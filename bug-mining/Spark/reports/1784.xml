<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:26:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-6954] ExecutorAllocationManager can end up requesting a negative number of executors</title>
                <link>https://issues.apache.org/jira/browse/SPARK-6954</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I have a simple test case for dynamic allocation on YARN that fails with the following stack trace-&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;15/04/16 00:52:14 ERROR Utils: Uncaught exception in thread spark-dynamic-executor-allocation-0
java.lang.IllegalArgumentException: Attempted to request a negative number of executor(s) -21 from the cluster manager. Please specify a positive number!
	at org.apache.spark.scheduler.cluster.CoarseGrainedSchedulerBackend.requestTotalExecutors(CoarseGrainedSchedulerBackend.scala:338)
	at org.apache.spark.SparkContext.requestTotalExecutors(SparkContext.scala:1137)
	at org.apache.spark.ExecutorAllocationManager.addExecutors(ExecutorAllocationManager.scala:294)
	at org.apache.spark.ExecutorAllocationManager.addOrCancelExecutorRequests(ExecutorAllocationManager.scala:263)
	at org.apache.spark.ExecutorAllocationManager.org$apache$spark$ExecutorAllocationManager$$schedule(ExecutorAllocationManager.scala:230)
	at org.apache.spark.ExecutorAllocationManager$$anon$1$$anonfun$run$1.apply$mcV$sp(ExecutorAllocationManager.scala:189)
	at org.apache.spark.ExecutorAllocationManager$$anon$1$$anonfun$run$1.apply(ExecutorAllocationManager.scala:189)
	at org.apache.spark.ExecutorAllocationManager$$anon$1$$anonfun$run$1.apply(ExecutorAllocationManager.scala:189)
	at org.apache.spark.util.Utils$.logUncaughtExceptions(Utils.scala:1618)
	at org.apache.spark.ExecutorAllocationManager$$anon$1.run(ExecutorAllocationManager.scala:189)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
	at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:304)
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:178)
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;My test is as follows-&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Start spark-shell with a single executor.&lt;/li&gt;
	&lt;li&gt;Run a &lt;tt&gt;select count(&amp;#42;)&lt;/tt&gt; query. The number of executors rises as input size is non-trivial.&lt;/li&gt;
	&lt;li&gt;After the job finishes, the number of  executors falls as most of them become idle.&lt;/li&gt;
	&lt;li&gt;Rerun the same query again, and the request to add executors fails with the above error. In fact, the job itself continues to run with whatever executors it already has, but it never gets more executors unless the shell is closed and restarted.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;In fact, this error only happens when I configure &lt;tt&gt;executorIdleTimeout&lt;/tt&gt; very small. For eg, I can reproduce it with the following configs-&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;spark.dynamicAllocation.executorIdleTimeout     5
spark.dynamicAllocation.schedulerBacklogTimeout 5
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Although I can simply increase &lt;tt&gt;executorIdleTimeout&lt;/tt&gt; to something like 60 secs to avoid the error, I think this is still a bug to be fixed.&lt;/p&gt;

&lt;p&gt;The root cause seems that &lt;tt&gt;numExecutorsPending&lt;/tt&gt; accidentally becomes negative if executors are killed too aggressively (i.e. &lt;tt&gt;executorIdleTimeout&lt;/tt&gt; is too small) because under that circumstance, the new target # of executors can be smaller than the current # of executors. When that happens, &lt;tt&gt;ExecutorAllocationManager&lt;/tt&gt; ends up trying to add a negative number of executors, which throws an exception.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12821390">SPARK-6954</key>
            <summary>ExecutorAllocationManager can end up requesting a negative number of executors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sandyr">Sandy Ryza</assignee>
                                    <reporter username="cheolsoo">Cheolsoo Park</reporter>
                        <labels>
                            <label>yarn</label>
                    </labels>
                <created>Thu, 16 Apr 2015 01:24:34 +0000</created>
                <updated>Fri, 19 Jun 2015 07:20:31 +0000</updated>
                            <resolved>Sat, 2 May 2015 09:59:43 +0000</resolved>
                                    <version>1.3.1</version>
                                    <fixVersion>1.3.2</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                    <component>YARN</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14497433" author="apachespark" created="Thu, 16 Apr 2015 01:31:31 +0000"  >&lt;p&gt;User &apos;piaozhexiu&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/5536&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/5536&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14497465" author="sandyr" created="Thu, 16 Apr 2015 02:15:52 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cheolsoo&quot; class=&quot;user-hover&quot; rel=&quot;cheolsoo&quot;&gt;cheolsoo&lt;/a&gt;, are you running with a version of Spark that contains &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-6325&quot; title=&quot;YarnAllocator crash with dynamic allocation on&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-6325&quot;&gt;&lt;del&gt;SPARK-6325&lt;/del&gt;&lt;/a&gt;? (1.3.0 does not).&lt;/p&gt;</comment>
                            <comment id="14497477" author="cheolsoo" created="Thu, 16 Apr 2015 02:33:25 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sandyr&quot; class=&quot;user-hover&quot; rel=&quot;sandyr&quot;&gt;sandyr&lt;/a&gt;, Thank you for the question.&lt;/p&gt;

&lt;p&gt;I am actually running 1.3.1-RC3, and I just confirmed that &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-6325&quot; title=&quot;YarnAllocator crash with dynamic allocation on&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-6325&quot;&gt;&lt;del&gt;SPARK-6325&lt;/del&gt;&lt;/a&gt; is in the commit log of my release branch.&lt;/p&gt;

&lt;p&gt;I updated the affects version to 1.3.1 to avoid confusion.&lt;/p&gt;</comment>
                            <comment id="14504305" author="cheolsoo" created="Tue, 21 Apr 2015 04:34:14 +0000"  >&lt;p&gt;I am uploading two diagrams that shows how the following variables move over time w/ and w/o my patch-&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;numExecutorsPending&lt;/li&gt;
	&lt;li&gt;executorIds.size&lt;/li&gt;
	&lt;li&gt;executorsPendingToRemove.size&lt;/li&gt;
	&lt;li&gt;targetNumExecutors&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;The &lt;tt&gt;with_fix.png&lt;/tt&gt; shows 4 consecutive runs of my query. As can be seen, &lt;tt&gt;targetNumExecutors&lt;/tt&gt; and &lt;tt&gt;numExecutorsPending&lt;/tt&gt; stays above zero.&lt;/li&gt;
	&lt;li&gt;The &lt;tt&gt;without_fix.png&lt;/tt&gt; shows a single run of my query. As can be seen, &lt;tt&gt;targetNumExecutors&lt;/tt&gt; and &lt;tt&gt;numExecutorsPending&lt;/tt&gt; goes negative after the 1st run.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Here is how I collected data in the source code-&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; def targetNumExecutors(): Int = {
  logInfo(&lt;span class=&quot;code-quote&quot;&gt;&quot;ZZZ &quot;&lt;/span&gt; +
    numExecutorsPending + &lt;span class=&quot;code-quote&quot;&gt;&quot;,&quot;&lt;/span&gt; +
    executorIds.size + &lt;span class=&quot;code-quote&quot;&gt;&quot;,&quot;&lt;/span&gt; +
    executorsPendingToRemove.size + &lt;span class=&quot;code-quote&quot;&gt;&quot;,&quot;&lt;/span&gt; +
    (numExecutorsPending + executorIds.size - executorsPendingToRemove.size))
  numExecutorsPending + executorIds.size - executorsPendingToRemove.size
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14512913" author="apachespark" created="Sun, 26 Apr 2015 06:42:32 +0000"  >&lt;p&gt;User &apos;sryza&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/5704&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/5704&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14524466" author="apachespark" created="Sat, 2 May 2015 02:10:18 +0000"  >&lt;p&gt;User &apos;sryza&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/5856&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/5856&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12833138">SPARK-7901</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12820697">SPARK-6891</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12726785" name="with_fix.png" size="315219" author="cheolsoo" created="Tue, 21 Apr 2015 04:34:14 +0000"/>
                            <attachment id="12726786" name="without_fix.png" size="221949" author="cheolsoo" created="Tue, 21 Apr 2015 04:34:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 29 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2dbmn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12329871">1.3.2</customfieldvalue>
    <customfieldvalue id="12329359">1.4.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>