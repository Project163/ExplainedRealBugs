<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:46:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-17086] QuantileDiscretizer throws InvalidArgumentException (parameter splits given invalid value) on valid data</title>
                <link>https://issues.apache.org/jira/browse/SPARK-17086</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I discovered this bug when working with a build from the master branch (which I believe is 2.1.0). This used to work fine when running spark 1.6.2.&lt;/p&gt;

&lt;p&gt;I have a dataframe with an &quot;intData&quot; column that has values like &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;1 3 2 1 1 2 3 2 2 2 1 3
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I have a stage in my pipeline that uses the QuantileDiscretizer to produce equal weight splits like this&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; QuantileDiscretizer()
        .setInputCol(&lt;span class=&quot;code-quote&quot;&gt;&quot;intData&quot;&lt;/span&gt;)
        .setOutputCol(&lt;span class=&quot;code-quote&quot;&gt;&quot;intData_bin&quot;&lt;/span&gt;)
        .setNumBuckets(10)
        .fit(df)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But when that gets run it (incorrectly) throws this error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;parameter splits given invalid value [-Infinity, 1.0, 1.0, 2.0, 2.0, 3.0, 3.0, Infinity]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I don&apos;t think that there should be duplicate splits generated should there be?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12997635">SPARK-17086</key>
            <summary>QuantileDiscretizer throws InvalidArgumentException (parameter splits given invalid value) on valid data</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="VinceXie">Vincent</assignee>
                                    <reporter username="barrybecker4">Barry Becker</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 Aug 2016 16:25:06 +0000</created>
                <updated>Wed, 6 Feb 2019 17:41:10 +0000</updated>
                            <resolved>Wed, 24 Aug 2016 09:17:18 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.1</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                    <component>ML</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15424076" author="vincexie" created="Wed, 17 Aug 2016 08:16:10 +0000"  >&lt;p&gt;confirmed issue doesnt exist on Spark-1.6.2.&lt;br/&gt;
I will work on this issue.&lt;/p&gt;</comment>
                            <comment id="15425949" author="yanboliang" created="Thu, 18 Aug 2016 06:02:17 +0000"  >&lt;p&gt;If the number of distinct input data is less than &lt;tt&gt;numBuckets&lt;/tt&gt;, it should not split the data into buckets. We should figure out a proper way to identify this condition and throw corresponding exception.&lt;/p&gt;</comment>
                            <comment id="15426185" author="srowen" created="Thu, 18 Aug 2016 09:52:24 +0000"  >&lt;p&gt;The issue is that approxQuantile may return quantiles where neighboring values are the same. This much is correct, really. It&apos;s perfectly possible for two different quantiles to have identical values. However this is used as input to the discretizer&apos;s split parameter, which wants strictly increasing quantiles. I think this requirement should just be relaxed. It&apos;s not invalid for two successive quantiles to be equal.&lt;/p&gt;

&lt;p&gt;The bucket defined by [1.0, 1.0) will only receive the value 1.0, but that&apos;s fine. In a case like this, the bucket [1.0,2.0) will actually never get any values. But that&apos;s fine too. It may be an unuseful result but it&apos;s correct given the request to create 10 buckets.&lt;/p&gt;</comment>
                            <comment id="15426246" author="vincexie" created="Thu, 18 Aug 2016 10:42:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yanboliang&quot; class=&quot;user-hover&quot; rel=&quot;yanboliang&quot;&gt;yanboliang&lt;/a&gt; yes, actually that case was handled on spark-1.6.2&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt; currently it will throw an illegal exception in this case:&lt;br/&gt;
java.lang.IllegalArgumentException: quantileDiscretizer_07696c9dca6c parameter splits given invalid value&lt;/p&gt;

&lt;p&gt;so, what i&apos;m doing now is to have a check before calling approxQuantile, that, if the distinct input data count is less than numBuckets, we will simply return an array with distinct elements as splits, for those cases where number of distinct input data is greater than numBuckets, we will just go to approxQuantile as the way it is now to generate a splits set. &lt;/p&gt;

&lt;p&gt;For example, with an input data shown in this case, we will output splits : &lt;span class=&quot;error&quot;&gt;&amp;#91;-Infinity, 1.0, 2.0, 3.0, Infinity&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;what do you think? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yanboliang&quot; class=&quot;user-hover&quot; rel=&quot;yanboliang&quot;&gt;yanboliang&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15426252" author="srowen" created="Thu, 18 Aug 2016 10:47:19 +0000"  >&lt;p&gt;Yes, I know it generates an error. I think it should accept quantiles like the one in the example above.&lt;br/&gt;
No I don&apos;t think it&apos;s valid to return distinct values as quantiles. In particular, you&apos;d return fewer than the requested number of quantiles.&lt;br/&gt;
Imagine input 1 1 1 1 1 1 1 1 1 2 3. You&apos;re suggesting returning &lt;span class=&quot;error&quot;&gt;&amp;#91;-Infinity, 1.0, 2.0, 3.0, Infinity&amp;#93;&lt;/span&gt; in this case as well, but that would imply at least that the median is 2, when it&apos;s 1.&lt;/p&gt;</comment>
                            <comment id="15426254" author="yanboliang" created="Thu, 18 Aug 2016 10:48:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sowen&quot; class=&quot;user-hover&quot; rel=&quot;sowen&quot;&gt;sowen&lt;/a&gt; &lt;br/&gt;
The bucket defined by [1.0, 1.0) will only receive the value 1.0, I think this scenario is OK. But if we provide the splits as &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;-Infinity, 1.0, 1.0, 1.0, 2.0, 2.0, 2.0, 3.0, 3.0, Infinity&amp;#93;&lt;/span&gt;&lt;/tt&gt;, it will output &lt;tt&gt;[-Infinity, 1.0), 1.0,  1.0, [1.0, 2.0), 2.0, 2.0, [2.0, 3.0), 3.0, &lt;span class=&quot;error&quot;&gt;&amp;#91;3.0, Infinity&amp;#93;&lt;/span&gt;&lt;/tt&gt;. &lt;br/&gt;
From the document, &lt;tt&gt;QuantileDiscretizer&lt;/tt&gt; takes a column with continuous features and outputs a column with binned categorical features. So I think it does not make sense if we put the same continuous value into different categorical features. Thanks.&lt;/p&gt;</comment>
                            <comment id="15426259" author="srowen" created="Thu, 18 Aug 2016 10:54:13 +0000"  >&lt;p&gt;You are right, some buckets will get no values. If the input has so few distinct (integer) values, 10 buckets is too many and there&apos;s no way 3 distinct values can ever fall into more than 3 distinct buckets. That much is actually fine IMHO.&lt;/p&gt;

&lt;p&gt;But yes it&apos;s ambiguous because 2 can logically go into [2,2) or [2,3). If it were consistently mapped into one of them, like the first matching bucket, I think it would still be valid output. If there&apos;s no easy way to make this mapping consistently then I agree it should probably be an error to end up with splits like this.&lt;/p&gt;

&lt;p&gt;(I&apos;m also not sure why 8 splits are output in the example but 10 buckets were requested. It just defines 7 buckets.)&lt;/p&gt;</comment>
                            <comment id="15426261" author="vincexie" created="Thu, 18 Aug 2016 10:57:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt; in the example you just took, yes, it will return &lt;span class=&quot;error&quot;&gt;&amp;#91;-Infinity, 1.0, 2.0, 3.0, Infinity&amp;#93;&lt;/span&gt;. that&apos;s also the result we saw on spark-1.6.2&lt;/p&gt;</comment>
                            <comment id="15426270" author="srowen" created="Thu, 18 Aug 2016 11:06:36 +0000"  >&lt;p&gt;I suppose it depends on the desired semantics of QuantileDiscretizer. It sounds like already would return fewer buckets than requested. (That could or should be documented.) &lt;/p&gt;

&lt;p&gt;It makes it sound like it tries to make the buckets match quantiles of the input, even if it doesn&apos;t guarantee it. The bins you describe here would result in pretty lopsided binning, but, any consistent scheme would be the same.&lt;/p&gt;

&lt;p&gt;OK I think I would agree with matching the 1.6.2 behavior then and documenting that the number of buckets may be smaller than requested, rather than return buckets some of which will always be empty. Let&apos;s just document / add a test for it.&lt;/p&gt;

&lt;p&gt;I don&apos;t think the test should involve the number of distinct input elements (which could be expensive to compute); you just want to collapse adjacent splits that are equal right? That will cover more cases too.&lt;/p&gt;</comment>
                            <comment id="15426276" author="vincexie" created="Thu, 18 Aug 2016 11:10:55 +0000"  >&lt;p&gt;Agree! &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15426549" author="barrybecker4" created="Thu, 18 Aug 2016 14:32:55 +0000"  >&lt;p&gt;I think I agree with the discussion. Here is a summary of the conclusions just to check my understanding:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;It&apos;s fine for appxQuantile to return duplicate splits. It should always return the requested number of quantiles corresponding to the length of the probabilities array pased to it.&lt;/li&gt;
	&lt;li&gt;QuantileBucketizer, on the other hand, may return fewer than the number of buckets requested. It should not give an error when the number of buckets requested is fewer than the number of distinct values. If the call to appxQuartile returns duplicate splits, just discard the duplicates when passing the splits to QBucketizer. This saves you from having to compute unique values first in order to check to see if that number is less that the requested number of bins. I think its fine that QBucketizer work this way. You want it to be robust and not give errors for edge cases like this. The objective is to return buckets that have as close to equal weight bins as possible with simple split values.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If the data was [1,1,1,1,1,1,1,1,4,5,10] and I asked for 10 bins, then I would expect the splits to be [-Inf, 1, 4, 5, 10, Inf] even though the mean is 1 and appxQuartile returned 1 repeated several time. If I asked for 2 bins, then I think the splits might be [-Inf, 1, 4, Inf]. If three bins are requested, would you get [-Inf, 1, 4, 5, Inf] or [-Inf, 1, 4, 10, Inf]? Maybe, in cases like this you should get [-Inf, 1, 4, 5, 10, Inf] even though only 3 bins were requested. In other words, if there are only a small number of unique integer values in the data, and the number of bins is slightly less than that number, maybe it should be increased to match it since that is likely to be more meaningful. For now, just removing duplicates is probably enough.&lt;/p&gt;</comment>
                            <comment id="15429348" author="srowen" created="Sat, 20 Aug 2016 12:09:33 +0000"  >&lt;p&gt;Yeah sounds good &amp;#8211; feel free to make a PR.&lt;/p&gt;</comment>
                            <comment id="15429951" author="qhuang" created="Mon, 22 Aug 2016 01:44:26 +0000"  >&lt;p&gt;I also agree on that it does not make sense if we put the same continuous value into different categorical features. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yanboliang&quot; class=&quot;user-hover&quot; rel=&quot;yanboliang&quot;&gt;yanboliang&lt;/a&gt;&lt;br/&gt;
But the original exception is confusing and difficult to understand to users:&lt;br/&gt;
&quot;quantileDiscretizer_d03027d0b77c parameter splits given invalid value&quot;&lt;br/&gt;
Thus, we could add an exception for quantileDiscretizer like in R:&lt;/p&gt;

&lt;p&gt;&amp;gt; x&amp;lt;-c(1,1,1,1,1,1,1,1,4,5,10)&lt;br/&gt;
&amp;gt; quantile&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
  0%  25%  50%  75% 100% &lt;br/&gt;
 1.0  1.0  1.0  2.5 10.0 &lt;br/&gt;
&amp;gt; a&amp;lt;-quantile&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
&amp;gt; cut(x,a)&lt;br/&gt;
Error in cut.default(x, a) : &apos;breaks&apos; are not unique&lt;/p&gt;

</comment>
                            <comment id="15430009" author="yanboliang" created="Mon, 22 Aug 2016 03:58:27 +0000"  >&lt;p&gt;We should not throw exception in this case. If the number of distinct input data is less than &lt;tt&gt;numBuckets&lt;/tt&gt;, we will simply return an array with distinct elements as splits. But we should not actually compute  the number of distinct input elements which is very expensive, we can collapse adjacent splits produced by &lt;tt&gt;approxQuantile&lt;/tt&gt; that are equal.&lt;/p&gt;</comment>
                            <comment id="15430270" author="apachespark" created="Mon, 22 Aug 2016 08:04:07 +0000"  >&lt;p&gt;User &apos;VinceShieh&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/14747&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/14747&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15434564" author="srowen" created="Wed, 24 Aug 2016 09:17:18 +0000"  >&lt;p&gt;Issue resolved by pull request 14747&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/14747&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/14747&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15434805" author="barrybecker4" created="Wed, 24 Aug 2016 12:17:26 +0000"  >&lt;p&gt;Is it possible to get this fix into 2.0.1? Maybe it would be possible to work around it by manually stripping the duplicate splits in client code?&lt;/p&gt;</comment>
                            <comment id="15434862" author="srowen" created="Wed, 24 Aug 2016 12:47:03 +0000"  >&lt;p&gt;OK, seems reasonable to me. Backported to 2.0.x&lt;/p&gt;</comment>
                            <comment id="15435236" author="barrybecker4" created="Wed, 24 Aug 2016 16:38:16 +0000"  >&lt;p&gt;Thanks. &lt;br/&gt;
BTW, I hope there are some test cases where the column to bin has NaN values (for nulls).&lt;br/&gt;
I seem to recall there being duplicate NaN split points being added for every occurrence of NaN in the data (or something like that).&lt;br/&gt;
I will open a separate issue on this if I can nail down the specifics and make a simple test case.&lt;/p&gt;</comment>
                            <comment id="16761953" author="matias rotenberg" created="Wed, 6 Feb 2019 17:21:53 +0000"  >&lt;p&gt;I seem to be running into this exact issue in 2.2.0 when using&#160;QuantileDiscretizer:&lt;/p&gt;

&lt;p&gt;IllegalArgumentException: u&apos;Bucketizer_467c983fd201c1561cf3 parameter splits given invalid value &lt;span class=&quot;error&quot;&gt;&amp;#91;-Infinity,-1.0,-1.0,-1.0,-0.999999999996,-0.999999994038,-0.999998539337,-0.993442759767,0.997389694724,0.999999999505,Infinity&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Could it be that the change was not ported to newer versions?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;edit:&lt;/p&gt;

&lt;p&gt;When I getSplits there are actually no duplicate values:\&lt;/p&gt;

&lt;p&gt;splits =&#160;&#160;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;-inf, -1.0, -0.999999999999999, -0.9999999999999638, -0.9999999999962722, -0.9999999940383268, -0.9999985393371443, -0.9934427597674274, 0.9973896947239832, 0.9999999995050777, inf&amp;#93;&lt;/span&gt;&lt;br/&gt;
&#160;&lt;br/&gt;
Could it be a matter of precision?&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12825303" name="titanic.csv" size="74795" author="barrybecker4" created="Wed, 24 Aug 2016 17:57:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 40 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i32dlr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>