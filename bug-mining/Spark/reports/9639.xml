<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:42:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-47840] Remove foldable propagation across Streaming Aggregate/Join nodes</title>
                <link>https://issues.apache.org/jira/browse/SPARK-47840</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Streaming queries with Union of 2 data streams followed by an Aggregate (groupBy) can produce incorrect results if the grouping key is a constant literal for micro-batch duration.&lt;/p&gt;

&lt;p&gt;The query produces incorrect results because the query optimizer recognizes the literal value in the grouping key as foldable and replaces the grouping key expression with the actual literal value. This optimization is correct for batch queries. However Streaming queries also read information from StateStore, and the output contains both the results from StateStore (computed in previous microbatches) and data from input sources (computed in this microbatch). The HashAggregate node after StateStore always reads grouping key value as the optimized literal (as the grouping key expression is optimized into a literal by the optimizer). This ends up replacing keys in StateStore with the literal value resulting in incorrect output.&#160;&lt;/p&gt;

&lt;p&gt;See an example logical and physical plan below for a query performing a union on 2 data streams, followed by a groupBy. Note that the name#4 expression has been optimized to ds1. The Streaming query Aggregate adds StateStoreSave node as child of HashAggregate, however any grouping key read from StateStore will still be read as ds1 due to the optimization.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Optimized Logical Plan&lt;/b&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;=== Applying Rule org.apache.spark.sql.catalyst.optimizer.FoldablePropagation ===&lt;/p&gt;

&lt;p&gt;=== Old Plan ===&lt;/p&gt;

&lt;p&gt;WriteToMicroBatchDataSource MemorySink, eb67645e-30fc-41a8-8006-35bb7649c202, Complete, 0&lt;br/&gt;
+- Aggregate &lt;a href=&quot;#4&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;name#4&lt;/a&gt;, &lt;a href=&quot;#4, count(1) AS count#31L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;name#4, count(1) AS count#31L&lt;/a&gt;&lt;br/&gt;
&#160; &#160;+- Project &lt;a href=&quot;#4&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ds1 AS name#4&lt;/a&gt;&lt;br/&gt;
&#160; &#160; &#160; +- StreamingDataSourceV2ScanRelation&lt;a href=&quot;#1&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;value#1&lt;/a&gt; MemoryStreamDataSource&lt;/p&gt;

&lt;p&gt;=== New Plan ===&lt;/p&gt;

&lt;p&gt;WriteToMicroBatchDataSource MemorySink, eb67645e-30fc-41a8-8006-35bb7649c202, Complete, 0&lt;br/&gt;
+- Aggregate &lt;span class=&quot;error&quot;&gt;&amp;#91;ds1&amp;#93;&lt;/span&gt;, &lt;a href=&quot;#4, count(1) AS count#31L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ds1 AS name#4, count(1) AS count#31L&lt;/a&gt;&lt;br/&gt;
&#160; &#160;+- Project &lt;a href=&quot;#4&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ds1 AS name#4&lt;/a&gt;&lt;br/&gt;
&#160; &#160; &#160; +- StreamingDataSourceV2ScanRelation&lt;a href=&quot;#1&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;value#1&lt;/a&gt; MemoryStreamDataSource&lt;/p&gt;

&lt;p&gt;====&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;b&gt;Corresponding Physical Plan&lt;/b&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;WriteToDataSourceV2 MicroBatchWrite&lt;span class=&quot;error&quot;&gt;&amp;#91;epoch: 0, writer: org.apache.spark.sql.execution.streaming.sources.MemoryStreamingWrite@2b4c6242&amp;#93;&lt;/span&gt;, org.apache.spark.sql.execution.datasources.v2.DataSourceV2Strategy$$Lambda$3143/1859075634@35709d26&lt;br/&gt;
+- HashAggregate(keys=&lt;a href=&quot;#39&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ds1#39&lt;/a&gt;, functions=&lt;a href=&quot;#38L) AS count(1)#30L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;finalmerge_count(merge count#38L) AS count(1)#30L&lt;/a&gt;, output=&lt;a href=&quot;#4, count#31L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;name#4, count#31L&lt;/a&gt;)&lt;br/&gt;
&#160; &#160;+- StateStoreSave &lt;a href=&quot;#39&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ds1#39&lt;/a&gt;, state info [ checkpoint = &lt;a href=&quot;file:///tmp/streaming.metadata-e470782a-18a3-463c-9e61-3a10d0bdf180/state&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:/tmp/streaming.metadata-e470782a-18a3-463c-9e61-3a10d0bdf180/state&lt;/a&gt;, runId = 4dedecca-910c-4518-855e-456702617414, opId = 0, ver = 0, numPartitions = 5], Complete, 0, 0, 2&lt;br/&gt;
&#160; &#160; &#160; +- HashAggregate(keys=&lt;a href=&quot;#39&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ds1#39&lt;/a&gt;, functions=&lt;a href=&quot;#38L) AS count#38L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;merge_count(merge count#38L) AS count#38L&lt;/a&gt;, output=&lt;a href=&quot;#39, count#38L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ds1#39, count#38L&lt;/a&gt;)&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160;+- StateStoreRestore &lt;a href=&quot;#39&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ds1#39&lt;/a&gt;, state info [ checkpoint = &lt;a href=&quot;file:///tmp/streaming.metadata-e470782a-18a3-463c-9e61-3a10d0bdf180/state&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:/tmp/streaming.metadata-e470782a-18a3-463c-9e61-3a10d0bdf180/state&lt;/a&gt;, runId = 4dedecca-910c-4518-855e-456702617414, opId = 0, ver = 0, numPartitions = 5], 2&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; +- HashAggregate(keys=&lt;a href=&quot;#39&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ds1#39&lt;/a&gt;, functions=&lt;a href=&quot;#38L) AS count#38L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;merge_count(merge count#38L) AS count#38L&lt;/a&gt;, output=&lt;a href=&quot;#39, count#38L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ds1#39, count#38L&lt;/a&gt;)&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;+- HashAggregate(keys=&lt;a href=&quot;#39&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ds1 AS ds1#39&lt;/a&gt;, functions=&lt;a href=&quot;#38L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;partial_count(1) AS count#38L&lt;/a&gt;, output=&lt;a href=&quot;#39, count#38L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ds1#39, count#38L&lt;/a&gt;)&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; +- Project&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;+- MicroBatchScan&lt;a href=&quot;#1&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;value#1&lt;/a&gt; MemoryStreamDataSource&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13575705">SPARK-47840</key>
            <summary>Remove foldable propagation across Streaming Aggregate/Join nodes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bhuwan.sahni">Bhuwan Sahni</assignee>
                                    <reporter username="bhuwan.sahni">Bhuwan Sahni</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 12 Apr 2024 23:43:32 +0000</created>
                <updated>Tue, 16 Apr 2024 03:36:41 +0000</updated>
                            <resolved>Tue, 16 Apr 2024 03:36:41 +0000</resolved>
                                    <version>3.5.1</version>
                    <version>4.0.0</version>
                                    <fixVersion>3.5.2</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                    <component>Structured Streaming</component>
                        <due>Fri, 19 Apr 2024 00:00:00 +0000</due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17837498" author="kabhwan" created="Tue, 16 Apr 2024 03:36:41 +0000"  >&lt;p&gt;Issue resolved by pull request 46035&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/46035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/46035&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 30 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1om34:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>