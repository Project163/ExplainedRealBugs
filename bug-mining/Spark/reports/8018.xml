<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:26:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-35290] unionByName with null filling fails for some nested structs</title>
                <link>https://issues.apache.org/jira/browse/SPARK-35290</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;We&apos;ve encountered a few weird edge cases that seem to fail the new null filling unionByName (which has been a great addition!). It seems to stem from the fields being sorted by name and corrupted along the way. The simple reproduction is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
df = spark.createDataFrame([[]])
df1 = (df
    .withColumn(&lt;span class=&quot;code-quote&quot;&gt;&apos;top&apos;&lt;/span&gt;, F.struct(
        F.struct(
            F.lit(&lt;span class=&quot;code-quote&quot;&gt;&apos;ba&apos;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&apos;ba&apos;&lt;/span&gt;)
        ).alias(&lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;)
    ))
)
df2 = (df
    .withColumn(&lt;span class=&quot;code-quote&quot;&gt;&apos;top&apos;&lt;/span&gt;, F.struct(
        F.struct(
            F.lit(&lt;span class=&quot;code-quote&quot;&gt;&apos;aa&apos;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&apos;aa&apos;&lt;/span&gt;)
        ).alias(&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;),
        F.struct(
            F.lit(&lt;span class=&quot;code-quote&quot;&gt;&apos;bb&apos;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&apos;bb&apos;&lt;/span&gt;)
        ).alias(&lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;),
    ))
)
df1.unionByName(df2, True).printSchema()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This results in the exception:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
pyspark.sql.utils.AnalysisException: Union can only be performed on tables with the compatible column types. struct&amp;lt;a:struct&amp;lt;aa:string&amp;gt;,b:struct&amp;lt;ba:string,bb:string&amp;gt;&amp;gt; &amp;lt;&amp;gt; struct&amp;lt;a:struct&amp;lt;aa:string&amp;gt;,b:struct&amp;lt;aa:string,bb:string&amp;gt;&amp;gt; at the first column of the second table;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;You can see in the second schema that it has&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
b:struct&amp;lt;aa:string,bb:string&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;when it should be&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
b:struct&amp;lt;ba:string:bb:string&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It seems to happen somewhere during &lt;a href=&quot;https://github.com/apache/spark/blob/master/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/analysis/ResolveUnion.scala#L73,&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/analysis/ResolveUnion.scala#L73,&lt;/a&gt;&#160;as everything seems correct up to that point from my testing. It&apos;s either modifying one expression during the transformUp then corrupts other expressions that are then modified, or the ExtractValue before the addFieldsInto is remembering the ordinal position in the struct that is then changing and causing issues.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I found that simply using sortStructFields instead of sortStructFieldsInWithFields gets things working correctly, but definitely has a performance impact. The deep expr unionByName test takes ~1-2 seconds normally but ~12-15 seconds with this change. I assume because the original method tried to rewrite existing expressions vs the sortStructFields just adds expressions on top of existing ones to project the new order.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure if it makes sense to take the slower but works in the edge cases method (assuming it doesn&apos;t break other cases, all existing tests pass), or if there&apos;s a way to fix the existing method for cases like this.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13376276">SPARK-35290</key>
            <summary>unionByName with null filling fails for some nested structs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kimahriman">Adam Binford</assignee>
                                    <reporter username="kimahriman">Adam Binford</reporter>
                        <labels>
                    </labels>
                <created>Sun, 2 May 2021 14:05:15 +0000</created>
                <updated>Mon, 12 Dec 2022 18:10:39 +0000</updated>
                            <resolved>Thu, 24 Jun 2021 16:21:57 +0000</resolved>
                                    <version>3.1.1</version>
                                    <fixVersion>3.2.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17338287" author="gurwls223" created="Mon, 3 May 2021 10:17:04 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=viirya&quot; class=&quot;user-hover&quot; rel=&quot;viirya&quot;&gt;viirya&lt;/a&gt;&#160;FYI&lt;/p&gt;</comment>
                            <comment id="17338476" author="viirya" created="Mon, 3 May 2021 16:47:20 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hyukjin.kwon&quot; class=&quot;user-hover&quot; rel=&quot;hyukjin.kwon&quot;&gt;hyukjin.kwon&lt;/a&gt; for ping me.&lt;/p&gt;</comment>
                            <comment id="17338477" author="viirya" created="Mon, 3 May 2021 16:47:34 +0000"  >&lt;p&gt;I will take a look.&lt;/p&gt;</comment>
                            <comment id="17338526" author="kimahriman" created="Mon, 3 May 2021 17:46:05 +0000"  >&lt;p&gt;I&apos;ve also been playing around with rewriting some of the logic to just directly recursively create a named struct and taking out the need for the UpdateField/WithField logic. I&apos;ve gotten all existing tests to pass (including a new one for this case), without the 12-15 second overhead mentioned in the description for the deeply nested case, but I think there&apos;s still some case insensitivity I might need to take care of. I can put up a PR soon with what that looks like.&lt;/p&gt;</comment>
                            <comment id="17338565" author="viirya" created="Mon, 3 May 2021 19:01:35 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Kimahriman&quot; class=&quot;user-hover&quot; rel=&quot;kimahriman&quot;&gt;Kimahriman&lt;/a&gt;. &lt;/p&gt;</comment>
                            <comment id="17338921" author="kimahriman" created="Tue, 4 May 2021 11:24:42 +0000"  >&lt;p&gt;Running into some issues trying to get case insensitivity working correctly. I was hoping to be able to leave everything on both sides of the union in it&apos;s existing casing, and just get things in the right order, but I&apos;m running into this issue:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;gt;&amp;gt;&amp;gt; from pyspark.sql.functions &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; *
&amp;gt;&amp;gt;&amp;gt; df1 = spark.range(1).withColumn(&lt;span class=&quot;code-quote&quot;&gt;&apos;top&apos;&lt;/span&gt;, struct(lit(&lt;span class=&quot;code-quote&quot;&gt;&apos;A&apos;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&apos;A&apos;&lt;/span&gt;)))
&amp;gt;&amp;gt;&amp;gt; df2 = spark.range(1).withColumn(&lt;span class=&quot;code-quote&quot;&gt;&apos;top&apos;&lt;/span&gt;, struct(lit(&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;)))
&amp;gt;&amp;gt;&amp;gt; spark.conf.set(&lt;span class=&quot;code-quote&quot;&gt;&apos;spark.sql.caseSensitive&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&apos;&lt;/span&gt;)
...
pyspark.sql.utils.AnalysisException: Union can only be performed on tables with the compatible column types. struct&amp;lt;a:string&amp;gt; &amp;lt;&amp;gt; struct&amp;lt;A:string&amp;gt; at the second column of the second table;

&amp;gt;&amp;gt;&amp;gt; spark.conf.set(&lt;span class=&quot;code-quote&quot;&gt;&apos;spark.sql.caseSensitive&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&apos;&lt;/span&gt;)
&amp;gt;&amp;gt;&amp;gt; df1.union(df2)
DataFrame[id: bigint, top: struct&amp;lt;A:string,a:string&amp;gt;]
&amp;gt;&amp;gt;&amp;gt; df1.unionByName(df2)
DataFrame[id: bigint, top: struct&amp;lt;A:string,a:string&amp;gt;]
&amp;gt;&amp;gt;&amp;gt; df1.unionByName(df2, True)
DataFrame[id: bigint, top: struct&amp;lt;A:string,a:string&amp;gt;]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;With case sensitivity enabled, it errors out as expected because the two structs are different types. However, when case sensitivity is disabled, the union is happy because it sees them as the same type, but when the schemas are merged, it treats them as two separate fields. I assume it&apos;s related to the StructType.merge method, but I don&apos;t exactly know where that gets called in the context of a Union. I don&apos;t see anything in that merge function that handles case insensitivity. Is that a bug in itself or a feature?&lt;/p&gt;</comment>
                            <comment id="17339961" author="apachespark" created="Thu, 6 May 2021 01:35:21 +0000"  >&lt;p&gt;User &apos;Kimahriman&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32448&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32448&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17339962" author="apachespark" created="Thu, 6 May 2021 01:35:38 +0000"  >&lt;p&gt;User &apos;Kimahriman&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32448&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32448&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17368070" author="apachespark" created="Wed, 23 Jun 2021 11:41:07 +0000"  >&lt;p&gt;User &apos;Kimahriman&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/33040&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/33040&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17368955" author="viirya" created="Thu, 24 Jun 2021 16:21:57 +0000"  >&lt;p&gt;Issue resolved by pull request 33040&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/33040&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/33040&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13404716">SPARK-36918</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 20 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0qnsw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>