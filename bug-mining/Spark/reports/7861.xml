<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:25:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-34463] toPandas failed with error: buffer source array is read-only when Arrow with self-destruct is enabled</title>
                <link>https://issues.apache.org/jira/browse/SPARK-34463</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Environment:&lt;/p&gt;

&lt;p&gt;apache/spark master &lt;br/&gt;
 pandas version &amp;gt; 1.0.5&lt;/p&gt;

&lt;p&gt;Reproduce code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
spark.conf.set(&lt;span class=&quot;code-quote&quot;&gt;&apos;spark.sql.execution.arrow.pyspark.enabled&apos;&lt;/span&gt;, True)
spark.conf.set(&lt;span class=&quot;code-quote&quot;&gt;&apos;spark.sql.execution.arrow.pyspark.selfDestruct.enabled&apos;&lt;/span&gt;, True)
spark.createDataFrame(sc.parallelize([(i,) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; i in range(13)], 1), &lt;span class=&quot;code-quote&quot;&gt;&apos;id &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;&apos;&lt;/span&gt;).selectExpr(&lt;span class=&quot;code-quote&quot;&gt;&apos;IF(id % 3==0, id+1, NULL) AS f1&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;(id+1) % 2 AS label&apos;&lt;/span&gt;).toPandas()[&lt;span class=&quot;code-quote&quot;&gt;&apos;label&apos;&lt;/span&gt;].value_counts()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Get error like:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Traceback (most recent call last): &lt;br/&gt;
 File &quot;&amp;lt;stdin&amp;gt;&quot;, line 1, in &amp;lt;module&amp;gt;&lt;br/&gt;
 File &quot;/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/site-packages/pandas/core/base.py&quot;, line 1033, in value_counts&lt;br/&gt;
 dropna=dropna,&lt;br/&gt;
 File &quot;/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/site-packages/pandas/core/algorithms.py&quot;, line 820, in value_counts&lt;br/&gt;
 keys, counts = value_counts_arraylike(values, dropna)&lt;br/&gt;
 File &quot;/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/site-packages/pandas/core/algorithms.py&quot;, line 865, in value_counts_arraylike&lt;br/&gt;
 keys, counts = f(values, dropna)&lt;br/&gt;
 File &quot;pandas/_libs/hashtable_func_helper.pxi&quot;, line 1098, in pandas._libs.hashtable.value_count_int64&lt;br/&gt;
 File &quot;stringsource&quot;, line 658, in View.MemoryView.memoryview_cwrapper&lt;br/&gt;
 File &quot;stringsource&quot;, line 349, in View.MemoryView.memoryview._&lt;em&gt;cinit&lt;/em&gt;_&lt;br/&gt;
 ValueError: buffer source array is read-only&lt;/p&gt;&lt;/blockquote&gt;</description>
                <environment></environment>
        <key id="13359314">SPARK-34463</key>
            <summary>toPandas failed with error: buffer source array is read-only when Arrow with self-destruct is enabled</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lidavidm">David Li</assignee>
                                    <reporter username="weichenxu123">Weichen Xu</reporter>
                        <labels>
                    </labels>
                <created>Thu, 18 Feb 2021 13:11:42 +0000</created>
                <updated>Mon, 12 Dec 2022 18:10:54 +0000</updated>
                            <resolved>Tue, 30 Mar 2021 04:30:44 +0000</resolved>
                                    <version>3.2.0</version>
                                    <fixVersion>3.2.0</fixVersion>
                                    <component>PySpark</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17286469" author="weichenxu123" created="Thu, 18 Feb 2021 13:15:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bryanc&quot; class=&quot;user-hover&quot; rel=&quot;bryanc&quot;&gt;bryanc&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lidavidm&quot; class=&quot;user-hover&quot; rel=&quot;lidavidm&quot;&gt;lidavidm&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hyukjin.kwon&quot; class=&quot;user-hover&quot; rel=&quot;hyukjin.kwon&quot;&gt;hyukjin.kwon&lt;/a&gt; Any idea ?&lt;br/&gt;
This is bug introduced by &lt;a href=&quot;https://github.com/apache/spark/pull/29818&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29818&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17286470" author="lidavidm" created="Thu, 18 Feb 2021 13:17:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=weichenxu123&quot; class=&quot;user-hover&quot; rel=&quot;weichenxu123&quot;&gt;weichenxu123&lt;/a&gt; Does it work when selfDestruct is not enabled? If so, this is something that needs to be fixed in Pandas - it doesn&apos;t always deal well with immutable backing arrays, and selfDestruct makes it more likely that PyArrow will find zero-copy opportunities and hence give Pandas an immutable backing array.&lt;/p&gt;</comment>
                            <comment id="17286473" author="weichenxu123" created="Thu, 18 Feb 2021 13:23:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lidavidm&quot; class=&quot;user-hover&quot; rel=&quot;lidavidm&quot;&gt;lidavidm&lt;/a&gt; Yes it works when selfDestruct disabled.&lt;/p&gt;

&lt;p&gt;And the bug only happen on pandas &amp;gt; 1.0.5&lt;/p&gt;

&lt;p&gt;Should we disable the feature when pandas &amp;gt; 1.0.5 ?&lt;/p&gt;</comment>
                            <comment id="17286474" author="lidavidm" created="Thu, 18 Feb 2021 13:26:59 +0000"  >&lt;p&gt;This is a &quot;case by case&quot; kind of thing - it&apos;ll depend on what you do in Pandas and what Pandas version you have. I don&apos;t think we need to disable the feature, but maybe we should make it clearer what caveats it has (I know Bryan suggested updating the docs, which I should get to soon). I would suggest trying to build a reproduction case (without Spark) and reporting it to Pandas, I&apos;ve done it before: &lt;a href=&quot;https://github.com/pandas-dev/pandas/pull/35532&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pandas-dev/pandas/pull/35532&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Things like this are why it&apos;s not universally enabled by default.&lt;/p&gt;</comment>
                            <comment id="17286475" author="weichenxu123" created="Thu, 18 Feb 2021 13:31:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lidavidm&quot; class=&quot;user-hover&quot; rel=&quot;lidavidm&quot;&gt;lidavidm&lt;/a&gt; OK. Could you help build a simple reproduce case without spark ? Seems you&apos;re more familiar about this. Thanks!&lt;/p&gt;</comment>
                            <comment id="17286476" author="weichenxu123" created="Thu, 18 Feb 2021 13:32:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lidavidm&quot; class=&quot;user-hover&quot; rel=&quot;lidavidm&quot;&gt;lidavidm&lt;/a&gt;&lt;br/&gt;
Btw, could you tell me why &quot;use_threads=false&quot; is set when selfDestruct enabled ? Is it required ?&lt;/p&gt;</comment>
                            <comment id="17286478" author="lidavidm" created="Thu, 18 Feb 2021 13:35:28 +0000"  >&lt;p&gt;I&apos;ll take a look.&lt;/p&gt;

&lt;p&gt;The reason for the three options is as follows:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;use_threads=False - convert each column sequentially to minimize memory usage (overhead = 1 column&apos;s worth of memory at any time instead of N columns where N = parallelism level)&lt;/li&gt;
	&lt;li&gt;split_blocks=True - create a separate Pandas block for each column. This is an internal implementation detail, but it makes it more likely for PyArrow to find zero-copy opportunities and reduce memory usage/conversion overhead even more&lt;/li&gt;
	&lt;li&gt;self_destruct=True - free the PyArrow array after each conversion to save memory (technically it&apos;s just decrementing a refcount so if you have any other references to the array, no memory is freed)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17287863" author="gurwls223" created="Sun, 21 Feb 2021 07:57:11 +0000"  >&lt;p&gt;I think it only fails in the master branch because &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-32953&quot; title=&quot;Lower memory usage in toPandas with Arrow self_destruct&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-32953&quot;&gt;&lt;del&gt;SPARK-32953&lt;/del&gt;&lt;/a&gt; is only merged into master, right? I will change the affect version.&lt;/p&gt;</comment>
                            <comment id="17293893" author="bryanc" created="Tue, 2 Mar 2021 18:11:23 +0000"  >&lt;p&gt;As David said, it depends on what is done in Pandas that might lead to this. I&apos;m not sure why `value_counts()` would cause this error, but other operations should work. I believe you could also workaround by making a copy of the DataFrame yourself. I think this example shows that the self destruct feature should be clearly documented to be experimental and only used if you know absolutely what you are doing.&lt;/p&gt;</comment>
                            <comment id="17293918" author="lidavidm" created="Tue, 2 Mar 2021 18:43:44 +0000"  >&lt;p&gt;I&apos;ve been a bit backlogged but I&apos;ll try to get docs and look at reproducing this soon. (I am similarly confused why value_counts would need a mutable backing array, but likely it&apos;s just an oversight in a parameter declaration somewhere.)&lt;/p&gt;</comment>
                            <comment id="17294838" author="lidavidm" created="Wed, 3 Mar 2021 21:21:07 +0000"  >&lt;p&gt;I&apos;ve checked that the master build of Pandas fixes this specific issue, and I believe it&apos;s due to &lt;a href=&quot;https://github.com/pandas-dev/pandas/commit/f1d4026973bfb650be63cbe87443570aa01935dd#diff-f4f1cb812ad02cac95da4070745323e8cf31dfbcc65da52744bb6721439210bbR37&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this commit&lt;/a&gt;. I&apos;ll add notes to the docs about these sorts of issues in general.&lt;/p&gt;</comment>
                            <comment id="17295396" author="apachespark" created="Thu, 4 Mar 2021 16:38:49 +0000"  >&lt;p&gt;User &apos;lidavidm&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/31738&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/31738&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17311115" author="gurwls223" created="Tue, 30 Mar 2021 04:30:44 +0000"  >&lt;p&gt;Issue resolved by pull request 31738&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/31738&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/31738&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13328561">SPARK-32953</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 33 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0nsog:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>