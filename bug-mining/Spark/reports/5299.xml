<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:56:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-22284] Code of class \&quot;org.apache.spark.sql.catalyst.expressions.GeneratedClass$SpecificUnsafeProjection\&quot; grows beyond 64 KB</title>
                <link>https://issues.apache.org/jira/browse/SPARK-22284</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I am using pySpark 2.1.0 in a production environment, and trying to join two DataFrames, one of which is very large and has complex nested structures.&lt;/p&gt;

&lt;p&gt;Basically, I load both DataFrames and cache them.&lt;br/&gt;
Then, in the large DataFrame, I extract 3 nested values and save them as direct columns.&lt;br/&gt;
Finally, I join on these three columns with the smaller DataFrame.&lt;br/&gt;
This would be a short code for this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
dataFrame.read......cache()
dataFrameSmall.read.......cache()
dataFrame = dataFrame.selectExpr([&lt;span class=&quot;code-quote&quot;&gt;&apos;*&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;nested.Value1 AS Value1&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;nested.Value2 AS Value2&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;nested.Value3 AS Value3&apos;&lt;/span&gt;])
dataFrame = dataFrame.dropDuplicates().join(dataFrameSmall, [&lt;span class=&quot;code-quote&quot;&gt;&apos;Value1&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;Value2&apos;&lt;/span&gt;,Value3&apos;])
dataFrame.count()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And this is the error I get when it gets to the count():&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.spark.SparkException: Job aborted due to stage failure: Task 11 in stage 7.0 failed 4 times, most recent failure: Lost task 11.3 in stage 7.0 (TID 11234, somehost.com, executor 10): java.util.concurrent.ExecutionException: java.lang.Exception: failed to compile: org.codehaus.janino.JaninoRuntimeException: Code of method \&lt;span class=&quot;code-quote&quot;&gt;&quot;apply_1$(Lorg/apache/spark/sql/catalyst/expressions/GeneratedClass$SpecificUnsafeProjection;Lorg/apache/spark/sql/catalyst/InternalRow;)V\&quot;&lt;/span&gt; of class \&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.spark.sql.catalyst.expressions.GeneratedClass$SpecificUnsafeProjection\&quot;&lt;/span&gt; grows beyond 64 KB
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I have seen many tickets with similar issues here, but no proper solution. Most of the fixes are until Spark 2.1.0 so I don&apos;t know if running it on Spark 2.2.0 would fix it. In any case I cannot change the version of Spark since it is in production.&lt;br/&gt;
I have also tried setting &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
spark.sql.codegen.wholeStage=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; but still the same error.&lt;/p&gt;

&lt;p&gt;The job worked well up to now, also with large datasets, but apparently this batch got larger, and that is the only thing that changed. Is there any workaround for this?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13109649">SPARK-22284</key>
            <summary>Code of class \&quot;org.apache.spark.sql.catalyst.expressions.GeneratedClass$SpecificUnsafeProjection\&quot; grows beyond 64 KB</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kiszk">Kazuaki Ishizaki</assignee>
                                    <reporter username="someonehere15">Ben</reporter>
                        <labels>
                    </labels>
                <created>Mon, 16 Oct 2017 08:40:13 +0000</created>
                <updated>Mon, 12 Dec 2022 18:10:38 +0000</updated>
                            <resolved>Fri, 10 Nov 2017 20:18:43 +0000</resolved>
                                    <version>2.1.0</version>
                                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>2.3.0</fixVersion>
                                    <component>Optimizer</component>
                    <component>PySpark</component>
                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16205600" author="srowen" created="Mon, 16 Oct 2017 09:04:40 +0000"  >&lt;p&gt;Without more details, this could be a duplicate of many existing issues, yes. Generally your ability to upgrade wouldn&apos;t dictate when changes are backported, and you should try 2.2. however if you find the fix that addresses this we can try to backport. But if you can&apos;t upgrade then it won&apos;t matter. &lt;/p&gt;</comment>
                            <comment id="16205601" author="someonehere15" created="Mon, 16 Oct 2017 09:09:23 +0000"  >&lt;p&gt;If I upgrade to 2.2.0 then I, for myself at least, would not need a backport anymore, although I would be happy to let you know if it works in 2.2.0 IF I could try it.&lt;br/&gt;
But the problem is exactly the fact that I cannot simply upgrade, at least for now, and wanted to ask if there is any general recommendation or workaround that I could try first, a configuration parameter or else.&lt;br/&gt;
I don&apos;t know what more details I can provide here to investigate. If there is, let me know.&lt;/p&gt;</comment>
                            <comment id="16205604" author="srowen" created="Mon, 16 Oct 2017 09:13:40 +0000"  >&lt;p&gt;What you&apos;ve described is a symptom with many causes. Have a look through JIRA. It would be useful to know if it happens in 2.2 to narrow it down. You could try disabling code gen but that has performance consequences. &lt;/p&gt;</comment>
                            <comment id="16205608" author="someonehere15" created="Mon, 16 Oct 2017 09:15:20 +0000"  >&lt;p&gt;I did try adding&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
--conf &lt;span class=&quot;code-quote&quot;&gt;&quot;spark.sql.codegen.wholeStage=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;in &lt;b&gt;spark-submit&lt;/b&gt;, but the same error occurred.&lt;/p&gt;</comment>
                            <comment id="16206994" author="gurwls223" created="Tue, 17 Oct 2017 04:47:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=someonehere15&quot; class=&quot;user-hover&quot; rel=&quot;someonehere15&quot;&gt;someonehere15&lt;/a&gt;, would you maybe able to provide a self-contained reproducer? I am willing to check it.&lt;/p&gt;</comment>
                            <comment id="16207183" author="viirya" created="Tue, 17 Oct 2017 08:53:33 +0000"  >&lt;p&gt;Btw, we have used &lt;tt&gt;UnsafeProjection&lt;/tt&gt; in many places for expression codegen. Disabling wholestage codegen doesn&apos;t help it. Even non-wholestage code path uses expression codegen.&lt;/p&gt;</comment>
                            <comment id="16210089" author="someonehere15" created="Wed, 18 Oct 2017 21:34:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hyukjin.kwon&quot; class=&quot;user-hover&quot; rel=&quot;hyukjin.kwon&quot;&gt;hyukjin.kwon&lt;/a&gt;, thank you very much for your assistance, but I don&apos;t think I can reproduce it easily.&lt;br/&gt;
Everything has been working fine until now, but it only got stuck in the last batch.&lt;/p&gt;

&lt;p&gt;If &apos;m correct, you are also the developer of spark-xml, which is exactly what I use for reading the source files.&lt;br/&gt;
I read more than a million XML files per batch, and these files have complex nested structures, so a lot of data is parsed into a DataFrame.&lt;br/&gt;
There are cases that the XML files may have very deep levels of nested tags, so I&apos;m not sure if that may be the cause, linking this issue to spark-xml and not the actual join step when the error happens.&lt;/p&gt;

&lt;p&gt;Furthermore, I tried splitting the batch where it got stuck into smaller batches to process. The first half of around 700 thousand files worked, but the second half had the same error. Then I split the second half in 100 thousand files per batch, and then it worked. I cannot make the XML files available, which means I can&apos;t give you a way to reproduce it. I can send you the generated code that is included in the error, but I&apos;m guessing that also doesn&apos;t help. However, if you think the deep nested levels may be a cause, maybe this can provide some insight.&lt;/p&gt;</comment>
                            <comment id="16210943" author="kiszk" created="Thu, 19 Oct 2017 12:37:44 +0000"  >&lt;p&gt;Can you attach the generated code? It may help which `SpecificUnsafeProjection` may cause this exception.&lt;/p&gt;</comment>
                            <comment id="16211169" author="someonehere15" created="Thu, 19 Oct 2017 14:57:02 +0000"  >&lt;p&gt;Sure, I just added it as an attachment.&lt;/p&gt;</comment>
                            <comment id="16211315" author="kiszk" created="Thu, 19 Oct 2017 16:33:30 +0000"  >&lt;p&gt;Thank you for uploading the generated code. This is very helpful. I understood that the very huge method is generated for calculating hash value from many many String columns in struct or array.&lt;br/&gt;
If I correctly remember it, this problem is not be fixed in 2.2 or master.&lt;/p&gt;

&lt;p&gt;I will try to create a repro and submit a PR to hopefully fix this.&lt;/p&gt;</comment>
                            <comment id="16211353" author="kiszk" created="Thu, 19 Oct 2017 16:57:05 +0000"  >&lt;p&gt;I found &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-18207&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;this JIRA&lt;/a&gt; and realized that I created the PR.&lt;br/&gt;
According to the attached code, I imagine that this case uses more complicated columns in a row.&lt;/p&gt;</comment>
                            <comment id="16211906" author="dongjoon" created="Thu, 19 Oct 2017 23:17:14 +0000"  >&lt;p&gt;Ping, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgaido&quot; class=&quot;user-hover&quot; rel=&quot;mgaido&quot;&gt;mgaido&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16212513" author="someonehere15" created="Fri, 20 Oct 2017 11:39:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kiszk&quot; class=&quot;user-hover&quot; rel=&quot;kiszk&quot;&gt;kiszk&lt;/a&gt;, happy to help, and thanks for your assistance.&lt;/p&gt;

&lt;p&gt;So, if I understand correctly, there was a similar ticket and it was solved, but my case is more complicated, right?&lt;br/&gt;
There are some cases in the files where the structures may indeed get very complex.&lt;br/&gt;
Would this case also be solvable?&lt;/p&gt;</comment>
                            <comment id="16214332" author="kiszk" created="Sun, 22 Oct 2017 14:48:39 +0000"  >&lt;p&gt;Yes, there was a similar ticket that was solved. Your case is more complicated case that includes `struct`. I created a repro in my environment. I think that it could be solvable. I will create a PR this week.&lt;/p&gt;

&lt;p&gt;To fix a problem, we usually submit a PR to the master branch. Then, we consider whether the PR could be applicable to previous versions based on risk assessments by committers.&lt;/p&gt;</comment>
                            <comment id="16216611" author="apachespark" created="Tue, 24 Oct 2017 09:36:03 +0000"  >&lt;p&gt;User &apos;kiszk&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19563&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19563&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16248001" author="cloud_fan" created="Fri, 10 Nov 2017 20:18:43 +0000"  >&lt;p&gt;Issue resolved by pull request 19563&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19563&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19563&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13132209">SPARK-23156</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12893056" name="64KB Error.log" size="5283780" author="someonehere15" created="Thu, 19 Oct 2017 14:56:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 1 week, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3lau7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>