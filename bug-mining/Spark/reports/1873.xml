<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:27:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-7624] Task scheduler delay is increasing time over time in spark local mode</title>
                <link>https://issues.apache.org/jira/browse/SPARK-7624</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I am running a simple spark streaming program with spark 1.3.1 in local mode, it receives json string from a socket with rate 50 events per second, it can run well in first 6 hours (although the minor gc count per minute is increasing all the time), after that, i can see that the scheduler delay in every task is significant increased from 10 ms to 100 ms, after 10 hours running, the task delay is about 800 ms and cpu is also increased from 2% to 30%. This causes the steaming job can not finish in one batch interval (5 seconds). I dumped the java memory after 16 hours and can see there are about 200000 &lt;tt&gt;org.apache.spark.scheduler.local.ReviveOffers&lt;/tt&gt; objects in &lt;tt&gt;akka.actor.LightArrayRevolverScheduler$TaskQueue[]&lt;/tt&gt;. Then i checked the code and see only one place may put the &lt;tt&gt;ReviveOffers&lt;/tt&gt; to akka &lt;tt&gt;LightArrayRevolverScheduler&lt;/tt&gt;: the &lt;tt&gt;LocalActor::reviveOffers&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; def reviveOffers() {
    val offers = Seq(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; WorkerOffer(localExecutorId, localExecutorHostname, freeCores))
    val tasks = scheduler.resourceOffers(offers).flatten
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (task &amp;lt;- tasks) {
      freeCores -= scheduler.CPUS_PER_TASK
      executor.launchTask(executorBackend, taskId = task.taskId, attemptNumber = task.attemptNumber,
        task.name, task.serializedTask)
    }

    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (tasks.isEmpty &amp;amp;&amp;amp; scheduler.activeTaskSets.nonEmpty) {
      &lt;span class=&quot;code-comment&quot;&gt;// Try to reviveOffer after 1 second, because scheduler may wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; locality timeout
&lt;/span&gt;      context.system.scheduler.scheduleOnce(1000 millis, self, ReviveOffers)
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I removed the last three lines in this method (the whole &lt;tt&gt;if&lt;/tt&gt; block, which is introduced from &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-4939&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-4939&lt;/a&gt;), it worked smooth after 20 hours running, the scheduler delay is about 10 ms all the time. So there should have some conditions that the ReviveOffers will be duplicate scheduled? I am not sure why this happens, but i feel that this is the root cause of this issue. &lt;/p&gt;

&lt;p&gt;My spark settings:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Memor: 3G&lt;/li&gt;
	&lt;li&gt;CPU: 8 cores&lt;/li&gt;
	&lt;li&gt;Streaming Batch interval: 5 seconds.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Here are my streaming code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;val input = ssc.socketTextStream(
      hostname, port, StorageLevel.MEMORY_ONLY_SER).mapPartitions(
      &lt;span class=&quot;code-comment&quot;&gt;/// parse the json to Order
&lt;/span&gt;      Order(_), preservePartitioning = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
val mresult = input.map(
      v =&amp;gt; (v.customer, UserSpending(v.customer, v.count * v.price, v.timestamp.toLong))).cache()
val tempr  = mresult.window(
            Seconds(firstStageWindowSize), 
            Seconds(firstStageWindowSize)
          ).transform(
            rdd =&amp;gt; rdd.union(rdd).union(rdd).union(rdd)
          )
tempr.count.print
tempr.cache().foreachRDD((rdd, t) =&amp;gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (i &amp;lt;- 1 to 5) {
              val c = rdd.filter(x=&amp;gt;scala.util.Random.nextInt(5) == i).count()
              println(&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;&quot;T: &quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot; + t + &quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;: &quot;&lt;/span&gt;&quot;&quot; + c)
            }
          })
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;========================================================&lt;br/&gt;
Updated at 2015-05-15&lt;br/&gt;
I did print some detail schedule times of the suspect lines in &lt;tt&gt;LocalActor::reviveOffers&lt;/tt&gt;: &lt;font color=&quot;red&quot;&gt;&lt;b&gt;1685343501&lt;/b&gt;&lt;/font&gt; times after 18 hours running.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12829759">SPARK-7624</key>
            <summary>Task scheduler delay is increasing time over time in spark local mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davies">Davies Liu</assignee>
                                    <reporter username="jhu">Jack Hu</reporter>
                        <labels>
                            <label>delay</label>
                            <label>schedule</label>
                    </labels>
                <created>Thu, 14 May 2015 03:13:14 +0000</created>
                <updated>Fri, 22 May 2015 23:03:30 +0000</updated>
                            <resolved>Fri, 22 May 2015 23:03:30 +0000</resolved>
                                    <version>1.3.1</version>
                                    <fixVersion>1.3.2</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14543325" author="srowen" created="Thu, 14 May 2015 07:31:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davies&quot; class=&quot;user-hover&quot; rel=&quot;davies&quot;&gt;davies&lt;/a&gt; thoughts on the impact of those few lines?&lt;/p&gt;</comment>
                            <comment id="14544950" author="davies" created="Fri, 15 May 2015 05:36:36 +0000"  >&lt;p&gt;This is introduced by &lt;a href=&quot;https://github.com/apache/spark/pull/4147&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/4147&lt;/a&gt;, I will revert it.&lt;/p&gt;</comment>
                            <comment id="14544962" author="apachespark" created="Fri, 15 May 2015 05:47:06 +0000"  >&lt;p&gt;User &apos;davies&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/6172&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/6172&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14544978" author="davies" created="Fri, 15 May 2015 05:58:54 +0000"  >&lt;p&gt;In the context of Spark Streaming, there could be some long running tasks (receivers), after the patch &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, LocalBackend will schedule another ReviveOffer if no task could be scheduled, becoming infinite loop. And, each new stage could introduce a new ReviveOffer infinite loop, the scheduler will become slower and slower.&lt;/p&gt;

&lt;p&gt;It&apos;s not easy to tell when we should schedule another ReviveOffer or not, so I&apos;d like to revert this patch, because the original problem is already resolved by &lt;a href=&quot;https://github.com/apache/spark/pull/3779&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/3779&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/spark/pull/4147&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/4147&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14549344" author="joshrosen" created="Mon, 18 May 2015 22:07:09 +0000"  >&lt;p&gt;Does this only affect local mode, or does it also affect cluster modes?&lt;/p&gt;</comment>
                            <comment id="14549537" author="joshrosen" created="Mon, 18 May 2015 23:57:10 +0000"  >&lt;p&gt;I&apos;ve merged Davies&apos; patch for 1.4 but we still need a 1.3.2 backport.&lt;/p&gt;</comment>
                            <comment id="14555284" author="apachespark" created="Thu, 21 May 2015 23:35:12 +0000"  >&lt;p&gt;User &apos;davies&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/6337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/6337&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14556962" author="davies" created="Fri, 22 May 2015 23:03:15 +0000"  >&lt;p&gt;Had merged into 1.3 branch. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 26 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2eppj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>