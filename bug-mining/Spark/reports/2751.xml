<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:34:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-11725] Let UDF to handle null value</title>
                <link>https://issues.apache.org/jira/browse/SPARK-11725</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I notice that currently spark will take the long field as -1 if it is null.&lt;br/&gt;
Here&apos;s the sample code.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;sqlContext.udf.register(&lt;span class=&quot;code-quote&quot;&gt;&quot;f&quot;&lt;/span&gt;, (x:Int)=&amp;gt;x+1)
df.withColumn(&lt;span class=&quot;code-quote&quot;&gt;&quot;age2&quot;&lt;/span&gt;, expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;f(age)&quot;&lt;/span&gt;)).show()

&lt;span class=&quot;code-comment&quot;&gt;//////////////// Output ///////////////////////
&lt;/span&gt;+----+-------+----+
| age|   name|age2|
+----+-------+----+
|&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|Michael|   0|
|  30|   Andy|  31|
|  19| Justin|  20|
+----+-------+----+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think for the null value we have 3 options&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Use a special value to represent it (what spark does now)&lt;/li&gt;
	&lt;li&gt;Always return null if the udf input has null value argument&lt;/li&gt;
	&lt;li&gt;Let udf itself to handle null&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I would prefer the third option &lt;/p&gt;</description>
                <environment></environment>
        <key id="12912787">SPARK-11725</key>
            <summary>Let UDF to handle null value</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cloud_fan">Wenchen Fan</assignee>
                                    <reporter username="zjffdu">Jeff Zhang</reporter>
                        <labels>
                            <label>releasenotes</label>
                    </labels>
                <created>Fri, 13 Nov 2015 10:24:11 +0000</created>
                <updated>Wed, 5 Apr 2017 08:23:27 +0000</updated>
                            <resolved>Wed, 18 Nov 2015 18:23:41 +0000</resolved>
                                                    <fixVersion>1.6.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="15003836" author="zjffdu" created="Fri, 13 Nov 2015 10:35:21 +0000"  >&lt;p&gt;And  I found that PySpark will allow the UDF to handle null value, but seems scala UDF didn&apos;t do that. &lt;/p&gt;</comment>
                            <comment id="15003943" author="hvanhovell" created="Fri, 13 Nov 2015 12:45:04 +0000"  >&lt;p&gt;&lt;tt&gt;Int&lt;/tt&gt; is a primitive. So there is no way to express &lt;tt&gt;null&lt;/tt&gt;; in these cases scala will default to &lt;tt&gt;0&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Use the boxed of the primitive version if you need nullability. For example:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;val df = Seq(
  (null, &quot;Michael&quot;),
  (Integer.valueOf(30), &quot;Andy&quot;),
  (Integer.valueOf(19), &quot;Justin&quot;)).toDF(&quot;age&quot;, &quot;name&quot;)
  
val f = udf((x: Integer) =&amp;gt; {
    if (x != null) Integer.valueOf(x + 1)
    else null
})
df.withColumn(&quot;age2&quot;, f($&quot;age&quot;)).show
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Would return:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+----+-------+----+
| age|   name|age2|
+----+-------+----+
|null|Michael|null|
|  30|   Andy|  31|
|  19| Justin|  20|
+----+-------+----+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15003950" author="zjffdu" created="Fri, 13 Nov 2015 12:50:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;So there is no way to express null; in these case scala will default to 0.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Not sure why it will default to -1 according my experiment. &lt;/p&gt;</comment>
                            <comment id="15003960" author="hvanhovell" created="Fri, 13 Nov 2015 13:12:54 +0000"  >&lt;p&gt;-1 is the default value for an Int in the code generator. That shouldn&apos;t leak into a UDF.&lt;/p&gt;

&lt;p&gt;The fact remains is that using a primitive parameter in a UDF and calling that UDF with a nullable column is not good practice and should be avoided.&lt;/p&gt;</comment>
                            <comment id="15005208" author="zjffdu" created="Sat, 14 Nov 2015 06:45:20 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hvanhovell&quot; class=&quot;user-hover&quot; rel=&quot;hvanhovell&quot;&gt;hvanhovell&lt;/a&gt; Should we prevent use primitive in UDF arguments ? otherwise user may get confusing result. &lt;/p&gt;</comment>
                            <comment id="15005391" author="hvanhovell" created="Sat, 14 Nov 2015 13:34:52 +0000"  >&lt;p&gt;I&apos;d rather add a warning than prevent this from happening.&lt;/p&gt;

&lt;p&gt;I cannot reproduce the &lt;tt&gt;-1&lt;/tt&gt; default values on Spark 1.5.2. For example:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;val id = udf((x: Int) =&amp;gt; {
    x
})
val q = sqlContext
  .range(1 &amp;lt;&amp;lt; 10)
  .select($&quot;id&quot;, when(($&quot;id&quot; mod 2) === 1, $&quot;id&quot;).as(&quot;val1&quot;))
  .select($&quot;id&quot;, $&quot;val1&quot;, id($&quot;val1&quot;).as(&quot;val2&quot;))
q.show

// Result:
id: org.apache.spark.sql.UserDefinedFunction = UserDefinedFunction(&amp;lt;function1&amp;gt;,IntegerType,List(IntegerType))
q: org.apache.spark.sql.DataFrame = [id: bigint, val1: bigint, val2: int]
+---+----+----+
| id|val1|val2|
+---+----+----+
|  0|null|   0|
|  1|   1|   1|
|  2|null|   0|
|  3|   3|   3|
|  4|null|   0|
|  5|   5|   5|
|  6|null|   0|
|  7|   7|   7|
|  8|null|   0|
|  9|   9|   9|
| 10|null|   0|
| 11|  11|  11|
| 12|null|   0|
| 13|  13|  13|
| 14|null|   0|
| 15|  15|  15|
| 16|null|   0|
| 17|  17|  17|
| 18|null|   0|
| 19|  19|  19|
+---+----+----+
only showing top 20 rows
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What version of Spark are you using?&lt;/p&gt;

</comment>
                            <comment id="15005399" author="zjffdu" created="Sat, 14 Nov 2015 13:48:30 +0000"  >&lt;p&gt;I am on master &lt;/p&gt;</comment>
                            <comment id="15005433" author="hvanhovell" created="Sat, 14 Nov 2015 14:58:16 +0000"  >&lt;p&gt;I can reproduce the &lt;tt&gt;-1&lt;/tt&gt; default values on master. This is not the expected behavior.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marmbrus&quot; class=&quot;user-hover&quot; rel=&quot;marmbrus&quot;&gt;marmbrus&lt;/a&gt;/&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rxin&quot; class=&quot;user-hover&quot; rel=&quot;rxin&quot;&gt;rxin&lt;/a&gt; Any what causes this?&lt;/p&gt;</comment>
                            <comment id="15005509" author="rxin" created="Sat, 14 Nov 2015 17:38:34 +0000"  >&lt;p&gt;This is the problem of default value in codegen I suspect.  &lt;a href=&quot;https://github.com/apache/spark/blob/22e96b87fb0a0eb4f2f1a8fc29a742ceabff952a/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/expressions/codegen/CodeGenerator.scala#L229&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/22e96b87fb0a0eb4f2f1a8fc29a742ceabff952a/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/expressions/codegen/CodeGenerator.scala#L229&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15008800" author="apachespark" created="Tue, 17 Nov 2015 15:12:03 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/9770&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/9770&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15011597" author="marmbrus" created="Wed, 18 Nov 2015 18:23:41 +0000"  >&lt;p&gt;Issue resolved by pull request 9770&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/9770&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/9770&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15134322" author="onetoinfinity@yahoo.com" created="Fri, 5 Feb 2016 15:28:20 +0000"  >&lt;p&gt;I would argue this is a rather inappropriate solution. Scala does not normally distinguish between primitive and boxed types, with Long for example representing both. &lt;/p&gt;

&lt;p&gt;So having Long args in a function and then testing for null is a valid thing to do in Scala.&lt;/p&gt;

&lt;p&gt;This is made worse by the fact that the behaviour is actually not documented anywhere, so results in very strange and unexpected behaviour.&lt;/p&gt;

&lt;p&gt;By the principle of least surprise, I would suggest either (or both) of:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Throwing an error when a null value cannot be passed to a UDF that has been compiled to only accept nulls.&lt;/li&gt;
	&lt;li&gt;Using Option&lt;span class=&quot;error&quot;&gt;&amp;#91;T&amp;#93;&lt;/span&gt; as a UDF arg to signal that the function accepts nulls.&lt;/li&gt;
&lt;/ul&gt;




</comment>
                            <comment id="15135264" author="marmbrus" created="Fri, 5 Feb 2016 23:36:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=onetoinfinity%40yahoo.com&quot; class=&quot;user-hover&quot; rel=&quot;onetoinfinity@yahoo.com&quot;&gt;onetoinfinity@yahoo.com&lt;/a&gt;, unfortunatly I don&apos;t think that that is true.  &lt;tt&gt;Long&lt;/tt&gt; and other primitive types inherit from &lt;tt&gt;AnyVal&lt;/tt&gt; while only things that inherit from &lt;tt&gt;AnyRef&lt;/tt&gt; can be &lt;tt&gt;null&lt;/tt&gt;.  If you attempt a comparison between a primitive and null, the compiler will tell you this.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;scala&amp;gt; 1 == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&amp;lt;console&amp;gt;:8: warning: comparing values of types Int and Null using `==&apos; will always yield &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
              1 == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
&lt;p&gt;Throwing an error when a null value cannot be passed to a UDF that has been compiled to only accept nulls.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;While this might be reasonable in a greenfield situation, I don&apos;t think we can change semantics on our users like that.  We chose this semantic because its pretty common for databases to use null for error conditions, rather than failing the whole query.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Using &lt;tt&gt;Option[T]&lt;/tt&gt; as a UDF arg to signal that the function accepts nulls.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I like this idea and I actually expected it to work.  As you can see it already works in datasets:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Seq((1, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;(1)), (2, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)).toDF().as[(Int, Option[Int])].collect()
res0: Array[(Int, Option[Int])] = Array((1,Some(1)), (2,None))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We should definitely be using the same logic when converting arguments for UDFs.&lt;/p&gt;</comment>
                            <comment id="15135357" author="zjffdu" created="Sat, 6 Feb 2016 00:45:58 +0000"  >&lt;p&gt;+1 for Option&lt;span class=&quot;error&quot;&gt;&amp;#91;T&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="15135447" author="onetoinfinity@yahoo.com" created="Sat, 6 Feb 2016 01:59:58 +0000"  >&lt;p&gt;You&apos;re right, sorry it seems I lost track of which Scala weirdness applies here: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;scala&amp;gt; def i : Int = (&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : java.lang.&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;)
i: Int

scala&amp;gt; i == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&amp;lt;console&amp;gt;:22: warning: comparing values of types Int and Null using `==&apos; will always yield &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
              i == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
                ^
java.lang.NullPointerException
	at scala.Predef$.Integer2int(Predef.scala:392)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;At least the previous behaviour of passing 0 as default value was consistent with this specific Scala weirdness:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;scala&amp;gt; val i: Int  = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;.asInstanceOf[Int]
i: Int = 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But the current behaviour of &quot;null propagation&quot; seems even more confusing semantically, since for example one can have an UDF with multiple args and just not calling the UDF when any of the args is null hardly can make any sense semantically.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def udf(i : Int, l: &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;, s: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;) = ...

sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select udf(i, l, s) from df&quot;&lt;/span&gt;) 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I understand the need to not break existing code but perhaps having a more clear and documented UDF spec perhaps with the use of Option would really help here.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13061485">SPARK-20212</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 41 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ocpj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333083">1.6.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>