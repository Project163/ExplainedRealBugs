<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:54:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-21228] InSet incorrect handling of structs</title>
                <link>https://issues.apache.org/jira/browse/SPARK-21228</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;In InSet it&apos;s possible that hset contains GenericInternalRows while child returns UnsafeRows (and vice versa). InSet uses hset.contains (both in doCodeGen and eval) which will always be false in this case.&lt;/p&gt;

&lt;p&gt;The following code reproduces the problem:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;spark.conf.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;spark.sql.optimizer.inSetConversionThreshold&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;) &lt;span class=&quot;code-comment&quot;&gt;// the &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; is 10 which requires a longer query text to repro
&lt;/span&gt;
spark.range(1, 10).selectExpr(&lt;span class=&quot;code-quote&quot;&gt;&quot;named_struct(&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, id, &lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;, id) as a&quot;&lt;/span&gt;).createOrReplaceTempView(&lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;)

sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select * from (select min(a) as minA from A) A where minA in (named_struct(&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, 1L, &lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;, 1L),named_struct(&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, 2L, &lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;, 2L),named_struct(&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, 3L, &lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;, 3L))&quot;&lt;/span&gt;).show &lt;span class=&quot;code-comment&quot;&gt;// the Aggregate here will &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; UnsafeRows &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; the list of structs that will become hset will be GenericInternalRows
&lt;/span&gt;+----+
|minA|
+----+
+----+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In.doCodeGen uses compareStructs and seems to work. In.eval might not work but not sure how to reproduce.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;spark.conf.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;spark.sql.optimizer.inSetConversionThreshold&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;3&quot;&lt;/span&gt;) &lt;span class=&quot;code-comment&quot;&gt;// now it will not use InSet
&lt;/span&gt;sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select * from (select min(a) as minA from A) A where minA in (named_struct(&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, 1L, &lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;, 1L),named_struct(&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, 2L, &lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;, 2L),named_struct(&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, 3L, &lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;, 3L))&quot;&lt;/span&gt;).show

+-----+
| minA|
+-----+
|[1,1]|
+-----+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Solution could be either to do safe&amp;lt;-&amp;gt;unsafe conversion in InSet or not trigger InSet optimization at all in this case.&lt;br/&gt;
Need to investigate if In.eval is affected.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13082826">SPARK-21228</key>
            <summary>InSet incorrect handling of structs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bograd">Bogdan Raducanu</assignee>
                                    <reporter username="bograd">Bogdan Raducanu</reporter>
                        <labels>
                    </labels>
                <created>Tue, 27 Jun 2017 13:50:07 +0000</created>
                <updated>Sat, 8 Jul 2017 12:15:43 +0000</updated>
                            <resolved>Thu, 6 Jul 2017 17:06:27 +0000</resolved>
                                    <version>2.2.0</version>
                                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>2.3.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16064945" author="bograd" created="Tue, 27 Jun 2017 14:46:25 +0000"  >&lt;p&gt;I tested manually (since there is no flag to disable codegen for expressions) that In.eval also fails, so only In.doCodeGen appears correct.&lt;/p&gt;</comment>
                            <comment id="16064970" author="bograd" created="Tue, 27 Jun 2017 15:06:38 +0000"  >&lt;p&gt;InSubquery.doCodeGen is using InSet directly (although InSubquery itself is never used) so a fix should consider this too.&lt;/p&gt;</comment>
                            <comment id="16066457" author="apachespark" created="Wed, 28 Jun 2017 13:02:03 +0000"  >&lt;p&gt;User &apos;bogdanrdc&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/18455&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18455&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16077985" author="apachespark" created="Fri, 7 Jul 2017 11:49:03 +0000"  >&lt;p&gt;User &apos;bogdanrdc&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/18563&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18563&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 19 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3gsbr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>