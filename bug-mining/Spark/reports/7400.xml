<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:18:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-32672] Data corruption in some cached compressed boolean columns</title>
                <link>https://issues.apache.org/jira/browse/SPARK-32672</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I found that when sorting some boolean data into the cache that the results can change when the data is read back out.&lt;/p&gt;

&lt;p&gt;It needs to be a non-trivial amount of data, and it is highly dependent on the order of the data.  If I disable compression in the cache the issue goes away.  I was able to make this happen in 3.0.0.  I am going to try and reproduce it in other versions too.&lt;/p&gt;

&lt;p&gt;I&apos;ll attach the parquet file with boolean data in an order that causes this to happen. As you can see after the data is cached a single null values switches over to be false.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
scala&amp;gt; val bad_order = spark.read.parquet(&lt;span class=&quot;code-quote&quot;&gt;&quot;./bad_order.snappy.parquet&quot;&lt;/span&gt;)
bad_order: org.apache.spark.sql.DataFrame = [b: &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;]                        

scala&amp;gt; bad_order.groupBy(&lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;).count.show
+-----+-----+
|    b|count|
+-----+-----+
| &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;| 7153|
| &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;|54334|
|&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;|54021|
+-----+-----+


scala&amp;gt; bad_order.cache()
res1: bad_order.type = [b: &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;]

scala&amp;gt; bad_order.groupBy(&lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;).count.show
+-----+-----+
|    b|count|
+-----+-----+
| &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;| 7152|
| &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;|54334|
|&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;|54022|
+-----+-----+


scala&amp;gt; 

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13323837">SPARK-32672</key>
            <summary>Data corruption in some cached compressed boolean columns</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="revans2">Robert Joseph Evans</assignee>
                                    <reporter username="revans2">Robert Joseph Evans</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Thu, 20 Aug 2020 21:24:03 +0000</created>
                <updated>Mon, 12 Dec 2022 18:11:00 +0000</updated>
                            <resolved>Sat, 22 Aug 2020 02:09:14 +0000</resolved>
                                    <version>2.3.4</version>
                    <version>2.4.6</version>
                    <version>3.0.0</version>
                    <version>3.0.1</version>
                    <version>3.1.0</version>
                                    <fixVersion>2.4.7</fixVersion>
                    <fixVersion>3.0.1</fixVersion>
                    <fixVersion>3.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17181459" author="revans2" created="Thu, 20 Aug 2020 21:40:26 +0000"  >&lt;p&gt;I verified that this is still happening on 3.0.2-SNAPSHOT&lt;/p&gt;</comment>
                            <comment id="17181466" author="revans2" created="Thu, 20 Aug 2020 21:54:39 +0000"  >&lt;p&gt;I verified that this is still happening on 3.1.0-SNAPSHOT  too&lt;/p&gt;</comment>
                            <comment id="17181468" author="tgraves" created="Thu, 20 Aug 2020 21:58:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ruifengz&quot; class=&quot;user-hover&quot; rel=&quot;ruifengz&quot;&gt;ruifengz&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17181478" author="revans2" created="Thu, 20 Aug 2020 22:20:59 +0000"  >&lt;p&gt;I did a little debugging and found that `BooleanBitSet$Encoder` is being used for compression.  There are other data orderings that use the same encoder and produce correct results though.&lt;/p&gt;</comment>
                            <comment id="17181486" author="revans2" created="Thu, 20 Aug 2020 22:45:49 +0000"  >&lt;p&gt;I added some debugging to the compression code and it looks like in the 8th CompressedBatch of 10,000 entries the number of nulls seen was different from the number expected.&lt;/p&gt;

&lt;p&gt;619 expected and 618 seen.  I&apos;ll try to debug this a bit more tomorrow.&lt;/p&gt;</comment>
                            <comment id="17181553" author="cltlfcjin" created="Fri, 21 Aug 2020 02:51:44 +0000"  >&lt;p&gt;Changed to Critical, Blocker is reserved for committer&lt;/p&gt;</comment>
                            <comment id="17181632" author="kabhwan" created="Fri, 21 Aug 2020 05:56:06 +0000"  >&lt;p&gt;Just FYI, he&apos;s a PMC member. And correctness issue goes normally a blocker unless there&apos;s some strong reason to not address the issue right now.&lt;/p&gt;</comment>
                            <comment id="17181867" author="tgraves" created="Fri, 21 Aug 2020 13:00:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cltlfcjin&quot; class=&quot;user-hover&quot; rel=&quot;cltlfcjin&quot;&gt;cltlfcjin&lt;/a&gt;&#160; Please do not be changing priority just because people are not committers. You should first evaluate what they are reporting. &#160;If you don&apos;t think its a blocker then we should state why the reason.&lt;/p&gt;

&lt;p&gt;I looked at this after it was filed and added correctness tag and it was already marked as Blocker so I didn&apos;t need to change it. &#160;As you can see from&#160;&lt;a href=&quot;https://spark.apache.org/contributing.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://spark.apache.org/contributing.html,&lt;/a&gt;&#160;correctness issues should be marked as a blocker at least until it&apos;s investigated and discussed.&#160;&lt;/p&gt;</comment>
                            <comment id="17181868" author="revans2" created="Fri, 21 Aug 2020 13:00:36 +0000"  >&lt;p&gt;So I am able to reduce the corruption down to just a single 10,000 row chunk, and still get it to happen. I&apos;ll post a new parquet file soon that will hopefully make debugging a little simpler.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
scala&amp;gt; val bad_order = spark.read.parquet(&lt;span class=&quot;code-quote&quot;&gt;&quot;/home/roberte/src/rapids-plugin-4-spark/integration_tests/bad_order.snappy.parquet&quot;&lt;/span&gt;).selectExpr(&lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;monotonically_increasing_id() as id&quot;&lt;/span&gt;).where(col(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;)&amp;gt;=70000 and col(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;) &amp;lt; 80000)
bad_order: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [b: &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;, id: bigint]

scala&amp;gt; bad_order.groupBy(&lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;).count.show
+-----+-----+
|    b|count|
+-----+-----+
| &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|  619|
| &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;| 4701|
|&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;| 4680|
+-----+-----+


scala&amp;gt; bad_order.cache()
res2: bad_order.type = [b: &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;, id: bigint]

scala&amp;gt; bad_order.groupBy(&lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;).count.show
+-----+-----+
|    b|count|
+-----+-----+
| &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|  618|
| &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;| 4701|
|&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;| 4681|
+-----+-----+

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17181873" author="revans2" created="Fri, 21 Aug 2020 13:15:37 +0000"  >&lt;p&gt;OK reading through the code I understand what is happening now.  The compression format ignores nulls, which are stored separately.  As such the bit set stored is only for non-null boolean values/bits. The number of entries stored in the compression format is  the number of non-null boolean values that are stored.&lt;/p&gt;

&lt;p&gt;So the stopping condition on a batch decompress.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (visitedLocal &amp;lt; countLocal) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;skips all of null values at the end.  But because the length of the column is known ahead of time it falls back to the default value which is false.&lt;/p&gt;

&lt;p&gt;I&apos;ll try to get a patch up shortly to fix this.&lt;/p&gt;</comment>
                            <comment id="17181909" author="apachespark" created="Fri, 21 Aug 2020 14:03:25 +0000"  >&lt;p&gt;User &apos;revans2&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29506&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29506&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17181910" author="apachespark" created="Fri, 21 Aug 2020 14:03:46 +0000"  >&lt;p&gt;User &apos;revans2&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29506&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29506&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17182156" author="dongjoon" created="Fri, 21 Aug 2020 21:19:57 +0000"  >&lt;p&gt;Thank you, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=revans2&quot; class=&quot;user-hover&quot; rel=&quot;revans2&quot;&gt;revans2&lt;/a&gt;. &lt;/p&gt;</comment>
                            <comment id="17182224" author="gurwls223" created="Sat, 22 Aug 2020 02:09:14 +0000"  >&lt;p&gt;Issue resolved by pull request 29506&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29506&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29506&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17182225" author="gurwls223" created="Sat, 22 Aug 2020 02:24:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=revans2&quot; class=&quot;user-hover&quot; rel=&quot;revans2&quot;&gt;revans2&lt;/a&gt; is a PMC, and it is a correctness issue. This indeed is a blocker. I think the initial action was a mistake.&lt;/p&gt;

&lt;p&gt;I think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cltlfcjin&quot; class=&quot;user-hover&quot; rel=&quot;cltlfcjin&quot;&gt;cltlfcjin&lt;/a&gt; referred:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Set to Major or below; higher priorities are generally reserved for committers to set. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I fully agree that ideally we should first evaluate what they are reporting with stating the reason.&lt;/p&gt;

&lt;p&gt;The problem is that we don&apos;t have a lot of manpower here in triaging/managing JIRAs. It&apos;s just that there are not so many people who do.&lt;br/&gt;
Given this situation, I would like to encourage to aggressively triage - there are many JIRAs that set priority incorrectly.&lt;/p&gt;

&lt;p&gt;For example, many JIRAs just ask questions and/or investigations with setting the priority as a blocker, presumably expecting quicker responses and actions. Such blockers matter for release managers.&lt;/p&gt;

&lt;p&gt;If we want more fine-grained and ideal evaluation of JIRAs, I would encourage our PMC members/committers/contributors to take a look more often.&lt;/p&gt;

&lt;p&gt;We also ended up with introducing auto-resolving JIRAs that sets affect versions as EOL Spark versions, due to the lack of the manpower in JIRA management (which I don&apos;t think this is ideal but I think it was inevitable) for the same reason.&lt;/p&gt;</comment>
                            <comment id="17182345" author="revans2" created="Sat, 22 Aug 2020 12:41:53 +0000"  >&lt;p&gt;Honestly, it is not a big deal what happened.  I have worked on enough open-source projects that I know that all of this is best-effort run by volunteers.  Plus my involvement in the Spark project has not been frequent enough for a lot of people to know that I am a PMC member and honestly I have not been involved enough lately to know the process myself.  So I am happy to have people correct me or treat me like I am a contributor instead. The important thing is that we fixed the bug, and it should start to roll out soon.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13072712">SPARK-20783</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13010159" name="bad_order.snappy.parquet" size="8210" author="revans2" created="Thu, 20 Aug 2020 21:24:39 +0000"/>
                            <attachment id="13010217" name="small_bad.snappy.parquet" size="1597" author="revans2" created="Fri, 21 Aug 2020 13:02:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 12 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0hyqg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>