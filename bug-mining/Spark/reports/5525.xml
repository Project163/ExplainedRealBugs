<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:58:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-13983] HiveThriftServer2 can not get &quot;--hiveconf&quot; or &apos;&apos;--hivevar&quot; variables since 1.6 version (both multi-session and single session)</title>
                <link>https://issues.apache.org/jira/browse/SPARK-13983</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;HiveThriftServer2 should be able to get &quot;&amp;#45;-hiveconf&quot; or &apos;&apos;&amp;#45;&amp;#45;hivevar&quot; variables from JDBC client, either from command line parameter of beeline, such as&lt;br/&gt;
&lt;tt&gt;beeline --hiveconf spark.sql.shuffle.partitions=3 --hivevar db_name=default&lt;/tt&gt;&lt;br/&gt;
or from JDBC connection string, like&lt;br/&gt;
&lt;tt&gt;jdbc:hive2://localhost:10000?spark.sql.shuffle.partitions=3#db_name=default&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;this worked in spark version 1.5.x, but after upgraded to 1.6, it doesn&apos;t work.&lt;/p&gt;

&lt;p&gt;to reproduce this issue, try to connect to HiveThriftServer2 with beeline:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;bin/beeline -u jdbc:hive2:&lt;span class=&quot;code-comment&quot;&gt;//localhost:10000 \
&lt;/span&gt;            --hiveconf spark.sql.shuffle.partitions=3 \
            --hivevar db_name=&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;or&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;bin/beeline -u jdbc:hive2:&lt;span class=&quot;code-comment&quot;&gt;//localhost:10000?spark.sql.shuffle.partitions=3#db_name=&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;will get following results:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;0: jdbc:hive2:&lt;span class=&quot;code-comment&quot;&gt;//localhost:10000&amp;gt; set spark.sql.shuffle.partitions;
&lt;/span&gt;+-------------------------------+--------+--+
|              key              | value  |
+-------------------------------+--------+--+
| spark.sql.shuffle.partitions  | 200    |
+-------------------------------+--------+--+
1 row selected (0.192 seconds)
0: jdbc:hive2:&lt;span class=&quot;code-comment&quot;&gt;//localhost:10000&amp;gt; use ${db_name};
&lt;/span&gt;Error: org.apache.spark.sql.AnalysisException: cannot recognize input near &lt;span class=&quot;code-quote&quot;&gt;&apos;$&apos;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;{&apos;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;db_name&apos;&lt;/span&gt; in &lt;span class=&quot;code-keyword&quot;&gt;switch&lt;/span&gt; database statement; line 1 pos 4 (state=,code=0)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;-&lt;/p&gt;

&lt;p&gt;but this bug does not affect current versions of spark-sql CLI, following commands works:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;bin/spark-sql --master local[2] \
              --hiveconf spark.sql.shuffle.partitions=3 \
              --hivevar db_name=&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;

spark-sql&amp;gt; set spark.sql.shuffle.partitions
spark.sql.shuffle.partitions   3
Time taken: 1.037 seconds, Fetched 1 row(s)

spark-sql&amp;gt; use ${db_name};
OK
Time taken: 1.697 seconds
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;so I think it may caused by this change: &lt;a href=&quot;https://github.com/apache/spark/pull/8909&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/8909&lt;/a&gt; ( &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-10810&quot; title=&quot;Improve session management for SQL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-10810&quot;&gt;&lt;del&gt;SPARK-10810&lt;/del&gt;&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-10902&quot; title=&quot;Hive UDF current_database() does not work&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-10902&quot;&gt;&lt;del&gt;SPARK-10902&lt;/del&gt;&lt;/a&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Improve session management in SQL )&lt;/p&gt;

&lt;p&gt;perhaps by calling &lt;tt&gt;hiveContext.newSession&lt;/tt&gt;, the variables from &lt;tt&gt;sessionConf&lt;/tt&gt; were not loaded into the new session? (&lt;a href=&quot;https://github.com/apache/spark/pull/8909/files#diff-8f8b7f4172e8a07ff20a4dbbbcc57b1dR69&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/8909/files#diff-8f8b7f4172e8a07ff20a4dbbbcc57b1dR69&lt;/a&gt;)&lt;/p&gt;</description>
                <environment>&lt;p&gt;ubuntu, spark 1.6.0 standalone, spark 1.6.1 standalone&lt;br/&gt;
(tried spark branch-1.6 snapshot as well)&lt;br/&gt;
compiled with scala 2.10.5 and hadoop 2.6&lt;br/&gt;
(-Phadoop-2.6 -Psparkr -Phive -Phive-thriftserver)&lt;/p&gt;</environment>
        <key id="12951324">SPARK-13983</key>
            <summary>HiveThriftServer2 can not get &quot;--hiveconf&quot; or &apos;&apos;--hivevar&quot; variables since 1.6 version (both multi-session and single session)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yumwang">Yuming Wang</assignee>
                                    <reporter username="chutium">Teng Qiu</reporter>
                        <labels>
                    </labels>
                <created>Thu, 17 Mar 2016 20:17:36 +0000</created>
                <updated>Thu, 1 Feb 2018 18:37:42 +0000</updated>
                            <resolved>Thu, 1 Feb 2018 18:37:42 +0000</resolved>
                                    <version>1.6.0</version>
                    <version>1.6.1</version>
                                    <fixVersion>2.3.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="15200328" author="davies" created="Thu, 17 Mar 2016 20:40:14 +0000"  >&lt;p&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lian+cheng&quot; class=&quot;user-hover&quot; rel=&quot;lian cheng&quot;&gt;lian cheng&lt;/a&gt; Could you help to look at this one?&lt;/p&gt;</comment>
                            <comment id="15200366" author="chutium" created="Thu, 17 Mar 2016 20:59:22 +0000"  >&lt;p&gt;also tried start the server in single session mode: &lt;tt&gt;sbin/start-thriftserver.sh --master spark://xxx:7077 --conf spark.sql.hive.thriftServer.singleSession=true&lt;/tt&gt;, got same error with beeline&lt;/p&gt;</comment>
                            <comment id="15200661" author="chutium" created="Thu, 17 Mar 2016 23:58:27 +0000"  >&lt;p&gt;now i can confirm that this issue was caused by PR &lt;a href=&quot;https://github.com/apache/spark/pull/8909&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/8909&lt;/a&gt; (&lt;a href=&quot;https://github.com/apache/spark/commit/3390b400d04e40f767d8a51f1078fcccb4e64abd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/3390b400d04e40f767d8a51f1078fcccb4e64abd&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;i compiled its parent commit &lt;a href=&quot;https://github.com/apache/spark/commit/84ea287178247c163226e835490c9c70b17d8d3b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/84ea287178247c163226e835490c9c70b17d8d3b&lt;/a&gt; , &quot;&amp;#45;&amp;#45;hiveconf&quot; or &apos;&apos;&amp;#45;&amp;#45;hivevar&quot; worked.&lt;/p&gt;

&lt;p&gt;and compiled rev. 3390b400d04e40f767d8a51f1078fcccb4e64abd , got this issue.&lt;/p&gt;

&lt;p&gt;i reviewed this PR again, but do not know much about this internal magic... want only list here some points, that may be problematic...&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/8909/files#diff-72dcd8f81a51c8a815159fdf0332acdcL301&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/8909/files#diff-72dcd8f81a51c8a815159fdf0332acdcL301&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/8909/files#diff-8f8b7f4172e8a07ff20a4dbbbcc57b1dR69&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/8909/files#diff-8f8b7f4172e8a07ff20a4dbbbcc57b1dR69&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/8909/files#diff-ff50aea397a607b79df9bec6f2a841dbR108&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/8909/files#diff-ff50aea397a607b79df9bec6f2a841dbR108&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/8909/files#diff-ff50aea397a607b79df9bec6f2a841dbR525&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/8909/files#diff-ff50aea397a607b79df9bec6f2a841dbR525&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;hope this can help you to find the actual bug&lt;/p&gt;</comment>
                            <comment id="15256139" author="chutium" created="Mon, 25 Apr 2016 09:26:23 +0000"  >&lt;p&gt;Any update would be much appreciated... we are still using 1.5.2 due to this issue... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15258139" author="lian cheng" created="Tue, 26 Apr 2016 14:09:33 +0000"  >&lt;p&gt;Here&apos;s my (incomplete) finding:&lt;/p&gt;

&lt;p&gt;Configurations set using &lt;tt&gt;-hiveconf&lt;/tt&gt; and &lt;tt&gt;-hivevar&lt;/tt&gt; are set to the current &lt;tt&gt;SessionState&lt;/tt&gt; after &lt;a href=&quot;https://github.com/apache/spark/blob/branch-1.6/sql/hive-thriftserver/src/main/scala/org/apache/spark/sql/hive/thriftserver/SparkSQLSessionManager.scala#L68-L70&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;calling SessionManager.openSession here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;In 1.5, these configurations are populated implicitly since &lt;tt&gt;SessionState&lt;/tt&gt; is thread-local.&lt;/p&gt;

&lt;p&gt;In 1.6, we create a new &lt;tt&gt;HiveContext&lt;/tt&gt; using &lt;tt&gt;HiveContext.newSession&lt;/tt&gt; under multi-session mode, which then &lt;a href=&quot;https://github.com/apache/spark/blob/branch-1.6/sql/hive/src/main/scala/org/apache/spark/sql/hive/HiveContext.scala#L119&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;creates a new execution Hive client&lt;/a&gt;. My theory is that, &lt;tt&gt;ClientWrapper.newSession&lt;/tt&gt; ignores the current &lt;tt&gt;SessionState&lt;/tt&gt; and simply creates a new one, thus configurations set via CLI flags are dropped.&lt;/p&gt;

&lt;p&gt;I haven&apos;t completely verified the last point though.&lt;/p&gt;</comment>
                            <comment id="15258524" author="yhuai" created="Tue, 26 Apr 2016 17:43:18 +0000"  >&lt;p&gt;Can you try to put spark.sql.hive.thriftServer.singleSession in spark conf (not put it while starting thriftserver) and try again?&lt;/p&gt;</comment>
                            <comment id="15302429" author="chutium" created="Thu, 26 May 2016 16:56:51 +0000"  >&lt;p&gt;Hi, we tried put spark.sql.hive.thriftServer.singleSession in spark conf, still the same.&lt;/p&gt;

&lt;p&gt;we enabled remote debug mode, and found ```SessionState``` may be created twice:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/blob/v1.6.1/sql/hive/src/main/scala/org/apache/spark/sql/hive/HiveQl.scala#L288&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/v1.6.1/sql/hive/src/main/scala/org/apache/spark/sql/hive/HiveQl.scala#L288&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/blob/v1.6.1/sql/hive/src/main/scala/org/apache/spark/sql/hive/client/ClientWrapper.scala#L200&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/v1.6.1/sql/hive/src/main/scala/org/apache/spark/sql/hive/client/ClientWrapper.scala#L200&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;after this, hivevar are missing, and strange is, username that we are using for login by beeline, is missing as well...&lt;/p&gt;</comment>
                            <comment id="15572249" author="apachespark" created="Thu, 13 Oct 2016 15:28:07 +0000"  >&lt;p&gt;User &apos;wangyum&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15466&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15466&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15902924" author="xwc3504" created="Thu, 9 Mar 2017 11:48:59 +0000"  >&lt;p&gt;spark 2.0.1 still has the bug... &lt;/p&gt;

&lt;p&gt;bin/beeline -f test.sql --hivevar db_name=offline&lt;/p&gt;

&lt;p&gt;the content of test.sql :  &lt;br/&gt;
--------------------------------&lt;br/&gt;
use ${hivevar:db_name};&lt;br/&gt;
-----------------------------------&lt;br/&gt;
the errors:&lt;br/&gt;
-------------------------------------------------------------------&lt;br/&gt;
Error: org.apache.spark.sql.catalyst.parser.ParseException: &lt;br/&gt;
no viable alternative at input &apos;$&apos;(line 1, pos 4)&lt;/p&gt;

&lt;p&gt;== SQL ==&lt;br/&gt;
use ${hivevar:db_name}&lt;br/&gt;
----^^^ (state=,code=0)&lt;br/&gt;
----------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;when can it be resolved?&lt;/p&gt;</comment>
                            <comment id="15999671" author="apachespark" created="Sun, 7 May 2017 03:58:02 +0000"  >&lt;p&gt;User &apos;wangyum&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/17886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/17886&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12948306">SPARK-13768</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13050340">SPARK-19927</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13014946">SPARK-18086</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 28 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2uujj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>