<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:44:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-49829] Issues with optimization on adding input to state store in stream-stream join </title>
                <link>https://issues.apache.org/jira/browse/SPARK-49829</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;NOTE: The ticket is describing the actual issue after RCA of tests the reporter reported, but I want to still assign the reporter to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azera&quot; class=&quot;user-hover&quot; rel=&quot;azera&quot;&gt;azera&lt;/a&gt;, to give the proper credit. Tests are directly pointing to the edge cases and I could easily spot on the root cause based on the simple reproducers. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azera&quot; class=&quot;user-hover&quot; rel=&quot;azera&quot;&gt;azera&lt;/a&gt; !&lt;/p&gt;

&lt;p&gt;Report link (user@): &lt;a href=&quot;https://lists.apache.org/thread/kmq9vlgdbsoytwlcch147n3mlxy56llf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lists.apache.org/thread/kmq9vlgdbsoytwlcch147n3mlxy56llf&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/spark/blob/039fd13eacb1cef835045e3a60cebf958589e1a2/sql/core/src/main/scala/org/apache/spark/sql/execution/streaming/StreamingSymmetricHashJoinExec.scala#L671-L677&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/039fd13eacb1cef835045e3a60cebf958589e1a2/sql/core/src/main/scala/org/apache/spark/sql/execution/streaming/StreamingSymmetricHashJoinExec.scala#L671-L677&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &#160; &#160; &#160; val isLeftSemiWithMatch =
&#160; &#160; &#160; &#160; &#160; joinType == LeftSemi &amp;amp;&amp;amp; joinSide == LeftSide &amp;amp;&amp;amp; iteratorNotEmpty
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// Add to state store only &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; both removal predicates &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not match,
&lt;/span&gt;&#160; &#160; &#160; &#160; &lt;span class=&quot;code-comment&quot;&gt;// and the row is not matched &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; left side of left semi join.
&lt;/span&gt;&#160; &#160; &#160; &#160; val shouldAddToState =
&#160; &#160; &#160; &#160; &#160; !stateKeyWatermarkPredicateFunc(key) &amp;amp;&amp;amp; !stateValueWatermarkPredicateFunc(thisRow) &amp;amp;&amp;amp;
&#160; &#160; &#160; &#160; &#160; !isLeftSemiWithMatch &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The above condition is to determine whether the stream-stream join add the input into state store. The criteria of `both removal predicates do not match` means the input is going to be evicted in this batch - before Spark introduced multiple stateful operators, watermark for late record and watermark for eviction were same, hence the input won&apos;t be matched with the condition after filtering out late records (Not sure about the edge case this condition was dealing with.)&lt;/p&gt;

&lt;p&gt;After multiple stateful operators (&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-40925&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-40925&lt;/a&gt;), watermark for late record and watermark for eviction are no longer the same. That said, input can be determined as not late, and can be evicted at the same batch. The above condition has to reflect this change but it was missed, hence having correctness issues on the report.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-45637&quot; title=&quot;Time window aggregation in separate streams followed by stream-stream join not returning results&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-45637&quot;&gt;&lt;del&gt;SPARK-45637&lt;/del&gt;&lt;/a&gt; is a one of the case, which I&apos;ll mark as duplicated.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13593666">SPARK-49829</key>
            <summary>Issues with optimization on adding input to state store in stream-stream join </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kabhwan">Jungtaek Lim</assignee>
                                    <reporter username="azera">Andrzej Zera</reporter>
                        <labels>
                            <label>correctness</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 30 Sep 2024 02:29:09 +0000</created>
                <updated>Fri, 18 Oct 2024 03:15:28 +0000</updated>
                            <resolved>Fri, 18 Oct 2024 03:13:59 +0000</resolved>
                                    <version>3.4.2</version>
                    <version>3.4.0</version>
                    <version>3.4.1</version>
                    <version>3.5.0</version>
                    <version>3.5.1</version>
                    <version>3.5.2</version>
                    <version>3.4.3</version>
                    <version>3.5.3</version>
                    <version>4.0.0</version>
                                    <fixVersion>3.4.4</fixVersion>
                    <fixVersion>3.5.4</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                    <component>Structured Streaming</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17885771" author="kabhwan" created="Mon, 30 Sep 2024 02:29:44 +0000"  >&lt;p&gt;I have a fix - will submit a fix sooner.&lt;/p&gt;</comment>
                            <comment id="17890776" author="kabhwan" created="Fri, 18 Oct 2024 03:13:59 +0000"  >&lt;p&gt;Issue resolved by pull request 48297&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/48297&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/48297&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13492095">SPARK-40925</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="13555222">SPARK-45637</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 3 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1rop4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>