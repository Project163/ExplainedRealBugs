<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:32:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-42635] Several counter-intuitive behaviours in the TimestampAdd expression</title>
                <link>https://issues.apache.org/jira/browse/SPARK-42635</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;ol&gt;
	&lt;li&gt;When the time is close to daylight saving time transition, the result may be discontinuous and not monotonic.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;We currently have:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
scala&amp;gt; spark.conf.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;spark.sql.session.timeZone&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;America/Los_Angeles&quot;&lt;/span&gt;)
scala&amp;gt; spark.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select timestampadd(second, 24 * 3600 - 1, timestamp&apos;2011-03-12 03:00:00&apos;)&quot;&lt;/span&gt;).show
+------------------------------------------------------------------------+
|timestampadd(second, ((24 * 3600) - 1), TIMESTAMP &apos;2011-03-12 03:00:00&apos;)|
+------------------------------------------------------------------------+
|                                                     2011-03-13 03:59:59|
+------------------------------------------------------------------------+
scala&amp;gt; spark.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select timestampadd(second, 24 * 3600, timestamp&apos;2011-03-12 03:00:00&apos;)&quot;&lt;/span&gt;).show
+------------------------------------------------------------------+
|timestampadd(second, (24 * 3600), TIMESTAMP &apos;2011-03-12 03:00:00&apos;)|
+------------------------------------------------------------------+
|                                               2011-03-13 03:00:00|
+------------------------------------------------------------------+ &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In the second query, adding one more second will set the time back one hour instead. Plus, there are only &lt;tt&gt;23 * 3600&lt;/tt&gt; seconds from &lt;tt&gt;2011-03-12 03:00:00&lt;/tt&gt; to &lt;tt&gt;2011-03-13 03:00:00&lt;/tt&gt;, instead of &lt;tt&gt;24 * 3600&lt;/tt&gt; seconds, due to the daylight saving time transition.&lt;/p&gt;

&lt;p&gt;The root cause of the problem is the Spark code at &lt;a href=&quot;https://github.com/apache/spark/blob/master/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/util/DateTimeUtils.scala#L790&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/util/DateTimeUtils.scala#L790&lt;/a&gt; wrongly assumes every day has &lt;tt&gt;MICROS_PER_DAY&lt;/tt&gt; seconds, and does the day and time-in-day split before looking at the timezone.&lt;/p&gt;

&lt;p&gt;2. Adding month, quarter, and year silently ignores Int overflow during unit conversion.&lt;/p&gt;

&lt;p&gt;The root cause is &lt;a href=&quot;https://github.com/apache/spark/blob/master/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/util/DateTimeUtils.scala#L1246&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/util/DateTimeUtils.scala#L1246&lt;/a&gt;. &lt;tt&gt;quantity&lt;/tt&gt; is multiplied by &lt;tt&gt;3&lt;/tt&gt; or &lt;tt&gt;MONTHS_PER_YEAR&lt;/tt&gt; without checking overflow. Note that we do have overflow checking in adding the amount to the timestamp, so the behavior is inconsistent.&lt;/p&gt;

&lt;p&gt;This can cause counter-intuitive results like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
scala&amp;gt; spark.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select timestampadd(quarter, 1431655764, timestamp&apos;1970-01-01&apos;)&quot;&lt;/span&gt;).show
+------------------------------------------------------------------+
|timestampadd(quarter, 1431655764, TIMESTAMP &apos;1970-01-01 00:00:00&apos;)|
+------------------------------------------------------------------+
|                                               1969-09-01 00:00:00|
+------------------------------------------------------------------+&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3. Adding sub-month units (week, day, hour, minute, second, millisecond, microsecond)silently ignores Long overflow during unit conversion.&lt;/p&gt;

&lt;p&gt;This is similar to the previous problem:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
&#160;scala&amp;gt; spark.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select timestampadd(day, 106751992, timestamp&apos;1970-01-01&apos;)&quot;&lt;/span&gt;).show(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
+-------------------------------------------------------------+
|timestampadd(day, 106751992, TIMESTAMP &apos;1970-01-01 00:00:00&apos;)|
+-------------------------------------------------------------+
|-290308-12-22 15:58:10.448384                                |
+-------------------------------------------------------------+&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13526728">SPARK-42635</key>
            <summary>Several counter-intuitive behaviours in the TimestampAdd expression</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mashplant">Chenhao Li</assignee>
                                    <reporter username="mashplant">Chenhao Li</reporter>
                        <labels>
                    </labels>
                <created>Wed, 1 Mar 2023 18:16:10 +0000</created>
                <updated>Sat, 4 Mar 2023 19:16:27 +0000</updated>
                            <resolved>Fri, 3 Mar 2023 06:39:39 +0000</resolved>
                                    <version>3.3.0</version>
                    <version>3.3.1</version>
                    <version>3.3.2</version>
                                    <fixVersion>3.3.3</fixVersion>
                    <fixVersion>3.4.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17695278" author="apachespark" created="Wed, 1 Mar 2023 19:30:54 +0000"  >&lt;p&gt;User &apos;chenhao-db&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/40237&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/40237&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17696036" author="maxgekk" created="Fri, 3 Mar 2023 06:39:39 +0000"  >&lt;p&gt;Issue resolved by pull request 40237&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/40237&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/40237&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17696042" author="apachespark" created="Fri, 3 Mar 2023 06:53:04 +0000"  >&lt;p&gt;User &apos;chenhao-db&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/40264&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/40264&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 36 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ga0g:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>