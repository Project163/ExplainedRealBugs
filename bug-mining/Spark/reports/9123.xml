<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:33:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-41599] Memory leak in FileSystem.CACHE when submitting apps to secure cluster using InProcessLauncher</title>
                <link>https://issues.apache.org/jira/browse/SPARK-41599</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When submitting spark application in kerberos environment the credentials of &apos;current user&apos; (UserGroupInformation.getCurrentUser()) are being modified.&lt;br/&gt;
Filesystem.CACHE entries contain &apos;current user&apos; (with user credentials) as a key.&lt;br/&gt;
Submitting many spark applications using InProcessLauncher cause that FileSystem.CACHE becomes bigger and bigger.&lt;br/&gt;
Finally process exits because of OutOfMemory error.&lt;/p&gt;

&lt;p&gt;Code for reproduction attached.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Output from running &apos;jmap -histo&apos; on reproduction jvm shows that the number of FileSystem$Cache$Key increases in time:&lt;/p&gt;

&lt;p&gt;time: #instances class&lt;br/&gt;
1671533274: 2 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671533335: 11 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671533395: 21 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671533455: 30 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671533515: 39 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671533576: 48 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671533636: 57 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671533696: 66 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671533757: 75 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671533817: 84 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671533877: 93 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671533937: 102 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671533998: 111 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671534058: 120 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671534118: 135 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671534178: 140 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671534239: 150 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671534299: 159 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671534359: 168 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671534419: 177 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671534480: 186 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671534540: 195 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671534600: 204 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671534661: 213 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671534721: 222 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671534781: 231 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671534841: 240 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671534902: 249 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671534962: 257 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671535022: 264 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671535083: 273 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671535143: 282 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;br/&gt;
1671535203: 291 org.apache.hadoop.fs.FileSystem$Cache$Key&lt;/p&gt;</description>
                <environment></environment>
        <key id="13514855">SPARK-41599</key>
            <summary>Memory leak in FileSystem.CACHE when submitting apps to secure cluster using InProcessLauncher</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="risyomei">Xieming Li</assignee>
                                    <reporter username="maciejsmolenski">Maciej Smolenski</reporter>
                        <labels>
                    </labels>
                <created>Tue, 20 Dec 2022 10:45:08 +0000</created>
                <updated>Fri, 30 Jun 2023 13:28:52 +0000</updated>
                            <resolved>Fri, 30 Jun 2023 13:24:41 +0000</resolved>
                                    <version>3.1.2</version>
                                    <fixVersion>3.5.0</fixVersion>
                                    <component>Deploy</component>
                    <component>YARN</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17651201" author="stevel@apache.org" created="Thu, 22 Dec 2022 09:47:49 +0000"  >&lt;p&gt;either the fs is being created by ((FileSystem.newInstance()}} and the code isn&apos;t calling close() after, or caching is disabled with &quot;fs.$SCHEME.impl.disable.cache&quot; set to true.&lt;/p&gt;

&lt;p&gt;There&apos;s also &lt;tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-17313&quot; title=&quot;FileSystem.get to support slow-to-instantiate FS clients&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-17313&quot;&gt;&lt;del&gt;HADOOP-17313&lt;/del&gt;&lt;/a&gt;. FileSystem.get to support slow-to-instantiate FS clients&lt;/tt&gt; which handles many threads calling get() on slow to create clients...but that only surfaced as an issue in large worker process&lt;/p&gt;</comment>
                            <comment id="17651614" author="stevel@apache.org" created="Fri, 23 Dec 2022 11:13:02 +0000"  >&lt;p&gt;1. try explicitly disabling the cache for that fs schema&lt;br/&gt;
2. there&apos;s a new 3.3.5 rc0 out at  &lt;a href=&quot;https://dist.apache.org/repos/dist/dev/hadoop/hadoop-3.3.5-RC0/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dist.apache.org/repos/dist/dev/hadoop/hadoop-3.3.5-RC0/&lt;/a&gt;  ; spark picks up the jars if you build it with the right settings. eg&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 build/sbt -Dhadoop.version=3.3.5 -Psnapshots-and-staging
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;that does fix the s3a instrumentation leakage, though if s3a fs instances are not being close()d they can still leak thread pools&lt;/p&gt;</comment>
                            <comment id="17651638" author="JIRAUSER298576" created="Fri, 23 Dec 2022 12:02:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks for the updates.&lt;/p&gt;

&lt;p&gt;&amp;gt; either the fs is being created by ((FileSystem.newInstance()}} and the code isn&apos;t calling close() after&lt;/p&gt;

&lt;p&gt;&amp;gt; try explicitly disabling the cache for that fs schema&lt;/p&gt;

&lt;p&gt;I added missing &apos;close&apos;s&apos; to places used by &apos;reproduction code&apos; (&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-41599&quot; title=&quot;Memory leak in FileSystem.CACHE when submitting apps to secure cluster using InProcessLauncher&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-41599&quot;&gt;&lt;del&gt;SPARK-41599&lt;/del&gt;&lt;/a&gt;-fixes-to-limit-FileSystem-CACHE-size-when-using-InProcessLauncher.diff) - and I was able to avoid memory leak when running this &apos;reproduction code&apos;.&lt;/p&gt;

&lt;p&gt;However &apos;reproduction code&apos; is small, this approach (ensuring that close is always called) will not work for larger applications with third party libraries (as in my case).&lt;/p&gt;

&lt;p&gt;As I understand there is no way to avoid UGI credentials changes when submitting many apps with InProcessLauncher (I expected such a fix when I was submitting the bug).&lt;/p&gt;

&lt;p&gt;This implies that for application (single jvm) which submits many spark apps using InProcessLauncher it is required to disable fs cache.&lt;/p&gt;

&lt;p&gt;For my case (large application) I think I will disable fs cache.&lt;/p&gt;</comment>
                            <comment id="17651672" author="stevel@apache.org" created="Fri, 23 Dec 2022 14:47:46 +0000"  >&lt;p&gt;apps can call&#160; FileSystem.closeAllForUGI() to remove all cached entries for a given user. It&apos;s how multi-user services (hive, tez) stay in control&lt;/p&gt;</comment>
                            <comment id="17652428" author="JIRAUSER298576" created="Wed, 28 Dec 2022 08:39:05 +0000"  >&lt;p&gt;&amp;gt; apps can call&#160; FileSystem.closeAllForUGI() to remove all cached entries for a given user. It&apos;s how multi-user services (hive, tez) stay in control&lt;/p&gt;

&lt;p&gt;It&apos;s good to know about this method, but I think this might not apply in my case - because from my investigation it seems that ugi used in FileSystem cache changes twice during single spark submit (repro code). This makes it difficult to remove all not needed entries.&lt;/p&gt;</comment>
                            <comment id="17678189" author="stevel@apache.org" created="Wed, 18 Jan 2023 10:53:17 +0000"  >&lt;p&gt;well, the challenge there becomes &quot;not changing that UGI&quot; or at least closing all fs instances for that ugi before that happens&lt;/p&gt;</comment>
                            <comment id="17733286" author="risyomei" created="Fri, 16 Jun 2023 02:37:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maciejsmolenski&quot; class=&quot;user-hover&quot; rel=&quot;maciejsmolenski&quot;&gt;maciejsmolenski&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;I am having this issue as well.&lt;/p&gt;

&lt;p&gt;I&apos;m encountering the same problem.&lt;/p&gt;

&lt;p&gt;Could you please guide me on how to &quot;explicitly disable the cache for that filesystem schema&quot;?&lt;/p&gt;

&lt;p&gt;I am trying to add the following configurations in my core-site.xml, but not sure if this is the right way.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &amp;lt;property&amp;gt;
&#160; &#160; &amp;lt;name&amp;gt;fs.hdfs.impl.disable.cache&amp;lt;/name&amp;gt;
&#160; &#160; &amp;lt;value&amp;gt;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;lt;/value&amp;gt;
&#160; &amp;lt;/property&amp;gt;
&#160; &amp;lt;property&amp;gt;
&#160; &#160; &amp;lt;name&amp;gt;fs.viewfs.impl.disable.cache&amp;lt;/name&amp;gt;
&#160; &#160; &amp;lt;value&amp;gt;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;lt;/value&amp;gt;
&#160; &amp;lt;/property&amp;gt; &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17733454" author="stevel@apache.org" created="Fri, 16 Jun 2023 10:49:05 +0000"  >&lt;p&gt;correct. remember, all the source of hadoop is there for you to open in your IDE -it&apos;s the only way to be sure&lt;/p&gt;</comment>
                            <comment id="17735743" author="risyomei" created="Wed, 21 Jun 2023 14:11:19 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt;, Thank you very much for your advice.&lt;/p&gt;

&lt;p&gt;After reviewing the code, I think the following PR should be able to fix the issue.&lt;/p&gt;

&lt;p&gt;May I ask you to take a look at it when you have time, please?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/spark/pull/41692&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/41692&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17738209" author="ci-cassandra.apache.org" created="Wed, 28 Jun 2023 16:52:37 +0000"  >&lt;p&gt;User &apos;risyomei&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/41692&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/41692&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17739083" author="srowen" created="Fri, 30 Jun 2023 13:24:41 +0000"  >&lt;p&gt;Issue resolved by pull request 41692&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/41692&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/41692&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17739088" author="risyomei" created="Fri, 30 Jun 2023 13:28:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thank you very much for your feedback and review.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13054011" name="InProcLaunchFsIssue.scala" size="2229" author="maciejsmolenski" created="Tue, 20 Dec 2022 11:10:33 +0000"/>
                            <attachment id="13054094" name="SPARK-41599-fixes-to-limit-FileSystem-CACHE-size-when-using-InProcessLauncher.diff" size="8264" author="maciejsmolenski" created="Fri, 23 Dec 2022 11:44:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 19 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1e98o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>