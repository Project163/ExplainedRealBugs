<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:00:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-24705] Spark.sql.adaptive.enabled=true is enabled and self-join query</title>
                <link>https://issues.apache.org/jira/browse/SPARK-24705</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smilegator&quot; class=&quot;user-hover&quot; rel=&quot;smilegator&quot;&gt;smilegator&lt;/a&gt;&lt;br/&gt;
When loading data using jdbc and enabling spark.sql.adaptive.enabled=true , for example loading a tableA table, unexpected results can occur when you use the following query.&lt;/p&gt;

&lt;p&gt;For example:&lt;br/&gt;
device_loc table comes from the jdbc data source&lt;br/&gt;
select tv_a.imei&lt;br/&gt;
from ( select a.imei,a.speed from device_loc a) tv_a&lt;br/&gt;
inner join ( select a.imei,a.speed from device_loc a ) tv_b on tv_a.imei = tv_b.imei&lt;br/&gt;
group by tv_a.imei&lt;/p&gt;

&lt;p&gt;When the cache tabel device_loc is executed before this query is executed, everything is fine,However, if you do not execute cache table, unexpected results will occur, resulting in failure to execute.&lt;/p&gt;

&lt;p&gt;Remarks&#65306;Attachment records the stack when the error occurred&lt;/p&gt;
</description>
                <environment></environment>
        <key id="13169329">SPARK-24705</key>
            <summary>Spark.sql.adaptive.enabled=true is enabled and self-join query</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="maropu">Takeshi Yamamuro</assignee>
                                    <reporter username="daic">cheng dai</reporter>
                        <labels>
                    </labels>
                <created>Sat, 30 Jun 2018 13:34:53 +0000</created>
                <updated>Thu, 2 Aug 2018 20:05:24 +0000</updated>
                            <resolved>Thu, 2 Aug 2018 20:05:24 +0000</resolved>
                                    <version>2.2.1</version>
                    <version>2.3.1</version>
                                    <fixVersion>2.4.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16529421" author="maropu" created="Mon, 2 Jul 2018 06:18:18 +0000"  >&lt;p&gt;I checked the master has the same issue. Also, it seems this issue only happens when using jdbc sources.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// Prepare test data in postgresql
&lt;/span&gt;postgres=# create table device_loc(imei &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, speed &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;);
CREATE TABLE
postgres=# insert into device_loc values (1, 1);
INSERT 0 1
postgres=# select * from device_loc;
 imei | speed 
------+-------
    1 |     1
(1 row)


&lt;span class=&quot;code-comment&quot;&gt;// Register as a jdbc table
&lt;/span&gt;scala&amp;gt; val jdbcTable = spark.read.jdbc(&lt;span class=&quot;code-quote&quot;&gt;&quot;jdbc:postgresql:postgres&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;device_loc&quot;&lt;/span&gt;, options)
scala&amp;gt; jdbcTable.registerTempTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;device_loc&quot;&lt;/span&gt;)
scala&amp;gt; sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM device_loc&quot;&lt;/span&gt;).show
+----+-----+
|imei|speed|
+----+-----+
|   1|    1|
+----+-----+

&lt;span class=&quot;code-comment&quot;&gt;// Prepare a query
&lt;/span&gt;scala&amp;gt; :paste
val df = sql(&quot;&quot;&quot;
select tv_a.imei
  from ( select a.imei,a.speed from device_loc a) tv_a
  &lt;span class=&quot;code-keyword&quot;&gt;inner&lt;/span&gt; join ( select a.imei,a.speed from device_loc a ) tv_b on tv_a.imei = tv_b.imei
  group by tv_a.imei
&quot;&quot;&quot;)

&lt;span class=&quot;code-comment&quot;&gt;// Run tests
&lt;/span&gt;scala&amp;gt; sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;SET spark.sql.adaptive.enabled=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;)
scala&amp;gt; df.show
+----+
|imei|
+----+
|   1|
+----+

scala&amp;gt; sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;SET spark.sql.adaptive.enabled=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;)
scala&amp;gt; df.show
org.apache.spark.sql.catalyst.errors.&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt;$TreeNodeException: execute, tree:
Exchange(coordinator id: 1401717308) hashpartitioning(imei#0, 200), coordinator[target post-shuffle partition size: 67108864]
+- *(1) Scan JDBCRelation(device_loc) [numPartitions=1] [imei#0] PushedFilters: [*IsNotNull(imei)], ReadSchema: struct&amp;lt;imei:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;

Caused by: java.lang.AssertionError: assertion failed
  at scala.Predef$.&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt;(Predef.scala:156)
  at org.apache.spark.sql.execution.exchange.ExchangeCoordinator.doEstimationIfNecessary(ExchangeCoordinator.scala:201)
  at org.apache.spark.sql.execution.exchange.ExchangeCoordinator.postShuffleRDD(ExchangeCoordinator.scala:259)
  at org.apache.spark.sql.execution.exchange.ShuffleExchangeExec$$anonfun$doExecute$1.apply(ShuffleExchangeExec.scala:124)
  at org.apache.spark.sql.execution.exchange.ShuffleExchangeExec$$anonfun$doExecute$1.apply(ShuffleExchangeExec.scala:119)
  at org.apache.spark.sql.catalyst.errors.&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt;$.attachTree(&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt;.scala:52)
  ... 100 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It seems this issue doesn&apos;t happen in the other datasources&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
scala&amp;gt; sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;SET spark.sql.adaptive.enabled=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;)
scala&amp;gt; spark.range(1).selectExpr(&lt;span class=&quot;code-quote&quot;&gt;&quot;id AS imei&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;id AS speed&quot;&lt;/span&gt;).write.saveAsTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;device_loc&quot;&lt;/span&gt;)
scala&amp;gt; :paste
val df = sql(&quot;&quot;&quot;
select tv_a.imei
  from ( select a.imei,a.speed from device_loc a) tv_a
  &lt;span class=&quot;code-keyword&quot;&gt;inner&lt;/span&gt; join ( select a.imei,a.speed from device_loc a ) tv_b on tv_a.imei = tv_b.imei
  group by tv_a.imei
&quot;&quot;&quot;)
scala&amp;gt; df.show()
+----+
|imei|
+----+
|   0|
+----+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16530978" author="daic" created="Tue, 3 Jul 2018 08:04:48 +0000"  >&lt;p&gt;This is indeed the case, and it is often used in my business, so I found this problem and hope that the community can help solve it.&lt;/p&gt;</comment>
                            <comment id="16531007" author="maropu" created="Tue, 3 Jul 2018 08:26:37 +0000"  >&lt;p&gt;Why don&apos;t you turn off `spark.sql.adaptive.enabled`?&lt;/p&gt;</comment>
                            <comment id="16531023" author="daic" created="Tue, 3 Jul 2018 08:42:20 +0000"  >&lt;p&gt;It is currently closed. If I want to use this feature to improve performance, it is currently not possible. I think this is a bug and it is necessary to fix it.&lt;/p&gt;</comment>
                            <comment id="16533195" author="smilegator" created="Thu, 5 Jul 2018 02:38:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maropu&quot; class=&quot;user-hover&quot; rel=&quot;maropu&quot;&gt;maropu&lt;/a&gt;Thank you for taking this. Please try to fix it?&lt;/p&gt;</comment>
                            <comment id="16533212" author="maropu" created="Thu, 5 Jul 2018 02:51:51 +0000"  >&lt;p&gt;ok, will do.&lt;/p&gt;</comment>
                            <comment id="16541063" author="apachespark" created="Thu, 12 Jul 2018 02:54:05 +0000"  >&lt;p&gt;User &apos;maropu&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21754&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21754&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16541065" author="maropu" created="Thu, 12 Jul 2018 02:54:29 +0000"  >&lt;p&gt;Sorry for my late response. IIUC I misunderstood the cause of this bug and this bug is not related to the JDBC source. I made a pr, so could you check there? Thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12929820" name="Error stack.txt" size="5051" author="daic" created="Sat, 30 Jun 2018 13:44:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 18 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3veyn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>