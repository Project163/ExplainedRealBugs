<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:34:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-10304] Partition discovery does not throw an exception if the dir structure is invalid</title>
                <link>https://issues.apache.org/jira/browse/SPARK-10304</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I have a dir structure like &lt;tt&gt;/path/table1/partition_column=1/&lt;/tt&gt;. When I try to use &lt;tt&gt;load(&quot;/path/&quot;)&lt;/tt&gt;, it works and I get a DF. When I query this DF, if it is stored as ORC, there will be the following NPE. But, if it is Parquet, we even can return rows. We should complain to users about the dir struct because &lt;tt&gt;table1&lt;/tt&gt; does not meet our format.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;org.apache.spark.SparkException: Job aborted due to stage failure: Task 26 in stage 57.0 failed 4 times, most recent failure: Lost task 26.3 in stage 57.0 (TID 3504, 10.0.195.227): java.lang.NullPointerException
at org.apache.spark.sql.hive.HiveInspectors$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;unwrapperFor(HiveInspectors.scala:466)
	at org.apache.spark.sql.hive.orc.OrcTableScan.unwrapperFor(OrcRelation.scala:224)
	at org.apache.spark.sql.hive.orc.OrcTableScan$$anonfun$org$apache$spark$sql$hive$orc$OrcTableScan$$fillObject$1$$anonfun$9.apply(OrcRelation.scala:261)
	at org.apache.spark.sql.hive.orc.OrcTableScan$$anonfun$org$apache$spark$sql$hive$orc$OrcTableScan$$fillObject$1$$anonfun$9.apply(OrcRelation.scala:261)
	at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:244)
	at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:244)
	at scala.collection.immutable.List.foreach(List.scala:318)
	at scala.collection.TraversableLike$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;map(TraversableLike.scala:244)
	at scala.collection.AbstractTraversable.map(Traversable.scala:105)
	at org.apache.spark.sql.hive.orc.OrcTableScan$$anonfun$org$apache$spark$sql$hive$orc$OrcTableScan$$fillObject$1.apply(OrcRelation.scala:261)
	at org.apache.spark.sql.hive.orc.OrcTableScan$$anonfun$org$apache$spark$sql$hive$orc$OrcTableScan$$fillObject$1.apply(OrcRelation.scala:256)
	at scala.Option.map(Option.scala:145)
	at org.apache.spark.sql.hive.orc.OrcTableScan.org$apache$spark$sql$hive$orc$OrcTableScan$$fillObject(OrcRelation.scala:256)
	at org.apache.spark.sql.hive.orc.OrcTableScan$$anonfun$execute$3.apply(OrcRelation.scala:318)
	at org.apache.spark.sql.hive.orc.OrcTableScan$$anonfun$execute$3.apply(OrcRelation.scala:316)
	at org.apache.spark.rdd.HadoopRDD$HadoopMapPartitionsWithSplitRDD.compute(HadoopRDD.scala:380)
	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:297)
	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)
	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)
	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:297)
	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)
	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12859452">SPARK-10304</key>
            <summary>Partition discovery does not throw an exception if the dir structure is invalid</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="viirya">L. C. Hsieh</assignee>
                                    <reporter username="yhuai">Yin Huai</reporter>
                        <labels>
                    </labels>
                <created>Wed, 26 Aug 2015 21:42:52 +0000</created>
                <updated>Wed, 4 Nov 2015 06:24:03 +0000</updated>
                            <resolved>Tue, 3 Nov 2015 15:42:01 +0000</resolved>
                                                    <fixVersion>1.6.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14715803" author="yhuai" created="Thu, 27 Aug 2015 00:22:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhazhan&quot; class=&quot;user-hover&quot; rel=&quot;zhazhan&quot;&gt;zhazhan&lt;/a&gt; can you take a look at this?&lt;/p&gt;</comment>
                            <comment id="14715958" author="zzhan" created="Thu, 27 Aug 2015 02:31:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhuai&quot; class=&quot;user-hover&quot; rel=&quot;yhuai&quot;&gt;yhuai&lt;/a&gt; NP. Will look at it.&lt;/p&gt;</comment>
                            <comment id="14716204" author="zzhan" created="Thu, 27 Aug 2015 07:18:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhuai&quot; class=&quot;user-hover&quot; rel=&quot;yhuai&quot;&gt;yhuai&lt;/a&gt; Is the field.getFieldObjectInspector return null? It should never happen if everything is as expected, right? Do you know how to reproduce the issue?&lt;/p&gt;</comment>
                            <comment id="14717475" author="yhuai" created="Thu, 27 Aug 2015 20:30:29 +0000"  >&lt;p&gt;Will field be null? I will try to get more info.&lt;/p&gt;</comment>
                            <comment id="14717575" author="yhuai" created="Thu, 27 Aug 2015 21:34:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zhazhan&quot; class=&quot;user-hover&quot; rel=&quot;zhazhan&quot;&gt;zhazhan&lt;/a&gt; just took a look, it is not an ORC issue. It is an issue related to partition discovery.&lt;/p&gt;</comment>
                            <comment id="14717951" author="zzhan" created="Fri, 28 Aug 2015 02:42:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhuai&quot; class=&quot;user-hover&quot; rel=&quot;yhuai&quot;&gt;yhuai&lt;/a&gt; Thanks for the information, and initial investigation. I will take a look.&lt;/p&gt;</comment>
                            <comment id="14723851" author="zzhan" created="Mon, 31 Aug 2015 18:49:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhuai&quot; class=&quot;user-hover&quot; rel=&quot;yhuai&quot;&gt;yhuai&lt;/a&gt; I tried to reproduce the problem with the same directory structure (table is saved in /tmp/table/peoplePartitioned), but didn&apos;t hit the problem. &lt;br/&gt;
val table = sqlContext.read.format(&quot;orc&quot;).load(&quot;/tmp/table&quot;)&lt;br/&gt;
table.registerTempTable(&quot;table&quot;)&lt;br/&gt;
sqlContext.sql(&quot;SELECT * FROM table WHERE age = 19&quot;).show&lt;br/&gt;
sqlContext.sql(&quot;SELECT * FROM table&quot;).show&lt;br/&gt;
val table = sqlContext.read.format(&quot;orc&quot;).load(&quot;/tmp/table/peoplePartitioned&quot;)&lt;br/&gt;
table.registerTempTable(&quot;table&quot;)&lt;br/&gt;
sqlContext.sql(&quot;SELECT * FROM table WHERE age = 19&quot;).show&lt;br/&gt;
sqlContext.sql(&quot;SELECT * FROM table&quot;).show&lt;/p&gt;

&lt;p&gt;I went through the partition parsing code, which is parsing the leaf directory, and thus starting point does not matter , and both /tmp/table and /tmp/table/peoplePartitioned are valid directory as long as it only have the files from the same orc table. &lt;/p&gt;

&lt;p&gt;Does your /tmp/table have some extra files not belonging to the same table? If not, can you please provide exact reproducing steps?&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lian+cheng&quot; class=&quot;user-hover&quot; rel=&quot;lian cheng&quot;&gt;lian cheng&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14723858" author="yhuai" created="Mon, 31 Aug 2015 18:53:31 +0000"  >&lt;p&gt;The dir struct I have is something like the following.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;/tmp/tables
|-&amp;gt; /tmp/tables/partitionedTable
     |-&amp;gt; /tmp/tables/partitionedTable/p=1/
|-&amp;gt; /tmp/tables/nonPartitionedTable1
|-&amp;gt; /tmp/tables/nonPartitionedTable2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14723994" author="zzhan" created="Mon, 31 Aug 2015 20:35:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhuai&quot; class=&quot;user-hover&quot; rel=&quot;yhuai&quot;&gt;yhuai&lt;/a&gt; I think the NPE is caused by the directory has multiple table inside.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lian+cheng&quot; class=&quot;user-hover&quot; rel=&quot;lian cheng&quot;&gt;lian cheng&lt;/a&gt; Does the design allow different partition spec. For example, one part of the table is partitioned by key1, key2,  the second part is partitioned by key1 only and the third part is not partitioned? If so, then it is hard to decide whether the directory is valid or not. Otherwise, we can simply check the consistency of partitionspec and throw exceptions if not consistent.&lt;/p&gt;</comment>
                            <comment id="14724122" author="zzhan" created="Mon, 31 Aug 2015 22:02:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lian+cheng&quot; class=&quot;user-hover&quot; rel=&quot;lian cheng&quot;&gt;lian cheng&lt;/a&gt; forget about my question. From the code, it is not allowed. Here it happens because the directory has nonPartitionedTableX, and the validation check does not handle this case.&lt;/p&gt;</comment>
                            <comment id="14724523" author="yhuai" created="Tue, 1 Sep 2015 01:14:17 +0000"  >&lt;p&gt;Yeah. I mean we should throw a nice error message at here instead of returning a DF (when using Parquet) or throwing a NPE (when using ORC).&lt;/p&gt;</comment>
                            <comment id="14724794" author="apachespark" created="Tue, 1 Sep 2015 05:09:04 +0000"  >&lt;p&gt;User &apos;zhzhan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/8547&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/8547&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14735710" author="zzhan" created="Tue, 8 Sep 2015 22:01:48 +0000"  >&lt;p&gt;Did more investigation. Currently all files are included (_common_metadata, etc), for example:&lt;br/&gt;
/Users/zzhang/repo/spark/sql/core/target/tmp/spark-cd6c0332-c6ed-4ef5-8061-7681b895e07a/_common_metadata&lt;br/&gt;
/Users/zzhang/repo/spark/sql/core/target/tmp/spark-cd6c0332-c6ed-4ef5-8061-7681b895e07a/_metadata&lt;br/&gt;
/Users/zzhang/repo/spark/sql/core/target/tmp/spark-cd6c0332-c6ed-4ef5-8061-7681b895e07a/id=71/part-r-00001-39ef2d6e-2832-4757-ac02-0a938eb83b7d.gz.parquet&lt;/p&gt;

&lt;p&gt;On the framework level, the partition will be retrieved from both &lt;br/&gt;
/Users/zzhang/repo/spark/sql/core/target/tmp/spark-cd6c0332-c6ed-4ef5-8061-7681b895e07a/&lt;br/&gt;
and &lt;br/&gt;
/Users/zzhang/repo/spark/sql/core/target/tmp/spark-cd6c0332-c6ed-4ef5-8061-7681b895e07a/id=71/&lt;/p&gt;

&lt;p&gt;In this case, the framework cannot differentiate valid and invalid directory.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lian+cheng&quot; class=&quot;user-hover&quot; rel=&quot;lian cheng&quot;&gt;lian cheng&lt;/a&gt; Can we filter all unnecessary files, e.g., _metadata, _common_metadata when doing the partition discovery by removing all files start with . or underscore? I didn&apos;t see such files are useful for partition discovery, but I may miss something. Otherwise, it seems to be hard to check the validation of the directory.&lt;br/&gt;
cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhuai&quot; class=&quot;user-hover&quot; rel=&quot;yhuai&quot;&gt;yhuai&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14877105" author="apachespark" created="Sat, 19 Sep 2015 13:07:04 +0000"  >&lt;p&gt;User &apos;viirya&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/8840&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/8840&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14901548" author="yhuai" created="Mon, 21 Sep 2015 22:38:52 +0000"  >&lt;p&gt;I dropped 1.5.1 as the target version since this issue does not prevent users from creating a df from a dataset with valid dir structure (the issue at here is that users can create a df from a dir with invalid structure). &lt;/p&gt;</comment>
                            <comment id="14987488" author="davies" created="Tue, 3 Nov 2015 15:42:01 +0000"  >&lt;p&gt;Issue resolved by pull request 8840&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/8840&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/8840&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14988980" author="apachespark" created="Wed, 4 Nov 2015 06:24:03 +0000"  >&lt;p&gt;User &apos;viirya&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/9459&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/9459&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 2 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2jf8v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333083">1.6.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>