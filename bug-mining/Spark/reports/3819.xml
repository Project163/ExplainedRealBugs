<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:45:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-15705] Spark won&apos;t read ORC schema from metastore for partitioned tables</title>
                <link>https://issues.apache.org/jira/browse/SPARK-15705</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Spark does not seem to read the schema from the Hive metastore for partitioned tables stored as ORC files. It appears to read the schema from the files themselves, which, if they were created with Hive, does not match the metastore schema (at least not before before Hive 2.0, see &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-4243&quot; title=&quot;Fix column names in FileSinkOperator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HIVE-4243&quot;&gt;&lt;del&gt;HIVE-4243&lt;/del&gt;&lt;/a&gt;). To reproduce:&lt;/p&gt;

&lt;p&gt;In Hive:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;hive&amp;gt; create table &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.test (id BIGINT, name STRING) partitioned by (state STRING) stored as orc;
hive&amp;gt; insert into table &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.test partition (state=&lt;span class=&quot;code-quote&quot;&gt;&quot;CA&quot;&lt;/span&gt;) values (1, &lt;span class=&quot;code-quote&quot;&gt;&quot;mike&quot;&lt;/span&gt;), (2, &lt;span class=&quot;code-quote&quot;&gt;&quot;steve&quot;&lt;/span&gt;), (3, &lt;span class=&quot;code-quote&quot;&gt;&quot;bill&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In Spark&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;scala&amp;gt; spark.table(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.test&quot;&lt;/span&gt;).printSchema
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Expected result: Spark should preserve the column names that were defined in Hive.&lt;/p&gt;

&lt;p&gt;Actual Result:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;root
 |-- _col0: &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
 |-- _col1: string (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
 |-- state: string (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Possibly related to &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-14959&quot; title=&quot;&#8203;Problem Reading partitioned ORC or Parquet files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-14959&quot;&gt;&lt;del&gt;SPARK-14959&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</description>
                <environment>&lt;p&gt;HDP 2.3.4 (Hive 1.2.1, Hadoop 2.7.1)&lt;/p&gt;</environment>
        <key id="12974866">SPARK-15705</key>
            <summary>Spark won&apos;t read ORC schema from metastore for partitioned tables</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yhuai">Yin Huai</assignee>
                                    <reporter username="nseggert">Nic Eggert</reporter>
                        <labels>
                    </labels>
                <created>Wed, 1 Jun 2016 17:29:40 +0000</created>
                <updated>Thu, 7 Dec 2017 00:17:27 +0000</updated>
                            <resolved>Tue, 19 Jul 2016 19:58:00 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>13</watches>
                                                                                                                <comments>
                            <comment id="15313257" author="xwu0226" created="Thu, 2 Jun 2016 23:07:16 +0000"  >&lt;p&gt;I can recreate it now. and will look into it. This is different issue than &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-14959&quot; title=&quot;&#8203;Problem Reading partitioned ORC or Parquet files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-14959&quot;&gt;&lt;del&gt;SPARK-14959&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15345036" author="nseggert" created="Wed, 22 Jun 2016 19:42:07 +0000"  >&lt;p&gt;Raised priority to critical. We have a lot of partitioned tables stored as ORC, so dataframes/datasets in  2.0 are effectively useless to us until this is fixed.&lt;/p&gt;</comment>
                            <comment id="15371513" author="nseggert" created="Mon, 11 Jul 2016 20:08:56 +0000"  >&lt;p&gt;Double-checked just for fun. The problem still exists in RC2.&lt;/p&gt;</comment>
                            <comment id="15373786" author="nseggert" created="Tue, 12 Jul 2016 22:02:12 +0000"  >&lt;p&gt;Found a work-around: Set spark.sql.hive.convertMetastoreOrc=false.&lt;/p&gt;</comment>
                            <comment id="15375543" author="nseggert" created="Wed, 13 Jul 2016 19:03:32 +0000"  >&lt;p&gt;I believe the problem is around here: &lt;a href=&quot;https://github.com/apache/spark/blob/master/sql/hive/src/main/scala/org/apache/spark/sql/hive/HiveMetastoreCatalog.scala#L301&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/sql/hive/src/main/scala/org/apache/spark/sql/hive/HiveMetastoreCatalog.scala#L301&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can see that there&apos;s special handling for merging parquet and metastore schema, but for anything else, the schema is just taken from the file. I don&apos;t really have the expertise to fix this on my own, but I&apos;m happy to help in any way I can.&lt;/p&gt;</comment>
                            <comment id="15384464" author="michael" created="Tue, 19 Jul 2016 16:30:17 +0000"  >&lt;p&gt;Yeah, I&apos;m not too keen on that code path either. Inferring the schema from reading every file in a partitioned table is a relatively heavyweight and slow operation. We&apos;re not leveraging the fact that we have a metastore schema. This is a performance/efficiency issue I&apos;ve been working on in our own codebase, and I believe we&apos;ll have something to contribute in the near future. However, that will definitely not make it into 2.0. As for your problem specifically, I can&apos;t really suggest a quick fix because I have no experience with the ORC file format.&lt;/p&gt;</comment>
                            <comment id="15384593" author="yhuai" created="Tue, 19 Jul 2016 17:56:58 +0000"  >&lt;p&gt;I will send a PR to change the default value of &lt;tt&gt;spark.sql.hive.convertMetastoreOrc&lt;/tt&gt;. Then, I will start to look at the fix. &lt;/p&gt;</comment>
                            <comment id="15384604" author="apachespark" created="Tue, 19 Jul 2016 18:02:06 +0000"  >&lt;p&gt;User &apos;yhuai&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/14267&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/14267&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15384648" author="yhuai" created="Tue, 19 Jul 2016 18:37:44 +0000"  >&lt;p&gt;The proper fix will be tracked by &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-16628&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-16628&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16163747" author="dongjoon" created="Tue, 12 Sep 2017 22:03:51 +0000"  >&lt;p&gt;Hi, All.&lt;/p&gt;

&lt;p&gt;I&apos;m tracking this bug. This seems to be fixed since 2.1.1.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;scala&amp;gt; spark.table(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.test&quot;&lt;/span&gt;).printSchema
root
 |-- id: &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
 |-- name: string (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
 |-- state: string (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)

scala&amp;gt; sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;set spark.sql.hive.convertMetastoreOrc=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;)
res1: org.apache.spark.sql.DataFrame = [key: string, value: string]

scala&amp;gt; spark.table(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.test&quot;&lt;/span&gt;).printSchema
root
 |-- _col0: &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
 |-- _col1: string (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
 |-- state: string (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)

scala&amp;gt; sc.version
res3: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; = 2.0.2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;scala&amp;gt; spark.table(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.test&quot;&lt;/span&gt;).printSchema
root
 |-- id: &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
 |-- name: string (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
 |-- state: string (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)

scala&amp;gt; sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;set spark.sql.hive.convertMetastoreOrc=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;)
res1: org.apache.spark.sql.DataFrame = [key: string, value: string]

scala&amp;gt; spark.table(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.test&quot;&lt;/span&gt;).printSchema
root
 |-- id: &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
 |-- name: string (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
 |-- state: string (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)

scala&amp;gt; sc.version
res3: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; = 2.1.1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;scala&amp;gt; spark.table(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.test&quot;&lt;/span&gt;).printSchema
root
 |-- id: &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
 |-- name: string (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
 |-- state: string (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)


scala&amp;gt; sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;set spark.sql.hive.convertMetastoreOrc=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;)
res1: org.apache.spark.sql.DataFrame = [key: string, value: string]

scala&amp;gt; spark.table(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.test&quot;&lt;/span&gt;).printSchema
root
 |-- id: &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
 |-- name: string (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
 |-- state: string (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)

scala&amp;gt; sc.version
res3: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; = 2.2.0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16281170" author="dongjoon" created="Thu, 7 Dec 2017 00:17:27 +0000"  >&lt;p&gt;Since 2.2.1 is released, I&apos;ll update the result from 2.2.1, too.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
scala&amp;gt; sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;set spark.sql.hive.convertMetastoreOrc=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;)
scala&amp;gt; spark.table(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.test&quot;&lt;/span&gt;).printSchema
root
 |-- id: &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
 |-- name: string (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
 |-- state: string (nullable = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)

scala&amp;gt; spark.version
res2: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; = 2.2.1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13075230">SPARK-20901</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12990855">SPARK-16628</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12952481">SPARK-14070</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 49 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2yu7j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>