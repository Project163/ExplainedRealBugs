<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:05:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-20286] dynamicAllocation.executorIdleTimeout is ignored after unpersist</title>
                <link>https://issues.apache.org/jira/browse/SPARK-20286</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;With dynamic allocation enabled, it seems that executors with cached data which are unpersisted are still being killed using the &lt;tt&gt;dynamicAllocation.cachedExecutorIdleTimeout&lt;/tt&gt; configuration, instead of &lt;tt&gt;dynamicAllocation.executorIdleTimeout&lt;/tt&gt;. Assuming the default configuration (&lt;tt&gt;dynamicAllocation.cachedExecutorIdleTimeout = Infinity&lt;/tt&gt;), an executor with unpersisted data won&apos;t be released until the job ends.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;How to reproduce&lt;/b&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Set different values for &lt;tt&gt;dynamicAllocation.executorIdleTimeout&lt;/tt&gt; and &lt;tt&gt;dynamicAllocation.cachedExecutorIdleTimeout&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Load a file into a RDD and persist it&lt;/li&gt;
	&lt;li&gt;Execute an action on the RDD (like a count) so some executors are activated.&lt;/li&gt;
	&lt;li&gt;When the action has finished, unpersist the RDD&lt;/li&gt;
	&lt;li&gt;The application UI removes correctly the persisted data from the &lt;b&gt;Storage&lt;/b&gt; tab, but if you look in the &lt;b&gt;Executors&lt;/b&gt; tab, you will find that the executors remain &lt;b&gt;active&lt;/b&gt; until (&lt;tt&gt;dynamicAllocation.cachedExecutorIdleTimeout&lt;/tt&gt; is reached.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13063025">SPARK-20286</key>
            <summary>dynamicAllocation.executorIdleTimeout is ignored after unpersist</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vanzin">Marcelo Masiero Vanzin</assignee>
                                    <reporter username="mpasa">Miguel P&#233;rez</reporter>
                        <labels>
                    </labels>
                <created>Mon, 10 Apr 2017 22:16:45 +0000</created>
                <updated>Sun, 14 Jul 2019 22:42:03 +0000</updated>
                            <resolved>Wed, 5 Jun 2019 13:10:19 +0000</resolved>
                                    <version>2.0.1</version>
                                    <fixVersion>3.0.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="15965306" author="jerryshao" created="Wed, 12 Apr 2017 03:09:14 +0000"  >&lt;p&gt;So the fix is that if there&apos;s no RDD get persisted, executors idle time should be changed to &lt;tt&gt;dynamicAllocation.executorIdleTimeout&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15965408" author="mpasa" created="Wed, 12 Apr 2017 05:34:26 +0000"  >&lt;p&gt;Yes. I suppose this is only checked when an executors passes from active to idle status (maybe when the last action has finished), and it&apos;s not changed when unpersist is called. But this is problematic, for example, if the job is interactive. Imagine you have a Zeppelin notebook or a Spark shell. The same driver could have different purposes and the session could be opened a long time. Once you have called a single persist, all these executors will have to wait &lt;tt&gt;dynamicAllocation.cachedExecutorIdleTimeout&lt;/tt&gt; (which is Infinity by default) or the user executing another action (executors will become active again and then idle, but this time without cached data).&lt;/p&gt;

&lt;p&gt;I don&apos;t know the solution. Maybe the best approach is to change from cachedExecutorIdleTimeout to executorIdleTimeout on all cached executors when the last RDD has been unpersisted, and then restart the time counter (unpersist will then count as an action).&lt;/p&gt;</comment>
                            <comment id="15965411" author="jerryshao" created="Wed, 12 Apr 2017 05:38:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;Maybe the best approach is to change from cachedExecutorIdleTimeout to executorIdleTimeout on all cached executors when the last RDD has been unpersisted, and then restart the time counter (unpersist will then count as an action).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, I think this is a feasible solution. I can help out it if you&apos;re not familiar with that code.&lt;/p&gt;</comment>
                            <comment id="15965556" author="mpasa" created="Wed, 12 Apr 2017 08:41:18 +0000"  >&lt;p&gt;I&apos;m zero familiar with the code, but I&apos;ll try to send a merge request when I have time to look it up. I&apos;ll be grateful for any kind of help. Thank you.&lt;/p&gt;</comment>
                            <comment id="15969924" author="umesh9794@gmail.com" created="Sat, 15 Apr 2017 11:39:22 +0000"  >&lt;p&gt;While looking at ExecutorAllocationManager.onExecutorIdle, there is a condition which checks whether executor has CachedBlocks or not , if it has cached blocks then it uses cachedExecutorIdleTimeoutS and if no cached blocks it uses executorIdleTimeoutS.&lt;/p&gt;

&lt;p&gt;Still not sure why even after calling unpersist it is behaving like this. One possibility: there might be some cached data on executors which is not reported to the BlockManager and it is causing executor to follow cachedExecutorIdleTimeout instead of executorIdleTimeout. &lt;br/&gt;
Need some thoughts though cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=joshrosen&quot; class=&quot;user-hover&quot; rel=&quot;joshrosen&quot;&gt;joshrosen&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rxin&quot; class=&quot;user-hover&quot; rel=&quot;rxin&quot;&gt;rxin&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15969944" author="mpasa" created="Sat, 15 Apr 2017 12:47:52 +0000"  >&lt;p&gt;My supposition is that &lt;tt&gt;onExecutorIdle&lt;/tt&gt; is only called when a task ends, so it&apos;s already idle when you call &lt;tt&gt;unpersist&lt;/tt&gt;. I&apos;m not sure how to test this though. Also, it will be great if the UI can show an &quot;idle&quot; status for the executors. Currently, they&apos;re shown as &quot;Active&quot; until they&apos;re killed and then shown as &quot;Dead&quot;.&lt;/p&gt;</comment>
                            <comment id="15972231" author="umesh9794@gmail.com" created="Tue, 18 Apr 2017 07:16:44 +0000"  >&lt;p&gt;Yep, +1 to the UI changes. However, I tested the behaviour by following the steps mentioned by you and this seems to be fixed in 2.1.0. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;spark2-shell  --conf spark.dynamicAllocation.executorIdleTimeout=7s --conf spark.dynamicAllocation.cachedExecutorIdleTimeout=20s --conf spark.dynamicAllocation.minExecutors=2

scala&amp;gt; sc.setLogLevel(&lt;span class=&quot;code-quote&quot;&gt;&quot;INFO&quot;&lt;/span&gt;)

scala&amp;gt; val rdd=sc.textFile(&lt;span class=&quot;code-quote&quot;&gt;&quot;/tmp/config.txt&quot;&lt;/span&gt;)
..
17/04/17 23:46:58 INFO spark.SparkContext: Created broadcast 0 from textFile at &amp;lt;console&amp;gt;:24
rdd: org.apache.spark.rdd.RDD[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;] = /tmp/config.txt MapPartitionsRDD[1] at textFile at &amp;lt;console&amp;gt;:24
..
..
scala&amp;gt; rdd.collect
17/04/17 23:47:10 INFO mapred.FileInputFormat: Total input paths to process : 1
17/04/17 23:47:10 INFO spark.SparkContext: Starting job: collect at &amp;lt;console&amp;gt;:27
..
..
17/04/17 23:47:13 INFO scheduler.DAGScheduler: Job 0 finished: collect at &amp;lt;console&amp;gt;:27, took 3.457215 s
..
scala&amp;gt; 17/04/17 23:47:20 INFO spark.ExecutorAllocationManager: Request to remove executorIds: 1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As expected executors remove request was received above after 7 secs. Then I tested behaviour for persist: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;scala&amp;gt; rdd.persist
res2: rdd.type = /tmp/config.txt MapPartitionsRDD[1] at textFile at &amp;lt;console&amp;gt;:24

scala&amp;gt; rdd.count
17/04/17 23:47:45 INFO spark.SparkContext: Starting job: count at &amp;lt;console&amp;gt;:27
..
17/04/17 23:47:45 INFO scheduler.DAGScheduler: Job 1 finished: count at &amp;lt;console&amp;gt;:27, took 0.293053 s
..
scala&amp;gt; 17/04/17 23:48:05 INFO spark.ExecutorAllocationManager: Request to remove executorIds: 1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In this case also request for removing the executor was received after 20 secs. Afterwords I tested unpersist: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;scala&amp;gt; rdd.unpersist(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
17/04/17 23:50:22 INFO rdd.MapPartitionsRDD: Removing RDD 1 from persistence list
17/04/17 23:50:22 INFO storage.BlockManager: Removing RDD 1
res7: rdd.type = /tmp/config.txt MapPartitionsRDD[1] at textFile at &amp;lt;console&amp;gt;:24

scala&amp;gt; rdd.count
17/04/17 23:50:31 INFO spark.SparkContext: Starting job: count at &amp;lt;console&amp;gt;:27
..
17/04/17 23:50:31 INFO scheduler.DAGScheduler: Job 3 finished: count at &amp;lt;console&amp;gt;:27, took 0.219764 s
res8: &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; = 100
..
scala&amp;gt; 17/04/17 23:50:38 INFO spark.ExecutorAllocationManager: Request to remove executorIds: 1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This time remove request was received after 7 secs. &lt;/p&gt;</comment>
                            <comment id="15972253" author="mpasa" created="Tue, 18 Apr 2017 07:35:09 +0000"  >&lt;p&gt;Thank you! I&apos;ll check it again and close the issue if I cannot reproduce the problem in 2.1.0.&lt;/p&gt;</comment>
                            <comment id="16570754" author="apachespark" created="Mon, 6 Aug 2018 20:45:04 +0000"  >&lt;p&gt;User &apos;dhruve&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/22015&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/22015&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16770344" author="toopt4" created="Sun, 17 Feb 2019 10:14:21 +0000"  >&lt;p&gt;gentle ping&lt;/p&gt;</comment>
                            <comment id="16856703" author="irashid" created="Wed, 5 Jun 2019 13:10:19 +0000"  >&lt;p&gt;Issue resolved by pull request 24704&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/24704&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/24704&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13171490">SPARK-24786</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 23 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3dghz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>