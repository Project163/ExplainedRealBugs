<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:25:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-33482] V2 Datasources that extend FileScan preclude exchange reuse</title>
                <link>https://issues.apache.org/jira/browse/SPARK-33482</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Sample query:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;spark.read.parquet(&quot;tbl&quot;).createOrReplaceTempView(&quot;tbl&quot;)
spark.read.parquet(&quot;lookup&quot;).createOrReplaceTempView(&quot;lookup&quot;)

sql(&quot;&quot;&quot;
   select tbl.col1, fk1, fk2
   from tbl, lookup l1, lookup l2
   where fk1 = l1.key
   and fk2 = l2.key
&quot;&quot;&quot;).explain
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Test files can be created as so:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;import scala.util.Random

val rand = Random

val tbl = spark.range(1, 10000).map { x =&amp;gt;
  (rand.nextLong.abs % 20,
   rand.nextLong.abs % 20,
   x)
}.toDF(&quot;fk1&quot;, &quot;fk2&quot;, &quot;col1&quot;)

tbl.write.mode(&quot;overwrite&quot;).parquet(&quot;tbl&quot;)

val lookup = spark.range(0, 20).map { x =&amp;gt;
  (x + 1, x * 10000, (x + 1) * 10000)
}.toDF(&quot;key&quot;, &quot;col1&quot;, &quot;col2&quot;)
lookup.write.mode(&quot;overwrite&quot;).parquet(&quot;lookup&quot;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Output with V1 Parquet reader:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; == Physical Plan ==
*(3) Project [col1#2L, fk1#0L, fk2#1L]
+- *(3) BroadcastHashJoin [fk2#1L], [key#12L], Inner, BuildRight, false
   :- *(3) Project [fk1#0L, fk2#1L, col1#2L]
   :  +- *(3) BroadcastHashJoin [fk1#0L], [key#6L], Inner, BuildRight, false
   :     :- *(3) Filter (isnotnull(fk1#0L) AND isnotnull(fk2#1L))
   :     :  +- *(3) ColumnarToRow
   :     :     +- FileScan parquet [fk1#0L,fk2#1L,col1#2L] Batched: true, DataFilters: [isnotnull(fk1#0L), isnotnull(fk2#1L)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/bruce/github/spark_upstream/tbl], PartitionFilters: [], PushedFilters: [IsNotNull(fk1), IsNotNull(fk2)], ReadSchema: struct&amp;lt;fk1:bigint,fk2:bigint,col1:bigint&amp;gt;
   :     +- BroadcastExchange HashedRelationBroadcastMode(List(input[0, bigint, false]),false), [id=#75]
   :        +- *(1) Filter isnotnull(key#6L)
   :           +- *(1) ColumnarToRow
   :              +- FileScan parquet [key#6L] Batched: true, DataFilters: [isnotnull(key#6L)], Format: Parquet, Location: InMemoryFileIndex[file:/Users/bruce/github/spark_upstream/lookup], PartitionFilters: [], PushedFilters: [IsNotNull(key)], ReadSchema: struct&amp;lt;key:bigint&amp;gt;
   +- ReusedExchange [key#12L], BroadcastExchange HashedRelationBroadcastMode(List(input[0, bigint, false]),false), [id=#75]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;With V1 Parquet reader, the exchange for lookup is reused (see last line).&lt;/p&gt;

&lt;p&gt;Output with V2 Parquet reader (spark.sql.sources.useV1SourceList=&quot;&quot;):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; == Physical Plan ==
*(3) Project [col1#2L, fk1#0L, fk2#1L]
+- *(3) BroadcastHashJoin [fk2#1L], [key#12L], Inner, BuildRight, false
   :- *(3) Project [fk1#0L, fk2#1L, col1#2L]
   :  +- *(3) BroadcastHashJoin [fk1#0L], [key#6L], Inner, BuildRight, false
   :     :- *(3) Filter (isnotnull(fk1#0L) AND isnotnull(fk2#1L))
   :     :  +- *(3) ColumnarToRow
   :     :     +- BatchScan[fk1#0L, fk2#1L, col1#2L] ParquetScan DataFilters: [isnotnull(fk1#0L), isnotnull(fk2#1L)], Format: parquet, Location: InMemoryFileIndex[file:/Users/bruce/github/spark_upstream/tbl], PartitionFilters: [], PushedFilers: [IsNotNull(fk1), IsNotNull(fk2)], ReadSchema: struct&amp;lt;fk1:bigint,fk2:bigint,col1:bigint&amp;gt;, PushedFilters: [IsNotNull(fk1), IsNotNull(fk2)]
   :     +- BroadcastExchange HashedRelationBroadcastMode(List(input[0, bigint, false]),false), [id=#75]
   :        +- *(1) Filter isnotnull(key#6L)
   :           +- *(1) ColumnarToRow
   :              +- BatchScan[key#6L] ParquetScan DataFilters: [isnotnull(key#6L)], Format: parquet, Location: InMemoryFileIndex[file:/Users/bruce/github/spark_upstream/lookup], PartitionFilters: [], PushedFilers: [IsNotNull(key)], ReadSchema: struct&amp;lt;key:bigint&amp;gt;, PushedFilters: [IsNotNull(key)]
   +- BroadcastExchange HashedRelationBroadcastMode(List(input[0, bigint, false]),false), [id=#83]
      +- *(2) Filter isnotnull(key#12L)
         +- *(2) ColumnarToRow
            +- BatchScan[key#12L] ParquetScan DataFilters: [isnotnull(key#12L)], Format: parquet, Location: InMemoryFileIndex[file:/Users/bruce/github/spark_upstream/lookup], PartitionFilters: [], PushedFilers: [IsNotNull(key)], ReadSchema: struct&amp;lt;key:bigint&amp;gt;, PushedFilters: [IsNotNull(key)]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;With the V2 Parquet reader, the exchange for lookup is not reused (see last 4 lines).&lt;/p&gt;

&lt;p&gt;You can see the same issue with the Orc reader (and I assume any other datasource that extends Filescan).&lt;/p&gt;

&lt;p&gt;The issue appears to be this check in FileScan#equals:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ExpressionSet(partitionFilters) == ExpressionSet(f.partitionFilters) &amp;amp;&amp;amp;
ExpressionSet(dataFilters) == ExpressionSet(f.dataFilters)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;partitionFilters and dataFilters are not normalized, so their exprIds don&apos;t match. Thus FileScan objects don&apos;t match, even if they are the same.&lt;/p&gt;

&lt;p&gt;As a side note, FileScan#equals has a dangling boolean expression:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
fileIndex == f.fileIndex &amp;amp;&amp;amp; readSchema == f.readSchema
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The result of that expression is not actually used anywhere. We might want to include it in the final decision, even though that&apos;s not the issue here.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13341480">SPARK-33482</key>
            <summary>V2 Datasources that extend FileScan preclude exchange reuse</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="petertoth">Peter Toth</assignee>
                                    <reporter username="bersprockets">Bruce Robbins</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 Nov 2020 02:58:14 +0000</created>
                <updated>Wed, 24 Mar 2021 15:07:45 +0000</updated>
                            <resolved>Tue, 23 Mar 2021 09:25:21 +0000</resolved>
                                    <version>3.0.0</version>
                    <version>3.0.1</version>
                    <version>3.0.2</version>
                    <version>3.1.0</version>
                    <version>3.1.1</version>
                                    <fixVersion>3.0.3</fixVersion>
                    <fixVersion>3.1.2</fixVersion>
                    <fixVersion>3.2.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17300548" author="apachespark" created="Fri, 12 Mar 2021 18:45:55 +0000"  >&lt;p&gt;User &apos;peter-toth&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/31820&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/31820&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17304315" author="apachespark" created="Thu, 18 Mar 2021 17:54:27 +0000"  >&lt;p&gt;User &apos;peter-toth&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/31848&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/31848&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17304316" author="apachespark" created="Thu, 18 Mar 2021 17:54:42 +0000"  >&lt;p&gt;User &apos;peter-toth&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/31848&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/31848&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17306919" author="cloud_fan" created="Tue, 23 Mar 2021 09:25:21 +0000"  >&lt;p&gt;Issue resolved by pull request 31848&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/31848&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/31848&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17307697" author="apachespark" created="Wed, 24 Mar 2021 09:23:46 +0000"  >&lt;p&gt;User &apos;peter-toth&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/31952&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/31952&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17307698" author="apachespark" created="Wed, 24 Mar 2021 09:23:55 +0000"  >&lt;p&gt;User &apos;peter-toth&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/31952&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/31952&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 33 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0kqjk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>