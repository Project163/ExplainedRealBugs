<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:00:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-23991] data loss when allocateBlocksToBatch</title>
                <link>https://issues.apache.org/jira/browse/SPARK-23991</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;with checkpoint and WAL enabled, driver will write the allocation of blocks to batch into hdfs. however, if it fails as following, the blocks of this batch cannot be computed by the DAG. Because the blocks have been dequeued from the receivedBlockQueue and get lost.&lt;/p&gt;
&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;error log&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;&lt;br/&gt;
18/04/15 11:11:25 WARN ReceivedBlockTracker: Exception thrown while writing record: BatchAllocationEvent(1523765480000 ms,AllocatedBlocks(Map(0 -&amp;gt; ArrayBuffer()))) to the WriteAheadLog. org.apache.spark.SparkException: Exception thrown in awaitResult: at org.apache.spark.util.ThreadUtils$.awaitResult(ThreadUtils.scala:194) at org.apache.spark.streaming.util.BatchedWriteAheadLog.write(BatchedWriteAheadLog.scala:83) at org.apache.spark.streaming.scheduler.ReceivedBlockTracker.writeToLog(ReceivedBlockTracker.scala:234) at org.apache.spark.streaming.scheduler.ReceivedBlockTracker.allocateBlocksToBatch(ReceivedBlockTracker.scala:118) at org.apache.spark.streaming.scheduler.ReceiverTracker.allocateBlocksToBatch(ReceiverTracker.scala:213) at org.apache.spark.streaming.scheduler.JobGenerator$$anonfun$3.apply(JobGenerator.scala:248) at org.apache.spark.streaming.scheduler.JobGenerator$$anonfun$3.apply(JobGenerator.scala:247) at scala.util.Try$.apply(Try.scala:192) at org.apache.spark.streaming.scheduler.JobGenerator.generateJobs(JobGenerator.scala:247) at org.apache.spark.streaming.scheduler.JobGenerator.org$apache$spark$streaming$scheduler$JobGenerator$$processEvent(JobGenerator.scala:183) at org.apache.spark.streaming.scheduler.JobGenerator$$anon$1.onReceive(JobGenerator.scala:89) at org.apache.spark.streaming.scheduler.JobGenerator$$anon$1.onReceive(JobGenerator.scala:88) at org.apache.spark.util.EventLoop$$anon$1.run(EventLoop.scala:48) Caused by: java.util.concurrent.TimeoutException: Futures timed out after &lt;span class=&quot;error&quot;&gt;&amp;#91;5000 milliseconds&amp;#93;&lt;/span&gt; at scala.concurrent.impl.Promise$DefaultPromise.ready(Promise.scala:219) at scala.concurrent.impl.Promise$DefaultPromise.result(Promise.scala:223) at scala.concurrent.Await$$anonfun$result$1.apply(package.scala:190) at scala.concurrent.BlockContext$DefaultBlockContext$.blockOn(BlockContext.scala:53) at scala.concurrent.Await$.result(package.scala:190) at org.apache.spark.util.ThreadUtils$.awaitResult(ThreadUtils.scala:190) ... 12 more 18/04/15 11:11:25 INFO ReceivedBlockTracker: Possibly processed batch 1523765480000 ms needs to be processed again in WAL recovery&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;the concerning codes are showed below:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  /**
   * Allocate all unallocated blocks to the given batch.
   * This event will get written to the write ahead log (&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; enabled).
   */
  def allocateBlocksToBatch(batchTime: Time): Unit = &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lastAllocatedBatchTime == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || batchTime &amp;gt; lastAllocatedBatchTime) {
      val streamIdToBlocks = streamIds.map { streamId =&amp;gt;
          (streamId, getReceivedBlockQueue(streamId).dequeueAll(x =&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;))
      }.toMap
      val allocatedBlocks = AllocatedBlocks(streamIdToBlocks)
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (writeToLog(BatchAllocationEvent(batchTime, allocatedBlocks))) {
        timeToAllocatedBlocks.put(batchTime, allocatedBlocks)
        lastAllocatedBatchTime = batchTime
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        logInfo(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Possibly processed batch $batchTime needs to be processed again in WAL recovery&quot;&lt;/span&gt;)
      }
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      &lt;span class=&quot;code-comment&quot;&gt;// This situation occurs when:
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// 1. WAL is ended with BatchAllocationEvent, but without BatchCleanupEvent,
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// possibly processed batch job or half-processed batch job need to be processed again,
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// so the batchTime will be equal to lastAllocatedBatchTime.
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// 2. Slow checkpointing makes recovered batch time older than WAL recovered
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// lastAllocatedBatchTime.
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// This situation will only occurs in recovery time.
&lt;/span&gt;      logInfo(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Possibly processed batch $batchTime needs to be processed again in WAL recovery&quot;&lt;/span&gt;)
    }
  }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;spark 2.11&lt;/p&gt;</environment>
        <key id="13152693">SPARK-23991</key>
            <summary>data loss when allocateBlocksToBatch</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gsomogyi">Gabor Somogyi</assignee>
                                    <reporter username="kevin09fjw">kevin fu</reporter>
                        <labels>
                    </labels>
                <created>Mon, 16 Apr 2018 11:30:28 +0000</created>
                <updated>Tue, 29 May 2018 12:12:51 +0000</updated>
                            <resolved>Tue, 29 May 2018 12:12:31 +0000</resolved>
                                    <version>2.2.0</version>
                                    <fixVersion>2.3.1</fixVersion>
                    <fixVersion>2.4.0</fixVersion>
                                    <component>DStreams</component>
                    <component>Input/Output</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16490729" author="apachespark" created="Fri, 25 May 2018 13:27:07 +0000"  >&lt;p&gt;User &apos;gaborgsomogyi&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21430&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21430&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16493453" author="jerryshao" created="Tue, 29 May 2018 12:12:31 +0000"  >&lt;p&gt;Issue resolved by pull request 21430&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21430&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21430&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 25 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3slen:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>