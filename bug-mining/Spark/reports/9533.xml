<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:39:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-40362] Bug in Canonicalization of expressions like Add &amp; Multiply i.e Commutative Operators</title>
                <link>https://issues.apache.org/jira/browse/SPARK-40362</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;In the canonicalization code which is now in two stages, canonicalization involving Commutative operators is broken, if they are subexpressions of certain type of expressions which override precanonicalize, for example BinaryComparison&#160;&lt;/p&gt;

&lt;p&gt;Consider following expression:&lt;/p&gt;

&lt;p&gt;a + b &amp;gt; 10&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160;GT&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; |&lt;/p&gt;

&lt;p&gt;a + b&#160; &#160; &#160; &#160; &#160; 10&lt;/p&gt;

&lt;p&gt;The BinaryComparison operator in the precanonicalize, first precanonicalizes&#160; children &amp;amp; then&#160; &#160;may swap operands based on left /right hashCode inequality..&lt;/p&gt;

&lt;p&gt;lets say&#160; Add(a + b) .hashCode is &amp;gt;&#160; 10.hashCode as a result GT is converted to LT&lt;/p&gt;

&lt;p&gt;But If the same tree is created&#160;&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160;GT&lt;/p&gt;

&lt;p&gt;&#160; &#160; &#160; &#160; &#160; &#160; |&lt;/p&gt;

&lt;p&gt;&#160;b + a&#160; &#160; &#160; 10&lt;/p&gt;

&lt;p&gt;The hashCode of Add(b, a) is not same as Add(a, b) , thus it is possible that for this tree&lt;/p&gt;

&lt;p&gt;&#160;Add(b + a) .hashCode is &amp;lt;&#160; 10.hashCode&#160; in which case GT remains as is.&lt;/p&gt;

&lt;p&gt;Thus to similar trees result in different canonicalization , one having GT other having LT&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The problem occurs because&#160; for commutative expressions the canonicalization normalizes the expression with consistent hashCode which is not the case with precanonicalize as the hashCode of commutative expression &apos;s precanonicalize and post canonicalize are different.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The test&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;test(&quot;bug X&quot;)&lt;br/&gt;
Unknown macro: { &#160; &#160; val tr1 = LocalRelation(&apos;c.int, &apos;b.string, &apos;a.int) &#160; &#160;val y = tr1.where(&apos;a.attr + &apos;c.attr &amp;gt; 10).analyze &#160; &#160;val fullCond = y.asInstanceOf&lt;span class=&quot;error&quot;&gt;&amp;#91;Filter&amp;#93;&lt;/span&gt;.condition.clone() &#160; val addExpr = (fullCond match Unknown macro}&lt;br/&gt;
).clone().asInstanceOf&lt;span class=&quot;error&quot;&gt;&amp;#91;Add&amp;#93;&lt;/span&gt;&lt;br/&gt;
val canonicalizedFullCond = fullCond.canonicalized&lt;/p&gt;

&lt;p&gt;// swap the operands of add&lt;br/&gt;
val newAddExpr = Add(addExpr.right, addExpr.left)&lt;/p&gt;

&lt;p&gt;// build a new condition which is same as the previous one, but with operands of //Add reversed&#160;&lt;/p&gt;

&lt;p&gt;val builtCondnCanonicalized = GreaterThan(newAddExpr, Literal(10)).canonicalized&lt;/p&gt;

&lt;p&gt;assertEquals(canonicalizedFullCond, builtCondnCanonicalized)&lt;br/&gt;
}&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This test fails.&lt;/p&gt;

&lt;p&gt;The fix which I propose is that for the commutative expressions, the precanonicalize should be overridden and &#160;Canonicalize.reorderCommutativeOperators be invoked on the expression instead of at place of canonicalize. effectively for commutative operands ( add, or , multiply , and etc) canonicalize and precanonicalize should be same.&lt;/p&gt;

&lt;p&gt;PR:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/spark/pull/37824&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/37824&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I am also trying a better fix, where by the idea is that for commutative expressions the murmur hashCode are caluculated using unorderedHash so that it is order&#160; independent ( i.e symmetric).&lt;/p&gt;

&lt;p&gt;The above approach works fine , but in case of Least &amp;amp; Greatest, the Product&apos;s element is&#160; a Seq,&#160; and that messes with consistency of hashCode.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13480357">SPARK-40362</key>
            <summary>Bug in Canonicalization of expressions like Add &amp; Multiply i.e Commutative Operators</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="petertoth">Peter Toth</assignee>
                                    <reporter username="ashahid7">Asif</reporter>
                        <labels>
                            <label>spark-sql</label>
                    </labels>
                <created>Tue, 6 Sep 2022 22:18:32 +0000</created>
                <updated>Tue, 13 Sep 2022 19:38:45 +0000</updated>
                            <resolved>Tue, 13 Sep 2022 19:38:27 +0000</resolved>
                                    <version>3.3.0</version>
                                    <fixVersion>3.3.1</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="259200">72h</timeoriginalestimate>
                            <timeestimate seconds="259200">72h</timeestimate>
                                        <comments>
                            <comment id="17601933" author="apachespark" created="Thu, 8 Sep 2022 17:13:45 +0000"  >&lt;p&gt;User &apos;ahshahid&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/37824&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/37824&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17602739" author="apachespark" created="Sat, 10 Sep 2022 18:06:05 +0000"  >&lt;p&gt;User &apos;peter-toth&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/37851&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/37851&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17602741" author="apachespark" created="Sat, 10 Sep 2022 18:07:18 +0000"  >&lt;p&gt;User &apos;peter-toth&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/37851&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/37851&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17603619" author="apachespark" created="Tue, 13 Sep 2022 15:04:03 +0000"  >&lt;p&gt;User &apos;peter-toth&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/37866&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/37866&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17603747" author="dongjoon" created="Tue, 13 Sep 2022 19:38:27 +0000"  >&lt;p&gt;Issue resolved by pull request 37866&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/37866&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/37866&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 9 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z18cy0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311620" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Shepherd</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>cloud_fan</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>