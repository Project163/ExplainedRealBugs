<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:30:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-40089] Sorting of at least Decimal(20, 2) fails for some values near the max.</title>
                <link>https://issues.apache.org/jira/browse/SPARK-40089</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I have been doing some testing with Decimal values for the RAPIDS Accelerator for Apache Spark. I have been trying to add in new corner cases and when I tried to enable the maximum supported value for a sort I started to get failures.&#160; On closer inspection it looks like the CPU is sorting things incorrectly.&#160; Specifically anything that is &quot;999999999999999999.50&quot; or above is placed as a chunk in the wrong location in the outputs.&lt;/p&gt;

&lt;p&gt;&#160;In local mode with 12 tasks.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
spark.read.parquet(&lt;span class=&quot;code-quote&quot;&gt;&quot;input.parquet&quot;&lt;/span&gt;).orderBy(col(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;)).collect.foreach(&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Here you will notice that the last entry printed is &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;999999999999999999.49&amp;#93;&lt;/span&gt;&lt;/tt&gt;, and &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;999999999999999999.99&amp;#93;&lt;/span&gt;&lt;/tt&gt; is near the top near &lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;-999999999999999999.99&amp;#93;&lt;/span&gt;&lt;/tt&gt;&lt;/p&gt;
</description>
                <environment></environment>
        <key id="13476892">SPARK-40089</key>
            <summary>Sorting of at least Decimal(20, 2) fails for some values near the max.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="revans2">Robert Joseph Evans</assignee>
                                    <reporter username="revans2">Robert Joseph Evans</reporter>
                        <labels>
                    </labels>
                <created>Mon, 15 Aug 2022 20:02:25 +0000</created>
                <updated>Tue, 23 Aug 2022 17:52:18 +0000</updated>
                            <resolved>Mon, 22 Aug 2022 08:38:53 +0000</resolved>
                                    <version>3.2.0</version>
                    <version>3.3.0</version>
                    <version>3.4.0</version>
                                    <fixVersion>3.1.4</fixVersion>
                    <fixVersion>3.3.1</fixVersion>
                    <fixVersion>3.2.3</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17579887" author="revans2" created="Mon, 15 Aug 2022 20:04:29 +0000"  >&lt;p&gt;I have been trying to debug this and it does not look like it is related to the partitioner. I can run with a single shuffle partition and I get the same results. Not sure if the prefix calculation is doing this or what.&lt;/p&gt;</comment>
                            <comment id="17579892" author="revans2" created="Mon, 15 Aug 2022 20:19:43 +0000"  >&lt;p&gt;It sure looks like it is related to the prefix calculator. I think it is overflowing some how. I added some debugging into 3.2.0 and I got back&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
22/08/15 20:17:58 ERROR SortExec: PREFIX FOR 999999999999999999.99 IS &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; -9223372036854775808
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The prefix should not be negative for non-negative values.&lt;/p&gt;</comment>
                            <comment id="17579897" author="revans2" created="Mon, 15 Aug 2022 20:28:45 +0000"  >&lt;p&gt;Looking at the code it appears that the prefix calculator has an overflow bug in it.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (value.changePrecision(p, s)) value.toUnscaledLong &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MinValue
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We are rounding up when changing the precision and when that happens we fall back to &lt;tt&gt;Long.MinValue&lt;/tt&gt;  a.k.a -9223372036854775808, which results in the failure. &lt;/p&gt;</comment>
                            <comment id="17579984" author="ulysses" created="Tue, 16 Aug 2022 01:46:34 +0000"  >&lt;p&gt;thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=revans2&quot; class=&quot;user-hover&quot; rel=&quot;revans2&quot;&gt;revans2&lt;/a&gt; for reporting the issue, I can reproduce it by:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
SELECT &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(col1 as decimal(20,2)) as c FROM VALUES (999999999999999999.50),(999999999999999999.49),(1.11) ORDER BY c;

-- output:
999999999999999999.50
1.11
999999999999999999.49&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;do you want send a pr to fix it ?&lt;/p&gt;</comment>
                            <comment id="17580360" author="revans2" created="Tue, 16 Aug 2022 15:02:13 +0000"  >&lt;p&gt;I have been trying to come up with a patch, but keep hitting some issues. I first tried to change &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; dt: DecimalType &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; dt.precision - dt.scale &amp;lt;= Decimal.MAX_LONG_DIGITS =&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;to&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; dt: DecimalType &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; dt.precision - dt.scale &amp;lt; Decimal.MAX_LONG_DIGITS =&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So that we would bypass the overflow case entirely and use the Double prefix logic. But when I do that the negative values all come after the positive values when sorting ascending. So now I have a lot of other tests/debugging that I need to run to understand what is happening there. Just because I think I have found another bug. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ulysses&quot; class=&quot;user-hover&quot; rel=&quot;ulysses&quot;&gt;ulysses&lt;/a&gt; I don&apos;t have a ton of time that I can devote to this right now, I will keep working towards a patch, but if you want to put up one, then I would love to see it. &lt;/p&gt;</comment>
                            <comment id="17580377" author="revans2" created="Tue, 16 Aug 2022 15:46:08 +0000"  >&lt;p&gt;Never mind I figured out that there is a separate prefixComparator that does the same kinds of checks. But I have a fix that works, so I will put up a PR shortly.&lt;/p&gt;</comment>
                            <comment id="17580434" author="revans2" created="Tue, 16 Aug 2022 19:57:00 +0000"  >&lt;p&gt;I put up a PR &lt;a href=&quot;https://github.com/apache/spark/pull/37540&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/37540&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17580437" author="apachespark" created="Tue, 16 Aug 2022 19:58:04 +0000"  >&lt;p&gt;User &apos;revans2&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/37540&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/37540&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17582811" author="cloud_fan" created="Mon, 22 Aug 2022 08:38:53 +0000"  >&lt;p&gt;Issue resolved by pull request 37540&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/37540&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/37540&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13048141" name="input.parquet" size="23716" author="revans2" created="Mon, 15 Aug 2022 20:03:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 12 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z17rq8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>