<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:59:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-24043] InterpretedPredicate.eval fails if expression tree contains Nondeterministic expressions</title>
                <link>https://issues.apache.org/jira/browse/SPARK-24043</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When whole-stage codegen and predicate codegen both fail,&#160;FilterExec falls back&#160;to using InterpretedPredicate. If the predicate&apos;s expression contains any non-deterministic expressions, the evaluation throws an error:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;scala&amp;gt; val df = Seq((1)).toDF(&quot;a&quot;)
df: org.apache.spark.sql.DataFrame = [a: int]

scala&amp;gt; df.filter(&apos;a &amp;gt; 0).show // this works fine
2018-04-21 20:39:26 WARN  FilterExec:66 - Codegen disabled for this expression:
 (value#1 &amp;gt; 0)
+---+
|  a|
+---+
|  1|
+---+

scala&amp;gt; df.filter(&apos;a &amp;gt; rand(7)).show // this will throw an error
2018-04-21 20:39:40 WARN  FilterExec:66 - Codegen disabled for this expression:
 (cast(value#1 as double) &amp;gt; rand(7))
2018-04-21 20:39:40 ERROR Executor:91 - Exception in task 0.0 in stage 1.0 (TID 1)
java.lang.IllegalArgumentException: requirement failed: Nondeterministic expression org.apache.spark.sql.catalyst.expressions.Rand should be initialized before eval.
	at scala.Predef$.require(Predef.scala:224)
	at org.apache.spark.sql.catalyst.expressions.Nondeterministic$class.eval(Expression.scala:326)
	at org.apache.spark.sql.catalyst.expressions.RDG.eval(randomExpressions.scala:34)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is because no code initializes the Nondeterministic expressions before eval is called on them.&lt;/p&gt;

&lt;p&gt;This is a low impact issue, since it would require both whole-stage codegen and predicate codegen to fail before FilterExec would fall back to using InterpretedPredicate.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13154287">SPARK-24043</key>
            <summary>InterpretedPredicate.eval fails if expression tree contains Nondeterministic expressions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bersprockets">Bruce Robbins</assignee>
                                    <reporter username="bersprockets">Bruce Robbins</reporter>
                        <labels>
                    </labels>
                <created>Sun, 22 Apr 2018 03:46:24 +0000</created>
                <updated>Mon, 7 May 2018 15:54:55 +0000</updated>
                            <resolved>Mon, 7 May 2018 15:54:55 +0000</resolved>
                                    <version>2.3.0</version>
                                    <fixVersion>2.4.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16447614" author="maropu" created="Mon, 23 Apr 2018 06:20:52 +0000"  >&lt;p&gt;I tried this in the master and v2.3 though, the issue didn&apos;t happen there. Do I miss any precondition?&lt;/p&gt;</comment>
                            <comment id="16449281" author="bersprockets" created="Tue, 24 Apr 2018 04:47:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maropu&quot; class=&quot;user-hover&quot; rel=&quot;maropu&quot;&gt;maropu&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&amp;gt; Do I miss any precondition?&lt;/p&gt;

&lt;p&gt;For this bug to materialize in spark-shell, Spark SQL needs to be interpreted mode (whole-stage codegen and predicate codegen are shut off).&lt;/p&gt;

&lt;p&gt;I ran some of the DataFrame and Dataset test suites in interpreted mode and this bug popped out (during the run for the test &quot;handle nondeterministic expressions correctly for set operations&quot;). To put Spark SQL in interpreted mode, I manually shut off whole-stage codegen and predicate codegen. It was still off when I did the above spark-shell demo.&lt;/p&gt;

&lt;p&gt;Outside of manually tweaking Spark, it&apos;s difficult to get predicate codegen to fail (It&apos;s easy to get whole-stage codegen to fall back &#8211; just supply more than 300 columns in your query. Predicate codegen is more resilient). That&apos;s why this is a low impact bug. However, at some point we might want to test interpreted mode.&lt;/p&gt;

&lt;p&gt;I will make a PR, but it&apos;s no emergency.&lt;/p&gt;

&lt;p&gt;To see the bug in action with Spark as-is, add these test cases to PredicateSuite. The first should succeed (no Nondeterministic expressions). The second will fail with an exception (&quot;Nondeterministic expression org.apache.spark.sql.catalyst.expressions.Rand should be initialized before eval&quot;):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  test(&lt;span class=&quot;code-quote&quot;&gt;&quot;Interpreted Predicate should work without nondeterministic expressions&quot;&lt;/span&gt;) {
    val interpreted = InterpretedPredicate.create(LessThan(Literal(0.2), Literal(1.0)))
    interpreted.initialize(0)
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt;(interpreted.eval(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow()))
  }

  test(&lt;span class=&quot;code-quote&quot;&gt;&quot;Interpreted Predicate should initialize nondeterministic expressions&quot;&lt;/span&gt;) {
    val interpreted = InterpretedPredicate.create(LessThan(Rand(7), Literal(1.0)))
    interpreted.initialize(0)
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt;(interpreted.eval(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow()))
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16449326" author="maropu" created="Tue, 24 Apr 2018 05:42:38 +0000"  >&lt;p&gt;I tried this with codegen=off;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      ____              __
     / __/__  ___ _____/ /__
    _\ \/ _ \/ _ `/ __/  &apos;_/
   /___/ .__/\_,_/_/ /_/\_\   version 2.3.0
      /_/
         
Using Scala version 2.11.8 (Java HotSpot(TM) 64-Bit Server VM, Java 1.8.0_31)
Type in expressions to have them evaluated.
Type :help &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; more information.

scala&amp;gt; sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;SET spark.sql.codegen.wholeStage=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;)
res0: org.apache.spark.sql.DataFrame = [key: string, value: string]

scala&amp;gt; Seq((1)).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;).filter(&apos;a &amp;gt; rand(7)).show 
+---+
|  a|
+---+
|  1|
+---+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16449352" author="bersprockets" created="Tue, 24 Apr 2018 06:12:17 +0000"  >&lt;p&gt;You&apos;re half-way there. When whole-stage codegen is off (and only then), FilterExec requests&#160;code generation and compilation for the predicate. See FilterExec.doExecute (which calls SparkPlan.newPredicate, which attempts to generate code for the predicate).&lt;/p&gt;

&lt;p&gt;I couldn&apos;t find a configuration setting to turn off predicate codegen.&lt;/p&gt;</comment>
                            <comment id="16449428" author="maropu" created="Tue, 24 Apr 2018 07:37:53 +0000"  >&lt;p&gt;Aha, I gotcha. ya, we currently have no configuration for the expression tree.&lt;/p&gt;</comment>
                            <comment id="16450426" author="apachespark" created="Tue, 24 Apr 2018 19:31:04 +0000"  >&lt;p&gt;User &apos;bersprockets&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21144&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21144&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 29 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3sv5z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>