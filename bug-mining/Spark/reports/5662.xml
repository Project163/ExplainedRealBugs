<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:59:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-23815] Spark writer dynamic partition overwrite mode fails to write output on multi level partition</title>
                <link>https://issues.apache.org/jira/browse/SPARK-23815</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Spark introduced new writer mode to overwrite only related partitions in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-20236&quot; title=&quot;Overwrite a partitioned data source table should only overwrite related partitions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-20236&quot;&gt;&lt;del&gt;SPARK-20236&lt;/del&gt;&lt;/a&gt;. While we are using this feature in our production cluster, we found a bug when writing multi-level partitions on HDFS.&lt;/p&gt;

&lt;p&gt;A simple test case to reproduce this issue:&lt;br/&gt;
 val df = Seq((&quot;1&quot;,&quot;2&quot;,&quot;3&quot;)).toDF(&quot;col1&quot;, &quot;col2&quot;,&quot;col3&quot;)&lt;br/&gt;
 df.write.partitionBy(&quot;col1&quot;,&quot;col2&quot;).mode(&quot;overwrite&quot;).save(&quot;/my/hdfs/location&quot;)&lt;/p&gt;

&lt;p&gt;If HDFS location &quot;/my/hdfs/location&quot; does not exist, there will be no output.&lt;/p&gt;

&lt;p&gt;This seems to be caused by the job commit change in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-20236&quot; title=&quot;Overwrite a partitioned data source table should only overwrite related partitions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-20236&quot;&gt;&lt;del&gt;SPARK-20236&lt;/del&gt;&lt;/a&gt; in HadoopMapReduceCommitProtocol.&lt;/p&gt;

&lt;p&gt;In the commit job process, the output has been written into staging dir /my/hdfs/location/.spark-staging.xxx/col1=1/col2=2, and then the code calls fs.rename to rename /my/hdfs/location/.spark-staging.xxx/col1=1/col2=2 to /my/hdfs/location/col1=1/col2=2. However, in our case the operation will fail on HDFS because /my/hdfs/location/col1=1 does not exists. HDFS rename can not&#160;create directory for more than one level.&#160;&lt;/p&gt;

&lt;p&gt;This does not happen in&#160;unit test covered&#160;with&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-20236&quot; title=&quot;Overwrite a partitioned data source table should only overwrite related partitions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-20236&quot;&gt;&lt;del&gt;SPARK-20236&lt;/del&gt;&lt;/a&gt; with local file system.&lt;/p&gt;

&lt;p&gt;We are proposing a fix. When cleaning current partition dir /my/hdfs/location/col1=1/col2=2 before the rename op, if the delete op fails (because /my/hdfs/location/col1=1/col2=2 may not exist), we call mkdirs op to create the parent dir /my/hdfs/location/col1=1 (if the parent dir does not exist) so the following rename op can succeed.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Reference: In official hdfs documentation(&lt;a href=&quot;https://hadoop.apache.org/docs/stable/hadoop-project-dist/hadoop-common/filesystem/filesystem.html),&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hadoop.apache.org/docs/stable/hadoop-project-dist/hadoop-common/filesystem/filesystem.html),&lt;/a&gt;&#160;the rename operation has preconditions:&#160;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

{{dest}}&#160;must be root, or have a parent that exists

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13148791">SPARK-23815</key>
            <summary>Spark writer dynamic partition overwrite mode fails to write output on multi level partition</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shengzhixia">Fangshi Li</assignee>
                                    <reporter username="shengzhixia">Fangshi Li</reporter>
                        <labels>
                    </labels>
                <created>Thu, 29 Mar 2018 05:16:18 +0000</created>
                <updated>Fri, 13 Apr 2018 05:59:33 +0000</updated>
                            <resolved>Fri, 13 Apr 2018 05:48:23 +0000</resolved>
                                    <version>2.3.0</version>
                                    <fixVersion>2.3.1</fixVersion>
                    <fixVersion>2.4.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16418452" author="apachespark" created="Thu, 29 Mar 2018 05:21:04 +0000"  >&lt;p&gt;User &apos;fangshil&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/20931&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/20931&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16436876" author="cloud_fan" created="Fri, 13 Apr 2018 05:48:23 +0000"  >&lt;p&gt;Issue resolved by pull request 20931&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/20931&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/20931&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 31 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3rxfz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>