<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:55:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-21563] Race condition when serializing TaskDescriptions and adding jars</title>
                <link>https://issues.apache.org/jira/browse/SPARK-21563</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=robert3005&quot; class=&quot;user-hover&quot; rel=&quot;robert3005&quot;&gt;robert3005&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I was seeing this exception during some running Spark jobs:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;16:16:28.294 [dispatcher-event-loop-14] ERROR org.apache.spark.rpc.netty.Inbox - Ignoring error
java.io.EOFException: null
    at java.io.DataInputStream.readFully(DataInputStream.java:197)
    at java.io.DataInputStream.readUTF(DataInputStream.java:609)
    at java.io.DataInputStream.readUTF(DataInputStream.java:564)
    at org.apache.spark.scheduler.TaskDescription$$anonfun$decode$1.apply(TaskDescription.scala:127)
    at org.apache.spark.scheduler.TaskDescription$$anonfun$decode$1.apply(TaskDescription.scala:126)
    at scala.collection.immutable.Range.foreach(Range.scala:160)
    at org.apache.spark.scheduler.TaskDescription$.decode(TaskDescription.scala:126)
    at org.apache.spark.executor.CoarseGrainedExecutorBackend$$anonfun$receive$1.applyOrElse(CoarseGrainedExecutorBackend.scala:95)
    at org.apache.spark.rpc.netty.Inbox$$anonfun$process$1.apply$mcV$sp(Inbox.scala:117)
    at org.apache.spark.rpc.netty.Inbox.safelyCall(Inbox.scala:205)
    at org.apache.spark.rpc.netty.Inbox.process(Inbox.scala:101)
    at org.apache.spark.rpc.netty.Dispatcher$MessageLoop.run(Dispatcher.scala:213)
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
    at java.lang.Thread.run(Thread.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After some debugging, we determined that this is due to a race condition in task serde.  cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=irashid&quot; class=&quot;user-hover&quot; rel=&quot;irashid&quot;&gt;irashid&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kayousterhout&quot; class=&quot;user-hover&quot; rel=&quot;kayousterhout&quot;&gt;kayousterhout&lt;/a&gt; who last touched that code in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-19796&quot; title=&quot;taskScheduler fails serializing long statements received by thrift server&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-19796&quot;&gt;&lt;del&gt;SPARK-19796&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The race is between adding additional jars to the SparkContext and serializing the TaskDescription.&lt;/p&gt;

&lt;p&gt;Consider this sequence of events:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TaskSetManager creates a TaskDescription using a reference to the SparkContext&apos;s jars: &lt;a href=&quot;https://github.com/apache/spark/blob/v2.2.0/core/src/main/scala/org/apache/spark/scheduler/TaskSetManager.scala#L506&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/v2.2.0/core/src/main/scala/org/apache/spark/scheduler/TaskSetManager.scala#L506&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;TaskDescription starts serializing, and begins writing jars: &lt;a href=&quot;https://github.com/apache/spark/blob/v2.2.0/core/src/main/scala/org/apache/spark/scheduler/TaskDescription.scala#L84&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/v2.2.0/core/src/main/scala/org/apache/spark/scheduler/TaskDescription.scala#L84&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;the size of the jar map is written out: &lt;a href=&quot;https://github.com/apache/spark/blob/v2.2.0/core/src/main/scala/org/apache/spark/scheduler/TaskDescription.scala#L63&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/v2.2.0/core/src/main/scala/org/apache/spark/scheduler/TaskDescription.scala#L63&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;em&gt;on another thread&lt;/em&gt;: the application adds a jar to the SparkContext&apos;s jars list&lt;/li&gt;
	&lt;li&gt;then the entries in the jars list are serialized out: &lt;a href=&quot;https://github.com/apache/spark/blob/v2.2.0/core/src/main/scala/org/apache/spark/scheduler/TaskDescription.scala#L64&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/v2.2.0/core/src/main/scala/org/apache/spark/scheduler/TaskDescription.scala#L64&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The problem now is that the jars list is serialized as having N entries, but actually N+1 entries follow that count!&lt;/p&gt;

&lt;p&gt;This causes task deserialization to fail in the executor, with the stacktrace above.&lt;/p&gt;

&lt;p&gt;The same issue also likely exists for files, though I haven&apos;t observed that and our application does not stress that codepath the same way it did for jar additions.&lt;/p&gt;

&lt;p&gt;One fix here is that TaskSetManager could make an immutable copy of the jars list that it passes into the TaskDescription constructor, so that list doesn&apos;t change mid-serialization.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13090879">SPARK-21563</key>
            <summary>Race condition when serializing TaskDescriptions and adding jars</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aash">Andrew Ash</assignee>
                                    <reporter username="aash">Andrew Ash</reporter>
                        <labels>
                    </labels>
                <created>Fri, 28 Jul 2017 20:08:40 +0000</created>
                <updated>Mon, 14 Aug 2017 14:58:53 +0000</updated>
                            <resolved>Mon, 14 Aug 2017 14:58:53 +0000</resolved>
                                    <version>2.2.0</version>
                                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>2.3.0</fixVersion>
                                    <component>Scheduler</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16105772" author="aash" created="Fri, 28 Jul 2017 22:08:04 +0000"  >&lt;p&gt;And for reference, I added this additional logging to assist in debugging: &lt;a href=&quot;https://github.com/palantir/spark/pull/238&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/palantir/spark/pull/238&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16109060" author="irashid" created="Tue, 1 Aug 2017 15:12:07 +0000"  >&lt;p&gt;Thanks for the detailed report &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aash&quot; class=&quot;user-hover&quot; rel=&quot;aash&quot;&gt;aash&lt;/a&gt;, makes perfect sense.  I think your proposed solution,  making an immutable copy of the files and jars, is the right thing to do.  I&apos;d just add that you should do it once per TaskSetManager, not once per TaskDescription.&lt;/p&gt;

&lt;p&gt;Do you want to take a stab at submitting the PR for this?&lt;/p&gt;</comment>
                            <comment id="16122549" author="aash" created="Thu, 10 Aug 2017 23:45:18 +0000"  >&lt;p&gt;Thanks for the thoughts &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=irashid&quot; class=&quot;user-hover&quot; rel=&quot;irashid&quot;&gt;irashid&lt;/a&gt; &amp;#8211; I submitted a PR implementing this approach at &lt;a href=&quot;https://github.com/apache/spark/pull/18913&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18913&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 14 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3i5g7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>