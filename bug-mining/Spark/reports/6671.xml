<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:06:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-29003] Spark history server startup hang due to deadlock</title>
                <link>https://issues.apache.org/jira/browse/SPARK-29003</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Occasionally when starting Spark History Server, the service process will hang before binding to the port so Spark History Server is not usable. One has to kill the process and start again. You can write a simple bash program to stop and start Spark History Server and you can reproduce this problem approximately 10% of time.&lt;/p&gt;

&lt;p&gt;The problem is due to java.nio.file.FileSystems.getDefault() cause deadlock. This is what I collected with jstack:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;log-replay-executor-0&quot;&lt;/span&gt; #17 daemon prio=5 os_prio=0 tid=0x00007fca90028800 nid=0x6e8 in &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait() [0x00007fcaa9471000]
    java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE 
    at java.nio.file.FileSystems.getDefault(FileSystems.java:176) 
    ... 
    at java.lang.&lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;.loadLibrary0(&lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;.java:870) - locked &amp;lt;0x00000000aaac1d40&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;) 
    ... 
    at org.apache.spark.deploy.history.FsHistoryProvider.mergeApplicationListing(FsHistoryProvider.scala:698)

&lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; #1 prio=5 os_prio=0 tid=0x00007fcad8016800 nid=0x6d8 waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; monitor entry [0x00007fcae146c000]
&#160; &#160; java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: BLOCKED (on object monitor) 
    at java.lang.&lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;.loadLibrary0(&lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;.java:862) - waiting to lock &amp;lt;0x00000000aaac1d40&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;) 
    ... 
    at java.nio.file.FileSystems.getDefault(FileSystems.java:176) 
    at java.io.File.toPath(File.java:2234) - locked &amp;lt;0x000000008699bb68&amp;gt; (a java.io.File) 
    ...&#160;
    at org.apache.spark.ui.JettyUtils$.startJettyServer(JettyUtils.scala:365)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Basically &quot;main&quot; thread and &quot;log-replay-executor-0&quot; thread simultaneously calling java.nio,file.FileSystems.getDefault() and deadlocked.&#160;&lt;/p&gt;

&lt;p&gt;This is similar to the reported JDK bug:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://bugs.openjdk.java.net/browse/JDK-8037567&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bugs.openjdk.java.net/browse/JDK-8037567&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The problem is that during Spark History Server startup, there are two things happening simultaneously that call into java.nio.file.FileSystems.getDefault():&lt;/p&gt;

&lt;p&gt;1) start jetty server&lt;br/&gt;
 2) start ApplicationHistoryProvider (which reads files from HDFS)&lt;/p&gt;

&lt;p&gt;We should do this two things sequentially instead of in parallel.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13255117">SPARK-29003</key>
            <summary>Spark history server startup hang due to deadlock</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shanyu">shanyu zhao</assignee>
                                    <reporter username="shanyu">shanyu zhao</reporter>
                        <labels>
                    </labels>
                <created>Fri, 6 Sep 2019 00:28:46 +0000</created>
                <updated>Sat, 14 Sep 2019 04:09:37 +0000</updated>
                            <resolved>Sat, 14 Sep 2019 04:09:37 +0000</resolved>
                                    <version>2.3.4</version>
                    <version>2.4.4</version>
                                    <fixVersion>3.0.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16923877" author="kabhwan" created="Fri, 6 Sep 2019 02:38:28 +0000"  >&lt;p&gt;Could you provide full of jstack? I guess unless you modify Spark it would be no line to redact. That would be much clearer to see the full picture.&lt;/p&gt;</comment>
                            <comment id="16924567" author="shanyu" created="Fri, 6 Sep 2019 20:07:19 +0000"  >&lt;p&gt;Please see the full jstack attached.&lt;/p&gt;</comment>
                            <comment id="16924581" author="kabhwan" created="Fri, 6 Sep 2019 20:38:35 +0000"  >&lt;p&gt;Thanks for providing jstack. Looks like it&apos;s known JDK issue but given the fixed version is too high I agree we may need to apply workaround on this.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://bugs.openjdk.java.net/browse/JDK-8194653&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bugs.openjdk.java.net/browse/JDK-8194653&lt;/a&gt;&lt;/p&gt;



&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Discussion:&#160;&lt;a href=&quot;http://mail.openjdk.java.net/pipermail/core-libs-dev/2018-January/050830.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://mail.openjdk.java.net/pipermail/core-libs-dev/2018-January/050830.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16929670" author="dongjoon" created="Sat, 14 Sep 2019 04:09:37 +0000"  >&lt;p&gt;Issue resolved by pull request 25705&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/25705&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/25705&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12979712" name="sparkhistory-jstack.log" size="21416" author="shanyu" created="Fri, 6 Sep 2019 20:06:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 9 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z06di8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>