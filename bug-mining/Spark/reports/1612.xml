<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:25:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-6450] Metastore Parquet table conversion fails when a single metastore Parquet table appears multiple times in the query</title>
                <link>https://issues.apache.org/jira/browse/SPARK-6450</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;The below query was working fine till 1.3 commit 9a151ce58b3e756f205c9f3ebbbf3ab0ba5b33fd.(Yes it definitely works at this commit although this commit is completely unrelated)&lt;/p&gt;

&lt;p&gt;It got broken in 1.3.0 release with an AnalysisException: resolved attributes ... missing from .... (although this list contains the fields which it reports missing)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;at org.apache.spark.sql.hive.thriftserver.SparkExecuteStatementOperation.run(Shim13.scala:189)
	at org.apache.hive.service.cli.session.HiveSessionImpl.executeStatementInternal(HiveSessionImpl.java:231)
	at org.apache.hive.service.cli.session.HiveSessionImpl.executeStatementAsync(HiveSessionImpl.java:218)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:606)
	at org.apache.hive.service.cli.session.HiveSessionProxy.invoke(HiveSessionProxy.java:79)
	at org.apache.hive.service.cli.session.HiveSessionProxy.access$000(HiveSessionProxy.java:37)
	at org.apache.hive.service.cli.session.HiveSessionProxy$1.run(HiveSessionProxy.java:64)
	at java.security.AccessController.doPrivileged(Native Method)
	at javax.security.auth.Subject.doAs(Subject.java:415)
	at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1548)
	at org.apache.hadoop.hive.shims.HadoopShimsSecure.doAs(HadoopShimsSecure.java:493)
	at org.apache.hive.service.cli.session.HiveSessionProxy.invoke(HiveSessionProxy.java:60)
	at com.sun.proxy.$Proxy17.executeStatementAsync(Unknown Source)
	at org.apache.hive.service.cli.CLIService.executeStatementAsync(CLIService.java:233)
	at org.apache.hive.service.cli.thrift.ThriftCLIService.ExecuteStatement(ThriftCLIService.java:344)
	at org.apache.hive.service.cli.thrift.TCLIService$Processor$ExecuteStatement.getResult(TCLIService.java:1313)
	at org.apache.hive.service.cli.thrift.TCLIService$Processor$ExecuteStatement.getResult(TCLIService.java:1298)
	at org.apache.thrift.ProcessFunction.process(ProcessFunction.java:39)
	at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:39)
	at org.apache.hive.service.auth.TSetIpAddressProcessor.process(TSetIpAddressProcessor.java:55)
	at org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadPoolServer.java:206)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;select Orders.Country, Orders.ProductCategory,count(1) from Orders join (select Orders.Country, count(1) CountryOrderCount from Orders where to_date(Orders.PlacedDate) &amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;2015-01-01&apos;&lt;/span&gt; group by Orders.Country order by CountryOrderCount DESC LIMIT 5) Top5Countries on Top5Countries.Country = Orders.Country where to_date(Orders.PlacedDate) &amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;2015-01-01&apos;&lt;/span&gt; group by Orders.Country,Orders.ProductCategory;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The temporary workaround is to add explicit alias for the table Orders&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;select o.Country, o.ProductCategory,count(1) from Orders o join (select r.Country, count(1) CountryOrderCount from Orders r where to_date(r.PlacedDate) &amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;2015-01-01&apos;&lt;/span&gt; group by r.Country order by CountryOrderCount DESC LIMIT 5) Top5Countries on Top5Countries.Country = o.Country where to_date(o.PlacedDate) &amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;2015-01-01&apos;&lt;/span&gt; group by o.Country,o.ProductCategory;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However this change not only affects self joins, it also seems to affect union queries as well, like the below query which was again working before(commit 9a151ce) got broken&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;select Orders.Country,&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,count(1) OrderCount from Orders group by Orders.Country,&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
union all
select &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,Orders.ProductCategory,count(1) OrderCount from Orders group by &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, Orders.ProductCategory
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;also fails with a Analysis exception.&lt;br/&gt;
The workaround is to add different aliases for the tables.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12784628">SPARK-6450</key>
            <summary>Metastore Parquet table conversion fails when a single metastore Parquet table appears multiple times in the query</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lian cheng">Cheng Lian</assignee>
                                    <reporter username="chinnitv">Anand Mohan Tumuluri</reporter>
                        <labels>
                    </labels>
                <created>Sun, 22 Mar 2015 02:26:46 +0000</created>
                <updated>Thu, 26 Mar 2015 00:40:38 +0000</updated>
                            <resolved>Thu, 26 Mar 2015 00:40:38 +0000</resolved>
                                    <version>1.3.0</version>
                                    <fixVersion>1.3.1</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14374760" author="marmbrus" created="Sun, 22 Mar 2015 02:55:57 +0000"  >&lt;p&gt;What kind of table are you reading from?  Does it happen to be parquet?&lt;/p&gt;</comment>
                            <comment id="14374761" author="chinnitv" created="Sun, 22 Mar 2015 02:59:40 +0000"  >&lt;p&gt;Yes it is from Parquet&lt;/p&gt;

&lt;p&gt;On Sat, Mar 21, 2015 at 7:56 PM, Michael Armbrust (JIRA) &amp;lt;jira@apache.org&amp;gt;&lt;/p&gt;
</comment>
                            <comment id="14375129" author="marmbrus" created="Sun, 22 Mar 2015 19:43:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lian+cheng&quot; class=&quot;user-hover&quot; rel=&quot;lian cheng&quot;&gt;lian cheng&lt;/a&gt; I think we are failing to attach the table name as a qualifier when converting parquet relations to the native code path.&lt;/p&gt;</comment>
                            <comment id="14375343" author="lian cheng" created="Mon, 23 Mar 2015 03:25:29 +0000"  >&lt;p&gt;Ah, I see. Will handle this ASAP. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chinnitv&quot; class=&quot;user-hover&quot; rel=&quot;chinnitv&quot;&gt;chinnitv&lt;/a&gt; Thanks for reporting this!&lt;/p&gt;</comment>
                            <comment id="14379086" author="marmbrus" created="Wed, 25 Mar 2015 01:11:16 +0000"  >&lt;p&gt;I am having trouble reproducing this issue.  Can you explain more how you are creating the table in question?&lt;/p&gt;</comment>
                            <comment id="14379114" author="lian cheng" created="Wed, 25 Mar 2015 01:35:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chinnitv&quot; class=&quot;user-hover&quot; rel=&quot;chinnitv&quot;&gt;chinnitv&lt;/a&gt;, could you please provide the DDL of the Orders table to help reproducing this issue?&lt;/p&gt;</comment>
                            <comment id="14379125" author="lian cheng" created="Wed, 25 Mar 2015 01:44:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chinnitv&quot; class=&quot;user-hover&quot; rel=&quot;chinnitv&quot;&gt;chinnitv&lt;/a&gt;, never mind, reproduced this issue with 1.3.0 release and the following Spark shell snippet:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;sqlContext.sql(&quot;&quot;&quot;create table if not exists Orders (Country string, ProductCategory string, PlacedDate string) stored as parquet&quot;&quot;&quot;)

sqlContext.sql(&quot;&quot;&quot;
    select
        Orders.Country,
        Orders.ProductCategory,
        count(1)
    from
        Orders
    join (
        select
            Orders.Country,
            count(1) CountryOrderCount
        from
            Orders
        where
            to_date(Orders.PlacedDate) &amp;gt; &apos;2015-01-01&apos;
        group by
            Orders.Country
        order by
            CountryOrderCount DESC
        LIMIT 5
    ) Top5Countries
    on
        Top5Countries.Country = Orders.Country
    where
        to_date(Orders.PlacedDate) &amp;gt; &apos;2015-01-01&apos;
    group by
        Orders.Country,
        Orders.ProductCategory
    &quot;&quot;&quot;).queryExecution.analyzed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14379499" author="lian cheng" created="Wed, 25 Mar 2015 08:38:11 +0000"  >&lt;p&gt;Here is a simpler Spark shell snippet for reproduction:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    import sqlContext._

    sql(
      &quot;&quot;&quot;CREATE TABLE IF NOT EXISTS ms_convert (key INT)
        |STORED AS PARQUET
      &quot;&quot;&quot;.stripMargin)

    // This shouldn&apos;t throw AnalysisException
    val analyzed = sql(
      &quot;&quot;&quot;SELECT key FROM ms_convert
        |UNION ALL
        |SELECT key FROM ms_convert
      &quot;&quot;&quot;.stripMargin).queryExecution.analyzed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marmbrus&quot; class=&quot;user-hover&quot; rel=&quot;marmbrus&quot;&gt;marmbrus&lt;/a&gt; has nailed down the root cause: the &lt;tt&gt;ParquetConversions&lt;/tt&gt; analysis rule generates a hash map, which maps from the original &lt;tt&gt;MetastoreRelation&lt;/tt&gt; instances to the newly created &lt;tt&gt;ParquetRelation2&lt;/tt&gt; instances. However, &lt;tt&gt;MetastoreRelation.equals&lt;/tt&gt; doesn&apos;t compare output attributes. Thus, if a single metastore Parquet table appears multiple times in a query, only a single entry ends up in the hash map, and the conversion is not correctly performed.&lt;/p&gt;

&lt;p&gt;Proper fix for this issue should be overriding &lt;tt&gt;equals&lt;/tt&gt; and &lt;tt&gt;hashCode&lt;/tt&gt; for &lt;tt&gt;MetastoreRelation&lt;/tt&gt;. However, this breaks more tests than expected. It&apos;s possible that these tests are ill-formed from the very beginning. But as 1.3.1 release is approaching, we&apos;d like to make the change more surgical to avoid potential regressions. The proposed fix here is to make both the metastore relations and their output attributes as keys in the hash map used in &lt;tt&gt;ParquetConversions&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14379539" author="apachespark" created="Wed, 25 Mar 2015 09:20:40 +0000"  >&lt;p&gt;User &apos;liancheng&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/5183&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/5183&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14381126" author="marmbrus" created="Thu, 26 Mar 2015 00:40:38 +0000"  >&lt;p&gt;Issue resolved by pull request 5183&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/5183&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/5183&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 34 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i276yv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311620" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Shepherd</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marmbrus</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12329486">1.3.1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>