<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:49:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-18597] Do not push down filters for LEFT ANTI JOIN</title>
                <link>https://issues.apache.org/jira/browse/SPARK-18597</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;The optimizer pushes down filters for left anti joins. This unfortunately has the opposite effect. For example:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;sql(&quot;create or replace temporary view tbl_a as values (1, 5), (2, 1), (3, 6) as t(c1, c2)&quot;)
sql(&quot;create or replace temporary view tbl_b as values 1 as t(c1)&quot;)
sql(&quot;&quot;&quot;
select *
from   tbl_a
       left anti join tbl_b on ((tbl_a.c1 = tbl_a.c2) is null or tbl_a.c1 = tbl_a.c2)
&quot;&quot;&quot;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Should return rows &lt;span class=&quot;error&quot;&gt;&amp;#91;1, 5&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;2, 1&amp;#93;&lt;/span&gt; &amp;amp; &lt;span class=&quot;error&quot;&gt;&amp;#91;3, 6&amp;#93;&lt;/span&gt;, but returns no rows.&lt;/p&gt;

&lt;p&gt;The upside is that this will only happen when you use a really weird anti-join (only referencing the table on the left hand side).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13023579">SPARK-18597</key>
            <summary>Do not push down filters for LEFT ANTI JOIN</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hvanhovell">Herman van H&#246;vell</assignee>
                                    <reporter username="hvanhovell">Herman van H&#246;vell</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Sun, 27 Nov 2016 13:48:05 +0000</created>
                <updated>Mon, 28 Nov 2016 21:24:57 +0000</updated>
                            <resolved>Mon, 28 Nov 2016 15:15:38 +0000</resolved>
                                                    <fixVersion>2.0.3</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15700571" author="apachespark" created="Mon, 28 Nov 2016 00:31:05 +0000"  >&lt;p&gt;User &apos;hvanhovell&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/16026&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16026&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15700636" author="nsyca" created="Mon, 28 Nov 2016 01:23:41 +0000"  >&lt;p&gt;It&apos;s nice to learn through this JIRA that Spark supports &lt;tt&gt;left anti join&lt;/tt&gt; externally rather just being an internal form when rewriting &lt;tt&gt;NOT EXISTS&lt;/tt&gt; or &lt;tt&gt;NOT IN&lt;/tt&gt;. If this is to follow the traditional join semantics, why does Spark choose not to output the columns from the right table of a &lt;tt&gt;left anti join&lt;/tt&gt;? I guess the same question applies to &lt;tt&gt;left semi&lt;/tt&gt; as well.&lt;/p&gt;</comment>
                            <comment id="15702328" author="hvanhovell" created="Mon, 28 Nov 2016 16:03:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nsyca&quot; class=&quot;user-hover&quot; rel=&quot;nsyca&quot;&gt;nsyca&lt;/a&gt; LEFT SEMI and LEFT ANTI are both SEMI joins (half joins). A semi join only returns rows from the first table when it matches one or more rows from the second table (I got this from &lt;a href=&quot;http://www.slideshare.net/alokeparnachoudhury/semi-joins&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.slideshare.net/alokeparnachoudhury/semi-joins&lt;/a&gt;). The anti join is the opposite, and only returns a row form the first table when it does not match any row in the second table.&lt;/p&gt;

&lt;p&gt;Hive also supports LEFT SEMI JOIN: &lt;a href=&quot;https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Joins&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Joins&lt;/a&gt;&lt;br/&gt;
Impala supports both LEFT SEMI and LEFT ANTI JOIN: &lt;a href=&quot;https://www.cloudera.com/documentation/enterprise/5-7-x/topics/impala_joins.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.cloudera.com/documentation/enterprise/5-7-x/topics/impala_joins.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15702336" author="apachespark" created="Mon, 28 Nov 2016 16:07:05 +0000"  >&lt;p&gt;User &apos;hvanhovell&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/16039&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16039&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15702454" author="nsyca" created="Mon, 28 Nov 2016 16:48:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hvanhovell&quot; class=&quot;user-hover&quot; rel=&quot;hvanhovell&quot;&gt;hvanhovell&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dongjoon&quot; class=&quot;user-hover&quot; rel=&quot;dongjoon&quot;&gt;dongjoon&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smilegator&quot; class=&quot;user-hover&quot; rel=&quot;smilegator&quot;&gt;smilegator&lt;/a&gt; FYI:&lt;/p&gt;

&lt;p&gt;I edited the description to reflect the correct behaviour of the &lt;tt&gt;LeftAnti&lt;/tt&gt; in the example. The correct answer is all the rows from tbl_a as there is no row in tbl_a that satisfies the predicate tbl_a.c1 = tbl_a.c2 in the ON clause. By the LeftAnti semantics of tbl_a except rows that satisfy the predicate in the ON clause, all rows from tbl_a are returned. &lt;/p&gt;</comment>
                            <comment id="15702474" author="hvanhovell" created="Mon, 28 Nov 2016 16:53:25 +0000"  >&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="15702505" author="nsyca" created="Mon, 28 Nov 2016 17:06:19 +0000"  >&lt;p&gt;I also left another comment in the PR that &lt;tt&gt;ExistenceJoin&lt;/tt&gt; should be treated the same as &lt;tt&gt;LeftOuter&lt;/tt&gt; and &lt;tt&gt;LeftAnti&lt;/tt&gt;, not &lt;tt&gt;InnerLike&lt;/tt&gt; and &lt;tt&gt;LeftSemi&lt;/tt&gt;. This is not currently exposed because the rewrite of &lt;tt&gt;[NOT] EXISTS OR ...&lt;/tt&gt; to &lt;tt&gt;ExistenceJoin&lt;/tt&gt; happens in rule &lt;tt&gt;RewritePredicateSubquery&lt;/tt&gt;, which is in a separate rule set and placed after the rule &lt;tt&gt;PushPredicateThroughJoin&lt;/tt&gt;. During the transformation in the rule &lt;tt&gt;PushPredicateThroughJoin&lt;/tt&gt;, an ExistenceJoin never exists.&lt;/p&gt;

&lt;p&gt;The semantics of &lt;tt&gt;ExistenceJoin&lt;/tt&gt; says we need to preserve all the rows from the left table through the join operation as if it is a regular &lt;tt&gt;LeftOuter&lt;/tt&gt; join. The &lt;tt&gt;ExistenceJoin&lt;/tt&gt; augments the &lt;tt&gt;LeftOuter&lt;/tt&gt; operation with a new column called &lt;tt&gt;exists&lt;/tt&gt;, set to true when the join condition in the ON clause is true and false otherwise. The filter of any rows will happen in the &lt;tt&gt;Filter&lt;/tt&gt; operation above the &lt;tt&gt;ExistenceJoin&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Example:&lt;/p&gt;

&lt;p&gt;A(c1, c2): &lt;/p&gt;
{ (1, 1), (1, 2) }
&lt;p&gt;B(c1): &lt;/p&gt;
{ (NULL) }
&lt;p&gt;   // can be any value as it is irrelevant in this example&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;A&lt;/span&gt;.*
&lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;A&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;where&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;exists&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;select&lt;/span&gt; 1 &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; B &lt;span class=&quot;code-keyword&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;A&lt;/span&gt;.c1 = &lt;span class=&quot;code-keyword&quot;&gt;A&lt;/span&gt;.c2)
       &lt;span class=&quot;code-keyword&quot;&gt;or&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;A&lt;/span&gt;.c2=2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In this example, the correct result is all the rows from A. If the pattern &lt;tt&gt;ExistenceJoin&lt;/tt&gt; at line 935 in &lt;tt&gt;Optimizer.scala&lt;/tt&gt; added by the PR of this JIRA is indeed active, the code will push down the predicate A.c1 = A.c2 to be a &lt;tt&gt;Filter&lt;/tt&gt; on relation A, which will filter the row (1,2) from A.&lt;/p&gt;

&lt;p&gt;If you agree with my analysis above, I can open a JIRA/a PR to move this piece of code from &lt;tt&gt;InnerLike&lt;/tt&gt; to &lt;tt&gt;LeftOuter&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15703126" author="hvanhovell" created="Mon, 28 Nov 2016 21:10:09 +0000"  >&lt;p&gt;That is a correct assessment. We will lose rows if we push down filters into the left side of an &lt;tt&gt;ExistanceJoin&lt;/tt&gt;. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nsyca&quot; class=&quot;user-hover&quot; rel=&quot;nsyca&quot;&gt;nsyca&lt;/a&gt; could you open a JIRA/PR for this?&lt;/p&gt;</comment>
                            <comment id="15703151" author="nsyca" created="Mon, 28 Nov 2016 21:20:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-18614&quot; title=&quot;Incorrect predicate pushdown from ExistenceJoin&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-18614&quot;&gt;&lt;del&gt;SPARK-18614&lt;/del&gt;&lt;/a&gt; is opened to deliver a fix to close this potential, not-yet-exposed, rewrite problem.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13023865">SPARK-18614</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 51 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i36tg7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12335644">2.1.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>