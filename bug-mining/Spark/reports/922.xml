<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:19:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-4022] Replace colt dependency (LGPL) with commons-math</title>
                <link>https://issues.apache.org/jira/browse/SPARK-4022</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;The colt library we use is LGPL-licensed:&lt;br/&gt;
&lt;a href=&quot;http://acs.lbl.gov/ACSSoftware/colt/license.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://acs.lbl.gov/ACSSoftware/colt/license.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We need to swap this out for commons-math. It is also a very old library that hasn&apos;t been updated since 2004.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12749398">SPARK-4022</key>
            <summary>Replace colt dependency (LGPL) with commons-math</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="srowen">Sean R. Owen</assignee>
                                    <reporter username="pwendell">Patrick Wendell</reporter>
                        <labels>
                    </labels>
                <created>Tue, 21 Oct 2014 00:56:19 +0000</created>
                <updated>Tue, 28 Oct 2014 20:57:15 +0000</updated>
                            <resolved>Mon, 27 Oct 2014 17:53:35 +0000</resolved>
                                                    <fixVersion>1.2.0</fixVersion>
                                    <component>MLlib</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14177759" author="srowen" created="Tue, 21 Oct 2014 01:03:32 +0000"  >&lt;p&gt;Yeah, looks like it is only in examples at least, so I don&apos;t know if Colt ever got technically distributed (? I forget whether it goes out with transitive deps). But best to change it. I can try it, since I know Commons Math well, unless someone&apos;s already on it.&lt;/p&gt;</comment>
                            <comment id="14177763" author="mengxr" created="Tue, 21 Oct 2014 01:10:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt; We use its random number generators and the stat.Probability package in core and mllib. It would be great if you can work on this JIRA. There are couple places we need to change:&lt;/p&gt;

&lt;p&gt;1) sampling&lt;br/&gt;
2) chi-sq tests&lt;br/&gt;
3) random forests&lt;br/&gt;
4) some unit tests&lt;/p&gt;

&lt;p&gt;We also need to shade the commons-math3 jar because hadoop depends on it. Fortunately, commons-math3 doesn&apos;t have any run-time deps.&lt;/p&gt;</comment>
                            <comment id="14177776" author="srowen" created="Tue, 21 Oct 2014 01:22:31 +0000"  >&lt;p&gt;Ah right there is Jet too, not just Colt.&lt;/p&gt;

&lt;p&gt;The LGPL license actually only pertains to a few parts of Colt, in hep.aida.*, which aren&apos;t used by Spark.&lt;br/&gt;
Another solution is just to make sure these classes never become part of the distribution. Colt and Jet themselves don&apos;t appear to be LGPL, in the main.&lt;/p&gt;

&lt;p&gt;Of course, if there was a desire to just stop using Colt+Jet anyway, I&apos;m cool with that too.&lt;/p&gt;</comment>
                            <comment id="14177784" author="mengxr" created="Tue, 21 Oct 2014 01:26:08 +0000"  >&lt;p&gt;Colt is really old. Even the download link (&lt;a href=&quot;http://acs.lbl.gov/software/colt/colt-download&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://acs.lbl.gov/software/colt/colt-download&lt;/a&gt;) is broken. It is good if we switch to an alternative that is active and has no license issues.&lt;/p&gt;</comment>
                            <comment id="14181524" author="srowen" created="Thu, 23 Oct 2014 16:17:18 +0000"  >&lt;p&gt;I have begun work on this. You can see the base change here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/srowen/spark/commits/SPARK-4022&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/srowen/spark/commits/SPARK-4022&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/srowen/spark/commit/8246dbd39be7ff162392c59c28dee74a1419e236&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/srowen/spark/commit/8246dbd39be7ff162392c59c28dee74a1419e236&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;There are 4 potential problems, each of which might need some assistance as to how to proceed.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;HypothesisTestSuite failure&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dorx&quot; class=&quot;user-hover&quot; rel=&quot;dorx&quot;&gt;dorx&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;HypothesisTestSuite:
  ...
- chi squared pearson RDD[LabeledPoint] *** FAILED ***
  org.apache.commons.math3.exception.NotStrictlyPositiveException: shape (0)
  at org.apache.commons.math3.distribution.GammaDistribution.&amp;lt;init&amp;gt;(GammaDistribution.java:168)
  ...
  at org.apache.spark.mllib.stat.test.ChiSqTest$.chiSquaredMatrix(ChiSqTest.scala:241)
  at org.apache.spark.mllib.stat.test.ChiSqTest$$anonfun$chiSquaredFeatures$4.apply(ChiSqTest.scala:134)
  at org.apache.spark.mllib.stat.test.ChiSqTest$$anonfun$chiSquaredFeatures$4.apply(ChiSqTest.scala:125)
  at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:244)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The commons-math3 implementation complains that a chi squared distribution is created with 0 degrees of freedom. It looks like that for col 645 in this test, there is just one feature, 0, and two labels. The contingency table should be at least 2x2 but it&apos;s 1x2 only, and that&apos;s not valid AFAICT. I spent some time staring at this and don&apos;t quite know what to make of fixing it.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;KMeansClusterSuite failure&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mengxr&quot; class=&quot;user-hover&quot; rel=&quot;mengxr&quot;&gt;mengxr&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;KMeansClusterSuite:
- task size should be small in both training and prediction *** FAILED ***
  org.apache.spark.SparkException: Job aborted due to stage failure: Task 0 in stage 1.0 failed 4 times, most recent failure: Lost task 0.3 in stage 1.0 (TID 8, localhost): java.io.InvalidClassException: org.apache.spark.util.random.PoissonSampler; local &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;incompatible: stream classdesc serialVersionUID = -795011761847245121, local &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;serialVersionUID = 4249244967777318419
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I understand what it&apos;s saying. PoissonSampler did indeed change and its serialized form changed, but, I don&apos;t see how two incompatible versions are turning up as a result of one clean build.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;RandomForestSuite failure&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=josephkb&quot; class=&quot;user-hover&quot; rel=&quot;josephkb&quot;&gt;josephkb&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;RandomForestSuite:
...
- alternating categorical and continuous features with multiclass labels to test indexing *** FAILED ***
  java.lang.AssertionError: assertion failed: validateClassifier calculated accuracy 0.75 but required 1.0.
  at scala.Predef$.&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt;(Predef.scala:179)
  at org.apache.spark.mllib.tree.RandomForestSuite$.validateClassifier(RandomForestSuite.scala:227)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;My guess on this one is that something is sampled differently as a result of this change, and happens to make the decision forest come out differently on this toy data set, and it happens to get 3/4 instead of 4/4 right now. This may be ignorable, meaning, the test was actually a little too strict and optimistic.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Less efficient seeded sampling for series of Poisson variables&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dorx&quot; class=&quot;user-hover&quot; rel=&quot;dorx&quot;&gt;dorx&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Colt had a way to seed the RNG, then generate a one-off sample from a Poisson distribution with mean m. commons-math3 lets you seed an instance of a Poisson distribution with mean m, but then not change that mean. To simulate, it&apos;s necessary to recreate a Poisson distribution with each successive mean with a deterministic series of seeds.&lt;/p&gt;

&lt;p&gt;See here: &lt;a href=&quot;https://github.com/srowen/spark/commit/8246dbd39be7ff162392c59c28dee74a1419e236#diff-0544248063499d8688c21f49be0918c8R285&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/srowen/spark/commit/8246dbd39be7ff162392c59c28dee74a1419e236#diff-0544248063499d8688c21f49be0918c8R285&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This isn&apos;t a problem per se but could be slower. I am not sure if this code can be changed to not require constant reinitialization of the distribution.&lt;/p&gt;</comment>
                            <comment id="14181777" author="josephkb" created="Thu, 23 Oct 2014 19:00:17 +0000"  >&lt;p&gt;Hi Sean, Thanks for picking this up!  W.r.t. the RandomForestSuite failure, I agree that the test is likely flaky since it relies on choosing random subsets of the features.  That test actually does not really need to call validateClassifier; the test was to check for a bug in training which caused an exception previously.  It should be fine to change (in that test in RandomForestSuite.scala):&lt;br/&gt;
from &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;RandomForestSuite.validateClassifier(model, arr, 1.0)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;RandomForestSuite.validateClassifier(model, arr, 0.0)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14181886" author="mengxr" created="Thu, 23 Oct 2014 20:20:43 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;ChiSqTest:&lt;/p&gt;

&lt;p&gt;This is an independence test. Since a constant distribution is independent of any distribution by definition, I think we should return pValue = 1.0 and statistic = 0.0 in that case.&lt;/p&gt;

&lt;p&gt;KMeansClusterSuite:&lt;/p&gt;

&lt;p&gt;It passed on my local machine. This test requires the assembly jar. Did you rebuild? Btw, breeze also depends on commons-math3. Even we plan to shade the jar, we should try to use the same version.&lt;/p&gt;

&lt;p&gt;Poisson sampler:&lt;/p&gt;

&lt;p&gt;The workaround won&apos;t generate good Poisson sequence because we change seed too frequently. We need two different mean values in stratified sampling. Refactoring the code is independent of this JIRA. So I would recommend the following:&lt;/p&gt;

&lt;p&gt;1) maintain a map of mean -&amp;gt; PoissonDistribution in RandomDataGenerator&lt;br/&gt;
2) if the request mean is in the map, use the RNG there, otherwise, insert a new RNG into the map (and check the size of the map)&lt;/p&gt;</comment>
                            <comment id="14182781" author="srowen" created="Fri, 24 Oct 2014 13:48:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mengxr&quot; class=&quot;user-hover&quot; rel=&quot;mengxr&quot;&gt;mengxr&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=josephkb&quot; class=&quot;user-hover&quot; rel=&quot;josephkb&quot;&gt;josephkb&lt;/a&gt; Great, most of this is resolved now. &lt;/p&gt;

&lt;p&gt;&lt;tt&gt;KMeansSuite&lt;/tt&gt; still fails for me, yes, after a clean build. I wonder if the problem is that the commons-math3 code is in a different package in the assembly? Before thinking too hard about it, let me open a PR to see what Jenkins makes of it.&lt;/p&gt;

&lt;p&gt;I also implemented the different approach to Poisson sampler seeding. It would be good to cap the size of the cache, although, I wonder if that could lead to problems. If a sampler is removed and recreated, it will start generating the same sequence again from the same seed. If it is not seeded, it will be nondeterministic. It looks like &lt;tt&gt;RandomDataGenerator&lt;/tt&gt; instances are short-lived and applied to a fixed set of mean values, which suggests this won&apos;t blow up readily. I admit I just glanced at the usages though.&lt;/p&gt;</comment>
                            <comment id="14182785" author="apachespark" created="Fri, 24 Oct 2014 13:50:10 +0000"  >&lt;p&gt;User &apos;srowen&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/2928&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/2928&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14185504" author="mengxr" created="Mon, 27 Oct 2014 17:53:35 +0000"  >&lt;p&gt;Issue resolved by pull request 2928&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/2928&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/2928&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12751232">SPARK-4121</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 4 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i21dtj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327369">1.2.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>