<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:22:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-4963] SchemaRDD.sample may return wrong results</title>
                <link>https://issues.apache.org/jira/browse/SPARK-4963</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;This &lt;tt&gt;sbt/sbt hive/console&lt;/tt&gt; session can easily reproduce this issue:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM src WHERE key % 2 = 0&quot;&lt;/span&gt;).
  sample(withReplacement = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, fraction = 0.05).
  registerTempTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;sampled&quot;&lt;/span&gt;)

println(table(&lt;span class=&quot;code-quote&quot;&gt;&quot;sampled&quot;&lt;/span&gt;).queryExecution)

val query = sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM sampled WHERE key % 2 = 1&quot;&lt;/span&gt;)
println(query.queryExecution)

&lt;span class=&quot;code-comment&quot;&gt;// Should print `&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&apos;
&lt;/span&gt;println((1 to 10).map(_ =&amp;gt; query.collect().isEmpty).reduce(_ &amp;amp;&amp;amp; _))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Notice that when fraction is less than 0.4, &lt;tt&gt;GapSamplingIterator&lt;/tt&gt; is used to do the sampling. My guess is that there&#8217;s something to do with the underlying mutable row objects used in &lt;tt&gt;HiveTableScan&lt;/tt&gt;, but haven&apos;t figured out the root cause.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12763739">SPARK-4963</key>
            <summary>SchemaRDD.sample may return wrong results</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yanboliang">Yanbo Liang</assignee>
                                    <reporter username="lian cheng">Cheng Lian</reporter>
                        <labels>
                    </labels>
                <created>Thu, 25 Dec 2014 07:19:01 +0000</created>
                <updated>Sat, 10 Jan 2015 22:20:20 +0000</updated>
                            <resolved>Sat, 10 Jan 2015 22:20:20 +0000</resolved>
                                    <version>1.2.0</version>
                                    <fixVersion>1.3.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14259098" author="yanboliang" created="Fri, 26 Dec 2014 14:59:19 +0000"  >&lt;p&gt;I also hit this bug.&lt;br/&gt;
In my experiment, last row of each partitions will be collect whether it pass predictive in Filter or not.&lt;br/&gt;
Further clue is different iterator behavior of  GenericRow &amp;amp; SpecificMutableRow.&lt;br/&gt;
I&apos;m working on this issue,  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lian+cheng&quot; class=&quot;user-hover&quot; rel=&quot;lian cheng&quot;&gt;lian cheng&lt;/a&gt; could you assign to me and I will try to submit fix. &lt;/p&gt;</comment>
                            <comment id="14259313" author="lian cheng" created="Sat, 27 Dec 2014 08:25:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yanboliang&quot; class=&quot;user-hover&quot; rel=&quot;yanboliang&quot;&gt;yanboliang&lt;/a&gt; Unfortunately I don&apos;t have the privilege to assign JIRA ticket &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; You can just start woking on it. And the fact that the last row of every partition will be collect clearly indicates mutable row is the root cause.&lt;/p&gt;</comment>
                            <comment id="14259977" author="apachespark" created="Mon, 29 Dec 2014 09:45:52 +0000"  >&lt;p&gt;User &apos;yanbohappy&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/3827&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/3827&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14259986" author="yanboliang" created="Mon, 29 Dec 2014 09:58:20 +0000"  >&lt;p&gt;SchemaRDD.sample() return wrong results due to GapSamplingIterator operating on mutable row.&lt;br/&gt;
HiveTableScan make RDD with SpecificMutableRow and SchemaRDD.sample() will return GapSamplingIterator for iterating.&lt;/p&gt;

&lt;p&gt;override def next(): T = {&lt;br/&gt;
val r = data.next()&lt;br/&gt;
advance&lt;br/&gt;
r&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;GapSamplingIterator.next() return the current underlying element and assigned it to r.&lt;br/&gt;
However if the underlying iterator is mutable row just like what HiveTableScan returned, underlying iterator and r will point to the same object.&lt;br/&gt;
After advance operation, we drop some underlying elments and it also changed r which is not expected. Then we return the wrong value different from initial r.&lt;/p&gt;

&lt;p&gt;To fix this issue, the most direct way is to make HiveTableScan return mutable row with copy just like the initial commit that I have made. This solution will make HiveTableScan can not get the full advantage of reusable MutableRow, but it can make sample operation return correct result.&lt;br/&gt;
Further more, we need to investigate GapSamplingIterator.next() and make it can implement copy operation inside it. To achieve this, we should define every elements that RDD can store implement the function like cloneable and it will make huge change.&lt;/p&gt;</comment>
                            <comment id="14260355" author="mengxr" created="Mon, 29 Dec 2014 19:38:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yanboliang&quot; class=&quot;user-hover&quot; rel=&quot;yanboliang&quot;&gt;yanboliang&lt;/a&gt; Thanks for looking into this issue! I&apos;ve assigned the JIRA to you.&lt;/p&gt;

&lt;p&gt;1. What&apos;s the overhead of making HiveTableScan return mutable row with copy?&lt;br/&gt;
2. Is this issue also applies to other operations rather than sample? For example,  a user may operate directly on a SchemaRDD.&lt;/p&gt;</comment>
                            <comment id="14260766" author="lian cheng" created="Tue, 30 Dec 2014 04:30:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yanboliang&quot; class=&quot;user-hover&quot; rel=&quot;yanboliang&quot;&gt;yanboliang&lt;/a&gt; Making &lt;tt&gt;HiveTableScan&lt;/tt&gt; return copied mutable does fix this issue, but I&apos;m afraid there can be noticeable performance regression. Would you mind to do a simple benchmark using code in &lt;a href=&quot;https://github.com/apache/spark/pull/758&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;#758&lt;/a&gt;?&lt;/p&gt;

&lt;p&gt;I&apos;m thinking maybe we can introduce a new &lt;tt&gt;Copy&lt;/tt&gt; physical operator which inserts &lt;tt&gt;_.copy&lt;/tt&gt; whenever an operator that may cache mutable row(s) as intermediate result (like &lt;tt&gt;Sample&lt;/tt&gt; and &lt;tt&gt;Sort&lt;/tt&gt;) is found. I&apos;d expect this operator to simplify and unify all ad-hoc mutable row copying code. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marmbrus&quot; class=&quot;user-hover&quot; rel=&quot;marmbrus&quot;&gt;marmbrus&lt;/a&gt; What do you think?&lt;/p&gt;</comment>
                            <comment id="14260782" author="marmbrus" created="Tue, 30 Dec 2014 04:37:24 +0000"  >&lt;p&gt;We could create a new operator, but the problem here is that we sometimes use operator specific logic to decide when to copy.  For example, we do this in exchange to avoid copies when the shuffle is going to be hash-based.  For that reason I think it might be okay to just do .map(_.copy()) before calling spark&apos;s sample method.&lt;/p&gt;</comment>
                            <comment id="14260790" author="lian cheng" created="Tue, 30 Dec 2014 04:48:35 +0000"  >&lt;p&gt;OK I agree. However the &lt;tt&gt;&amp;#95;.copy()&lt;/tt&gt; call should be added in the SQL &lt;tt&gt;Sample&lt;/tt&gt; operator rather than Spark&apos;s &lt;tt&gt;RDD.sample&lt;/tt&gt; method, since the element type of an arbitrary RDD doesn&apos;t necessarily to be a &lt;tt&gt;Product&lt;/tt&gt; and &lt;tt&gt;&amp;#95;.copy()&lt;/tt&gt; is not available.&lt;/p&gt;</comment>
                            <comment id="14260791" author="marmbrus" created="Tue, 30 Dec 2014 04:50:08 +0000"  >&lt;p&gt;Yeah, agree.  Lets add it to SQL&apos;s Sample operator.&lt;/p&gt;</comment>
                            <comment id="14260914" author="yanboliang" created="Tue, 30 Dec 2014 08:26:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mengxr&quot; class=&quot;user-hover&quot; rel=&quot;mengxr&quot;&gt;mengxr&lt;/a&gt; &lt;br/&gt;
1. Just like Cheng &amp;amp; Michael&apos;s suggestion, add Copy operation at SQL&apos;s Sample operator is more reasonable. &lt;br/&gt;
I had made a new commit to update at this PR and it have no effect on HiveTableScan.&lt;br/&gt;
2. This issue may not take effect on other SQL operators because of they are all iterating continuously without skipping or dropping.&lt;br/&gt;
But if the user want to skip or drop some elements when iterate over the SchemaRDD, it may produce wrong result. &lt;br/&gt;
So users should pay more attention(eg. execute copy ahead) when using SchemaRDD if its underlying is based on mutable row.&lt;/p&gt;

&lt;p&gt;As far as I know, ParquetFile/ParquetRelation is also hit this issue due to it also read data and deserialize to SpecificMutableRow.&lt;br/&gt;
However the new commit I have submit can also resolve it.&lt;/p&gt;</comment>
                            <comment id="14260917" author="yanboliang" created="Tue, 30 Dec 2014 08:34:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=liancheng&quot; class=&quot;user-hover&quot; rel=&quot;liancheng&quot;&gt;liancheng&lt;/a&gt; &amp;amp; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marmbrus&quot; class=&quot;user-hover&quot; rel=&quot;marmbrus&quot;&gt;marmbrus&lt;/a&gt;&lt;br/&gt;
Thank you for your suggestion.&lt;br/&gt;
I also agree to add copy to SQL&apos;s Sample operator and had submit the new patch.&lt;br/&gt;
Meantime I also found that ParquetFile/ParquetRelation is also hit this issue due to it also read data and deserialize to SpecificMutableRow. The new patch resolve it also. &lt;/p&gt;</comment>
                            <comment id="14261331" author="marmbrus" created="Tue, 30 Dec 2014 18:33:37 +0000"  >&lt;p&gt;Mutability is an internal optimization and we always copy at boundaries where we expose data to the user.  We should not remove it from parquet or hive table scan because it greatly improves performance.&lt;/p&gt;</comment>
                            <comment id="14269136" author="yanboliang" created="Thu, 8 Jan 2015 10:18:38 +0000"  >&lt;p&gt;Can anyone verify and merge this patch? It&apos;s a bug appeared frequently and fix it asap will be better.&lt;/p&gt;</comment>
                            <comment id="14269322" author="lian cheng" created="Thu, 8 Jan 2015 13:58:23 +0000"  >&lt;p&gt;Commented the PR, thanks for working on this!&lt;/p&gt;</comment>
                            <comment id="14272709" author="marmbrus" created="Sat, 10 Jan 2015 22:20:20 +0000"  >&lt;p&gt;Issue resolved by pull request 3827&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/3827&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/3827&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 45 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i23rsf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12329029">1.2.1</customfieldvalue>
    <customfieldvalue id="12327642">1.3.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>