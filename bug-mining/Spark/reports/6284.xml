<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:03:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-26751] HiveSessionImpl might have memory leak since Operation do not close properly</title>
                <link>https://issues.apache.org/jira/browse/SPARK-26751</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When we run in background and we get exception which is not HiveSQLException,&lt;br/&gt;
we may encounter memory leak since handleToOperation will not removed correctly.&lt;br/&gt;
The reason is below:&lt;br/&gt;
1. when calling operation.run we throw an exception which is not HiveSQLException&lt;br/&gt;
2. then opHandleSet will not add the opHandle, and operationManager.closeOperation(opHandle); will not be called&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; OperationHandle executeStatementInternal(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; statement, Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; confOverlay, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; runAsync) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; HiveSQLException {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.acquire(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
        OperationManager operationManager = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getOperationManager();
        ExecuteStatementOperation operation = operationManager.newExecuteStatementOperation(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getSession(), statement, confOverlay, runAsync);
        OperationHandle opHandle = operation.getHandle();

        OperationHandle e;
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            operation.run();
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.opHandleSet.add(opHandle);
            e = opHandle;
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (HiveSQLException var11) {
            operationManager.closeOperation(opHandle);
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; var11;
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.release(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
        }

        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; e;
    }


      &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        &lt;span class=&quot;code-comment&quot;&gt;// This submit blocks &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; no background threads are available to run &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; operation
&lt;/span&gt;        val backgroundHandle =
          parentSession.getSessionManager().submitBackgroundOperation(backgroundOperation)
        setBackgroundHandle(backgroundHandle)
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; rejected: RejectedExecutionException =&amp;gt;
          setState(OperationState.ERROR)
          &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HiveSQLException(&lt;span class=&quot;code-quote&quot;&gt;&quot;The background threadpool cannot accept&quot;&lt;/span&gt; +
            &lt;span class=&quot;code-quote&quot;&gt;&quot; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; task &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; execution, please retry the operation&quot;&lt;/span&gt;, rejected)
        &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; NonFatal(e) =&amp;gt;
          logError(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Error executing query in background&quot;&lt;/span&gt;, e)
          setState(OperationState.ERROR)
          &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;3. when we close the session we will also call operationManager.closeOperation(opHandle),since we did not add this opHandle into the opHandleSet.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; HiveSQLException {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.acquire(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
            Iterator ioe = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.opHandleSet.iterator();

            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;(ioe.hasNext()) {
                OperationHandle opHandle = (OperationHandle)ioe.next();
                &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.operationManager.closeOperation(opHandle);
            }

            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.opHandleSet.clear();
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.cleanupSessionLogDir();
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.cleanupPipeoutFile();
            HiveHistory ioe1 = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sessionState.getHiveHistory();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; != ioe1) {
                ioe1.closeStream();
            }

            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sessionState.close();
            } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
                &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sessionState = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
            }
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException var17) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HiveSQLException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failure to close&quot;&lt;/span&gt;, var17);
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sessionState != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sessionState.close();
                } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable var15) {
                    LOG.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error closing session&quot;&lt;/span&gt;, var15);
                }

                &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sessionState = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
            }

            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.release(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
        }

    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;4. however, the opHandle will added into handleToOperation for each statement&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val handleToOperation = ReflectionUtils
    .getSuperField[JMap[OperationHandle, Operation]](&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;handleToOperation&quot;&lt;/span&gt;)

  val sessionToActivePool = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConcurrentHashMap[SessionHandle, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;]()
  val sessionToContexts = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConcurrentHashMap[SessionHandle, SQLContext]()

  override def newExecuteStatementOperation(
      parentSession: HiveSession,
      statement: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;,
      confOverlay: JMap[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;],
      async: &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;): ExecuteStatementOperation = &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; {
    val sqlContext = sessionToContexts.get(parentSession.getSessionHandle)
    require(sqlContext != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, s&lt;span class=&quot;code-quote&quot;&gt;&quot;Session handle: ${parentSession.getSessionHandle} has not been&quot;&lt;/span&gt; +
      s&lt;span class=&quot;code-quote&quot;&gt;&quot; initialized or had already closed.&quot;&lt;/span&gt;)
    val conf = sqlContext.sessionState.conf
    val hiveSessionState = parentSession.getSessionState
    setConfMap(conf, hiveSessionState.getOverriddenConfigurations)
    setConfMap(conf, hiveSessionState.getHiveVariables)
    val runInBackground = async &amp;amp;&amp;amp; conf.getConf(HiveUtils.HIVE_THRIFT_SERVER_ASYNC)
    val operation = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SparkExecuteStatementOperation(parentSession, statement, confOverlay,
      runInBackground)(sqlContext, sessionToActivePool)
    handleToOperation.put(operation.getHandle, operation)
    logDebug(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Created Operation &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; $statement with session=$parentSession, &quot;&lt;/span&gt; +
      s&lt;span class=&quot;code-quote&quot;&gt;&quot;runInBackground=$runInBackground&quot;&lt;/span&gt;)
    operation
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Below is an example which has memory leak:&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12956569/12956569_26751.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;</description>
                <environment></environment>
        <key id="13212214">SPARK-26751</key>
            <summary>HiveSessionImpl might have memory leak since Operation do not close properly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cane">zhoukang</assignee>
                                    <reporter username="cane">zhoukang</reporter>
                        <labels>
                    </labels>
                <created>Mon, 28 Jan 2019 11:31:31 +0000</created>
                <updated>Fri, 1 Mar 2019 21:47:27 +0000</updated>
                            <resolved>Sun, 3 Feb 2019 14:47:23 +0000</resolved>
                                    <version>2.4.0</version>
                                    <fixVersion>2.3.3</fixVersion>
                    <fixVersion>2.4.1</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16759433" author="srowen" created="Sun, 3 Feb 2019 14:47:23 +0000"  >&lt;p&gt;Issue resolved by pull request 23673&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/23673&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23673&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13211240">SPARK-26701</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12956569" name="26751.png" size="128575" author="cane" created="Mon, 28 Jan 2019 11:35:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 41 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|yi0dq0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>