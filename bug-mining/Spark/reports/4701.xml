<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:52:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-20059] HbaseCredentialProvider uses wrong classloader</title>
                <link>https://issues.apache.org/jira/browse/SPARK-20059</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;&lt;tt&gt;HBaseCredentialProvider&lt;/tt&gt; uses system classloader instead of child classloader, which will make HBase jars specified with &lt;tt&gt;--jars&lt;/tt&gt; fail to work, so here we should use the right class loader.&lt;/p&gt;

&lt;p&gt;Besides in yarn cluster mode jars specified with &lt;tt&gt;--jars&lt;/tt&gt; is not added into client&apos;s class path, which will make it fail to load HBase jars and issue tokens in our scenario. Also some customized credential provider cannot be registered into client.&lt;/p&gt;

&lt;p&gt;So here I will fix this two issues.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="13058211">SPARK-20059</key>
            <summary>HbaseCredentialProvider uses wrong classloader</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jerryshao">Saisai Shao</assignee>
                                    <reporter username="jerryshao">Saisai Shao</reporter>
                        <labels>
                    </labels>
                <created>Wed, 22 Mar 2017 13:00:42 +0000</created>
                <updated>Sun, 17 May 2020 18:15:04 +0000</updated>
                            <resolved>Wed, 29 Mar 2017 17:10:56 +0000</resolved>
                                    <version>2.1.0</version>
                    <version>2.2.0</version>
                                    <fixVersion>2.1.1</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                                    <component>Spark Core</component>
                    <component>YARN</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15936329" author="apachespark" created="Wed, 22 Mar 2017 13:39:04 +0000"  >&lt;p&gt;User &apos;jerryshao&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/17388&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/17388&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15942960" author="srowen" created="Mon, 27 Mar 2017 09:49:00 +0000"  >&lt;p&gt;Is this actually the same issue as &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-20019&quot; title=&quot;spark can not load alluxio fileSystem after adding jar&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-20019&quot;&gt;&lt;del&gt;SPARK-20019&lt;/del&gt;&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-11421&quot; title=&quot;Add the ability to add a jar to the current class loader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-11421&quot;&gt;&lt;del&gt;SPARK-11421&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="15942976" author="jerryshao" created="Mon, 27 Mar 2017 10:00:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sowen&quot; class=&quot;user-hover&quot; rel=&quot;sowen&quot;&gt;sowen&lt;/a&gt;, it probably is not the same issue.&lt;/p&gt;

&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-20019&quot; title=&quot;spark can not load alluxio fileSystem after adding jar&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-20019&quot;&gt;&lt;del&gt;SPARK-20019&lt;/del&gt;&lt;/a&gt;, jars are added through SQL command in to Hive&apos;s SessionState, the code path is different.&lt;/p&gt;

&lt;p&gt;And in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-11421&quot; title=&quot;Add the ability to add a jar to the current class loader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-11421&quot;&gt;&lt;del&gt;SPARK-11421&lt;/del&gt;&lt;/a&gt;, AFAIK,  the target is to add jars to the current classloader in the runtime.&lt;/p&gt;

&lt;p&gt;Here the issue is during start, jars specified through &lt;tt&gt;--jars&lt;/tt&gt; should be added to Spark&apos;s child classloader in yarn cluster mode. &lt;/p&gt;

&lt;p&gt;They&apos;re probably all classloader related issues, but I think they&apos;re targeted to the different area, and touched the different code path.&lt;/p&gt;</comment>
                            <comment id="16672622" author="praneetsharma" created="Fri, 2 Nov 2018 06:33:33 +0000"  >&lt;p&gt;Hi Guys&lt;/p&gt;

&lt;p&gt;Regarding the fix done here for yarn-cluster mode, why are we adding primaryResource? Isn&apos;t adding args.jars to childClasspath enough?&lt;/p&gt;

&lt;p&gt;I ask this because we have a scenario where-in the cleanup of primaryResource fails till the application has completed. Here are the details:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;We have a primaryResource jar present in an &lt;b&gt;NFS&lt;/b&gt; mounted location. Our scenario is that we perform the cleanup after the spark job starts on the cluster.&lt;/li&gt;
	&lt;li&gt;Till spark-2.1.0, this clean has worked fine for us because since we are in yarn-cluster mode, this primaryResource is no longer needed on the client once it has been uploaded to the cluster.&lt;/li&gt;
	&lt;li&gt;But with spark-2.2.1 (which contains this fix), when we attempt to clean up the primaryResource, it produces a .nfsxxx file which essentially means that spark-submit process is holding onto an open handle on this primaryResource for the entirety of application lifecycle.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;What we found out was that since we are now adding primaryResource to the thread-context-classloader within SparkSubmit.scala even for yarn-cluster mode, the cleanup doesn&apos;t seem to happen on NFS. This is a regression for us. And it becomes more problematic for us in case of long running streaming jobs, because now we can&apos;t cleanup the primaryResource till the application completes, which is unacceptable to us.&lt;/p&gt;

&lt;p&gt;This is how the issue can be reproduced:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Have spark-examples jar present in an NFS mounted location.&lt;/li&gt;
	&lt;li&gt;While performing spark-submit in yarn-cluster mode, provide spark-examples jar as the primary resource.&#160;&lt;/li&gt;
	&lt;li&gt;When the job gets submitted onto the cluster, try deleting the jar in the NFS location.
	&lt;ul&gt;
		&lt;li&gt;While the jar gets deleted, but it produces an .nfsxx file which locks the deletion of the directory itself until the application fully completes and spark-submit ends&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
export HADOOP_CONF_DIR=./conf
./bin/spark-submit --&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.spark.examples.SparkPi --master yarn --deploy-mode cluster --executor-memory 1G --num-executors 1 /mountloc/spark-test/spark-examples_2.11-2.3.1.jar 1000
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When the above command submits an application onto the cluster, we attempt to delete&#160;/mountloc/spark-test/ location (which houses the primaryResource), but it doesn&apos;t succeed since NFS locks this directory by producing .nfsxxx file.&lt;/p&gt;

&lt;p&gt;Please provide your thoughts on the same. Please let me know if any further information needs to be provided from my side.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 2 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3cmsv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>