<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:58:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-23157] withColumn fails for a column that is a result of mapped DataSet</title>
                <link>https://issues.apache.org/jira/browse/SPARK-23157</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Having &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;R(id: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;)
val ds = spark.createDataset(Seq(R(&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;)))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This works:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
scala&amp;gt; ds.withColumn(&lt;span class=&quot;code-quote&quot;&gt;&quot;n&quot;&lt;/span&gt;, ds.col(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;))
res16: org.apache.spark.sql.DataFrame = [id: string, n: string]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but when we map over ds it fails:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
scala&amp;gt; ds.withColumn(&lt;span class=&quot;code-quote&quot;&gt;&quot;n&quot;&lt;/span&gt;, ds.map(a =&amp;gt; a).col(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;))
org.apache.spark.sql.AnalysisException: resolved attribute(s) id#55 missing from id#4 in &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; !Project [id#4, id#55 AS n#57];;
!Project [id#4, id#55 AS n#57]
+- LocalRelation [id#4]

  at org.apache.spark.sql.catalyst.analysis.CheckAnalysis$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;failAnalysis(CheckAnalysis.scala:39)
  at org.apache.spark.sql.catalyst.analysis.Analyzer.failAnalysis(Analyzer.scala:91)
  at org.apache.spark.sql.catalyst.analysis.CheckAnalysis$$anonfun$checkAnalysis$1.apply(CheckAnalysis.scala:347)
  at org.apache.spark.sql.catalyst.analysis.CheckAnalysis$$anonfun$checkAnalysis$1.apply(CheckAnalysis.scala:78)
  at org.apache.spark.sql.catalyst.trees.TreeNode.foreachUp(TreeNode.scala:127)
  at org.apache.spark.sql.catalyst.analysis.CheckAnalysis$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;checkAnalysis(CheckAnalysis.scala:78)
  at org.apache.spark.sql.catalyst.analysis.Analyzer.checkAnalysis(Analyzer.scala:91)
  at org.apache.spark.sql.execution.QueryExecution.assertAnalyzed(QueryExecution.scala:52)
  at org.apache.spark.sql.Dataset$.ofRows(Dataset.scala:67)
  at org.apache.spark.sql.Dataset.org$apache$spark$sql$Dataset$$withPlan(Dataset.scala:2884)
  at org.apache.spark.sql.Dataset.select(Dataset.scala:1150)
  at org.apache.spark.sql.Dataset.withColumn(Dataset.scala:1905)
  ... 48 elided
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13132223">SPARK-23157</key>
            <summary>withColumn fails for a column that is a result of mapped DataSet</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="henryr">Henry Robinson</assignee>
                                    <reporter username="kretes">Tomasz Bartczak</reporter>
                        <labels>
                    </labels>
                <created>Fri, 19 Jan 2018 16:24:13 +0000</created>
                <updated>Mon, 12 Dec 2022 18:11:04 +0000</updated>
                            <resolved>Thu, 1 Feb 2018 02:16:23 +0000</resolved>
                                    <version>2.2.1</version>
                                    <fixVersion>2.3.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16340412" author="henryr" created="Fri, 26 Jan 2018 01:31:42 +0000"  >&lt;p&gt;I&apos;m not sure&#160;if&#160;this should actually be expected to work.&#160;&lt;tt&gt;Dataset.map()&lt;/tt&gt; will always&#160;return a dataset with a logical plan that&apos;s different to the original, so &lt;tt&gt;ds.map(a =&amp;gt; a).col(&quot;id&quot;)&lt;/tt&gt; has an expression that refers to an attribute ID that isn&apos;t produced by the original dataset. It seems like the requirement for &lt;tt&gt;ds.withColumn()&lt;/tt&gt; is that the column argument is an expression over &lt;tt&gt;ds&lt;/tt&gt;&apos;s logical plan.&lt;/p&gt;

&lt;p&gt;You get the same error doing the following, which is more explicit about these being two separate datasets.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
scala&amp;gt; val ds = spark.createDataset(Seq(R(&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;)))
ds: org.apache.spark.sql.Dataset[R] = [id: string]

scala&amp;gt; val ds2 = spark.createDataset(Seq(R(&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;)))
ds2: org.apache.spark.sql.Dataset[R] = [id: string]

scala&amp;gt; ds.withColumn(&lt;span class=&quot;code-quote&quot;&gt;&quot;id2&quot;&lt;/span&gt;, ds2.col(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;))
org.apache.spark.sql.AnalysisException: Resolved attribute(s) id#113 missing from id#1 in &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; !Project [id#1, id#113 AS id2#115]. Attribute(s) with the same name appear in the operation: id. Please check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the right attribute(s) are used.;;
!Project [id#1, id#113 AS id2#115]
+- LocalRelation [id#1]

  at org.apache.spark.sql.catalyst.analysis.CheckAnalysis$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;failAnalysis(CheckAnalysis.scala:41)
  at org.apache.spark.sql.catalyst.analysis.Analyzer.failAnalysis(Analyzer.scala:91)
  at org.apache.spark.sql.catalyst.analysis.CheckAnalysis$$anonfun$checkAnalysis$1.apply(CheckAnalysis.scala:297)
  at org.apache.spark.sql.catalyst.analysis.CheckAnalysis$$anonfun$checkAnalysis$1.apply(CheckAnalysis.scala:80)
  at org.apache.spark.sql.catalyst.trees.TreeNode.foreachUp(TreeNode.scala:127)
  at org.apache.spark.sql.catalyst.analysis.CheckAnalysis$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;checkAnalysis(CheckAnalysis.scala:80)
  at org.apache.spark.sql.catalyst.analysis.Analyzer.checkAnalysis(Analyzer.scala:91)
  at org.apache.spark.sql.execution.QueryExecution.assertAnalyzed(QueryExecution.scala:52)
  at org.apache.spark.sql.Dataset$.ofRows(Dataset.scala:70)
  at org.apache.spark.sql.Dataset.org$apache$spark$sql$Dataset$$withPlan(Dataset.scala:3286)
  at org.apache.spark.sql.Dataset.select(Dataset.scala:1303)
  at org.apache.spark.sql.Dataset.withColumns(Dataset.scala:2185)
  at org.apache.spark.sql.Dataset.withColumn(Dataset.scala:2152)
  ... 49 elided
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If the &lt;tt&gt;map&lt;/tt&gt; function weren&apos;t the identity, would you expect this still to work?&lt;/p&gt;</comment>
                            <comment id="16343168" author="kretes" created="Mon, 29 Jan 2018 10:15:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=henryr&quot; class=&quot;user-hover&quot; rel=&quot;henryr&quot;&gt;henryr&lt;/a&gt; I see what you mean in your example.&lt;/p&gt;

&lt;p&gt;However I would expect my example to work both with an identity and with any arbitrary function. My expectations for this API come from e.g. pandas where I can operate on columns and if I have the same number of elements in column - I can use it to in multiple Datasets.&lt;/p&gt;

&lt;p&gt;And since in my example root Dataset is the same and there is no shuffling/filtering or any other operation that may change the order or number of rows - adding column that is an effect of some operation on same root Dataset should be possible.&lt;/p&gt;</comment>
                            <comment id="16343279" author="srowen" created="Mon, 29 Jan 2018 12:04:46 +0000"  >&lt;p&gt;Agree this should not work . You are selecting a column from a different Dataset. Happening to work because a number of cols matches or the function is the identity sounds like as much way to write bugs as convenience&lt;/p&gt;</comment>
                            <comment id="16343962" author="henryr" created="Mon, 29 Jan 2018 20:24:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kretes&quot; class=&quot;user-hover&quot; rel=&quot;kretes&quot;&gt;kretes&lt;/a&gt; - I can see an argument for the behaviour you&apos;re describing, but that&apos;s not the way the API is apparently intended. Like Sean says, there are way too many ways to shoot yourself in the foot if you can stitch together arbitrary datasets like this if the Datasets are column-wise incompatible, and&#160;allowing the&#160;relatively small subset of cases where it would work would lead to a more confusing API, IMO.&#160;&lt;/p&gt;

&lt;p&gt;The documentation for &lt;tt&gt;withColumn()&lt;/tt&gt; could be updated to make this clearer; if I get a moment today I&apos;ll submit a PR.&#160;&lt;/p&gt;</comment>
                            <comment id="16344078" author="apachespark" created="Mon, 29 Jan 2018 21:57:04 +0000"  >&lt;p&gt;User &apos;henryr&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/20429&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/20429&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16345949" author="apachespark" created="Tue, 30 Jan 2018 22:52:05 +0000"  >&lt;p&gt;User &apos;henryr&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/20443&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/20443&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16347908" author="gurwls223" created="Thu, 1 Feb 2018 02:16:23 +0000"  >&lt;p&gt;Issue resolved by pull request 20443&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/20443&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/20443&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 41 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3p4ev:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>