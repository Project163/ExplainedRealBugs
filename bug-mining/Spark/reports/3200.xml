<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 02:12:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92">
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-13779] YarnAllocator cancels and resubmits container requests with no locality preference</title>
                <link>https://issues.apache.org/jira/browse/SPARK-13779</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;&lt;a href="https://issues.apache.org/jira/browse/SPARK-9817" title="Improve the container placement strategy by considering the localities of pending container requests" class="issue-link" data-issue-key="SPARK-9817"&gt;&lt;del&gt;SPARK-9817&lt;/del&gt;&lt;/a&gt; attempts to improve locality by considering the set of pending container requests. Pending requests with a locality preference that is no longer needed or no locality preference are cancelled, then resubmitted with updated locality preferences.&lt;/p&gt;

&lt;p&gt;When running over data in S3, some stages have no locality information so the result is that the current logic cancels all pending requests and resubmits them (still without locality preferences) on every call to &lt;a href="https://github.com/apache/spark/blob/master/yarn/src/main/scala/org/apache/spark/deploy/yarn/YarnAllocator.scala#L273" class="external-link" target="_blank" rel="nofollow noopener"&gt;&lt;tt&gt;updateResourceRequests()&lt;/tt&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I propose the following update to avoid this problem:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Cancel any pending requests with stale locality preferences&lt;/li&gt;
	&lt;li&gt;Calculate N new requests, where N is the number of new containers + cancelled stale requests + outstanding requests without locality&lt;/li&gt;
	&lt;li&gt;If the number of new requests with a locality preference was larger than the available count (new containers + cancelled stale requests), then cancel enough requests with no locality preference to be able to submit all of the requests with a locality preference.&lt;/li&gt;
	&lt;li&gt;If the number of new requests with a locality preference is smaller than the available count then submit all of the locality requests and a request with no locality preference for the remaining available count. No pending requests with no locality are cancelled.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;This strategy only cancels requests with no locality preference if a new request can be made that has a locality preference. Cancelling stale locality requests happens as it does today. I've tested this on large S3 jobs (50,000+ tasks) and it fixes the request thrashing problem.&lt;/p&gt;</description>
                <environment/>
        <key id="12948508">SPARK-13779</key>
            <summary>YarnAllocator cancels and resubmits container requests with no locality preference</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rdblue">Ryan Blue</assignee>
                                    <reporter username="rdblue">Ryan Blue</reporter>
                        <labels>
                    </labels>
                <created>Wed, 9 Mar 2016 19:42:27 +0000</created>
                <updated>Sun, 17 May 2020 18:17:04 +0000</updated>
                            <resolved>Mon, 14 Mar 2016 18:20:34 +0000</resolved>
                                    <version>1.6.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>Spark Core</component>
                    <component>YARN</component>
                        <due/>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15187950" author="apachespark" created="Wed, 9 Mar 2016 21:03:04 +0000">&lt;p&gt;User 'rdblue' has created a pull request for this issue:&lt;br/&gt;
&lt;a href="https://github.com/apache/spark/pull/11612" class="external-link" target="_blank" rel="nofollow noopener"&gt;https://github.com/apache/spark/pull/11612&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 36 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2uf47:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>