<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:22:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-5052] com.google.common.base.Optional binary has a wrong method signatures</title>
                <link>https://issues.apache.org/jira/browse/SPARK-5052</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;PR &lt;a href=&quot;https://github.com/apache/spark/pull/1813&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/1813&lt;/a&gt; shaded Guava jar file and moved Guava classes to package org.spark-project.guava when Spark is built by Maven.&lt;/p&gt;

&lt;p&gt;When a user jar uses the actual com.google.common.base.Optional transform(com.google.common.base.Function); method from Guava,  a java.lang.NoSuchMethodError: com.google.common.base.Optional.transform(Lcom/google/common/base/Function;)Lcom/google/common/base/Optional; is thrown.&lt;/p&gt;

&lt;p&gt;The reason seems to be that the Optional class included on spark-assembly-1.2.0-hadoop1.0.4.jar has an incorrect method signature that includes the shaded class as an argument:&lt;/p&gt;

&lt;p&gt;Expected:&lt;br/&gt;
javap -classpath target/scala-2.10/googlegenomics-spark-examples-assembly-1.0.jar com.google.common.base.Optional&lt;br/&gt;
  public abstract &amp;lt;V extends java/lang/Object&amp;gt; com.google.common.base.Optional&amp;lt;V&amp;gt; transform(com.google.common.base.Function&amp;lt;? super T, V&amp;gt;);&lt;/p&gt;

&lt;p&gt;Found:&lt;br/&gt;
javap -classpath lib/spark-assembly-1.2.0-hadoop1.0.4.jar com.google.common.base.Optional&lt;br/&gt;
  public abstract &amp;lt;V extends java/lang/Object&amp;gt; com.google.common.base.Optional&amp;lt;V&amp;gt; transform(org.spark-project.guava.common.base.Function&amp;lt;? super T, V&amp;gt;);&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12764455">SPARK-5052</key>
            <summary>com.google.common.base.Optional binary has a wrong method signatures</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="elmer.garduno">Elmer Garduno</assignee>
                                    <reporter username="elmer.garduno">Elmer Garduno</reporter>
                        <labels>
                    </labels>
                <created>Thu, 1 Jan 2015 17:41:45 +0000</created>
                <updated>Tue, 27 Jan 2015 01:41:53 +0000</updated>
                            <resolved>Tue, 27 Jan 2015 01:41:19 +0000</resolved>
                                    <version>1.2.0</version>
                                    <fixVersion>1.3.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14262646" author="srowen" created="Thu, 1 Jan 2015 19:36:30 +0000"  >&lt;p&gt;Guava is shaded, except for this one class, because it was sort of inadvertently used in the public API. It should be a shading of Guava 14. You are perhaps trying to use a different version? And that results in this ugly little conflict. Best thing is to use Guava 14 or at least ensure a different copy does not shadow this Optional at runtime. I am not sure there is otherwise a change in Spark here. &lt;/p&gt;</comment>
                            <comment id="14262673" author="elmer.garduno" created="Thu, 1 Jan 2015 22:02:21 +0000"  >&lt;p&gt;Reverting to Guava 14 still generates the same error. But including com.google.common.base.Function on the &lt;a href=&quot;https://github.com/apache/spark/blob/master/core/pom.xml#L394&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;pom&lt;/a&gt; seems to generate an assembly jar with the correct method signature:&lt;/p&gt;

&lt;p&gt;public abstract &amp;lt;V extends java/lang/Object&amp;gt; com.google.common.base.Optional&amp;lt;V&amp;gt; transform(com.google.common.base.Function&amp;lt;? super T, V&amp;gt;);&lt;/p&gt;

&lt;p&gt;I&apos;m now creating the distribution to test on the cluster.&lt;/p&gt;</comment>
                            <comment id="14262740" author="elmer.garduno" created="Fri, 2 Jan 2015 03:31:37 +0000"  >&lt;p&gt;As mentioned in the previous comment the method signatures get fixed when including the conflicting shaded classes in core/pom.xml and excluding them (in assembly/pom.xml). Here are the signatures for the classes generated on Spark 1.2.0 and the signatures after fixing the dependencies, note how the &lt;tt&gt;or(org.spark-project.guava.common.base.Supplier)&lt;/tt&gt; and &lt;tt&gt;transform(org.spark-project.guava.common.base.Function)&lt;/tt&gt; have incorrect signatures. &lt;/p&gt;

&lt;p&gt;The problem is that If user code attempts to use this methods a &lt;tt&gt;NoSuchMethodError&lt;/tt&gt; will be thrown as the classes on runtime have the incorrect signatures:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;javap -classpath ../spark-1.2.0-bin-hadoop1/lib/spark-assembly-1.2.0-hadoop1.0.4.jar com.google.common.base.Optional
Compiled from &lt;span class=&quot;code-quote&quot;&gt;&quot;Optional.java&quot;&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;com.google.common.base.Optional&amp;lt;T&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; java.io.Serializable {
  ...
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; T or(org.spark-project.guava.common.base.Supplier&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; T&amp;gt;);
  ...
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; &amp;lt;V &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; java/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; com.google.common.base.Optional&amp;lt;V&amp;gt; transform(org.spark-project.guava.common.base.Function&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt; T, V&amp;gt;);
  ...
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After adding the required classes to the pom files, the methods have the correct signatures:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;javap -classpath assembly/target/scala-2.10/spark-assembly-1.3.0-SNAPSHOT-hadoop1.2.1.jar com.google.common.base.Optional
Compiled from &lt;span class=&quot;code-quote&quot;&gt;&quot;Optional.java&quot;&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;com.google.common.base.Optional&amp;lt;T&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; java.io.Serializable {
  ...
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; com.google.common.base.Optional&amp;lt;T&amp;gt; or(com.google.common.base.Optional&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; T&amp;gt;);
  ...
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; &amp;lt;V &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; java/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;&amp;gt; com.google.common.base.Optional&amp;lt;V&amp;gt; transform(com.google.common.base.Function&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt; T, V&amp;gt;);
  ...
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now the tricky part, adding only the two affected classes (Function, Supplier) generates runtime problems as they have downstream dependencies:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Exception in thread &quot;main&quot; java.lang.VerifyError: Bad return type
Exception Details:
  Location:
    org/spark-project/guava/common/base/Equivalence.onResultOf(Lcom/google/common/base/Function;)Lorg/spark-project/guava/common/base/Equivalence; @9: areturn
  Reason:
    Type &apos;com/google/common/base/FunctionalEquivalence&apos; (current frame, stack[0]) is not assignable to &apos;org/spark-project/guava/common/base/Equivalence&apos; (from method signature)
  Current Frame:
    bci: @9
    flags: { }
    locals: { &apos;org/spark-project/guava/common/base/Equivalence&apos;, &apos;com/google/common/base/Function&apos; }
    stack: { &apos;com/google/common/base/FunctionalEquivalence&apos; }
  Bytecode:
    0000000: bb00 3059 2b2a b700 33b0

	at org.spark-project.guava.common.collect.MapMakerInternalMap$Strength$1.defaultEquivalence(MapMakerInternalMap.java:304)
	at org.spark-project.guava.common.collect.MapMaker.getKeyEquivalence(MapMaker.java:158)
	at org.spark-project.guava.common.collect.MapMakerInternalMap.&amp;lt;init&amp;gt;(MapMakerInternalMap.java:201)
	at org.spark-project.guava.common.collect.MapMaker.makeMap(MapMaker.java:506)
	at org.apache.spark.SparkEnv.&amp;lt;init&amp;gt;(SparkEnv.scala:77)
	at org.apache.spark.SparkEnv$.create(SparkEnv.scala:337)
	at org.apache.spark.SparkEnv$.createDriverEnv(SparkEnv.scala:159)
	at org.apache.spark.SparkContext.&amp;lt;init&amp;gt;(SparkContext.scala:232)
	at com.google.cloud.genomics.spark.examples.GenomicsConf.newSparkContext(GenomicsConf.scala:57)
	at com.google.cloud.genomics.spark.examples.VariantsPcaDriver.&amp;lt;init&amp;gt;(VariantsPca.scala:59)
	at com.google.cloud.genomics.spark.examples.VariantsPcaDriver$.apply(VariantsPca.scala:53)
	at com.google.cloud.genomics.spark.examples.VariantsPcaDriver$.main(VariantsPca.scala:44)
	at com.google.cloud.genomics.spark.examples.VariantsPcaDriver.main(VariantsPca.scala)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The fix to the problem is to include all of &lt;tt&gt;com/google/common/base/*&lt;/tt&gt; (or narrow it down manually to all the required deps), but that seems to defeat the purpose of these exclusions? Thoughts?&lt;/p&gt;
</comment>
                            <comment id="14262744" author="apachespark" created="Fri, 2 Jan 2015 03:49:21 +0000"  >&lt;p&gt;User &apos;elmer-garduno&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/3874&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/3874&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14263617" author="elmer.garduno" created="Sat, 3 Jan 2015 20:15:27 +0000"  >&lt;p&gt;The problem seem to be fixed when using spark-submit instead of spark-class.&lt;/p&gt;</comment>
                            <comment id="14263695" author="elmer.garduno" created="Sun, 4 Jan 2015 01:29:06 +0000"  >&lt;p&gt;False alarm, still getting the same errors when running on the standalone cluster.&lt;/p&gt;</comment>
                            <comment id="14281698" author="mfawzymkh" created="Sun, 18 Jan 2015 08:27:03 +0000"  >&lt;p&gt;Is there any progress on this issue.&lt;br/&gt;
I am trying to use facebook-swift  in a user jar and hitting this issue with Guava.&lt;/p&gt;

&lt;p&gt;facebook swift-service 14.0 uses Guava 16 &lt;/p&gt;</comment>
                            <comment id="14281965" author="elmer.garduno" created="Sun, 18 Jan 2015 21:21:40 +0000"  >&lt;p&gt;The pull request is waiting for an admin to look at it.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12731833">SPARK-2848</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 44 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i23w53:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>