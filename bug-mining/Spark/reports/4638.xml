<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:51:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-19611] Spark 2.1.0 breaks some Hive tables backed by case-sensitive data files</title>
                <link>https://issues.apache.org/jira/browse/SPARK-19611</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;This issue replaces &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-19455&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;SPARK-19455&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/spark/pull/16797&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR #16797&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-16980&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;SPARK-16980&lt;/a&gt; removed the schema inferrence from the HiveMetastoreCatalog class when converting a MetastoreRelation to a LoigcalRelation (HadoopFsRelation, in this case) in favor of simply using the schema returend by the metastore. This results in an optimization as the underlying file status no longer need to be resolved until after the partition pruning step, reducing the number of files to be touched significantly in some cases. The downside is that the data schema used may no longer match the underlying file schema for case-sensitive formats such as Parquet.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-17183&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;SPARK-17183&lt;/a&gt; added support for saving a case-sensitive copy of the schema in the metastore table properties, which HiveExternalCatalog will read in as the table&apos;s schema if it is present. If it is not present, it will fall back to the case-insensitive metastore schema.&lt;/p&gt;

&lt;p&gt;Unfortunately, this silently breaks queries over tables where the underlying data fields are case-sensitive but a case-sensitive schema wasn&apos;t written to the table properties by Spark. This situation will occur for any Hive table that wasn&apos;t created by Spark or that was created prior to Spark 2.1.0. If a user attempts to run a query over such a table containing a case-sensitive field name in the query projection or in the query filter, the query will return 0 results in every case.&lt;/p&gt;

&lt;p&gt;The change we are proposing is to bring back the schema inference that was used prior to Spark 2.1.0 if a case-sensitive schema can&apos;t be read from the table properties.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;INFER_AND_SAVE: Infer a schema from the data files if no case-sensitive schema can be read from the table properties. Attempt to save the inferred schema in the table properties to avoid future inference.&lt;/li&gt;
	&lt;li&gt;INFER_ONLY: Infer the schema if no case-sensitive schema can be read but don&apos;t attempt to save it.&lt;/li&gt;
	&lt;li&gt;NEVER_INFER: Fall back to using the case-insensitive schema returned by the Hive Metatore. Useful if the user knows that none of the underlying data is case-sensitive.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;See the discussion on &lt;a href=&quot;https://github.com/apache/spark/pull/16797&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR #16797&lt;/a&gt; for more discussion around this issue and the proposed solution.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13043351">SPARK-19611</key>
            <summary>Spark 2.1.0 breaks some Hive tables backed by case-sensitive data files</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="budde">Adam Budde</assignee>
                                    <reporter username="budde">Adam Budde</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 Feb 2017 19:24:06 +0000</created>
                <updated>Mon, 30 Oct 2017 23:13:04 +0000</updated>
                            <resolved>Thu, 9 Mar 2017 20:55:48 +0000</resolved>
                                    <version>2.1.0</version>
                                    <fixVersion>2.1.1</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="15868458" author="apachespark" created="Wed, 15 Feb 2017 19:41:04 +0000"  >&lt;p&gt;User &apos;budde&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/16942&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16942&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15868666" author="apachespark" created="Wed, 15 Feb 2017 22:13:04 +0000"  >&lt;p&gt;User &apos;budde&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/16944&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16944&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15868677" author="apachespark" created="Wed, 15 Feb 2017 22:18:03 +0000"  >&lt;p&gt;User &apos;budde&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/16942&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16942&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15870164" author="rxin" created="Thu, 16 Feb 2017 15:53:38 +0000"  >&lt;p&gt;Rather than this fix, can we just save the case sensitive schema in the catalog?&lt;/p&gt;</comment>
                            <comment id="15870262" author="budde" created="Thu, 16 Feb 2017 16:45:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-17183&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;SPARK-17183&lt;/a&gt; added support for saving the case-sensitive schema in the table properties in order to avoid the conflicts introduced by Hive metastore downcasing without the need for schema inference. The problem stated here occurs when Spark doesn&apos;t find a case-sensitive schema in the table properties and falls back to the case insensitive metastore schema. This will happen for any Hive table that wasn&apos;t created by Spark or that was created with Spark 2.1.0.&lt;/p&gt;

&lt;p&gt;In the &lt;a href=&quot;https://github.com/apache/spark/pull/16797&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR 16797 discussion&lt;/a&gt; I provided my reasoning for why I think simply offering a way to perform migrations to write case-sensitive schemas to the table properties won&apos;t be sufficient to solve this alone.&lt;/p&gt;</comment>
                            <comment id="15903850" author="cloud_fan" created="Thu, 9 Mar 2017 20:55:48 +0000"  >&lt;p&gt;Issue resolved by pull request 16944&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/16944&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16944&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15904033" author="apachespark" created="Thu, 9 Mar 2017 23:07:03 +0000"  >&lt;p&gt;User &apos;budde&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/17229&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/17229&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15905705" author="apachespark" created="Fri, 10 Mar 2017 21:13:02 +0000"  >&lt;p&gt;User &apos;budde&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/17249&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/17249&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16225953" author="apachespark" created="Mon, 30 Oct 2017 23:13:04 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19615&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19615&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13066456">SPARK-20450</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13110299">SPARK-22306</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13111244">SPARK-22329</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 3 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3a4nz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>