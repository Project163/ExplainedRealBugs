<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:47:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-17618] Dataframe except returns incorrect results when combined with coalesce</title>
                <link>https://issues.apache.org/jira/browse/SPARK-17618</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;We were getting incorrect results from the DataFrame except method - all rows were being returned instead of the ones that intersected. Calling subtract on the underlying RDD returned the correct result.&lt;/p&gt;

&lt;p&gt;We tracked it down to the use of coalesce - the following is the simplest example case we created that reproduces the issue:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;val schema = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StructType().add(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;, types.IntegerType )
val t1 = sql.createDataFrame(sql.sparkContext.parallelize(1 to 100).map(i=&amp;gt; Row(i)), schema)
val t2 = sql.createDataFrame(sql.sparkContext.parallelize(5 to 10).map(i=&amp;gt; Row(i)), schema)
val t3 = t1.join(t2, t1.col(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;).equalTo(t2.col(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;)), &lt;span class=&quot;code-quote&quot;&gt;&quot;leftsemi&quot;&lt;/span&gt;)
println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Count using normal except = &quot;&lt;/span&gt; + t1.except(t3).count())
println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Count using coalesce = &quot;&lt;/span&gt; + t1.coalesce(8).except(t3.coalesce(8)).count())
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We should get the same result from both uses of except, but the one using coalesce returns 100 instead of 94.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13006362">SPARK-17618</key>
            <summary>Dataframe except returns incorrect results when combined with coalesce</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="joshrosen">Josh Rosen</assignee>
                                    <reporter username="gedwards">Graeme Edwards</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Wed, 21 Sep 2016 02:51:12 +0000</created>
                <updated>Wed, 28 Sep 2016 23:27:26 +0000</updated>
                            <resolved>Tue, 27 Sep 2016 18:01:52 +0000</resolved>
                                    <version>1.6.1</version>
                    <version>1.6.2</version>
                                    <fixVersion>1.6.3</fixVersion>
                    <fixVersion>2.0.1</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15510874" author="joshrosen" created="Wed, 21 Sep 2016 19:11:59 +0000"  >&lt;p&gt;It looks like this affects 1.6.2 as well, but I was unable to reproduce in 2.x.&lt;/p&gt;

&lt;p&gt;Comparing the two physical plans, I wonder if the issue has to do with Tungsten vs. regular internal row formats.&lt;/p&gt;

&lt;p&gt;For &lt;tt&gt;t1.except(t3).explain(true)&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;== Physical Plan ==
Except
:- Scan ExistingRDD[test#35] 
+- ConvertToSafe
   +- LeftSemiJoinHash [test#35], [test#36], None
      :- TungstenExchange hashpartitioning(test#35,200), None
      :  +- ConvertToUnsafe
      :     +- Scan ExistingRDD[test#35] 
      +- TungstenExchange hashpartitioning(test#36,200), None
         +- ConvertToUnsafe
            +- Scan ExistingRDD[test#36]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;whereas &lt;tt&gt;t1.coalesce(8).except(t3.coalesce(8)).explain(true)&lt;/tt&gt; produces&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Except
:- Coalesce 8
:  +- Scan ExistingRDD[test#35] 
+- Coalesce 8
   +- LeftSemiJoinHash [test#35], [test#36], None
      :- TungstenExchange hashpartitioning(test#35,200), None
      :  +- ConvertToUnsafe
      :     +- Scan ExistingRDD[test#35] 
      +- TungstenExchange hashpartitioning(test#36,200), None
         +- ConvertToUnsafe
            +- Scan ExistingRDD[test#36]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;My hunch is that Except is inappropriately mixing Tungsten and non-Tungsten row formats due to a bug in the row format conversion rules.&lt;/p&gt;</comment>
                            <comment id="15510934" author="joshrosen" created="Wed, 21 Sep 2016 19:35:57 +0000"  >&lt;p&gt;Yep, the problem is that &lt;tt&gt;Coalesce&lt;/tt&gt; advertises that it accepts Unsafe rows but misdeclares its row output format as being regular rows. Comparing an UnsafeRow to any other row type for equality always returns false (its &lt;tt&gt;equals()&lt;/tt&gt; implementation is compatible with Java universal equality, so it doesn&apos;t throw when performing a comparison against a different type). As a result, the Except compares safe and unsafe rows, causing the comparisons to be incorrect and leading to the wrong answer that you saw here.&lt;/p&gt;

&lt;p&gt;I&apos;m marking this as a blocker for 1.6.3 and am working on a fix which will fix this issue.&lt;/p&gt;</comment>
                            <comment id="15511034" author="apachespark" created="Wed, 21 Sep 2016 20:15:05 +0000"  >&lt;p&gt;User &apos;JoshRosen&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15185&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15185&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15511443" author="gedwards" created="Wed, 21 Sep 2016 22:49:44 +0000"  >&lt;p&gt;Thanks Josh, that perfectly explains what we saw. Thanks for the quick response!&lt;/p&gt;</comment>
                            <comment id="15526953" author="hvanhovell" created="Tue, 27 Sep 2016 18:01:52 +0000"  >&lt;p&gt;Resolved per Josh&apos;s PR.&lt;/p&gt;

&lt;p&gt;Follow-up for 2.0/master will follow.&lt;/p&gt;</comment>
                            <comment id="15527038" author="apachespark" created="Tue, 27 Sep 2016 18:33:05 +0000"  >&lt;p&gt;User &apos;JoshRosen&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15265&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15265&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 8 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i33ven:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12336854">1.6.3</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>