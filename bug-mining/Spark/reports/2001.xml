<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:28:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-8342] Decimal Math beyond ~2^112 is broken</title>
                <link>https://issues.apache.org/jira/browse/SPARK-8342</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Here is a snippet from the spark-shell that should not happen&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;scala&amp;gt; val d = Decimal(&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MaxValue,100,0) * Decimal(&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MaxValue,100,0)
d: org.apache.spark.sql.types.Decimal = 0
scala&amp;gt; d.toDebugString
res3: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; = Decimal(expanded,0,1,0})
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It looks like precision gets reseted on some operations and values are then truncated.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12837594">SPARK-8342</key>
            <summary>Decimal Math beyond ~2^112 is broken</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="viirya">L. C. Hsieh</assignee>
                                    <reporter username="rtreffer">Rene Treffer</reporter>
                        <labels>
                    </labels>
                <created>Sat, 13 Jun 2015 13:41:36 +0000</created>
                <updated>Sun, 14 Jun 2015 06:58:47 +0000</updated>
                            <resolved>Sun, 14 Jun 2015 05:42:33 +0000</resolved>
                                    <version>1.5.0</version>
                                    <fixVersion>1.5.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14584682" author="apachespark" created="Sat, 13 Jun 2015 15:56:06 +0000"  >&lt;p&gt;User &apos;viirya&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/6797&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/6797&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14584784" author="rtreffer" created="Sat, 13 Jun 2015 19:10:40 +0000"  >&lt;p&gt;Oh no, I managed to create a completely unrelated testcase for my problem. Reduction ftw....&lt;/p&gt;

&lt;p&gt;Here is what breaks in the &amp;gt;2^112 range&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.types.Decimal

val one = Decimal(1)
val two = Decimal(2)

def pow(n : Int) :  Decimal = &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (n &amp;lt;= 0) { one } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; { 
  val a = pow(n - 1)
  a.changePrecision(n,0)
  two.changePrecision(n,0)
  a * two
}

(109 to 120).foreach(n =&amp;gt; println(pow(n).toJavaBigDecimal.unscaledValue.toString))
649037107316853453566312041152512
1298074214633706907132624082305024
2596148429267413814265248164610048
5192296858534827628530496329220096
1038459371706965525706099265844019
2076918743413931051412198531688038
4153837486827862102824397063376076
8307674973655724205648794126752152
1661534994731144841129758825350430
3323069989462289682259517650700860
6646139978924579364519035301401720
1329227995784915872903807060280344
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So precision gets lost. It&apos;s not visible on the normal output path, but it is a loss of precision (10^n is always enough to hold 2^n without loss of precision).&lt;/p&gt;

&lt;p&gt;Should I open another ticket for this?&lt;/p&gt;</comment>
                            <comment id="14584943" author="rxin" created="Sun, 14 Jun 2015 05:42:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rtreffer&quot; class=&quot;user-hover&quot; rel=&quot;rtreffer&quot;&gt;rtreffer&lt;/a&gt; if this patch doesn&apos;t fix it, can you open another ticket? Thanks.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/spark/pull/6797&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/6797&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14584961" author="rtreffer" created="Sun, 14 Jun 2015 06:58:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rxin&quot; class=&quot;user-hover&quot; rel=&quot;rxin&quot;&gt;rxin&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=viirya&quot; class=&quot;user-hover&quot; rel=&quot;viirya&quot;&gt;viirya&lt;/a&gt; yes, I&apos;ve tested with the patch applied (both the original report, which is now fixed, and my original problem, which is not fixed) :-S&lt;/p&gt;

&lt;p&gt;I&apos;ve opened &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-8359&quot; title=&quot;Spark SQL Decimal type precision loss on multiplication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-8359&quot;&gt;&lt;del&gt;SPARK-8359&lt;/del&gt;&lt;/a&gt; for the precision loss.&lt;/p&gt;

&lt;p&gt;Sorry for the confusion, this patch still causes a similar problem:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.types.Decimal

val d = Decimal(&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MaxValue,100,0) * Decimal(&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MaxValue,100,0)

d.toJavaBigDecimal.unscaledValue.toString

8507059173023461584739690778423250
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But cross-checking with bc says it should be&lt;br/&gt;
85070591730234615847396907784232501249 ((2^63 - 1) * (2^63 - 1))&lt;br/&gt;
8507059173023461584739690778423250 is truncated.&lt;br/&gt;
Calling changePrecision(100,0) after the multiplication results in&lt;br/&gt;
85070591730234615847396907784232500000&lt;/p&gt;

&lt;p&gt;Anyway, different bug, different ticket, although the problem is also present in this case, it&apos;s just hidden behind another bug 0.o&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 23 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2g08v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>