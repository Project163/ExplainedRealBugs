<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:01:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-23173] from_json can produce nulls for fields which are marked as non-nullable</title>
                <link>https://issues.apache.org/jira/browse/SPARK-23173</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;The &lt;tt&gt;from_json&lt;/tt&gt; function&#160;uses&#160;a schema&#160;to convert a string into a Spark SQL struct. This schema can contain non-nullable fields. The underlying &lt;tt&gt;JsonToStructs&lt;/tt&gt; expression does not check if a resulting&#160;struct respects the nullability of the schema. This leads to very weird problems in&#160;consuming expressions. In our case parquet writing would produce an illegal parquet file.&lt;/p&gt;

&lt;p&gt;There are roughly solutions here:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Assume that each field in schema passed to&#160;&lt;tt&gt;from_json&lt;/tt&gt; is nullable, and ignore the nullability information set in the passed schema.&lt;/li&gt;
	&lt;li&gt;Validate the object during runtime, and fail execution if the data is null where we are not expecting this.&lt;br/&gt;
I currently am slightly in favor of option 1, since this is the more performant option and a lot easier to do.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;WDYT? cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rxin&quot; class=&quot;user-hover&quot; rel=&quot;rxin&quot;&gt;rxin&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marmbrus&quot; class=&quot;user-hover&quot; rel=&quot;marmbrus&quot;&gt;marmbrus&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hyukjin.kwon&quot; class=&quot;user-hover&quot; rel=&quot;hyukjin.kwon&quot;&gt;hyukjin.kwon&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brkyvz&quot; class=&quot;user-hover&quot; rel=&quot;brkyvz&quot;&gt;brkyvz&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13132556">SPARK-23173</key>
            <summary>from_json can produce nulls for fields which are marked as non-nullable</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mswit">Micha&#322; &#346;witakowski</assignee>
                                    <reporter username="hvanhovell">Herman van H&#246;vell</reporter>
                        <labels>
                            <label>release-notes</label>
                    </labels>
                <created>Mon, 22 Jan 2018 01:43:52 +0000</created>
                <updated>Mon, 12 Dec 2022 18:11:10 +0000</updated>
                            <resolved>Sat, 10 Mar 2018 14:05:19 +0000</resolved>
                                    <version>2.2.1</version>
                                    <fixVersion>2.3.1</fixVersion>
                    <fixVersion>2.4.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="16333855" author="gurwls223" created="Mon, 22 Jan 2018 04:16:01 +0000"  >&lt;p&gt;I believe this one is related with &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-17763&quot; title=&quot;JacksonParser silently parses null as 0 when the field is not nullable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-17763&quot;&gt;&lt;del&gt;SPARK-17763&lt;/del&gt;&lt;/a&gt;. My first try was 2 (roughly 1.5 years ago).&lt;/p&gt;

&lt;p&gt;The root cause seems the same - I just double checked the Jackson parsers produce &lt;tt&gt;null&lt;/tt&gt; regardless of the nullability.&lt;/p&gt;

&lt;p&gt;Just FYI, there was a related discussion in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-16472&quot; title=&quot;Inconsistent nullability in schema after being read&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-16472&quot;&gt;&lt;del&gt;SPARK-16472&lt;/del&gt;&lt;/a&gt; too. If I understood correctly, seems the guys roughly rather prefer to leave it as nullable rather than failure during runtime. &lt;/p&gt;

&lt;p&gt;So, +1 for 1. to me given the past discussion and It seems simplest and less invasion.&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; too who was in the discussion of &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-16472&quot; title=&quot;Inconsistent nullability in schema after being read&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-16472&quot;&gt;&lt;del&gt;SPARK-16472&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16333940" author="cloud_fan" created="Mon, 22 Jan 2018 07:04:52 +0000"  >&lt;p&gt;+1 on proposal 1.&lt;/p&gt;</comment>
                            <comment id="16334005" author="viirya" created="Mon, 22 Jan 2018 08:21:04 +0000"  >&lt;p&gt;+1 for 1 too.&lt;/p&gt;</comment>
                            <comment id="16334226" author="brkyvz" created="Mon, 22 Jan 2018 13:01:31 +0000"  >&lt;p&gt;In terms of usability, I prefer 1. In terms of the viewpoint of a data engineer, I would like 2 as well if that&apos;s not too hard.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Basically, if I expect that my data doesn&apos;t have nulls, but is suddenly outputting them, I would rather have it fail initially (or get written out to the &amp;#95;corrupt&amp;#95;record column).&lt;/p&gt;

&lt;p&gt;In an ideal world, I should be able to either permit nullable fields (Option 1), or have the record be written out as corrupt.&lt;/p&gt;</comment>
                            <comment id="16334388" author="mswit" created="Mon, 22 Jan 2018 15:16:20 +0000"  >&lt;p&gt;I think starting with option 1 is a good idea for a remedy of the corruption issue.&lt;/p&gt;

&lt;p&gt;Verifying the data would certainly be good and it can be done in at least two approaches:&lt;/p&gt;

&lt;p&gt;(1) detect incorrect data and fail&lt;/p&gt;

&lt;p&gt;(2) write rejected data to a separate file/column as Burak suggests&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;(1) can even be orthogonal if the verification is done at the level of parquet encoding. It would help avoid the corruption with all sources, not just JSON.&lt;/p&gt;</comment>
                            <comment id="16339144" author="mswit" created="Thu, 25 Jan 2018 12:16:11 +0000"  >&lt;p&gt;I&apos;m going to work on this.&lt;/p&gt;</comment>
                            <comment id="16339794" author="rxin@databricks.com" created="Thu, 25 Jan 2018 20:04:00 +0000"  >&lt;p&gt;Yea I agree with you Herman.&lt;/p&gt;

&lt;p&gt;On Sun, Jan 21, 2018 at 5:44 PM Herman van Hovell (JIRA) &amp;lt;jira@apache.org&amp;gt;&lt;/p&gt;
</comment>
                            <comment id="16380250" author="apachespark" created="Wed, 28 Feb 2018 12:51:04 +0000"  >&lt;p&gt;User &apos;mswit-databricks&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/20694&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/20694&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16394179" author="gurwls223" created="Sat, 10 Mar 2018 14:05:19 +0000"  >&lt;p&gt;Fixed in &lt;a href=&quot;https://github.com/apache/spark/pull/20694&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/20694&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13009179">SPARK-17763</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12896678">SPARK-10848</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 36 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3p5wf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>