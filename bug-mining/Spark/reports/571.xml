<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:16:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-2931] getAllowedLocalityLevel() throws ArrayIndexOutOfBoundsException</title>
                <link>https://issues.apache.org/jira/browse/SPARK-2931</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When running Spark Perf&apos;s sort-by-key benchmark on EC2 with v1.1.0-snapshot, I get the following errors (one per task):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;14/08/08 18:54:22 INFO scheduler.TaskSetManager: Starting task 39.0 in stage 0.0 (TID 39, ip-172-31-14-30.us-west-2.compute.internal, PROCESS_LOCAL, 1003 bytes)
14/08/08 18:54:22 INFO cluster.SparkDeploySchedulerBackend: Registered executor: Actor[akka.tcp:&lt;span class=&quot;code-comment&quot;&gt;//sparkExecutor@ip-172-31-9-213.us-west-2.compute.internal:58901/user/Executor#1436065036] with ID 0
&lt;/span&gt;14/08/08 18:54:22 ERROR actor.OneForOneStrategy: 1
java.lang.ArrayIndexOutOfBoundsException: 1
  at org.apache.spark.scheduler.TaskSetManager.getAllowedLocalityLevel(TaskSetManager.scala:475)
  at org.apache.spark.scheduler.TaskSetManager.resourceOffer(TaskSetManager.scala:409)
  at org.apache.spark.scheduler.TaskSchedulerImpl$$anonfun$resourceOffers$3$$anonfun$apply$7$$anonfun$apply$2.apply$mcVI$sp(TaskSchedulerImpl.scala:261)
  at scala.collection.immutable.Range.foreach$mVc$sp(Range.scala:141)
  at org.apache.spark.scheduler.TaskSchedulerImpl$$anonfun$resourceOffers$3$$anonfun$apply$7.apply(TaskSchedulerImpl.scala:257)
  at org.apache.spark.scheduler.TaskSchedulerImpl$$anonfun$resourceOffers$3$$anonfun$apply$7.apply(TaskSchedulerImpl.scala:254)
  at scala.collection.IndexedSeqOptimized$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;foreach(IndexedSeqOptimized.scala:33)
  at scala.collection.mutable.ArrayOps$ofRef.foreach(ArrayOps.scala:108)
  at org.apache.spark.scheduler.TaskSchedulerImpl$$anonfun$resourceOffers$3.apply(TaskSchedulerImpl.scala:254)
  at org.apache.spark.scheduler.TaskSchedulerImpl$$anonfun$resourceOffers$3.apply(TaskSchedulerImpl.scala:254)
  at scala.collection.mutable.ResizableArray$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;foreach(ResizableArray.scala:59)
  at scala.collection.mutable.ArrayBuffer.foreach(ArrayBuffer.scala:47)
  at org.apache.spark.scheduler.TaskSchedulerImpl.resourceOffers(TaskSchedulerImpl.scala:254)
  at org.apache.spark.scheduler.cluster.CoarseGrainedSchedulerBackend$DriverActor.makeOffers(CoarseGrainedSchedulerBackend.scala:153)
  at org.apache.spark.scheduler.cluster.CoarseGrainedSchedulerBackend$DriverActor$$anonfun$receive$1.applyOrElse(CoarseGrainedSchedulerBackend.scala:103)
  at akka.actor.ActorCell.receiveMessage(ActorCell.scala:498)
  at akka.actor.ActorCell.invoke(ActorCell.scala:456)
  at akka.dispatch.Mailbox.processMailbox(Mailbox.scala:237)
  at akka.dispatch.Mailbox.run(Mailbox.scala:219)
  at akka.dispatch.ForkJoinExecutorConfigurator$AkkaForkJoinTask.exec(AbstractDispatcher.scala:386)
  at scala.concurrent.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)
  at scala.concurrent.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339)
  at scala.concurrent.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)
  at scala.concurrent.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This causes the job to hang.&lt;/p&gt;

&lt;p&gt;I can deterministically reproduce this by re-running the test, either in isolation or as part of the full performance testing suite.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Spark EC2, spark-1.1.0-snapshot1, sort-by-key spark-perf benchmark&lt;/p&gt;</environment>
        <key id="12732910">SPARK-2931</key>
            <summary>getAllowedLocalityLevel() throws ArrayIndexOutOfBoundsException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="joshrosen">Josh Rosen</assignee>
                                    <reporter username="joshrosen">Josh Rosen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 8 Aug 2014 19:18:49 +0000</created>
                <updated>Wed, 22 Oct 2014 22:18:14 +0000</updated>
                            <resolved>Fri, 15 Aug 2014 06:42:38 +0000</resolved>
                                    <version>1.1.0</version>
                                    <fixVersion>1.1.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14091222" author="kayousterhout" created="Fri, 8 Aug 2014 20:04:59 +0000"  >&lt;p&gt;Do you know of any way to reproduce this locally without running the full spark-perf suite?&lt;/p&gt;</comment>
                            <comment id="14091252" author="joshrosen" created="Fri, 8 Aug 2014 20:25:34 +0000"  >&lt;p&gt;It&apos;s pretty quick to set up a local spark-perf that runs the 1.1.10-snapshot1 binary distribution.  Unfortunately, I tried this and was unable to reproduce the issue.  Maybe I need to run multiple local workers with different hostnames, which I&apos;ll try next.&lt;/p&gt;</comment>
                            <comment id="14091259" author="kayousterhout" created="Fri, 8 Aug 2014 20:31:37 +0000"  >&lt;p&gt;I tried doing something similar to spark-perf and could not reproduce this problem; will try running it on multiples machines shortly.  In case it&apos;s useful to you, here&apos;s what I did:&lt;/p&gt;

&lt;p&gt;val randKeys = sc.parallelize(1 to 10, 10).flatMap { x =&amp;gt; val r = new Random&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;; (1 to 20).map{ x =&amp;gt; r.nextInt(10) }}&lt;br/&gt;
val kv = randKeys.map((_, 1))&lt;br/&gt;
kv.sortByKey().collect()&lt;/p&gt;</comment>
                            <comment id="14091581" author="joshrosen" created="Sat, 9 Aug 2014 02:01:28 +0000"  >&lt;p&gt;This isn&apos;t the easiest bug to reproduce.  I tried running the same spark-perf test on a smaller cluster composed of 20 m1.xlarge instances and it worked fine.  I&apos;ve been able to consistently reproduce it on a cluster of 8 r3.8xlarge nodes.&lt;/p&gt;

&lt;p&gt;It looks like the problem was introduced in &lt;a href=&quot;https://github.com/apache/spark/pull/1313&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/1313&lt;/a&gt;, since it works fine if I revert to the previous commit.&lt;/p&gt;</comment>
                            <comment id="14091700" author="pwendell" created="Sat, 9 Aug 2014 08:07:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=matei&quot; class=&quot;user-hover&quot; rel=&quot;matei&quot;&gt;matei&lt;/a&gt; Hey Matei - IIRC you looked at this patch a bunch. Do you have any guesses as to what is causing this?&lt;/p&gt;</comment>
                            <comment id="14091703" author="kayousterhout" created="Sat, 9 Aug 2014 08:18:31 +0000"  >&lt;p&gt;Josh and I chatted a bit about this offline.  I suspect what&apos;s happening is:&lt;/p&gt;

&lt;p&gt;Here we recompute myLocalityLevels: &lt;a href=&quot;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/scheduler/TaskSetManager.scala#L693&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/scheduler/TaskSetManager.scala#L693&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;...but don&apos;t reset currentLocalityLevel.&lt;/p&gt;

&lt;p&gt;So, it seems like if the number of locality levels decreases, currentLocalityLevel can end being higher than the set of allowed levels.  If this is indeed the problem, it looks like the code was last changed by the patch you mentioned Patrick/Josh.&lt;/p&gt;</comment>
                            <comment id="14091746" author="mridulm80" created="Sat, 9 Aug 2014 12:54:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kayousterhout&quot; class=&quot;user-hover&quot; rel=&quot;kayousterhout&quot;&gt;kayousterhout&lt;/a&gt; this is weird, I remember mentioned this exact same issue in some PR for 1.1 (trying to find which one, though not 1313 iirc); and I think it was supposed to have been addressed.&lt;br/&gt;
We had observed this issue of currentLocalityLevel running away when we had internally merged the pr.&lt;/p&gt;

&lt;p&gt;Strange that it was not addressed, speaks volumes of me not following up on my reviews !&lt;/p&gt;</comment>
                            <comment id="14091841" author="joshrosen" created="Sat, 9 Aug 2014 18:11:08 +0000"  >&lt;p&gt;@ &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kayousterhout&quot; class=&quot;user-hover&quot; rel=&quot;kayousterhout&quot;&gt;kayousterhout&lt;/a&gt;: I can see how that code in &lt;tt&gt;executorLost()&lt;/tt&gt; could be problematic, but I don&apos;t think that&apos;s what&apos;s triggering this bug since I don&apos;t see any &quot;Re-queueing tasks for ...&quot; messages in my log.&lt;/p&gt;

&lt;p&gt;I&apos;ve attached a full log from a failing test run.  If it helps, I can re-run at DEBUG logging or add extra logging statements.&lt;/p&gt;</comment>
                            <comment id="14091849" author="mridulm80" created="Sat, 9 Aug 2014 18:49:04 +0000"  >&lt;p&gt;Checking more, it might have been for an internal review : not sure, cant find an external reference.&lt;br/&gt;
So the issue is as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kayousterhout&quot; class=&quot;user-hover&quot; rel=&quot;kayousterhout&quot;&gt;kayousterhout&lt;/a&gt; described, after locality levels are updated (as part of an executor loss, etc); the index is not updated accordingly (or reset).&lt;/p&gt;

&lt;p&gt;The earlier code was assuming the population of the data structures wont change once created - which is no longer the case.&lt;br/&gt;
A testcase to simulate this should be possible - rough sketch :&lt;br/&gt;
a) Add two executors one PROCESS_LOCAL executor exec1 and one ANY executors exec2.&lt;br/&gt;
my locality levels should now contain all levels now due to exec1&lt;br/&gt;
b) schedule a task on the process_local executors, and wait sufficiently such that level is now at rack or any.&lt;br/&gt;
c) fail the process_local executor - iirc currently this will not cause recomputation of levels.&lt;br/&gt;
d) Add an ANY executor exec3 - this will trigger computeValidLocalityLevels in executorAdded (exec failure does not, we probably should add that).&lt;br/&gt;
e) Now, any invocation of getAllowedLocalityLevel will cause the exception Josh mentioned.&lt;/p&gt;


&lt;p&gt;and ensure the corresponding cleanup is triggered; to cause an update&lt;/p&gt;</comment>
                            <comment id="14091880" author="mridulm80" created="Sat, 9 Aug 2014 19:59:05 +0000"  >&lt;p&gt;A patch to showcase the exception&lt;/p&gt;</comment>
                            <comment id="14091881" author="mridulm80" created="Sat, 9 Aug 2014 19:59:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=joshrosen&quot; class=&quot;user-hover&quot; rel=&quot;joshrosen&quot;&gt;joshrosen&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kayousterhout&quot; class=&quot;user-hover&quot; rel=&quot;kayousterhout&quot;&gt;kayousterhout&lt;/a&gt; Added a patch which deterministically showcases the bug - should be easy to fix it now I hope &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14092331" author="lirui" created="Mon, 11 Aug 2014 01:52:26 +0000"  >&lt;p&gt;I think this may be introduced in &lt;a href=&quot;https://github.com/apache/spark/pull/892&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;#892&lt;/a&gt;. When the valid locality levels are recomputed I didn&apos;t reset the current level. Sorry about this.&lt;/p&gt;</comment>
                            <comment id="14092966" author="joshrosen" created="Mon, 11 Aug 2014 16:45:49 +0000"  >&lt;p&gt;Thanks for investigating and reproducing this issue.  Is someone planning to open a PR with a fix?  If not, I can probably do it later this afternoon, since this bug is a blocker for many of the spark-perf tests that I&apos;m running.&lt;/p&gt;</comment>
                            <comment id="14093295" author="apachespark" created="Mon, 11 Aug 2014 21:07:37 +0000"  >&lt;p&gt;User &apos;JoshRosen&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/1896&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/1896&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14098257" author="pwendell" created="Fri, 15 Aug 2014 06:42:38 +0000"  >&lt;p&gt;This was fixed in:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/1896&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/1896&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12725194">SPARK-2353</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12660814" name="scala-sort-by-key.err" size="63140" author="joshrosen" created="Sat, 9 Aug 2014 18:11:08 +0000"/>
                            <attachment id="12660819" name="test.patch" size="2084" author="mridulm80" created="Sat, 9 Aug 2014 19:59:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>410938</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 14 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1yp7z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>410931</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326686">1.1.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>