<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:54:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-20832] Standalone master should explicitly inform drivers of worker deaths and invalidate external shuffle service outputs</title>
                <link>https://issues.apache.org/jira/browse/SPARK-20832</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-17370&quot; title=&quot;Shuffle service files not invalidated when a slave is lost&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-17370&quot;&gt;&lt;del&gt;SPARK-17370&lt;/del&gt;&lt;/a&gt; (a patch authored by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ekhliang&quot; class=&quot;user-hover&quot; rel=&quot;ekhliang&quot;&gt;ekhliang&lt;/a&gt; and reviewed by me), we added logic to the DAGScheduler to mark external shuffle service instances as unavailable upon task failure when the task failure reason was &quot;SlaveLost&quot; and this was known to be caused by worker death. If the Spark Master discovered that a worker was dead then it would notify any drivers with executors on those workers to mark those executors as dead. The linked patch simply piggybacked on this logic to have the executor death notification also imply worker death and to have worker-death-caused-executor-death imply shuffle file loss.&lt;/p&gt;

&lt;p&gt;However, there are modes of external shuffle service loss which this mechanism does not detect, leaving the system prone race conditions. Consider the following:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Spark standalone is configured to run an external shuffle service embedded in the Worker.&lt;/li&gt;
	&lt;li&gt;Application has shuffle outputs and executors on Worker A.&lt;/li&gt;
	&lt;li&gt;Stage depending on outputs of tasks that ran on Worker A starts.&lt;/li&gt;
	&lt;li&gt;All executors on worker A are removed due to dying with exceptions, scaling-down via the dynamic allocation APIs, but &lt;em&gt;not&lt;/em&gt; due to worker death. Worker A is still healthy at this point.&lt;/li&gt;
	&lt;li&gt;At this point the MapOutputTracker still records map output locations on Worker A&apos;s shuffle service. This is expected behavior.&lt;/li&gt;
	&lt;li&gt;Worker A dies at an instant where the application has no executors running on it.&lt;/li&gt;
	&lt;li&gt;The Master knows that Worker A died but does not inform the driver (which had no executors on that worker at the time of its death).&lt;/li&gt;
	&lt;li&gt;Some task from the running stage attempts to fetch map outputs from Worker A but these requests time out because Worker A&apos;s shuffle service isn&apos;t available.&lt;/li&gt;
	&lt;li&gt;Due to other logic in the scheduler, these preventable FetchFailures don&apos;t wind up invaliding the now-invalid unavailable map output locations (this is a distinct bug / behavior which I&apos;ll discuss in a separate JIRA ticket).&lt;/li&gt;
	&lt;li&gt;This behavior leads to several unsuccessful stage reattempts and ultimately to a job failure.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;A simple way to address this would be to have the Master explicitly notify drivers of all Worker deaths, even if those drivers don&apos;t currently have executors. The Spark Standalone scheduler backend can receive the explicit WorkerLost message and can bubble up the right calls to the task scheduler and DAGScheduler to invalidate map output locations from the now-dead external shuffle service.&lt;/p&gt;

&lt;p&gt;This relates to &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-20115&quot; title=&quot;Fix DAGScheduler to recompute all the lost shuffle blocks when external shuffle service is unavailable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-20115&quot;&gt;&lt;del&gt;SPARK-20115&lt;/del&gt;&lt;/a&gt; in the sense that both tickets aim to address issues where the external shuffle service is unavailable. The key difference is the mechanism for detection: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-20115&quot; title=&quot;Fix DAGScheduler to recompute all the lost shuffle blocks when external shuffle service is unavailable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-20115&quot;&gt;&lt;del&gt;SPARK-20115&lt;/del&gt;&lt;/a&gt; marks the external shuffle service as unavailable whenever any fetch failure occurs from it, whereas the proposal here relies on more explicit signals. This JIRA ticket&apos;s proposal is scoped only to Spark Standalone mode. As a compromise, we might be able to consider &quot;all of a single shuffle&apos;s outputs lost on a single external shuffle service&quot; following a fetch failure (to be discussed in separate JIRA). &lt;/p&gt;</description>
                <environment></environment>
        <key id="13073754">SPARK-20832</key>
            <summary>Standalone master should explicitly inform drivers of worker deaths and invalidate external shuffle service outputs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jiangxb1987">Xingbo Jiang</assignee>
                                    <reporter username="joshrosen">Josh Rosen</reporter>
                        <labels>
                    </labels>
                <created>Mon, 22 May 2017 03:19:32 +0000</created>
                <updated>Sun, 17 May 2020 17:47:08 +0000</updated>
                            <resolved>Thu, 22 Jun 2017 12:49:04 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.3.0</fixVersion>
                                    <component>Deploy</component>
                    <component>Scheduler</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16029778" author="jiangxb1987" created="Tue, 30 May 2017 17:19:43 +0000"  >&lt;p&gt;I&apos;m working on this.&lt;/p&gt;</comment>
                            <comment id="16055746" author="apachespark" created="Tue, 20 Jun 2017 13:25:04 +0000"  >&lt;p&gt;User &apos;jiangxb1987&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/18362&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18362&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16059293" author="cloud_fan" created="Thu, 22 Jun 2017 12:49:04 +0000"  >&lt;p&gt;Issue resolved by pull request 18362&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/18362&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18362&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13002220">SPARK-17370</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13060672">SPARK-20178</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13004522">SPARK-17519</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 21 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3fa0n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>