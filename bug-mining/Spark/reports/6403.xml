<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:04:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-27216] Upgrade RoaringBitmap to 0.7.45 to fix Kryo unsafe ser/dser issue</title>
                <link>https://issues.apache.org/jira/browse/SPARK-27216</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;HighlyCompressedMapStatus uses RoaringBitmap to record the empty blocks. But RoaringBitmap-0.5.11 couldn&apos;t be ser/deser with unsafe KryoSerializer.&lt;/p&gt;

&lt;p&gt;We can use below UT to reproduce:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  test(&lt;span class=&quot;code-quote&quot;&gt;&quot;kryo serialization with RoaringBitmap&quot;&lt;/span&gt;) {
    val bitmap = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RoaringBitmap
    bitmap.add(1787)

    val safeSer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KryoSerializer(conf).newInstance()
    val bitmap2 : RoaringBitmap = safeSer.deserialize(safeSer.serialize(bitmap))
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt;(bitmap2.equals(bitmap))

    conf.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;spark.kryo.unsafe&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;)
    val unsafeSer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KryoSerializer(conf).newInstance()
    val bitmap3 : RoaringBitmap = unsafeSer.deserialize(unsafeSer.serialize(bitmap))
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt;(bitmap3.equals(bitmap)) &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; will fail
&lt;/span&gt;  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Upgrade to latest version 0.7.45 to fix it&lt;/p&gt;</description>
                <environment></environment>
        <key id="13222836">SPARK-27216</key>
            <summary>Upgrade RoaringBitmap to 0.7.45 to fix Kryo unsafe ser/dser issue</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cltlfcjin">Lantao Jin</assignee>
                                    <reporter username="cltlfcjin">Lantao Jin</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Wed, 20 Mar 2019 13:07:05 +0000</created>
                <updated>Sat, 16 Oct 2021 15:43:26 +0000</updated>
                            <resolved>Thu, 4 Apr 2019 01:11:08 +0000</resolved>
                                    <version>2.0.0</version>
                    <version>2.1.0</version>
                    <version>2.2.0</version>
                    <version>2.3.3</version>
                    <version>2.4.0</version>
                    <version>3.0.0</version>
                                    <fixVersion>2.3.4</fixVersion>
                    <fixVersion>2.4.2</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16804447" author="aallen" created="Thu, 28 Mar 2019 23:38:25 +0000"  >&lt;p&gt;Thanks for this bug report, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cltlfcjin&quot; class=&quot;user-hover&quot; rel=&quot;cltlfcjin&quot;&gt;cltlfcjin&lt;/a&gt;. We we running into &quot;FetchFailedException: Received a zero-size buffer for block shuffle_0_0_332 from BlockManagerId&quot; and this bug report gave us enough of the hint to try &lt;tt&gt;config.set(&quot;spark.kryo.unsafe&quot;, &quot;false&quot;)&lt;/tt&gt; which worked-around the issue.&lt;/p&gt;</comment>
                            <comment id="16806841" author="cltlfcjin" created="Mon, 1 Apr 2019 14:23:42 +0000"  >&lt;p&gt;Thanks for reporting this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aallen&quot; class=&quot;user-hover&quot; rel=&quot;aallen&quot;&gt;aallen&lt;/a&gt;. It&apos;s a bug of RoaringBitmap-0.5.11. I&apos;ve filed PR #24264 to fix it. I believe it could be worked-around by upgrading the RoaringBitmap jar to latest version manually if you still need spark.kryo.unsafe=true&lt;/p&gt;</comment>
                            <comment id="16807181" author="irashid" created="Mon, 1 Apr 2019 20:54:40 +0000"  >&lt;p&gt;Any chance you know what the issue in roaring bitmap is?  Just wondering as it is a pretty large version bump.&lt;/p&gt;

&lt;p&gt;BTW, 0.7.45 also seems to have some big performance improvements (&lt;a href=&quot;https://github.com/RoaringBitmap/RoaringBitmap/pull/320&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/RoaringBitmap/RoaringBitmap/pull/320&lt;/a&gt;) for deserialization, it might be worth considering changing spark to take advantage of that (definitely a separate issue, might not even matter for the way spark uses roaring bitmap anyway ...)&lt;/p&gt;</comment>
                            <comment id="16807400" author="cltlfcjin" created="Tue, 2 Apr 2019 04:18:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=irashid&quot; class=&quot;user-hover&quot; rel=&quot;irashid&quot;&gt;irashid&lt;/a&gt; Not yet. It&apos;s petty challenging to find out it without JIRA This fixing is much important than performance since it causes job failed (2.4 and above) or data quality problem (2.1~2.3 AFAIK) when using unsafe KryoSerializer. I don&apos;t know which version is the proper one, so I simply use latest version. Anyway, Spark is not a heavy user on this lib. Why not replace it is due to compatibility consideration.&lt;/p&gt;</comment>
                            <comment id="16807749" author="irashid" created="Tue, 2 Apr 2019 13:15:21 +0000"  >&lt;p&gt;I think its probably fine to upgrade it, I just wanted to check if we knew what the issue was.&lt;/p&gt;

&lt;p&gt;Though spark only uses this library in one spot, its a pretty important one &amp;#8211; managing MapStatus is a major source of pressure on the driver on large clusters.&lt;/p&gt;</comment>
                            <comment id="16809415" author="irashid" created="Thu, 4 Apr 2019 01:11:21 +0000"  >&lt;p&gt;Fixed by &lt;a href=&quot;https://github.com/apache/spark/pull/24264&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/24264&lt;/a&gt; in master / 3.0.0&lt;/p&gt;</comment>
                            <comment id="16825782" author="joshrosen" created="Thu, 25 Apr 2019 06:38:22 +0000"  >&lt;p&gt;I&apos;ve added the &lt;tt&gt;correctness&lt;/tt&gt; label to this ticket because it sounds like it can cause query correctness issues in pre-2.4 versions of Spark (for example, I think&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-23178&quot; title=&quot;Kryo Unsafe problems with count distinct from cache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-23178&quot;&gt;&lt;del&gt;SPARK-23178&lt;/del&gt;&lt;/a&gt;&#160;might be a report of this).&lt;/p&gt;

&lt;p&gt;Note for future readers: this problem only occurs in a non-default configuration (the default is &lt;tt&gt;spark.kryo.unsafe == false&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;/cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smilegator&quot; class=&quot;user-hover&quot; rel=&quot;smilegator&quot;&gt;smilegator&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16825788" author="smilegator" created="Thu, 25 Apr 2019 06:44:14 +0000"  >&lt;p&gt;Thanks, Josh! We will add it to the release note. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13229219">SPARK-27530</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13156718">SPARK-24160</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13226010">SPARK-27367</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13229219">SPARK-27530</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13132671">SPARK-23178</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 29 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z00wnc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>