<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:31:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-41187] [Core] LiveExecutor MemoryLeak in AppStatusListener when ExecutorLost happen</title>
                <link>https://issues.apache.org/jira/browse/SPARK-41187</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;We have a long running thriftserver, which we found memory leak happened. One of the memory leak is like below.  &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13052352/13052352_image-2022-11-18-10-57-49-230.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;The event queue size in our prod env is set to very large to avoid message drop, but we still find the message drop in log. And the event processing time is very long , event is accumulated in queue.&lt;/p&gt;

&lt;p&gt;In heap dump we found LiveExecutor&#160; instances number is also become very huge. After check the heap dump, Finally we found the reason.&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13052353/13052353_image-2022-11-18-11-01-57-435.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;The reason is:&lt;/p&gt;

&lt;p&gt;For a shuffle map stage tasks, if a executor lost happen,&#160; the finished task will be resubmitted, and send out a taskEnd Message with reason &quot;Resubmitted&quot; in TaskSetManager.scala, this will cause the&#160; activeTask in AppStatusListner&apos;s liveStage become negative&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
override def executorLost(execId: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, host: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, reason: ExecutorLossReason): Unit = {
  &lt;span class=&quot;code-comment&quot;&gt;// Re-enqueue any tasks that ran on the failed executor &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is a shuffle map stage,
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// and we are not using an external shuffle server which could serve the shuffle outputs.
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// The reason is the next stage wouldn&apos;t be able to fetch the data from &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; dead executor
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// so we would need to rerun these tasks on other executors.
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isShuffleMapTasks &amp;amp;&amp;amp; !env.blockManager.externalShuffleServiceEnabled &amp;amp;&amp;amp; !isZombie) {
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; ((tid, info) &amp;lt;- taskInfos &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; info.executorId == execId) {
      val index = info.index
      &lt;span class=&quot;code-comment&quot;&gt;// We may have a running task whose partition has been marked as successful,
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; partition has another task completed in another stage attempt.
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// We treat it as a running task and will call handleFailedTask later.
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (successful(index) &amp;amp;&amp;amp; !info.running &amp;amp;&amp;amp; !killedByOtherAttempt.contains(tid)) {
        successful(index) = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
        copiesRunning(index) -= 1
        tasksSuccessful -= 1
        addPendingTask(index)
        &lt;span class=&quot;code-comment&quot;&gt;// Tell the DAGScheduler that &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; task was resubmitted so that it doesn&apos;t think our
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// stage finishes when a total of tasks.size tasks finish.
&lt;/span&gt;        sched.dagScheduler.taskEnded(
          tasks(index), Resubmitted, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, Seq.empty, Array.empty, info)
      }
    }
  }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13052354/13052354_image-2022-11-18-11-09-34-760.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;if liveStage activeTask is negative, it will never be removed, thus cause the executor moved to deadExecutors will never to removed, cause it need to check there is no stage submission less than its remove time before removed.&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;/** Was the specified executor active &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; any currently live stages? */&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; def isExecutorActiveForLiveStages(exec: LiveExecutor): &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; = {
  liveStages.values.asScala.exists { stage =&amp;gt;
    stage.info.submissionTime.getOrElse(0L) &amp;lt; exec.removeTime.getTime
  }
} 

override def onStageCompleted(event: SparkListenerStageCompleted): Unit = {
  .....

  &lt;span class=&quot;code-comment&quot;&gt;// remove any dead executors that were not running &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; any currently active stages
&lt;/span&gt;  deadExecutors.retain((execId, exec) =&amp;gt; isExecutorActiveForLiveStages(exec))
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Add the corresponding logs in prod env as attachment. The resubmitted task number is equals to the activeTasks in heap dump for that stage.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13053103/13053103_image-20221113232214179.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13053102/13053102_image-20221113232233952.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Hope I describe it clear, I will create a pull request later,&#160; we just ignore the resubmitted message in AppStatusListener to fix it.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13503315">SPARK-41187</key>
            <summary>[Core] LiveExecutor MemoryLeak in AppStatusListener when ExecutorLost happen</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yimo_yym">wineternity</assignee>
                                    <reporter username="yimo_yym">wineternity</reporter>
                        <labels>
                    </labels>
                <created>Fri, 18 Nov 2022 02:42:32 +0000</created>
                <updated>Mon, 12 Dec 2022 04:54:03 +0000</updated>
                            <resolved>Mon, 12 Dec 2022 04:54:03 +0000</resolved>
                                    <version>3.1.2</version>
                    <version>3.2.0</version>
                    <version>3.1.3</version>
                    <version>3.3.1</version>
                                    <fixVersion>3.3.2</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17635638" author="apachespark" created="Fri, 18 Nov 2022 03:38:42 +0000"  >&lt;p&gt;User &apos;wineternity&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/38702&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/38702&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17638495" author="yimo_yym" created="Fri, 25 Nov 2022 05:16:01 +0000"  >&lt;p&gt;Add the corresponding logs in prod env as attachment. The resubmitted task number is equals to the activeTasks in heap dump for that stage.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13052352" name="image-2022-11-18-10-57-49-230.png" size="281999" author="yimo_yym" created="Fri, 18 Nov 2022 02:57:51 +0000"/>
                            <attachment id="13052353" name="image-2022-11-18-11-01-57-435.png" size="383173" author="yimo_yym" created="Fri, 18 Nov 2022 03:01:59 +0000"/>
                            <attachment id="13052354" name="image-2022-11-18-11-09-34-760.png" size="606122" author="yimo_yym" created="Fri, 18 Nov 2022 03:09:36 +0000"/>
                            <attachment id="13053103" name="image-20221113232214179.png" size="433356" author="yimo_yym" created="Fri, 25 Nov 2022 05:17:26 +0000"/>
                            <attachment id="13053102" name="image-20221113232233952.png" size="1743473" author="yimo_yym" created="Fri, 25 Nov 2022 05:18:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 50 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ca3s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>