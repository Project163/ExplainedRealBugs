<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:48:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-52516] Memory Leak with coalesce foreachpartitions and v2 datasources</title>
                <link>https://issues.apache.org/jira/browse/SPARK-52516</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Doing the following should not leak any significant amount of memory.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
sparkSession.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select * from icebergcatalog.db.table&quot;&lt;/span&gt;).coalesce(4).foreachPartition( 
    (iterator) -&amp;gt; { &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (iterator.hasNext()) iterator.next(); }
); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Some of the details of this are contained in this thread here&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/iceberg/issues/13297&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/iceberg/issues/13297&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In summary there is a bug where adding a heavy reference in&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
context.addTaskCompletionListener&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;can lead to an OOM as the callback is preventing garbage collection of those heavy references. In particular doing a coalesce piles up &quot;sub-tasks&quot; such that they cannot be cleaned up until the coalesce task completes.&lt;/p&gt;

&lt;p&gt;This same issue manifested in 2 different scala classes&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
sql/core/src/main/scala/org/apache/spark/sql/execution/datasources/v2/DataSourceRDD.scala
sql/core/src/main/scala/org/apache/spark/sql/execution/datasources/v2/parquet/ParquetPartitionReaderFactory.scala &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Iceberg is affected by the first but using the v2 parquet readers are affected by the 2nd.&lt;/p&gt;

&lt;p&gt;The proposed solution is to use a delegate class to de-reference the heavy objects on iterator exhaustion or close. Which only requires changes local to those classes without any public api changes.&lt;/p&gt;

&lt;p&gt;The proposed changes were tested on spark 3.4.X but not on 4.0.0 But I believe 4.0.0 is likely impacted.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13621147">SPARK-52516</key>
            <summary>Memory Leak with coalesce foreachpartitions and v2 datasources</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="viirya">L. C. Hsieh</assignee>
                                    <reporter username="jkolash">Joshua Kolash</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 17 Jun 2025 19:24:42 +0000</created>
                <updated>Fri, 18 Jul 2025 15:53:57 +0000</updated>
                            <resolved>Fri, 18 Jul 2025 15:53:10 +0000</resolved>
                                    <version>3.4.3</version>
                                    <fixVersion>4.1.0</fixVersion>
                    <fixVersion>4.0.1</fixVersion>
                    <fixVersion>3.5.7</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17984986" author="JIRAUSER310043" created="Fri, 20 Jun 2025 15:39:26 +0000"  >&lt;p&gt;This gist can be used to generate synthetic data to reproduce the issue.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://gist.github.com/jkolash/c13d48f97657787068bedc464e0c43c4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/jkolash/c13d48f97657787068bedc464e0c43c4&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I need to write the tests that can reproduce this that run in either in spark or a separate project.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="13623517">SPARK-52809</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            20 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1wde0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>