<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:40:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-13806] SQL round() produces incorrect results for negative values</title>
                <link>https://issues.apache.org/jira/browse/SPARK-13806</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Round in catalyst/expressions/mathExpressions.scala appears to be untested with negative values, and it doesn&apos;t handle them correctly.&lt;/p&gt;

&lt;p&gt;There are at least two issues here:&lt;/p&gt;

&lt;p&gt;First, in the genCode for FloatType and DoubleType with _scale == 0, round() will not produce the same results as for the BigDecimal.ROUND_HALF_UP strategy used in all other cases.  This is because Math.round is used for these _scale == 0 cases.  For example, Math.round(-3.5) is -3, while BigDecimal.ROUND_HALF_UP at scale 0 for -3.5 is -4. &lt;/p&gt;

&lt;p&gt;Even after this bug is fixed with something like...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (${ce.value} &amp;lt; 0) {
  ${ev.value} = -1 * &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.round(-1 * ${ce.value});
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
  ${ev.value} = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.round(${ce.value});
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;...which will allow an additional test like this to succeed in MathFunctionsSuite.scala:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;checkEvaluation(Round(-3.5D, 0), -4.0D, EmptyRow)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;...there still appears to be a problem on at least the checkEvalutionWithUnsafeProjection path, where failures like this are produced:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Incorrect evaluation in unsafe mode: round(-3.141592653589793, -6), actual: [0,0], expected: [0,8000000000000000] (ExpressionEvalHelper.scala:145)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; </description>
                <environment></environment>
        <key id="12948952">SPARK-13806</key>
            <summary>SQL round() produces incorrect results for negative values</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davies">Davies Liu</assignee>
                                    <reporter username="markhamstra">Mark Hamstra</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Mar 2016 23:43:05 +0000</created>
                <updated>Wed, 23 Mar 2016 18:35:28 +0000</updated>
                            <resolved>Tue, 22 Mar 2016 23:50:27 +0000</resolved>
                                    <version>1.6.0</version>
                    <version>1.6.1</version>
                    <version>2.0.0</version>
                                    <fixVersion>1.5.3</fixVersion>
                    <fixVersion>1.6.2</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15205103" author="davies" created="Mon, 21 Mar 2016 20:51:06 +0000"  >&lt;p&gt;This is because round() in Java/Scala have different sematics than Database, we should figure out that&apos;s the right behavior first.  cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rxin&quot; class=&quot;user-hover&quot; rel=&quot;rxin&quot;&gt;rxin&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15205134" author="markhamstra" created="Mon, 21 Mar 2016 21:03:19 +0000"  >&lt;p&gt;Yes, there is the mostly orthogonal question about which rounding strategy should be used &amp;#8211; see the comments in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-8279&quot; title=&quot;udf_round_3 test fails&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-8279&quot;&gt;&lt;del&gt;SPARK-8279&lt;/del&gt;&lt;/a&gt;.  But, assuming that we are adopting the ROUND_HALF_UP strategy, there is the problem with negative values that this JIRA points out: When using ROUND_HALF_UP and scale == 0, -x.5 must round to -(x+1), but Math.round will round it to -x.&lt;/p&gt;

&lt;p&gt;In addition to this, the code gen for rounding of negative floating point values with negative scales is broken.&lt;/p&gt;

&lt;p&gt;All of this stems from Spark SQL&apos;s implementation of round() being untested with negative values. &lt;/p&gt;</comment>
                            <comment id="15206926" author="apachespark" created="Tue, 22 Mar 2016 18:10:04 +0000"  >&lt;p&gt;User &apos;davies&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/11894&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/11894&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15207556" author="davies" created="Tue, 22 Mar 2016 23:50:27 +0000"  >&lt;p&gt;Issue resolved by pull request 11894&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/11894&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/11894&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 34 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2uhuv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>