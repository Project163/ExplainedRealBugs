<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:57:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-22587] Spark job fails if fs.defaultFS and application jar are different url</title>
                <link>https://issues.apache.org/jira/browse/SPARK-22587</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Spark Job fails if the fs.defaultFs and url where application jar resides are different and having same scheme,&lt;/p&gt;

&lt;p&gt;spark-submit  --conf spark.master=yarn-cluster wasb://XXX/tmp/test.py&lt;/p&gt;

&lt;p&gt;core-site.xml fs.defaultFS is set to wasb:///YYY. Hadoop list works (hadoop fs -ls) works for both the url XXX and YYY.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.lang.IllegalArgumentException: Wrong FS: wasb:&lt;span class=&quot;code-comment&quot;&gt;//XXX/tmp/test.py, expected: wasb://YYY 
&lt;/span&gt;at org.apache.hadoop.fs.FileSystem.checkPath(FileSystem.java:665) 
at org.apache.hadoop.fs.azure.NativeAzureFileSystem.checkPath(NativeAzureFileSystem.java:1251) 
at org.apache.hadoop.fs.FileSystem.makeQualified(FileSystem.java:485) 
at org.apache.spark.deploy.yarn.Client.copyFileToRemote(Client.scala:396) 
at org.apache.spark.deploy.yarn.Client.org$apache$spark$deploy$yarn$Client$$distribute$1(Client.scala:507) 
at org.apache.spark.deploy.yarn.Client.prepareLocalResources(Client.scala:660) 
at org.apache.spark.deploy.yarn.Client.createContainerLaunchContext(Client.scala:912) 
at org.apache.spark.deploy.yarn.Client.submitApplication(Client.scala:172) 
at org.apache.spark.deploy.yarn.Client.run(Client.scala:1248) 
at org.apache.spark.deploy.yarn.Client$.main(Client.scala:1307) 
at org.apache.spark.deploy.yarn.Client.main(Client.scala) 
at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) 
at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) 
at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) 
at java.lang.reflect.Method.invoke(Method.java:498) 
at org.apache.spark.deploy.SparkSubmit$.org$apache$spark$deploy$SparkSubmit$$runMain(SparkSubmit.scala:751) 
at org.apache.spark.deploy.SparkSubmit$.doRunMain$1(SparkSubmit.scala:187) 
at org.apache.spark.deploy.SparkSubmit$.submit(SparkSubmit.scala:212) 
at org.apache.spark.deploy.SparkSubmit$.main(SparkSubmit.scala:126) 
at org.apache.spark.deploy.SparkSubmit.main(SparkSubmit.scala) 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The code Client.copyFileToRemote tries to resolve the path of application jar (XXX) from the FileSystem object created using fs.defaultFS url (YYY) instead of the actual url of application jar.&lt;/p&gt;

&lt;p&gt;val destFs = destDir.getFileSystem(hadoopConf)&lt;br/&gt;
val srcFs = srcPath.getFileSystem(hadoopConf)&lt;/p&gt;

&lt;p&gt;getFileSystem will create the filesystem based on the url of the path and so this is fine. But the below lines of code tries to get the srcPath (XXX url) from the destFs (YYY url) and so it fails.&lt;/p&gt;

&lt;p&gt;var destPath = srcPath&lt;br/&gt;
val qualifiedDestPath = destFs.makeQualified(destPath)&lt;/p&gt;

</description>
                <environment></environment>
        <key id="13120391">SPARK-22587</key>
            <summary>Spark job fails if fs.defaultFS and application jar are different url</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="merlin">Mingjie Tang</assignee>
                                    <reporter username="prabhujoseph">Prabhu Joseph</reporter>
                        <labels>
                    </labels>
                <created>Thu, 23 Nov 2017 06:17:40 +0000</created>
                <updated>Wed, 23 Oct 2019 16:15:18 +0000</updated>
                            <resolved>Thu, 11 Jan 2018 04:03:02 +0000</resolved>
                                    <version>1.6.3</version>
                                    <fixVersion>2.3.0</fixVersion>
                                    <component>Spark Submit</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16264118" author="srowen" created="Thu, 23 Nov 2017 10:19:59 +0000"  >&lt;p&gt;Hm, but if the src and dest FS are different, it overwrites destPath to be a path relative to destDir. I am not sure if that is the actual problem.&lt;br/&gt;
Is it that compareFs believes incorrectly that these represent the same FS?&lt;br/&gt;
If so then I do wonder if it makes sense to always set &lt;tt&gt;destPath = new Path(destDir, destName.getOrElse(srcPath.getName()))&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;This is some old logic from Sandy; maybe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vanzin&quot; class=&quot;user-hover&quot; rel=&quot;vanzin&quot;&gt;vanzin&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=steve_l&quot; class=&quot;user-hover&quot; rel=&quot;steve_l&quot;&gt;steve_l&lt;/a&gt; has an opinion on the logic here.&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/blob/master/resource-managers/yarn/src/main/scala/org/apache/spark/deploy/yarn/Client.scala#L356&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/resource-managers/yarn/src/main/scala/org/apache/spark/deploy/yarn/Client.scala#L356&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16264986" author="jerryshao" created="Fri, 24 Nov 2017 06:51:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=prabhujoseph&quot; class=&quot;user-hover&quot; rel=&quot;prabhujoseph&quot;&gt;prabhujoseph&lt;/a&gt;, I think it is because the logic of comparing two FS &lt;tt&gt;compareFs&lt;/tt&gt; is not worked as expected for wasb, it identifies these two FSs as the same FS, but in fact they&apos;re two FSs. that&apos;s why the following &lt;tt&gt;makeQualified&lt;/tt&gt; will throw an exception.&lt;/p&gt;</comment>
                            <comment id="16266674" author="stevel@apache.org" created="Mon, 27 Nov 2017 11:39:47 +0000"  >&lt;p&gt;Jerry had already pulled me in for this; it&apos;s one of those little &quot;pits of semantics&quot; you can get pulled into, &quot;the incident pit&quot; as they call it in SCUBA.&lt;/p&gt;

&lt;p&gt;summary: You need a case insensitive check for schema and serInfo too, maybe even port. &lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Allow for null though.&lt;/li&gt;
	&lt;li&gt;an consider using &lt;tt&gt;FileSystem.makeQualified(path)&lt;/tt&gt; as the safety check&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;What does Hadoop get up to?&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;FileSystem.checkPath does a full check of (scheme, authority), with the auth of the canonicalized URI (including default ports) (so hdfs://namnode/ and hdfs://namenode:9820/ refer to the same FS. That code dates from 2008, so should be considered normative.&lt;/li&gt;
	&lt;li&gt;S3AFilesSystem.checkPath only looks at hostnames, because it tries to strip out user:password from Paths for security reasons&lt;/li&gt;
	&lt;li&gt;Wasb uses FileSystem.checkPath, but does some hacks to also handle an older scheme of &quot;asv&quot;. I wouldn&apos;t worry about that little detail though&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;AbstractFileSystem.checkPath&lt;/tt&gt; (the FileContext implementation code) doesn&apos;t check auth, it looks at host and mentions the fact that on a &lt;a href=&quot;file://&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file://&lt;/a&gt; reference the host may be null. Raises &lt;tt&gt;InvalidPathException&lt;/tt&gt; (subclass of &lt;tt&gt;IllegalArgumentException&lt;/tt&gt; if its unhappy.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Overall then: check auth with an .equalsIgnoreCase(), allow for null. Worry about default ports if you really want to. &lt;/p&gt;

&lt;p&gt;Filed &lt;a href=&quot;https://issues.apache.org/jira/browse/HADOOP-15070&quot; title=&quot;add test to verify FileSystem and paths differentiate on user info&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HADOOP-15070&quot;&gt;&lt;del&gt;HADOOP-15070&lt;/del&gt;&lt;/a&gt; to cover this whole area better in docs &amp;amp; tests, should make the FileContext/FileSystem checks consistent and raise the same InvalidPathException.&lt;/p&gt;

&lt;p&gt;One thing to consider is adding to the FS APIs some predicate &lt;tt&gt;isFileSystemPath(Path p)&lt;/tt&gt; to do the validation without the overhead of exception throwing, and implement it in one single (consistent) place. Wouldn&apos;t be there until Hadoop 3.1 though, so not of any immediate benefit.&lt;/p&gt;

&lt;p&gt;thank you for bringing this undocumented, unspecified, untested and inconsistent logic to my attention &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16266697" author="stevel@apache.org" created="Mon, 27 Nov 2017 12:00:58 +0000"  >&lt;p&gt;See also &lt;a href=&quot;https://github.com/apache/hadoop/blob/trunk/hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/FileSystem.java#L3530&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;FileSystem.CACHE.Key.isEqual()&lt;/a&gt; is how the filesystem cache compares things (scheme + auth + UGI of owner of the FS).&lt;/p&gt;

&lt;p&gt;FileSystem doesn&apos;t implement it&apos;s own .equals operator, nor do any subclasses: they rely on Object.equals. So if you compare that then the cache will return the same FS instance for both (assuming the conf didn&apos;t disable caching). &lt;/p&gt;

&lt;p&gt;You could probably implement a reliable check as follows&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      srcFs.makeQualified(destFs.getWorkingDir())))
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; IllegalArgumentException =&amp;gt;
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Not ideal, as the false response is expensive, but given if the two filesystems are different the client will copy the file, then the cost of raising an exception is lost in the noise&lt;/p&gt;</comment>
                            <comment id="16273745" author="merlin" created="Fri, 1 Dec 2017 00:49:16 +0000"  >&lt;p&gt;we can update the compareFS by considering the authority. &lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/blob/master/resource-managers/yarn/src/main/scala/org/apache/spark/deploy/yarn/Client.scala#L1442&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/resource-managers/yarn/src/main/scala/org/apache/spark/deploy/yarn/Client.scala#L1442&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The PR is sent out. &lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19885&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19885&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16277787" author="apachespark" created="Tue, 5 Dec 2017 00:02:04 +0000"  >&lt;p&gt;User &apos;merlintang&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19885&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19885&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13123167">HADOOP-15094</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13120898">HADOOP-15070</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 50 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3n4kf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>