<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:58:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-23310] Perf regression introduced by SPARK-21113</title>
                <link>https://issues.apache.org/jira/browse/SPARK-23310</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;While running all TPC-DS queries with SF set to 1000, we noticed that Q95 (&lt;a href=&quot;https://github.com/databricks/spark-sql-perf/blob/master/src/main/resources/tpcds_2_4/q95.sql&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/databricks/spark-sql-perf/blob/master/src/main/resources/tpcds_2_4/q95.sql&lt;/a&gt;) has noticeable regression (11%). After looking into it, we found that the regression was introduced by&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-21113&quot; title=&quot;Support for read ahead input stream to amortize disk IO cost in the Spill reader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-21113&quot;&gt;&lt;del&gt;SPARK-21113&lt;/del&gt;&lt;/a&gt;. Specially,&#160;ReadAheadInputStream gets lock congestion. After setting spark.unsafe.sorter.spill.read.ahead.enabled set to false, the regression disappear and the overall performance of all TPC-DS queries has improved.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I am proposing that we&#160;set&#160;spark.unsafe.sorter.spill.read.ahead.enabled to false by default for Spark 2.3 and re-enable it after addressing the lock congestion issue.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13135668">SPARK-23310</key>
            <summary>Perf regression introduced by SPARK-21113</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="11">Done</resolution>
                                        <assignee username="sitalkedia@gmail.com">Sital Kedia</assignee>
                                    <reporter username="yhuai">Yin Huai</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 Feb 2018 02:10:42 +0000</created>
                <updated>Mon, 12 Feb 2018 18:35:26 +0000</updated>
                            <resolved>Mon, 5 Feb 2018 18:21:34 +0000</resolved>
                                    <version>2.3.0</version>
                                    <fixVersion>2.3.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="16349679" author="yhuai" created="Fri, 2 Feb 2018 02:19:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sitalkedia%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;sitalkedia@gmail.com&quot;&gt;sitalkedia@gmail.com&lt;/a&gt; We found that the commit for &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-21113&quot; title=&quot;Support for read ahead input stream to amortize disk IO cost in the Spill reader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-21113&quot;&gt;&lt;del&gt;SPARK-21113&lt;/del&gt;&lt;/a&gt; introduced a noticeable regression. Because Q95 is a join heavy join, which represents one set of common workloads, I am concerned that this regression is quite easy to hit by users of Spark 2.3. Considering that setting&#160;spark.unsafe.sorter.spill.read.ahead.enabled to false improves the overall performance of all TPC-DS queries, how about we set&#160;spark.unsafe.sorter.spill.read.ahead.enabled to false by default in Spark 2.3? Then, we can look into how to resolve this regression for Spark 2.4. What do you think?&lt;/p&gt;

&lt;p&gt;(Feel free to enable it for your workloads because they will definitely help Spark to improve this part &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; )&lt;/p&gt;</comment>
                            <comment id="16350875" author="sitalkedia@gmail.com" created="Fri, 2 Feb 2018 19:54:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhuai&quot; class=&quot;user-hover&quot; rel=&quot;yhuai&quot;&gt;yhuai&lt;/a&gt; - Sorry about introducing the regression for TPC-DS queries. Let&apos;s set&#160;spark.unsafe.sorter.spill.read.ahead.enabled to false to unblock the release.&#160; Let me know if you want me to make a PR or you can do it yourself.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&amp;gt;&amp;gt;&#160;ReadAheadInputStream gets lock congestion&lt;/p&gt;

&lt;p&gt;BTW, do you have idea where the lock contention is occuring? I will file a separate Jira and work on fixing it.&lt;/p&gt;</comment>
                            <comment id="16351048" author="sameerag" created="Fri, 2 Feb 2018 23:18:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sitalkedia%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;sitalkedia@gmail.com&quot;&gt;sitalkedia@gmail.com&lt;/a&gt;&#160;it&apos;d be great if you can create the patch.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=npoggi&quot; class=&quot;user-hover&quot; rel=&quot;npoggi&quot;&gt;npoggi&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=juliuszsompolski&quot; class=&quot;user-hover&quot; rel=&quot;juliuszsompolski&quot;&gt;juliuszsompolski&lt;/a&gt; who can give more context on the bug they found.&lt;/p&gt;</comment>
                            <comment id="16351071" author="npoggi" created="Fri, 2 Feb 2018 23:44:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sitalkedia%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;sitalkedia@gmail.com&quot;&gt;sitalkedia@gmail.com&lt;/a&gt; we have found around 18% higher time in &lt;a href=&quot;https://github.com/databricks/spark-sql-perf/blob/master/src/main/resources/tpcds_2_4/q95.sql&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Q95&lt;/a&gt; of TPC-DS at least at scale factor 1000 (1TB). From 348.3. to 422.6s with the setting ON.&#160; The regression is in {{&lt;font color=&quot;#24292e&quot;&gt;ReadAheadInputStream.read}}, and &lt;/font&gt;seems to happen when reading a small amounts of data due to checks and locks.&#160;&#160; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=juliuszsompolski&quot; class=&quot;user-hover&quot; rel=&quot;juliuszsompolski&quot;&gt;juliuszsompolski&lt;/a&gt; can provide more internal details.&lt;/p&gt;

&lt;p&gt;Overall for TPC-DS SF 1000, we don&apos;t see any significat improvement (over 5%) with the feature ON in the rest of the queries.&#160; But of course other workloads can probably improve.&lt;/p&gt;</comment>
                            <comment id="16351097" author="sitalkedia@gmail.com" created="Sat, 3 Feb 2018 00:09:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/spark/pull/20492&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/20492&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16351207" author="apachespark" created="Sat, 3 Feb 2018 02:44:03 +0000"  >&lt;p&gt;User &apos;sitalkedia&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/20492&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/20492&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16352723" author="sameerag" created="Mon, 5 Feb 2018 18:21:34 +0000"  >&lt;p&gt;Issue resolved by pull request&#160;20492 &lt;a href=&quot;https://github.com/apache/spark/pull/20492&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/20492&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16352754" author="kiszk" created="Mon, 5 Feb 2018 18:44:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=juliuszsompolski&quot; class=&quot;user-hover&quot; rel=&quot;juliuszsompolski&quot;&gt;juliuszsompolski&lt;/a&gt; We would appreciate it if you would post internal detail for future analysis and fixes.&lt;/p&gt;</comment>
                            <comment id="16353338" author="apachespark" created="Tue, 6 Feb 2018 04:31:03 +0000"  >&lt;p&gt;User &apos;ueshin&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/20514&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/20514&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16357890" author="juliuszsompolski" created="Fri, 9 Feb 2018 04:00:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kiszk&quot; class=&quot;user-hover&quot; rel=&quot;kiszk&quot;&gt;kiszk&lt;/a&gt; I raised &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-23366&quot; title=&quot;Improve hot reading path in ReadAheadInputStream&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-23366&quot;&gt;&lt;del&gt;SPARK-23366&lt;/del&gt;&lt;/a&gt; and submitted &lt;a href=&quot;https://github.com/apache/spark/pull/20555&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/20555&lt;/a&gt;&#160;against it.&lt;/p&gt;</comment>
                            <comment id="16359429" author="kiszk" created="Sat, 10 Feb 2018 13:54:02 +0000"  >&lt;p&gt;got it, thanks&lt;/p&gt;</comment>
                            <comment id="16361071" author="npoggi" created="Mon, 12 Feb 2018 16:59:07 +0000"  >&lt;p&gt;Q72 of TPC-DS is also affected around 30% at scale factor 1000. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=juliuszsompolski&quot; class=&quot;user-hover&quot; rel=&quot;juliuszsompolski&quot;&gt;juliuszsompolski&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-23366&quot; title=&quot;Improve hot reading path in ReadAheadInputStream&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-23366&quot;&gt;&lt;del&gt;SPARK-23366&lt;/del&gt;&lt;/a&gt; also fixes it.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310460">
                    <name>Child-Issue</name>
                                            <outwardlinks description="is a parent of">
                                        <issuelink>
            <issuekey id="13137334">SPARK-23366</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13080235">SPARK-21113</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 40 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3pp1z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12339551">2.3.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>