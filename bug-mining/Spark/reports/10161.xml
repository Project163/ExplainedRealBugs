<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:47:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-51272] Race condition in DagScheduler can result in failure of retrying all partitions for non deterministic partitioning key</title>
                <link>https://issues.apache.org/jira/browse/SPARK-51272</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;In DagScheduler, where a successful task completion occurs concurrently with a task failure , for an inDeterminate stage, results in a situation , where instead of re-executing all partitions, only some are retried. This results in data loss.&lt;br/&gt;
The race condition identified is as follows:&lt;br/&gt;
a) A successful result stage task, is yet to mark in the boolean array tracking partitions success/failure as true/false.&lt;br/&gt;
b) A concurrent failed result task, belonging to an InDeterminate stage, idenitfies all the stages which needs/ can be rolled back. For Result Stage, it looks into the array of successful partitions. As none is marked as true, the ResultStage and dependent stages are delegated to thread pool for retry.&lt;br/&gt;
c) Between the time of collecting stages to rollback and re-try of stages, the successful task marks boolean as true.&lt;br/&gt;
d) The Retry of Stage, as a result, misses the partition marked as successful, for retry.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Attaching two files for reproducing the functional bug , showing the race condition causing data corruption.&lt;/p&gt;

&lt;p&gt;I am attaching 2 files for bug test&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;bugrepro.patch&lt;br/&gt;
This is needed to coax the single VM test to reproduce the issue. It has lots of interception and tweaks to ensure that system is able to hit the data loss situation.&lt;br/&gt;
( like each partition writes only a shuffle file containing keys evaluating to same hashCode and deleting the shuffle file at right time etc)&lt;/li&gt;
	&lt;li&gt;The BugTest itself.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;a) If the bugrepro.patch is applied to current master and the BugTest run, it will fail immediately with assertion failure where instead of 12 rows, 6 rows show up in result.&lt;/p&gt;

&lt;p&gt;b) If the bugrepro.patch is applied on top of PR &lt;a href=&quot;https://github.com/apache/spark/pull/50029&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/50029&lt;/a&gt; &#160;, then the BugTest will fail after one or two or more iterations, indicating the race condition in DataScheduler/Stage interaction.&lt;/p&gt;

&lt;p&gt;c) But if the same BugTest is run on branch containing fix for this bug as well as the PR &lt;a href=&quot;https://github.com/apache/spark/pull/50029&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/50029&lt;/a&gt;, it will pass in all the 100 iteration.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13609280">SPARK-51272</key>
            <summary>Race condition in DagScheduler can result in failure of retrying all partitions for non deterministic partitioning key</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="attilapiros">Attila Zsolt Piros</assignee>
                                    <reporter username="ashahid7">Asif</reporter>
                        <labels>
                            <label>pull-request-available</label>
                            <label>spark-core</label>
                    </labels>
                <created>Thu, 20 Feb 2025 23:31:44 +0000</created>
                <updated>Wed, 4 Jun 2025 18:04:56 +0000</updated>
                            <resolved>Tue, 20 May 2025 13:18:59 +0000</resolved>
                                    <version>3.5.4</version>
                                    <fixVersion>3.5.6</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17928944" author="ashahid7" created="Thu, 20 Feb 2025 23:34:03 +0000"  >&lt;p&gt; &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13074898/13074898_BugTest.txt&quot; title=&quot;BugTest.txt attached to SPARK-51272&quot;&gt;BugTest.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;  &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13074899/13074899_bugrepro.patch&quot; title=&quot;bugrepro.patch attached to SPARK-51272&quot;&gt;bugrepro.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; &lt;/p&gt;</comment>
                            <comment id="17952858" author="cloud_fan" created="Tue, 20 May 2025 13:18:59 +0000"  >&lt;p&gt;Issue resolved by pull request 50946&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/50946&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/50946&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17954160" author="dongjoon" created="Mon, 26 May 2025 21:37:29 +0000"  >&lt;p&gt;I added `4.0.0` back to the `Fixed Version` field. It seems to be dropped accidentally.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13076690/13076690_Screenshot+2025-05-26+at+14.36.37.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310360">
                    <name>Dependent</name>
                                            <outwardlinks description="Dependent">
                                        <issuelink>
            <issuekey id="13606434">SPARK-51016</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13074898" name="BugTest.txt" size="7672" author="ashahid7" created="Thu, 20 Feb 2025 23:33:32 +0000"/>
                            <attachment id="13076690" name="Screenshot 2025-05-26 at 14.36.37.png" size="44528" author="dongjoon" created="Mon, 26 May 2025 21:36:49 +0000"/>
                            <attachment id="13074899" name="bugrepro.patch" size="15407" author="ashahid7" created="Thu, 20 Feb 2025 23:34:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            24 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1uclk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>