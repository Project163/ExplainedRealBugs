<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:34:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-44805] Data lost after union using spark.sql.parquet.enableNestedColumnVectorizedReader=true</title>
                <link>https://issues.apache.org/jira/browse/SPARK-44805</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When union-ing two DataFrames read from parquet containing nested structures (2 fields of array types where one is double and second is integer) data from the second field seems to be lost (zeros are set instead).&#160;&lt;/p&gt;

&lt;p&gt;This seems to be the case only if nested vectorised reader is used (spark.sql.parquet.enableNestedColumnVectorizedReader=true).&#160;&lt;/p&gt;

&lt;p&gt;The following Python code reproduces the problem:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
from pyspark.sql &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; SparkSession
from pyspark.sql.types &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; *

# PREPARING DATA
data1 = []
data2 = []

&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; i in range(2):&#160;
&#160; &#160; data1.append( (([1,2,3],[1,1,2]),i))
&#160; &#160; data2.append( (([1.0,2.0,3.0],[1,1]),i+10))

schema1 = StructType([
&#160; &#160; &#160; &#160; StructField(&lt;span class=&quot;code-quote&quot;&gt;&apos;value&apos;&lt;/span&gt;, StructType([
&#160; &#160; &#160; &#160; &#160; &#160; &#160;StructField(&lt;span class=&quot;code-quote&quot;&gt;&apos;f1&apos;&lt;/span&gt;, ArrayType(IntegerType()), True),
&#160; &#160; &#160; &#160; &#160; &#160; &#160;StructField(&lt;span class=&quot;code-quote&quot;&gt;&apos;f2&apos;&lt;/span&gt;, ArrayType(IntegerType()), True) &#160; &#160; &#160; &#160; &#160; &#160;&#160;
&#160; &#160; &#160; &#160; &#160; &#160; &#160;])),
&#160; &#160; &#160; &#160; &#160;StructField(&lt;span class=&quot;code-quote&quot;&gt;&apos;id&apos;&lt;/span&gt;, IntegerType(), True)
])

schema2 = StructType([
&#160; &#160; &#160; &#160; StructField(&lt;span class=&quot;code-quote&quot;&gt;&apos;value&apos;&lt;/span&gt;, StructType([
&#160; &#160; &#160; &#160; &#160; &#160; &#160;StructField(&lt;span class=&quot;code-quote&quot;&gt;&apos;f1&apos;&lt;/span&gt;, ArrayType(DoubleType()), True),
&#160; &#160; &#160; &#160; &#160; &#160; &#160;StructField(&lt;span class=&quot;code-quote&quot;&gt;&apos;f2&apos;&lt;/span&gt;, ArrayType(IntegerType()), True) &#160; &#160; &#160; &#160; &#160; &#160;&#160;
&#160; &#160; &#160; &#160; &#160; &#160; &#160;])),
&#160; &#160; &#160; &#160; &#160;StructField(&lt;span class=&quot;code-quote&quot;&gt;&apos;id&apos;&lt;/span&gt;, IntegerType(), True)
])

spark = SparkSession.builder.getOrCreate()
data_dir = &lt;span class=&quot;code-quote&quot;&gt;&quot;/user/&amp;lt;user&amp;gt;/&quot;&lt;/span&gt;

df1 = spark.createDataFrame(data1, schema1)
df1.write.mode(&lt;span class=&quot;code-quote&quot;&gt;&apos;overwrite&apos;&lt;/span&gt;).parquet(data_dir + &lt;span class=&quot;code-quote&quot;&gt;&quot;data1&quot;&lt;/span&gt;)&#160;
df2 = spark.createDataFrame(data2, schema2)
df2.write.mode(&lt;span class=&quot;code-quote&quot;&gt;&apos;overwrite&apos;&lt;/span&gt;).parquet(data_dir + &lt;span class=&quot;code-quote&quot;&gt;&quot;data2&quot;&lt;/span&gt;)&#160;


# READING DATA
parquet1 = spark.read.parquet(data_dir + &lt;span class=&quot;code-quote&quot;&gt;&quot;data1&quot;&lt;/span&gt;)
parquet2 = spark.read.parquet(data_dir + &lt;span class=&quot;code-quote&quot;&gt;&quot;data2&quot;&lt;/span&gt;)


# UNION
out = parquet1.union(parquet2)


parquet1.select(&lt;span class=&quot;code-quote&quot;&gt;&quot;value.f2&quot;&lt;/span&gt;).distinct().show()
out.select(&lt;span class=&quot;code-quote&quot;&gt;&quot;value.f2&quot;&lt;/span&gt;).distinct().show()
print(parquet1.collect())
print(out.collect()) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Output:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+---------+
|       f2|
+---------+
|[1, 1, 2]|
+---------+

+---------+
|       f2|
+---------+
|[0, 0, 0]|
|   [1, 1]|
+---------+


[
Row(value=Row(f1=[1, 2, 3], f2=[1, 1, 2]), id=0), 
Row(value=Row(f1=[1, 2, 3], f2=[1, 1, 2]), id=1)
]

[
Row(value=Row(f1=[1.0, 2.0, 3.0], f2=[0, 0, 0]), id=0), 
Row(value=Row(f1=[1.0, 2.0, 3.0], f2=[0, 0, 0]), id=1), 
Row(value=Row(f1=[1.0, 2.0, 3.0], f2=[1, 1]), id=10), 
Row(value=Row(f1=[1.0, 2.0, 3.0], f2=[1, 1]), id=11)
] &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Please notice that values for the field f2 are lost after the union is done. This only happens when this data is read from parquet files.&#160;&lt;/p&gt;

&lt;p&gt;Could you please look into this?&#160;&lt;/p&gt;

&lt;p&gt;Best regards,&lt;/p&gt;

&lt;p&gt;Jakub&lt;/p&gt;</description>
                <environment>&lt;p&gt;pySpark, linux, hadoop, parquet.&#160;&lt;/p&gt;</environment>
        <key id="13547273">SPARK-44805</key>
            <summary>Data lost after union using spark.sql.parquet.enableNestedColumnVectorizedReader=true</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bersprockets">Bruce Robbins</assignee>
                                    <reporter username="jwozniak">Jakub Wozniak</reporter>
                        <labels>
                            <label>correctness</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 14 Aug 2023 14:46:53 +0000</created>
                <updated>Wed, 13 Sep 2023 15:32:44 +0000</updated>
                            <resolved>Fri, 8 Sep 2023 20:11:31 +0000</resolved>
                                    <version>3.3.1</version>
                    <version>3.4.1</version>
                                    <fixVersion>3.4.2</fixVersion>
                    <fixVersion>3.5.1</fixVersion>
                    <fixVersion>3.3.4</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17754344" author="bersprockets" created="Tue, 15 Aug 2023 00:14:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sunchao&quot; class=&quot;user-hover&quot; rel=&quot;sunchao&quot;&gt;sunchao&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;It seems to be some weird interaction between Parquet nested vectorization and the &lt;tt&gt;Cast&lt;/tt&gt; expression:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;drop table if exists t1;

create table t1 using parquet as
select * from values
(named_struct(&apos;f1&apos;, array(1, 2, 3), &apos;f2&apos;, array(1, 1, 2)))
as (value);

select value from t1;
{&quot;f1&quot;:[1,2,3],&quot;f2&quot;:[1,1,2]}         &amp;lt;== this is expected
Time taken: 0.126 seconds, Fetched 1 row(s)

select cast(value as struct&amp;lt;f1:array&amp;lt;double&amp;gt;,f2:array&amp;lt;int&amp;gt;&amp;gt;) AS value from t1;
{&quot;f1&quot;:[1.0,2.0,3.0],&quot;f2&quot;:[0,0,0]}   &amp;lt;== this is not expected
Time taken: 0.102 seconds, Fetched 1 row(s)

set spark.sql.parquet.enableNestedColumnVectorizedReader=false;

select cast(value as struct&amp;lt;f1:array&amp;lt;double&amp;gt;,f2:array&amp;lt;int&amp;gt;&amp;gt;) AS value from t1;
{&quot;f1&quot;:[1.0,2.0,3.0],&quot;f2&quot;:[1,1,2]}   &amp;lt;== now has expected value
Time taken: 0.244 seconds, Fetched 1 row(s)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The union operation adds this &lt;tt&gt;Cast&lt;/tt&gt; expression because &lt;tt&gt;value&lt;/tt&gt; has different datatypes between your two dataframes.&lt;/p&gt;</comment>
                            <comment id="17759615" author="jwozniak" created="Mon, 28 Aug 2023 15:21:51 +0000"  >&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;Is it possible to know any ETA on this one?&lt;/p&gt;

&lt;p&gt;Is this something that could potentially be fixed in the next version of Spark or rather not?&#160;&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Jakub&lt;/p&gt;</comment>
                            <comment id="17762234" author="bersprockets" created="Tue, 5 Sep 2023 23:50:13 +0000"  >&lt;p&gt;I looked at this yesterday and I think I have a handle on what&apos;s going on. I will make a PR in the coming days.&lt;/p&gt;</comment>
                            <comment id="17762295" author="jwozniak" created="Wed, 6 Sep 2023 07:30:41 +0000"  >&lt;p&gt;Would be great, thanks!&#160;&lt;/p&gt;</comment>
                            <comment id="17762792" author="bersprockets" created="Thu, 7 Sep 2023 15:47:25 +0000"  >&lt;p&gt;PR here: &lt;a href=&quot;https://github.com/apache/spark/pull/42850&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/42850&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17762935" author="snoot" created="Fri, 8 Sep 2023 03:23:42 +0000"  >&lt;p&gt;User &apos;bersprockets&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/42850&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/42850&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17763253" author="dongjoon" created="Fri, 8 Sep 2023 20:11:31 +0000"  >&lt;p&gt;Issue resolved by pull request 42850&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/42850&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/42850&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 9 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1jrxk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>