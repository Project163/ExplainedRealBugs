<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:06:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-21045] Spark executor blocked instead of throwing exception because exception occur when python worker send exception info to PythonRDD in Python 2+</title>
                <link>https://issues.apache.org/jira/browse/SPARK-21045</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;My pyspark program is always blocking in product yarn cluster. Then I jstack and found :&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;Executor task launch worker &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; task 0&quot;&lt;/span&gt; #60 daemon prio=5 os_prio=31 tid=0x00007fb2f44e3000 nid=0xa003 runnable [0x0000000123b4a000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE
        at java.net.SocketInputStream.socketRead0(Native Method)
        at java.net.SocketInputStream.socketRead(SocketInputStream.java:116)
        at java.net.SocketInputStream.read(SocketInputStream.java:170)
        at java.net.SocketInputStream.read(SocketInputStream.java:141)
        at java.io.BufferedInputStream.fill(BufferedInputStream.java:246)
        at java.io.BufferedInputStream.read(BufferedInputStream.java:265)
        - locked &amp;lt;0x00000007acab1c98&amp;gt; (a java.io.BufferedInputStream)
        at java.io.DataInputStream.readInt(DataInputStream.java:387)
        at org.apache.spark.api.python.PythonRunner$$anon$1.read(PythonRDD.scala:190)
        at org.apache.spark.api.python.PythonRunner$$anon$1.&amp;lt;init&amp;gt;(PythonRDD.scala:234)
        at org.apache.spark.api.python.PythonRunner.compute(PythonRDD.scala:152)
        at org.apache.spark.api.python.PythonRDD.compute(PythonRDD.scala:63)
        at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:323)
        at org.apache.spark.rdd.RDD.iterator(RDD.scala:287)
        at org.apache.spark.scheduler.ResultTask.runTask(ResultTask.scala:87)
        at org.apache.spark.scheduler.Task.run(Task.scala:99)
        at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:322)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It is blocking in socket read.  I view the log on blocking executor and found error:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Traceback (most recent call last):
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/spark/python/lib/pyspark.zip/pyspark/worker.py&quot;&lt;/span&gt;, line 178, in main
    write_with_length(traceback.format_exc().encode(&lt;span class=&quot;code-quote&quot;&gt;&quot;utf-8&quot;&lt;/span&gt;), outfile)
UnicodeDecodeError: &lt;span class=&quot;code-quote&quot;&gt;&apos;ascii&apos;&lt;/span&gt; codec can&apos;t decode &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; 0xe4 in position 618: ordinal not in range(128)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Finally I found the problem:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;worker.py&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    # 178 line in spark 2.1.1
    except Exception:
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;:
            write_int(SpecialLengths.PYTHON_EXCEPTION_THROWN, outfile)
            write_with_length(traceback.format_exc().encode(&lt;span class=&quot;code-quote&quot;&gt;&quot;utf-8&quot;&lt;/span&gt;), outfile)
        except IOError:
            # JVM close the socket
            pass
        except Exception:
            # Write the error to stderr &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it happened &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; serializing
            print(&lt;span class=&quot;code-quote&quot;&gt;&quot;PySpark worker failed with exception:&quot;&lt;/span&gt;, file=sys.stderr)
            print(traceback.format_exc(), file=sys.stderr)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;when write_with_length(traceback.format_exc().encode(&quot;utf-8&quot;), outfile) occur exception like UnicodeDecodeError, the python worker can&apos;t send the trace info, but when the PythonRDD get PYTHON_EXCEPTION_THROWN, It should read the trace info length next. So it is blocking.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;PythonRDD.scala&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    # 190 line in spark 2.1.1
    &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; SpecialLengths.PYTHON_EXCEPTION_THROWN =&amp;gt;
     &lt;span class=&quot;code-comment&quot;&gt;// Signals that an exception has been thrown in python
&lt;/span&gt;     val exLength = stream.readInt()  &lt;span class=&quot;code-comment&quot;&gt;// It is possible to be blocked&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;font color=&quot;red&quot;&gt;&lt;br/&gt;
We can triggle the bug use simple program:&lt;/font&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;test.py&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    spark = SparkSession.builder.master(&lt;span class=&quot;code-quote&quot;&gt;&apos;local&apos;&lt;/span&gt;).getOrCreate()
    rdd = spark.sparkContext.parallelize([&lt;span class=&quot;code-quote&quot;&gt;&apos;&#20013;&apos;&lt;/span&gt;]).map(lambda x: x.encode(&lt;span class=&quot;code-quote&quot;&gt;&quot;utf8&quot;&lt;/span&gt;))
    rdd.collect()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;It has problem only in Python 2+. &lt;br/&gt;
Python 3+ is ok.&lt;/p&gt;</environment>
        <key id="13078844">SPARK-21045</key>
            <summary>Spark executor blocked instead of throwing exception because exception occur when python worker send exception info to PythonRDD in Python 2+</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="advancedxy">YE</assignee>
                                    <reporter username="wangzjie1">Joshuawangzj</reporter>
                        <labels>
                    </labels>
                <created>Sat, 10 Jun 2017 08:36:54 +0000</created>
                <updated>Mon, 12 Dec 2022 18:10:55 +0000</updated>
                            <resolved>Fri, 20 Sep 2019 23:10:46 +0000</resolved>
                                    <version>2.0.1</version>
                    <version>2.0.2</version>
                    <version>2.1.1</version>
                                    <fixVersion>3.0.0</fixVersion>
                                    <component>PySpark</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16045592" author="apachespark" created="Sat, 10 Jun 2017 16:06:03 +0000"  >&lt;p&gt;User &apos;dataknocker&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/18261&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18261&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16045604" author="apachespark" created="Sat, 10 Jun 2017 16:32:03 +0000"  >&lt;p&gt;User &apos;dataknocker&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/18262&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18262&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16051471" author="apachespark" created="Fri, 16 Jun 2017 06:44:04 +0000"  >&lt;p&gt;User &apos;dataknocker&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/18261&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18261&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16051485" author="apachespark" created="Fri, 16 Jun 2017 06:57:03 +0000"  >&lt;p&gt;User &apos;dataknocker&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/18324&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18324&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16934818" author="gurwls223" created="Fri, 20 Sep 2019 23:10:46 +0000"  >&lt;p&gt;Fixed at &lt;a href=&quot;https://github.com/apache/spark/pull/25847&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/25847&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 8 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3g4nb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>