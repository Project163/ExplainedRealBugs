<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:59:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-23569] pandas_udf does not work with type-annotated python functions</title>
                <link>https://issues.apache.org/jira/browse/SPARK-23569</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When invoked against a type annotated function pandas_udf raises:&lt;/p&gt;

&lt;p&gt;`ValueError: Function has keyword-only parameters or annotations, use getfullargspec() API which can support them`&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;the deprecated `getargsspec` call occurs in `pyspark/sql/udf.py`&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
def _create_udf(f, returnType, evalType):

    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; evalType in (PythonEvalType.SQL_SCALAR_PANDAS_UDF,
                    PythonEvalType.SQL_GROUPED_MAP_PANDAS_UDF):
        &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; inspect
        from pyspark.sql.utils &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; require_minimum_pyarrow_version

        require_minimum_pyarrow_version()
        argspec = inspect.getargspec(f)

        ...&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;To reproduce:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
from pyspark.sql &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; SparkSession

from pyspark.sql.functions &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; pandas_udf, PandasUDFType, col, lit

spark = SparkSession.builder.getOrCreate()

df = spark.range(12).withColumn(&lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;, col(&lt;span class=&quot;code-quote&quot;&gt;&apos;id&apos;&lt;/span&gt;) * 2)

def ok(a,b): &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; a*b

df.withColumn(&lt;span class=&quot;code-quote&quot;&gt;&apos;ok&apos;&lt;/span&gt;, pandas_udf(f=ok, returnType=&lt;span class=&quot;code-quote&quot;&gt;&apos;bigint&apos;&lt;/span&gt;)(&lt;span class=&quot;code-quote&quot;&gt;&apos;id&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;)).show()&#160; # no problems

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; pandas as pd

def ok(a: pd.Series,b: pd.Series) -&amp;gt; pd.Series: &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; a*b

df.withColumn(&lt;span class=&quot;code-quote&quot;&gt;&apos;ok&apos;&lt;/span&gt;, pandas_udf(f=ok, returnType=&lt;span class=&quot;code-quote&quot;&gt;&apos;bigint&apos;&lt;/span&gt;)(&lt;span class=&quot;code-quote&quot;&gt;&apos;id&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;))

&#160;

---------------------------------------------------------------------------
ValueError Traceback (most recent call last)
&amp;lt;ipython-input-17-2e6ae67b15ee&amp;gt; in &amp;lt;module&amp;gt;()
----&amp;gt; 1 df.withColumn(&lt;span class=&quot;code-quote&quot;&gt;&apos;ok&apos;&lt;/span&gt;, pandas_udf(f=ok, returnType=&lt;span class=&quot;code-quote&quot;&gt;&apos;bigint&apos;&lt;/span&gt;)(&lt;span class=&quot;code-quote&quot;&gt;&apos;id&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;))

/opt/miniconda/lib/python3.6/site-packages/pyspark/sql/functions.py in pandas_udf(f, returnType, functionType)
2277 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; functools.partial(_create_udf, returnType=return_type, evalType=eval_type)
2278 &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;:
-&amp;gt; 2279 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; _create_udf(f=f, returnType=return_type, evalType=eval_type)
2280
2281

/opt/miniconda/lib/python3.6/site-packages/pyspark/sql/udf.py in _create_udf(f, returnType, evalType)
44
45 require_minimum_pyarrow_version()
---&amp;gt; 46 argspec = inspect.getargspec(f)
47
48 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; evalType == PythonEvalType.SQL_SCALAR_PANDAS_UDF and len(argspec.args) == 0 and \

/opt/miniconda/lib/python3.6/inspect.py in getargspec(func)
1043 getfullargspec(func)
1044 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; kwonlyargs or ann:
-&amp;gt; 1045 raise ValueError(&lt;span class=&quot;code-quote&quot;&gt;&quot;Function has keyword-only parameters or annotations&quot;&lt;/span&gt;
1046 &lt;span class=&quot;code-quote&quot;&gt;&quot;, use getfullargspec() API which can support them&quot;&lt;/span&gt;)
1047 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ArgSpec(args, varargs, varkw, defaults)

ValueError: Function has keyword-only parameters or annotations, use getfullargspec() API which can support them
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;python 3.6 | pyspark 2.3.0 |&#160;Using Scala version 2.11.8, OpenJDK 64-Bit Server VM, 1.8.0_141 |&#160;Revision a0d7949896e70f427e7f3942ff340c9484ff0aab&lt;/p&gt;</environment>
        <key id="13142170">SPARK-23569</key>
            <summary>pandas_udf does not work with type-annotated python functions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mstewart141">Stu (Michael Stewart)</assignee>
                                    <reporter username="mstewart141">Stu (Michael Stewart)</reporter>
                        <labels>
                    </labels>
                <created>Fri, 2 Mar 2018 19:04:35 +0000</created>
                <updated>Mon, 12 Dec 2022 18:10:34 +0000</updated>
                            <resolved>Mon, 5 Mar 2018 04:39:21 +0000</resolved>
                                    <version>2.3.0</version>
                                    <fixVersion>2.3.1</fixVersion>
                    <fixVersion>2.4.0</fixVersion>
                                    <component>PySpark</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16384578" author="gurwls223" created="Sat, 3 Mar 2018 09:34:52 +0000"  >&lt;p&gt;I think it&apos;s because of deprecated&#160;&lt;tt&gt;inspect.getargspec&lt;/tt&gt; in Python 3. Can we replace it to like &lt;tt&gt;inspect.signature&lt;/tt&gt; in Python 3?&lt;/p&gt;</comment>
                            <comment id="16384581" author="gurwls223" created="Sat, 3 Mar 2018 09:35:59 +0000"  >&lt;p&gt;If it&apos;s hard to add a test, manual tests will be fine enough but please add it in PR description. Would you be interested in submitting a PR?&lt;/p&gt;</comment>
                            <comment id="16384857" author="mstewart141" created="Sat, 3 Mar 2018 20:59:22 +0000"  >&lt;p&gt;yes, i&apos;ll give it a go&lt;/p&gt;</comment>
                            <comment id="16384871" author="apachespark" created="Sat, 3 Mar 2018 22:16:04 +0000"  >&lt;p&gt;User &apos;mstewart141&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/20728&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/20728&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16385601" author="gurwls223" created="Mon, 5 Mar 2018 04:39:21 +0000"  >&lt;p&gt;Fixed in &lt;a href=&quot;https://github.com/apache/spark/pull/20728&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/20728&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 37 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3qt3b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>