<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:48:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-53143] Fix self join in DataFrame API - Join is not the only expected output from analyzer</title>
                <link>https://issues.apache.org/jira/browse/SPARK-53143</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;There is an edge case with self join when multiple joins are present.&lt;br/&gt;
&#160;&lt;br/&gt;
Example: two joins, where the latter one is self join.&lt;br/&gt;
The first one is the &quot;using&quot; join - in this case, analyzer&apos;s&lt;br/&gt;
`ResolveNaturalAndUsingJoin` will add `Project` as the top node.&lt;br/&gt;
The second join is a self join, but with specified join condition (i.e. `joinExprs`) -&lt;br/&gt;
if the join condition uses columns that are not part of the project list (of the first&lt;br/&gt;
join), `AddMetadataColumns` rule will be hit to add metadata for those columns. As a&lt;br/&gt;
consequence, `Project` will be added to the top of joined plan to return the&lt;br/&gt;
original/expected list of projected columns.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Whereas similar (i.e. `Project` node on top) can happen in multiple other cases,&lt;br/&gt;
from `Dataset` perspective the issue is specific to self joins only, since&lt;br/&gt;
`resolveSelfJoinCondition` assumed that the analyzed plan will be always of `Join` type.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Minimalist PySpark repro:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
spark.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE IF NOT EXISTS table_11 (id INT);&quot;&lt;/span&gt;)
spark.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE IF NOT EXISTS table_12 (id INT, col_1 STRING);&quot;&lt;/span&gt;)

df = spark.table(&lt;span class=&quot;code-quote&quot;&gt;&quot;table_12&quot;&lt;/span&gt;).where(&lt;span class=&quot;code-quote&quot;&gt;&quot;col_1 = &lt;span class=&quot;code-quote&quot;&gt;&apos;test&apos;&lt;/span&gt;&quot;&lt;/span&gt;).select(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;)

spark.table(&lt;span class=&quot;code-quote&quot;&gt;&quot;table_11&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;t&quot;&lt;/span&gt;) \
 &#160;.join(df.alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;df1&quot;&lt;/span&gt;), on = [&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;]) \
 &#160;.join(df.alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;df2&quot;&lt;/span&gt;), col(&lt;span class=&quot;code-quote&quot;&gt;&quot;df1.id&quot;&lt;/span&gt;) == col(&lt;span class=&quot;code-quote&quot;&gt;&quot;df2.id&quot;&lt;/span&gt;), how = &lt;span class=&quot;code-quote&quot;&gt;&quot;left&quot;&lt;/span&gt;)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Throws an exception:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.ClassCastException: &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.spark.sql.catalyst.plans.logical.Project cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.spark.sql.catalyst.plans.logical.Join (org.apache.spark.sql.catalyst.plans.logical.Project and org.apache.spark.sql.catalyst.plans.logical.Join are in unnamed module of loader &lt;span class=&quot;code-quote&quot;&gt;&apos;app&apos;&lt;/span&gt;)
	at org.apache.spark.sql.classic.Dataset.resolveSelfJoinCondition(Dataset.scala:665)
	at org.apache.spark.sql.classic.Dataset.join(Dataset.scala:690)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:569)
	at py4j.reflection.MethodInvoker.invoke(MethodInvoker.java:244)
	at py4j.reflection.ReflectionEngine.invoke(ReflectionEngine.java:374)
	at py4j.Gateway.invoke(Gateway.java:282)
	at py4j.commands.AbstractCommand.invokeMethod(AbstractCommand.java:132)
	at py4j.commands.CallCommand.execute(CallCommand.java:79)
	at py4j.ClientServerConnection.waitForCommands(ClientServerConnection.java:184)
	at py4j.ClientServerConnection.run(ClientServerConnection.java:108)
	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:840) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13625643">SPARK-53143</key>
            <summary>Fix self join in DataFrame API - Join is not the only expected output from analyzer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davidm-db">David Milicevic</assignee>
                                    <reporter username="davidm-db">David Milicevic</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 6 Aug 2025 11:59:32 +0000</created>
                <updated>Thu, 28 Aug 2025 13:35:34 +0000</updated>
                            <resolved>Thu, 28 Aug 2025 13:35:34 +0000</resolved>
                                    <version>4.0.0</version>
                                    <fixVersion>4.1.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="18016789" author="cloud_fan" created="Thu, 28 Aug 2025 13:35:34 +0000"  >&lt;p&gt;Issue resolved by pull request 51873&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/51873&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/51873&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1x4pk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12355581">4.1.0</customfieldvalue>
    <customfieldvalue id="12353359">4.0.0</customfieldvalue>
    <customfieldvalue id="12355941">4.0.1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>