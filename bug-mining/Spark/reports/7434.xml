<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:19:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-32779] Spark/Hive3 interaction potentially causes deadlock</title>
                <link>https://issues.apache.org/jira/browse/SPARK-32779</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;This is an issue for applications that share a Spark Session across multiple threads.&lt;/p&gt;

&lt;p&gt;sessionCatalog.loadPartition (after checking that the table exists) grabs locks in this order:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;HiveExternalCatalog&lt;/li&gt;
	&lt;li&gt;HiveSessionCatalog (in Shim_v3_0)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Other operations (e.g., sessionCatalog.tableExists), grab locks in this order:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;HiveSessionCatalog&lt;/li&gt;
	&lt;li&gt;HiveExternalCatalog&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;a href=&quot;https://github.com/apache/spark/blob/ad6b887541bf90cc3ea830a1a3322b71ccdd80ee/sql/hive/src/main/scala/org/apache/spark/sql/hive/client/HiveShim.scala#L1332&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;This&lt;/a&gt; appears to be the culprit. Maybe db name should be defaulted &lt;em&gt;before&lt;/em&gt; the call to HiveClient so that Shim_v3_0 doesn&apos;t have to call back into SessionCatalog. Or possibly this is not needed at all, since loadPartition in&#160;Shim_v2_1 doesn&apos;t worry about the default db name, but that might be because of differences between Hive client libraries.&lt;/p&gt;

&lt;p&gt;Reproduction case:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;You need to have a running Hive 3.x HMS instance and the appropriate hive-site.xml for your Spark instance&lt;/li&gt;
	&lt;li&gt;Adjust your spark.sql.hive.metastore.version accordingly&lt;/li&gt;
	&lt;li&gt;It might take more than one try to hit the deadlock&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Launch Spark:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;bin/spark-shell --conf &quot;spark.sql.hive.metastore.jars=${HIVE_HOME}/lib/*&quot; --conf spark.sql.hive.metastore.version=3.1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Then use the following code:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;import scala.collection.mutable.ArrayBuffer
import scala.util.Random

val tableCount = 4
for (i &amp;lt;- 0 until tableCount) {
  val tableName = s&quot;partitioned${i+1}&quot;
  sql(s&quot;drop table if exists $tableName&quot;)
  sql(s&quot;create table $tableName (a bigint) partitioned by (b bigint) stored as orc&quot;)
}

val threads = new ArrayBuffer[Thread]
for (i &amp;lt;- 0 until tableCount) {
  threads.append(new Thread( new Runnable {
    override def run: Unit = {
      val tableName = s&quot;partitioned${i + 1}&quot;
      val rand = Random
      val df = spark.range(0, 20000).toDF(&quot;a&quot;)
      val location = s&quot;/tmp/${rand.nextLong.abs}&quot;
      df.write.mode(&quot;overwrite&quot;).orc(location)
      sql(
        s&quot;&quot;&quot;
        LOAD DATA LOCAL INPATH &apos;$location&apos; INTO TABLE $tableName partition (b=$i)&quot;&quot;&quot;)
    }
  }, s&quot;worker$i&quot;))
  threads(i).start()
}

for (i &amp;lt;- 0 until tableCount) {
  println(s&quot;Joining with thread $i&quot;)
  threads(i).join()
}
println(&quot;All done&quot;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The job often gets stuck after one or two &quot;Joining...&quot; lines.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;kill -3&lt;/tt&gt; shows something like this:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Found one Java-level deadlock:
=============================
&quot;worker3&quot;:
  waiting to lock monitor 0x00007fdc3cde6798 (object 0x0000000784d98ac8, a org.apache.spark.sql.hive.HiveSessionCatalog),
  which is held by &quot;worker0&quot;
&quot;worker0&quot;:
  waiting to lock monitor 0x00007fdc441d1b88 (object 0x00000007861d1208, a org.apache.spark.sql.hive.HiveExternalCatalog),
  which is held by &quot;worker3&quot;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13325818">SPARK-32779</key>
            <summary>Spark/Hive3 interaction potentially causes deadlock</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sandeep.katta2007">Sandeep Katta</assignee>
                                    <reporter username="bersprockets">Bruce Robbins</reporter>
                        <labels>
                    </labels>
                <created>Wed, 2 Sep 2020 23:19:13 +0000</created>
                <updated>Mon, 12 Dec 2022 18:10:42 +0000</updated>
                            <resolved>Mon, 7 Sep 2020 06:11:52 +0000</resolved>
                                    <version>3.0.0</version>
                    <version>3.1.0</version>
                                    <fixVersion>3.0.2</fixVersion>
                    <fixVersion>3.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17190014" author="jinxintang" created="Thu, 3 Sep 2020 09:46:32 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bersprockets&quot; class=&quot;user-hover&quot; rel=&quot;bersprockets&quot;&gt;bersprockets&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Seems spark cannot work with hive-3.1.x currently due to type imcompatible, for example:&lt;/p&gt;

&lt;p&gt;in `org.apache.spark.sql.catalyst.util.DateTimeUtils$#fromJavaTimestamp` the method `fromJavaTimestamp` accept `java.sql.Timestamp` type,&#160; it works fine in hive-2.x, but in `hive-3.1.x`, the `org.apache.hadoop.hive.serde2.objectinspector.primitive.TimestampObjectInspector#getPrimitiveJavaObject` return `org.apache.hadoop.hive.common.type.Timestamp` not `java.sql.Timestamp`. Could you please provide related infos.&lt;/p&gt;</comment>
                            <comment id="17190626" author="sandeep.katta2007" created="Fri, 4 Sep 2020 08:25:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bersprockets&quot; class=&quot;user-hover&quot; rel=&quot;bersprockets&quot;&gt;bersprockets&lt;/a&gt;&#160;thanks for raising this issue, I am working on this. I will raise the patch soon&lt;/p&gt;</comment>
                            <comment id="17190671" author="apachespark" created="Fri, 4 Sep 2020 10:39:54 +0000"  >&lt;p&gt;User &apos;sandeep-katta&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29649&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29649&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17191459" author="gurwls223" created="Mon, 7 Sep 2020 06:11:52 +0000"  >&lt;p&gt;Issue resolved by pull request 29649&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29649&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29649&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17194617" author="apachespark" created="Sat, 12 Sep 2020 05:47:07 +0000"  >&lt;p&gt;User &apos;sandeep-katta&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29736&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29736&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17194619" author="apachespark" created="Sat, 12 Sep 2020 05:48:04 +0000"  >&lt;p&gt;User &apos;sandeep-katta&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29736&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29736&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 9 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0iay0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>