<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:45:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-16379] Spark on mesos is broken due to race condition in Logging</title>
                <link>https://issues.apache.org/jira/browse/SPARK-16379</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;This commit introduced a transient lazy log val: &lt;a href=&quot;https://github.com/apache/spark/commit/044971eca0ff3c2ce62afa665dbd3072d52cbbec&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/044971eca0ff3c2ce62afa665dbd3072d52cbbec&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This has caused problems in the past:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/1004&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/1004&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;One commit before that everything works fine.&lt;/p&gt;

&lt;p&gt;I spotted that when my CI started to fail:&lt;br/&gt;
&lt;a href=&quot;https://ci.typesafe.com/job/mit-docker-test-ref/191/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci.typesafe.com/job/mit-docker-test-ref/191/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can easily verify it by installing mesos on your machine and try to connect with spark shell from bin dir:&lt;/p&gt;

&lt;p&gt;./spark-shell --master mesos://zk://localhost:2181/mesos --conf spark.executor.url=$(pwd)/../spark-2.0.0-SNAPSHOT-bin-test.tgz&lt;/p&gt;

&lt;p&gt;It gets stuck at the point where it tries to create the SparkContext.&lt;/p&gt;

&lt;p&gt;Logging gets stuck here:&lt;br/&gt;
I0705 12:10:10.076617  9303 group.cpp:700] Trying to get &apos;/mesos/json.info_0000000152&apos; in ZooKeeper&lt;br/&gt;
I0705 12:10:10.076920  9304 detector.cpp:479] A new leading master (UPID=master@127.0.1.1:5050) is detected&lt;br/&gt;
I0705 12:10:10.076956  9303 sched.cpp:326] New master detected at master@127.0.1.1:5050&lt;br/&gt;
I0705 12:10:10.077057  9303 sched.cpp:336] No credentials provided. Attempting to register without authentication&lt;br/&gt;
I0705 12:10:10.090709  9301 sched.cpp:703] Framework registered with 13553f8b-f42c-4f20-88cd-16f1cc153ede-0001&lt;/p&gt;

&lt;p&gt;I verified it also by changing @transient lazy val log to def and it works as expected.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12986787">SPARK-16379</key>
            <summary>Spark on mesos is broken due to race condition in Logging</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="srowen">Sean R. Owen</assignee>
                                    <reporter username="skonto">Stavros Kontopoulos</reporter>
                        <labels>
                    </labels>
                <created>Tue, 5 Jul 2016 11:24:05 +0000</created>
                <updated>Wed, 6 Jul 2016 21:21:41 +0000</updated>
                            <resolved>Wed, 6 Jul 2016 20:36:02 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15362392" author="srowen" created="Tue, 5 Jul 2016 11:57:13 +0000"  >&lt;p&gt;Hm, I wonder if the implicit lock present here that manages the &apos;lazy&apos; aspect is involved in a deadlock now. Can you show a thread dump perhaps to verify that?&lt;/p&gt;</comment>
                            <comment id="15362400" author="skonto" created="Tue, 5 Jul 2016 12:10:10 +0000"  >&lt;p&gt;Thread dump of repl added.&lt;br/&gt;
waiting here &lt;a href=&quot;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/scheduler/cluster/mesos/MesosSchedulerUtils.scala#L135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/scheduler/cluster/mesos/MesosSchedulerUtils.scala#L135&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;but before that:&lt;/p&gt;

&lt;p&gt;&quot;main&quot; #1 prio=5 os_prio=0 tid=0x00007f0bc8011800 nid=0x1269 waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f0bcfa24000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: WAITING (parking)&lt;br/&gt;
	at sun.misc.Unsafe.park(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;parking to wait for  &amp;lt;0x00000000ed7b8558&amp;gt; (a java.util.concurrent.CountDownLatch$Sync)&lt;br/&gt;
	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)&lt;br/&gt;
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836)&lt;br/&gt;
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly(AbstractQueuedSynchronizer.java:997)&lt;br/&gt;
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1304)&lt;br/&gt;
	at java.util.concurrent.CountDownLatch.await(CountDownLatch.java:231)&lt;br/&gt;
	at org.apache.spark.scheduler.cluster.mesos.MesosSchedulerUtils$class.startScheduler(MesosSchedulerUtils.scala:135)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000000ed78bb68&amp;gt; (a org.apache.spark.scheduler.cluster.mesos.MesosCoarseGrainedSchedulerBackend)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;and blocked here:&lt;br/&gt;
Thread-15&quot; #67 prio=5 os_prio=0 tid=0x00007f0abc004000 nid=0x12b0 waiting for monitor entry &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f0ad37fd000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: BLOCKED (on object monitor)&lt;br/&gt;
	at org.apache.spark.scheduler.cluster.CoarseGrainedSchedulerBackend.log$lzycompute(CoarseGrainedSchedulerBackend.scala:43)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x00000000ed78bb68&amp;gt; (a org.apache.spark.scheduler.cluster.mesos.MesosCoarseGrainedSchedulerBackend)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The lock is on 0x00000000ed78bb68. &lt;/p&gt;

&lt;p&gt;MesosCoarseGrainedSchedulerBackend inherits from CoarseGrainedSchedulerBackend so the code cannot proceed.&lt;/p&gt;

&lt;p&gt;We should have a rule here to avoid transient lazy vals etc. &lt;/p&gt;</comment>
                            <comment id="15362447" author="srowen" created="Tue, 5 Jul 2016 12:52:53 +0000"  >&lt;p&gt;This doesn&apos;t seem to have anything to do with Logging, though it is a legitimate deadlock, it seems. I don&apos;t think there&apos;s anything wrong with lazy vals (why would transient matter?) excepting of course that one has to be careful about initialization circularity.&lt;/p&gt;</comment>
                            <comment id="15362459" author="skonto" created="Tue, 5 Jul 2016 13:09:01 +0000"  >&lt;p&gt;It is because of how logging is implemented there. Its a clear deadlock. This synchronized block here: &lt;a href=&quot;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/scheduler/cluster/mesos/MesosSchedulerUtils.scala#L105&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/scheduler/cluster/mesos/MesosSchedulerUtils.scala#L105&lt;/a&gt;&lt;br/&gt;
conflicts with the log lazy val. I suggested a rule or something because its tricky to use them sometimes, lazy val tries to lock the object, obviously was not caught at the review process. &lt;/p&gt;</comment>
                            <comment id="15362460" author="srowen" created="Tue, 5 Jul 2016 13:09:48 +0000"  >&lt;p&gt;Hm, but I note that in &lt;a href=&quot;https://github.com/apache/spark/commit/044971eca0ff3c2ce62afa665dbd3072d52cbbec&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/044971eca0ff3c2ce62afa665dbd3072d52cbbec&lt;/a&gt; we removed a seemingly pointless override of &lt;tt&gt;log&lt;/tt&gt; in &lt;tt&gt;CoarseGrainedSchedulerBackend&lt;/tt&gt;. It certainly seems suspicious, and I&apos;d be OK just reverting the commit ... but I&apos;d love to figure out why this is actually the problem. It seems like the Logging change may be OK, but revealed some other problem?&lt;/p&gt;</comment>
                            <comment id="15362463" author="skonto" created="Tue, 5 Jul 2016 13:12:55 +0000"  >&lt;p&gt;I dont think it reveals another problem. If you just replace it with a def everything is ok because a method does not lock anything.&lt;/p&gt;</comment>
                            <comment id="15362494" author="srowen" created="Tue, 5 Jul 2016 13:30:29 +0000"  >&lt;p&gt;A little more context does show the role that Logging plays:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-15&quot;&lt;/span&gt; #67 prio=5 os_prio=0 tid=0x00007f0abc004000 nid=0x12b0 waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; monitor entry [0x00007f0ad37fd000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: BLOCKED (on object monitor)
	at org.apache.spark.scheduler.cluster.CoarseGrainedSchedulerBackend.log$lzycompute(CoarseGrainedSchedulerBackend.scala:43)
	- waiting to lock &amp;lt;0x00000000ed78bb68&amp;gt; (a org.apache.spark.scheduler.cluster.mesos.MesosCoarseGrainedSchedulerBackend)
	at org.apache.spark.scheduler.cluster.CoarseGrainedSchedulerBackend.log(CoarseGrainedSchedulerBackend.scala:43)
	at org.apache.spark.internal.Logging$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;logInfo(Logging.scala:48)
	at org.apache.spark.scheduler.cluster.CoarseGrainedSchedulerBackend.logInfo(CoarseGrainedSchedulerBackend.scala:43)
	at org.apache.spark.scheduler.cluster.mesos.MesosCoarseGrainedSchedulerBackend.registered(MesosCoarseGrainedSchedulerBackend.scala:247)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; #1 prio=5 os_prio=0 tid=0x00007f0bc8011800 nid=0x1269 waiting on condition [0x00007f0bcfa24000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (parking)
	at sun.misc.Unsafe.park(Native Method)
	- parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000000ed7b8558&amp;gt; (a java.util.concurrent.CountDownLatch$Sync)
	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly(AbstractQueuedSynchronizer.java:997)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1304)
	at java.util.concurrent.CountDownLatch.await(CountDownLatch.java:231)
	at org.apache.spark.scheduler.cluster.mesos.MesosSchedulerUtils$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;startScheduler(MesosSchedulerUtils.scala:135)
	- locked &amp;lt;0x00000000ed78bb68&amp;gt; (a org.apache.spark.scheduler.cluster.mesos.MesosCoarseGrainedSchedulerBackend)
	at org.apache.spark.scheduler.cluster.mesos.MesosCoarseGrainedSchedulerBackend.startScheduler(MesosCoarseGrainedSchedulerBackend.scala:48)
	at org.apache.spark.scheduler.cluster.mesos.MesosCoarseGrainedSchedulerBackend.start(MesosCoarseGrainedSchedulerBackend.scala:157)
	at org.apache.spark.scheduler.TaskSchedulerImpl.start(TaskSchedulerImpl.scala:155)
	at org.apache.spark.SparkContext.&amp;lt;init&amp;gt;(SparkContext.scala:500)
	at org.apache.spark.SparkContext$.getOrCreate(SparkContext.scala:2256)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It&apos;s not a direct deadlock, but a problem of a callback holding a lock while waiting for its callback, which can&apos;t proceed without the lock.&lt;br/&gt;
I&apos;d rather actually fix this problem. One simplistic solution is to remove the logInfo statement. Another is to remove the synchronized block in MesosSchedulerUtils.startScheduler; I&apos;m not 100% clear why it&apos;s needed, when it seems like it&apos;s just protecting &lt;tt&gt;mesosDriver&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15362558" author="skonto" created="Tue, 5 Jul 2016 14:29:08 +0000"  >&lt;p&gt;Usually you should not lock on the object for synchronization that way i agree. But the reason the callback cannot proceed is the log, and the implicit lock it needs on the object. Actually it tries to log here: &lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/scheduler/cluster/mesos/MesosCoarseGrainedSchedulerBackend.scala#L247&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/scheduler/cluster/mesos/MesosCoarseGrainedSchedulerBackend.scala#L247&lt;/a&gt;&lt;br/&gt;
I think for whatever reason the synch block is needed (correct or wrong) a new functionality or a refactoring should not break it.&lt;/p&gt;

&lt;p&gt;And even after this is fixed (the probable wrong use of the synch block), i wanted to point out the tricky thing with lazy vals, there was another issue as i said in the past.&lt;br/&gt;
In other words i dont think using the lazy val there is the best way since it creates hidden issues. Thats what i am trying to say.&lt;/p&gt;

&lt;p&gt;Redesign something that is not a good choice is fine, but redesigning it by breaking it is not something i agree on at the end of the day. &lt;br/&gt;
I propose the commit to be reverted. Refactor-redesign the scheduler there (if needed) and then proceed with the commit if needed. What do you think?&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgummelt&quot; class=&quot;user-hover&quot; rel=&quot;mgummelt&quot;&gt;mgummelt&lt;/a&gt; what do you think? Can you provide some context for the synchronization there? &lt;/p&gt;
</comment>
                            <comment id="15363013" author="mgummelt" created="Tue, 5 Jul 2016 18:55:57 +0000"  >&lt;p&gt;I traced back the addition of the `synchronized` block, and it seems Matei added it a long time ago.  I can&apos;t prove that the method is thread-safe, so I&apos;d rather not remove the synchronization block.  So we can either:&lt;/p&gt;

&lt;p&gt;1) Remove the log statements (I&apos;d like to keep them)&lt;br/&gt;
2) Revert the `lazy` commit&lt;br/&gt;
3) Introduce an explicit lock, and synchronize on that rather than `this`&lt;/p&gt;

&lt;p&gt;2) is the &quot;correct&quot; thing to do, since it&apos;s the author&apos;s responsibility to not break existing code, but I&apos;m OK with 3) as well.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt; what do you think?&lt;/p&gt;</comment>
                            <comment id="15363199" author="srowen" created="Tue, 5 Jul 2016 20:43:39 +0000"  >&lt;p&gt;I don&apos;t agree with that logic; it&apos;s entirely possible that code has a bug that&apos;s only revealed when some other legitimate change happens, and the right subsequent change is to fix the bug. I don&apos;t think we&apos;d ban lazy vals either. Arguably it&apos;s &quot;synchronized&quot; that is the issue here, really.&lt;/p&gt;

&lt;p&gt;Indeed, reverting the last patch only &apos;fixes&apos; it because the code contained a hack to avoid this condition. The previous code also involved acquiring a lock, and I&apos;m guessing it &lt;em&gt;could&lt;/em&gt; still be a problem, though less likely to come up given that the locking only happens during the first call (well hopefully). Removing the logInfo actually removes the issue more directly than reintroducing the hack. Changing the startScheduler method is &lt;em&gt;probably&lt;/em&gt; the right-er fix, though that&apos;s less conservative.&lt;/p&gt;

&lt;p&gt;I&apos;m not against reverting the change just on the grounds that Logging is inherited lots of places and so there&apos;s a risk of a repeat of this problem elsewhere, even if it may ultimately also be due to some other coding problem. I&apos;d just rather not also reintroduce the hack.&lt;/p&gt;</comment>
                            <comment id="15363258" author="mgummelt" created="Tue, 5 Jul 2016 21:09:58 +0000"  >&lt;p&gt;&amp;gt; it&apos;s entirely possible that code has a bug that&apos;s only revealed when some other legitimate change happens&lt;/p&gt;

&lt;p&gt;Of course, but I still don&apos;t see the bug that existed previously.  Perhaps `synchronized` was unnecessary, but I still see no race condition nor deadlock in the previous code.  Maybe following up on this will help:&lt;/p&gt;

&lt;p&gt;&amp;gt; The previous code also involved acquiring a lock&lt;/p&gt;

&lt;p&gt;Link? I don&apos;t see this. Or do you just mean the null check? &lt;a href=&quot;https://github.com/apache/spark/commit/044971eca0ff3c2ce62afa665dbd3072d52cbbec#diff-bfd5810d8aa78ad90150e806d830bb78L45&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/044971eca0ff3c2ce62afa665dbd3072d52cbbec#diff-bfd5810d8aa78ad90150e806d830bb78L45&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15363266" author="srowen" created="Tue, 5 Jul 2016 21:15:30 +0000"  >&lt;p&gt;I mean this: &lt;a href=&quot;https://github.com/apache/spark/blob/044971eca0ff3c2ce62afa665dbd3072d52cbbec/core/src/main/scala/org/apache/spark/internal/Logging.scala#L94&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/044971eca0ff3c2ce62afa665dbd3072d52cbbec/core/src/main/scala/org/apache/spark/internal/Logging.scala#L94&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15363269" author="srowen" created="Tue, 5 Jul 2016 21:16:29 +0000"  >&lt;p&gt;Oh I also meant this as the existing workaround: &lt;a href=&quot;https://github.com/apache/spark/commit/044971eca0ff3c2ce62afa665dbd3072d52cbbec#diff-7d99a7c7a051e5e851aaaefb275a44a1L103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/044971eca0ff3c2ce62afa665dbd3072d52cbbec#diff-7d99a7c7a051e5e851aaaefb275a44a1L103&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15363270" author="skonto" created="Tue, 5 Jul 2016 21:16:58 +0000"  >&lt;p&gt;&amp;gt; Arguably it&apos;s &quot;synchronized&quot; that is the issue here, really.&lt;br/&gt;
Is it forbidden to use a synchronized block if i know what i am doing? The same applies to the log lazy val.&lt;br/&gt;
If you know what you are doing i am sure its fine.&lt;br/&gt;
The problem here is that we have two incompatible code parts and we have to merge them somehow in order to proceed.&lt;/p&gt;</comment>
                            <comment id="15363272" author="srowen" created="Tue, 5 Jul 2016 21:18:24 +0000"  >&lt;p&gt;Yes, but that is what I am arguing. Above you said it should be prohibited in all cases. I don&apos;t think it should be prohibited.&lt;/p&gt;</comment>
                            <comment id="15363278" author="skonto" created="Tue, 5 Jul 2016 21:21:31 +0000"  >&lt;p&gt;Ok we can be flexible thats not the issue. A warning at least. Given it has caused an issue twice. Sometimes i prefer to be more strict, but its just a suggestion. Could be added as a warning in the project code guidelines for example. &lt;/p&gt;

&lt;p&gt;One other thing i hope it holds is no new commit should break the project even if it fixes something or reveals another issue etc.&lt;/p&gt;</comment>
                            <comment id="15363289" author="mgummelt" created="Tue, 5 Jul 2016 21:29:59 +0000"  >&lt;p&gt;I say we add a new lock to synchronize on and be done with it.&lt;/p&gt;

&lt;p&gt;The root of the issue is that deadlock detection is hard.  The author of the breaking change added a critical region, and to do so safely, you have to ensure that all calling code paths haven&apos;t acquired the same lock, which is difficult (undecidable).&lt;/p&gt;

&lt;p&gt;The only process change I can imagine to fix the higher level issue is running some sort of deadlock detection tool in the Spark tests.  I agree we shouldn&apos;t get rid of `lazy val` completely, but it is unfortunate that you can&apos;t use them in a `synchronized` block.  It&apos;s a leaky abstraction.  Seems to be addressed here: &lt;a href=&quot;http://docs.scala-lang.org/sips/pending/improved-lazy-val-initialization.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.scala-lang.org/sips/pending/improved-lazy-val-initialization.html&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;One other thing i hope it holds is no new commit should break the project even if it fixes something or reveals another issue etc.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Well I do agree with Sean that it&apos;s on us to fix bugs revealed by external changes.&lt;/p&gt;</comment>
                            <comment id="15363290" author="mgummelt" created="Tue, 5 Jul 2016 21:29:59 +0000"  >&lt;p&gt;Hmmm, since that&apos;s a different lock, I don&apos;t see the possibility for deadlock in the previous code, but I&apos;m content to relinquish the point.  Concurrency is hard &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15363296" author="srowen" created="Tue, 5 Jul 2016 21:35:05 +0000"  >&lt;p&gt;I don&apos;t think it&apos;s even a bad practice, any more than using &lt;tt&gt;synchronized&lt;/tt&gt;. &lt;br/&gt;
Ideally, if change A uncovers bug B then it needs to be expanded to address the bug and committed all at once. Nobody is suggesting knowingly making a change that triggers a bug, so I am not sure what this is arguing against in this context. We have a bug and need to address it in the best way we can see.&lt;/p&gt;</comment>
                            <comment id="15363302" author="skonto" created="Tue, 5 Jul 2016 21:39:09 +0000"  >&lt;p&gt;There was no bug previously in the scheduler. It was working before i guess.&lt;br/&gt;
The project was not broken and the best practice is to keep it that way all the time. &lt;br/&gt;
I think we can agree on that right?&lt;/p&gt;</comment>
                            <comment id="15363303" author="srowen" created="Tue, 5 Jul 2016 21:39:23 +0000"  >&lt;p&gt;It&apos;s true, I can&apos;t say for sure the problem exists without that line. It&apos;s suspicious. In any event it seems worth doing away with it while fixing this up, which may still entail reverting the main change for safety but also trying to prove there&apos;s no similar problem still lurking in the previous Logging approach that needs any working-around anywhere.&lt;/p&gt;</comment>
                            <comment id="15363314" author="skonto" created="Tue, 5 Jul 2016 21:44:52 +0000"  >&lt;p&gt;&amp;gt; Nobody is suggesting knowingly making a change that triggers a bug, so I am not sure what this is arguing against in this context.&lt;/p&gt;

&lt;p&gt;I am just saying now that we know its an issue, we could revert the commit so we can do the improvements next. Its a blocker.&lt;/p&gt;</comment>
                            <comment id="15363324" author="srowen" created="Tue, 5 Jul 2016 21:51:37 +0000"  >&lt;p&gt;Of course we&apos;d all like to never have bugs. Nobody makes bugs on purpose. Bugs exist though, and everyone agrees something has to be fixed. This just states the obvious and is not actionable. What does that mean for &lt;em&gt;how&lt;/em&gt; to fix &lt;em&gt;this&lt;/em&gt; bug?  I will make a PR in any event since I think this issue is understood by now.&lt;/p&gt;</comment>
                            <comment id="15364039" author="skyluc" created="Wed, 6 Jul 2016 09:22:50 +0000"  >&lt;p&gt;This problem is in 2.0.0-rc2. Making it impossible to test the release candidate with Mesos.&lt;/p&gt;</comment>
                            <comment id="15364043" author="srowen" created="Wed, 6 Jul 2016 09:25:06 +0000"  >&lt;p&gt;Yeah there are other blockers. It won&apos;t be the last RC.&lt;/p&gt;</comment>
                            <comment id="15364133" author="apachespark" created="Wed, 6 Jul 2016 10:54:05 +0000"  >&lt;p&gt;User &apos;srowen&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/14069&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/14069&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15365109" author="drcrallen" created="Wed, 6 Jul 2016 21:16:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt; is there a list of blockers somewhere? I also want to get branch-2.0 tested from our side but would like to know what sort of caveats to expect.&lt;/p&gt;</comment>
                            <comment id="15365112" author="srowen" created="Wed, 6 Jul 2016 21:19:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/issues/?jql=project%20%3D%20SPARK%20AND%20Priority%20%3D%20Blocker%20AND%20%22Target%20Version%2Fs%22%20%3D%202.0.0%20AND%20Resolution%20%3D%20Unresolved&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/issues/?jql=project%20%3D%20SPARK%20AND%20Priority%20%3D%20Blocker%20AND%20%22Target%20Version%2Fs%22%20%3D%202.0.0%20AND%20Resolution%20%3D%20Unresolved&lt;/a&gt; ? you can filter JIRA how you like. Target Version should be pretty reliable.&lt;/p&gt;</comment>
                            <comment id="15365117" author="drcrallen" created="Wed, 6 Jul 2016 21:21:41 +0000"  >&lt;p&gt;That&apos;s great, thanks a ton!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12981865">SPARK-16131</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12816175" name="out.txt" size="39725" author="skonto" created="Tue, 5 Jul 2016 12:10:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 19 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30j7b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12329449">2.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>