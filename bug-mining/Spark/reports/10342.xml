<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:49:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-53448] Conversion of a pyspark DataFrame with a Variant column to pandas fails with an error</title>
                <link>https://issues.apache.org/jira/browse/SPARK-53448</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;&#160;Based on this thread in stack overflow &lt;a href=&quot;https://stackoverflow.com/questions/79747926/conversion-of-a-pyspark-dataframe-with-a-variant-column-to-pandas-fails-with-an&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/79747926/conversion-of-a-pyspark-dataframe-with-a-variant-column-to-pandas-fails-with-an&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
{{from pyspark.sql &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; SparkSessionfrom pyspark.sql.functions &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; expr

spark = SparkSession.builder.getOrCreate();
data = [
    (&lt;span class=&quot;code-quote&quot;&gt;&apos;{&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;Alice&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;age&quot;&lt;/span&gt;: 30, &lt;span class=&quot;code-quote&quot;&gt;&quot;city&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;New York&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;salary&quot;&lt;/span&gt;: 85000}&apos;&lt;/span&gt;,),
    (&lt;span class=&quot;code-quote&quot;&gt;&apos;{&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;Bob&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;age&quot;&lt;/span&gt;: 25, &lt;span class=&quot;code-quote&quot;&gt;&quot;city&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;San Francisco&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;salary&quot;&lt;/span&gt;: 92000}&apos;&lt;/span&gt;,),
    (&lt;span class=&quot;code-quote&quot;&gt;&apos;{&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;Charlie&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;age&quot;&lt;/span&gt;: 35, &lt;span class=&quot;code-quote&quot;&gt;&quot;city&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;Los Angeles&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;salary&quot;&lt;/span&gt;: 79000}&apos;&lt;/span&gt;,)
]
df = spark.createDataFrame(data, [&lt;span class=&quot;code-quote&quot;&gt;&quot;json_data&quot;&lt;/span&gt;])
df_variant = df.withColumn(&lt;span class=&quot;code-quote&quot;&gt;&quot;variant_column&quot;&lt;/span&gt;, expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;parse_json(json_data)&quot;&lt;/span&gt;))
df_variant.printSchema()
df_variant.show(truncate=False)
pdf = df_variant.toPandas()print(pdf)}}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The below code throws below error. &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;File ~/.pyenv/versions/3.11.9/lib/python3.11/site-packages/pyspark/sql/pandas/types.py:1090, in _create_converter_to_pandas.&amp;lt;locals&amp;gt;._converter.&amp;lt;locals&amp;gt;.convert_variant(value)
   1088     return VariantVal(value[&quot;value&quot;], value[&quot;metadata&quot;])
   1089 else:
-&amp;gt; 1090     raise PySparkValueError(errorClass=&quot;MALFORMED_VARIANT&quot;)

File ~/.pyenv/versions/3.11.9/lib/python3.11/site-packages/pyspark/errors/exceptions/base.py:47, in PySparkException.__init__(self, message, errorClass, messageParameters, contexts)
     44 self._error_reader = ErrorClassesReader()
     46 if message is None:
---&amp;gt; 47     self._message = self._error_reader.get_error_message(
     48         cast(str, errorClass), cast(Dict[str, str], messageParameters)
     49     )
     50 else:
     51     self._message = message

File ~/.pyenv/versions/3.11.9/lib/python3.11/site-packages/pyspark/errors/utils.py:105, in ErrorClassesReader.get_error_message(self, errorClass, messageParameters)
    103 # Verify message parameters.
    104 message_parameters_from_template = re.findall(&quot;&amp;lt;([a-zA-Z0-9_-]+)&amp;gt;&quot;, message_template)
--&amp;gt; 105 assert set(message_parameters_from_template) == set(messageParameters), (
    106     f&quot;Undefined error message parameter for error class: {errorClass}. &quot;
    107     f&quot;Parameters: {messageParameters}&quot;
    108 )
    110 def replace_match(match: Match[str]) -&amp;gt; str:
    111     return match.group().translate(str.maketrans(&quot;&amp;lt;&amp;gt;&quot;, &quot;{}&quot;))

TypeError: &apos;NoneType&apos; object is not iterable
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="13627788">SPARK-53448</key>
            <summary>Conversion of a pyspark DataFrame with a Variant column to pandas fails with an error</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vindhyag">Vindhya G</assignee>
                                    <reporter username="vindhyag">Vindhya G</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 1 Sep 2025 10:05:16 +0000</created>
                <updated>Tue, 11 Nov 2025 17:03:32 +0000</updated>
                            <resolved>Tue, 11 Nov 2025 17:03:32 +0000</resolved>
                                    <version>4.0.0</version>
                                    <fixVersion>4.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="18017399" author="JIRAUSER299405" created="Mon, 1 Sep 2025 10:06:59 +0000"  >&lt;p&gt;When I ran the code locally I found &lt;a href=&quot;https://github.com/apache/spark/blob/master/python/pyspark/sql/pandas/types.py#L1081&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/python/pyspark/sql/pandas/types.py#L1081&lt;/a&gt; has the condition for value to be dict but the above code sends VariantVal. When I added below check it worked locally. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; isinstance(value, VariantVal):
                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; value
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="18018739" author="JIRAUSER299405" created="Mon, 8 Sep 2025 06:38:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/spark/pull/52260&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/52260&lt;/a&gt; . &lt;/p&gt;</comment>
                            <comment id="18037509" author="gurwls223" created="Tue, 11 Nov 2025 17:03:32 +0000"  >&lt;p&gt;Issue resolved by pull request 52260&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/52260&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/52260&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 hours ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1xi0o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>