<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:07:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-29055] Spark UI storage memory increasing overtime</title>
                <link>https://issues.apache.org/jira/browse/SPARK-29055</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I used Spark 2.1.1 and I upgraded into new versions. After Spark version 2.3.3,&#160; I observed from Spark UI that the driver memory is&lt;font color=&quot;#ff0000&quot;&gt; increasing continuously.&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;In more detail, the driver memory and executors memory have the same used memory storage and after each iteration the storage memory is increasing. You can reproduce this behavior by running the following snippet code. The following example, is very simple, without any dataframe persistence, but the memory consumption is not stable as it was in former Spark versions (Specifically until Spark 2.3.2).&lt;/p&gt;

&lt;p&gt;Also, I tested with Spark streaming and structured streaming API and I had the same behavior. I tested with an existing application which reads from Kafka source and do some aggregations, persist dataframes and then unpersist them. The persist and unpersist it works correct, I see the dataframes in the storage tab in Spark UI and after the unpersist, all dataframe have removed. But, after the unpersist the executors memory is not zero, BUT has the same value with the driver memory. This behavior also affects the application performance because the memory of the executors is increasing as the driver increasing and after a while the persisted dataframes are not fit in the executors memory and&#160; I have spill to disk.&lt;/p&gt;

&lt;p&gt;Another error which I had after a long running, was &lt;font color=&quot;#ff0000&quot;&gt;java.lang.OutOfMemoryError: GC overhead limit exceeded, but I don&apos;t know if its relevant with the above behavior or not.&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;HOW TO REPRODUCE THIS BEHAVIOR:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Create a very simple application(streaming count_file.py) in order to reproduce this behavior. This application reads CSV files from a directory, count the rows and then remove the processed files.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; time
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; os

from pyspark.sql &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; SparkSession
from pyspark.sql &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; functions as F
from pyspark.sql &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; types as T

target_dir = &lt;span class=&quot;code-quote&quot;&gt;&quot;...&quot;&lt;/span&gt;

spark=SparkSession.builder.appName(&lt;span class=&quot;code-quote&quot;&gt;&quot;DataframeCount&quot;&lt;/span&gt;).getOrCreate()

&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; True:
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; f in os.listdir(target_dir):
        df = spark.read.load(target_dir + f, format=&lt;span class=&quot;code-quote&quot;&gt;&quot;csv&quot;&lt;/span&gt;)
        print(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt; of records: {0}&quot;&lt;/span&gt;.format(df.count()))
        time.sleep(15)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Submit code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
spark-submit 
--master spark:&lt;span class=&quot;code-comment&quot;&gt;//xxx.xxx.xx.xxx
&lt;/span&gt;--deploy-mode client
--executor-memory 4g
--executor-cores 3
streaming count_file.py
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;TESTED CASES WITH THE SAME BEHAVIOUR:&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I tested with default settings (spark-defaults.conf)&lt;/li&gt;
	&lt;li&gt;Add spark.cleaner.periodicGC.interval 1min (or less)&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;Turn spark.cleaner.referenceTracking.blocking&lt;/tt&gt;=false&lt;/li&gt;
	&lt;li&gt;Run the application in cluster mode&lt;/li&gt;
	&lt;li&gt;Increase/decrease the resources of the executors and driver&lt;/li&gt;
	&lt;li&gt;I tested with extraJavaOptions in driver and executor -XX:+UseG1GC -XX:InitiatingHeapOccupancyPercent=35 -XX:ConcGCThreads=12&lt;br/&gt;
 &#160;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;DEPENDENCIES&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Operation system: Ubuntu 16.04.3 LTS&lt;/li&gt;
	&lt;li&gt;Java: jdk1.8.0_131 (tested also with jdk1.8.0_221)&lt;/li&gt;
	&lt;li&gt;Python: Python 2.7.12&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;NOTE:&lt;/b&gt; In Spark 2.1.1 the driver memory consumption (Storage Memory tab) was extremely low and after the run of ContextCleaner and BlockManager the memory was decreasing.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13256113">SPARK-29055</key>
            <summary>Spark UI storage memory increasing overtime</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kabhwan">Jungtaek Lim</assignee>
                                    <reporter username="Geopap">George Papa</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 Sep 2019 13:13:02 +0000</created>
                <updated>Mon, 16 Mar 2020 07:24:57 +0000</updated>
                            <resolved>Tue, 1 Oct 2019 16:49:32 +0000</resolved>
                                    <version>2.3.3</version>
                                    <fixVersion>2.4.5</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>Block Manager</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="16930467" author="maxgekk" created="Mon, 16 Sep 2019 11:55:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Geopap&quot; class=&quot;user-hover&quot; rel=&quot;Geopap&quot;&gt;Geopap&lt;/a&gt;&#160;Can you provide the csv files?&lt;/p&gt;</comment>
                            <comment id="16930517" author="geopap" created="Mon, 16 Sep 2019 13:00:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maxgekk&quot; class=&quot;user-hover&quot; rel=&quot;maxgekk&quot;&gt;maxgekk&lt;/a&gt; I have uploaded a zip with few test csvs which you can use to reproduce the error.&lt;/p&gt;</comment>
                            <comment id="16939787" author="jkleckner" created="Fri, 27 Sep 2019 22:28:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Geopap&quot; class=&quot;user-hover&quot; rel=&quot;Geopap&quot;&gt;Geopap&lt;/a&gt;&#160;How quickly does the memory grow?&lt;/p&gt;</comment>
                            <comment id="16940031" author="geopap" created="Sat, 28 Sep 2019 14:02:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jkleckner&quot; class=&quot;user-hover&quot; rel=&quot;jkleckner&quot;&gt;jkleckner&lt;/a&gt; its grows few KB after each action. I have tested with different applications with different inputs, and the growth was the same; it is independent of the input data volume. Maybe this growth is caused from metadata that have not be cleared successfully.&lt;/p&gt;</comment>
                            <comment id="16940252" author="kabhwan" created="Sun, 29 Sep 2019 06:03:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Geopap&quot; class=&quot;user-hover&quot; rel=&quot;Geopap&quot;&gt;Geopap&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Could you reproduce against latest Spark 2.4.4? Even better if you could reproduce it against latest master branch.&lt;/p&gt;

&lt;p&gt;How long (many jobs) you&apos;ve run the query when you encounter the memory issue?&lt;/p&gt;

&lt;p&gt;Is this issue same with&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-27648&quot; title=&quot;In Spark2.4 Structured Streaming&#65306;The executor storage memory increasing over time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-27648&quot;&gt;&lt;del&gt;SPARK-27648&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="16940417" author="geopap" created="Sun, 29 Sep 2019 13:43:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kabhwan&quot; class=&quot;user-hover&quot; rel=&quot;kabhwan&quot;&gt;kabhwan&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I have tested also with the latest Spark 2.4.4, and I had the same behavior.&lt;/p&gt;

&lt;p&gt;Initially, I tested with production applications in a testing environment. I run them for a lot of hours, but the memory storage didn&apos;t have any decrease.&lt;/p&gt;

&lt;p&gt;Due to the production applications are based on Spark streaming and structured streaming, it is difficult someone else to reproduce the same environment,&#160; so I created a simple application (snippet code).&lt;/p&gt;

&lt;p&gt;You can run the snippet code (with spark version &amp;lt;=2.3.2) and observe the storage memory of the executors and the driver; then run the same code with 2.3.3 or newer and observe the difference. I think the starting point is to reproduce the same behavior with a very simple application like the application in the snippet code.&lt;/p&gt;

&lt;p&gt;In my view the problem is not related with the Spark API (batch, spark streaming, structured streaming etc) but it is something more fundamental in Spark versions. The issue &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-27648&quot; title=&quot;In Spark2.4 Structured Streaming&#65306;The executor storage memory increasing over time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-27648&quot;&gt;&lt;del&gt;SPARK-27648&lt;/del&gt;&lt;/a&gt; it looks the same, but I think the problem is not related with the structured streaming (Initially, I faced it with a structured streaming application, but then I understand that it was not the structured streaming API)&lt;/p&gt;</comment>
                            <comment id="16940419" author="geopap" created="Sun, 29 Sep 2019 13:48:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yy3b2007com&quot; class=&quot;user-hover&quot; rel=&quot;yy3b2007com&quot;&gt;yy3b2007com&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You have created the&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-27648&quot; title=&quot;In Spark2.4 Structured Streaming&#65306;The executor storage memory increasing over time&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-27648&quot;&gt;&lt;del&gt;SPARK-27648&lt;/del&gt;&lt;/a&gt; &#160; issue. I think my issue is the same with yours, can you take a look to this issue if its similar to yours?&lt;/p&gt;</comment>
                            <comment id="16940429" author="kabhwan" created="Sun, 29 Sep 2019 14:02:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Geopap&quot; class=&quot;user-hover&quot; rel=&quot;Geopap&quot;&gt;Geopap&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Could you take memory dump for multiple of times which there are huge difference of memory usages? How long does your minimized reproducer run before showing outstanding difference? If you could provide more information it would save bunch of hours from contributors who are interested on this.&lt;/p&gt;</comment>
                            <comment id="16940691" author="kabhwan" created="Mon, 30 Sep 2019 07:16:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Geopap&quot; class=&quot;user-hover&quot; rel=&quot;Geopap&quot;&gt;Geopap&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I guess you&apos;re hitting &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-29301&quot; title=&quot;Removing block is not reflected to the driver/executor&amp;#39;s storage memory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-29301&quot;&gt;&lt;del&gt;SPARK-29301&lt;/del&gt;&lt;/a&gt;. Please take a look at the description, and if you don&apos;t mind please try out with the patch.&lt;/p&gt;

&lt;p&gt;Btw, thanks for providing simple reproducer!&lt;/p&gt;</comment>
                            <comment id="16941220" author="geopap" created="Mon, 30 Sep 2019 18:14:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kabhwan&quot; class=&quot;user-hover&quot; rel=&quot;kabhwan&quot;&gt;kabhwan&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Good news!! I run the snippet code with your patch and the Spark looks to works right now!!&lt;/p&gt;

&lt;p&gt;I have a question about the PR description; You said &quot;The storage memory in metrics in AppStatusListener is now out of sync which lets end users easy to confuse as memory leak is happening.&quot;. Do you mean that it was not a leak, but a wrong in the storage memory in UI?&lt;/p&gt;

&lt;p&gt;Because, the memory of the JVM (MEM%) in the system was also increasing before your patch, and after your correction the JVM memory is also stable.&lt;/p&gt;</comment>
                            <comment id="16941453" author="kabhwan" created="Tue, 1 Oct 2019 01:45:31 +0000"  >&lt;p&gt;I haven&apos;t observed increased memory usage even without the patch. jvisualvm showed the graph of heap memory usage which looked OK. Could you attach jvisualvm or other profiler tool and take a look at heap memory usage on driver?&lt;/p&gt;</comment>
                            <comment id="16941736" author="geopap" created="Tue, 1 Oct 2019 10:56:44 +0000"  >&lt;p&gt;&#160;&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kabhwan&quot; class=&quot;user-hover&quot; rel=&quot;kabhwan&quot;&gt;kabhwan&lt;/a&gt;&lt;br/&gt;
First of all thank for your time about this issue!!&lt;br/&gt;
As I described in the initial description, after a long time run, I start having spill to disk. So, maybe the bug in the UI memory usage report which is look to be corrected with (&lt;a href=&quot;https://github.com/apache/spark/pull/25973&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;GitHub Pull Request #25973&lt;/a&gt;), there is another hidden bug.&lt;br/&gt;
&#160;&lt;br/&gt;
I run the code in the snippet (I test it without any sleeping time, in order to see the results faster) and I have recorded the JVM memory usage for approximately 1 hour between Spark 2.4.4 and your branch with your patch.&lt;br/&gt;
Spark JVM memory with Spark 2.4.4:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Time&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;RES&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;SHR&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;MEM%&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1min&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;1349&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;32724&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.5&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;3min&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;1936&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;32724&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.2&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;5min&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;2506&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;32724&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.6&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;7min&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;2564&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;32724&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;9min&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;2584&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;32724&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;11min&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;2585&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;32724&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;13min&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;2592&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;32724&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;15min&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;2591&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;32724&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;17min&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;2591&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;32724&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;30min&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;2600&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;32724&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1h&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;2618&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;32724&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.7&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Spark JVM memory with Spark patch(&lt;a href=&quot;https://github.com/apache/spark/pull/25973&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;GitHub Pull Request #25973&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Time&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;RES&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;SHR&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;MEM%&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1min&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;1134&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;25380&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.4&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;3min&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;1520&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;25380&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.6&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;5min&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;1570&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;25380&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.6&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;7min&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;1598&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;25380&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;9min&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;1613&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;25380&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;11min&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;1616&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;25380&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;15min&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;1620&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;25380&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;17min&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;1625&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;25380&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;30min&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;1629&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;25380&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1h&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#de350b&quot;&gt;1660&lt;/font&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;25380&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.7&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;As you can see the RES memory is slightly increasing in both cases overtime. Also, when I tested with a real streaming application in a testing env after hours, the persisted dataframes overflows the memory and spill to disk.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;You can easily reproduce the above behavior, by running the snippet code (I prefer to run without any sleeping delay) and track the JVM memory with top or htop command.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16942224" author="jkleckner" created="Tue, 1 Oct 2019 18:32:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vanzin&quot; class=&quot;user-hover&quot; rel=&quot;vanzin&quot;&gt;vanzin&lt;/a&gt;&#160;It seems from the previous comment that it is not resolved by PR #25973 as the memory continues to grow.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Geopap&quot; class=&quot;user-hover&quot; rel=&quot;Geopap&quot;&gt;Geopap&lt;/a&gt;&#160;I recorded an internal tech talk about how to connect/grab heap dump/analyze with jvisualvm if you are interested here:&#160;&lt;a href=&quot;https://www.youtube.com/channel/UCA81uPFG3aqo2X1YgZRAoEg&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.youtube.com/channel/UCA81uPFG3aqo2X1YgZRAoEg&lt;/a&gt;&lt;/p&gt;



&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16942231" author="viirya" created="Tue, 1 Oct 2019 18:46:52 +0000"  >&lt;p&gt;Should we update the title of this ticket? It is not real memory leak in Spark, right?&lt;/p&gt;</comment>
                            <comment id="16942267" author="kabhwan" created="Tue, 1 Oct 2019 19:34:10 +0000"  >&lt;p&gt;Looks like I can update the title and description, but then the information of &quot;possible memory leak&quot; is lost.&lt;br/&gt;
I could also clone the issue but it changes the reporter to me (as I don&apos;t have privilege to modify reporter) which is not desired.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Geopap&quot; class=&quot;user-hover&quot; rel=&quot;Geopap&quot;&gt;Geopap&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vanzin&quot; class=&quot;user-hover&quot; rel=&quot;vanzin&quot;&gt;vanzin&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=viirya&quot; class=&quot;user-hover&quot; rel=&quot;viirya&quot;&gt;viirya&lt;/a&gt; Could anyone clone this issue? After cloning I&apos;ll update this issue accordingly.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                                                <inwardlinks description="is cloned by">
                                        <issuelink>
            <issuekey id="13259987">SPARK-29321</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="13231959">SPARK-27648</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13259588">SPARK-29301</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12980412" name="test_csvs.zip" size="1356189" author="Geopap" created="Mon, 16 Sep 2019 12:58:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 6 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z06jnk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>