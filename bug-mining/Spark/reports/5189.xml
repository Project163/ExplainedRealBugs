<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:56:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-22033] BufferHolder, other size checks should account for the specific VM array size limitations</title>
                <link>https://issues.apache.org/jira/browse/SPARK-22033</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;User may get the following OOM Error while running a job with heavy aggregations&lt;/p&gt;

&lt;p&gt;```&lt;br/&gt;
java.lang.OutOfMemoryError: Requested array size exceeds VM limit&lt;br/&gt;
	at org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder.grow(BufferHolder.java:73)&lt;br/&gt;
	at org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter.write(UnsafeRowWriter.java:235)&lt;br/&gt;
	at org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter.write(UnsafeRowWriter.java:228)&lt;br/&gt;
	at org.apache.spark.sql.catalyst.expressions.GeneratedClass$SpecificUnsafeProjection.apply(Unknown Source)&lt;br/&gt;
	at org.apache.spark.sql.execution.aggregate.AggregationIterator$$anonfun$generateResultProjection$2.apply(AggregationIterator.scala:254)&lt;br/&gt;
	at org.apache.spark.sql.execution.aggregate.AggregationIterator$$anonfun$generateResultProjection$2.apply(AggregationIterator.scala:247)&lt;br/&gt;
	at org.apache.spark.sql.execution.aggregate.ObjectAggregationIterator.next(ObjectAggregationIterator.scala:88)&lt;br/&gt;
	at org.apache.spark.sql.execution.aggregate.ObjectAggregationIterator.next(ObjectAggregationIterator.scala:33)&lt;br/&gt;
	at scala.collection.Iterator$$anon$11.next(Iterator.scala:409)&lt;br/&gt;
	at org.apache.spark.shuffle.sort.UnsafeShuffleWriter.write(UnsafeShuffleWriter.java:167)&lt;br/&gt;
	at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:96)&lt;br/&gt;
	at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:53)&lt;br/&gt;
	at org.apache.spark.scheduler.Task.run(Task.scala:108)&lt;br/&gt;
	at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:335)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:748)&lt;br/&gt;
```&lt;/p&gt;

&lt;p&gt;The &lt;span class=&quot;error&quot;&gt;&amp;#91;`BufferHolder.grow` tries to create a byte array of `Integer.MAX_VALUE` here&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/spark/blob/v2.2.0/sql/catalyst/src/main/java/org/apache/spark/sql/catalyst/expressions/codegen/BufferHolder.java#L72&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/v2.2.0/sql/catalyst/src/main/java/org/apache/spark/sql/catalyst/expressions/codegen/BufferHolder.java#L72&lt;/a&gt;) but the maximum size of an array depends on specifics of a VM.&lt;/p&gt;

&lt;p&gt;The safest value seems to be `Integer.MAX_VALUE - 8` &lt;br/&gt;
&lt;a href=&quot;http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/tip/src/share/classes/java/util/ArrayList.java#l229&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/tip/src/share/classes/java/util/ArrayList.java#l229&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In my JVM:&lt;br/&gt;
```&lt;br/&gt;
java -version&lt;br/&gt;
openjdk version &quot;1.8.0_141&quot;&lt;br/&gt;
OpenJDK Runtime Environment (build 1.8.0_141-b16)&lt;br/&gt;
OpenJDK 64-Bit Server VM (build 25.141-b16, mixed mode)&lt;br/&gt;
```&lt;/p&gt;

&lt;p&gt;the max is `new Array&lt;span class=&quot;error&quot;&gt;&amp;#91;Byte&amp;#93;&lt;/span&gt;(Integer.MAX_VALUE - 2)`&lt;/p&gt;</description>
                <environment></environment>
        <key id="13102696">SPARK-22033</key>
            <summary>BufferHolder, other size checks should account for the specific VM array size limitations</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="srowen">Sean R. Owen</assignee>
                                    <reporter username="buryat">Vadim Semenov</reporter>
                        <labels>
                    </labels>
                <created>Fri, 15 Sep 2017 22:06:32 +0000</created>
                <updated>Mon, 9 Apr 2018 20:49:17 +0000</updated>
                            <resolved>Sat, 23 Sep 2017 14:41:13 +0000</resolved>
                                    <version>2.2.0</version>
                                    <fixVersion>2.3.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16168612" author="buryat" created="Fri, 15 Sep 2017 22:15:05 +0000"  >&lt;p&gt;Leaving traces for others if they happen to hit the same issue.&lt;/p&gt;

&lt;p&gt;The issue isn&apos;t exclusive to the ObjectAggregator, it can happen in the SortBasedAggregator too&lt;/p&gt;

&lt;p&gt;```&lt;br/&gt;
java.lang.OutOfMemoryError: Requested array size exceeds VM limit&lt;br/&gt;
	at org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder.grow(BufferHolder.java:73)&lt;br/&gt;
	at org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter.write(UnsafeRowWriter.java:235)&lt;br/&gt;
	at org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter.write(UnsafeRowWriter.java:228)&lt;br/&gt;
	at org.apache.spark.sql.catalyst.expressions.GeneratedClass$SpecificUnsafeProjection.apply(Unknown Source)&lt;br/&gt;
	at org.apache.spark.sql.execution.aggregate.AggregationIterator$$anonfun$generateResultProjection$2.apply(AggregationIterator.scala:254)&lt;br/&gt;
	at org.apache.spark.sql.execution.aggregate.AggregationIterator$$anonfun$generateResultProjection$2.apply(AggregationIterator.scala:247)&lt;br/&gt;
	at org.apache.spark.sql.execution.aggregate.SortBasedAggregationIterator.next(SortBasedAggregationIterator.scala:159)&lt;br/&gt;
	at org.apache.spark.sql.execution.aggregate.SortBasedAggregationIterator.next(SortBasedAggregationIterator.scala:29)&lt;br/&gt;
	at org.apache.spark.sql.execution.aggregate.SortBasedAggregationIterator.initialize(SortBasedAggregationIterator.scala:103)&lt;br/&gt;
	at org.apache.spark.sql.execution.aggregate.SortBasedAggregationIterator.&amp;lt;init&amp;gt;(SortBasedAggregationIterator.scala:113)&lt;br/&gt;
	at org.apache.spark.sql.execution.aggregate.SortAggregateExec$$anonfun$doExecute$1$$anonfun$3.apply(SortAggregateExec.scala:86)&lt;br/&gt;
	at org.apache.spark.sql.execution.aggregate.SortAggregateExec$$anonfun$doExecute$1$$anonfun$3.apply(SortAggregateExec.scala:77)&lt;br/&gt;
	at org.apache.spark.rdd.RDD$$anonfun$mapPartitionsInternal$1$$anonfun$apply$25.apply(RDD.scala:827)&lt;br/&gt;
	at org.apache.spark.rdd.RDD$$anonfun$mapPartitionsInternal$1$$anonfun$apply$25.apply(RDD.scala:827)&lt;br/&gt;
	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)&lt;br/&gt;
	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:323)&lt;br/&gt;
	at org.apache.spark.rdd.RDD.iterator(RDD.scala:287)&lt;br/&gt;
	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)&lt;br/&gt;
	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:323)&lt;br/&gt;
	at org.apache.spark.rdd.RDD.iterator(RDD.scala:287)&lt;br/&gt;
	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)&lt;br/&gt;
	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:323)&lt;br/&gt;
	at org.apache.spark.rdd.RDD.iterator(RDD.scala:287)&lt;br/&gt;
	at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:96)&lt;br/&gt;
	at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:53)&lt;br/&gt;
	at org.apache.spark.scheduler.Task.run(Task.scala:108)&lt;br/&gt;
	at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:335)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:748)&lt;br/&gt;
```&lt;/p&gt;</comment>
                            <comment id="16168650" author="srowen" created="Fri, 15 Sep 2017 22:59:00 +0000"  >&lt;p&gt;Hm, good point. There may be other similar issues throughout the code.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; does that sound right to you?&lt;/p&gt;</comment>
                            <comment id="16168928" author="cloud_fan" created="Sat, 16 Sep 2017 14:04:20 +0000"  >&lt;p&gt;yea sounds good to me, though I can&apos;t think of other places that have the similar issue.&lt;/p&gt;</comment>
                            <comment id="16169318" author="kiszk" created="Sun, 17 Sep 2017 14:42:42 +0000"  >&lt;p&gt;I think &lt;tt&gt;ColumnVector&lt;/tt&gt; and &lt;tt&gt;HashMapGrowthStrategy&lt;/tt&gt; may have possibility of the similar issue.&lt;br/&gt;
What do you think?&lt;/p&gt;</comment>
                            <comment id="16170109" author="maropu" created="Mon, 18 Sep 2017 14:54:49 +0000"  >&lt;p&gt;just a heads-up: this is probably related to the 2G limit issue: &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-6235&quot; title=&quot;Address various 2G limits&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-6235&quot;&gt;&lt;del&gt;SPARK-6235&lt;/del&gt;&lt;/a&gt; (I think you all have known though...).&lt;/p&gt;</comment>
                            <comment id="16170121" author="apachespark" created="Mon, 18 Sep 2017 15:01:04 +0000"  >&lt;p&gt;User &apos;srowen&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19266&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19266&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16170122" author="srowen" created="Mon, 18 Sep 2017 15:01:47 +0000"  >&lt;p&gt;I tried to change all the locations where an array size was checked vs Int.MaxValue. Modifying the checks in MLlib might be going overboard as a failure there isn&apos;t avoidable if the array is too big, whereas in other cases, it&apos;s actually avoiding an avoidable error.&lt;/p&gt;

&lt;p&gt;Thoughts on the PR?&lt;/p&gt;</comment>
                            <comment id="16177823" author="srowen" created="Sat, 23 Sep 2017 14:41:13 +0000"  >&lt;p&gt;Issue resolved by pull request 19266&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19266&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19266&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13107891">SPARK-22222</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 8 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3k56n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>