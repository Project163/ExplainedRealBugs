<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:32:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-10431] Flaky test: o.a.s.metrics.InputOutputMetricsSuite - input metrics with cache and coalesce</title>
                <link>https://issues.apache.org/jira/browse/SPARK-10431</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I sometimes get test failures such as:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;input metrics with cache and coalesce *** FAILED ***&lt;br/&gt;
  5994472 did not equal 6044472 (InputOutputMetricsSuite.scala:101)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Tracking this down by adding some debug it seems this is a timing issue in the test.&lt;/p&gt;

&lt;p&gt;test(&quot;input metrics with cache and coalesce&quot;) {&lt;br/&gt;
    // prime the cache manager&lt;br/&gt;
    val rdd = sc.textFile(tmpFilePath, 4).cache()&lt;br/&gt;
    rdd.collect()     // &amp;lt;== #1&lt;/p&gt;

&lt;p&gt;    val bytesRead = runAndReturnBytesRead &lt;/p&gt;
{      // &amp;lt;== #2
      rdd.count()
    }
&lt;p&gt;    val bytesRead2 = runAndReturnBytesRead &lt;/p&gt;
{
      rdd.coalesce(4).count()
    }

&lt;p&gt;    // for count and coelesce, the same bytes should be read.&lt;br/&gt;
    assert(bytesRead != 0)&lt;br/&gt;
    assert(bytesRead2 == bytesRead) // fails&lt;br/&gt;
  }&lt;/p&gt;

&lt;p&gt;What is happening is that the runAndReturnBytesRead (#2) function adds a SparkListener to monitor TaskEnd events to total the bytes read from eg the rdd.count()&lt;/p&gt;

&lt;p&gt;In the case where this fails the listener receives a TaskEnd event from earlier tasks (eg #1) and this mucks up the totalling. This happens because the asynchronous thread processing the event queue and notifying the listeners has not processed one of the taskEnd events before the new listener is added so it also receives that event.&lt;/p&gt;

&lt;p&gt;There is a simple fix to the test to wait for the event queue to be empty before adding the new listener and I will submit a pull request for that.&lt;/p&gt;

&lt;p&gt;I also notice that a lot of the tests add a listener and as there is no removeSparkListener api the number of listeners on the context builds up during the running of the suite. This is probably why I see this issue running on slow machines.&lt;/p&gt;

&lt;p&gt;A wider question may be: should a listener receive events that occurred before it was added?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12861523">SPARK-10431</key>
            <summary>Flaky test: o.a.s.metrics.InputOutputMetricsSuite - input metrics with cache and coalesce</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="robbinspg">Peter George Robbins</assignee>
                                    <reporter username="robbinspg">Peter George Robbins</reporter>
                        <labels>
                            <label>flaky-test</label>
                    </labels>
                <created>Thu, 3 Sep 2015 09:58:57 +0000</created>
                <updated>Thu, 3 Sep 2015 20:49:34 +0000</updated>
                            <resolved>Thu, 3 Sep 2015 20:49:34 +0000</resolved>
                                    <version>1.5.0</version>
                                    <fixVersion>1.5.1</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>Tests</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14728795" author="apachespark" created="Thu, 3 Sep 2015 10:03:05 +0000"  >&lt;p&gt;User &apos;robbinspg&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/8582&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/8582&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 11 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2jqm7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333108">1.5.1</customfieldvalue>
    <customfieldvalue id="12333083">1.6.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>