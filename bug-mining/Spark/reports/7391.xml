<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:18:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-32018] Fix UnsafeRow set overflowed decimal</title>
                <link>https://issues.apache.org/jira/browse/SPARK-32018</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;There is a bug that writing an overflowed decimal into UnsafeRow is fine but reading it out will throw ArithmeticException. This exception is thrown when calling&#160;&lt;tt&gt;getDecimal&lt;/tt&gt;&#160;in UnsafeRow with input decimal&apos;s precision greater than the input precision. Setting the value of the overflowed decimal to null when writing into UnsafeRow should fix this issue.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13312081">SPARK-32018</key>
            <summary>Fix UnsafeRow set overflowed decimal</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cloud_fan">Wenchen Fan</assignee>
                                    <reporter username="allisonwang-db">Allison Wang</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 Jun 2020 23:59:53 +0000</created>
                <updated>Tue, 18 Aug 2020 04:03:44 +0000</updated>
                            <resolved>Thu, 16 Jul 2020 18:11:13 +0000</resolved>
                                    <version>2.4.6</version>
                    <version>2.4.7</version>
                    <version>3.0.0</version>
                    <version>3.0.1</version>
                                    <fixVersion>3.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="17139229" author="angerszhuuu" created="Thu, 18 Jun 2020 08:47:15 +0000"  >&lt;p&gt;Work On this&lt;/p&gt;</comment>
                            <comment id="17147313" author="angerszhuuu" created="Sun, 28 Jun 2020 11:04:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=allisonwang-db&quot; class=&quot;user-hover&quot; rel=&quot;allisonwang-db&quot;&gt;allisonwang-db&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Can you show a test case to reproduce this?&lt;/p&gt;</comment>
                            <comment id="17152869" author="apachespark" created="Tue, 7 Jul 2020 16:29:14 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29026&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29026&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17152871" author="apachespark" created="Tue, 7 Jul 2020 16:30:33 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29026&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29026&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17158548" author="apachespark" created="Wed, 15 Jul 2020 17:20:29 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29125&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29125&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17158553" author="apachespark" created="Wed, 15 Jul 2020 17:21:45 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29125&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29125&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17159675" author="apachespark" created="Fri, 17 Jul 2020 05:02:30 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29141&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29141&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17159677" author="apachespark" created="Fri, 17 Jul 2020 05:03:19 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29141&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29141&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17169132" author="ksunitha" created="Fri, 31 Jul 2020 20:20:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/cloud-fan&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;@cloud-fan&lt;/a&gt;, I noticed the back ports now. &#160;This change is more far reaching in its impact as previous callers of UnsafeRow.getDecimal that would have thrown an exception earlier would now return null.&lt;/p&gt;

&lt;p&gt;As an e.g, a caller like aggregate sum will need changes to account for this. Earlier cases where sum would throw error for overflow will &lt;b&gt;now return incorrect results&lt;/b&gt;. The new tests that were added for sum overflow cases in the DataFrameSuite in master can be used to see repro.&lt;/p&gt;

&lt;p&gt;IMO, it would be better to not back port the setDecimal change in isolation. wdyt? &#160; Please share your thoughts. &#160;Thanks.&#160;&lt;/p&gt;

&lt;p&gt;I added a comment on the pr but since it is closed, adding a comment here.&lt;/p&gt;</comment>
                            <comment id="17172688" author="ksunitha" created="Thu, 6 Aug 2020 22:03:43 +0000"  >&lt;p&gt;The important issue is we should not return incorrect results. In general, it is not a good practice to back port a change to a stable branch and cause more queries to return incorrect results.&lt;/p&gt;

&lt;p&gt;Just to reiterate:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;This current PR that has back ported the UnsafeRow fix causes queries to return incorrect results. This is for v2.4.x and v3.0.x line. This change by itself has unsafe side effects and results in incorrect results being returned.&lt;/li&gt;
	&lt;li&gt;It does not matter whether you have whole stage on or off, ansi on or off, you will get more queries returning incorrect results.&lt;/li&gt;
	&lt;li&gt;Incorrect results is very serious and it is not good for Spark users to run into it for common operations like sum.&lt;/li&gt;
&lt;/ol&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160;
scala&amp;gt; val decStr = &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt; + &lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt; * 19
decStr: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; = 10000000000000000000
scala&amp;gt; val d3 = spark.range(0, 1, 1, 1).union(spark.range(0, 11, 1, 1))
d3: org.apache.spark.sql.Dataset[&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;] = [id: bigint]
&#160;
scala&amp;gt;&#160; val d5 = d3.select(expr(s&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&apos;$decStr&apos;&lt;/span&gt; as decimal (38, 18)) as d&quot;&lt;/span&gt;),lit(1).as(&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;)).groupBy(&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;).agg(sum($&lt;span class=&quot;code-quote&quot;&gt;&quot;d&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;sumd&quot;&lt;/span&gt;)).select($&lt;span class=&quot;code-quote&quot;&gt;&quot;sumd&quot;&lt;/span&gt;)
d5: org.apache.spark.sql.DataFrame = [sumd: decimal(38,18)]
scala&amp;gt; d5.show(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)   &amp;lt;----- INCORRECT RESULTS
+---------------------------------------+
|sumd &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; |
+---------------------------------------+
|20000000000000000000.000000000000000000|
+---------------------------------------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17172689" author="ksunitha" created="Thu, 6 Aug 2020 22:06:08 +0000"  >&lt;p&gt;I have added a summary of my comments from the&#160; &lt;a href=&quot;https://github.com/apache/spark/pull/29125&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29125&lt;/a&gt;&#160;discussion in above comment. &#160;Thanks.&#160;&lt;/p&gt;</comment>
                            <comment id="17175284" author="apachespark" created="Tue, 11 Aug 2020 06:41:19 +0000"  >&lt;p&gt;User &apos;gengliangwang&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29404&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29404&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17175285" author="apachespark" created="Tue, 11 Aug 2020 06:42:07 +0000"  >&lt;p&gt;User &apos;gengliangwang&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29404&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29404&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17176906" author="prashant_" created="Thu, 13 Aug 2020 10:27:45 +0000"  >&lt;p&gt;This issue is resolved as fixed with version 2.4.7. However, I am unable to find the fix in branch 2.4.&#160;&lt;/p&gt;</comment>
                            <comment id="17176955" author="cloud_fan" created="Thu, 13 Aug 2020 12:23:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Gengliang.Wang&quot; class=&quot;user-hover&quot; rel=&quot;Gengliang.Wang&quot;&gt;Gengliang.Wang&lt;/a&gt; we should create a new JIRA ticket for the new fix. The new fix is not applicable to 2.4 as 2.4 does not have ANSI mode.&lt;/p&gt;</comment>
                            <comment id="17178713" author="apachespark" created="Mon, 17 Aug 2020 04:36:27 +0000"  >&lt;p&gt;User &apos;gengliangwang&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29448&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29448&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17178714" author="apachespark" created="Mon, 17 Aug 2020 04:37:20 +0000"  >&lt;p&gt;User &apos;gengliangwang&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29448&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29448&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17178772" author="apachespark" created="Mon, 17 Aug 2020 06:56:33 +0000"  >&lt;p&gt;User &apos;gengliangwang&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29450&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29450&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17178773" author="apachespark" created="Mon, 17 Aug 2020 06:56:37 +0000"  >&lt;p&gt;User &apos;gengliangwang&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29450&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29450&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17179002" author="cloud_fan" created="Mon, 17 Aug 2020 13:59:09 +0000"  >&lt;p&gt;The unsafe row bug fix has been reverted from 3.0/2.4, see the reason &lt;a href=&quot;https://github.com/apache/spark/pull/29450#issuecomment-674799489&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29450#issuecomment-674799489&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17179351" author="apachespark" created="Tue, 18 Aug 2020 04:03:44 +0000"  >&lt;p&gt;User &apos;gengliangwang&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29458&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29458&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 13 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0fyk0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>