<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:32:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-5259] Do not submit stage until its dependencies map outputs are registered</title>
                <link>https://issues.apache.org/jira/browse/SPARK-5259</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;We should track pending tasks by partition ID instead of Task objects.&lt;/p&gt;

&lt;p&gt;Before this, failure &amp;amp; retry could result in a case where a stage got submitted before the map output from its dependencies get registered. This was due to an error in the condition for registering map outputs.&lt;/p&gt;

&lt;p&gt;More complete explanation of the original problem:&lt;/p&gt;

&lt;p&gt;1. while shuffle stage was retry, there may have 2 taskSet running. &lt;/p&gt;

&lt;p&gt;we call the 2 taskSet:taskSet0.0, taskSet0.1, and we know, taskSet0.1 will re-run taskSet0.0&apos;s un-complete task&lt;/p&gt;

&lt;p&gt;if taskSet0.0 was run all the task that the taskSet0.1 not complete yet but covered the partitions.&lt;/p&gt;

&lt;p&gt;then stage is Available is true.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  def isAvailable: &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; = {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!isShuffleMap) {
      &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      numAvailableOutputs == numPartitions
    }
  } 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but stage.pending task is not empty, to protect register mapStatus in mapOutputTracker.&lt;/p&gt;

&lt;p&gt;because if task is complete success, pendingTasks is minus Task in reference-level because the task is not override hashcode() and equals()&lt;br/&gt;
pendingTask -= task&lt;/p&gt;

&lt;p&gt;but numAvailableOutputs is according to partitionID.&lt;/p&gt;

&lt;p&gt;here is the testcase to prove:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  test(&lt;span class=&quot;code-quote&quot;&gt;&quot;Make sure mapStage.pendingtasks is set() &quot;&lt;/span&gt; +
    &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; MapStage.isAvailable is &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; stage was retry &quot;&lt;/span&gt;) {
    val firstRDD = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MyRDD(sc, 6, Nil)
    val firstShuffleDep = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ShuffleDependency(firstRDD, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
    val firstShuyffleId = firstShuffleDep.shuffleId
    val shuffleMapRdd = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MyRDD(sc, 6, List(firstShuffleDep))
    val shuffleDep = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ShuffleDependency(shuffleMapRdd, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
    val shuffleId = shuffleDep.shuffleId
    val reduceRdd = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MyRDD(sc, 2, List(shuffleDep))
    submit(reduceRdd, Array(0, 1))
    complete(taskSets(0), Seq(
      (Success, makeMapStatus(&lt;span class=&quot;code-quote&quot;&gt;&quot;hostB&quot;&lt;/span&gt;, 1)),
      (Success, makeMapStatus(&lt;span class=&quot;code-quote&quot;&gt;&quot;hostB&quot;&lt;/span&gt;, 2)),
      (Success, makeMapStatus(&lt;span class=&quot;code-quote&quot;&gt;&quot;hostC&quot;&lt;/span&gt;, 3)),
      (Success, makeMapStatus(&lt;span class=&quot;code-quote&quot;&gt;&quot;hostB&quot;&lt;/span&gt;, 4)),
      (Success, makeMapStatus(&lt;span class=&quot;code-quote&quot;&gt;&quot;hostB&quot;&lt;/span&gt;, 5)),
      (Success, makeMapStatus(&lt;span class=&quot;code-quote&quot;&gt;&quot;hostC&quot;&lt;/span&gt;, 6))
    ))
    complete(taskSets(1), Seq(
      (Success, makeMapStatus(&lt;span class=&quot;code-quote&quot;&gt;&quot;hostA&quot;&lt;/span&gt;, 1)),
      (Success, makeMapStatus(&lt;span class=&quot;code-quote&quot;&gt;&quot;hostB&quot;&lt;/span&gt;, 2)),
      (Success, makeMapStatus(&lt;span class=&quot;code-quote&quot;&gt;&quot;hostA&quot;&lt;/span&gt;, 1)),
      (Success, makeMapStatus(&lt;span class=&quot;code-quote&quot;&gt;&quot;hostB&quot;&lt;/span&gt;, 2)),
      (Success, makeMapStatus(&lt;span class=&quot;code-quote&quot;&gt;&quot;hostA&quot;&lt;/span&gt;, 1))
    ))
    runEvent(ExecutorLost(&lt;span class=&quot;code-quote&quot;&gt;&quot;exec-hostA&quot;&lt;/span&gt;))
    runEvent(CompletionEvent(taskSets(1).tasks(0), Resubmitted, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;))
    runEvent(CompletionEvent(taskSets(1).tasks(2), Resubmitted, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;))
    runEvent(CompletionEvent(taskSets(1).tasks(0),
      FetchFailed(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, firstShuyffleId, -1, 0, &lt;span class=&quot;code-quote&quot;&gt;&quot;Fetch Mata data failed&quot;&lt;/span&gt;),
      &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;))
    scheduler.resubmitFailedStages()
    runEvent(CompletionEvent(taskSets(1).tasks(0), Success,
      makeMapStatus(&lt;span class=&quot;code-quote&quot;&gt;&quot;hostC&quot;&lt;/span&gt;, 1), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;))
    runEvent(CompletionEvent(taskSets(1).tasks(2), Success,
      makeMapStatus(&lt;span class=&quot;code-quote&quot;&gt;&quot;hostC&quot;&lt;/span&gt;, 1), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;))
    runEvent(CompletionEvent(taskSets(1).tasks(4), Success,
      makeMapStatus(&lt;span class=&quot;code-quote&quot;&gt;&quot;hostC&quot;&lt;/span&gt;, 1), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;))
    runEvent(CompletionEvent(taskSets(1).tasks(5), Success,
      makeMapStatus(&lt;span class=&quot;code-quote&quot;&gt;&quot;hostB&quot;&lt;/span&gt;, 2), &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;))
    val stage = scheduler.stageIdToStage(taskSets(1).stageId)
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt;(stage.attemptId == 2)
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt;(stage.isAvailable)
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt;(stage.pendingTasks.size == 0)
  }


&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12767653">SPARK-5259</key>
            <summary>Do not submit stage until its dependencies map outputs are registered</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="SuYan">SuYan</assignee>
                                    <reporter username="SuYan">SuYan</reporter>
                        <labels>
                    </labels>
                <created>Thu, 15 Jan 2015 04:06:13 +0000</created>
                <updated>Fri, 9 Dec 2016 12:06:06 +0000</updated>
                            <resolved>Mon, 21 Sep 2015 19:26:31 +0000</resolved>
                                    <version>1.1.1</version>
                    <version>1.2.0</version>
                                    <fixVersion>1.6.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="14278222" author="apachespark" created="Thu, 15 Jan 2015 04:08:45 +0000"  >&lt;p&gt;User &apos;suyanNone&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/4055&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/4055&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14642927" author="apachespark" created="Mon, 27 Jul 2015 16:05:09 +0000"  >&lt;p&gt;User &apos;squito&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/7699&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/7699&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14703566" author="rxin" created="Wed, 19 Aug 2015 18:56:18 +0000"  >&lt;p&gt;I have retargeted this and downgraded it from Blocker to Critical since it&apos;s been there for a while and not a regression.&lt;/p&gt;</comment>
                            <comment id="14901242" author="irashid" created="Mon, 21 Sep 2015 19:26:31 +0000"  >&lt;p&gt;Issue resolved by pull request 7699&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/7699&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/7699&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15735160" author="xukun" created="Fri, 9 Dec 2016 12:06:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=squito&quot; class=&quot;user-hover&quot; rel=&quot;squito&quot;&gt;squito&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SuYan&quot; class=&quot;user-hover&quot; rel=&quot;SuYan&quot;&gt;SuYan&lt;/a&gt; Would it be possible to backport this to branch 1.5?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12860709">SPARK-10370</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 49 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i24ebr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333083">1.6.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>