<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:26:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-35512] pyspark partitionBy may encounter &apos;OverflowError: cannot convert float infinity to integer&apos;</title>
                <link>https://issues.apache.org/jira/browse/SPARK-35512</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;h2&gt;&lt;a name=&quot;Codesample&quot;&gt;&lt;/a&gt;Code sample&lt;/h2&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-python&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;# pyspark
&lt;/span&gt;rdd = ...
new_rdd = rdd.partitionBy(64)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;An OverflowError is raised when there is a &lt;font color=&quot;#ff0000&quot;&gt;big input file&lt;/font&gt; and &lt;font color=&quot;#ff0000&quot;&gt;executor memory&lt;/font&gt; is not big enough.&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;Errorinformation%3A%C2%A0&quot;&gt;&lt;/a&gt;Error information:&#160;&lt;/h2&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
TaskSetManager: Lost task 312.0 in stage 1.0 (TID 748, 11.4.137.5, executor 83): org.apache.spark.api.python.PythonException: Traceback (most recent call last):
File &lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/spark3/python/lib/pyspark.zip/pyspark/worker.py&quot;&lt;/span&gt;, line 605, in main
process()
File &lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/spark3/python/lib/pyspark.zip/pyspark/worker.py&quot;&lt;/span&gt;, line 597, in process
serializer.dump_stream(out_iter, outfile)
File &lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/spark3/python/lib/pyspark.zip/pyspark/serializers.py&quot;&lt;/span&gt;, line 141, in dump_stream
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; obj in iterator:
File &lt;span class=&quot;code-quote&quot;&gt;&quot;/opt/spark3/python/lib/pyspark.zip/pyspark/rdd.py&quot;&lt;/span&gt;, line 1899, in add_shuffle_key
OverflowError: cannot convert &lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt; infinity to integer
at org.apache.spark.api.python.BasePythonRunner$ReaderIterator.handlePythonException(PythonRunner.scala:503)
at org.apache.spark.api.python.PythonRunner$$anon$3.read(PythonRunner.scala:638)
at org.apache.spark.api.python.PythonRunner$$anon$3.read(PythonRunner.scala:621)
at org.apache.spark.api.python.BasePythonRunner$ReaderIterator.hasNext(PythonRunner.scala:456)
at org.apache.spark.InterruptibleIterator.hasNext(InterruptibleIterator.scala:37)
at scala.collection.Iterator$GroupedIterator.fill(Iterator.scala:1209)
at scala.collection.Iterator$GroupedIterator.hasNext(Iterator.scala:1215)
at scala.collection.Iterator$$anon$10.hasNext(Iterator.scala:458)
at org.apache.spark.shuffle.sort.BypassMergeSortShuffleWriter.write(BypassMergeSortShuffleWriter.java:156)
at org.apache.spark.shuffle.ShuffleWriteProcessor.write(ShuffleWriteProcessor.scala:59)
at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:99)
at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:52)
at org.apache.spark.scheduler.Task.run(Task.scala:130)
at org.apache.spark.executor.Executor$TaskRunner.$anonfun$run$3(Executor.scala:444)
at org.apache.spark.util.Utils$.tryWithSafeFinally(Utils.scala:1420)
at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:447)
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;h2&gt;&lt;a name=&quot;Sparkcode&quot;&gt;&lt;/a&gt;Spark code&lt;/h2&gt;

&lt;p&gt;&#160;&lt;a href=&quot;https://github.com/apache/spark/blob/master/python/pyspark/rdd.py#L2072&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/python/pyspark/rdd.py#L2072&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-python&quot;&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; k, v &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; iterator:
                buckets[partitionFunc(k) % numPartitions].append((k, v))
                c += 1                &lt;span class=&quot;code-comment&quot;&gt;# check used memory &lt;span class=&quot;code-keyword&quot;&gt;and&lt;/span&gt; avg size of chunk of objects 
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (c % 1000 == 0 &lt;span class=&quot;code-keyword&quot;&gt;and&lt;/span&gt; get_used_memory() &amp;gt; limit
                        &lt;span class=&quot;code-keyword&quot;&gt;or&lt;/span&gt; c &amp;gt; batch):
                    n, size = &lt;span class=&quot;code-object&quot;&gt;len&lt;/span&gt;(buckets), 0
                    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; split &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;list&lt;/span&gt;(buckets.keys()):
                        &lt;span class=&quot;code-keyword&quot;&gt;yield&lt;/span&gt; pack_long(split)
                        d = outputSerializer.dumps(buckets[split])
                        &lt;span class=&quot;code-keyword&quot;&gt;del&lt;/span&gt; buckets[split]
                        &lt;span class=&quot;code-keyword&quot;&gt;yield&lt;/span&gt; d
                        size += &lt;span class=&quot;code-object&quot;&gt;len&lt;/span&gt;(d)                    avg = &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;(size / n) &amp;gt;&amp;gt; 20
                    &lt;span class=&quot;code-comment&quot;&gt;# let 1M &amp;lt; avg &amp;lt; 10M
&lt;/span&gt;                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; avg &amp;lt; 1:
                        batch *= 1.5
                    &lt;span class=&quot;code-keyword&quot;&gt;elif&lt;/span&gt; avg &amp;gt; 10:
                        batch = &lt;span class=&quot;code-object&quot;&gt;max&lt;/span&gt;(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;(batch / 1.5), 1)
                    c = 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;h2&gt;&lt;a name=&quot;Explanation&quot;&gt;&lt;/a&gt;Explanation&lt;/h2&gt;

&lt;p&gt;&lt;b&gt;`batch`&lt;/b&gt; may grow infinity when `&lt;b&gt;get_used_memory() &amp;gt; limit&lt;/b&gt;` is true, then overflow at `&lt;b&gt;max(int(batch / 1.5), 1)&lt;/b&gt;`&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13380270">SPARK-35512</key>
            <summary>pyspark partitionBy may encounter &apos;OverflowError: cannot convert float infinity to integer&apos;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nolan.liou">nolan liu</assignee>
                                    <reporter username="nolan.liou">nolan liu</reporter>
                        <labels>
                    </labels>
                <created>Tue, 25 May 2021 08:49:45 +0000</created>
                <updated>Mon, 12 Dec 2022 18:10:52 +0000</updated>
                            <resolved>Wed, 9 Jun 2021 01:59:18 +0000</resolved>
                                    <version>3.0.2</version>
                                    <fixVersion>3.2.0</fixVersion>
                                    <component>PySpark</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17351461" author="apachespark" created="Wed, 26 May 2021 03:27:58 +0000"  >&lt;p&gt;User &apos;nolanliou&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32667&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32667&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17359696" author="gurwls223" created="Wed, 9 Jun 2021 01:59:18 +0000"  >&lt;p&gt;Issue resolved by pull request 32667&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32667&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32667&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 22 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0rcew:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>