<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:33:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-10960] SQL with windowing function cannot reference column in inner select block</title>
                <link>https://issues.apache.org/jira/browse/SPARK-10960</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;There seems to be a bug in the Spark SQL parser when I use windowing functions. Specifically, when the SELECT refers to a column from an inner select block, the parser throws an error.&lt;/p&gt;

&lt;p&gt;Here is an example:&lt;br/&gt;
--------------------------&lt;br/&gt;
When I use a windowing function and add a &apos;1&apos; constant to the result, &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;   select Rank() OVER ( ORDER BY D1.c3 ) + 1 as c1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The Spark SQL parser works. The whole SQL is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;select Rank() OVER ( ORDER BY D1.c3 ) + 1 as c1,
                         D1.c3 as c3,
                         D1.c4 as c4,
                         D1.c5 as c5
                    from 
                         (select T3671.ROW_WID as c3,
                                   T3671.CAL_MONTH as c4,
                                   T3671.CAL_YEAR as c5,
                                   1 as c6
                              from 
                                   W_DAY_D T3671
                         ) D1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, if I change the projection so that it refers to a column in an inner select block, D1.C6, whose value is itself a &apos;1&apos; literal, so it is functionally equivalent to the SQL above, Spark SQL will throw an error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;select Rank() OVER ( ORDER BY D1.c3 ) + D1.C6 as c1,
                         D1.c3 as c3,
                         D1.c4 as c4,
                         D1.c5 as c5
                    from 
                         (select T3671.ROW_WID as c3,
                                   T3671.CAL_MONTH as c4,
                                   T3671.CAL_YEAR as c5,
                                   1 as c6
                              from 
                                   W_DAY_D T3671
                         ) D1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The error message is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;. . . . . . . . . . . . . . . .&amp;gt; java.lang.NullPointerException
Error: org.apache.spark.sql.AnalysisException: resolved attribute(s) c6#3386 missing from c5#3390
,c3#3383,c4#3389,_we0#3461,c3#3388 in &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; !Project [c3#3388,c4#3389,c5#3390,c3#3383,_we0#346
1,(_we0#3461 + c6#3386) AS c1#3387]; (state=,code=0)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The above example is a simplified version of the SQL I was testing. The full SQL I was using, which fails with a similar error, is as follows:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;select Case when &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; D1.c6 when 1 then D1.c3 &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; NULL end  is not &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; then Rank() OVER ( ORDER BY &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; when ( &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; D1.c6 when 1 then D1.c3 &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; NULL end  ) is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; then 1 &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; 0 end, &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; D1.c6 when 1 then D1.c3 &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; NULL end ) end as c1,
                         Case when &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; D1.c7 when 1 then D1.c3 &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; NULL end  is not &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; then Rank() OVER ( PARTITION BY D1.c4, D1.c5 ORDER BY &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; when ( &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; D1.c7 when 1 then D1.c3 &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; NULL end  ) is &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; then 1 &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; 0 end, &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; D1.c7 when 1 then D1.c3 &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; NULL end ) end as c2,
                         D1.c3 as c3,
                         D1.c4 as c4,
                         D1.c5 as c5
                    from 
                         (select T3671.ROW_WID as c3,
                                   T3671.CAL_MONTH as c4,
                                   T3671.CAL_YEAR as c5,
                                   ROW_NUMBER() OVER (PARTITION BY T3671.CAL_MONTH, T3671.CAL_YEAR ORDER BY T3671.CAL_MONTH DESC, T3671.CAL_YEAR DESC) as c6,
                                   ROW_NUMBER() OVER (PARTITION BY T3671.CAL_MONTH, T3671.CAL_YEAR, T3671.ROW_WID ORDER BY T3671.CAL_MONTH DESC, T3671.CAL_YEAR DESC, T3671.ROW_WID DESC) as c7
                              from 
                                   W_DAY_D T3671
                         ) D1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Hopefully when fixed, both these sample SQLs should work!&lt;/p&gt;</description>
                <environment></environment>
        <key id="12902822">SPARK-10960</key>
            <summary>SQL with windowing function cannot reference column in inner select block</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="viirya">L. C. Hsieh</assignee>
                                    <reporter username="jeanlucw">David Wong</reporter>
                        <labels>
                    </labels>
                <created>Tue, 6 Oct 2015 21:15:14 +0000</created>
                <updated>Tue, 24 Nov 2015 00:05:10 +0000</updated>
                            <resolved>Mon, 12 Oct 2015 16:20:55 +0000</resolved>
                                    <version>1.4.0</version>
                    <version>1.5.0</version>
                                    <fixVersion>1.4.2</fixVersion>
                    <fixVersion>1.5.2</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14947306" author="apachespark" created="Wed, 7 Oct 2015 18:16:06 +0000"  >&lt;p&gt;User &apos;viirya&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/9011&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/9011&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14953268" author="yhuai" created="Mon, 12 Oct 2015 16:20:55 +0000"  >&lt;p&gt;Issue resolved by pull request 9011&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/9011&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/9011&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15023417" author="jeanlucw" created="Tue, 24 Nov 2015 00:05:10 +0000"  >&lt;p&gt;I can confirm both queries I logged are working in 1.5.2 now. Thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2mnrz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>