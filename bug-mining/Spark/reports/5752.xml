<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:00:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-24230] With Parquet 1.10 upgrade has errors in the vectorized reader</title>
                <link>https://issues.apache.org/jira/browse/SPARK-24230</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When reading some parquet files can get an error like:&lt;/p&gt;

&lt;p&gt;java.io.IOException: expecting more rows but reached last block. Read 0 out of 1194236&lt;/p&gt;

&lt;p&gt;This&#160;happens when looking for a needle thats pretty rare in a large haystack.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The issue here&#160;I believe is that the total row count is calculated at&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/spark/blob/master/sql/core/src/main/java/org/apache/spark/sql/execution/datasources/parquet/SpecificParquetRecordReaderBase.java#L229&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/sql/core/src/main/java/org/apache/spark/sql/execution/datasources/parquet/SpecificParquetRecordReaderBase.java#L229&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;But we pass the blocks we filtered via&#160;&lt;/p&gt;

&lt;p&gt;org.apache.parquet.filter2.compat.RowGroupFilter.filterRowGroups&lt;/p&gt;

&lt;p&gt;to the&#160;ParquetFileReader constructor.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;However the ParquetFileReader constructor will filter the list of blocks again using&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/parquet-mr/blob/master/parquet-hadoop/src/main/java/org/apache/parquet/hadoop/ParquetFileReader.java#L737&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/parquet-mr/blob/master/parquet-hadoop/src/main/java/org/apache/parquet/hadoop/ParquetFileReader.java#L737&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;if a block is filtered out by the latter method, and not the former the&#160;vectorized reader will believe it should see more rows than it will.&lt;/p&gt;

&lt;p&gt;the fix I used locally is pretty straight forward:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (BlockMetaData block : blocks) {
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.totalRowCount += block.getRowCount();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;goes to&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.totalRowCount = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.reader.getRecordCount();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rdblue&quot; class=&quot;user-hover&quot; rel=&quot;rdblue&quot;&gt;rdblue&lt;/a&gt; do you know if this sounds right?&#160;The second filter method in the ParquetFileReader might filter more blocks leading to the count being off?&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13158319">SPARK-24230</key>
            <summary>With Parquet 1.10 upgrade has errors in the vectorized reader</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rdblue">Ryan Blue</assignee>
                                    <reporter username="ianoc">Ian O Connell</reporter>
                        <labels>
                    </labels>
                <created>Wed, 9 May 2018 23:07:46 +0000</created>
                <updated>Thu, 24 May 2018 13:01:59 +0000</updated>
                            <resolved>Thu, 24 May 2018 13:01:59 +0000</resolved>
                                    <version>2.4.0</version>
                                    <fixVersion>2.3.1</fixVersion>
                    <fixVersion>2.4.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16469656" author="rdblue" created="Wed, 9 May 2018 23:14:19 +0000"  >&lt;p&gt;Looks like I have a fix for this that I missed when submitting the patch for 1.10.0. Here it is:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
--- a/sql/core/src/main/java/org/apache/spark/sql/execution/datasources/parquet/SpecificParquetRecordReaderBase.java
+++ b/sql/core/src/main/java/org/apache/spark/sql/execution/datasources/parquet/SpecificParquetRecordReaderBase.java
@@ -148,7 +148,8 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SpecificParquetRecordReaderBase&amp;lt;T&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; RecordReader&amp;lt;Vo
     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sparkSchema = StructType$.MODULE$.fromString(sparkRequestedSchemaString);
     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.reader = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ParquetFileReader(
         configuration, footer.getFileMetaData(), file, blocks, requestedSchema.getColumns());
-    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (BlockMetaData block : blocks) {
+    &lt;span class=&quot;code-comment&quot;&gt;// use the blocks from the reader in &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; some &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not match filters and will not be read
&lt;/span&gt;+    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (BlockMetaData block : reader.getRowGroups()) {
       &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.totalRowCount += block.getRowCount();
     }
 
@@ -224,7 +225,8 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SpecificParquetRecordReaderBase&amp;lt;T&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; RecordReader&amp;lt;Vo
     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sparkSchema = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ParquetToSparkSchemaConverter(config).convert(requestedSchema);
     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.reader = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ParquetFileReader(
         config, footer.getFileMetaData(), file, blocks, requestedSchema.getColumns());
-    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (BlockMetaData block : blocks) {
+    &lt;span class=&quot;code-comment&quot;&gt;// use the blocks from the reader in &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; some &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not match filters and will not be read
&lt;/span&gt;+    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (BlockMetaData block : reader.getRowGroups()) {
       &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.totalRowCount += block.getRowCount();
     }
   }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;ll submit a PR to fix this. Thanks for reporting it!&lt;/p&gt;</comment>
                            <comment id="16469658" author="ianoc" created="Wed, 9 May 2018 23:18:26 +0000"  >&lt;p&gt;Great, thanks!&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;(I think its probably worth just using the reader.getRecordCount&#160;since the identical logic is already in the&#160;file reader we want)&lt;/p&gt;</comment>
                            <comment id="16470948" author="apachespark" created="Thu, 10 May 2018 18:57:07 +0000"  >&lt;p&gt;User &apos;rdblue&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21295&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21295&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 27 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3tjjj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>