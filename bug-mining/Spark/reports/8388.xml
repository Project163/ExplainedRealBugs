<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:29:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-36553] KMeans fails with NegativeArraySizeException for K = 50000 after issue #27758 was introduced</title>
                <link>https://issues.apache.org/jira/browse/SPARK-36553</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;We are running KMeans on approximately 350M rows of x, y, z coordinates using the following configuration:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
KMeans(
  featuresCol=&lt;span class=&quot;code-quote&quot;&gt;&apos;features&apos;&lt;/span&gt;,
  predictionCol=&lt;span class=&quot;code-quote&quot;&gt;&apos;centroid_id&apos;&lt;/span&gt;,
  k=50000,
  initMode=&lt;span class=&quot;code-quote&quot;&gt;&apos;k-means||&apos;&lt;/span&gt;,
  initSteps=2,
  tol=0.00005,
  maxIter=20,
  seed=SEED,
  distanceMeasure=&lt;span class=&quot;code-quote&quot;&gt;&apos;euclidean&apos;&lt;/span&gt;
)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When using Spark 3.0.0 this worked fine, but&#160; when upgrading to 3.1.1 we are consistently getting errors unless we reduce K.&lt;/p&gt;

&lt;p&gt;Stacktrace:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
An error occurred &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; calling o167.fit.An error occurred &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; calling o167.fit.: java.lang.NegativeArraySizeException: -897458648 at scala.reflect.ManifestFactory$DoubleManifest.newArray(Manifest.scala:194) at scala.reflect.ManifestFactory$DoubleManifest.newArray(Manifest.scala:191) at scala.Array$.ofDim(Array.scala:221) at org.apache.spark.mllib.clustering.DistanceMeasure.computeStatistics(DistanceMeasure.scala:52) at org.apache.spark.mllib.clustering.KMeans.runAlgorithmWithWeight(KMeans.scala:280) at org.apache.spark.mllib.clustering.KMeans.runWithWeight(KMeans.scala:231) at org.apache.spark.ml.clustering.KMeans.$anonfun$fit$1(KMeans.scala:354) at org.apache.spark.ml.util.Instrumentation$.$anonfun$instrumented$1(Instrumentation.scala:191) at scala.util.Try$.apply(Try.scala:213) at org.apache.spark.ml.util.Instrumentation$.instrumented(Instrumentation.scala:191) at org.apache.spark.ml.clustering.KMeans.fit(KMeans.scala:329) at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method) at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(Unknown Source) at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source) at java.base/java.lang.reflect.Method.invoke(Unknown Source) at py4j.reflection.MethodInvoker.invoke(MethodInvoker.java:244) at py4j.reflection.ReflectionEngine.invoke(ReflectionEngine.java:357) at py4j.Gateway.invoke(Gateway.java:282) at py4j.commands.AbstractCommand.invokeMethod(AbstractCommand.java:132) at py4j.commands.CallCommand.execute(CallCommand.java:79) at py4j.GatewayConnection.run(GatewayConnection.java:238) at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(Unknown Source)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The issue is introduced by&#160;&lt;a href=&quot;#diff-725d4624ddf4db9cc51721c2ddaef50a1bc30e7b471e0439da28c5b5582efdfdR52&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;#27758&lt;/a&gt;] which significantly reduces the maximum value of K. Snippit of line that throws error from&#160;&lt;a href=&quot;#L52&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;DistanceMeasure.scala:&lt;/a&gt;]&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val packedValues = Array.ofDim[&lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;](k * (k + 1) / 2)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;What we have tried:&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Reducing iterations&lt;/li&gt;
	&lt;li&gt;Reducing input volume&lt;/li&gt;
	&lt;li&gt;Reducing K&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Only reducing K have yielded success.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Possible workaround:&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Roll back to Spark 3.0.0 since a KMeansModel generated with 3.0.0 cannot be loaded in 3.1.1.&lt;/li&gt;
	&lt;li&gt;Reduce K. Currently trying with 45000.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;What we don&apos;t understand&lt;/b&gt;:&lt;/p&gt;

&lt;p&gt;Given the line of code above, we do not understand why we would get an integer overflow.&lt;/p&gt;

&lt;p&gt;For K=50,000, packedValues should be allocated with the size of 1,250,025,000 &amp;lt; (2^31) and not result in a negative array size.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Suggested resolution:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;I&apos;m not strong in the inner workings on KMeans, but my immediate thought would be to add a fallback to previous logic for K larger than a set threshold if the optimisation is to stay in place, as it breaks compatibility from 3.0.0 to 3.1.1 for edge cases.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Please let me know if more information is needed, this is my first time raising a bug for a OS.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13396348">SPARK-36553</key>
            <summary>KMeans fails with NegativeArraySizeException for K = 50000 after issue #27758 was introduced</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="podongfeng">Ruifeng Zheng</assignee>
                                    <reporter username="anders.rydbirk">Anders Rydbirk</reporter>
                        <labels>
                    </labels>
                <created>Fri, 20 Aug 2021 11:49:47 +0000</created>
                <updated>Wed, 2 Mar 2022 19:55:57 +0000</updated>
                            <resolved>Wed, 2 Mar 2022 19:55:57 +0000</resolved>
                                    <version>3.1.1</version>
                                    <fixVersion>3.1.3</fixVersion>
                    <fixVersion>3.3.0</fixVersion>
                    <fixVersion>3.2.2</fixVersion>
                                    <component>ML</component>
                    <component>MLlib</component>
                    <component>PySpark</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17489278" author="podongfeng" created="Wed, 9 Feb 2022 06:33:40 +0000"  >&lt;p&gt;it is a overflow:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
scala&amp;gt; val k = 50000
val k: Int = 50000

scala&amp;gt; k * (k + 1) / 2
val res1: Int = -897458648
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17489281" author="apachespark" created="Wed, 9 Feb 2022 06:39:37 +0000"  >&lt;p&gt;User &apos;zhengruifeng&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/35457&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/35457&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13288730">SPARK-31007</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 39 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0u3gw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>