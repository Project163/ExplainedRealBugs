<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:07:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-29503] MapObjects doesn&apos;t copy Unsafe data when nested under Safe data</title>
                <link>https://issues.apache.org/jira/browse/SPARK-29503</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;In order for MapObjects to operate safely, it checks to see if the result of the mapping function is an Unsafe type (UnsafeRow, UnsafeArrayData, UnsafeMapData) and performs a copy before writing it into MapObjects&apos; output array. This is to protect against expressions which re-use the same native memory buffer to represent its result across evaluations; if the copy wasn&apos;t here, all results would be pointing to the same native buffer and would represent the last result written to the buffer. However, MapObjects misses this needed copy if the Unsafe data is nested below some safe structure, for instance a GenericArrrayData whose elements are all UnsafeRows. In this scenario, all elements of the GenericArrayData will be pointing to the same native UnsafeRow buffer which will hold the last value written to it.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Right now, this bug seems to only occur when a `ProjectExec` goes down the `execute` path, as opposed to WholeStageCodegen&apos;s `produce` and `consume` path.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Example Reproduction Code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.objects.MapObjects
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.CreateArray
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.Expression
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.functions.{array, struct}
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.Column
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.types.ArrayType

&lt;span class=&quot;code-comment&quot;&gt;// For the purpose of demonstration, we need to disable WholeStage codegen
&lt;/span&gt;spark.conf.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;spark.sql.codegen.wholeStage&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;)

&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; exampleDS = spark.sparkContext.parallelize(Seq(Seq(1, 2, 3))).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;items&quot;&lt;/span&gt;)

&lt;span class=&quot;code-comment&quot;&gt;// Trivial example: Nest unsafe struct inside safe array
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// items: Seq[Int] =&amp;gt; items.map{item =&amp;gt; Seq(Struct(item))}
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; result = exampleDS.select(    
    &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Column(MapObjects(
        {item: Expression =&amp;gt; array(struct(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Column(item))).expr},
        $&lt;span class=&quot;code-quote&quot;&gt;&quot;items&quot;&lt;/span&gt;.expr,
        exampleDS.schema(&lt;span class=&quot;code-quote&quot;&gt;&quot;items&quot;&lt;/span&gt;).dataType.asInstanceOf[ArrayType].elementType
    )) as &lt;span class=&quot;code-quote&quot;&gt;&quot;items&quot;&lt;/span&gt;
)

result.show(10, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Actual Output:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+---------------------------------------------------------+
|items                                                    |
+---------------------------------------------------------+
|[WrappedArray([3]), WrappedArray([3]), WrappedArray([3])]|
+---------------------------------------------------------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Expected Output:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+---------------------------------------------------------+
|items                                                    |
+---------------------------------------------------------+
|[WrappedArray([1]), WrappedArray([2]), WrappedArray([3])]|
+---------------------------------------------------------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We&apos;ve confirmed that the bug exists on version 2.1.1 as well as on master (which I assume corresponds to version 3.0.0?)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13262915">SPARK-29503</key>
            <summary>MapObjects doesn&apos;t copy Unsafe data when nested under Safe data</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kabhwan">Jungtaek Lim</assignee>
                                    <reporter username="aaronlewism">Aaron Lewis</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Thu, 17 Oct 2019 17:50:04 +0000</created>
                <updated>Mon, 2 Mar 2020 21:49:58 +0000</updated>
                            <resolved>Wed, 23 Oct 2019 17:07:53 +0000</resolved>
                                    <version>2.1.1</version>
                    <version>2.2.3</version>
                    <version>2.3.4</version>
                    <version>2.4.5</version>
                    <version>3.0.0</version>
                                    <fixVersion>3.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16955090" author="kabhwan" created="Sat, 19 Oct 2019 06:56:04 +0000"  >&lt;p&gt;Thanks for reporting the issue in super detailed information! I&apos;ve submitted a PR based on your observation. Please take a look.&lt;/p&gt;</comment>
                            <comment id="16958036" author="cloud_fan" created="Wed, 23 Oct 2019 17:07:54 +0000"  >&lt;p&gt;Issue resolved by pull request 26173&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/26173&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/26173&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 3 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z07p7k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>