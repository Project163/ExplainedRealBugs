<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:34:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-44854] Python timedelta to DayTimeIntervalType edge cases bug</title>
                <link>https://issues.apache.org/jira/browse/SPARK-44854</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;h1&gt;&lt;a name=&quot;PythonTimedeltatoPySparkDayTimeIntervalTypebug&quot;&gt;&lt;/a&gt;Python Timedelta to PySpark DayTimeIntervalType bug&lt;/h1&gt;

&lt;p&gt;There is a bug that exists which means certain Python datetime.timedelta objects get converted to a PySpark DayTimeIntervalType column with a different value to that which is stored in the Python timedelta.&lt;/p&gt;

&lt;p&gt;A simple illustrative example can be produced with the below code:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
from datetime &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; timedelta
from pyspark.sql.types &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; DayTimeIntervalType, StructField, StructType

spark = ...spark session setup here...

td = timedelta(days=4498031, seconds=16054, microseconds=999981)
df = spark.createDataFrame([(td,)], StructType([StructField(name=&lt;span class=&quot;code-quote&quot;&gt;&quot;timedelta_col&quot;&lt;/span&gt;, dataType=DayTimeIntervalType(), nullable=False)]))
df.show(truncate=False)

&amp;gt; +------------------------------------------------+
&amp;gt; |timedelta_col &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; | 
&amp;gt; +------------------------------------------------+ 
&amp;gt; |INTERVAL &lt;span class=&quot;code-quote&quot;&gt;&apos;4498031 04:27:35.999981&apos;&lt;/span&gt; DAY TO SECOND| 
&amp;gt; +------------------------------------------------+

print(str(td))

&amp;gt;  &lt;span class=&quot;code-quote&quot;&gt;&apos;4498031 days, 4:27:34.999981&apos;&lt;/span&gt; &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In the above example, look at the seconds. The original python timedelta object has 34 seconds, the pyspark DayTimeIntervalType column has 35 seconds.&lt;/p&gt;
&lt;h1&gt;&lt;a name=&quot;Fix&quot;&gt;&lt;/a&gt;Fix&lt;/h1&gt;

&lt;p&gt;This issue arises because the current conversion from python timedelta uses the timedelta function `.total_seconds()` to get the number of seconds, and then adds the microsecond component back in afterwards. Unfortunately the `.total_seconds()` function with some timedeltas (ones with microsecond entries close to 1_000_000 I believe) ends up rounding &lt;b&gt;up&lt;/b&gt; to the nearest second (probably due to floating point precision), with the microseconds then added on top of that. The effect is that 1 second gets added incorrectly.&lt;/p&gt;

&lt;p&gt;The issue can be fixed by doing the processing in a slightly different way. Instead of doing:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
(math.floor(dt.total_seconds()) * 1000000) + dt.microseconds&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Instead we construct the timedelta from its components:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
(((dt.days * 86400) + dt.seconds) * 1_000_000) + dt.microseconds &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;
&lt;h1&gt;&lt;a name=&quot;Tests&quot;&gt;&lt;/a&gt;Tests&lt;/h1&gt;

&lt;p&gt;An illustrative edge case example for timedeltas is the above (which can also be written as `datetime.timedelta(microseconds=388629894454999981)`)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;A related edge case which is already handled but not tested exists for the situation where there are positive and negative components to the created timedelta object. An entry for this edge case is also included as it is related.&lt;/p&gt;
&lt;h1&gt;&lt;a name=&quot;PR&quot;&gt;&lt;/a&gt;PR&lt;/h1&gt;

&lt;p&gt;Link to the PR addressing this issue: &lt;a href=&quot;https://github.com/apache/spark/pull/42541&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/42541&lt;/a&gt;&lt;/p&gt;
&lt;h1&gt;&lt;a name=&quot;Keywordstohelppeoplesearchingforthisissue%3A&quot;&gt;&lt;/a&gt;Keywords to help people searching for this issue:&lt;/h1&gt;

&lt;p&gt;datetime.timedelta&lt;/p&gt;

&lt;p&gt;timedelta&lt;/p&gt;

&lt;p&gt;pyspark.sql.types.DayTimeIntervalType&lt;/p&gt;

&lt;p&gt;DayTimeIntervalType&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13547756">SPARK-44854</key>
            <summary>Python timedelta to DayTimeIntervalType edge cases bug</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="hdaly0">Ocean HD</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 17 Aug 2023 16:57:45 +0000</created>
                <updated>Tue, 22 Aug 2023 02:56:40 +0000</updated>
                            <resolved>Tue, 22 Aug 2023 02:56:40 +0000</resolved>
                                    <version>3.4.0</version>
                                    <fixVersion>3.4.2</fixVersion>
                    <fixVersion>3.5.0</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                    <component>PySpark</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="10800">3h</timeoriginalestimate>
                            <timeestimate seconds="10800">3h</timeestimate>
                                        <comments>
                            <comment id="17757181" author="gurwls223" created="Tue, 22 Aug 2023 02:56:40 +0000"  >&lt;p&gt;Issue resolved by pull request 42541&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/42541&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/42541&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 12 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1juww:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>