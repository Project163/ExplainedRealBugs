<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:32:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-40303] The performance will be worse after codegen</title>
                <link>https://issues.apache.org/jira/browse/SPARK-40303</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.benchmark.Benchmark

&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; dir = &lt;span class=&quot;code-quote&quot;&gt;&quot;/tmp/spark/benchmark&quot;&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; N = 2000000
&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; columns = Range(0, 100).map(i =&amp;gt; s&lt;span class=&quot;code-quote&quot;&gt;&quot;id % $i AS id$i&quot;&lt;/span&gt;)

spark.range(N).selectExpr(columns: _*).write.mode(&lt;span class=&quot;code-quote&quot;&gt;&quot;Overwrite&quot;&lt;/span&gt;).parquet(dir)

&lt;span class=&quot;code-comment&quot;&gt;// Seq(1, 2, 5, 10, 15, 25, 40, 60, 100)
&lt;/span&gt;Seq(60).foreach{ cnt =&amp;gt;
  &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; selectExps = columns.take(cnt).map(_.split(&lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt;).last).map(c =&amp;gt; s&lt;span class=&quot;code-quote&quot;&gt;&quot;count(distinct $c)&quot;&lt;/span&gt;)

  &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; benchmark = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Benchmark(&lt;span class=&quot;code-quote&quot;&gt;&quot;Benchmark count distinct&quot;&lt;/span&gt;, N, minNumIters = 1)
  benchmark.addCase(s&lt;span class=&quot;code-quote&quot;&gt;&quot;$cnt count distinct &lt;span class=&quot;code-keyword&quot;&gt;with&lt;/span&gt; codegen&quot;&lt;/span&gt;) { _ =&amp;gt;
    withSQLConf(
      &lt;span class=&quot;code-quote&quot;&gt;&quot;spark.sql.codegen.wholeStage&quot;&lt;/span&gt; -&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;spark.sql.codegen.factoryMode&quot;&lt;/span&gt; -&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;FALLBACK&quot;&lt;/span&gt;) {
      spark.read.parquet(dir).selectExpr(selectExps: _*).write.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;noop&quot;&lt;/span&gt;).mode(&lt;span class=&quot;code-quote&quot;&gt;&quot;Overwrite&quot;&lt;/span&gt;).save()
    }
  }

  benchmark.addCase(s&lt;span class=&quot;code-quote&quot;&gt;&quot;$cnt count distinct without codegen&quot;&lt;/span&gt;) { _ =&amp;gt;
    withSQLConf(
      &lt;span class=&quot;code-quote&quot;&gt;&quot;spark.sql.codegen.wholeStage&quot;&lt;/span&gt; -&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;spark.sql.codegen.factoryMode&quot;&lt;/span&gt; -&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;NO_CODEGEN&quot;&lt;/span&gt;) {
      spark.read.parquet(dir).selectExpr(selectExps: _*).write.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;noop&quot;&lt;/span&gt;).mode(&lt;span class=&quot;code-quote&quot;&gt;&quot;Overwrite&quot;&lt;/span&gt;).save()
    }
  }
  benchmark.run()
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Java HotSpot(TM) 64-Bit Server VM 1.8.0_281-b09 on Mac OS X 10.15.7
Intel(R) Core(TM) i9-9980HK CPU @ 2.40GHz
Benchmark count distinct:                 Best Time(ms)   Avg Time(ms)   Stdev(ms)    Rate(M/s)   Per Row(ns)   Relative
------------------------------------------------------------------------------------------------------------------------
60 count distinct with codegen                   628146         628146           0          0.0      314072.8       1.0X
60 count distinct without codegen                147635         147635           0          0.0       73817.5       4.3X
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="13479625">SPARK-40303</key>
            <summary>The performance will be worse after codegen</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yumwang">Yuming Wang</assignee>
                                    <reporter username="yumwang">Yuming Wang</reporter>
                        <labels>
                    </labels>
                <created>Thu, 1 Sep 2022 09:04:52 +0000</created>
                <updated>Fri, 20 Jan 2023 17:04:17 +0000</updated>
                            <resolved>Fri, 20 Jan 2023 17:04:17 +0000</resolved>
                                    <version>3.4.0</version>
                                    <fixVersion>3.4.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="17598831" author="q79969786" created="Thu, 1 Sep 2022 09:10:45 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=joshrosen&quot; class=&quot;user-hover&quot; rel=&quot;joshrosen&quot;&gt;joshrosen&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rednaxelafx&quot; class=&quot;user-hover&quot; rel=&quot;rednaxelafx&quot;&gt;rednaxelafx&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17599254" author="luciferyang" created="Fri, 2 Sep 2022 04:42:25 +0000"  >&lt;p&gt;Run use Java 8 with `-XX:+PrintCompilation`, I found the following logs:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
64350 21862 &#160; &#160; &#160; 4 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1::hashAgg_doConsume_0$ (2051 bytes) &#160; COMPILE SKIPPED: unsupported incoming calling sequence (not retryable)
137245 22141 % &#160; &#160; 4 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1::hashAgg_doAggregateWithKeys_0$ @ 38 (2712 bytes) &#160; COMPILE SKIPPED: unsupported calling sequence (not retryable) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rednaxelafx&quot; class=&quot;user-hover&quot; rel=&quot;rednaxelafx&quot;&gt;rednaxelafx&lt;/a&gt; In this case, will compilation optimization degenerate to Level 3 or give up when use Java 8?&lt;/p&gt;</comment>
                            <comment id="17599262" author="luciferyang" created="Fri, 2 Sep 2022 05:03:30 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160;64265 21820 &#160; &#160; &#160; 3 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1::hashAgg_doConsume_0$ (2051 bytes)
&#160; 64308 21862 &#160; &#160; &#160; 4 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1::hashAgg_doConsume_0$ (2051 bytes)
&#160; 64350 21862 &#160; &#160; &#160; 4 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1::hashAgg_doConsume_0$ (2051 bytes) &#160; COMPILE SKIPPED: unsupported incoming calling sequence (not retryable) 
1735350 24101 &#160; &#160; &#160; 3 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage2::hashAgg_doConsume_0$ (2052 bytes)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
103941 22065 % &#160; &#160; 3 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1::hashAgg_doAggregateWithKeys_0$ @ 38 (2712 bytes)
&#160;104602 22067 &#160; &#160; &#160; 3 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1::hashAgg_doAggregateWithKeys_0$ (2712 bytes)
&#160;135979 22141 % &#160; &#160; 4 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1::hashAgg_doAggregateWithKeys_0$ @ 38 (2712 bytes)
&#160;137245 22141 % &#160; &#160; 4 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1::hashAgg_doAggregateWithKeys_0$ @ 38 (2712 bytes) &#160; COMPILE SKIPPED: unsupported calling sequence (not retryable) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The compilation relevant&#160; logs are as above when Java 8 is used&lt;/p&gt;</comment>
                            <comment id="17599263" author="luciferyang" created="Fri, 2 Sep 2022 05:06:39 +0000"  >&lt;p&gt;If run with Java 17, the performance gap will be smaller. The compilation logs of `hashAgg_doConsume_0` and `hashAgg_doAggregateWithKeys_0` as follows:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160;102158 22568 &#160; &#160; &#160; 3 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1::hashAgg_doConsume_0$ (2051 bytes)
&#160;102180 22606 &#160; &#160; &#160; 4 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1::hashAgg_doConsume_0$ (2051 bytes)
&#160;102228 22606 &#160; &#160; &#160; 4 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1::hashAgg_doConsume_0$ (2051 bytes) &#160; COMPILE SKIPPED: unsupported incoming calling sequence (retry at different tier)
&#160;102228 22619 &#160; &#160; &#160; 1 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1::hashAgg_doConsume_0$ (2051 bytes)
&#160;102240 22568 &#160; &#160; &#160; 3 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1::hashAgg_doConsume_0$ (2051 bytes) &#160; made not entrant
&#160;218296 24067 &#160; &#160; &#160; 3 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage2::hashAgg_doConsume_0$ (2052 bytes)
&#160;218463 22568 &#160; &#160; &#160; 3 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1::hashAgg_doConsume_0$ (2051 bytes) &#160; made zombie &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
105832 22708 % &#160; &#160; 3 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1::hashAgg_doAggregateWithKeys_0$ @ 38 (2712 bytes)
&#160;105955 22709 &#160; &#160; &#160; 3 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1::hashAgg_doAggregateWithKeys_0$ (2712 bytes)
&#160;108247 22741 % &#160; &#160; 4 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1::hashAgg_doAggregateWithKeys_0$ @ 38 (2712 bytes)
&#160;108484 22741 % &#160; &#160; 4 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1::hashAgg_doAggregateWithKeys_0$ @ 38 (2712 bytes) &#160; COMPILE SKIPPED: unsupported calling sequence (retry at different tier)
&#160;108727 22708 % &#160; &#160; 3 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1::hashAgg_doAggregateWithKeys_0$ @ 38 (2712 bytes) &#160; made not entrant
&#160;108727 22743 % &#160; &#160; 1 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1::hashAgg_doAggregateWithKeys_0$ @ 38 (2712 bytes)
&#160;218463 22708 % &#160; &#160; 3 &#160; &#160; &#160; org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1::hashAgg_doAggregateWithKeys_0$ @ 38 (2712 bytes) &#160; made zombie &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17599302" author="rednaxelafx" created="Fri, 2 Sep 2022 07:57:51 +0000"  >&lt;p&gt;Interesting, thanks for posting your findings, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=LuciferYang&quot; class=&quot;user-hover&quot; rel=&quot;LuciferYang&quot;&gt;LuciferYang&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;In the JDK8 case, the message:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
COMPILE SKIPPED: unsupported calling sequence (not retryable)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Indicates that the compiler deemed this method should not be attempted to compile again on any tier of compilation, and because this is an OSR compilation (i.e. loop compilation), this will mark the method as &quot;never try to perform OSR compilation again on all tiers&quot;. On JDK17 this is relaxed a bit and it&apos;ll try tier 1.&lt;/p&gt;

&lt;p&gt;Note that OSR compilation and STD compilation (normal compilation) are separate things. Marking one as not compilation doesn&apos;t affect the other. I haven&apos;t checked the IR yet but if I had to guess, the reason why this method is recorded as not OSR compilable is because there are too many live local variables at the OSR (loop) entry point, beyond what the HotSpot JVM could support.&lt;br/&gt;
So only OSR is affected, STD should still be fine.&lt;/p&gt;

&lt;p&gt;In general, the tiered compilation system in the HotSpot JVM works as:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;tier 0: interpreter&lt;/li&gt;
	&lt;li&gt;tier 1: C1 no profiling (best code quality for C1, same as HotSpot Client VM&apos;s C1)&lt;/li&gt;
	&lt;li&gt;tier 2: C1 basic profiling (lower performance than tier 1, only used when the target level is tier 3 but the C1 queue is too long)&lt;/li&gt;
	&lt;li&gt;tier 3: C1 full profiling (lower performance than tier 2, for collecting profile to perform tier 4 profile-guided optimization)&lt;/li&gt;
	&lt;li&gt;tier 4: C2&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;As such, tiers 2 and 3 are only useful if tier 4 is available. So if a method is recorded as &quot;not compilable on tier 4&quot;, the only realistic option left is to try tier 1.&lt;/p&gt;</comment>
                            <comment id="17599314" author="luciferyang" created="Fri, 2 Sep 2022 08:34:59 +0000"  >&lt;p&gt;do some investigate on linux with spark `local&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;` module, maybe help:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Upgrading to Java 17 will significantly improve performance (about 10times over Java 8: From 20 minutes to 1.9 minutes)&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;When using Java 8, adding `spark.sql.CodeGenerator.validParamLength = 48` is helpful for performance improvement (From 20 minutes to 3.1 minutes)&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17599332" author="luciferyang" created="Fri, 2 Sep 2022 08:55:07 +0000"  >&lt;p&gt;Thank you for your explain, very clear &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rednaxelafx&quot; class=&quot;user-hover&quot; rel=&quot;rednaxelafx&quot;&gt;rednaxelafx&lt;/a&gt; .&lt;/p&gt;

&lt;p&gt;I guess this may related to the number of `doConsume` method parameters. After some experiments, I found when the number of parameters exceeds 50, the performance of the case in the Jira description will significant deterioration.&lt;/p&gt;

&lt;p&gt;If need change the code, maybe try to make the input parameters of the `doConsume` method fixed length will help, such as using a List or Array, but this will lose the parameter type, and I am not sure whether it is feasible in practice&lt;/p&gt;</comment>
                            <comment id="17599616" author="rednaxelafx" created="Fri, 2 Sep 2022 16:52:33 +0000"  >&lt;p&gt;Nice findings &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=LuciferYang&quot; class=&quot;user-hover&quot; rel=&quot;LuciferYang&quot;&gt;LuciferYang&lt;/a&gt;!&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;After some experiments, I found when the number of parameters exceeds 50, the performance of the case in the Jira description will significant deterioration.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Sounds reasonable. Note that in a STD compilation, the only things that need to be live at the method entry are the method parameters (both implicit ones like &lt;tt&gt;this&lt;/tt&gt;, and explicit ones); however, for an OSR compilation, it would be all of the parameters/local variables that are live at the loop entry point, so in this case both the &lt;tt&gt;doConsume&lt;/tt&gt; parameters and the local variables contribute to the problem.&lt;/p&gt;

&lt;p&gt;Just FYI I have an old write on PrintCompilation and OSR here: &lt;a href=&quot;https://gist.github.com/rednaxelafx/1165804#file-notes-md&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/rednaxelafx/1165804#file-notes-md&lt;/a&gt;&lt;br/&gt;
(Gee, just realized that was from 11 years ago.......)&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;maybe try to make the input parameters of the `doConsume` method fixed length will help, such as using a List or Array&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Welp, hoisting the parameters into an Arguments object is rather common in &quot;code splitting&quot; in code generators. Since we&apos;re already doing codegen, it&apos;s possible to generate tailor-made Arguments classes to retain the type information. Using List/Array would require extra boxing for primitive types and it&apos;s less ideal.&lt;br/&gt;
(An array-based box is already used in Spark SQL&apos;s codegen in the form of the &lt;tt&gt;references&lt;/tt&gt; array. Indeed the type info is lost on the interface level and you&apos;d have to do a cast when you get data out of it. It&apos;s still usable though.)&lt;/p&gt;</comment>
                            <comment id="17603883" author="luciferyang" created="Wed, 14 Sep 2022 05:23:11 +0000"  >&lt;p&gt;I did a simple experiment to compare the following scenarios&#65306;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;A method with 127 input parameters&lt;/li&gt;
	&lt;li&gt;Encapsulate the input parameters of the above method as a specific type, including 127 fields, and create a new parameter object before each call&lt;/li&gt;
	&lt;li&gt;Encapsulate the input parameters of the above method as a specific type, including 127 fields, reuse one parameter object and reset + refill parameter data before each call&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I confirmed that the JIT compilation failure mentioned above will occur in the 1&amp;amp;2 test scenarios&#65292; the test result as follows:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Java 8&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
OpenJDK 64-Bit Server VM 1.8.0_345-b01 on Linux 5.15.0-1019-azure
Intel(R) Xeon(R) Platinum 8171M CPU @ 2.60GHz
Test sum: &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Best Time(ms) &#160; Avg Time(ms) &#160; Stdev(ms) &#160; &#160;Rate(M/s) &#160; Per Row(ns) &#160; Relative
------------------------------------------------------------------------------------------------------------------------
Use multiple parameters method &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;35772 &#160; &#160; &#160; &#160; &#160;36161 &#160; &#160; &#160; &#160; 550 &#160; &#160; &#160; &#160; &#160;0.3 &#160; &#160; &#160; &#160;3577.2 &#160; &#160; &#160; 1.0X
Use TestParameters create &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 38701 &#160; &#160; &#160; &#160; &#160;38783 &#160; &#160; &#160; &#160; 115 &#160; &#160; &#160; &#160; &#160;0.3 &#160; &#160; &#160; &#160;3870.1 &#160; &#160; &#160; 0.9X
Use TestParameters reuse &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;17986 &#160; &#160; &#160; &#160; &#160;18125 &#160; &#160; &#160; &#160; 196 &#160; &#160; &#160; &#160; &#160;0.6 &#160; &#160; &#160; &#160;1798.6 &#160; &#160; &#160; 2.0X &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Java 11&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
OpenJDK 64-Bit Server VM 11.0.16+8-LTS on Linux 5.15.0-1019-azure
Intel(R) Xeon(R) Platinum 8370C CPU @ 2.80GHz
Test sum: &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Best Time(ms) &#160; Avg Time(ms) &#160; Stdev(ms) &#160; &#160;Rate(M/s) &#160; Per Row(ns) &#160; Relative
------------------------------------------------------------------------------------------------------------------------
Use multiple parameters method &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;12253 &#160; &#160; &#160; &#160; &#160;12286 &#160; &#160; &#160; &#160; &#160;46 &#160; &#160; &#160; &#160; &#160;0.8 &#160; &#160; &#160; &#160;1225.3 &#160; &#160; &#160; 1.0X
Use TestParameters create &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 13644 &#160; &#160; &#160; &#160; &#160;13665 &#160; &#160; &#160; &#160; &#160;30 &#160; &#160; &#160; &#160; &#160;0.7 &#160; &#160; &#160; &#160;1364.4 &#160; &#160; &#160; 0.9X
Use TestParameters reuse &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;13188 &#160; &#160; &#160; &#160; &#160;13219 &#160; &#160; &#160; &#160; &#160;44 &#160; &#160; &#160; &#160; &#160;0.8 &#160; &#160; &#160; &#160;1318.8 &#160; &#160; &#160; 0.9X &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Java 17&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
OpenJDK 64-Bit Server VM 17.0.4+8-LTS on Linux 5.15.0-1019-azure
Intel(R) Xeon(R) CPU E5-2673 v3 @ 2.40GHz
Test sum: &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Best Time(ms) &#160; Avg Time(ms) &#160; Stdev(ms) &#160; &#160;Rate(M/s) &#160; Per Row(ns) &#160; Relative
------------------------------------------------------------------------------------------------------------------------
Use multiple parameters method &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;14044 &#160; &#160; &#160; &#160; &#160;14128 &#160; &#160; &#160; &#160; 119 &#160; &#160; &#160; &#160; &#160;0.7 &#160; &#160; &#160; &#160;1404.4 &#160; &#160; &#160; 1.0X
Use TestParameters create &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 16174 &#160; &#160; &#160; &#160; &#160;16289 &#160; &#160; &#160; &#160; 162 &#160; &#160; &#160; &#160; &#160;0.6 &#160; &#160; &#160; &#160;1617.4 &#160; &#160; &#160; 0.9X
Use TestParameters reuse &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;15633 &#160; &#160; &#160; &#160; &#160;15638 &#160; &#160; &#160; &#160; &#160; 8 &#160; &#160; &#160; &#160; &#160;0.6 &#160; &#160; &#160; &#160;1563.3 &#160; &#160; &#160; 0.9X &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;From the test results, encapsulating and reusing specific parameter types will only alleviate the problem when using Java 8, but running programs using Java 11 or Java 17 seems to be a simpler and more effective way.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;So for the current issue, I suggest upgrading the Java runtime environment to solve the problem. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yumwang&quot; class=&quot;user-hover&quot; rel=&quot;yumwang&quot;&gt;yumwang&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Uploaded the test program to the attachment&lt;/p&gt;</comment>
                            <comment id="17608003" author="q79969786" created="Wed, 21 Sep 2022 23:50:14 +0000"  >&lt;p&gt;Issue fixed by &lt;a href=&quot;https://bugs.openjdk.org/browse/JDK-8159720&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JDK-8159720&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17619978" author="q79969786" created="Wed, 19 Oct 2022 04:10:03 +0000"  >&lt;p&gt;How to run benchmark code:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Download latest spark: &lt;a href=&quot;https://spark.apache.org/downloads.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://spark.apache.org/downloads.html&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;start spark-shell
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sh&quot;&gt;
tar -zxf spark-3.3.1-bin-hadoop3.tgz
cd spark-3.3.1-bin-hadoop3
bin/spark-shell --master &lt;span class=&quot;code-quote-red&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;local&lt;/span&gt;[2]&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;&#160;Run benchmark code:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; dir = &lt;span class=&quot;code-quote&quot;&gt;&quot;/tmp/spark/benchmark&quot;&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; N = 2000000
&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; columns = Range(0, 100).map(i =&amp;gt; s&lt;span class=&quot;code-quote&quot;&gt;&quot;id % $i AS id$i&quot;&lt;/span&gt;)

spark.range(N).selectExpr(columns: _*).write.mode(&lt;span class=&quot;code-quote&quot;&gt;&quot;Overwrite&quot;&lt;/span&gt;).parquet(dir)

Seq(40, 60).foreach { cnt =&amp;gt;
  &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; selectExps = columns.take(cnt).map(_.split(&lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt;).last).map(c =&amp;gt; s&lt;span class=&quot;code-quote&quot;&gt;&quot;count(distinct $c)&quot;&lt;/span&gt;)
  &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; start = System.currentTimeMillis()
  spark.read.parquet(dir).selectExpr(selectExps: _*).collect()
  println(cnt + &lt;span class=&quot;code-quote&quot;&gt;&quot;|&quot;&lt;/span&gt; + (System.currentTimeMillis() - start))
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;&#160;Output:
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Before:
40|280273
60|581743
After backport JDK-8159720 to JDK 8:
40|20582
60|49688
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;


</comment>
                            <comment id="17679103" author="apachespark" created="Fri, 20 Jan 2023 10:50:08 +0000"  >&lt;p&gt;User &apos;wangyum&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/39671&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/39671&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17679104" author="apachespark" created="Fri, 20 Jan 2023 10:50:55 +0000"  >&lt;p&gt;User &apos;wangyum&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/39671&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/39671&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17679230" author="dongjoon" created="Fri, 20 Jan 2023 17:04:17 +0000"  >&lt;p&gt;Issue resolved by pull request 39671&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/39671&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/39671&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13480055">SPARK-40331</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13049263" name="TestApiBenchmark.scala" size="7444" author="LuciferYang" created="Wed, 14 Sep 2022 05:23:32 +0000"/>
                            <attachment id="13049264" name="TestApis.java" size="4629" author="LuciferYang" created="Wed, 14 Sep 2022 05:23:32 +0000"/>
                            <attachment id="13049265" name="TestParameters.java" size="27316" author="LuciferYang" created="Wed, 14 Sep 2022 05:23:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 42 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z188gw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>