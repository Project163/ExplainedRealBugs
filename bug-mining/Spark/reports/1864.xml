<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:27:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-7660] Snappy-java buffer-sharing bug leads to data corruption / test failures</title>
                <link>https://issues.apache.org/jira/browse/SPARK-7660</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;snappy-java contains a bug that can lead to situations where separate SnappyOutputStream instances end up sharing the same input and output buffers, which can lead to data corruption issues.  See &lt;a href=&quot;https://github.com/xerial/snappy-java/issues/107&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/xerial/snappy-java/issues/107&lt;/a&gt; for my upstream bug report and &lt;a href=&quot;https://github.com/xerial/snappy-java/pull/108&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/xerial/snappy-java/pull/108&lt;/a&gt; for my patch to fix this issue.&lt;/p&gt;

&lt;p&gt;I discovered this issue because the buffer-sharing was leading to a test failure in JavaAPISuite: one of the repartition-and-sort tests was returning the wrong answer because both tasks wrote their output using the same compression buffers and one task won the race, causing its output to be written to both shuffle output files. As a result, the test returned the result of collecting one partition twice (see &lt;a href=&quot;https://github.com/apache/spark/pull/5868#issuecomment-101954962&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/5868#issuecomment-101954962&lt;/a&gt; for more details).&lt;/p&gt;

&lt;p&gt;The buffer-sharing can only occur if &lt;tt&gt;close()&lt;/tt&gt; is called twice on the same SnappyOutputStream &lt;em&gt;and&lt;/em&gt; the JVM experiences little GC / memory pressure (for a more precise description of when this issue may occur, see my upstream tickets).  I think that this double-close happens somewhere in some test code that was added as part of my Tungsten shuffle patch, exposing this bug (to see this, download a recent build of master and run &lt;a href=&quot;https://gist.github.com/JoshRosen/eb3257a75c16597d769f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/JoshRosen/eb3257a75c16597d769f&lt;/a&gt; locally in order to force the test execution order that triggers the bug).&lt;/p&gt;

&lt;p&gt;I think that it&apos;s rare that this bug would lead to silent failures like this. In more realistic workloads that aren&apos;t writing only a handful of bytes per task, I would expect this issue to lead to stream corruption issues like &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-4105&quot; title=&quot;FAILED_TO_UNCOMPRESS(5) errors when fetching shuffle data with sort-based shuffle&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-4105&quot;&gt;&lt;del&gt;SPARK-4105&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12830079">SPARK-7660</key>
            <summary>Snappy-java buffer-sharing bug leads to data corruption / test failures</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="joshrosen">Josh Rosen</assignee>
                                    <reporter username="joshrosen">Josh Rosen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 15 May 2015 06:05:04 +0000</created>
                <updated>Sun, 17 May 2015 16:42:40 +0000</updated>
                            <resolved>Sun, 17 May 2015 16:42:39 +0000</resolved>
                                    <version>1.4.0</version>
                                    <fixVersion>1.2.3</fixVersion>
                    <fixVersion>1.3.2</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                    <component>Shuffle</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14544987" author="joshrosen" created="Fri, 15 May 2015 06:06:43 +0000"  >&lt;p&gt;Note that this affects more than just Spark 1.4.0; I&apos;ll trace back and figure out the complete list of affected versions tomorrow, but I think that any version that relied on a Snappy-java library published after mid June or July 2014 may be affected.&lt;/p&gt;</comment>
                            <comment id="14545005" author="joshrosen" created="Fri, 15 May 2015 06:20:52 +0000"  >&lt;p&gt;I pushed &lt;a href=&quot;https://github.com/apache/spark/commit/7da33ce5057ff965eec19ce662465b64a3564019&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/7da33ce5057ff965eec19ce662465b64a3564019&lt;/a&gt; as a hotfix, which masks the bug in a way that fixes the JavaAPISuite Jenkins failures.  We&apos;ll still fix this bug before 1.4, but in the meantime this will make it easy to recognize new Jenkins failures.&lt;/p&gt;</comment>
                            <comment id="14545014" author="joshrosen" created="Fri, 15 May 2015 06:31:57 +0000"  >&lt;p&gt;If we&apos;re wary of upgrading to a new Snappy version and don&apos;t want to wait for a new release / backport, one option is to just wrap SnappyOutputStream with our own code to make close() idempotent.  I don&apos;t think that this will have any significant overhead if done right, since the JIT should be able to inline the SnappyOutputStream calls.&lt;/p&gt;</comment>
                            <comment id="14545031" author="apachespark" created="Fri, 15 May 2015 06:48:05 +0000"  >&lt;p&gt;User &apos;JoshRosen&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/6176&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/6176&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14547227" author="joshrosen" created="Sun, 17 May 2015 16:42:40 +0000"  >&lt;p&gt;Fixed by my workaround PR in 1.2.3, 1.3.2, and 1.4.0.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12750940">SPARK-4105</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 27 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ero7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12329359">1.4.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>