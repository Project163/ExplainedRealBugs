<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:25:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-34845] ProcfsMetricsGetter.computeAllMetrics may return partial metrics when some of child pids metrics are missing</title>
                <link>https://issues.apache.org/jira/browse/SPARK-34845</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When the procfs metrics of some child pids are unavailable, ProcfsMetricsGetter.computeAllMetrics() may return partial metrics (the sum of a subset of child pids), instead of an all 0 result. This can be misleading and is undesired per the current code comments in &lt;a href=&quot;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/executor/ProcfsMetricsGetter.scala#L214&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/executor/ProcfsMetricsGetter.scala#L214&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;How to reproduce it?&lt;/p&gt;

&lt;p&gt;This unit test is kind of self-explanatory:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    val p = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ProcfsMetricsGetter(getTestResourcePath(&lt;span class=&quot;code-quote&quot;&gt;&quot;ProcfsMetrics&quot;&lt;/span&gt;))
    val mockedP = spy(p)

    &lt;span class=&quot;code-comment&quot;&gt;// proc file of pid 22764 doesn&lt;span class=&quot;code-quote&quot;&gt;&apos;t exist, so partial metrics shouldn&apos;&lt;/span&gt;t be returned
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; ptree = Set(26109, 22764, 22763)
    when(mockedP.computeProcessTree).thenReturn(ptree)
    &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; r = mockedP.computeAllMetrics
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt;(r.jvmVmemTotal == 0)
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt;(r.jvmRSSTotal == 0)
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt;(r.pythonVmemTotal == 0)
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt;(r.pythonRSSTotal == 0)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In the current implementation, computeAllMetrics will reset the&#160;allMetrics to 0 when processing 22764 because 22764&apos;s proc file doesn&apos;t exist, but then it will continue processing pid&#160;22763, and update&#160;allMetrics to procfs metrics of&#160;pid&#160;22763.&lt;/p&gt;

&lt;p&gt;Also, a side effect of this bug is that it can lead to a verbose warning log if many pids&apos; stat files are missing. An early terminating can make the warning logs more concise.&lt;/p&gt;

&lt;p&gt;How to solve it?&lt;/p&gt;

&lt;p&gt;The issue can be fixed by throwing&#160;IOException to&#160;computeAllMetrics(), in that case, computeAllMetrics can aware that at lease one child pid&apos;s procfs metrics is missing and then terminate the metrics reporting.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13367107">SPARK-34845</key>
            <summary>ProcfsMetricsGetter.computeAllMetrics may return partial metrics when some of child pids metrics are missing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Baohe Zhang">Baohe Zhang</assignee>
                                    <reporter username="Baohe Zhang">Baohe Zhang</reporter>
                        <labels>
                    </labels>
                <created>Tue, 23 Mar 2021 21:43:42 +0000</created>
                <updated>Mon, 29 Mar 2021 14:49:03 +0000</updated>
                            <resolved>Mon, 29 Mar 2021 14:49:03 +0000</resolved>
                                    <version>3.0.0</version>
                    <version>3.0.1</version>
                    <version>3.0.2</version>
                    <version>3.1.0</version>
                    <version>3.1.1</version>
                                    <fixVersion>3.0.3</fixVersion>
                    <fixVersion>3.1.2</fixVersion>
                    <fixVersion>3.2.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17307454" author="apachespark" created="Tue, 23 Mar 2021 22:49:11 +0000"  >&lt;p&gt;User &apos;baohe-zhang&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/31945&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/31945&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17307456" author="apachespark" created="Tue, 23 Mar 2021 22:50:43 +0000"  >&lt;p&gt;User &apos;baohe-zhang&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/31945&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/31945&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17310702" author="dongjoon" created="Mon, 29 Mar 2021 14:49:03 +0000"  >&lt;p&gt;Issue resolved by pull request 31945&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/31945&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/31945&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 33 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0p3zc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>