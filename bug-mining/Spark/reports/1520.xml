<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:24:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-6050] Spark on YARN does not work --executor-cores is specified</title>
                <link>https://issues.apache.org/jira/browse/SPARK-6050</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>
&lt;p&gt;There are multiple issues here (which I will detail as comments), but to reproduce running the following ALWAYS hangs in our cluster with the 1.3 RC&lt;/p&gt;

&lt;p&gt;./bin/spark-submit --class org.apache.spark.examples.SparkPi     --master yarn-cluster --executor-cores 8    --num-executors 15     --driver-memory 4g     --executor-memory 2g          --queue webmap     lib/spark-examples*.jar     10&lt;/p&gt;</description>
                <environment>&lt;p&gt;&lt;br/&gt;
2.5 based YARN cluster.&lt;/p&gt;</environment>
        <key id="12778121">SPARK-6050</key>
            <summary>Spark on YARN does not work --executor-cores is specified</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vanzin">Marcelo Masiero Vanzin</assignee>
                                    <reporter username="mridulm80">Mridul Muralidharan</reporter>
                        <labels>
                    </labels>
                <created>Fri, 27 Feb 2015 03:38:32 +0000</created>
                <updated>Mon, 9 Mar 2015 18:57:33 +0000</updated>
                            <resolved>Mon, 2 Mar 2015 22:42:42 +0000</resolved>
                                    <version>1.3.0</version>
                                    <fixVersion>1.3.0</fixVersion>
                                    <component>YARN</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="14339686" author="mridulm80" created="Fri, 27 Feb 2015 03:49:37 +0000"  >&lt;p&gt;Thanks to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tgraves&quot; class=&quot;user-hover&quot; rel=&quot;tgraves&quot;&gt;tgraves&lt;/a&gt; for helping investigate this.&lt;/p&gt;

&lt;p&gt;There are multiple issues in the codebase - and not all of them have been fully understood.&lt;/p&gt;

&lt;p&gt;a) For some reason, either YARN returns incorrect response to an allocate request or we are not setting the right param.&lt;br/&gt;
Note the snippet &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; to detail this.&lt;br/&gt;
(I cant share the logs unfortunately - but Tom has access to it and should be trivial for others to reproduce the issue).&lt;/p&gt;

&lt;p&gt;b) For whatever reason (a) happens, we do not recover from it.&lt;br/&gt;
All subsequent requests heartbeat requests DO NOT contain pending allocation requests (and we have rejected/de-allocated whatever yarn just sent us due to (a)).&lt;/p&gt;

&lt;p&gt;To elaborate; updateResourceRequests has missing == 0 since it is relying on getNumPendingAllocate() - which DOES NOT do the right thing in our context. Note: the &apos;ask&apos; list in the super class was cleared as part of the previous allocate() call.&lt;/p&gt;



&lt;p&gt;Fixing (a) will mask (b) - but IMO we should address it at the earliest too.&lt;/p&gt;




&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; Note the vCore in the response, and the subsequent ignoring of all containers.&lt;br/&gt;
15/02/27 01:40:30 INFO YarnAllocator: Will request 1000 executor containers, each with 8 cores and 38912 MB memory including 10240 MB overhead&lt;br/&gt;
15/02/27 01:40:30 INFO YarnAllocator: Container request (host: Any, capability: &amp;lt;memory:38912, vCores:8&amp;gt;)&lt;br/&gt;
15/02/27 01:40:30 INFO ApplicationMaster: Started progress reporter thread - sleep time : 5000&lt;br/&gt;
15/02/27 01:40:30 DEBUG ApplicationMaster: Sending progress&lt;br/&gt;
15/02/27 01:40:30 INFO YarnAllocator: missing = 0, targetNumExecutors = 1000, numPendingAllocate = 1000, numExecutorsRunning = 0&lt;br/&gt;
15/02/27 01:40:35 DEBUG ApplicationMaster: Sending progress&lt;br/&gt;
15/02/27 01:40:35 INFO YarnAllocator: missing = 0, targetNumExecutors = 1000, numPendingAllocate = 1000, numExecutorsRunning = 0&lt;br/&gt;
15/02/27 01:40:36 DEBUG YarnAllocator: Allocated containers: 1000. Current executor count: 0. Cluster resources: &amp;lt;memory:43006976, vCores:-1000&amp;gt;.&lt;br/&gt;
15/02/27 01:40:36 DEBUG YarnAllocator: Releasing 1000 unneeded containers that were allocated to us&lt;br/&gt;
15/02/27 01:40:36 INFO YarnAllocator: Received 1000 containers from YARN, launching executors on 0 of them.&lt;/p&gt;</comment>
                            <comment id="14339798" author="mridulm80" created="Fri, 27 Feb 2015 06:42:50 +0000"  >&lt;p&gt;With more verbose debug added, the problem surfaces.&lt;br/&gt;
Atleast with hadoop 2.5, the returned response always has vCores == 1 (and at the RM, it is treated as vCores == 1 too ... sigh, unimplemented ?)&lt;/p&gt;


&lt;p&gt;So in effect, we must not set executorCores while creating &quot;resource&quot; in YarnAllocator.&lt;/p&gt;

&lt;p&gt;See below for log snippet :&lt;/p&gt;


&lt;p&gt;15/02/27 06:37:33 INFO YarnAllocator: Will request 1 executor containers, each with 2 cores and 32870 MB memory including 2150 MB overhead&lt;br/&gt;
15/02/27 06:37:33 DEBUG AMRMClientImpl: Added priority=1&lt;br/&gt;
15/02/27 06:37:33 DEBUG AMRMClientImpl: addResourceRequest: applicationId= priority=1 resourceName=* numContainers=1 #asks=1&lt;br/&gt;
15/02/27 06:37:33 INFO YarnAllocator: Container request (host: Any, capability: &amp;lt;memory:32870, vCores:2&amp;gt;)&lt;br/&gt;
15/02/27 06:37:33 INFO YarnAllocator: missing = 0, targetNumExecutors = 1, numPendingAllocate = 1, numExecutorsRunning = 0&lt;br/&gt;
15/02/27 06:37:33 INFO AMRMClientImpl: Received new token for : &amp;lt;host&amp;gt;:8041&lt;br/&gt;
15/02/27 06:37:33 DEBUG YarnAllocator: Allocated containers: 1. Current executor count: 0. Cluster resources: &amp;lt;memory:81907200, vCores:-1&amp;gt;.&lt;br/&gt;
15/02/27 06:37:33 INFO YarnAllocator: allocatedContainer = Container: [ContainerId: &amp;lt;contained_id&amp;gt;, NodeId: &amp;lt;host&amp;gt;:8041, NodeHttpAddress: &amp;lt;host&amp;gt;:8042, Resource: &amp;lt;memory:33280, vCores:1&amp;gt;, Priority: 1, Token: Token &lt;/p&gt;
{ kind: ContainerToken, service: &amp;lt;host&amp;gt;:8041 }
&lt;p&gt;, ], location = &amp;lt;host&amp;gt;&lt;br/&gt;
15/02/27 06:37:33 INFO YarnAllocator: allocatedContainer = Container: [ContainerId: &amp;lt;contained_id&amp;gt;, NodeId: &amp;lt;host&amp;gt;:8041, NodeHttpAddress: &amp;lt;host&amp;gt;:8042, Resource: &amp;lt;memory:33280, vCores:1&amp;gt;, Priority: 1, Token: Token &lt;/p&gt;
{ kind: ContainerToken, service: &amp;lt;host&amp;gt;:8041 }
&lt;p&gt;, ], location = /&amp;lt;IP&amp;gt;&lt;br/&gt;
15/02/27 06:37:33 INFO YarnAllocator: allocatedContainer = Container: [ContainerId: &amp;lt;contained_id&amp;gt;, NodeId: &amp;lt;host&amp;gt;:8041, NodeHttpAddress: &amp;lt;host&amp;gt;:8042, Resource: &amp;lt;memory:33280, vCores:1&amp;gt;, Priority: 1, Token: Token &lt;/p&gt;
{ kind: ContainerToken, service: &amp;lt;host&amp;gt;:8041 }
&lt;p&gt;, ], location = *&lt;br/&gt;
15/02/27 06:37:33 DEBUG YarnAllocator: Releasing 1 unneeded containers that were allocated to us&lt;br/&gt;
15/02/27 06:37:33 INFO YarnAllocator: Received 1 containers from YARN, launching executors on 0 of them.&lt;/p&gt;</comment>
                            <comment id="14339857" author="pwendell" created="Fri, 27 Feb 2015 08:03:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mridulm%40yahoo-inc.com&quot; class=&quot;user-hover&quot; rel=&quot;mridulm@yahoo-inc.com&quot;&gt;mridulm@yahoo-inc.com&lt;/a&gt; thanks for testing and reporting this! Ping to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vanzin&quot; class=&quot;user-hover&quot; rel=&quot;vanzin&quot;&gt;vanzin&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andrewor14&quot; class=&quot;user-hover&quot; rel=&quot;andrewor14&quot;&gt;andrewor14&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="14340195" author="tgraves" created="Fri, 27 Feb 2015 14:33:23 +0000"  >&lt;p&gt;Thanks for investigating this more.&lt;/p&gt;

&lt;p&gt;This is because on that hadoop cluster cpu scheduling isn&apos;t turned on.  When its not turned on,it defaults to 1 core.&lt;/p&gt;

&lt;p&gt;@mridulm are you requesting 2 cores in your config?  I didn&apos;t see it in your example SparkPi command but going by the log command I assume you are.  &lt;/p&gt;

&lt;p&gt;15/02/27 06:37:33 INFO YarnAllocator: Will request 1 executor containers, each with 2 cores and 32870 MB memory including 2150 MB overhead&lt;/p&gt;

&lt;p&gt;If that is the case just remove the config or change to 1 core.  Other then that I don&apos;t know there is anything Spark can do as it doesn&apos;t know how Hadoop is configured.  The change that was made is to now use more of the Hadoop AMClient which adds the matching for the container requests. We just weren&apos;t checking that the cores matched before in Spark 1.2.  &lt;/p&gt;

&lt;p&gt;We could theorectically look at the hadoop configs but that could get pretty hairy quickly as there are different schedulers and then within the scheduler it handles memory/cores differently.  Many clusters don&apos;t have scheduler configs on gateway boxes also. One thing we should do is add better logging as to why they don&apos;t match, but the match routine is also in the Hadoop AMClient code so its more us printing exactly what came back with the allocate response.  I can also file Hadoop jira to log information when it doesn&apos;t match.  The other option would be to write our own match routine.&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;



</comment>
                            <comment id="14340379" author="mridulm80" created="Fri, 27 Feb 2015 17:08:59 +0000"  >
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tgraves&quot; class=&quot;user-hover&quot; rel=&quot;tgraves&quot;&gt;tgraves&lt;/a&gt; You are right, cpu scheduling is not turned on in our cluster.&lt;br/&gt;
In the description, I am specifying number of cores as 8.&lt;/p&gt;

&lt;p&gt;For our jobs, I request for the entire memory of the node to use it completely.&lt;br/&gt;
We need to specify number of cores in order for spark to launch multiple threads on the executor (else it will be large memory, single thread) : and &apos;--executor-cores&apos; is the means to do so.&lt;/p&gt;

&lt;p&gt;So either we will need to check if cpu scheduling is turned on in yarn before specifying cores as a resource (if off, use 1), or assume the user knows best and always ask for &apos;1&apos; core and spin-off multiple threads like in 1.2.&lt;/p&gt;</comment>
                            <comment id="14340411" author="vanzin" created="Fri, 27 Feb 2015 17:24:18 +0000"  >&lt;p&gt;Is there any downside to always requesting 1 if cpu scheduling is off? (Other than users using a lot more cores than they would otherwise be allowed, but I guess that&apos;s what the Yarn admin wanted by turning that option off.)&lt;/p&gt;</comment>
                            <comment id="14340431" author="tgraves" created="Fri, 27 Feb 2015 17:35:37 +0000"  >&lt;p&gt;Ah good point.   Note that 1.2 didn&apos;t always ask for 1. It asked for whatever the user asked for but it didn&apos;t do any validation on the requests coming back.  We should basically do the same thing. If we were to change to only ask for 1 it would negate hadoop cpu scheduling which I don&apos;t want to do.&lt;/p&gt;</comment>
                            <comment id="14340433" author="tgraves" created="Fri, 27 Feb 2015 17:37:27 +0000"  >&lt;p&gt;Note, the problem is in determining whether cpu scheduling is off or not.  There is no interface exposed to the user. For the Capacity Scheduler you would have to look for specific config:&lt;/p&gt;

&lt;p&gt;capacity-scheduler.xml.&lt;br/&gt;
    &amp;lt;name&amp;gt;yarn.scheduler.capacity.resource-calculator&amp;lt;/name&amp;gt;&lt;br/&gt;
    &amp;lt;value&amp;gt;org.apache.hadoop.yarn.util.resource.DominantResourceCalculator&amp;lt;/value&amp;gt;&lt;/p&gt;


&lt;p&gt;That config file might not even be available on all the gateways as its only needed on RM.&lt;/p&gt;</comment>
                            <comment id="14340705" author="vanzin" created="Fri, 27 Feb 2015 19:49:10 +0000"  >&lt;p&gt;Hmm, I&apos;m having trouble reproducing this locally. The correct value to hit this should be &lt;tt&gt;org.apache.hadoop.yarn.util.resource.DefaultResourseCalculator&lt;/tt&gt;, right? Maybe they fixed this particular behavior in 2.6?&lt;/p&gt;</comment>
                            <comment id="14340707" author="vanzin" created="Fri, 27 Feb 2015 19:50:02 +0000"  >&lt;p&gt;Oh, let me try again with &lt;tt&gt;DefaultResourceCalculator&lt;/tt&gt;. Gotta love typos in documentation.&lt;/p&gt;</comment>
                            <comment id="14340734" author="vanzin" created="Fri, 27 Feb 2015 20:05:44 +0000"  >&lt;p&gt;Ok, I think I&apos;m hitting it when using the right name. Will take a look.&lt;/p&gt;</comment>
                            <comment id="14340773" author="tgraves" created="Fri, 27 Feb 2015 20:40:49 +0000"  >&lt;p&gt;Sounds like you figured it out already, I cut and paste the wrong one, you need the DominantResourceCalculator with capacity scheduler to get it to do cores.&lt;/p&gt;</comment>
                            <comment id="14340794" author="apachespark" created="Fri, 27 Feb 2015 20:57:49 +0000"  >&lt;p&gt;User &apos;vanzin&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/4818&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/4818&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14340968" author="tgraves" created="Fri, 27 Feb 2015 22:48:04 +0000"  >&lt;p&gt;Note that there is one other problem Mridul reported in this jira and perhaps we should split this into another jira unless &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vanzin&quot; class=&quot;user-hover&quot; rel=&quot;vanzin&quot;&gt;vanzin&lt;/a&gt; thinks the pr fixes it also:&lt;/p&gt;


&lt;p&gt;So the scenario is like this.&lt;br/&gt;
Suppose we asked for 10 workers, RM gave us say 12 - but we decided to use only 6 (in this example, we used 0 due to vCores constraints).&lt;br/&gt;
Now, we still need 4 workers more - but we will never ask for it again from RM.&lt;/p&gt;</comment>
                            <comment id="14340972" author="vanzin" created="Fri, 27 Feb 2015 22:51:23 +0000"  >&lt;p&gt;That sounds like a potentially different issue. But since the requested resources are static in YarnAllocator, I don&apos;t see how the code would only use 6 containers when the RM sends more.&lt;/p&gt;

&lt;p&gt;Unless the RM can send back containers that don&apos;t match your request (aside from this weird situation for which we&apos;re adding the workaround). Otherwise, the code should match all of them and YarnAllocator should use all of them.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 38 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i264tb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327642">1.3.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>