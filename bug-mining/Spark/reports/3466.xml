<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:41:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-13670] spark-class doesn&apos;t bubble up error from launcher command</title>
                <link>https://issues.apache.org/jira/browse/SPARK-13670</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;There&apos;s a particular snippet in spark-class &lt;a href=&quot;https://github.com/apache/spark/blob/master/bin/spark-class#L86&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; that runs the spark-launcher code in a subshell.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;# The launcher library will print arguments separated by a NULL character, to allow arguments with
# characters that would be otherwise interpreted by the shell. Read that in a &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; loop, populating
# an array that will be used to exec the &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; command.
CMD=()
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; IFS= read -d &apos;&apos; -r ARG; &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt;
  CMD+=(&lt;span class=&quot;code-quote&quot;&gt;&quot;$ARG&quot;&lt;/span&gt;)
done &amp;lt; &amp;lt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;$RUNNER&quot;&lt;/span&gt; -cp &lt;span class=&quot;code-quote&quot;&gt;&quot;$LAUNCH_CLASSPATH&quot;&lt;/span&gt; org.apache.spark.launcher.Main &lt;span class=&quot;code-quote&quot;&gt;&quot;$@&quot;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem is that the if the launcher Main fails, this code still still returns success and continues, even though the top level script is marked &lt;tt&gt;set -e&lt;/tt&gt;. This is because the launcher.Main is run within a subshell.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12946906">SPARK-13670</key>
            <summary>spark-class doesn&apos;t bubble up error from launcher command</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vanzin">Marcelo Masiero Vanzin</assignee>
                                    <reporter username="mgrover">Mark Grover</reporter>
                        <labels>
                    </labels>
                <created>Fri, 4 Mar 2016 07:06:27 +0000</created>
                <updated>Tue, 10 May 2016 17:34:59 +0000</updated>
                            <resolved>Tue, 10 May 2016 17:34:59 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>Spark Submit</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15179491" author="mgrover" created="Fri, 4 Mar 2016 07:13:40 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vanzin&quot; class=&quot;user-hover&quot; rel=&quot;vanzin&quot;&gt;vanzin&lt;/a&gt; as fyi.&lt;br/&gt;
I ran into this when I was running &lt;tt&gt;dev/mima&lt;/tt&gt;. It should have failed because I didn&apos;t have the tools jar and launcher.main() did throw an exception but the subshell ate it all up and the mima testing continued, eventually giving me a ton of errors since the exclusions list wasn&apos;t correctly populated.&lt;/p&gt;

&lt;p&gt;Anyways, there are a few ways I can think of fixing it, open to others as well:&lt;br/&gt;
1. We could just fix the symptom and have the dev/mima script, explicitly check for tools directory and tools jar in bash and break, if it&apos;s not present. However, a) that&apos;s just fixing the symptom, not the root cause, b) we already have those checks in launcher code.&lt;br/&gt;
2. We could have the command write the output to a file instead of reading it directly from a subshell. Then, that makes error handling easier.&lt;br/&gt;
3. We can have the subshell kill the parent process on error, essentially running the subshell like so:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;$RUNNER&quot;&lt;/span&gt; -cp &lt;span class=&quot;code-quote&quot;&gt;&quot;$LAUNCH_CLASSPATH&quot;&lt;/span&gt; org.apache.spark.launcher.Main &lt;span class=&quot;code-quote&quot;&gt;&quot;$@&quot;&lt;/span&gt; || kill $$)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The side effect is that any other subshells spawned by the parent, i.e. spark-class will be terminated as well. Based on a quick look, I didn&apos;t see any other subshells though.&lt;/p&gt;

&lt;p&gt;Thoughts? Preferences?&lt;/p&gt;</comment>
                            <comment id="15180427" author="vanzin" created="Fri, 4 Mar 2016 19:41:26 +0000"  >&lt;p&gt;After some fun playing with arcane bash syntax, here&apos;s something that worked for me:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;run_command() {
  CMD=()
  &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; IFS=&lt;span class=&quot;code-quote&quot;&gt;&apos;&apos; read -d &apos;&lt;/span&gt;&apos; -r ARG; &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt;
    echo &lt;span class=&quot;code-quote&quot;&gt;&quot;line: $ARG&quot;&lt;/span&gt;
    CMD+=(&lt;span class=&quot;code-quote&quot;&gt;&quot;$ARG&quot;&lt;/span&gt;)
  done
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; [ ${#CMD[@]} -gt 0 ]; then
    exec &lt;span class=&quot;code-quote&quot;&gt;&quot;${CMD[@]}&quot;&lt;/span&gt;
  fi
}

set -o pipefail
&lt;span class=&quot;code-quote&quot;&gt;&quot;$RUNNER&quot;&lt;/span&gt; -cp &lt;span class=&quot;code-quote&quot;&gt;&quot;$LAUNCH_CLASSPATH&quot;&lt;/span&gt; org.apache.spark.launcher.Main &lt;span class=&quot;code-quote&quot;&gt;&quot;$@&quot;&lt;/span&gt; | run_command
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Example:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ ./bin/spark-shell 
NOTE: SPARK_PREPEND_CLASSES is set, placing locally compiled Spark classes ahead of assembly.
Exception in thread &quot;main&quot; java.lang.IllegalArgumentException: Testing, testing, testing...
        at org.apache.spark.launcher.Main.main(Main.java:93)

$ echo $?
1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="15180444" author="vanzin" created="Fri, 4 Mar 2016 19:53:29 +0000"  >&lt;p&gt;Note that will probably leave a bash process running somewhere alongside the Spark jvm, so probably would need tweaks to avoid that... bash is fun.&lt;/p&gt;</comment>
                            <comment id="15180455" author="vanzin" created="Fri, 4 Mar 2016 20:00:34 +0000"  >&lt;p&gt;Actually scrap that, it breaks things when the spark-shell actually runs... back to the drawing board.&lt;/p&gt;</comment>
                            <comment id="15180463" author="mgrover" created="Fri, 4 Mar 2016 20:08:01 +0000"  >&lt;p&gt;Thanks for looking at this. What do you think of #2 - writing the output to a file?&lt;/p&gt;</comment>
                            <comment id="15180479" author="vanzin" created="Fri, 4 Mar 2016 20:14:54 +0000"  >&lt;p&gt;Not a fan... you have to write the file somewhere, clean it up, worry about who can read it, all sorts of stuff. Better to avoid it.&lt;/p&gt;</comment>
                            <comment id="15180489" author="vanzin" created="Fri, 4 Mar 2016 20:19:30 +0000"  >&lt;p&gt;Here&apos;s something a little ugly that works though:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;build_command() {
  &lt;span class=&quot;code-quote&quot;&gt;&quot;$RUNNER&quot;&lt;/span&gt; -cp &lt;span class=&quot;code-quote&quot;&gt;&quot;$LAUNCH_CLASSPATH&quot;&lt;/span&gt; org.apache.spark.launcher.Main &lt;span class=&quot;code-quote&quot;&gt;&quot;$@&quot;&lt;/span&gt;
  EC=$?
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; [ $EC -ne 0 ]; then
    printf &lt;span class=&quot;code-quote&quot;&gt;&quot;%d\0&quot;&lt;/span&gt; $EC
  fi
}

CMD=()
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; IFS= read -d &apos;&apos; -r ARG; &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt;
  CMD+=(&lt;span class=&quot;code-quote&quot;&gt;&quot;$ARG&quot;&lt;/span&gt;)
done &amp;lt; &amp;lt;(build_command &lt;span class=&quot;code-quote&quot;&gt;&quot;$@&quot;&lt;/span&gt;)

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; [ ${#CMD[@]} -eq 1 ]; then
  exit ${CMD[0]}
fi

exec &lt;span class=&quot;code-quote&quot;&gt;&quot;${CMD[@]}&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15180516" author="mgrover" created="Fri, 4 Mar 2016 20:48:06 +0000"  >&lt;p&gt;And, it&apos;s guaranteed that Main would never return that output?&lt;/p&gt;

&lt;p&gt;I feel like we may be overloading too much here but again, I don&apos;t have any non-ugly ideas either. We may just have to choose our poison.&lt;/p&gt;</comment>
                            <comment id="15180535" author="vanzin" created="Fri, 4 Mar 2016 21:06:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;And, it&apos;s guaranteed that Main would never return that output?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m reasonably sure it won&apos;t. I just tried spark-shell, pyspark and sparkR and they all work (since they all generate multiple command line arguments).&lt;/p&gt;

&lt;p&gt;But if worried about that, you could always append the exit code to the output of &lt;tt&gt;build_command&lt;/tt&gt; by always executing the printf. Then just remove the exit code in the parent shell, something like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;COUNT=${#CMD[@]}
EC=${CMD[$COUNT]}
CMD=&lt;span class=&quot;code-quote&quot;&gt;&quot;${CMD[@]:0:$((COUNT -1))}&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Not 100% sure about the syntax, but seems to work in a quick test.&lt;/p&gt;</comment>
                            <comment id="15180643" author="vanzin" created="Fri, 4 Mar 2016 22:22:01 +0000"  >&lt;p&gt;Here&apos;s one that works regardless of the output of Main. It would be nice to have someone try this on MacOS.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;# The launcher library will print arguments separated by a NULL character, to allow arguments with
# characters that would be otherwise interpreted by the shell. Read that in a &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; loop, populating
# an array that will be used to exec the &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; command.
#
# The exit code of the launcher is appended to the output, so the parent shell removes it from the
# command array and checks the value to see &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the launcher succeeded.
build_command() {
  &lt;span class=&quot;code-quote&quot;&gt;&quot;$RUNNER&quot;&lt;/span&gt; -cp &lt;span class=&quot;code-quote&quot;&gt;&quot;$LAUNCH_CLASSPATH&quot;&lt;/span&gt; org.apache.spark.launcher.Main &lt;span class=&quot;code-quote&quot;&gt;&quot;$@&quot;&lt;/span&gt;
  printf &lt;span class=&quot;code-quote&quot;&gt;&quot;%d\0&quot;&lt;/span&gt; $?
}

CMD=()
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; IFS= read -d &apos;&apos; -r ARG; &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt;
  CMD+=(&lt;span class=&quot;code-quote&quot;&gt;&quot;$ARG&quot;&lt;/span&gt;)
done &amp;lt; &amp;lt;(build_command &lt;span class=&quot;code-quote&quot;&gt;&quot;$@&quot;&lt;/span&gt;)

COUNT=${#CMD[@]}
LAST=$((COUNT - 1))
EC=${CMD[$LAST]}
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; [ $EC != 0 ]; then
  exit $EC
fi

CMD=(&lt;span class=&quot;code-quote&quot;&gt;&quot;${CMD[@]:0:$LAST}&quot;&lt;/span&gt;)
exec &lt;span class=&quot;code-quote&quot;&gt;&quot;${CMD[@]}&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15180663" author="mgrover" created="Fri, 4 Mar 2016 22:31:34 +0000"  >&lt;p&gt;I have a mac, I can do some more testing.&lt;/p&gt;</comment>
                            <comment id="15207146" author="mgrover" created="Tue, 22 Mar 2016 19:52:58 +0000"  >&lt;p&gt;Apologies for the delay in responding. This works for me in the failure case, on mac. I haven&apos;t done exhaustive testing - but my use-case that was originally broken which led to this JIRA, is fixed by the proposed fix. Thanks for working on this, Marcelo.&lt;/p&gt;</comment>
                            <comment id="15271487" author="apachespark" created="Wed, 4 May 2016 21:44:04 +0000"  >&lt;p&gt;User &apos;vanzin&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/12910&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/12910&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 28 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2u58f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>