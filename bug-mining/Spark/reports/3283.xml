<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:40:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-14138] Generated SpecificColumnarIterator code can exceed JVM size limit for cached DataFrames</title>
                <link>https://issues.apache.org/jira/browse/SPARK-14138</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;The generated &lt;tt&gt;SpecificColumnarIterator&lt;/tt&gt; code for wide DataFrames can exceed the JVM 64k limit under certain circumstances. This snippet reproduces the error in spark-shell (with 5G driver memory) by creating a new DataFrame with &amp;gt;2000 aggregation-based columns:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;val df = sc.parallelize(1 to 10).toDF()
val aggr = {1 to 2260}.map(colnum =&amp;gt; avg(df.col(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;)).as(s&lt;span class=&quot;code-quote&quot;&gt;&quot;col_$colnum&quot;&lt;/span&gt;))
val res = df.groupBy(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).agg(count(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;), aggr: _*).cache()
res.show() &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; will &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The following error is produced (pruned for brevity):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;/* 001 */
/* 002 */ import java.nio.ByteBuffer;
/* 003 */ import java.nio.ByteOrder;
/* 004 */ import scala.collection.Iterator;
/* 005 */ import org.apache.spark.sql.types.DataType;
/* 006 */ import org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder;
/* 007 */ import org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter;
/* 008 */ import org.apache.spark.sql.execution.columnar.MutableUnsafeRow;
/* 009 */
/* 010 */ public SpecificColumnarIterator generate(org.apache.spark.sql.catalyst.expressions.Expression[] expr) {
/* 011 */   return new SpecificColumnarIterator();
/* 012 */ }
/* 013 */

...

/* 9113 */     accessor2261.extractTo(mutableRow, 2261);
/* 9114 */     unsafeRow.pointTo(bufferHolder.buffer, 2262, bufferHolder.totalSize());
/* 9115 */     return unsafeRow;
/* 9116 */   }
/* 9117 */ }

	at org.apache.spark.sql.catalyst.expressions.codegen.CodeGenerator.org$apache$spark$sql$catalyst$expressions$codegen$CodeGenerator$$doCompile(CodeGenerator.scala:555)
	at org.apache.spark.sql.catalyst.expressions.codegen.CodeGenerator$$anon$1.load(CodeGenerator.scala:575)
	at org.apache.spark.sql.catalyst.expressions.codegen.CodeGenerator$$anon$1.load(CodeGenerator.scala:572)
	at org.spark-project.guava.cache.LocalCache$LoadingValueReference.loadFuture(LocalCache.java:3599)
	at org.spark-project.guava.cache.LocalCache$Segment.loadSync(LocalCache.java:2379)
	... 28 more
Caused by: org.codehaus.janino.JaninoRuntimeException: Code of method &quot;()Z&quot; of class &quot;org.apache.spark.sql.catalyst.expressions.GeneratedClass$SpecificColumnarIterator&quot; grows beyond 64 KB
	at org.codehaus.janino.CodeContext.makeSpace(CodeContext.java:941)
	at org.codehaus.janino.CodeContext.write(CodeContext.java:836)
	at org.codehaus.janino.UnitCompiler.writeOpcode(UnitCompiler.java:10251)
	at org.codehaus.janino.UnitCompiler.invoke(UnitCompiler.java:10050)
	at org.codehaus.janino.UnitCompiler.compileGet2(UnitCompiler.java:4008)
	at org.codehaus.janino.UnitCompiler.access$6900(UnitCompiler.java:185)
	at org.codehaus.janino.UnitCompiler$10.visitMethodInvocation(UnitCompiler.java:3263)
	at org.codehaus.janino.Java$MethodInvocation.accept(Java.java:3974)
	at org.codehaus.janino.UnitCompiler.compileGet(UnitCompiler.java:3290)
	at org.codehaus.janino.UnitCompiler.compileGetValue(UnitCompiler.java:4368)
	at org.codehaus.janino.UnitCompiler.compileGet2(UnitCompiler.java:3927)
	at org.codehaus.janino.UnitCompiler.access$6900(UnitCompiler.java:185)
	at org.codehaus.janino.UnitCompiler$10.visitMethodInvocation(UnitCompiler.java:3263)
	at org.codehaus.janino.Java$MethodInvocation.accept(Java.java:3974)
	at org.codehaus.janino.UnitCompiler.compileGet(UnitCompiler.java:3290)
	at org.codehaus.janino.UnitCompiler.compileGetValue(UnitCompiler.java:4368)
	at org.codehaus.janino.UnitCompiler.invokeConstructor(UnitCompiler.java:6681)
	at org.codehaus.janino.UnitCompiler.compileGet2(UnitCompiler.java:4126)
	at org.codehaus.janino.UnitCompiler.access$7600(UnitCompiler.java:185)
	at org.codehaus.janino.UnitCompiler$10.visitNewClassInstance(UnitCompiler.java:3275)
	at org.codehaus.janino.Java$NewClassInstance.accept(Java.java:4085)
	at org.codehaus.janino.UnitCompiler.compileGet(UnitCompiler.java:3290)
	at org.codehaus.janino.UnitCompiler.compileGetValue(UnitCompiler.java:4368)
	at org.codehaus.janino.UnitCompiler.compile2(UnitCompiler.java:2669)
	at org.codehaus.janino.UnitCompiler.access$4500(UnitCompiler.java:185)
	at org.codehaus.janino.UnitCompiler$7.visitAssignment(UnitCompiler.java:2619)
	at org.codehaus.janino.Java$Assignment.accept(Java.java:3405)
	at org.codehaus.janino.UnitCompiler.compile(UnitCompiler.java:2654)
	at org.codehaus.janino.UnitCompiler.compile2(UnitCompiler.java:1643)
	at org.codehaus.janino.UnitCompiler.access$1100(UnitCompiler.java:185)
	at org.codehaus.janino.UnitCompiler$4.visitExpressionStatement(UnitCompiler.java:936)
	at org.codehaus.janino.Java$ExpressionStatement.accept(Java.java:2097)
	at org.codehaus.janino.UnitCompiler.compile(UnitCompiler.java:958)
	at org.codehaus.janino.UnitCompiler.compileStatements(UnitCompiler.java:1007)
	at org.codehaus.janino.UnitCompiler.compile(UnitCompiler.java:2293)
	at org.codehaus.janino.UnitCompiler.compileDeclaredMethods(UnitCompiler.java:822)
	at org.codehaus.janino.UnitCompiler.compileDeclaredMethods(UnitCompiler.java:794)
	at org.codehaus.janino.UnitCompiler.compile2(UnitCompiler.java:507)
	at org.codehaus.janino.UnitCompiler.compile2(UnitCompiler.java:658)
	at org.codehaus.janino.UnitCompiler.compile2(UnitCompiler.java:662)
	at org.codehaus.janino.UnitCompiler.access$600(UnitCompiler.java:185)
	at org.codehaus.janino.UnitCompiler$2.visitMemberClassDeclaration(UnitCompiler.java:350)
	at org.codehaus.janino.Java$MemberClassDeclaration.accept(Java.java:1035)
	at org.codehaus.janino.UnitCompiler.compile(UnitCompiler.java:354)
	at org.codehaus.janino.UnitCompiler.compileDeclaredMemberTypes(UnitCompiler.java:769)
	at org.codehaus.janino.UnitCompiler.compile2(UnitCompiler.java:532)
	at org.codehaus.janino.UnitCompiler.compile2(UnitCompiler.java:393)
	at org.codehaus.janino.UnitCompiler.access$400(UnitCompiler.java:185)
	at org.codehaus.janino.UnitCompiler$2.visitPackageMemberClassDeclaration(UnitCompiler.java:347)
	at org.codehaus.janino.Java$PackageMemberClassDeclaration.accept(Java.java:1139)
	at org.codehaus.janino.UnitCompiler.compile(UnitCompiler.java:354)
	at org.codehaus.janino.UnitCompiler.compileUnit(UnitCompiler.java:322)
	at org.codehaus.janino.SimpleCompiler.compileToClassLoader(SimpleCompiler.java:383)
	at org.codehaus.janino.ClassBodyEvaluator.compileToClass(ClassBodyEvaluator.java:315)
	at org.codehaus.janino.ClassBodyEvaluator.cook(ClassBodyEvaluator.java:233)
	at org.codehaus.janino.SimpleCompiler.cook(SimpleCompiler.java:192)
	at org.codehaus.commons.compiler.Cookable.cook(Cookable.java:84)
	at org.apache.spark.sql.catalyst.expressions.codegen.CodeGenerator.org$apache$spark$sql$catalyst$expressions$codegen$CodeGenerator$$doCompile(CodeGenerator.scala:550)
	... 32 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that the issue does not occur (and the &lt;tt&gt;.show()&lt;/tt&gt; call prints the right results) when the number of aggregation columns is slightly reduced, 2250 instead of 2260 in this case:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;val df = sc.parallelize(1 to 10).toDF()
val aggr = {1 to 2250}.map(colnum =&amp;gt; avg(df.col(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;)).as(s&lt;span class=&quot;code-quote&quot;&gt;&quot;col_$colnum&quot;&lt;/span&gt;)) &lt;span class=&quot;code-comment&quot;&gt;// only 2250
&lt;/span&gt;val res = df.groupBy(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).agg(count(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;), aggr: _*).cache()
res.show() &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; will work&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also, if the final DataFrame is not cached, then it will also work for 2260 aggregations:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;val df = sc.parallelize(1 to 10).toDF()
val aggr = {1 to 2260}.map(colnum =&amp;gt; avg(df.col(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;)).as(s&lt;span class=&quot;code-quote&quot;&gt;&quot;col_$colnum&quot;&lt;/span&gt;))
val res = df.groupBy(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).agg(count(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;), aggr: _*) &lt;span class=&quot;code-comment&quot;&gt;// no .cache() call
&lt;/span&gt;res.show() &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; will work&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12953408">SPARK-14138</key>
            <summary>Generated SpecificColumnarIterator code can exceed JVM size limit for cached DataFrames</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kiszk">Kazuaki Ishizaki</assignee>
                                    <reporter username="skrasser">Sven Krasser</reporter>
                        <labels>
                    </labels>
                <created>Thu, 24 Mar 2016 21:42:03 +0000</created>
                <updated>Mon, 14 Nov 2016 23:11:40 +0000</updated>
                            <resolved>Sat, 2 Apr 2016 05:38:28 +0000</resolved>
                                    <version>1.6.1</version>
                                    <fixVersion>1.6.2</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="15213071" author="kiszk" created="Sat, 26 Mar 2016 15:12:31 +0000"  >&lt;p&gt;I will make a PR that includes two solutions:&lt;br/&gt;
1. make this method smaller&lt;br/&gt;
2. push a large code piece into a method as &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-8443&quot; title=&quot;GenerateMutableProjection Exceeds JVM Code Size Limits&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-8443&quot;&gt;&lt;del&gt;SPARK-8443&lt;/del&gt;&lt;/a&gt; did&lt;/p&gt;</comment>
                            <comment id="15213327" author="apachespark" created="Sun, 27 Mar 2016 04:28:03 +0000"  >&lt;p&gt;User &apos;kiszk&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/11984&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/11984&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15214787" author="skrasser" created="Mon, 28 Mar 2016 20:08:16 +0000"  >&lt;p&gt;Thanks for the speedy fix! Will this make it into 1.6.2?&lt;/p&gt;</comment>
                            <comment id="15221445" author="apachespark" created="Fri, 1 Apr 2016 09:25:04 +0000"  >&lt;p&gt;User &apos;kiszk&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/12108&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/12108&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15222732" author="davies" created="Sat, 2 Apr 2016 05:38:28 +0000"  >&lt;p&gt;Issue resolved by pull request 12108&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/12108&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/12108&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15253976" author="wkinney" created="Fri, 22 Apr 2016 14:00:23 +0000"  >&lt;p&gt;Is there a workaround for this for 1.6.1?&lt;/p&gt;</comment>
                            <comment id="15254061" author="kiszk" created="Fri, 22 Apr 2016 15:01:22 +0000"  >&lt;p&gt;Yes, it will be included in 1.6.2 and 2.0.0.&lt;/p&gt;</comment>
                            <comment id="15329358" author="kalle" created="Tue, 14 Jun 2016 11:44:55 +0000"  >&lt;p&gt;Will there be a 1.6.2 release any time soon? The current 1.6-branch cannot be compiled and there is no nightly for 1.6 at &lt;a href=&quot;http://people.apache.org/~pwendell/spark-nightly/spark-branch-1.6-bin/spark-1.6.2-SNAPSHOT-2016_06_13_01_29-be3c41b-bin/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://people.apache.org/~pwendell/spark-nightly/spark-branch-1.6-bin/spark-1.6.2-SNAPSHOT-2016_06_13_01_29-be3c41b-bin/&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15329387" author="kalle" created="Tue, 14 Jun 2016 12:15:36 +0000"  >&lt;p&gt;I&apos;ve now successfully compiled from commit c53c83c for Hadoop 2.6. The original exception is gone, but unfortunately a StackOverflowError is raised instead. Full traceback here: &lt;a href=&quot;http://pastebin.com/0C6tk2SD&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://pastebin.com/0C6tk2SD&lt;/a&gt;. The error occurred when trying to persist a Dataframe with a little more than 3000 aggregation columns from Pyspark.&lt;/p&gt;</comment>
                            <comment id="15664842" author="barrybecker4" created="Mon, 14 Nov 2016 19:54:27 +0000"  >&lt;p&gt;I am using spark 1.6.3 on a DataFrame with 204 columns. Indeed I get the StackOverflowError. Should this be reopened?&lt;/p&gt;

&lt;p&gt;org.apache.spark.SparkException: Job aborted due to stage failure: Task 1 in stage 843.0 failed 1 times, most recent failure: Lost task 1.0 in stage 843.0 (TID 40670, localhost): org.spark-project.guava.util.concurrent.ExecutionError: java.lang.StackOverflowError&lt;br/&gt;
	at org.spark-project.guava.cache.LocalCache$Segment.get(LocalCache.java:2261)&lt;br/&gt;
	at org.spark-project.guava.cache.LocalCache.get(LocalCache.java:4000)&lt;br/&gt;
	at org.spark-project.guava.cache.LocalCache.getOrLoad(LocalCache.java:4004)&lt;br/&gt;
	at org.spark-project.guava.cache.LocalCache$LocalLoadingCache.get(LocalCache.java:4874)&lt;br/&gt;
	at org.apache.spark.sql.catalyst.expressions.codegen.CodeGenerator.compile&lt;/p&gt;</comment>
                            <comment id="15665334" author="srowen" created="Mon, 14 Nov 2016 23:11:40 +0000"  >&lt;p&gt;That does not look like the problem described here, no. The comment above is also referring to a different problem.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12982637">SPARK-16191</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12838845">SPARK-8443</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12960593">SPARK-14793</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 1 week ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2v6xr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>