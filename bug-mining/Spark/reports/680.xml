<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:17:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-3358] PySpark worker fork()ing performance regression in m3.* / PVM instances</title>
                <link>https://issues.apache.org/jira/browse/SPARK-3358</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-2764&quot; title=&quot;Simplify process structure of PySpark daemon / worker launching process&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-2764&quot;&gt;&lt;del&gt;SPARK-2764&lt;/del&gt;&lt;/a&gt; (and some followup commits) simplified PySpark&apos;s worker process structure by removing an intermediate pool of processes forked by daemon.py.  Previously, daemon.py forked a fixed-size pool of processes that shared a socket and handled worker launch requests from Java.  After my patch, this intermediate pool was removed and launch requests are handled directly in daemon.py.&lt;/p&gt;

&lt;p&gt;Unfortunately, this seems to have increased PySpark task launch latency when running on m3* class instances in EC2.  Most of this difference can be attributed to m3 instances&apos; more expensive fork() system calls.  I tried the following microbenchmark on m3.xlarge and r3.xlarge instances:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; os

&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; x in range(1000):
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; os.fork() == 0:
    exit()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On the r3.xlarge instance:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;real	0m0.761s
user	0m0.008s
sys	0m0.144s
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And on m3.xlarge:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;real    0m1.699s
user    0m0.012s
sys     0m1.008s
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think this is due to HVM vs PVM EC2 instances using different virtualization technologies with different fork costs.&lt;/p&gt;

&lt;p&gt;It may be the case that this performance difference only appears in certain microbenchmarks and is masked by other performance improvements in PySpark, such as improvements to large group-bys.  I&apos;m in the process of re-running spark-perf benchmarks on m3 instances in order to confirm whether this impacts more realistic jobs.&lt;/p&gt;</description>
                <environment>&lt;p&gt;m3.* instances on EC2&lt;/p&gt;</environment>
        <key id="12738660">SPARK-3358</key>
            <summary>PySpark worker fork()ing performance regression in m3.* / PVM instances</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="joshrosen">Josh Rosen</reporter>
                        <labels>
                    </labels>
                <created>Wed, 3 Sep 2014 00:37:27 +0000</created>
                <updated>Sat, 13 Dec 2014 07:33:17 +0000</updated>
                            <resolved>Sat, 13 Dec 2014 07:33:17 +0000</resolved>
                                    <version>1.1.0</version>
                                    <fixVersion>1.1.0</fixVersion>
                    <fixVersion>1.2.0</fixVersion>
                                    <component>PySpark</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14119089" author="joshrosen" created="Wed, 3 Sep 2014 00:57:31 +0000"  >&lt;p&gt;Credit where it&apos;s due: Davies pointed out the potential for this problem in the original PR: &lt;a href=&quot;https://github.com/apache/spark/pull/1680#issuecomment-50721351&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/1680#issuecomment-50721351&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The Redis team did their own benchmarking on this (&lt;a href=&quot;http://redislabs.com/blog/testing-fork-time-on-awsxen-infrastructure&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://redislabs.com/blog/testing-fork-time-on-awsxen-infrastructure&lt;/a&gt; (or &lt;a href=&quot;https://web.archive.org/web/20140529181436/http://redislabs.com/blog/testing-fork-time-on-awsxen-infrastructure&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://web.archive.org/web/20140529181436/http://redislabs.com/blog/testing-fork-time-on-awsxen-infrastructure&lt;/a&gt;, since their site may be down / slow right now)).&lt;/p&gt;

&lt;p&gt;Based on those results, and updated numbers at &lt;a href=&quot;http://redislabs.com/blog/benchmarking-the-new-aws-m3-instances-with-redis&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://redislabs.com/blog/benchmarking-the-new-aws-m3-instances-with-redis&lt;/a&gt;, it looks like HVM AMIs don&apos;t have this problem.  I&apos;m going to try running a similar microbenchmark on m3.xlarge with the spark-ec2 HVM AMI to see if that improves performance.  If so, we should consider changing from PVM to HVM for those instance types.&lt;/p&gt;</comment>
                            <comment id="14119093" author="joshrosen" created="Wed, 3 Sep 2014 00:59:08 +0000"  >&lt;p&gt;Update: that same microbenchmark that I posted above runs really fast in a m3.xlarge instance when using the HVM AMI:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;real	0m0.713s
user	0m0.020s
sys	0m0.108s
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14119141" author="nchammas" created="Wed, 3 Sep 2014 01:31:01 +0000"  >&lt;p&gt;Josh, do you think this is related to the r3 vs. m3 performance difference you &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-3333?focusedCommentId=14118695&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14118695&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;reported in SPARK-3333&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="14119145" author="joshrosen" created="Wed, 3 Sep 2014 01:32:37 +0000"  >&lt;p&gt;Yes, I meant to link the two issues.&lt;/p&gt;</comment>
                            <comment id="14119253" author="pwendell" created="Wed, 3 Sep 2014 03:32:00 +0000"  >&lt;p&gt;There was actually a patch a couple months ago that changed the default instance type to PVM for these from HVM. I didn&apos;t backport that particular change to 1.0 to be conservative (turned out to be a good call!) in case somehow this caused a regression.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/spark/pull/1156&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/1156&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ll just revert that part of the patch in master and 1.1 as well.&lt;/p&gt;</comment>
                            <comment id="14119265" author="apachespark" created="Wed, 3 Sep 2014 03:35:27 +0000"  >&lt;p&gt;User &apos;pwendell&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/2244&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/2244&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14119276" author="nchammas" created="Wed, 3 Sep 2014 03:42:46 +0000"  >&lt;p&gt;Nit: Isn&apos;t it &lt;a href=&quot;http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/virtualization_types.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PV and not PVM&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="14120284" author="davies" created="Wed, 3 Sep 2014 19:13:19 +0000"  >&lt;p&gt;Changing from PV to HVM may cause performance regression for real workload, because PVM is slower than PV generally. &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;In long term, we should re-use the Python worker to reduce the fork() overhead.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://palakonda.org/2012/10/30/aws-virtualization-hvm-vs-paravirtualization/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://palakonda.org/2012/10/30/aws-virtualization-hvm-vs-paravirtualization/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14120354" author="joshrosen" created="Wed, 3 Sep 2014 20:07:15 +0000"  >&lt;p&gt;Agreed.  Long term, I think it would be better to address the causes behind why we need to fork so many processes.&lt;/p&gt;</comment>
                            <comment id="14120792" author="davies" created="Thu, 4 Sep 2014 01:15:12 +0000"  >&lt;p&gt;I had created an PR to reuse Python worker:  &lt;a href=&quot;https://github.com/apache/spark/pull/2259&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/2259&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="14243454" author="srowen" created="Fri, 12 Dec 2014 00:27:42 +0000"  >&lt;p&gt;Is this then resolved by one of &lt;a href=&quot;https://github.com/apache/spark/pull/2244&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/2244&lt;/a&gt; or &lt;a href=&quot;https://github.com/apache/spark/pull/2259&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/2259&lt;/a&gt; ?&lt;/p&gt;</comment>
                            <comment id="14245238" author="joshrosen" created="Sat, 13 Dec 2014 07:32:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Yeah, I think it&apos;s okay to mark this as fixed for now.  We can always re-open if people complain that it&apos;s causing them problems.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12738156">SPARK-3333</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 49 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1zlrr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>