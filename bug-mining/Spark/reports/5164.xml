<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:55:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-21958] Attempting to save large Word2Vec model hangs driver in constant GC.</title>
                <link>https://issues.apache.org/jira/browse/SPARK-21958</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;In the new version of Word2Vec, the model saving was modified to estimate an appropriate number of partitions based on the kryo buffer size. This is a great improvement, but there is a caveat for very large models.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;(word, vector)&lt;/tt&gt; tuple goes through a transformation to a local case class of &lt;tt&gt;Data(word, vector)&lt;/tt&gt;... I can only assume this is for the kryo serialization process. The new version of the code iterates over the entire vocabulary to do this transformation (the old version wrapped the entire datum) in the driver&apos;s heap. Only to have the result then distributed to the cluster to be written into it&apos;s parquet files.&lt;/p&gt;

&lt;p&gt;With extremely large vocabularies (~2 million docs, with uni-grams, bi-grams, and tri-grams), that local driver transformation is causing the driver to hang indefinitely in GC as I can only assume that it&apos;s generating millions of short lived objects which can&apos;t be evicted fast enough.&lt;/p&gt;

&lt;p&gt;Perhaps I&apos;m overlooking something, but it seems to me that since the result is distributed over the cluster to be saved &lt;em&gt;after&lt;/em&gt; the transformation anyway, we may as well distribute it &lt;em&gt;first&lt;/em&gt;, allowing the cluster resources to do the transformation more efficiently, and then write the parquet file from there.&lt;/p&gt;

&lt;p&gt;I have a patch implemented, and am in the process of testing it at scale. I will open a pull request when I feel that the patch is successfully resolving the issue, and after making sure that it passes unit tests.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Running spark on yarn, hadoop 2.7.2 provided by the cluster&lt;/p&gt;</environment>
        <key id="13100846">SPARK-21958</key>
            <summary>Attempting to save large Word2Vec model hangs driver in constant GC.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="travis.hegner">Travis Hegner</assignee>
                                    <reporter username="travis.hegner">Travis Hegner</reporter>
                        <labels>
                            <label>easyfix</label>
                            <label>patch</label>
                            <label>performance</label>
                    </labels>
                <created>Fri, 8 Sep 2017 15:41:18 +0000</created>
                <updated>Fri, 15 Sep 2017 13:18:57 +0000</updated>
                            <resolved>Fri, 15 Sep 2017 13:17:56 +0000</resolved>
                                    <version>2.2.0</version>
                                    <fixVersion>2.3.0</fixVersion>
                                    <component>ML</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16160862" author="mlnick" created="Mon, 11 Sep 2017 07:51:34 +0000"  >&lt;p&gt;Seems like your proposal could improve things - but yeah let&apos;s see what your testing results are.&lt;/p&gt;</comment>
                            <comment id="16161451" author="travis.hegner" created="Mon, 11 Sep 2017 15:36:06 +0000"  >&lt;p&gt;Running the patch applied to tag &lt;tt&gt;v2.2.0&lt;/tt&gt; allows a 4.0G model to save and load as expected, where without the patch my driver would hang in GC forever, even with a 64G heap. I believe the patch is working successfully so I will re-base against master and open the pull request. Running &lt;tt&gt;mvn test&lt;/tt&gt; for only the ML sub-component works, but I have failing tests in areas of code I haven&apos;t touched.&lt;/p&gt;</comment>
                            <comment id="16161471" author="apachespark" created="Mon, 11 Sep 2017 15:54:04 +0000"  >&lt;p&gt;User &apos;travishegner&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19191&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19191&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16167853" author="mlnick" created="Fri, 15 Sep 2017 13:17:56 +0000"  >&lt;p&gt;Issue resolved by pull request 19191&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19191&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19191&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 9 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3jtun:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>