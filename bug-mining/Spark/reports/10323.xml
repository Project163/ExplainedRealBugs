<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:48:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-53792] Fix rocksdbPinnedBlocksMemoryUsage when bounded memory usage is enabled</title>
                <link>https://issues.apache.org/jira/browse/SPARK-53792</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;We forgot to fix this to show the correct metric when bounded memory usage is enabled. Currently, it is collecting data for each RocksDB without accounting for when all the RocksDB instances on the executor are sharing the same cache, leading to double counting.&lt;/p&gt;

&lt;p&gt;This is where we collect the cache memory metric: &lt;a href=&quot;https://github.com/apache/spark/blob/master/sql/core/src/main/scala/org/apache/spark/sql/execution/streaming/state/RocksDB.scala#L2045&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/sql/core/src/main/scala/org/apache/spark/sql/execution/streaming/state/RocksDB.scala#L2045&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We are currently using getDBProperty(&quot;rocksdb.block-cache-pinned-usage&quot;) to read the pinned blocks for each DB. When the block cache is shared, this is wrong because:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;b&gt;Instance-specific vs. global stats&lt;/b&gt;: Database properties like &quot;rocksdb.block-cache-pinned-usage&quot; report on the memory size of entries requested specifically by that DB instance.&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;Double-counting potential&lt;/b&gt;: If you query the DB property on both instances and add them together, you could potentially double-count because a single block in the shared cache could be used by both DB instances.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;Solution:&lt;/b&gt; Do lrucache.getPinnedUsage (&lt;a href=&quot;https://github.com/facebook/rocksdb/blob/v9.8.4/java/src/main/java/org/rocksdb/Cache.java#L33C15-L33C29&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/facebook/rocksdb/blob/v9.8.4/java/src/main/java/org/rocksdb/Cache.java#L33C15-L33C29&lt;/a&gt; in OSS RocksDB) instead, to get the actual memory size of pinned blocks in the shared cache. We are querying the cache here instead of the DB.&lt;/p&gt;

&lt;p&gt;To estimate the pinnedBlocks used by a single DB instance, we can divide lrucache.getPinnedUsage() by num_rocksdb_instances_sharing_the_cache. We already do a similar thing for memoryUsage. See: &lt;a href=&quot;https://github.com/apache/spark/blob/master/sql/core/src/main/scala/org/apache/spark/sql/execution/streaming/state/RocksDBMemoryManager.scala#L124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/sql/core/src/main/scala/org/apache/spark/sql/execution/streaming/state/RocksDBMemoryManager.scala#L124&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Original fix:&lt;/b&gt; OSS Spark PR:[ &lt;a href=&quot;https://github.com/apache/spark/commit/35c299a1e3e373e20ae45d7604df51c83ff1dbe2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/35c299a1e3e373e20ae45d7604df51c83ff1dbe2&lt;/a&gt;|https://github.com/apache/spark/commit/35c299a1e3e373e20ae45d7604df51c83ff1dbe2]&lt;/p&gt;</description>
                <environment></environment>
        <key id="13630560">SPARK-53792</key>
            <summary>Fix rocksdbPinnedBlocksMemoryUsage when bounded memory usage is enabled</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="zifeif2">Zifei Feng</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 2 Oct 2025 18:06:18 +0000</created>
                <updated>Wed, 8 Oct 2025 17:51:40 +0000</updated>
                            <resolved>Wed, 8 Oct 2025 17:51:35 +0000</resolved>
                                    <version>4.0.1</version>
                                    <fixVersion>4.1.0</fixVersion>
                                    <component>Structured Streaming</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="18028431" author="JIRAUSER287599" created="Wed, 8 Oct 2025 17:51:25 +0000"  >&lt;p&gt;PR merged here: &lt;a href=&quot;https://github.com/apache/spark/pull/52527&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/52527&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12314421" key="com.atlassian.jira.plugin.system.customfieldtypes:labels">
                        <customfieldname>Language</customfieldname>
                        <customfieldvalues>
                                        <label>scala</label>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1xz4g:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311620" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Shepherd</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>anishshri-db</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>