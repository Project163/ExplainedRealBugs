<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:05:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-28058] Reading csv with DROPMALFORMED sometimes doesn&apos;t drop malformed records</title>
                <link>https://issues.apache.org/jira/browse/SPARK-28058</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;The spark sql csv reader is not dropping malformed records as expected.&lt;/p&gt;

&lt;p&gt;Consider this file (fruit.csv).  Notice it contains a header record, 3 valid records, and one malformed record.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;fruit,color,price,quantity
apple,red,1,3
banana,yellow,2,4
orange,orange,3,5
xxx
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If I read this file using the spark sql csv reader as follows, everything looks good.  The malformed record is dropped.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;scala&amp;gt; spark.read.option(&quot;header&quot;, &quot;true&quot;).option(&quot;mode&quot;, &quot;DROPMALFORMED&quot;).csv(&quot;fruit.csv&quot;).show(truncate=false)
+------+------+-----+--------+                                                  
|fruit |color |price|quantity|
+------+------+-----+--------+
|apple |red   |1    |3       |
|banana|yellow|2    |4       |
|orange|orange|3    |5       |
+------+------+-----+--------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, if I select a subset of the columns, the malformed record is not dropped.  The malformed data is placed in the first column, and the remaining column(s) are filled with nulls.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;scala&amp;gt; spark.read.option(&quot;header&quot;, &quot;true&quot;).option(&quot;mode&quot;, &quot;DROPMALFORMED&quot;).csv(&quot;fruit.csv&quot;).select(&apos;fruit).show(truncate=false)
+------+
|fruit |
+------+
|apple |
|banana|
|orange|
|xxx   |
+------+

scala&amp;gt; spark.read.option(&quot;header&quot;, &quot;true&quot;).option(&quot;mode&quot;, &quot;DROPMALFORMED&quot;).csv(&quot;fruit.csv&quot;).select(&apos;fruit, &apos;color).show(truncate=false)
+------+------+
|fruit |color |
+------+------+
|apple |red   |
|banana|yellow|
|orange|orange|
|xxx   |null  |
+------+------+

scala&amp;gt; spark.read.option(&quot;header&quot;, &quot;true&quot;).option(&quot;mode&quot;, &quot;DROPMALFORMED&quot;).csv(&quot;fruit.csv&quot;).select(&apos;fruit, &apos;color, &apos;price).show(truncate=false)
+------+------+-----+
|fruit |color |price|
+------+------+-----+
|apple |red   |1    |
|banana|yellow|2    |
|orange|orange|3    |
|xxx   |null  |null |
+------+------+-----+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And finally, if I manually select all of the columns, the malformed record is once again dropped.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;scala&amp;gt; spark.read.option(&quot;header&quot;, &quot;true&quot;).option(&quot;mode&quot;, &quot;DROPMALFORMED&quot;).csv(&quot;fruit.csv&quot;).select(&apos;fruit, &apos;color, &apos;price, &apos;quantity).show(truncate=false)
+------+------+-----+--------+
|fruit |color |price|quantity|
+------+------+-----+--------+
|apple |red   |1    |3       |
|banana|yellow|2    |4       |
|orange|orange|3    |5       |
+------+------+-----+--------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I would expect the malformed record(s) to be dropped regardless of which columns are being selected from the file.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13239649">SPARK-28058</key>
            <summary>Reading csv with DROPMALFORMED sometimes doesn&apos;t drop malformed records</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="viirya">L. C. Hsieh</assignee>
                                    <reporter username="stwhit">Stuart White</reporter>
                        <labels>
                    </labels>
                <created>Fri, 14 Jun 2019 20:48:38 +0000</created>
                <updated>Mon, 12 Dec 2022 18:10:47 +0000</updated>
                            <resolved>Tue, 18 Jun 2019 04:49:30 +0000</resolved>
                                    <version>2.4.1</version>
                    <version>2.4.3</version>
                                    <fixVersion>2.4.4</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16864674" author="gurwls223" created="Sat, 15 Jun 2019 12:39:02 +0000"  >&lt;p&gt;From a cursory look, seems like this behaviour was inherited from Univocity parser.&lt;/p&gt;</comment>
                            <comment id="16865650" author="viirya" created="Mon, 17 Jun 2019 14:24:36 +0000"  >&lt;p&gt;This is due to CSV parser column pruning. You can disable it and the behavior would like you expect:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
scala&amp;gt; spark.read.option(&lt;span class=&quot;code-quote&quot;&gt;&quot;header&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;).option(&lt;span class=&quot;code-quote&quot;&gt;&quot;mode&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;DROPMALFORMED&quot;&lt;/span&gt;).csv(&lt;span class=&quot;code-quote&quot;&gt;&quot;fruit.csv&quot;&lt;/span&gt;).select(&apos;fruit).show(truncate=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
+------+
|fruit |
+------+
|apple |
|banana|
|orange|
|xxx&#160;&#160; |
+------+

scala&amp;gt; spark.conf.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;spark.sql.csv.parser.columnPruning.enabled&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)

scala&amp;gt; spark.read.option(&lt;span class=&quot;code-quote&quot;&gt;&quot;header&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;).option(&lt;span class=&quot;code-quote&quot;&gt;&quot;mode&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;DROPMALFORMED&quot;&lt;/span&gt;).csv(&lt;span class=&quot;code-quote&quot;&gt;&quot;fruit.csv&quot;&lt;/span&gt;).select(&apos;fruit).show(truncate=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
+------+
|fruit |
+------+
|apple |
|banana|
|orange|
+------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16865664" author="viirya" created="Mon, 17 Jun 2019 14:42:09 +0000"  >&lt;p&gt;Although this isn&apos;t a bug, I think it might be worth adding a note to current doc to explain/clarify it.&lt;/p&gt;</comment>
                            <comment id="16865679" author="stwhit" created="Mon, 17 Jun 2019 15:07:14 +0000"  >&lt;p&gt;Thank you both for your responses.&lt;br/&gt;
&#160;&lt;br/&gt;
I now see that at the &lt;a href=&quot;https://spark.apache.org/docs/2.4.0/sql-migration-guide-upgrade.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Spark SQL Upgrading Guide&lt;/a&gt;, under the &lt;a href=&quot;https://spark.apache.org/docs/2.4.0/sql-migration-guide-upgrade.html#upgrading-from-spark-sql-23-to-24&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Upgrading From Spark SQL 2.3 to 2.4&lt;/a&gt; section, it states:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;In version 2.3 and earlier, CSV rows are considered as malformed if at least one column 
value in the row is malformed. CSV parser dropped such rows in the DROPMALFORMED mode or
outputs an error in the FAILFAST mode. Since Spark 2.4, CSV row is considered as malformed
only when it contains malformed column values requested from CSV datasource, other values
can be ignored. As an example, CSV file contains the &#8220;id,name&#8221; header and one row &#8220;1234&#8221;.
In Spark 2.4, selection of the id column consists of a row with one column value 1234 but
in Spark 2.3 and earlier it is empty in the DROPMALFORMED mode. To restore the previous
behavior, set spark.sql.csv.parser.columnPruning.enabled to false.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I had not noticed that until you called the &lt;tt&gt;spark.sql.csv.parser.columnPruning.enabled&lt;/tt&gt; option to my attention.&lt;/p&gt;

&lt;p&gt;Thanks again for the help!&lt;/p&gt;</comment>
                            <comment id="16865695" author="viirya" created="Mon, 17 Jun 2019 15:28:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stwhit&quot; class=&quot;user-hover&quot; rel=&quot;stwhit&quot;&gt;stwhit&lt;/a&gt; Thanks for letting us know that!&lt;/p&gt;

&lt;p&gt;Although it is in the migration guide, for new users it should be good to have the note in &lt;tt&gt;DROPMALFORMED&lt;/tt&gt; doc. I filed &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-28082&quot; title=&quot;Add a note to DROPMALFORMED mode of CSV for column pruning&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-28082&quot;&gt;&lt;del&gt;SPARK-28082&lt;/del&gt;&lt;/a&gt; to track the doc improvement.&lt;/p&gt;
</comment>
                            <comment id="16865714" author="viirya" created="Mon, 17 Jun 2019 15:49:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hyukjin.kwon&quot; class=&quot;user-hover&quot; rel=&quot;hyukjin.kwon&quot;&gt;hyukjin.kwon&lt;/a&gt; Do you mean this is suspect to be a bug:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
scala&amp;gt; spark.read.option(&lt;span class=&quot;code-quote&quot;&gt;&quot;header&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;).option(&lt;span class=&quot;code-quote&quot;&gt;&quot;mode&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;DROPMALFORMED&quot;&lt;/span&gt;).csv(&lt;span class=&quot;code-quote&quot;&gt;&quot;fruit.csv&quot;&lt;/span&gt;).select(&lt;span class=&quot;code-quote&quot;&gt;&apos;fruit, &apos;&lt;/span&gt;color).show(truncate=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
+------+------+
|fruit |color |
+------+------+
|apple |red   |
|banana|yellow|
|orange|orange|
|xxx   |&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;  |
+------+------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In this case, the reader should read two columns. But the corrupted record has only one column. Reasonably, it should be dropped as a malformed one. But we see the missing column is filled with null.&lt;/p&gt;

&lt;p&gt;This seems to be inherited from Univocity parser, when we use &lt;tt&gt;CsvParserSettings.selectIndexes&lt;/tt&gt; to do field selection. In above case, the parser returns two tokens where the second token is just null. I&apos;m not sure if it is known behavior of Univocity parser, or it is a bug at Univocity parser.&lt;/p&gt;</comment>
                            <comment id="16866097" author="gurwls223" created="Tue, 18 Jun 2019 00:31:23 +0000"  >&lt;p&gt;Yes, that was what I saw and I thought it&apos;s a bug in Unviocity. After another thought, yes, it looks an intended behaviour in Univocity (I guess). Thanks guys for clarification.&lt;/p&gt;</comment>
                            <comment id="16866229" author="gurwls223" created="Tue, 18 Jun 2019 04:49:30 +0000"  >&lt;p&gt;Issue resolved by pull request 24894&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/24894&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/24894&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13239899">SPARK-28079</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13239970">SPARK-28082</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 22 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z03rq0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>