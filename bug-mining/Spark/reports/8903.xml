<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:32:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-41793] Incorrect result for window frames defined by a range clause on large decimals </title>
                <link>https://issues.apache.org/jira/browse/SPARK-41793</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Context &lt;a href=&quot;https://github.com/NVIDIA/spark-rapids/issues/7429#issuecomment-1368040686&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/NVIDIA/spark-rapids/issues/7429#issuecomment-1368040686&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The following windowing query on a simple two-row input should produce two non-empty windows as a result&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
from pprint &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; pprint
data = [
  (&lt;span class=&quot;code-quote&quot;&gt;&apos;9223372036854775807&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;11342371013783243717493546650944543.47&apos;&lt;/span&gt;),
  (&lt;span class=&quot;code-quote&quot;&gt;&apos;9223372036854775807&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;999999999999999999999999999999999999.99&apos;&lt;/span&gt;)
]
df1 = spark.createDataFrame(data, &lt;span class=&quot;code-quote&quot;&gt;&apos;a STRING, b STRING&apos;&lt;/span&gt;)
df2 = df1.select(df1.a.&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&apos;LONG&apos;&lt;/span&gt;), df1.b.&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&apos;DECIMAL(38,2)&apos;&lt;/span&gt;))
df2.createOrReplaceTempView(&lt;span class=&quot;code-quote&quot;&gt;&apos;test_table&apos;&lt;/span&gt;)
df = sql(&apos;&apos;&apos;
  SELECT 
    COUNT(1) OVER (
      PARTITION BY a 
      ORDER BY b ASC 
      RANGE BETWEEN 10.2345 PRECEDING AND 6.7890 FOLLOWING
    ) AS CNT_1 
  FROM 
    test_table
  &apos;&apos;&apos;)
res = df.collect()
df.explain(True)
pprint(res)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Spark&#160;3.4.0-SNAPSHOT output:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[Row(CNT_1=1), Row(CNT_1=0)]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Spark 3.3.1 output as expected:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Row(CNT_1=1), Row(CNT_1=1)]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


</description>
                <environment></environment>
        <key id="13516063">SPARK-41793</key>
            <summary>Incorrect result for window frames defined by a range clause on large decimals </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ulysses">XiDuo You</assignee>
                                    <reporter username="jira.shegalov">Gera Shegalov</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Sat, 31 Dec 2022 01:06:04 +0000</created>
                <updated>Thu, 23 Feb 2023 12:37:28 +0000</updated>
                            <resolved>Thu, 23 Feb 2023 12:37:06 +0000</resolved>
                                    <version>3.4.0</version>
                                    <fixVersion>3.4.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17653238" author="jira.shegalov" created="Sat, 31 Dec 2022 01:36:17 +0000"  >&lt;p&gt;Similarly in SQLite&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
.header on

create table test_table(a &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;, b decimal(38,2));
insert into test_table 
values
  (&lt;span class=&quot;code-quote&quot;&gt;&apos;9223372036854775807&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;11342371013783243717493546650944543.47&apos;&lt;/span&gt;),
  (&lt;span class=&quot;code-quote&quot;&gt;&apos;9223372036854775807&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;999999999999999999999999999999999999.99&apos;&lt;/span&gt;);

select * from test_table;

select 
  count(1) over(
    partition by a 
    order by b asc
    range between 10.2345 preceding and 6.7890 following) as cnt_1 
  from 
    test_table;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;yields&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
a|b
9223372036854775807|1.13423710137832e+34
9223372036854775807|1.0e+36
cnt_1
1
1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17653348" author="bersprockets" created="Sat, 31 Dec 2022 20:37:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ulysses&quot; class=&quot;user-hover&quot; rel=&quot;ulysses&quot;&gt;ulysses&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The change in behavior appears to be from commit &lt;a href=&quot;https://github.com/apache/spark/commit/301a139638&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;301a139638&lt;/a&gt;  (&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-39316&quot; title=&quot;Merge PromotePrecision and CheckOverflow into decimal binary arithmetic&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-39316&quot;&gt;&lt;del&gt;SPARK-39316&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;When I test with the commit immediately preceding, I get:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;1
1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When I test on that commit, I get&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;1
0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I used this to test in spark-sql:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;create or replace temp view test_table
as select * from values
  (9223372036854775807l, cast(&apos;11342371013783243717493546650944543.47&apos; as decimal(38,2))),
  (9223372036854775807l, cast(&apos;999999999999999999999999999999999999.99&apos; as decimal(38,2)))
as data(a, b);

  SELECT 
    COUNT(1) OVER (
      PARTITION BY a 
      ORDER BY b ASC 
      RANGE BETWEEN 10.2345 PRECEDING AND 6.7890 FOLLOWING
    ) AS CNT_1 
  FROM 
    test_table;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17678744" author="tgraves" created="Thu, 19 Jan 2023 14:46:41 +0000"  >&lt;p&gt;this sounds like a correctness issue - &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ulyssesyou&quot; class=&quot;user-hover&quot; rel=&quot;ulyssesyou&quot;&gt;ulyssesyou&lt;/a&gt; am I missing something here?&lt;/p&gt;</comment>
                            <comment id="17683753" author="ulysses" created="Fri, 3 Feb 2023 08:51:36 +0000"  >&lt;p&gt;I&apos;m not sure this is a correctness bug but I think it&apos;s more like a right behavior change.&lt;/p&gt;

&lt;p&gt;An example, what happened if run this query ?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
select 1 where where (1 + 999999999999999999999999999999999999.99) &amp;gt; 999999999999999999999999999999999999.99;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Without ANSI, it returns empty, so the size of count should return 0.&lt;/p&gt;</comment>
                            <comment id="17684903" author="jira.shegalov" created="Mon, 6 Feb 2023 19:37:24 +0000"  >&lt;p&gt;if the consensus is that it&apos;s not a correctness bug in 3.4,&#160; then this fix should probably be documented and backported to maintenance branches?&lt;/p&gt;</comment>
                            <comment id="17685384" author="jira.shegalov" created="Tue, 7 Feb 2023 17:00:49 +0000"  >&lt;p&gt;Another interpretation of why the pre-3.4 count of 1 may be actually correct could be that regardless of whether the window frame bound values overflow or not&#160; the current row is always part of the window it defines. Whether or not it should be the case can be clarified in the doc.&lt;/p&gt;

&lt;p&gt;UPDATE: if we consider the range of this query plan above &lt;tt&gt;RangeFrame, -10.23, 6.79)&lt;/tt&gt;.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
spark-sql&amp;gt; select b - 10.23 as lower, b, b + 6.79 as upper from test_table;
11342371013783243717493546650944533.24	11342371013783243717493546650944543.47	11342371013783243717493546650944550.26
999999999999999999999999999999999989.76	999999999999999999999999999999999999.99	NULL
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;as consisting of the union of &lt;br/&gt;
[lower; b) &lt;br/&gt;
b &lt;br/&gt;
(b; upper]&lt;/p&gt;

&lt;p&gt;only the (b; upper] is undefined&lt;/p&gt;

&lt;p&gt;the first [lower; b) and b are defined and have at least one row.  &lt;/p&gt;

&lt;p&gt;either way not counting the current row is a counterintuitive result&lt;/p&gt;</comment>
                            <comment id="17692408" author="tgraves" created="Wed, 22 Feb 2023 23:09:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ulysses&quot; class=&quot;user-hover&quot; rel=&quot;ulysses&quot;&gt;ulysses&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xinrong&quot; class=&quot;user-hover&quot; rel=&quot;xinrong&quot;&gt;xinrong&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;We need to decide what we are doing with this for 3.4 before doing any release.&lt;/p&gt;</comment>
                            <comment id="17692451" author="cloud_fan" created="Thu, 23 Feb 2023 02:26:58 +0000"  >&lt;p&gt;When we are doing window operator computing per partition, it&apos;s local decimal calculations and we can temporarily go beyond the decimal precision limitation, because `Decimal` is backed by `java.math.BigDecimal`. We should only check overflow before writing out decimal values. There is an expression `DecimalAddNoOverflowCheck` and we should use it in the window operator.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ulysses&quot; class=&quot;user-hover&quot; rel=&quot;ulysses&quot;&gt;ulysses&lt;/a&gt; can you help to fix it? This is the same idea we use in Sum/Average.&lt;/p&gt;</comment>
                            <comment id="17692480" author="apachespark" created="Thu, 23 Feb 2023 04:10:39 +0000"  >&lt;p&gt;User &apos;ulysses-you&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/40138&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/40138&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17692649" author="cloud_fan" created="Thu, 23 Feb 2023 12:37:06 +0000"  >&lt;p&gt;Issue resolved by pull request 40138&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/40138&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/40138&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13518196">SPARK-42049</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 37 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1egiw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>