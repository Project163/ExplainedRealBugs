<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:29:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-38823] Incorrect result of dataset reduceGroups in java</title>
                <link>https://issues.apache.org/jira/browse/SPARK-38823</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  @Data
  @NoArgsConstructor
  @AllArgsConstructor
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Item &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Serializable {
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; x;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; y;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; z;

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Item addZ(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; z) {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Item(x, y, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.z + z);
    }
  } &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
List&amp;lt;Item&amp;gt; items = List.of(
 &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Item(&lt;span class=&quot;code-quote&quot;&gt;&quot;X1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Y1&quot;&lt;/span&gt;, 1),
 &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Item(&lt;span class=&quot;code-quote&quot;&gt;&quot;X2&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Y1&quot;&lt;/span&gt;, 1),
 &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Item(&lt;span class=&quot;code-quote&quot;&gt;&quot;X1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Y1&quot;&lt;/span&gt;, 1),
 &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Item(&lt;span class=&quot;code-quote&quot;&gt;&quot;X2&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Y1&quot;&lt;/span&gt;, 1),
 &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Item(&lt;span class=&quot;code-quote&quot;&gt;&quot;X3&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Y1&quot;&lt;/span&gt;, 1),
 &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Item(&lt;span class=&quot;code-quote&quot;&gt;&quot;X1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Y1&quot;&lt;/span&gt;, 1),
 &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Item(&lt;span class=&quot;code-quote&quot;&gt;&quot;X1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Y2&quot;&lt;/span&gt;, 1),
 &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Item(&lt;span class=&quot;code-quote&quot;&gt;&quot;X2&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;Y1&quot;&lt;/span&gt;, 1)); 

Dataset&amp;lt;Item&amp;gt; ds = spark.createDataFrame(items, Item.class).as(Encoders.bean(Item.class)); 
ds.groupByKey((MapFunction&amp;lt;Item, Tuple2&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;&amp;gt;) item -&amp;gt; Tuple2.apply(item.getX(), item.getY()),
    Encoders.tuple(Encoders.STRING(), Encoders.STRING())) 
.reduceGroups((ReduceFunction&amp;lt;Item&amp;gt;) (item1, item2) -&amp;gt; 
  item1.addZ(item2.getZ()))
 .show(10);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;result is&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+--------+----------------------------------------------+
|     key|ReduceAggregator(poc.job.JavaSparkReduce$Item)|
+--------+----------------------------------------------+
|{X1, Y1}|                                   {X2, Y1, 2}|-- expected 3
|{X2, Y1}|                                   {X2, Y1, 2}|-- expected 3
|{X1, Y2}|                                   {X2, Y1, 1}|
|{X3, Y1}|                                   {X2, Y1, 1}|
+--------+----------------------------------------------+&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;pay attention that key doesn&apos;t mach with value&lt;/p&gt;</description>
                <environment></environment>
        <key id="13438444">SPARK-38823</key>
            <summary>Incorrect result of dataset reduceGroups in java</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bersprockets">Bruce Robbins</assignee>
                                    <reporter username="ikozar22">IKozar</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Thu, 7 Apr 2022 17:50:05 +0000</created>
                <updated>Mon, 12 Dec 2022 18:10:50 +0000</updated>
                            <resolved>Thu, 14 Apr 2022 23:38:46 +0000</resolved>
                                    <version>3.3.0</version>
                    <version>3.4.0</version>
                                    <fixVersion>3.3.0</fixVersion>
                                    <component>Java API</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17521414" author="bersprockets" created="Wed, 13 Apr 2022 01:57:24 +0000"  >&lt;p&gt;This appears to be an optimization bug that results in corruption of the buffers in &lt;tt&gt;AggregationIterator&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;On master and 3.3, &lt;tt&gt;NewInstance&lt;/tt&gt; with no arguments is considered foldable. As a result, the &lt;tt&gt;ConstantFolding&lt;/tt&gt; rule turns NewInstance into a Literal holding an instance of the user&apos;s specified Java bean. The instance becomes a singleton that gets reused for each input record (although its fields get updated by &lt;tt&gt;InitializeJavaBean&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;Because the instance gets reused, sometimes multiple buffers in &lt;tt&gt;AggregationIterator&lt;/tt&gt; are actually referring to the same Java bean instance.&lt;/p&gt;

&lt;p&gt;Take, for example, the test I added &lt;a href=&quot;https://github.com/bersprockets/spark/blob/17a8ad64f5bc39cb26d25b63f3692e7b8632baf8/sql/core/src/test/java/test/org/apache/spark/sql/JavaBeanDeserializationSuite.java#L560&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The input is:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;List&amp;lt;Item&amp;gt; items = Arrays.asList(
    new Item(&quot;a&quot;, 1),
    new Item(&quot;b&quot;, 3),
    new Item(&quot;c&quot;, 2),
    new Item(&quot;a&quot;, 7));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;As &lt;tt&gt;ObjectAggregationIterator&lt;/tt&gt; reads the input, the buffers get set up as follows (note that the first field of Item should be the same as the key):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;- Read Item(&quot;a&quot;, 1)

- Buffers are now:
  Key &quot;a&quot; --&amp;gt; Item(&quot;a&quot;, 1)

- Read Item(&quot;b&quot;, 3)

- Buffers are now:
  Key &quot;a&quot; -&amp;gt; Item(&quot;b&quot;, 3)
  Key &quot;b&quot; -&amp;gt; Item(&quot;b&quot;, 3)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The buffer for key &quot;a&quot; now contains Item(&quot;b&quot;, 3). That&apos;s because both buffers contain a reference to the same Item instance, and that Item instance&apos;s fields were updated when &lt;tt&gt;Item(&quot;b&quot;, 3)&lt;/tt&gt; was read.&lt;/p&gt;

&lt;p&gt;When &lt;tt&gt;AggregateIterator&lt;/tt&gt; finally calls the test&apos;s reduce function, it will pass the same Item instance (&lt;tt&gt;Item(&quot;a&quot;, 7)&lt;/tt&gt;) as both the buffer and the input record. At that point, the buffers for &quot;a&quot;, &quot;b&quot;, and &quot;c&quot; will all contain &lt;tt&gt;Item(&quot;a&quot;, 7)&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I &lt;em&gt;think&lt;/em&gt; the fix for this is to make &lt;tt&gt;NewInstance&lt;/tt&gt; non-foldable. My linked test passes with that change (and fails without it). I will run the unit tests and hopefully make a PR tomorrow, assuming the proposed fix doesn&apos;t break something else besides &lt;tt&gt;ConstantFoldingSuite&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17521894" author="bersprockets" created="Wed, 13 Apr 2022 19:17:05 +0000"  >&lt;p&gt;By the way, here is some code that demos the issue in spark-shell:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;// repro in scala using Java APIs
import org.apache.spark.api.java.function.{MapFunction, ReduceFunction}
import org.apache.spark.sql.Encoders;
import collection.JavaConverters._

class Item (var k: String, var v: Int) extends java.io.Serializable {  
  def setK(value: String): Unit = {
    k = value
  }
  def setV(value: Int): Unit = {
    v = value
  }
  def getK: String = {
    k
  }
  def getV: Int = {
    v
  }
  def this() {
    this(&quot;&quot;, 0)
  }

  def addValue(inc: Int): Item = {
    new Item(k, v + inc)
  }

  override def toString: String = {
    s&quot;Item($k,$v)&quot;
  }
}

val items = Seq(
  new Item(&quot;a&quot;, 1),
  new Item(&quot;b&quot;, 3),
  new Item(&quot;c&quot;, 2),
  new Item(&quot;a&quot;, 7)
)

val ds = spark.createDataFrame(items.asJava, classOf[Item]).as(Encoders.bean(classOf[Item])).coalesce(1)

val mf = new MapFunction[Item, String] {
  override def call(item: Item): String = {
    println(s&quot;Key is ${item.k} for item $item&quot;)
    item.k
  }
}

val kvgd1 = ds.groupByKey(mf, Encoders.STRING)

val rf = new ReduceFunction[Item] {
  override def call(item1: Item, item2: Item): Item = {
    val sameRef = item1 eq item2
    val msg = s&quot;item1 $item1; item2 $item2&quot;
    val newItem = item1.addValue(item2.v)
    println(s&quot;$msg; new item is $newItem; sameRef is $sameRef&quot;)
    newItem
  }
}
 
kvgd1.reduceGroups(rf).show(10)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This will return&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+---+----------------------------------------------------------------------------+
|key|ReduceAggregator($line20.$read$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw$Item)|
+---+----------------------------------------------------------------------------+
|  a|                                                                      {a, 7}|
|  b|                                                                      {a, 7}|
|  c|                                                                      {a, 7}|
+---+----------------------------------------------------------------------------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;However, it should return&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+---+----------------------------------------------------------------------------+
|key|ReduceAggregator($line20.$read$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw$$iw$Item)|
+---+----------------------------------------------------------------------------+
|  a|                                                                      {a, 8}|
|  b|                                                                      {b, 3}|
|  c|                                                                      {c, 2}|
+---+----------------------------------------------------------------------------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17521907" author="apachespark" created="Wed, 13 Apr 2022 19:40:07 +0000"  >&lt;p&gt;User &apos;bersprockets&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/36183&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/36183&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17521909" author="apachespark" created="Wed, 13 Apr 2022 19:41:13 +0000"  >&lt;p&gt;User &apos;bersprockets&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/36183&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/36183&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17522588" author="gurwls223" created="Thu, 14 Apr 2022 23:38:46 +0000"  >&lt;p&gt;Issue resolved by pull request 36183&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/36183&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/36183&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 30 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z119ig:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>