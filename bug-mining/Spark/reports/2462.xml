<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:32:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-10548] Concurrent execution in SQL does not work</title>
                <link>https://issues.apache.org/jira/browse/SPARK-10548</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;From the mailing list:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt; { df1.count() } 
&lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt; { df2.count() } 

java.lang.IllegalArgumentException: spark.sql.execution.id is already set 
        at org.apache.spark.sql.execution.SQLExecution$.withNewExecutionId(SQLExecution.scala:87) 
        at org.apache.spark.sql.DataFrame.withNewExecutionId(DataFrame.scala:1904) 
        at org.apache.spark.sql.DataFrame.collect(DataFrame.scala:1385) 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;=== edit ===&lt;/p&gt;

&lt;p&gt;Simple reproduction:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;(1 to 100).par.foreach { _ =&amp;gt;
  sc.parallelize(1 to 5).map { i =&amp;gt; (i, i) }.toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;).count()
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12863179">SPARK-10548</key>
            <summary>Concurrent execution in SQL does not work</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="andrewor14">Andrew Or</assignee>
                                    <reporter username="andrewor14">Andrew Or</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Sep 2015 20:00:49 +0000</created>
                <updated>Fri, 6 May 2016 20:20:47 +0000</updated>
                            <resolved>Tue, 8 Mar 2016 19:01:02 +0000</resolved>
                                    <version>1.5.0</version>
                                    <fixVersion>1.5.1</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="14739938" author="apachespark" created="Fri, 11 Sep 2015 00:51:05 +0000"  >&lt;p&gt;User &apos;andrewor14&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/8710&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/8710&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14741294" author="apachespark" created="Fri, 11 Sep 2015 18:28:18 +0000"  >&lt;p&gt;User &apos;andrewor14&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/8721&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/8721&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15134146" author="akshayh" created="Fri, 5 Feb 2016 13:10:53 +0000"  >&lt;p&gt;We are still facing this issue while repeatedly querying cassandra database using spark-cassandra-connector.&lt;/p&gt;

&lt;p&gt;Spark version 1.5.1&lt;br/&gt;
spark-cassandra-connector 1.5.0-M3&lt;/p&gt;</comment>
                            <comment id="15182265" author="nicerobot" created="Sun, 6 Mar 2016 18:44:59 +0000"  >&lt;p&gt;I might be misunderstanding the solution but i&apos;m not clear how the implementation addresses the problem. The issue appears to be that the ThreadLocal property &lt;tt&gt;&quot;spark.sql.execution.id&quot;&lt;/tt&gt; is not handled properly (cleaned up) in thread-pooled environments. The implemented solution is essentially in &lt;tt&gt;SparkContext&lt;/tt&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      &lt;span class=&quot;code-comment&quot;&gt;// Note: make a clone such that changes in the parent properties aren&apos;t reflected in
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// the those of the children threads, which has confusing semantics (SPARK-10563).
&lt;/span&gt;      SerializationUtils.clone(parent).asInstanceOf[Properties]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But from what I can tell, the problem isn&apos;t related to parent/child threads. It&apos;s that &lt;tt&gt;localProperties&lt;/tt&gt;&apos; &lt;tt&gt;&quot;spark.sql.execution.id&quot;&lt;/tt&gt; key is retained after a thread completes. When that thread is returned to the pool and reused by another execution, the execution id will remain because it&apos;s part of the SparkContext&apos;s &lt;tt&gt;localProperties&lt;/tt&gt;. It seems like a &lt;tt&gt;&quot;spark.sql.execution.id&quot;&lt;/tt&gt; should be local to an execution context instance (a &lt;tt&gt;QueryExecution&lt;/tt&gt;?), not global to a thread nor specifically a property of a SQLContext/SparkContext.&lt;/p&gt;</comment>
                            <comment id="15183660" author="zsxwing" created="Mon, 7 Mar 2016 20:43:17 +0000"  >&lt;p&gt;Thanks for reporting it. Looking at it.&lt;/p&gt;</comment>
                            <comment id="15183812" author="zsxwing" created="Mon, 7 Mar 2016 22:03:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nicerobot&quot; class=&quot;user-hover&quot; rel=&quot;nicerobot&quot;&gt;nicerobot&lt;/a&gt; The issue was reintroduced by &lt;a href=&quot;https://github.com/apache/spark/pull/9264&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/9264&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It will call Await.ready in &quot;runJob&quot; to wait for results. &quot;par&quot; uses a ForkJoin thread pool by default and ForkJoin thread pool will try to run new task when  Await.ready is called. In this case, new task will see other task&apos;s &quot;spark.sql.execution.id&quot;.&lt;/p&gt;

&lt;p&gt;Right now just don&apos;t use ForkJoin thread pool to launch Spark jobs until a fix is out.&lt;/p&gt;</comment>
                            <comment id="15184075" author="nicerobot" created="Tue, 8 Mar 2016 00:15:35 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zsxwing&quot; class=&quot;user-hover&quot; rel=&quot;zsxwing&quot;&gt;zsxwing&lt;/a&gt;. What&apos;s the recommended way to accomplish that?&lt;/p&gt;</comment>
                            <comment id="15185513" author="zsxwing" created="Tue, 8 Mar 2016 19:01:02 +0000"  >&lt;p&gt;In a second thought, I prefer to close this one and open a new JIRA to discuss about how to make local properties work with ForkJoin thread pool since we may not need to fix it&lt;/p&gt;</comment>
                            <comment id="15185528" author="zsxwing" created="Tue, 8 Mar 2016 19:07:34 +0000"  >&lt;p&gt;Open &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-13747&quot; title=&quot;Concurrent execution in SQL doesn&amp;#39;t work with Scala ForkJoinPool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-13747&quot;&gt;&lt;del&gt;SPARK-13747&lt;/del&gt;&lt;/a&gt; for further discussion&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12948114">SPARK-13747</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12954730">TOREE-283</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 36 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2k0nr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333108">1.5.1</customfieldvalue>
    <customfieldvalue id="12333083">1.6.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>