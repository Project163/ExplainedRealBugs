<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:26:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-34859] Vectorized parquet reader needs synchronization among pages for column index</title>
                <link>https://issues.apache.org/jira/browse/SPARK-34859</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;the current implementation has a problem. the pages returned by `readNextFilteredRowGroup` may not be aligned, some columns may have more rows than others.&lt;/p&gt;

&lt;p&gt;Parquet is using `org.apache.parquet.column.impl.SynchronizingColumnReader` with `rowIndexes` to make sure that rows are aligned.&#160;&lt;/p&gt;

&lt;p&gt;Currently&#160;`VectorizedParquetRecordReader` doesn&apos;t have such synchronizing among pages from different columns. Using&#160;`readNextFilteredRowGroup` may result in incorrect result.&lt;/p&gt;

&lt;p&gt;&#160;&lt;br/&gt;
I have attache an example parquet file. This file is generated with `spark.range(0, 2000).map(i =&amp;gt; (i.toLong, i.toInt))` and the layout of this file is listed below.&lt;br/&gt;
row group 0&lt;br/&gt;
--------------------------------------------------------------------------------&lt;br/&gt;
_1: &#160;INT64 SNAPPY DO:0 FPO:4 SZ:8161/16104/1.97 VC:2000 ENC:PLAIN,BIT_PACKED &lt;span class=&quot;error&quot;&gt;&amp;#91;more&amp;#93;&lt;/span&gt;...&lt;br/&gt;
_2: &#160;INT32 SNAPPY DO:0 FPO:8165 SZ:8061/8052/1.00 VC:2000 ENC:PLAIN,BIT_PACKED &lt;span class=&quot;error&quot;&gt;&amp;#91;more&amp;#93;&lt;/span&gt;...&lt;/p&gt;

&lt;p&gt;&#160; &#160; _1 TV=2000 RL=0 DL=0&lt;br/&gt;
&#160; &#160; ----------------------------------------------------------------------------&lt;br/&gt;
&#160; &#160; page 0: &#160;DLE:BIT_PACKED RLE:BIT_PACKED VLE:PLAIN ST:[no stats for &#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;more&amp;#93;&lt;/span&gt;... VC:500&lt;br/&gt;
&#160; &#160; page 1: &#160;DLE:BIT_PACKED RLE:BIT_PACKED VLE:PLAIN ST:[no stats for &#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;more&amp;#93;&lt;/span&gt;... VC:500&lt;br/&gt;
&#160; &#160; page 2: &#160;DLE:BIT_PACKED RLE:BIT_PACKED VLE:PLAIN ST:[no stats for &#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;more&amp;#93;&lt;/span&gt;... VC:500&lt;br/&gt;
&#160; &#160; page 3: &#160;DLE:BIT_PACKED RLE:BIT_PACKED VLE:PLAIN ST:[no stats for &#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;more&amp;#93;&lt;/span&gt;... VC:500&lt;/p&gt;

&lt;p&gt;&#160; &#160; _2 TV=2000 RL=0 DL=0&lt;br/&gt;
&#160; &#160; ----------------------------------------------------------------------------&lt;br/&gt;
&#160; &#160; page 0: &#160;DLE:BIT_PACKED RLE:BIT_PACKED VLE:PLAIN ST:[no stats for &#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;more&amp;#93;&lt;/span&gt;... VC:1000&lt;br/&gt;
&#160; &#160; page 1: &#160;DLE:BIT_PACKED RLE:BIT_PACKED VLE:PLAIN ST:[no stats for &#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;more&amp;#93;&lt;/span&gt;... VC:1000&lt;br/&gt;
&#160;&lt;br/&gt;
As you can see in the row group 0, column1 has 4 data pages each with 500 values and column 2 has 2 data pages with 1000 values each.&#160;&lt;br/&gt;
If we want to filter the rows by values with _1 = 510 using columnindex, parquet will return the page 1 of column _1 and page 0 of column _2. Page 1 of column _1 starts with row 500, and page 0 of column _2 starts with row 0, and it will be incorrect if we simply read the two values as one row.&lt;br/&gt;
&#160;&lt;br/&gt;
As an example, If you try filter with&#160;&#160;_1 = 510 with column index on in current version, it will give you the wrong result&lt;br/&gt;
&lt;ins&gt;--&lt;del&gt;&lt;/ins&gt;&lt;/del&gt;--+&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;_1 &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;_2 &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;ins&gt;--&lt;del&gt;&lt;/ins&gt;&lt;/del&gt;--+&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;510&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;10 &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;ins&gt;--&lt;del&gt;&lt;/ins&gt;&lt;/del&gt;--+&lt;br/&gt;
And if turn columnindex off, you can get the correct result&lt;br/&gt;
&lt;ins&gt;--&lt;del&gt;&lt;/ins&gt;&lt;/del&gt;--+&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;_1 &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;_2 &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;ins&gt;--&lt;del&gt;&lt;/ins&gt;&lt;/del&gt;--+&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;510&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;510&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;&lt;ins&gt;--&lt;del&gt;&lt;/ins&gt;&lt;/del&gt;--+&lt;br/&gt;
&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13367411">SPARK-34859</key>
            <summary>Vectorized parquet reader needs synchronization among pages for column index</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="csun">Chao Sun</assignee>
                                    <reporter username="lxian2">Li Xian</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Thu, 25 Mar 2021 02:21:19 +0000</created>
                <updated>Fri, 13 Aug 2021 18:46:29 +0000</updated>
                            <resolved>Wed, 30 Jun 2021 21:21:56 +0000</resolved>
                                    <version>3.2.0</version>
                                    <fixVersion>3.2.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="17308435" author="q79969786" created="Thu, 25 Mar 2021 07:01:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lxian2&quot; class=&quot;user-hover&quot; rel=&quot;lxian2&quot;&gt;lxian2&lt;/a&gt; Thank you for reporting this issue. Would you like work on this?&lt;/p&gt;</comment>
                            <comment id="17308872" author="dongjoon" created="Thu, 25 Mar 2021 18:07:07 +0000"  >&lt;p&gt;Thank you for creating a new JIRA, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lxian2&quot; class=&quot;user-hover&quot; rel=&quot;lxian2&quot;&gt;lxian2&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="17309330" author="lxian2" created="Fri, 26 Mar 2021 10:24:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yumwang&quot; class=&quot;user-hover&quot; rel=&quot;yumwang&quot;&gt;yumwang&lt;/a&gt;&#160;Yes, I&apos;m interested in this issue and I would like to work on it.&#160;&lt;/p&gt;</comment>
                            <comment id="17310941" author="apachespark" created="Mon, 29 Mar 2021 19:30:18 +0000"  >&lt;p&gt;User &apos;lxian&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/31998&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/31998&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17310943" author="apachespark" created="Mon, 29 Mar 2021 19:30:48 +0000"  >&lt;p&gt;User &apos;lxian&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/31998&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/31998&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17310947" author="lxian2" created="Mon, 29 Mar 2021 19:40:18 +0000"  >&lt;p&gt;My plan is to use rowIndexes to do a filtering on the values read in&#160;org.apache.spark.sql.execution.datasources.parquet.VectorizedColumnReader#readBatch&lt;/p&gt;

&lt;p&gt;The values are written into a temporary WritableColumnVector&#160;first. And it will loop over the row indexes to find out which value should be written into the result vector.&lt;/p&gt;

&lt;p&gt;I did some tests in&#160;&lt;a href=&quot;https://github.com/apache/spark/pull/31998&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/31998&lt;/a&gt;&#160;and I think it looks good so far&lt;/p&gt;</comment>
                            <comment id="17352185" author="dongjoon" created="Wed, 26 May 2021 23:20:02 +0000"  >&lt;p&gt;Hi, All. I&apos;ll raise this to a release blocker for Apache Spark 3.2.0.&lt;/p&gt;</comment>
                            <comment id="17355890" author="apachespark" created="Wed, 2 Jun 2021 17:40:45 +0000"  >&lt;p&gt;User &apos;sunchao&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32753&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32753&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17355892" author="apachespark" created="Wed, 2 Jun 2021 17:41:11 +0000"  >&lt;p&gt;User &apos;sunchao&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32753&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32753&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17372202" author="dongjoon" created="Wed, 30 Jun 2021 21:21:57 +0000"  >&lt;p&gt;Issue resolved by pull request 32753&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32753&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32753&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310460">
                    <name>Child-Issue</name>
                                                                <inwardlinks description="is a child of">
                                        <issuelink>
            <issuekey id="13383483">SPARK-35743</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13389464">SPARK-36123</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13203936">SPARK-26345</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13025965" name="part-00000-bee08cae-04cd-491c-9602-4c66791af3d0-c000.snappy.parquet" size="16979" author="lxian2" created="Wed, 26 May 2021 03:21:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 19 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0p5uw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12349407">3.2.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>