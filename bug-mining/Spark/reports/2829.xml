<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:35:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-12030] Incorrect results when aggregate joined data</title>
                <link>https://issues.apache.org/jira/browse/SPARK-12030</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I have following issue.&lt;br/&gt;
I created 2 dataframes from JDBC (MySQL) and joined them (t1 has fk1 to t2)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;t1 = sqlCtx.read.jdbc(&lt;span class=&quot;code-quote&quot;&gt;&quot;jdbc:mysql:&lt;span class=&quot;code-comment&quot;&gt;//XXX&quot;&lt;/span&gt;, t1, id1, 0, size1, 200).cache()
&lt;/span&gt;t2 = sqlCtx.read.jdbc(&lt;span class=&quot;code-quote&quot;&gt;&quot;jdbc:mysql:&lt;span class=&quot;code-comment&quot;&gt;//XXX&quot;&lt;/span&gt;, t2).cache()
&lt;/span&gt;joined = t1.join(t2, t1.fk1 == t2.id2, &lt;span class=&quot;code-quote&quot;&gt;&quot;left_outer&quot;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Important: both table are cached, so results should be the same on every query.&lt;br/&gt;
Then I did come counts:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;t1.count() -&amp;gt; 5900729
t1.registerTempTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;t1&quot;&lt;/span&gt;)
sqlCtx.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select distinct(id1) from t1&quot;&lt;/span&gt;).count() -&amp;gt; 5900729
t2.count() -&amp;gt; 54298
joined.count() -&amp;gt; 5900729
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And here magic begins - I counted distinct id1 from joined table&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;joined.registerTempTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;joined&quot;&lt;/span&gt;)
sqlCtx.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select distinct(id1) from joined&quot;&lt;/span&gt;).count()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Results varies &lt;b&gt;(are different on every run)&lt;/b&gt; between 5899000 and &lt;br/&gt;
5900000 but never are equal to 5900729.&lt;/p&gt;

&lt;p&gt;In addition. I did more queries:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;sqlCtx.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select id1, count(*) from joined group by id1 having count(*) &amp;gt; 1&quot;&lt;/span&gt;).collect() 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This gives some results but this query return &lt;b&gt;1&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;len(sqlCtx.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select * from joined where id1 = result&quot;&lt;/span&gt;).collect())
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What&apos;s wrong ?&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12916689">SPARK-12030</key>
            <summary>Incorrect results when aggregate joined data</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nongli">Nong Li</assignee>
                                    <reporter username="maver1ck">Maciej Bry&#324;ski</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Fri, 27 Nov 2015 21:24:39 +0000</created>
                <updated>Wed, 31 Aug 2016 21:29:26 +0000</updated>
                            <resolved>Tue, 1 Dec 2015 21:00:20 +0000</resolved>
                                    <version>1.6.0</version>
                                    <fixVersion>1.5.3</fixVersion>
                    <fixVersion>1.6.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="15030430" author="smilegator" created="Sat, 28 Nov 2015 08:34:11 +0000"  >&lt;p&gt;What is the data type of id1?&lt;/p&gt;</comment>
                            <comment id="15030612" author="maver1ck" created="Sat, 28 Nov 2015 18:19:06 +0000"  >&lt;p&gt;id1, id2 and fk1 are integers.&lt;/p&gt;</comment>
                            <comment id="15030615" author="xguo27" created="Sat, 28 Nov 2015 18:26:51 +0000"  >&lt;p&gt;I tried your scenario with some TPCDS table last night, joined on integer columns, but could not reproduce incorrect results.&lt;/p&gt;

&lt;p&gt;Does your table have very large integer values which might overflow?&lt;/p&gt;</comment>
                            <comment id="15030618" author="smilegator" created="Sat, 28 Nov 2015 18:28:03 +0000"  >&lt;p&gt;If you cache `joined`, can you see the same issue? &lt;/p&gt;</comment>
                            <comment id="15030632" author="maver1ck" created="Sat, 28 Nov 2015 19:19:04 +0000"  >&lt;p&gt;When I cache joined the result of distinct(id) is always the same but not equal 5900729.&lt;/p&gt;

&lt;p&gt;I save data from JDBC to parquet. &lt;br/&gt;
And without cache I have same issue.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;I attached both dataframes as parquet.&lt;/b&gt; Readed by sqlCtx.read.parquet&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;t1 = sqlCtx.read.parquet(&lt;span class=&quot;code-quote&quot;&gt;&apos;t1&apos;&lt;/span&gt;)
t2 = sqlCtx.read.parquet(&lt;span class=&quot;code-quote&quot;&gt;&apos;t2&apos;&lt;/span&gt;)
t1.registerTempTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;t1&quot;&lt;/span&gt;)
t2.registerTempTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;t2&quot;&lt;/span&gt;)
joined = t1.join(t2, t1.fk1 == t2.id2, &lt;span class=&quot;code-quote&quot;&gt;&quot;left_outer&quot;&lt;/span&gt;)
t1.count()  -&amp;gt; 5904733
sqlCtx.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select distinct(id1) from t1&quot;&lt;/span&gt;).count() -&amp;gt; 5904733
t2.count() -&amp;gt; 54298
joined.count() -&amp;gt; 5904733
joined.registerTempTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;joined&quot;&lt;/span&gt;)
sqlCtx.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select distinct(id1) from joined&quot;&lt;/span&gt;).count() -&amp;gt; 5904435 # &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; varies between queries
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Plan for last select:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;== Physical Plan ==
TungstenAggregate(key=[], functions=[(count(1),mode=Final,isDistinct=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)], output=[count#3930L])
 TungstenExchange SinglePartition, None
  TungstenAggregate(key=[], functions=[(count(1),mode=Partial,isDistinct=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)], output=[count#3933L])
   TungstenAggregate(key=[id1#3895], functions=[], output=[])
    TungstenExchange hashpartitioning(id1#3895,400), None
     TungstenAggregate(key=[id1#3895], functions=[], output=[id1#3895])
      Project [id1#3895]
       SortMergeOuterJoin [fk1#3896], [id2#3897], LeftOuter, None
        Sort [fk1#3896 ASC], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, 0
         TungstenExchange hashpartitioning(fk1#3896,400), None
          Scan ParquetRelation[file:t1] PushedFilter: [] [id1#3895,fk1#3896]
        Sort [id2#3897 ASC], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, 0
         TungstenExchange hashpartitioning(id2#3897,400), None
          Scan ParquetRelation[file:t2] PushedFilter: [] [id2#3897]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;On GUI I see the problem in first TungstenAggregate:&lt;br/&gt;
number of input rows: 5904733&lt;br/&gt;
number of output rows: 5904435&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Screenshot from GUI attached&lt;/b&gt;&lt;/p&gt;</comment>
                            <comment id="15030633" author="maver1ck" created="Sat, 28 Nov 2015 19:25:19 +0000"  >&lt;p&gt;Spark version 1.6.0-preview2 started in standalone mode on 3 hosts (128GB RAM, 20/40 cores each). Build:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;mvn -e -Phive -Phive-thriftserver -Pyarn -Phadoop-2.6 -Dhadoop.version=2.6.0 -DskipTests &lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And spark-defaults.conf:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;spark.master                     spark:&lt;span class=&quot;code-comment&quot;&gt;//somehost:7077
&lt;/span&gt;spark.serializer                 org.apache.spark.serializer.KryoSerializer
spark.driver.memory              20g
spark.executor.extraJavaOptions -XX:-UseGCOverheadLimit -XX:+UseG1GC  -Dhdp.version=current -XX:-UseCompressedOops
spark.driver.extraJavaOptions -XX:-UseGCOverheadLimit -XX:+UseG1GC  -Dhdp.version=current -XX:-UseCompressedOops
spark.executor.memory           30g
spark.storage.memoryFraction            0.2
spark.shuffle.memoryFraction            0.4
spark.driver.maxResultSize              4g
spark.cores.max         30
spark.executor.extraClassPath   spark/mysql-connector-java-5.1.35-bin.jar:spark/spark-csv_2.10-1.3.0-SNAPSHOT.jar:spark/commons-csv-1.2.jar:spark/aerospike-spark-0.3-SNAPSHOT-jar-with-dependencies.jar
spark.driver.extraClassPath    spark/mysql-connector-java-5.1.35-bin.jar:spark/spark-csv_2.10-1.3.0-SNAPSHOT.jar:spark/commons-csv-1.2.jar:spark/aerospike-spark-0.3-SNAPSHOT-jar-with-dependencies.jar
spark.kryoserializer.buffer.max 1g
spark.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.parallelism       400
spark.sql.autoBroadcastJoinThreshold    0
spark.yarn.am.extraJavaOptions -Dhdp.version=current
spark.executor.instances    10
spark.yarn.queue    dwh
spark.python.worker.reuse       &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
spark.sql.shuffle.partitions    400
spark.io.compression.codec      lz4
spark.eventLog.enabled  &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
spark.eventLog.dir      history/
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15030638" author="smilegator" created="Sat, 28 Nov 2015 19:34:45 +0000"  >&lt;p&gt;Trying to reproduce it using your parquet files. Thanks!&lt;/p&gt;</comment>
                            <comment id="15030643" author="maver1ck" created="Sat, 28 Nov 2015 19:42:38 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smilegator&quot; class=&quot;user-hover&quot; rel=&quot;smilegator&quot;&gt;smilegator&lt;/a&gt;&lt;br/&gt;
I tried following things:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;disable kryoserializer&lt;/li&gt;
	&lt;li&gt;disable lz4&lt;/li&gt;
	&lt;li&gt;change join type to inner&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Without success. &lt;br/&gt;
Next I&apos;ll try to reproduce this on 1.5.2.&lt;/p&gt;</comment>
                            <comment id="15030652" author="smilegator" created="Sat, 28 Nov 2015 19:59:01 +0000"  >&lt;p&gt;Thank you! &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maver1ck&quot; class=&quot;user-hover&quot; rel=&quot;maver1ck&quot;&gt;maver1ck&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;That will be great if we can know whether this is an existing bug in 1.5.2. We need to deliver the fix to all the affected versions. &lt;/p&gt;</comment>
                            <comment id="15030694" author="smilegator" created="Sat, 28 Nov 2015 23:18:15 +0000"  >&lt;p&gt;I can reproduce it now. Will take a look at it and try to fix it. Thanks!&lt;/p&gt;</comment>
                            <comment id="15030887" author="maver1ck" created="Sun, 29 Nov 2015 11:07:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smilegator&quot; class=&quot;user-hover&quot; rel=&quot;smilegator&quot;&gt;smilegator&lt;/a&gt;&lt;br/&gt;
I tested 1.5.2 (binaries from spark page) and it works great.&lt;br/&gt;
So I think it&apos;s only Spark 1.6.0 problem.&lt;/p&gt;</comment>
                            <comment id="15031060" author="smilegator" created="Sun, 29 Nov 2015 16:34:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maver1ck&quot; class=&quot;user-hover&quot; rel=&quot;maver1ck&quot;&gt;maver1ck&lt;/a&gt; Yeah, the problem might be introduced in 1.6.0. So far, I think it is caused by SortMergeJoin. I believe you will not hit the problem if your plan does not use sort merge join. Thanks!&lt;/p&gt;</comment>
                            <comment id="15031206" author="smilegator" created="Sun, 29 Nov 2015 23:06:23 +0000"  >&lt;p&gt;I can reproduced a similar issue in a Sort. I think the impact could be broader. &lt;/p&gt;</comment>
                            <comment id="15032724" author="smilegator" created="Mon, 30 Nov 2015 23:37:52 +0000"  >&lt;p&gt;I believe I already found which PRs introduced the regression. However, these two PRs are huge. I need more times to locate the exact lines. &lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="15032857" author="davies" created="Tue, 1 Dec 2015 01:26:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smilegator&quot; class=&quot;user-hover&quot; rel=&quot;smilegator&quot;&gt;smilegator&lt;/a&gt; Could you post the related PRs here? So we can also looking into it, thanks!&lt;/p&gt;</comment>
                            <comment id="15032887" author="smilegator" created="Tue, 1 Dec 2015 01:56:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-7542&quot; title=&quot;Support off-heap sort buffer in UnsafeExternalSorter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-7542&quot;&gt;&lt;del&gt;SPARK-7542&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Support off-heap index/sort buffer&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/9477&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/9477&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;and&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-11389&quot; title=&quot;Add support for off-heap memory to MemoryManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-11389&quot;&gt;&lt;del&gt;SPARK-11389&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;CORE&amp;#93;&lt;/span&gt; Add support for off-heap memory to MemoryManage&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/9344&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/9344&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The problem does not exist if I took out the code changes by these two JIRAs. The code changes of these two JIRAs are mixed. Thus, I assume it should be caused by #9477.&lt;/p&gt;</comment>
                            <comment id="15032902" author="smilegator" created="Tue, 1 Dec 2015 01:58:09 +0000"  >&lt;p&gt;I already excluded Exchange and Partitioning. It should be caused by Sort. Will continue the investigation tonight. Will keep you posted if I can locate the exact changes. Thanks!&lt;/p&gt;</comment>
                            <comment id="15032927" author="yhuai" created="Tue, 1 Dec 2015 02:08:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smilegator&quot; class=&quot;user-hover&quot; rel=&quot;smilegator&quot;&gt;smilegator&lt;/a&gt; Can you post the case that triggers the problem? Also, is &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-12055&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-12055&lt;/a&gt; a related issue?&lt;/p&gt;</comment>
                            <comment id="15032939" author="smilegator" created="Tue, 1 Dec 2015 02:15:36 +0000"  >&lt;p&gt;Let me post a simple case that can trigger the data corruption. The data set t1 is downloaded from this JIRA. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;test(&lt;span class=&quot;code-quote&quot;&gt;&quot;sort result&quot;&lt;/span&gt;) {
  withSQLConf(SQLConf.AUTO_BROADCASTJOIN_THRESHOLD.key -&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;-1&quot;&lt;/span&gt;,
  SQLConf.SHUFFLE_PARTITIONS.key -&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;) {
  val t1test = sqlContext.read.parquet(&lt;span class=&quot;code-quote&quot;&gt;&quot;/Users/xiaoli/Downloads/t1&quot;&lt;/span&gt;).dropDuplicates().where(&lt;span class=&quot;code-quote&quot;&gt;&quot;fk1=39 or (fk1=525 and id1 &amp;lt; 664618 and id1 &amp;gt;= 470050)&quot;&lt;/span&gt;).repartition(1).cache()

  &lt;span class=&quot;code-comment&quot;&gt;//t1test.orderBy(&lt;span class=&quot;code-quote&quot;&gt;&quot;fk1&quot;&lt;/span&gt;).explain(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
&lt;/span&gt;  val t1 = t1test.orderBy(&lt;span class=&quot;code-quote&quot;&gt;&quot;fk1&quot;&lt;/span&gt;).cache()

  checkAnswer( t1test, t1.collect() )
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I am not sure if you can see the un-match. I am unable to reproduce it in a Thinkpad, but I can easily reproduce it in my macbook. &lt;/p&gt;

&lt;p&gt;My case did not hit any exception, but I saw a data corruption. After sorting, one row &lt;span class=&quot;error&quot;&gt;&amp;#91;664615,525&amp;#93;&lt;/span&gt; is replaced by another row &lt;span class=&quot;error&quot;&gt;&amp;#91;664611,525&amp;#93;&lt;/span&gt;. Thus one row disappeared after sorting, but you can see a duplicate of another row. The number of total rows was not changed after the sort. &lt;/p&gt;</comment>
                            <comment id="15033321" author="nongli" created="Tue, 1 Dec 2015 08:19:37 +0000"  >&lt;p&gt;I think I tracked it down. The bug is from this PR which exposed another bug.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-7542&quot; title=&quot;Support off-heap sort buffer in UnsafeExternalSorter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-7542&quot;&gt;&lt;del&gt;SPARK-7542&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; Support off-heap index/sort buffer&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/9477&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/9477&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The issue I think is in &lt;a href=&quot;https://github.com/apache/spark/blob/master/unsafe/src/main/java/org/apache/spark/unsafe/Platform.java#L108&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/unsafe/src/main/java/org/apache/spark/unsafe/Platform.java#L108&lt;/a&gt;&lt;br/&gt;
which does not support overlapping regions. For example,&lt;/p&gt;

&lt;p&gt;If the src region is [100 - 1000) and the dest region is [500-1500) and the copy size is 100, the first copy of 100 bytes would overwrite the bytes at offset 500. This needs a check to see that the src region is before the dest and run this loop backwards I think.&lt;/p&gt;

&lt;p&gt;This only hits on larger data sets when a single copy exceeds the threshold (1M).&lt;/p&gt;</comment>
                            <comment id="15033356" author="smilegator" created="Tue, 1 Dec 2015 08:48:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nongli&quot; class=&quot;user-hover&quot; rel=&quot;nongli&quot;&gt;nongli&lt;/a&gt; Thank you very much! &lt;/p&gt;

&lt;p&gt;Your finding sounds reasonable. I observed it happens only when the number of rows is larger than 65539. The corrupted area always exists at 65538.  Almost the last row. &lt;/p&gt;

&lt;p&gt;Please submit the PR. I will verify it. &lt;/p&gt;

&lt;p&gt;Thanks again! You are SO GREAT!&lt;/p&gt;</comment>
                            <comment id="15034141" author="apachespark" created="Tue, 1 Dec 2015 17:33:02 +0000"  >&lt;p&gt;User &apos;nongli&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/10068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/10068&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15034563" author="yhuai" created="Tue, 1 Dec 2015 21:00:20 +0000"  >&lt;p&gt;Issue resolved by pull request 10068&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/10068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/10068&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15034615" author="davies" created="Tue, 1 Dec 2015 21:29:02 +0000"  >&lt;p&gt;I also figured out the root cause last night, that&apos;s an interesting bug.&lt;/p&gt;</comment>
                            <comment id="15034641" author="maver1ck" created="Tue, 1 Dec 2015 21:44:06 +0000"  >&lt;p&gt;Will the fix be included in 1.6.0 ?&lt;/p&gt;</comment>
                            <comment id="15034652" author="yhuai" created="Tue, 1 Dec 2015 21:49:55 +0000"  >&lt;p&gt;Yes, it will be in 1.6.0.&lt;/p&gt;</comment>
                            <comment id="15034936" author="yhuai" created="Wed, 2 Dec 2015 00:15:17 +0000"  >&lt;p&gt;I also merged the patch to branch 1.5. Please note that, in 1.5, we do not trigger the corner case. However, in 1.6, we use the problematic method in tim sort, which exposes the problem.&lt;/p&gt;</comment>
                            <comment id="15035164" author="smilegator" created="Wed, 2 Dec 2015 02:47:23 +0000"  >&lt;p&gt;I did verify the fix using my test cases. It works! &lt;/p&gt;

&lt;p&gt;I posted a question in the PR. If possible, could anyone answer it? Really appreciate your help! &lt;/p&gt;

&lt;p&gt;Thank you! &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12917055">SPARK-12055</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 50 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2p0q7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333083">1.6.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>