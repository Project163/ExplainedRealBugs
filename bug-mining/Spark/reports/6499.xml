<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:05:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-27798] ConvertToLocalRelation should tolerate expression reusing output object</title>
                <link>https://issues.apache.org/jira/browse/SPARK-27798</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Steps to reproduce:&lt;/p&gt;

&lt;p&gt;Create a local Dataset (at least two distinct rows) with a binary Avro field. Use the&#160;&lt;tt&gt;from_avro&lt;/tt&gt; function to deserialize the binary into another column. Verify that all of the rows incorrectly have the same value.&lt;/p&gt;

&lt;p&gt;Here&apos;s a concrete example (using Spark 2.4.3). All it does is converts a list of TestPayload objects into binary using the defined avro schema, then tries to deserialize using&#160;&lt;tt&gt;from_avro&lt;/tt&gt; with that same schema:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.avro.Schema
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.avro.&lt;span class=&quot;code-keyword&quot;&gt;generic&lt;/span&gt;.{GenericDatumWriter, GenericRecord, GenericRecordBuilder}
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.avro.io.EncoderFactory
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.SparkSession
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.avro.from_avro
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.functions.col

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.io.ByteArrayOutputStream

object TestApp &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; App {
  &lt;span class=&quot;code-comment&quot;&gt;// Payload container
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TestEvent(payload: Array[&lt;span class=&quot;code-object&quot;&gt;Byte&lt;/span&gt;])
  &lt;span class=&quot;code-comment&quot;&gt;// Deserialized Payload
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TestPayload(message: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;)
  &lt;span class=&quot;code-comment&quot;&gt;// Schema &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; Payload
&lt;/span&gt;  val simpleSchema =
    &quot;&quot;&quot;
      |{
      |&lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;record&quot;&lt;/span&gt;,
      |&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;Payload&quot;&lt;/span&gt;,
      |&lt;span class=&quot;code-quote&quot;&gt;&quot;fields&quot;&lt;/span&gt; : [ {&lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;message&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt; : [ &lt;span class=&quot;code-quote&quot;&gt;&quot;string&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt; ] } ]
      |}
    &quot;&quot;&quot;.stripMargin
  &lt;span class=&quot;code-comment&quot;&gt;// Convert TestPayload into avro binary
&lt;/span&gt;  def generateSimpleSchemaBinary(record: TestPayload, avsc: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;): Array[&lt;span class=&quot;code-object&quot;&gt;Byte&lt;/span&gt;] = {
    val schema = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Schema.Parser().parse(avsc)
    val out = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ByteArrayOutputStream()
    val writer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GenericDatumWriter[GenericRecord](schema)
    val encoder = EncoderFactory.get().binaryEncoder(out, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
    val rootRecord = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GenericRecordBuilder(schema).set(&lt;span class=&quot;code-quote&quot;&gt;&quot;message&quot;&lt;/span&gt;, record.message).build()
    writer.write(rootRecord, encoder)
    encoder.flush()
    out.toByteArray
  }

  val spark: SparkSession = SparkSession.builder().master(&lt;span class=&quot;code-quote&quot;&gt;&quot;local[*]&quot;&lt;/span&gt;).getOrCreate()
  &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; spark.implicits._
  List(
    TestPayload(&lt;span class=&quot;code-quote&quot;&gt;&quot;one&quot;&lt;/span&gt;),
    TestPayload(&lt;span class=&quot;code-quote&quot;&gt;&quot;two&quot;&lt;/span&gt;),
    TestPayload(&lt;span class=&quot;code-quote&quot;&gt;&quot;three&quot;&lt;/span&gt;),
    TestPayload(&lt;span class=&quot;code-quote&quot;&gt;&quot;four&quot;&lt;/span&gt;)
  ).map(payload =&amp;gt; TestEvent(generateSimpleSchemaBinary(payload, simpleSchema)))
    .toDS()
    .withColumn(&lt;span class=&quot;code-quote&quot;&gt;&quot;deserializedPayload&quot;&lt;/span&gt;, from_avro(col(&lt;span class=&quot;code-quote&quot;&gt;&quot;payload&quot;&lt;/span&gt;), simpleSchema))
    .show(truncate = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And here is what this program outputs:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+----------------------+-------------------+
|payload&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; |deserializedPayload|
+----------------------+-------------------+
|[00 06 6F 6E 65]&#160;&#160;&#160;&#160;&#160; |[four]&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; |
|[00 06 74 77 6F]&#160;&#160;&#160;&#160;&#160; |[four]&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; |
|[00 0A 74 68 72 65 65]|[four]&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; |
|[00 08 66 6F 75 72]&#160;&#160; |[four]&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; |
+----------------------+-------------------+&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here, we can see that the avro binary is correctly generated, but the deserialized version is a copy of the last row. I have not yet verified that this is an issue in cluster mode as well.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I dug into a bit more of the code and it seems like the resuse of &lt;tt&gt;result&lt;/tt&gt; in &lt;tt&gt;AvroDataToCatalyst&lt;/tt&gt; is overwriting the decoded values of previous rows. I set a breakpoint in &lt;tt&gt;LocalRelation&lt;/tt&gt; and the &lt;tt&gt;data&lt;/tt&gt; sequence seem to all point to the same address in memory - and therefore a mutation in one variable will cause all of it to mutate.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12969324/12969324_Screen+Shot+2019-05-21+at+2.39.27+PM.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13234738">SPARK-27798</key>
            <summary>ConvertToLocalRelation should tolerate expression reusing output object</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="viirya">L. C. Hsieh</assignee>
                                    <reporter username="ykmori15">Yosuke Mori</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Tue, 21 May 2019 22:25:41 +0000</created>
                <updated>Mon, 12 Dec 2022 18:10:37 +0000</updated>
                            <resolved>Sat, 8 Jun 2019 19:10:57 +0000</resolved>
                                    <version>1.6.3</version>
                    <version>2.0.2</version>
                    <version>2.1.3</version>
                    <version>2.2.3</version>
                    <version>2.4.3</version>
                                    <fixVersion>2.3.4</fixVersion>
                    <fixVersion>2.4.4</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16845311" author="ykmori15" created="Tue, 21 May 2019 22:38:09 +0000"  >&lt;p&gt;Someone else seems to have encountered this issue as well &lt;a href=&quot;https://stackoverflow.com/questions/53623373/spark-2-4-0-to-avro-from-avro-deserialization-not-working-with-seq-todf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/53623373/spark-2-4-0-to-avro-from-avro-deserialization-not-working-with-seq-todf&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16845456" author="gurwls223" created="Wed, 22 May 2019 03:21:08 +0000"  >&lt;p&gt;Seems fixed in the current master:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+----------------------+-------------------+
|payload               |deserializedPayload|
+----------------------+-------------------+
|[00 06 6F 6E 65]      |[one]              |
|[00 06 74 77 6F]      |[two]              |
|[00 0A 74 68 72 65 65]|[three]            |
|[00 08 66 6F 75 72]   |[four]             |
+----------------------+-------------------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16851576" author="dongjoon" created="Thu, 30 May 2019 06:55:07 +0000"  >&lt;p&gt;Is this fixed in `branch-2.4`, too?&lt;/p&gt;</comment>
                            <comment id="16851583" author="dongjoon" created="Thu, 30 May 2019 07:02:21 +0000"  >&lt;p&gt;Ur, this seems to exist in `branch-2.4` until today.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+----------------------+-------------------+
|payload               |deserializedPayload|
+----------------------+-------------------+
|[00 06 6F 6E 65]      |[four]             |
|[00 06 74 77 6F]      |[four]             |
|[00 0A 74 68 72 65 65]|[four]             |
|[00 08 66 6F 75 72]   |[four]             |
+----------------------+-------------------+

scala&amp;gt; spark.version
res1: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; = 2.4.4-SNAPSHOT
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dbtsai&quot; class=&quot;user-hover&quot; rel=&quot;dbtsai&quot;&gt;dbtsai&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smilegator&quot; class=&quot;user-hover&quot; rel=&quot;smilegator&quot;&gt;smilegator&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Gengliang.Wang&quot; class=&quot;user-hover&quot; rel=&quot;Gengliang.Wang&quot;&gt;Gengliang.Wang&lt;/a&gt; since this is registered as a correctness issue.&lt;/p&gt;</comment>
                            <comment id="16851586" author="dongjoon" created="Thu, 30 May 2019 07:04:49 +0000"  >&lt;p&gt;BTW, thank you for reporting, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ykmori15&quot; class=&quot;user-hover&quot; rel=&quot;ykmori15&quot;&gt;ykmori15&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16851877" author="gengliang.wang" created="Thu, 30 May 2019 13:41:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ykmori15&quot; class=&quot;user-hover&quot; rel=&quot;ykmori15&quot;&gt;ykmori15&lt;/a&gt;Thanks for reporting. I am looking into it.&lt;/p&gt;</comment>
                            <comment id="16851966" author="gengliang.wang" created="Thu, 30 May 2019 15:07:22 +0000"  >&lt;p&gt;Turning off the rule &quot;ConvertToLocalRelation&quot; should work around the problem:&lt;br/&gt;
spark.conf.set(&#8220;spark.sql.optimizer.excludedRules&#8221;, &#8220;org.apache.spark.sql.catalyst.optimizer.ConvertToLocalRelation&#8221;)&lt;/p&gt;</comment>
                            <comment id="16852055" author="gengliang.wang" created="Thu, 30 May 2019 16:42:55 +0000"  >&lt;p&gt;Also, the issue can be reproduced on latest master if we use spark-shell.&lt;/p&gt;</comment>
                            <comment id="16852268" author="dongjoon" created="Thu, 30 May 2019 19:25:09 +0000"  >&lt;p&gt;Thank you so much for the investigation and update, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Gengliang.Wang&quot; class=&quot;user-hover&quot; rel=&quot;Gengliang.Wang&quot;&gt;Gengliang.Wang&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16856362" author="viirya" created="Wed, 5 Jun 2019 05:36:52 +0000"  >&lt;p&gt;Is anyone working one this? If none, I will probably send a PR to fix it.&lt;/p&gt;</comment>
                            <comment id="16856370" author="gengliang.wang" created="Wed, 5 Jun 2019 05:50:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=viirya&quot; class=&quot;user-hover&quot; rel=&quot;viirya&quot;&gt;viirya&lt;/a&gt; I am currently working on other issues.&lt;br/&gt;
Thanks for working on it!&lt;/p&gt;</comment>
                            <comment id="16859302" author="dongjoon" created="Sat, 8 Jun 2019 19:10:57 +0000"  >&lt;p&gt;This is resolved via the following PRs.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/spark/pull/24805&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/24805&lt;/a&gt; (master)&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/spark/pull/24822&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/24822&lt;/a&gt; (branch-2.4)&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/spark/pull/24823&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/24823&lt;/a&gt; (branch-2.3)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13219044">SPARK-27027</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12969324" name="Screen Shot 2019-05-21 at 2.39.27 PM.png" size="119669" author="ykmori15" created="Tue, 21 May 2019 22:26:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 23 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z02xj4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>