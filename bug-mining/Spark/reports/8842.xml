<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:32:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-40817] Remote spark.jars URIs ignored for Spark on Kubernetes in cluster mode </title>
                <link>https://issues.apache.org/jira/browse/SPARK-40817</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I discovered that remote URIs in &lt;tt&gt;spark.jars&lt;/tt&gt; get discarded when launching Spark on Kubernetes in cluster mode&#160;via spark-submit.&lt;/p&gt;
&lt;h1&gt;&lt;a name=&quot;Reproduction&quot;&gt;&lt;/a&gt;Reproduction&lt;/h1&gt;

&lt;p&gt;Here is an example reproduction with S3 being used for remote JAR storage:&#160;&lt;/p&gt;

&lt;p&gt;I first created 2 JARs:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;/opt/my-local-jar.jar&lt;/tt&gt; on the host where I&apos;m running spark-submit&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;s3://$BUCKET_NAME/my-remote-jar.jar&lt;/tt&gt; in an S3 bucket I own&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I then ran the following spark-submit command with &lt;tt&gt;spark.jars&lt;/tt&gt; pointing to both the local JAR and the remote JAR:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 spark-submit \
  --master k8s:&lt;span class=&quot;code-comment&quot;&gt;//https://$KUBERNETES_API_SERVER_URL:443 \
&lt;/span&gt;  --deploy-mode cluster \
  --name=spark-submit-test \
  --&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.spark.examples.SparkPi \
  --conf spark.jars=/opt/my-local-jar.jar,s3a:&lt;span class=&quot;code-comment&quot;&gt;//$BUCKET_NAME/my-remote-jar.jar \
&lt;/span&gt;  --conf spark.kubernetes.file.upload.path=s3a:&lt;span class=&quot;code-comment&quot;&gt;//$BUCKET_NAME/my-upload-path/ \
&lt;/span&gt;  [...]
  /opt/spark/examples/jars/spark-examples_2.12-3.1.3.jar
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Once the driver and the executors started, I confirmed that there was no trace of &lt;tt&gt;my-remote-jar.jar&lt;/tt&gt; anymore. For example, looking at the Spark History Server, I could see that &lt;tt&gt;spark.jars&lt;/tt&gt; got transformed into this:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13051008/13051008_image-2022-10-17-10-44-46-862.png&quot; height=&quot;80&quot; width=&quot;991&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;There was no mention of &lt;tt&gt;my-remote-jar.jar&lt;/tt&gt; on the classpath or anywhere else.&lt;/p&gt;

&lt;p&gt;Note that I ran all tests with Spark 3.1.3, however the code which handles those dependencies seems to be the same for more recent versions of Spark as well.&lt;/p&gt;
&lt;h1&gt;&lt;a name=&quot;Rootcausedescription&quot;&gt;&lt;/a&gt;Root cause description&lt;/h1&gt;

&lt;p&gt;I believe that the issue seems to be coming from &lt;a href=&quot;https://github.com/apache/spark/blob/d1f8a503a26bcfb4e466d9accc5fa241a7933667/resource-managers/kubernetes/core/src/main/scala/org/apache/spark/deploy/k8s/features/BasicDriverFeatureStep.scala#L163-L186&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this logic&lt;/a&gt; in &lt;tt&gt;BasicDriverFeatureStep.getAdditionalPodSystemProperties()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Specifically, this logic takes all URIs in &lt;tt&gt;spark.jars&lt;/tt&gt;, &lt;a href=&quot;https://github.com/apache/spark/blob/d1f8a503a26bcfb4e466d9accc5fa241a7933667/resource-managers/kubernetes/core/src/main/scala/org/apache/spark/deploy/k8s/features/BasicDriverFeatureStep.scala#L165&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;filters only on local URIs,&lt;/a&gt;&#160;&lt;a href=&quot;https://github.com/apache/spark/blob/d1f8a503a26bcfb4e466d9accc5fa241a7933667/resource-managers/kubernetes/core/src/main/scala/org/apache/spark/deploy/k8s/features/BasicDriverFeatureStep.scala#L173&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;uploads&lt;/a&gt; those local files to &lt;tt&gt;spark.kubernetes.file.upload.path }}and then &lt;a href=&quot;https://github.com/apache/spark/blob/d1f8a503a26bcfb4e466d9accc5fa241a7933667/resource-managers/kubernetes/core/src/main/scala/org/apache/spark/deploy/k8s/features/BasicDriverFeatureStep.scala#L182&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;b&gt;replaces&lt;/b&gt;&lt;/a&gt; the value of {{spark.jars&lt;/tt&gt; with those newly uploaded JARs. By overwriting the previous value of &lt;tt&gt;spark.jars&lt;/tt&gt;, we are losing all mention of remote JARs that were previously specified there.&#160;&lt;/p&gt;

&lt;p&gt;Consequently, when the Spark driver starts afterwards, it only downloads JARs from &lt;tt&gt;spark.kubernetes.file.upload.path&lt;/tt&gt;.&lt;/p&gt;
&lt;h1&gt;&lt;a name=&quot;Possiblesolution&quot;&gt;&lt;/a&gt;Possible solution&lt;/h1&gt;

&lt;p&gt;I think a possible fix would be to not fully overwrite the value of &lt;tt&gt;spark.jars&lt;/tt&gt; but to make sure that we keep remote URIs there.&lt;/p&gt;

&lt;p&gt;The new logic would look something like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Seq(JARS, FILES, ARCHIVES, SUBMIT_PYTHON_FILES).foreach { key =&amp;gt;
  val uris = conf.get(key).filter(uri =&amp;gt; KubernetesUtils.isLocalAndResolvable(uri))
  &lt;span class=&quot;code-comment&quot;&gt;// Save remote URIs
&lt;/span&gt;  val remoteUris = conf.get(key).filter(uri =&amp;gt; !KubernetesUtils.isLocalAndResolvable(uri))
  val value = {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (key == ARCHIVES) {
      uris.map(UriBuilder.fromUri(_).fragment(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;).build()).map(_.toString)
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      uris
    }
  }
  val resolved = KubernetesUtils.uploadAndTransformFileUris(value, Some(conf.sparkConf))
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (resolved.nonEmpty) {
    val resolvedValue = &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (key == ARCHIVES) {
      uris.zip(resolved).map { &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; (uri, r) =&amp;gt;
        UriBuilder.fromUri(r).fragment(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; java.net.URI(uri).getFragment).build().toString
      }
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      resolved
    }
    &lt;span class=&quot;code-comment&quot;&gt;// don&apos;t forget to add remote URIs
&lt;/span&gt;    additionalProps.put(key.key, (resolvedValue ++ remoteUris).mkString(&lt;span class=&quot;code-quote&quot;&gt;&quot;,&quot;&lt;/span&gt;))
  }
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I tested it out in my environment and it worked: &lt;tt&gt;s3a://$BUCKET_NAME/my-remote-jar.jar&lt;/tt&gt; was kept in &lt;tt&gt;spark.jars&lt;/tt&gt; and the Spark driver was able to download it.&lt;/p&gt;

&lt;p&gt;I don&apos;t know the codebase well enough though to assess whether I am missing something else or if this is enough to fix the issue.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Spark 3.1.3&lt;/p&gt;

&lt;p&gt;Kubernetes 1.21&lt;/p&gt;

&lt;p&gt;Ubuntu 20.04.1&lt;/p&gt;</environment>
        <key id="13486567">SPARK-40817</key>
            <summary>Remote spark.jars URIs ignored for Spark on Kubernetes in cluster mode </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="_anton">Anton Ippolitov</assignee>
                                    <reporter username="_anton">Anton Ippolitov</reporter>
                        <labels>
                    </labels>
                <created>Mon, 17 Oct 2022 08:44:30 +0000</created>
                <updated>Fri, 20 Jan 2023 22:44:18 +0000</updated>
                            <resolved>Fri, 20 Jan 2023 22:41:03 +0000</resolved>
                                    <version>3.0.0</version>
                    <version>3.1.3</version>
                    <version>3.3.0</version>
                    <version>3.2.2</version>
                    <version>3.4.0</version>
                                    <fixVersion>3.2.4</fixVersion>
                    <fixVersion>3.3.2</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>Kubernetes</component>
                    <component>Spark Submit</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17623267" author="apachespark" created="Mon, 24 Oct 2022 16:14:09 +0000"  >&lt;p&gt;User &apos;antonipp&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/38376&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/38376&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17676635" author="bjornjorgensen" created="Fri, 13 Jan 2023 14:11:22 +0000"  >&lt;p&gt;If this affects 3.4 you must upgrade the &quot;Affects Version/s:&quot;  &lt;/p&gt;</comment>
                            <comment id="17679098" author="apachespark" created="Fri, 20 Jan 2023 10:43:46 +0000"  >&lt;p&gt;User &apos;antonipp&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/39670&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/39670&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17679099" author="apachespark" created="Fri, 20 Jan 2023 10:44:19 +0000"  >&lt;p&gt;User &apos;antonipp&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/39669&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/39669&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13051008" name="image-2022-10-17-10-44-46-862.png" size="56604" author="_anton" created="Mon, 17 Oct 2022 08:44:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12314421" key="com.atlassian.jira.plugin.system.customfieldtypes:labels">
                        <customfieldname>Language</customfieldname>
                        <customfieldvalues>
                                        <label>scala</label>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 42 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z19exs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>