<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:54:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-20920] ForkJoinPool pools are leaked when writing hive tables with many partitions</title>
                <link>https://issues.apache.org/jira/browse/SPARK-20920</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;This bug is loosely related to &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-17396&quot; title=&quot;Threads number keep increasing when query on external CSV partitioned table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-17396&quot;&gt;&lt;del&gt;SPARK-17396&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In this case it happens when writing to a hive table with many, many, partitions (my table is partitioned by hour and stores data it gets from kafka in a spark streaming application):&lt;/p&gt;

&lt;p&gt;df.repartition()&lt;br/&gt;
  .write&lt;br/&gt;
  .format(&quot;orc&quot;)&lt;br/&gt;
  .option(&quot;path&quot;, s&quot;$tablesStoragePath/$tableName&quot;)&lt;br/&gt;
  .mode(SaveMode.Append)&lt;br/&gt;
  .partitionBy(&quot;dt&quot;, &quot;hh&quot;)&lt;br/&gt;
  .saveAsTable(tableName)&lt;/p&gt;

&lt;p&gt;As this table grows beyond a certain size, ForkJoinPool pools start leaking. Upon examination (with a debugger) I found that the caller is AlterTableRecoverPartitionsCommand and the problem happens when `evalTaskSupport` is used (line 555). I have tried setting a very large threshold via `spark.rdd.parallelListingThreshold` and the problem went away.&lt;/p&gt;

&lt;p&gt;My assumption is that the problem happens in this case and not in the one in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-17396&quot; title=&quot;Threads number keep increasing when query on external CSV partitioned table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-17396&quot;&gt;&lt;del&gt;SPARK-17396&lt;/del&gt;&lt;/a&gt; due to the fact that AlterTableRecoverPartitionsCommand is a case class while UnionRDD is an object so multiple instances are not possible, therefore no leak.&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
Rares&lt;/p&gt;</description>
                <environment></environment>
        <key id="13075759">SPARK-20920</key>
            <summary>ForkJoinPool pools are leaked when writing hive tables with many partitions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="srowen">Sean R. Owen</assignee>
                                    <reporter username="mrares">Rares Mirica</reporter>
                        <labels>
                    </labels>
                <created>Tue, 30 May 2017 08:17:45 +0000</created>
                <updated>Mon, 10 Jul 2017 23:40:23 +0000</updated>
                            <resolved>Tue, 13 Jun 2017 09:48:41 +0000</resolved>
                                    <version>2.1.1</version>
                                    <fixVersion>2.1.2</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16029277" author="srowen" created="Tue, 30 May 2017 11:20:15 +0000"  >&lt;p&gt;Duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-20848&quot; title=&quot;Dangling threads when reading parquet files in local mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-20848&quot;&gt;&lt;del&gt;SPARK-20848&lt;/del&gt;&lt;/a&gt;, it seems, or others related to ForkJoinPool&lt;/p&gt;</comment>
                            <comment id="16029393" author="mrares" created="Tue, 30 May 2017 13:04:10 +0000"  >&lt;p&gt;Yes, as per my comment, it&apos;s a related but distinct problem, I am hoping it&apos;s easily solvable by moving the ForkJoinPool into the companion object of the case class so that a single one is maintained&lt;/p&gt;</comment>
                            <comment id="16029492" author="srowen" created="Tue, 30 May 2017 14:36:53 +0000"  >&lt;p&gt;Yeah, we can&apos;t use a ForkJoinPool like this. It has to be started, closed where used. It&apos;s a similar fix &amp;#8211; want to give it a try? See &lt;a href=&quot;https://github.com/apache/spark/pull/18100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18100&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16038583" author="apachespark" created="Tue, 6 Jun 2017 10:35:03 +0000"  >&lt;p&gt;User &apos;srowen&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/18216&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18216&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16047662" author="srowen" created="Tue, 13 Jun 2017 09:48:41 +0000"  >&lt;p&gt;Issue resolved by pull request 18216&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/18216&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18216&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 23 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3fme7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>