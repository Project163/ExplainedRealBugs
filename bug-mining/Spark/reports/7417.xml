<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:18:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-32693] Compare two dataframes with same schema except nullable property</title>
                <link>https://issues.apache.org/jira/browse/SPARK-32693</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;My aim is to compare two dataframes with very close schemas : same number of fields, with the same names, types and metadata. The only difference comes from the fact that a given field might be nullable in one dataframe and not in the other.&lt;/p&gt;

&lt;p&gt;Here is the code that i used :&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val session = SparkSession.builder().getOrCreate()
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.Row
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.sql.Timestamp
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; scala.collection.JavaConverters._

&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;A(g: Timestamp, h: Option[Timestamp], i: Int)
&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;B(e: Int, f: Seq[A])
&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;C(g: Timestamp, h: Option[Timestamp], i: Option[Int])
&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;D(e: Option[Int], f: Seq[C])

val schema1 = StructType(Array(StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;, IntegerType, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;), StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;, IntegerType, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;), StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;c&quot;&lt;/span&gt;, IntegerType, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)))
val rowSeq1: List[Row] = List(Row(10, 1, 1), Row(10, 50, 2))
val df1 = session.createDataFrame(rowSeq1.asJava, schema1)
df1.printSchema()

val schema2 = StructType(Array(StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;, IntegerType), StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;, IntegerType), StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;c&quot;&lt;/span&gt;, IntegerType)))
val rowSeq2: List[Row] = List(Row(10, 1, 1))
val df2 = session.createDataFrame(rowSeq2.asJava, schema2)
df2.printSchema()

println(s&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt; of records &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; first &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; : ${df1.except(df2).count()}&quot;&lt;/span&gt;)
val schema3 = StructType(
 Array(
 StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;, IntegerType, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;),
 StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;, IntegerType, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;), 
 StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;c&quot;&lt;/span&gt;, IntegerType, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;), 
 StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;d&quot;&lt;/span&gt;, ArrayType(StructType(Array(StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;e&quot;&lt;/span&gt;, IntegerType, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;), StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;f&quot;&lt;/span&gt;, ArrayType(StructType(Array(StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;g&quot;&lt;/span&gt;, TimestampType), StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;h&quot;&lt;/span&gt;, TimestampType), StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;i&quot;&lt;/span&gt;, IntegerType, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
 ))))
 ))))
 )
 )
val date1 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Timestamp(1597589638L)
val date2 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Timestamp(1597599638L)
val rowSeq3: List[Row] = List(Row(10, 1, 1, Seq(B(100, Seq(A(date1, None, 1))))), Row(10, 50, 2, Seq(B(101, Seq(A(date2, None, 2))))))
val df3 = session.createDataFrame(rowSeq3.asJava, schema3)
df3.printSchema()

val schema4 = StructType(
 Array(
 StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;, IntegerType), 
 StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;, IntegerType), 
 StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;, IntegerType), 
 StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;d&quot;&lt;/span&gt;, ArrayType(StructType(Array(StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;e&quot;&lt;/span&gt;, IntegerType), StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;f&quot;&lt;/span&gt;, ArrayType(StructType(Array(StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;g&quot;&lt;/span&gt;, TimestampType), StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;h&quot;&lt;/span&gt;, TimestampType), StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;i&quot;&lt;/span&gt;, IntegerType)
 ))))
 ))))
 )
 )
val rowSeq4: List[Row] = List(Row(10, 1, 1, Seq(D(Some(100), Seq(C(date1, None, Some(1)))))))
val df4 = session.createDataFrame(rowSeq4.asJava, schema3)
df4.printSchema()
println(s&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt; of records &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; second &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; : ${df3.except(df4).count()}&quot;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The preceeding code shows what seems to me a bug in Spark :&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;If you consider two dataframes (df1 and df2) having exactly the same schema, except fields are not nullable for the first dataframe and are nullable for the second. Then, doing df1.except(df2).count() works well.&lt;/li&gt;
	&lt;li&gt;Now, if you consider two other dataframes (df3 and df4) having the same schema (with fields nullable on one side and not on the other). If these two dataframes contain nested fields, then, this time, the action df3.except(df4).count gives the following exception : java.lang.IllegalArgumentException: requirement failed: Join keys from two sides should have same types&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13324296">SPARK-32693</key>
            <summary>Compare two dataframes with same schema except nullable property</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="viirya">L. C. Hsieh</assignee>
                                    <reporter username="dbe_75">david bernuau</reporter>
                        <labels>
                    </labels>
                <created>Mon, 24 Aug 2020 15:28:22 +0000</created>
                <updated>Thu, 3 Sep 2020 04:10:12 +0000</updated>
                            <resolved>Fri, 28 Aug 2020 01:37:04 +0000</resolved>
                                    <version>2.4.4</version>
                    <version>3.1.0</version>
                                    <fixVersion>2.4.7</fixVersion>
                    <fixVersion>3.0.2</fixVersion>
                    <fixVersion>3.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17185621" author="apachespark" created="Thu, 27 Aug 2020 06:07:48 +0000"  >&lt;p&gt;User &apos;viirya&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29555&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29555&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17186194" author="maropu" created="Fri, 28 Aug 2020 01:37:04 +0000"  >&lt;p&gt;Resolved by&#160;&lt;a href=&quot;https://github.com/apache/spark/pull/29555&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29555&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17186517" author="dbe_75" created="Fri, 28 Aug 2020 12:44:05 +0000"  >&lt;p&gt;thanks&lt;/p&gt;</comment>
                            <comment id="17186853" author="apachespark" created="Sat, 29 Aug 2020 00:10:36 +0000"  >&lt;p&gt;User &apos;viirya&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29575&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29575&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17186854" author="apachespark" created="Sat, 29 Aug 2020 00:11:33 +0000"  >&lt;p&gt;User &apos;viirya&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29575&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29575&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17186857" author="apachespark" created="Sat, 29 Aug 2020 00:21:26 +0000"  >&lt;p&gt;User &apos;viirya&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29576&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29576&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17186859" author="apachespark" created="Sat, 29 Aug 2020 00:21:57 +0000"  >&lt;p&gt;User &apos;viirya&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29576&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29576&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17187111" author="maropu" created="Sat, 29 Aug 2020 21:56:56 +0000"  >&lt;p&gt;Since the release vote for v3.0.1 (RC3) is on-going now, I set 3.0.2 to &quot;Fix Version/s&quot;. If it fails, I will reset it to 3.0.1.&#160;&lt;/p&gt;</comment>
                            <comment id="17188055" author="maropu" created="Tue, 1 Sep 2020 00:15:10 +0000"  >&lt;p&gt;I changed 3.0.2 to 3.0.1 in &quot;Fix Version/s&quot; because the RC3 vote for v3.0.1 seemed to fail:&#160;&lt;a href=&quot;http://apache-spark-developers-list.1001551.n3.nabble.com/VOTE-Release-Spark-3-0-1-RC3-td30092.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://apache-spark-developers-list.1001551.n3.nabble.com/VOTE-Release-Spark-3-0-1-RC3-td30092.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17188057" author="viirya" created="Tue, 1 Sep 2020 00:17:15 +0000"  >&lt;p&gt;Ok. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maropu&quot; class=&quot;user-hover&quot; rel=&quot;maropu&quot;&gt;maropu&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17189823" author="maropu" created="Thu, 3 Sep 2020 04:09:59 +0000"  >&lt;p&gt;Unfortunately, v3.0.1 does not include this fix...., so I reset it back:&#160;&lt;a href=&quot;http://apache-spark-developers-list.1001551.n3.nabble.com/VOTE-RESULT-Release-Spark-3-0-1-RC3-td30114.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://apache-spark-developers-list.1001551.n3.nabble.com/VOTE-RESULT-Release-Spark-3-0-1-RC3-td30114.html&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 10 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0i1kg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>