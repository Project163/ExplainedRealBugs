<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:09:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-30246] Spark on Yarn External Shuffle Service Memory Leak</title>
                <link>https://issues.apache.org/jira/browse/SPARK-30246</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;In our large busy yarn cluster which deploy Spark external shuffle service as part of YARN NM aux service, we encountered OOM in some NMs.&lt;br/&gt;
after i dump the heap memory and found there are some StremState objects still in heap, but the app which the StreamState belongs to is already finished.&lt;/p&gt;

&lt;p&gt;Here is some relate Figures:&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://raw.githubusercontent.com/012huang/public_source/master/SparkPRFigures/nm_oom.png&quot; width=&quot;100%&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;The heap dump below shows that the memory consumption mainly consists of two parts:&lt;br/&gt;
&lt;b&gt;(1) OneForOneStreamManager (4,429,796,424 (77.11%) bytes)&lt;/b&gt;&lt;br/&gt;
&lt;b&gt;(2) PoolChunk(occupy 1,059,201,712 (18.44%) bytes. )&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://raw.githubusercontent.com/012huang/public_source/master/SparkPRFigures/nm_heap_overview.png&quot; width=&quot;100%&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;dig into the OneForOneStreamManager, there are some StreaStates still remained :&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://raw.githubusercontent.com/012huang/public_source/master/SparkPRFigures/streamState.png&quot; width=&quot;100%&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;


&lt;p&gt;incomming references to StreamState::associatedChannel: &lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://raw.githubusercontent.com/012huang/public_source/master/SparkPRFigures/associatedChannel_incomming_reference.png&quot; width=&quot;100%&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;hadoop 2.7.3&lt;br/&gt;
spark 2.4.3&lt;br/&gt;
jdk 1.8.0_60&lt;/p&gt;</environment>
        <key id="13274300">SPARK-30246</key>
            <summary>Spark on Yarn External Shuffle Service Memory Leak</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="henriquedsg89">Henrique dos Santos Goulart</assignee>
                                    <reporter username="UncleHuang">uncle-huang</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Dec 2019 04:47:50 +0000</created>
                <updated>Sat, 15 Feb 2020 08:29:03 +0000</updated>
                            <resolved>Wed, 15 Jan 2020 21:36:08 +0000</resolved>
                                    <version>2.4.3</version>
                                    <fixVersion>2.4.5</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>Shuffle</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="16999730" author="jfilipiak" created="Thu, 19 Dec 2019 04:26:23 +0000"  >&lt;p&gt;Hello, we are facing similiiar issues at the moment,&lt;/p&gt;

&lt;p&gt;hence I am also looking into this. The cleanup logic seems pretty legitimate. Could you list all the incomming references to StreamState::associatedChannel from your dump.&#160;&lt;/p&gt;

&lt;p&gt;I think its&apos;s either because there is no read timeout on the Network channel (associatedChannel would have incoming references from netty) or the connectionInactive handler isn&apos;t called on read timeouts (that would be a bug in code and not the config and the associatedChannel would have no incoming references from netty).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16999830" author="unclehuang" created="Thu, 19 Dec 2019 08:00:53 +0000"  >&lt;p&gt;hi , &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jfilipiak&quot; class=&quot;user-hover&quot; rel=&quot;jfilipiak&quot;&gt;jfilipiak&lt;/a&gt;, I add a figure about the incomming references to StreamState::associatedChannel above.&lt;/p&gt;</comment>
                            <comment id="16999832" author="unclehuang" created="Thu, 19 Dec 2019 08:02:19 +0000"  >&lt;p&gt;I&apos;m working on this and have added a patch for verification last week, so far it looks good by monitoring streams size and nm&apos;s heap memory usage.  I will add a PR for this after verification.&lt;/p&gt;</comment>
                            <comment id="17000763" author="jfilipiak" created="Fri, 20 Dec 2019 09:39:12 +0000"  >&lt;p&gt;Hi, Feel free to send the PR along later i can double check it.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;You can clearly see the connection is still hold on to by Netty, that probably indicates that this connection doesn&apos;t time out properly.&lt;/p&gt;

&lt;p&gt;Looks like (in your versin 2.4.3)&lt;/p&gt;

&lt;p&gt;org.apache.spark.network.yarn.YarnShuffleService.serviceInit(Configuration)#L185&lt;/p&gt;

&lt;p&gt;initializes TransportContext like this&lt;/p&gt;

&lt;p&gt;TransportContext transportContext = new TransportContext(transportConf, blockHandler);&lt;/p&gt;

&lt;p&gt;leaving closeIdleConnections set to false. and hence your idle connection wouldn&apos;t get closed&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17016348" author="vanzin" created="Wed, 15 Jan 2020 21:36:09 +0000"  >&lt;p&gt;Issue resolved by pull request 27064&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/27064&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/27064&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17018919" author="jfilipiak" created="Sun, 19 Jan 2020 14:26:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vanzin&quot; class=&quot;user-hover&quot; rel=&quot;vanzin&quot;&gt;vanzin&lt;/a&gt; have to disagree, this is the wrong link.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The issue in this task seems to be fixed upstream regardless. Someone added a true, closeIdleConnections to Netty TransportContext constructor.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 43 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z09mzs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>