<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:59:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-23496] Locality of coalesced partitions can be severely skewed by the order of input partitions</title>
                <link>https://issues.apache.org/jira/browse/SPARK-23496</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Example:&lt;/p&gt;

&lt;p&gt;Consider&#160;RDD &quot;R&quot; with 100 partitions, half of which&#160;have locality preference &quot;hostA&quot; and&#160;half&#160;have &quot;hostB&quot;.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Assume&#160;odd-numbered input partitions of R prefer &quot;hostA&quot; and even-numbered prefer &quot;hostB&quot;.&#160;Then R.coalesce(50) will have 25 partitions with preference &quot;hostA&quot; and 25 with &quot;hostB&quot; (even distribution).&lt;/li&gt;
	&lt;li&gt;Assume partitions with index 0-49 of R prefer &quot;hostA&quot; and partitions with index 50-99 prefer &quot;hostB&quot;. Then R.coalesce(50) will have 49 partitions with &quot;hostA&quot; and 1 with &quot;hostB&quot; (extremely skewed distribution).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The algorithm in&#160;&lt;tt&gt;DefaultPartitionCoalescer.setupGroups&lt;/tt&gt;&#160;is responsible for picking preferred locations for coalesced partitions. It analyzes the preferred locations of input partitions. It starts by trying to create one partition for each unique location in the input. However, if the the requested number of coalesced partitions is higher that the number of unique locations, it has to pick duplicate locations.&lt;/p&gt;

&lt;p&gt;Currently, the duplicate locations&#160;are picked by iterating over the input partitions in order, and copying their preferred locations to coalesced partitions. If the input partitions&#160;are clustered by location, this can result in severe skew.&lt;/p&gt;

&lt;p&gt;Instead of iterating over the list of input partitions in order, we should pick them at random.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13140512">SPARK-23496</key>
            <summary>Locality of coalesced partitions can be severely skewed by the order of input partitions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ala.luszczak">Ala Luszczak</assignee>
                                    <reporter username="ala.luszczak">Ala Luszczak</reporter>
                        <labels>
                    </labels>
                <created>Fri, 23 Feb 2018 14:30:16 +0000</created>
                <updated>Mon, 5 Mar 2018 13:33:50 +0000</updated>
                            <resolved>Mon, 5 Mar 2018 13:33:50 +0000</resolved>
                                    <version>3.0.0</version>
                                    <fixVersion>2.4.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16374429" author="apachespark" created="Fri, 23 Feb 2018 14:46:05 +0000"  >&lt;p&gt;User &apos;ala&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/20664&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/20664&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16374439" author="mgaido" created="Fri, 23 Feb 2018 14:52:50 +0000"  >&lt;p&gt;I read that the proposed solution is to use random numbers instead of iterating. This seems to me not as a solution but as a workaround, which doesn&apos;t solve the problem, but it makes it unlikely.&lt;/p&gt;

&lt;p&gt;What about a solutions which does solve the problem, ie. we enforce an even distribution according to the incoming data distribution? I mean, what about creating a sort of reversed index with the preferred location as key and the partition as values and picking from each value list a ratio corresponding to the coalescing ratio?&lt;/p&gt;</comment>
                            <comment id="16374506" author="ala.luszczak" created="Fri, 23 Feb 2018 15:37:27 +0000"  >&lt;p&gt;I agree that this solution is merely making the problem unlikely to occur, instead of really solving it.&lt;/p&gt;

&lt;p&gt;But the code in &lt;tt&gt;DefaultPartitionsCoalescer.setGroups()&lt;/tt&gt; (&lt;a href=&quot;https://github.com/ala/spark/blob/master/core/src/main/scala/org/apache/spark/rdd/CoalescedRDD.scala#L234-L240&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;see comment&lt;/a&gt;) is deliberately written so that it&apos;s fast (O(n log n) with respect to number of coalesced partitions, which is assumed order of magnitude smaller than the number of input partitions), but not necessarily accurate. The same applies to other algorithms there.&lt;/p&gt;

&lt;p&gt;Enforcing an even data distribution is not trivial. For example:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;We merely look at the number of partitions, not on the number of rows in each of the partitions. There might be a severe skew across the partitions to begin with.&lt;/li&gt;
	&lt;li&gt;It&apos;s not clear how to treat partitions with multiple preferred location.&lt;/li&gt;
	&lt;li&gt;It&apos;s not clear if it&apos;s more important for every input location to find some matching coalesced partition, or if it&apos;s more important to keep the partition size even.&lt;/li&gt;
	&lt;li&gt;It&apos;s not clear how best to deal with a mix of partitions with and without locality preferences.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think it&apos;s better to have a very simple fix that will work well vast majority of the time now, and maybe have a follow-up ticked for revisiting the design of &lt;tt&gt;DefaultPartitionCoalescer&lt;/tt&gt; for later.&lt;/p&gt;</comment>
                            <comment id="16374530" author="mgaido" created="Fri, 23 Feb 2018 15:50:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ala.luszczak&quot; class=&quot;user-hover&quot; rel=&quot;ala.luszczak&quot;&gt;ala.luszczak&lt;/a&gt; thanks for your answer. Honestly I don&apos;t see any value in a quick fix and revisiting it later. Since this won&apos;t come in Spark 2.3 and next release won&apos;t be out very soon, I think we have the time to design a final solution now. Anyway, I do agree with the objections you raised, ie. that there are so many factors to take in account that it is hard to define a method which works properly in all conditions. So, the proposed fix might be ok. But I would be happy to hear also opinions from other people in the community about this topic.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 38 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3qix3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311620" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Shepherd</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>hvanhovell</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>