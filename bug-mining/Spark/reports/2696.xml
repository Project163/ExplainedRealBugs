<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:34:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-11500] Not deterministic order of columns when using merging schemas.</title>
                <link>https://issues.apache.org/jira/browse/SPARK-11500</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When executing &lt;/p&gt;

&lt;p&gt;&lt;tt&gt;sqlContext.read.option(&quot;mergeSchema&quot;, &quot;true&quot;).parquet(pathOne, pathTwo).printSchema()&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;The order of columns is not deterministic, showing up in a different order sometimes.&lt;/p&gt;

&lt;p&gt;This is because of &lt;tt&gt;FileStatusCache&lt;/tt&gt; in &lt;tt&gt;HadoopFsRelation&lt;/tt&gt; (which &lt;tt&gt;ParquetRelation&lt;/tt&gt; extends as you know). When &lt;tt&gt;FileStatusCache.listLeafFiles()&lt;/tt&gt; is called, this returns &lt;tt&gt;Set&lt;span class=&quot;error&quot;&gt;&amp;#91;FileStatus&amp;#93;&lt;/span&gt;&lt;/tt&gt; which messes up the order of &lt;tt&gt;Array&lt;span class=&quot;error&quot;&gt;&amp;#91;FileStatus&amp;#93;&lt;/span&gt;&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;So, after retrieving the list of leaf files including &lt;tt&gt;_metadata&lt;/tt&gt; and &lt;tt&gt;_common_metadata&lt;/tt&gt;,  this starts to merge (separately and if necessary) the &lt;tt&gt;Set&lt;/tt&gt; s of &lt;tt&gt;_metadata&lt;/tt&gt;, &lt;tt&gt;_common_metadata&lt;/tt&gt; and part-files in &lt;tt&gt;ParquetRelation.mergeSchemasInParallel()&lt;/tt&gt;, which ends up in the different column order having the leading columns (of the first file) which the other files do not have.&lt;/p&gt;

&lt;p&gt;I think this can be resolved by using &lt;tt&gt;LinkedHashSet&lt;/tt&gt;.&lt;/p&gt;



&lt;p&gt;in a simple view,&lt;br/&gt;
If A file has 1,2,3 fields, and B file column 3,4,5, we can not ensure which column shows first since It is not deterministic.&lt;/p&gt;

&lt;p&gt;1. Read file list (A and B)&lt;/p&gt;

&lt;p&gt;2. Not deterministic order of (A and B or B and A) as I said.&lt;/p&gt;

&lt;p&gt;3. It merges by &lt;tt&gt;reduceOption&lt;/tt&gt; with retrieved schemas of (A and B or B and A), (which maybe also should be &lt;tt&gt;reduceOptionRight&lt;/tt&gt; or &lt;tt&gt;reduceOptionLeft&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;4. The output columns would be 1,2,3,4,5 when A and B, or 3.4.5.1.2 when B and A.&lt;/p&gt;


</description>
                <environment></environment>
        <key id="12910255">SPARK-11500</key>
            <summary>Not deterministic order of columns when using merging schemas.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gurwls223">Hyukjin Kwon</assignee>
                                    <reporter username="gurwls223">Hyukjin Kwon</reporter>
                        <labels>
                    </labels>
                <created>Wed, 4 Nov 2015 06:39:55 +0000</created>
                <updated>Mon, 12 Dec 2022 18:11:08 +0000</updated>
                            <resolved>Wed, 11 Nov 2015 08:46:51 +0000</resolved>
                                                    <fixVersion>1.6.0</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14989203" author="srowen" created="Wed, 4 Nov 2015 09:36:02 +0000"  >&lt;p&gt;Dumb question, but why does the ordering of columns matter here &amp;#8211; is the result incorrect in the intermediate step here or is it just non-deterministic but correct in the output.&lt;/p&gt;

&lt;p&gt;If it does, does &lt;tt&gt;LinkedHashSet&lt;/tt&gt; help? it becomes dependent on insertion order. It could be a sorted collection with some defined order like a &lt;tt&gt;TreeSet&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14989325" author="gurwls223" created="Wed, 4 Nov 2015 10:53:57 +0000"  >&lt;p&gt;It is non-deterministic and also incorrect in the output, which first was found here &lt;a href=&quot;https://github.com/apache/spark/pull/9327#discussion_r43846677&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/9327#discussion_r43846677&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;Also, (I think) the insertion order should be kept not sorted because what we need to do is make this deterministic. In this way, the columns of the first file put in &lt;tt&gt;parquet&lt;/tt&gt; can stay always leading in the output.&lt;/p&gt;

</comment>
                            <comment id="14990172" author="yhuai" created="Wed, 4 Nov 2015 18:54:15 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lian+cheng&quot; class=&quot;user-hover&quot; rel=&quot;lian cheng&quot;&gt;lian cheng&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14992834" author="lian cheng" created="Fri, 6 Nov 2015 01:02:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hyukjin.kwon&quot; class=&quot;user-hover&quot; rel=&quot;hyukjin.kwon&quot;&gt;hyukjin.kwon&lt;/a&gt; Thanks for reporting. Would you like to work on this one?&lt;/p&gt;</comment>
                            <comment id="14992841" author="gurwls223" created="Fri, 6 Nov 2015 01:05:21 +0000"  >&lt;p&gt;Yes please &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14993311" author="apachespark" created="Fri, 6 Nov 2015 07:52:03 +0000"  >&lt;p&gt;User &apos;HyukjinKwon&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/9517&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/9517&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15000122" author="lian cheng" created="Wed, 11 Nov 2015 08:46:51 +0000"  >&lt;p&gt;Issue resolved by pull request 9517&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/9517&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/9517&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15008383" author="gurwls223" created="Tue, 17 Nov 2015 09:42:24 +0000"  >&lt;p&gt;At the end, you were right. Although I didn&apos;t use &lt;tt&gt;TreeSet&lt;/tt&gt;, the file list is sorted. It&apos;s pretty late though. Thanks for the helpful comment.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 1 week ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2nx9z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333083">1.6.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>