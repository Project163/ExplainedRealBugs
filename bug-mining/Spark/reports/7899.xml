<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:25:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-34674] Spark app on k8s doesn&apos;t terminate without call to sparkContext.stop() method</title>
                <link>https://issues.apache.org/jira/browse/SPARK-34674</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Hello!&lt;br/&gt;
 I have run into a problem that if I don&apos;t call the method sparkContext.stop() explicitly, then a Spark driver process doesn&apos;t terminate even after its Main method has been completed. This behaviour is different from spark on yarn, where the manual sparkContext stopping is not required.&lt;br/&gt;
 It looks like, the problem is in using non-daemon threads, which prevent the driver jvm process from terminating.&lt;br/&gt;
 At least I see two non-daemon threads, if I don&apos;t call sparkContext.stop():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[OkHttp kubernetes.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.svc,5,main]
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[OkHttp kubernetes.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.svc Writer,5,main]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Could you tell please, if it is possible to solve this problem?&lt;/p&gt;

&lt;p&gt;Docker image from the&#160;official release of spark-3.1.1 hadoop3.2 is used.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13363273">SPARK-34674</key>
            <summary>Spark app on k8s doesn&apos;t terminate without call to sparkContext.stop() method</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Kotlov">Sergey Kotlov</assignee>
                                    <reporter username="Kotlov">Sergey Kotlov</reporter>
                        <labels>
                    </labels>
                <created>Tue, 9 Mar 2021 13:58:20 +0000</created>
                <updated>Mon, 12 Dec 2022 18:11:04 +0000</updated>
                            <resolved>Thu, 22 Apr 2021 05:54:59 +0000</resolved>
                                    <version>3.1.1</version>
                                    <fixVersion>3.1.2</fixVersion>
                    <fixVersion>3.2.0</fixVersion>
                                    <component>Kubernetes</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17298761" author="gurwls223" created="Wed, 10 Mar 2021 11:40:40 +0000"  >&lt;p&gt;It sounds more like a question. Can you loop Spark mailing list before filing an issue? Also it would be great if you describe how you reproduced this.&lt;/p&gt;</comment>
                            <comment id="17303313" author="kotlov" created="Wed, 17 Mar 2021 11:38:34 +0000"  >&lt;p&gt;Sorry, I didn&apos;t search&#160;sufficiently for existing issues.&lt;/p&gt;

&lt;p&gt;There is already the issue &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-27812&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-27812&lt;/a&gt;, and it is marked as Fixed.&lt;/p&gt;

&lt;p&gt;But it looks like, I have this bug in Spark 3.1.1.&lt;/p&gt;

&lt;p&gt;I just start an spark app on&#160;Amazon EKS (Kubernetes version - 1.17) by&#160;&lt;em&gt;spark-on-k8s-operator: v1beta2-1.2.0-3.0.0&lt;/em&gt;&#160;&lt;a href=&quot;https://github.com/GoogleCloudPlatform/spark-on-k8s-operator&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;(https://github.com/GoogleCloudPlatform/spark-on-k8s-operator)&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Spark docker image is built from the&#160;official release of spark-3.1.1 hadoop3.2.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17304472" author="dongjoon" created="Thu, 18 Mar 2021 21:38:52 +0000"  >&lt;p&gt;I reopen this because the affected version is not the same according to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Kotlov&quot; class=&quot;user-hover&quot; rel=&quot;Kotlov&quot;&gt;Kotlov&lt;/a&gt;. The following is a copy of my comment at the other JIRA.&lt;/p&gt;

&lt;p&gt;1. Does your example work with any Spark versions before? Then, what is the latest Spark version?&lt;br/&gt;
2. BTW, `sparkContext.stop()` or `spark.stop()` should be called by App. I don&apos;t think your use case is a legit Spark example although it might be a behavior change across Spark versions.&lt;/p&gt;</comment>
                            <comment id="17305419" author="kotlov" created="Sat, 20 Mar 2021 12:43:59 +0000"  >&lt;p&gt;Thanks for response, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dongjoon&quot; class=&quot;user-hover&quot; rel=&quot;dongjoon&quot;&gt;dongjoon&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I haven&apos;t tried to use the previous versions of Spark on Kubernetes. Right now my company is using Spark on AWS EMR (it uses YARN), and we have never needed to call spark.stop() there. As far as I know, Spark uses the ShutdownHook to stop SparkContext anyway before exiting the JVM. But in my example, if I understand correctly, these non-daemon threads prevent the jvm process from exiting, even after the Main method of application has been completed. And I just thought, it can be considered as a bug.&lt;br/&gt;
P.S. I have to migrate a large number of existing Spark batch jobs (which are owned by different people across company) from EMR to K8S, and right now it is desirable to keep the code of these jobs unchanged.&lt;/p&gt;</comment>
                            <comment id="17306692" author="dongjoon" created="Tue, 23 Mar 2021 02:06:40 +0000"  >&lt;p&gt;What makes you think like the following, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Kotlov&quot; class=&quot;user-hover&quot; rel=&quot;Kotlov&quot;&gt;Kotlov&lt;/a&gt;? I don&apos;t think Apache Spark has that kind of contracts.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;As far as I know, Spark uses the ShutdownHook to stop SparkContext anyway before exiting the JVM&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="17307398" author="kotlov" created="Tue, 23 Mar 2021 20:20:50 +0000"  >&lt;p&gt;I saw it in the sources. But you are right,&#160;generally I should not rely on the functionality, that is not described in the official documentation.&lt;/p&gt;</comment>
                            <comment id="17307554" author="dongjoon" created="Wed, 24 Mar 2021 04:19:00 +0000"  >&lt;p&gt;Let&apos;s keep this issue open for a while to collect more opinion. We need more information for this issue report.&lt;/p&gt;</comment>
                            <comment id="17309873" author="dongjoon" created="Sat, 27 Mar 2021 05:40:58 +0000"  >&lt;p&gt;I&apos;ll take a look at this during this weekend, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Kotlov&quot; class=&quot;user-hover&quot; rel=&quot;Kotlov&quot;&gt;Kotlov&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17310235" author="kotlov" created="Sun, 28 Mar 2021 16:23:31 +0000"  >&lt;p&gt;Thanks for looking into this problem, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dongjoon&quot; class=&quot;user-hover&quot; rel=&quot;dongjoon&quot;&gt;dongjoon&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;As a temporary solution suitable for my purposes, I just added a finally block that closes SparkContext to &lt;a href=&quot;https://github.com/apache/spark/blob/066c055b526aff5d2c0ace176f8eebf0eeab6f13/core/src/main/scala/org/apache/spark/deploy/SparkSubmit.scala#L950&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this place&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17310268" author="dongjoon" created="Sun, 28 Mar 2021 17:58:31 +0000"  >&lt;p&gt;Could you make a PR to the Apache Spark repo, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Kotlov&quot; class=&quot;user-hover&quot; rel=&quot;Kotlov&quot;&gt;Kotlov&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17316286" author="karlmanong" created="Wed, 7 Apr 2021 12:30:07 +0000"  >&lt;p&gt;I have the same problem, and I submitted a PR: &lt;a href=&quot;https://github.com/apache/spark/pull/32080&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32080&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17316319" author="apachespark" created="Wed, 7 Apr 2021 13:01:07 +0000"  >&lt;p&gt;User &apos;KarlManong&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32080&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32080&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17316694" author="apachespark" created="Wed, 7 Apr 2021 21:24:07 +0000"  >&lt;p&gt;User &apos;kotlovs&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32081&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32081&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17316695" author="apachespark" created="Wed, 7 Apr 2021 21:24:59 +0000"  >&lt;p&gt;User &apos;kotlovs&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32081&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32081&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17316697" author="kotlov" created="Wed, 7 Apr 2021 21:27:29 +0000"  >&lt;p&gt;The fix that I currently use:&#160; &lt;a href=&quot;https://github.com/apache/spark/pull/32081&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32081&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17317545" author="dongjoon" created="Thu, 8 Apr 2021 23:52:21 +0000"  >&lt;p&gt;Issue resolved by pull request 32081&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32081&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32081&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17317648" author="dongjoon" created="Fri, 9 Apr 2021 04:55:04 +0000"  >&lt;p&gt;This is reverted due to the Hive Thrift Server UT failures.&lt;/p&gt;</comment>
                            <comment id="17327054" author="apachespark" created="Thu, 22 Apr 2021 02:18:22 +0000"  >&lt;p&gt;User &apos;kotlovs&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32283&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32283&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17327056" author="apachespark" created="Thu, 22 Apr 2021 02:18:55 +0000"  >&lt;p&gt;User &apos;kotlovs&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32283&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32283&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17327121" author="dongjoon" created="Thu, 22 Apr 2021 05:54:59 +0000"  >&lt;p&gt;Issue resolved by pull request 32283&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32283&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32283&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13235056">SPARK-27812</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 29 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ogfs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>