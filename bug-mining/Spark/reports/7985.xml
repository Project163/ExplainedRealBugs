<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:26:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-35296] Dataset.observe fails with an assertion</title>
                <link>https://issues.apache.org/jira/browse/SPARK-35296</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I hit this assertion error when using dataset.observe:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.AssertionError: assertion failed
	at scala.Predef$.&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt;(Predef.scala:208) ~[scala-library-2.12.10.jar:?]
	at org.apache.spark.sql.execution.AggregatingAccumulator.setState(AggregatingAccumulator.scala:204) ~[spark-sql_2.12-3.1.1.jar:3.1.1]
	at org.apache.spark.sql.execution.CollectMetricsExec.$anonfun$doExecute$2(CollectMetricsExec.scala:72) ~[spark-sql_2.12-3.1.1.jar:3.1.1]
	at org.apache.spark.sql.execution.CollectMetricsExec.$anonfun$doExecute$2$adapted(CollectMetricsExec.scala:71) ~[spark-sql_2.12-3.1.1.jar:3.1.1]
	at org.apache.spark.TaskContext$$anon$1.onTaskCompletion(TaskContext.scala:125) ~[spark-core_2.12-3.1.1.jar:3.1.1]
	at org.apache.spark.TaskContextImpl.$anonfun$markTaskCompleted$1(TaskContextImpl.scala:124) ~[spark-core_2.12-3.1.1.jar:3.1.1]
	at org.apache.spark.TaskContextImpl.$anonfun$markTaskCompleted$1$adapted(TaskContextImpl.scala:124) ~[spark-core_2.12-3.1.1.jar:3.1.1]
	at org.apache.spark.TaskContextImpl.$anonfun$invokeListeners$1(TaskContextImpl.scala:137) ~[spark-core_2.12-3.1.1.jar:3.1.1]
	at org.apache.spark.TaskContextImpl.$anonfun$invokeListeners$1$adapted(TaskContextImpl.scala:135) ~[spark-core_2.12-3.1.1.jar:3.1.1]
	at scala.collection.mutable.ResizableArray.foreach(ResizableArray.scala:62) ~[scala-library-2.12.10.jar:?]
	at scala.collection.mutable.ResizableArray.foreach$(ResizableArray.scala:55) ~[scala-library-2.12.10.jar:?]
	at scala.collection.mutable.ArrayBuffer.foreach(ArrayBuffer.scala:49) ~[scala-library-2.12.10.jar:?]
	at org.apache.spark.TaskContextImpl.invokeListeners(TaskContextImpl.scala:135) ~[spark-core_2.12-3.1.1.jar:3.1.1]
	at org.apache.spark.TaskContextImpl.markTaskCompleted(TaskContextImpl.scala:124) ~[spark-core_2.12-3.1.1.jar:3.1.1]
	at org.apache.spark.scheduler.Task.run(Task.scala:147) ~[spark-core_2.12-3.1.1.jar:3.1.1]
	at org.apache.spark.executor.Executor$TaskRunner.$anonfun$run$3(Executor.scala:497) ~[spark-core_2.12-3.1.1.jar:3.1.1]
	at org.apache.spark.util.Utils$.tryWithSafeFinally(Utils.scala:1439) [spark-core_2.12-3.1.1.jar:3.1.1]
	at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:500) [spark-core_2.12-3.1.1.jar:3.1.1]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_282]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_282]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748) [?:1.8.0_282]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A workaround, that I used was to add .coalesce(1) before calling this method.&lt;/p&gt;

&lt;p&gt;It happens in a quite complex query and I have not been able to reproduce this with a simpler query&lt;/p&gt;

&lt;p&gt;Added an screenshot of the debugger, at the moment of exception&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13024932/13024932_2021-05-03_18-34.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;</description>
                <environment></environment>
        <key id="13376401">SPARK-35296</key>
            <summary>Dataset.observe fails with an assertion</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sarutak">Kousuke Saruta</assignee>
                                    <reporter username="tanelk">Tanel Kiis</reporter>
                        <labels>
                    </labels>
                <created>Mon, 3 May 2021 15:47:36 +0000</created>
                <updated>Thu, 10 Jun 2021 17:23:58 +0000</updated>
                            <resolved>Thu, 10 Jun 2021 17:22:03 +0000</resolved>
                                    <version>3.1.1</version>
                    <version>3.2.0</version>
                                    <fixVersion>3.0.3</fixVersion>
                    <fixVersion>3.2.0</fixVersion>
                    <fixVersion>3.1.3</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17338438" author="tanelk" created="Mon, 3 May 2021 15:55:41 +0000"  >&lt;p&gt;I tried to change an excisting UT to reproduce this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
diff --git a/sql/core/src/test/scala/org/apache/spark/sql/util/DataFrameCallbackSuite.scala b/sql/core/src/test/scala/org/apache/spark/sql/util/DataFrameCallbackSuite.scala
index b3d29df1b2..0fcd31a09c 100644
--- a/sql/core/src/test/scala/org/apache/spark/sql/util/DataFrameCallbackSuite.scala
+++ b/sql/core/src/test/scala/org/apache/spark/sql/util/DataFrameCallbackSuite.scala
@@ -246,7 +246,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;DataFrameCallbackSuite &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; QueryTest
     }
     spark.listenerManager.register(listener)
     &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
-      val df = spark.range(100)
+      val df = spark.range(100).repartition(2)
         .observe(
           name = &lt;span class=&quot;code-quote&quot;&gt;&quot;my_event&quot;&lt;/span&gt;,
           min($&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;).as(&lt;span class=&quot;code-quote&quot;&gt;&quot;min_val&quot;&lt;/span&gt;),
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But did not hit the same exception:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[info] - get observable metrics by callback *** FAILED *** (324 milliseconds)
[info]   0 did not equal 2 (DataFrameCallbackSuite.scala:261)
[info]   org.scalatest.exceptions.TestFailedException:
[info]   at org.scalatest.Assertions.newAssertionFailedException(Assertions.scala:472)
[info]   at org.scalatest.Assertions.newAssertionFailedException$(Assertions.scala:471)
[info]   at org.scalatest.Assertions$.newAssertionFailedException(Assertions.scala:1231)
[info]   at org.scalatest.Assertions$AssertionsHelper.macroAssert(Assertions.scala:1295)
[info]   at org.apache.spark.sql.util.DataFrameCallbackSuite.checkMetrics$1(DataFrameCallbackSuite.scala:261)
[info]   at org.apache.spark.sql.util.DataFrameCallbackSuite.$anonfun$&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;$15(DataFrameCallbackSuite.scala:270)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Although i think that this should not happen either.&lt;/p&gt;</comment>
                            <comment id="17338441" author="tanelk" created="Mon, 3 May 2021 15:57:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hvanhovell&quot; class=&quot;user-hover&quot; rel=&quot;hvanhovell&quot;&gt;hvanhovell&lt;/a&gt; The assertion in AggregatingAccumulator is added by you. Perhaps you have some idea on why it happens. &lt;/p&gt;</comment>
                            <comment id="17338465" author="tanelk" created="Mon, 3 May 2021 16:26:52 +0000"  >&lt;p&gt;I finally managed to change the UT in such way, that the assertion error happens - the following coalesce was the missing link.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
diff --git a/sql/core/src/test/scala/org/apache/spark/sql/util/DataFrameCallbackSuite.scala b/sql/core/src/test/scala/org/apache/spark/sql/util/DataFrameCallbackSuite.scala
index b3d29df1b2..16ebddd75c 100644
--- a/sql/core/src/test/scala/org/apache/spark/sql/util/DataFrameCallbackSuite.scala
+++ b/sql/core/src/test/scala/org/apache/spark/sql/util/DataFrameCallbackSuite.scala
@@ -246,7 +246,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;DataFrameCallbackSuite &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; QueryTest
     }
     spark.listenerManager.register(listener)
     &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
-      val df = spark.range(100)
+      val df = spark.range(0, 100, 1, 5)
         .observe(
           name = &lt;span class=&quot;code-quote&quot;&gt;&quot;my_event&quot;&lt;/span&gt;,
           min($&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;).as(&lt;span class=&quot;code-quote&quot;&gt;&quot;min_val&quot;&lt;/span&gt;),
@@ -256,6 +256,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;DataFrameCallbackSuite &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; QueryTest
         .observe(
           name = &lt;span class=&quot;code-quote&quot;&gt;&quot;other_event&quot;&lt;/span&gt;,
           avg($&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;).&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&quot;&lt;/span&gt;).as(&lt;span class=&quot;code-quote&quot;&gt;&quot;avg_val&quot;&lt;/span&gt;))
+        .coalesce(2)

       def checkMetrics(metrics: Map[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, Row]): Unit = {
         &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt;(metrics.size === 2)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17356253" author="tanelk" created="Thu, 3 Jun 2021 07:39:20 +0000"  >&lt;p&gt;Perhaps someone who knows the internals better, ccould help here. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt;? &lt;br/&gt;
I tried to take another look, but I can&apos;t figure it out.&lt;/p&gt;</comment>
                            <comment id="17357576" author="apachespark" created="Fri, 4 Jun 2021 19:16:29 +0000"  >&lt;p&gt;User &apos;sarutak&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32786&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32786&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17357578" author="apachespark" created="Fri, 4 Jun 2021 19:17:24 +0000"  >&lt;p&gt;User &apos;sarutak&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32786&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32786&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17361108" author="cloud_fan" created="Thu, 10 Jun 2021 17:22:03 +0000"  >&lt;p&gt;Issue resolved by pull request 32786&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32786&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32786&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13024932" name="2021-05-03_18-34.png" size="102579" author="tanelk" created="Mon, 3 May 2021 15:59:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 22 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0qokg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>