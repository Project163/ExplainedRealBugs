<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:58:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-20947] Encoding/decoding issue in PySpark pipe implementation</title>
                <link>https://issues.apache.org/jira/browse/SPARK-20947</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Pipe action convert objects into strings using a way that was affected by the default encoding setting of Python environment.&lt;/p&gt;

&lt;p&gt;Here is the related code fragment (L717-721@python/pyspark/rdd.py):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            def pipe_objs(out):
                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; obj in iterator:
                    s = str(obj).rstrip(&lt;span class=&quot;code-quote&quot;&gt;&apos;\n&apos;&lt;/span&gt;) + &lt;span class=&quot;code-quote&quot;&gt;&apos;\n&apos;&lt;/span&gt;
                    out.write(s.encode(&lt;span class=&quot;code-quote&quot;&gt;&apos;utf-8&apos;&lt;/span&gt;))
                out.close()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The `str(obj)` part implicitly convert `obj` to an unicode string, then encode it into a byte string using default encoding; On the other hand, the `s.encode(&apos;utf-8&apos;)` part implicitly decode `s` into an unicode string using default encoding and then encode it (AGAIN!) into a UTF-8 encoded byte string.&lt;/p&gt;

&lt;p&gt;Typically the default encoding of Python environment would be &apos;ascii&apos;, which means passing  an unicode string containing characters beyond &apos;ascii&apos; charset will raise UnicodeEncodeError exception at `str(obj)` and passing a byte string containing bytes greater than 128 will again raise UnicodeEncodeError exception at &apos;s.encode(&apos;utf-8&apos;)`.&lt;/p&gt;

&lt;p&gt;Changing `str(obj)` to `unicode(obj)` would eliminate these problems.&lt;/p&gt;

&lt;p&gt;The following code snippet reproduces these errors:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Welcome to
      ____              __
     / __/__  ___ _____/ /__
    _\ \/ _ \/ _ `/ __/  &apos;_/
   /__ / .__/\_,_/_/ /_/\_\   version 1.6.3
      /_/

Using Python version 2.7.12 (&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;, Jul 25 2016 15:06:45)
SparkContext available as sc, HiveContext available as sqlContext.
&amp;gt;&amp;gt;&amp;gt; sc.parallelize([u&lt;span class=&quot;code-quote&quot;&gt;&apos;\u6d4b\u8bd5&apos;&lt;/span&gt;]).pipe(&lt;span class=&quot;code-quote&quot;&gt;&apos;cat&apos;&lt;/span&gt;).collect()
[Stage 0:&amp;gt;                                                          (0 + 4) / 4]Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-1:
Traceback (most recent call last):
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/local/Cellar/python/2.7.12/Frameworks/Python.framework/Versions/2.7/lib/python2.7/threading.py&quot;&lt;/span&gt;, line 801, in __bootstrap_inner
    self.run()
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/local/Cellar/python/2.7.12/Frameworks/Python.framework/Versions/2.7/lib/python2.7/threading.py&quot;&lt;/span&gt;, line 754, in run
    self.__target(*self.__args, **self.__kwargs)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/Users/wxz/Downloads/spark-1.6.3-bin-hadoop2.6/python/pyspark/rdd.py&quot;&lt;/span&gt;, line 719, in pipe_objs
    s = str(obj).rstrip(&lt;span class=&quot;code-quote&quot;&gt;&apos;\n&apos;&lt;/span&gt;) + &lt;span class=&quot;code-quote&quot;&gt;&apos;\n&apos;&lt;/span&gt;
UnicodeEncodeError: &lt;span class=&quot;code-quote&quot;&gt;&apos;ascii&apos;&lt;/span&gt; codec can&apos;t encode characters in position 0-1: ordinal not in range(128)
&amp;gt;&amp;gt;&amp;gt;
&amp;gt;&amp;gt;&amp;gt; sc.parallelize([u&lt;span class=&quot;code-quote&quot;&gt;&apos;\u6d4b\u8bd5&apos;&lt;/span&gt;]).map(lambda x: x.encode(&lt;span class=&quot;code-quote&quot;&gt;&apos;utf-8&apos;&lt;/span&gt;)).pipe(&lt;span class=&quot;code-quote&quot;&gt;&apos;cat&apos;&lt;/span&gt;).collect()
Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-1:
Traceback (most recent call last):
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/local/Cellar/python/2.7.12/Frameworks/Python.framework/Versions/2.7/lib/python2.7/threading.py&quot;&lt;/span&gt;, line 801, in __bootstrap_inner
    self.run()
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/local/Cellar/python/2.7.12/Frameworks/Python.framework/Versions/2.7/lib/python2.7/threading.py&quot;&lt;/span&gt;, line 754, in run
    self.__target(*self.__args, **self.__kwargs)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/Users/wxz/Downloads/spark-1.6.3-bin-hadoop2.6/python/pyspark/rdd.py&quot;&lt;/span&gt;, line 720, in pipe_objs
    out.write(s.encode(&lt;span class=&quot;code-quote&quot;&gt;&apos;utf-8&apos;&lt;/span&gt;))
UnicodeDecodeError: &lt;span class=&quot;code-quote&quot;&gt;&apos;ascii&apos;&lt;/span&gt; codec can&apos;t decode &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; 0xe6 in position 0: ordinal not in range(128)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13076417">SPARK-20947</key>
            <summary>Encoding/decoding issue in PySpark pipe implementation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chaoslawful">Xiaozhe Wang</assignee>
                                    <reporter username="chaoslawful">Xiaozhe Wang</reporter>
                        <labels>
                    </labels>
                <created>Thu, 1 Jun 2017 07:36:53 +0000</created>
                <updated>Mon, 12 Dec 2022 18:11:09 +0000</updated>
                            <resolved>Mon, 22 Jan 2018 01:46:37 +0000</resolved>
                                    <version>1.6.0</version>
                    <version>1.6.1</version>
                    <version>1.6.2</version>
                    <version>1.6.3</version>
                    <version>2.0.0</version>
                    <version>2.0.1</version>
                    <version>2.0.2</version>
                    <version>2.1.0</version>
                    <version>2.1.1</version>
                                    <fixVersion>2.4.0</fixVersion>
                                    <component>PySpark</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16032585" author="chaoslawful" created="Thu, 1 Jun 2017 07:41:00 +0000"  >&lt;p&gt;Patch that fixed encode/decode error of pipe action&lt;/p&gt;</comment>
                            <comment id="16046420" author="apachespark" created="Mon, 12 Jun 2017 10:21:03 +0000"  >&lt;p&gt;User &apos;chaoslawful&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/18277&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18277&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16333775" author="gurwls223" created="Mon, 22 Jan 2018 01:46:37 +0000"  >&lt;p&gt;Fixed in &lt;a href=&quot;https://github.com/apache/spark/pull/18277&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18277&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12870750" name="fix-pipe-encoding-error.patch" size="497" author="chaoslawful" created="Thu, 1 Jun 2017 07:41:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 43 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3fqgf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>