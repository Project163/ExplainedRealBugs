<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:48:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-18111] Wrong ApproximatePercentile answer when multiple records have the minimum value</title>
                <link>https://issues.apache.org/jira/browse/SPARK-18111</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When multiple records have the minimum value, the answer of ApproximatePercentile is wrong.&lt;/p&gt;

&lt;p&gt;Suppose we have a table with 12 records and 4 partitions, values of column &quot;col&quot; in these partitions are:&lt;br/&gt;
1, 1, 2&lt;br/&gt;
1, 1, 3&lt;br/&gt;
1, 1, 4&lt;br/&gt;
1, 1, 5&lt;br/&gt;
If we query percentile_approx(col, array(0.5)), the current answer is &quot;5&quot;, which is far from the correct answer &quot;1&quot;.&lt;/p&gt;

&lt;p&gt;The test case is as below:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  test(&lt;span class=&quot;code-quote&quot;&gt;&quot;percentile_approx, multiple records with the minimum value in a partition&quot;&lt;/span&gt;) {
    withTempView(table) {
      spark.sparkContext.makeRDD(Seq(1, 1, 2, 1, 1, 3, 1, 1, 4, 1, 1, 5), 4).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;col&quot;&lt;/span&gt;)
        .createOrReplaceTempView(table)
      checkAnswer(
        spark.sql(s&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT percentile_approx(col, array(0.5)) FROM $table&quot;&lt;/span&gt;),
        Row(Seq(1.0D))
      )
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13015326">SPARK-18111</key>
            <summary>Wrong ApproximatePercentile answer when multiple records have the minimum value</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ZenWzh">Zhenhua Wang</assignee>
                                    <reporter username="ZenWzh">Zhenhua Wang</reporter>
                        <labels>
                    </labels>
                <created>Wed, 26 Oct 2016 06:57:28 +0000</created>
                <updated>Wed, 2 Nov 2016 18:47:34 +0000</updated>
                            <resolved>Tue, 1 Nov 2016 13:13:05 +0000</resolved>
                                    <version>2.0.1</version>
                                    <fixVersion>2.0.3</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15607669" author="apachespark" created="Wed, 26 Oct 2016 07:05:06 +0000"  >&lt;p&gt;User &apos;wzhfy&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15641&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15641&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15608054" author="srowen" created="Wed, 26 Oct 2016 10:09:14 +0000"  >&lt;p&gt;The percentile at 0.5 is the median, and 2 is as good an answer as 1 here. Does this show a bug? If I understand your test case then don&apos;t you want to test on a case like &quot;1 2 2&quot; and show that it returns 1 perhaps? because the median is obviously 2. It is an approximate algorithm, note.&lt;/p&gt;</comment>
                            <comment id="15610192" author="zenwzh" created="Thu, 27 Oct 2016 00:42:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt; The minimum is not only skipped once in the whole data, but &lt;b&gt;skipped per partition&lt;/b&gt;.&lt;br/&gt;
For example, we have two partitions of data: (1, 1, 3, 3) and (5, 5, 7, 7), then when we do global merging, the samples in QuantileSummaries is (1, 3, 3, 5, 7, 7), and the percentiles result returned for query percentile_approx(0.25, 0.5, 0.75) is (3.0, 5.0, 7.0), but the correct answer should be (1.0, 3.0, 5.0). Of course we can say it&apos;s an approximate algorithm, but this error is already &lt;b&gt;beyond the error bound which the algo provides&lt;/b&gt;. And also, we can make the error even larger if we construct more such partitions and thus more skipped minimum elements.&lt;/p&gt;</comment>
                            <comment id="15610948" author="srowen" created="Thu, 27 Oct 2016 07:01:59 +0000"  >&lt;p&gt;You may have a point but this example still doesn&apos;t seem to show it. 3, 5, 7 are as correct as 1, 3, 5, even when computing the &apos;exact&apos; percentiles. In fact the conventional definition of percentiles would say 3, 5, 7 are correct because 25% of the data falls below 3, not 1.&lt;/p&gt;

&lt;p&gt;The PR you show suggests a different problem, that an element gets added twice when it&apos;s the only element in the partition. &lt;/p&gt;</comment>
                            <comment id="15611160" author="zenwzh" created="Thu, 27 Oct 2016 08:28:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt; Sorry for the ambiguous example. I&apos;ve updated the description and used a more obvious example.&lt;br/&gt;
BTW, my pr does address the problem in this jira, with a small change from &quot;currHead.value &amp;lt; head.value&quot; to &quot;currHead.value &amp;lt;= head.value&quot;&lt;/p&gt;</comment>
                            <comment id="15611187" author="srowen" created="Thu, 27 Oct 2016 08:38:53 +0000"  >&lt;p&gt;Yes that&apos;s clear, thank you. Just checking. It really says &apos;5&apos;, not &apos;2&apos;? but both are wrong, yes.&lt;/p&gt;</comment>
                            <comment id="15611229" author="zenwzh" created="Thu, 27 Oct 2016 08:54:13 +0000"  >&lt;p&gt;Yes, it says &apos;5&apos;. Because the samples in QuantileSummaries after the final merging is (1, 2, 3, 4, 5), and the rank of 0.5 percentile is quantile * count, i.e. 0.5 * 12 = 6. The rank is larger than its length, in which case it just returns the last sample.&lt;/p&gt;</comment>
                            <comment id="15611236" author="zenwzh" created="Thu, 27 Oct 2016 08:56:34 +0000"  >&lt;p&gt;Everytime it calls compress(), it will lose one duplicated minimum value.&lt;/p&gt;</comment>
                            <comment id="15625402" author="srowen" created="Tue, 1 Nov 2016 13:13:05 +0000"  >&lt;p&gt;Resolved by &lt;a href=&quot;https://github.com/apache/spark/pull/15641&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15641&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15628309" author="apachespark" created="Wed, 2 Nov 2016 09:15:04 +0000"  >&lt;p&gt;User &apos;wzhfy&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15732&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15732&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13017125">SPARK-18221</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 2 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i35ejb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>