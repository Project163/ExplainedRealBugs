<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:50:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-18857] SparkSQL ThriftServer hangs while extracting huge data volumes in incremental collect mode</title>
                <link>https://issues.apache.org/jira/browse/SPARK-18857</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;We are trying to run a sql query on our spark cluster and extracting around 200 million records through SparkSQL ThriftServer interface. This query works fine for Spark 1.6.3 version, however for spark 2.0.2, thrift server hangs after fetching data from a few partitions (we are using incremental collect mode with 400 partitions). As per documentation max memory taken up by thrift server should be what is required by the biggest data partition. But we observed that Thrift server is not releasing the old partitions memory whenever the GC occurs even though it has moved to next partition data fetches. which is not the case with 1.6.3 version.&lt;/p&gt;

&lt;p&gt;On further investigation we found that SparkExecuteStatementOperation.scala was modified for &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-16563&quot; title=&quot;Repeat calling Spark SQL thrift server fetchResults return empty for ExecuteStatement operation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-16563&quot;&gt;&lt;del&gt;SPARK-16563&lt;/del&gt;&lt;/a&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;SQL&amp;#93;&lt;/span&gt; fix spark sql thrift server FetchResults bug&quot; and result set iterator was duplicated to keep a reference to the first set.&lt;/p&gt;

&lt;p&gt;+      val (itra, itrb) = iter.duplicate&lt;br/&gt;
+      iterHeader = itra&lt;br/&gt;
+      iter = itrb&lt;/p&gt;

&lt;p&gt;We suspect that this is resulting in the memory not being cleared on GC. To confirm this we created an iterator in our test class and fetched the data once without duplicating and second time with creating a duplicate. we could see that in first instance it ran fine and fetched the entire data set while in second instance driver hanged after fetching data from a few partitions.&lt;/p&gt;


</description>
                <environment></environment>
        <key id="13028031">SPARK-18857</key>
            <summary>SparkSQL ThriftServer hangs while extracting huge data volumes in incremental collect mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dongjoon">Dongjoon Hyun</assignee>
                                    <reporter username="vishalagrwal">vishal agrawal</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Dec 2016 08:37:34 +0000</created>
                <updated>Thu, 12 Jan 2017 10:46:00 +0000</updated>
                            <resolved>Tue, 10 Jan 2017 13:28:16 +0000</resolved>
                                    <version>2.0.2</version>
                                    <fixVersion>2.0.3</fixVersion>
                    <fixVersion>2.1.1</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15747691" author="vishalagrwal" created="Wed, 14 Dec 2016 08:42:11 +0000"  >&lt;p&gt;GC logs for 2 spark versions while running the same query&lt;/p&gt;</comment>
                            <comment id="15754166" author="dongjoon" created="Fri, 16 Dec 2016 11:22:56 +0000"  >&lt;p&gt;Thank you for reporting, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vishalagrwal&quot; class=&quot;user-hover&quot; rel=&quot;vishalagrwal&quot;&gt;vishalagrwal&lt;/a&gt;.&lt;br/&gt;
Then, in the Spark side, could you test on Spark 2.0.0 before &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-16563&quot; title=&quot;Repeat calling Spark SQL thrift server fetchResults return empty for ExecuteStatement operation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-16563&quot;&gt;&lt;del&gt;SPARK-16563&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="15760203" author="vishalagrwal" created="Mon, 19 Dec 2016 05:28:11 +0000"  >&lt;p&gt;We are unable to use incremental collect in a spark version before 2.0.2 due the bug spark-18009&lt;/p&gt;

&lt;p&gt;We will have to take 2.0.2 and change this particular class and build from source code.&lt;/p&gt;</comment>
                            <comment id="15778011" author="vishalagrwal" created="Mon, 26 Dec 2016 09:48:34 +0000"  >&lt;p&gt;we have built Spark from 2.0.2 source code by changing SparkExecuteStatementOperation.scala to pre &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-16563&quot; title=&quot;Repeat calling Spark SQL thrift server fetchResults return empty for ExecuteStatement operation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-16563&quot;&gt;&lt;del&gt;SPARK-16563&lt;/del&gt;&lt;/a&gt; version. this version works fine without causing any thrift server issues.&lt;/p&gt;</comment>
                            <comment id="15787428" author="dongjoon" created="Fri, 30 Dec 2016 10:36:29 +0000"  >&lt;p&gt;Thank you for testing and sharing that information!&lt;/p&gt;</comment>
                            <comment id="15787618" author="apachespark" created="Fri, 30 Dec 2016 12:56:04 +0000"  >&lt;p&gt;User &apos;dongjoon-hyun&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/16440&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16440&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15787622" author="dongjoon" created="Fri, 30 Dec 2016 12:58:16 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vishalagrwal&quot; class=&quot;user-hover&quot; rel=&quot;vishalagrwal&quot;&gt;vishalagrwal&lt;/a&gt;.&lt;br/&gt;
I agree with you. This is an important problem.&lt;br/&gt;
At least, I made a PR as a first attempt. In any ways, I hope this will be resolved soon.&lt;/p&gt;</comment>
                            <comment id="15789403" author="srowen" created="Sat, 31 Dec 2016 11:51:58 +0000"  >&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alicegugu&quot; class=&quot;user-hover&quot; rel=&quot;alicegugu&quot;&gt;alicegugu&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15791397" author="dongjoon" created="Sun, 1 Jan 2017 17:25:40 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vishalagrwal&quot; class=&quot;user-hover&quot; rel=&quot;vishalagrwal&quot;&gt;vishalagrwal&lt;/a&gt;.&lt;br/&gt;
Could you test your case with &lt;a href=&quot;https://github.com/apache/spark/pull/16440&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16440&lt;/a&gt; ?&lt;br/&gt;
Although I tried to address the iterator issue you mentioned, it&apos;s a memory issue.&lt;br/&gt;
So, I&apos;m not sure the other parts still consume lots of memory in your case.&lt;/p&gt;</comment>
                            <comment id="15792152" author="vishalagrwal" created="Mon, 2 Jan 2017 04:07:22 +0000"  >&lt;p&gt;thanks. we will test it and confirm.&lt;/p&gt;</comment>
                            <comment id="15792731" author="vishalagrwal" created="Mon, 2 Jan 2017 11:35:11 +0000"  >&lt;p&gt;Thanks. its working fine now for our scenario.&lt;/p&gt;</comment>
                            <comment id="15793668" author="dongjoon" created="Mon, 2 Jan 2017 23:08:35 +0000"  >&lt;p&gt;Thank you for testing and confirming!&lt;/p&gt;</comment>
                            <comment id="15814967" author="srowen" created="Tue, 10 Jan 2017 13:28:17 +0000"  >&lt;p&gt;Issue resolved by pull request 16440&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/16440&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16440&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15817170" author="dongjoon" created="Wed, 11 Jan 2017 04:55:22 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt;.&lt;br/&gt;
This is a bug existing 2.0.2 and 2.1.X.&lt;br/&gt;
I&apos;ll create a backport for this issue.&lt;/p&gt;</comment>
                            <comment id="15817178" author="dongjoon" created="Wed, 11 Jan 2017 04:58:19 +0000"  >&lt;p&gt;Or, could you cherry-pick that please?&lt;br/&gt;
When I try to cherry-pick for branch-2.0 and branch-2.1, there was no problem.&lt;/p&gt;</comment>
                            <comment id="15817924" author="srowen" created="Wed, 11 Jan 2017 10:28:58 +0000"  >&lt;p&gt;I think it&apos;s probably OK, if it&apos;s a significant problem, and we have a targeted, tested fix here.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12989681">SPARK-16563</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12843184" name="GC-spark-1.6.3" size="9522" author="vishalagrwal" created="Wed, 14 Dec 2016 08:42:11 +0000"/>
                            <attachment id="12843185" name="GC-spark-2.0.2" size="7162" author="vishalagrwal" created="Wed, 14 Dec 2016 08:42:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 44 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i37kxb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>