<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:56:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-22083] When dropping multiple blocks to disk, Spark should release all locks on a failure</title>
                <link>https://issues.apache.org/jira/browse/SPARK-22083</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;&lt;tt&gt;MemoryStore.evictBlocksToFreeSpace&lt;/tt&gt; first &lt;a href=&quot;https://github.com/apache/spark/blob/55d5fa79db883e4d93a9c102a94713c9d2d1fb55/core/src/main/scala/org/apache/spark/storage/memory/MemoryStore.scala#L520&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;acquires writer locks on all the blocks it intends to evict &lt;/a&gt;.  However, if there is an exception while dropping blocks, there is no &lt;tt&gt;finally&lt;/tt&gt; block to release all the locks.&lt;/p&gt;

&lt;p&gt;If there is only one block being dropped, this isn&apos;t a problem (probably).  Usually the call stack goes from &lt;tt&gt;MemoryStore.evictBlocksToFreeSpace --&amp;gt; dropBlocks --&amp;gt; BlockManager.dropFromMemory --&amp;gt; DiskStore.put&lt;/tt&gt;.  And &lt;tt&gt;DiskStore.put&lt;/tt&gt; does do a &lt;a href=&quot;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/storage/DiskStore.scala#L83&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;removeBlock()&lt;/tt&gt; in a &lt;tt&gt;finally&lt;/tt&gt; block&lt;/a&gt;, which cleans up the locks.&lt;/p&gt;

&lt;p&gt;I ran into this from the serialization issue in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-21928&quot; title=&quot;ClassNotFoundException for custom Kryo registrator class during serde in netty threads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-21928&quot;&gt;&lt;del&gt;SPARK-21928&lt;/del&gt;&lt;/a&gt;.  In that, a netty thread ends up trying to evict some blocks from memory to disk, and fails.  When there is only one block that needs to be evicted, and the error occurs, there isn&apos;t any real problem; I assume that netty thread is dead, but the executor threads seem fine.  However, in the cases where two blocks get dropped, one task gets completely stuck.  Unfortunately I don&apos;t have a stack trace from the stuck executor, but I assume it just waits forever on this lock that never gets released.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13103808">SPARK-22083</key>
            <summary>When dropping multiple blocks to disk, Spark should release all locks on a failure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="irashid">Imran Rashid</assignee>
                                    <reporter username="irashid">Imran Rashid</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 Sep 2017 04:09:13 +0000</created>
                <updated>Tue, 3 Oct 2017 06:10:50 +0000</updated>
                            <resolved>Mon, 25 Sep 2017 19:09:34 +0000</resolved>
                                    <version>2.1.1</version>
                    <version>2.2.0</version>
                                    <fixVersion>2.1.2</fixVersion>
                    <fixVersion>2.1.3</fixVersion>
                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>2.3.0</fixVersion>
                                    <component>Block Manager</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16175309" author="apachespark" created="Thu, 21 Sep 2017 19:18:04 +0000"  >&lt;p&gt;User &apos;squito&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19311&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19311&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16176902" author="irashid" created="Fri, 22 Sep 2017 18:34:51 +0000"  >&lt;p&gt;After another look at this, I&apos;m actually not sure why we didn&apos;t see problems when we were only dropping one block.  Though there is a finally block in &lt;tt&gt;DiskStore.put()&lt;/tt&gt;, that just calls &lt;tt&gt;DiskStore.remove()&lt;/tt&gt;, not &lt;tt&gt;BlockInfoManager.removeBlock() / unlock()&lt;/tt&gt;, so the lock should still be held.  I guess just luck that an executor task thread wasn&apos;t stuck trying to get the lock.&lt;/p&gt;

&lt;p&gt;I feel like the lock management needs another review, there seems to be an implicit assumption that block management is always done by task threads, but its also done by netty threads as blocks get promoted to or evicted from memory.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13099975">SPARK-21928</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 8 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3kc07:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>