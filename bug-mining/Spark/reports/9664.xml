<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:42:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-48105]  Fix the data corruption issue when state store unload and snapshotting happens concurrently for HDFS state store</title>
                <link>https://issues.apache.org/jira/browse/SPARK-48105</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;There are two race conditions between state store snapshotting and state store unloading which could result in query failure and potential data corruption.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Case 1:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;the maintenance thread pool encounters some issues and call the &lt;a href=&quot;https://github.com/apache/spark/blob/d9d79a54a3cd487380039c88ebe9fa708e0dcf23/sql/core/src/main/scala/org/apache/spark/sql/execution/streaming/state/StateStore.scala#L774&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;stopMaintenanceTask,&lt;/a&gt; this function further calls &lt;a href=&quot;https://github.com/apache/spark/blob/master/sql/core/src/main/scala/org/apache/spark/sql/execution/streaming/state/StateStore.scala#L587&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;threadPool.stop.&lt;/a&gt; However, this function doesn&apos;t wait for the stop operation to be completed and move to do the state store &lt;a href=&quot;https://github.com/apache/spark/blob/d9d79a54a3cd487380039c88ebe9fa708e0dcf23/sql/core/src/main/scala/org/apache/spark/sql/execution/streaming/state/StateStore.scala#L775-L778&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;unload and clear.&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;the provider unload will &lt;a href=&quot;https://github.com/apache/spark/blob/master/sql/core/src/main/scala/org/apache/spark/sql/execution/streaming/state/StateStore.scala#L719-L721&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;close the state store&lt;/a&gt; which &lt;a href=&quot;https://github.com/apache/spark/blob/master/sql/core/src/main/scala/org/apache/spark/sql/execution/streaming/state/HDFSBackedStateStoreProvider.scala#L353-L355&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;clear the values of loadedMaps&lt;/a&gt; for HDFS backed state store.&lt;/li&gt;
	&lt;li&gt;if the not-yet-stop maintenance thread is still running and trying to do the snapshot, but the data in the underlying `HDFSBackedStateStoreMap` has been removed. if this snapshot process completes successfully, then we will write corrupted data and the following batches will consume this corrupted data.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Case 2:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;In executor_1, the maintenance thread is going to do the snapshot for state_store_1, it retrieves the `HDFSBackedStateStoreMap` object from the loadedMaps, after this, the maintenance thread &lt;a href=&quot;https://github.com/apache/spark/blob/c6696cdcd611a682ebf5b7a183e2970ecea3b58c/sql/core/src/main/scala/org/apache/spark/sql/execution/streaming/state/HDFSBackedStateStoreProvider.scala#L750-L751&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;releases the lock of the loadedMaps&lt;/a&gt;.&lt;/li&gt;
	&lt;li&gt;state_store_1 is loaded in another executor, e.g. executor_2.&lt;/li&gt;
	&lt;li&gt;another state store, state_store_2, is loaded on executor_1 and &lt;a href=&quot;https://github.com/apache/spark/blob/master/sql/core/src/main/scala/org/apache/spark/sql/execution/streaming/state/StateStore.scala#L854-L871&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;reportActiveStoreInstance&lt;/a&gt; to driver.&lt;/li&gt;
	&lt;li&gt;executor_1 does the &lt;a href=&quot;https://github.com/apache/spark/blob/c6696cdcd611a682ebf5b7a183e2970ecea3b58c/sql/core/src/main/scala/org/apache/spark/sql/execution/streaming/state/StateStore.scala#L713&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;unload&lt;/a&gt; for those no longer active state store which clears the data entries in the `HDFSBackedStateStoreMap`&lt;/li&gt;
	&lt;li&gt;the snapshotting thread is terminated and uploads the incomplete snapshot to cloud because the &lt;a href=&quot;https://github.com/apache/spark/blob/c6696cdcd611a682ebf5b7a183e2970ecea3b58c/sql/core/src/main/scala/org/apache/spark/sql/execution/streaming/state/HDFSBackedStateStoreProvider.scala#L634&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;iterator doesn&apos;t have next element&lt;/a&gt; after doing the clear.&lt;/li&gt;
	&lt;li&gt;future batches are consuming the corrupted data.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Proposed fix:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;When we close the hdfs state store, we should only remove the entry from `loadedMaps` rather than doing the active data cleanup. JVM GC should be able to help us GC those objects.&lt;/li&gt;
	&lt;li&gt;we should wait for the maintenance thread to stop before unloading the providers.&#160;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anishshri-db&quot; class=&quot;user-hover&quot; rel=&quot;anishshri-db&quot;&gt;anishshri-db&lt;/a&gt; for helping debug this issue!&lt;/p&gt;</description>
                <environment></environment>
        <key id="13578020">SPARK-48105</key>
            <summary> Fix the data corruption issue when state store unload and snapshotting happens concurrently for HDFS state store</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="huanli.wang">Huanli Wang</assignee>
                                    <reporter username="huanli.wang">Huanli Wang</reporter>
                        <labels>
                            <label>correctness</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 3 May 2024 03:12:40 +0000</created>
                <updated>Thu, 23 May 2024 04:10:40 +0000</updated>
                            <resolved>Tue, 7 May 2024 00:53:43 +0000</resolved>
                                    <version>3.5.2</version>
                    <version>3.4.4</version>
                    <version>4.0.0</version>
                                    <fixVersion>3.5.2</fixVersion>
                    <fixVersion>3.4.4</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                    <component>Structured Streaming</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17843123" author="JIRAUSER287599" created="Fri, 3 May 2024 05:45:27 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=huanli.wang&quot; class=&quot;user-hover&quot; rel=&quot;huanli.wang&quot;&gt;huanli.wang&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Worth noting that we believe that this also fixes the stream-stream join null pointer issue - &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-31754&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-31754&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This was effectively happening due to the same state data loss/corruption scenarios explained above&lt;/p&gt;

&lt;p&gt;cc - &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kabhwan&quot; class=&quot;user-hover&quot; rel=&quot;kabhwan&quot;&gt;kabhwan&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17844072" author="kabhwan" created="Tue, 7 May 2024 00:53:43 +0000"  >&lt;p&gt;Issue resolved via &lt;a href=&quot;https://github.com/apache/spark/pull/46351&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/46351&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13305809">SPARK-31754</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 27 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1p0ao:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>