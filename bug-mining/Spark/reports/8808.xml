<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:31:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-41049] Nondeterministic expressions have unstable values if they are children of CodegenFallback expressions</title>
                <link>https://issues.apache.org/jira/browse/SPARK-41049</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;h2&gt;&lt;a name=&quot;Expectation&quot;&gt;&lt;/a&gt;Expectation&lt;/h2&gt;

&lt;p&gt;For a given row, Nondeterministic expressions are expected to have stable values.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.functions._
&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; df = sparkContext.parallelize(1 to 5).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;x&quot;&lt;/span&gt;)
&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; v1 = rand().*(lit(10000)).cast(IntegerType)
df.select(v1, v1).collect&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Returns a set like this:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;8777&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;8777&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1357&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1357&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;3435&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;3435&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;9204&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;9204&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;3870&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;3870&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;where both columns always have the same value, but what that value is changes from row to row. This is different from the following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
df.select(rand(), rand()).collect&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In this case, because the rand() calls are distinct, the values in both columns should be different.&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;Problem&quot;&gt;&lt;/a&gt;Problem&lt;/h2&gt;

&lt;p&gt;This expectation does not appear to be stable in the event that any subsequent expression is a CodegenFallback. This program:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql._
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.types._
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.functions._

&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; sparkSession = SparkSession.builder().getOrCreate()
&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; df = sparkSession.sparkContext.parallelize(1 to 5).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;x&quot;&lt;/span&gt;)
&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; v1 = rand().*(lit(10000)).cast(IntegerType)
&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; v2 = to_csv(struct(v1.as(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;))) &lt;span class=&quot;code-comment&quot;&gt;// to_csv is CodegenFallback
&lt;/span&gt;df.select(v1, v1, v2, v2).collect &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;produces output like this:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;8159&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;8159&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;8159&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#ff0000&quot;&gt;2028&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;8320&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;8320&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;8320&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#ff0000&quot;&gt;1640&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;7937&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;7937&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;7937&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#ff0000&quot;&gt;769&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;436&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;436&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;436&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#ff0000&quot;&gt;8924&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;8924&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;8924&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2827&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;font color=&quot;#ff0000&quot;&gt;2731&lt;/font&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Not sure why the first call via the CodegenFallback path should be correct while subsequent calls aren&apos;t.&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;Workaround&quot;&gt;&lt;/a&gt;Workaround&lt;/h2&gt;

&lt;p&gt;If the Nondeterministic expression is moved to a separate, earlier select() call, so the CodegenFallback instead only refers to a column reference, then the problem seems to go away. But this workaround may not be reliable if optimization is ever able to restructure adjacent select()s.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13499656">SPARK-41049</key>
            <summary>Nondeterministic expressions have unstable values if they are children of CodegenFallback expressions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cloud_fan">Wenchen Fan</assignee>
                                    <reporter username="gboo">Guy Boo</reporter>
                        <labels>
                            <label>correctness</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 8 Nov 2022 11:25:27 +0000</created>
                <updated>Thu, 30 May 2024 00:16:23 +0000</updated>
                            <resolved>Sat, 31 Dec 2022 02:05:57 +0000</resolved>
                                    <version>3.1.2</version>
                                    <fixVersion>3.4.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17648792" author="apachespark" created="Fri, 16 Dec 2022 20:51:51 +0000"  >&lt;p&gt;User &apos;NarekDW&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/39097&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/39097&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17652396" author="apachespark" created="Wed, 28 Dec 2022 07:04:16 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/39248&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/39248&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17653241" author="cloud_fan" created="Sat, 31 Dec 2022 02:05:57 +0000"  >&lt;p&gt;Issue resolved by pull request 39248&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/39248&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/39248&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17653978" author="apachespark" created="Tue, 3 Jan 2023 12:29:23 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/39364&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/39364&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17654132" author="xkrogen" created="Tue, 3 Jan 2023 18:23:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; &#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gboo&quot; class=&quot;user-hover&quot; rel=&quot;gboo&quot;&gt;gboo&lt;/a&gt;&#160; I think this should be tagged as a &apos;correctness&apos; issue, do you agree?&lt;/p&gt;</comment>
                            <comment id="17655433" author="JIRAUSER298186" created="Fri, 6 Jan 2023 12:44:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xkrogen&quot; class=&quot;user-hover&quot; rel=&quot;xkrogen&quot;&gt;xkrogen&lt;/a&gt; I&apos;ve added the &quot;correctness&quot; label.&lt;/p&gt;</comment>
                            <comment id="17655516" author="xkrogen" created="Fri, 6 Jan 2023 16:52:08 +0000"  >&lt;p&gt;Thanks! &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; &#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=viirya&quot; class=&quot;user-hover&quot; rel=&quot;viirya&quot;&gt;viirya&lt;/a&gt;&#160; shall we backport this to branch-3.3 and branch-3.2, given it is a correctness bug?&lt;/p&gt;</comment>
                            <comment id="17655532" author="viirya" created="Fri, 6 Jan 2023 18:02:12 +0000"  >&lt;p&gt;For a correctness bug, I think we should backport it, though the patch is a kind of refactoring work.&lt;/p&gt;</comment>
                            <comment id="17675646" author="xkrogen" created="Wed, 11 Jan 2023 16:34:04 +0000"  >&lt;p&gt;Thanks for the input &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=viirya&quot; class=&quot;user-hover&quot; rel=&quot;viirya&quot;&gt;viirya&lt;/a&gt;! &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt;, will you work on putting together a PR for the other branches? I would guess that it&apos;s not a trivial cherry-pick given the size of the change.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 43 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1bnjs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>