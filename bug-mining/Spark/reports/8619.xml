<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:30:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-39184] ArrayIndexOutOfBoundsException for some date/time sequences in some time-zones</title>
                <link>https://issues.apache.org/jira/browse/SPARK-39184</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;The following query gets an &lt;tt&gt;ArrayIndexOutOfBoundsException&lt;/tt&gt; when run from the &lt;tt&gt;America/Los_Angeles&lt;/tt&gt; time-zone:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;spark-sql&amp;gt; select sequence(timestamp&apos;2022-03-13 00:00:00&apos;, timestamp&apos;2022-03-16 03:00:00&apos;, interval 1 day 1 hour) as x;
22/05/13 14:47:27 ERROR SparkSQLDriver: Failed in [select sequence(timestamp&apos;2022-03-13 00:00:00&apos;, timestamp&apos;2022-03-16 03:00:00&apos;, interval 1 day 1 hour) as x]
java.lang.ArrayIndexOutOfBoundsException: 3
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In fact, any such query will get an &lt;tt&gt;ArrayIndexOutOfBoundsException&lt;/tt&gt; if the start-stop period in your time-zone includes more instances of &quot;spring forward&quot; than instances of &quot;fall back&quot; and the start-stop period is evenly divisible by the interval.&lt;/p&gt;

&lt;p&gt;In the &lt;tt&gt;America/Los_Angeles&lt;/tt&gt; time-zone, examples include:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;-- This query encompasses 2 instances of &quot;spring forward&quot; but only one
-- instance of &quot;fall back&quot;.
select sequence(
  timestamp&apos;2022-03-13&apos;,
  timestamp&apos;2022-03-13&apos; + (interval &apos;42&apos; hours * 209),
  interval &apos;42&apos; hours) as x;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;select sequence(
  timestamp&apos;2022-03-13&apos;,
  timestamp&apos;2022-03-13&apos; + (interval &apos;31&apos; hours * 11),
  interval &apos;31&apos; hours) as x;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13444915">SPARK-39184</key>
            <summary>ArrayIndexOutOfBoundsException for some date/time sequences in some time-zones</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bersprockets">Bruce Robbins</assignee>
                                    <reporter username="bersprockets">Bruce Robbins</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 May 2022 22:05:48 +0000</created>
                <updated>Mon, 29 Aug 2022 01:45:43 +0000</updated>
                            <resolved>Tue, 16 Aug 2022 08:57:02 +0000</resolved>
                                    <version>3.1.3</version>
                    <version>3.2.1</version>
                    <version>3.3.0</version>
                    <version>3.4.0</version>
                                    <fixVersion>3.1.4</fixVersion>
                    <fixVersion>3.3.1</fixVersion>
                    <fixVersion>3.2.3</fixVersion>
                    <fixVersion>3.4.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17536913" author="bersprockets" created="Fri, 13 May 2022 22:07:21 +0000"  >&lt;p&gt;I will take a stab at fixing this when the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-37544&quot; title=&quot;sequence over dates with month interval is producing incorrect results&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-37544&quot;&gt;&lt;del&gt;SPARK-37544&lt;/del&gt;&lt;/a&gt; is merged (which is changing code in the same area).&lt;/p&gt;</comment>
                            <comment id="17537252" author="bersprockets" created="Sun, 15 May 2022 18:59:07 +0000"  >&lt;p&gt;Some notes on what is happening.&lt;/p&gt;

&lt;p&gt;Let&apos;s take this small reproduction example (this fails in the &lt;tt&gt;America/Los_Angeles&lt;/tt&gt; time-zone):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;select sequence(
  timestamp&apos;2022-03-13 00:00:00&apos;,
  timestamp&apos;2022-03-14 01:00:00&apos;,
  interval 1 day 1 hour) as x;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This produces the error:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.ArrayIndexOutOfBoundsException: 1
	at scala.runtime.ScalaRunTime$.array_update(ScalaRunTime.scala:77) ~[scala-library.jar:?]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The following shows what is happening (essentially), using Scala code that can be pasted into the REPL:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;import java.time._
import java.time.temporal.ChronoUnit._

val zid = ZoneId.of(&quot;America/Los_Angeles&quot;)
val startZdt = ZonedDateTime.of(LocalDateTime.of(2022, 3, 13, 0, 0, 0, 0), zid)
val stopZdt = ZonedDateTime.of(LocalDateTime.of(2022, 3, 14, 1, 0, 0, 0), zid)

val interval = Duration.ofDays(1).plusHours(1)
print(interval.toHours)
// prints 25

// the diff between the start and stop is 24 hours, because 2022-03-13 has
// only 23 hours in the America/Los_Angeles time-zone due to &quot;Spring Forward&quot;
val hours = startZdt.until(stopZdt, HOURS)
println(hours)
// prints 24

// this is how InternalSequenceBase estimates the size of the result array
// (it actually uses micros, but we&apos;re just scaling to hours for simplicity here).
// This calculates a single element
print((hours/interval.toHours) + 1)
// prints 1

// InternalSequenceBase thinks it only needs one array element because if you add
// 25 hours to &apos;2022-03-13 00:00:00&apos;, you get &apos;2022-03-14 02:00:00&apos;, which is greater
// than the stop value.
// To show that, we add 25 hours to the start value
println(startZdt.plusHours(25))
// prints 2022-03-14T02:00-07:00[America/Los_Angeles]

// However, when calculating the value to put in each element, InternalSequenceBase
// doesn&apos;t add 25 hours to the previous value (or start value). It instead
// adds 1 day and 1 hour. That gives you &apos;2022-03-14 01:00:00&apos;, which is equal to the
// stop value (and thus should be included).
// As a result, we blow past the end of the pre-allocated array.
println(startZdt.plusDays(1).plusHours(1))
// prints 2022-03-14T01:00-07:00[America/Los_Angeles]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17579429" author="apachespark" created="Sun, 14 Aug 2022 16:24:28 +0000"  >&lt;p&gt;User &apos;bersprockets&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/37513&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/37513&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17580176" author="maxgekk" created="Tue, 16 Aug 2022 08:57:33 +0000"  >&lt;p&gt;Resolved by &lt;a href=&quot;https://github.com/apache/spark/pull/37513&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/37513&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17580519" author="apachespark" created="Wed, 17 Aug 2022 01:25:18 +0000"  >&lt;p&gt;User &apos;bersprockets&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/37542&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/37542&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17580521" author="apachespark" created="Wed, 17 Aug 2022 01:26:27 +0000"  >&lt;p&gt;User &apos;bersprockets&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/37542&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/37542&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17596153" author="apachespark" created="Sun, 28 Aug 2022 16:21:03 +0000"  >&lt;p&gt;User &apos;bersprockets&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/37699&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/37699&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 11 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z12cu8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>