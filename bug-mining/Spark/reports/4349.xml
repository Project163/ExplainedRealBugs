<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:49:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-17822] JVMObjectTracker.objMap may leak JVM objects</title>
                <link>https://issues.apache.org/jira/browse/SPARK-17822</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;JVMObjectTracker.objMap is used to track JVM objects for SparkR. However, we observed that JVM objects that are not used anymore are still trapped in this map, which prevents those object get GCed. &lt;/p&gt;

&lt;p&gt;Seems it makes sense to use weak reference (like persistentRdds in SparkContext). &lt;/p&gt;</description>
                <environment></environment>
        <key id="13010355">SPARK-17822</key>
            <summary>JVMObjectTracker.objMap may leak JVM objects</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mengxr">Xiangrui Meng</assignee>
                                    <reporter username="yhuai">Yin Huai</reporter>
                        <labels>
                    </labels>
                <created>Fri, 7 Oct 2016 03:52:38 +0000</created>
                <updated>Thu, 23 Feb 2017 19:36:25 +0000</updated>
                            <resolved>Fri, 9 Dec 2016 15:52:15 +0000</resolved>
                                                    <fixVersion>2.0.3</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                    <component>SparkR</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="15565374" author="apachespark" created="Tue, 11 Oct 2016 13:13:05 +0000"  >&lt;p&gt;User &apos;techaddict&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15433&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15433&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15626684" author="rxin" created="Tue, 1 Nov 2016 21:10:58 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=felixcheung&quot; class=&quot;user-hover&quot; rel=&quot;felixcheung&quot;&gt;felixcheung&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shivaram&quot; class=&quot;user-hover&quot; rel=&quot;shivaram&quot;&gt;shivaram&lt;/a&gt; can one of the R guys take this? It seems like pretty severe.&lt;/p&gt;</comment>
                            <comment id="15627846" author="felixcheung" created="Wed, 2 Nov 2016 05:52:52 +0000"  >&lt;p&gt;I don&apos;t have a good handle on what actually is the problem. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhuai&quot; class=&quot;user-hover&quot; rel=&quot;yhuai&quot;&gt;yhuai&lt;/a&gt; could you give us some pointers?&lt;/p&gt;</comment>
                            <comment id="15629313" author="yhuai" created="Wed, 2 Nov 2016 15:32:32 +0000"  >&lt;p&gt;Basically, the problem that I have observed is a long running Spark driver runs out of memory because JVMObjectTracker.objMap prevents objects that are not used anymore from getting GCed. I am attaching a screenshot which shows the objects inside the map.&lt;/p&gt;</comment>
                            <comment id="15631612" author="felixcheung" created="Thu, 3 Nov 2016 05:10:41 +0000"  >&lt;p&gt;I see. Is it possible that the R object is alive? Does running gc in R help?&lt;br/&gt;
&lt;a href=&quot;https://stat.ethz.ch/R-manual/R-devel/library/base/html/gc.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stat.ethz.ch/R-manual/R-devel/library/base/html/gc.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It would be great if there is a way you could share what the R code looks like.&lt;/p&gt;
</comment>
                            <comment id="15644875" author="shivaram" created="Mon, 7 Nov 2016 17:58:34 +0000"  >&lt;p&gt;Yeah just to provide some more context, every time an object is added to the JVMObjectTracker we correspondingly make a note of it on the R side (in a map called .validJobjs&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;). &lt;br/&gt;
This map and correspondingly the JVM side objects should get cleared up when the object gets GC&apos;d R&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;. &lt;/p&gt;

&lt;p&gt;I think there are two possibilities here - one is the R side actually is holding on to these references and not clearing them. The other is that the GC messages from R to JVM is somehow not working as expected.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhuai&quot; class=&quot;user-hover&quot; rel=&quot;yhuai&quot;&gt;yhuai&lt;/a&gt; If we give you some debug scripts can you run them on the R side before the crash ?&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/spark/blob/daa975f4bfa4f904697bf3365a4be9987032e490/R/pkg/R/jobj.R#L43&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/daa975f4bfa4f904697bf3365a4be9987032e490/R/pkg/R/jobj.R#L43&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/spark/blob/daa975f4bfa4f904697bf3365a4be9987032e490/R/pkg/R/jobj.R#L90&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/daa975f4bfa4f904697bf3365a4be9987032e490/R/pkg/R/jobj.R#L90&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15713604" author="josephkb" created="Fri, 2 Dec 2016 01:02:49 +0000"  >&lt;p&gt;I&apos;ve been able to observe something like this bug by creating a DataFrame in SparkR and calling sql queries on it repeatedly.  Java objects from these duplicate queries start to collect in JVMObjectTracker.  But those Java objects do get GCed periodically.  And calling gc() in R completely cleans them up.&lt;/p&gt;

&lt;p&gt;The periodic GC I saw only occurred when I ran R commands, so perhaps it is not triggered as frequently as we&#8217;d like.  I&apos;m not that familiar with SparkR internals, but is there a good way to make this happen?&lt;/p&gt;</comment>
                            <comment id="15713646" author="josephkb" created="Fri, 2 Dec 2016 01:24:17 +0000"  >&lt;p&gt;Since 2.1 is underway and this is not a regression, I&apos;ll shift the target.&lt;/p&gt;</comment>
                            <comment id="15716690" author="mengxr" created="Fri, 2 Dec 2016 22:13:14 +0000"  >&lt;p&gt;I will take a look.&lt;/p&gt;</comment>
                            <comment id="15717723" author="felixcheung" created="Sat, 3 Dec 2016 08:39:36 +0000"  >&lt;p&gt;From what &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=josephkb&quot; class=&quot;user-hover&quot; rel=&quot;josephkb&quot;&gt;josephkb&lt;/a&gt; observed and described, I suspect this is a case of small pointers in R holding larger memory/classes in JVM.&lt;/p&gt;

&lt;p&gt;If the memory footprint of the pointer in R is very small, chances are even after thousands of iterations the memory consumption in R is still not high enough to trigger a GC to reclaim. If we have a repro, calling gc() or gcinfo(TRUE) should tell us about memory consumption as it grows.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure about the previous attempt to mitigate this with WeakReference though - since we don&apos;t know which of the R object is still being referenced, once we remove the JVM object, and the R pointer could become a dangling pointer.&lt;/p&gt;

&lt;p&gt;And perhaps then this could be helped by increasing the aggressiveness of R GC:&lt;br/&gt;
&lt;a href=&quot;https://stat.ethz.ch/R-manual/R-devel/library/base/html/Memory.htm&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stat.ethz.ch/R-manual/R-devel/library/base/html/Memory.htm&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://adv-r.had.co.nz/memory.html#gc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://adv-r.had.co.nz/memory.html#gc&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15722886" author="mengxr" created="Mon, 5 Dec 2016 17:59:06 +0000"  >&lt;p&gt;The issue comes with multiple RBackend connections. It is feasible to create multiple RBackend sessions. But they share the same `JVMObjectTracker`. It cannot tell which JVM object is from which RBackend. If an RBackend died without proper cleaning, we got a memory leak.&lt;/p&gt;

&lt;p&gt;I will send a PR to make JVMObjectTracker a member variable of RBackend. There should be more TODOs to allow concurrent RBackend sessions. But this would help solve the most critical issue.&lt;/p&gt;</comment>
                            <comment id="15723342" author="apachespark" created="Mon, 5 Dec 2016 20:50:06 +0000"  >&lt;p&gt;User &apos;mengxr&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/16154&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16154&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15735647" author="mengxr" created="Fri, 9 Dec 2016 15:52:17 +0000"  >&lt;p&gt;Issue resolved by pull request 16154&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/16154&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16154&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310060">
                    <name>Container</name>
                                            <outwardlinks description="contains">
                                        <issuelink>
            <issuekey id="13010360">SPARK-17823</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13010360">SPARK-17823</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12836592" name="screenshot-1.png" size="883446" author="yhuai" created="Wed, 2 Nov 2016 15:28:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 49 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i34jzz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12338608">2.0.3</customfieldvalue>
    <customfieldvalue id="12335644">2.1.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>