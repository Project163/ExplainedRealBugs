<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:27:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-7233] ClosureCleaner#clean blocks concurrent job submitter threads</title>
                <link>https://issues.apache.org/jira/browse/SPARK-7233</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;&lt;tt&gt;org.apache.spark.util.ClosureCleaner#clean&lt;/tt&gt; method contains logic to determine if Spark is run in interpreter mode: &lt;a href=&quot;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/util/ClosureCleaner.scala#L120&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/util/ClosureCleaner.scala#L120&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;While this behavior is indeed valuable in particular situations, in addition to this it causes concurrent submitter threads to be blocked on a native call to &lt;tt&gt;java.lang.Class#forName0&lt;/tt&gt; since it appears only 1 thread at a time can make the call.&lt;/p&gt;

&lt;p&gt;This becomes a major issue when you have multiple threads concurrently submitting short-lived jobs. This is one of the patterns how we use Spark in production, and the number of parallel requests is expected to be quite high, up to a couple of thousand at a time.&lt;/p&gt;

&lt;p&gt;A typical stacktrace of a blocked thread looks like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;http-bio-8091-exec-14 [BLOCKED] [DAEMON]

java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName0(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;) &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.java (&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt;)
java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;) &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.java:260
org.apache.spark.util.ClosureCleaner$.clean(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;) ClosureCleaner.scala:122
org.apache.spark.SparkContext.clean(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;) SparkContext.scala:1623
org.apache.spark.rdd.RDD.reduce(Function2) RDD.scala:883
org.apache.spark.rdd.RDD.takeOrdered(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, Ordering) RDD.scala:1240
org.apache.spark.api.java.JavaRDDLike$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;takeOrdered(JavaRDDLike, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, Comparator) JavaRDDLike.scala:586
org.apache.spark.api.java.AbstractJavaRDDLike.takeOrdered(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, Comparator) JavaRDDLike.scala:46
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12825911">SPARK-7233</key>
            <summary>ClosureCleaner#clean blocks concurrent job submitter threads</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="preeze">Oleksii Kostyliev</assignee>
                                    <reporter username="preeze">Oleksii Kostyliev</reporter>
                        <labels>
                    </labels>
                <created>Wed, 29 Apr 2015 11:35:48 +0000</created>
                <updated>Fri, 15 May 2015 18:24:29 +0000</updated>
                            <resolved>Fri, 15 May 2015 18:24:29 +0000</resolved>
                                    <version>1.3.1</version>
                    <version>1.4.0</version>
                                    <fixVersion>1.4.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14519169" author="preeze" created="Wed, 29 Apr 2015 11:38:47 +0000"  >&lt;p&gt;To illustrate the issue, I performed a test against local Spark.&lt;br/&gt;
Attached is the screenshot from the Threads view in Yourkit profiler.&lt;br/&gt;
The test was generating only 20 concurrent requests.&lt;br/&gt;
As you can see, job submitter threads mainly spend their time being blocked by each other.&lt;/p&gt;</comment>
                            <comment id="14520202" author="pwendell" created="Wed, 29 Apr 2015 20:46:28 +0000"  >&lt;p&gt;Thanks this is a great find. As a simple fix, can we just check once whether we are in the interpreter? It will be either true or not for an entire JVM lifetime.&lt;/p&gt;</comment>
                            <comment id="14520211" author="andrewor14" created="Wed, 29 Apr 2015 20:49:28 +0000"  >&lt;p&gt;Yes, it can be a static field since that part is pretty isolated and doesn&apos;t have to be in the `clean` method. Great find.&lt;/p&gt;</comment>
                            <comment id="14520232" author="andrewor14" created="Wed, 29 Apr 2015 21:02:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=preeze&quot; class=&quot;user-hover&quot; rel=&quot;preeze&quot;&gt;preeze&lt;/a&gt; would you like to submit a patch for this? If not, I can take it up.&lt;/p&gt;</comment>
                            <comment id="14520368" author="pwendell" created="Wed, 29 Apr 2015 22:01:14 +0000"  >&lt;p&gt;I think we should just create a lazy val in Utils that tells you whether you are in the repl. This will also be needed by &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-7261&quot; title=&quot;Change default log level to WARN in the REPL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-7261&quot;&gt;&lt;del&gt;SPARK-7261&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14521134" author="preeze" created="Thu, 30 Apr 2015 08:34:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andrewor14&quot; class=&quot;user-hover&quot; rel=&quot;andrewor14&quot;&gt;andrewor14&lt;/a&gt; With pleasure but afraid I won&apos;t be able to start with it in the nearest 2 weeks. If you feel you can do it earlier, I would ask you to take this up, please!&lt;/p&gt;

&lt;p&gt;My brief list of the ways to fix it included:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;making this boolean &lt;tt&gt;inInterpreter&lt;/tt&gt; part of the SparkContext and initializing it during SparkContext creation. I assume the same SparkContext can&apos;t be reused from both REPL and non-REPL envs.&lt;/li&gt;
	&lt;li&gt;introducing an env variable to indicate if we want to enable REPL-mode detection.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The suggestion by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pwendell&quot; class=&quot;user-hover&quot; rel=&quot;pwendell&quot;&gt;pwendell&lt;/a&gt; with lazy val in Utils does seem to be simpler and more concise since REPL presence can be indeed detected once per JVM lifespan.&lt;/p&gt;</comment>
                            <comment id="14521154" author="preeze" created="Thu, 30 Apr 2015 08:53:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andrewor14&quot; class=&quot;user-hover&quot; rel=&quot;andrewor14&quot;&gt;andrewor14&lt;/a&gt; This got priority on our side as well, so I am starting with the patch right now.&lt;/p&gt;</comment>
                            <comment id="14522987" author="apachespark" created="Fri, 1 May 2015 09:34:17 +0000"  >&lt;p&gt;User &apos;preeze&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/5835&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/5835&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12729145" name="blocked_threads_closurecleaner.png" size="195173" author="preeze" created="Wed, 29 Apr 2015 11:38:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 29 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2e2on:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12329359">1.4.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>