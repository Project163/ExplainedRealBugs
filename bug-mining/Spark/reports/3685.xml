<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:44:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-15822] segmentation violation in o.a.s.unsafe.types.UTF8String </title>
                <link>https://issues.apache.org/jira/browse/SPARK-15822</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Executors fail with segmentation violation while running application with&lt;br/&gt;
spark.memory.offHeap.enabled true&lt;br/&gt;
spark.memory.offHeap.size 512m&lt;/p&gt;

&lt;p&gt;Also now reproduced with &lt;br/&gt;
spark.memory.offHeap.enabled false&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;#
# A fatal error has been detected by the Java Runtime Environment:
#
#  SIGSEGV (0xb) at pc=0x00007f4559b4d4bd, pid=14182, tid=139935319750400
#
# JRE version: OpenJDK Runtime Environment (8.0_91-b14) (build 1.8.0_91-b14)
# Java VM: OpenJDK 64-Bit Server VM (25.91-b14 mixed mode linux-amd64 compressed oops)
# Problematic frame:
# J 4816 C2 org.apache.spark.unsafe.types.UTF8String.compareTo(Lorg/apache/spark/unsafe/types/UTF8String;)I (64 bytes) @ 0x00007f4559b4d4bd [0x00007f4559b4d460+0x5d]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We initially saw this on IBM java on PowerPC box but is recreatable on linux with OpenJDK. On linux with IBM Java 8 we see a null pointer exception at the same code point:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;16/06/08 11:14:58 ERROR Executor: Exception in task 1.0 in stage 5.0 (TID 48)
java.lang.NullPointerException
	at org.apache.spark.unsafe.types.UTF8String.compareTo(UTF8String.java:831)
	at org.apache.spark.unsafe.types.UTF8String.compare(UTF8String.java:844)
	at org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIterator.findNextInnerJoinRows$(Unknown Source)
	at org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIterator.processNext(Unknown Source)
	at org.apache.spark.sql.execution.BufferedRowIterator.hasNext(BufferedRowIterator.java:43)
	at org.apache.spark.sql.execution.WholeStageCodegenExec$$anonfun$doExecute$2$$anon$2.hasNext(WholeStageCodegenExec.scala:377)
	at scala.collection.Iterator$$anon$11.hasNext(Iterator.scala:408)
	at scala.collection.convert.Wrappers$IteratorWrapper.hasNext(Wrappers.scala:30)
	at org.spark_project.guava.collect.Ordering.leastOf(Ordering.java:664)
	at org.apache.spark.util.collection.Utils$.takeOrdered(Utils.scala:37)
	at org.apache.spark.rdd.RDD$$anonfun$takeOrdered$1$$anonfun$30.apply(RDD.scala:1365)
	at org.apache.spark.rdd.RDD$$anonfun$takeOrdered$1$$anonfun$30.apply(RDD.scala:1362)
	at org.apache.spark.rdd.RDD$$anonfun$mapPartitions$1$$anonfun$apply$23.apply(RDD.scala:757)
	at org.apache.spark.rdd.RDD$$anonfun$mapPartitions$1$$anonfun$apply$23.apply(RDD.scala:757)
	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)
	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:318)
	at org.apache.spark.rdd.RDD.iterator(RDD.scala:282)
	at org.apache.spark.scheduler.ResultTask.runTask(ResultTask.scala:70)
	at org.apache.spark.scheduler.Task.run(Task.scala:85)
	at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:274)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1153)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
	at java.lang.Thread.run(Thread.java:785)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;linux amd64&lt;/p&gt;

&lt;p&gt;openjdk version &quot;1.8.0_91&quot;&lt;br/&gt;
OpenJDK Runtime Environment (build 1.8.0_91-b14)&lt;br/&gt;
OpenJDK 64-Bit Server VM (build 25.91-b14, mixed mode)&lt;/p&gt;</environment>
        <key id="12976818">SPARK-15822</key>
            <summary>segmentation violation in o.a.s.unsafe.types.UTF8String </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hvanhovell">Herman van H&#246;vell</assignee>
                                    <reporter username="robbinspg">Peter George Robbins</reporter>
                        <labels>
                    </labels>
                <created>Wed, 8 Jun 2016 10:43:43 +0000</created>
                <updated>Mon, 27 Mar 2017 21:48:38 +0000</updated>
                            <resolved>Fri, 17 Jun 2016 05:27:58 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="15320380" author="robbinspg" created="Wed, 8 Jun 2016 11:04:58 +0000"  >&lt;p&gt;I&apos;m investigating this and will attach the app and config later&lt;/p&gt;</comment>
                            <comment id="15323781" author="apachespark" created="Fri, 10 Jun 2016 03:02:03 +0000"  >&lt;p&gt;User &apos;hvanhovell&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/13589&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/13589&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15324331" author="robbinspg" created="Fri, 10 Jun 2016 11:50:09 +0000"  >&lt;p&gt;I&apos;m still looking into this tracing back through the code using Memory Analyzer on the core dumps.&lt;/p&gt;

&lt;p&gt;Currently on the stack we have the following generated code&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; generate(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references) {
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GeneratedIterator(references);
}

&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;GeneratedIterator &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; org.apache.spark.sql.execution.BufferedRowIterator {
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; sort_needToSort;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.SortExec sort_plan;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.UnsafeExternalRowSorter sort_sorter;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.executor.TaskMetrics sort_metrics;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; scala.collection.Iterator&amp;lt;UnsafeRow&amp;gt; sort_sortedIter;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_initAgg;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_bufIsNull;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_bufValue;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.aggregate.HashAggregateExec agg_plan;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.UnsafeFixedWidthAggregationMap agg_hashMap;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.UnsafeKVExternalSorter agg_sorter;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.unsafe.KVIterator agg_mapIter;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric agg_peakMemory;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric agg_spillSize;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; scala.collection.Iterator inputadapter_input;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UnsafeRow agg_result;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder agg_holder;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter agg_rowWriter;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UnsafeRow agg_result1;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder agg_holder1;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter agg_rowWriter1;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric sort_numOutputRows;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric sort_aggTime;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric sort_peakMemory;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric sort_spillSize;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric sort_sortTime;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; GeneratedIterator(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references) {
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.references = references;
}

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void init(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; index, scala.collection.Iterator inputs[]) {
partitionIndex = index;
sort_needToSort = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sort_plan = (org.apache.spark.sql.execution.SortExec) references[0];
sort_sorter = sort_plan.createSorter();
sort_metrics = org.apache.spark.TaskContext.get().taskMetrics();

agg_initAgg = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;

&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_plan = (org.apache.spark.sql.execution.aggregate.HashAggregateExec) references[1];

&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_peakMemory = (org.apache.spark.sql.execution.metric.SQLMetric) references[2];
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_spillSize = (org.apache.spark.sql.execution.metric.SQLMetric) references[3];
inputadapter_input = inputs[0];
agg_result = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow(2);
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_holder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder(agg_result, 64);
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_rowWriter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(agg_holder, 2);
agg_result1 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow(3);
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_holder1 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder(agg_result1, 64);
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_rowWriter1 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(agg_holder1, 3);
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sort_numOutputRows = (org.apache.spark.sql.execution.metric.SQLMetric) references[4];
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sort_aggTime = (org.apache.spark.sql.execution.metric.SQLMetric) references[5];
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sort_peakMemory = (org.apache.spark.sql.execution.metric.SQLMetric) references[6];
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sort_spillSize = (org.apache.spark.sql.execution.metric.SQLMetric) references[7];
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sort_sortTime = (org.apache.spark.sql.execution.metric.SQLMetric) references[8];
}

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void agg_doAggregateWithKeys() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
agg_hashMap = agg_plan.createHashMap();

&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (inputadapter_input.hasNext()) {
InternalRow inputadapter_row = (InternalRow) inputadapter_input.next();
&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; inputadapter_isNull = inputadapter_row.isNullAt(0);
UTF8String inputadapter_value = inputadapter_isNull ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (inputadapter_row.getUTF8String(0));
&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; inputadapter_isNull1 = inputadapter_row.isNullAt(1);
UTF8String inputadapter_value1 = inputadapter_isNull1 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (inputadapter_row.getUTF8String(1));
&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; inputadapter_value2 = inputadapter_row.getLong(2);

UnsafeRow agg_unsafeRowAggBuffer = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
org.apache.spark.sql.execution.vectorized.ColumnarBatch.Row agg_vectorizedAggBuffer = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_vectorizedAggBuffer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;// generate grouping key
&lt;/span&gt;agg_holder.reset();

agg_rowWriter.zeroOutNullBytes();

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (inputadapter_isNull) {
agg_rowWriter.setNullAt(0);
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
agg_rowWriter.write(0, inputadapter_value);
}

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (inputadapter_isNull1) {
agg_rowWriter.setNullAt(1);
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
agg_rowWriter.write(1, inputadapter_value1);
}
agg_result.setTotalSize(agg_holder.totalSize());
&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_value6 = 42;

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!inputadapter_isNull) {
agg_value6 = org.apache.spark.unsafe.hash.Murmur3_x86_32.hashUnsafeBytes(inputadapter_value.getBaseObject(), inputadapter_value.getBaseOffset(), inputadapter_value.numBytes(), agg_value6);
}

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!inputadapter_isNull1) {
agg_value6 = org.apache.spark.unsafe.hash.Murmur3_x86_32.hashUnsafeBytes(inputadapter_value1.getBaseObject(), inputadapter_value1.getBaseOffset(), inputadapter_value1.numBytes(), agg_value6);
}
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to get the buffer from hash map
&lt;/span&gt;agg_unsafeRowAggBuffer =
agg_hashMap.getAggregationBufferFromUnsafeRow(agg_result, agg_value6);
}
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_unsafeRowAggBuffer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_sorter == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
agg_sorter = agg_hashMap.destructAndCreateExternalSorter();
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
agg_sorter.merge(agg_hashMap.destructAndCreateExternalSorter());
}

&lt;span class=&quot;code-comment&quot;&gt;// the hash map had be spilled, it should have enough memory now,
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;  to allocate buffer again.
&lt;/span&gt;agg_unsafeRowAggBuffer =
agg_hashMap.getAggregationBufferFromUnsafeRow(agg_result, agg_value6);
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_unsafeRowAggBuffer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;// failed to allocate the first page
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; OutOfMemoryError(&lt;span class=&quot;code-quote&quot;&gt;&quot;No enough memory &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; aggregation&quot;&lt;/span&gt;);
}
}
}

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_vectorizedAggBuffer != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;// update vectorized row
&lt;/span&gt;
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;// update unsafe row
&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;// common sub-expressions
&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;// evaluate aggregate function
&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value10 = agg_unsafeRowAggBuffer.getLong(0);

&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value9 = -1L;
agg_value9 = agg_value10 + inputadapter_value2;
&lt;span class=&quot;code-comment&quot;&gt;// update unsafe row buffer
&lt;/span&gt;agg_unsafeRowAggBuffer.setLong(0, agg_value9);

}
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldStop()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
}

agg_mapIter = agg_plan.finishAggregate(agg_hashMap, agg_sorter, agg_peakMemory, agg_spillSize);
}

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void sort_addToSorter() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_initAgg) {
agg_initAgg = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; sort_beforeAgg = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.nanoTime();
agg_doAggregateWithKeys();
sort_aggTime.add((&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.nanoTime() - sort_beforeAgg) / 1000000);
}

&lt;span class=&quot;code-comment&quot;&gt;// output the result
&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (agg_mapIter.next()) {
sort_numOutputRows.add(1);
UnsafeRow agg_aggKey = (UnsafeRow) agg_mapIter.getKey();
UnsafeRow agg_aggBuffer = (UnsafeRow) agg_mapIter.getValue();

&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull11 = agg_aggKey.isNullAt(0);
UTF8String agg_value12 = agg_isNull11 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (agg_aggKey.getUTF8String(0));
&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull12 = agg_aggKey.isNullAt(1);
UTF8String agg_value13 = agg_isNull12 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (agg_aggKey.getUTF8String(1));
&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value14 = agg_aggBuffer.getLong(0);

agg_holder1.reset();

agg_rowWriter1.zeroOutNullBytes();

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_isNull11) {
agg_rowWriter1.setNullAt(0);
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
agg_rowWriter1.write(0, agg_value12);
}

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_isNull12) {
agg_rowWriter1.setNullAt(1);
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
agg_rowWriter1.write(1, agg_value13);
}

agg_rowWriter1.write(2, agg_value14);
agg_result1.setTotalSize(agg_holder1.totalSize());
sort_sorter.insertRow((UnsafeRow)agg_result1);

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldStop()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
}

agg_mapIter.close();
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_sorter == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
agg_hashMap.free();
}

}

&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void processNext() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sort_needToSort) {
&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; sort_spillSizeBefore = sort_metrics.memoryBytesSpilled();
sort_addToSorter();
sort_sortedIter = sort_sorter.sort();
sort_sortTime.add(sort_sorter.getSortTimeNanos() / 1000000);
sort_peakMemory.add(sort_sorter.getPeakMemoryUsage());
sort_spillSize.add(sort_metrics.memoryBytesSpilled() - sort_spillSizeBefore);
sort_metrics.incPeakExecutionMemory(sort_sorter.getPeakMemoryUsage());
sort_needToSort = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
}

&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (sort_sortedIter.hasNext()) {
UnsafeRow sort_outputRow = (UnsafeRow)sort_sortedIter.next();

append(sort_outputRow);

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldStop()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
}
}
}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;the agg_mapiter is return a key and value of Unsafe rows &lt;br/&gt;
key:&lt;br/&gt;
baseObject null&lt;br/&gt;
baseOffset 140362032947276&lt;br/&gt;
numFields 2&lt;br/&gt;
sizeInBytes 40&lt;br/&gt;
butSetWidthInBytes 8&lt;/p&gt;

&lt;p&gt;ie. it is corrupt and value is similarly corrupt&lt;/p&gt;

&lt;p&gt;Now investigating at which point the corruption occurred&lt;/p&gt;</comment>
                            <comment id="15324341" author="aroberts" created="Fri, 10 Jun 2016 12:07:23 +0000"  >&lt;p&gt;Note that this segv happens regardless of spark.memory.offHeap being set and only with spark-submit (so not --master local&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;)&lt;/p&gt;</comment>
                            <comment id="15324352" author="aroberts" created="Fri, 10 Jun 2016 12:15:07 +0000"  >&lt;p&gt;The comment for baseOffset which has the corrupt value suggests this is only used with read and readExternal, this definition exists in a variety of places and I think its used here in sql/core/src/main/scala/org/apache/spark/sql/execution/joins/HashedRelation.scala.&lt;/p&gt;

&lt;p&gt;HashedRelation&apos;s read method looks interesting so I&apos;m going to investigate here (perhaps this is what Pete will find using Memory Analyzer anyway).&lt;/p&gt;</comment>
                            <comment id="15324455" author="hvanhovell" created="Fri, 10 Jun 2016 13:29:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aroberts&quot; class=&quot;user-hover&quot; rel=&quot;aroberts&quot;&gt;aroberts&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=robbinspg&quot; class=&quot;user-hover&quot; rel=&quot;robbinspg&quot;&gt;robbinspg&lt;/a&gt; Can you share a reproducible example? Then I can join the debugging effort on my side.&lt;/p&gt;</comment>
                            <comment id="15324475" author="aroberts" created="Fri, 10 Jun 2016 13:45:46 +0000"  >&lt;p&gt;Herman, here&apos;s the application, note my HashedRelation comment is only a theory at this stage (edit: now looks irrelevant)&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.SparkConf
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.DataFrame
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.functions._

object SQLFlights {
  def displayTop(title: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, df: DataFrame) {
    println(title);
    df.sort(desc(&lt;span class=&quot;code-quote&quot;&gt;&quot;rank&quot;&lt;/span&gt;)).take(10).foreach(println)
  }

  def main(args: Array[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;]) {
    val inputfile = args(0)
    val airport = args(1)

    val conf = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SparkConf().setAppName(&lt;span class=&quot;code-quote&quot;&gt;&quot;SQL Flights&quot;&lt;/span&gt;)
    val sqlContext = org.apache.spark.sql.SparkSession.builder.config(conf).getOrCreate()

    val df = sqlContext.read.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;com.databricks.spark.csv&quot;&lt;/span&gt;)
        .option(&lt;span class=&quot;code-quote&quot;&gt;&quot;header&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;)
        .option(&lt;span class=&quot;code-quote&quot;&gt;&quot;inferSchema&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;)
        .load(inputfile)
        .cache()

    val arrivals = df.filter(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Dest = &lt;span class=&quot;code-quote&quot;&gt;&apos;$airport&apos;&lt;/span&gt;&quot;&lt;/span&gt;).cache();
    val departures = df.filter(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Origin = &lt;span class=&quot;code-quote&quot;&gt;&apos;$airport&apos;&lt;/span&gt;&quot;&lt;/span&gt;).cache();
    val departuresByCarrier = departures.groupBy(&lt;span class=&quot;code-quote&quot;&gt;&quot;Dest&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;UniqueCarrier&quot;&lt;/span&gt;).count().withColumnRenamed(&lt;span class=&quot;code-quote&quot;&gt;&quot;count&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;total&quot;&lt;/span&gt;)
    val a = departures.filter(&lt;span class=&quot;code-quote&quot;&gt;&quot;Cancelled != 0 and CancellationCode = &lt;span class=&quot;code-quote&quot;&gt;&apos;A&apos;&lt;/span&gt;&quot;&lt;/span&gt;)
    println(&lt;span class=&quot;code-quote&quot;&gt;&quot;done a&quot;&lt;/span&gt;)
    val b = a.groupBy(&lt;span class=&quot;code-quote&quot;&gt;&quot;Dest&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;UniqueCarrier&quot;&lt;/span&gt;).count()
    println(&lt;span class=&quot;code-quote&quot;&gt;&quot;done b&quot;&lt;/span&gt;)
    val c = b.join(departuresByCarrier, Seq(&lt;span class=&quot;code-quote&quot;&gt;&quot;Dest&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;UniqueCarrier&quot;&lt;/span&gt;))
    println(&lt;span class=&quot;code-quote&quot;&gt;&quot;done c&quot;&lt;/span&gt;)
    val d = c.selectExpr(&lt;span class=&quot;code-quote&quot;&gt;&quot;Dest&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;UniqueCarrier&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;round(count * 100 / total, 2) as rank&quot;&lt;/span&gt;)
    println(&lt;span class=&quot;code-quote&quot;&gt;&quot;done d&quot;&lt;/span&gt;)
    displayTop(&lt;span class=&quot;code-quote&quot;&gt;&quot;Top Departure Carrier Cancellations:&quot;&lt;/span&gt;, d)
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;in conf/spark-env.sh:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;export SPARK_WORKER_CORES=2
export SPARK_WORKER_INSTANCES=2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;in conf/spark-defaults.conf:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;spark.sql.warehouse.dir /home/aroberts/sql-flights
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Submit including --packages com.databricks:spark-csv_2.11:1.4.0&lt;/p&gt;

&lt;p&gt;The job will complete but if you look in the $SPARK_HOME/work dir you&apos;ll see that after our queries are done, executors will die due to the segv and by looking in the stderr files we can see the problem.&lt;/p&gt;

&lt;p&gt;Data set to use as the first arg can be downloaded at &lt;a href=&quot;http://stat-computing.org/dataexpo/2009/2008.csv.bz2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stat-computing.org/dataexpo/2009/2008.csv.bz2&lt;/a&gt; (after extracting we can do head -1000000 to create a smaller file and still get the problem without waiting so long).&lt;/p&gt;

&lt;p&gt;As the second arg you can use ORD as the airport name.&lt;/p&gt;</comment>
                            <comment id="15324506" author="robbinspg" created="Fri, 10 Jun 2016 14:16:41 +0000"  >&lt;p&gt;generated SMJ code from the stack:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; generate(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references) {
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GeneratedIterator(references);
}

&lt;span class=&quot;code-comment&quot;&gt;/*wholestagecodegen_c1*/&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;GeneratedIterator &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; org.apache.spark.sql.execution.BufferedRowIterator {
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; scala.collection.Iterator smj_leftInput;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; scala.collection.Iterator smj_rightInput;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; InternalRow smj_leftRow;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; InternalRow smj_rightRow;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UTF8String smj_value4;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UTF8String smj_value5;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; java.util.ArrayList smj_matches;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UTF8String smj_value6;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UTF8String smj_value7;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UTF8String smj_value8;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; smj_isNull4;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UTF8String smj_value9;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; smj_isNull5;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; smj_value10;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric smj_numOutputRows;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UnsafeRow smj_result;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder smj_holder;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter smj_rowWriter;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UnsafeRow project_result;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder project_holder;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter project_rowWriter;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; GeneratedIterator(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references) {
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.references = references;
}

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void init(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; index, scala.collection.Iterator inputs[]) {
partitionIndex = index;
smj_leftInput = inputs[0];
smj_rightInput = inputs[1];

smj_rightRow = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;

smj_matches = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; java.util.ArrayList();

&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.smj_numOutputRows = (org.apache.spark.sql.execution.metric.SQLMetric) references[0];
smj_result = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow(6);
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.smj_holder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder(smj_result, 128);
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.smj_rowWriter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(smj_holder, 6);
project_result = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow(3);
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.project_holder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder(project_result, 64);
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.project_rowWriter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(project_holder, 3);
}

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; findNextInnerJoinRows(
scala.collection.Iterator leftIter,
scala.collection.Iterator rightIter) {
smj_leftRow = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; comp = 0;
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (smj_leftRow == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!leftIter.hasNext()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
smj_leftRow = (InternalRow) leftIter.next();
&lt;span class=&quot;code-comment&quot;&gt;/*smj_c1*/&lt;/span&gt;
&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; smj_isNull = smj_leftRow.isNullAt(0);
UTF8String smj_value = smj_isNull ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (smj_leftRow.getUTF8String(0));
&lt;span class=&quot;code-comment&quot;&gt;/*smj_c2*/&lt;/span&gt;
&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; smj_isNull1 = smj_leftRow.isNullAt(1);
UTF8String smj_value1 = smj_isNull1 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (smj_leftRow.getUTF8String(1));
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (smj_isNull || smj_isNull1) {
smj_leftRow = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
}
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!smj_matches.isEmpty()) {
comp = 0;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comp == 0) {
comp = smj_value.compare(smj_value6);
}
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comp == 0) {
comp = smj_value1.compare(smj_value7);
}

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comp == 0) {
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
}
smj_matches.clear();
}

&lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; {
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (smj_rightRow == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!rightIter.hasNext()) {
smj_value6 = smj_value;

smj_value7 = smj_value1;

&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; !smj_matches.isEmpty();
}
smj_rightRow = (InternalRow) rightIter.next();
&lt;span class=&quot;code-comment&quot;&gt;/*smj_c3*/&lt;/span&gt;
&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; smj_isNull2 = smj_rightRow.isNullAt(0);
UTF8String smj_value2 = smj_isNull2 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (smj_rightRow.getUTF8String(0));
&lt;span class=&quot;code-comment&quot;&gt;/*smj_c4*/&lt;/span&gt;
&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; smj_isNull3 = smj_rightRow.isNullAt(1);
UTF8String smj_value3 = smj_isNull3 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (smj_rightRow.getUTF8String(1));
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (smj_isNull2 || smj_isNull3) {
smj_rightRow = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
}

smj_value4 = smj_value2;

smj_value5 = smj_value3;

}

comp = 0;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comp == 0) {
comp = smj_value.compare(smj_value4);
}
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comp == 0) {
comp = smj_value1.compare(smj_value5);
}

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comp &amp;gt; 0) {
smj_rightRow = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comp &amp;lt; 0) {
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!smj_matches.isEmpty()) {
smj_value6 = smj_value;

smj_value7 = smj_value1;

&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
}
smj_leftRow = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
smj_matches.add(smj_rightRow.copy());
smj_rightRow = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;;
}
} &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (smj_leftRow != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
}
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;// unreachable
&lt;/span&gt;}

&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void processNext() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
&lt;span class=&quot;code-comment&quot;&gt;/*project_c*/&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/*smj_c*/&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (findNextInnerJoinRows(smj_leftInput, smj_rightInput)) {
&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; smj_size = smj_matches.size();
smj_isNull4 = smj_leftRow.isNullAt(0);
smj_value8 = smj_isNull4 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (smj_leftRow.getUTF8String(0));
smj_isNull5 = smj_leftRow.isNullAt(1);
smj_value9 = smj_isNull5 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (smj_leftRow.getUTF8String(1));
smj_value10 = smj_leftRow.getLong(2);
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; smj_i = 0; smj_i &amp;lt; smj_size; smj_i ++) {
InternalRow smj_rightRow1 = (InternalRow) smj_matches.get(smj_i);

smj_numOutputRows.add(1);

&lt;span class=&quot;code-comment&quot;&gt;/*project_c1*/&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/*wholestagecodegen_c*/&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/*project_c7*/&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/*smj_c7*/&lt;/span&gt;
&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; smj_value13 = smj_rightRow1.getLong(2);
&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; project_isNull8 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; project_value8 = -1.0;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) {
project_value8 = (&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;) smj_value13;
}
&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; project_isNull3 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; project_value3 = -1.0;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (project_value8 == 0) {
project_isNull3 = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/*project_c3*/&lt;/span&gt;
&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; project_value5 = -1L;
project_value5 = smj_value10 * 100L;
&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; project_isNull4 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; project_value4 = -1.0;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) {
project_value4 = (&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;) project_value5;
}
project_value3 = (&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;)(project_value4 / project_value8);
}
&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; project_isNull2 = project_isNull3;
&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; project_value2 = -1.0;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!project_isNull2) {
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;.isNaN(project_value3) || &lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;.isInfinite(project_value3)) {
project_value2 = project_value3;
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
project_value2 = java.math.BigDecimal.valueOf(project_value3).
setScale(2, java.math.BigDecimal.ROUND_HALF_UP).doubleValue();
}
}
project_holder.reset();

project_rowWriter.zeroOutNullBytes();

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (smj_isNull4) {
project_rowWriter.setNullAt(0);
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
project_rowWriter.write(0, smj_value8);
}

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (smj_isNull5) {
project_rowWriter.setNullAt(1);
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
project_rowWriter.write(1, smj_value9);
}

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (project_isNull2) {
project_rowWriter.setNullAt(2);
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
project_rowWriter.write(2, project_value2);
}
project_result.setTotalSize(project_holder.totalSize());
append(project_result.copy());

}
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldStop()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
}
}
}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15324875" author="davies" created="Fri, 10 Jun 2016 17:23:00 +0000"  >&lt;p&gt;Could you try to disable whole-stage codegen to see whether this is related to that or not?&lt;/p&gt;</comment>
                            <comment id="15324907" author="davies" created="Fri, 10 Jun 2016 17:34:55 +0000"  >&lt;p&gt;SortMergeJoin assume that the keys do not have null in them (we insert an IsNotNull predicate for inner join), it seems that there is something wrong here, could you post the query plan?&lt;/p&gt;</comment>
                            <comment id="15325093" author="robbinspg" created="Fri, 10 Jun 2016 19:03:19 +0000"  >&lt;p&gt;How do I disable whole-stage codegen?&lt;/p&gt;

&lt;p&gt;found it &lt;/p&gt;

&lt;p&gt;spark.sql.codegen.wholeStage false&lt;/p&gt;</comment>
                            <comment id="15325100" author="hvanhovell" created="Fri, 10 Jun 2016 19:10:13 +0000"  >&lt;p&gt;Using spark session: &lt;tt&gt;spark.conf.set(&quot;spark.sql.codegen.wholeStage&quot;, false)&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="15325159" author="robbinspg" created="Fri, 10 Jun 2016 19:44:30 +0000"  >&lt;p&gt;I am forcing a system dump when I detect a corrupt UTF8String is being created. This is using IBM JVM because I can analyse the dump and see the stacks and object contents using Eclipse Memory Analyzer.&lt;/p&gt;

&lt;p&gt;So... with whole stage codegen enabled we get a stack of:&lt;br/&gt;
java.lang.Thread @ 0x835f9838  &lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at com.ibm.jvm.Dump.SystemDumpImpl()I (Native Method)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at com.ibm.jvm.Dump.SystemDump()V (Dump.java:139)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.unsafe.types.UTF8String.&amp;lt;init&amp;gt;(Ljava/lang/Object;JI)V (UTF8String.java:125(Compiled Code))&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.unsafe.types.UTF8String.fromAddress(Ljava/lang/Object;JI)Lorg/apache/spark/unsafe/types/UTF8String; (UTF8String.java:102(Compiled Code))&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.sql.catalyst.expressions.UnsafeRow.getUTF8String(I)Lorg/apache/spark/unsafe/types/UTF8String; (UnsafeRow.java:414(Compiled Code))&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIterator.sort_addToSorter$(Lorg/apache/spark/sql/catalyst/expressions/GeneratedClass$GeneratedIterator;)V (null)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIterator.processNext()V (null)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.sql.execution.BufferedRowIterator.hasNext()Z (BufferedRowIterator.java:43(Compiled Code))&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.sql.execution.WholeStageCodegenExec$$anonfun$8$$anon$1.hasNext()Z (WholeStageCodegenExec.scala:361(Compiled Code))&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIterator.findNextInnerJoinRows$(Lorg/apache/spark/sql/catalyst/expressions/GeneratedClass$GeneratedIterator;Lscala/collection/Iterator;Lscala/collection/Iterator;)Z (null)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIterator.processNext()V (null)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.sql.execution.BufferedRowIterator.hasNext()Z (BufferedRowIterator.java:43(Compiled Code))&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.sql.execution.WholeStageCodegenExec$$anonfun$doExecute$2$$anon$2.hasNext()Z (WholeStageCodegenExec.scala:377)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at scala.collection.Iterator$$anon$11.hasNext()Z (Iterator.scala:408(Compiled Code))&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at scala.collection.convert.Wrappers$IteratorWrapper.hasNext()Z (Wrappers.scala:30)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.spark_project.guava.collect.Ordering.leastOf(Ljava/util/Iterator;I)Ljava/util/List; (Ordering.java:628)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.util.collection.Utils$.takeOrdered(Lscala/collection/Iterator;ILscala/math/Ordering;)Lscala/collection/Iterator; (Utils.scala:37)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.rdd.RDD$$anonfun$takeOrdered$1$$anonfun$30.apply(Lscala/collection/Iterator;)Lscala/collection/Iterator; (RDD.scala:1365)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.rdd.RDD$$anonfun$takeOrdered$1$$anonfun$30.apply(Ljava/lang/Object;)Ljava/lang/Object; (RDD.scala:1362)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.rdd.RDD$$anonfun$mapPartitions$1$$anonfun$apply$23.apply(Lorg/apache/spark/TaskContext;ILscala/collection/Iterator;)Lscala/collection/Iterator; (RDD.scala:757)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.rdd.RDD$$anonfun$mapPartitions$1$$anonfun$apply$23.apply(Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object; (RDD.scala:757)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.rdd.MapPartitionsRDD.compute(Lorg/apache/spark/Partition;Lorg/apache/spark/TaskContext;)Lscala/collection/Iterator; (MapPartitionsRDD.scala:38)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(Lorg/apache/spark/Partition;Lorg/apache/spark/TaskContext;)Lscala/collection/Iterator; (RDD.scala:318)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.rdd.RDD.iterator(Lorg/apache/spark/Partition;Lorg/apache/spark/TaskContext;)Lscala/collection/Iterator; (RDD.scala:282)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.scheduler.ResultTask.runTask(Lorg/apache/spark/TaskContext;)Ljava/lang/Object; (ResultTask.scala:70)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;and disabled it still fails:&lt;/p&gt;

&lt;p&gt;java.lang.Thread @ 0x835ffd60                 &lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at com.ibm.jvm.Dump.SystemDumpImpl()I (Native Method)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at com.ibm.jvm.Dump.SystemDump()V (Dump.java:139)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.unsafe.types.UTF8String.&amp;lt;init&amp;gt;(Ljava/lang/Object;JI)V (UTF8String.java:125(Compiled Code))&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.unsafe.types.UTF8String.fromAddress(Ljava/lang/Object;JI)Lorg/apache/spark/unsafe/types/UTF8String; (UTF8String.java:102(Compiled Code))&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.sql.catalyst.expressions.UnsafeRow.getUTF8String(I)Lorg/apache/spark/unsafe/types/UTF8String; (UnsafeRow.java:414(Compiled Code))&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.sql.catalyst.expressions.JoinedRow.getUTF8String(I)Lorg/apache/spark/unsafe/types/UTF8String; (JoinedRow.scala:102(Compiled Code))&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.sql.catalyst.expressions.GeneratedClass$SpecificUnsafeProjection.apply(Lorg/apache/spark/sql/catalyst/InternalRow;)Lorg/apache/spark/sql/catalyst/expressions/UnsafeRow; (null)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.sql.execution.aggregate.AggregationIterator$$anonfun$generateResultProjection$1.apply(Lorg/apache/spark/sql/catalyst/expressions/UnsafeRow;Lorg/apache/spark/sql/catalyst/expressions/MutableRow;)Lorg/apache/spark/sql/catalyst/expressions/UnsafeRow; (AggregationIterator.scala:231)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.sql.execution.aggregate.AggregationIterator$$anonfun$generateResultProjection$1.apply(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object; (AggregationIterator.scala:220)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.sql.execution.aggregate.TungstenAggregationIterator.next()Lorg/apache/spark/sql/catalyst/expressions/UnsafeRow; (TungstenAggregationIterator.scala:392)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.sql.execution.aggregate.TungstenAggregationIterator.next()Ljava/lang/Object; (TungstenAggregationIterator.scala:79)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.sql.execution.UnsafeExternalRowSorter.sort(Lscala/collection/Iterator;)Lscala/collection/Iterator; (UnsafeExternalRowSorter.java:173)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.sql.execution.SortExec$$anonfun$1.apply(Lscala/collection/Iterator;)Lscala/collection/Iterator; (SortExec.scala:100)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.sql.execution.SortExec$$anonfun$1.apply(Ljava/lang/Object;)Ljava/lang/Object; (SortExec.scala:93)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.rdd.RDD$$anonfun$mapPartitionsInternal$1$$anonfun$apply$24.apply(Lorg/apache/spark/TaskContext;ILscala/collection/Iterator;)Lscala/collection/Iterator; (RDD.scala:775)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.rdd.RDD$$anonfun$mapPartitionsInternal$1$$anonfun$apply$24.apply(Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object; (RDD.scala:775)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.rdd.MapPartitionsRDD.compute(Lorg/apache/spark/Partition;Lorg/apache/spark/TaskContext;)Lscala/collection/Iterator; (MapPartitionsRDD.scala:38)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(Lorg/apache/spark/Partition;Lorg/apache/spark/TaskContext;)Lscala/collection/Iterator; (RDD.scala:318)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.rdd.RDD.iterator(Lorg/apache/spark/Partition;Lorg/apache/spark/TaskContext;)Lscala/collection/Iterator; (RDD.scala:282)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.rdd.ZippedPartitionsRDD2.compute(Lorg/apache/spark/Partition;Lorg/apache/spark/TaskContext;)Lscala/collection/Iterator; (ZippedPartitionsRDD.scala:89)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(Lorg/apache/spark/Partition;Lorg/apache/spark/TaskContext;)Lscala/collection/Iterator; (RDD.scala:318)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.rdd.RDD.iterator(Lorg/apache/spark/Partition;Lorg/apache/spark/TaskContext;)Lscala/collection/Iterator; (RDD.scala:282)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.rdd.MapPartitionsRDD.compute(Lorg/apache/spark/Partition;Lorg/apache/spark/TaskContext;)Lscala/collection/Iterator; (MapPartitionsRDD.scala:38)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(Lorg/apache/spark/Partition;Lorg/apache/spark/TaskContext;)Lscala/collection/Iterator; (RDD.scala:318)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at org.apache.spark.rdd.RDD.iterator(Lorg/apache/spark/Partition;Lorg/apache/spark/TaskContext;)Lscala/collection/Iterator; (RDD.scala:282)&lt;/li&gt;
&lt;/ul&gt;
&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


</comment>
                            <comment id="15325417" author="davies" created="Fri, 10 Jun 2016 22:36:18 +0000"  >&lt;p&gt;The latest stacktrace is different than previous one, it seems that the UnsafeRow in aggregate hash map is corrupt.&lt;/p&gt;

&lt;p&gt;How large is your dataset? It will be great if we can reproduce it (currently no luck).&lt;/p&gt;</comment>
                            <comment id="15325465" author="aroberts" created="Fri, 10 Jun 2016 23:01:54 +0000"  >&lt;p&gt;I added a link above to the dataset, it&apos;s 658mb when extracted from the bz2 which is 109mb, I can reproduce the problem by doing head -1000000 2008.csv &amp;gt; lessrows.csv and using this as the first argument (then we only deal with a 94mb shortened version of the original file).&lt;/p&gt;</comment>
                            <comment id="15325567" author="hvanhovell" created="Sat, 11 Jun 2016 00:43:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=robbinspg&quot; class=&quot;user-hover&quot; rel=&quot;robbinspg&quot;&gt;robbinspg&lt;/a&gt; I have tried to reproduce the problem on my side using your code/dataset with 2 workers, but I unfortunately could not reproduce the issue. I do have a few follow-up questions:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;What version of 2.0 are you on (git commit hash)?&lt;/li&gt;
	&lt;li&gt;Could you post the plan? I am curious which side on the join is producing these illegal values.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15325759" author="robbinspg" created="Sat, 11 Jun 2016 07:11:40 +0000"  >&lt;p&gt;The stack trace is taken earlier when I detect that the UTF8String created from the corrupt UnsafeRow is created as I&apos;m trying to backtrack to the point of corruption. The earlier stacktrace is the npe which occurs later on trying to use the corrupt UTF8String.&lt;/p&gt;

&lt;p&gt;Dumb question but how do I post the plan?&lt;/p&gt;</comment>
                            <comment id="15325761" author="robbinspg" created="Sat, 11 Jun 2016 07:21:27 +0000"  >&lt;p&gt;has failed on latest Branch 2.0 and master. Currently using Branch-2.0&lt;/p&gt;

&lt;p&gt;commit a790ac5793e1988895341fa878f947b09b275926&lt;br/&gt;
Author: yinxusen &amp;lt;yinxusen@gmail.com&amp;gt;&lt;br/&gt;
Date:   Wed Jun 8 09:18:04 2016 +0100&lt;/p&gt;
</comment>
                            <comment id="15327703" author="hvanhovell" created="Mon, 13 Jun 2016 16:30:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=robbinspg&quot; class=&quot;user-hover&quot; rel=&quot;robbinspg&quot;&gt;robbinspg&lt;/a&gt; You can dump the plan to the console by using calling &lt;tt&gt;explain(true)&lt;/tt&gt; on a DataFrame or by prepending &lt;tt&gt;EXPLAIN EXTENDED ...&lt;/tt&gt; to your SQL statement.&lt;/p&gt;</comment>
                            <comment id="15327992" author="robbinspg" created="Mon, 13 Jun 2016 19:20:15 +0000"  >&lt;p&gt;So this does seem to cause the NPE or SEGV intermittently, ie I get some clean runs. However, I added some tracing to detect when the UnsafeRow looks corrupt (baseobject = null, offset=massive) and I see these in every run so I suspect there is always corruption but that doesn&apos;t always lead to a visible failure. The app usually gives the appearance of success as Spark re-submits the lost tasks and restarts failing executors. Here is what I think is the plan associated with one of the failing jobs:&lt;/p&gt;

&lt;p&gt;== Parsed Logical Plan ==&lt;br/&gt;
&apos;Project &lt;a href=&quot;#927&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;unresolvedalias(&apos;Origin, None), unresolvedalias(&apos;UniqueCarrier, None), &apos;round(((&apos;count * 100) / &apos;total), 2) AS rank#927&lt;/a&gt;&lt;br/&gt;
+- Project &lt;a href=&quot;#16, UniqueCarrier#8, count#888L, total#851L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#16, UniqueCarrier#8, count#888L, total#851L&lt;/a&gt;&lt;br/&gt;
   +- Join Inner, ((Origin#16 = Origin#909) &amp;amp;&amp;amp; (UniqueCarrier#8 = UniqueCarrier#901))&lt;br/&gt;
      :- Aggregate &lt;a href=&quot;#16, UniqueCarrier#8&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#16, UniqueCarrier#8&lt;/a&gt;, &lt;a href=&quot;#16, UniqueCarrier#8, count(1) AS count#888L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#16, UniqueCarrier#8, count(1) AS count#888L&lt;/a&gt;&lt;br/&gt;
      :  +- Filter (NOT (Cancelled#21 = 0) &amp;amp;&amp;amp; (CancellationCode#22 = A))&lt;br/&gt;
      :     +- Filter (Dest#17 = ORD)&lt;br/&gt;
      :        +- Relation&lt;a href=&quot;#0,Month#1,DayofMonth#2,DayOfWeek#3,DepTime#4,CRSDepTime#5,ArrTime#6,CRSArrTime#7,UniqueCarrier#8,FlightNum#9,TailNum#10,ActualElapsedTime#11,CRSElapsedTime#12,AirTime#13,ArrDelay#14,DepDelay#15,Origin#16,Dest#17,Distance#18,TaxiIn#19,TaxiOut#20,Cancelled#21,CancellationCode#22,Diverted#23,CarrierDelay#24,WeatherDelay#25,NASDelay#26,SecurityDelay#27,LateAircraftDelay#28&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Year#0,Month#1,DayofMonth#2,DayOfWeek#3,DepTime#4,CRSDepTime#5,ArrTime#6,CRSArrTime#7,UniqueCarrier#8,FlightNum#9,TailNum#10,ActualElapsedTime#11,CRSElapsedTime#12,AirTime#13,ArrDelay#14,DepDelay#15,Origin#16,Dest#17,Distance#18,TaxiIn#19,TaxiOut#20,Cancelled#21,CancellationCode#22,Diverted#23,CarrierDelay#24,WeatherDelay#25,NASDelay#26,SecurityDelay#27,LateAircraftDelay#28&lt;/a&gt; csv&lt;br/&gt;
      +- Project &lt;a href=&quot;#909, UniqueCarrier#901, count#846L AS total#851L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#909, UniqueCarrier#901, count#846L AS total#851L&lt;/a&gt;&lt;br/&gt;
         +- Aggregate &lt;a href=&quot;#909, UniqueCarrier#901&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#909, UniqueCarrier#901&lt;/a&gt;, &lt;a href=&quot;#909, UniqueCarrier#901, count(1) AS count#846L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#909, UniqueCarrier#901, count(1) AS count#846L&lt;/a&gt;&lt;br/&gt;
            +- Filter (Dest#910 = ORD)&lt;br/&gt;
               +- Relation&lt;a href=&quot;#893,Month#894,DayofMonth#895,DayOfWeek#896,DepTime#897,CRSDepTime#898,ArrTime#899,CRSArrTime#900,UniqueCarrier#901,FlightNum#902,TailNum#903,ActualElapsedTime#904,CRSElapsedTime#905,AirTime#906,ArrDelay#907,DepDelay#908,Origin#909,Dest#910,Distance#911,TaxiIn#912,TaxiOut#913,Cancelled#914,CancellationCode#915,Diverted#916,CarrierDelay#917,WeatherDelay#918,NASDelay#919,SecurityDelay#920,LateAircraftDelay#921&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Year#893,Month#894,DayofMonth#895,DayOfWeek#896,DepTime#897,CRSDepTime#898,ArrTime#899,CRSArrTime#900,UniqueCarrier#901,FlightNum#902,TailNum#903,ActualElapsedTime#904,CRSElapsedTime#905,AirTime#906,ArrDelay#907,DepDelay#908,Origin#909,Dest#910,Distance#911,TaxiIn#912,TaxiOut#913,Cancelled#914,CancellationCode#915,Diverted#916,CarrierDelay#917,WeatherDelay#918,NASDelay#919,SecurityDelay#920,LateAircraftDelay#921&lt;/a&gt; csv&lt;/p&gt;

&lt;p&gt;== Analyzed Logical Plan ==&lt;br/&gt;
Origin: string, UniqueCarrier: string, rank: double&lt;br/&gt;
Project &lt;a href=&quot;#16, UniqueCarrier#8, round((cast((count#888L * cast(100 as bigint)) as double) / cast(total#851L as double)), 2) AS rank#927&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#16, UniqueCarrier#8, round((cast((count#888L * cast(100 as bigint)) as double) / cast(total#851L as double)), 2) AS rank#927&lt;/a&gt;&lt;br/&gt;
+- Project &lt;a href=&quot;#16, UniqueCarrier#8, count#888L, total#851L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#16, UniqueCarrier#8, count#888L, total#851L&lt;/a&gt;&lt;br/&gt;
   +- Join Inner, ((Origin#16 = Origin#909) &amp;amp;&amp;amp; (UniqueCarrier#8 = UniqueCarrier#901))&lt;br/&gt;
      :- Aggregate &lt;a href=&quot;#16, UniqueCarrier#8&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#16, UniqueCarrier#8&lt;/a&gt;, &lt;a href=&quot;#16, UniqueCarrier#8, count(1) AS count#888L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#16, UniqueCarrier#8, count(1) AS count#888L&lt;/a&gt;&lt;br/&gt;
      :  +- Filter (NOT (Cancelled#21 = 0) &amp;amp;&amp;amp; (CancellationCode#22 = A))&lt;br/&gt;
      :     +- Filter (Dest#17 = ORD)&lt;br/&gt;
      :        +- Relation&lt;a href=&quot;#0,Month#1,DayofMonth#2,DayOfWeek#3,DepTime#4,CRSDepTime#5,ArrTime#6,CRSArrTime#7,UniqueCarrier#8,FlightNum#9,TailNum#10,ActualElapsedTime#11,CRSElapsedTime#12,AirTime#13,ArrDelay#14,DepDelay#15,Origin#16,Dest#17,Distance#18,TaxiIn#19,TaxiOut#20,Cancelled#21,CancellationCode#22,Diverted#23,CarrierDelay#24,WeatherDelay#25,NASDelay#26,SecurityDelay#27,LateAircraftDelay#28&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Year#0,Month#1,DayofMonth#2,DayOfWeek#3,DepTime#4,CRSDepTime#5,ArrTime#6,CRSArrTime#7,UniqueCarrier#8,FlightNum#9,TailNum#10,ActualElapsedTime#11,CRSElapsedTime#12,AirTime#13,ArrDelay#14,DepDelay#15,Origin#16,Dest#17,Distance#18,TaxiIn#19,TaxiOut#20,Cancelled#21,CancellationCode#22,Diverted#23,CarrierDelay#24,WeatherDelay#25,NASDelay#26,SecurityDelay#27,LateAircraftDelay#28&lt;/a&gt; csv&lt;br/&gt;
      +- Project &lt;a href=&quot;#909, UniqueCarrier#901, count#846L AS total#851L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#909, UniqueCarrier#901, count#846L AS total#851L&lt;/a&gt;&lt;br/&gt;
         +- Aggregate &lt;a href=&quot;#909, UniqueCarrier#901&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#909, UniqueCarrier#901&lt;/a&gt;, &lt;a href=&quot;#909, UniqueCarrier#901, count(1) AS count#846L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#909, UniqueCarrier#901, count(1) AS count#846L&lt;/a&gt;&lt;br/&gt;
            +- Filter (Dest#910 = ORD)&lt;br/&gt;
               +- Relation&lt;a href=&quot;#893,Month#894,DayofMonth#895,DayOfWeek#896,DepTime#897,CRSDepTime#898,ArrTime#899,CRSArrTime#900,UniqueCarrier#901,FlightNum#902,TailNum#903,ActualElapsedTime#904,CRSElapsedTime#905,AirTime#906,ArrDelay#907,DepDelay#908,Origin#909,Dest#910,Distance#911,TaxiIn#912,TaxiOut#913,Cancelled#914,CancellationCode#915,Diverted#916,CarrierDelay#917,WeatherDelay#918,NASDelay#919,SecurityDelay#920,LateAircraftDelay#921&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Year#893,Month#894,DayofMonth#895,DayOfWeek#896,DepTime#897,CRSDepTime#898,ArrTime#899,CRSArrTime#900,UniqueCarrier#901,FlightNum#902,TailNum#903,ActualElapsedTime#904,CRSElapsedTime#905,AirTime#906,ArrDelay#907,DepDelay#908,Origin#909,Dest#910,Distance#911,TaxiIn#912,TaxiOut#913,Cancelled#914,CancellationCode#915,Diverted#916,CarrierDelay#917,WeatherDelay#918,NASDelay#919,SecurityDelay#920,LateAircraftDelay#921&lt;/a&gt; csv&lt;/p&gt;

&lt;p&gt;== Optimized Logical Plan ==&lt;br/&gt;
Project &lt;a href=&quot;#16, UniqueCarrier#8, round((cast((count#888L * 100) as double) / cast(total#851L as double)), 2) AS rank#927&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#16, UniqueCarrier#8, round((cast((count#888L * 100) as double) / cast(total#851L as double)), 2) AS rank#927&lt;/a&gt;&lt;br/&gt;
+- Join Inner, ((Origin#16 = Origin#909) &amp;amp;&amp;amp; (UniqueCarrier#8 = UniqueCarrier#901))&lt;br/&gt;
   :- Aggregate &lt;a href=&quot;#16, UniqueCarrier#8&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#16, UniqueCarrier#8&lt;/a&gt;, &lt;a href=&quot;#16, UniqueCarrier#8, count(1) AS count#888L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#16, UniqueCarrier#8, count(1) AS count#888L&lt;/a&gt;&lt;br/&gt;
   :  +- Project &lt;a href=&quot;#8, Origin#16&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;UniqueCarrier#8, Origin#16&lt;/a&gt;&lt;br/&gt;
   :     +- Filter (((((isnotnull(UniqueCarrier#8) &amp;amp;&amp;amp; isnotnull(Origin#16)) &amp;amp;&amp;amp; isnotnull(Cancelled#21)) &amp;amp;&amp;amp; isnotnull(CancellationCode#22)) &amp;amp;&amp;amp; NOT (Cancelled#21 = 0)) &amp;amp;&amp;amp; (CancellationCode#22 = A))&lt;br/&gt;
   :        +- InMemoryRelation &lt;a href=&quot;#0, Month#1, DayofMonth#2, DayOfWeek#3, DepTime#4, CRSDepTime#5, ArrTime#6, CRSArrTime#7, UniqueCarrier#8, FlightNum#9, TailNum#10, ActualElapsedTime#11, CRSElapsedTime#12, AirTime#13, ArrDelay#14, DepDelay#15, Origin#16, Dest#17, Distance#18, TaxiIn#19, TaxiOut#20, Cancelled#21, CancellationCode#22, Diverted#23, CarrierDelay#24, WeatherDelay#25, NASDelay#26, SecurityDelay#27, LateAircraftDelay#28&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Year#0, Month#1, DayofMonth#2, DayOfWeek#3, DepTime#4, CRSDepTime#5, ArrTime#6, CRSArrTime#7, UniqueCarrier#8, FlightNum#9, TailNum#10, ActualElapsedTime#11, CRSElapsedTime#12, AirTime#13, ArrDelay#14, DepDelay#15, Origin#16, Dest#17, Distance#18, TaxiIn#19, TaxiOut#20, Cancelled#21, CancellationCode#22, Diverted#23, CarrierDelay#24, WeatherDelay#25, NASDelay#26, SecurityDelay#27, LateAircraftDelay#28&lt;/a&gt;, true, 10000, StorageLevel(disk, memory, deserialized, 1 replicas)&lt;br/&gt;
   :           :  +- Filter (isnotnull(Dest#17) &amp;amp;&amp;amp; (Dest#17 = ORD))&lt;br/&gt;
   :           :     +- InMemoryTableScan &lt;a href=&quot;#0, Month#1, DayofMonth#2, DayOfWeek#3, DepTime#4, CRSDepTime#5, ArrTime#6, CRSArrTime#7, UniqueCarrier#8, FlightNum#9, TailNum#10, ActualElapsedTime#11, CRSElapsedTime#12, AirTime#13, ArrDelay#14, DepDelay#15, Origin#16, Dest#17, Distance#18, TaxiIn#19, TaxiOut#20, Cancelled#21, CancellationCode#22, Diverted#23, CarrierDelay#24, WeatherDelay#25, NASDelay#26, SecurityDelay#27, LateAircraftDelay#28&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Year#0, Month#1, DayofMonth#2, DayOfWeek#3, DepTime#4, CRSDepTime#5, ArrTime#6, CRSArrTime#7, UniqueCarrier#8, FlightNum#9, TailNum#10, ActualElapsedTime#11, CRSElapsedTime#12, AirTime#13, ArrDelay#14, DepDelay#15, Origin#16, Dest#17, Distance#18, TaxiIn#19, TaxiOut#20, Cancelled#21, CancellationCode#22, Diverted#23, CarrierDelay#24, WeatherDelay#25, NASDelay#26, SecurityDelay#27, LateAircraftDelay#28&lt;/a&gt;, &lt;a href=&quot;#17), (Dest#17 = ORD)&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;isnotnull(Dest#17), (Dest#17 = ORD)&lt;/a&gt;&lt;br/&gt;
   :           :        :  +- InMemoryRelation &lt;a href=&quot;#0, Month#1, DayofMonth#2, DayOfWeek#3, DepTime#4, CRSDepTime#5, ArrTime#6, CRSArrTime#7, UniqueCarrier#8, FlightNum#9, TailNum#10, ActualElapsedTime#11, CRSElapsedTime#12, AirTime#13, ArrDelay#14, DepDelay#15, Origin#16, Dest#17, Distance#18, TaxiIn#19, TaxiOut#20, Cancelled#21, CancellationCode#22, Diverted#23, CarrierDelay#24, WeatherDelay#25, NASDelay#26, SecurityDelay#27, LateAircraftDelay#28&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Year#0, Month#1, DayofMonth#2, DayOfWeek#3, DepTime#4, CRSDepTime#5, ArrTime#6, CRSArrTime#7, UniqueCarrier#8, FlightNum#9, TailNum#10, ActualElapsedTime#11, CRSElapsedTime#12, AirTime#13, ArrDelay#14, DepDelay#15, Origin#16, Dest#17, Distance#18, TaxiIn#19, TaxiOut#20, Cancelled#21, CancellationCode#22, Diverted#23, CarrierDelay#24, WeatherDelay#25, NASDelay#26, SecurityDelay#27, LateAircraftDelay#28&lt;/a&gt;, true, 10000, StorageLevel(disk, memory, deserialized, 1 replicas)&lt;br/&gt;
   :           :        :     :  +- Scan csv &lt;a href=&quot;#0,Month#1,DayofMonth#2,DayOfWeek#3,DepTime#4,CRSDepTime#5,ArrTime#6,CRSArrTime#7,UniqueCarrier#8,FlightNum#9,TailNum#10,ActualElapsedTime#11,CRSElapsedTime#12,AirTime#13,ArrDelay#14,DepDelay#15,Origin#16,Dest#17,Distance#18,TaxiIn#19,TaxiOut#20,Cancelled#21,CancellationCode#22,Diverted#23,CarrierDelay#24,WeatherDelay#25,NASDelay#26,SecurityDelay#27,LateAircraftDelay#28&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Year#0,Month#1,DayofMonth#2,DayOfWeek#3,DepTime#4,CRSDepTime#5,ArrTime#6,CRSArrTime#7,UniqueCarrier#8,FlightNum#9,TailNum#10,ActualElapsedTime#11,CRSElapsedTime#12,AirTime#13,ArrDelay#14,DepDelay#15,Origin#16,Dest#17,Distance#18,TaxiIn#19,TaxiOut#20,Cancelled#21,CancellationCode#22,Diverted#23,CarrierDelay#24,WeatherDelay#25,NASDelay#26,SecurityDelay#27,LateAircraftDelay#28&lt;/a&gt; Format: CSV, InputPaths: &lt;a href=&quot;file:/home/robbins/brandberry/2008.csv&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:/home/robbins/brandberry/2008.csv&lt;/a&gt;, PushedFilters: [], ReadSchema: struct&amp;lt;Year:int,Month:int,DayofMonth:int,DayOfWeek:int,DepTime:string,CRSDepTime:int,ArrTime:stri...&lt;br/&gt;
   +- Aggregate &lt;a href=&quot;#909, UniqueCarrier#901&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#909, UniqueCarrier#901&lt;/a&gt;, &lt;a href=&quot;#909, UniqueCarrier#901, count(1) AS total#851L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#909, UniqueCarrier#901, count(1) AS total#851L&lt;/a&gt;&lt;br/&gt;
      +- Project &lt;a href=&quot;#901, Origin#909&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;UniqueCarrier#901, Origin#909&lt;/a&gt;&lt;br/&gt;
         +- Filter (isnotnull(Origin#909) &amp;amp;&amp;amp; isnotnull(UniqueCarrier#901))&lt;br/&gt;
            +- InMemoryRelation &lt;a href=&quot;#893, Month#894, DayofMonth#895, DayOfWeek#896, DepTime#897, CRSDepTime#898, ArrTime#899, CRSArrTime#900, UniqueCarrier#901, FlightNum#902, TailNum#903, ActualElapsedTime#904, CRSElapsedTime#905, AirTime#906, ArrDelay#907, DepDelay#908, Origin#909, Dest#910, Distance#911, TaxiIn#912, TaxiOut#913, Cancelled#914, CancellationCode#915, Diverted#916, CarrierDelay#917, WeatherDelay#918, NASDelay#919, SecurityDelay#920, LateAircraftDelay#921&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Year#893, Month#894, DayofMonth#895, DayOfWeek#896, DepTime#897, CRSDepTime#898, ArrTime#899, CRSArrTime#900, UniqueCarrier#901, FlightNum#902, TailNum#903, ActualElapsedTime#904, CRSElapsedTime#905, AirTime#906, ArrDelay#907, DepDelay#908, Origin#909, Dest#910, Distance#911, TaxiIn#912, TaxiOut#913, Cancelled#914, CancellationCode#915, Diverted#916, CarrierDelay#917, WeatherDelay#918, NASDelay#919, SecurityDelay#920, LateAircraftDelay#921&lt;/a&gt;, true, 10000, StorageLevel(disk, memory, deserialized, 1 replicas)&lt;br/&gt;
               :  +- Filter (isnotnull(Dest#17) &amp;amp;&amp;amp; (Dest#17 = ORD))&lt;br/&gt;
               :     +- InMemoryTableScan &lt;a href=&quot;#0, Month#1, DayofMonth#2, DayOfWeek#3, DepTime#4, CRSDepTime#5, ArrTime#6, CRSArrTime#7, UniqueCarrier#8, FlightNum#9, TailNum#10, ActualElapsedTime#11, CRSElapsedTime#12, AirTime#13, ArrDelay#14, DepDelay#15, Origin#16, Dest#17, Distance#18, TaxiIn#19, TaxiOut#20, Cancelled#21, CancellationCode#22, Diverted#23, CarrierDelay#24, WeatherDelay#25, NASDelay#26, SecurityDelay#27, LateAircraftDelay#28&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Year#0, Month#1, DayofMonth#2, DayOfWeek#3, DepTime#4, CRSDepTime#5, ArrTime#6, CRSArrTime#7, UniqueCarrier#8, FlightNum#9, TailNum#10, ActualElapsedTime#11, CRSElapsedTime#12, AirTime#13, ArrDelay#14, DepDelay#15, Origin#16, Dest#17, Distance#18, TaxiIn#19, TaxiOut#20, Cancelled#21, CancellationCode#22, Diverted#23, CarrierDelay#24, WeatherDelay#25, NASDelay#26, SecurityDelay#27, LateAircraftDelay#28&lt;/a&gt;, &lt;a href=&quot;#17), (Dest#17 = ORD)&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;isnotnull(Dest#17), (Dest#17 = ORD)&lt;/a&gt;&lt;br/&gt;
               :        :  +- InMemoryRelation &lt;a href=&quot;#0, Month#1, DayofMonth#2, DayOfWeek#3, DepTime#4, CRSDepTime#5, ArrTime#6, CRSArrTime#7, UniqueCarrier#8, FlightNum#9, TailNum#10, ActualElapsedTime#11, CRSElapsedTime#12, AirTime#13, ArrDelay#14, DepDelay#15, Origin#16, Dest#17, Distance#18, TaxiIn#19, TaxiOut#20, Cancelled#21, CancellationCode#22, Diverted#23, CarrierDelay#24, WeatherDelay#25, NASDelay#26, SecurityDelay#27, LateAircraftDelay#28&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Year#0, Month#1, DayofMonth#2, DayOfWeek#3, DepTime#4, CRSDepTime#5, ArrTime#6, CRSArrTime#7, UniqueCarrier#8, FlightNum#9, TailNum#10, ActualElapsedTime#11, CRSElapsedTime#12, AirTime#13, ArrDelay#14, DepDelay#15, Origin#16, Dest#17, Distance#18, TaxiIn#19, TaxiOut#20, Cancelled#21, CancellationCode#22, Diverted#23, CarrierDelay#24, WeatherDelay#25, NASDelay#26, SecurityDelay#27, LateAircraftDelay#28&lt;/a&gt;, true, 10000, StorageLevel(disk, memory, deserialized, 1 replicas)&lt;br/&gt;
               :        :     :  +- Scan csv &lt;a href=&quot;#0,Month#1,DayofMonth#2,DayOfWeek#3,DepTime#4,CRSDepTime#5,ArrTime#6,CRSArrTime#7,UniqueCarrier#8,FlightNum#9,TailNum#10,ActualElapsedTime#11,CRSElapsedTime#12,AirTime#13,ArrDelay#14,DepDelay#15,Origin#16,Dest#17,Distance#18,TaxiIn#19,TaxiOut#20,Cancelled#21,CancellationCode#22,Diverted#23,CarrierDelay#24,WeatherDelay#25,NASDelay#26,SecurityDelay#27,LateAircraftDelay#28&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Year#0,Month#1,DayofMonth#2,DayOfWeek#3,DepTime#4,CRSDepTime#5,ArrTime#6,CRSArrTime#7,UniqueCarrier#8,FlightNum#9,TailNum#10,ActualElapsedTime#11,CRSElapsedTime#12,AirTime#13,ArrDelay#14,DepDelay#15,Origin#16,Dest#17,Distance#18,TaxiIn#19,TaxiOut#20,Cancelled#21,CancellationCode#22,Diverted#23,CarrierDelay#24,WeatherDelay#25,NASDelay#26,SecurityDelay#27,LateAircraftDelay#28&lt;/a&gt; Format: CSV, InputPaths: &lt;a href=&quot;file:/home/robbins/brandberry/2008.csv&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:/home/robbins/brandberry/2008.csv&lt;/a&gt;, PushedFilters: [], ReadSchema: struct&amp;lt;Year:int,Month:int,DayofMonth:int,DayOfWeek:int,DepTime:string,CRSDepTime:int,ArrTime:stri...&lt;/p&gt;

&lt;p&gt;== Physical Plan ==&lt;br/&gt;
Project &lt;a href=&quot;#16, UniqueCarrier#8, round((cast((count#888L * 100) as double) / cast(total#851L as double)), 2) AS rank#927&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#16, UniqueCarrier#8, round((cast((count#888L * 100) as double) / cast(total#851L as double)), 2) AS rank#927&lt;/a&gt;&lt;br/&gt;
+- BroadcastHashJoin &lt;a href=&quot;#16, UniqueCarrier#8&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#16, UniqueCarrier#8&lt;/a&gt;, &lt;a href=&quot;#909, UniqueCarrier#901&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#909, UniqueCarrier#901&lt;/a&gt;, Inner, BuildRight&lt;br/&gt;
   :- HashAggregate(key=&lt;a href=&quot;#16,UniqueCarrier#8&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#16,UniqueCarrier#8&lt;/a&gt;, functions=&lt;span class=&quot;error&quot;&gt;&amp;#91;count(1)&amp;#93;&lt;/span&gt;, output=&lt;a href=&quot;#16,UniqueCarrier#8,count#888L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#16,UniqueCarrier#8,count#888L&lt;/a&gt;)&lt;br/&gt;
   :  +- Exchange hashpartitioning(Origin#16, UniqueCarrier#8, 200)&lt;br/&gt;
   :     +- HashAggregate(key=&lt;a href=&quot;#16,UniqueCarrier#8&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#16,UniqueCarrier#8&lt;/a&gt;, functions=&lt;span class=&quot;error&quot;&gt;&amp;#91;partial_count(1)&amp;#93;&lt;/span&gt;, output=&lt;a href=&quot;#16,UniqueCarrier#8,count#1342L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#16,UniqueCarrier#8,count#1342L&lt;/a&gt;)&lt;br/&gt;
   :        +- Project &lt;a href=&quot;#8, Origin#16&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;UniqueCarrier#8, Origin#16&lt;/a&gt;&lt;br/&gt;
   :           +- Filter (((((isnotnull(UniqueCarrier#8) &amp;amp;&amp;amp; isnotnull(Origin#16)) &amp;amp;&amp;amp; isnotnull(Cancelled#21)) &amp;amp;&amp;amp; isnotnull(CancellationCode#22)) &amp;amp;&amp;amp; NOT (Cancelled#21 = 0)) &amp;amp;&amp;amp; (CancellationCode#22 = A))&lt;br/&gt;
   :              +- InMemoryTableScan &lt;a href=&quot;#8, Origin#16, Cancelled#21, CancellationCode#22&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;UniqueCarrier#8, Origin#16, Cancelled#21, CancellationCode#22&lt;/a&gt;, &lt;a href=&quot;#8), isnotnull(Origin#16), isnotnull(Cancelled#21), isnotnull(CancellationCode#22), NOT (Cancelled#21 = 0), (CancellationCode#22 = A)&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;isnotnull(UniqueCarrier#8), isnotnull(Origin#16), isnotnull(Cancelled#21), isnotnull(CancellationCode#22), NOT (Cancelled#21 = 0), (CancellationCode#22 = A)&lt;/a&gt;&lt;br/&gt;
   :                 :  +- InMemoryRelation &lt;a href=&quot;#0, Month#1, DayofMonth#2, DayOfWeek#3, DepTime#4, CRSDepTime#5, ArrTime#6, CRSArrTime#7, UniqueCarrier#8, FlightNum#9, TailNum#10, ActualElapsedTime#11, CRSElapsedTime#12, AirTime#13, ArrDelay#14, DepDelay#15, Origin#16, Dest#17, Distance#18, TaxiIn#19, TaxiOut#20, Cancelled#21, CancellationCode#22, Diverted#23, CarrierDelay#24, WeatherDelay#25, NASDelay#26, SecurityDelay#27, LateAircraftDelay#28&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Year#0, Month#1, DayofMonth#2, DayOfWeek#3, DepTime#4, CRSDepTime#5, ArrTime#6, CRSArrTime#7, UniqueCarrier#8, FlightNum#9, TailNum#10, ActualElapsedTime#11, CRSElapsedTime#12, AirTime#13, ArrDelay#14, DepDelay#15, Origin#16, Dest#17, Distance#18, TaxiIn#19, TaxiOut#20, Cancelled#21, CancellationCode#22, Diverted#23, CarrierDelay#24, WeatherDelay#25, NASDelay#26, SecurityDelay#27, LateAircraftDelay#28&lt;/a&gt;, true, 10000, StorageLevel(disk, memory, deserialized, 1 replicas)&lt;br/&gt;
   :                 :     :  +- Filter (isnotnull(Dest#17) &amp;amp;&amp;amp; (Dest#17 = ORD))&lt;br/&gt;
   :                 :     :     +- InMemoryTableScan &lt;a href=&quot;#0, Month#1, DayofMonth#2, DayOfWeek#3, DepTime#4, CRSDepTime#5, ArrTime#6, CRSArrTime#7, UniqueCarrier#8, FlightNum#9, TailNum#10, ActualElapsedTime#11, CRSElapsedTime#12, AirTime#13, ArrDelay#14, DepDelay#15, Origin#16, Dest#17, Distance#18, TaxiIn#19, TaxiOut#20, Cancelled#21, CancellationCode#22, Diverted#23, CarrierDelay#24, WeatherDelay#25, NASDelay#26, SecurityDelay#27, LateAircraftDelay#28&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Year#0, Month#1, DayofMonth#2, DayOfWeek#3, DepTime#4, CRSDepTime#5, ArrTime#6, CRSArrTime#7, UniqueCarrier#8, FlightNum#9, TailNum#10, ActualElapsedTime#11, CRSElapsedTime#12, AirTime#13, ArrDelay#14, DepDelay#15, Origin#16, Dest#17, Distance#18, TaxiIn#19, TaxiOut#20, Cancelled#21, CancellationCode#22, Diverted#23, CarrierDelay#24, WeatherDelay#25, NASDelay#26, SecurityDelay#27, LateAircraftDelay#28&lt;/a&gt;, &lt;a href=&quot;#17), (Dest#17 = ORD)&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;isnotnull(Dest#17), (Dest#17 = ORD)&lt;/a&gt;&lt;br/&gt;
   :                 :     :        :  +- InMemoryRelation &lt;a href=&quot;#0, Month#1, DayofMonth#2, DayOfWeek#3, DepTime#4, CRSDepTime#5, ArrTime#6, CRSArrTime#7, UniqueCarrier#8, FlightNum#9, TailNum#10, ActualElapsedTime#11, CRSElapsedTime#12, AirTime#13, ArrDelay#14, DepDelay#15, Origin#16, Dest#17, Distance#18, TaxiIn#19, TaxiOut#20, Cancelled#21, CancellationCode#22, Diverted#23, CarrierDelay#24, WeatherDelay#25, NASDelay#26, SecurityDelay#27, LateAircraftDelay#28&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Year#0, Month#1, DayofMonth#2, DayOfWeek#3, DepTime#4, CRSDepTime#5, ArrTime#6, CRSArrTime#7, UniqueCarrier#8, FlightNum#9, TailNum#10, ActualElapsedTime#11, CRSElapsedTime#12, AirTime#13, ArrDelay#14, DepDelay#15, Origin#16, Dest#17, Distance#18, TaxiIn#19, TaxiOut#20, Cancelled#21, CancellationCode#22, Diverted#23, CarrierDelay#24, WeatherDelay#25, NASDelay#26, SecurityDelay#27, LateAircraftDelay#28&lt;/a&gt;, true, 10000, StorageLevel(disk, memory, deserialized, 1 replicas)&lt;br/&gt;
   :                 :     :        :     :  +- Scan csv &lt;a href=&quot;#0,Month#1,DayofMonth#2,DayOfWeek#3,DepTime#4,CRSDepTime#5,ArrTime#6,CRSArrTime#7,UniqueCarrier#8,FlightNum#9,TailNum#10,ActualElapsedTime#11,CRSElapsedTime#12,AirTime#13,ArrDelay#14,DepDelay#15,Origin#16,Dest#17,Distance#18,TaxiIn#19,TaxiOut#20,Cancelled#21,CancellationCode#22,Diverted#23,CarrierDelay#24,WeatherDelay#25,NASDelay#26,SecurityDelay#27,LateAircraftDelay#28&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Year#0,Month#1,DayofMonth#2,DayOfWeek#3,DepTime#4,CRSDepTime#5,ArrTime#6,CRSArrTime#7,UniqueCarrier#8,FlightNum#9,TailNum#10,ActualElapsedTime#11,CRSElapsedTime#12,AirTime#13,ArrDelay#14,DepDelay#15,Origin#16,Dest#17,Distance#18,TaxiIn#19,TaxiOut#20,Cancelled#21,CancellationCode#22,Diverted#23,CarrierDelay#24,WeatherDelay#25,NASDelay#26,SecurityDelay#27,LateAircraftDelay#28&lt;/a&gt; Format: CSV, InputPaths: &lt;a href=&quot;file:/home/robbins/brandberry/2008.csv&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:/home/robbins/brandberry/2008.csv&lt;/a&gt;, PushedFilters: [], ReadSchema: struct&amp;lt;Year:int,Month:int,DayofMonth:int,DayOfWeek:int,DepTime:string,CRSDepTime:int,ArrTime:stri...&lt;br/&gt;
   +- BroadcastExchange HashedRelationBroadcastMode(List(input&lt;span class=&quot;error&quot;&gt;&amp;#91;0, string, true&amp;#93;&lt;/span&gt;, input&lt;span class=&quot;error&quot;&gt;&amp;#91;1, string, true&amp;#93;&lt;/span&gt;))&lt;br/&gt;
      +- HashAggregate(key=&lt;a href=&quot;#909,UniqueCarrier#901&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#909,UniqueCarrier#901&lt;/a&gt;, functions=&lt;span class=&quot;error&quot;&gt;&amp;#91;count(1)&amp;#93;&lt;/span&gt;, output=&lt;a href=&quot;#909,UniqueCarrier#901,total#851L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#909,UniqueCarrier#901,total#851L&lt;/a&gt;)&lt;br/&gt;
         +- Exchange hashpartitioning(Origin#909, UniqueCarrier#901, 200)&lt;br/&gt;
            +- HashAggregate(key=&lt;a href=&quot;#909,UniqueCarrier#901&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#909,UniqueCarrier#901&lt;/a&gt;, functions=&lt;span class=&quot;error&quot;&gt;&amp;#91;partial_count(1)&amp;#93;&lt;/span&gt;, output=&lt;a href=&quot;#909,UniqueCarrier#901,count#1344L&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Origin#909,UniqueCarrier#901,count#1344L&lt;/a&gt;)&lt;br/&gt;
               +- Filter (isnotnull(Origin#909) &amp;amp;&amp;amp; isnotnull(UniqueCarrier#901))&lt;br/&gt;
                  +- InMemoryTableScan &lt;a href=&quot;#901, Origin#909&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;UniqueCarrier#901, Origin#909&lt;/a&gt;, &lt;a href=&quot;#909), isnotnull(UniqueCarrier#901)&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;isnotnull(Origin#909), isnotnull(UniqueCarrier#901)&lt;/a&gt;&lt;br/&gt;
                     :  +- InMemoryRelation &lt;a href=&quot;#893, Month#894, DayofMonth#895, DayOfWeek#896, DepTime#897, CRSDepTime#898, ArrTime#899, CRSArrTime#900, UniqueCarrier#901, FlightNum#902, TailNum#903, ActualElapsedTime#904, CRSElapsedTime#905, AirTime#906, ArrDelay#907, DepDelay#908, Origin#909, Dest#910, Distance#911, TaxiIn#912, TaxiOut#913, Cancelled#914, CancellationCode#915, Diverted#916, CarrierDelay#917, WeatherDelay#918, NASDelay#919, SecurityDelay#920, LateAircraftDelay#921&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Year#893, Month#894, DayofMonth#895, DayOfWeek#896, DepTime#897, CRSDepTime#898, ArrTime#899, CRSArrTime#900, UniqueCarrier#901, FlightNum#902, TailNum#903, ActualElapsedTime#904, CRSElapsedTime#905, AirTime#906, ArrDelay#907, DepDelay#908, Origin#909, Dest#910, Distance#911, TaxiIn#912, TaxiOut#913, Cancelled#914, CancellationCode#915, Diverted#916, CarrierDelay#917, WeatherDelay#918, NASDelay#919, SecurityDelay#920, LateAircraftDelay#921&lt;/a&gt;, true, 10000, StorageLevel(disk, memory, deserialized, 1 replicas)&lt;br/&gt;
                     :     :  +- Filter (isnotnull(Dest#17) &amp;amp;&amp;amp; (Dest#17 = ORD))&lt;br/&gt;
                     :     :     +- InMemoryTableScan &lt;a href=&quot;#0, Month#1, DayofMonth#2, DayOfWeek#3, DepTime#4, CRSDepTime#5, ArrTime#6, CRSArrTime#7, UniqueCarrier#8, FlightNum#9, TailNum#10, ActualElapsedTime#11, CRSElapsedTime#12, AirTime#13, ArrDelay#14, DepDelay#15, Origin#16, Dest#17, Distance#18, TaxiIn#19, TaxiOut#20, Cancelled#21, CancellationCode#22, Diverted#23, CarrierDelay#24, WeatherDelay#25, NASDelay#26, SecurityDelay#27, LateAircraftDelay#28&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Year#0, Month#1, DayofMonth#2, DayOfWeek#3, DepTime#4, CRSDepTime#5, ArrTime#6, CRSArrTime#7, UniqueCarrier#8, FlightNum#9, TailNum#10, ActualElapsedTime#11, CRSElapsedTime#12, AirTime#13, ArrDelay#14, DepDelay#15, Origin#16, Dest#17, Distance#18, TaxiIn#19, TaxiOut#20, Cancelled#21, CancellationCode#22, Diverted#23, CarrierDelay#24, WeatherDelay#25, NASDelay#26, SecurityDelay#27, LateAircraftDelay#28&lt;/a&gt;, &lt;a href=&quot;#17), (Dest#17 = ORD)&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;isnotnull(Dest#17), (Dest#17 = ORD)&lt;/a&gt;&lt;br/&gt;
                     :     :        :  +- InMemoryRelation &lt;a href=&quot;#0, Month#1, DayofMonth#2, DayOfWeek#3, DepTime#4, CRSDepTime#5, ArrTime#6, CRSArrTime#7, UniqueCarrier#8, FlightNum#9, TailNum#10, ActualElapsedTime#11, CRSElapsedTime#12, AirTime#13, ArrDelay#14, DepDelay#15, Origin#16, Dest#17, Distance#18, TaxiIn#19, TaxiOut#20, Cancelled#21, CancellationCode#22, Diverted#23, CarrierDelay#24, WeatherDelay#25, NASDelay#26, SecurityDelay#27, LateAircraftDelay#28&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Year#0, Month#1, DayofMonth#2, DayOfWeek#3, DepTime#4, CRSDepTime#5, ArrTime#6, CRSArrTime#7, UniqueCarrier#8, FlightNum#9, TailNum#10, ActualElapsedTime#11, CRSElapsedTime#12, AirTime#13, ArrDelay#14, DepDelay#15, Origin#16, Dest#17, Distance#18, TaxiIn#19, TaxiOut#20, Cancelled#21, CancellationCode#22, Diverted#23, CarrierDelay#24, WeatherDelay#25, NASDelay#26, SecurityDelay#27, LateAircraftDelay#28&lt;/a&gt;, true, 10000, StorageLevel(disk, memory, deserialized, 1 replicas)&lt;br/&gt;
                     :     :        :     :  +- Scan csv &lt;a href=&quot;#0,Month#1,DayofMonth#2,DayOfWeek#3,DepTime#4,CRSDepTime#5,ArrTime#6,CRSArrTime#7,UniqueCarrier#8,FlightNum#9,TailNum#10,ActualElapsedTime#11,CRSElapsedTime#12,AirTime#13,ArrDelay#14,DepDelay#15,Origin#16,Dest#17,Distance#18,TaxiIn#19,TaxiOut#20,Cancelled#21,CancellationCode#22,Diverted#23,CarrierDelay#24,WeatherDelay#25,NASDelay#26,SecurityDelay#27,LateAircraftDelay#28&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Year#0,Month#1,DayofMonth#2,DayOfWeek#3,DepTime#4,CRSDepTime#5,ArrTime#6,CRSArrTime#7,UniqueCarrier#8,FlightNum#9,TailNum#10,ActualElapsedTime#11,CRSElapsedTime#12,AirTime#13,ArrDelay#14,DepDelay#15,Origin#16,Dest#17,Distance#18,TaxiIn#19,TaxiOut#20,Cancelled#21,CancellationCode#22,Diverted#23,CarrierDelay#24,WeatherDelay#25,NASDelay#26,SecurityDelay#27,LateAircraftDelay#28&lt;/a&gt; Format: CSV, InputPaths: &lt;a href=&quot;file:/home/robbins/brandberry/2008.csv&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file:/home/robbins/brandberry/2008.csv&lt;/a&gt;, PushedFilters: [], ReadSchema: struct&amp;lt;Year:int,Month:int,DayofMonth:int,DayOfWeek:int,DepTime:string,CRSDepTime:int,ArrTime:stri...&lt;/p&gt;</comment>
                            <comment id="15328200" author="hvanhovell" created="Mon, 13 Jun 2016 20:30:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=robbinspg&quot; class=&quot;user-hover&quot; rel=&quot;robbinspg&quot;&gt;robbinspg&lt;/a&gt; Could you try this without caching?&lt;/p&gt;</comment>
                            <comment id="15329474" author="robbinspg" created="Tue, 14 Jun 2016 13:12:28 +0000"  >&lt;p&gt;modified app to remove .cache()&apos;s and still get a segv on open jdk 8. &lt;/p&gt;

&lt;p&gt;I may have been mistaken about it failing with &apos;spark.sql.codegen.wholeStage false&apos; as I can not reproduce it with that set.&lt;/p&gt;</comment>
                            <comment id="15331370" author="robbinspg" created="Wed, 15 Jun 2016 08:18:12 +0000"  >&lt;p&gt;Chatting with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hvanhovell&quot; class=&quot;user-hover&quot; rel=&quot;hvanhovell&quot;&gt;hvanhovell&lt;/a&gt; here is the current state. I can reproduce a segv using local&lt;span class=&quot;error&quot;&gt;&amp;#91;8&amp;#93;&lt;/span&gt; on an 8 core machine. It is intermittent but  many many runs with eg local&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; produce no issues. The segv info is:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;#
# A fatal error has been detected by the Java Runtime Environment:
#
#  SIGSEGV (0xb) at pc=0x00007fe8c118ca58, pid=3558, tid=140633451779840
#
# JRE version: OpenJDK Runtime Environment (8.0_91-b14) (build 1.8.0_91-b14)
# Java VM: OpenJDK 64-Bit Server VM (25.91-b14 mixed mode linux-amd64 compressed oops)
# Problematic frame:
# J 7467 C1 org.apache.spark.unsafe.Platform.getByte(Ljava/lang/Object;J)B (9 bytes) @ 0x00007fe8c118ca58 [0x00007fe8c118ca20+0x38]
#
# Failed to write core dump. Core dumps have been disabled. To enable core dumping, try &quot;ulimit -c unlimited&quot; before starting Java again
#
# If you would like to submit a bug report, please visit:
#   http://bugreport.java.com/bugreport/crash.jsp
#

---------------  T H R E A D  ---------------

Current thread (0x00007fe858018800):  JavaThread &quot;Executor task launch worker-3&quot; daemon [_thread_in_Java, id=3698, stack(0x00007fe7c6dfd000,0x00007fe7c6efe000)]

siginfo: si_signo: 11 (SIGSEGV), si_code: 1 (SEGV_MAPERR), si_addr: 0x0000000000a09cf4

Registers:
RAX=0x00007fe884ce5828, RBX=0x00007fe884ce5828, RCX=0x00007fe81e0a5360, RDX=0x0000000000a09cf4
RSP=0x00007fe7c6efb9e0, RBP=0x00007fe7c6efba80, RSI=0x0000000000000000, RDI=0x0000000000003848
R8 =0x00000000200b94c8, R9 =0x00000000eef66bf0, R10=0x00007fe8d87a2f00, R11=0x00007fe8c118ca20
R12=0x0000000000000000, R13=0x00007fe7c6efba28, R14=0x00007fe7c6efba98, R15=0x00007fe858018800
RIP=0x00007fe8c118ca58, EFLAGS=0x0000000000010206, CSGSFS=0x0000000000000033, ERR=0x0000000000000004
  TRAPNO=0x000000000000000e

Top of Stack: (sp=0x00007fe7c6efb9e0)
0x00007fe7c6efb9e0:   00007fe7c56941e8 0000000000000000
0x00007fe7c6efb9f0:   00007fe7c6efbab0 00007fe8c140c38c
0x00007fe7c6efba00:   00007fe8c1007d80 00000000eef66bc8
0x00007fe7c6efba10:   00007fe7c6efba80 00007fe8c1007700
0x00007fe7c6efba20:   00007fe8c1007700 0000000000a09cf4
0x00007fe7c6efba30:   0000000000000030 0000000000000000
0x00007fe7c6efba40:   00007fe7c6efba40 00007fe81e0a1f9b
0x00007fe7c6efba50:   00007fe7c6efba98 00007fe81e0a5360
0x00007fe7c6efba60:   0000000000000000 00007fe81e0a1fc0
0x00007fe7c6efba70:   00007fe7c6efba28 00007fe7c6efba90
0x00007fe7c6efba80:   00007fe7c6efbae8 00007fe8c1007700
0x00007fe7c6efba90:   0000000000000000 00000000ee4f4898
0x00007fe7c6efbaa0:   000000000000004d 00007fe7c6efbaa8
0x00007fe7c6efbab0:   00007fe81e0a42be 00007fe7c6efbb18
0x00007fe7c6efbac0:   00007fe81e0a5360 0000000000000000
0x00007fe7c6efbad0:   00007fe81e0a4338 00007fe7c6efba90
0x00007fe7c6efbae0:   00007fe7c6efbb10 00007fe7c6efbb60
0x00007fe7c6efbaf0:   00007fe8c1007a40 0000000000000000
0x00007fe7c6efbb00:   0000000000000000 0000000000000003
0x00007fe7c6efbb10:   00000000ee4f4898 00000000eef67950
0x00007fe7c6efbb20:   00007fe7c6efbb20 00007fe81e0a43f2
0x00007fe7c6efbb30:   00007fe7c6efbb78 00007fe81e0a5360
0x00007fe7c6efbb40:   0000000000000000 00007fe81e0a4418
0x00007fe7c6efbb50:   00007fe7c6efbb10 00007fe7c6efbb70
0x00007fe7c6efbb60:   00007fe7c6efbbc0 00007fe8c1007a40
0x00007fe7c6efbb70:   00000000ee4f4898 00000000eef67950
0x00007fe7c6efbb80:   00007fe7c6efbb80 00007fe7c56844e5
0x00007fe7c6efbb90:   00007fe7c6efbc28 00007fe7c5684950
0x00007fe7c6efbba0:   0000000000000000 00007fe7c5684618
0x00007fe7c6efbbb0:   00007fe7c6efbb70 00007fe7c6efbc18
0x00007fe7c6efbbc0:   00007fe7c6efbc70 00007fe8c10077d0
0x00007fe7c6efbbd0:   0000000000000000 0000000000000000 

Instructions: (pc=0x00007fe8c118ca58)
0x00007fe8c118ca38:   08 83 c7 08 89 78 08 48 b8 28 58 ce 84 e8 7f 00
0x00007fe8c118ca48:   00 81 e7 f8 3f 00 00 83 ff 00 0f 84 16 00 00 00
0x00007fe8c118ca58:   0f be 04 16 c1 e0 18 c1 f8 18 48 83 c4 30 5d 85
0x00007fe8c118ca68:   05 93 c6 85 17 c3 48 89 44 24 08 48 c7 04 24 ff 

Register to memory mapping:

RAX={method} {0x00007fe884ce5828} &apos;getByte&apos; &apos;(Ljava/lang/Object;J)B&apos; in &apos;org/apache/spark/unsafe/Platform&apos;
RBX={method} {0x00007fe884ce5828} &apos;getByte&apos; &apos;(Ljava/lang/Object;J)B&apos; in &apos;org/apache/spark/unsafe/Platform&apos;
RCX=0x00007fe81e0a5360 is pointing into metadata
RDX=0x0000000000a09cf4 is an unknown value
RSP=0x00007fe7c6efb9e0 is pointing into the stack for thread: 0x00007fe858018800
RBP=0x00007fe7c6efba80 is pointing into the stack for thread: 0x00007fe858018800
RSI=0x0000000000000000 is an unknown value
RDI=0x0000000000003848 is an unknown value
R8 =0x00000000200b94c8 is an unknown value
R9 =0x00000000eef66bf0 is an oop
[B 
 - klass: {type array byte}
 - length: 48
R10=0x00007fe8d87a2f00: &amp;lt;offset 0xf07f00&amp;gt; in /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.91-0.b14.el6_7.x86_64/jre/lib/amd64/server/libjvm.so at 0x00007fe8d789b000
R11=0x00007fe8c118ca20 is at entry_point+0 in (nmethod*)0x00007fe8c118c8d0
R12=0x0000000000000000 is an unknown value
R13=0x00007fe7c6efba28 is pointing into the stack for thread: 0x00007fe858018800
R14=0x00007fe7c6efba98 is pointing into the stack for thread: 0x00007fe858018800
R15=0x00007fe858018800 is a thread


Stack: [0x00007fe7c6dfd000,0x00007fe7c6efe000],  sp=0x00007fe7c6efb9e0,  free space=1018k
Native frames: (J=compiled Java code, j=interpreted, Vv=VM code, C=native code)
J 7467 C1 org.apache.spark.unsafe.Platform.getByte(Ljava/lang/Object;J)B (9 bytes) @ 0x00007fe8c118ca58 [0x00007fe8c118ca20+0x38]
j  org.apache.spark.unsafe.types.UTF8String.getByte(I)B+11
j  org.apache.spark.unsafe.types.UTF8String.compareTo(Lorg/apache/spark/unsafe/types/UTF8String;)I+30
j  org.apache.spark.unsafe.types.UTF8String.compare(Lorg/apache/spark/unsafe/types/UTF8String;)I+2
j  org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIterator.findNextInnerJoinRows$(Lorg/apache/spark/sql/catalyst/expressions/GeneratedClass$GeneratedIterator;Lscala/collection/Iterator;Lscala/collection/Iterator;)Z+141
j  org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIterator.processNext()V+410
J 7729 C1 org.apache.spark.sql.execution.BufferedRowIterator.hasNext()Z (30 bytes) @ 0x00007fe8c1ad80d4 [0x00007fe8c1ad7e60+0x274]
j  org.apache.spark.sql.execution.WholeStageCodegenExec$$anonfun$doExecute$3$$anon$2.hasNext()Z+4
J 8582 C2 scala.collection.Iterator$$anon$11.hasNext()Z (10 bytes) @ 0x00007fe8c2506bd8 [0x00007fe8c2506760+0x478]
j  scala.collection.convert.Wrappers$IteratorWrapper.hasNext()Z+4
j  org.spark_project.guava.collect.Ordering.leastOf(Ljava/util/Iterator;I)Ljava/util/List;+132
j  org.apache.spark.util.collection.Utils$.takeOrdered(Lscala/collection/Iterator;ILscala/math/Ordering;)Lscala/collection/Iterator;+29
j  org.apache.spark.rdd.RDD$$anonfun$takeOrdered$1$$anonfun$30.apply(Lscala/collection/Iterator;)Lscala/collection/Iterator;+46
j  org.apache.spark.rdd.RDD$$anonfun$takeOrdered$1$$anonfun$30.apply(Ljava/lang/Object;)Ljava/lang/Object;+5
j  org.apache.spark.rdd.RDD$$anonfun$mapPartitions$1$$anonfun$apply$23.apply(Lorg/apache/spark/TaskContext;ILscala/collection/Iterator;)Lscala/collection/Iterator;+5
j  org.apache.spark.rdd.RDD$$anonfun$mapPartitions$1$$anonfun$apply$23.apply(Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;+13
j  org.apache.spark.rdd.MapPartitionsRDD.compute(Lorg/apache/spark/Partition;Lorg/apache/spark/TaskContext;)Lscala/collection/Iterator;+27
j  org.apache.spark.rdd.RDD.computeOrReadCheckpoint(Lorg/apache/spark/Partition;Lorg/apache/spark/TaskContext;)Lscala/collection/Iterator;+26
j  org.apache.spark.rdd.RDD.iterator(Lorg/apache/spark/Partition;Lorg/apache/spark/TaskContext;)Lscala/collection/Iterator;+33
j  org.apache.spark.scheduler.ResultTask.runTask(Lorg/apache/spark/TaskContext;)Ljava/lang/Object;+136
j  org.apache.spark.scheduler.Task.run(JILorg/apache/spark/metrics/MetricsSystem;)Ljava/lang/Object;+82
j  org.apache.spark.executor.Executor$TaskRunner.run()V+374
j  java.util.concurrent.ThreadPoolExecutor.runWorker(Ljava/util/concurrent/ThreadPoolExecutor$Worker;)V+95
j  java.util.concurrent.ThreadPoolExecutor$Worker.run()V+5
j  java.lang.Thread.run()V+11
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

</comment>
                            <comment id="15331371" author="robbinspg" created="Wed, 15 Jun 2016 08:19:03 +0000"  >&lt;p&gt;The generated code is:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Top Arrival Carrier Cancellations:
Found 5 WholeStageCodegen subtrees.
== Subtree 1 / 5 ==
*HashAggregate(key=[Origin#16,UniqueCarrier#8], functions=[partial_count(1)], output=[Origin#16,UniqueCarrier#8,count#296L])
+- *Project [UniqueCarrier#8, Origin#16]
   +- *Filter (((((((isnotnull(Origin#16) &amp;amp;&amp;amp; isnotnull(UniqueCarrier#8)) &amp;amp;&amp;amp; isnotnull(Cancelled#21)) &amp;amp;&amp;amp; isnotnull(CancellationCode#22)) &amp;amp;&amp;amp; NOT (Cancelled#21 = 0)) &amp;amp;&amp;amp; (CancellationCode#22 = A)) &amp;amp;&amp;amp; isnotnull(Dest#17)) &amp;amp;&amp;amp; (Dest#17 = ORD))
      +- *Scan csv [UniqueCarrier#8,Origin#16,Dest#17,Cancelled#21,CancellationCode#22] Format: CSV, InputPaths: file:/home/robbins/brandberry/2008.csv, PushedFilters: [IsNotNull(Origin), IsNotNull(UniqueCarrier), IsNotNull(Cancelled), IsNotNull(CancellationCode), ..., ReadSchema: struct&amp;lt;UniqueCarrier:string,Origin:string,Dest:string,Cancelled:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,CancellationCode:string&amp;gt;

Generated code:
&lt;span class=&quot;code-comment&quot;&gt;/* 001 */&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; generate(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references) {
&lt;span class=&quot;code-comment&quot;&gt;/* 002 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GeneratedIterator(references);
&lt;span class=&quot;code-comment&quot;&gt;/* 003 */&lt;/span&gt; }
&lt;span class=&quot;code-comment&quot;&gt;/* 004 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 005 */&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;GeneratedIterator &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; org.apache.spark.sql.execution.BufferedRowIterator {
&lt;span class=&quot;code-comment&quot;&gt;/* 006 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references;
&lt;span class=&quot;code-comment&quot;&gt;/* 007 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_initAgg;
&lt;span class=&quot;code-comment&quot;&gt;/* 008 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_bufIsNull;
&lt;span class=&quot;code-comment&quot;&gt;/* 009 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_bufValue;
&lt;span class=&quot;code-comment&quot;&gt;/* 010 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; agg_VectorizedHashMap agg_vectorizedHashMap;
&lt;span class=&quot;code-comment&quot;&gt;/* 011 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; java.util.Iterator&amp;lt;org.apache.spark.sql.execution.vectorized.ColumnarBatch.Row&amp;gt; agg_vectorizedHashMapIter;
&lt;span class=&quot;code-comment&quot;&gt;/* 012 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.aggregate.HashAggregateExec agg_plan;
&lt;span class=&quot;code-comment&quot;&gt;/* 013 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.UnsafeFixedWidthAggregationMap agg_hashMap;
&lt;span class=&quot;code-comment&quot;&gt;/* 014 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.UnsafeKVExternalSorter agg_sorter;
&lt;span class=&quot;code-comment&quot;&gt;/* 015 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.unsafe.KVIterator agg_mapIter;
&lt;span class=&quot;code-comment&quot;&gt;/* 016 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric agg_peakMemory;
&lt;span class=&quot;code-comment&quot;&gt;/* 017 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric agg_spillSize;
&lt;span class=&quot;code-comment&quot;&gt;/* 018 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric scan_numOutputRows;
&lt;span class=&quot;code-comment&quot;&gt;/* 019 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; scala.collection.Iterator scan_input;
&lt;span class=&quot;code-comment&quot;&gt;/* 020 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric filter_numOutputRows;
&lt;span class=&quot;code-comment&quot;&gt;/* 021 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UnsafeRow filter_result;
&lt;span class=&quot;code-comment&quot;&gt;/* 022 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder filter_holder;
&lt;span class=&quot;code-comment&quot;&gt;/* 023 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter filter_rowWriter;
&lt;span class=&quot;code-comment&quot;&gt;/* 024 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UnsafeRow project_result;
&lt;span class=&quot;code-comment&quot;&gt;/* 025 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder project_holder;
&lt;span class=&quot;code-comment&quot;&gt;/* 026 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter project_rowWriter;
&lt;span class=&quot;code-comment&quot;&gt;/* 027 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UnsafeRow agg_result2;
&lt;span class=&quot;code-comment&quot;&gt;/* 028 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder agg_holder;
&lt;span class=&quot;code-comment&quot;&gt;/* 029 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter agg_rowWriter;
&lt;span class=&quot;code-comment&quot;&gt;/* 030 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowJoiner agg_unsafeRowJoiner;
&lt;span class=&quot;code-comment&quot;&gt;/* 031 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric wholestagecodegen_numOutputRows;
&lt;span class=&quot;code-comment&quot;&gt;/* 032 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric wholestagecodegen_aggTime;
&lt;span class=&quot;code-comment&quot;&gt;/* 033 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UnsafeRow wholestagecodegen_result;
&lt;span class=&quot;code-comment&quot;&gt;/* 034 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder wholestagecodegen_holder;
&lt;span class=&quot;code-comment&quot;&gt;/* 035 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter wholestagecodegen_rowWriter;
&lt;span class=&quot;code-comment&quot;&gt;/* 036 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 037 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; GeneratedIterator(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references) {
&lt;span class=&quot;code-comment&quot;&gt;/* 038 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.references = references;
&lt;span class=&quot;code-comment&quot;&gt;/* 039 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 040 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 041 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void init(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; index, scala.collection.Iterator inputs[]) {
&lt;span class=&quot;code-comment&quot;&gt;/* 042 */&lt;/span&gt;     partitionIndex = index;
&lt;span class=&quot;code-comment&quot;&gt;/* 043 */&lt;/span&gt;     agg_initAgg = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 044 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 045 */&lt;/span&gt;     agg_vectorizedHashMap = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; agg_VectorizedHashMap();
&lt;span class=&quot;code-comment&quot;&gt;/* 046 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 047 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_plan = (org.apache.spark.sql.execution.aggregate.HashAggregateExec) references[0];
&lt;span class=&quot;code-comment&quot;&gt;/* 048 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 049 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_peakMemory = (org.apache.spark.sql.execution.metric.SQLMetric) references[1];
&lt;span class=&quot;code-comment&quot;&gt;/* 050 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_spillSize = (org.apache.spark.sql.execution.metric.SQLMetric) references[2];
&lt;span class=&quot;code-comment&quot;&gt;/* 051 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.scan_numOutputRows = (org.apache.spark.sql.execution.metric.SQLMetric) references[3];
&lt;span class=&quot;code-comment&quot;&gt;/* 052 */&lt;/span&gt;     scan_input = inputs[0];
&lt;span class=&quot;code-comment&quot;&gt;/* 053 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.filter_numOutputRows = (org.apache.spark.sql.execution.metric.SQLMetric) references[4];
&lt;span class=&quot;code-comment&quot;&gt;/* 054 */&lt;/span&gt;     filter_result = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow(5);
&lt;span class=&quot;code-comment&quot;&gt;/* 055 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.filter_holder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder(filter_result, 128);
&lt;span class=&quot;code-comment&quot;&gt;/* 056 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.filter_rowWriter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(filter_holder, 5);
&lt;span class=&quot;code-comment&quot;&gt;/* 057 */&lt;/span&gt;     project_result = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow(2);
&lt;span class=&quot;code-comment&quot;&gt;/* 058 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.project_holder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder(project_result, 64);
&lt;span class=&quot;code-comment&quot;&gt;/* 059 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.project_rowWriter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(project_holder, 2);
&lt;span class=&quot;code-comment&quot;&gt;/* 060 */&lt;/span&gt;     agg_result2 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow(2);
&lt;span class=&quot;code-comment&quot;&gt;/* 061 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_holder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder(agg_result2, 64);
&lt;span class=&quot;code-comment&quot;&gt;/* 062 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_rowWriter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(agg_holder, 2);
&lt;span class=&quot;code-comment&quot;&gt;/* 063 */&lt;/span&gt;     agg_unsafeRowJoiner = agg_plan.createUnsafeJoiner();
&lt;span class=&quot;code-comment&quot;&gt;/* 064 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.wholestagecodegen_numOutputRows = (org.apache.spark.sql.execution.metric.SQLMetric) references[7];
&lt;span class=&quot;code-comment&quot;&gt;/* 065 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.wholestagecodegen_aggTime = (org.apache.spark.sql.execution.metric.SQLMetric) references[8];
&lt;span class=&quot;code-comment&quot;&gt;/* 066 */&lt;/span&gt;     wholestagecodegen_result = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow(3);
&lt;span class=&quot;code-comment&quot;&gt;/* 067 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.wholestagecodegen_holder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder(wholestagecodegen_result, 64);
&lt;span class=&quot;code-comment&quot;&gt;/* 068 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.wholestagecodegen_rowWriter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(wholestagecodegen_holder, 3);
&lt;span class=&quot;code-comment&quot;&gt;/* 069 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 070 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 071 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;agg_VectorizedHashMap {
&lt;span class=&quot;code-comment&quot;&gt;/* 072 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.vectorized.ColumnarBatch batch;
&lt;span class=&quot;code-comment&quot;&gt;/* 073 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.vectorized.ColumnarBatch aggregateBufferBatch;
&lt;span class=&quot;code-comment&quot;&gt;/* 074 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;[] buckets;
&lt;span class=&quot;code-comment&quot;&gt;/* 075 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; capacity = 1 &amp;lt;&amp;lt; 16;
&lt;span class=&quot;code-comment&quot;&gt;/* 076 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; loadFactor = 0.5;
&lt;span class=&quot;code-comment&quot;&gt;/* 077 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; numBuckets = (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) (capacity / loadFactor);
&lt;span class=&quot;code-comment&quot;&gt;/* 078 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxSteps = 2;
&lt;span class=&quot;code-comment&quot;&gt;/* 079 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; numRows = 0;
&lt;span class=&quot;code-comment&quot;&gt;/* 080 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.types.StructType schema = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.types.StructType().add(&lt;span class=&quot;code-quote&quot;&gt;&quot;Origin&quot;&lt;/span&gt;, org.apache.spark.sql.types.DataTypes.StringType)
&lt;span class=&quot;code-comment&quot;&gt;/* 081 */&lt;/span&gt;     .add(&lt;span class=&quot;code-quote&quot;&gt;&quot;UniqueCarrier&quot;&lt;/span&gt;, org.apache.spark.sql.types.DataTypes.StringType)
&lt;span class=&quot;code-comment&quot;&gt;/* 082 */&lt;/span&gt;     .add(&lt;span class=&quot;code-quote&quot;&gt;&quot;count&quot;&lt;/span&gt;, org.apache.spark.sql.types.DataTypes.LongType);
&lt;span class=&quot;code-comment&quot;&gt;/* 083 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.types.StructType aggregateBufferSchema =
&lt;span class=&quot;code-comment&quot;&gt;/* 084 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.types.StructType().add(&lt;span class=&quot;code-quote&quot;&gt;&quot;count&quot;&lt;/span&gt;, org.apache.spark.sql.types.DataTypes.LongType);
&lt;span class=&quot;code-comment&quot;&gt;/* 085 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 086 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; agg_VectorizedHashMap() {
&lt;span class=&quot;code-comment&quot;&gt;/* 087 */&lt;/span&gt;       batch = org.apache.spark.sql.execution.vectorized.ColumnarBatch.allocate(schema,
&lt;span class=&quot;code-comment&quot;&gt;/* 088 */&lt;/span&gt;         org.apache.spark.memory.MemoryMode.ON_HEAP, capacity);
&lt;span class=&quot;code-comment&quot;&gt;/* 089 */&lt;/span&gt;       &lt;span class=&quot;code-comment&quot;&gt;// TODO: Possibly generate &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; projection in HashAggregate directly
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 090 */&lt;/span&gt;       aggregateBufferBatch = org.apache.spark.sql.execution.vectorized.ColumnarBatch.allocate(
&lt;span class=&quot;code-comment&quot;&gt;/* 091 */&lt;/span&gt;         aggregateBufferSchema, org.apache.spark.memory.MemoryMode.ON_HEAP, capacity);
&lt;span class=&quot;code-comment&quot;&gt;/* 092 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0 ; i &amp;lt; aggregateBufferBatch.numCols(); i++) {
&lt;span class=&quot;code-comment&quot;&gt;/* 093 */&lt;/span&gt;         aggregateBufferBatch.setColumn(i, batch.column(i+2));
&lt;span class=&quot;code-comment&quot;&gt;/* 094 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 095 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 096 */&lt;/span&gt;       buckets = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;[numBuckets];
&lt;span class=&quot;code-comment&quot;&gt;/* 097 */&lt;/span&gt;       java.util.Arrays.fill(buckets, -1);
&lt;span class=&quot;code-comment&quot;&gt;/* 098 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 099 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 100 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; org.apache.spark.sql.execution.vectorized.ColumnarBatch.Row findOrInsert(UTF8String agg_key, UTF8String agg_key1) {
&lt;span class=&quot;code-comment&quot;&gt;/* 101 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; h = hash(agg_key, agg_key1);
&lt;span class=&quot;code-comment&quot;&gt;/* 102 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; step = 0;
&lt;span class=&quot;code-comment&quot;&gt;/* 103 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; idx = (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) h &amp;amp; (numBuckets - 1);
&lt;span class=&quot;code-comment&quot;&gt;/* 104 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (step &amp;lt; maxSteps) {
&lt;span class=&quot;code-comment&quot;&gt;/* 105 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// Return bucket index &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it&apos;s either an empty slot or already contains the key
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 106 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (buckets[idx] == -1) {
&lt;span class=&quot;code-comment&quot;&gt;/* 107 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (numRows &amp;lt; capacity) {
&lt;span class=&quot;code-comment&quot;&gt;/* 108 */&lt;/span&gt;             &lt;span class=&quot;code-comment&quot;&gt;// Initialize aggregate keys
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 109 */&lt;/span&gt;             batch.column(0).putByteArray(numRows, agg_key.getBytes());
&lt;span class=&quot;code-comment&quot;&gt;/* 110 */&lt;/span&gt;             batch.column(1).putByteArray(numRows, agg_key1.getBytes());
&lt;span class=&quot;code-comment&quot;&gt;/* 111 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 112 */&lt;/span&gt;             agg_bufIsNull = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 113 */&lt;/span&gt;             agg_bufValue = 0L;
&lt;span class=&quot;code-comment&quot;&gt;/* 114 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 115 */&lt;/span&gt;             &lt;span class=&quot;code-comment&quot;&gt;// Initialize aggregate values
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 116 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 117 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_bufIsNull) {
&lt;span class=&quot;code-comment&quot;&gt;/* 118 */&lt;/span&gt;               batch.column(2).putLong(numRows, agg_bufValue);
&lt;span class=&quot;code-comment&quot;&gt;/* 119 */&lt;/span&gt;             } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 120 */&lt;/span&gt;               batch.column(2).putNull(numRows);
&lt;span class=&quot;code-comment&quot;&gt;/* 121 */&lt;/span&gt;             }
&lt;span class=&quot;code-comment&quot;&gt;/* 122 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 123 */&lt;/span&gt;             buckets[idx] = numRows++;
&lt;span class=&quot;code-comment&quot;&gt;/* 124 */&lt;/span&gt;             batch.setNumRows(numRows);
&lt;span class=&quot;code-comment&quot;&gt;/* 125 */&lt;/span&gt;             aggregateBufferBatch.setNumRows(numRows);
&lt;span class=&quot;code-comment&quot;&gt;/* 126 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; aggregateBufferBatch.getRow(buckets[idx]);
&lt;span class=&quot;code-comment&quot;&gt;/* 127 */&lt;/span&gt;           } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 128 */&lt;/span&gt;             &lt;span class=&quot;code-comment&quot;&gt;// No more space
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 129 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 130 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 131 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (equals(idx, agg_key, agg_key1)) {
&lt;span class=&quot;code-comment&quot;&gt;/* 132 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; aggregateBufferBatch.getRow(buckets[idx]);
&lt;span class=&quot;code-comment&quot;&gt;/* 133 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 134 */&lt;/span&gt;         idx = (idx + 1) &amp;amp; (numBuckets - 1);
&lt;span class=&quot;code-comment&quot;&gt;/* 135 */&lt;/span&gt;         step++;
&lt;span class=&quot;code-comment&quot;&gt;/* 136 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 137 */&lt;/span&gt;       &lt;span class=&quot;code-comment&quot;&gt;// Didn&apos;t find it
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 138 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 139 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 140 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 141 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; equals(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; idx, UTF8String agg_key, UTF8String agg_key1) {
&lt;span class=&quot;code-comment&quot;&gt;/* 142 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (batch.column(0).getUTF8String(buckets[idx]).equals(agg_key)) &amp;amp;&amp;amp; (batch.column(1).getUTF8String(buckets[idx]).equals(agg_key1));
&lt;span class=&quot;code-comment&quot;&gt;/* 143 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 144 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 145 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; hash(UTF8String agg_key, UTF8String agg_key1) {
&lt;span class=&quot;code-comment&quot;&gt;/* 146 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_hash = 0;
&lt;span class=&quot;code-comment&quot;&gt;/* 147 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 148 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_result = 0;
&lt;span class=&quot;code-comment&quot;&gt;/* 149 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; agg_key.getBytes().length; i++) {
&lt;span class=&quot;code-comment&quot;&gt;/* 150 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_hash1 = agg_key.getBytes()[i];
&lt;span class=&quot;code-comment&quot;&gt;/* 151 */&lt;/span&gt;         agg_result = (agg_result ^ (0x9e3779b9)) + agg_hash1 + (agg_result &amp;lt;&amp;lt; 6) + (agg_result &amp;gt;&amp;gt;&amp;gt; 2);
&lt;span class=&quot;code-comment&quot;&gt;/* 152 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 153 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 154 */&lt;/span&gt;       agg_hash = (agg_hash ^ (0x9e3779b9)) + agg_result + (agg_hash &amp;lt;&amp;lt; 6) + (agg_hash &amp;gt;&amp;gt;&amp;gt; 2);
&lt;span class=&quot;code-comment&quot;&gt;/* 155 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 156 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_result1 = 0;
&lt;span class=&quot;code-comment&quot;&gt;/* 157 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; agg_key1.getBytes().length; i++) {
&lt;span class=&quot;code-comment&quot;&gt;/* 158 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_hash2 = agg_key1.getBytes()[i];
&lt;span class=&quot;code-comment&quot;&gt;/* 159 */&lt;/span&gt;         agg_result1 = (agg_result1 ^ (0x9e3779b9)) + agg_hash2 + (agg_result1 &amp;lt;&amp;lt; 6) + (agg_result1 &amp;gt;&amp;gt;&amp;gt; 2);
&lt;span class=&quot;code-comment&quot;&gt;/* 160 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 161 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 162 */&lt;/span&gt;       agg_hash = (agg_hash ^ (0x9e3779b9)) + agg_result1 + (agg_hash &amp;lt;&amp;lt; 6) + (agg_hash &amp;gt;&amp;gt;&amp;gt; 2);
&lt;span class=&quot;code-comment&quot;&gt;/* 163 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 164 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; agg_hash;
&lt;span class=&quot;code-comment&quot;&gt;/* 165 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 166 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 167 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; java.util.Iterator&amp;lt;org.apache.spark.sql.execution.vectorized.ColumnarBatch.Row&amp;gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 168 */&lt;/span&gt;     rowIterator() {
&lt;span class=&quot;code-comment&quot;&gt;/* 169 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; batch.rowIterator();
&lt;span class=&quot;code-comment&quot;&gt;/* 170 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 171 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 172 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close() {
&lt;span class=&quot;code-comment&quot;&gt;/* 173 */&lt;/span&gt;       batch.close();
&lt;span class=&quot;code-comment&quot;&gt;/* 174 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 175 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 176 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 177 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 178 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void agg_doAggregateWithKeys() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
&lt;span class=&quot;code-comment&quot;&gt;/* 179 */&lt;/span&gt;     agg_hashMap = agg_plan.createHashMap();
&lt;span class=&quot;code-comment&quot;&gt;/* 180 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 181 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (scan_input.hasNext()) {
&lt;span class=&quot;code-comment&quot;&gt;/* 182 */&lt;/span&gt;       InternalRow scan_row = (InternalRow) scan_input.next();
&lt;span class=&quot;code-comment&quot;&gt;/* 183 */&lt;/span&gt;       scan_numOutputRows.add(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 184 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; scan_isNull8 = scan_row.isNullAt(3);
&lt;span class=&quot;code-comment&quot;&gt;/* 185 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; scan_value8 = scan_isNull8 ? -1 : (scan_row.getInt(3));
&lt;span class=&quot;code-comment&quot;&gt;/* 186 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 187 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!(!(scan_isNull8))) &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 188 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 189 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; filter_value3 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 190 */&lt;/span&gt;       filter_value3 = scan_value8 == 0;
&lt;span class=&quot;code-comment&quot;&gt;/* 191 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; filter_value2 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 192 */&lt;/span&gt;       filter_value2 = !(filter_value3);
&lt;span class=&quot;code-comment&quot;&gt;/* 193 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!filter_value2) &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 194 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; scan_isNull9 = scan_row.isNullAt(4);
&lt;span class=&quot;code-comment&quot;&gt;/* 195 */&lt;/span&gt;       UTF8String scan_value9 = scan_isNull9 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (scan_row.getUTF8String(4));
&lt;span class=&quot;code-comment&quot;&gt;/* 196 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 197 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!(!(scan_isNull9))) &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 198 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 199 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; filter_obj = ((Expression) references[5]).eval(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
&lt;span class=&quot;code-comment&quot;&gt;/* 200 */&lt;/span&gt;       UTF8String filter_value10 = (UTF8String) filter_obj;
&lt;span class=&quot;code-comment&quot;&gt;/* 201 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; filter_value8 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 202 */&lt;/span&gt;       filter_value8 = scan_value9.equals(filter_value10);
&lt;span class=&quot;code-comment&quot;&gt;/* 203 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!filter_value8) &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 204 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; scan_isNull7 = scan_row.isNullAt(2);
&lt;span class=&quot;code-comment&quot;&gt;/* 205 */&lt;/span&gt;       UTF8String scan_value7 = scan_isNull7 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (scan_row.getUTF8String(2));
&lt;span class=&quot;code-comment&quot;&gt;/* 206 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 207 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!(!(scan_isNull7))) &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 208 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 209 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; filter_obj1 = ((Expression) references[6]).eval(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
&lt;span class=&quot;code-comment&quot;&gt;/* 210 */&lt;/span&gt;       UTF8String filter_value15 = (UTF8String) filter_obj1;
&lt;span class=&quot;code-comment&quot;&gt;/* 211 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; filter_value13 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 212 */&lt;/span&gt;       filter_value13 = scan_value7.equals(filter_value15);
&lt;span class=&quot;code-comment&quot;&gt;/* 213 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!filter_value13) &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 214 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 215 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; scan_isNull6 = scan_row.isNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 216 */&lt;/span&gt;       UTF8String scan_value6 = scan_isNull6 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (scan_row.getUTF8String(1));
&lt;span class=&quot;code-comment&quot;&gt;/* 217 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 218 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!(!(scan_isNull6))) &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 219 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 220 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; scan_isNull5 = scan_row.isNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 221 */&lt;/span&gt;       UTF8String scan_value5 = scan_isNull5 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (scan_row.getUTF8String(0));
&lt;span class=&quot;code-comment&quot;&gt;/* 222 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 223 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!(!(scan_isNull5))) &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 224 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 225 */&lt;/span&gt;       filter_numOutputRows.add(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 226 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 227 */&lt;/span&gt;       UnsafeRow agg_unsafeRowAggBuffer = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 228 */&lt;/span&gt;       org.apache.spark.sql.execution.vectorized.ColumnarBatch.Row agg_vectorizedAggBuffer = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 229 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 230 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 231 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; &amp;amp;&amp;amp; !&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 232 */&lt;/span&gt;           agg_vectorizedAggBuffer = agg_vectorizedHashMap.findOrInsert(
&lt;span class=&quot;code-comment&quot;&gt;/* 233 */&lt;/span&gt;             scan_value6, scan_value5);
&lt;span class=&quot;code-comment&quot;&gt;/* 234 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 235 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 236 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 237 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_vectorizedAggBuffer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 238 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// generate grouping key
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 239 */&lt;/span&gt;         agg_holder.reset();
&lt;span class=&quot;code-comment&quot;&gt;/* 240 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 241 */&lt;/span&gt;         agg_rowWriter.write(0, scan_value6);
&lt;span class=&quot;code-comment&quot;&gt;/* 242 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 243 */&lt;/span&gt;         agg_rowWriter.write(1, scan_value5);
&lt;span class=&quot;code-comment&quot;&gt;/* 244 */&lt;/span&gt;         agg_result2.setTotalSize(agg_holder.totalSize());
&lt;span class=&quot;code-comment&quot;&gt;/* 245 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_value6 = 42;
&lt;span class=&quot;code-comment&quot;&gt;/* 246 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 247 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 248 */&lt;/span&gt;           agg_value6 = org.apache.spark.unsafe.hash.Murmur3_x86_32.hashUnsafeBytes(scan_value6.getBaseObject(), scan_value6.getBaseOffset(), scan_value6.numBytes(), agg_value6);
&lt;span class=&quot;code-comment&quot;&gt;/* 249 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 250 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 251 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 252 */&lt;/span&gt;           agg_value6 = org.apache.spark.unsafe.hash.Murmur3_x86_32.hashUnsafeBytes(scan_value5.getBaseObject(), scan_value5.getBaseOffset(), scan_value5.numBytes(), agg_value6);
&lt;span class=&quot;code-comment&quot;&gt;/* 253 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 254 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 255 */&lt;/span&gt;           &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to get the buffer from hash map
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 256 */&lt;/span&gt;           agg_unsafeRowAggBuffer =
&lt;span class=&quot;code-comment&quot;&gt;/* 257 */&lt;/span&gt;           agg_hashMap.getAggregationBufferFromUnsafeRow(agg_result2, agg_value6);
&lt;span class=&quot;code-comment&quot;&gt;/* 258 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 259 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_unsafeRowAggBuffer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 260 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_sorter == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 261 */&lt;/span&gt;             agg_sorter = agg_hashMap.destructAndCreateExternalSorter();
&lt;span class=&quot;code-comment&quot;&gt;/* 262 */&lt;/span&gt;           } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 263 */&lt;/span&gt;             agg_sorter.merge(agg_hashMap.destructAndCreateExternalSorter());
&lt;span class=&quot;code-comment&quot;&gt;/* 264 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 265 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 266 */&lt;/span&gt;           &lt;span class=&quot;code-comment&quot;&gt;// the hash map had be spilled, it should have enough memory now,
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 267 */&lt;/span&gt;           &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;  to allocate buffer again.
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 268 */&lt;/span&gt;           agg_unsafeRowAggBuffer =
&lt;span class=&quot;code-comment&quot;&gt;/* 269 */&lt;/span&gt;           agg_hashMap.getAggregationBufferFromUnsafeRow(agg_result2, agg_value6);
&lt;span class=&quot;code-comment&quot;&gt;/* 270 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_unsafeRowAggBuffer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 271 */&lt;/span&gt;             &lt;span class=&quot;code-comment&quot;&gt;// failed to allocate the first page
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 272 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; OutOfMemoryError(&lt;span class=&quot;code-quote&quot;&gt;&quot;No enough memory &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; aggregation&quot;&lt;/span&gt;);
&lt;span class=&quot;code-comment&quot;&gt;/* 273 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 274 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 275 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 276 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 277 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_vectorizedAggBuffer != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 278 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// update vectorized row
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 279 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 280 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// common sub-expressions
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 281 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 282 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// evaluate aggregate function
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 283 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value10 = agg_vectorizedAggBuffer.getLong(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 284 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 285 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value9 = -1L;
&lt;span class=&quot;code-comment&quot;&gt;/* 286 */&lt;/span&gt;         agg_value9 = agg_value10 + 1L;
&lt;span class=&quot;code-comment&quot;&gt;/* 287 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// update vectorized row
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 288 */&lt;/span&gt;         agg_vectorizedAggBuffer.setLong(0, agg_value9);
&lt;span class=&quot;code-comment&quot;&gt;/* 289 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 290 */&lt;/span&gt;       } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 291 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// update unsafe row
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 292 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 293 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// common sub-expressions
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 294 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 295 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// evaluate aggregate function
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 296 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value13 = agg_unsafeRowAggBuffer.getLong(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 297 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 298 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value12 = -1L;
&lt;span class=&quot;code-comment&quot;&gt;/* 299 */&lt;/span&gt;         agg_value12 = agg_value13 + 1L;
&lt;span class=&quot;code-comment&quot;&gt;/* 300 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// update unsafe row buffer
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 301 */&lt;/span&gt;         agg_unsafeRowAggBuffer.setLong(0, agg_value12);
&lt;span class=&quot;code-comment&quot;&gt;/* 302 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 303 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 304 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldStop()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 305 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 306 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 307 */&lt;/span&gt;     agg_vectorizedHashMapIter = agg_vectorizedHashMap.rowIterator();
&lt;span class=&quot;code-comment&quot;&gt;/* 308 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 309 */&lt;/span&gt;     agg_mapIter = agg_plan.finishAggregate(agg_hashMap, agg_sorter, agg_peakMemory, agg_spillSize);
&lt;span class=&quot;code-comment&quot;&gt;/* 310 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 311 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 312 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void processNext() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
&lt;span class=&quot;code-comment&quot;&gt;/* 313 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_initAgg) {
&lt;span class=&quot;code-comment&quot;&gt;/* 314 */&lt;/span&gt;       agg_initAgg = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 315 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; wholestagecodegen_beforeAgg = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.nanoTime();
&lt;span class=&quot;code-comment&quot;&gt;/* 316 */&lt;/span&gt;       agg_doAggregateWithKeys();
&lt;span class=&quot;code-comment&quot;&gt;/* 317 */&lt;/span&gt;       wholestagecodegen_aggTime.add((&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.nanoTime() - wholestagecodegen_beforeAgg) / 1000000);
&lt;span class=&quot;code-comment&quot;&gt;/* 318 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 319 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 320 */&lt;/span&gt;     &lt;span class=&quot;code-comment&quot;&gt;// output the result
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 321 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 322 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (agg_vectorizedHashMapIter.hasNext()) {
&lt;span class=&quot;code-comment&quot;&gt;/* 323 */&lt;/span&gt;       wholestagecodegen_numOutputRows.add(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 324 */&lt;/span&gt;       org.apache.spark.sql.execution.vectorized.ColumnarBatch.Row wholestagecodegen_vectorizedHashMapRow =
&lt;span class=&quot;code-comment&quot;&gt;/* 325 */&lt;/span&gt;       (org.apache.spark.sql.execution.vectorized.ColumnarBatch.Row)
&lt;span class=&quot;code-comment&quot;&gt;/* 326 */&lt;/span&gt;       agg_vectorizedHashMapIter.next();
&lt;span class=&quot;code-comment&quot;&gt;/* 327 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 328 */&lt;/span&gt;       wholestagecodegen_holder.reset();
&lt;span class=&quot;code-comment&quot;&gt;/* 329 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 330 */&lt;/span&gt;       wholestagecodegen_rowWriter.zeroOutNullBytes();
&lt;span class=&quot;code-comment&quot;&gt;/* 331 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 332 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; wholestagecodegen_isNull = wholestagecodegen_vectorizedHashMapRow.isNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 333 */&lt;/span&gt;       UTF8String wholestagecodegen_value = wholestagecodegen_isNull ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (wholestagecodegen_vectorizedHashMapRow.getUTF8String(0));
&lt;span class=&quot;code-comment&quot;&gt;/* 334 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (wholestagecodegen_isNull) {
&lt;span class=&quot;code-comment&quot;&gt;/* 335 */&lt;/span&gt;         wholestagecodegen_rowWriter.setNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 336 */&lt;/span&gt;       } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 337 */&lt;/span&gt;         wholestagecodegen_rowWriter.write(0, wholestagecodegen_value);
&lt;span class=&quot;code-comment&quot;&gt;/* 338 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 339 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 340 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; wholestagecodegen_isNull1 = wholestagecodegen_vectorizedHashMapRow.isNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 341 */&lt;/span&gt;       UTF8String wholestagecodegen_value1 = wholestagecodegen_isNull1 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (wholestagecodegen_vectorizedHashMapRow.getUTF8String(1));
&lt;span class=&quot;code-comment&quot;&gt;/* 342 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (wholestagecodegen_isNull1) {
&lt;span class=&quot;code-comment&quot;&gt;/* 343 */&lt;/span&gt;         wholestagecodegen_rowWriter.setNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 344 */&lt;/span&gt;       } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 345 */&lt;/span&gt;         wholestagecodegen_rowWriter.write(1, wholestagecodegen_value1);
&lt;span class=&quot;code-comment&quot;&gt;/* 346 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 347 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 348 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; wholestagecodegen_value2 = wholestagecodegen_vectorizedHashMapRow.getLong(2);
&lt;span class=&quot;code-comment&quot;&gt;/* 349 */&lt;/span&gt;       wholestagecodegen_rowWriter.write(2, wholestagecodegen_value2);
&lt;span class=&quot;code-comment&quot;&gt;/* 350 */&lt;/span&gt;       wholestagecodegen_result.setTotalSize(wholestagecodegen_holder.totalSize());
&lt;span class=&quot;code-comment&quot;&gt;/* 351 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 352 */&lt;/span&gt;       append(wholestagecodegen_result);
&lt;span class=&quot;code-comment&quot;&gt;/* 353 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 354 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldStop()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 355 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 356 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 357 */&lt;/span&gt;     agg_vectorizedHashMap.close();
&lt;span class=&quot;code-comment&quot;&gt;/* 358 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 359 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (agg_mapIter.next()) {
&lt;span class=&quot;code-comment&quot;&gt;/* 360 */&lt;/span&gt;       wholestagecodegen_numOutputRows.add(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 361 */&lt;/span&gt;       UnsafeRow agg_aggKey = (UnsafeRow) agg_mapIter.getKey();
&lt;span class=&quot;code-comment&quot;&gt;/* 362 */&lt;/span&gt;       UnsafeRow agg_aggBuffer = (UnsafeRow) agg_mapIter.getValue();
&lt;span class=&quot;code-comment&quot;&gt;/* 363 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 364 */&lt;/span&gt;       UnsafeRow agg_resultRow = agg_unsafeRowJoiner.join(agg_aggKey, agg_aggBuffer);
&lt;span class=&quot;code-comment&quot;&gt;/* 365 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 366 */&lt;/span&gt;       append(agg_resultRow);
&lt;span class=&quot;code-comment&quot;&gt;/* 367 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 368 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldStop()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 369 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 370 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 371 */&lt;/span&gt;     agg_mapIter.close();
&lt;span class=&quot;code-comment&quot;&gt;/* 372 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_sorter == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 373 */&lt;/span&gt;       agg_hashMap.free();
&lt;span class=&quot;code-comment&quot;&gt;/* 374 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 375 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 376 */&lt;/span&gt; }

== Subtree 2 / 5 ==
*Project [Origin#16, UniqueCarrier#8, round((&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;((count#134L * 100) as &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;) / &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(total#97L as &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;)), 2) AS rank#173]
+- *SortMergeJoin [Origin#16, UniqueCarrier#8], [Origin#155, UniqueCarrier#147], Inner
   :- *Sort [Origin#16 ASC, UniqueCarrier#8 ASC], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, 0
   :  +- *HashAggregate(key=[Origin#16,UniqueCarrier#8], functions=[count(1)], output=[Origin#16,UniqueCarrier#8,count#134L])
   :     +- Exchange hashpartitioning(Origin#16, UniqueCarrier#8, 200)
   :        +- *HashAggregate(key=[Origin#16,UniqueCarrier#8], functions=[partial_count(1)], output=[Origin#16,UniqueCarrier#8,count#296L])
   :           +- *Project [UniqueCarrier#8, Origin#16]
   :              +- *Filter (((((((isnotnull(Origin#16) &amp;amp;&amp;amp; isnotnull(UniqueCarrier#8)) &amp;amp;&amp;amp; isnotnull(Cancelled#21)) &amp;amp;&amp;amp; isnotnull(CancellationCode#22)) &amp;amp;&amp;amp; NOT (Cancelled#21 = 0)) &amp;amp;&amp;amp; (CancellationCode#22 = A)) &amp;amp;&amp;amp; isnotnull(Dest#17)) &amp;amp;&amp;amp; (Dest#17 = ORD))
   :                 +- *Scan csv [UniqueCarrier#8,Origin#16,Dest#17,Cancelled#21,CancellationCode#22] Format: CSV, InputPaths: file:/home/robbins/brandberry/2008.csv, PushedFilters: [IsNotNull(Origin), IsNotNull(UniqueCarrier), IsNotNull(Cancelled), IsNotNull(CancellationCode), ..., ReadSchema: struct&amp;lt;UniqueCarrier:string,Origin:string,Dest:string,Cancelled:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,CancellationCode:string&amp;gt;
   +- *Sort [Origin#155 ASC, UniqueCarrier#147 ASC], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, 0
      +- *HashAggregate(key=[Origin#155,UniqueCarrier#147], functions=[count(1)], output=[Origin#155,UniqueCarrier#147,total#97L])
         +- Exchange hashpartitioning(Origin#155, UniqueCarrier#147, 200)
            +- *HashAggregate(key=[Origin#155,UniqueCarrier#147], functions=[partial_count(1)], output=[Origin#155,UniqueCarrier#147,count#303L])
               +- *Project [UniqueCarrier#147, Origin#155]
                  +- *Filter (((isnotnull(UniqueCarrier#147) &amp;amp;&amp;amp; isnotnull(Origin#155)) &amp;amp;&amp;amp; isnotnull(Dest#156)) &amp;amp;&amp;amp; (Dest#156 = ORD))
                     +- *Scan csv [UniqueCarrier#147,Origin#155,Dest#156] Format: CSV, InputPaths: file:/home/robbins/brandberry/2008.csv, PushedFilters: [IsNotNull(UniqueCarrier), IsNotNull(Origin), IsNotNull(Dest), EqualTo(Dest,ORD)], ReadSchema: struct&amp;lt;UniqueCarrier:string,Origin:string,Dest:string&amp;gt;

Generated code:
&lt;span class=&quot;code-comment&quot;&gt;/* 001 */&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; generate(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references) {
&lt;span class=&quot;code-comment&quot;&gt;/* 002 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GeneratedIterator(references);
&lt;span class=&quot;code-comment&quot;&gt;/* 003 */&lt;/span&gt; }
&lt;span class=&quot;code-comment&quot;&gt;/* 004 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 005 */&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;GeneratedIterator &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; org.apache.spark.sql.execution.BufferedRowIterator {
&lt;span class=&quot;code-comment&quot;&gt;/* 006 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references;
&lt;span class=&quot;code-comment&quot;&gt;/* 007 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; scala.collection.Iterator smj_leftInput;
&lt;span class=&quot;code-comment&quot;&gt;/* 008 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; scala.collection.Iterator smj_rightInput;
&lt;span class=&quot;code-comment&quot;&gt;/* 009 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; InternalRow smj_leftRow;
&lt;span class=&quot;code-comment&quot;&gt;/* 010 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; InternalRow smj_rightRow;
&lt;span class=&quot;code-comment&quot;&gt;/* 011 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UTF8String smj_value4;
&lt;span class=&quot;code-comment&quot;&gt;/* 012 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UTF8String smj_value5;
&lt;span class=&quot;code-comment&quot;&gt;/* 013 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; java.util.ArrayList smj_matches;
&lt;span class=&quot;code-comment&quot;&gt;/* 014 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UTF8String smj_value6;
&lt;span class=&quot;code-comment&quot;&gt;/* 015 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UTF8String smj_value7;
&lt;span class=&quot;code-comment&quot;&gt;/* 016 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UTF8String smj_value8;
&lt;span class=&quot;code-comment&quot;&gt;/* 017 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; smj_isNull4;
&lt;span class=&quot;code-comment&quot;&gt;/* 018 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UTF8String smj_value9;
&lt;span class=&quot;code-comment&quot;&gt;/* 019 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; smj_isNull5;
&lt;span class=&quot;code-comment&quot;&gt;/* 020 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; smj_value10;
&lt;span class=&quot;code-comment&quot;&gt;/* 021 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric smj_numOutputRows;
&lt;span class=&quot;code-comment&quot;&gt;/* 022 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UnsafeRow smj_result;
&lt;span class=&quot;code-comment&quot;&gt;/* 023 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder smj_holder;
&lt;span class=&quot;code-comment&quot;&gt;/* 024 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter smj_rowWriter;
&lt;span class=&quot;code-comment&quot;&gt;/* 025 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UnsafeRow project_result;
&lt;span class=&quot;code-comment&quot;&gt;/* 026 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder project_holder;
&lt;span class=&quot;code-comment&quot;&gt;/* 027 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter project_rowWriter;
&lt;span class=&quot;code-comment&quot;&gt;/* 028 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 029 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; GeneratedIterator(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references) {
&lt;span class=&quot;code-comment&quot;&gt;/* 030 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.references = references;
&lt;span class=&quot;code-comment&quot;&gt;/* 031 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 032 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 033 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void init(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; index, scala.collection.Iterator inputs[]) {
&lt;span class=&quot;code-comment&quot;&gt;/* 034 */&lt;/span&gt;     partitionIndex = index;
&lt;span class=&quot;code-comment&quot;&gt;/* 035 */&lt;/span&gt;     smj_leftInput = inputs[0];
&lt;span class=&quot;code-comment&quot;&gt;/* 036 */&lt;/span&gt;     smj_rightInput = inputs[1];
&lt;span class=&quot;code-comment&quot;&gt;/* 037 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 038 */&lt;/span&gt;     smj_rightRow = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 039 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 040 */&lt;/span&gt;     smj_matches = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; java.util.ArrayList();
&lt;span class=&quot;code-comment&quot;&gt;/* 041 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 042 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.smj_numOutputRows = (org.apache.spark.sql.execution.metric.SQLMetric) references[0];
&lt;span class=&quot;code-comment&quot;&gt;/* 043 */&lt;/span&gt;     smj_result = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow(6);
&lt;span class=&quot;code-comment&quot;&gt;/* 044 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.smj_holder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder(smj_result, 128);
&lt;span class=&quot;code-comment&quot;&gt;/* 045 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.smj_rowWriter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(smj_holder, 6);
&lt;span class=&quot;code-comment&quot;&gt;/* 046 */&lt;/span&gt;     project_result = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow(3);
&lt;span class=&quot;code-comment&quot;&gt;/* 047 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.project_holder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder(project_result, 64);
&lt;span class=&quot;code-comment&quot;&gt;/* 048 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.project_rowWriter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(project_holder, 3);
&lt;span class=&quot;code-comment&quot;&gt;/* 049 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 050 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 051 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; findNextInnerJoinRows(
&lt;span class=&quot;code-comment&quot;&gt;/* 052 */&lt;/span&gt;     scala.collection.Iterator leftIter,
&lt;span class=&quot;code-comment&quot;&gt;/* 053 */&lt;/span&gt;     scala.collection.Iterator rightIter) {
&lt;span class=&quot;code-comment&quot;&gt;/* 054 */&lt;/span&gt;     smj_leftRow = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 055 */&lt;/span&gt;     &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; comp = 0;
&lt;span class=&quot;code-comment&quot;&gt;/* 056 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (smj_leftRow == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 057 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!leftIter.hasNext()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 058 */&lt;/span&gt;       smj_leftRow = (InternalRow) leftIter.next();
&lt;span class=&quot;code-comment&quot;&gt;/* 059 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 060 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; smj_isNull = smj_leftRow.isNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 061 */&lt;/span&gt;       UTF8String smj_value = smj_isNull ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (smj_leftRow.getUTF8String(0));
&lt;span class=&quot;code-comment&quot;&gt;/* 062 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 063 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; smj_isNull1 = smj_leftRow.isNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 064 */&lt;/span&gt;       UTF8String smj_value1 = smj_isNull1 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (smj_leftRow.getUTF8String(1));
&lt;span class=&quot;code-comment&quot;&gt;/* 065 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (smj_isNull || smj_isNull1) {
&lt;span class=&quot;code-comment&quot;&gt;/* 066 */&lt;/span&gt;         smj_leftRow = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 067 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 068 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 069 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!smj_matches.isEmpty()) {
&lt;span class=&quot;code-comment&quot;&gt;/* 070 */&lt;/span&gt;         comp = 0;
&lt;span class=&quot;code-comment&quot;&gt;/* 071 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comp == 0) {
&lt;span class=&quot;code-comment&quot;&gt;/* 072 */&lt;/span&gt;           comp = smj_value.compare(smj_value6);
&lt;span class=&quot;code-comment&quot;&gt;/* 073 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 074 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comp == 0) {
&lt;span class=&quot;code-comment&quot;&gt;/* 075 */&lt;/span&gt;           comp = smj_value1.compare(smj_value7);
&lt;span class=&quot;code-comment&quot;&gt;/* 076 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 077 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 078 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comp == 0) {
&lt;span class=&quot;code-comment&quot;&gt;/* 079 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 080 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 081 */&lt;/span&gt;         smj_matches.clear();
&lt;span class=&quot;code-comment&quot;&gt;/* 082 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 083 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 084 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 085 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (smj_rightRow == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 086 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!rightIter.hasNext()) {
&lt;span class=&quot;code-comment&quot;&gt;/* 087 */&lt;/span&gt;             smj_value6 = smj_value;
&lt;span class=&quot;code-comment&quot;&gt;/* 088 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 089 */&lt;/span&gt;             smj_value7 = smj_value1;
&lt;span class=&quot;code-comment&quot;&gt;/* 090 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 091 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; !smj_matches.isEmpty();
&lt;span class=&quot;code-comment&quot;&gt;/* 092 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 093 */&lt;/span&gt;           smj_rightRow = (InternalRow) rightIter.next();
&lt;span class=&quot;code-comment&quot;&gt;/* 094 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 095 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; smj_isNull2 = smj_rightRow.isNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 096 */&lt;/span&gt;           UTF8String smj_value2 = smj_isNull2 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (smj_rightRow.getUTF8String(0));
&lt;span class=&quot;code-comment&quot;&gt;/* 097 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 098 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; smj_isNull3 = smj_rightRow.isNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 099 */&lt;/span&gt;           UTF8String smj_value3 = smj_isNull3 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (smj_rightRow.getUTF8String(1));
&lt;span class=&quot;code-comment&quot;&gt;/* 100 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (smj_isNull2 || smj_isNull3) {
&lt;span class=&quot;code-comment&quot;&gt;/* 101 */&lt;/span&gt;             smj_rightRow = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 102 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 103 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 104 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 105 */&lt;/span&gt;           smj_value4 = smj_value2;
&lt;span class=&quot;code-comment&quot;&gt;/* 106 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 107 */&lt;/span&gt;           smj_value5 = smj_value3;
&lt;span class=&quot;code-comment&quot;&gt;/* 108 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 109 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 110 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 111 */&lt;/span&gt;         comp = 0;
&lt;span class=&quot;code-comment&quot;&gt;/* 112 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comp == 0) {
&lt;span class=&quot;code-comment&quot;&gt;/* 113 */&lt;/span&gt;           comp = smj_value.compare(smj_value4);
&lt;span class=&quot;code-comment&quot;&gt;/* 114 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 115 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comp == 0) {
&lt;span class=&quot;code-comment&quot;&gt;/* 116 */&lt;/span&gt;           comp = smj_value1.compare(smj_value5);
&lt;span class=&quot;code-comment&quot;&gt;/* 117 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 118 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 119 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comp &amp;gt; 0) {
&lt;span class=&quot;code-comment&quot;&gt;/* 120 */&lt;/span&gt;           smj_rightRow = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 121 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comp &amp;lt; 0) {
&lt;span class=&quot;code-comment&quot;&gt;/* 122 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!smj_matches.isEmpty()) {
&lt;span class=&quot;code-comment&quot;&gt;/* 123 */&lt;/span&gt;             smj_value6 = smj_value;
&lt;span class=&quot;code-comment&quot;&gt;/* 124 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 125 */&lt;/span&gt;             smj_value7 = smj_value1;
&lt;span class=&quot;code-comment&quot;&gt;/* 126 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 127 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 128 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 129 */&lt;/span&gt;           smj_leftRow = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 130 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 131 */&lt;/span&gt;           smj_matches.add(smj_rightRow.copy());
&lt;span class=&quot;code-comment&quot;&gt;/* 132 */&lt;/span&gt;           smj_rightRow = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;;
&lt;span class=&quot;code-comment&quot;&gt;/* 133 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 134 */&lt;/span&gt;       } &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (smj_leftRow != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
&lt;span class=&quot;code-comment&quot;&gt;/* 135 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 136 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;// unreachable
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 137 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 138 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 139 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void processNext() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
&lt;span class=&quot;code-comment&quot;&gt;/* 140 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (findNextInnerJoinRows(smj_leftInput, smj_rightInput)) {
&lt;span class=&quot;code-comment&quot;&gt;/* 141 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; smj_size = smj_matches.size();
&lt;span class=&quot;code-comment&quot;&gt;/* 142 */&lt;/span&gt;       smj_isNull4 = smj_leftRow.isNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 143 */&lt;/span&gt;       smj_value8 = smj_isNull4 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (smj_leftRow.getUTF8String(0));
&lt;span class=&quot;code-comment&quot;&gt;/* 144 */&lt;/span&gt;       smj_isNull5 = smj_leftRow.isNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 145 */&lt;/span&gt;       smj_value9 = smj_isNull5 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (smj_leftRow.getUTF8String(1));
&lt;span class=&quot;code-comment&quot;&gt;/* 146 */&lt;/span&gt;       smj_value10 = smj_leftRow.getLong(2);
&lt;span class=&quot;code-comment&quot;&gt;/* 147 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; smj_i = 0; smj_i &amp;lt; smj_size; smj_i ++) {
&lt;span class=&quot;code-comment&quot;&gt;/* 148 */&lt;/span&gt;         InternalRow smj_rightRow1 = (InternalRow) smj_matches.get(smj_i);
&lt;span class=&quot;code-comment&quot;&gt;/* 149 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 150 */&lt;/span&gt;         smj_numOutputRows.add(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 151 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 152 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; smj_value13 = smj_rightRow1.getLong(2);
&lt;span class=&quot;code-comment&quot;&gt;/* 153 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; project_isNull8 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 154 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; project_value8 = -1.0;
&lt;span class=&quot;code-comment&quot;&gt;/* 155 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 156 */&lt;/span&gt;           project_value8 = (&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;) smj_value13;
&lt;span class=&quot;code-comment&quot;&gt;/* 157 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 158 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; project_isNull3 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 159 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; project_value3 = -1.0;
&lt;span class=&quot;code-comment&quot;&gt;/* 160 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (project_value8 == 0) {
&lt;span class=&quot;code-comment&quot;&gt;/* 161 */&lt;/span&gt;           project_isNull3 = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 162 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 163 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; project_value5 = -1L;
&lt;span class=&quot;code-comment&quot;&gt;/* 164 */&lt;/span&gt;           project_value5 = smj_value10 * 100L;
&lt;span class=&quot;code-comment&quot;&gt;/* 165 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; project_isNull4 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 166 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; project_value4 = -1.0;
&lt;span class=&quot;code-comment&quot;&gt;/* 167 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 168 */&lt;/span&gt;             project_value4 = (&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;) project_value5;
&lt;span class=&quot;code-comment&quot;&gt;/* 169 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 170 */&lt;/span&gt;           project_value3 = (&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;)(project_value4 / project_value8);
&lt;span class=&quot;code-comment&quot;&gt;/* 171 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 172 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; project_isNull2 = project_isNull3;
&lt;span class=&quot;code-comment&quot;&gt;/* 173 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; project_value2 = -1.0;
&lt;span class=&quot;code-comment&quot;&gt;/* 174 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!project_isNull2) {
&lt;span class=&quot;code-comment&quot;&gt;/* 175 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;.isNaN(project_value3) || &lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;.isInfinite(project_value3)) {
&lt;span class=&quot;code-comment&quot;&gt;/* 176 */&lt;/span&gt;             project_value2 = project_value3;
&lt;span class=&quot;code-comment&quot;&gt;/* 177 */&lt;/span&gt;           } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 178 */&lt;/span&gt;             project_value2 = java.math.BigDecimal.valueOf(project_value3).
&lt;span class=&quot;code-comment&quot;&gt;/* 179 */&lt;/span&gt;             setScale(2, java.math.BigDecimal.ROUND_HALF_UP).doubleValue();
&lt;span class=&quot;code-comment&quot;&gt;/* 180 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 181 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 182 */&lt;/span&gt;         project_holder.reset();
&lt;span class=&quot;code-comment&quot;&gt;/* 183 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 184 */&lt;/span&gt;         project_rowWriter.zeroOutNullBytes();
&lt;span class=&quot;code-comment&quot;&gt;/* 185 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 186 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (smj_isNull4) {
&lt;span class=&quot;code-comment&quot;&gt;/* 187 */&lt;/span&gt;           project_rowWriter.setNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 188 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 189 */&lt;/span&gt;           project_rowWriter.write(0, smj_value8);
&lt;span class=&quot;code-comment&quot;&gt;/* 190 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 191 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 192 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (smj_isNull5) {
&lt;span class=&quot;code-comment&quot;&gt;/* 193 */&lt;/span&gt;           project_rowWriter.setNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 194 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 195 */&lt;/span&gt;           project_rowWriter.write(1, smj_value9);
&lt;span class=&quot;code-comment&quot;&gt;/* 196 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 197 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 198 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (project_isNull2) {
&lt;span class=&quot;code-comment&quot;&gt;/* 199 */&lt;/span&gt;           project_rowWriter.setNullAt(2);
&lt;span class=&quot;code-comment&quot;&gt;/* 200 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 201 */&lt;/span&gt;           project_rowWriter.write(2, project_value2);
&lt;span class=&quot;code-comment&quot;&gt;/* 202 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 203 */&lt;/span&gt;         project_result.setTotalSize(project_holder.totalSize());
&lt;span class=&quot;code-comment&quot;&gt;/* 204 */&lt;/span&gt;         append(project_result.copy());
&lt;span class=&quot;code-comment&quot;&gt;/* 205 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 206 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 207 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldStop()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 208 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 209 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 210 */&lt;/span&gt; }

== Subtree 3 / 5 ==
*HashAggregate(key=[Origin#155,UniqueCarrier#147], functions=[partial_count(1)], output=[Origin#155,UniqueCarrier#147,count#303L])
+- *Project [UniqueCarrier#147, Origin#155]
   +- *Filter (((isnotnull(UniqueCarrier#147) &amp;amp;&amp;amp; isnotnull(Origin#155)) &amp;amp;&amp;amp; isnotnull(Dest#156)) &amp;amp;&amp;amp; (Dest#156 = ORD))
      +- *Scan csv [UniqueCarrier#147,Origin#155,Dest#156] Format: CSV, InputPaths: file:/home/robbins/brandberry/2008.csv, PushedFilters: [IsNotNull(UniqueCarrier), IsNotNull(Origin), IsNotNull(Dest), EqualTo(Dest,ORD)], ReadSchema: struct&amp;lt;UniqueCarrier:string,Origin:string,Dest:string&amp;gt;

Generated code:
&lt;span class=&quot;code-comment&quot;&gt;/* 001 */&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; generate(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references) {
&lt;span class=&quot;code-comment&quot;&gt;/* 002 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GeneratedIterator(references);
&lt;span class=&quot;code-comment&quot;&gt;/* 003 */&lt;/span&gt; }
&lt;span class=&quot;code-comment&quot;&gt;/* 004 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 005 */&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;GeneratedIterator &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; org.apache.spark.sql.execution.BufferedRowIterator {
&lt;span class=&quot;code-comment&quot;&gt;/* 006 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references;
&lt;span class=&quot;code-comment&quot;&gt;/* 007 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_initAgg;
&lt;span class=&quot;code-comment&quot;&gt;/* 008 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_bufIsNull;
&lt;span class=&quot;code-comment&quot;&gt;/* 009 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_bufValue;
&lt;span class=&quot;code-comment&quot;&gt;/* 010 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; agg_VectorizedHashMap agg_vectorizedHashMap;
&lt;span class=&quot;code-comment&quot;&gt;/* 011 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; java.util.Iterator&amp;lt;org.apache.spark.sql.execution.vectorized.ColumnarBatch.Row&amp;gt; agg_vectorizedHashMapIter;
&lt;span class=&quot;code-comment&quot;&gt;/* 012 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.aggregate.HashAggregateExec agg_plan;
&lt;span class=&quot;code-comment&quot;&gt;/* 013 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.UnsafeFixedWidthAggregationMap agg_hashMap;
&lt;span class=&quot;code-comment&quot;&gt;/* 014 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.UnsafeKVExternalSorter agg_sorter;
&lt;span class=&quot;code-comment&quot;&gt;/* 015 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.unsafe.KVIterator agg_mapIter;
&lt;span class=&quot;code-comment&quot;&gt;/* 016 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric agg_peakMemory;
&lt;span class=&quot;code-comment&quot;&gt;/* 017 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric agg_spillSize;
&lt;span class=&quot;code-comment&quot;&gt;/* 018 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric scan_numOutputRows;
&lt;span class=&quot;code-comment&quot;&gt;/* 019 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; scala.collection.Iterator scan_input;
&lt;span class=&quot;code-comment&quot;&gt;/* 020 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric filter_numOutputRows;
&lt;span class=&quot;code-comment&quot;&gt;/* 021 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UnsafeRow filter_result;
&lt;span class=&quot;code-comment&quot;&gt;/* 022 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder filter_holder;
&lt;span class=&quot;code-comment&quot;&gt;/* 023 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter filter_rowWriter;
&lt;span class=&quot;code-comment&quot;&gt;/* 024 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UnsafeRow project_result;
&lt;span class=&quot;code-comment&quot;&gt;/* 025 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder project_holder;
&lt;span class=&quot;code-comment&quot;&gt;/* 026 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter project_rowWriter;
&lt;span class=&quot;code-comment&quot;&gt;/* 027 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UnsafeRow agg_result2;
&lt;span class=&quot;code-comment&quot;&gt;/* 028 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder agg_holder;
&lt;span class=&quot;code-comment&quot;&gt;/* 029 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter agg_rowWriter;
&lt;span class=&quot;code-comment&quot;&gt;/* 030 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowJoiner agg_unsafeRowJoiner;
&lt;span class=&quot;code-comment&quot;&gt;/* 031 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric wholestagecodegen_numOutputRows;
&lt;span class=&quot;code-comment&quot;&gt;/* 032 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric wholestagecodegen_aggTime;
&lt;span class=&quot;code-comment&quot;&gt;/* 033 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UnsafeRow wholestagecodegen_result;
&lt;span class=&quot;code-comment&quot;&gt;/* 034 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder wholestagecodegen_holder;
&lt;span class=&quot;code-comment&quot;&gt;/* 035 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter wholestagecodegen_rowWriter;
&lt;span class=&quot;code-comment&quot;&gt;/* 036 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 037 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; GeneratedIterator(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references) {
&lt;span class=&quot;code-comment&quot;&gt;/* 038 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.references = references;
&lt;span class=&quot;code-comment&quot;&gt;/* 039 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 040 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 041 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void init(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; index, scala.collection.Iterator inputs[]) {
&lt;span class=&quot;code-comment&quot;&gt;/* 042 */&lt;/span&gt;     partitionIndex = index;
&lt;span class=&quot;code-comment&quot;&gt;/* 043 */&lt;/span&gt;     agg_initAgg = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 044 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 045 */&lt;/span&gt;     agg_vectorizedHashMap = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; agg_VectorizedHashMap();
&lt;span class=&quot;code-comment&quot;&gt;/* 046 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 047 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_plan = (org.apache.spark.sql.execution.aggregate.HashAggregateExec) references[0];
&lt;span class=&quot;code-comment&quot;&gt;/* 048 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 049 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_peakMemory = (org.apache.spark.sql.execution.metric.SQLMetric) references[1];
&lt;span class=&quot;code-comment&quot;&gt;/* 050 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_spillSize = (org.apache.spark.sql.execution.metric.SQLMetric) references[2];
&lt;span class=&quot;code-comment&quot;&gt;/* 051 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.scan_numOutputRows = (org.apache.spark.sql.execution.metric.SQLMetric) references[3];
&lt;span class=&quot;code-comment&quot;&gt;/* 052 */&lt;/span&gt;     scan_input = inputs[0];
&lt;span class=&quot;code-comment&quot;&gt;/* 053 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.filter_numOutputRows = (org.apache.spark.sql.execution.metric.SQLMetric) references[4];
&lt;span class=&quot;code-comment&quot;&gt;/* 054 */&lt;/span&gt;     filter_result = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow(3);
&lt;span class=&quot;code-comment&quot;&gt;/* 055 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.filter_holder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder(filter_result, 96);
&lt;span class=&quot;code-comment&quot;&gt;/* 056 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.filter_rowWriter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(filter_holder, 3);
&lt;span class=&quot;code-comment&quot;&gt;/* 057 */&lt;/span&gt;     project_result = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow(2);
&lt;span class=&quot;code-comment&quot;&gt;/* 058 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.project_holder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder(project_result, 64);
&lt;span class=&quot;code-comment&quot;&gt;/* 059 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.project_rowWriter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(project_holder, 2);
&lt;span class=&quot;code-comment&quot;&gt;/* 060 */&lt;/span&gt;     agg_result2 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow(2);
&lt;span class=&quot;code-comment&quot;&gt;/* 061 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_holder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder(agg_result2, 64);
&lt;span class=&quot;code-comment&quot;&gt;/* 062 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_rowWriter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(agg_holder, 2);
&lt;span class=&quot;code-comment&quot;&gt;/* 063 */&lt;/span&gt;     agg_unsafeRowJoiner = agg_plan.createUnsafeJoiner();
&lt;span class=&quot;code-comment&quot;&gt;/* 064 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.wholestagecodegen_numOutputRows = (org.apache.spark.sql.execution.metric.SQLMetric) references[6];
&lt;span class=&quot;code-comment&quot;&gt;/* 065 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.wholestagecodegen_aggTime = (org.apache.spark.sql.execution.metric.SQLMetric) references[7];
&lt;span class=&quot;code-comment&quot;&gt;/* 066 */&lt;/span&gt;     wholestagecodegen_result = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow(3);
&lt;span class=&quot;code-comment&quot;&gt;/* 067 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.wholestagecodegen_holder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder(wholestagecodegen_result, 64);
&lt;span class=&quot;code-comment&quot;&gt;/* 068 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.wholestagecodegen_rowWriter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(wholestagecodegen_holder, 3);
&lt;span class=&quot;code-comment&quot;&gt;/* 069 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 070 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 071 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;agg_VectorizedHashMap {
&lt;span class=&quot;code-comment&quot;&gt;/* 072 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.vectorized.ColumnarBatch batch;
&lt;span class=&quot;code-comment&quot;&gt;/* 073 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.vectorized.ColumnarBatch aggregateBufferBatch;
&lt;span class=&quot;code-comment&quot;&gt;/* 074 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;[] buckets;
&lt;span class=&quot;code-comment&quot;&gt;/* 075 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; capacity = 1 &amp;lt;&amp;lt; 16;
&lt;span class=&quot;code-comment&quot;&gt;/* 076 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; loadFactor = 0.5;
&lt;span class=&quot;code-comment&quot;&gt;/* 077 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; numBuckets = (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) (capacity / loadFactor);
&lt;span class=&quot;code-comment&quot;&gt;/* 078 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxSteps = 2;
&lt;span class=&quot;code-comment&quot;&gt;/* 079 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; numRows = 0;
&lt;span class=&quot;code-comment&quot;&gt;/* 080 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.types.StructType schema = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.types.StructType().add(&lt;span class=&quot;code-quote&quot;&gt;&quot;Origin&quot;&lt;/span&gt;, org.apache.spark.sql.types.DataTypes.StringType)
&lt;span class=&quot;code-comment&quot;&gt;/* 081 */&lt;/span&gt;     .add(&lt;span class=&quot;code-quote&quot;&gt;&quot;UniqueCarrier&quot;&lt;/span&gt;, org.apache.spark.sql.types.DataTypes.StringType)
&lt;span class=&quot;code-comment&quot;&gt;/* 082 */&lt;/span&gt;     .add(&lt;span class=&quot;code-quote&quot;&gt;&quot;count&quot;&lt;/span&gt;, org.apache.spark.sql.types.DataTypes.LongType);
&lt;span class=&quot;code-comment&quot;&gt;/* 083 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.types.StructType aggregateBufferSchema =
&lt;span class=&quot;code-comment&quot;&gt;/* 084 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.types.StructType().add(&lt;span class=&quot;code-quote&quot;&gt;&quot;count&quot;&lt;/span&gt;, org.apache.spark.sql.types.DataTypes.LongType);
&lt;span class=&quot;code-comment&quot;&gt;/* 085 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 086 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; agg_VectorizedHashMap() {
&lt;span class=&quot;code-comment&quot;&gt;/* 087 */&lt;/span&gt;       batch = org.apache.spark.sql.execution.vectorized.ColumnarBatch.allocate(schema,
&lt;span class=&quot;code-comment&quot;&gt;/* 088 */&lt;/span&gt;         org.apache.spark.memory.MemoryMode.ON_HEAP, capacity);
&lt;span class=&quot;code-comment&quot;&gt;/* 089 */&lt;/span&gt;       &lt;span class=&quot;code-comment&quot;&gt;// TODO: Possibly generate &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; projection in HashAggregate directly
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 090 */&lt;/span&gt;       aggregateBufferBatch = org.apache.spark.sql.execution.vectorized.ColumnarBatch.allocate(
&lt;span class=&quot;code-comment&quot;&gt;/* 091 */&lt;/span&gt;         aggregateBufferSchema, org.apache.spark.memory.MemoryMode.ON_HEAP, capacity);
&lt;span class=&quot;code-comment&quot;&gt;/* 092 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0 ; i &amp;lt; aggregateBufferBatch.numCols(); i++) {
&lt;span class=&quot;code-comment&quot;&gt;/* 093 */&lt;/span&gt;         aggregateBufferBatch.setColumn(i, batch.column(i+2));
&lt;span class=&quot;code-comment&quot;&gt;/* 094 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 095 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 096 */&lt;/span&gt;       buckets = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;[numBuckets];
&lt;span class=&quot;code-comment&quot;&gt;/* 097 */&lt;/span&gt;       java.util.Arrays.fill(buckets, -1);
&lt;span class=&quot;code-comment&quot;&gt;/* 098 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 099 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 100 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; org.apache.spark.sql.execution.vectorized.ColumnarBatch.Row findOrInsert(UTF8String agg_key, UTF8String agg_key1) {
&lt;span class=&quot;code-comment&quot;&gt;/* 101 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; h = hash(agg_key, agg_key1);
&lt;span class=&quot;code-comment&quot;&gt;/* 102 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; step = 0;
&lt;span class=&quot;code-comment&quot;&gt;/* 103 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; idx = (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) h &amp;amp; (numBuckets - 1);
&lt;span class=&quot;code-comment&quot;&gt;/* 104 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (step &amp;lt; maxSteps) {
&lt;span class=&quot;code-comment&quot;&gt;/* 105 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// Return bucket index &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it&apos;s either an empty slot or already contains the key
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 106 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (buckets[idx] == -1) {
&lt;span class=&quot;code-comment&quot;&gt;/* 107 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (numRows &amp;lt; capacity) {
&lt;span class=&quot;code-comment&quot;&gt;/* 108 */&lt;/span&gt;             &lt;span class=&quot;code-comment&quot;&gt;// Initialize aggregate keys
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 109 */&lt;/span&gt;             batch.column(0).putByteArray(numRows, agg_key.getBytes());
&lt;span class=&quot;code-comment&quot;&gt;/* 110 */&lt;/span&gt;             batch.column(1).putByteArray(numRows, agg_key1.getBytes());
&lt;span class=&quot;code-comment&quot;&gt;/* 111 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 112 */&lt;/span&gt;             agg_bufIsNull = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 113 */&lt;/span&gt;             agg_bufValue = 0L;
&lt;span class=&quot;code-comment&quot;&gt;/* 114 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 115 */&lt;/span&gt;             &lt;span class=&quot;code-comment&quot;&gt;// Initialize aggregate values
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 116 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 117 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_bufIsNull) {
&lt;span class=&quot;code-comment&quot;&gt;/* 118 */&lt;/span&gt;               batch.column(2).putLong(numRows, agg_bufValue);
&lt;span class=&quot;code-comment&quot;&gt;/* 119 */&lt;/span&gt;             } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 120 */&lt;/span&gt;               batch.column(2).putNull(numRows);
&lt;span class=&quot;code-comment&quot;&gt;/* 121 */&lt;/span&gt;             }
&lt;span class=&quot;code-comment&quot;&gt;/* 122 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 123 */&lt;/span&gt;             buckets[idx] = numRows++;
&lt;span class=&quot;code-comment&quot;&gt;/* 124 */&lt;/span&gt;             batch.setNumRows(numRows);
&lt;span class=&quot;code-comment&quot;&gt;/* 125 */&lt;/span&gt;             aggregateBufferBatch.setNumRows(numRows);
&lt;span class=&quot;code-comment&quot;&gt;/* 126 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; aggregateBufferBatch.getRow(buckets[idx]);
&lt;span class=&quot;code-comment&quot;&gt;/* 127 */&lt;/span&gt;           } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 128 */&lt;/span&gt;             &lt;span class=&quot;code-comment&quot;&gt;// No more space
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 129 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 130 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 131 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (equals(idx, agg_key, agg_key1)) {
&lt;span class=&quot;code-comment&quot;&gt;/* 132 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; aggregateBufferBatch.getRow(buckets[idx]);
&lt;span class=&quot;code-comment&quot;&gt;/* 133 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 134 */&lt;/span&gt;         idx = (idx + 1) &amp;amp; (numBuckets - 1);
&lt;span class=&quot;code-comment&quot;&gt;/* 135 */&lt;/span&gt;         step++;
&lt;span class=&quot;code-comment&quot;&gt;/* 136 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 137 */&lt;/span&gt;       &lt;span class=&quot;code-comment&quot;&gt;// Didn&apos;t find it
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 138 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 139 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 140 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 141 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; equals(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; idx, UTF8String agg_key, UTF8String agg_key1) {
&lt;span class=&quot;code-comment&quot;&gt;/* 142 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (batch.column(0).getUTF8String(buckets[idx]).equals(agg_key)) &amp;amp;&amp;amp; (batch.column(1).getUTF8String(buckets[idx]).equals(agg_key1));
&lt;span class=&quot;code-comment&quot;&gt;/* 143 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 144 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 145 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; hash(UTF8String agg_key, UTF8String agg_key1) {
&lt;span class=&quot;code-comment&quot;&gt;/* 146 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_hash = 0;
&lt;span class=&quot;code-comment&quot;&gt;/* 147 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 148 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_result = 0;
&lt;span class=&quot;code-comment&quot;&gt;/* 149 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; agg_key.getBytes().length; i++) {
&lt;span class=&quot;code-comment&quot;&gt;/* 150 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_hash1 = agg_key.getBytes()[i];
&lt;span class=&quot;code-comment&quot;&gt;/* 151 */&lt;/span&gt;         agg_result = (agg_result ^ (0x9e3779b9)) + agg_hash1 + (agg_result &amp;lt;&amp;lt; 6) + (agg_result &amp;gt;&amp;gt;&amp;gt; 2);
&lt;span class=&quot;code-comment&quot;&gt;/* 152 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 153 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 154 */&lt;/span&gt;       agg_hash = (agg_hash ^ (0x9e3779b9)) + agg_result + (agg_hash &amp;lt;&amp;lt; 6) + (agg_hash &amp;gt;&amp;gt;&amp;gt; 2);
&lt;span class=&quot;code-comment&quot;&gt;/* 155 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 156 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_result1 = 0;
&lt;span class=&quot;code-comment&quot;&gt;/* 157 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; agg_key1.getBytes().length; i++) {
&lt;span class=&quot;code-comment&quot;&gt;/* 158 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_hash2 = agg_key1.getBytes()[i];
&lt;span class=&quot;code-comment&quot;&gt;/* 159 */&lt;/span&gt;         agg_result1 = (agg_result1 ^ (0x9e3779b9)) + agg_hash2 + (agg_result1 &amp;lt;&amp;lt; 6) + (agg_result1 &amp;gt;&amp;gt;&amp;gt; 2);
&lt;span class=&quot;code-comment&quot;&gt;/* 160 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 161 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 162 */&lt;/span&gt;       agg_hash = (agg_hash ^ (0x9e3779b9)) + agg_result1 + (agg_hash &amp;lt;&amp;lt; 6) + (agg_hash &amp;gt;&amp;gt;&amp;gt; 2);
&lt;span class=&quot;code-comment&quot;&gt;/* 163 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 164 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; agg_hash;
&lt;span class=&quot;code-comment&quot;&gt;/* 165 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 166 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 167 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; java.util.Iterator&amp;lt;org.apache.spark.sql.execution.vectorized.ColumnarBatch.Row&amp;gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 168 */&lt;/span&gt;     rowIterator() {
&lt;span class=&quot;code-comment&quot;&gt;/* 169 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; batch.rowIterator();
&lt;span class=&quot;code-comment&quot;&gt;/* 170 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 171 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 172 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close() {
&lt;span class=&quot;code-comment&quot;&gt;/* 173 */&lt;/span&gt;       batch.close();
&lt;span class=&quot;code-comment&quot;&gt;/* 174 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 175 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 176 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 177 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 178 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void agg_doAggregateWithKeys() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
&lt;span class=&quot;code-comment&quot;&gt;/* 179 */&lt;/span&gt;     agg_hashMap = agg_plan.createHashMap();
&lt;span class=&quot;code-comment&quot;&gt;/* 180 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 181 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (scan_input.hasNext()) {
&lt;span class=&quot;code-comment&quot;&gt;/* 182 */&lt;/span&gt;       InternalRow scan_row = (InternalRow) scan_input.next();
&lt;span class=&quot;code-comment&quot;&gt;/* 183 */&lt;/span&gt;       scan_numOutputRows.add(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 184 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; scan_isNull5 = scan_row.isNullAt(2);
&lt;span class=&quot;code-comment&quot;&gt;/* 185 */&lt;/span&gt;       UTF8String scan_value5 = scan_isNull5 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (scan_row.getUTF8String(2));
&lt;span class=&quot;code-comment&quot;&gt;/* 186 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 187 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!(!(scan_isNull5))) &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 188 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 189 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; filter_obj = ((Expression) references[5]).eval(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
&lt;span class=&quot;code-comment&quot;&gt;/* 190 */&lt;/span&gt;       UTF8String filter_value4 = (UTF8String) filter_obj;
&lt;span class=&quot;code-comment&quot;&gt;/* 191 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; filter_value2 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 192 */&lt;/span&gt;       filter_value2 = scan_value5.equals(filter_value4);
&lt;span class=&quot;code-comment&quot;&gt;/* 193 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!filter_value2) &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 194 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 195 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; scan_isNull3 = scan_row.isNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 196 */&lt;/span&gt;       UTF8String scan_value3 = scan_isNull3 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (scan_row.getUTF8String(0));
&lt;span class=&quot;code-comment&quot;&gt;/* 197 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 198 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!(!(scan_isNull3))) &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 199 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 200 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; scan_isNull4 = scan_row.isNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 201 */&lt;/span&gt;       UTF8String scan_value4 = scan_isNull4 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (scan_row.getUTF8String(1));
&lt;span class=&quot;code-comment&quot;&gt;/* 202 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 203 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!(!(scan_isNull4))) &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 204 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 205 */&lt;/span&gt;       filter_numOutputRows.add(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 206 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 207 */&lt;/span&gt;       UnsafeRow agg_unsafeRowAggBuffer = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 208 */&lt;/span&gt;       org.apache.spark.sql.execution.vectorized.ColumnarBatch.Row agg_vectorizedAggBuffer = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 209 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 210 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 211 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; &amp;amp;&amp;amp; !&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 212 */&lt;/span&gt;           agg_vectorizedAggBuffer = agg_vectorizedHashMap.findOrInsert(
&lt;span class=&quot;code-comment&quot;&gt;/* 213 */&lt;/span&gt;             scan_value4, scan_value3);
&lt;span class=&quot;code-comment&quot;&gt;/* 214 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 215 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 216 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 217 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_vectorizedAggBuffer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 218 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// generate grouping key
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 219 */&lt;/span&gt;         agg_holder.reset();
&lt;span class=&quot;code-comment&quot;&gt;/* 220 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 221 */&lt;/span&gt;         agg_rowWriter.write(0, scan_value4);
&lt;span class=&quot;code-comment&quot;&gt;/* 222 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 223 */&lt;/span&gt;         agg_rowWriter.write(1, scan_value3);
&lt;span class=&quot;code-comment&quot;&gt;/* 224 */&lt;/span&gt;         agg_result2.setTotalSize(agg_holder.totalSize());
&lt;span class=&quot;code-comment&quot;&gt;/* 225 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_value6 = 42;
&lt;span class=&quot;code-comment&quot;&gt;/* 226 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 227 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 228 */&lt;/span&gt;           agg_value6 = org.apache.spark.unsafe.hash.Murmur3_x86_32.hashUnsafeBytes(scan_value4.getBaseObject(), scan_value4.getBaseOffset(), scan_value4.numBytes(), agg_value6);
&lt;span class=&quot;code-comment&quot;&gt;/* 229 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 230 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 231 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 232 */&lt;/span&gt;           agg_value6 = org.apache.spark.unsafe.hash.Murmur3_x86_32.hashUnsafeBytes(scan_value3.getBaseObject(), scan_value3.getBaseOffset(), scan_value3.numBytes(), agg_value6);
&lt;span class=&quot;code-comment&quot;&gt;/* 233 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 234 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 235 */&lt;/span&gt;           &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to get the buffer from hash map
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 236 */&lt;/span&gt;           agg_unsafeRowAggBuffer =
&lt;span class=&quot;code-comment&quot;&gt;/* 237 */&lt;/span&gt;           agg_hashMap.getAggregationBufferFromUnsafeRow(agg_result2, agg_value6);
&lt;span class=&quot;code-comment&quot;&gt;/* 238 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 239 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_unsafeRowAggBuffer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 240 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_sorter == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 241 */&lt;/span&gt;             agg_sorter = agg_hashMap.destructAndCreateExternalSorter();
&lt;span class=&quot;code-comment&quot;&gt;/* 242 */&lt;/span&gt;           } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 243 */&lt;/span&gt;             agg_sorter.merge(agg_hashMap.destructAndCreateExternalSorter());
&lt;span class=&quot;code-comment&quot;&gt;/* 244 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 245 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 246 */&lt;/span&gt;           &lt;span class=&quot;code-comment&quot;&gt;// the hash map had be spilled, it should have enough memory now,
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 247 */&lt;/span&gt;           &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;  to allocate buffer again.
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 248 */&lt;/span&gt;           agg_unsafeRowAggBuffer =
&lt;span class=&quot;code-comment&quot;&gt;/* 249 */&lt;/span&gt;           agg_hashMap.getAggregationBufferFromUnsafeRow(agg_result2, agg_value6);
&lt;span class=&quot;code-comment&quot;&gt;/* 250 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_unsafeRowAggBuffer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 251 */&lt;/span&gt;             &lt;span class=&quot;code-comment&quot;&gt;// failed to allocate the first page
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 252 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; OutOfMemoryError(&lt;span class=&quot;code-quote&quot;&gt;&quot;No enough memory &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; aggregation&quot;&lt;/span&gt;);
&lt;span class=&quot;code-comment&quot;&gt;/* 253 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 254 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 255 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 256 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 257 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_vectorizedAggBuffer != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 258 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// update vectorized row
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 259 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 260 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// common sub-expressions
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 261 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 262 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// evaluate aggregate function
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 263 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value10 = agg_vectorizedAggBuffer.getLong(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 264 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 265 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value9 = -1L;
&lt;span class=&quot;code-comment&quot;&gt;/* 266 */&lt;/span&gt;         agg_value9 = agg_value10 + 1L;
&lt;span class=&quot;code-comment&quot;&gt;/* 267 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// update vectorized row
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 268 */&lt;/span&gt;         agg_vectorizedAggBuffer.setLong(0, agg_value9);
&lt;span class=&quot;code-comment&quot;&gt;/* 269 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 270 */&lt;/span&gt;       } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 271 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// update unsafe row
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 272 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 273 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// common sub-expressions
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 274 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 275 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// evaluate aggregate function
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 276 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value13 = agg_unsafeRowAggBuffer.getLong(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 277 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 278 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value12 = -1L;
&lt;span class=&quot;code-comment&quot;&gt;/* 279 */&lt;/span&gt;         agg_value12 = agg_value13 + 1L;
&lt;span class=&quot;code-comment&quot;&gt;/* 280 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// update unsafe row buffer
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 281 */&lt;/span&gt;         agg_unsafeRowAggBuffer.setLong(0, agg_value12);
&lt;span class=&quot;code-comment&quot;&gt;/* 282 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 283 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 284 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldStop()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 285 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 286 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 287 */&lt;/span&gt;     agg_vectorizedHashMapIter = agg_vectorizedHashMap.rowIterator();
&lt;span class=&quot;code-comment&quot;&gt;/* 288 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 289 */&lt;/span&gt;     agg_mapIter = agg_plan.finishAggregate(agg_hashMap, agg_sorter, agg_peakMemory, agg_spillSize);
&lt;span class=&quot;code-comment&quot;&gt;/* 290 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 291 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 292 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void processNext() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
&lt;span class=&quot;code-comment&quot;&gt;/* 293 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_initAgg) {
&lt;span class=&quot;code-comment&quot;&gt;/* 294 */&lt;/span&gt;       agg_initAgg = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 295 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; wholestagecodegen_beforeAgg = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.nanoTime();
&lt;span class=&quot;code-comment&quot;&gt;/* 296 */&lt;/span&gt;       agg_doAggregateWithKeys();
&lt;span class=&quot;code-comment&quot;&gt;/* 297 */&lt;/span&gt;       wholestagecodegen_aggTime.add((&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.nanoTime() - wholestagecodegen_beforeAgg) / 1000000);
&lt;span class=&quot;code-comment&quot;&gt;/* 298 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 299 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 300 */&lt;/span&gt;     &lt;span class=&quot;code-comment&quot;&gt;// output the result
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 301 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 302 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (agg_vectorizedHashMapIter.hasNext()) {
&lt;span class=&quot;code-comment&quot;&gt;/* 303 */&lt;/span&gt;       wholestagecodegen_numOutputRows.add(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 304 */&lt;/span&gt;       org.apache.spark.sql.execution.vectorized.ColumnarBatch.Row wholestagecodegen_vectorizedHashMapRow =
&lt;span class=&quot;code-comment&quot;&gt;/* 305 */&lt;/span&gt;       (org.apache.spark.sql.execution.vectorized.ColumnarBatch.Row)
&lt;span class=&quot;code-comment&quot;&gt;/* 306 */&lt;/span&gt;       agg_vectorizedHashMapIter.next();
&lt;span class=&quot;code-comment&quot;&gt;/* 307 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 308 */&lt;/span&gt;       wholestagecodegen_holder.reset();
&lt;span class=&quot;code-comment&quot;&gt;/* 309 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 310 */&lt;/span&gt;       wholestagecodegen_rowWriter.zeroOutNullBytes();
&lt;span class=&quot;code-comment&quot;&gt;/* 311 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 312 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; wholestagecodegen_isNull = wholestagecodegen_vectorizedHashMapRow.isNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 313 */&lt;/span&gt;       UTF8String wholestagecodegen_value = wholestagecodegen_isNull ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (wholestagecodegen_vectorizedHashMapRow.getUTF8String(0));
&lt;span class=&quot;code-comment&quot;&gt;/* 314 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (wholestagecodegen_isNull) {
&lt;span class=&quot;code-comment&quot;&gt;/* 315 */&lt;/span&gt;         wholestagecodegen_rowWriter.setNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 316 */&lt;/span&gt;       } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 317 */&lt;/span&gt;         wholestagecodegen_rowWriter.write(0, wholestagecodegen_value);
&lt;span class=&quot;code-comment&quot;&gt;/* 318 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 319 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 320 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; wholestagecodegen_isNull1 = wholestagecodegen_vectorizedHashMapRow.isNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 321 */&lt;/span&gt;       UTF8String wholestagecodegen_value1 = wholestagecodegen_isNull1 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (wholestagecodegen_vectorizedHashMapRow.getUTF8String(1));
&lt;span class=&quot;code-comment&quot;&gt;/* 322 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (wholestagecodegen_isNull1) {
&lt;span class=&quot;code-comment&quot;&gt;/* 323 */&lt;/span&gt;         wholestagecodegen_rowWriter.setNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 324 */&lt;/span&gt;       } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 325 */&lt;/span&gt;         wholestagecodegen_rowWriter.write(1, wholestagecodegen_value1);
&lt;span class=&quot;code-comment&quot;&gt;/* 326 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 327 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 328 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; wholestagecodegen_value2 = wholestagecodegen_vectorizedHashMapRow.getLong(2);
&lt;span class=&quot;code-comment&quot;&gt;/* 329 */&lt;/span&gt;       wholestagecodegen_rowWriter.write(2, wholestagecodegen_value2);
&lt;span class=&quot;code-comment&quot;&gt;/* 330 */&lt;/span&gt;       wholestagecodegen_result.setTotalSize(wholestagecodegen_holder.totalSize());
&lt;span class=&quot;code-comment&quot;&gt;/* 331 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 332 */&lt;/span&gt;       append(wholestagecodegen_result);
&lt;span class=&quot;code-comment&quot;&gt;/* 333 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 334 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldStop()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 335 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 336 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 337 */&lt;/span&gt;     agg_vectorizedHashMap.close();
&lt;span class=&quot;code-comment&quot;&gt;/* 338 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 339 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (agg_mapIter.next()) {
&lt;span class=&quot;code-comment&quot;&gt;/* 340 */&lt;/span&gt;       wholestagecodegen_numOutputRows.add(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 341 */&lt;/span&gt;       UnsafeRow agg_aggKey = (UnsafeRow) agg_mapIter.getKey();
&lt;span class=&quot;code-comment&quot;&gt;/* 342 */&lt;/span&gt;       UnsafeRow agg_aggBuffer = (UnsafeRow) agg_mapIter.getValue();
&lt;span class=&quot;code-comment&quot;&gt;/* 343 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 344 */&lt;/span&gt;       UnsafeRow agg_resultRow = agg_unsafeRowJoiner.join(agg_aggKey, agg_aggBuffer);
&lt;span class=&quot;code-comment&quot;&gt;/* 345 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 346 */&lt;/span&gt;       append(agg_resultRow);
&lt;span class=&quot;code-comment&quot;&gt;/* 347 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 348 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldStop()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 349 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 350 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 351 */&lt;/span&gt;     agg_mapIter.close();
&lt;span class=&quot;code-comment&quot;&gt;/* 352 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_sorter == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 353 */&lt;/span&gt;       agg_hashMap.free();
&lt;span class=&quot;code-comment&quot;&gt;/* 354 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 355 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 356 */&lt;/span&gt; }

== Subtree 4 / 5 ==
*Sort [Origin#155 ASC, UniqueCarrier#147 ASC], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, 0
+- *HashAggregate(key=[Origin#155,UniqueCarrier#147], functions=[count(1)], output=[Origin#155,UniqueCarrier#147,total#97L])
   +- Exchange hashpartitioning(Origin#155, UniqueCarrier#147, 200)
      +- *HashAggregate(key=[Origin#155,UniqueCarrier#147], functions=[partial_count(1)], output=[Origin#155,UniqueCarrier#147,count#303L])
         +- *Project [UniqueCarrier#147, Origin#155]
            +- *Filter (((isnotnull(UniqueCarrier#147) &amp;amp;&amp;amp; isnotnull(Origin#155)) &amp;amp;&amp;amp; isnotnull(Dest#156)) &amp;amp;&amp;amp; (Dest#156 = ORD))
               +- *Scan csv [UniqueCarrier#147,Origin#155,Dest#156] Format: CSV, InputPaths: file:/home/robbins/brandberry/2008.csv, PushedFilters: [IsNotNull(UniqueCarrier), IsNotNull(Origin), IsNotNull(Dest), EqualTo(Dest,ORD)], ReadSchema: struct&amp;lt;UniqueCarrier:string,Origin:string,Dest:string&amp;gt;

Generated code:
&lt;span class=&quot;code-comment&quot;&gt;/* 001 */&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; generate(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references) {
&lt;span class=&quot;code-comment&quot;&gt;/* 002 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GeneratedIterator(references);
&lt;span class=&quot;code-comment&quot;&gt;/* 003 */&lt;/span&gt; }
&lt;span class=&quot;code-comment&quot;&gt;/* 004 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 005 */&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;GeneratedIterator &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; org.apache.spark.sql.execution.BufferedRowIterator {
&lt;span class=&quot;code-comment&quot;&gt;/* 006 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references;
&lt;span class=&quot;code-comment&quot;&gt;/* 007 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; sort_needToSort;
&lt;span class=&quot;code-comment&quot;&gt;/* 008 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.SortExec sort_plan;
&lt;span class=&quot;code-comment&quot;&gt;/* 009 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.UnsafeExternalRowSorter sort_sorter;
&lt;span class=&quot;code-comment&quot;&gt;/* 010 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.executor.TaskMetrics sort_metrics;
&lt;span class=&quot;code-comment&quot;&gt;/* 011 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; scala.collection.Iterator&amp;lt;UnsafeRow&amp;gt; sort_sortedIter;
&lt;span class=&quot;code-comment&quot;&gt;/* 012 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_initAgg;
&lt;span class=&quot;code-comment&quot;&gt;/* 013 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_bufIsNull;
&lt;span class=&quot;code-comment&quot;&gt;/* 014 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_bufValue;
&lt;span class=&quot;code-comment&quot;&gt;/* 015 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.aggregate.HashAggregateExec agg_plan;
&lt;span class=&quot;code-comment&quot;&gt;/* 016 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.UnsafeFixedWidthAggregationMap agg_hashMap;
&lt;span class=&quot;code-comment&quot;&gt;/* 017 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.UnsafeKVExternalSorter agg_sorter;
&lt;span class=&quot;code-comment&quot;&gt;/* 018 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.unsafe.KVIterator agg_mapIter;
&lt;span class=&quot;code-comment&quot;&gt;/* 019 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric agg_peakMemory;
&lt;span class=&quot;code-comment&quot;&gt;/* 020 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric agg_spillSize;
&lt;span class=&quot;code-comment&quot;&gt;/* 021 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; scala.collection.Iterator inputadapter_input;
&lt;span class=&quot;code-comment&quot;&gt;/* 022 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UnsafeRow agg_result;
&lt;span class=&quot;code-comment&quot;&gt;/* 023 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder agg_holder;
&lt;span class=&quot;code-comment&quot;&gt;/* 024 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter agg_rowWriter;
&lt;span class=&quot;code-comment&quot;&gt;/* 025 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UnsafeRow agg_result1;
&lt;span class=&quot;code-comment&quot;&gt;/* 026 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder agg_holder1;
&lt;span class=&quot;code-comment&quot;&gt;/* 027 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter agg_rowWriter1;
&lt;span class=&quot;code-comment&quot;&gt;/* 028 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric sort_numOutputRows;
&lt;span class=&quot;code-comment&quot;&gt;/* 029 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric sort_aggTime;
&lt;span class=&quot;code-comment&quot;&gt;/* 030 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric sort_peakMemory;
&lt;span class=&quot;code-comment&quot;&gt;/* 031 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric sort_spillSize;
&lt;span class=&quot;code-comment&quot;&gt;/* 032 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric sort_sortTime;
&lt;span class=&quot;code-comment&quot;&gt;/* 033 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 034 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; GeneratedIterator(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references) {
&lt;span class=&quot;code-comment&quot;&gt;/* 035 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.references = references;
&lt;span class=&quot;code-comment&quot;&gt;/* 036 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 037 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 038 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void init(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; index, scala.collection.Iterator inputs[]) {
&lt;span class=&quot;code-comment&quot;&gt;/* 039 */&lt;/span&gt;     partitionIndex = index;
&lt;span class=&quot;code-comment&quot;&gt;/* 040 */&lt;/span&gt;     sort_needToSort = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 041 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sort_plan = (org.apache.spark.sql.execution.SortExec) references[0];
&lt;span class=&quot;code-comment&quot;&gt;/* 042 */&lt;/span&gt;     sort_sorter = sort_plan.createSorter();
&lt;span class=&quot;code-comment&quot;&gt;/* 043 */&lt;/span&gt;     sort_metrics = org.apache.spark.TaskContext.get().taskMetrics();
&lt;span class=&quot;code-comment&quot;&gt;/* 044 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 045 */&lt;/span&gt;     agg_initAgg = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 046 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 047 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_plan = (org.apache.spark.sql.execution.aggregate.HashAggregateExec) references[1];
&lt;span class=&quot;code-comment&quot;&gt;/* 048 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 049 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_peakMemory = (org.apache.spark.sql.execution.metric.SQLMetric) references[2];
&lt;span class=&quot;code-comment&quot;&gt;/* 050 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_spillSize = (org.apache.spark.sql.execution.metric.SQLMetric) references[3];
&lt;span class=&quot;code-comment&quot;&gt;/* 051 */&lt;/span&gt;     inputadapter_input = inputs[0];
&lt;span class=&quot;code-comment&quot;&gt;/* 052 */&lt;/span&gt;     agg_result = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow(2);
&lt;span class=&quot;code-comment&quot;&gt;/* 053 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_holder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder(agg_result, 64);
&lt;span class=&quot;code-comment&quot;&gt;/* 054 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_rowWriter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(agg_holder, 2);
&lt;span class=&quot;code-comment&quot;&gt;/* 055 */&lt;/span&gt;     agg_result1 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow(3);
&lt;span class=&quot;code-comment&quot;&gt;/* 056 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_holder1 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder(agg_result1, 64);
&lt;span class=&quot;code-comment&quot;&gt;/* 057 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_rowWriter1 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(agg_holder1, 3);
&lt;span class=&quot;code-comment&quot;&gt;/* 058 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sort_numOutputRows = (org.apache.spark.sql.execution.metric.SQLMetric) references[4];
&lt;span class=&quot;code-comment&quot;&gt;/* 059 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sort_aggTime = (org.apache.spark.sql.execution.metric.SQLMetric) references[5];
&lt;span class=&quot;code-comment&quot;&gt;/* 060 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sort_peakMemory = (org.apache.spark.sql.execution.metric.SQLMetric) references[6];
&lt;span class=&quot;code-comment&quot;&gt;/* 061 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sort_spillSize = (org.apache.spark.sql.execution.metric.SQLMetric) references[7];
&lt;span class=&quot;code-comment&quot;&gt;/* 062 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sort_sortTime = (org.apache.spark.sql.execution.metric.SQLMetric) references[8];
&lt;span class=&quot;code-comment&quot;&gt;/* 063 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 064 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 065 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void agg_doAggregateWithKeys() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
&lt;span class=&quot;code-comment&quot;&gt;/* 066 */&lt;/span&gt;     agg_hashMap = agg_plan.createHashMap();
&lt;span class=&quot;code-comment&quot;&gt;/* 067 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 068 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (inputadapter_input.hasNext()) {
&lt;span class=&quot;code-comment&quot;&gt;/* 069 */&lt;/span&gt;       InternalRow inputadapter_row = (InternalRow) inputadapter_input.next();
&lt;span class=&quot;code-comment&quot;&gt;/* 070 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; inputadapter_isNull = inputadapter_row.isNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 071 */&lt;/span&gt;       UTF8String inputadapter_value = inputadapter_isNull ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (inputadapter_row.getUTF8String(0));
&lt;span class=&quot;code-comment&quot;&gt;/* 072 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; inputadapter_isNull1 = inputadapter_row.isNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 073 */&lt;/span&gt;       UTF8String inputadapter_value1 = inputadapter_isNull1 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (inputadapter_row.getUTF8String(1));
&lt;span class=&quot;code-comment&quot;&gt;/* 074 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; inputadapter_value2 = inputadapter_row.getLong(2);
&lt;span class=&quot;code-comment&quot;&gt;/* 075 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 076 */&lt;/span&gt;       UnsafeRow agg_unsafeRowAggBuffer = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 077 */&lt;/span&gt;       org.apache.spark.sql.execution.vectorized.ColumnarBatch.Row agg_vectorizedAggBuffer = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 078 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 079 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_vectorizedAggBuffer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 080 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// generate grouping key
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 081 */&lt;/span&gt;         agg_holder.reset();
&lt;span class=&quot;code-comment&quot;&gt;/* 082 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 083 */&lt;/span&gt;         agg_rowWriter.zeroOutNullBytes();
&lt;span class=&quot;code-comment&quot;&gt;/* 084 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 085 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (inputadapter_isNull) {
&lt;span class=&quot;code-comment&quot;&gt;/* 086 */&lt;/span&gt;           agg_rowWriter.setNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 087 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 088 */&lt;/span&gt;           agg_rowWriter.write(0, inputadapter_value);
&lt;span class=&quot;code-comment&quot;&gt;/* 089 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 090 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 091 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (inputadapter_isNull1) {
&lt;span class=&quot;code-comment&quot;&gt;/* 092 */&lt;/span&gt;           agg_rowWriter.setNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 093 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 094 */&lt;/span&gt;           agg_rowWriter.write(1, inputadapter_value1);
&lt;span class=&quot;code-comment&quot;&gt;/* 095 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 096 */&lt;/span&gt;         agg_result.setTotalSize(agg_holder.totalSize());
&lt;span class=&quot;code-comment&quot;&gt;/* 097 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_value6 = 42;
&lt;span class=&quot;code-comment&quot;&gt;/* 098 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 099 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!inputadapter_isNull) {
&lt;span class=&quot;code-comment&quot;&gt;/* 100 */&lt;/span&gt;           agg_value6 = org.apache.spark.unsafe.hash.Murmur3_x86_32.hashUnsafeBytes(inputadapter_value.getBaseObject(), inputadapter_value.getBaseOffset(), inputadapter_value.numBytes(), agg_value6);
&lt;span class=&quot;code-comment&quot;&gt;/* 101 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 102 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 103 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!inputadapter_isNull1) {
&lt;span class=&quot;code-comment&quot;&gt;/* 104 */&lt;/span&gt;           agg_value6 = org.apache.spark.unsafe.hash.Murmur3_x86_32.hashUnsafeBytes(inputadapter_value1.getBaseObject(), inputadapter_value1.getBaseOffset(), inputadapter_value1.numBytes(), agg_value6);
&lt;span class=&quot;code-comment&quot;&gt;/* 105 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 106 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 107 */&lt;/span&gt;           &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to get the buffer from hash map
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 108 */&lt;/span&gt;           agg_unsafeRowAggBuffer =
&lt;span class=&quot;code-comment&quot;&gt;/* 109 */&lt;/span&gt;           agg_hashMap.getAggregationBufferFromUnsafeRow(agg_result, agg_value6);
&lt;span class=&quot;code-comment&quot;&gt;/* 110 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 111 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_unsafeRowAggBuffer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 112 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_sorter == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 113 */&lt;/span&gt;             agg_sorter = agg_hashMap.destructAndCreateExternalSorter();
&lt;span class=&quot;code-comment&quot;&gt;/* 114 */&lt;/span&gt;           } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 115 */&lt;/span&gt;             agg_sorter.merge(agg_hashMap.destructAndCreateExternalSorter());
&lt;span class=&quot;code-comment&quot;&gt;/* 116 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 117 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 118 */&lt;/span&gt;           &lt;span class=&quot;code-comment&quot;&gt;// the hash map had be spilled, it should have enough memory now,
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 119 */&lt;/span&gt;           &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;  to allocate buffer again.
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 120 */&lt;/span&gt;           agg_unsafeRowAggBuffer =
&lt;span class=&quot;code-comment&quot;&gt;/* 121 */&lt;/span&gt;           agg_hashMap.getAggregationBufferFromUnsafeRow(agg_result, agg_value6);
&lt;span class=&quot;code-comment&quot;&gt;/* 122 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_unsafeRowAggBuffer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 123 */&lt;/span&gt;             &lt;span class=&quot;code-comment&quot;&gt;// failed to allocate the first page
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 124 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; OutOfMemoryError(&lt;span class=&quot;code-quote&quot;&gt;&quot;No enough memory &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; aggregation&quot;&lt;/span&gt;);
&lt;span class=&quot;code-comment&quot;&gt;/* 125 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 126 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 127 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 128 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 129 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_vectorizedAggBuffer != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 130 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// update vectorized row
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 131 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 132 */&lt;/span&gt;       } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 133 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// update unsafe row
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 134 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 135 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// common sub-expressions
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 136 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 137 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// evaluate aggregate function
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 138 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value10 = agg_unsafeRowAggBuffer.getLong(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 139 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 140 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value9 = -1L;
&lt;span class=&quot;code-comment&quot;&gt;/* 141 */&lt;/span&gt;         agg_value9 = agg_value10 + inputadapter_value2;
&lt;span class=&quot;code-comment&quot;&gt;/* 142 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// update unsafe row buffer
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 143 */&lt;/span&gt;         agg_unsafeRowAggBuffer.setLong(0, agg_value9);
&lt;span class=&quot;code-comment&quot;&gt;/* 144 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 145 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 146 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldStop()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 147 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 148 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 149 */&lt;/span&gt;     agg_mapIter = agg_plan.finishAggregate(agg_hashMap, agg_sorter, agg_peakMemory, agg_spillSize);
&lt;span class=&quot;code-comment&quot;&gt;/* 150 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 151 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 152 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void sort_addToSorter() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
&lt;span class=&quot;code-comment&quot;&gt;/* 153 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_initAgg) {
&lt;span class=&quot;code-comment&quot;&gt;/* 154 */&lt;/span&gt;       agg_initAgg = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 155 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; sort_beforeAgg = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.nanoTime();
&lt;span class=&quot;code-comment&quot;&gt;/* 156 */&lt;/span&gt;       agg_doAggregateWithKeys();
&lt;span class=&quot;code-comment&quot;&gt;/* 157 */&lt;/span&gt;       sort_aggTime.add((&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.nanoTime() - sort_beforeAgg) / 1000000);
&lt;span class=&quot;code-comment&quot;&gt;/* 158 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 159 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 160 */&lt;/span&gt;     &lt;span class=&quot;code-comment&quot;&gt;// output the result
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 161 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 162 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (agg_mapIter.next()) {
&lt;span class=&quot;code-comment&quot;&gt;/* 163 */&lt;/span&gt;       sort_numOutputRows.add(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 164 */&lt;/span&gt;       UnsafeRow agg_aggKey = (UnsafeRow) agg_mapIter.getKey();
&lt;span class=&quot;code-comment&quot;&gt;/* 165 */&lt;/span&gt;       UnsafeRow agg_aggBuffer = (UnsafeRow) agg_mapIter.getValue();
&lt;span class=&quot;code-comment&quot;&gt;/* 166 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 167 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull11 = agg_aggKey.isNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 168 */&lt;/span&gt;       UTF8String agg_value12 = agg_isNull11 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (agg_aggKey.getUTF8String(0));
&lt;span class=&quot;code-comment&quot;&gt;/* 169 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull12 = agg_aggKey.isNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 170 */&lt;/span&gt;       UTF8String agg_value13 = agg_isNull12 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (agg_aggKey.getUTF8String(1));
&lt;span class=&quot;code-comment&quot;&gt;/* 171 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value14 = agg_aggBuffer.getLong(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 172 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 173 */&lt;/span&gt;       agg_holder1.reset();
&lt;span class=&quot;code-comment&quot;&gt;/* 174 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 175 */&lt;/span&gt;       agg_rowWriter1.zeroOutNullBytes();
&lt;span class=&quot;code-comment&quot;&gt;/* 176 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 177 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_isNull11) {
&lt;span class=&quot;code-comment&quot;&gt;/* 178 */&lt;/span&gt;         agg_rowWriter1.setNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 179 */&lt;/span&gt;       } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 180 */&lt;/span&gt;         agg_rowWriter1.write(0, agg_value12);
&lt;span class=&quot;code-comment&quot;&gt;/* 181 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 182 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 183 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_isNull12) {
&lt;span class=&quot;code-comment&quot;&gt;/* 184 */&lt;/span&gt;         agg_rowWriter1.setNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 185 */&lt;/span&gt;       } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 186 */&lt;/span&gt;         agg_rowWriter1.write(1, agg_value13);
&lt;span class=&quot;code-comment&quot;&gt;/* 187 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 188 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 189 */&lt;/span&gt;       agg_rowWriter1.write(2, agg_value14);
&lt;span class=&quot;code-comment&quot;&gt;/* 190 */&lt;/span&gt;       agg_result1.setTotalSize(agg_holder1.totalSize());
&lt;span class=&quot;code-comment&quot;&gt;/* 191 */&lt;/span&gt;       sort_sorter.insertRow((UnsafeRow)agg_result1);
&lt;span class=&quot;code-comment&quot;&gt;/* 192 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 193 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldStop()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 194 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 195 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 196 */&lt;/span&gt;     agg_mapIter.close();
&lt;span class=&quot;code-comment&quot;&gt;/* 197 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_sorter == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 198 */&lt;/span&gt;       agg_hashMap.free();
&lt;span class=&quot;code-comment&quot;&gt;/* 199 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 200 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 201 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 202 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 203 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void processNext() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
&lt;span class=&quot;code-comment&quot;&gt;/* 204 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sort_needToSort) {
&lt;span class=&quot;code-comment&quot;&gt;/* 205 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; sort_spillSizeBefore = sort_metrics.memoryBytesSpilled();
&lt;span class=&quot;code-comment&quot;&gt;/* 206 */&lt;/span&gt;       sort_addToSorter();
&lt;span class=&quot;code-comment&quot;&gt;/* 207 */&lt;/span&gt;       sort_sortedIter = sort_sorter.sort();
&lt;span class=&quot;code-comment&quot;&gt;/* 208 */&lt;/span&gt;       sort_sortTime.add(sort_sorter.getSortTimeNanos() / 1000000);
&lt;span class=&quot;code-comment&quot;&gt;/* 209 */&lt;/span&gt;       sort_peakMemory.add(sort_sorter.getPeakMemoryUsage());
&lt;span class=&quot;code-comment&quot;&gt;/* 210 */&lt;/span&gt;       sort_spillSize.add(sort_metrics.memoryBytesSpilled() - sort_spillSizeBefore);
&lt;span class=&quot;code-comment&quot;&gt;/* 211 */&lt;/span&gt;       sort_metrics.incPeakExecutionMemory(sort_sorter.getPeakMemoryUsage());
&lt;span class=&quot;code-comment&quot;&gt;/* 212 */&lt;/span&gt;       sort_needToSort = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 213 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 214 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 215 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (sort_sortedIter.hasNext()) {
&lt;span class=&quot;code-comment&quot;&gt;/* 216 */&lt;/span&gt;       UnsafeRow sort_outputRow = (UnsafeRow)sort_sortedIter.next();
&lt;span class=&quot;code-comment&quot;&gt;/* 217 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 218 */&lt;/span&gt;       append(sort_outputRow);
&lt;span class=&quot;code-comment&quot;&gt;/* 219 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 220 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldStop()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 221 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 222 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 223 */&lt;/span&gt; }

== Subtree 5 / 5 ==
*Sort [Origin#16 ASC, UniqueCarrier#8 ASC], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, 0
+- *HashAggregate(key=[Origin#16,UniqueCarrier#8], functions=[count(1)], output=[Origin#16,UniqueCarrier#8,count#134L])
   +- Exchange hashpartitioning(Origin#16, UniqueCarrier#8, 200)
      +- *HashAggregate(key=[Origin#16,UniqueCarrier#8], functions=[partial_count(1)], output=[Origin#16,UniqueCarrier#8,count#296L])
         +- *Project [UniqueCarrier#8, Origin#16]
            +- *Filter (((((((isnotnull(Origin#16) &amp;amp;&amp;amp; isnotnull(UniqueCarrier#8)) &amp;amp;&amp;amp; isnotnull(Cancelled#21)) &amp;amp;&amp;amp; isnotnull(CancellationCode#22)) &amp;amp;&amp;amp; NOT (Cancelled#21 = 0)) &amp;amp;&amp;amp; (CancellationCode#22 = A)) &amp;amp;&amp;amp; isnotnull(Dest#17)) &amp;amp;&amp;amp; (Dest#17 = ORD))
               +- *Scan csv [UniqueCarrier#8,Origin#16,Dest#17,Cancelled#21,CancellationCode#22] Format: CSV, InputPaths: file:/home/robbins/brandberry/2008.csv, PushedFilters: [IsNotNull(Origin), IsNotNull(UniqueCarrier), IsNotNull(Cancelled), IsNotNull(CancellationCode), ..., ReadSchema: struct&amp;lt;UniqueCarrier:string,Origin:string,Dest:string,Cancelled:&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,CancellationCode:string&amp;gt;

Generated code:
&lt;span class=&quot;code-comment&quot;&gt;/* 001 */&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; generate(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references) {
&lt;span class=&quot;code-comment&quot;&gt;/* 002 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GeneratedIterator(references);
&lt;span class=&quot;code-comment&quot;&gt;/* 003 */&lt;/span&gt; }
&lt;span class=&quot;code-comment&quot;&gt;/* 004 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 005 */&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;GeneratedIterator &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; org.apache.spark.sql.execution.BufferedRowIterator {
&lt;span class=&quot;code-comment&quot;&gt;/* 006 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references;
&lt;span class=&quot;code-comment&quot;&gt;/* 007 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; sort_needToSort;
&lt;span class=&quot;code-comment&quot;&gt;/* 008 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.SortExec sort_plan;
&lt;span class=&quot;code-comment&quot;&gt;/* 009 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.UnsafeExternalRowSorter sort_sorter;
&lt;span class=&quot;code-comment&quot;&gt;/* 010 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.executor.TaskMetrics sort_metrics;
&lt;span class=&quot;code-comment&quot;&gt;/* 011 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; scala.collection.Iterator&amp;lt;UnsafeRow&amp;gt; sort_sortedIter;
&lt;span class=&quot;code-comment&quot;&gt;/* 012 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_initAgg;
&lt;span class=&quot;code-comment&quot;&gt;/* 013 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_bufIsNull;
&lt;span class=&quot;code-comment&quot;&gt;/* 014 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_bufValue;
&lt;span class=&quot;code-comment&quot;&gt;/* 015 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.aggregate.HashAggregateExec agg_plan;
&lt;span class=&quot;code-comment&quot;&gt;/* 016 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.UnsafeFixedWidthAggregationMap agg_hashMap;
&lt;span class=&quot;code-comment&quot;&gt;/* 017 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.UnsafeKVExternalSorter agg_sorter;
&lt;span class=&quot;code-comment&quot;&gt;/* 018 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.unsafe.KVIterator agg_mapIter;
&lt;span class=&quot;code-comment&quot;&gt;/* 019 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric agg_peakMemory;
&lt;span class=&quot;code-comment&quot;&gt;/* 020 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric agg_spillSize;
&lt;span class=&quot;code-comment&quot;&gt;/* 021 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; scala.collection.Iterator inputadapter_input;
&lt;span class=&quot;code-comment&quot;&gt;/* 022 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UnsafeRow agg_result;
&lt;span class=&quot;code-comment&quot;&gt;/* 023 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder agg_holder;
&lt;span class=&quot;code-comment&quot;&gt;/* 024 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter agg_rowWriter;
&lt;span class=&quot;code-comment&quot;&gt;/* 025 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UnsafeRow agg_result1;
&lt;span class=&quot;code-comment&quot;&gt;/* 026 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder agg_holder1;
&lt;span class=&quot;code-comment&quot;&gt;/* 027 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter agg_rowWriter1;
&lt;span class=&quot;code-comment&quot;&gt;/* 028 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric sort_numOutputRows;
&lt;span class=&quot;code-comment&quot;&gt;/* 029 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric sort_aggTime;
&lt;span class=&quot;code-comment&quot;&gt;/* 030 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric sort_peakMemory;
&lt;span class=&quot;code-comment&quot;&gt;/* 031 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric sort_spillSize;
&lt;span class=&quot;code-comment&quot;&gt;/* 032 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric sort_sortTime;
&lt;span class=&quot;code-comment&quot;&gt;/* 033 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 034 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; GeneratedIterator(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references) {
&lt;span class=&quot;code-comment&quot;&gt;/* 035 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.references = references;
&lt;span class=&quot;code-comment&quot;&gt;/* 036 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 037 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 038 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void init(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; index, scala.collection.Iterator inputs[]) {
&lt;span class=&quot;code-comment&quot;&gt;/* 039 */&lt;/span&gt;     partitionIndex = index;
&lt;span class=&quot;code-comment&quot;&gt;/* 040 */&lt;/span&gt;     sort_needToSort = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 041 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sort_plan = (org.apache.spark.sql.execution.SortExec) references[0];
&lt;span class=&quot;code-comment&quot;&gt;/* 042 */&lt;/span&gt;     sort_sorter = sort_plan.createSorter();
&lt;span class=&quot;code-comment&quot;&gt;/* 043 */&lt;/span&gt;     sort_metrics = org.apache.spark.TaskContext.get().taskMetrics();
&lt;span class=&quot;code-comment&quot;&gt;/* 044 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 045 */&lt;/span&gt;     agg_initAgg = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 046 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 047 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_plan = (org.apache.spark.sql.execution.aggregate.HashAggregateExec) references[1];
&lt;span class=&quot;code-comment&quot;&gt;/* 048 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 049 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_peakMemory = (org.apache.spark.sql.execution.metric.SQLMetric) references[2];
&lt;span class=&quot;code-comment&quot;&gt;/* 050 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_spillSize = (org.apache.spark.sql.execution.metric.SQLMetric) references[3];
&lt;span class=&quot;code-comment&quot;&gt;/* 051 */&lt;/span&gt;     inputadapter_input = inputs[0];
&lt;span class=&quot;code-comment&quot;&gt;/* 052 */&lt;/span&gt;     agg_result = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow(2);
&lt;span class=&quot;code-comment&quot;&gt;/* 053 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_holder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder(agg_result, 64);
&lt;span class=&quot;code-comment&quot;&gt;/* 054 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_rowWriter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(agg_holder, 2);
&lt;span class=&quot;code-comment&quot;&gt;/* 055 */&lt;/span&gt;     agg_result1 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow(3);
&lt;span class=&quot;code-comment&quot;&gt;/* 056 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_holder1 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder(agg_result1, 64);
&lt;span class=&quot;code-comment&quot;&gt;/* 057 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.agg_rowWriter1 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(agg_holder1, 3);
&lt;span class=&quot;code-comment&quot;&gt;/* 058 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sort_numOutputRows = (org.apache.spark.sql.execution.metric.SQLMetric) references[4];
&lt;span class=&quot;code-comment&quot;&gt;/* 059 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sort_aggTime = (org.apache.spark.sql.execution.metric.SQLMetric) references[5];
&lt;span class=&quot;code-comment&quot;&gt;/* 060 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sort_peakMemory = (org.apache.spark.sql.execution.metric.SQLMetric) references[6];
&lt;span class=&quot;code-comment&quot;&gt;/* 061 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sort_spillSize = (org.apache.spark.sql.execution.metric.SQLMetric) references[7];
&lt;span class=&quot;code-comment&quot;&gt;/* 062 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sort_sortTime = (org.apache.spark.sql.execution.metric.SQLMetric) references[8];
&lt;span class=&quot;code-comment&quot;&gt;/* 063 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 064 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 065 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void agg_doAggregateWithKeys() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
&lt;span class=&quot;code-comment&quot;&gt;/* 066 */&lt;/span&gt;     agg_hashMap = agg_plan.createHashMap();
&lt;span class=&quot;code-comment&quot;&gt;/* 067 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 068 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (inputadapter_input.hasNext()) {
&lt;span class=&quot;code-comment&quot;&gt;/* 069 */&lt;/span&gt;       InternalRow inputadapter_row = (InternalRow) inputadapter_input.next();
&lt;span class=&quot;code-comment&quot;&gt;/* 070 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; inputadapter_isNull = inputadapter_row.isNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 071 */&lt;/span&gt;       UTF8String inputadapter_value = inputadapter_isNull ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (inputadapter_row.getUTF8String(0));
&lt;span class=&quot;code-comment&quot;&gt;/* 072 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; inputadapter_isNull1 = inputadapter_row.isNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 073 */&lt;/span&gt;       UTF8String inputadapter_value1 = inputadapter_isNull1 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (inputadapter_row.getUTF8String(1));
&lt;span class=&quot;code-comment&quot;&gt;/* 074 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; inputadapter_value2 = inputadapter_row.getLong(2);
&lt;span class=&quot;code-comment&quot;&gt;/* 075 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 076 */&lt;/span&gt;       UnsafeRow agg_unsafeRowAggBuffer = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 077 */&lt;/span&gt;       org.apache.spark.sql.execution.vectorized.ColumnarBatch.Row agg_vectorizedAggBuffer = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 078 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 079 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_vectorizedAggBuffer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 080 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// generate grouping key
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 081 */&lt;/span&gt;         agg_holder.reset();
&lt;span class=&quot;code-comment&quot;&gt;/* 082 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 083 */&lt;/span&gt;         agg_rowWriter.zeroOutNullBytes();
&lt;span class=&quot;code-comment&quot;&gt;/* 084 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 085 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (inputadapter_isNull) {
&lt;span class=&quot;code-comment&quot;&gt;/* 086 */&lt;/span&gt;           agg_rowWriter.setNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 087 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 088 */&lt;/span&gt;           agg_rowWriter.write(0, inputadapter_value);
&lt;span class=&quot;code-comment&quot;&gt;/* 089 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 090 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 091 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (inputadapter_isNull1) {
&lt;span class=&quot;code-comment&quot;&gt;/* 092 */&lt;/span&gt;           agg_rowWriter.setNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 093 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 094 */&lt;/span&gt;           agg_rowWriter.write(1, inputadapter_value1);
&lt;span class=&quot;code-comment&quot;&gt;/* 095 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 096 */&lt;/span&gt;         agg_result.setTotalSize(agg_holder.totalSize());
&lt;span class=&quot;code-comment&quot;&gt;/* 097 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; agg_value6 = 42;
&lt;span class=&quot;code-comment&quot;&gt;/* 098 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 099 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!inputadapter_isNull) {
&lt;span class=&quot;code-comment&quot;&gt;/* 100 */&lt;/span&gt;           agg_value6 = org.apache.spark.unsafe.hash.Murmur3_x86_32.hashUnsafeBytes(inputadapter_value.getBaseObject(), inputadapter_value.getBaseOffset(), inputadapter_value.numBytes(), agg_value6);
&lt;span class=&quot;code-comment&quot;&gt;/* 101 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 102 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 103 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!inputadapter_isNull1) {
&lt;span class=&quot;code-comment&quot;&gt;/* 104 */&lt;/span&gt;           agg_value6 = org.apache.spark.unsafe.hash.Murmur3_x86_32.hashUnsafeBytes(inputadapter_value1.getBaseObject(), inputadapter_value1.getBaseOffset(), inputadapter_value1.numBytes(), agg_value6);
&lt;span class=&quot;code-comment&quot;&gt;/* 105 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 106 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 107 */&lt;/span&gt;           &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; to get the buffer from hash map
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 108 */&lt;/span&gt;           agg_unsafeRowAggBuffer =
&lt;span class=&quot;code-comment&quot;&gt;/* 109 */&lt;/span&gt;           agg_hashMap.getAggregationBufferFromUnsafeRow(agg_result, agg_value6);
&lt;span class=&quot;code-comment&quot;&gt;/* 110 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 111 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_unsafeRowAggBuffer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 112 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_sorter == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 113 */&lt;/span&gt;             agg_sorter = agg_hashMap.destructAndCreateExternalSorter();
&lt;span class=&quot;code-comment&quot;&gt;/* 114 */&lt;/span&gt;           } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 115 */&lt;/span&gt;             agg_sorter.merge(agg_hashMap.destructAndCreateExternalSorter());
&lt;span class=&quot;code-comment&quot;&gt;/* 116 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 117 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 118 */&lt;/span&gt;           &lt;span class=&quot;code-comment&quot;&gt;// the hash map had be spilled, it should have enough memory now,
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 119 */&lt;/span&gt;           &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;  to allocate buffer again.
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 120 */&lt;/span&gt;           agg_unsafeRowAggBuffer =
&lt;span class=&quot;code-comment&quot;&gt;/* 121 */&lt;/span&gt;           agg_hashMap.getAggregationBufferFromUnsafeRow(agg_result, agg_value6);
&lt;span class=&quot;code-comment&quot;&gt;/* 122 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_unsafeRowAggBuffer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 123 */&lt;/span&gt;             &lt;span class=&quot;code-comment&quot;&gt;// failed to allocate the first page
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 124 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; OutOfMemoryError(&lt;span class=&quot;code-quote&quot;&gt;&quot;No enough memory &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; aggregation&quot;&lt;/span&gt;);
&lt;span class=&quot;code-comment&quot;&gt;/* 125 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 126 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 127 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 128 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 129 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_vectorizedAggBuffer != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 130 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// update vectorized row
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 131 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 132 */&lt;/span&gt;       } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 133 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// update unsafe row
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 134 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 135 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// common sub-expressions
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 136 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 137 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// evaluate aggregate function
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 138 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value10 = agg_unsafeRowAggBuffer.getLong(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 139 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 140 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value9 = -1L;
&lt;span class=&quot;code-comment&quot;&gt;/* 141 */&lt;/span&gt;         agg_value9 = agg_value10 + inputadapter_value2;
&lt;span class=&quot;code-comment&quot;&gt;/* 142 */&lt;/span&gt;         &lt;span class=&quot;code-comment&quot;&gt;// update unsafe row buffer
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 143 */&lt;/span&gt;         agg_unsafeRowAggBuffer.setLong(0, agg_value9);
&lt;span class=&quot;code-comment&quot;&gt;/* 144 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 145 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 146 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldStop()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 147 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 148 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 149 */&lt;/span&gt;     agg_mapIter = agg_plan.finishAggregate(agg_hashMap, agg_sorter, agg_peakMemory, agg_spillSize);
&lt;span class=&quot;code-comment&quot;&gt;/* 150 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 151 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 152 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void sort_addToSorter() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
&lt;span class=&quot;code-comment&quot;&gt;/* 153 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!agg_initAgg) {
&lt;span class=&quot;code-comment&quot;&gt;/* 154 */&lt;/span&gt;       agg_initAgg = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 155 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; sort_beforeAgg = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.nanoTime();
&lt;span class=&quot;code-comment&quot;&gt;/* 156 */&lt;/span&gt;       agg_doAggregateWithKeys();
&lt;span class=&quot;code-comment&quot;&gt;/* 157 */&lt;/span&gt;       sort_aggTime.add((&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.nanoTime() - sort_beforeAgg) / 1000000);
&lt;span class=&quot;code-comment&quot;&gt;/* 158 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 159 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 160 */&lt;/span&gt;     &lt;span class=&quot;code-comment&quot;&gt;// output the result
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 161 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 162 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (agg_mapIter.next()) {
&lt;span class=&quot;code-comment&quot;&gt;/* 163 */&lt;/span&gt;       sort_numOutputRows.add(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 164 */&lt;/span&gt;       UnsafeRow agg_aggKey = (UnsafeRow) agg_mapIter.getKey();
&lt;span class=&quot;code-comment&quot;&gt;/* 165 */&lt;/span&gt;       UnsafeRow agg_aggBuffer = (UnsafeRow) agg_mapIter.getValue();
&lt;span class=&quot;code-comment&quot;&gt;/* 166 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 167 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull11 = agg_aggKey.isNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 168 */&lt;/span&gt;       UTF8String agg_value12 = agg_isNull11 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (agg_aggKey.getUTF8String(0));
&lt;span class=&quot;code-comment&quot;&gt;/* 169 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; agg_isNull12 = agg_aggKey.isNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 170 */&lt;/span&gt;       UTF8String agg_value13 = agg_isNull12 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (agg_aggKey.getUTF8String(1));
&lt;span class=&quot;code-comment&quot;&gt;/* 171 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; agg_value14 = agg_aggBuffer.getLong(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 172 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 173 */&lt;/span&gt;       agg_holder1.reset();
&lt;span class=&quot;code-comment&quot;&gt;/* 174 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 175 */&lt;/span&gt;       agg_rowWriter1.zeroOutNullBytes();
&lt;span class=&quot;code-comment&quot;&gt;/* 176 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 177 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_isNull11) {
&lt;span class=&quot;code-comment&quot;&gt;/* 178 */&lt;/span&gt;         agg_rowWriter1.setNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 179 */&lt;/span&gt;       } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 180 */&lt;/span&gt;         agg_rowWriter1.write(0, agg_value12);
&lt;span class=&quot;code-comment&quot;&gt;/* 181 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 182 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 183 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_isNull12) {
&lt;span class=&quot;code-comment&quot;&gt;/* 184 */&lt;/span&gt;         agg_rowWriter1.setNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 185 */&lt;/span&gt;       } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 186 */&lt;/span&gt;         agg_rowWriter1.write(1, agg_value13);
&lt;span class=&quot;code-comment&quot;&gt;/* 187 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 188 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 189 */&lt;/span&gt;       agg_rowWriter1.write(2, agg_value14);
&lt;span class=&quot;code-comment&quot;&gt;/* 190 */&lt;/span&gt;       agg_result1.setTotalSize(agg_holder1.totalSize());
&lt;span class=&quot;code-comment&quot;&gt;/* 191 */&lt;/span&gt;       sort_sorter.insertRow((UnsafeRow)agg_result1);
&lt;span class=&quot;code-comment&quot;&gt;/* 192 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 193 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldStop()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 194 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 195 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 196 */&lt;/span&gt;     agg_mapIter.close();
&lt;span class=&quot;code-comment&quot;&gt;/* 197 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (agg_sorter == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 198 */&lt;/span&gt;       agg_hashMap.free();
&lt;span class=&quot;code-comment&quot;&gt;/* 199 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 200 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 201 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 202 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 203 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void processNext() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
&lt;span class=&quot;code-comment&quot;&gt;/* 204 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sort_needToSort) {
&lt;span class=&quot;code-comment&quot;&gt;/* 205 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; sort_spillSizeBefore = sort_metrics.memoryBytesSpilled();
&lt;span class=&quot;code-comment&quot;&gt;/* 206 */&lt;/span&gt;       sort_addToSorter();
&lt;span class=&quot;code-comment&quot;&gt;/* 207 */&lt;/span&gt;       sort_sortedIter = sort_sorter.sort();
&lt;span class=&quot;code-comment&quot;&gt;/* 208 */&lt;/span&gt;       sort_sortTime.add(sort_sorter.getSortTimeNanos() / 1000000);
&lt;span class=&quot;code-comment&quot;&gt;/* 209 */&lt;/span&gt;       sort_peakMemory.add(sort_sorter.getPeakMemoryUsage());
&lt;span class=&quot;code-comment&quot;&gt;/* 210 */&lt;/span&gt;       sort_spillSize.add(sort_metrics.memoryBytesSpilled() - sort_spillSizeBefore);
&lt;span class=&quot;code-comment&quot;&gt;/* 211 */&lt;/span&gt;       sort_metrics.incPeakExecutionMemory(sort_sorter.getPeakMemoryUsage());
&lt;span class=&quot;code-comment&quot;&gt;/* 212 */&lt;/span&gt;       sort_needToSort = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 213 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 214 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 215 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (sort_sortedIter.hasNext()) {
&lt;span class=&quot;code-comment&quot;&gt;/* 216 */&lt;/span&gt;       UnsafeRow sort_outputRow = (UnsafeRow)sort_sortedIter.next();
&lt;span class=&quot;code-comment&quot;&gt;/* 217 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 218 */&lt;/span&gt;       append(sort_outputRow);
&lt;span class=&quot;code-comment&quot;&gt;/* 219 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 220 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldStop()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 221 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 222 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 223 */&lt;/span&gt; }


&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15331375" author="robbinspg" created="Wed, 15 Jun 2016 08:19:52 +0000"  >&lt;p&gt;and the plan:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;== Parsed Logical Plan ==
&apos;Project [unresolvedalias(&apos;Origin, None), unresolvedalias(&apos;UniqueCarrier, None), &apos;round(((&apos;count * 100) / &apos;total), 2) AS rank#173]
+- Project [Origin#16, UniqueCarrier#8, count#134L, total#97L]
   +- Join Inner, ((Origin#16 = Origin#155) &amp;amp;&amp;amp; (UniqueCarrier#8 = UniqueCarrier#147))
      :- Aggregate [Origin#16, UniqueCarrier#8], [Origin#16, UniqueCarrier#8, count(1) AS count#134L]
      :  +- Filter (NOT (Cancelled#21 = 0) &amp;amp;&amp;amp; (CancellationCode#22 = A))
      :     +- Filter (Dest#17 = ORD)
      :        +- Relation[Year#0,Month#1,DayofMonth#2,DayOfWeek#3,DepTime#4,CRSDepTime#5,ArrTime#6,CRSArrTime#7,UniqueCarrier#8,FlightNum#9,TailNum#10,ActualElapsedTime#11,CRSElapsedTime#12,AirTime#13,ArrDelay#14,DepDelay#15,Origin#16,Dest#17,Distance#18,TaxiIn#19,TaxiOut#20,Cancelled#21,CancellationCode#22,Diverted#23,... 5 more fields] csv
      +- Project [Origin#155, UniqueCarrier#147, count#92L AS total#97L]
         +- Aggregate [Origin#155, UniqueCarrier#147], [Origin#155, UniqueCarrier#147, count(1) AS count#92L]
            +- Filter (Dest#156 = ORD)
               +- Relation[Year#139,Month#140,DayofMonth#141,DayOfWeek#142,DepTime#143,CRSDepTime#144,ArrTime#145,CRSArrTime#146,UniqueCarrier#147,FlightNum#148,TailNum#149,ActualElapsedTime#150,CRSElapsedTime#151,AirTime#152,ArrDelay#153,DepDelay#154,Origin#155,Dest#156,Distance#157,TaxiIn#158,TaxiOut#159,Cancelled#160,CancellationCode#161,Diverted#162,... 5 more fields] csv

== Analyzed Logical Plan ==
Origin: string, UniqueCarrier: string, rank: double
Project [Origin#16, UniqueCarrier#8, round((cast((count#134L * cast(100 as bigint)) as double) / cast(total#97L as double)), 2) AS rank#173]
+- Project [Origin#16, UniqueCarrier#8, count#134L, total#97L]
   +- Join Inner, ((Origin#16 = Origin#155) &amp;amp;&amp;amp; (UniqueCarrier#8 = UniqueCarrier#147))
      :- Aggregate [Origin#16, UniqueCarrier#8], [Origin#16, UniqueCarrier#8, count(1) AS count#134L]
      :  +- Filter (NOT (Cancelled#21 = 0) &amp;amp;&amp;amp; (CancellationCode#22 = A))
      :     +- Filter (Dest#17 = ORD)
      :        +- Relation[Year#0,Month#1,DayofMonth#2,DayOfWeek#3,DepTime#4,CRSDepTime#5,ArrTime#6,CRSArrTime#7,UniqueCarrier#8,FlightNum#9,TailNum#10,ActualElapsedTime#11,CRSElapsedTime#12,AirTime#13,ArrDelay#14,DepDelay#15,Origin#16,Dest#17,Distance#18,TaxiIn#19,TaxiOut#20,Cancelled#21,CancellationCode#22,Diverted#23,... 5 more fields] csv
      +- Project [Origin#155, UniqueCarrier#147, count#92L AS total#97L]
         +- Aggregate [Origin#155, UniqueCarrier#147], [Origin#155, UniqueCarrier#147, count(1) AS count#92L]
            +- Filter (Dest#156 = ORD)
               +- Relation[Year#139,Month#140,DayofMonth#141,DayOfWeek#142,DepTime#143,CRSDepTime#144,ArrTime#145,CRSArrTime#146,UniqueCarrier#147,FlightNum#148,TailNum#149,ActualElapsedTime#150,CRSElapsedTime#151,AirTime#152,ArrDelay#153,DepDelay#154,Origin#155,Dest#156,Distance#157,TaxiIn#158,TaxiOut#159,Cancelled#160,CancellationCode#161,Diverted#162,... 5 more fields] csv

== Optimized Logical Plan ==
Project [Origin#16, UniqueCarrier#8, round((cast((count#134L * 100) as double) / cast(total#97L as double)), 2) AS rank#173]
+- Join Inner, ((Origin#16 = Origin#155) &amp;amp;&amp;amp; (UniqueCarrier#8 = UniqueCarrier#147))
   :- Aggregate [Origin#16, UniqueCarrier#8], [Origin#16, UniqueCarrier#8, count(1) AS count#134L]
   :  +- Project [UniqueCarrier#8, Origin#16]
   :     +- Filter (((((((isnotnull(Origin#16) &amp;amp;&amp;amp; isnotnull(UniqueCarrier#8)) &amp;amp;&amp;amp; isnotnull(Cancelled#21)) &amp;amp;&amp;amp; isnotnull(CancellationCode#22)) &amp;amp;&amp;amp; NOT (Cancelled#21 = 0)) &amp;amp;&amp;amp; (CancellationCode#22 = A)) &amp;amp;&amp;amp; isnotnull(Dest#17)) &amp;amp;&amp;amp; (Dest#17 = ORD))
   :        +- Relation[Year#0,Month#1,DayofMonth#2,DayOfWeek#3,DepTime#4,CRSDepTime#5,ArrTime#6,CRSArrTime#7,UniqueCarrier#8,FlightNum#9,TailNum#10,ActualElapsedTime#11,CRSElapsedTime#12,AirTime#13,ArrDelay#14,DepDelay#15,Origin#16,Dest#17,Distance#18,TaxiIn#19,TaxiOut#20,Cancelled#21,CancellationCode#22,Diverted#23,... 5 more fields] csv
   +- Aggregate [Origin#155, UniqueCarrier#147], [Origin#155, UniqueCarrier#147, count(1) AS total#97L]
      +- Project [UniqueCarrier#147, Origin#155]
         +- Filter (((isnotnull(UniqueCarrier#147) &amp;amp;&amp;amp; isnotnull(Origin#155)) &amp;amp;&amp;amp; isnotnull(Dest#156)) &amp;amp;&amp;amp; (Dest#156 = ORD))
            +- Relation[Year#139,Month#140,DayofMonth#141,DayOfWeek#142,DepTime#143,CRSDepTime#144,ArrTime#145,CRSArrTime#146,UniqueCarrier#147,FlightNum#148,TailNum#149,ActualElapsedTime#150,CRSElapsedTime#151,AirTime#152,ArrDelay#153,DepDelay#154,Origin#155,Dest#156,Distance#157,TaxiIn#158,TaxiOut#159,Cancelled#160,CancellationCode#161,Diverted#162,... 5 more fields] csv

== Physical Plan ==
*Project [Origin#16, UniqueCarrier#8, round((cast((count#134L * 100) as double) / cast(total#97L as double)), 2) AS rank#173]
+- *SortMergeJoin [Origin#16, UniqueCarrier#8], [Origin#155, UniqueCarrier#147], Inner
   :- *Sort [Origin#16 ASC, UniqueCarrier#8 ASC], false, 0
   :  +- *HashAggregate(key=[Origin#16,UniqueCarrier#8], functions=[count(1)], output=[Origin#16,UniqueCarrier#8,count#134L])
   :     +- Exchange hashpartitioning(Origin#16, UniqueCarrier#8, 200)
   :        +- *HashAggregate(key=[Origin#16,UniqueCarrier#8], functions=[partial_count(1)], output=[Origin#16,UniqueCarrier#8,count#296L])
   :           +- *Project [UniqueCarrier#8, Origin#16]
   :              +- *Filter (((((((isnotnull(Origin#16) &amp;amp;&amp;amp; isnotnull(UniqueCarrier#8)) &amp;amp;&amp;amp; isnotnull(Cancelled#21)) &amp;amp;&amp;amp; isnotnull(CancellationCode#22)) &amp;amp;&amp;amp; NOT (Cancelled#21 = 0)) &amp;amp;&amp;amp; (CancellationCode#22 = A)) &amp;amp;&amp;amp; isnotnull(Dest#17)) &amp;amp;&amp;amp; (Dest#17 = ORD))
   :                 +- *Scan csv [UniqueCarrier#8,Origin#16,Dest#17,Cancelled#21,CancellationCode#22] Format: CSV, InputPaths: file:/home/robbins/brandberry/2008.csv, PushedFilters: [IsNotNull(Origin), IsNotNull(UniqueCarrier), IsNotNull(Cancelled), IsNotNull(CancellationCode), ..., ReadSchema: struct&amp;lt;UniqueCarrier:string,Origin:string,Dest:string,Cancelled:int,CancellationCode:string&amp;gt;
   +- *Sort [Origin#155 ASC, UniqueCarrier#147 ASC], false, 0
      +- *HashAggregate(key=[Origin#155,UniqueCarrier#147], functions=[count(1)], output=[Origin#155,UniqueCarrier#147,total#97L])
         +- Exchange hashpartitioning(Origin#155, UniqueCarrier#147, 200)
            +- *HashAggregate(key=[Origin#155,UniqueCarrier#147], functions=[partial_count(1)], output=[Origin#155,UniqueCarrier#147,count#303L])
               +- *Project [UniqueCarrier#147, Origin#155]
                  +- *Filter (((isnotnull(UniqueCarrier#147) &amp;amp;&amp;amp; isnotnull(Origin#155)) &amp;amp;&amp;amp; isnotnull(Dest#156)) &amp;amp;&amp;amp; (Dest#156 = ORD))
                     +- *Scan csv [UniqueCarrier#147,Origin#155,Dest#156] Format: CSV, InputPaths: file:/home/robbins/brandberry/2008.csv, PushedFilters: [IsNotNull(UniqueCarrier), IsNotNull(Origin), IsNotNull(Dest), EqualTo(Dest,ORD)], ReadSchema: struct&amp;lt;UniqueCarrier:string,Origin:string,Dest:string&amp;gt;

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15331580" author="robbinspg" created="Wed, 15 Jun 2016 11:48:53 +0000"  >&lt;p&gt;I can also recreate this issue on Oracle JDK 1.8:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;#
# A fatal error has been detected by the Java Runtime Environment:
#
#  SIGSEGV (0xb) at pc=0x00007f0c65d06aec, pid=7521, tid=0x00007f0b69ffd700
#
# JRE version: Java(TM) SE Runtime Environment (8.0_92-b14) (build 1.8.0_92-b14)
# Java VM: Java HotSpot(TM) 64-Bit Server VM (25.92-b14 mixed mode linux-amd64 compressed oops)
# Problematic frame:
# J 7453 C1 org.apache.spark.unsafe.Platform.getByte(Ljava/lang/Object;J)B (9 bytes) @ 0x00007f0c65d06aec [0x00007f0c65d06ae0+0xc]
#
# Failed to write core dump. Core dumps have been disabled. To enable core dumping, try &quot;ulimit -c unlimited&quot; before starting Java again
#
# If you would like to submit a bug report, please visit:
#   http://bugreport.java.com/bugreport/crash.jsp
#

---------------  T H R E A D  ---------------

Current thread (0x00007f0bf4008800):  JavaThread &quot;Executor task launch worker-3&quot; daemon [_thread_in_Java, id=7662, stack(0x00007f0b69efd000,0x00007f0b69ffe000)]

siginfo: si_signo: 11 (SIGSEGV), si_code: 1 (SEGV_MAPERR), si_addr: 0x0000000002868e54

Registers:
RAX=0x00007f0c461abb38, RBX=0x00007f0c461abb38, RCX=0x00007f0c213547c8, RDX=0x0000000002868e54
RSP=0x00007f0b69ffba40, RBP=0x00007f0b69ffbae0, RSI=0x0000000000000000, RDI=0x00000001008254d8
R8 =0x00000000200bd0a6, R9 =0x00000000d9fa2650, R10=0x00007f0c79d39020, R11=0x00007f0c65d06ae0
R12=0x0000000000000000, R13=0x00007f0b69ffba88, R14=0x00007f0b69ffbaf8, R15=0x00007f0bf4008800
RIP=0x00007f0c65d06aec, EFLAGS=0x0000000000010202, CSGSFS=0x0000000000000033, ERR=0x0000000000000004
  TRAPNO=0x000000000000000e

Top of Stack: (sp=0x00007f0b69ffba40)
0x00007f0b69ffba40:   00007f0b684b4a70 0000000000000000
0x00007f0b69ffba50:   00007f0b69ffbb10 00007f0c65e96d4c
0x00007f0b69ffba60:   00007f0c65008040 00000000d9fa2628
0x00007f0b69ffba70:   00007f0b69ffbae0 00007f0c650079c0
0x00007f0b69ffba80:   00007f0c650079c0 0000000002868e54
0x00007f0b69ffba90:   0000000000000030 0000000000000000
0x00007f0b69ffbaa0:   00007f0b69ffbaa0 00007f0c21351403
0x00007f0b69ffbab0:   00007f0b69ffbaf8 00007f0c213547c8
0x00007f0b69ffbac0:   0000000000000000 00007f0c21351428
0x00007f0b69ffbad0:   00007f0b69ffba88 00007f0b69ffbaf0
0x00007f0b69ffbae0:   00007f0b69ffbb48 00007f0c650079c0
0x00007f0b69ffbaf0:   0000000000000000 00000000d9f57cf0
0x00007f0b69ffbb00:   000000000000004c 00007f0b69ffbb08
0x00007f0b69ffbb10:   00007f0c21353726 00007f0b69ffbb78
0x00007f0b69ffbb20:   00007f0c213547c8 0000000000000000
0x00007f0b69ffbb30:   00007f0c213537a0 00007f0b69ffbaf0
0x00007f0b69ffbb40:   00007f0b69ffbb70 00007f0b69ffbbc0
0x00007f0b69ffbb50:   00007f0c65007d00 0000000000000000
0x00007f0b69ffbb60:   0000000000000000 0000000000000003
0x00007f0b69ffbb70:   00000000d9f57cf0 00000000d9fa33b0
0x00007f0b69ffbb80:   00007f0b69ffbb80 00007f0c2135385a
0x00007f0b69ffbb90:   00007f0b69ffbbd8 00007f0c213547c8
0x00007f0b69ffbba0:   0000000000000000 00007f0c21353880
0x00007f0b69ffbbb0:   00007f0b69ffbb70 00007f0b69ffbbd0
0x00007f0b69ffbbc0:   00007f0b69ffbc20 00007f0c65007d00
0x00007f0b69ffbbd0:   00000000d9f57cf0 00000000d9fa33b0
0x00007f0b69ffbbe0:   00007f0b69ffbbe0 00007f0b684a24e5
0x00007f0b69ffbbf0:   00007f0b69ffbc88 00007f0b684a2950
0x00007f0b69ffbc00:   0000000000000000 00007f0b684a2618
0x00007f0b69ffbc10:   00007f0b69ffbbd0 00007f0b69ffbc78
0x00007f0b69ffbc20:   00007f0b69ffbcd0 00007f0c65007a90
0x00007f0b69ffbc30:   0000000000000000 0000000000000000 

Instructions: (pc=0x00007f0c65d06aec)
0x00007f0c65d06acc:   0a 80 11 64 01 f8 12 fe 06 90 0c 64 01 f8 12 fe
0x00007f0c65d06adc:   06 90 0c 64 89 84 24 00 c0 fe ff 55 48 83 ec 30
0x00007f0c65d06aec:   0f be 04 16 c1 e0 18 c1 f8 18 48 83 c4 30 5d 85
0x00007f0c65d06afc:   05 ff f5 28 14 c3 90 90 49 8b 87 a8 02 00 00 49 

Register to memory mapping:

RAX={method} {0x00007f0c461abb38} &apos;getByte&apos; &apos;(Ljava/lang/Object;J)B&apos; in &apos;org/apache/spark/unsafe/Platform&apos;
RBX={method} {0x00007f0c461abb38} &apos;getByte&apos; &apos;(Ljava/lang/Object;J)B&apos; in &apos;org/apache/spark/unsafe/Platform&apos;
RCX=0x00007f0c213547c8 is pointing into metadata
RDX=0x0000000002868e54 is an unknown value
RSP=0x00007f0b69ffba40 is pointing into the stack for thread: 0x00007f0bf4008800
RBP=0x00007f0b69ffbae0 is pointing into the stack for thread: 0x00007f0bf4008800
RSI=0x0000000000000000 is an unknown value
RDI=0x00000001008254d8 is pointing into metadata
R8 =0x00000000200bd0a6 is an unknown value
R9 =0x00000000d9fa2650 is an oop
[B 
 - klass: {type array byte}
 - length: 48
R10=0x00007f0c79d39020: &amp;lt;offset 0xfbc020&amp;gt; in /home/robbins/sdks/jdk1.8.0_92/jre/lib/amd64/server/libjvm.so at 0x00007f0c78d7d000
R11=0x00007f0c65d06ae0 is at entry_point+0 in (nmethod*)0x00007f0c65d06990
R12=0x0000000000000000 is an unknown value
R13=0x00007f0b69ffba88 is pointing into the stack for thread: 0x00007f0bf4008800
R14=0x00007f0b69ffbaf8 is pointing into the stack for thread: 0x00007f0bf4008800
R15=0x00007f0bf4008800 is a thread


Stack: [0x00007f0b69efd000,0x00007f0b69ffe000],  sp=0x00007f0b69ffba40,  free space=1018k
Native frames: (J=compiled Java code, j=interpreted, Vv=VM code, C=native code)
J 7453 C1 org.apache.spark.unsafe.Platform.getByte(Ljava/lang/Object;J)B (9 bytes) @ 0x00007f0c65d06aec [0x00007f0c65d06ae0+0xc]
j  org.apache.spark.unsafe.types.UTF8String.getByte(I)B+11
j  org.apache.spark.unsafe.types.UTF8String.compareTo(Lorg/apache/spark/unsafe/types/UTF8String;)I+30
j  org.apache.spark.unsafe.types.UTF8String.compare(Lorg/apache/spark/unsafe/types/UTF8String;)I+2
j  org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIterator.findNextInnerJoinRows$(Lorg/apache/spark/sql/catalyst/expressions/GeneratedClass$GeneratedIterator;Lscala/collection/Iterator;Lscala/collection/Iterator;)Z+141
j  org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIterator.processNext()V+410
J 7795 C1 org.apache.spark.sql.execution.BufferedRowIterator.hasNext()Z (30 bytes) @ 0x00007f0c655268d4 [0x00007f0c65526660+0x274]
j  org.apache.spark.sql.execution.WholeStageCodegenExec$$anonfun$doExecute$3$$anon$2.hasNext()Z+4
J 5092 C2 scala.collection.Iterator$$anon$11.hasNext()Z (10 bytes) @ 0x00007f0c65c5f904 [0x00007f0c65c5f8a0+0x64]
j  scala.collection.convert.Wrappers$IteratorWrapper.hasNext()Z+4
j  org.spark_project.guava.collect.Ordering.leastOf(Ljava/util/Iterator;I)Ljava/util/List;+132
j  org.apache.spark.util.collection.Utils$.takeOrdered(Lscala/collection/Iterator;ILscala/math/Ordering;)Lscala/collection/Iterator;+29
j  org.apache.spark.rdd.RDD$$anonfun$takeOrdered$1$$anonfun$30.apply(Lscala/collection/Iterator;)Lscala/collection/Iterator;+46
j  org.apache.spark.rdd.RDD$$anonfun$takeOrdered$1$$anonfun$30.apply(Ljava/lang/Object;)Ljava/lang/Object;+5
j  org.apache.spark.rdd.RDD$$anonfun$mapPartitions$1$$anonfun$apply$23.apply(Lorg/apache/spark/TaskContext;ILscala/collection/Iterator;)Lscala/collection/Iterator;+5
j  org.apache.spark.rdd.RDD$$anonfun$mapPartitions$1$$anonfun$apply$23.apply(Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;+13
j  org.apache.spark.rdd.MapPartitionsRDD.compute(Lorg/apache/spark/Partition;Lorg/apache/spark/TaskContext;)Lscala/collection/Iterator;+27
j  org.apache.spark.rdd.RDD.computeOrReadCheckpoint(Lorg/apache/spark/Partition;Lorg/apache/spark/TaskContext;)Lscala/collection/Iterator;+26
j  org.apache.spark.rdd.RDD.iterator(Lorg/apache/spark/Partition;Lorg/apache/spark/TaskContext;)Lscala/collection/Iterator;+33
j  org.apache.spark.scheduler.ResultTask.runTask(Lorg/apache/spark/TaskContext;)Ljava/lang/Object;+136
j  org.apache.spark.scheduler.Task.run(JILorg/apache/spark/metrics/MetricsSystem;)Ljava/lang/Object;+82
j  org.apache.spark.executor.Executor$TaskRunner.run()V+374
j  java.util.concurrent.ThreadPoolExecutor.runWorker(Ljava/util/concurrent/ThreadPoolExecutor$Worker;)V+95
j  java.util.concurrent.ThreadPoolExecutor$Worker.run()V+5
j  java.lang.Thread.run()V+11
v  ~StubRoutines::call_stub
V  [libjvm.so+0x68e746]  JavaCalls::call_helper(JavaValue*, methodHandle*, JavaCallArguments*, Thread*)+0x1056
V  [libjvm.so+0x68ec51]  JavaCalls::call_virtual(JavaValue*, KlassHandle, Symbol*, Symbol*, JavaCallArguments*, Thread*)+0x321
V  [libjvm.so+0x68f0f7]  JavaCalls::call_virtual(JavaValue*, Handle, KlassHandle, Symbol*, Symbol*, Thread*)+0x47
V  [libjvm.so+0x726060]  thread_entry(JavaThread*, Thread*)+0xa0
V  [libjvm.so+0xa6cc5f]  JavaThread::thread_main_inner()+0xdf
V  [libjvm.so+0xa6cd8c]  JavaThread::run()+0x11c
V  [libjvm.so+0x91fad8]  java_start(Thread*)+0x108
C  [libpthread.so.0+0x7aa1]


&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15333462" author="robbinspg" created="Thu, 16 Jun 2016 09:44:31 +0000"  >&lt;p&gt;Tracing through  off heap memory allocation this looks like the segv is caused by the UTf8String base+offset still addressing a page that has recently been freed.&lt;/p&gt;</comment>
                            <comment id="15333586" author="robbinspg" created="Thu, 16 Jun 2016 11:17:30 +0000"  >&lt;p&gt;OK so I think I know what is happening! &lt;/p&gt;

&lt;p&gt;In the following generate SMJ code on line 058 the call to leftIter.next() will return either a Row constructed by pointing into a page OR for the final Row in the iterator it returns a copy of the row and the underlying memory pages are freed in cleanupResources. This now means that any Rows previously returned from the iterator are invalid as they are addressing freed memory. In the case where I see the segv the Row assigned to smj_value6 is pointing into freed memory and this causes the  segmentation fault.&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 001 */&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; generate(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references) {
&lt;span class=&quot;code-comment&quot;&gt;/* 002 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; GeneratedIterator(references);
&lt;span class=&quot;code-comment&quot;&gt;/* 003 */&lt;/span&gt; }
&lt;span class=&quot;code-comment&quot;&gt;/* 004 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 005 */&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;GeneratedIterator &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; org.apache.spark.sql.execution.BufferedRowIterator {
&lt;span class=&quot;code-comment&quot;&gt;/* 006 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references;
&lt;span class=&quot;code-comment&quot;&gt;/* 007 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; scala.collection.Iterator smj_leftInput;
&lt;span class=&quot;code-comment&quot;&gt;/* 008 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; scala.collection.Iterator smj_rightInput;
&lt;span class=&quot;code-comment&quot;&gt;/* 009 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; InternalRow smj_leftRow;
&lt;span class=&quot;code-comment&quot;&gt;/* 010 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; InternalRow smj_rightRow;
&lt;span class=&quot;code-comment&quot;&gt;/* 011 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UTF8String smj_value4;
&lt;span class=&quot;code-comment&quot;&gt;/* 012 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UTF8String smj_value5;
&lt;span class=&quot;code-comment&quot;&gt;/* 013 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; java.util.ArrayList smj_matches;
&lt;span class=&quot;code-comment&quot;&gt;/* 014 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UTF8String smj_value6;
&lt;span class=&quot;code-comment&quot;&gt;/* 015 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UTF8String smj_value7;
&lt;span class=&quot;code-comment&quot;&gt;/* 016 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UTF8String smj_value8;
&lt;span class=&quot;code-comment&quot;&gt;/* 017 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; smj_isNull4;
&lt;span class=&quot;code-comment&quot;&gt;/* 018 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UTF8String smj_value9;
&lt;span class=&quot;code-comment&quot;&gt;/* 019 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; smj_isNull5;
&lt;span class=&quot;code-comment&quot;&gt;/* 020 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; smj_value10;
&lt;span class=&quot;code-comment&quot;&gt;/* 021 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.execution.metric.SQLMetric smj_numOutputRows;
&lt;span class=&quot;code-comment&quot;&gt;/* 022 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UnsafeRow smj_result;
&lt;span class=&quot;code-comment&quot;&gt;/* 023 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder smj_holder;
&lt;span class=&quot;code-comment&quot;&gt;/* 024 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter smj_rowWriter;
&lt;span class=&quot;code-comment&quot;&gt;/* 025 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; UnsafeRow project_result;
&lt;span class=&quot;code-comment&quot;&gt;/* 026 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder project_holder;
&lt;span class=&quot;code-comment&quot;&gt;/* 027 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter project_rowWriter;
&lt;span class=&quot;code-comment&quot;&gt;/* 028 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 029 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; GeneratedIterator(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] references) {
&lt;span class=&quot;code-comment&quot;&gt;/* 030 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.references = references;
&lt;span class=&quot;code-comment&quot;&gt;/* 031 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 032 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 033 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void init(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; index, scala.collection.Iterator inputs[]) {
&lt;span class=&quot;code-comment&quot;&gt;/* 034 */&lt;/span&gt;     partitionIndex = index;
&lt;span class=&quot;code-comment&quot;&gt;/* 035 */&lt;/span&gt;     smj_leftInput = inputs[0];
&lt;span class=&quot;code-comment&quot;&gt;/* 036 */&lt;/span&gt;     smj_rightInput = inputs[1];
&lt;span class=&quot;code-comment&quot;&gt;/* 037 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 038 */&lt;/span&gt;     smj_rightRow = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 039 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 040 */&lt;/span&gt;     smj_matches = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; java.util.ArrayList();
&lt;span class=&quot;code-comment&quot;&gt;/* 041 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 042 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.smj_numOutputRows = (org.apache.spark.sql.execution.metric.SQLMetric) references[0];
&lt;span class=&quot;code-comment&quot;&gt;/* 043 */&lt;/span&gt;     smj_result = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow(6);
&lt;span class=&quot;code-comment&quot;&gt;/* 044 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.smj_holder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder(smj_result, 128);
&lt;span class=&quot;code-comment&quot;&gt;/* 045 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.smj_rowWriter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(smj_holder, 6);
&lt;span class=&quot;code-comment&quot;&gt;/* 046 */&lt;/span&gt;     project_result = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UnsafeRow(3);
&lt;span class=&quot;code-comment&quot;&gt;/* 047 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.project_holder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.BufferHolder(project_result, 64);
&lt;span class=&quot;code-comment&quot;&gt;/* 048 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.project_rowWriter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; org.apache.spark.sql.catalyst.expressions.codegen.UnsafeRowWriter(project_holder, 3);
&lt;span class=&quot;code-comment&quot;&gt;/* 049 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 050 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 051 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; findNextInnerJoinRows(
&lt;span class=&quot;code-comment&quot;&gt;/* 052 */&lt;/span&gt;     scala.collection.Iterator leftIter,
&lt;span class=&quot;code-comment&quot;&gt;/* 053 */&lt;/span&gt;     scala.collection.Iterator rightIter) {
&lt;span class=&quot;code-comment&quot;&gt;/* 054 */&lt;/span&gt;     smj_leftRow = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 055 */&lt;/span&gt;     &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; comp = 0;
&lt;span class=&quot;code-comment&quot;&gt;/* 056 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (smj_leftRow == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 057 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!leftIter.hasNext()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 058 */&lt;/span&gt;       smj_leftRow = (InternalRow) leftIter.next();
&lt;span class=&quot;code-comment&quot;&gt;/* 059 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 060 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; smj_isNull = smj_leftRow.isNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 061 */&lt;/span&gt;       UTF8String smj_value = smj_isNull ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (smj_leftRow.getUTF8String(0));
&lt;span class=&quot;code-comment&quot;&gt;/* 062 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 063 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; smj_isNull1 = smj_leftRow.isNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 064 */&lt;/span&gt;       UTF8String smj_value1 = smj_isNull1 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (smj_leftRow.getUTF8String(1));
&lt;span class=&quot;code-comment&quot;&gt;/* 065 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (smj_isNull || smj_isNull1) {
&lt;span class=&quot;code-comment&quot;&gt;/* 066 */&lt;/span&gt;         smj_leftRow = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 067 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 068 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 069 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!smj_matches.isEmpty()) {
&lt;span class=&quot;code-comment&quot;&gt;/* 070 */&lt;/span&gt;         comp = 0;
&lt;span class=&quot;code-comment&quot;&gt;/* 071 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comp == 0) {
&lt;span class=&quot;code-comment&quot;&gt;/* 072 */&lt;/span&gt;           comp = smj_value.compare(smj_value6);
&lt;span class=&quot;code-comment&quot;&gt;/* 073 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 074 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comp == 0) {
&lt;span class=&quot;code-comment&quot;&gt;/* 075 */&lt;/span&gt;           comp = smj_value1.compare(smj_value7);
&lt;span class=&quot;code-comment&quot;&gt;/* 076 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 077 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 078 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comp == 0) {
&lt;span class=&quot;code-comment&quot;&gt;/* 079 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 080 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 081 */&lt;/span&gt;         smj_matches.clear();
&lt;span class=&quot;code-comment&quot;&gt;/* 082 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 083 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 084 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 085 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (smj_rightRow == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 086 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!rightIter.hasNext()) {
&lt;span class=&quot;code-comment&quot;&gt;/* 087 */&lt;/span&gt;             smj_value6 = smj_value;
&lt;span class=&quot;code-comment&quot;&gt;/* 088 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 089 */&lt;/span&gt;             smj_value7 = smj_value1;
&lt;span class=&quot;code-comment&quot;&gt;/* 090 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 091 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; !smj_matches.isEmpty();
&lt;span class=&quot;code-comment&quot;&gt;/* 092 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 093 */&lt;/span&gt;           smj_rightRow = (InternalRow) rightIter.next();
&lt;span class=&quot;code-comment&quot;&gt;/* 094 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 095 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; smj_isNull2 = smj_rightRow.isNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 096 */&lt;/span&gt;           UTF8String smj_value2 = smj_isNull2 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (smj_rightRow.getUTF8String(0));
&lt;span class=&quot;code-comment&quot;&gt;/* 097 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 098 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; smj_isNull3 = smj_rightRow.isNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 099 */&lt;/span&gt;           UTF8String smj_value3 = smj_isNull3 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (smj_rightRow.getUTF8String(1));
&lt;span class=&quot;code-comment&quot;&gt;/* 100 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (smj_isNull2 || smj_isNull3) {
&lt;span class=&quot;code-comment&quot;&gt;/* 101 */&lt;/span&gt;             smj_rightRow = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 102 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 103 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 104 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 105 */&lt;/span&gt;           smj_value4 = smj_value2;
&lt;span class=&quot;code-comment&quot;&gt;/* 106 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 107 */&lt;/span&gt;           smj_value5 = smj_value3;
&lt;span class=&quot;code-comment&quot;&gt;/* 108 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 109 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 110 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 111 */&lt;/span&gt;         comp = 0;
&lt;span class=&quot;code-comment&quot;&gt;/* 112 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comp == 0) {
&lt;span class=&quot;code-comment&quot;&gt;/* 113 */&lt;/span&gt;           comp = smj_value.compare(smj_value4);
&lt;span class=&quot;code-comment&quot;&gt;/* 114 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 115 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comp == 0) {
&lt;span class=&quot;code-comment&quot;&gt;/* 116 */&lt;/span&gt;           comp = smj_value1.compare(smj_value5);
&lt;span class=&quot;code-comment&quot;&gt;/* 117 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 118 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 119 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comp &amp;gt; 0) {
&lt;span class=&quot;code-comment&quot;&gt;/* 120 */&lt;/span&gt;           smj_rightRow = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 121 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comp &amp;lt; 0) {
&lt;span class=&quot;code-comment&quot;&gt;/* 122 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!smj_matches.isEmpty()) {
&lt;span class=&quot;code-comment&quot;&gt;/* 123 */&lt;/span&gt;             smj_value6 = smj_value;
&lt;span class=&quot;code-comment&quot;&gt;/* 124 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 125 */&lt;/span&gt;             smj_value7 = smj_value1;
&lt;span class=&quot;code-comment&quot;&gt;/* 126 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 127 */&lt;/span&gt;             &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 128 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 129 */&lt;/span&gt;           smj_leftRow = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 130 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 131 */&lt;/span&gt;           smj_matches.add(smj_rightRow.copy());
&lt;span class=&quot;code-comment&quot;&gt;/* 132 */&lt;/span&gt;           smj_rightRow = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;;
&lt;span class=&quot;code-comment&quot;&gt;/* 133 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 134 */&lt;/span&gt;       } &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (smj_leftRow != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
&lt;span class=&quot;code-comment&quot;&gt;/* 135 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 136 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;// unreachable
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;/* 137 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 138 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 139 */&lt;/span&gt;   &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void processNext() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; java.io.IOException {
&lt;span class=&quot;code-comment&quot;&gt;/* 140 */&lt;/span&gt;     &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (findNextInnerJoinRows(smj_leftInput, smj_rightInput)) {
&lt;span class=&quot;code-comment&quot;&gt;/* 141 */&lt;/span&gt;       &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; smj_size = smj_matches.size();
&lt;span class=&quot;code-comment&quot;&gt;/* 142 */&lt;/span&gt;       smj_isNull4 = smj_leftRow.isNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 143 */&lt;/span&gt;       smj_value8 = smj_isNull4 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (smj_leftRow.getUTF8String(0));
&lt;span class=&quot;code-comment&quot;&gt;/* 144 */&lt;/span&gt;       smj_isNull5 = smj_leftRow.isNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 145 */&lt;/span&gt;       smj_value9 = smj_isNull5 ? &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; : (smj_leftRow.getUTF8String(1));
&lt;span class=&quot;code-comment&quot;&gt;/* 146 */&lt;/span&gt;       smj_value10 = smj_leftRow.getLong(2);
&lt;span class=&quot;code-comment&quot;&gt;/* 147 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; smj_i = 0; smj_i &amp;lt; smj_size; smj_i ++) {
&lt;span class=&quot;code-comment&quot;&gt;/* 148 */&lt;/span&gt;         InternalRow smj_rightRow1 = (InternalRow) smj_matches.get(smj_i);
&lt;span class=&quot;code-comment&quot;&gt;/* 149 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 150 */&lt;/span&gt;         smj_numOutputRows.add(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 151 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 152 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; smj_value13 = smj_rightRow1.getLong(2);
&lt;span class=&quot;code-comment&quot;&gt;/* 153 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; project_isNull8 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 154 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; project_value8 = -1.0;
&lt;span class=&quot;code-comment&quot;&gt;/* 155 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 156 */&lt;/span&gt;           project_value8 = (&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;) smj_value13;
&lt;span class=&quot;code-comment&quot;&gt;/* 157 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 158 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; project_isNull3 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 159 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; project_value3 = -1.0;
&lt;span class=&quot;code-comment&quot;&gt;/* 160 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (project_value8 == 0) {
&lt;span class=&quot;code-comment&quot;&gt;/* 161 */&lt;/span&gt;           project_isNull3 = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 162 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 163 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; project_value5 = -1L;
&lt;span class=&quot;code-comment&quot;&gt;/* 164 */&lt;/span&gt;           project_value5 = smj_value10 * 100L;
&lt;span class=&quot;code-comment&quot;&gt;/* 165 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; project_isNull4 = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 166 */&lt;/span&gt;           &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; project_value4 = -1.0;
&lt;span class=&quot;code-comment&quot;&gt;/* 167 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) {
&lt;span class=&quot;code-comment&quot;&gt;/* 168 */&lt;/span&gt;             project_value4 = (&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;) project_value5;
&lt;span class=&quot;code-comment&quot;&gt;/* 169 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 170 */&lt;/span&gt;           project_value3 = (&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;)(project_value4 / project_value8);
&lt;span class=&quot;code-comment&quot;&gt;/* 171 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 172 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; project_isNull2 = project_isNull3;
&lt;span class=&quot;code-comment&quot;&gt;/* 173 */&lt;/span&gt;         &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; project_value2 = -1.0;
&lt;span class=&quot;code-comment&quot;&gt;/* 174 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!project_isNull2) {
&lt;span class=&quot;code-comment&quot;&gt;/* 175 */&lt;/span&gt;           &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;.isNaN(project_value3) || &lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;.isInfinite(project_value3)) {
&lt;span class=&quot;code-comment&quot;&gt;/* 176 */&lt;/span&gt;             project_value2 = project_value3;
&lt;span class=&quot;code-comment&quot;&gt;/* 177 */&lt;/span&gt;           } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 178 */&lt;/span&gt;             project_value2 = java.math.BigDecimal.valueOf(project_value3).
&lt;span class=&quot;code-comment&quot;&gt;/* 179 */&lt;/span&gt;             setScale(2, java.math.BigDecimal.ROUND_HALF_UP).doubleValue();
&lt;span class=&quot;code-comment&quot;&gt;/* 180 */&lt;/span&gt;           }
&lt;span class=&quot;code-comment&quot;&gt;/* 181 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 182 */&lt;/span&gt;         project_holder.reset();
&lt;span class=&quot;code-comment&quot;&gt;/* 183 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 184 */&lt;/span&gt;         project_rowWriter.zeroOutNullBytes();
&lt;span class=&quot;code-comment&quot;&gt;/* 185 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 186 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (smj_isNull4) {
&lt;span class=&quot;code-comment&quot;&gt;/* 187 */&lt;/span&gt;           project_rowWriter.setNullAt(0);
&lt;span class=&quot;code-comment&quot;&gt;/* 188 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 189 */&lt;/span&gt;           project_rowWriter.write(0, smj_value8);
&lt;span class=&quot;code-comment&quot;&gt;/* 190 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 191 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 192 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (smj_isNull5) {
&lt;span class=&quot;code-comment&quot;&gt;/* 193 */&lt;/span&gt;           project_rowWriter.setNullAt(1);
&lt;span class=&quot;code-comment&quot;&gt;/* 194 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 195 */&lt;/span&gt;           project_rowWriter.write(1, smj_value9);
&lt;span class=&quot;code-comment&quot;&gt;/* 196 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 197 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 198 */&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (project_isNull2) {
&lt;span class=&quot;code-comment&quot;&gt;/* 199 */&lt;/span&gt;           project_rowWriter.setNullAt(2);
&lt;span class=&quot;code-comment&quot;&gt;/* 200 */&lt;/span&gt;         } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
&lt;span class=&quot;code-comment&quot;&gt;/* 201 */&lt;/span&gt;           project_rowWriter.write(2, project_value2);
&lt;span class=&quot;code-comment&quot;&gt;/* 202 */&lt;/span&gt;         }
&lt;span class=&quot;code-comment&quot;&gt;/* 203 */&lt;/span&gt;         project_result.setTotalSize(project_holder.totalSize());
&lt;span class=&quot;code-comment&quot;&gt;/* 204 */&lt;/span&gt;         append(project_result.copy());
&lt;span class=&quot;code-comment&quot;&gt;/* 205 */&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;/* 206 */&lt;/span&gt;       }
&lt;span class=&quot;code-comment&quot;&gt;/* 207 */&lt;/span&gt;       &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldStop()) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;/* 208 */&lt;/span&gt;     }
&lt;span class=&quot;code-comment&quot;&gt;/* 209 */&lt;/span&gt;   }
&lt;span class=&quot;code-comment&quot;&gt;/* 210 */&lt;/span&gt; }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15333594" author="robbinspg" created="Thu, 16 Jun 2016 11:22:23 +0000"  >&lt;p&gt;Tracking where the memory is being allocated it is interesting that for the Executor that crashes (Executor task launch worker-3) the Unsafe off-heap memory is allocated in a much different address range than the other executors. I think the generated code is incorrect anyway but may be accidentally passing as sometimes the memory in the freed page is still accessible?&lt;/p&gt;

&lt;p&gt;org.apache.spark.unsafe.memory.UnsafeMemoryAllocator@7bf8aaef Executor task launch worker-3 UnsafeMemoryAllocator.allocated: 262144 at &lt;b&gt;28900976&lt;/b&gt;&lt;br/&gt;
org.apache.spark.unsafe.memory.UnsafeMemoryAllocator@7bf8aaef Executor task launch worker-1 UnsafeMemoryAllocator.allocated: 262144 at 140689774260048&lt;br/&gt;
org.apache.spark.unsafe.memory.UnsafeMemoryAllocator@7bf8aaef Executor task launch worker-4 UnsafeMemoryAllocator.allocated: 262144 at 140689572734864&lt;br/&gt;
org.apache.spark.unsafe.memory.UnsafeMemoryAllocator@7bf8aaef Executor task launch worker-7 UnsafeMemoryAllocator.allocated: 262144 at 140689908250560&lt;br/&gt;
org.apache.spark.unsafe.memory.UnsafeMemoryAllocator@7bf8aaef Executor task launch worker-8 UnsafeMemoryAllocator.allocated: 262144 at 140690243746416&lt;br/&gt;
org.apache.spark.unsafe.memory.UnsafeMemoryAllocator@7bf8aaef Executor task launch worker-0 UnsafeMemoryAllocator.allocated: 262144 at 140690176924448&lt;br/&gt;
org.apache.spark.unsafe.memory.UnsafeMemoryAllocator@7bf8aaef Executor task launch worker-5 UnsafeMemoryAllocator.allocated: 262144 at 140689773997888&lt;br/&gt;
org.apache.spark.unsafe.memory.UnsafeMemoryAllocator@7bf8aaef Executor task launch worker-6 UnsafeMemoryAllocator.allocated: 262144 at 140689707058576&lt;/p&gt;</comment>
                            <comment id="15334003" author="apachespark" created="Thu, 16 Jun 2016 15:35:05 +0000"  >&lt;p&gt;User &apos;robbinspg&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/13707&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/13707&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15335099" author="apachespark" created="Fri, 17 Jun 2016 00:43:03 +0000"  >&lt;p&gt;User &apos;hvanhovell&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/13723&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/13723&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15335443" author="davies" created="Fri, 17 Jun 2016 05:27:58 +0000"  >&lt;p&gt;Issue resolved by pull request 13723&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/13723&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/13723&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15464793" author="rhernando" created="Mon, 5 Sep 2016 11:29:33 +0000"  >&lt;p&gt;Encountered a similar error (using 2.0.0):&lt;/p&gt;

&lt;blockquote&gt;&lt;ol&gt;
	&lt;li&gt;SIGSEGV (0xb) at pc=0x00007fbb355dfd6c, pid=5592, tid=0x00007faa9f2f4700&lt;br/&gt;
#&lt;/li&gt;
	&lt;li&gt;JRE version: Java(TM) SE Runtime Environment (8.0_101-b13) (build 1.8.0_101-b13)&lt;/li&gt;
	&lt;li&gt;Java VM: Java HotSpot(TM) 64-Bit Server VM (25.101-b13 mixed mode linux-amd64 )&lt;/li&gt;
	&lt;li&gt;Problematic frame:&lt;/li&gt;
	&lt;li&gt;J 4895 C1 org.apache.spark.unsafe.Platform.getLong(Ljava/lang/Object;J)J (9 bytes) @ 0x00007fbb355dfd6c &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007fbb355dfd60+0xc&amp;#93;&lt;/span&gt;&lt;br/&gt;
#&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;

&lt;p&gt;I&apos;m not sure if it&apos;s related&lt;/p&gt;</comment>
                            <comment id="15464808" author="hvanhovell" created="Mon, 5 Sep 2016 11:40:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhernando&quot; class=&quot;user-hover&quot; rel=&quot;rhernando&quot;&gt;rhernando&lt;/a&gt; It should not be related to this one. Are you doing a broadcast hash join by any chance? &lt;/p&gt;</comment>
                            <comment id="15464860" author="rhernando" created="Mon, 5 Sep 2016 12:07:47 +0000"  >&lt;p&gt;I&apos;m doing joins between SQL views. Data source is JDBC to SQL server&lt;/p&gt;</comment>
                            <comment id="15464962" author="hvanhovell" created="Mon, 5 Sep 2016 13:05:46 +0000"  >&lt;p&gt;Could you share the query plan? &lt;/p&gt;</comment>
                            <comment id="15465316" author="rhernando" created="Mon, 5 Sep 2016 16:09:42 +0000"  >&lt;blockquote&gt;
&lt;p&gt;== Parsed Logical Plan ==&lt;br/&gt;
&apos;Project &lt;span class=&quot;error&quot;&gt;&amp;#91;*&amp;#93;&lt;/span&gt;&lt;br/&gt;
+- &apos;UnresolvedRelation `COEQ_63`&lt;/p&gt;

&lt;p&gt;== Analyzed Logical Plan ==&lt;br/&gt;
InstanceId: bigint, price: double, ZoneId: int, priceItemId: int, priceId: int&lt;br/&gt;
Project &lt;a href=&quot;#20236L, price#20237, ZoneId#20239, priceItemId#20242, priceId#20244&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;InstanceId#20236L, price#20237, ZoneId#20239, priceItemId#20242, priceId#20244&lt;/a&gt;&lt;br/&gt;
+- SubqueryAlias coeq_63&lt;br/&gt;
   +- Project &lt;a href=&quot;#143L AS InstanceId#20236L, SL_RD_ColR_N#189 AS price#20237, 24 AS ZoneId#20239, 6 AS priceItemId#20242, 63 AS priceId#20244&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;_TableSL_SID#143L AS InstanceId#20236L, SL_RD_ColR_N#189 AS price#20237, 24 AS ZoneId#20239, 6 AS priceItemId#20242, 63 AS priceId#20244&lt;/a&gt;&lt;br/&gt;
      +- SubqueryAlias 6__input&lt;br/&gt;
         +- Relation&lt;a href=&quot;#143L,_TableP_DC_SID#144L,_TableSH_SID#145L,ID#146,Name#147,TableP_DCID#148,TableSHID#149,SL_ACT_GI_DTE#150,SL_Xcl_C#151,SL_Xcl_C#152,SL_Css_Cojs#153L,SL_Config#154,SL_CREATEDON# .......... 36 more fields&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;_TableSL_SID#143L,_TableP_DC_SID#144L,_TableSH_SID#145L,ID#146,Name#147,TableP_DCID#148,TableSHID#149,SL_ACT_GI_DTE#150,SL_Xcl_C#151,SL_Xcl_C#152,SL_Css_Cojs#153L,SL_Config#154,SL_CREATEDON# .......... 36 more fields&lt;/a&gt; JDBCRelation((select &lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;_TableSL_SID&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt;. ... &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;  FROM &lt;span class=&quot;error&quot;&gt;&amp;#91;sch&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt; JOIN sch.TPSLTables TPSLTables ON &lt;span class=&quot;error&quot;&gt;&amp;#91;TPSLTables&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;_TableSL_SID&amp;#93;&lt;/span&gt; = &lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;_TableSL_SID&amp;#93;&lt;/span&gt; where _TP = 24) input)&lt;/p&gt;

&lt;p&gt;== Optimized Logical Plan ==&lt;br/&gt;
Project &lt;a href=&quot;#143L AS InstanceId#20236L, SL_RD_ColR_N#189 AS price#20237, 24 AS ZoneId#20239, 6 AS priceItemId#20242, 63 AS priceId#20244&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;_TableSL_SID#143L AS InstanceId#20236L, SL_RD_ColR_N#189 AS price#20237, 24 AS ZoneId#20239, 6 AS priceItemId#20242, 63 AS priceId#20244&lt;/a&gt;&lt;br/&gt;
+- InMemoryRelation &lt;a href=&quot;#143L, _TableP_DC_SID#144L, _TableSH_SID#145L, ID#146, Name#147, ... 36 more fields&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;_TableSL_SID#143L, _TableP_DC_SID#144L, _TableSH_SID#145L, ID#146, Name#147, ... 36 more fields&lt;/a&gt;, true, 10000, StorageLevel(disk, memory, deserialized, 1 replicas)&lt;br/&gt;
   :  +- *Scan JDBCRelation((select &lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;_TableSL_SID&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;_TableP_DC_SID&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;_TableSH_SID&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;ID&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;Name&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;TableP_DCID&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;TableSHID&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;TPSLTables&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;SL_ACT_GI_DTE&amp;#93;&lt;/span&gt;,  ... &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt; FROM &lt;span class=&quot;error&quot;&gt;&amp;#91;sch&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt; JOIN sch.TPSLTables TPSLTables ON &lt;span class=&quot;error&quot;&gt;&amp;#91;TPSLTables&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;_TableSL_SID&amp;#93;&lt;/span&gt; = &lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;_TableSL_SID&amp;#93;&lt;/span&gt; where _TP = 24) input) &lt;a href=&quot;#143L,_TableP_DC_SID#144L,_TableSH_SID#145L,ID#146,Name#147,TableP_DCID#148,TableSHID#149,SL_ACT_GI_DTE#150,SL_Xcl_C#151,... 36 more fields&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;_TableSL_SID#143L,_TableP_DC_SID#144L,_TableSH_SID#145L,ID#146,Name#147,TableP_DCID#148,TableSHID#149,SL_ACT_GI_DTE#150,SL_Xcl_C#151,... 36 more fields&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;== Physical Plan ==&lt;br/&gt;
*Project &lt;a href=&quot;#143L AS InstanceId#20236L, SL_RD_ColR_N#189 AS price#20237, 24 AS ZoneId#20239, 6 AS priceItemId#20242, 63 AS priceId#20244&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;_TableSL_SID#143L AS InstanceId#20236L, SL_RD_ColR_N#189 AS price#20237, 24 AS ZoneId#20239, 6 AS priceItemId#20242, 63 AS priceId#20244&lt;/a&gt;&lt;br/&gt;
+- InMemoryTableScan &lt;a href=&quot;#143L, SL_RD_ColR_N#189&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;_TableSL_SID#143L, SL_RD_ColR_N#189&lt;/a&gt;&lt;br/&gt;
   :  +- InMemoryRelation &lt;a href=&quot;#143L, _TableP_DC_SID#144L, _TableSH_SID#145L, ID#146, Name#147, ... 36 more fields&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;_TableSL_SID#143L, _TableP_DC_SID#144L, _TableSH_SID#145L, ID#146, Name#147, ... 36 more fields&lt;/a&gt;, true, 10000, StorageLevel(disk, memory, deserialized, 1 replicas)&lt;br/&gt;
   :     :  +- *Scan JDBCRelation((select &lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;_TableSL_SID&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;_TableP_DC_SID&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;_TableSH_SID&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;ID&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;Name&amp;#93;&lt;/span&gt;, &lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;TableP_DCID&amp;#93;&lt;/span&gt;,  ... &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt; FROM &lt;span class=&quot;error&quot;&gt;&amp;#91;sch&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt; JOIN sch.TPSLTables TPSLTables ON &lt;span class=&quot;error&quot;&gt;&amp;#91;TPSLTables&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;_TableSL_SID&amp;#93;&lt;/span&gt; = &lt;span class=&quot;error&quot;&gt;&amp;#91;SLTables&amp;#93;&lt;/span&gt;.&lt;span class=&quot;error&quot;&gt;&amp;#91;_TableSL_SID&amp;#93;&lt;/span&gt; where _TP = 24) input) &lt;a href=&quot;#143L,_TableP_DC_SID#144L,_TableSH_SID#145L,ID#146,Name#147,,... 36 more fields&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;_TableSL_SID#143L,_TableP_DC_SID#144L,_TableSH_SID#145L,ID#146,Name#147,,... 36 more fields&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="15465335" author="hvanhovell" created="Mon, 5 Sep 2016 16:14:08 +0000"  >&lt;p&gt;Thanks! Do you also have this problem when you don&apos;t cache the table?&lt;/p&gt;</comment>
                            <comment id="15465338" author="hvanhovell" created="Mon, 5 Sep 2016 16:15:21 +0000"  >&lt;p&gt;Could you open a new ticket for this one? It is definitely not connected to this or the broadcast join issue.&lt;/p&gt;</comment>
                            <comment id="15465342" author="rhernando" created="Mon, 5 Sep 2016 16:17:15 +0000"  >&lt;p&gt;Thank you!&lt;/p&gt;

&lt;p&gt;I&apos;ll do it&lt;/p&gt;</comment>
                            <comment id="15465353" author="rhernando" created="Mon, 5 Sep 2016 16:24:00 +0000"  >&lt;p&gt;Created &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-17403&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-17403&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15633231" author="nseggert" created="Thu, 3 Nov 2016 15:54:35 +0000"  >&lt;p&gt;I think I&apos;m seeing this bug in 1.6.2 when using the G1 garbage collector (other GCs seem fine, oddly). Any chance the fix can be backported to the 1.6.x branch?&lt;/p&gt;</comment>
                            <comment id="15633480" author="hvanhovell" created="Thu, 3 Nov 2016 17:08:10 +0000"  >&lt;p&gt;What are you seeing? The InMemory cache issue or the broadcast join issue? They are not related.&lt;/p&gt;</comment>
                            <comment id="15633487" author="nseggert" created="Thu, 3 Nov 2016 17:10:34 +0000"  >&lt;p&gt;I&apos;m seeing the segmentation violation at &lt;/p&gt;

&lt;p&gt;org.apache.spark.unsafe.types.UTF8String.compareTo(Lorg/apache/spark/unsafe/types/UTF8String&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15633509" author="hvanhovell" created="Thu, 3 Nov 2016 17:15:47 +0000"  >&lt;p&gt;Could you share your plan? Are you using caching?&lt;/p&gt;</comment>
                            <comment id="15633719" author="nseggert" created="Thu, 3 Nov 2016 18:20:05 +0000"  >&lt;p&gt;Yes, I&apos;m caching right before the action that causes the crash.&lt;/p&gt;

&lt;p&gt;Here&apos;s the code snippet:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    g.vertices.cache
    val colorsDF = g.vertices.select(colorCol).distinct
    colorsDF.explain(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
    val colors = colorsDF.rdd.map(_.getString(0)).collect.toList
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and the explain output:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;== Parsed Logical Plan ==
Aggregate [idType#126], [idType#126]
+- Project [idType#126]
   +- Project [id#125,idType#126,date#127,uid#128]
      +- Filter (degree#132 &amp;lt; 100)
         +- Project [id#125,idType#126,date#127,uid#128,degree#132]
            +- Join Inner, Some((id#125 = id#130))
               :- LogicalRDD [id#125,idType#126,date#127,uid#128], MapPartitionsRDD[81] at createDataFrame at &lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt;.scala:67
               +- Aggregate [id#130], [id#130,&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;((count(1),mode=Complete,isDistinct=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) as &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) AS degree#132]
                  +- Project [id#130]
                     +- Generate explode(array(src#84,dst#85)), &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, None, [id#130]
                        +- LogicalRDD [src#84,dst#85,srcType#86,dstType#87,date#88,relationship#89], MapPartitionsRDD[46] at createDataFrame at &lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt;.scala:67

== Analyzed Logical Plan ==
idType: string
Aggregate [idType#126], [idType#126]
+- Project [idType#126]
   +- Project [id#125,idType#126,date#127,uid#128]
      +- Filter (degree#132 &amp;lt; 100)
         +- Project [id#125,idType#126,date#127,uid#128,degree#132]
            +- Join Inner, Some((id#125 = id#130))
               :- LogicalRDD [id#125,idType#126,date#127,uid#128], MapPartitionsRDD[81] at createDataFrame at &lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt;.scala:67
               +- Aggregate [id#130], [id#130,&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;((count(1),mode=Complete,isDistinct=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;) as &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) AS degree#132]
                  +- Project [id#130]
                     +- Generate explode(array(src#84,dst#85)), &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, None, [id#130]
                        +- LogicalRDD [src#84,dst#85,srcType#86,dstType#87,date#88,relationship#89], MapPartitionsRDD[46] at createDataFrame at &lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt;.scala:67

== Optimized Logical Plan ==
Aggregate [idType#126], [idType#126]
+- Project [idType#126]
   +- InMemoryRelation [id#125,idType#126,date#127,uid#128], &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, 10000, StorageLevel(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, 1), Project [id#125,idType#126,date#127,uid#128], None

== Physical Plan ==
TungstenAggregate(key=[idType#126], functions=[], output=[idType#126])
+- TungstenExchange hashpartitioning(idType#126,2400), None
   +- TungstenAggregate(key=[idType#126], functions=[], output=[idType#126])
      +- InMemoryColumnarTableScan [idType#126], InMemoryRelation [id#125,idType#126,date#127,uid#128], &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, 10000, StorageLevel(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, 1), Project [id#125,idType#126,date#127,uid#128], None
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Doesn&apos;t seem like anything too complicated.&lt;/p&gt;

&lt;p&gt;I&apos;ll also note that when I turn off Tungsten, I get various other errors. Is G1GC just not well-supported anymore? This step of my program runs fine with other GCs (I have problems later due to GC pauses, but that&apos;s another issue).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13059552">SPARK-20112</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 2 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2z5if:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>