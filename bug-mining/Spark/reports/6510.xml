<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:05:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-28062] HuberAggregator copies coefficients vector every time an instance is added</title>
                <link>https://issues.apache.org/jira/browse/SPARK-28062</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Every time an instance is added to the HuberAggregator, a copy of the coefficients vector is created (see code snippet below). This causes a performance degradation, which is particularly severe when the instances have long sparse feature vectors.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; add(instance: Instance): HuberAggregator = {
    instance &lt;span class=&quot;code-keyword&quot;&gt;match&lt;/span&gt; { &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; Instance(label, weight, features) =&amp;gt;
      require(numFeatures == features.size, s&lt;span class=&quot;code-quote&quot;&gt;&quot;Dimensions mismatch when adding &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; sample.&quot;&lt;/span&gt; +
        s&lt;span class=&quot;code-quote&quot;&gt;&quot; Expecting $numFeatures but got ${features.size}.&quot;&lt;/span&gt;)
      require(weight &amp;gt;= 0.0, s&lt;span class=&quot;code-quote&quot;&gt;&quot;instance weight, $weight has to be &amp;gt;= 0.0&quot;&lt;/span&gt;)

      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (weight == 0.0) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;
      &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; localFeaturesStd = bcFeaturesStd.value
      &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; localCoefficients = bcParameters.value.toArray.slice(0, numFeatures)
&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; localGradientSumArray = gradientSumArray

&lt;span class=&quot;code-comment&quot;&gt;// Snip
&lt;/span&gt;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The LeastSquaresAggregator class avoids this performance issue via the use of transient lazy class variables to store such reused values. Applying a similar approach to HuberAggregator gives a significant speed boost. Running the script below locally on my machine gives the following timing results:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Current implementation: 
    Time(s): 540.1439919471741
    Iterations: 26
    Intercept: 0.518109382890512
    Coefficients: [0.0, -0.2516936902000245, 0.0, 0.0, -0.19633887469839809, 0.0, -0.39565545053893925, 0.0, -0.18617574426698882, 0.0478922416670529]

Modified implementation to match LeastSquaresAggregator:
    Time(s): 46.82946586608887
    Iterations: 26
    Intercept: 0.5181093828893774
    Coefficients: [0.0, -0.25169369020031357, 0.0, 0.0, -0.1963388746927919, 0.0, -0.3956554505389966, 0.0, -0.18617574426702874, 0.04789224166878518]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;




&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-python&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; random &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; random, randint, seed
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; time

&lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; pyspark.ml.feature &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; OneHotEncoder
&lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; pyspark.ml.regression &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; LinearRegression
&lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; pyspark.sql &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; SparkSession

seed(0)

spark = SparkSession.builder.appName(&lt;span class=&quot;code-quote&quot;&gt;&apos;huber-speed-test&apos;&lt;/span&gt;).getOrCreate()
df = spark.createDataFrame([[randint(0, 100000), random()] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;range&lt;/span&gt;(100000)],  [&lt;span class=&quot;code-quote&quot;&gt;&quot;category&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;target&quot;&lt;/span&gt;])
ohe = OneHotEncoder(inputCols=[&lt;span class=&quot;code-quote&quot;&gt;&quot;category&quot;&lt;/span&gt;], outputCols=[&lt;span class=&quot;code-quote&quot;&gt;&quot;encoded_category&quot;&lt;/span&gt;]).fit(df)
lr = LinearRegression(featuresCol=&lt;span class=&quot;code-quote&quot;&gt;&quot;encoded_category&quot;&lt;/span&gt;, labelCol=&lt;span class=&quot;code-quote&quot;&gt;&quot;target&quot;&lt;/span&gt;, loss=&lt;span class=&quot;code-quote&quot;&gt;&quot;huber&quot;&lt;/span&gt;, regParam=1.0)

start = time.time()
model = lr.fit(ohe.transform(df))
end = time.time()

&lt;span class=&quot;code-object&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;Time(s): &quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;str&lt;/span&gt;(end - start))
&lt;span class=&quot;code-object&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;Iterations: &quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;str&lt;/span&gt;(model.summary.totalIterations))
&lt;span class=&quot;code-object&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;Intercept: &quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;str&lt;/span&gt;(model.intercept))
&lt;span class=&quot;code-object&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;Coefficients: &quot;&lt;/span&gt; + &lt;span class=&quot;code-object&quot;&gt;str&lt;/span&gt;(&lt;span class=&quot;code-object&quot;&gt;list&lt;/span&gt;(model.coefficients)[0:10]))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="13239749">SPARK-28062</key>
            <summary>HuberAggregator copies coefficients vector every time an instance is added</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Andrew-C">Andrew Crosby</assignee>
                                    <reporter username="Andrew-C">Andrew Crosby</reporter>
                        <labels>
                    </labels>
                <created>Sat, 15 Jun 2019 19:24:45 +0000</created>
                <updated>Wed, 19 Jun 2019 14:00:35 +0000</updated>
                            <resolved>Wed, 19 Jun 2019 13:57:26 +0000</resolved>
                                    <version>3.0.0</version>
                                    <fixVersion>3.0.0</fixVersion>
                                    <component>ML</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="16867661" author="srowen" created="Wed, 19 Jun 2019 13:57:26 +0000"  >&lt;p&gt;Issue resolved by pull request 24880&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/24880&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/24880&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 21 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z03sc8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>