<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:55:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-21721] Memory leak in org.apache.spark.sql.hive.execution.InsertIntoHiveTable</title>
                <link>https://issues.apache.org/jira/browse/SPARK-21721</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;The leak came from org.apache.spark.sql.hive.execution.InsertIntoHiveTable. At line 118, it put a staging path to FileSystem delete cache, and then remove the path from disk at line 385. It does not remove the path from FileSystem cache. If a streaming application keep persisting data to a partitioned hive table, the memory will keep increasing until JVM terminated.&lt;/p&gt;

&lt;p&gt;Below is a simple code to reproduce it.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; test

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.SparkSession
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.fs.Path
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.fs.FileSystem
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.SaveMode
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.lang.reflect.Field



&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;PathLeakTest(id: Int, gp: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;)

object StagePathLeak {

  def main(args: Array[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;]): Unit = {

    val spark = SparkSession.builder().master(&lt;span class=&quot;code-quote&quot;&gt;&quot;local[4]&quot;&lt;/span&gt;).appName(&lt;span class=&quot;code-quote&quot;&gt;&quot;StagePathLeak&quot;&lt;/span&gt;).enableHiveSupport().getOrCreate()
    spark.conf.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;hive.exec.dynamic.partition.mode&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;nonstrict&quot;&lt;/span&gt;)
    &lt;span class=&quot;code-comment&quot;&gt;//create a partitioned table
&lt;/span&gt;    spark.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;drop table &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; exists path_leak&quot;&lt;/span&gt;);
    spark.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;create table &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; not exists path_leak(id &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)&quot;&lt;/span&gt; +
        &lt;span class=&quot;code-quote&quot;&gt;&quot; partitioned by (gp &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;)&quot;&lt;/span&gt;+
      &lt;span class=&quot;code-quote&quot;&gt;&quot; row format serde &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe&apos;&lt;/span&gt;&quot;&lt;/span&gt;+
      &lt;span class=&quot;code-quote&quot;&gt;&quot; stored as&quot;&lt;/span&gt;+
        &lt;span class=&quot;code-quote&quot;&gt;&quot; inputformat &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.hadoop.hive.ql.io.parquet.MapredParquetInputFormat&apos;&lt;/span&gt;&quot;&lt;/span&gt;+
        &lt;span class=&quot;code-quote&quot;&gt;&quot; outputformat &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.hadoop.hive.ql.io.parquet.MapredParquetOutputFormat&apos;&lt;/span&gt;&quot;&lt;/span&gt;)

    &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; seq = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; scala.collection.mutable.ArrayBuffer[PathLeakTest]()
    &lt;span class=&quot;code-comment&quot;&gt;// 2 partitions
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (x &amp;lt;- 1 to 2) {
      seq += (&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PathLeakTest(x, &lt;span class=&quot;code-quote&quot;&gt;&quot;g&quot;&lt;/span&gt; + x))
    }
    val rdd = spark.sparkContext.makeRDD[PathLeakTest](seq)

    &lt;span class=&quot;code-comment&quot;&gt;//insert 50 records to Hive table
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (j &amp;lt;- 1 to 50) {
      val df = spark.createDataFrame(rdd)
      &lt;span class=&quot;code-comment&quot;&gt;//#1 InsertIntoHiveTable line 118:  add stage path to FileSystem deleteOnExit cache
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;//#2 InsertIntoHiveTable line 385:  delete the path from disk but not from the FileSystem cache, and it caused the leak
&lt;/span&gt;      df.write.mode(SaveMode.Overwrite).insertInto(&lt;span class=&quot;code-quote&quot;&gt;&quot;path_leak&quot;&lt;/span&gt;)  
    }
    
    val fs = FileSystem.get(spark.sparkContext.hadoopConfiguration)
    val deleteOnExit = getDeleteOnExit(fs.getClass)
    deleteOnExit.setAccessible(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
    val caches = deleteOnExit.get(fs).asInstanceOf[java.util.TreeSet[Path]]
    &lt;span class=&quot;code-comment&quot;&gt;//check FileSystem deleteOnExit cache size
&lt;/span&gt;    println(caches.size())
    val it = caches.iterator()
    &lt;span class=&quot;code-comment&quot;&gt;//all starge pathes were still cached even they have already been deleted from the disk
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt;(it.hasNext()){
      println(it.next());
    }
  }
  
  def getDeleteOnExit(cls: &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;[_]) : Field = {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;{
       &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; cls.getDeclaredField(&lt;span class=&quot;code-quote&quot;&gt;&quot;deleteOnExit&quot;&lt;/span&gt;)
    }&lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt;{
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; ex: NoSuchFieldException =&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; getDeleteOnExit(cls.getSuperclass)
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
  }

}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;




</description>
                <environment></environment>
        <key id="13094373">SPARK-21721</key>
            <summary>Memory leak in org.apache.spark.sql.hive.execution.InsertIntoHiveTable</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="viirya">L. C. Hsieh</assignee>
                                    <reporter username="yzheng616">yzheng616</reporter>
                        <labels>
                    </labels>
                <created>Mon, 14 Aug 2017 02:53:26 +0000</created>
                <updated>Tue, 15 Aug 2017 15:49:13 +0000</updated>
                            <resolved>Tue, 15 Aug 2017 15:49:13 +0000</resolved>
                                    <version>2.0.2</version>
                    <version>2.1.1</version>
                    <version>2.2.0</version>
                                    <fixVersion>2.1.2</fixVersion>
                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>2.3.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16125217" author="viirya" created="Mon, 14 Aug 2017 04:22:33 +0000"  >&lt;p&gt;Submitted a PR at &lt;a href=&quot;https://github.com/apache/spark/pull/18934&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18934&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 14 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3iqon:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>