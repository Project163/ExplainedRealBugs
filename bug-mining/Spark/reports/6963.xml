<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:09:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-29438] Failed to get state store in stream-stream join</title>
                <link>https://issues.apache.org/jira/browse/SPARK-29438</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Now, Spark use the `TaskPartitionId` to determine the StateStore path.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
TaskPartitionId   \ 
StateStoreVersion  --&amp;gt; StoreProviderId -&amp;gt; StateStore
StateStoreName    /  
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In spark stages, the task partition id is determined by the number of tasks. As we said the StateStore file path depends on the task partition id. So if stream-stream join task partition id is changed against last batch, it will get wrong StateStore data or fail with non-exist StateStore data. In some corner cases, it happened. Following is a sample pseudocode:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val df3 = streamDf1.join(streamDf2)
val df5 = streamDf3.join(batchDf4)
val df = df3.union(df5)
df.writeStream...start()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;A simplified DAG like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
DataSourceV2Scan   Scan Relation     DataSourceV2Scan   DataSourceV2Scan
 (streamDf3)            |               (streamDf1)        (streamDf2)
     |                  |                   |                 |
  Exchange(200)      Exchange(200)       Exchange(200)     Exchange(200)
     |                  |                   |                 | 
   Sort                Sort                 |                 |
     \                  /                   \                 /
      \                /                     \               /
        SortMergeJoin                    StreamingSymmetricHashJoin
                     \                 /
                       \             /
                         \         /
                            Union
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Stream-Steam join task Id will start from 200 to 399 as they are in the same stage with `SortMergeJoin`. But when there is no new incoming data in `streamDf3` in some batch, it will generate a empty LocalRelation, and then the SortMergeJoin will be replaced with a BroadcastHashJoin. In this case, Stream-Steam join task Id will start from 1 to 200. Finally, it will get wrong StateStore path through TaskPartitionId, and failed with error reading state store delta file.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
LocalTableScan   Scan Relation     DataSourceV2Scan   DataSourceV2Scan
     |                  |                   |                 |
BroadcastExchange       |              Exchange(200)     Exchange(200)
     |                  |                   |                 | 
     |                  |                   |                 |
      \                /                     \               /
       \             /                        \             /
      BroadcastHashJoin                 StreamingSymmetricHashJoin
                     \                 /
                       \             /
                         \         /
                            Union
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In my job, I closed the auto BroadcastJoin feature (set spark.sql.autoBroadcastJoinThreshold=-1) to walk around this bug. We should make the StateStore path determinate but not depends on TaskPartitionId.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13261766">SPARK-29438</key>
            <summary>Failed to get state store in stream-stream join</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kabhwan">Jungtaek Lim</assignee>
                                    <reporter username="uncleGen">Genmao Yu</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Oct 2019 10:35:24 +0000</created>
                <updated>Tue, 14 Apr 2020 04:27:08 +0000</updated>
                            <resolved>Fri, 31 Jan 2020 04:22:56 +0000</resolved>
                                    <version>2.4.4</version>
                                    <fixVersion>3.0.0</fixVersion>
                                    <component>Structured Streaming</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16949365" author="unclegen" created="Fri, 11 Oct 2019 10:56:32 +0000"  >&lt;p&gt;There are several&#160;optional alternatives to resolve this issue:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Adding some rules to make the stream-stream join task partition id more determinate. In above cases, we can reorder the LogicalPlan in Union, i.e. making`StreamingSymmetricHashJoin` prior to `SortMergeJoin/BroadcastHashJoin`.&#160;&lt;/li&gt;
	&lt;li&gt;As said in desc, the&#160;StateStore path should not depend on the TaskPartitionId. We may get the&#160;StateStore path from&#160;StateStoreCoordinator. But this may increase some RPC load in Driver.&lt;/li&gt;
	&lt;li&gt;Dynamically disable the `autoBroadcastJoin` in some rules.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16949430" author="kabhwan" created="Fri, 11 Oct 2019 13:10:48 +0000"  >&lt;p&gt;Could you point out the codebase where you are referring? AFAIK it is determined by a pair of (operatorId, partitionId), not a pair of (taskId, partitionId). If there&apos;s a chance operatorId  changes, that would be pretty serious bug as state store will load completely wrong state.&lt;/p&gt;</comment>
                            <comment id="16949461" author="unclegen" created="Fri, 11 Oct 2019 13:43:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kabhwan&quot; class=&quot;user-hover&quot; rel=&quot;kabhwan&quot;&gt;kabhwan&lt;/a&gt; Yes, the whole statestore path is `CheckpointRoot/operatorId/taskPartitionId/version/`. The `taskPartitionId` may change in some corner case in subsequent batch, that is what I mean.&lt;/p&gt;</comment>
                            <comment id="16949465" author="kabhwan" created="Fri, 11 Oct 2019 13:49:43 +0000"  >&lt;p&gt;Could you please link the actual code block from Github repo?&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;current master branch&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/blob/6390f02f9fba059ec5d089a68c8d758aca35c9cd/sql/core/src/main/scala/org/apache/spark/sql/execution/streaming/state/StateStore.scala#L267-L280&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/6390f02f9fba059ec5d089a68c8d758aca35c9cd/sql/core/src/main/scala/org/apache/spark/sql/execution/streaming/state/StateStore.scala#L267-L280&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;current branch-2.4 branch&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/blob/4f46e8f804cba6d845116cb7daf9b4c682e6a0f1/sql/core/src/main/scala/org/apache/spark/sql/execution/streaming/state/StateStore.scala#L267-L280&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/4f46e8f804cba6d845116cb7daf9b4c682e6a0f1/sql/core/src/main/scala/org/apache/spark/sql/execution/streaming/state/StateStore.scala#L267-L280&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;current branch-2.3 branch&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/blob/75cc3b2da9ee0b51ecf0f13169f2b634e36a60c4/sql/core/src/main/scala/org/apache/spark/sql/execution/streaming/state/StateStore.scala#L265-L278&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/75cc3b2da9ee0b51ecf0f13169f2b634e36a60c4/sql/core/src/main/scala/org/apache/spark/sql/execution/streaming/state/StateStore.scala#L265-L278&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;using taskId in the path is completely new to me so would like to confirm.&lt;/p&gt;</comment>
                            <comment id="16953422" author="kabhwan" created="Thu, 17 Oct 2019 05:47:30 +0000"  >&lt;p&gt;Any updates here?&lt;/p&gt;</comment>
                            <comment id="16955798" author="kabhwan" created="Mon, 21 Oct 2019 06:30:37 +0000"  >&lt;p&gt;This would be pretty much easier to reproduce: make left side of union changing its number of partitions at any chance, then right side of union (stream-stream join, no need to be outer join) would throw error.&lt;/p&gt;

&lt;p&gt;The chance of having number of partitions changed from left side of union is pretty easy - for example, Kafka streaming source. It doesn&apos;t guarantee fixed number of partitions, which means the number of partitions can be changed between batches.&lt;/p&gt;

&lt;p&gt;It doesn&apos;t seem to hit an edge-case - fairly easy to reproduce, so priority of &apos;critical&apos; seems OK to me, and even I think it should be a &apos;blocker&apos; as the query can be crashed at any time.&lt;/p&gt;</comment>
                            <comment id="17027177" author="tdas" created="Fri, 31 Jan 2020 04:22:56 +0000"  >&lt;p&gt;Issue resolved by pull request 26162&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/26162&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/26162&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 41 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z07i48:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>