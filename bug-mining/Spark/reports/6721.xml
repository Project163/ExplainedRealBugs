<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:07:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-29336] The implementation of QuantileSummaries.merge  does not guarantee that the relativeError will be respected </title>
                <link>https://issues.apache.org/jira/browse/SPARK-29336</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Hello Spark maintainers,&lt;/p&gt;

&lt;p&gt;I was experimenting with my own implementation of the&#160;&lt;a href=&quot;http://infolab.stanford.edu/~datar/courses/cs361a/papers/quantiles.pdf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;space-efficient quantile algorithm&lt;/a&gt; in another language and I was using the Spark&apos;s one as a reference.&lt;/p&gt;

&lt;p&gt;In my analysis, I believe to have found an issue with the &lt;tt&gt;merge()&lt;/tt&gt; logic. Here is some simple Scala code that reproduces the issue I&apos;ve found:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; values = (1 to 100).toArray
val all_quantiles = values.indices.map(i =&amp;gt; (i+1).toDouble / values.length).toArray
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (n &amp;lt;- 0 until 5) {
  &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; df = spark.sparkContext.makeRDD(values).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;).repartition(5)
  val all_answers = df.stat.approxQuantile(&lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;, all_quantiles, 0.1)
  val all_answered_ranks = all_answers.map(ans =&amp;gt; values.indexOf(ans)).toArray
  val error = all_answered_ranks.zipWithIndex.map({ &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; (answer, expected) =&amp;gt; &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.abs(expected - answer) }).toArray
  val max_error = error.max
  print(max_error + &lt;span class=&quot;code-quote&quot;&gt;&quot;\n&quot;&lt;/span&gt;)
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I query for all possible quantiles in a 100-element array with a desired 10% max error. In this scenario, one would expect to observe a maximum error of 10 ranks or less (10% of 100). However, the output I observe is:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;16
12
10
11
17&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The variance is probably due to non-deterministic operations behind the scenes, but irrelevant to the core cause. (and sorry for my Scala, I&apos;m not used to it)&lt;/p&gt;

&lt;p&gt;Interestingly enough, if I change from five to one partition the code works as expected and gives 10 every time. This seems to point to some problem at the &lt;a href=&quot;https://github.com/apache/spark/blob/51d6ba7490eaac32fc33b8996fdf06b747884a54/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/util/QuantileSummaries.scala#L153-L171&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;merge logic&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The original authors (&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=clockfly&quot; class=&quot;user-hover&quot; rel=&quot;clockfly&quot;&gt;clockfly&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; for what I could dig from the history) suggest the published paper is not clear on how that should be done and, honestly, I was not confident in the current approach either.&lt;/p&gt;

&lt;p&gt;I&apos;ve found &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-21184&quot; title=&quot;QuantileSummaries implementation is wrong and QuantileSummariesSuite fails with larger n&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-21184&quot;&gt;&lt;del&gt;SPARK-21184&lt;/del&gt;&lt;/a&gt; that reports the same problem, but it was unfortunately closed with no fix applied.&lt;/p&gt;

&lt;p&gt;In my external implementation I believe to have found a sound way to implement the merge method. &lt;a href=&quot;https://github.com/sitegui/space-efficient-quantile/blob/188c74638c9840e5f47d6c6326b2886d47b149bc/src/modified_gk/summary.rs#L162-L218&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Here is my take in Rust, if relevant&lt;/a&gt;&lt;br/&gt;
I&apos;d be really glad to add unit tests and contribute my implementation adapted to Scala.&lt;br/&gt;
 I&apos;d love to hear your opinion on the matter.&lt;br/&gt;
Best regards&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13260183">SPARK-29336</key>
            <summary>The implementation of QuantileSummaries.merge  does not guarantee that the relativeError will be respected </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sitegui">Guilherme Souza</assignee>
                                    <reporter username="sitegui">Guilherme Souza</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 2 Oct 2019 20:31:23 +0000</created>
                <updated>Fri, 12 Apr 2024 13:22:50 +0000</updated>
                            <resolved>Tue, 8 Oct 2019 13:12:08 +0000</resolved>
                                    <version>2.4.3</version>
                                    <fixVersion>3.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16944046" author="sitegui" created="Thu, 3 Oct 2019 21:40:47 +0000"  >&lt;p&gt;I&apos;ve added a new test case that reproduces the problem here: &lt;a href=&quot;https://github.com/sitegui/spark/commit/fa123cf289c47ceeb6f84278ae028e5a46a85bf0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/sitegui/spark/commit/fa123cf289c47ceeb6f84278ae028e5a46a85bf0&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The problem is triggered specially when the merging summaries had seen an uneven number of samples.&lt;/p&gt;

&lt;p&gt;I&apos;ve managed to reproduce for exact splits as well, however that requires a larger number of samples.&lt;/p&gt;

&lt;p&gt;I&apos;m current working at a forked branch and will try to create a PR that fixes the issue in the following days.&lt;/p&gt;</comment>
                            <comment id="16945801" author="cloud_fan" created="Mon, 7 Oct 2019 11:27:53 +0000"  >&lt;p&gt;This algorithm was implemented in Spark many years ago: &lt;a href=&quot;https://github.com/apache/spark/pull/6042&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/6042&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=viirya&quot; class=&quot;user-hover&quot; rel=&quot;viirya&quot;&gt;viirya&lt;/a&gt; do you have any clue about the reported problem?&lt;/p&gt;</comment>
                            <comment id="16945985" author="viirya" created="Mon, 7 Oct 2019 15:57:38 +0000"  >&lt;p&gt;It is long time ago, but from the comment seems the merging algorithm is not clear in the paper. The fix in the proposed PR looks promising.&lt;/p&gt;</comment>
                            <comment id="16946187" author="viirya" created="Mon, 7 Oct 2019 20:12:31 +0000"  >&lt;p&gt;Actually I found the merging is changed by others since I implemented. Anyway, the fix I think can solve this.&lt;/p&gt;</comment>
                            <comment id="16946842" author="srowen" created="Tue, 8 Oct 2019 13:12:08 +0000"  >&lt;p&gt;Issue resolved by pull request 26029&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/26029&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/26029&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17081538" author="siddarthan" created="Sat, 11 Apr 2020 19:57:33 +0000"  >&lt;p&gt;We just upgraded from Spark 2.4.5 to 3.0.0-preview and hit an issue that seems related to this change.&lt;/p&gt;

&lt;p&gt;We were getting correctly computed quantiles on a dataframe with 200 partitions. After this change the results changed. When I run it with quantiles &lt;span class=&quot;error&quot;&gt;&amp;#91;0.8, 0.9, 1.0&amp;#93;&lt;/span&gt; I get the same values for 0.9 and 1.0. With spark 2.4.5 I get different values for 0.9 and 1.0. In fact, substantially different values. Relative error = 0.000001 and the results for 2.4.5 match the results when computing quantiles with pandas.&lt;/p&gt;

&lt;p&gt;I have not been able to debug further yet but this seems like a pretty serious regression.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13260043">SPARK-29325</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 31 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z078qw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>