<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:49:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-18403] ObjectHashAggregateSuite is being flaky (occasional OOM errors)</title>
                <link>https://issues.apache.org/jira/browse/SPARK-18403</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;This test suite fails occasionally on Jenkins due to OOM errors. I&apos;ve already reproduced it locally but haven&apos;t figured out the root cause.&lt;/p&gt;

&lt;p&gt;We should probably disable it temporarily before getting it fixed so that it doesn&apos;t break the PR build too often.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13019922">SPARK-18403</key>
            <summary>ObjectHashAggregateSuite is being flaky (occasional OOM errors)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lian cheng">Cheng Lian</assignee>
                                    <reporter username="lian cheng">Cheng Lian</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Nov 2016 19:34:09 +0000</created>
                <updated>Tue, 22 Nov 2016 06:54:12 +0000</updated>
                            <resolved>Thu, 10 Nov 2016 21:44:29 +0000</resolved>
                                    <version>2.2.0</version>
                                    <fixVersion>2.2.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15655058" author="apachespark" created="Thu, 10 Nov 2016 20:29:04 +0000"  >&lt;p&gt;User &apos;liancheng&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15845&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15845&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15655244" author="rxin" created="Thu, 10 Nov 2016 21:44:29 +0000"  >&lt;p&gt;Please make sure we enable it.&lt;/p&gt;</comment>
                            <comment id="15684659" author="lian cheng" created="Mon, 21 Nov 2016 20:40:00 +0000"  >&lt;p&gt;Here is a minimal test case (add it to &lt;tt&gt;ObjectHashAggregateSuite&lt;/tt&gt;) that can be used to reproduce this issue steadily:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;test(&lt;span class=&quot;code-quote&quot;&gt;&quot;oom&quot;&lt;/span&gt;) {
  withSQLConf(
    SQLConf.USE_OBJECT_HASH_AGG.key -&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;,
    SQLConf.OBJECT_AGG_SORT_BASED_FALLBACK_THRESHOLD.key -&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;
  ) {
    Seq(Tuple1(Seq.empty[Int]))
      .toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;c0&quot;&lt;/span&gt;)
      .groupBy(lit(1))
      .agg(typed_count($&lt;span class=&quot;code-quote&quot;&gt;&quot;c0&quot;&lt;/span&gt;), max($&lt;span class=&quot;code-quote&quot;&gt;&quot;c0&quot;&lt;/span&gt;))
      .show()
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;What I observed is that the partial aggregation phase produces a malformed &lt;tt&gt;UnsafeRow&lt;/tt&gt; after applying the &lt;tt&gt;resultProjection&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/spark/blob/07beb5d21c6803e80733149f1560c71cd3cacc86/sql/core/src/main/scala/org/apache/spark/sql/execution/aggregate/AggregationIterator.scala#L254&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;When printed, the malformed &lt;tt&gt;UnsafeRow&lt;/tt&gt; is always&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[0,0,2000000008,2800000008,100000000000000,5a5a5a5a5a5a5a5a]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The &lt;tt&gt;5a5a5a5a5a5a5a5a&lt;/tt&gt; is interpreted as the length of an &lt;tt&gt;ArrayData&lt;/tt&gt;. Therefore, the JVM blows up when trying to allocate a huge array to deep copy this &lt;tt&gt;ArrayData&lt;/tt&gt; at a later phase.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sameer&quot; class=&quot;user-hover&quot; rel=&quot;sameer&quot;&gt;sameer&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davies&quot; class=&quot;user-hover&quot; rel=&quot;davies&quot;&gt;davies&lt;/a&gt;, would you mind to have a look at this issue? Thanks!&lt;/p&gt;</comment>
                            <comment id="15684928" author="hvanhovell" created="Mon, 21 Nov 2016 22:21:47 +0000"  >&lt;p&gt;The 5a5a5a5a5a5a means that the page has been freed clean. This has been added in &lt;a href=&quot;https://github.com/apache/spark/commit/44c7c62bcfca74c82ffc4e3c53997fff47bfacac&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/44c7c62bcfca74c82ffc4e3c53997fff47bfacac&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This means that we are freeing an in-use buffer page.&lt;/p&gt;
</comment>
                            <comment id="15685389" author="lian cheng" created="Tue, 22 Nov 2016 01:53:02 +0000"  >&lt;p&gt;Figured it out. It&apos;s caused by a false sharing issue inside &lt;tt&gt;ObjectAggregationIterator&lt;/tt&gt;. In short, after setting an &lt;tt&gt;UnsafeArrayData&lt;/tt&gt; to an aggregation buffer, which is a safe row, the underlying buffer of the &lt;tt&gt;UnsafeArrayData&lt;/tt&gt; gets overwritten when iterator steps forward.&lt;/p&gt;

&lt;p&gt;Have to say that this issue is pretty hard to debug. The large array allocation blows up the JVM right away and you can&apos;t really find the large array in the heap dump since the allocation itself fails. Therefore, all the heap dumps are super small (~70MB) compared to the heap size (3GB for default SBT tests) and you can&apos;t find anything useful in the heap dumps.&lt;/p&gt;

&lt;p&gt;I&apos;m opening a PR to fix this issue.&lt;/p&gt;</comment>
                            <comment id="15685870" author="apachespark" created="Tue, 22 Nov 2016 06:41:05 +0000"  >&lt;p&gt;User &apos;liancheng&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15976&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15976&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i366vj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12338275">2.2.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>