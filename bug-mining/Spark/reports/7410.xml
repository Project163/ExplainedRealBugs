<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:18:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-32683] Datetime Pattern F not working as expected</title>
                <link>https://issues.apache.org/jira/browse/SPARK-32683</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;h3&gt;&lt;a name=&quot;Background&quot;&gt;&lt;/a&gt;Background&lt;/h3&gt;

&lt;p&gt;From the &lt;a href=&quot;https://spark.apache.org/docs/latest/sql-ref-datetime-pattern.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;documentation&lt;/a&gt;, the pattern F should give a week of the month.&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;b&gt;Symbol&lt;/b&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;b&gt;Meaning&lt;/b&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;b&gt;Presentation&lt;/b&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;b&gt;Example&lt;/b&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;F&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;week-of-month&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;number(1)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;3&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;h3&gt;&lt;a name=&quot;TestData&quot;&gt;&lt;/a&gt;Test Data&lt;/h3&gt;

&lt;p&gt;Here is my test data, that is a csv file.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
date
2020-08-01
2020-08-02
2020-08-03
2020-08-04
2020-08-05
2020-08-06
2020-08-07
2020-08-08
2020-08-09
2020-08-10 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;h3&gt;&lt;a name=&quot;Stepstothebug&quot;&gt;&lt;/a&gt;Steps to the bug&lt;/h3&gt;

&lt;p&gt;I have tested in the scala spark 3.0.0 and pyspark 3.0.0:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// Spark
&lt;/span&gt;
df.withColumn(&lt;span class=&quot;code-quote&quot;&gt;&quot;date&quot;&lt;/span&gt;, to_timestamp(&apos;date, &lt;span class=&quot;code-quote&quot;&gt;&quot;yyyy-MM-dd&quot;&lt;/span&gt;))
  .withColumn(&lt;span class=&quot;code-quote&quot;&gt;&quot;week&quot;&lt;/span&gt;, date_format(&apos;date, &lt;span class=&quot;code-quote&quot;&gt;&quot;F&quot;&lt;/span&gt;)).show

+-------------------+----+
|               date|week|
+-------------------+----+
|2020-08-01 00:00:00|   1|
|2020-08-02 00:00:00|   2|
|2020-08-03 00:00:00|   3|
|2020-08-04 00:00:00|   4|
|2020-08-05 00:00:00|   5|
|2020-08-06 00:00:00|   6|
|2020-08-07 00:00:00|   7|
|2020-08-08 00:00:00|   1|
|2020-08-09 00:00:00|   2|
|2020-08-10 00:00:00|   3|
+-------------------+----+


# pyspark

df.withColumn(&lt;span class=&quot;code-quote&quot;&gt;&apos;date&apos;&lt;/span&gt;, to_timestamp(&lt;span class=&quot;code-quote&quot;&gt;&apos;date&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;yyyy-MM-dd&apos;&lt;/span&gt;)) \
  .withColumn(&lt;span class=&quot;code-quote&quot;&gt;&apos;week&apos;&lt;/span&gt;, date_format(&lt;span class=&quot;code-quote&quot;&gt;&apos;date&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;F&apos;&lt;/span&gt;)) \
  .show(10, False)

+-------------------+----+
|date               |week|
+-------------------+----+
|2020-08-01 00:00:00|1   |
|2020-08-02 00:00:00|2   |
|2020-08-03 00:00:00|3   |
|2020-08-04 00:00:00|4   |
|2020-08-05 00:00:00|5   |
|2020-08-06 00:00:00|6   |
|2020-08-07 00:00:00|7   |
|2020-08-08 00:00:00|1   |
|2020-08-09 00:00:00|2   |
|2020-08-10 00:00:00|3   |
+-------------------+----+&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;h3&gt;&lt;a name=&quot;Expectedresult&quot;&gt;&lt;/a&gt;Expected result&lt;/h3&gt;

&lt;p&gt;The `week` column is not the week of the month. It is a day of the week as a number.&lt;/p&gt;

&lt;p&gt;&#160; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13010214/13010214_comment.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;From my calendar, the first day of August should have 1 for the week-of-month and from 2nd to 8th should have 2 and so on.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+-------------------+----+
|date               |week|
+-------------------+----+
|2020-08-01 00:00:00|1   |
|2020-08-02 00:00:00|2   |
|2020-08-03 00:00:00|2   |
|2020-08-04 00:00:00|2   |
|2020-08-05 00:00:00|2   |
|2020-08-06 00:00:00|2   |
|2020-08-07 00:00:00|2   |
|2020-08-08 00:00:00|2   |
|2020-08-09 00:00:00|3   |
|2020-08-10 00:00:00|3   |
+-------------------+----+&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Windows 10 Pro&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;with Jupyter Lab - Docker Image&#160;
	&lt;ul&gt;
		&lt;li&gt;jupyter/all-spark-notebook:f1811928b3dd&#160;
		&lt;ul&gt;
			&lt;li&gt;spark 3.0.0&lt;/li&gt;
			&lt;li&gt;python 3.8.5&lt;/li&gt;
			&lt;li&gt;openjdk 11.0.8&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</environment>
        <key id="13323949">SPARK-32683</key>
            <summary>Datetime Pattern F not working as expected</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Qin Yao">Kent Yao 2</assignee>
                                    <reporter username="lamanus">Daeho Ro</reporter>
                        <labels>
                    </labels>
                <created>Fri, 21 Aug 2020 12:34:07 +0000</created>
                <updated>Tue, 25 Aug 2020 13:27:11 +0000</updated>
                            <resolved>Tue, 25 Aug 2020 13:17:40 +0000</resolved>
                                    <version>3.0.0</version>
                                    <fixVersion>3.0.1</fixVersion>
                    <fixVersion>3.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17182643" author="varun wachaspati" created="Sun, 23 Aug 2020 10:09:07 +0000"  >&lt;p&gt;Stumbled upon the same issue, upon initial investigation looks like change in behaviour in java.lang.DateTimeFormatterBuilder.&lt;br/&gt;
Literal character &apos;F&apos; currently maps to&#160;ChronoField.ALIGNED_DAY_OF_WEEK_IN_MONTH instead of ChronoField.ALIGNED_WEEK_OF_MONTH&lt;/p&gt;

&lt;p&gt;According to ALIGNED_DAY_OF_WEEK_IN_MONTH definition it formats the timestamp to give the count of the date within that week. Defintion -&#160;&lt;a href=&quot;https://github.com/openjdk/jdk/blob/master/src/java.base/share/classes/java/time/temporal/ChronoField.java#L373&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/openjdk/jdk/blob/master/src/java.base/share/classes/java/time/temporal/ChronoField.java#L373&lt;/a&gt;&lt;/p&gt;



&lt;p&gt;Tried the same snippet in Spark 2.4.6, and it&apos;s behaviour was inline with the spark documentation. This looks like a regression for Spark 3.x.&#160;&lt;/p&gt;</comment>
                            <comment id="17182677" author="maropu" created="Sun, 23 Aug 2020 12:25:55 +0000"  >&lt;p&gt;cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maxgekk&quot; class=&quot;user-hover&quot; rel=&quot;maxgekk&quot;&gt;maxgekk&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Qin+Yao&quot; class=&quot;user-hover&quot; rel=&quot;Qin Yao&quot;&gt;Qin Yao&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17182932" author="qin yao" created="Mon, 24 Aug 2020 03:48:40 +0000"  >&lt;p&gt;This is a bug of the doc that we inherited from JDK &lt;a href=&quot;https://bugs.openjdk.java.net/browse/JDK-8169482&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bugs.openjdk.java.net/browse/JDK-8169482&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The SimpleDateFormatter(*F	Day of week in month*) we used in 2.x and the DatetimeFormatter(&lt;b&gt;F       week-of-month&lt;/b&gt;) we use now both have the opposite meanings to what they declared in the java docs. And unfortunately, this also leads to silent data change in Spark too.&lt;/p&gt;

&lt;p&gt;The  &lt;b&gt;`week-of-month`&lt;/b&gt; is actually  the pattern `W` in DatetimeFormatter, which is banned to use in Spark 3.x&lt;/p&gt;

&lt;p&gt;If we want to keep pattern `F`, we need to accept the behavior change and fix the doc in Spark. cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17183081" author="cloud_fan" created="Mon, 24 Aug 2020 08:58:12 +0000"  >&lt;p&gt;It&apos;s unfortunate that we missed it before the 3.0 release. I think we should not introduce behavior change in 3.0.1 again, and let&apos;s update the doc and migration guide instead.&lt;/p&gt;</comment>
                            <comment id="17183769" author="apachespark" created="Tue, 25 Aug 2020 06:41:14 +0000"  >&lt;p&gt;User &apos;yaooqinn&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29538&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29538&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17183770" author="apachespark" created="Tue, 25 Aug 2020 06:41:37 +0000"  >&lt;p&gt;User &apos;yaooqinn&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29538&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29538&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17184024" author="cloud_fan" created="Tue, 25 Aug 2020 13:17:40 +0000"  >&lt;p&gt;Issue resolved by pull request 29538&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29538&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29538&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17184031" author="lamanus" created="Tue, 25 Aug 2020 13:21:40 +0000"  >&lt;p&gt;I did not mean to change the doc but the source or recover the DateFormatter W, anyway, the function is gone (even before) and the documentation is now clear, not confused.&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13010214" name="comment.png" size="95218" author="lamanus" created="Fri, 21 Aug 2020 12:35:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 12 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0hzfc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>