<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:54:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-21374] Reading globbed paths from S3 into DF doesn&apos;t work if filesystem caching is disabled</title>
                <link>https://issues.apache.org/jira/browse/SPARK-21374</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;&lt;b&gt;Motivation:&lt;/b&gt;&lt;br/&gt;
In my case I want to disable filesystem cache to be able to change S3&apos;s access key and secret key on the fly to read from buckets with different permissions. This works perfectly fine for RDDs but doesn&apos;t work for DFs.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Example (works for RDD but fails for DataFrame):&lt;/b&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.SparkContext
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.SparkConf
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.SparkSession

object SimpleApp {
  def main(args: Array[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;]) {

    val awsAccessKeyId = &lt;span class=&quot;code-quote&quot;&gt;&quot;something&quot;&lt;/span&gt;
    val awsSecretKey = &lt;span class=&quot;code-quote&quot;&gt;&quot;something &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;&quot;&lt;/span&gt;

    val conf = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SparkConf().setAppName(&lt;span class=&quot;code-quote&quot;&gt;&quot;Simple Application&quot;&lt;/span&gt;).setMaster(&lt;span class=&quot;code-quote&quot;&gt;&quot;local[*]&quot;&lt;/span&gt;)

    val sc = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SparkContext(conf)
    sc.hadoopConfiguration.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;fs.s3.awsAccessKeyId&quot;&lt;/span&gt;, awsAccessKeyId)
    sc.hadoopConfiguration.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;fs.s3.awsSecretAccessKey&quot;&lt;/span&gt;, awsSecretKey)
    sc.hadoopConfiguration.setBoolean(&lt;span class=&quot;code-quote&quot;&gt;&quot;fs.s3.impl.disable.cache&quot;&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
    sc.hadoopConfiguration.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;fs.s3.impl&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.hadoop.fs.s3native.NativeS3FileSystem&quot;&lt;/span&gt;)
    sc.hadoopConfiguration.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;fs.s3.buffer.dir&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;/tmp&quot;&lt;/span&gt;)

    val spark = SparkSession.builder().config(conf).getOrCreate()

    val rddFile = sc.textFile(&lt;span class=&quot;code-quote&quot;&gt;&quot;s3:&lt;span class=&quot;code-comment&quot;&gt;//bucket/file.csv&quot;&lt;/span&gt;).count // ok
&lt;/span&gt;    val rddGlob = sc.textFile(&lt;span class=&quot;code-quote&quot;&gt;&quot;s3:&lt;span class=&quot;code-comment&quot;&gt;//bucket/*&quot;&lt;/span&gt;).count // ok
&lt;/span&gt;    val dfFile = spark.read.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;csv&quot;&lt;/span&gt;).load(&lt;span class=&quot;code-quote&quot;&gt;&quot;s3:&lt;span class=&quot;code-comment&quot;&gt;//bucket/file.csv&quot;&lt;/span&gt;).count // ok
&lt;/span&gt;    
    val dfGlob = spark.read.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;csv&quot;&lt;/span&gt;).load(&lt;span class=&quot;code-quote&quot;&gt;&quot;s3:&lt;span class=&quot;code-comment&quot;&gt;//bucket/*&quot;&lt;/span&gt;).count 
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// IllegalArgumentExcepton. AWS Access Key ID and Secret Access Key must be specified as the username or password (respectively)
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// of a s3 URL, or by setting the fs.s3.awsAccessKeyId or fs.s3.awsSecretAccessKey properties (respectively).
&lt;/span&gt;   
    sc.stop()
  }
}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13086291">SPARK-21374</key>
            <summary>Reading globbed paths from S3 into DF doesn&apos;t work if filesystem caching is disabled</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="andrey.t">Andrey Taptunov</assignee>
                                    <reporter username="andrey.t">Andrey Taptunov</reporter>
                        <labels>
                    </labels>
                <created>Tue, 11 Jul 2017 15:24:23 +0000</created>
                <updated>Mon, 7 Aug 2017 18:21:34 +0000</updated>
                            <resolved>Sat, 5 Aug 2017 05:41:10 +0000</resolved>
                                    <version>2.0.2</version>
                    <version>2.1.1</version>
                                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>2.3.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16084764" author="zsxwing" created="Wed, 12 Jul 2017 21:43:58 +0000"  >&lt;p&gt;Yeah, org.apache.spark.deploy.SparkHadoopUtil.globPath uses a wrong Hadoop configuration. Welcome to submit a PR to fix it.&lt;/p&gt;

&lt;p&gt;Right now as a workaround, you can use the following codes to set your keys:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;val conf = org.apache.spark.deploy.SparkHadoopUtil.get.conf
conf.set(...)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16085596" author="apachespark" created="Thu, 13 Jul 2017 11:54:03 +0000"  >&lt;p&gt;User &apos;andrey-tpt&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/18623&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/18623&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16085645" author="stevel@apache.org" created="Thu, 13 Jul 2017 12:37:48 +0000"  >&lt;p&gt;This is possibly a sign that your new configuration isn&apos;t having its auth values picked up, or they are incorrect (i.e properties are wrong). Its working for enabled caching as some other codepath has set them up with the right properties, and so when used in the DF, the previous params are picked up.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;if using Hadoop 2.7.x JARs, switch to s3a and use s3a in the URLs &amp;amp; settings. You don&apos;t need to set the fs.s3a.impl field either; done for yoiu.&lt;/li&gt;
	&lt;li&gt;if you can upgrade to Hadoop 2.8 binaries, you can use per-bucket configuration; this does exactly what you want: lets you configure different auth details for different buckets, without having to play these games. See &lt;a href=&quot;https://hadoop.apache.org/docs/current/hadoop-aws/tools/hadoop-aws/index.html#Configuring_different_S3_buckets&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hadoop.apache.org/docs/current/hadoop-aws/tools/hadoop-aws/index.html#Configuring_different_S3_buckets&lt;/a&gt; and &lt;a href=&quot;https://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.6.1/bk_cloud-data-access/content/s3-per-bucket-configs.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.6.1/bk_cloud-data-access/content/s3-per-bucket-configs.html&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;



&lt;p&gt;going to 2.8 binaries (or anything with the feature backported to a 2.7.x variant) should solve your problem without you having to worry about what you are seeing here.&lt;/p&gt;</comment>
                            <comment id="16093417" author="andrey.t" created="Wed, 19 Jul 2017 17:05:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stevel%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;stevel@apache.org&quot;&gt;stevel@apache.org&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;Indeed, while working on PR and debugging the code I see that code works only accidentally because caching is turned on by default.&lt;/p&gt;

&lt;p&gt;1. Thanks for the advice. I doubt that it&apos;s related to type of the filesystem - I&apos;ve only mentioned filesystem explicitly to show why &quot;awsAcceesKeyId&quot; not &quot;access.key&quot; is used with &quot;s3&quot; scheme in the example. Sorry for the confusion. &lt;/p&gt;

&lt;p&gt;2. Unfortunately, it&apos;s not that easy - this example is only simplified version of what happens in my project. We don&apos;t have information about which buckets user will try to access in interactive mode so I can not enumerate them all in configuration. &lt;/p&gt;</comment>
                            <comment id="16108897" author="stevel@apache.org" created="Tue, 1 Aug 2017 13:35:58 +0000"  >&lt;p&gt;I understand...the patch shows the issue. Its only working in some codepaths because the (authenticated) S3 FS instance was already created and cached.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 16 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3hdmn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>