<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:30:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-38969] Graceful decomissionning on Kubernetes fails / decom script error</title>
                <link>https://issues.apache.org/jira/browse/SPARK-38969</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Hello, we are running into some issue while attempting graceful decommissioning of executors. We enabled:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;spark.decommission.enabled&#160;&lt;/li&gt;
	&lt;li&gt;spark.storage.decommission.rddBlocks.enabled&lt;/li&gt;
	&lt;li&gt;spark.storage.decommission.shuffleBlocks.enabled&lt;/li&gt;
	&lt;li&gt;spark.storage.decommission.enabled&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;and set spark.storage.decommission.fallbackStorage.path to a path in our bucket.&lt;br/&gt;
&#160;&lt;br/&gt;
The logs from the driver seems to suggest the decommissioning process started but then unexpectedly exited and failed:&lt;br/&gt;
&#160;&lt;br/&gt;
```&lt;br/&gt;
22/04/20 15:09:09 WARN KubernetesClusterSchedulerBackend$KubernetesDriverEndpoint: Received executor 3 decommissioned message&lt;br/&gt;
22/04/20 15:09:09 INFO KubernetesClusterSchedulerBackend: Decommission executors: 3&lt;br/&gt;
22/04/20 15:09:09 INFO BlockManagerMasterEndpoint: Mark BlockManagers (BlockManagerId(3, 100.96.1.130, 44789, None)) as being decommissioning.&lt;br/&gt;
22/04/20 15:09:10 ERROR TaskSchedulerImpl: Lost executor 3 on 100.96.1.130: Executor decommission.&lt;br/&gt;
22/04/20 15:09:10 INFO DAGScheduler: Executor lost: 3 (epoch 2)&lt;br/&gt;
22/04/20 15:09:10 INFO ExecutorMonitor: Executor 3 is removed. Remove reason statistics: (gracefully decommissioned: 0, decommision unfinished: 0, driver killed: 0, unexpectedly exited: 3).&lt;br/&gt;
22/04/20 15:09:10 INFO BlockManagerMasterEndpoint: Trying to remove executor 3 from BlockManagerMaster.&lt;br/&gt;
22/04/20 15:09:10 INFO BlockManagerMasterEndpoint: Removing block manager BlockManagerId(3, 100.96.1.130, 44789, None)&lt;br/&gt;
22/04/20 15:09:10 INFO BlockManagerMaster: Removed 3 successfully in removeExecutor&lt;br/&gt;
22/04/20 15:09:10 INFO DAGScheduler: Shuffle files lost for executor: 3 (epoch 2)&lt;br/&gt;
```&lt;br/&gt;
&#160;&lt;br/&gt;
However, the executor logs seem to suggest that decommissioning was successful:&lt;br/&gt;
&#160;&lt;br/&gt;
```&lt;br/&gt;
22/04/20 15:09:09 INFO CoarseGrainedExecutorBackend: Decommission executor 3.&lt;br/&gt;
22/04/20 15:09:09 INFO CoarseGrainedExecutorBackend: Will exit when finished decommissioning&lt;br/&gt;
22/04/20 15:09:09 INFO BlockManager: Starting block manager decommissioning process...&lt;br/&gt;
22/04/20 15:09:10 INFO BlockManagerDecommissioner: Starting block migration&lt;br/&gt;
22/04/20 15:09:10 INFO BlockManagerDecommissioner: Attempting to migrate all RDD blocks&lt;br/&gt;
22/04/20 15:09:10 INFO BlockManagerDecommissioner: Attempting to migrate all shuffle blocks&lt;br/&gt;
22/04/20 15:09:10 INFO BlockManagerDecommissioner: Start refreshing migratable shuffle blocks&lt;br/&gt;
22/04/20 15:09:10 INFO BlockManagerDecommissioner: 0 of 0 local shuffles are added. In total, 0 shuffles are remained.&lt;br/&gt;
22/04/20 15:09:10 INFO BlockManagerDecommissioner: Attempting to migrate all cached RDD blocks&lt;br/&gt;
22/04/20 15:09:10 INFO BlockManagerDecommissioner: Starting shuffle block migration thread for BlockManagerId(4, 100.96.1.131, 35607, None)&lt;br/&gt;
22/04/20 15:09:10 INFO BlockManagerDecommissioner: Starting shuffle block migration thread for BlockManagerId(fallback, remote, 7337, None)&lt;br/&gt;
22/04/20 15:09:10 INFO BlockManagerDecommissioner: Finished current round refreshing migratable shuffle blocks, waiting for 30000ms before the next round refreshing.&lt;br/&gt;
22/04/20 15:09:10 WARN BlockManagerDecommissioner: Asked to decommission RDD cache blocks, but no blocks to migrate&lt;br/&gt;
22/04/20 15:09:10 INFO BlockManagerDecommissioner: Finished current round RDD blocks migration, waiting for 30000ms before the next round migration.&lt;br/&gt;
22/04/20 15:09:10 INFO CoarseGrainedExecutorBackend: Checking to see if we can shutdown.&lt;br/&gt;
22/04/20 15:09:10 INFO CoarseGrainedExecutorBackend: No running tasks, checking migrations&lt;br/&gt;
22/04/20 15:09:10 INFO CoarseGrainedExecutorBackend: No running tasks, all blocks migrated, stopping.&lt;br/&gt;
22/04/20 15:09:10 ERROR CoarseGrainedExecutorBackend: Executor self-exiting due to : Finished decommissioning&lt;br/&gt;
22/04/20 15:09:10 INFO BlockManagerDecommissioner: Stop RDD blocks migration().&lt;br/&gt;
22/04/20 15:09:10 INFO BlockManagerDecommissioner: Stop refreshing migratable shuffle blocks.&lt;br/&gt;
22/04/20 15:09:10 INFO BlockManagerDecommissioner: Stopping migrating shuffle blocks.&lt;br/&gt;
22/04/20 15:09:10 INFO CoarseGrainedExecutorBackend: Driver commanded a shutdown&lt;br/&gt;
22/04/20 15:09:10 INFO BlockManagerDecommissioner: Stopped block migration&lt;br/&gt;
22/04/20 15:09:10 INFO BlockManagerDecommissioner: Stop shuffle block migration().&lt;br/&gt;
22/04/20 15:09:10 INFO BlockManagerDecommissioner: Stop shuffle block migration().&lt;br/&gt;
22/04/20 15:09:10 INFO MemoryStore: MemoryStore cleared&lt;br/&gt;
22/04/20 15:09:10 INFO BlockManager: BlockManager stopped&lt;br/&gt;
22/04/20 15:09:10 INFO ShutdownHookManager: Shutdown hook called&lt;br/&gt;
```&lt;br/&gt;
&#160;&lt;br/&gt;
The decommissioning script `/opt/decom.sh` also always terminates with exit code 137, not really sure why that is.&lt;br/&gt;
&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Running spark-thriftserver (3.2.0) on Kubernetes (GKE 1.20.15-gke.2500).&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</environment>
        <key id="13440716">SPARK-38969</key>
            <summary>Graceful decomissionning on Kubernetes fails / decom script error</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="holden">Holden Karau</assignee>
                                    <reporter username="yeachan153">Yeachan Park</reporter>
                        <labels>
                    </labels>
                <created>Wed, 20 Apr 2022 15:16:52 +0000</created>
                <updated>Fri, 12 Aug 2022 23:34:12 +0000</updated>
                            <resolved>Fri, 12 Aug 2022 23:34:12 +0000</resolved>
                                    <version>3.2.0</version>
                                    <fixVersion>3.4.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17530922" author="holdenk" created="Mon, 2 May 2022 19:34:59 +0000"  >&lt;p&gt;Most likely it&apos;s from the `timeout 60` in there (at least the exit code of 137). I&apos;ll do some poking into reasoning for `unexpectedly exited` too.&lt;/p&gt;</comment>
                            <comment id="17530931" author="JIRAUSER288356" created="Mon, 2 May 2022 20:11:44 +0000"  >&lt;p&gt;Hi Holden, thanks for responding. Triggering the decom script manually from within a pod still made it exit with code 137, even though the whole execution took much less than 60 seconds.&lt;/p&gt;</comment>
                            <comment id="17530950" author="apachespark" created="Mon, 2 May 2022 21:37:30 +0000"  >&lt;p&gt;User &apos;holdenk&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/36434&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/36434&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17579188" author="holdenk" created="Fri, 12 Aug 2022 23:34:12 +0000"  >&lt;p&gt;Updated decommissioning script to be more resilent and block as long as it takes on the executor to exit. K8s will still kill the pod if it exceeds the graceful shutdown time-limit so we don&apos;t have to worry too much about blocking forever there.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Also updated how we tag executor loss reasons for executors which decommission too &quot;quickly&quot;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;See &lt;a href=&quot;https://github.com/apache/spark/pull/36434/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/36434/files&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 13 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z11n3c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>