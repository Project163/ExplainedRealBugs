<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:23:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-4877] userClassPathFirst doesn&apos;t handle user classes inheriting from parent</title>
                <link>https://issues.apache.org/jira/browse/SPARK-4877</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;We&apos;re trying out userClassPathFirst.&lt;/p&gt;

&lt;p&gt;To do so, we make an uberjar that does not contain Spark or Scala classes (because we want those to load from the parent classloader, otherwise we&apos;ll get errors like scala.Function0 != scala.Function0 since they&apos;d load from different class loaders).&lt;/p&gt;

&lt;p&gt;(Tangentially, some isolation classloaders like Jetty whitelist certain packages, like spark/* and scala/*, to only come from the parent classloader, so that technically if the user still messes up and leaks the Scala/Spark jars into their uberjar, it won&apos;t blow up; this would be a good enhancement, I think.)&lt;/p&gt;

&lt;p&gt;Anyway, we have a custom Kryo registrar, which ships in our uberjar, but since it &quot;extends spark.KryoRegistrator&quot;, which is not in our uberjar, we get a ClassNotFoundException.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12762375">SPARK-4877</key>
            <summary>userClassPathFirst doesn&apos;t handle user classes inheriting from parent</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="click_stephen">Stephen Haberman</assignee>
                                    <reporter username="stephen">Stephen Haberman</reporter>
                        <labels>
                    </labels>
                <created>Wed, 17 Dec 2014 20:18:45 +0000</created>
                <updated>Fri, 6 Feb 2015 19:07:32 +0000</updated>
                            <resolved>Fri, 6 Feb 2015 19:05:03 +0000</resolved>
                                    <version>1.2.0</version>
                                    <fixVersion>1.3.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14250461" author="stephen" created="Wed, 17 Dec 2014 20:19:14 +0000"  >&lt;p&gt;Stack trace:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2014-12-17 05:07:36,811 WARN  [task-result-getter-0] scheduler.TaskSetManager (Logging.scala:logWarning(71)) - Lost task 0.0 in stage 0.0 (TID 0, ip-10-153-171-58.ec2.internal): java.lang.NoClassDefFoundError: org/apache/spark/serializer/KryoRegistrator
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.defineClass1(Native Method)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.defineClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:800)
	at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:142)
	at java.net.URLClassLoader.defineClass(URLClassLoader.java:449)
	at java.net.URLClassLoader.access$100(URLClassLoader.java:71)
	at java.net.URLClassLoader$1.run(URLClassLoader.java:361)
	at java.net.URLClassLoader$1.run(URLClassLoader.java:355)
	at java.security.AccessController.doPrivileged(Native Method)
	at java.net.URLClassLoader.findClass(URLClassLoader.java:354)
	at org.apache.spark.executor.ChildExecutorURLClassLoader$userClassLoader$.findClass(ExecutorURLClassLoader.scala:42)
	at org.apache.spark.executor.ChildExecutorURLClassLoader.findClass(ExecutorURLClassLoader.scala:50)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:425)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:358)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName0(Native Method)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.forName(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.java:270)
	at org.apache.spark.serializer.KryoSerializer$$anonfun$newKryo$3.apply(KryoSerializer.scala:101)
	at org.apache.spark.serializer.KryoSerializer$$anonfun$newKryo$3.apply(KryoSerializer.scala:101)
	at scala.Option.map(Option.scala:145)
	at org.apache.spark.serializer.KryoSerializer.newKryo(KryoSerializer.scala:101)
	at org.apache.spark.serializer.KryoSerializerInstance.&amp;lt;init&amp;gt;(KryoSerializer.scala:157)
	at org.apache.spark.serializer.KryoSerializer.newInstance(KryoSerializer.scala:119)
	at org.apache.spark.broadcast.TorrentBroadcast$.unBlockifyObject(TorrentBroadcast.scala:214)
	at org.apache.spark.broadcast.TorrentBroadcast$$anonfun$readBroadcastBlock$1.apply(TorrentBroadcast.scala:177)
	at org.apache.spark.util.Utils$.tryOrIOException(Utils.scala:1000)
	at org.apache.spark.broadcast.TorrentBroadcast.readBroadcastBlock(TorrentBroadcast.scala:164)
	at org.apache.spark.broadcast.TorrentBroadcast._value$lzycompute(TorrentBroadcast.scala:64)
	at org.apache.spark.broadcast.TorrentBroadcast._value(TorrentBroadcast.scala:64)
	at org.apache.spark.broadcast.TorrentBroadcast.getValue(TorrentBroadcast.scala:87)
	at org.apache.spark.broadcast.Broadcast.value(Broadcast.scala:70)
	at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:61)
	at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:41)
	at org.apache.spark.scheduler.Task.run(Task.scala:56)
	at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:196)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: java.lang.ClassNotFoundException: org.apache.spark.serializer.KryoRegistrator
	at java.net.URLClassLoader$1.run(URLClassLoader.java:366)
	at java.net.URLClassLoader$1.run(URLClassLoader.java:355)
	at java.security.AccessController.doPrivileged(Native Method)
	at java.net.URLClassLoader.findClass(URLClassLoader.java:354)
	at org.apache.spark.executor.ChildExecutorURLClassLoader$userClassLoader$.findClass(ExecutorURLClassLoader.scala:42)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:425)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.loadClass(&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt;.java:358)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also note that I have a fix and will be submitting a PR soon.&lt;/p&gt;</comment>
                            <comment id="14250473" author="apachespark" created="Wed, 17 Dec 2014 20:25:37 +0000"  >&lt;p&gt;User &apos;stephenh&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/3725&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/3725&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14257855" author="stephen" created="Wed, 24 Dec 2014 02:33:32 +0000"  >&lt;p&gt;FWIW two reviewers have okay&apos;d this PR; can someone else take a look + commit it?&lt;/p&gt;</comment>
                            <comment id="14288023" author="mattwhelan" created="Thu, 22 Jan 2015 19:12:51 +0000"  >&lt;p&gt;Looking at the PR, you&apos;re still overriding findClass, not loadClass.  You can&apos;t change the delegation strategy successfully without changing loadClass.  &lt;/p&gt;</comment>
                            <comment id="14288945" author="stephen" created="Fri, 23 Jan 2015 08:00:56 +0000"  >&lt;p&gt;Hi Matt,&lt;/p&gt;

&lt;p&gt;I don&apos;t doubt you are right, but can you clarify?&lt;/p&gt;

&lt;p&gt;I had noticed that the Jetty/Hadoop implementations do overload loadClass, but I was going for a minimal amount of changes for this initial PR. It also passes the tests and works for us in production, so AFAICT was okay.&lt;/p&gt;

&lt;p&gt;I think more fully porting the Jetty/Hadoop code over is a good idea, I was just assuming moving from findClass to loadClass wouldn&apos;t be required until taking that on.&lt;/p&gt;</comment>
                            <comment id="14289559" author="MattWhelan" created="Fri, 23 Jan 2015 17:30:33 +0000"  >&lt;p&gt;The best thing to do is look at the source for ClassLoader.loadClass, and think about the implications.  Much has been written on the topic as well.&lt;/p&gt;

&lt;p&gt;The short version is that loadClass controls the delegation process, and findClass is a fallback that gets called after delegation fails.  You can&apos;t effectively change delegation with just findClass.&lt;/p&gt;

&lt;p&gt;The Java Language Spec, the docs for ClassLoader, and &lt;a href=&quot;http://www.ibm.com/developerworks/library/j-dclp1/index.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.ibm.com/developerworks/library/j-dclp1/index.html&lt;/a&gt; (actually, that whole series) are all good references.  It&apos;s a really complicated topic, and is terribly easy to mess it up in subtle ways if you don&apos;t consider all the possible implications of what you&apos;re doing.&lt;/p&gt;</comment>
                            <comment id="14305810" author="holdenk" created="Wed, 4 Feb 2015 19:37:56 +0000"  >&lt;p&gt;Hi Matt,&lt;/p&gt;

&lt;p&gt;I don&apos;t believe we need to override loadClass, this would be true if we created a class loader with the parent in the normal sense, but when we extend the classloader we keep the parent class loader as null and do our own resolution routing, so loadClass shouldn&apos;t be able to trigger a resolution on the parent since it has no knowledge of the parent.&lt;/p&gt;</comment>
                            <comment id="14306082" author="matt.whelan" created="Wed, 4 Feb 2015 22:12:53 +0000"  >&lt;p&gt;Overriding only findClass ignores caching, which causes LinkageErrors when you try to load the same class twice.  &lt;/p&gt;

&lt;p&gt;Really getting into the details of class loading is beyond the scope of a Jira issue thread.  I posted links to a couple really good sources above.  If you read those and familiarize yourself with the details of the default loadClass implementation, I think you&apos;ll come to the same conclusion.&lt;/p&gt;</comment>
                            <comment id="14306104" author="stephen" created="Wed, 4 Feb 2015 22:21:41 +0000"  >&lt;p&gt;Hi Matt,&lt;/p&gt;

&lt;p&gt;I know about the caching/LinkageError issue, because I saw it running a job; my patch has a test that reproduced it and fixes it.&lt;/p&gt;

&lt;p&gt;I&apos;m still willing to believe loadClass might be preferred, but AFAICT it&apos;s not required, and the current findClass approach is working fine (with this patch) in our production jobs.&lt;/p&gt;

&lt;p&gt;(Note that I&apos;m very open to refactoring this approach further in the future, especially to introduce the Jetty/Hadoop concept of system classes, but our jobs have not ran into any issues.)&lt;/p&gt;</comment>
                            <comment id="14309659" author="joshrosen" created="Fri, 6 Feb 2015 19:05:03 +0000"  >&lt;p&gt;Issue resolved by pull request 3725&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/3725&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/3725&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14309666" author="joshrosen" created="Fri, 6 Feb 2015 19:07:32 +0000"  >&lt;p&gt;I&apos;ve gone ahead and committed this PR because it fixes a known bug and adds a new test case.  Both the old and new code overloaded findClass; I think the findClass vs. loadClass change is related to the this JIRA, but kind of orthogonal to the fix here.  If you think that we should re-work our classloader to change its overriding strategy, let&apos;s do that in a separate followup PR.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12769114">SPARK-5358</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12769114">SPARK-5358</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 41 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i23jhz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>