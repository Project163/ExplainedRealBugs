<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:02:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-22148] TaskSetManager.abortIfCompletelyBlacklisted should not abort when all current executors are blacklisted but dynamic allocation is enabled</title>
                <link>https://issues.apache.org/jira/browse/SPARK-22148</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Currently TaskSetManager.abortIfCompletelyBlacklisted aborts the TaskSet and the whole Spark job with `task X (partition Y) cannot run anywhere due to node and executor blacklist. Blacklisting behavior can be configured via spark.blacklist.*.` when all the available executors are blacklisted for a pending Task or TaskSet. This makes sense for static allocation, where the set of executors is fixed for the duration of the application, but this might lead to unnecessary job failures when dynamic allocation is enabled. For example, in a Spark application with a single job at a time, when a node fails at the end of a stage attempt, all other executors will complete their tasks, but the tasks running in the executors of the failing node will be pending. Spark will keep waiting for those tasks for 2 minutes by default (spark.network.timeout) until the heartbeat timeout is triggered, and then it will blacklist those executors for that stage. At that point in time, other executors would had been released after being idle for 1 minute by default (spark.dynamicAllocation.executorIdleTimeout), because the next stage hasn&apos;t started yet and so there are no more tasks available (assuming the default of spark.speculation = false). So Spark will fail because the only executors available are blacklisted for that stage. &lt;/p&gt;

&lt;p&gt;An alternative is requesting more executors to the cluster manager in this situation. This could be retried a configurable number of times after a configurable wait time between request attempts, so if the cluster manager fails to provide a suitable executor then the job is aborted like in the previous case. &lt;/p&gt;</description>
                <environment></environment>
        <key id="13105515">SPARK-22148</key>
            <summary>TaskSetManager.abortIfCompletelyBlacklisted should not abort when all current executors are blacklisted but dynamic allocation is enabled</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Dhruve Ashar">Dhruve Ashar</assignee>
                                    <reporter username="juanrh">Juan Rodr&#237;guez Hortal&#225;</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Sep 2017 17:28:51 +0000</created>
                <updated>Mon, 13 Apr 2020 23:22:39 +0000</updated>
                            <resolved>Tue, 6 Nov 2018 14:26:51 +0000</resolved>
                                    <version>2.2.0</version>
                                    <fixVersion>2.4.1</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>Scheduler</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="16217299" author="juanrh" created="Tue, 24 Oct 2017 17:16:05 +0000"  >&lt;p&gt;Hi, &lt;/p&gt;

&lt;p&gt;I&apos;ve been working on this issue, and I would like to get your feedback on the following approach. The idea is that instead of failing in `TaskSetManager.abortIfCompletelyBlacklisted`, when a task cannot be scheduled in any executor but dynamic allocation is enabled, we will register this task with `ExecutorAllocationManager`. Then `ExecutorAllocationManager` will request additional executors for these &quot;unscheduleable tasks&quot; by increasing the value returned in `ExecutorAllocationManager.maxNumExecutorsNeeded`. This way we are counting these tasks twice, but this makes sense because the current executors don&apos;t have any slot for these tasks, so we actually want to get new executors that are able to run these tasks. To avoid a deadlock due to tasks being unscheduleable forever, we store the timestamp when a task was registered as unscheduleable, and in `ExecutorAllocationManager.schedule` we abort the application if there is some task that has been unscheduleable for a configurable age threshold. This way we give an opportunity to dynamic allocation to get more executors that are able to run the tasks, but we don&apos;t make the application wait forever. &lt;/p&gt;

&lt;p&gt;Attached is a patch with a draft for this approach. Looking forward to your feedback on this. &lt;/p&gt;</comment>
                            <comment id="16222926" author="apachespark" created="Fri, 27 Oct 2017 22:04:05 +0000"  >&lt;p&gt;User &apos;juanrh&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19590&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19590&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16222967" author="irashid" created="Fri, 27 Oct 2017 22:32:07 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=juanrh&quot; class=&quot;user-hover&quot; rel=&quot;juanrh&quot;&gt;juanrh&lt;/a&gt;, thanks for filing this and the PR.  is this &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-15815&quot; title=&quot;Hang while enable blacklistExecutor and DynamicExecutorAllocator &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-15815&quot;&gt;&lt;del&gt;SPARK-15815&lt;/del&gt;&lt;/a&gt;?? though the initial summary &amp;amp; description aren&apos;t as succinct as your, if you follow the discussion its certainly related.  Perhaps its distinct because I think you are talking about something more particular to dynamic allocation.&lt;/p&gt;

&lt;p&gt;anyway I haven&apos;t taken a more detailed look yet, just wanted to you point to the other issue.&lt;/p&gt;</comment>
                            <comment id="16225375" author="juanrh" created="Mon, 30 Oct 2017 17:29:20 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=irashid&quot; class=&quot;user-hover&quot; rel=&quot;irashid&quot;&gt;irashid&lt;/a&gt;. This looks like a different problem, because this issue is about a crash due to job aborted because there is no place to schedule a task, and &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-15815&quot; title=&quot;Hang while enable blacklistExecutor and DynamicExecutorAllocator &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-15815&quot;&gt;&lt;del&gt;SPARK-15815&lt;/del&gt;&lt;/a&gt; is about a hang. But I have seen hangs similar to the one described in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-15815&quot; title=&quot;Hang while enable blacklistExecutor and DynamicExecutorAllocator &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-15815&quot;&gt;&lt;del&gt;SPARK-15815&lt;/del&gt;&lt;/a&gt; in the past, also related to dynamic allocation, so it looks like the root cause could be related. \&lt;/p&gt;

&lt;p&gt;My proposal is similar to some of the ideas you outline in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-15815&quot; title=&quot;Hang while enable blacklistExecutor and DynamicExecutorAllocator &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-15815&quot;&gt;&lt;del&gt;SPARK-15815&lt;/del&gt;&lt;/a&gt;. The main difference is that I don&apos;t suggest killing an executor, but requesting more executors to the resource manager. The result is similar, but your approach would work even if no more capacity is available. On the other hand my approach won&apos;t kill an executor that is progressing in other tasks. However my approach won&apos;t work if 1) there are no more executors available in the cluster, and 2) the executor timeout if very long, or executors are caching RDDs and the default timeout of infinite, as I was expecting to cover the case of no more capacity available by assuming an executor will eventually become idle. Killing an executor has no terrible consequences because with dynamic allocation we probably have external shuffle, so I think the approach you propose in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-15815&quot; title=&quot;Hang while enable blacklistExecutor and DynamicExecutorAllocator &quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-15815&quot;&gt;&lt;del&gt;SPARK-15815&lt;/del&gt;&lt;/a&gt; is a better alternative. &lt;/p&gt;</comment>
                            <comment id="16512510" author="irashid" created="Thu, 14 Jun 2018 14:10:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tgraves&quot; class=&quot;user-hover&quot; rel=&quot;tgraves&quot;&gt;tgraves&lt;/a&gt; we might be able to work on this soon &amp;#8211; a week or two out at least, though.  I know you mentioned some interest in looking at this too, so please let us know if you want to take it up.&lt;/p&gt;</comment>
                            <comment id="16512691" author="tgraves" created="Thu, 14 Jun 2018 16:13:54 +0000"  >&lt;p&gt;ok, just update if you start working on it. thanks.&lt;/p&gt;</comment>
                            <comment id="16597750" author="apachespark" created="Thu, 30 Aug 2018 18:24:03 +0000"  >&lt;p&gt;User &apos;dhruve&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/22288&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/22288&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17077603" author="vsowrirajan" created="Tue, 7 Apr 2020 21:59:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=irashid&quot; class=&quot;user-hover&quot; rel=&quot;irashid&quot;&gt;irashid&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Dhruve+Ashar&quot; class=&quot;user-hover&quot; rel=&quot;Dhruve Ashar&quot;&gt;Dhruve Ashar&lt;/a&gt; Recently we have enabled blacklisting in our platform and it works nicely mostly. We also have this fix where there are no executors to retry due to blacklisting (mainly with dynamic allocation enabled and happens during the tail end of the stage). &lt;/p&gt;

&lt;p&gt;I also went through the fix and in general blacklisting code. Although it still happens, where all the other executors are busy and no idle blacklisted executor left to kill and request a new executor which causes the stage and eventually the job to be aborted before all the retries. &lt;/p&gt;

&lt;p&gt;Do you guys also see this behavior or have this issue? Do you think requesting a new executor in general would help rather than trying to kill a blacklisted idle executor?&lt;/p&gt;</comment>
                            <comment id="17077614" author="tgraves" created="Tue, 7 Apr 2020 22:24:36 +0000"  >&lt;p&gt;I&apos;m not sure I follow what you are saying. &#160;Are you just saying even with this change, you still see the behavior that your job is aborted? &#160;This PR is a heuristic which makes it better in some cases but it still might hit that condition.&lt;/p&gt;

&lt;p&gt;You say &quot; where all the other executors are busy and no idle blacklisted executor left to kill&quot;. &#160; I&apos;m not sure what that means.I assume it already killed some and if there aren&apos;t any left to kill, is it just taking a long time to acquire more from yarn? &#160;If not please give more detail&lt;/p&gt;</comment>
                            <comment id="17077674" author="vsowrirajan" created="Tue, 7 Apr 2020 23:57:26 +0000"  >&lt;p&gt;Thanks for responding &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tgraves&quot; class=&quot;user-hover&quot; rel=&quot;tgraves&quot;&gt;tgraves&lt;/a&gt;. Thats right. &lt;/p&gt;

&lt;p&gt;Lets say all the executors are busy with some task and one of the task fails, then we are aborting the stage as there is no idle blacklisted executor available to kill and replace. But with dynamic allocation enabled, we could have requested for more executors and retried the task.&lt;/p&gt;

&lt;p&gt;Infact, I can reproduce this with min executors set to 1 and max to some number. In this case, it wouldn&apos;t scale up immediately and the first task fails the whole stage because the only executor available is blacklisted for the task and also busy running other task at that time.&lt;/p&gt;

&lt;p&gt;// Though this example would fail as casting an int to string is not valid. Just for example purposes.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
def test(a: Int) = { a.asInstanceOf[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;] }
sc.parallelize(1 to 10, 10).map(x =&amp;gt; test(x)).collect 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Although if there are more executors, then its retried. Similar other cases are possible &lt;/p&gt;</comment>
                            <comment id="17078278" author="tgraves" created="Wed, 8 Apr 2020 13:29:30 +0000"  >&lt;p&gt;so off the top of my head, I think the main issue with just requesting more is that the dynamic allocation manager isn&apos;t tied very tightly to the scheduler or the blacklist tracker, so getting the information required to properly track why we have more executors then needed took quite a bit more work and code refactoring. &#160;If you are still seeing issues regularly though we could revisit to see if we could either request more or perhaps kill executors that are blacklisted that aren&apos;t completely idle. &#160;But I would have to re-read through these and think about it more. &#160;If you have ideas feel free to propose, though we should do it under a new Jira and link them&#160;&lt;/p&gt;</comment>
                            <comment id="17078520" author="vsowrirajan" created="Wed, 8 Apr 2020 17:35:04 +0000"  >&lt;p&gt;Thanks for your comments &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tgraves&quot; class=&quot;user-hover&quot; rel=&quot;tgraves&quot;&gt;tgraves&lt;/a&gt; Makes sense, I will think about it more, create a new JIRA and share a new proposal based on how we think about it internally.&lt;/p&gt;</comment>
                            <comment id="17082736" author="xkrogen" created="Mon, 13 Apr 2020 23:22:39 +0000"  >&lt;p&gt;For future folks: the JIRA created for the issue is &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-31418&quot; title=&quot;Blacklisting feature aborts Spark job without retrying for max num retries in case of Dynamic allocation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-31418&quot;&gt;&lt;del&gt;SPARK-31418&lt;/del&gt;&lt;/a&gt; and discussion is continuing there.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12976727">SPARK-15815</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12976727">SPARK-15815</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13162670">SPARK-24413</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13297691">SPARK-31418</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12893769" name="SPARK-22148_WIP.diff" size="8013" author="juanrh" created="Tue, 24 Oct 2017 17:16:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 31 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3kmhz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>