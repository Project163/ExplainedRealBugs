<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:15:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-2390] Files in .sparkStaging on HDFS cannot be deleted and wastes the space of HDFS</title>
                <link>https://issues.apache.org/jira/browse/SPARK-2390</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When running jobs with YARN Cluster mode and using HistoryServer, the files in the Staging Directory cannot be deleted.&lt;/p&gt;

&lt;p&gt;HistoryServer uses directory where event log is written, and the directory is represented as a instance of o.a.h.f.FileSystem created by using FileSystem.get.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;FileLogger.scala&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; val fileSystem = Utils.getHadoopFileSystem(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; URI(logDir))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;utils.getHadoopFileSystem&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def getHadoopFileSystem(path: URI): FileSystem = {
  FileSystem.get(path, SparkHadoopUtil.get.newConfiguration())
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On the other hand, ApplicationMaster has a instance named fs, which also created by using FileSystem.get.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;ApplicationMaster&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; val fs = FileSystem.get(yarnConf)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;FileSystem.get returns cached same instance when URI passed to the method represents same file system and the method is called by same user.&lt;/p&gt;

&lt;p&gt;Because of the behavior, when the directory for event log is on HDFS, fs of ApplicationMaster and fileSystem of FileLogger is same instance.&lt;/p&gt;

&lt;p&gt;When shutting down ApplicationMaster, fileSystem.close is called in FileLogger#stop, which is invoked by SparkContext#stop indirectly.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;FileLogger.stop&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def stop() {
  hadoopDataStream.foreach(_.close())
  writer.foreach(_.close())
  fileSystem.close()
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And  ApplicationMaster#cleanupStagingDir also called by JVM shutdown hook. In this method, fs.delete(stagingDirPath) is invoked. &lt;/p&gt;

&lt;p&gt;Because fs.delete in ApplicationMaster is called after fileSystem.close in FileLogger, fs.delete fails and results not deleting files in the staging directory.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12725804">SPARK-2390</key>
            <summary>Files in .sparkStaging on HDFS cannot be deleted and wastes the space of HDFS</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sarutak">Kousuke Saruta</assignee>
                                    <reporter username="sarutak">Kousuke Saruta</reporter>
                        <labels>
                    </labels>
                <created>Mon, 7 Jul 2014 18:30:10 +0000</created>
                <updated>Thu, 10 Dec 2015 06:54:03 +0000</updated>
                            <resolved>Tue, 15 Jul 2014 06:55:52 +0000</resolved>
                                    <version>1.0.0</version>
                    <version>1.0.1</version>
                                    <fixVersion>1.1.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14054041" author="sarutak" created="Mon, 7 Jul 2014 19:08:59 +0000"  >&lt;p&gt;I modified the way to create a instance of FileSystem in FileLogger as follows, the symptom didn&apos;t appear.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; val fileSystem = FileSystem.newInstance(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; URI(logDir), SparkHadoopUtil.get.newConfiguration())  
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="14054162" author="mridulm80" created="Mon, 7 Jul 2014 20:20:23 +0000"  >&lt;p&gt;Here, and a bunch of other places, spark currently closes the Filesystem instance : this is incorrect, and should not be done.&lt;br/&gt;
The fix would be to remove the fs.close; not force creation of new instances.&lt;/p&gt;</comment>
                            <comment id="14054298" author="sarutak" created="Mon, 7 Jul 2014 23:44:01 +0000"  >&lt;p&gt;Thank you for your comment &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mridulm80&quot; class=&quot;user-hover&quot; rel=&quot;mridulm80&quot;&gt;mridulm80&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I noticed FileSystem is to be closed by shutdown hook, and the shutdown hook deletes files in the staging directory and then close FileSystem.&lt;br/&gt;
So, in this case, I also think there is no problem to remove fs.close.&lt;/p&gt;</comment>
                            <comment id="14054333" author="sarutak" created="Tue, 8 Jul 2014 00:39:40 +0000"  >&lt;p&gt;Pull Requested at &lt;a href=&quot;https://github.com/apache/spark/pull/1326&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/1326&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14061773" author="pwendell" created="Tue, 15 Jul 2014 06:55:52 +0000"  >&lt;p&gt;Issue resolved by pull request 1326&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/1326&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/1326&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15050205" author="apachespark" created="Thu, 10 Dec 2015 06:54:03 +0000"  >&lt;p&gt;User &apos;sarutak&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/1326&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/1326&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>403962</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 49 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1xiwn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>404005</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>