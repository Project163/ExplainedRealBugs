<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:15:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-31450] Make ExpressionEncoder thread safe</title>
                <link>https://issues.apache.org/jira/browse/SPARK-31450</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;ExpressionEncoder is currently not thread-safe because it contains stateful objects that are required for converting objects to internal rows and vise versa. We have been working around this by (excessively) cloning ExpressionEncoders which is not free. I propose that we move the stateful bits of the expression encoder into two helper classes that will take care of the conversions.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13298503">SPARK-31450</key>
            <summary>Make ExpressionEncoder thread safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hvanhovell">Herman van H&#246;vell</assignee>
                                    <reporter username="hvanhovell">Herman van H&#246;vell</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 Apr 2020 08:36:30 +0000</created>
                <updated>Mon, 16 Nov 2020 20:16:53 +0000</updated>
                            <resolved>Fri, 17 Apr 2020 01:48:18 +0000</resolved>
                                    <version>3.0.0</version>
                                    <fixVersion>3.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17085359" author="dongjoon" created="Fri, 17 Apr 2020 01:48:18 +0000"  >&lt;p&gt;Issue resolved by pull request 28223&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/28223&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/28223&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17233054" author="navinvishy" created="Mon, 16 Nov 2020 20:16:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hvanhovell&quot; class=&quot;user-hover&quot; rel=&quot;hvanhovell&quot;&gt;hvanhovell&lt;/a&gt;&#160; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dongjoon&quot; class=&quot;user-hover&quot; rel=&quot;dongjoon&quot;&gt;dongjoon&lt;/a&gt; I was in the process of migrating some code from Spark 2.4 to Spark 3 and noticed that this required a change in our code. We use the following process to go from a Thrift type T to InternalRow(reading thrift files on HDFS into a Dataframe):&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;We construct a Spark schema by inspecting the thrift metadata.&lt;/li&gt;
	&lt;li&gt;We convert a thrift object to a GenericRow using the thrift metadata to read columns.&lt;/li&gt;
	&lt;li&gt;We then construct an ExpressionEncoder&lt;span class=&quot;error&quot;&gt;&amp;#91;Row&amp;#93;&lt;/span&gt;&#160;and use it to create an InternalRow as follows:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val schema: StructType = ... &lt;span class=&quot;code-comment&quot;&gt;// infer thrift schema
&lt;/span&gt;val encoder: ExpressionEncoder[Row] = RowEncoder(schema)
val genericRow: GenericRow = toGenericRow(thriftObject, schema)
val internalRow: InternalRow = encoder.toRow(genericRow)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The above steps are used to implement&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; def buildReader(
      sparkSession: SparkSession,
      dataSchema: StructType,
      partitionSchema: StructType,
      requiredSchema: StructType,
      filters: Seq[Filter],
      options: Map[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;],
      hadoopConf: Configuration): PartitionedFile =&amp;gt; Iterator[InternalRow]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;in trait org.apache.spark.sql.execution.datasources.FileFormat where we need an Iterator&lt;span class=&quot;error&quot;&gt;&amp;#91;InternalRow&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;With the change in this ticket, I would have to replace&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val internalRow: InternalRow = encoder.toRow(genericRow) &#160;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;with&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val serializer = encoder.createSerializer()
val internalRow: InternalRow = serializer(genericRow)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Since this is marked as an internal API in the PR, I was wondering if there is a way to implement this so that it is compatible with both Spark 2.4 and Spark 3.&#160;&lt;/p&gt;

&lt;p&gt;My goal is to not require a code change if possible. It seems to me that since I know the schema of the thrift type it should be possible to construct an InternalRow, but I don&apos;t see a way to do this in the code base.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0dnko:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>