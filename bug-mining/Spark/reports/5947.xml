<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:01:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-24909] Spark scheduler can hang when fetch failures, executor lost, task running on lost executor, and multiple stage attempts</title>
                <link>https://issues.apache.org/jira/browse/SPARK-24909</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;The DAGScheduler can hang if the executor was lost (due to fetch failure) and all the tasks in the tasks sets are marked as completed.&#160;(&lt;a href=&quot;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/scheduler/DAGScheduler.scala#L1265)&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/scheduler/DAGScheduler.scala#L1265)&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It never creates new task attempts in the task scheduler but the dag scheduler still has pendingPartitions.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
8/07/22 08:30:00 INFO scheduler.TaskSetManager: Starting task 55769.0 in stage 44.0 (TID 970752, host1.com, executor 33, partition 55769, PROCESS_LOCAL, 7874 bytes)

18/07/22 08:30:29 INFO scheduler.DAGScheduler: Marking ShuffleMapStage 44 (repartition at Lift.scala:191) as failed due to a fetch failure from ShuffleMapStage 42 (map at foo.scala:27)
18/07/22 08:30:29 INFO scheduler.DAGScheduler: Resubmitting ShuffleMapStage 42 (map at foo.scala:27) and ShuffleMapStage 44 (repartition at bar.scala:191) due to fetch failure
....

18/07/22 08:30:56 INFO scheduler.DAGScheduler: Executor lost: 33 (epoch 18)
18/07/22 08:30:56 INFO schedulerDAGScheduler: Shuffle files lost &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; executor: 33 (epoch 18)

18/07/22 08:31:20 INFO scheduler.DAGScheduler: Submitting ShuffleMapStage 44 (MapPartitionsRDD[70]&#160;at repartition at bar.scala:191), which has no missing parents
18/07/22 08:31:21 INFO cluster.YarnClusterScheduler: Adding task set 44.1 with 59955 tasks

18/07/22 08:31:41 INFO scheduler.TaskSetManager: Finished task 55769.0 in stage 44.0 (TID 970752) in 101505 ms on host1.com (executor 33) (15081/73320)

8/07/22 08:31:41 INFO scheduler.DAGScheduler: Ignoring possibly bogus ShuffleMapTask(44, 55769) completion from executor 33&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In the logs above you will see that task&#160;55769.0 finished after the executor was lost and a new task set was started.&#160; The DAG scheduler says &quot;Ignoring possibly bogus&quot;.. but in the TaskSetManager side it has marked those tasks as completed for all stage attempts. The DAGScheduler gets hung here.&#160; I did a heap dump on the process and can see that 55769 is still in the DAGScheduler pendingPartitions list but the tasksetmanagers are all complete&lt;/p&gt;

&lt;p&gt;Note to reproduce this, you need a situation where&#160; you&#160;have a shufflemaptask (call it task1) fetching data from an executor where it also has other shufflemaptasks (call it task2) running (fetch from other hosts).&#160;the&#160;task1 fetching the data has to FetchFail which would cause the stage to fail and the executor to be marked&#160;as lost due to the fetch failure.&#160; It restarts a new task set for the new stage attempt, then the shufflemaptask task2 that was running on the executor that was marked Lost finished.&#160; The scheduler ignore that complete event&#160; &quot;Ignoring possible bogus ...&quot;. This results in a hang because at this point the TaskSetManager has already marked all tasks for all attempts of that stage as completed.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Configs needed to be on:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;tt&gt;spark.blacklist.application.fetchFailure.enabled=true&lt;/tt&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;tt&gt;spark.blacklist.application.fetchFailure.enabled=true&lt;/tt&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;spark.files.fetchFailure.unRegisterOutputOnHost=true&lt;/p&gt;

&lt;p&gt;spark.shuffle.service.enabled=true&lt;/p&gt;</description>
                <environment></environment>
        <key id="13174181">SPARK-24909</key>
            <summary>Spark scheduler can hang when fetch failures, executor lost, task running on lost executor, and multiple stage attempts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tgraves">Thomas Graves</assignee>
                                    <reporter username="tgraves">Thomas Graves</reporter>
                        <labels>
                    </labels>
                <created>Tue, 24 Jul 2018 19:00:05 +0000</created>
                <updated>Sun, 17 May 2020 17:48:16 +0000</updated>
                            <resolved>Wed, 29 Aug 2018 23:32:44 +0000</resolved>
                                    <version>2.3.1</version>
                                    <fixVersion>2.3.2</fixVersion>
                    <fixVersion>2.4.0</fixVersion>
                                    <component>Scheduler</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16554701" author="tgraves" created="Tue, 24 Jul 2018 19:26:19 +0000"  >&lt;p&gt;Note this may have been introduced as part of&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-23433&quot; title=&quot;java.lang.IllegalStateException: more than one active taskSet for stage&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-23433&quot;&gt;&lt;del&gt;SPARK-23433&lt;/del&gt;&lt;/a&gt; where we now mark all the partitions in stage attempts as completed.&#160; &#160;If the task that completed had been in the latest attempt it would have been removed from pendingPartitions.&#160; If we didn&apos;t have&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-23433&quot; title=&quot;java.lang.IllegalStateException: more than one active taskSet for stage&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-23433&quot;&gt;&lt;del&gt;SPARK-23433&lt;/del&gt;&lt;/a&gt; then I think the stage attempt 44.1 would have went on to run the task again.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=irashid&quot; class=&quot;user-hover&quot; rel=&quot;irashid&quot;&gt;irashid&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16554748" author="irashid" created="Tue, 24 Jul 2018 20:17:32 +0000"  >&lt;p&gt;ugh, yeah I think you&apos;re right.  do you have a fix in mind?&lt;/p&gt;

&lt;p&gt;we could undo &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-23433&quot; title=&quot;java.lang.IllegalStateException: more than one active taskSet for stage&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-23433&quot;&gt;&lt;del&gt;SPARK-23433&lt;/del&gt;&lt;/a&gt;, so that active taskset doesn&apos;t care if an earlier taskset completes the tasks it has (and rethink how to solve that case).&lt;/p&gt;

&lt;p&gt;Or we could have the markPartitionCompletedInAllTaskSets take the epoch into account.&lt;/p&gt;

&lt;p&gt;Or, we could change that condition in the dagscheduler where its getting hung &amp;#8211; it could resubmit the taskset if it thinks there is still work to be done, but all tasksets are complete (which might be a more stable approach in general), rather than only doing it if &lt;tt&gt;shuffleStage.pendingPartitions.isEmpty&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;All of these changes always have a ton of corner cases and past bugs I need to remind myself of, though ...&lt;/p&gt;</comment>
                            <comment id="16554803" author="tgraves" created="Tue, 24 Jul 2018 21:16:38 +0000"  >&lt;p&gt;I haven&apos;t come up with a fix yet but have been looking at essentially all the things you have mentioned.&#160; will continue working on it, except I&apos;m out tomorrow so will continue thursday.&#160;&#160;&lt;/p&gt;</comment>
                            <comment id="16565437" author="tgraves" created="Wed, 1 Aug 2018 14:56:26 +0000"  >&lt;p&gt;this is unfortunately not a straight forward fix, the DAGScheduler doesn&apos;t have control over the fine grain things in the taskscheduler/tasksetmanager, so undoing some of that is not possible with the existing api.&lt;/p&gt;

&lt;p&gt;one possible thing would be to undo the change in&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-19263&quot; title=&quot;DAGScheduler should avoid sending conflicting task set.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-19263&quot;&gt;&lt;del&gt;SPARK-19263&lt;/del&gt;&lt;/a&gt;,&#160; &lt;a href=&quot;https://github.com/apache/spark/commit/729ce3703257aa34c00c5c8253e6971faf6a0c8d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/729ce3703257aa34c00c5c8253e6971faf6a0c8d&lt;/a&gt;&#160;and fix that another way as well&lt;/p&gt;

&lt;p&gt;Still working on a fix, just making a few notes.&lt;/p&gt;</comment>
                            <comment id="16565513" author="tgraves" created="Wed, 1 Aug 2018 15:44:47 +0000"  >&lt;p&gt;looking more I think the fix may actually just be to revert the change from&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-19263&quot; title=&quot;DAGScheduler should avoid sending conflicting task set.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-19263&quot;&gt;&lt;del&gt;SPARK-19263&lt;/del&gt;&lt;/a&gt;, so that it always does&#160;shuffleStage.pendingPartitions -= task.partitionId.&#160; &#160;The change in&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-23433&quot; title=&quot;java.lang.IllegalStateException: more than one active taskSet for stage&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-23433&quot;&gt;&lt;del&gt;SPARK-23433&lt;/del&gt;&lt;/a&gt;, should fix the issue originaly from &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-19263&quot; title=&quot;DAGScheduler should avoid sending conflicting task set.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-19263&quot;&gt;&lt;del&gt;SPARK-19263&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;If we always remove it from the pendingPartitions and the map output isn&apos;t there it will resubmit the stage.&#160; &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-23433&quot; title=&quot;java.lang.IllegalStateException: more than one active taskSet for stage&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-23433&quot;&gt;&lt;del&gt;SPARK-23433&lt;/del&gt;&lt;/a&gt;, since its marking all tasks in other stage attempts as complete should make sure no other active stages for that are running.&lt;/p&gt;

&lt;p&gt;Need to investigate more and run some tests.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16596932" author="vanzin" created="Wed, 29 Aug 2018 23:32:44 +0000"  >&lt;p&gt;Issue resolved by pull request 21976&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21976&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21976&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13181616">SPARK-25263</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 11 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3w8lj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12342385">2.4.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>