<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:57:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-22267] Spark SQL incorrectly reads ORC file when column order is different</title>
                <link>https://issues.apache.org/jira/browse/SPARK-22267</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;For a long time, Apache Spark SQL returns incorrect results when ORC file schema is different from metastore schema order.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
scala&amp;gt; Seq(1 -&amp;gt; 2).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;c1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;c2&quot;&lt;/span&gt;).write.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;parquet&quot;&lt;/span&gt;).mode(&lt;span class=&quot;code-quote&quot;&gt;&quot;overwrite&quot;&lt;/span&gt;).save(&lt;span class=&quot;code-quote&quot;&gt;&quot;/tmp/p&quot;&lt;/span&gt;)
scala&amp;gt; Seq(1 -&amp;gt; 2).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;c1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;c2&quot;&lt;/span&gt;).write.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;orc&quot;&lt;/span&gt;).mode(&lt;span class=&quot;code-quote&quot;&gt;&quot;overwrite&quot;&lt;/span&gt;).save(&lt;span class=&quot;code-quote&quot;&gt;&quot;/tmp/o&quot;&lt;/span&gt;)
scala&amp;gt; sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE EXTERNAL TABLE p(c2 INT, c1 INT) STORED AS parquet LOCATION &lt;span class=&quot;code-quote&quot;&gt;&apos;/tmp/p&apos;&lt;/span&gt;&quot;&lt;/span&gt;)
scala&amp;gt; sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE EXTERNAL TABLE o(c2 INT, c1 INT) STORED AS orc LOCATION &lt;span class=&quot;code-quote&quot;&gt;&apos;/tmp/o&apos;&lt;/span&gt;&quot;&lt;/span&gt;)
scala&amp;gt; spark.table(&lt;span class=&quot;code-quote&quot;&gt;&quot;p&quot;&lt;/span&gt;).show  &lt;span class=&quot;code-comment&quot;&gt;// Parquet is good.
&lt;/span&gt;+---+---+
| c2| c1|
+---+---+
|  2|  1|
+---+---+
scala&amp;gt; spark.table(&lt;span class=&quot;code-quote&quot;&gt;&quot;o&quot;&lt;/span&gt;).show    &lt;span class=&quot;code-comment&quot;&gt;// This is wrong.
&lt;/span&gt;+---+---+
| c2| c1|
+---+---+
|  1|  2|
+---+---+
scala&amp;gt; spark.read.orc(&lt;span class=&quot;code-quote&quot;&gt;&quot;/tmp/o&quot;&lt;/span&gt;).show  &lt;span class=&quot;code-comment&quot;&gt;// This is correct.
&lt;/span&gt;+---+---+
| c1| c2|
+---+---+
|  1|  2|
+---+---+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;TESTCASE&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  test(&lt;span class=&quot;code-quote&quot;&gt;&quot;SPARK-22267 Spark SQL incorrectly reads ORC files when column order is different&quot;&lt;/span&gt;) {
    withTempDir { dir =&amp;gt;
      val path = dir.getCanonicalPath

      Seq(1 -&amp;gt; 2).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;c1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;c2&quot;&lt;/span&gt;).write.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;orc&quot;&lt;/span&gt;).mode(&lt;span class=&quot;code-quote&quot;&gt;&quot;overwrite&quot;&lt;/span&gt;).save(path)
      checkAnswer(spark.read.orc(path), Row(1, 2))

      Seq(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;).foreach { value =&amp;gt;
        withTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;t&quot;&lt;/span&gt;) {
          withSQLConf(HiveUtils.CONVERT_METASTORE_ORC.key -&amp;gt; value) {
            sql(s&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE EXTERNAL TABLE t(c2 INT, c1 INT) STORED AS ORC LOCATION &lt;span class=&quot;code-quote&quot;&gt;&apos;$path&apos;&lt;/span&gt;&quot;&lt;/span&gt;)
            checkAnswer(spark.table(&lt;span class=&quot;code-quote&quot;&gt;&quot;t&quot;&lt;/span&gt;), Row(2, 1))
          }
        }
      }
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13109016">SPARK-22267</key>
            <summary>Spark SQL incorrectly reads ORC file when column order is different</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dongjoon">Dongjoon Hyun</assignee>
                                    <reporter username="dongjoon">Dongjoon Hyun</reporter>
                        <labels>
                    </labels>
                <created>Thu, 12 Oct 2017 18:45:23 +0000</created>
                <updated>Mon, 11 Dec 2017 13:55:27 +0000</updated>
                            <resolved>Mon, 11 Dec 2017 13:55:27 +0000</resolved>
                                    <version>1.6.3</version>
                    <version>2.0.2</version>
                    <version>2.1.0</version>
                    <version>2.2.0</version>
                                    <fixVersion>2.3.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16251250" author="apachespark" created="Tue, 14 Nov 2017 11:16:05 +0000"  >&lt;p&gt;User &apos;mpetruska&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19744&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19744&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16251305" author="cloud_fan" created="Tue, 14 Nov 2017 12:21:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dongjoon&quot; class=&quot;user-hover&quot; rel=&quot;dongjoon&quot;&gt;dongjoon&lt;/a&gt; will this be fixed by the new orc reader?&lt;/p&gt;</comment>
                            <comment id="16251788" author="dongjoon" created="Tue, 14 Nov 2017 17:30:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt;. This issue comes from old Hive reader path.&lt;br/&gt;
I&apos;ll check the PR and email.&lt;/p&gt;</comment>
                            <comment id="16253281" author="mpetruska" created="Wed, 15 Nov 2017 10:58:57 +0000"  >&lt;p&gt;Investigated the issue; unfortunately did not find any means to fix the issue without forcing CONVERT_METASTORE_ORC or changing the ORC reader implementation.&lt;br/&gt;
Maybe &lt;a href=&quot;https://github.com/apache/spark/pull/19470&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19470&lt;/a&gt; fixes the issue? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dongjoon&quot; class=&quot;user-hover&quot; rel=&quot;dongjoon&quot;&gt;dongjoon&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16254038" author="dongjoon" created="Wed, 15 Nov 2017 19:43:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mpetruska&quot; class=&quot;user-hover&quot; rel=&quot;mpetruska&quot;&gt;mpetruska&lt;/a&gt;. I made this issue during that PR.&lt;br/&gt;
Please see my comment at that time, &lt;a href=&quot;https://github.com/apache/spark/pull/19470#issuecomment-336230552&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19470#issuecomment-336230552&lt;/a&gt; .&lt;br/&gt;
We need more effort on this issue later. For Spark 2.3, convertMetastoreOrc with new OrcFileFormat will be the best option for us.&lt;/p&gt;</comment>
                            <comment id="16255112" author="mpetruska" created="Thu, 16 Nov 2017 10:46:32 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dongjoon&quot; class=&quot;user-hover&quot; rel=&quot;dongjoon&quot;&gt;dongjoon&lt;/a&gt;, I can confirm that reading from an ORC file works correctly with &quot;convertMetastoreOrc&quot; set (it causes to use the new OrcFileFormat) in 2.3.0-SNAPSHOT.&lt;/p&gt;</comment>
                            <comment id="16255650" author="dongjoon" created="Thu, 16 Nov 2017 17:29:49 +0000"  >&lt;p&gt;Yep. It does, but there exist the following issues still.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-15474&quot; title=&quot; ORC data source fails to write and read back empty dataframe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-15474&quot;&gt;&lt;del&gt;SPARK-15474&lt;/del&gt;&lt;/a&gt;: ORC data source fails to write and read back empty dataframe&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-21791&quot; title=&quot;ORC should support column names with dot&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-21791&quot;&gt;&lt;del&gt;SPARK-21791&lt;/del&gt;&lt;/a&gt;: ORC should support column names with dot&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Those will be resolved in the following PR by using new ORC 1.4 (&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-20682&quot; title=&quot;Add new ORCFileFormat based on Apache ORC&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-20682&quot;&gt;&lt;del&gt;SPARK-20682&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/spark/pull/19651&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19651&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16262850" author="mpetruska" created="Wed, 22 Nov 2017 16:10:42 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dongjoon&quot; class=&quot;user-hover&quot; rel=&quot;dongjoon&quot;&gt;dongjoon&lt;/a&gt;, I see that both issues mentioned are in progress.&lt;br/&gt;
Do you need some help or should I work on using `OrcFileFormat` even when &quot;convertMetastoreOrc&quot; is not set?&lt;/p&gt;</comment>
                            <comment id="16263548" author="dongjoon" created="Wed, 22 Nov 2017 23:26:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mpetruska&quot; class=&quot;user-hover&quot; rel=&quot;mpetruska&quot;&gt;mpetruska&lt;/a&gt;. If you have a patch, please feel free to proceed `convertMetastoreOrc=false` case. Thanks.&lt;/p&gt;</comment>
                            <comment id="16274447" author="mpetruska" created="Fri, 1 Dec 2017 14:12:11 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dongjoon&quot; class=&quot;user-hover&quot; rel=&quot;dongjoon&quot;&gt;dongjoon&lt;/a&gt;, sorry for the late reply. I do not have a patch for that case; my first idea would be to force the `convertMetastoreOrc=true` behaviour even when it is set to false. Is it viable? Is there a better solution?&lt;/p&gt;</comment>
                            <comment id="16274526" author="cloud_fan" created="Fri, 1 Dec 2017 15:39:27 +0000"  >&lt;p&gt;just to confirm, is it a hive bug or a Spark only bug?&lt;/p&gt;</comment>
                            <comment id="16274588" author="mpetruska" created="Fri, 1 Dec 2017 16:28:22 +0000"  >&lt;p&gt;All evidence suggests that this is a hive bug.&lt;br/&gt;
In &lt;a href=&quot;https://github.com/apache/spark/pull/19744&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19744&lt;/a&gt; I tried a couple of configurations/properties for the hive `OrcInputFormat` and `OrcSerde`; none of them had any effect, the data was always read in the order as written (and not in the order requested).&lt;/p&gt;</comment>
                            <comment id="16283407" author="apachespark" created="Fri, 8 Dec 2017 11:25:04 +0000"  >&lt;p&gt;User &apos;dongjoon-hyun&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19928&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19928&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16283410" author="dongjoon" created="Fri, 8 Dec 2017 11:27:52 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mpetruska&quot; class=&quot;user-hover&quot; rel=&quot;mpetruska&quot;&gt;mpetruska&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt;.&lt;br/&gt;
After &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-22279&quot; title=&quot;Turn on spark.sql.hive.convertMetastoreOrc by default&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-22279&quot;&gt;&lt;del&gt;SPARK-22279&lt;/del&gt;&lt;/a&gt;, the default configuration doesn&apos;t have this bug. Although Hive 1.2.1 library code path still has the problem, we had better have a test coverage on what we have now in order to prevent future regression on it. So, I create a test case PR.&lt;br/&gt;
I believe most of users are not going to hit this issue since 2.3.&lt;/p&gt;</comment>
                            <comment id="16285941" author="cloud_fan" created="Mon, 11 Dec 2017 13:55:27 +0000"  >&lt;p&gt;Issue resolved by pull request 19928&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19928&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19928&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13075230">SPARK-20901</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 49 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3l7fr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>