<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:33:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-41971] `toPandas` should support duplicate filed names when arrow-optimization is on</title>
                <link>https://issues.apache.org/jira/browse/SPARK-41971</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;toPandas support duplicate columns name, but for a struct column, it doesnot support duplicate field names.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
In [27]: spark.conf.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;spark.sql.execution.arrow.pyspark.enabled&quot;&lt;/span&gt;, False)

In [28]: spark.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select 1 v, 1 v&quot;&lt;/span&gt;).toPandas()
Out[28]: 
   v  v
0  1  1

In [29]: spark.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select struct(1 v, 1 v)&quot;&lt;/span&gt;).toPandas()
Out[29]: 
  struct(1 AS v, 1 AS v)
0                 (1, 1)

In [30]: spark.conf.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;spark.sql.execution.arrow.pyspark.enabled&quot;&lt;/span&gt;, True)

In [31]: spark.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select 1 v, 1 v&quot;&lt;/span&gt;).toPandas()
Out[31]: 
   v  v
0  1  1

In [32]: spark.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select struct(1 v, 1 v)&quot;&lt;/span&gt;).toPandas()
/Users/ruifeng.zheng/Dev/spark/python/pyspark/sql/pandas/conversion.py:204: UserWarning: toPandas attempted Arrow optimization because &lt;span class=&quot;code-quote&quot;&gt;&apos;spark.sql.execution.arrow.pyspark.enabled&apos;&lt;/span&gt; is set to &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, but has reached the error below and can not &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;. Note that &lt;span class=&quot;code-quote&quot;&gt;&apos;spark.sql.execution.arrow.pyspark.fallback.enabled&apos;&lt;/span&gt; does not have an effect on failures in the middle of computation.
  Ran out of field metadata, likely malformed
  warn(msg)
---------------------------------------------------------------------------
ArrowInvalid                              Traceback (most recent call last)
Cell In[32], line 1
----&amp;gt; 1 spark.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select struct(1 v, 1 v)&quot;&lt;/span&gt;).toPandas()

File ~/Dev/spark/python/pyspark/sql/pandas/conversion.py:143, in PandasConversionMixin.toPandas(self)
    141 tmp_column_names = [&lt;span class=&quot;code-quote&quot;&gt;&quot;col_{}&quot;&lt;/span&gt;.format(i) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; i in range(len(self.columns))]
    142 self_destruct = jconf.arrowPySparkSelfDestructEnabled()
--&amp;gt; 143 batches = self.toDF(*tmp_column_names)._collect_as_arrow(
    144     split_batches=self_destruct
    145 )
    146 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; len(batches) &amp;gt; 0:
    147     table = pyarrow.Table.from_batches(batches)

File ~/Dev/spark/python/pyspark/sql/pandas/conversion.py:358, in PandasConversionMixin._collect_as_arrow(self, split_batches)
    356             results.append(batch_or_indices)
    357     &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;:
--&amp;gt; 358         results = list(batch_stream)
    359 &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt;:
    360     # Join serving thread and raise any exceptions from collectAsArrowToPython
    361     jsocket_auth_server.getResult()

File ~/Dev/spark/python/pyspark/sql/pandas/serializers.py:55, in ArrowCollectSerializer.load_stream(self, stream)
     50 &quot;&quot;&quot;
     51 Load a stream of un-ordered Arrow RecordBatches, where the last iteration yields
     52 a list of indices that can be used to put the RecordBatches in the correct order.
     53 &quot;&quot;&quot;
     54 # load the batches
---&amp;gt; 55 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; batch in self.serializer.load_stream(stream):
     56     yield batch
     58 # load the batch order indices or propagate any error that occurred in the JVM

File ~/Dev/spark/python/pyspark/sql/pandas/serializers.py:98, in ArrowStreamSerializer.load_stream(self, stream)
     95 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; pyarrow as pa
     97 reader = pa.ipc.open_stream(stream)
---&amp;gt; 98 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; batch in reader:
     99     yield batch

File ~/.dev/miniconda3/envs/spark_dev/lib/python3.9/site-packages/pyarrow/ipc.pxi:638, in __iter__()

File ~/.dev/miniconda3/envs/spark_dev/lib/python3.9/site-packages/pyarrow/ipc.pxi:674, in pyarrow.lib.RecordBatchReader.read_next_batch()

File ~/.dev/miniconda3/envs/spark_dev/lib/python3.9/site-packages/pyarrow/error.pxi:100, in pyarrow.lib.check_status()

ArrowInvalid: Ran out of field metadata, likely malformed

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13517524">SPARK-41971</key>
            <summary>`toPandas` should support duplicate filed names when arrow-optimization is on</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ueshin">Takuya Ueshin</assignee>
                                    <reporter username="podongfeng">Ruifeng Zheng</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 Jan 2023 03:12:35 +0000</created>
                <updated>Thu, 4 May 2023 18:07:43 +0000</updated>
                            <resolved>Thu, 4 May 2023 18:04:03 +0000</resolved>
                                    <version>3.4.0</version>
                                    <fixVersion>3.5.0</fixVersion>
                                    <component>PySpark</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17657059" author="podongfeng" created="Wed, 11 Jan 2023 03:14:18 +0000"  >&lt;p&gt;I think that is due to something is wrong in `ArrowConverter`.&lt;/p&gt;

&lt;p&gt;In Spark, a schema is just a StructType, but in arrow that is not the case, a schema is a class other than datatype. This difference maybe the cause.&lt;/p&gt;</comment>
                            <comment id="17702892" author="JIRAUSER299429" created="Mon, 20 Mar 2023 18:57:04 +0000"  >&lt;p&gt;Can I work on this issue?&lt;/p&gt;</comment>
                            <comment id="17719462" author="xinrongm" created="Thu, 4 May 2023 18:04:03 +0000"  >&lt;p&gt;Issue resolved by pull request 40988&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/40988&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/40988&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17719463" author="xinrongm" created="Thu, 4 May 2023 18:07:43 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nikj&quot; class=&quot;user-hover&quot; rel=&quot;nikj&quot;&gt;nikj&lt;/a&gt; , the issue has been resolved. Feel free to pick other issues that you are interested in. Normally we comment on the ticket and file the pull request afterward directly.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 27 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1epgo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>