<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:56:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-22211] LimitPushDown optimization for FullOuterJoin generates wrong results</title>
                <link>https://issues.apache.org/jira/browse/SPARK-22211</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;LimitPushDown pushes LocalLimit to one side for FullOuterJoin, but this may generate a wrong result:&lt;/p&gt;

&lt;p&gt;Assume we use limit(1) and LocalLimit will be pushed to left side, and id=999 is selected, but at right side we have 100K rows including 999, the result will be&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;one row is (999, 999)&lt;/li&gt;
	&lt;li&gt;the rest rows are (null, xxx)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Once you call show(), the row (999,999) has only 1/100000th chance to be selected by CollectLimit.&lt;/p&gt;

&lt;p&gt;The actual optimization might be, &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;push down limit&lt;/li&gt;
	&lt;li&gt;but convert the join to Broadcast LeftOuterJoin or RightOuterJoin.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Here is my notebook:&lt;br/&gt;
&lt;a href=&quot;https://databricks-prod-cloudfront.cloud.databricks.com/public/4027ec902e239c93eaaa8714f173bcfc/349451637617406/2750346983121008/6888856075277290/latest.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://databricks-prod-cloudfront.cloud.databricks.com/public/4027ec902e239c93eaaa8714f173bcfc/349451637617406/2750346983121008/6888856075277290/latest.html&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; scala.util.Random._

val dl = shuffle(1 to 100000).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;)
val dr = shuffle(1 to 100000).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;)

println(&lt;span class=&quot;code-quote&quot;&gt;&quot;data frame dl:&quot;&lt;/span&gt;)
dl.explain

println(&lt;span class=&quot;code-quote&quot;&gt;&quot;data frame dr:&quot;&lt;/span&gt;)
dr.explain

val j = dl.join(dr, dl(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;) === dr(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;), &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;outer&lt;/span&gt;&quot;&lt;/span&gt;).limit(1)

j.explain

j.show(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;data frame dl:
== Physical Plan ==
LocalTableScan [id#10]
data frame dr:
== Physical Plan ==
LocalTableScan [id#16]
== Physical Plan ==
CollectLimit 1
+- SortMergeJoin [id#10], [id#16], FullOuter
   :- *Sort [id#10 ASC NULLS FIRST], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, 0
   :  +- Exchange hashpartitioning(id#10, 200)
   :     +- *LocalLimit 1
   :        +- LocalTableScan [id#10]
   +- *Sort [id#16 ASC NULLS FIRST], &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, 0
      +- Exchange hashpartitioning(id#16, 200)
         +- LocalTableScan [id#16]
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; scala.util.Random._
dl: org.apache.spark.sql.DataFrame = [id: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;]
dr: org.apache.spark.sql.DataFrame = [id: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;]
j: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [id: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, id: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;]

+----+---+
|id  |id |
+----+---+
|&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|148|
+----+---+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;on community.cloude.databrick.com &lt;br/&gt;
Runtime Version 3.2 (includes Apache Spark 2.2.0, Scala 2.11)&lt;/p&gt;</environment>
        <key id="13107418">SPARK-22211</key>
            <summary>LimitPushDown optimization for FullOuterJoin generates wrong results</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="henryr">Henry Robinson</assignee>
                                    <reporter username="bewang.tech">Benyi Wang</reporter>
                        <labels>
                    </labels>
                <created>Fri, 6 Oct 2017 03:09:11 +0000</created>
                <updated>Thu, 9 Nov 2017 01:17:04 +0000</updated>
                            <resolved>Sun, 5 Nov 2017 05:56:07 +0000</resolved>
                                    <version>2.2.0</version>
                                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>2.3.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16194170" author="maropu" created="Fri, 6 Oct 2017 05:36:26 +0000"  >&lt;p&gt;Probably, the suggested solution does not work when both-side tables are small and a limit value is high. IMHO one option to solve this is just to stop the pushdown for full-outer joins (because I couldn&apos;t find better solutions to solve this smartly...).&lt;/p&gt;</comment>
                            <comment id="16202278" author="bewang.tech" created="Thu, 12 Oct 2017 17:02:57 +0000"  >&lt;p&gt;I think my suggestion solution is correct.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Case &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Left join key &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Right join key &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Full outer join &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 1 &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Y &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; N &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;tt&gt;(left(&amp;#42;), null)&lt;/tt&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 2 &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Y &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Y &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;tt&gt;(left(&amp;#42;), right(&amp;#42;))&lt;/tt&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 3 &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; N &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Y &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;tt&gt;(null, right(&amp;#42;))&lt;/tt&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 4 &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; N &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; N &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Not applied &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;If LimitPushDown pushes limit to the left side, whatever a limit value is and how big of left side table, you will always select some rows, in other words, the join keys are always exists, and only case 1 and 2 will happen, so it is actually a Left-join instead. It is equivalent to right-join when pushing down to  the right side.&lt;/p&gt;

&lt;p&gt;The only problem of this method is: case 3 has no chance to be shown while pushing down to the left side, and case 1 for the right side. I would say this is not a big issue because we just want to see some samples of the join result, but the benefit is huge. If we want to see left-only or right-only, we might add where clause.  &lt;/p&gt;</comment>
                            <comment id="16202863" author="maropu" created="Fri, 13 Oct 2017 00:26:00 +0000"  >&lt;p&gt;Aha, I misunderstood. But, I think the case 3 is not acceptable (I know we can get big performance gains though...) because the transformation of relational expressions must not change results. IIUC, in the case 3, the push-down changes the result, right?&lt;/p&gt;</comment>
                            <comment id="16223073" author="henryr" created="Sat, 28 Oct 2017 00:08:51 +0000"  >&lt;p&gt;I think the optimization proposed works only for a self-join. If you transform a FOJ into a one-sided outer join in general, you might omit rows from the result that should be there. &lt;/p&gt;

&lt;p&gt;Assume that the idea is to transform the full outer-join into a right outer-join, with the limit pushed to either the LHS or RHS. One problem comes if the limit is pushed to the RHS, but is larger than the number of rows in the RHS. For example, if you have tables T1 = (1,2) and T2 = (1), consider the following query:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;SELECT * FROM T1 a FULL OUTER JOIN T2 b on a.col = b.col LIMIT 2&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;If the limit is pushed into T2&apos;s scan (and the FOJ is changed to a ROJ), the query would emit only the tuple (1,1) - and omit (2,null) which should be included.&lt;/p&gt;

&lt;p&gt;(If the limit is pushed into T1&apos;s scan there are other bugs if the limit is &lt;em&gt;less&lt;/em&gt; than the number of rows, by a similar argument).&lt;/p&gt;

&lt;p&gt;I checked and I don&apos;t think Postgres tries to push limits into a FOJ either. Impala doesn&apos;t. &lt;/p&gt;</comment>
                            <comment id="16225816" author="henryr" created="Mon, 30 Oct 2017 21:59:30 +0000"  >&lt;p&gt;Thinking about it a more, I think the optimization that&apos;s currently implemented works as long as a) the limit is pushed to the streaming side of the join and b) the physical join implementation guarantees that it will emit rows that have non-null RHSs from the streaming side before any that have a null RHS.&lt;/p&gt;

&lt;p&gt;That is: say we&apos;ve got a build-side of one row, (A,C), and a streaming-side of (A,B). If we do a full outer-join of these two inputs, the result should be some ordering of (A, A), (null, B), (C, null). If we do a FOJ with LIMIT 1 pushed to the streaming side, imagine it returns (B). It&apos;s an error if the join operator sees that A on the build-side has no match, and emits that (A, null) before it sees that B has no match and emits (null, B). But if it emits (null, B) first, the limit above it should kick in and no further rows will be emitted. &lt;/p&gt;

&lt;p&gt;It seems a bit fragile to rely on this behaviour from all join implementations, and it has some implications for other transformations (e.g. it would not be safe to flip the join order for a FOJ with a pushed-down limit - but would be ok for a non-pushed-down one). However, it&apos;s also a bit concerning to remove an optimization that&apos;s probably a big win for some queries, even if it&apos;s incorrect. There are rewrites that would work, e.g.:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;x.join(y, x(&lt;span class=&quot;code-quote&quot;&gt;&apos;bar&apos;&lt;/span&gt;) === y(&lt;span class=&quot;code-quote&quot;&gt;&apos;bar&apos;&lt;/span&gt;), &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;outer&lt;/span&gt;&quot;&lt;/span&gt;).limit(10) ==&amp;gt; x.sort.limit(10).join(y.sort.limit(10), x(&lt;span class=&quot;code-quote&quot;&gt;&apos;bar&apos;&lt;/span&gt;) === y(&lt;span class=&quot;code-quote&quot;&gt;&apos;bar&apos;&lt;/span&gt;), &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;outer&lt;/span&gt;&quot;&lt;/span&gt;).sort.limit(10) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;seems like it would be correct. But for now, how about we disable the push-down optimization in &lt;tt&gt;LimitPushDown&lt;/tt&gt; and see if there&apos;s a need to investigate more complicated optimizations after that?&lt;/p&gt;</comment>
                            <comment id="16236861" author="apachespark" created="Fri, 3 Nov 2017 00:09:04 +0000"  >&lt;p&gt;User &apos;henryr&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19647&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19647&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16237133" author="smilegator" created="Fri, 3 Nov 2017 06:05:29 +0000"  >&lt;p&gt;Will submit a PR based on my previous PR &lt;a href=&quot;https://github.com/apache/spark/pull/10454&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/10454&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16237778" author="henryr" created="Fri, 3 Nov 2017 15:35:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smilegator&quot; class=&quot;user-hover&quot; rel=&quot;smilegator&quot;&gt;smilegator&lt;/a&gt; - sounds good! What will your approach be? I wasn&apos;t able to see a safe way to push the limit through the join without either a more invasive rewrite or restricting the set of join operators for FOJ. &lt;/p&gt;</comment>
                            <comment id="16237797" author="smilegator" created="Fri, 3 Nov 2017 15:54:00 +0000"  >&lt;p&gt;The Join operator should be limit aware. Anyway, we can do it later.&lt;/p&gt;</comment>
                            <comment id="16237822" author="srowen" created="Fri, 3 Nov 2017 16:05:07 +0000"  >&lt;p&gt;In the name of correctness, still worth disabling for now, and then fixing later right?&lt;/p&gt;</comment>
                            <comment id="16237825" author="smilegator" created="Fri, 3 Nov 2017 16:06:51 +0000"  >&lt;p&gt;We should merge it to the master and the previous releases at first.&lt;/p&gt;</comment>
                            <comment id="16238281" author="henryr" created="Fri, 3 Nov 2017 20:03:32 +0000"  >&lt;p&gt;Sounds good, thanks both.&lt;/p&gt;</comment>
                            <comment id="16245029" author="dongjoon" created="Thu, 9 Nov 2017 00:58:17 +0000"  >&lt;p&gt;Hi, All.&lt;br/&gt;
This breaks `branch-2.2`.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;SBT: &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/view/Spark%20QA%20Test%20(Dashboard)/job/spark-branch-2.2-test-sbt-hadoop-2.7/408/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/view/Spark%20QA%20Test%20(Dashboard)/job/spark-branch-2.2-test-sbt-hadoop-2.7/408/&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;MAVEN: &lt;a href=&quot;https://amplab.cs.berkeley.edu/jenkins/view/Spark%20QA%20Test%20(Dashboard)/job/spark-branch-2.2-test-maven-hadoop-2.7/423&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://amplab.cs.berkeley.edu/jenkins/view/Spark%20QA%20Test%20(Dashboard)/job/spark-branch-2.2-test-maven-hadoop-2.7/423&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16245063" author="apachespark" created="Thu, 9 Nov 2017 01:17:04 +0000"  >&lt;p&gt;User &apos;henryr&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19701&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19701&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 1 week, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ky4v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12340470">2.2.1</customfieldvalue>
    <customfieldvalue id="12339551">2.3.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>