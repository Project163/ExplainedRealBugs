<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:08:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-17398] Failed to query on external JSon Partitioned table</title>
                <link>https://issues.apache.org/jira/browse/SPARK-17398</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;1. Create External Json partitioned table &lt;br/&gt;
with SerDe in hive-hcatalog-core-1.2.1.jar, download fom&lt;br/&gt;
&lt;a href=&quot;https://mvnrepository.com/artifact/org.apache.hive.hcatalog/hive-hcatalog-core/1.2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://mvnrepository.com/artifact/org.apache.hive.hcatalog/hive-hcatalog-core/1.2.1&lt;/a&gt;&lt;br/&gt;
2. Query table meet exception, which works in spark1.5.2&lt;br/&gt;
Exception in thread &quot;main&quot; org.apache.spark.SparkException: Job aborted due to stage failure: Task 0 in stage 1.0 failed 1 times, most recent failure: Lost task&lt;br/&gt;
 0.0 in stage 1.0 (TID 1, localhost): java.lang.ClassCastException: java.util.ArrayList cannot be cast to org.apache.hive.hcatalog.data.HCatRecord&lt;br/&gt;
        at org.apache.hive.hcatalog.data.HCatRecordObjectInspector.getStructFieldData(HCatRecordObjectInspector.java:45)&lt;br/&gt;
        at org.apache.spark.sql.hive.HadoopTableReader$$anonfun$fillObject$2.apply(TableReader.scala:430)&lt;br/&gt;
        at org.apache.spark.sql.hive.HadoopTableReader$$anonfun$fillObject$2.apply(TableReader.scala:426)&lt;/p&gt;


&lt;p&gt;3. Test Code&lt;/p&gt;

&lt;p&gt;import org.apache.spark.SparkConf&lt;br/&gt;
import org.apache.spark.SparkContext&lt;br/&gt;
import org.apache.spark.sql.hive.HiveContext&lt;/p&gt;

&lt;p&gt;object JsonBugs {&lt;/p&gt;

&lt;p&gt;  def main(args: Array&lt;span class=&quot;error&quot;&gt;&amp;#91;String&amp;#93;&lt;/span&gt;): Unit = {&lt;br/&gt;
    val table = &quot;test_json&quot;&lt;br/&gt;
    val location = &quot;file:///g:/home/test/json&quot;&lt;br/&gt;
    val create = s&quot;&quot;&quot;CREATE   EXTERNAL  TABLE  ${table}&lt;br/&gt;
             (id string,  seq string )&lt;br/&gt;
              PARTITIONED BY(index int)&lt;br/&gt;
              ROW FORMAT SERDE &apos;org.apache.hive.hcatalog.data.JsonSerDe&apos;&lt;br/&gt;
              LOCATION &quot;${location}&quot; &lt;br/&gt;
          &quot;&quot;&quot;&lt;br/&gt;
    val add_part = s&quot;&quot;&quot;&lt;br/&gt;
         ALTER TABLE ${table} ADD &lt;br/&gt;
         PARTITION (index=1)LOCATION &apos;${location}/index=1&apos;&lt;br/&gt;
    &quot;&quot;&quot;&lt;/p&gt;

&lt;p&gt;    val conf = new SparkConf().setAppName(&quot;scala&quot;).setMaster(&quot;local&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;&quot;)&lt;br/&gt;
    conf.set(&quot;spark.sql.warehouse.dir&quot;, &quot;file:///g:/home/warehouse&quot;)&lt;br/&gt;
    val ctx = new SparkContext(conf)&lt;/p&gt;

&lt;p&gt;    val hctx = new HiveContext(ctx)&lt;br/&gt;
    val exist = hctx.tableNames().map &lt;/p&gt;
{ x =&amp;gt; x.toLowerCase() }
&lt;p&gt;.contains(table)&lt;br/&gt;
    if (!exist) &lt;/p&gt;
{
      hctx.sql(create)
      hctx.sql(add_part)
    }
&lt;p&gt; else &lt;/p&gt;
{
      hctx.sql(&quot;show partitions &quot; + table).show()
    }
&lt;p&gt;    hctx.sql(&quot;select * from test_json&quot;).show()&lt;br/&gt;
  }&lt;br/&gt;
}&lt;/p&gt;</description>
                <environment></environment>
        <key id="13002665">SPARK-17398</key>
            <summary>Failed to query on external JSon Partitioned table</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="wypoon">Wing Yew Poon</assignee>
                                    <reporter username="pin_zhang">pin_zhang</reporter>
                        <labels>
                    </labels>
                <created>Mon, 5 Sep 2016 05:27:38 +0000</created>
                <updated>Sat, 1 Mar 2025 06:27:29 +0000</updated>
                            <resolved>Fri, 20 Dec 2019 18:53:00 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.4.5</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15687427" author="srowen" created="Tue, 22 Nov 2016 17:58:30 +0000"  >&lt;p&gt;Changing resolution because I don&apos;t see evidence of what resolved it, even if it may indeed be resolved&lt;/p&gt;</comment>
                            <comment id="16874652" author="bianqi" created="Fri, 28 Jun 2019 04:03:47 +0000"  >&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12973134/12973134_screenshot-1.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;  &lt;/p&gt;</comment>
                            <comment id="16968033" author="angerszhuuu" created="Wed, 6 Nov 2019 02:48:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bianqi&quot; class=&quot;user-hover&quot; rel=&quot;bianqi&quot;&gt;bianqi&lt;/a&gt;&lt;br/&gt;
Hi, I meet this problem too, have you know what&apos;s the problem? &lt;/p&gt;</comment>
                            <comment id="16996073" author="wypoon" created="Sat, 14 Dec 2019 02:02:46 +0000"  >&lt;p&gt;This issue was never actually fixed. Evidently the problem still exists.&lt;br/&gt;
I&apos;ll create a PR with a fix.&lt;/p&gt;</comment>
                            <comment id="17931622" author="fu" created="Sat, 1 Mar 2025 06:27:29 +0000"  >&lt;p&gt;&amp;gt; Caused by: java.lang.ClassCastException: java.util.ArrayList cannot be cast to org.apache.hive.hcatalog.data.HCatRecord&lt;/p&gt;

&lt;p&gt;run into similar issue when change the serde from  `org.apache.hadoop.hive.serde2.JsonSerDe` to `org.apache.hive.hcatalog.data.JsonSerDe` because of some Trino upgrade requirement, &lt;br/&gt;
it turns out that the later requires all lower case column name when define the hive table.&lt;/p&gt;

&lt;p&gt;```&lt;br/&gt;
CREATE EXTERNAL TABLE xx (&lt;br/&gt;
        errorLog STRING &amp;#8211; have to be errorlog. &lt;br/&gt;
)&lt;br/&gt;
PARTITIONED BY (date STRING)&lt;br/&gt;
ROW FORMAT SERDE &apos;org.apache.hive.hcatalog.data.JsonSerDe&apos;&lt;br/&gt;
STORED AS TEXTFILE&lt;br/&gt;
LOCATION &apos;s3://somebucket/tables/xx&apos;&lt;br/&gt;
```&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13234100">HIVE-21752</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13039339">HIVE-15773</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12973134" name="screenshot-1.png" size="32585" author="bianqi" created="Fri, 28 Jun 2019 04:03:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            36 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i338lz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>