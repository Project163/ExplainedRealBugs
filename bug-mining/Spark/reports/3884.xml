<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:46:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-16804] Correlated subqueries containing non-deterministic operators return incorrect results</title>
                <link>https://issues.apache.org/jira/browse/SPARK-16804</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Correlated subqueries with LIMIT could return incorrect results. The rule ResolveSubquery in the Analysis phase moves correlated predicates to a join predicates and neglect the semantic of the LIMIT.&lt;/p&gt;

&lt;p&gt;Example:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Seq(1, 2).toDF(&quot;c1&quot;).createOrReplaceTempView(&quot;t1&quot;)
Seq(1, 2).toDF(&quot;c2&quot;).createOrReplaceTempView(&quot;t2&quot;)

sql(&quot;select c1 from t1 where exists (select 1 from t2 where t1.c1=t2.c2 LIMIT 1)&quot;).show
+---+                                                                           
| c1|
+---+
|  1|
+---+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The correct result contains both rows from T1.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12993655">SPARK-16804</key>
            <summary>Correlated subqueries containing non-deterministic operators return incorrect results</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nsyca">Nattavut Sutyanyong</assignee>
                                    <reporter username="nsyca">Nattavut Sutyanyong</reporter>
                        <labels>
                    </labels>
                <created>Fri, 29 Jul 2016 21:37:56 +0000</created>
                <updated>Tue, 15 Nov 2016 22:22:17 +0000</updated>
                            <resolved>Mon, 8 Aug 2016 10:16:36 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.2</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="259200">72h</timeoriginalestimate>
                            <timeestimate seconds="259200">72h</timeestimate>
                                        <comments>
                            <comment id="15400068" author="apachespark" created="Fri, 29 Jul 2016 21:57:04 +0000"  >&lt;p&gt;User &apos;nsyca&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/14411&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/14411&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15400075" author="nsyca" created="Fri, 29 Jul 2016 21:59:50 +0000"  >&lt;p&gt;I am working on a fix. Could you please assign this JIRA to nsyca?&lt;/p&gt;</comment>
                            <comment id="15400090" author="nsyca" created="Fri, 29 Jul 2016 22:06:09 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;scala&amp;gt; sql(&quot;select c1 from t1 where exists (select 1 from t2 where t1.c1=t2.c2 LIMIT 1)&quot;).explain(true)
== Parsed Logical Plan ==
&apos;Project [&apos;c1]
+- &apos;Filter exists#21
   :  +- &apos;SubqueryAlias exists#21
   :     +- &apos;GlobalLimit 1
   :        +- &apos;LocalLimit 1
   :           +- &apos;Project [unresolvedalias(1, None)]
   :              +- &apos;Filter (&apos;t1.c1 = &apos;t2.c2)
   :                 +- &apos;UnresolvedRelation `t2`
   +- &apos;UnresolvedRelation `t1`

== Analyzed Logical Plan ==
c1: int
Project [c1#17]
+- Filter predicate-subquery#21 [(c1#17 = c2#10)]
   :  +- SubqueryAlias predicate-subquery#21 [(c1#17 = c2#10)]   &amp;lt;== This correlated predicate is incorrectly moved above the LIMIT
   :     +- GlobalLimit 1
   :        +- LocalLimit 1
   :           +- Project [1 AS 1#26, c2#10]
   :              +- SubqueryAlias t2
   :                 +- Project [value#8 AS c2#10]
   :                    +- LocalRelation [value#8]
   +- SubqueryAlias t1
      +- Project [value#15 AS c1#17]
         +- LocalRelation [value#15]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;By rewriting the correlated predicate in the subquery in Analysis phase from below the LIMIT 1 operation to above it causing the scan of the subquery table to return only 1 row. The correct semantic is the LIMIT 1 must be applied on the subquery for each input value from the parent table.&lt;/p&gt;</comment>
                            <comment id="15400105" author="nsyca" created="Fri, 29 Jul 2016 22:14:13 +0000"  >&lt;p&gt;This fix blocks any correlated subquery when there is a LIMIT operation on the path from the parent table to the correlated predicate. We may consider relaxing this restriction once we have a better support on processing correlated subquery in run-time. &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-13417&quot; title=&quot;SQL subquery support&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-13417&quot;&gt;&lt;del&gt;SPARK-13417&lt;/del&gt;&lt;/a&gt; is an umbrella task to track this effort.&lt;/p&gt;

&lt;p&gt;Note that if the LIMIT is not in the correlated path, Spark returns correct result.&lt;/p&gt;

&lt;p&gt;Example:&lt;/p&gt;

&lt;p&gt;sql(&quot;select c1 from t1 where exists (select 1 from t2 where t1.c1=t2.c2) and exists (select 1 from t2 LIMIT 1)&quot;).show&lt;/p&gt;

&lt;p&gt;will return both rows from T1, which is correctly handled with and without this proposed fix.&lt;/p&gt;

&lt;p&gt;This fix will change the behaviour of the query&lt;/p&gt;

&lt;p&gt;sql(&quot;select c1 from t1 where exists (select 1 from t2 where t1.c1=t2.c2 LIMIT 1)&quot;).show&lt;/p&gt;

&lt;p&gt;to return an error from the Analysis phase as shown below:&lt;/p&gt;

&lt;p&gt;org.apache.spark.sql.AnalysisException: Accessing outer query column is not allowed in a LIMIT: LocalLimit 1&lt;br/&gt;
...&lt;/p&gt;</comment>
                            <comment id="15400150" author="nsyca" created="Fri, 29 Jul 2016 22:39:55 +0000"  >&lt;p&gt;To demonstrate that this fix does not unnecessarily block the &quot;good&quot; cases (where LIMIT is present but NOT on the correlated path), here is an example, which produce the same result set in both with and without this proposed fix.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;scala&amp;gt; sql(&quot;select c1 from t1 where exists (select 1 from (select 1 from t2 limit 1) where
t1.c1=t2.c2)&quot;).show
+---+
| c1|
+---+
|  1|
+---+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15410651" author="nsyca" created="Sat, 6 Aug 2016 16:23:37 +0000"  >&lt;p&gt;The PR also extends the fix to block the &lt;tt&gt;TABLESAMPLE&lt;/tt&gt; operation in any correlated subquery. &lt;/p&gt;</comment>
                            <comment id="15412849" author="nsyca" created="Tue, 9 Aug 2016 02:53:18 +0000"  >&lt;p&gt;Thank you, @hvanhovell, for merging my PR.&lt;/p&gt;</comment>
                            <comment id="15637905" author="apachespark" created="Fri, 4 Nov 2016 22:29:09 +0000"  >&lt;p&gt;User &apos;hvanhovell&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15772&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15772&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13020945">SPARK-18455</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 2 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i31p1z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12336857">2.0.1</customfieldvalue>
    <customfieldvalue id="12335644">2.1.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>