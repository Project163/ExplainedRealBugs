<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:56:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-22472] Datasets generate random values for null primitive types</title>
                <link>https://issues.apache.org/jira/browse/SPARK-22472</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Not sure if it ever were reported.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
scala&amp;gt; val s = sc.parallelize(Seq[Option[&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;]](None,Some(1L),Some(5))).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;v&quot;&lt;/span&gt;)
s: org.apache.spark.sql.DataFrame = [v: bigint]

scala&amp;gt; s.show(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
+----+
|v   |
+----+
|&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|
|1   |
|5   |
+----+


scala&amp;gt; s.as[&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;].map(v =&amp;gt; v*2).show(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
+-----+
|value|
+-----+
|-2   |
|2    |
|10   |
+-----+


scala&amp;gt; s.select($&lt;span class=&quot;code-quote&quot;&gt;&quot;v&quot;&lt;/span&gt;*2).show(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
+-------+
|(v * 2)|
+-------+
|&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;   |
|2      |
|10     |
+-------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13117007">SPARK-22472</key>
            <summary>Datasets generate random values for null primitive types</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cloud_fan">Wenchen Fan</assignee>
                                    <reporter username="kuzemchik">Vladislav Kuzemchik</reporter>
                        <labels>
                            <label>release-notes</label>
                    </labels>
                <created>Wed, 8 Nov 2017 15:34:22 +0000</created>
                <updated>Fri, 1 Dec 2017 07:22:17 +0000</updated>
                            <resolved>Fri, 10 Nov 2017 06:02:06 +0000</resolved>
                                    <version>2.1.1</version>
                    <version>2.2.0</version>
                                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>2.3.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16244263" author="srowen" created="Wed, 8 Nov 2017 16:28:19 +0000"  >&lt;p&gt;Not sure it&apos;s random, but, somehow the value is being construed as -1 before being doubled. It&apos;s odd because &lt;tt&gt;s.as&lt;span class=&quot;error&quot;&gt;&amp;#91;Long&amp;#93;&lt;/span&gt;.show(false)&lt;/tt&gt; is fine. Try &lt;tt&gt;s.as&lt;span class=&quot;error&quot;&gt;&amp;#91;Long&amp;#93;&lt;/span&gt;.map(_.toString).show(false)&lt;/tt&gt; to see it more directly.&lt;/p&gt;

&lt;p&gt;I admit I don&apos;t know much about the internals; is someone more informed able to weigh in on why null would become -1 here?&lt;/p&gt;

&lt;p&gt;I think part of the issue is that you&apos;re converting null to a primitive long, but would expect 0 if anything, or an exception.&lt;/p&gt;</comment>
                            <comment id="16244273" author="kuzemchik" created="Wed, 8 Nov 2017 16:37:38 +0000"  >&lt;p&gt;My assumption is that it is because it goes into Tungsten to do multiplication on Dataset, and probably tries to get value of null pointer.&lt;/p&gt;

&lt;p&gt;I would expect 0 or exception too.&lt;/p&gt;</comment>
                            <comment id="16244310" author="mgaido" created="Wed, 8 Nov 2017 16:56:47 +0000"  >&lt;p&gt;Two things:&lt;br/&gt;
 1 - if you use &lt;tt&gt;as[Option[Long]]&lt;/tt&gt;, it works fine;&lt;br/&gt;
 2 - actually if you collect the Dataset, the value for &lt;tt&gt;null&lt;/tt&gt; is &lt;tt&gt;0&lt;/tt&gt;, but with the transformation, there is this bad result.&lt;/p&gt;

&lt;p&gt;Then I am not sure about the right approach here. Because maybe the best thing would be to force using &lt;tt&gt;Option[Long]&lt;/tt&gt; when the value is &lt;tt&gt;nullable&lt;/tt&gt;, but this might be too restrictive and may break compatibility.&lt;/p&gt;</comment>
                            <comment id="16244319" author="kuzemchik" created="Wed, 8 Nov 2017 17:05:00 +0000"  >&lt;p&gt;I&apos;m using Option&lt;span class=&quot;error&quot;&gt;&amp;#91;Long&amp;#93;&lt;/span&gt; as a workaround, but it is kinda scary to leave things as is and hope that you gonna catch it on review when anyone else is using datasets.&lt;/p&gt;

&lt;p&gt;I think spark should warn(or even error with some config parameter set) when you converting nullable DataFrame column into non-optional type.&lt;/p&gt;

&lt;p&gt;Currently if you do that with non-primitive type, you most likely gonna net NPE, and will have to handle this use case anyway.&lt;/p&gt;


&lt;p&gt;In my opinion current implicit behavior cause much more harm. We talking about bad results without any notification.&lt;/p&gt;</comment>
                            <comment id="16244327" author="kiszk" created="Wed, 8 Nov 2017 17:10:17 +0000"  >&lt;p&gt;Thank you for reporting this behavior.&lt;/p&gt;

&lt;p&gt;When I checked the generated code and source code, it is currently-expected behavior. In other words, if an Option object is &lt;tt&gt;null&lt;/tt&gt; or an Option value is &lt;tt&gt;empty&lt;/tt&gt;, &lt;tt&gt;-1&lt;/tt&gt; is passed to a lambda function. I will check why &lt;tt&gt;-1&lt;/tt&gt; was used as a value for these cases.&lt;/p&gt;</comment>
                            <comment id="16244438" author="kiszk" created="Wed, 8 Nov 2017 17:59:10 +0000"  >&lt;p&gt;From &lt;a href=&quot;https://github.com/apache/spark/commit/9e66a53c9955285a85c19f55c3ef62db2e1b868a#diff-94a1f59bcc9b6758c4ca874652437634R227&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the initial version&lt;/a&gt; of this conversion (about two years ago), this conversion returns &lt;tt&gt;-1&lt;/tt&gt;...&lt;/p&gt;</comment>
                            <comment id="16244466" author="srowen" created="Wed, 8 Nov 2017 18:19:25 +0000"  >&lt;p&gt;This doesn&apos;t look right ...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/spark/blob/master/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/expressions/codegen/CodeGenerator.scala#L596&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/expressions/codegen/CodeGenerator.scala#L596&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  def defaultValue(jt: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;): &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; = jt match {
    &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; JAVA_BOOLEAN =&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; JAVA_BYTE =&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;(&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;)-1&quot;&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; JAVA_SHORT =&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;(&lt;span class=&quot;code-object&quot;&gt;short&lt;/span&gt;)-1&quot;&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; JAVA_INT =&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;-1&quot;&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; JAVA_LONG =&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;-1L&quot;&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; JAVA_FLOAT =&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;-1.0f&quot;&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; JAVA_DOUBLE =&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;-1.0&quot;&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; _ =&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt;
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The default for any uninitialized primitive type is 0 in the JVM.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; I think you were the last to touch this, but didn&apos;t write it. Is this really -1 on purpose for another reason?&lt;/p&gt;</comment>
                            <comment id="16245676" author="apachespark" created="Thu, 9 Nov 2017 13:52:04 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19707&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19707&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16270178" author="felixcheung" created="Wed, 29 Nov 2017 05:33:45 +0000"  >&lt;p&gt;This is going out in 2.2.1 - do we need a rel note on this change?&lt;/p&gt;</comment>
                            <comment id="16270259" author="cloud_fan" created="Wed, 29 Nov 2017 06:47:24 +0000"  >&lt;p&gt;yea I think we should, this may turn a runnable query(with an unreasonable result) to a failed query.&lt;/p&gt;</comment>
                            <comment id="16274042" author="felixcheung" created="Fri, 1 Dec 2017 07:07:15 +0000"  >&lt;p&gt;I guess it&apos;s too late to add to &lt;a href=&quot;http://spark.apache.org/docs/latest/sql-programming-guide.html#migration-guide&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://spark.apache.org/docs/latest/sql-programming-guide.html#migration-guide&lt;/a&gt; (and we don&apos;t seem to document this in patch release there anyway)&lt;/p&gt;

&lt;p&gt;I guess I&apos;ll just add this to the website on the actual release announcement like&lt;br/&gt;
&lt;a href=&quot;http://spark.apache.org/releases/spark-release-2-1-2.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://spark.apache.org/releases/spark-release-2-1-2.html&lt;/a&gt;&lt;br/&gt;
or &lt;br/&gt;
&lt;a href=&quot;http://spark.apache.org/releases/spark-release-2-1-0.html#known-issues&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://spark.apache.org/releases/spark-release-2-1-0.html#known-issues&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;sounds good?&lt;/p&gt;</comment>
                            <comment id="16274058" author="cloud_fan" created="Fri, 1 Dec 2017 07:22:17 +0000"  >&lt;p&gt;sounds good, thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 50 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3mjr3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12340470">2.2.1</customfieldvalue>
    <customfieldvalue id="12339551">2.3.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>