<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:09:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-30511] Spark marks intentionally killed speculative tasks as pending leads to holding idle executors</title>
                <link>https://issues.apache.org/jira/browse/SPARK-30511</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;&lt;b&gt;TL;DR&lt;/b&gt;&lt;br/&gt;
 When speculative tasks fail/get killed, they are still considered as pending and count towards the calculation of number of needed executors.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;Symptom&quot;&gt;&lt;/a&gt;Symptom&lt;/h3&gt;

&lt;p&gt;In one of our production job (where it&apos;s running 4 tasks per executor), we found that it was holding 6 executors at the end with only 2 tasks running (1 speculative). With more logging enabled, we found the job printed:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
pendingTasks is 0 pendingSpeculativeTasks is 17 totalRunningTasks is 2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;while the job only had 1 speculative task running and 16 speculative tasks intentionally killed because of corresponding original tasks had finished.&lt;/p&gt;

&lt;p&gt;An easy repro of the issue (`--conf spark.speculation=true --conf spark.executor.cores=4 --conf spark.dynamicAllocation.maxExecutors=1000` in cluster mode):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val n = 4000
val someRDD = sc.parallelize(1 to n, n)
someRDD.mapPartitionsWithIndex( (index: Int, it: Iterator[Int]) =&amp;gt; {
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (index &amp;lt; 300 &amp;amp;&amp;amp; index &amp;gt;= 150) {
    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(index * 1000) &lt;span class=&quot;code-comment&quot;&gt;// Fake running tasks
&lt;/span&gt;} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (index == 300) {
    &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1000 * 1000) &lt;span class=&quot;code-comment&quot;&gt;// Fake &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; running tasks
&lt;/span&gt;}
it.toList.map(x =&amp;gt; index + &lt;span class=&quot;code-quote&quot;&gt;&quot;, &quot;&lt;/span&gt; + x).iterator
}).collect
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;You will see when running the last task, we would be hold 38 executors (see attachment), which is exactly (152 + 3) / 4 = 38.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;TheBug&quot;&gt;&lt;/a&gt;The Bug&lt;/h3&gt;

&lt;p&gt;Upon examining the code of&#160;&lt;em&gt;pendingSpeculativeTasks&lt;/em&gt;:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
stageAttemptToNumSpeculativeTasks.map { &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; (stageAttempt, numTasks) =&amp;gt;
  numTasks - stageAttemptToSpeculativeTaskIndices.get(stageAttempt).map(_.size).getOrElse(0)
}.sum
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;where&#160;&lt;em&gt;stageAttemptToNumSpeculativeTasks(stageAttempt)&lt;/em&gt; is incremented on&#160;&lt;em&gt;onSpeculativeTaskSubmitted&lt;/em&gt;, but never decremented.&#160; &lt;em&gt;stageAttemptToNumSpeculativeTasks -= stageAttempt&lt;/em&gt;&#160;is performed on stage completion.&#160;&lt;b&gt;This means Spark is marking ended speculative tasks as pending, which leads to Spark to hold more executors that it actually needs!&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;I will have a PR ready to fix this issue, along with &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-28403&quot; title=&quot;Executor Allocation Manager can add an extra executor when speculative tasks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-28403&quot;&gt;&lt;del&gt;SPARK-28403&lt;/del&gt;&lt;/a&gt;&#160;too&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13279428">SPARK-30511</key>
            <summary>Spark marks intentionally killed speculative tasks as pending leads to holding idle executors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zebingl">Zebing Lin</assignee>
                                    <reporter username="zebingl">Zebing Lin</reporter>
                        <labels>
                    </labels>
                <created>Tue, 14 Jan 2020 19:32:10 +0000</created>
                <updated>Sun, 17 May 2020 17:48:18 +0000</updated>
                            <resolved>Fri, 31 Jan 2020 14:50:31 +0000</resolved>
                                    <version>2.3.0</version>
                                    <fixVersion>3.0.0</fixVersion>
                                    <component>Scheduler</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                    <issuelinks>
                            <issuelinktype id="12310361">
                    <name>Blocked</name>
                                            <outwardlinks description="Blocked">
                                        <issuelink>
            <issuekey id="13244980">SPARK-28403</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13220152">SPARK-27082</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12991024" name="Screen Shot 2020-01-15 at 11.13.17.png" size="132860" author="zebingl" created="Wed, 15 Jan 2020 19:14:18 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 43 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0aiaw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>