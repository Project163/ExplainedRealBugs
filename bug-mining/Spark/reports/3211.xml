<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 02:12:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92">
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-13642] Properly handle signal kill of ApplicationMaster</title>
                <link>https://issues.apache.org/jira/browse/SPARK-13642</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Currently when running Spark on Yarn with yarn cluster mode, the default application final state is "SUCCEED", if any exception is occurred, this final state will be changed to "FAILED" and trigger the reattempt if possible. &lt;/p&gt;

&lt;p&gt;This is OK in normal case, but if there's a race condition when AM received a signal (SIGTERM) and no any exception is occurred. In this situation, shutdown hook will be invoked and marked this application as finished with success, and there's no another attempt.&lt;/p&gt;

&lt;p&gt;In such situation, actually from Spark's aspect this application is failed and need another attempt, but from Yarn's aspect the application is finished with success.&lt;/p&gt;

&lt;p&gt;This could happened in NM failure situation, the failure of NM will send SIGTERM to AM, AM should mark this attempt as failure and rerun again, not invoke unregister.&lt;/p&gt;

&lt;p&gt;So to increase the chance of this race condition, here is the reproduced code:&lt;/p&gt;

&lt;div class="code panel" style="border-width: 1px;"&gt;&lt;div class="codeContent panelContent"&gt;
&lt;pre class="code-java"&gt;val sc = ...
&lt;span class="code-object"&gt;Thread&lt;/span&gt;.sleep(30000L)
sc.parallelize(1 to 100).collect()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If the AM is failed in sleeping, there's no exception been thrown, so from Yarn's point this application is finished successfully, but from Spark's point, this application should be reattempted.&lt;/p&gt;

&lt;p&gt;The log normally like this:&lt;/p&gt;

&lt;div class="preformatted panel" style="border-width: 1px;"&gt;&lt;div class="preformattedContent panelContent"&gt;
&lt;pre&gt;16/03/03 12:44:19 INFO ContainerManagementProtocolProxy: Opening proxy : 192.168.0.105:45454
16/03/03 12:44:21 INFO YarnClusterSchedulerBackend: Registered executor NettyRpcEndpointRef(null) (192.168.0.105:57461) with ID 2
16/03/03 12:44:21 INFO BlockManagerMasterEndpoint: Registering block manager 192.168.0.105:57462 with 511.1 MB RAM, BlockManagerId(2, 192.168.0.105, 57462)
16/03/03 12:44:23 INFO YarnClusterSchedulerBackend: Registered executor NettyRpcEndpointRef(null) (192.168.0.105:57467) with ID 1
16/03/03 12:44:23 INFO BlockManagerMasterEndpoint: Registering block manager 192.168.0.105:57468 with 511.1 MB RAM, BlockManagerId(1, 192.168.0.105, 57468)
16/03/03 12:44:23 INFO YarnClusterSchedulerBackend: SchedulerBackend is ready for scheduling beginning after reached minRegisteredResourcesRatio: 0.8
16/03/03 12:44:23 INFO YarnClusterScheduler: YarnClusterScheduler.postStartHook done
16/03/03 12:44:39 ERROR ApplicationMaster: RECEIVED SIGNAL 15: SIGTERM
16/03/03 12:44:39 INFO SparkContext: Invoking stop() from shutdown hook
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/metrics/json,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/stages/stage/kill,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/api,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/static,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/executors/threadDump/json,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/executors/threadDump,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/executors/json,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/executors,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/environment/json,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/environment,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/storage/rdd/json,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/storage/rdd,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/storage/json,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/storage,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/stages/pool/json,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/stages/pool,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/stages/stage/json,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/stages/stage,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/stages/json,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/stages,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/jobs/job/json,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/jobs/job,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/jobs/json,null}
16/03/03 12:44:39 INFO ContextHandler: stopped o.e.j.s.ServletContextHandler{/jobs,null}
16/03/03 12:44:39 INFO SparkUI: Stopped Spark web UI at http://192.168.0.105:57452
16/03/03 12:44:39 INFO YarnAllocator: Driver requested a total number of 0 executor(s).
16/03/03 12:44:39 INFO YarnAllocator: Canceling requests for 0 executor containers
16/03/03 12:44:39 INFO YarnClusterSchedulerBackend: Shutting down all executors
16/03/03 12:44:39 WARN YarnAllocator: Expected to find pending requests, but found none.
16/03/03 12:44:39 INFO YarnClusterSchedulerBackend: Asking each executor to shut down
16/03/03 12:44:39 INFO SchedulerExtensionServices: Stopping SchedulerExtensionServices
(serviceOption=None,
 services=List(),
 started=false)
16/03/03 12:44:39 INFO MapOutputTrackerMasterEndpoint: MapOutputTrackerMasterEndpoint stopped!
16/03/03 12:44:39 INFO MemoryStore: MemoryStore cleared
16/03/03 12:44:39 INFO BlockManager: BlockManager stopped
16/03/03 12:44:39 INFO BlockManagerMaster: BlockManagerMaster stopped
16/03/03 12:44:39 INFO OutputCommitCoordinator$OutputCommitCoordinatorEndpoint: OutputCommitCoordinator stopped!
16/03/03 12:44:39 INFO SparkContext: Successfully stopped SparkContext
16/03/03 12:44:39 INFO ApplicationMaster: Final app status: SUCCEEDED, exitCode: 0, (reason: Shutdown hook called before final status was reported.)
16/03/03 12:44:39 INFO ApplicationMaster: Unregistering ApplicationMaster with SUCCEEDED (diag message: Shutdown hook called before final status was reported.)
16/03/03 12:44:39 INFO AMRMClientImpl: Waiting for application to be successfully unregistered.
16/03/03 12:44:39 INFO ApplicationMaster: Deleting staging directory .sparkStaging/application_1456975940304_0004
16/03/03 12:44:40 INFO ShutdownHookManager: Shutdown hook called
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So basically, I think only after the finish of user class, we could mark this application as "SUCCESS", otherwise, especially in the signal stopped scenario, it would be better to mark as failed and try again (except explicitly KILL command by yarn).&lt;/p&gt;</description>
                <environment/>
        <key id="12946415">SPARK-13642</key>
            <summary>Properly handle signal kill of ApplicationMaster</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jerryshao">Saisai Shao</assignee>
                                    <reporter username="jerryshao">Saisai Shao</reporter>
                        <labels>
                    </labels>
                <created>Thu, 3 Mar 2016 06:38:36 +0000</created>
                <updated>Sun, 17 May 2020 18:16:50 +0000</updated>
                            <resolved>Tue, 15 Mar 2016 17:21:13 +0000</resolved>
                                    <version>1.6.0</version>
                                    <fixVersion>1.6.2</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>Spark Core</component>
                    <component>YARN</component>
                        <due/>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15177347" author="jerryshao" created="Thu, 3 Mar 2016 06:44:45 +0000">&lt;p&gt;&lt;a href="https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tgraves" class="user-hover" rel="tgraves"&gt;tgraves&lt;/a&gt; &lt;a href="https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vanzin" class="user-hover" rel="vanzin"&gt;vanzin&lt;/a&gt;, would you please comment on this, why the default application final state is "SUCCESS"? Is it better to mark this application as "SUCCESS" only after user class is exited? Thanks a lot.&lt;/p&gt;</comment>
                            <comment id="15177905" author="tgraves" created="Thu, 3 Mar 2016 14:53:07 +0000">&lt;p&gt;The problem is that you really don't want the opposite to happen... ie a success attempt to be marked as failed because then it will be retried and you could mess up good data.&lt;/p&gt;

&lt;p&gt;          // We report success to avoid&lt;br/&gt;
          // retrying applications that have succeeded (System.exit(0)), which means that&lt;br/&gt;
          // applications that explicitly exit with a non-zero status will also show up as&lt;br/&gt;
          // succeeded in the RM UI.&lt;/p&gt;

&lt;p&gt;In your above case stop() was called on the SparkContext and we assume stop means the application ran til finish thus was successful from YARNs point of view.&lt;/p&gt;

&lt;p&gt;I think we would need a better way for the YARN side to really know what happened on the driver side.&lt;/p&gt;</comment>
                            <comment id="15179102" author="jerryshao" created="Fri, 4 Mar 2016 01:23:13 +0000">&lt;p&gt;Hi &lt;a href="https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tgraves" class="user-hover" rel="tgraves"&gt;tgraves&lt;/a&gt;, thanks a lot for your comments. I think here &lt;tt&gt;stop()&lt;/tt&gt; is not called explicitly by the user's code when app is finished, this is triggered in shutdown hook when receiving a signal.&lt;/p&gt;

&lt;p&gt;If the AM is terminated by signal, except deliberately killing, the application is actually in the middle of runtime, so does it make sense to mark it as successful? In this specific case, we expect another attempt but yarn fails to do it. Personally I think we should handle this situation properly.&lt;/p&gt;
</comment>
                            <comment id="15179400" author="apachespark" created="Fri, 4 Mar 2016 06:09:05 +0000">&lt;p&gt;User 'jerryshao' has created a pull request for this issue:&lt;br/&gt;
&lt;a href="https://github.com/apache/spark/pull/11512" class="external-link" target="_blank" rel="nofollow noopener"&gt;https://github.com/apache/spark/pull/11512&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15192828" author="apachespark" created="Mon, 14 Mar 2016 06:58:03 +0000">&lt;p&gt;User 'jerryshao' has created a pull request for this issue:&lt;br/&gt;
&lt;a href="https://github.com/apache/spark/pull/11690" class="external-link" target="_blank" rel="nofollow noopener"&gt;https://github.com/apache/spark/pull/11690&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15192928" author="apachespark" created="Mon, 14 Mar 2016 08:53:04 +0000">&lt;p&gt;User 'jerryshao' has created a pull request for this issue:&lt;br/&gt;
&lt;a href="https://github.com/apache/spark/pull/11693" class="external-link" target="_blank" rel="nofollow noopener"&gt;https://github.com/apache/spark/pull/11693&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 36 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2u2qv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>