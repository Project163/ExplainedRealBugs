<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:15:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-2523] For partitioned Hive tables, partition-specific ObjectInspectors should be used.</title>
                <link>https://issues.apache.org/jira/browse/SPARK-2523</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;In HiveTableScan.scala, ObjectInspector was created for all of the partition based records, which probably causes ClassCastException if the object inspector is not identical among table &amp;amp; partitions.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12727612">SPARK-2523</key>
            <summary>For partitioned Hive tables, partition-specific ObjectInspectors should be used.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chenghao">Cheng Hao</assignee>
                                    <reporter username="chenghao">Cheng Hao</reporter>
                        <labels>
                    </labels>
                <created>Wed, 16 Jul 2014 08:37:02 +0000</created>
                <updated>Wed, 30 Jul 2014 20:10:59 +0000</updated>
                            <resolved>Mon, 28 Jul 2014 18:29:02 +0000</resolved>
                                                    <fixVersion>1.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14063288" author="chenghao" created="Wed, 16 Jul 2014 08:39:09 +0000"  >&lt;p&gt;This is the follow up for &lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/1408&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/1408&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/1390&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/1390&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The PR is &lt;a href=&quot;https://github.com/apache/spark/pull/1439&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/1439&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14063289" author="chenghao" created="Wed, 16 Jul 2014 08:43:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yhuai&quot; class=&quot;user-hover&quot; rel=&quot;yhuai&quot;&gt;yhuai&lt;/a&gt; Can you review the code for me?&lt;/p&gt;</comment>
                            <comment id="14063753" author="yhuai" created="Wed, 16 Jul 2014 17:23:52 +0000"  >&lt;p&gt;Yeah, no problem. Can you add a case which can trigger the bug in the description?&lt;/p&gt;</comment>
                            <comment id="14064570" author="chenghao" created="Thu, 17 Jul 2014 04:41:58 +0000"  >&lt;p&gt;sbt/sbt hive/console&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;prepare.scala&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;hql(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE add_part_test (key STRING, value STRING) PARTITIONED BY (ds STRING) ROW FORMAT SERDE &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.hadoop.hive.serde2.columnar.LazyBinaryColumnarSerDe&apos;&lt;/span&gt; STORED AS RCFILE&quot;&lt;/span&gt;).collect
hql(&lt;span class=&quot;code-quote&quot;&gt;&quot;from src insert into table add_part_test PARTITION (ds=&lt;span class=&quot;code-quote&quot;&gt;&apos;2010-01-01&apos;&lt;/span&gt;) select 100,100 limit 1&quot;&lt;/span&gt;).collect
hql(&lt;span class=&quot;code-quote&quot;&gt;&quot;ALTER TABLE add_part_test set SERDE &apos;org.apache.hadoop.hive.serde2.columnar.ColumnarSerDe&quot;&lt;/span&gt;).collect
hql(&lt;span class=&quot;code-quote&quot;&gt;&quot;from src insert into table add_part_test PARTITION (ds=&lt;span class=&quot;code-quote&quot;&gt;&apos;2010-01-02&apos;&lt;/span&gt;) select 200,200 limit 1&quot;&lt;/span&gt;).collect
hql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select * from add_part_test&quot;&lt;/span&gt;).collect.mkString(&lt;span class=&quot;code-quote&quot;&gt;&quot;\n&quot;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Output (Without this PR)&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;14/07/17 12:12:02 WARN scheduler.TaskSetManager: Loss was due to java.lang.ClassCastException&lt;br/&gt;
java.lang.ClassCastException: org.apache.hadoop.io.Text cannot be cast to org.apache.hadoop.hive.serde2.lazy.LazyString&lt;br/&gt;
	at org.apache.hadoop.hive.serde2.lazy.objectinspector.primitive.LazyStringObjectInspector.getPrimitiveJavaObject(LazyStringObjectInspector.java:52)&lt;br/&gt;
	at org.apache.hadoop.hive.serde2.lazy.objectinspector.primitive.LazyStringObjectInspector.getPrimitiveJavaObject(LazyStringObjectInspector.java:28)&lt;br/&gt;
	at org.apache.spark.sql.hive.HiveInspectors$class.unwrapData(hiveUdfs.scala:287)&lt;br/&gt;
	at org.apache.spark.sql.hive.execution.HiveTableScan.unwrapData(HiveTableScan.scala:48)&lt;br/&gt;
	at org.apache.spark.sql.hive.execution.HiveTableScan$$anonfun$attributeFunctions$1$$anonfun$apply$3.apply(HiveTableScan.scala:101)&lt;br/&gt;
	at org.apache.spark.sql.hive.execution.HiveTableScan$$anonfun$attributeFunctions$1$$anonfun$apply$3.apply(HiveTableScan.scala:99)&lt;br/&gt;
	at org.apache.spark.sql.hive.execution.HiveTableScan$$anonfun$12$$anonfun$apply$5.apply(HiveTableScan.scala:203)&lt;br/&gt;
	at org.apache.spark.sql.hive.execution.HiveTableScan$$anonfun$12$$anonfun$apply$5.apply(HiveTableScan.scala:200)&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And &lt;/p&gt;
&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Output (With this PR)&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;100,100,2010-01-01&amp;#93;&lt;/span&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;200,200,2010-01-02&amp;#93;&lt;/span&gt;&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;analysis.sql&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;hql(&lt;span class=&quot;code-quote&quot;&gt;&quot;DESCRIBE EXTENDED add_part_test partition (ds=&lt;span class=&quot;code-quote&quot;&gt;&apos;2010-01-01&apos;&lt;/span&gt;)&quot;&lt;/span&gt;).collect.mkString(&lt;span class=&quot;code-quote&quot;&gt;&quot;\n&quot;&lt;/span&gt;)
hql(&lt;span class=&quot;code-quote&quot;&gt;&quot;DESCRIBE EXTENDED add_part_test partition (ds=&lt;span class=&quot;code-quote&quot;&gt;&apos;2010-01-02&apos;&lt;/span&gt;)&quot;&lt;/span&gt;).collect.mkString(&lt;span class=&quot;code-quote&quot;&gt;&quot;\n&quot;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;You probably will see the different output like:&lt;/p&gt;

&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Output&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;Detailed Partition Information	Partition(values: 2010-01-01, ... serdeInfo:SerDeInfo(name:null, serializationLib:org.apache.hadoop.hive.serde2.columnar.LazyBinaryColumnarSerDe...)	&lt;br/&gt;
Detailed Partition Information	Partition(values: 2010-01-02, ... serdeInfo:SerDeInfo(name:null, serializationLib:org.apache.hadoop.hive.serde2.columnar.ColumnarSerDe...)	&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14064576" author="chenghao" created="Thu, 17 Jul 2014 04:57:30 +0000"  >&lt;p&gt;I think the root cause is the when ALTER table with different SERDE, it will not affect the existed partitions, but table and all subsequent partitions will inherit from it, so we got different SerDEs for different Partitions when new partitions added afterward. &lt;/p&gt;

&lt;p&gt;The original implementation of HiveTableScan gets the ObjectInspectors from the TableDesc, which is not correct for the existed partitions in this case.&lt;/p&gt;

&lt;p&gt;This PR solve that by utilizing the partition desc for SerDe instantiation, and convert it into Catalyst MutableRow directly while scanning the partition, I think it&apos;s more straightforward as we don&apos;t need the ObjectInspector for the downstream operators. (In Shark we do have to make a uniform ObjectInspector for downstream operators, that&apos;s why we have to serialize the row and then deserialize it again in &lt;a href=&quot;https://github.com/apache/spark/pull/1390&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR1390&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="14065035" author="yhuai" created="Thu, 17 Jul 2014 15:37:49 +0000"  >&lt;p&gt;I see. Although we are using the right SerDe to deserialize a row, we are using the wrong ObjectInspector to extract fields (in attributeFunctions)... Also, creating Rows in TableReader makes sense. Will finish my review soon.&lt;/p&gt;</comment>
                            <comment id="14079881" author="apachespark" created="Wed, 30 Jul 2014 20:10:59 +0000"  >&lt;p&gt;User &apos;yhuai&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/1669&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/1669&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>405718</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 16 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1xtif:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>405740</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326686">1.1.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>