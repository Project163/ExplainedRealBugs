<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:04:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-26859] Fix field writer index bug in non-vectorized ORC deserializer</title>
                <link>https://issues.apache.org/jira/browse/SPARK-26859</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;There is a bug in the ORC deserialization code that, when triggered, results in completely wrong data being read. I&apos;ve marked this as a Blocker as per the docs in &lt;a href=&quot;https://spark.apache.org/contributing.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://spark.apache.org/contributing.html&lt;/a&gt; as it&apos;s a data correctness issue.&lt;/p&gt;

&lt;p&gt;The bug is triggered when the following set of conditions are all met:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the non-vectorized ORC reader is being used;&lt;/li&gt;
	&lt;li&gt;a schema is explicitly specified when reading the ORC file&lt;/li&gt;
	&lt;li&gt;the provided schema has columns not present in the ORC file, and these columns are in the middle of the schema&lt;/li&gt;
	&lt;li&gt;the ORC file being read contains null values in the columns after the ones added by the schema.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;When all of these are met:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the internal state of the ORC deserializer gets messed up, and, as a result&lt;/li&gt;
	&lt;li&gt;the null values from the ORC file end up being set on wrong columns, not the one they&apos;re in, and&lt;/li&gt;
	&lt;li&gt;the old values from the null columns don&apos;t get cleared from the previous record.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Here&apos;s a concrete example. Let&apos;s consider the following DataFrame:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; rdd = sparkContext.parallelize(Seq((1, 2, &lt;span class=&quot;code-quote&quot;&gt;&quot;abc&quot;&lt;/span&gt;), (4, 5, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt;&quot;&lt;/span&gt;), (8, 9, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)))
        &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; df = rdd.toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;col1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;col2&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;col3&quot;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and the following schema:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
col1 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, col4 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, col2 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, col3 string
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Notice the `col4 int` added in the middle that doesn&apos;t exist in the dataframe.&lt;/p&gt;

&lt;p&gt;Saving this dataframe to ORC and then reading it back with the specified schema should result in reading the same values, with nulls for `col4`. Instead, we get the following back:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[1,&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,2,abc]
[4,&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,5,def]
[8,&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;,def]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Notice how the `def` from the second record doesn&apos;t get properly cleared and ends up in the third record as well; also, instead of `col2 = 9` in the last record as expected, we get the null that should&apos;ve been in column 3 instead.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Impact&lt;/b&gt;&lt;br/&gt;
When this issue is triggered, it results in completely wrong results being read from the ORC file. The set of conditions under which it gets triggered is somewhat narrow so the set of affected users is probably limited. There are possibly also people that are affected but haven&apos;t realized it because the conditions are so obscure.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Bug details&lt;/b&gt;&lt;br/&gt;
The issue is caused by calling `setNullAt` with a wrong index in `OrcDeserializer.scala:deserialize()`. I have a fix that I&apos;ll send out for review shortly.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Workaround&lt;/b&gt;&lt;br/&gt;
This bug is currently only triggered when new columns are added to the middle of the schema. This means that it can be worked around by only adding new columns at the end.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13215208">SPARK-26859</key>
            <summary>Fix field writer index bug in non-vectorized ORC deserializer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ivan.vergiliev">Ivan Vergiliev</assignee>
                                    <reporter username="ivan.vergiliev">Ivan Vergiliev</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Tue, 12 Feb 2019 10:47:48 +0000</created>
                <updated>Thu, 8 Aug 2019 21:56:11 +0000</updated>
                            <resolved>Wed, 20 Feb 2019 14:05:25 +0000</resolved>
                                    <version>2.3.0</version>
                                    <fixVersion>2.3.4</fixVersion>
                    <fixVersion>2.4.1</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16766495" author="dongjoon" created="Tue, 12 Feb 2019 21:42:52 +0000"  >&lt;p&gt;Thank you for reporting, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ivan.vergiliev&quot; class=&quot;user-hover&quot; rel=&quot;ivan.vergiliev&quot;&gt;ivan.vergiliev&lt;/a&gt;. I understand this was marked as `Blocker` since it returns incorrect data, but it would be lower than that since this happens at user-given schema situation and non-vectorized path. Anyway, I&apos;ll review it tonight.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://spark.apache.org/contributing.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://spark.apache.org/contributing.html&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16773043" author="cloud_fan" created="Wed, 20 Feb 2019 14:05:25 +0000"  >&lt;p&gt;Issue resolved by pull request 23766&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/23766&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23766&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 38 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|yi0w48:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>