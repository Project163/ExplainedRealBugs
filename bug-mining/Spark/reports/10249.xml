<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:48:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-52772] Inconsistent table attribute handling during updates</title>
                <link>https://issues.apache.org/jira/browse/SPARK-52772</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;TableOutputResolver is inconsistent in copying the table column metadata to the query attributes.&#160; For example, it does not copy for struct fields but does copy for primitives or when casting is required.&#160; Additionally, even when the table metadata is copied to the query attributes, rewrites sometimes undo the desired metadata and leak source table metadata that gets confused for target metadata.&#160; Another problem with leaking source metadata is if the CHAR_VARCHAR_TYPE_STRING_METADATA_KEY is propagated, then the write operation will remain unresolved, or worse flip from resolved to unresolved.&lt;/p&gt;

&lt;p&gt;As one example, JacksonGenerator#writeFields depends on the query attribute metadata to detect if a target column has a default value.&#160; It uses this information to decide if a null is written explicitly or if the field is not written to the json at all.&lt;/p&gt;

&lt;p&gt;Passing this table information via the source query attributes is not the best design. Ideally we should change all the writers to pick up table configuration from the table directly. However, there are many third-party connectors that may rely on this behavior.&#160; So for now, we will simply make the query output attributes match the target column&apos;s names and metadata in all cases.&lt;/p&gt;

&lt;p&gt;Getting the compiler to honor our required metadata is harder than it should be.&#160; Many rewrites are careless with the effects they have on resulting metadata.&#160; This is especially true when the metadata is empty.&#160; We need to fix removeRedundantAlias and trimNonTopLevelAliases to preserve empty metadata instead of changing to inherited metadata.&#160; Project.doCanonicalize also needs to consider the effective metadata instead of the alias inheritance instructions.&lt;/p&gt;

&lt;p&gt;While attempting to fix this issue, many things were attempted to get only the target table column metadata to flow, but many subtle bugs were encountered or discovered.&#160; Examples of things that get the target column metadata to flow initially, but then rewrites undo it (in org.apache.spark.sql.catalyst.analysis.TableOutputResolver.applyColumnMetadata):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
expr match {
 &#160;&lt;span class=&quot;code-comment&quot;&gt;// This does not work because &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;
&lt;/span&gt;&#160; &lt;span class=&quot;code-comment&quot;&gt;// &#160;   expr = Alias(&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(attr, attr.dataType), attr.name)()
&lt;/span&gt;&#160; &lt;span class=&quot;code-comment&quot;&gt;// expr.metadata is empty, but after the no-op &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; is removed by a rewrite
&lt;/span&gt;&#160; &lt;span class=&quot;code-comment&quot;&gt;// &#160;   expr = Alias(attr, attr.name)()
&lt;/span&gt;&#160; &lt;span class=&quot;code-comment&quot;&gt;// Now expr.metadata propagates source metadata.
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// We don&apos;t want to rely on inherited metadata, so we only keep &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; pattern when the metadata is
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// not derived.
&lt;/span&gt;&#160; &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; expr: NamedExpression &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; expr.name == attr.name &amp;amp;&amp;amp; expr.metadata == requiredMetadata =&amp;gt;
    expr

  &lt;span class=&quot;code-comment&quot;&gt;// This doesn&apos;t should work because RemoveNoopOperators discards our requiredMetadata.
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// It&apos;s also risky to reuse the attribute with different state.
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// So we don&apos;t use &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; pattern.
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; a: Attribute =&amp;gt;
    a.withName(attr.name).withMetadata(requiredMetadata)

  &lt;span class=&quot;code-comment&quot;&gt;// This doesn&apos;t work because RemoveRedundantAliases discards the alias &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// derived alias.metadata is empty, even though attr.metadata is not empty.
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// This is a silly way to request empty metadata anyway; we use the direct way below instead.
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; attr: Attribute &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; requiredMetadata.isEmpty =&amp;gt; 
    Alias(attr, attr.name)(nonInheritableMetadataKeys = attr.metadata.keys)

  &lt;span class=&quot;code-comment&quot;&gt;// This doesn&apos;t work because CleanupAliases discards explicitMetadata=Some(empty)
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// We fixed the rewrites to make &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; work.
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; expr =&amp;gt;
    Alias(expr, attr.name)(explicitMetadata = Some(requiredMetadata)) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13623190">SPARK-52772</key>
            <summary>Inconsistent table attribute handling during updates</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kbeyer">Kevin Beyer</assignee>
                                    <reporter username="kbeyer">Kevin Beyer</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 11 Jul 2025 18:32:03 +0000</created>
                <updated>Thu, 14 Aug 2025 17:06:21 +0000</updated>
                            <resolved>Fri, 1 Aug 2025 11:50:47 +0000</resolved>
                                    <version>4.1.0</version>
                                    <fixVersion>4.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="18011416" author="cloud_fan" created="Fri, 1 Aug 2025 11:50:47 +0000"  >&lt;p&gt;Issue resolved by pull request 51466&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/51466&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/51466&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="13568224">SPARK-47029</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1wpzk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>