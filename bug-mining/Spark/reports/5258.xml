<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:56:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-22328] ClosureCleaner misses referenced superclass fields, gives them null values</title>
                <link>https://issues.apache.org/jira/browse/SPARK-22328</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://github.com/ryan-williams/spark-bugs/tree/closure&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Runnable repro here&lt;/a&gt;:&lt;/p&gt;

&lt;p&gt;Superclass with some fields:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;App &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Serializable {
  &lt;span class=&quot;code-comment&quot;&gt;// SparkContext stub
&lt;/span&gt;  @&lt;span class=&quot;code-keyword&quot;&gt;transient&lt;/span&gt; lazy val sc = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SparkContext(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SparkConf().setAppName(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;).setMaster(&lt;span class=&quot;code-quote&quot;&gt;&quot;local[4]&quot;&lt;/span&gt;).set(&lt;span class=&quot;code-quote&quot;&gt;&quot;spark.ui.showConsoleProgress&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;))

  &lt;span class=&quot;code-comment&quot;&gt;// These fields get missed by the ClosureCleaner in some situations
&lt;/span&gt;  val n1 = 111
  val s1 = &lt;span class=&quot;code-quote&quot;&gt;&quot;aaa&quot;&lt;/span&gt;

  &lt;span class=&quot;code-comment&quot;&gt;// Simple scaffolding to exercise passing a closure to RDD.foreach in subclasses
&lt;/span&gt;  def rdd = sc.parallelize(1 to 1)
  def run(name: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;): Unit = {
    print(s&lt;span class=&quot;code-quote&quot;&gt;&quot;$name:\t&quot;&lt;/span&gt;)
    body()
    sc.stop()
  }
  def body(): Unit
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Running a simple Spark job with various instantiations of this class:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
object Main {
  &lt;span class=&quot;code-comment&quot;&gt;/** [[App]]s generated &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; way will not correctly detect references to [[App.n1]] in Spark closures */&lt;/span&gt;
  val fn = () &#8658; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; App {
    val n2 = 222
    val s2 = &lt;span class=&quot;code-quote&quot;&gt;&quot;bbb&quot;&lt;/span&gt;
    def body(): Unit = rdd.foreach { _ &#8658; println(s&lt;span class=&quot;code-quote&quot;&gt;&quot;$n1, $n2, $s1, $s2&quot;&lt;/span&gt;) }
  }

  &lt;span class=&quot;code-comment&quot;&gt;/** Doesn&apos;t serialize closures correctly */&lt;/span&gt;
  val app1 = fn()

  &lt;span class=&quot;code-comment&quot;&gt;/** Works fine */&lt;/span&gt;
  val app2 =
    &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; App {
      val n2 = 222
      val s2 = &lt;span class=&quot;code-quote&quot;&gt;&quot;bbb&quot;&lt;/span&gt;
      def body(): Unit = rdd.foreach { _ &#8658; println(s&lt;span class=&quot;code-quote&quot;&gt;&quot;$n1, $n2, $s1, $s2&quot;&lt;/span&gt;) }
    }

  &lt;span class=&quot;code-comment&quot;&gt;/** [[App]]s created &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; way also work fine */&lt;/span&gt;
  def makeApp(): App =
    &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; App {
      val n2 = 222
      val s2 = &lt;span class=&quot;code-quote&quot;&gt;&quot;bbb&quot;&lt;/span&gt;
      def body(): Unit = rdd.foreach { _ &#8658; println(s&lt;span class=&quot;code-quote&quot;&gt;&quot;$n1, $n2, $s1, $s2&quot;&lt;/span&gt;) }
    }

  val app3 = makeApp()  &lt;span class=&quot;code-comment&quot;&gt;// ok
&lt;/span&gt;
  val fn2 = () &#8658; makeApp()  &lt;span class=&quot;code-comment&quot;&gt;// ok
&lt;/span&gt;
  def main(args: Array[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;]): Unit = {
    fn().run(&lt;span class=&quot;code-quote&quot;&gt;&quot;fn&quot;&lt;/span&gt;)    &lt;span class=&quot;code-comment&quot;&gt;// bad: n1 &#8594; 0, s1 &#8594; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/span&gt;    app1.run(&lt;span class=&quot;code-quote&quot;&gt;&quot;app1&quot;&lt;/span&gt;)  &lt;span class=&quot;code-comment&quot;&gt;// bad: n1 &#8594; 0, s1 &#8594; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/span&gt;    app2.run(&lt;span class=&quot;code-quote&quot;&gt;&quot;app2&quot;&lt;/span&gt;)  &lt;span class=&quot;code-comment&quot;&gt;// ok
&lt;/span&gt;    app3.run(&lt;span class=&quot;code-quote&quot;&gt;&quot;app3&quot;&lt;/span&gt;)  &lt;span class=&quot;code-comment&quot;&gt;// ok
&lt;/span&gt;    fn2().run(&lt;span class=&quot;code-quote&quot;&gt;&quot;fn2&quot;&lt;/span&gt;)  &lt;span class=&quot;code-comment&quot;&gt;// ok
&lt;/span&gt;  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Build + Run:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ sbt run
&#8230;
fn:	0, 222, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, bbb
app1:	0, 222, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, bbb
app2:	111, 222, aaa, bbb
app3:	111, 222, aaa, bbb
fn2:	111, 222, aaa, bbb
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The first two versions have &lt;tt&gt;0&lt;/tt&gt; and &lt;tt&gt;null&lt;/tt&gt;, resp., for the &lt;tt&gt;A.n1&lt;/tt&gt; and &lt;tt&gt;A.s1&lt;/tt&gt; fields.&lt;/p&gt;

&lt;p&gt;Something about this syntax causes the problem:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
() =&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; App { &#8230; }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13111177">SPARK-22328</key>
            <summary>ClosureCleaner misses referenced superclass fields, gives them null values</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="viirya">L. C. Hsieh</assignee>
                                    <reporter username="rdub">Ryan Williams</reporter>
                        <labels>
                    </labels>
                <created>Sat, 21 Oct 2017 17:04:04 +0000</created>
                <updated>Thu, 6 Sep 2018 09:43:20 +0000</updated>
                            <resolved>Thu, 26 Oct 2017 20:45:17 +0000</resolved>
                                    <version>2.2.0</version>
                                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>2.3.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16214755" author="apachespark" created="Mon, 23 Oct 2017 07:15:04 +0000"  >&lt;p&gt;User &apos;viirya&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19556&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19556&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16221216" author="cloud_fan" created="Thu, 26 Oct 2017 20:45:17 +0000"  >&lt;p&gt;Issue resolved by pull request 19556&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19556&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19556&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 3 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ljuv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>