<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:46:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-16550] Caching data with replication doesn&apos;t replicate data</title>
                <link>https://issues.apache.org/jira/browse/SPARK-16550</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Caching multiple replicas of blocks is currently broken. The following examples show replication doesn&apos;t happen for various use-cases:&lt;/p&gt;

&lt;p&gt;These were run using Spark 2.0.0-preview, in local-cluster&lt;span class=&quot;error&quot;&gt;&amp;#91;2,1,1024&amp;#93;&lt;/span&gt; mode&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;case class TestInteger(i: Int)
val data = sc.parallelize((1 to 1000).map(TestInteger(_)), 10).persist(MEMORY_ONLY_2)
data.count
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;sc.getExecutorStorageStatus.map(s =&amp;gt; s.rddBlocksById(data.id).size).sum shows only 10 blocks as opposed to the expected 20&lt;br/&gt;
Block replication fails on the executors with a java.lang.RuntimeException: java.lang.ClassNotFoundException: $line14.$read$$iw$$iw$TestInteger&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;val data1 = sc.parallelize(1 to 1000, 10).persist(org.apache.spark.storage.StorageLevel.MEMORY_ONLY_2)
data1.count

Block replication again fails with the following errors:
16/07/14 14:50:40 ERROR TransportRequestHandler: Error while invoking RpcHandler#receive() on RPC id 8567643992794608648
com.esotericsoftware.kryo.KryoException: Encountered unregistered class ID: 13994
	at com.esotericsoftware.kryo.util.DefaultClassResolver.readClass(DefaultClassResolver.java:137)
	at com.esotericsoftware.kryo.Kryo.readClass(Kryo.java:670)
	at com.esotericsoftware.kryo.Kryo.readClassAndObject(Kryo.java:781)
	at org.apache.spark.serializer.KryoDeserializationStream.readObject(KryoSerializer.scala:229)
	at org.apache.spark.serializer.DeserializationStream$$anon$1.getNext(Serializer.scala:169)
	at org.apache.spark.util.NextIterator.hasNext(NextIterator.scala:73)
	at org.apache.spark.storage.memory.MemoryStore.putIteratorAsValues(MemoryStore.scala:213)
	at org.apache.spark.storage.BlockManager$$anonfun$doPutBytes$1.apply(BlockManager.scala:775)
	at org.apache.spark.storage.BlockManager$$anonfun$doPutBytes$1.apply(BlockManager.scala:753)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;sc.getExecutorStorageStatus.map(s =&amp;gt; s.rddBlocksById(data1.id).size).sum again shows 10 blocks&lt;/p&gt;

&lt;p&gt;Caching serialized data works for native types, but not for custom classes&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;val data3 = sc.parallelize(1 to 1000, 10).persist(MEMORY_ONLY_SER_2)
data3.count
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;works as intended.&lt;/p&gt;

&lt;p&gt;But &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;val data4 = sc.parallelize((1 to 1000).map(TestInteger(_)), 10).persist(MEMORY_ONLY_SER_2)
data4.count
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Again doesn&apos;t replicate data and executors show the same ClassNotFoundException&lt;/p&gt;

&lt;p&gt;These examples worked fine and showed expected results with Spark 1.6.2&lt;/p&gt;</description>
                <environment></environment>
        <key id="12989543">SPARK-16550</key>
            <summary>Caching data with replication doesn&apos;t replicate data</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ekhliang">Eric Liang</assignee>
                                    <reporter username="shubhamc">Shubham Chopra</reporter>
                        <labels>
                    </labels>
                <created>Thu, 14 Jul 2016 19:05:57 +0000</created>
                <updated>Mon, 22 Aug 2016 23:32:00 +0000</updated>
                            <resolved>Mon, 22 Aug 2016 23:31:58 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.1</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                    <component>Block Manager</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                                                            <comments>
                            <comment id="15378167" author="srowen" created="Thu, 14 Jul 2016 19:17:51 +0000"  >&lt;p&gt;You have a shell-related problem here that caused the failure. It has nothing to do with replication. Basically, you&apos;ll find that case classes in the shell don&apos;t necessarily work in all cases. These are more functions of how Scala works and not Spark issues per se. Compiled programs will work fine. I&apos;ll close this.&lt;/p&gt;</comment>
                            <comment id="15378478" author="shubhamc" created="Thu, 14 Jul 2016 22:03:05 +0000"  >&lt;p&gt;Example code: &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;case class TestInteger(i: Int)

object TestApp {
  def main(args: Array[String]) {
    val conf = (new SparkConf).setAppName(&quot;Test app&quot;).setMaster(&quot;yarn-client&quot;)
    val sc = new SparkContext(conf)

    val data = sc.parallelize(1 to 1000, 10).persist(StorageLevel.MEMORY_ONLY_2)
    println(data.count)
    println(s&quot;Total number of blocks in data: ${sc.getExecutorStorageStatus.map(_.rddBlocksById(data.id).size).sum}&quot;)

    val dataTestInt = sc.parallelize((1 to 1000).map(TestInteger(_)), 10).persist(StorageLevel.MEMORY_ONLY_2)
    println(dataTestInt.count)
    println(s&quot;Total number of blocks in dataTestInt: ${sc.getExecutorStorageStatus.map(_.rddBlocksById(dataTestInt.id).size).sum}&quot;)

    val dataInteger = sc.parallelize((1 to 1000).map(new Integer(_)), 10).persist(StorageLevel.MEMORY_ONLY_2)
    println(dataInteger.count)
    println(s&quot;Total number of blocks in dataInteger: ${sc.getExecutorStorageStatus.map(_.rddBlocksById(dataInteger.id).size).sum}&quot;)

    val dataSerialized = sc.parallelize(1 to 1000, 10).persist(StorageLevel.MEMORY_ONLY_SER_2)
    println(dataSerialized.count)
    println(s&quot;Total number of blocks in dataSerialized: ${sc.getExecutorStorageStatus.map(_.rddBlocksById(dataSerialized.id).size).sum}&quot;)

    val dataTestIntSer = sc.parallelize((1 to 1000).map(TestInteger(_)), 10).persist(StorageLevel.MEMORY_ONLY_SER_2)
    println(dataTestIntSer.count)
    println(s&quot;Total number of blocks in dataTestIntSer: ${sc.getExecutorStorageStatus.map(_.rddBlocksById(dataTestIntSer.id).size).sum}&quot;)

  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Output:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;1000&lt;br/&gt;
Total number of blocks in data: 10&lt;br/&gt;
1000&lt;br/&gt;
Total number of blocks in dataTestInt: 10&lt;br/&gt;
1000&lt;br/&gt;
Total number of blocks in dataInteger: 20&lt;br/&gt;
1000&lt;br/&gt;
Total number of blocks in dataSerialized: 20&lt;br/&gt;
1000&lt;br/&gt;
Total number of blocks in dataTestIntSer: 10&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The issue exists when I submit a compiled program as well. The exception stack traces are similar to the ones posted above.&lt;/p&gt;

&lt;p&gt;I think part of the problem might be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-13990&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;SPARK-13990&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This code works fine in Spark 1.6.2, both in the shell and when submitted as compiled code.&lt;/p&gt;</comment>
                            <comment id="15378496" author="srowen" created="Thu, 14 Jul 2016 22:13:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shubhamc&quot; class=&quot;user-hover&quot; rel=&quot;shubhamc&quot;&gt;shubhamc&lt;/a&gt; don&apos;t set Blocker. Even if this is a real issue, it would not block a release.&lt;/p&gt;</comment>
                            <comment id="15378527" author="rxin" created="Thu, 14 Jul 2016 22:41:04 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=joshrosen&quot; class=&quot;user-hover&quot; rel=&quot;joshrosen&quot;&gt;joshrosen&lt;/a&gt; who wrote &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-13990&quot; title=&quot;Automatically pick serializer when caching RDDs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-13990&quot;&gt;&lt;del&gt;SPARK-13990&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15378593" author="joshrosen" created="Thu, 14 Jul 2016 23:25:34 +0000"  >&lt;p&gt;&lt;b&gt;For the case involving a REPL-defined class:&lt;/b&gt; The ClassNotFoundException is occurring because the NettyBlockRpcServer is attempting to deserialize a ClassTag field and that ClassTag references a class which is only present in the REPL classloader and not in the executor JVM&apos;s default classloader. One potential solution is to use the executor&apos;s REPL / context classloader for deserializing ClassTags, but this might be slightly non-straightforward due to some complicated initialization ordering dependencies.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;For the case involving integers:&lt;/b&gt; I omitted a classTag inside a call in &lt;tt&gt;doGetLocalBytes()&lt;/tt&gt;, which is called as part of the write-side of the block replication code.&lt;/p&gt;</comment>
                            <comment id="15379793" author="joshrosen" created="Fri, 15 Jul 2016 17:57:10 +0000"  >&lt;p&gt;I have a partial fix for the &quot;unable to replicate integers&quot; issue, including an enhancement to the caching tests in DistributedSuite to make them capable of catching this bug: &lt;a href=&quot;https://github.com/JoshRosen/spark/tree/SPARK-16550&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/JoshRosen/spark/tree/SPARK-16550&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;All that remains is to fix the ClassTag + Classloading issue so that this also works for REPL-defined classes (or, alternatively, just erase the caching ClassTag to ClassTag[Any] since we&apos;re just going to use the default serializer).&lt;/p&gt;</comment>
                            <comment id="15388638" author="apachespark" created="Thu, 21 Jul 2016 23:57:04 +0000"  >&lt;p&gt;User &apos;ericl&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/14311&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/14311&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15388785" author="rxin" created="Fri, 22 Jul 2016 02:46:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shubhamc&quot; class=&quot;user-hover&quot; rel=&quot;shubhamc&quot;&gt;shubhamc&lt;/a&gt; can you test the patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ekhliang&quot; class=&quot;user-hover&quot; rel=&quot;ekhliang&quot;&gt;ekhliang&lt;/a&gt; submitted?&lt;/p&gt;</comment>
                            <comment id="15392680" author="shubhamc" created="Mon, 25 Jul 2016 21:11:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rxin&quot; class=&quot;user-hover&quot; rel=&quot;rxin&quot;&gt;rxin&lt;/a&gt; I did some basic testing using the patch, and it shows the desired replication. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ekhliang&quot; class=&quot;user-hover&quot; rel=&quot;ekhliang&quot;&gt;ekhliang&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;The patch, however, does fail some unit tests in DistributedSuite.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                            <subtask id="12997008">SPARK-17042</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 17 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30zon:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>