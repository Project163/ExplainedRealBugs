<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:03:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-26718] Fixed integer overflow in SS kafka rateLimit calculation</title>
                <link>https://issues.apache.org/jira/browse/SPARK-26718</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;when running spark structured streaming using lib: `&quot;org.apache.spark&quot; %% &quot;spark-sql-kafka-0-10&quot; % &quot;2.4.0&quot;`, we keep getting error regarding current offset fetching:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: org.apache.spark.SparkException: Job aborted due to stage failure: Task 0 in stage 0.0 failed 4 times, most recent failure: Lost task 0.3 in stage 0.0 (TID 3, qa2-hdp-4.acuityads.org, executor 2): java.lang.AssertionError: assertion failed: latest offs
et -9223372036854775808 does not equal -1
at scala.Predef$.&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt;(Predef.scala:170)
at org.apache.spark.sql.kafka010.KafkaMicroBatchInputPartitionReader.resolveRange(KafkaMicroBatchReader.scala:371)
at org.apache.spark.sql.kafka010.KafkaMicroBatchInputPartitionReader.&amp;lt;init&amp;gt;(KafkaMicroBatchReader.scala:329)
at org.apache.spark.sql.kafka010.KafkaMicroBatchInputPartition.createPartitionReader(KafkaMicroBatchReader.scala:314)
at org.apache.spark.sql.execution.datasources.v2.DataSourceRDD.compute(DataSourceRDD.scala:42)
at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:324)
at org.apache.spark.rdd.RDD.iterator(RDD.scala:288)
at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:52)
at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:324)
at org.apache.spark.rdd.RDD.iterator(RDD.scala:288)
at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:52)
at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:324)
at org.apache.spark.rdd.RDD.iterator(RDD.scala:288)
at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:52)
at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:324)
at org.apache.spark.rdd.RDD.iterator(RDD.scala:288)
at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:99)
at org.apache.spark.scheduler.ShuffleMapTask.runTask(ShuffleMapTask.scala:55)
at org.apache.spark.scheduler.Task.run(Task.scala:121)
at org.apache.spark.executor.Executor$TaskRunner$$anonfun$10.apply(Executor.scala:402)
at org.apache.spark.util.Utils$.tryWithSafeFinally(Utils.scala:1360)
at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:408)
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;for some reason, looks like fetchLatestOffset returned a Long.MIN_VALUE for one of the partitions. I checked the structured streaming checkpoint, that was correct, it&apos;s the currentAvailableOffset was set to Long.MIN_VALUE.&lt;/p&gt;

&lt;p&gt;kafka broker version: 1.1.0.&lt;br/&gt;
lib we used:&lt;/p&gt;

&lt;p&gt;{{libraryDependencies += &quot;org.apache.spark&quot; %% &quot;spark-sql-kafka-0-10&quot; % &quot;2.4.0&quot; }}&lt;/p&gt;

&lt;p&gt;how to reproduce:&lt;br/&gt;
basically we started a structured streamer and subscribed a topic of 4 partitions. then produced some messages into topic, job crashed and logged the stacktrace like above.&lt;/p&gt;

&lt;p&gt;also the committed offsets seem fine as we see in the logs:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
=== Streaming Query ===
Identifier: [id = c46c67ee-3514-4788-8370-a696837b21b1, runId = 31878627-d473-4ee8-955d-d4d3f3f45eb9]
Current Committed Offsets: {KafkaV2[Subscribe[REVENUEEVENT]]: {&lt;span class=&quot;code-quote&quot;&gt;&quot;REVENUEEVENT&quot;&lt;/span&gt;:{&lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt;:1}}}
Current Available Offsets: {KafkaV2[Subscribe[REVENUEEVENT]]: {&lt;span class=&quot;code-quote&quot;&gt;&quot;REVENUEEVENT&quot;&lt;/span&gt;:{&lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt;:-9223372036854775808}}}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;so spark streaming recorded the correct value for partition: 0, but the current available offsets returned from kafka is showing Long.MIN_VALUE.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13211637">SPARK-26718</key>
            <summary>Fixed integer overflow in SS kafka rateLimit calculation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="linehrr">Ryne Yang</assignee>
                                    <reporter username="linehrr">Ryne Yang</reporter>
                        <labels>
                    </labels>
                <created>Thu, 24 Jan 2019 19:15:38 +0000</created>
                <updated>Wed, 30 Jan 2019 19:14:40 +0000</updated>
                            <resolved>Tue, 29 Jan 2019 19:01:59 +0000</resolved>
                                    <version>2.4.0</version>
                                    <fixVersion>2.3.3</fixVersion>
                    <fixVersion>2.4.1</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>Structured Streaming</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16751625" author="linehrr" created="Thu, 24 Jan 2019 22:02:40 +0000"  >&lt;p&gt;found the issue, it&apos;s the rateLimit calculation. if anyone set the `maxOffsetsPerTrigger` to Long.MaxValue. then this could happen.&lt;/p&gt;

&lt;p&gt;in class KafkaMicroBatchReader.scala:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; def rateLimit(
limit: &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;,
from: PartitionOffsetMap,
until: PartitionOffsetMap): PartitionOffsetMap = {
val fromNew = kafkaOffsetReader.fetchEarliestOffsets(until.keySet.diff(from.keySet).toSeq)
val sizes = until.flatMap {
&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; (tp, end) =&amp;gt;
&lt;span class=&quot;code-comment&quot;&gt;// If begin isn&lt;span class=&quot;code-quote&quot;&gt;&apos;t defined, something&apos;&lt;/span&gt;s wrong, but let alert logic in getBatch handle it
&lt;/span&gt;from.get(tp).orElse(fromNew.get(tp)).flatMap { begin =&amp;gt;
val size = end - begin
logDebug(s&lt;span class=&quot;code-quote&quot;&gt;&quot;rateLimit $tp size is $size&quot;&lt;/span&gt;)
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (size &amp;gt; 0) Some(tp -&amp;gt; size) &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; None
}
}
val total = sizes.values.sum.toDouble
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (total &amp;lt; 1) {
until
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
until.map {
&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; (tp, end) =&amp;gt;
tp -&amp;gt; sizes.get(tp).map { size =&amp;gt;
val begin = from.get(tp).getOrElse(fromNew(tp))
val prorate = limit * (size / total)
&lt;span class=&quot;code-comment&quot;&gt;// Don&apos;t completely starve small topicpartitions
&lt;/span&gt;val off = begin + (&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (prorate &amp;lt; 1) &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.ceil(prorate) &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.floor(prorate)).toLong
&lt;span class=&quot;code-comment&quot;&gt;// Paranoia, make sure not to &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; an offset that&apos;s past end
&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.min(end, off)
}.getOrElse(end)
}
}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;this rateLimit function is the trouble where if limit is set to Long.MaxValue, it could have integer overflow, showing in below example:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val begin = 100
val limit = &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MaxValue
val size = 5933L
val total = 5933L.toDouble

val prorate = limit * (size / total)
&lt;span class=&quot;code-comment&quot;&gt;// Don&apos;t completely starve small topicpartitions
&lt;/span&gt;val off = begin + (&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (prorate &amp;lt; 1) &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.ceil(prorate) &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.floor(prorate)).toLong

println(off)

&lt;span class=&quot;code-comment&quot;&gt;// prints -9223372036854775709&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;root cause is `limit * (size/total)&apos;, it would lose precision due to Double type and then `begin + Math.floor(prorate)` will overflow.&#160;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16751629" author="linehrr" created="Thu, 24 Jan 2019 22:05:53 +0000"  >&lt;p&gt;A simple fix would be a if statement to check if the integer overflowed, and then throw some exception to notify the user.&#160;&lt;/p&gt;</comment>
                            <comment id="16751694" author="kabhwan" created="Thu, 24 Jan 2019 23:22:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=linehrr&quot; class=&quot;user-hover&quot; rel=&quot;linehrr&quot;&gt;linehrr&lt;/a&gt;&lt;br/&gt;
Thanks for the analysis. I think allowing Long.MaxValue to end users sounds convenient and end users already use it, so ensuring &apos;off&apos; to not being overflowed would be ideal. This is simply ensured via modifying the code as:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val prorate = limit * (size / total)
val prorateLong = (&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (prorate &amp;lt; 1) &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.ceil(prorate) &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.floor(prorate)).toLong
val off = &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (prorateLong &amp;gt; &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MaxValue - begin) &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.MaxValue &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; begin + propateLong
&lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.min(end, off)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Please submit a patch if you would like to. If you wouldn&apos;t submit a patch please let me know that I can take this up. Thanks!&lt;/p&gt;</comment>
                            <comment id="16751706" author="gsomogyi" created="Thu, 24 Jan 2019 23:52:03 +0000"  >&lt;p&gt;+1 on &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kabhwan&quot; class=&quot;user-hover&quot; rel=&quot;kabhwan&quot;&gt;kabhwan&lt;/a&gt; suggestion&lt;/p&gt;</comment>
                            <comment id="16752353" author="linehrr" created="Fri, 25 Jan 2019 15:28:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kabhwan&quot; class=&quot;user-hover&quot; rel=&quot;kabhwan&quot;&gt;kabhwan&lt;/a&gt; cool, I will make a PR soon. thank you.&#160;&lt;/p&gt;</comment>
                            <comment id="16752420" author="linehrr" created="Fri, 25 Jan 2019 16:47:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kabhwan&quot; class=&quot;user-hover&quot; rel=&quot;kabhwan&quot;&gt;kabhwan&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gsomogyi&quot; class=&quot;user-hover&quot; rel=&quot;gsomogyi&quot;&gt;gsomogyi&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;PR submitted :&#160;&lt;a href=&quot;https://github.com/apache/spark/pull/23652&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23652&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16752478" author="apachespark" created="Fri, 25 Jan 2019 17:24:26 +0000"  >&lt;p&gt;User &apos;linehrr&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/23652&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23652&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16755295" author="dongjoon" created="Tue, 29 Jan 2019 19:01:59 +0000"  >&lt;p&gt;This is resolved via &lt;a href=&quot;https://github.com/apache/spark/pull/23666&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23666&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13010283">SPARK-17813</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 42 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|yi0a5s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>