<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:13:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-1860] Standalone Worker cleanup should not clean up running executors</title>
                <link>https://issues.apache.org/jira/browse/SPARK-1860</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;The default values of the standalone worker cleanup code cleanup all application data every 7 days. This includes jars that were added to any executors that happen to be running for longer than 7 days, hitting streaming jobs especially hard.&lt;/p&gt;

&lt;p&gt;Executor&apos;s log/data folders should not be cleaned up if they&apos;re still running. Until then, this behavior should not be enabled by default.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12714679">SPARK-1860</key>
            <summary>Standalone Worker cleanup should not clean up running executors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="ilikerps">Aaron Davidson</reporter>
                        <labels>
                    </labels>
                <created>Fri, 16 May 2014 00:38:27 +0000</created>
                <updated>Thu, 26 Feb 2015 01:01:57 +0000</updated>
                            <resolved>Fri, 3 Oct 2014 21:26:11 +0000</resolved>
                                    <version>1.0.0</version>
                                    <fixVersion>1.2.0</fixVersion>
                                    <component>Deploy</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="13999594" author="pwendell" created="Fri, 16 May 2014 04:38:35 +0000"  >&lt;p&gt;Issue resolved by pull request 800&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/800&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/800&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13999600" author="pwendell" created="Fri, 16 May 2014 04:56:28 +0000"  >&lt;p&gt;The PR actually just disabled it, it didn&apos;t fix this.&lt;/p&gt;</comment>
                            <comment id="13999602" author="pwendell" created="Fri, 16 May 2014 04:59:55 +0000"  >&lt;p&gt;I think it would be better to only start the TTL once an executor has finished and to only delete the specific folder used by the executor.&lt;/p&gt;</comment>
                            <comment id="14001151" author="aash" created="Sun, 18 May 2014 18:26:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkim&quot; class=&quot;user-hover&quot; rel=&quot;mkim&quot;&gt;mkim&lt;/a&gt; is going to take a look at this after discussion at &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-1154&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-1154&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I think the correct fix as Patrick outlines would be:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// pseudocode
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; folder in onDiskFolders:
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; folder is owned by a running application:
        &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; folder contains any folder/file (recursively) that is more recently touched (mtime) than the TTS:
        &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;
    cleanUp(folder)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Schedule that to run periodically (interval configured by setting) and this should be all fixed up.&lt;/p&gt;

&lt;p&gt;Is that right?&lt;/p&gt;

&lt;p&gt;An alternative approach could be to have executor clean up the application&apos;s work directory when the application terminates, but un-clean executor shutdown could still leave work directories around so a TTL approach still needs to be included as well.&lt;/p&gt;</comment>
                            <comment id="14004747" author="mkim" created="Wed, 21 May 2014 15:10:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aash&quot; class=&quot;user-hover&quot; rel=&quot;aash&quot;&gt;aash&lt;/a&gt;, is there a reliable way to check &quot;folder is owned by a running application&quot;? I thought that&apos;s not possible, so I was just going to have the second if statement, which means folder for running applications that just haven&apos;t been active for TTS will also get wiped out, assuming that executor is writing out something to either stdout or stderr when it runs some computation.&lt;/p&gt;

&lt;p&gt;This also means that if you have a long-running inactive application, the application should send a &quot;heartbeat&quot; by running a trivial computation once every while.&lt;/p&gt;

&lt;p&gt;Any suggestions?&lt;/p&gt;</comment>
                            <comment id="14005596" author="aash" created="Thu, 22 May 2014 04:16:08 +0000"  >&lt;p&gt;So the Spark master webui shows the running applications, so it at least knows what&apos;s running.  I guess since this is running on a worker it may need to be told by the master what the active applications are.  Not sure the internals of Spark very well but there&apos;s got to be a way to determine this.&lt;/p&gt;</comment>
                            <comment id="14047074" author="mkim" created="Sun, 29 Jun 2014 07:49:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pwendell&quot; class=&quot;user-hover&quot; rel=&quot;pwendell&quot;&gt;pwendell&lt;/a&gt;, would there be an easy way to tell from the worker node whether an app directory is active or not? In other words, can a worker node get the list of active application ids from the master? I thought this was not doable, so was just going to wipe out all app directories that haven&apos;t been used (i.e. no jobs have run even if the the application is still alive) based on the last modified date of the log files. What do you think?&lt;/p&gt;</comment>
                            <comment id="14075911" author="mkim" created="Mon, 28 Jul 2014 05:28:27 +0000"  >&lt;p&gt;Friendly ping? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pwendell&quot; class=&quot;user-hover&quot; rel=&quot;pwendell&quot;&gt;pwendell&lt;/a&gt; Can you let me know if there is an easy way to tell from the worker node whether an app is active? Or, should we just go with the rather-fragile design as I proposed right above?&lt;/p&gt;</comment>
                            <comment id="14076403" author="ilikerps" created="Mon, 28 Jul 2014 17:10:33 +0000"  >&lt;p&gt;There&apos;s not an easy way to tell if an application is still running. However, the Worker has state about which executors are still running. This is really what I intended originally &amp;#8211; we must not clean up an Executor&apos;s own state from underneath it. I will change the title to reflect this intention.&lt;/p&gt;</comment>
                            <comment id="14076778" author="markhamstra" created="Mon, 28 Jul 2014 20:29:41 +0000"  >&lt;p&gt;I don&apos;t think that there is much in the way of conflict, but something to be aware of is that the proposed fix to &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-2425&quot; title=&quot;Standalone Master is too aggressive in removing Applications&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-2425&quot;&gt;&lt;del&gt;SPARK-2425&lt;/del&gt;&lt;/a&gt; does modify Executor state transitions and cleanup: &lt;a href=&quot;https://github.com/apache/spark/pull/1360&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/1360&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14152421" author="mcheah" created="Mon, 29 Sep 2014 22:22:49 +0000"  >&lt;p&gt;Apologies for any naivety - this will be the first issue I tackle as a Spark contributor.&lt;/p&gt;

&lt;p&gt;Mingyu and I had a short chat and we thought it would be reasonable for the Executor to simply clean up its own state when it shuts down. Is there anything preventing Executor.stop() from cleaning up the app directory it was using?&lt;/p&gt;</comment>
                            <comment id="14152552" author="aash" created="Mon, 29 Sep 2014 23:54:49 +0000"  >&lt;p&gt;Cleanup on executor shutdown is part of the solution (and should be done IMO) but not all of it.&lt;/p&gt;

&lt;p&gt;Particularly it won&apos;t cover when an executor dies from an OOM or a kill -9 or any other unclean shutdown.  The perfect solution would do the event-based cleanup self on executor shutdown, and also a periodic cleaner to get rid of directories that were shutdown uncleanly.&lt;/p&gt;</comment>
                            <comment id="14152621" author="mcheah" created="Tue, 30 Sep 2014 00:45:46 +0000"  >&lt;p&gt;ExecutorRunner seems to have various cases corresponding to how the Executor exited. ExecutorRunner also creates the directory in fetchAndRunExecutor(). We can catch all of the exit cases there and delete the directory in any case.&lt;/p&gt;

&lt;p&gt;In the case that the executor failed to exit, however, it would be best to preserve the logs. instead of blindly killing the whole directory.&lt;/p&gt;

&lt;p&gt;On that note, one other thought is that perhaps we actually want to preserve the directory entirely upon crash since preserving the state will allow us to better understand what happened, i.e. what jars and files were present and so on.&lt;/p&gt;</comment>
                            <comment id="14152744" author="ilikerps" created="Tue, 30 Sep 2014 02:49:20 +0000"  >&lt;p&gt;Note that there are two separate forms of cleanup: application data cleanup (jars and logs) and shuffle data cleanup. Standalone Worker cleanup deals with the former, Executor termination handlers deal with the latter. The purpose is not to deal with executors that have terminated ungracefully, but to actually clean up old application directories.&lt;/p&gt;

&lt;p&gt;Here the idea is that a Worker may be running for a very long time (weeks, months) and over time accumulates hundreds of application directories. We want to delete these directories after several days of them being terminated (today we&apos;ll clean them up whether or not they&apos;re terminated, which loses their jars and logs), after which we presumably don&apos;t care anymore. We do not want to clean them up immediately after application termination.&lt;/p&gt;

&lt;p&gt;The Worker performing shuffle data cleanup for ungracefully terminated Executors is not a bad idea, but is a (smallish) feature onto itself, as the Worker does not currently know where a particular Executor is storing its data.&lt;/p&gt;</comment>
                            <comment id="14152758" author="mcheah" created="Tue, 30 Sep 2014 03:14:29 +0000"  >&lt;p&gt;I agree we should focus the scope on cleaning up things that have successfully finished. Preserving state is beneficial in erroneous cases.&lt;/p&gt;

&lt;p&gt;However, should it not be the case that when an Executor shuts down, it cleans up all of the files it created? As you stated, the Worker doesn&apos;t know where a particular Executor is storing its data, but the Executor should know where it is storing its own data, and be managing it and cleaning up when completed. This is regardless of the distinction between application data and shuffle data.&lt;/p&gt;

&lt;p&gt;The Executor class has a record of the files and jars added through the SparkContext (currentFiles and currentJars fields) for that Executor&apos;s use, and these should naturally expire and be cleaned up when the Executor terminates. The top level application directories may still remain for a short time (Executors can only delete the subdirectory they work with) but the Worker can do a pass and remove empty directories that were all cleaned up by the completed Executor task.&lt;/p&gt;</comment>
                            <comment id="14152839" author="ilikerps" created="Tue, 30 Sep 2014 06:09:58 +0000"  >&lt;p&gt;The Executor could clean up its own jars when it terminates normally, that seems fine. The impact of this seems limited, though, and it&apos;s a good idea to limit the scope of shutdown hooks as much as possible.&lt;/p&gt;

&lt;p&gt;There are three classes of things to delete:&lt;br/&gt;
1. Shuffle files / block manager blocks &amp;#8211; large &amp;#8211; deleted by graceful Executor termination. Can be deleted immediately.&lt;br/&gt;
2. Uploaded jars / files &amp;#8211; usually small &amp;#8211; deleted by Worker cleanup. Can be deleted immediately.&lt;br/&gt;
3. Logs &amp;#8211; small to medium &amp;#8211; deleted by Worker cleanup. Should not be deleted immediately.&lt;/p&gt;

&lt;p&gt;Number 1 is most critical in terms of impact on the system. Numbers 2 and 3 are of the same order of magnitude in size, so cleaning up 2 and not 3 is not expected to improve the system&apos;s stability by more than a factor of ~2x applications.&lt;/p&gt;

&lt;p&gt;Note that the intentions of this particular JIRA are very simple: cleanup 2 and 3 for all executors several days after they have terminated, rather than after they have started. If you wish to expand the scope of the Worker or Executor cleanup, that should be covered in a separate JIRA (which is welcome &amp;#8211; I just want to make sure we&apos;re on the same page about this particular issue!).&lt;/p&gt;</comment>
                            <comment id="14153382" author="mcheah" created="Tue, 30 Sep 2014 16:47:51 +0000"  >&lt;p&gt;Cool, I see where you&apos;re coming from now. I&apos;ll whip up something. Thanks for the input!&lt;/p&gt;

&lt;p&gt;The cleanup for jars and added files is more for cosmetic sake than performance, I agree.&lt;/p&gt;</comment>
                            <comment id="14153514" author="mcheah" created="Tue, 30 Sep 2014 18:25:49 +0000"  >&lt;p&gt;The change I am going to make is that when the cleanup task runs, it deletes an app directory inside the work directory if both the timestamp on the app directory and the timestamps on all of the app directory&apos;s files are older than the app directory retention time.&lt;/p&gt;

&lt;p&gt;If any files inside the app directory are recently modified, the app directory is not touched.&lt;/p&gt;

&lt;p&gt;Let me know if this change suffices to address this issue and I&apos;ll open a pull request.&lt;/p&gt;</comment>
                            <comment id="14153752" author="aash" created="Tue, 30 Sep 2014 21:08:45 +0000"  >&lt;p&gt;That matches my expectations for this ticket Matt &amp;#8211; improve the timed cleanup task to only delete applications that have terminated instead of running ones as well.&lt;/p&gt;</comment>
                            <comment id="14153893" author="mcheah" created="Tue, 30 Sep 2014 22:31:22 +0000"  >&lt;p&gt;Would like confirmation from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adav&quot; class=&quot;user-hover&quot; rel=&quot;adav&quot;&gt;adav&lt;/a&gt; for the proposed change.&lt;/p&gt;</comment>
                            <comment id="14154220" author="apachespark" created="Wed, 1 Oct 2014 01:54:37 +0000"  >&lt;p&gt;User &apos;mccheah&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/2608&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/2608&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14154226" author="apachespark" created="Wed, 1 Oct 2014 02:01:24 +0000"  >&lt;p&gt;User &apos;mccheah&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/2609&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/2609&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14154228" author="ilikerps" created="Wed, 1 Oct 2014 02:05:49 +0000"  >&lt;p&gt;Your logic SGTM, but I would add one additional check to avoid deleting the directory for an Application which still has running Executors on that node, just to make absolutely sure that we don&apos;t delete app directories that just happen to sit idle for a while. This check can be performed by iterating over the &quot;executors&quot; map in Worker.scala and matching the appId with the app directory&apos;s name.&lt;/p&gt;</comment>
                            <comment id="14155097" author="mcheah" created="Wed, 1 Oct 2014 16:49:54 +0000"  >&lt;p&gt;This might be a silly question, but are we guaranteed that the application folder will always be labeled by appid? I looked at ExecutorRunner and it certainly generates the folder by application ID and executor ID, but code comments in ExecutorRunner indicate it is only used by the standalone cluster mode. Hence I didn&apos;t tie any logic to the actual naming of the folders.&lt;/p&gt;</comment>
                            <comment id="14155303" author="ilikerps" created="Wed, 1 Oct 2014 19:03:10 +0000"  >&lt;p&gt;The Worker itself is solely a Standalone mode construct, so AFAIK, this is not an issue.&lt;/p&gt;</comment>
                            <comment id="14158546" author="ilikerps" created="Fri, 3 Oct 2014 21:26:11 +0000"  >&lt;p&gt;Fixed by mccheah in &lt;a href=&quot;https://github.com/apache/spark/pull/2609&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/2609&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14158646" author="aash" created="Fri, 3 Oct 2014 23:04:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ilikerps&quot; class=&quot;user-hover&quot; rel=&quot;ilikerps&quot;&gt;ilikerps&lt;/a&gt; this ticket mentioned turning the cleanup code on by default once this ticket was fixed.  Should we change the defaults to have this on by default?&lt;/p&gt;</comment>
                            <comment id="14159343" author="ilikerps" created="Sat, 4 Oct 2014 23:23:39 +0000"  >&lt;p&gt;Agreed, that sounds good. Would you or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mccheah&quot; class=&quot;user-hover&quot; rel=&quot;mccheah&quot;&gt;mccheah&lt;/a&gt; be able to create a quick PR for this?&lt;/p&gt;</comment>
                            <comment id="14159707" author="aash" created="Sun, 5 Oct 2014 21:31:08 +0000"  >&lt;p&gt;Filed as &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-3805&quot; title=&quot;Enable Standalone worker cleanup by default&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-3805&quot;&gt;&lt;del&gt;SPARK-3805&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12746021">SPARK-3805</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12704705">SPARK-1154</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12705436">SPARK-786</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>392992</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 7 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1vo9r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>393160</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327369">1.2.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>