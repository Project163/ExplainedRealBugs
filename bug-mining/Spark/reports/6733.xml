<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:07:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-27812] kubernetes client import non-daemon thread which block jvm exit.</title>
                <link>https://issues.apache.org/jira/browse/SPARK-27812</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I&#160;try spark-submit to k8s with cluster mode. Driver pod failed to exit with An Okhttp Websocket Non-Daemon Thread.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13235056">SPARK-27812</key>
            <summary>kubernetes client import non-daemon thread which block jvm exit.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="igor.calabria">Igor Calabria</assignee>
                                    <reporter username="Andrew HUALI">Henry Yu</reporter>
                        <labels>
                    </labels>
                <created>Thu, 23 May 2019 06:53:05 +0000</created>
                <updated>Thu, 18 Mar 2021 21:36:13 +0000</updated>
                            <resolved>Thu, 17 Oct 2019 19:24:50 +0000</resolved>
                                    <version>2.4.3</version>
                    <version>2.4.4</version>
                                    <fixVersion>2.4.5</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>Kubernetes</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>13</watches>
                                                                                                                <comments>
                            <comment id="16852342" author="igor.calabria" created="Thu, 30 May 2019 20:47:48 +0000"  >&lt;p&gt;I believe this was introduced when `kubernetes-client` was updated in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26742&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-26742&lt;/a&gt; . I can confirm that reverting &lt;a href=&quot;https://github.com/apache/spark/commit/2d4e9cf84b85a5f8278276e8d8ff59f6f4b11c4c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/2d4e9cf84b85a5f8278276e8d8ff59f6f4b11c4c&lt;/a&gt; fixes this issue. This is funny because it was already discussed here (2017): &lt;a href=&quot;https://github.com/apache-spark-on-k8s/spark/pull/216#discussion_r112641765.&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache-spark-on-k8s/spark/pull/216#discussion_r112641765 &lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The previous solution was setting `.withWebsocketPingInterval(&lt;font color=&quot;#6897bb&quot;&gt;0&lt;/font&gt;)` option when instantiating the client. This prevented the user thread from being created. Maybe something changed with okhttp or kubernetes-client and this is no longer the case.&lt;/p&gt;</comment>
                            <comment id="16852402" author="dongjoon" created="Thu, 30 May 2019 22:04:51 +0000"  >&lt;p&gt;Thank you for reporting, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Andrew+HUALI&quot; class=&quot;user-hover&quot; rel=&quot;Andrew HUALI&quot;&gt;Andrew HUALI&lt;/a&gt; and thank you for the investigation, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=igor.calabria&quot; class=&quot;user-hover&quot; rel=&quot;igor.calabria&quot;&gt;igor.calabria&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Can we move forward to resolve the issue by upgrading the libraries?&lt;/p&gt;</comment>
                            <comment id="16853159" author="igor.calabria" created="Fri, 31 May 2019 16:02:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dongjoon&quot; class=&quot;user-hover&quot; rel=&quot;dongjoon&quot;&gt;dongjoon&lt;/a&gt; Do you mean downgrading? Because the issue was introduced when kubernetes client was updated. I took a look at both OkHttp and fabric8&apos;s kubernetes client code between the upgraded tags and I couldn&apos;t find anything obvious that caused this. &lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Maybe the right path for spark is to actually deal with &quot;rogue&quot; user threads on shutdown/exceptions instead of simply relying that they won&apos;t be created by libs or user code.&lt;/p&gt;</comment>
                            <comment id="16853227" author="dongjoon" created="Fri, 31 May 2019 17:13:17 +0000"  >&lt;p&gt;What I meat was &lt;b&gt;upgrading&lt;/b&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=igor.calabria&quot; class=&quot;user-hover&quot; rel=&quot;igor.calabria&quot;&gt;igor.calabria&lt;/a&gt;. Currently, the latest one is already 4.2.2.&lt;/p&gt;</comment>
                            <comment id="16859710" author="andrew huali" created="Mon, 10 Jun 2019 05:30:11 +0000"  >&lt;p&gt;In our private branch, I fix this and potential non-daemon thread introduced by other third party lib&#160;by adding&#160;SparkUncaughtExceptionHandler to KubernetesClusterSchedulerBackend&lt;/p&gt;

&lt;p&gt;. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dongjoon&quot; class=&quot;user-hover&quot; rel=&quot;dongjoon&quot;&gt;dongjoon&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Driver Pod doesn&apos;t exit because there is a uncaught exception,&#160;kubernetes-client failed to call close method , and non-daemon thread block shutdownhook to get executed. With&#160;SparkUncaughtExceptionHandler, we can catch user/spark uncaught exception and Call System.exit which triggers shutdownhook to make things better.&lt;/p&gt;

&lt;p&gt;How about this solution?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16859712" author="andrew huali" created="Mon, 10 Jun 2019 05:35:56 +0000"  >&lt;p&gt;According to Okhttp Committer&#160;&lt;b&gt;&lt;a href=&quot;https://github.com/swankjesse&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;swankjesse&lt;/a&gt;&apos;s&lt;/b&gt;&#160;answer, they&#160;won&apos;t fix non-daemon thread when using websocket.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/square/okhttp/issues/3339&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/square/okhttp/issues/3339&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dongjoon&quot; class=&quot;user-hover&quot; rel=&quot;dongjoon&quot;&gt;dongjoon&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16860439" author="dongjoon" created="Tue, 11 Jun 2019 00:37:24 +0000"  >&lt;p&gt;Thank you for update, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Andrew+HUALI&quot; class=&quot;user-hover&quot; rel=&quot;Andrew HUALI&quot;&gt;Andrew HUALI&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16860580" author="andrew huali" created="Tue, 11 Jun 2019 05:50:51 +0000"  >&lt;p&gt;So, any other idea to fix it? or I will try to make pr with the&#160;SparkUncaughtExceptionHandler solution.&#160;&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dongjoon&quot; class=&quot;user-hover&quot; rel=&quot;dongjoon&quot;&gt;dongjoon&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16860602" author="dongjoon" created="Tue, 11 Jun 2019 06:40:08 +0000"  >&lt;p&gt;If &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26742&quot; title=&quot;Bump Kubernetes Client Version to 4.1.2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26742&quot;&gt;&lt;del&gt;SPARK-26742&lt;/del&gt;&lt;/a&gt; is the root cause and there is no way, we need to ping there to get a proper help. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Andrew+HUALI&quot; class=&quot;user-hover&quot; rel=&quot;Andrew HUALI&quot;&gt;Andrew HUALI&lt;/a&gt;, could you comment on the following PR and give the link to this issue, please?&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/spark/pull/23993&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23993&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16861728" author="andrew huali" created="Wed, 12 Jun 2019 03:45:17 +0000"  >&lt;p&gt;OK &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dongjoon&quot; class=&quot;user-hover&quot; rel=&quot;dongjoon&quot;&gt;dongjoon&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16883716" author="skonto" created="Fri, 12 Jul 2019 11:09:51 +0000"  >&lt;p&gt;There is an issue in general with setting a driver SparkUncaughtExceptionHandler as described in here: &lt;a href=&quot;https://github.com/apache/spark/pull/24796&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/24796&lt;/a&gt;. I am also in favor of a handler, where we can just sys.exit without running any shutdown hook logic though because of the deadlock issue.&#160;&lt;/p&gt;

&lt;p&gt;Btw I dont think we should downgrade we need to move forward and K8s moves fast so we need to do the same. The upgrade happened because the client was very old but jvm exception handling is a pita in general.&#160;&lt;/p&gt;</comment>
                            <comment id="16885219" author="ebiemond" created="Mon, 15 Jul 2019 13:13:17 +0000"  >&lt;p&gt;for &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-27927&quot; title=&quot;driver pod hangs with pyspark 2.4.3 and master on kubenetes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-27927&quot;&gt;SPARK-27927&lt;/a&gt; indeed all is fine on spark 2.4.3 when I revert&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26742&quot; title=&quot;Bump Kubernetes Client Version to 4.1.2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26742&quot;&gt;&lt;del&gt;SPARK-26742&lt;/del&gt;&lt;/a&gt; commit -&amp;gt; k8s back to&#160;kubernetes-client-3.0.0.jar&#160;&amp;amp;&#160;kubernetes-model-2.0.0.jar&lt;/p&gt;

&lt;p&gt;I understand we need to do patching but spark 2.4.3&#160;is maintenance release and this should never happen.&#160;&lt;/p&gt;

&lt;p&gt;especially If we not even patch&#160;jackson-core to 2.9.9 because of security risks&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This has to be done in 3.0.0 and have a proper fix for this blocking threads plus all the time to resolve this.&lt;/p&gt;</comment>
                            <comment id="16886359" author="irashid" created="Tue, 16 Jul 2019 18:14:07 +0000"  >&lt;p&gt;as mentioned elsewhere, installing an uncaught exception handler on the driver is not great because it can mess with usercode in the driver.&#160; Maybe we can make it configurable &#8211; by default,&#160;only install one if there is no uncaught exception handler already installed?&#160; No great solution here ...&lt;/p&gt;</comment>
                            <comment id="16892037" author="eje" created="Wed, 24 Jul 2019 17:39:29 +0000"  >&lt;p&gt;Agreed with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=skonto&quot; class=&quot;user-hover&quot; rel=&quot;skonto&quot;&gt;skonto&lt;/a&gt; that downgrading isn&apos;t a good option.&#160; We need to keep abreast of K8s (and the api) over time. Invoking sys.exit in theory seems a bit heavy handed, BUT it&apos;s also better than just hanging, and I don&apos;t know how one would manage a controlled unwind of a deadlock.&lt;/p&gt;</comment>
                            <comment id="16929501" author="igor.calabria" created="Fri, 13 Sep 2019 20:04:25 +0000"  >&lt;p&gt;Hi everyone, I have added a simple PR &lt;a href=&quot;https://github.com/apache/spark/pull/25785&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/25785&lt;/a&gt; that fixes this. The SparkUncaughtExceptionHandler PR is not enough because the driver hangs even if there&apos;s no exception.&lt;/p&gt;

&lt;p&gt;I have no idea if it&apos;s viable to merge this, but I&apos;m providing the patch so people may have a quick fix before a better solution is agreed upon.&lt;/p&gt;</comment>
                            <comment id="16954037" author="dongjoon" created="Thu, 17 Oct 2019 19:24:50 +0000"  >&lt;p&gt;Issue resolved by pull request 26093&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/26093&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/26093&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17303304" author="kotlov" created="Wed, 17 Mar 2021 11:16:56 +0000"  >&lt;p&gt;It seems, I have reproduced this bug in Spark 3.1.1.&lt;/p&gt;

&lt;p&gt;If I don&apos;t call sparkContext.stop() explicitly, then a Spark driver process doesn&apos;t terminate even after its Main method has been completed.&lt;br/&gt;
 There are two non-daemon threads, if I don&apos;t call sparkContext.stop():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[OkHttp kubernetes.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.svc,5,main]
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[OkHttp kubernetes.&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;.svc Writer,5,main]&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It looks like, it prevents the driver jvm process from terminating.&lt;/p&gt;

&lt;p&gt;Spark app is started on&#160;Amazon EKS (Kubernetes version - 1.17) by &lt;em&gt;spark-on-k8s-operator: v1beta2-1.2.0-3.0.0&lt;/em&gt; &lt;a href=&quot;https://github.com/GoogleCloudPlatform/spark-on-k8s-operator&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;(https://github.com/GoogleCloudPlatform/spark-on-k8s-operator)&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Spark docker image is built from the&#160;official release of spark-3.1.1 hadoop3.2.&lt;/p&gt;</comment>
                            <comment id="17304457" author="dongjoon" created="Thu, 18 Mar 2021 21:22:54 +0000"  >&lt;p&gt;Thank you for reporting, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Kotlov&quot; class=&quot;user-hover&quot; rel=&quot;Kotlov&quot;&gt;Kotlov&lt;/a&gt;.&lt;br/&gt;
1. Could you file a new JIRA because it might be related to K8s client version?&lt;br/&gt;
2. BTW, `sparkContext.stop()` or `spark.stop()` should be called by App. I don&apos;t think your use case is a legit Spark example although it might be a behavior change across Spark versions.&lt;/p&gt;</comment>
                            <comment id="17304459" author="dongjoon" created="Thu, 18 Mar 2021 21:24:48 +0000"  >&lt;p&gt;Does your example work with any Spark versions before? Then, what is the latest Spark version?&lt;/p&gt;</comment>
                            <comment id="17304470" author="dongjoon" created="Thu, 18 Mar 2021 21:36:13 +0000"  >&lt;p&gt;I found your JIRA, &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-34674&quot; title=&quot;Spark app on k8s doesn&amp;#39;t terminate without call to sparkContext.stop() method&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-34674&quot;&gt;&lt;del&gt;SPARK-34674&lt;/del&gt;&lt;/a&gt; . Please comment on there because this issue seems irrelevant to yours technically.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13363273">SPARK-34674</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13250660">SPARK-28721</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13212038">SPARK-26742</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 34 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z02zhs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>