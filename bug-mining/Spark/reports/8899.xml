<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:32:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-42406] [PROTOBUF] Recursive field handling is incompatible with delta</title>
                <link>https://issues.apache.org/jira/browse/SPARK-42406</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Protobuf deserializer (`from_protobuf()` function()) optionally supports recursive fields by limiting the depth to certain level. See example below. It assigns a &apos;NullType&apos; for such a field when allowed depth is reached.&#160;&lt;/p&gt;

&lt;p&gt;It causes a few issues. E.g. a repeated field as in the following example results in a Array field with &apos;NullType&apos;. Delta does not support null type in a complex type.&lt;/p&gt;

&lt;p&gt;Actually `Array&lt;span class=&quot;error&quot;&gt;&amp;#91;NullType&amp;#93;&lt;/span&gt;` is not really useful anyway.&lt;/p&gt;

&lt;p&gt;How about this fix: Drop the recursive field when the limit reached rather than using a NullType.&#160;&lt;/p&gt;

&lt;p&gt;The example below makes it clear:&lt;/p&gt;

&lt;p&gt;Consider a recursive Protobuf:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-python&quot;&gt;
message TreeNode {
&#160; string value = 1;
&#160; repeated TreeNode children = 2;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Allow depth of 2:&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-python&quot;&gt;
&#160; &#160;df.select(
&#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&apos;proto&apos;&lt;/span&gt;,
&#160; &#160; &#160;messageName = &lt;span class=&quot;code-quote&quot;&gt;&apos;TreeNode&apos;&lt;/span&gt;,
  &#160;  options = { ... &lt;span class=&quot;code-quote&quot;&gt;&quot;recursive.fields.&lt;span class=&quot;code-object&quot;&gt;max&lt;/span&gt;.depth&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt; }
  ).printSchema()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Schema looks like this:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;root
|&#8211; from_protobuf(proto): struct (nullable = true)|
|&#160;|&#8211; value: string (nullable = true)|
|&#160;|&#8211; children: array (nullable = false)|
|&#160;|&#160;|&#8211; element: struct (containsNull = false)|
|&#160;|&#160;|&#160;|&#8211; value: string (nullable = true)|
|&#160;|&#160;|&#160;|&#8211; children: array (nullable = false)|
|&#160;|&#160;|&#160;|&#160;|&#8211; element: struct (containsNull = false)|
|&#160;|&#160;|&#160;|&#160;|&#160;|&#8211; value: string (nullable = true)|
|&#160;|&#160;|&#160;|&#160;|&#160;|&#8211; children: array (nullable = false). [ === Proposed fix: Drop this field === ]|
|&#160;|&#160;|&#160;|&#160;|&#160;|&#160;|&#8211; element: void (containsNull = false) [ === NOTICE &apos;void&apos; HERE === ] 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When we try to write this to a delta table, we get an error:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;AnalysisException: Found nested NullType in column from_protobuf(proto).children which is of ArrayType. Delta doesn&apos;t support writing NullType in complex types.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
We could just drop the field &apos;element&apos; when recursion depth is reached. It is simpler and does not need to deal with NullType. We are ignoring the value anyway. There is no use in keeping the field.&lt;/p&gt;

&lt;p&gt;Another issue is setting for &apos;recursive.fields.max.depth&apos;: It is not enforced correctly. &apos;0&apos; does not make sense.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13524334">SPARK-42406</key>
            <summary>[PROTOBUF] Recursive field handling is incompatible with delta</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rangadi">Raghu Angadi</assignee>
                                    <reporter username="rangadi">Raghu Angadi</reporter>
                        <labels>
                    </labels>
                <created>Sat, 11 Feb 2023 20:53:51 +0000</created>
                <updated>Tue, 28 Feb 2023 04:45:01 +0000</updated>
                            <resolved>Tue, 28 Feb 2023 04:45:01 +0000</resolved>
                                    <version>3.4.0</version>
                                    <fixVersion>3.4.0</fixVersion>
                                    <component>Protobuf</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17687489" author="rangadi" created="Sat, 11 Feb 2023 21:00:14 +0000"  >&lt;p&gt;cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sanysandish%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;sanysandish@gmail.com&quot;&gt;sanysandish@gmail.com&lt;/a&gt; PTAL.&lt;/p&gt;</comment>
                            <comment id="17688033" author="rangadi" created="Mon, 13 Feb 2023 17:11:15 +0000"  >&lt;p&gt;I am working on a fix.&lt;/p&gt;</comment>
                            <comment id="17688366" author="apachespark" created="Tue, 14 Feb 2023 08:42:47 +0000"  >&lt;p&gt;User &apos;rangadi&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/40011&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/40011&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17688742" author="gengliang.wang" created="Tue, 14 Feb 2023 23:12:41 +0000"  >&lt;p&gt;Issue resolved by pull request 40011&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/40011&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/40011&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17688752" author="rangadi" created="Tue, 14 Feb 2023 23:48:42 +0000"  >&lt;p&gt;Thanks for merging &lt;a href=&quot;https://github.com/apache/spark/pull/40011&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/40011&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Keeping this ticket open to fix the issue with &apos;nullType&apos; and delta.&lt;/p&gt;</comment>
                            <comment id="17690837" author="apachespark" created="Sun, 19 Feb 2023 05:16:28 +0000"  >&lt;p&gt;User &apos;rangadi&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/40080&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/40080&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17690838" author="apachespark" created="Sun, 19 Feb 2023 05:16:43 +0000"  >&lt;p&gt;User &apos;rangadi&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/40080&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/40080&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17691857" author="gengliang.wang" created="Wed, 22 Feb 2023 01:35:54 +0000"  >&lt;p&gt;Resolved in &lt;a href=&quot;https://github.com/apache/spark/pull/40080&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/40080&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17692592" author="rangadi" created="Thu, 23 Feb 2023 09:04:17 +0000"  >&lt;p&gt;The main for still to be merged.&lt;/p&gt;</comment>
                            <comment id="17692607" author="apachespark" created="Thu, 23 Feb 2023 09:41:57 +0000"  >&lt;p&gt;User &apos;rangadi&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/40141&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/40141&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17694303" author="gengliang.wang" created="Tue, 28 Feb 2023 04:45:01 +0000"  >&lt;p&gt;Issue resolved by pull request 40141&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/40141&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/40141&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 37 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1fv9k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>