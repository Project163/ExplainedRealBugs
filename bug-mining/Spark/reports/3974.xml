<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:46:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-16883] SQL decimal type is not properly cast to number when collecting SparkDataFrame</title>
                <link>https://issues.apache.org/jira/browse/SPARK-16883</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;To reproduce run following code. As you can see &quot;y&quot; is a list of values.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;registerTempTable(createDataFrame(iris), &lt;span class=&quot;code-quote&quot;&gt;&quot;iris&quot;&lt;/span&gt;)
str(collect(sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt; as &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;) as x, &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&apos;2&apos;&lt;/span&gt; as decimal) as y  from iris limit 5&quot;&lt;/span&gt;)))

&lt;span class=&quot;code-quote&quot;&gt;&apos;data.frame&apos;&lt;/span&gt;:	5 obs. of  2 variables:
 $ x: num  1 1 1 1 1
 $ y:List of 5
  ..$ : num 2
  ..$ : num 2
  ..$ : num 2
  ..$ : num 2
  ..$ : num 2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12994735">SPARK-16883</key>
            <summary>SQL decimal type is not properly cast to number when collecting SparkDataFrame</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="wm624">Miao Wang</assignee>
                                    <reporter username="falaki">Hossein Falaki</reporter>
                        <labels>
                    </labels>
                <created>Wed, 3 Aug 2016 22:53:50 +0000</created>
                <updated>Fri, 2 Sep 2016 16:28:44 +0000</updated>
                            <resolved>Fri, 2 Sep 2016 08:51:42 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.1</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                    <component>SparkR</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15408298" author="wm624" created="Thu, 4 Aug 2016 18:47:35 +0000"  >&lt;p&gt;I will take a look.&lt;/p&gt;</comment>
                            <comment id="15408611" author="wm624" created="Thu, 4 Aug 2016 22:56:14 +0000"  >&lt;p&gt;&amp;gt; test &amp;lt;- sql(&quot;select cast(&apos;1&apos; as double) as x, cast(&apos;2&apos; as decimal) as y  from iris limit 5&quot;)&lt;br/&gt;
&amp;gt; test&lt;br/&gt;
SparkDataFrame&lt;span class=&quot;error&quot;&gt;&amp;#91;x:double, y:decimal(10,0)&amp;#93;&lt;/span&gt;&lt;br/&gt;
&amp;gt; take(test, 5)&lt;br/&gt;
  x y&lt;br/&gt;
1 1 2&lt;br/&gt;
2 1 2&lt;br/&gt;
3 1 2&lt;br/&gt;
4 1 2&lt;br/&gt;
5 1 2&lt;br/&gt;
&amp;gt; test2 &amp;lt;- collect(sql(&quot;select cast(&apos;1&apos; as double) as x, cast(&apos;2&apos; as decimal) as y  from iris limit 5&quot;))&lt;br/&gt;
&amp;gt; test2&lt;br/&gt;
  x y&lt;br/&gt;
1 1 2&lt;br/&gt;
2 1 2&lt;br/&gt;
3 1 2&lt;br/&gt;
4 1 2&lt;br/&gt;
5 1 2&lt;br/&gt;
&amp;gt; str(test2)&lt;br/&gt;
&apos;data.frame&apos;:	5 obs. of  2 variables:&lt;br/&gt;
 $ x: num  1 1 1 1 1&lt;br/&gt;
 $ y:List of 5&lt;br/&gt;
  ..$ : num 2&lt;br/&gt;
  ..$ : num 2&lt;br/&gt;
  ..$ : num 2&lt;br/&gt;
  ..$ : num 2&lt;br/&gt;
  ..$ : num 2&lt;br/&gt;
&amp;gt; class(test2)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &quot;data.frame&quot;&lt;br/&gt;
&amp;gt; test2&lt;br/&gt;
  x y&lt;br/&gt;
1 1 2&lt;br/&gt;
2 1 2&lt;br/&gt;
3 1 2&lt;br/&gt;
4 1 2&lt;br/&gt;
5 1 2&lt;br/&gt;
&amp;gt; take(test2, 5)&lt;br/&gt;
Error in (function (classes, fdef, mtable)  : &lt;br/&gt;
  unable to find an inherited method for function &#8216;take&#8217; for signature &#8216;&quot;data.frame&quot;, &quot;numeric&quot;&#8217;&lt;br/&gt;
&amp;gt; test2&lt;br/&gt;
  x y&lt;br/&gt;
1 1 2&lt;br/&gt;
2 1 2&lt;br/&gt;
3 1 2&lt;br/&gt;
4 1 2&lt;br/&gt;
5 1 2&lt;br/&gt;
&amp;gt; class(test2)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &quot;data.frame&quot;&lt;/p&gt;

&lt;p&gt;It looks like str() function has some issue for decimal. &lt;/p&gt;</comment>
                            <comment id="15408621" author="falaki" created="Thu, 4 Aug 2016 23:05:42 +0000"  >&lt;p&gt;I think that is because we are not converting &lt;tt&gt;decimal&lt;/tt&gt; to a &lt;tt&gt;numeric&lt;/tt&gt; properly. In &lt;tt&gt;pkg/R/types.R&lt;/tt&gt; decimal is supposed to translate to numeric.&lt;/p&gt;</comment>
                            <comment id="15408916" author="wm624" created="Fri, 5 Aug 2016 05:41:02 +0000"  >&lt;p&gt;Right. I am trying to modify it. I will send a PR once I fix it.&lt;/p&gt;</comment>
                            <comment id="15408994" author="wm624" created="Fri, 5 Aug 2016 06:45:02 +0000"  >&lt;p&gt;I found the root cause. I am trying to propose a clean solution to handle this case.&lt;/p&gt;

&lt;p&gt;PRIMITIVE_TYPES &amp;lt;- as.environment(list(&lt;br/&gt;
...&lt;br/&gt;
  &quot;decimal&quot; = &quot;numeric&quot;,&lt;br/&gt;
...&lt;/p&gt;

&lt;p&gt;But when backend returns decimal(10, 0), it can&apos;t handle this type in collect() and coltypes().&lt;/p&gt;

&lt;p&gt;collect() won&apos;t throw Error, but print the list as shown in the above example.&lt;/p&gt;</comment>
                            <comment id="15409691" author="shivaram" created="Fri, 5 Aug 2016 16:42:40 +0000"  >&lt;p&gt;The thing to check then is how the serialization / deserialization is happening. That is in SerDe.scala we should be writing the Decimal out as numeric for this to work correctly&lt;/p&gt;</comment>
                            <comment id="15410105" author="falaki" created="Fri, 5 Aug 2016 21:32:36 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shivaram&quot; class=&quot;user-hover&quot; rel=&quot;shivaram&quot;&gt;shivaram&lt;/a&gt;! This may require changing the serialization. Who thought this might happen! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;</comment>
                            <comment id="15412057" author="wm624" created="Mon, 8 Aug 2016 16:43:49 +0000"  >&lt;p&gt;I can give a try.&lt;/p&gt;</comment>
                            <comment id="15414416" author="wm624" created="Tue, 9 Aug 2016 23:09:44 +0000"  >&lt;p&gt;I add some debug information in SerDe.scala, as shown below:&lt;br/&gt;
16/08/09 16:05:18 INFO SerDe: writeObject start&lt;br/&gt;
16/08/09 16:05:18 INFO SerDe: &lt;span class=&quot;error&quot;&gt;&amp;#91;x: double, y: decimal(10,0)&amp;#93;&lt;/span&gt;&lt;br/&gt;
16/08/09 16:05:18 INFO SerDe: writeObject end&lt;br/&gt;
16/08/09 16:05:18 INFO SerDe: writeType start&lt;br/&gt;
16/08/09 16:05:18 INFO SerDe: jobj&lt;br/&gt;
16/08/09 16:05:18 INFO SerDe: writeType end&lt;br/&gt;
16/08/09 16:05:18 INFO SerDe: writeObject start&lt;br/&gt;
16/08/09 16:05:18 INFO SerDe: StructType(StructField(x,DoubleType,true), StructField(y,DecimalType(10,0),true))&lt;br/&gt;
16/08/09 16:05:18 INFO SerDe: writeObject end&lt;br/&gt;
16/08/09 16:05:18 INFO SerDe: writeType start&lt;br/&gt;
16/08/09 16:05:18 INFO SerDe: jobj&lt;br/&gt;
16/08/09 16:05:18 INFO SerDe: writeType end&lt;/p&gt;

&lt;p&gt;It serializes the value as a Java object, which is correct. The problem is in the frontend (sparkR).&lt;/p&gt;

&lt;p&gt;To verify my guess, I simply add &quot;decimal(10,0)&quot; = &quot;numeric&quot; in the PRIMITIVE_TYPES mapping table. It works as below:&lt;br/&gt;
&apos;data.frame&apos;:	5 obs. of  2 variables:&lt;br/&gt;
 $ x: num  1 1 1 1 1&lt;br/&gt;
 $ y: num  2 2 2 2 2&lt;/p&gt;

&lt;p&gt;I think the right fix should be in the frontend by adding a handling function with regex to match special cases like decimal (10,0). In general, we should map decimal and decimal(x,y) to numeric. &lt;/p&gt;</comment>
                            <comment id="15414420" author="wm624" created="Tue, 9 Aug 2016 23:13:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shivaram&quot; class=&quot;user-hover&quot; rel=&quot;shivaram&quot;&gt;shivaram&lt;/a&gt; What do you think about my proposed solution?&lt;/p&gt;</comment>
                            <comment id="15414422" author="shivaram" created="Tue, 9 Aug 2016 23:14:12 +0000"  >&lt;p&gt;Hmm why do we want to serialize it as a java object here ? Can&apos;t we serialize it as a double similar to how BigDecimal is handled in &lt;a href=&quot;https://github.com/apache/spark/blob/b89b3a5c8e391fcaebe7ef3c77ef16bb9431d6ab/core/src/main/scala/org/apache/spark/api/r/SerDe.scala#L294&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/b89b3a5c8e391fcaebe7ef3c77ef16bb9431d6ab/core/src/main/scala/org/apache/spark/api/r/SerDe.scala#L294&lt;/a&gt; ?&lt;/p&gt;</comment>
                            <comment id="15414432" author="wm624" created="Tue, 9 Aug 2016 23:22:16 +0000"  >&lt;p&gt;I think it is because &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;x: double, y: decimal(10,0)&amp;#93;&lt;/span&gt;&lt;br/&gt;
StructType(StructField(x,DoubleType,true), StructField(y,DecimalType(10,0),true))&lt;/p&gt;

&lt;p&gt;does not match any type inside writeObject() and hit the default case.&lt;/p&gt;

&lt;p&gt;It is not serialized field by feild. &lt;/p&gt;</comment>
                            <comment id="15414446" author="shivaram" created="Tue, 9 Aug 2016 23:36:06 +0000"  >&lt;p&gt;Yeah I see that - The change I am proposing is to add another case inside writeObject to convert DecimalTypes to doubles using something like the function in &lt;a href=&quot;https://github.com/apache/spark/blob/master/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/expressions/Cast.scala#L344&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/expressions/Cast.scala#L344&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I guess the question is whether this change is more intrusive than the other one and how will this impact handling more types in the future. It&apos;ll be great if you can try out one or both of them and open a PR for more discussion.&lt;/p&gt;</comment>
                            <comment id="15414476" author="wm624" created="Wed, 10 Aug 2016 00:02:50 +0000"  >&lt;p&gt;OK.I will try both. For the frontend solution, I can create a special handling function which will be used for handling all special cases like decimal(10, 0) with return value of Boolean type. The callers will only change a little bit by calling this function when it is not the PRIMITIVE types. In the future, we can add more in this special function to handle other cases. These cases are those which are not Complex types but not covered by PRIMITIVE types mapping.&lt;/p&gt;

&lt;p&gt;For the second solution, I will make changes as you suggested. I will learn how serialize StructType(StructField(x,DoubleType,true), StructField(y,DecimalType(10,0),true)) by adding the value type. &lt;/p&gt;

&lt;p&gt;The second solution could be simpler, I guess.&lt;/p&gt;</comment>
                            <comment id="15418111" author="apachespark" created="Thu, 11 Aug 2016 23:26:04 +0000"  >&lt;p&gt;User &apos;wangmiao1981&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/14613&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/14613&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 14 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i31vpr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12336857">2.0.1</customfieldvalue>
    <customfieldvalue id="12335644">2.1.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>