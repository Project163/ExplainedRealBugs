<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:43:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-15317] JobProgressListener takes a huge amount of memory with iterative DataFrame program in local, standalone</title>
                <link>https://issues.apache.org/jira/browse/SPARK-15317</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;h2&gt;&lt;a name=&quot;TL%3BDR&quot;&gt;&lt;/a&gt;TL;DR&lt;/h2&gt;

&lt;p&gt;Running a small test locally, I found JobProgressListener consuming a huge amount of memory.  There are many tasks being run, but it is still surprising.  Summary, with details below:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Spark app: series of DataFrame joins&lt;/li&gt;
	&lt;li&gt;Issue: GC&lt;/li&gt;
	&lt;li&gt;Heap dump shows JobProgressListener taking 150 - 400MB, depending on the Spark mode/version&lt;/li&gt;
&lt;/ul&gt;


&lt;h2&gt;&lt;a name=&quot;Reproducingthisissue&quot;&gt;&lt;/a&gt;Reproducing this issue&lt;/h2&gt;

&lt;h3&gt;&lt;a name=&quot;Withmorecomplexcode&quot;&gt;&lt;/a&gt;With more complex code&lt;/h3&gt;

&lt;p&gt;The code which fails:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Here is a branch with the code snippet which fails: &lt;a href=&quot;https://github.com/jkbradley/spark/tree/18836174ab190d94800cc247f5519f3148822dce&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jkbradley/spark/tree/18836174ab190d94800cc247f5519f3148822dce&lt;/a&gt;
	&lt;ul&gt;
		&lt;li&gt;This is based on Spark commit hash: bb1362eb3b36b553dca246b95f59ba7fd8adcc8a&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Look at &lt;tt&gt;CC.scala&lt;/tt&gt;, which implements connected components using DataFrames: &lt;a href=&quot;https://github.com/jkbradley/spark/blob/18836174ab190d94800cc247f5519f3148822dce/mllib/src/main/scala/org/apache/spark/ml/CC.scala&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jkbradley/spark/blob/18836174ab190d94800cc247f5519f3148822dce/mllib/src/main/scala/org/apache/spark/ml/CC.scala&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In the spark shell, run:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.ml.CC
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.SQLContext
val sqlContext = SQLContext.getOrCreate(sc)
CC.runTest(sqlContext)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I have attached a file &lt;tt&gt;cc_traces.txt&lt;/tt&gt; with the stack traces from running &lt;tt&gt;runTest&lt;/tt&gt;.  Note that I sometimes had to run &lt;tt&gt;runTest&lt;/tt&gt; twice to cause the fatal exception.  This includes a trace for 1.6, which should run without modifications to &lt;tt&gt;CC.scala&lt;/tt&gt;.  These traces are from running in local mode.&lt;/p&gt;

&lt;p&gt;I used &lt;tt&gt;jmap&lt;/tt&gt; to dump the heap:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;local mode with 2.0: JobProgressListener took about 397 MB&lt;/li&gt;
	&lt;li&gt;standalone mode with 2.0: JobProgressListener took about 171 MB  (See attached screenshots from MemoryAnalyzer)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Both 1.6 and 2.0 exhibit this issue.  2.0 ran faster, and the issue (JobProgressListener allocation) seems more severe with 2.0, though it could just be that 2.0 makes more progress and runs more jobs.&lt;/p&gt;

&lt;h3&gt;&lt;a name=&quot;Withsimplercode&quot;&gt;&lt;/a&gt;With simpler code&lt;/h3&gt;

&lt;p&gt;I ran this with master (~Spark 2.0):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;val data = spark.range(0, 10000, 1, 10000)
data.cache().count()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The resulting heap dump:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;78MB for &lt;tt&gt;scala.tools.nsc.interpreter.ILoop$ILoopInterpreter&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;58MB for &lt;tt&gt;org.apache.spark.ui.jobs.JobProgressListener&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;80MB for &lt;tt&gt;io.netty.buffer.PoolChunk&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment>&lt;p&gt;Spark 2.0, local mode + standalone mode on MacBook Pro OSX 10.9&lt;/p&gt;</environment>
        <key id="12969659">SPARK-15317</key>
            <summary>JobProgressListener takes a huge amount of memory with iterative DataFrame program in local, standalone</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zsxwing">Shixiong Zhu</assignee>
                                    <reporter username="josephkb">Joseph K. Bradley</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 May 2016 21:23:46 +0000</created>
                <updated>Thu, 19 May 2016 23:34:46 +0000</updated>
                            <resolved>Thu, 19 May 2016 19:04:55 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15283344" author="josephkb" created="Sat, 14 May 2016 00:44:47 +0000"  >&lt;p&gt;Comparing 1.6 and 2.0 more carefully, this is definitely a &lt;b&gt;regression&lt;/b&gt; from 1.6 to 2.0.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;With 10K partitions
	&lt;ul&gt;
		&lt;li&gt;Dumped heap after graph creation hit 55K tasks.
		&lt;ul&gt;
			&lt;li&gt;With 1.6, this ran very quickly.  See &lt;tt&gt;compare-1.6-10Kpartitions.png&lt;/tt&gt;.&lt;/li&gt;
			&lt;li&gt;With 2.0, this took a long time.  See &lt;tt&gt;compare-2.0-10Kpartitions.png&lt;/tt&gt;.&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;With 16 partitions
	&lt;ul&gt;
		&lt;li&gt;Dumped heap after Iteration 5 finished.
		&lt;ul&gt;
			&lt;li&gt;With 1.6, this died on the first iteration, but from what looked like a different scaling issue.  (See attached file cc_traces.txt for the same error.)&lt;/li&gt;
			&lt;li&gt;With 2.0, this ran.  See &lt;tt&gt;compare-2.0-16partitions.png&lt;/tt&gt;.&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15287209" author="apachespark" created="Tue, 17 May 2016 18:30:04 +0000"  >&lt;p&gt;User &apos;zsxwing&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/13153&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/13153&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12971302">SPARK-15419</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12803949" name="cc_traces.txt" size="46979" author="josephkb" created="Fri, 13 May 2016 21:24:50 +0000"/>
                            <attachment id="12803985" name="compare-1.6-10Kpartitions.png" size="151211" author="josephkb" created="Sat, 14 May 2016 00:45:12 +0000"/>
                            <attachment id="12803987" name="compare-2.0-10Kpartitions.png" size="158097" author="josephkb" created="Sat, 14 May 2016 00:45:12 +0000"/>
                            <attachment id="12803986" name="compare-2.0-16partitions.png" size="167924" author="josephkb" created="Sat, 14 May 2016 00:45:12 +0000"/>
                            <attachment id="12803951" name="dump-standalone-2.0-1of4.png" size="171483" author="josephkb" created="Fri, 13 May 2016 21:32:07 +0000"/>
                            <attachment id="12803952" name="dump-standalone-2.0-2of4.png" size="163789" author="josephkb" created="Fri, 13 May 2016 21:32:07 +0000"/>
                            <attachment id="12803953" name="dump-standalone-2.0-3of4.png" size="193942" author="josephkb" created="Fri, 13 May 2016 21:32:07 +0000"/>
                            <attachment id="12803954" name="dump-standalone-2.0-4of4.png" size="181081" author="josephkb" created="Fri, 13 May 2016 21:32:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 27 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2xygv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12329449">2.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>