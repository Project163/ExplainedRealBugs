<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:04:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-26555] Thread safety issue causes createDataset to fail with misleading errors</title>
                <link>https://issues.apache.org/jira/browse/SPARK-26555</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;This can be replicated (~2% of the time) with&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.sql.Timestamp
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.concurrent.{Executors, Future}

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.SparkSession

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; scala.collection.mutable.ListBuffer
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; scala.concurrent.ExecutionContext
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; scala.util.Random

&lt;span class=&quot;code-keyword&quot;&gt;object&lt;/span&gt; Main {
  &lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; main(args: Array[String]): Unit = {
    &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; sparkSession = SparkSession.builder
      .getOrCreate()
    &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; sparkSession.implicits._

    &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; executor = Executors.newFixedThreadPool(1)
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;implicit&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; xc: ExecutionContext = ExecutionContext.fromExecutorService(executor)
      &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; futures = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ListBuffer[Future[_]]()

      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (i &amp;lt;- 1 to 3) {
        futures += executor.submit(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Runnable {
          &lt;span class=&quot;code-keyword&quot;&gt;override&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; run(): Unit = {
            &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; d = &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (Random.nextInt(2) == 0) Some(&lt;span class=&quot;code-quote&quot;&gt;&quot;d value&quot;&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; None
            &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; e = &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (Random.nextInt(2) == 0) Some(5.0) &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; None
            &lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; f = &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (Random.nextInt(2) == 0) Some(6.0) &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; None
            println(&lt;span class=&quot;code-quote&quot;&gt;&quot;DEBUG&quot;&lt;/span&gt;, d, e, f)
            sparkSession.createDataset(Seq(
              MyClass(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Timestamp(1L), &lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;c&quot;&lt;/span&gt;, d, e, f)
            ))
          }
        })
      }

      futures.foreach(_.get())
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
      println(&lt;span class=&quot;code-quote&quot;&gt;&quot;SHUTDOWN&quot;&lt;/span&gt;)
      executor.shutdown()
      sparkSession.stop()
    }
  }

  &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MyClass(
    a: Timestamp,
    b: String,
    c: String,
    d: Option[String],
    e: Option[Double],
    f: Option[Double]
  )
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So it will usually come up during&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-bash&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;code-object&quot;&gt;in&lt;/span&gt; $(seq 1 200); &lt;span class=&quot;code-object&quot;&gt;do&lt;/span&gt;
  echo &lt;span class=&quot;code-object&quot;&gt;$i&lt;/span&gt;
  spark-submit --master &lt;span class=&quot;code-object&quot;&gt;local&lt;/span&gt;[4] target/scala-2.11/spark-test_2.11-0.1.jar
&lt;span class=&quot;code-object&quot;&gt;done&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;causing a variety of possible errors, such as&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.util.concurrent.ExecutionException: scala.MatchError: scala.Option[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;] (of &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;scala.reflect.internal.Types$ClassArgsTypeRef)
        at java.util.concurrent.FutureTask.report(FutureTask.java:122)
Caused by: scala.MatchError: scala.Option[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;] (of &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;scala.reflect.internal.Types$ClassArgsTypeRef)
	at org.apache.spark.sql.catalyst.ScalaReflection$$anonfun$org$apache$spark$sql$catalyst$ScalaReflection$$deserializerFor$1.apply(ScalaReflection.scala:210)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;or&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.util.concurrent.ExecutionException: java.lang.UnsupportedOperationException: Schema &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; type scala.Option[scala.&lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;] is not supported
	at java.util.concurrent.FutureTask.report(FutureTask.java:122)
Caused by: java.lang.UnsupportedOperationException: Schema &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; type scala.Option[scala.&lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;] is not supported
	at org.apache.spark.sql.catalyst.ScalaReflection$$anonfun$schemaFor$1.apply(ScalaReflection.scala:789)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13207928">SPARK-26555</key>
            <summary>Thread safety issue causes createDataset to fail with misleading errors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mwlon">Martin Loncaric</assignee>
                                    <reporter username="mwlon">Martin Loncaric</reporter>
                        <labels>
                    </labels>
                <created>Mon, 7 Jan 2019 00:36:13 +0000</created>
                <updated>Mon, 12 Dec 2022 18:10:48 +0000</updated>
                            <resolved>Tue, 19 Mar 2019 10:23:31 +0000</resolved>
                                    <version>2.4.0</version>
                                    <fixVersion>2.4.4</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16735447" author="gurwls223" created="Mon, 7 Jan 2019 04:18:26 +0000"  >&lt;p&gt;Critical+ is usually reserved for committers. Please avoid to set this.&lt;/p&gt;</comment>
                            <comment id="16782146" author="srowen" created="Fri, 1 Mar 2019 22:04:21 +0000"  >&lt;p&gt;This doesn&apos;t look like a Spark bug. It comes up, I think, when your random data set has all &quot;None&quot; for a column. That&apos;s what the error indicates at least. That part of the code shouldn&apos;t have any shared state. Can you verify from your debug output?&lt;/p&gt;</comment>
                            <comment id="16782179" author="srowen" created="Fri, 1 Mar 2019 22:46:50 +0000"  >&lt;p&gt;Hm, I might have that backwards; might be when all are not None? at least, I have a strong suspicious it&apos;s to do with the data that gets generated in some runs. Maybe fix that at one data set and see if you can reproduce?&lt;/p&gt;</comment>
                            <comment id="16782185" author="mwlon" created="Fri, 1 Mar 2019 23:03:50 +0000"  >&lt;p&gt;Will try it out and report back&lt;/p&gt;</comment>
                            <comment id="16782239" author="mwlon" created="Sat, 2 Mar 2019 01:24:53 +0000"  >&lt;p&gt;I was able to replicate with both all rows in all optional columns as `Some()` and all rows in all optional columns as `None`.&lt;/p&gt;</comment>
                            <comment id="16782258" author="mwlon" created="Sat, 2 Mar 2019 02:50:17 +0000"  >&lt;p&gt;I can also replicate with different schemas containing Option.&lt;/p&gt;

&lt;p&gt;When I remove all Option columns from the schema, the sporadic failure goes away. This also never happens when I remove the concurrency.&lt;/p&gt;</comment>
                            <comment id="16782806" author="srowen" created="Sun, 3 Mar 2019 18:30:00 +0000"  >&lt;p&gt;To be clear, is there a data set that works only when not run in this concurrent loop? What I&apos;m reading here is simply that you generate datasets sometimes that (correctly, I believe) can&apos;t have their schema inferred.&lt;/p&gt;</comment>
                            <comment id="16782821" author="mwlon" created="Sun, 3 Mar 2019 18:55:27 +0000"  >&lt;p&gt;Yes - when I take away any randomness and use the same dataset every time (say, with Some(something) for each optional value), I still get this issue.&lt;/p&gt;

&lt;p&gt;I&apos;ve run this code in a couple different environments and obtained the same result, so you should be able to verify this as well.&lt;/p&gt;</comment>
                            <comment id="16788771" author="srowen" created="Sat, 9 Mar 2019 18:51:54 +0000"  >&lt;p&gt;What is the fixed data set that reproduces this, to be clear?&lt;br/&gt;
And you mean that if you run it once it works, but fails in parallel?&lt;/p&gt;</comment>
                            <comment id="16788773" author="mwlon" created="Sat, 9 Mar 2019 19:03:39 +0000"  >&lt;p&gt;You can literally try any dataset with Option&apos;s in the schema and replicate this issue. For example,&lt;/p&gt;

&lt;p&gt;sparkSession.createDataset(Seq(&lt;br/&gt;
              MyClass(new Timestamp(1L), &quot;b&quot;, &quot;c&quot;, Some(&quot;d&quot;), Some(1.0), Some(2.0))&lt;br/&gt;
))&lt;/p&gt;

&lt;p&gt;I think the code I left is pretty clear - it fails sometimes. Run it once, and it may or may not work. I don&apos;t run multiple spark-submit&apos;s in parallel.&lt;/p&gt;</comment>
                            <comment id="16792086" author="mwlon" created="Wed, 13 Mar 2019 20:26:05 +0000"  >&lt;p&gt;Update: I have proved that the issue lies in reflection thread safety issues in org.apache.spark.sql.catalyst.ScalaReflection: &lt;a href=&quot;https://stackoverflow.com/questions/55150590/thread-safety-in-scala-reflection-with-type-matching&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/55150590/thread-safety-in-scala-reflection-with-type-matching&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Investigating whether this can be fixed with different usage of the reflection library, or whether this is a scala issue.&lt;/p&gt;</comment>
                            <comment id="16792240" author="mwlon" created="Thu, 14 Mar 2019 01:44:36 +0000"  >&lt;p&gt;This is an existing issue with scala: &lt;a href=&quot;https://github.com/scala/bug/issues/10766&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/scala/bug/issues/10766&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16795946" author="cloud_fan" created="Tue, 19 Mar 2019 10:23:31 +0000"  >&lt;p&gt;Issue resolved by pull request 24085&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/24085&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/24085&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16834025" author="joshrosen" created="Mon, 6 May 2019 17:22:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt;, could&#160;we backport this to the 2.4.x series? It&apos;d be nice to have an LTS fix for users who can&apos;t immediately upgrade to 3.0.&lt;/p&gt;</comment>
                            <comment id="16834055" author="srowen" created="Mon, 6 May 2019 17:45:28 +0000"  >&lt;p&gt;I personally think it&apos;s OK to backport &amp;#8211; do you want to open a PR and go for it?&lt;/p&gt;</comment>
                            <comment id="16834203" author="joshrosen" created="Mon, 6 May 2019 21:18:13 +0000"  >&lt;p&gt;I won&apos;t be able to tackle a backport for at least a week, so this is up for grabs in case someone else wants to do it.&lt;/p&gt;

&lt;p&gt;If I do end up working on this then I&apos;ll loop back here to claim it.&lt;/p&gt;</comment>
                            <comment id="16868178" author="joshrosen" created="Thu, 20 Jun 2019 02:05:08 +0000"  >&lt;p&gt;Backported for 2.4.4 in &lt;a href=&quot;https://github.com/apache/spark/commit/ba7f61e25d58aa379f94a23b03503a25574529bc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/ba7f61e25d58aa379f94a23b03503a25574529bc&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13221374">SPARK-27150</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 21 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|u00k8g:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>