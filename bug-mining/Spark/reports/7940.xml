<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:26:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-27991] ShuffleBlockFetcherIterator should take Netty constant-factor overheads into account when limiting number of simultaneous block fetches</title>
                <link>https://issues.apache.org/jira/browse/SPARK-27991</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;ShuffleBlockFetcherIterator has logic to limit the number of simultaneous block fetches. By default, this logic tries to keep the number of outstanding block fetches &lt;a href=&quot;https://github.com/apache/spark/blob/v2.4.3/core/src/main/scala/org/apache/spark/storage/ShuffleBlockFetcherIterator.scala#L274&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;beneath a data size limit&lt;/a&gt;&#160;(&lt;tt&gt;maxBytesInFlight&lt;/tt&gt;). However, this limiting does not take fixed overheads into account: even though a remote block might be, say, 4KB, there are certain fixed-size internal overheads due to Netty buffer sizes which may cause the actual space requirements to be larger.&lt;/p&gt;

&lt;p&gt;As a result, if a map stage produces a huge number of extremely tiny blocks then we may see errors like&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.spark.shuffle.FetchFailedException: failed to allocate 16777216 &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;(s) of direct memory (used: 39325794304, max: 39325794304)
at org.apache.spark.storage.ShuffleBlockFetcherIterator.throwFetchFailedException(ShuffleBlockFetcherIterator.scala:554)
at org.apache.spark.storage.ShuffleBlockFetcherIterator.next(ShuffleBlockFetcherIterator.scala:485)
[...]
Caused by: io.netty.util.internal.OutOfDirectMemoryError: failed to allocate 16777216 &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;(s) of direct memory (used: 39325794304, max: 39325794304)
at io.netty.util.internal.PlatformDependent.incrementMemoryCounter(PlatformDependent.java:640)
at io.netty.util.internal.PlatformDependent.allocateDirectNoCleaner(PlatformDependent.java:594)
at io.netty.buffer.PoolArena$DirectArena.allocateDirect(PoolArena.java:764)
at io.netty.buffer.PoolArena$DirectArena.newChunk(PoolArena.java:740)
at io.netty.buffer.PoolArena.allocateNormal(PoolArena.java:244)
at io.netty.buffer.PoolArena.allocate(PoolArena.java:226)
at io.netty.buffer.PoolArena.allocate(PoolArena.java:146)
at io.netty.buffer.PooledByteBufAllocator.newDirectBuffer(PooledByteBufAllocator.java:324)
[...]&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-24989&quot; title=&quot;BlockFetcher should retry while getting OutOfDirectMemoryError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-24989&quot;&gt;&lt;del&gt;SPARK-24989&lt;/del&gt;&lt;/a&gt; is another report of this problem (but with a different proposed fix).&lt;/p&gt;

&lt;p&gt;This problem can currently be mitigated by setting &lt;tt&gt;spark.reducer.maxReqsInFlight&lt;/tt&gt; to some some non-IntMax value (&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-6166&quot; title=&quot;Limit number of in flight outbound requests for shuffle fetch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-6166&quot;&gt;&lt;del&gt;SPARK-6166&lt;/del&gt;&lt;/a&gt;), but this additional manual configuration step is cumbersome.&lt;/p&gt;

&lt;p&gt;Instead, I think that Spark should take these fixed overheads into account in the &lt;tt&gt;maxBytesInFlight&lt;/tt&gt; calculation: instead of using blocks&apos; actual sizes, use &lt;tt&gt;Math.min(blockSize, minimumNettyBufferSize)&lt;/tt&gt;.&#160;There might be some tricky details involved to make this work on all configurations (e.g. to use a different minimum when direct buffers are disabled, etc.), but I think the&#160;core idea behind the fix is pretty simple.&lt;/p&gt;

&lt;p&gt;This will improve Spark&apos;s stability and removes configuration / tuning burden from end users.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13238597">SPARK-27991</key>
            <summary>ShuffleBlockFetcherIterator should take Netty constant-factor overheads into account when limiting number of simultaneous block fetches</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Ngone51">wuyi</assignee>
                                    <reporter username="joshrosen">Josh Rosen</reporter>
                        <labels>
                    </labels>
                <created>Mon, 10 Jun 2019 17:24:25 +0000</created>
                <updated>Thu, 20 May 2021 04:28:33 +0000</updated>
                            <resolved>Thu, 20 May 2021 04:27:12 +0000</resolved>
                                    <version>2.4.0</version>
                                    <fixVersion>3.2.0</fixVersion>
                                    <component>Shuffle</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16882532" author="joshrosen" created="Thu, 11 Jul 2019 00:27:31 +0000"  >&lt;p&gt;I&apos;ve tried to come up with a standalone reproduction of this issue, but so far I&apos;ve been unable to find one that triggers this error. I&apos;ve tried creating jobs which run 10000+ mappers shuffling tiny blocks to a single reducer, resulting in thousands of requests in flight, but this has failed to trigger the error posted above.&lt;/p&gt;

&lt;p&gt;However, I&#160;&lt;em&gt;did&lt;/em&gt; manage to get a more complete backtrace from a different internal&#160;workload:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: io.netty.util.internal.OutOfDirectMemoryError: failed to allocate 16777216 &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;(s) of direct memory (used: 7918845952, max: 7923040256)
	at io.netty.util.internal.PlatformDependent.incrementMemoryCounter(PlatformDependent.java:640)
	at io.netty.util.internal.PlatformDependent.allocateDirectNoCleaner(PlatformDependent.java:594)
	at io.netty.buffer.PoolArena$DirectArena.allocateDirect(PoolArena.java:764)
	at io.netty.buffer.PoolArena$DirectArena.newChunk(PoolArena.java:740)
	at io.netty.buffer.PoolArena.allocateNormal(PoolArena.java:244)
	at io.netty.buffer.PoolArena.allocate(PoolArena.java:226)
	at io.netty.buffer.PoolArena.allocate(PoolArena.java:146)
	at io.netty.buffer.PooledByteBufAllocator.newDirectBuffer(PooledByteBufAllocator.java:324)
	at io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:185)
	at io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:176)
	at io.netty.buffer.AbstractByteBufAllocator.ioBuffer(AbstractByteBufAllocator.java:137)
	at io.netty.channel.DefaultMaxMessagesRecvByteBufAllocator$MaxMessageHandle.allocate(DefaultMaxMessagesRecvByteBufAllocator.java:80)
	at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:122)
	at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:645)
	at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:580)
	at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:497)
	at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:459)
	at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:858)
	at io.netty.util.concurrent.DefaultThreadFactory$DefaultRunnableDecorator.run(DefaultThreadFactory.java:138)
	... 1 more&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Something that jumps out to me is the &lt;tt&gt;DefaultMaxMessagesRecvByteBufAllocator&lt;/tt&gt; (and the &lt;tt&gt;AdaptiveRecvByteBufAllocator&lt;/tt&gt;&#160;in&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-24989&quot; title=&quot;BlockFetcher should retry while getting OutOfDirectMemoryError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-24989&quot;&gt;&lt;del&gt;SPARK-24989&lt;/del&gt;&lt;/a&gt;): maybe there&apos;s something about these failing workloads which is leading to significant space wasting in receive buffers, causing tiny blocks to experience huge&#160;bloat in space requirements?&lt;/p&gt;</comment>
                            <comment id="17327118" author="apachespark" created="Thu, 22 Apr 2021 05:50:26 +0000"  >&lt;p&gt;User &apos;Ngone51&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32287&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32287&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17327119" author="apachespark" created="Thu, 22 Apr 2021 05:50:42 +0000"  >&lt;p&gt;User &apos;Ngone51&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32287&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32287&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17348045" author="cloud_fan" created="Thu, 20 May 2021 04:27:12 +0000"  >&lt;p&gt;Issue resolved by pull request 32287&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32287&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32287&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13176177">SPARK-24989</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 25 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z03l94:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>