<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:26:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-35106] HadoopMapReduceCommitProtocol performs bad rename when dynamic partition overwrite is used</title>
                <link>https://issues.apache.org/jira/browse/SPARK-35106</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Recently when evaluating the code in &lt;tt&gt;HadoopMapReduceCommitProtocol#commitJob&lt;/tt&gt;, I found some bad codepath under the &lt;tt&gt;dynamicPartitionOverwrite == true&lt;/tt&gt; scenario:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      # BLOCK 1
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (dynamicPartitionOverwrite) {
        val absPartitionPaths = filesToMove.values.map(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(_).getParent).toSet
        logDebug(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Clean up absolute partition directories &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; overwriting: $absPartitionPaths&quot;&lt;/span&gt;)
        absPartitionPaths.foreach(fs.delete(_, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;))
      }
      # BLOCK 2
      &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; ((src, dst) &amp;lt;- filesToMove) {
        fs.rename(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(src), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(dst))
      }

      # BLOCK 3
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (dynamicPartitionOverwrite) {
        val partitionPaths = allPartitionPaths.foldLeft(Set[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;]())(_ ++ _)
        logDebug(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Clean up &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; partition directories &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; overwriting: $partitionPaths&quot;&lt;/span&gt;)
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (part &amp;lt;- partitionPaths) {
          val finalPartPath = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(path, part)
          &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!fs.delete(finalPartPath, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) &amp;amp;&amp;amp; !fs.exists(finalPartPath.getParent)) {
            &lt;span class=&quot;code-comment&quot;&gt;// According to the official hadoop FileSystem API spec, delete op should assume
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// the destination is no longer present regardless of &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; value, thus we &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// need to &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; finalPartPath exists before rename.
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// Also in our &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;, based on the spec, delete returns &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; only when finalPartPath
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// does not exist. When &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; happens, we need to take action &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; parent of finalPartPath
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// also does not exist(e.g. the scenario described on SPARK-23815), because
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// FileSystem API spec on rename op says the rename dest(finalPartPath) must have
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// a parent that exists, otherwise we may get unexpected result on the rename.
&lt;/span&gt;            fs.mkdirs(finalPartPath.getParent)
          }
          fs.rename(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Path(stagingDir, part), finalPartPath)
        }
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Assuming &lt;tt&gt;dynamicPartitionOverwrite == true&lt;/tt&gt;, we have the following sequence of events:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Block 1 deletes all parent directories of &lt;tt&gt;filesToMove.values&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Block 2 attempts to rename all &lt;tt&gt;filesToMove.keys&lt;/tt&gt; to &lt;tt&gt;filesToMove.values&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Block 3 does directory-level renames to place files into their final locations&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;All renames in Block 2 will always fail, since all parent directories of &lt;tt&gt;filesToMove.values&lt;/tt&gt; were just deleted in Block 1. Under a normal HDFS scenario, the contract of &lt;tt&gt;fs.rename&lt;/tt&gt; is to return &lt;tt&gt;false&lt;/tt&gt; under such a failure scenario, as opposed to throwing an exception. There is a separate issue here that Block 2 should probably be checking for those &lt;tt&gt;false&lt;/tt&gt; return values &amp;#8211; but this allows for &lt;tt&gt;dynamicPartitionOverwrite&lt;/tt&gt; to &quot;work&quot;, albeit with a bunch of failed renames in the middle. Really, we should only run Block 2 in the &lt;tt&gt;dynamicPartitionOverwrite == false&lt;/tt&gt; case, and consolidate Blocks 1 and 3 to run in the &lt;tt&gt;true&lt;/tt&gt; case.&lt;/p&gt;

&lt;p&gt;We discovered this issue when testing against a &lt;tt&gt;FileSystem&lt;/tt&gt; implementation which was throwing an exception for this failed rename scenario instead of returning false, escalating the silent/ignored rename failures into actual failures.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13373062">SPARK-35106</key>
            <summary>HadoopMapReduceCommitProtocol performs bad rename when dynamic partition overwrite is used</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yuzhousun">Yuzhou Sun</assignee>
                                    <reporter username="xkrogen">Erik Krogen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 16 Apr 2021 16:04:02 +0000</created>
                <updated>Fri, 24 Sep 2021 22:38:08 +0000</updated>
                            <resolved>Wed, 19 May 2021 07:47:38 +0000</resolved>
                                    <version>3.1.1</version>
                                    <fixVersion>3.0.3</fixVersion>
                    <fixVersion>3.1.2</fixVersion>
                    <fixVersion>3.2.0</fixVersion>
                                    <component>Input/Output</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17323924" author="apachespark" created="Fri, 16 Apr 2021 16:15:47 +0000"  >&lt;p&gt;User &apos;xkrogen&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32207&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32207&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17343654" author="apachespark" created="Thu, 13 May 2021 01:40:36 +0000"  >&lt;p&gt;User &apos;YuzhouSun&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32529&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32529&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17343655" author="apachespark" created="Thu, 13 May 2021 01:40:45 +0000"  >&lt;p&gt;User &apos;YuzhouSun&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32529&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32529&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17343669" author="apachespark" created="Thu, 13 May 2021 03:09:28 +0000"  >&lt;p&gt;User &apos;YuzhouSun&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32530&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32530&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17343670" author="apachespark" created="Thu, 13 May 2021 03:10:32 +0000"  >&lt;p&gt;User &apos;YuzhouSun&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32530&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32530&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17347379" author="cloud_fan" created="Wed, 19 May 2021 07:47:38 +0000"  >&lt;p&gt;Issue resolved by pull request 32530&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32530&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32530&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17348033" author="yuzhousun" created="Thu, 20 May 2021 03:36:03 +0000"  >&lt;p&gt;Thanks Erik and Wenchen for&#160;initializing and reviewing the fix!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 25 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0q3zs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>