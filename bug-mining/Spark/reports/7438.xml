<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:19:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-32638] WidenSetOperationTypes in subquery  attribute  missing</title>
                <link>https://issues.apache.org/jira/browse/SPARK-32638</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I am migrating sql from mysql to spark sql, meet a very strange case. Below is code to reproduce the exception:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val spark = SparkSession.builder()
 .master(&lt;span class=&quot;code-quote&quot;&gt;&quot;local&quot;&lt;/span&gt;)
 .appName(&lt;span class=&quot;code-quote&quot;&gt;&quot;Word Count&quot;&lt;/span&gt;)
 .getOrCreate()
spark.sparkContext.setLogLevel(&lt;span class=&quot;code-quote&quot;&gt;&quot;TRACE&quot;&lt;/span&gt;)
val DecimalType = DataTypes.createDecimalType(20, 2)
val schema = StructType(List(
 StructField(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;, DecimalType, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
))
val dataList = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; util.ArrayList[Row]()


val df=spark.createDataFrame(dataList,schema)
df.printSchema()
df.createTempView(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;)
val sql=
 &quot;&quot;&quot;
 |SELECT t.kpi_04 FROM
 |(
 | SELECT a as `kpi_04` FROM test
 | UNION ALL
 | SELECT a+a as `kpi_04` FROM test
 |) t
 |
 &quot;&quot;&quot;.stripMargin
spark.sql(sql)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Exception Message:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; org.apache.spark.sql.AnalysisException: Resolved attribute(s) kpi_04#2 missing from kpi_04#4 in &lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt; !Project [kpi_04#2]. Attribute(s) with the same name appear in the operation: kpi_04. Please check &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the right attribute(s) are used.;;
!Project [kpi_04#2]
+- SubqueryAlias t
 +- Union
 :- Project [&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(kpi_04#2 as decimal(21,2)) AS kpi_04#4]
 : +- Project [a#0 AS kpi_04#2]
 : +- SubqueryAlias test
 : +- LocalRelation &amp;lt;empty&amp;gt;, [a#0]
 +- Project [kpi_04#3]
 +- Project [CheckOverflow((promote_precision(&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(a#0 as decimal(21,2))) + promote_precision(&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(a#0 as decimal(21,2)))), DecimalType(21,2)) AS kpi_04#3]
 +- SubqueryAlias test
 +- LocalRelation &amp;lt;empty&amp;gt;, [a#0]&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Base the trace log ,seemly the&#160;WidenSetOperationTypes add new outer project layer. It caused the parent query lose the reference to subquery.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160;
=== Applying Rule org.apache.spark.sql.catalyst.analysis.TypeCoercion$WidenSetOperationTypes ===
!&apos;Project [kpi_04#2] !Project [kpi_04#2]
!+- &apos;SubqueryAlias t +- SubqueryAlias t
! +- &apos;Union +- Union
! :- Project [a#0 AS kpi_04#2] :- Project [&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(kpi_04#2 as decimal(21,2)) AS kpi_04#4]
! : +- SubqueryAlias test : +- Project [a#0 AS kpi_04#2]
! : +- LocalRelation &amp;lt;empty&amp;gt;, [a#0] : +- SubqueryAlias test
! +- Project [CheckOverflow((promote_precision(&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(a#0 as decimal(21,2))) + promote_precision(&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(a#0 as decimal(21,2)))), DecimalType(21,2)) AS kpi_04#3] : +- LocalRelation &amp;lt;empty&amp;gt;, [a#0]
! +- SubqueryAlias test +- Project [kpi_04#3]
! +- LocalRelation &amp;lt;empty&amp;gt;, [a#0] +- Project [CheckOverflow((promote_precision(&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(a#0 as decimal(21,2))) + promote_precision(&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(a#0 as decimal(21,2)))), DecimalType(21,2)) AS kpi_04#3]
! +- SubqueryAlias test
! +- LocalRelation &amp;lt;empty&amp;gt;, [a#0]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160; in the source code ,WidenSetOperationTypes.scala. it is&#160; a intent behavior, but&#160; possibly&#160; miss this edge case.&#160;&lt;/p&gt;

&lt;p&gt;I hope someone can help me out to fix it .&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (targetTypes.nonEmpty) {
 &lt;span class=&quot;code-comment&quot;&gt;// Add an extra Project &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; the targetTypes are different from the original types.
&lt;/span&gt; children.map(widenTypes(_, targetTypes))
} &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
 &lt;span class=&quot;code-comment&quot;&gt;// Unable to find a target type to widen, then just &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; the original set.
&lt;/span&gt; children
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13323034">SPARK-32638</key>
            <summary>WidenSetOperationTypes in subquery  attribute  missing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="maropu">Takeshi Yamamuro</assignee>
                                    <reporter username="kkyong">Guojian Li</reporter>
                        <labels>
                    </labels>
                <created>Mon, 17 Aug 2020 11:16:25 +0000</created>
                <updated>Tue, 8 Sep 2020 23:23:27 +0000</updated>
                            <resolved>Thu, 3 Sep 2020 14:49:38 +0000</resolved>
                                    <version>2.3.4</version>
                    <version>2.4.5</version>
                    <version>3.0.0</version>
                                    <fixVersion>3.0.2</fixVersion>
                    <fixVersion>3.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17179536" author="cloud_fan" created="Tue, 18 Aug 2020 10:39:28 +0000"  >&lt;p&gt;2.3 is not maintained anymore, can you check with 2.4/3.0/master?&lt;/p&gt;</comment>
                            <comment id="17180365" author="cltlfcjin" created="Wed, 19 Aug 2020 08:46:19 +0000"  >&lt;p&gt;Yes. This problem exists in 3.0 and master.&lt;/p&gt;

&lt;p&gt;The problem occurs follow these steps:&lt;br/&gt;
In ResolveReference.apply()&lt;br/&gt;
When resolving the Project, its children are all resolved&lt;br/&gt;
&apos;Project &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;#39;t.kpi_04&amp;#93;&lt;/span&gt;&lt;br/&gt;
+- SubqueryAlias t&lt;br/&gt;
   +- Union&lt;br/&gt;
      :- Project &lt;a href=&quot;#44 AS kpi_04#46&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;a#44 AS kpi_04#46&lt;/a&gt;&lt;br/&gt;
      :  +- SubqueryAlias test&lt;br/&gt;
      :     +- LocalRelation &amp;lt;empty&amp;gt;, &lt;a href=&quot;#44&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;a#44&lt;/a&gt;&lt;br/&gt;
      +- Project &lt;a href=&quot;#44 + a#44) AS kpi_04#47&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;(a#44 + a#44) AS kpi_04#47&lt;/a&gt;&lt;br/&gt;
         +- SubqueryAlias test&lt;br/&gt;
            +- LocalRelation &amp;lt;empty&amp;gt;, &lt;a href=&quot;#44&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;a#44&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;-&amp;gt; &lt;br/&gt;
Project &lt;a href=&quot;#46&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;kpi_04#46&lt;/a&gt;&lt;br/&gt;
+- SubqueryAlias t&lt;br/&gt;
   +- Union&lt;br/&gt;
      :- Project &lt;a href=&quot;#44 AS kpi_04#46&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;a#44 AS kpi_04#46&lt;/a&gt;&lt;br/&gt;
      :  +- SubqueryAlias test&lt;br/&gt;
      :     +- LocalRelation &amp;lt;empty&amp;gt;, &lt;a href=&quot;#44&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;a#44&lt;/a&gt;&lt;br/&gt;
      +- Project &lt;a href=&quot;#44 + a#44) AS kpi_04#47&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;(a#44 + a#44) AS kpi_04#47&lt;/a&gt;&lt;br/&gt;
         +- SubqueryAlias test&lt;br/&gt;
            +- LocalRelation &amp;lt;empty&amp;gt;, &lt;a href=&quot;#44&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;a#44&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;After Project resolved. It child Union changes the children by WidenSetOperationTypes.&lt;/p&gt;

&lt;p&gt;In the next iteration, Project won&apos;t be resolved again.&lt;br/&gt;
!Project &lt;a href=&quot;#46&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;kpi_04#46&lt;/a&gt;&lt;br/&gt;
+- SubqueryAlias t&lt;br/&gt;
   +- Union&lt;br/&gt;
      :- Project &lt;a href=&quot;#46 as decimal(22,1)) AS kpi_04#48&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;cast(kpi_04#46 as decimal(22,1)) AS kpi_04#48&lt;/a&gt;&lt;br/&gt;
      :  +- Project &lt;a href=&quot;#44 AS kpi_04#46&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;a#44 AS kpi_04#46&lt;/a&gt;&lt;br/&gt;
      :     +- SubqueryAlias test&lt;br/&gt;
      :        +- LocalRelation &amp;lt;empty&amp;gt;, &lt;a href=&quot;#44&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;a#44&lt;/a&gt;&lt;br/&gt;
      +- Project &lt;a href=&quot;#47&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;kpi_04#47&lt;/a&gt;&lt;br/&gt;
         +- Project &lt;a href=&quot;#44 as decimal(22,1))) + promote_precision(cast(a#44 as decimal(22,1)))), DecimalType(22,1), true) AS kpi_04#47&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;CheckOverflow((promote_precision(cast(a#44 as decimal(22,1))) + promote_precision(cast(a#44 as decimal(22,1)))), DecimalType(22,1), true) AS kpi_04#47&lt;/a&gt;&lt;br/&gt;
            +- SubqueryAlias test&lt;br/&gt;
               +- LocalRelation &amp;lt;empty&amp;gt;, &lt;a href=&quot;#44&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;a#44&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17180373" author="kkyong" created="Wed, 19 Aug 2020 08:55:55 +0000"  >&lt;p&gt;I reproduce it on 2.4.5 .&#160; and find&#160; it was reported before on&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-18622&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-18622&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;But developer just fix it&#160; by changing out type&#160; not the suggesting solution .&#160; &#160;When WidenSetOperationTypes adding extra new project , it need to&#160; make sure the existing reference still valid.&#160; &#160;&lt;/p&gt;

&lt;p&gt;the issue is too hard for me to fix ,&#160; really hope&#160; some guys can help me out .&#160; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17180415" author="maropu" created="Wed, 19 Aug 2020 09:50:21 +0000"  >&lt;p&gt;Looks like a minor bug. I&apos;ll make a PR later.&lt;/p&gt;</comment>
                            <comment id="17180985" author="apachespark" created="Thu, 20 Aug 2020 06:50:14 +0000"  >&lt;p&gt;User &apos;maropu&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29485&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29485&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17190191" author="cloud_fan" created="Thu, 3 Sep 2020 14:49:38 +0000"  >&lt;p&gt;Issue resolved by pull request 29485&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29485&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29485&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17190340" author="apachespark" created="Thu, 3 Sep 2020 18:05:26 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29643&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29643&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17190341" author="apachespark" created="Thu, 3 Sep 2020 18:06:27 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29643&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29643&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17192110" author="apachespark" created="Tue, 8 Sep 2020 10:13:58 +0000"  >&lt;p&gt;User &apos;maropu&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29680&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29680&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17192111" author="apachespark" created="Tue, 8 Sep 2020 10:14:10 +0000"  >&lt;p&gt;User &apos;maropu&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/29680&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/29680&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 10 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0hts8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>