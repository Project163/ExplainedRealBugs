<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:31:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-41344] Reading V2 datasource masks underlying error</title>
                <link>https://issues.apache.org/jira/browse/SPARK-41344</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;In Spark 3.3,&#160;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;DataSourceV2Utils, the loadV2Source calls: &lt;b&gt;(CatalogV2Util.loadTable(catalog, ident, timeTravel).get&lt;/b&gt;, Some(catalog), Some(ident)).&lt;/li&gt;
	&lt;li&gt;CatalogV2Util.scala, when it tries to &lt;b&gt;loadTable(x,x,x)&lt;/b&gt;&#160;and it fails with any of these exceptions NoSuchTableException, NoSuchDatabaseException, NoSuchNamespaceException, it would return None&lt;/li&gt;
	&lt;li&gt;Coming back to DataSourceV2Utils, None was previously returned and calling None.get results in a cryptic error technically &quot;correct&quot;, but the &lt;b&gt;original exceptions NoSuchTableException, NoSuchDatabaseException, NoSuchNamespaceException are thrown away.&lt;/b&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Ask:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Retain the original error and propagate this to the user. Prior to Spark 3.3, the&#160;&lt;b&gt;original error&lt;/b&gt; was shown and this seems like a design flaw.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Sample user facing error:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;None.get&lt;br/&gt;
java.util.NoSuchElementException: None.get&lt;br/&gt;
&#160; &#160; at scala.None$.get(Option.scala:529)&lt;br/&gt;
&#160; &#160; at scala.None$.get(Option.scala:527)&lt;br/&gt;
&#160; &#160; at org.apache.spark.sql.execution.datasources.v2.DataSourceV2Utils$.loadV2Source(DataSourceV2Utils.scala:129)&lt;br/&gt;
&#160; &#160; at org.apache.spark.sql.DataFrameReader.$anonfun$load$1(DataFrameReader.scala:209)&lt;br/&gt;
&#160; &#160; at scala.Option.flatMap(Option.scala:271)&lt;br/&gt;
&#160; &#160; at org.apache.spark.sql.DataFrameReader.load(DataFrameReader.scala:207)&lt;br/&gt;
&#160; &#160; at org.apache.spark.sql.DataFrameReader.load(DataFrameReader.scala:171)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;DataSourceV2Utils.scala - CatalogV2Util.loadTable(x,x,x).get&lt;/b&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/blob/7fd654c0142ab9e4002882da4e65d3b25bebd26c/sql/core/src/main/scala/org/apache/spark/sql/execution/datasources/v2/DataSourceV2Utils.scala#L137&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/7fd654c0142ab9e4002882da4e65d3b25bebd26c/sql/core/src/main/scala/org/apache/spark/sql/execution/datasources/v2/DataSourceV2Utils.scala#L137&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;CatalogV2Util.scala - Option(catalog.asTableCatalog.loadTable(ident))&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;{&lt;/b&gt;}&lt;a href=&quot;https://github.com/apache/spark/blob/7fd654c0142ab9e4002882da4e65d3b25bebd26c/sql/catalyst/src/main/scala/org/apache/spark/sql/connector/catalog/CatalogV2Util.scala#L341&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/7fd654c0142ab9e4002882da4e65d3b25bebd26c/sql/catalyst/src/main/scala/org/apache/spark/sql/connector/catalog/CatalogV2Util.scala#L341&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;CatalogV2Util.scala - catching the exceptions and return None&lt;/b&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/blob/7fd654c0142ab9e4002882da4e65d3b25bebd26c/sql/catalyst/src/main/scala/org/apache/spark/sql/connector/catalog/CatalogV2Util.scala#L344&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/7fd654c0142ab9e4002882da4e65d3b25bebd26c/sql/catalyst/src/main/scala/org/apache/spark/sql/connector/catalog/CatalogV2Util.scala#L344&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13507725">SPARK-41344</key>
            <summary>Reading V2 datasource masks underlying error</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="wforget">Zhen Wang</assignee>
                                    <reporter username="kecheung">Kevin Cheung</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 1 Dec 2022 01:08:16 +0000</created>
                <updated>Tue, 19 Nov 2024 11:09:48 +0000</updated>
                            <resolved>Thu, 29 Dec 2022 11:27:39 +0000</resolved>
                                    <version>3.3.0</version>
                    <version>3.3.1</version>
                    <version>3.4.0</version>
                                    <fixVersion>3.4.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17641606" author="kecheung" created="Thu, 1 Dec 2022 01:10:12 +0000"  >&lt;p&gt;Github link that is causing the issue&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/commit/feba05f181f594b53cf9c832cd44b00be2646938&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/feba05f181f594b53cf9c832cd44b00be2646938&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17641611" author="gurwls223" created="Thu, 1 Dec 2022 01:33:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kecheung&quot; class=&quot;user-hover&quot; rel=&quot;kecheung&quot;&gt;kecheung&lt;/a&gt; are you interested in submitting a PR?&lt;/p&gt;</comment>
                            <comment id="17641666" author="kecheung" created="Thu, 1 Dec 2022 04:56:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hyukjin.kwon&quot; class=&quot;user-hover&quot; rel=&quot;hyukjin.kwon&quot;&gt;hyukjin.kwon&lt;/a&gt; I currently don&apos;t have the bandwidth for this at the moment. I noticed this issue when I was upgrading a connector to spark 3.3. So I did the investigation and concluded that this looks like a design issue since users will never know what&apos;s the &quot;real&quot; error should they face NoSuchTableException, NoSuchDatabaseException, NoSuchNamespaceException.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Hopefully someone who&apos;s familiar or has extra time can investigate the fix further.&lt;/p&gt;</comment>
                            <comment id="17642298" author="wforget" created="Fri, 2 Dec 2022 06:01:05 +0000"  >&lt;p&gt;I want to work on this and will send a PR later.&lt;/p&gt;</comment>
                            <comment id="17642303" author="apachespark" created="Fri, 2 Dec 2022 06:07:16 +0000"  >&lt;p&gt;User &apos;wForget&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/38871&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/38871&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17642304" author="apachespark" created="Fri, 2 Dec 2022 06:07:24 +0000"  >&lt;p&gt;User &apos;wForget&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/38871&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/38871&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17642877" author="ganaakruti" created="Sat, 3 Dec 2022 17:09:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wforget&quot; class=&quot;user-hover&quot; rel=&quot;wforget&quot;&gt;wforget&lt;/a&gt; - wondering if we could get a return type of Try&lt;span class=&quot;error&quot;&gt;&amp;#91;_&amp;#93;&lt;/span&gt; instead of Option&lt;span class=&quot;error&quot;&gt;&amp;#91;_&amp;#93;&lt;/span&gt; -&amp;gt; None (which is what we get in case of error at this point).&#160;&lt;/p&gt;

&lt;p&gt;The callee in this case, DataFrameReader, I see is applying `.getOrElse` to try v1 load. In this scenario, when the table or entity is not present at all, would it make sense to throw the error as soon the exception is caught instead of trying alternatives? I could be wrong, but like to ask this question. See below code in DataFrameReader -&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13053490/13053490_image-2022-12-03-09-24-43-285.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &#160;&lt;/p&gt;

&lt;p&gt;CC - &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kecheung&quot; class=&quot;user-hover&quot; rel=&quot;kecheung&quot;&gt;kecheung&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17643131" author="wforget" created="Mon, 5 Dec 2022 06:35:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ganaakruti&quot; class=&quot;user-hover&quot; rel=&quot;ganaakruti&quot;&gt;ganaakruti&lt;/a&gt;&#160; As far as I understand, V1 and V2 only have different implementations for data source operations, they should have the same tables view. The table that cannot be found in V2 should also not be found in V1.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=planga82&quot; class=&quot;user-hover&quot; rel=&quot;planga82&quot;&gt;planga82&lt;/a&gt; Could you please take a look?&lt;/p&gt;</comment>
                            <comment id="17644061" author="planga82" created="Tue, 6 Dec 2022 23:16:27 +0000"  >&lt;p&gt;In this case the provider has been detected as DataSourceV2 and also implements SupportsCatalogOptions, so if it fails at that point, it does not make sense to try it as DataSource V1.&lt;/p&gt;

&lt;p&gt;The CatalogV2Util.loadTable function catches NoSuchTableException, NoSuchDatabaseException and NoSuchNamespaceException to return an option, which makes sense in other places where it is used, but not at this point. Maybe the best solution is to have another function that does not catch those exceptions to use in this case and does not return an option.&lt;/p&gt;</comment>
                            <comment id="17644087" author="wforget" created="Wed, 7 Dec 2022 01:26:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=planga82&quot; class=&quot;user-hover&quot; rel=&quot;planga82&quot;&gt;planga82&lt;/a&gt;&#160; Thanks for your reply, I have submitted a PR &lt;a href=&quot;https://github.com/apache/spark/pull/38871&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/38871&lt;/a&gt;, can you help me review it?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&amp;gt; Maybe the best solution is to have another function that does not catch those exceptions to use in this case and does not return an option.&lt;/p&gt;

&lt;p&gt;Does this mean we need to add a new method in CatalogV2Util?&lt;/p&gt;</comment>
                            <comment id="17644492" author="kecheung" created="Wed, 7 Dec 2022 19:46:50 +0000"  >&lt;p&gt;+1 &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=planga82&quot; class=&quot;user-hover&quot; rel=&quot;planga82&quot;&gt;planga82&lt;/a&gt;. I like this approach of having another function so the real exception can be propagated&lt;/p&gt;</comment>
                            <comment id="17644498" author="kecheung" created="Wed, 7 Dec 2022 19:51:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wforget&quot; class=&quot;user-hover&quot; rel=&quot;wforget&quot;&gt;wforget&lt;/a&gt; I believe he just means duplicate CatalogV2Util.loadTable as a new function with signature CatalogV2Util.loadTableThrowsException : Table. The only difference would be you just don&apos;t catch the exceptions. Then change this to your new function (&lt;b&gt;CatalogV2Util.loadTableThrowsException(catalog, ident, timeTravel)&lt;/b&gt;, Some(catalog), Some(ident)). This solves the problem of masking the original exception&lt;/p&gt;</comment>
                            <comment id="17652813" author="gurwls223" created="Thu, 29 Dec 2022 11:27:39 +0000"  >&lt;p&gt;Issue resolved by pull request 38871&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/38871&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/38871&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310460">
                    <name>Child-Issue</name>
                                            <outwardlinks description="is a parent of">
                                        <issuelink>
            <issuekey id="13521838">SPARK-42222</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13384431">SPARK-35803</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13053490" name="image-2022-12-03-09-24-43-285.png" size="67238" author="ganaakruti" created="Sat, 3 Dec 2022 17:24:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 45 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1d1a0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>