<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:29:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-37290] Exponential planning time in case of non-deterministic function</title>
                <link>https://issues.apache.org/jira/browse/SPARK-37290</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;We are experiencing an exponential growth of processing time in case of some DataFrame queries including non-deterministic functions. I could create a small example program, which can be pasted into the Spark shell for reproducing the issue:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; adselect_raw = spark.createDataFrame(Seq((&lt;span class=&quot;code-quote&quot;&gt;&quot;imp-1&quot;&lt;/span&gt;,1),(&lt;span class=&quot;code-quote&quot;&gt;&quot;imp-2&quot;&lt;/span&gt;,2)))
    .cache()
&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; adselect = adselect_raw.select(
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;uuid()&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;userUuid&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;impressionUuid&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;accessDateTime&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;publisher&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;site&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;placement&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;advertiser&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;campaign&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;lineItem&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;creative&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;browserLanguage&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;geoLocode&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;osFamily&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;osName&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;browserName&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;referrerDomain&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;placementIabCategory&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;placementDeviceGroup&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;placementDevice&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;placementVideoType&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;placementSection&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;placementPlayer&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;demandType&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;techCosts&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;mediaCosts&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;directSPrice&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;network&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;deviceSetting&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;placementGroup&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;postalCode&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;householdId&quot;&lt;/span&gt;)
    )

&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; adcount_raw = spark.createDataFrame(Seq((&lt;span class=&quot;code-quote&quot;&gt;&quot;imp-1&quot;&lt;/span&gt;, 1), (&lt;span class=&quot;code-quote&quot;&gt;&quot;imp-2&quot;&lt;/span&gt;, 2)))
&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; adcount = adcount_raw.select(
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_1&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;impressionUuid&quot;&lt;/span&gt;),
        expr(&lt;span class=&quot;code-quote&quot;&gt;&quot;_2&quot;&lt;/span&gt;).alias(&lt;span class=&quot;code-quote&quot;&gt;&quot;accessDateTime&quot;&lt;/span&gt;)
    )

&lt;span class=&quot;code-keyword&quot;&gt;val&lt;/span&gt; result =  adselect.join(adcount, Seq(&lt;span class=&quot;code-quote&quot;&gt;&quot;impressionUuid&quot;&lt;/span&gt;))
result.explain()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Further reducing the program (for example by removing the join or the cache) did not show the problem any more.&lt;/p&gt;

&lt;p&gt;The problem occurs during planning time and debugging lead me to the function &lt;tt&gt;UnaryNode.getAllValidConstraints&lt;/tt&gt; where the local variable &lt;tt&gt;allConstraints&lt;/tt&gt; grew with an apparently exponential number of entries for the non-deterministic function &quot;&lt;tt&gt;uuid()&lt;/tt&gt;&quot; in the code example above. Every time a new column from the large select is processed in the &lt;tt&gt;foreach&lt;/tt&gt; loop in the function &lt;tt&gt;UnaryNode.getAllValidConstraints&lt;/tt&gt;, the number of entries for the &lt;tt&gt;uuid()&lt;/tt&gt; column in the ExpressionSet seems to be doubled:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-scala&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;trait&lt;/span&gt; UnaryNode &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; LogicalPlan &lt;span class=&quot;code-keyword&quot;&gt;with&lt;/span&gt; UnaryLike[LogicalPlan] {
  &lt;span class=&quot;code-keyword&quot;&gt;override&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; getAllValidConstraints(projectList: Seq[NamedExpression]): ExpressionSet = {
    &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; allConstraints = child.constraints
    projectList.foreach {
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; a @ Alias(l: Literal, _) =&amp;gt;
        allConstraints += EqualNullSafe(a.toAttribute, l)
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; a @ Alias(e, _) =&amp;gt;
        &lt;span class=&quot;code-comment&quot;&gt;// KK: Since the ExpressionSet handles each non-deterministic function as a separate entry, each &lt;span class=&quot;code-quote&quot;&gt;&quot;uuid()&quot;&lt;/span&gt; entry in allConstraints is re-added over an over again in every iteration, 
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// thereby doubling the list every time    
&lt;/span&gt;        allConstraints ++= allConstraints.map(_ transform {
          &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; expr: Expression &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; expr.semanticEquals(e) =&amp;gt;
            a.toAttribute
        })
        allConstraints += EqualNullSafe(e, a.toAttribute)
      &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; _ =&amp;gt; &lt;span class=&quot;code-comment&quot;&gt;// Don&apos;t change.
&lt;/span&gt;    }

    allConstraints
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;As a workaround, we moved the &lt;tt&gt;uuid()&lt;/tt&gt; column in our code to the end of the list in the select statement, which solved the issue (since all other columns were already processed in the &lt;tt&gt;foreach&lt;/tt&gt; loop).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13411254">SPARK-37290</key>
            <summary>Exponential planning time in case of non-deterministic function</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kupferk">Kaya Kupferschmidt</assignee>
                                    <reporter username="kupferk">Kaya Kupferschmidt</reporter>
                        <labels>
                    </labels>
                <created>Thu, 11 Nov 2021 11:28:40 +0000</created>
                <updated>Tue, 22 Feb 2022 05:52:35 +0000</updated>
                            <resolved>Tue, 22 Feb 2022 05:52:35 +0000</resolved>
                                    <version>3.1.2</version>
                                    <fixVersion>3.1.3</fixVersion>
                    <fixVersion>3.3.0</fixVersion>
                    <fixVersion>3.2.2</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17477375" author="apachespark" created="Mon, 17 Jan 2022 19:27:33 +0000"  >&lt;p&gt;User &apos;Stelyus&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/35231&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/35231&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17477453" author="apachespark" created="Mon, 17 Jan 2022 22:00:14 +0000"  >&lt;p&gt;User &apos;Stelyus&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/35233&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/35233&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17495870" author="cloud_fan" created="Tue, 22 Feb 2022 05:52:35 +0000"  >&lt;p&gt;Issue resolved by pull request 35233&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/35233&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/35233&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 38 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0wn9c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>