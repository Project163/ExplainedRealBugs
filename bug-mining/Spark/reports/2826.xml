<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:35:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-11949] Query on DataFrame from cube gives wrong results</title>
                <link>https://issues.apache.org/jira/browse/SPARK-11949</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;Reproduce bug&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;fact(date: Int, hour: Int, minute: Int, room_name: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, temp: &lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;)
val df0 = sc.parallelize(Seq
(
fact(20151123, 18, 35, &lt;span class=&quot;code-quote&quot;&gt;&quot;room1&quot;&lt;/span&gt;, 18.6),
fact(20151123, 18, 35, &lt;span class=&quot;code-quote&quot;&gt;&quot;room2&quot;&lt;/span&gt;, 22.4),
fact(20151123, 18, 36, &lt;span class=&quot;code-quote&quot;&gt;&quot;room1&quot;&lt;/span&gt;, 17.4),
fact(20151123, 18, 36, &lt;span class=&quot;code-quote&quot;&gt;&quot;room2&quot;&lt;/span&gt;, 25.6)
)).toDF()
val cube0 = df0.cube(&lt;span class=&quot;code-quote&quot;&gt;&quot;date&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;hour&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;minute&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;room_name&quot;&lt;/span&gt;).agg(Map
(
&lt;span class=&quot;code-quote&quot;&gt;&quot;temp&quot;&lt;/span&gt; -&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;avg&quot;&lt;/span&gt;
))
cube0.where(&lt;span class=&quot;code-quote&quot;&gt;&quot;date IS NULL&quot;&lt;/span&gt;).show()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The query result is empty. It should not be, because cube0 contains the value null several times in column &apos;date&apos;. The issue arises because the cube function reuses the schema information from df0. If I change the type of parameters in the case class to Option&lt;span class=&quot;error&quot;&gt;&amp;#91;T&amp;#93;&lt;/span&gt; the query gives correct results.&lt;/p&gt;

&lt;p&gt;Solution: The cube function should change the schema by changing the nullable property to true, for the columns (dimensions) specified in the method call parameters.&lt;/p&gt;

&lt;p&gt;I am new at Scala and Spark. I don&apos;t know how to implement this. Somebody please do.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12915770">SPARK-11949</key>
            <summary>Query on DataFrame from cube gives wrong results</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="viirya">L. C. Hsieh</assignee>
                                    <reporter username="vkcelik">Veli Kerim Celik</reporter>
                        <labels>
                            <label>correctness</label>
                            <label>dataframe</label>
                            <label>sql</label>
                    </labels>
                <created>Tue, 24 Nov 2015 11:41:54 +0000</created>
                <updated>Mon, 12 Dec 2022 18:10:36 +0000</updated>
                            <resolved>Tue, 1 Dec 2015 15:44:55 +0000</resolved>
                                    <version>1.5.1</version>
                                    <fixVersion>1.6.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="15026495" author="yanboliang" created="Wed, 25 Nov 2015 09:37:49 +0000"  >&lt;p&gt;This should be caused by Int type was set nullable = false. If we filter on String type, it will work well.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;scala&amp;gt; cube0.where(&lt;span class=&quot;code-quote&quot;&gt;&quot;room_name IS NULL&quot;&lt;/span&gt;).show()
+--------+----+------+---------+---------+                                      
|    date|hour|minute|room_name|avg(temp)|
+--------+----+------+---------+---------+
|    &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|    36|     &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|     21.5|
|    &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|    35|     &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|     20.5|
|20151123|  18|    36|     &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|     21.5|
|20151123|  18|    35|     &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|     20.5|
|    &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|  18|  &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|     &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|     21.0|
|20151123|&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|    36|     &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|     21.5|
|20151123|&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|    35|     &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|     20.5|
|    &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|  &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|     &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|     21.0|
|20151123|  18|  &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|     &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|     21.0|
|    &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|  18|    36|     &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|     21.5|
|    &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|  18|    35|     &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|     20.5|
|20151123|&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|  &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|     &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;|     21.0|
+--------+----+------+---------+---------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;ï¿½The cube operator should modify the original nullable to true for groupByExprs and it can fix this issue.&lt;/p&gt;</comment>
                            <comment id="15026508" author="gurwls223" created="Wed, 25 Nov 2015 09:46:24 +0000"  >&lt;p&gt;Oops. I did the same test a bit ago.&lt;br/&gt;
Maybe you want to run this code just for testing. I will leave the codes.&lt;br/&gt;
Here.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Fact(date: Option[Int], hour: Option[Int], minute: Option[Int], room_name: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, temp: &lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;)
  val rdd = sc.parallelize(Seq
    (
        Fact(Some(20151123), Some(18), Some(35), &lt;span class=&quot;code-quote&quot;&gt;&quot;room1&quot;&lt;/span&gt;, 18.6),
        Fact(Some(20151123), Some(18), Some(35), &lt;span class=&quot;code-quote&quot;&gt;&quot;room2&quot;&lt;/span&gt;, 22.4),
        Fact(Some(20151123), Some(18), Some(36), &lt;span class=&quot;code-quote&quot;&gt;&quot;room1&quot;&lt;/span&gt;, 17.4),
        Fact(Some(20151123), Some(18), Some(36), &lt;span class=&quot;code-quote&quot;&gt;&quot;room2&quot;&lt;/span&gt;, 25.6)
      ))
  val df0 = sqlContext.createDataFrame(rdd)
  val cube0 = df0.cube(&lt;span class=&quot;code-quote&quot;&gt;&quot;date&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;hour&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;minute&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;room_name&quot;&lt;/span&gt;).agg(Map
    (
        &lt;span class=&quot;code-quote&quot;&gt;&quot;temp&quot;&lt;/span&gt; -&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;avg&quot;&lt;/span&gt;
      )).toDF()
  cube0.where(&lt;span class=&quot;code-quote&quot;&gt;&quot;date IS NULL&quot;&lt;/span&gt;).show()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15026605" author="vkcelik" created="Wed, 25 Nov 2015 10:54:24 +0000"  >&lt;p&gt;I had already tried using Option&lt;span class=&quot;error&quot;&gt;&amp;#91;T&amp;#93;&lt;/span&gt;, before your suggestion. It solved the problem and gave correct results.&lt;br/&gt;
Now I tried running this code. It also gives correct results.&lt;/p&gt;</comment>
                            <comment id="15026618" author="vkcelik" created="Wed, 25 Nov 2015 11:10:19 +0000"  >&lt;p&gt;Yes, it works on room_name because the column is nullable = true. &lt;br/&gt;
I don&apos;t know where in the code groupByExprs is located and why it is relevant to this issue. &lt;/p&gt;

&lt;p&gt;The solution is:&lt;br/&gt;
In the cube method &apos;def cube(col1: String, cols: String*): GroupedData&apos; after resolving col1 and cols to the corresponding columns, set nullable = true on these columns. &lt;br/&gt;
In the method &apos;def cube(cols: Column*): GroupedData&apos;, set nullable = true for all columns in cols.&lt;/p&gt;</comment>
                            <comment id="15030718" author="dkbiswal" created="Sun, 29 Nov 2015 00:22:04 +0000"  >&lt;p&gt;I would like to work on this issue.&lt;/p&gt;</comment>
                            <comment id="15031561" author="apachespark" created="Mon, 30 Nov 2015 09:41:04 +0000"  >&lt;p&gt;User &apos;viirya&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/10038&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/10038&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15033897" author="yhuai" created="Tue, 1 Dec 2015 15:44:55 +0000"  >&lt;p&gt;Issue resolved by pull request 10038&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/10038&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/10038&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15034752" author="apachespark" created="Tue, 1 Dec 2015 22:35:03 +0000"  >&lt;p&gt;User &apos;viirya&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/10067&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/10067&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15035322" author="yhuai" created="Wed, 2 Dec 2015 05:52:17 +0000"  >&lt;p&gt;The follow up pr &lt;a href=&quot;https://github.com/apache/spark/pull/10067&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/10067&lt;/a&gt; has also been merged.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 50 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ov27:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>