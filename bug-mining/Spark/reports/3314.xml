<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:40:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-13048] EMLDAOptimizer deletes dependent checkpoint of DistributedLDAModel</title>
                <link>https://issues.apache.org/jira/browse/SPARK-13048</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;In EMLDAOptimizer, all checkpoints are deleted before returning the DistributedLDAModel.&lt;/p&gt;

&lt;p&gt;The most recent checkpoint is still necessary for operations on the DistributedLDAModel under a couple scenarios:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The graph doesn&apos;t fit in memory on the worker nodes (e.g. very large data set).&lt;/li&gt;
	&lt;li&gt;Late worker failures that require reading the now-dependent checkpoint.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I ran into this problem running a 10M record LDA model in a memory starved environment. The model consistently failed in either the &lt;tt&gt;collect at LDAModel.scala:528&lt;/tt&gt; stage (when converting to a LocalLDAModel) or in the &lt;tt&gt;reduce at LDAModel.scala:563&lt;/tt&gt; stage (when calling &quot;describeTopics&quot; on the model). In both cases, a FileNotFoundException is thrown attempting to access a checkpoint file.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure what the correct fix is here; it might involve a class signature change. An alternative simple fix is to leave the last checkpoint around and expect the user to clean the checkpoint directory themselves.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.io.FileNotFoundException: File does not exist: /hdfs/path/to/checkpoints/c8bd2b4e-27dd-47b3-84ec-3ff0bac04587/rdd-635/part-00071
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Relevant code is included below.&lt;/p&gt;

&lt;p&gt;LDAOptimizer.scala:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  override private[clustering] def getLDAModel(iterationTimes: Array[Double]): LDAModel = {
    require(graph != null, &quot;graph is null, EMLDAOptimizer not initialized.&quot;)
    this.graphCheckpointer.deleteAllCheckpoints()
    // The constructor&apos;s default arguments assume gammaShape = 100 to ensure equivalence in
    // LDAModel.toLocal conversion
    new DistributedLDAModel(this.graph, this.globalTopicTotals, this.k, this.vocabSize,
      Vectors.dense(Array.fill(this.k)(this.docConcentration)), this.topicConcentration,
      iterationTimes)
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;PeriodicCheckpointer.scala&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  /**
   * Call this at the end to delete any remaining checkpoint files.
   */
  def deleteAllCheckpoints(): Unit = {
    while (checkpointQueue.nonEmpty) {
      removeCheckpointFile()
    }
  }

  /**
   * Dequeue the oldest checkpointed Dataset, and remove its checkpoint files.
   * This prints a warning but does not fail if the files cannot be removed.
   */
  private def removeCheckpointFile(): Unit = {
    val old = checkpointQueue.dequeue()
    // Since the old checkpoint is not deleted by Spark, we manually delete it.
    val fs = FileSystem.get(sc.hadoopConfiguration)
    getCheckpointFiles(old).foreach { checkpointFile =&amp;gt;
      try {
        fs.delete(new Path(checkpointFile), true)
      } catch {
        case e: Exception =&amp;gt;
          logWarning(&quot;PeriodicCheckpointer could not remove old checkpoint file: &quot; +
            checkpointFile)
      }
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Standalone Spark cluster&lt;/p&gt;</environment>
        <key id="12934567">SPARK-13048</key>
            <summary>EMLDAOptimizer deletes dependent checkpoint of DistributedLDAModel</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="josephkb">Joseph K. Bradley</assignee>
                                    <reporter username="jvstein">Jeff Stein</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Jan 2016 20:08:41 +0000</created>
                <updated>Fri, 8 Apr 2016 02:48:51 +0000</updated>
                            <resolved>Fri, 8 Apr 2016 02:48:51 +0000</resolved>
                                    <version>1.5.2</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>MLlib</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15127179" author="holdenk" created="Mon, 1 Feb 2016 22:43:05 +0000"  >&lt;p&gt;This sounds useful, although we probably wouldn&apos;t want to always leave the last checkpoint around (and we also need to provide a way for the user to cleanup the last check point).&lt;/p&gt;

&lt;p&gt;We could make a getCheckPointedLDAModel or offer a param to the current method and then add a cleanup function to the resulting LDAModel for the user to call. Any thoughts &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=josephkb&quot; class=&quot;user-hover&quot; rel=&quot;josephkb&quot;&gt;josephkb&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mengxr&quot; class=&quot;user-hover&quot; rel=&quot;mengxr&quot;&gt;mengxr&lt;/a&gt;? Also an interesting question would be how to expose something similar in the pipelines API.&lt;/p&gt;</comment>
                            <comment id="15155212" author="jvstein" created="Sat, 20 Feb 2016 00:25:58 +0000"  >&lt;p&gt;As an aside, the code in the clustering namespace violates the &lt;span class=&quot;error&quot;&gt;&amp;#91;open/closed principle&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://en.wikipedia.org/wiki/Open/closed_principle&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://en.wikipedia.org/wiki/Open/closed_principle&lt;/a&gt;).&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LDAOptimizer is unnecessarily a sealed trait (I understand it&apos;s a developer api, but I&apos;m a developer...)&lt;/li&gt;
	&lt;li&gt;EMLDAOptimizer is final&lt;/li&gt;
	&lt;li&gt;Lots of private&lt;span class=&quot;error&quot;&gt;&amp;#91;clustering&amp;#93;&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;All of this meant that writing a decent workaround for the bug took a lot more code than I would have hoped.&lt;/p&gt;</comment>
                            <comment id="15180241" author="josephkb" created="Fri, 4 Mar 2016 17:49:07 +0000"  >&lt;p&gt;I&apos;d say the best fix would be to add an option to LDA to not delete the last checkpoint.  I&apos;d prefer to expose this as a Param in the spark.ml API, but it could be added to the spark.mllib API as well if necessary.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=holdenk&quot; class=&quot;user-hover&quot; rel=&quot;holdenk&quot;&gt;holdenk&lt;/a&gt;  I agree we need to figure out how to handle/control caching and checkpointing within Pipelines, but that will have to wait for after 2.0.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jvstein&quot; class=&quot;user-hover&quot; rel=&quot;jvstein&quot;&gt;jvstein&lt;/a&gt;  We try to minimize the public API.  Although I agree with you about opening up APIs in principal, it have proven dangerous in practice.  Even when we mark things DeveloperApi, many users still use those APIs, making it difficult to change them in the future.&lt;/p&gt;</comment>
                            <comment id="15225353" author="josephkb" created="Tue, 5 Apr 2016 00:11:09 +0000"  >&lt;p&gt;I&apos;ll send a PR for this.  I&apos;d prefer to fix this in 2.0 only since it will require a public API change (adding a Param saying not to delete the last checkpoint).&lt;/p&gt;</comment>
                            <comment id="15225502" author="apachespark" created="Tue, 5 Apr 2016 01:46:03 +0000"  >&lt;p&gt;User &apos;jkbradley&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/12166&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/12166&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15225506" author="josephkb" created="Tue, 5 Apr 2016 01:47:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jvstein&quot; class=&quot;user-hover&quot; rel=&quot;jvstein&quot;&gt;jvstein&lt;/a&gt; Would you be able to test whether the patch I just sent takes care of the problem you encountered?&lt;/p&gt;</comment>
                            <comment id="15226687" author="jvstein" created="Tue, 5 Apr 2016 17:15:04 +0000"  >&lt;p&gt;Sure, I&apos;ll take a look. It&apos;ll be a few days before I can get around to it.&lt;/p&gt;</comment>
                            <comment id="15231541" author="josephkb" created="Fri, 8 Apr 2016 02:48:51 +0000"  >&lt;p&gt;Issue resolved by pull request 12166&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/12166&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/12166&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12956342">SPARK-14420</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 32 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2s1y7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12329449">2.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>