<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:17:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-29295] Duplicate result when dropping partition of an external table and then overwriting</title>
                <link>https://issues.apache.org/jira/browse/SPARK-29295</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When we drop a partition of a external table and then overwrite it, if we set CONVERT_METASTORE_PARQUET=true(default value), it will overwrite this partition.&lt;br/&gt;
But when we set CONVERT_METASTORE_PARQUET=false, it will give duplicate result.&lt;/p&gt;

&lt;p&gt;Here is a reproduce code below(you can add it into SQLQuerySuite in hive module):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  test(&lt;span class=&quot;code-quote&quot;&gt;&quot;spark gives duplicate result when dropping a partition of an external partitioned table&quot;&lt;/span&gt; +
    &lt;span class=&quot;code-quote&quot;&gt;&quot; firstly and they overwrite it&quot;&lt;/span&gt;) {
    withTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;) {
      withTempDir { f =&amp;gt;
        sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;create external table test(id &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) partitioned by (name string) stored as &quot;&lt;/span&gt; +
          s&lt;span class=&quot;code-quote&quot;&gt;&quot;parquet location &lt;span class=&quot;code-quote&quot;&gt;&apos;${f.getAbsolutePath}&apos;&lt;/span&gt;&quot;&lt;/span&gt;)

        withSQLConf(HiveUtils.CONVERT_METASTORE_PARQUET.key -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;.toString) {
          sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;insert overwrite table test partition(name=&lt;span class=&quot;code-quote&quot;&gt;&apos;n1&apos;&lt;/span&gt;) select 1&quot;&lt;/span&gt;)
          sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;ALTER TABLE test DROP PARTITION(name=&lt;span class=&quot;code-quote&quot;&gt;&apos;n1&apos;&lt;/span&gt;)&quot;&lt;/span&gt;)
          sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;insert overwrite table test partition(name=&lt;span class=&quot;code-quote&quot;&gt;&apos;n1&apos;&lt;/span&gt;) select 2&quot;&lt;/span&gt;)
          checkAnswer( sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select id from test where name = &lt;span class=&quot;code-quote&quot;&gt;&apos;n1&apos;&lt;/span&gt; order by id&quot;&lt;/span&gt;),
            Array(Row(1), Row(2)))
        }

        withSQLConf(HiveUtils.CONVERT_METASTORE_PARQUET.key -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;.toString) {
          sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;insert overwrite table test partition(name=&lt;span class=&quot;code-quote&quot;&gt;&apos;n1&apos;&lt;/span&gt;) select 1&quot;&lt;/span&gt;)
          sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;ALTER TABLE test DROP PARTITION(name=&lt;span class=&quot;code-quote&quot;&gt;&apos;n1&apos;&lt;/span&gt;)&quot;&lt;/span&gt;)
          sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;insert overwrite table test partition(name=&lt;span class=&quot;code-quote&quot;&gt;&apos;n1&apos;&lt;/span&gt;) select 2&quot;&lt;/span&gt;)
          checkAnswer( sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;select id from test where name = &lt;span class=&quot;code-quote&quot;&gt;&apos;n1&apos;&lt;/span&gt; order by id&quot;&lt;/span&gt;),
            Array(Row(2)))
        }
      }
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
create external table test(id &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) partitioned by (name string) stored as parquet location &lt;span class=&quot;code-quote&quot;&gt;&apos;/tmp/p&apos;&lt;/span&gt;;
set spark.sql.hive.convertMetastoreParquet=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
insert overwrite table test partition(name=&lt;span class=&quot;code-quote&quot;&gt;&apos;n1&apos;&lt;/span&gt;) select 1;
ALTER TABLE test DROP PARTITION(name=&lt;span class=&quot;code-quote&quot;&gt;&apos;n1&apos;&lt;/span&gt;);
insert overwrite table test partition(name=&lt;span class=&quot;code-quote&quot;&gt;&apos;n1&apos;&lt;/span&gt;) select 2;
select id from test where name = &lt;span class=&quot;code-quote&quot;&gt;&apos;n1&apos;&lt;/span&gt; order by id;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13259560">SPARK-29295</key>
            <summary>Duplicate result when dropping partition of an external table and then overwriting</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="viirya">L. C. Hsieh</assignee>
                                    <reporter username="hzfeiwang">feiwang</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Mon, 30 Sep 2019 01:19:50 +0000</created>
                <updated>Tue, 9 Jun 2020 07:31:46 +0000</updated>
                            <resolved>Fri, 18 Oct 2019 08:37:53 +0000</resolved>
                                    <version>2.2.3</version>
                    <version>2.3.4</version>
                    <version>2.4.5</version>
                                    <fixVersion>2.4.6</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16940598" author="hzfeiwang" created="Mon, 30 Sep 2019 01:32:04 +0000"  >&lt;p&gt;When we set CONVERT_METASTORE_PARQUET=true, it will use InsertIntoHadoopFsRelationCommand to process this statement.&lt;/p&gt;

&lt;p&gt;When we set CONVERT_METASTORE_PARQUET=false, it will use InsertIntoHiveTable.&lt;/p&gt;</comment>
                            <comment id="16940600" author="hzfeiwang" created="Mon, 30 Sep 2019 01:38:16 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=viirya&quot; class=&quot;user-hover&quot; rel=&quot;viirya&quot;&gt;viirya&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16940718" author="viirya" created="Mon, 30 Sep 2019 07:52:16 +0000"  >&lt;p&gt;Thanks for reporting this. Will take a look.&lt;/p&gt;</comment>
                            <comment id="16940754" author="hzfeiwang" created="Mon, 30 Sep 2019 08:42:09 +0000"  >&lt;p&gt;relative hive issue, &lt;a href=&quot;https://issues.apache.org/jira/browse/HIVE-17063&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/HIVE-17063&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16941060" author="viirya" created="Mon, 30 Sep 2019 15:28:17 +0000"  >&lt;p&gt;I traced code last night, and yes it looks like a Hive bug. &lt;a href=&quot;https://jira.apache.org/jira/browse/HIVE-18702&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jira.apache.org/jira/browse/HIVE-18702&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16941475" author="hzfeiwang" created="Tue, 1 Oct 2019 02:27:45 +0000"  >&lt;p&gt;Yes, how can we resolve this issue?&lt;br/&gt;
Only by upgrading the hive version?&lt;/p&gt;</comment>
                            <comment id="16941483" author="viirya" created="Tue, 1 Oct 2019 02:53:29 +0000"  >&lt;p&gt;I created a PR for this issue.&lt;/p&gt;</comment>
                            <comment id="16949886" author="angerszhuuu" created="Sat, 12 Oct 2019 03:26:30 +0000"  >&lt;p&gt;&#160;This probelm seems start from hive 1.2&lt;/p&gt;

&lt;p&gt;I test in our env hive-1.1, won&apos;t have this problem.&lt;/p&gt;</comment>
                            <comment id="16954391" author="cloud_fan" created="Fri, 18 Oct 2019 08:37:53 +0000"  >&lt;p&gt;Issue resolved by pull request 25979&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/25979&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/25979&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17057260" author="dongjoon" created="Wed, 11 Mar 2020 17:43:34 +0000"  >&lt;p&gt;I marked this as a `correctness` issue.&lt;/p&gt;</comment>
                            <comment id="17057261" author="dongjoon" created="Wed, 11 Mar 2020 17:43:53 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=viirya&quot; class=&quot;user-hover&quot; rel=&quot;viirya&quot;&gt;viirya&lt;/a&gt;. Could you make a backport against branch-2.4?&lt;/p&gt;</comment>
                            <comment id="17057283" author="dongjoon" created="Wed, 11 Mar 2020 18:05:11 +0000"  >&lt;p&gt;I confirmed that Apache Spark 2.1.3 and older versions have no problem.&lt;/p&gt;</comment>
                            <comment id="17057772" author="dongjoon" created="Thu, 12 Mar 2020 10:01:58 +0000"  >&lt;p&gt;This lands to `branch-2.4` via &lt;a href=&quot;https://github.com/apache/spark/pull/27887&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/27887&lt;/a&gt; .&lt;/p&gt;</comment>
                            <comment id="17128955" author="apachespark" created="Tue, 9 Jun 2020 07:31:46 +0000"  >&lt;p&gt;User &apos;turboFei&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/28765&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/28765&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13181915">SPARK-25271</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13138196">HIVE-18702</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 23 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z074wo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>