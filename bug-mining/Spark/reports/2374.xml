<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:31:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-10177] Parquet support interprets timestamp values differently from Hive 0.14.0+</title>
                <link>https://issues.apache.org/jira/browse/SPARK-10177</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Running the following SQL under Hive 0.14.0+ (tested against 0.14.0 and 1.2.1):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;TABLE&lt;/span&gt; ts_test STORED &lt;span class=&quot;code-keyword&quot;&gt;AS&lt;/span&gt; PARQUET
&lt;span class=&quot;code-keyword&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;CAST&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;2015-01-01 00:00:00&quot;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;AS&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;TIMESTAMP&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Then read the Parquet file generated by Hive with Spark SQL:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;scala&amp;gt; sqlContext.read.parquet(&quot;hdfs://localhost:9000/user/hive/warehouse_hive14/ts_test&quot;).collect()
res1: Array[org.apache.spark.sql.Row] = Array([2015-01-01 12:00:00.0])
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This issue can be easily reproduced with &lt;a href=&quot;https://github.com/apache/spark/pull/8392/files#diff-1e55698cc579cbae676f827a89c2dc2eR116&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this test case in PR #8392&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Spark 1.4.1 works as expected in this case.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Update:&lt;/p&gt;

&lt;p&gt;Seems that the problem is that we do Julian day conversion wrong in &lt;tt&gt;DateTimeUtils&lt;/tt&gt;.  The following &lt;tt&gt;spark-shell&lt;/tt&gt; session illustrates it:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.sql._
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util._
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.hadoop.hive.ql.io.parquet.timestamp._
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.sql.catalyst.util._

TimeZone.setDefault(TimeZone.getTimeZone(&lt;span class=&quot;code-quote&quot;&gt;&quot;GMT&quot;&lt;/span&gt;))
val ts = Timestamp.valueOf(&lt;span class=&quot;code-quote&quot;&gt;&quot;1970-01-01 00:00:00&quot;&lt;/span&gt;)
val nt = NanoTimeUtils.getNanoTime(ts, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
val jts = DateTimeUtils.fromJulianDay(nt.getJulianDay, nt.getTimeOfDayNanos)
DateTimeUtils.toJavaTimestamp(jts)

&lt;span class=&quot;code-comment&quot;&gt;// ==&amp;gt; java.sql.Timestamp = 1970-01-01 12:00:00.0&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12858195">SPARK-10177</key>
            <summary>Parquet support interprets timestamp values differently from Hive 0.14.0+</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davies">Davies Liu</assignee>
                                    <reporter username="lian cheng">Cheng Lian</reporter>
                        <labels>
                    </labels>
                <created>Mon, 24 Aug 2015 04:42:39 +0000</created>
                <updated>Tue, 25 Aug 2015 08:01:36 +0000</updated>
                            <resolved>Tue, 25 Aug 2015 08:01:36 +0000</resolved>
                                    <version>1.5.0</version>
                                    <fixVersion>1.5.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14708957" author="lian cheng" created="Mon, 24 Aug 2015 08:25:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davies&quot; class=&quot;user-hover&quot; rel=&quot;davies&quot;&gt;davies&lt;/a&gt; I&apos;m not sure whether this is a regression introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-8307&quot; title=&quot;Improve timestamp from parquet&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-8307&quot;&gt;&lt;del&gt;SPARK-8307&lt;/del&gt;&lt;/a&gt;. Saw &lt;a href=&quot;https://github.com/apache/spark/pull/6759#discussion_r32387873&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this PR comment of yours&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I had verified this using the sample parquet file in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-4768&quot; title=&quot;Add Support For Impala Encoded Timestamp (INT96)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-4768&quot;&gt;&lt;del&gt;SPARK-4768&lt;/del&gt;&lt;/a&gt;, it can read by exact the same value back (with timzone difference).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Is the timezone difference expected? On the other hand, I tried to inspect the Parquet file &lt;tt&gt;5e4481a02f951e29-651ee94ed14560bf_922627129_data.0.parq&lt;/tt&gt; attached in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-4768&quot; title=&quot;Add Support For Impala Encoded Timestamp (INT96)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-4768&quot;&gt;&lt;del&gt;SPARK-4768&lt;/del&gt;&lt;/a&gt; with &lt;tt&gt;parquet-tools&lt;/tt&gt;. Seems that it doesn&apos;t contain a proper timestamp value (please notice the &lt;tt&gt;&amp;lt;null&amp;gt;&lt;/tt&gt; in the result of &lt;tt&gt;parquet-dump&lt;/tt&gt;)?&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ parquet-schema 5e4481a02f951e29-651ee94ed14560bf_922627129_data.0.parq
message schema {
  optional binary dummy;
  optional int96 timestamp1;
}



$ parquet-meta 5e4481a02f951e29-651ee94ed14560bf_922627129_data.0.parq
file:        file:/Users/lian/Desktop/5e4481a02f951e29-651ee94ed14560bf_922627129_data.0.parq
creator:     impala version 2.0.0-cdh5 (build ecf30af0b4d6e56ea80297df2189367ada6b7da7)

file schema: schema
------------------------------------------------------------------------------------------------------------
dummy:       OPTIONAL BINARY R:0 D:1
timestamp1:  OPTIONAL INT96 R:0 D:1

row group 1: RC:1 TS:96 OFFSET:4
------------------------------------------------------------------------------------------------------------
dummy:        BINARY SNAPPY DO:4 FPO:33 SZ:57/53/0.93 VC:1 ENC:PLAIN,PLAIN_DICTIONARY,RLE
timestamp1:   INT96 SNAPPY DO:93 FPO:107 SZ:39/36/0.92 VC:1 ENC:PLAIN,PLAIN_DICTIONARY,RLE



$ parquet-dump 5e4481a02f951e29-651ee94ed14560bf_922627129_data.0.parq
row group 0
------------------------------------------------------------------------------------------------------------
dummy:       BINARY SNAPPY DO:4 FPO:33 SZ:57/53/0.93 VC:1 ENC:PLAIN_DICTIONARY,RLE,PLAIN
timestamp1:  INT96 SNAPPY DO:93 FPO:107 SZ:39/36/0.92 VC:1 ENC:PLAIN_DICTIONARY,RLE,PLAIN

    dummy TV=1 RL=0 DL=1 DS:      1 DE:PLAIN_DICTIONARY
    --------------------------------------------------------------------------------------------------------
    page 0:                        DLE:RLE RLE:BIT_PACKED VLE:PLAIN_DICTIONARY SZ:9 VC:1

    timestamp1 TV=1 RL=0 DL=1 DS: 0 DE:PLAIN_DICTIONARY
    --------------------------------------------------------------------------------------------------------
    page 0:                        DLE:RLE RLE:BIT_PACKED VLE:PLAIN SZ:6 VC:1

BINARY dummy
------------------------------------------------------------------------------------------------------------
*** row group 1 of 1, values 1 to 1 ***
value 1: R:0 D:1 V:test row 4

INT96 timestamp1
------------------------------------------------------------------------------------------------------------
*** row group 1 of 1, values 1 to 1 ***
value 1: R:0 D:0 V:&amp;lt;null&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14708961" author="lian cheng" created="Mon, 24 Aug 2015 08:34:48 +0000"  >&lt;p&gt;Attached the Parquet file generated by the Hive 0.14.0 SQL statement mentioned in the ticket description (Hive 1.2.1 should be the same).&lt;/p&gt;

&lt;p&gt;Below are results of &lt;tt&gt;parquet-tools&lt;/tt&gt; inspections:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ parquet-schema 000000_0
message hive_schema {
  optional int96 _c0;
}



$ parquet-meta 000000_0
file:        file:/Users/lian/Desktop/000000_0
creator:     parquet-mr

file schema: hive_schema
---------------------------------------------------------------------------------------
_c0:         OPTIONAL INT96 R:0 D:1

row group 1: RC:1 TS:67 OFFSET:4
---------------------------------------------------------------------------------------
_c0:          INT96 UNCOMPRESSED DO:0 FPO:4 SZ:67/67/1.00 VC:1 ENC:RLE,BIT_PACKED,PLAIN



$ parquet-dump 000000_0
row group 0
---------------------------------------------------------------------------------------
_c0:  INT96 UNCOMPRESSED DO:0 FPO:4 SZ:67/67/1.00 VC:1 ENC:RLE,BIT_PACKED,PLAIN

    _c0 TV=1 RL=0 DL=1
    -----------------------------------------------------------------------------------
    page 0:  DLE:RLE RLE:BIT_PACKED VLE:PLAIN SZ:18 VC:1

INT96 _c0
---------------------------------------------------------------------------------------
*** row group 1 of 1, values 1 to 1 ***
value 1: R:0 D:1 V:651896637159333601027328
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14708968" author="lian cheng" created="Mon, 24 Aug 2015 08:40:37 +0000"  >&lt;p&gt;Ah, didn&apos;t realize that the &lt;tt&gt;string_timestamp.gz&lt;/tt&gt; file attached in &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-4768&quot; title=&quot;Add Support For Impala Encoded Timestamp (INT96)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-4768&quot;&gt;&lt;del&gt;SPARK-4768&lt;/del&gt;&lt;/a&gt; is actuall a tar.gz file containing multiple Parquet files within it. Now I can decode them.&lt;/p&gt;</comment>
                            <comment id="14709430" author="lian cheng" created="Mon, 24 Aug 2015 15:11:15 +0000"  >&lt;p&gt;I&apos;m not quite familiar with Julian date, but the Julian date of &lt;tt&gt;1970-01-01 00:00:00&lt;/tt&gt; should be &lt;tt&gt;2440587.500000&lt;/tt&gt;.  So for the following code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;val nanoTime = NanoTimeUtils.getNanoTime(Timestamp.valueOf(&lt;span class=&quot;code-quote&quot;&gt;&quot;1970-01-01 00:00:00&quot;&lt;/span&gt;), &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;tt&gt;nanoTime.getJulianDay&lt;/tt&gt; should be &lt;tt&gt;2440587&lt;/tt&gt;, while &lt;tt&gt;nanoTime.getTimeOfDayNanos&lt;/tt&gt; should be&lt;br/&gt;
the number of nanoseconds of 12 hr.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=davies&quot; class=&quot;user-hover&quot; rel=&quot;davies&quot;&gt;davies&lt;/a&gt; Could help verifying this one?  If my conclusion above is right, then it&apos;s Hive who is doing Julian day conversion wrong...&lt;/p&gt;</comment>
                            <comment id="14709878" author="davies" created="Mon, 24 Aug 2015 19:08:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lian+cheng&quot; class=&quot;user-hover&quot; rel=&quot;lian cheng&quot;&gt;lian cheng&lt;/a&gt; After some investigation, just realized that we misunderstood the format used in Hive/parquet. the INT96 has two parts, day of julian day, nano seconds of the day. Because of an integer of julian day begin at noon of a day (12 pm), so they two parts are overlapped. They can&apos;t be interpreted as Julian day, and then add them together.&lt;/p&gt;

&lt;p&gt;It&apos;s weird but not wrong, I will send out a PR to fix this soon.&lt;/p&gt;</comment>
                            <comment id="14709900" author="apachespark" created="Mon, 24 Aug 2015 19:20:03 +0000"  >&lt;p&gt;User &apos;davies&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/8400&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/8400&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14710830" author="lian cheng" created="Tue, 25 Aug 2015 08:01:36 +0000"  >&lt;p&gt;Issue resolved by pull request 8400&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/8400&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/8400&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12751990" name="000000_0" size="196" author="lian cheng" created="Mon, 24 Aug 2015 08:34:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 13 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2j9on:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310921" key="com.pyxis.greenhopper.jira:gh-sprint">
                        <customfieldname>Sprint</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="168">Spark 1.5 doc/QA sprint</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332078">1.5.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>