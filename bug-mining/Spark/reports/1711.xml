<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:26:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-6800] Reading from JDBC with SQLContext, using lower/upper bounds and numPartitions gives incorrect results.</title>
                <link>https://issues.apache.org/jira/browse/SPARK-6800</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Having a Derby table with people info (id, name, age) defined like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;val jdbcUrl = &lt;span class=&quot;code-quote&quot;&gt;&quot;jdbc:derby:memory:PeopleDB;create=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&quot;&lt;/span&gt;
val conn = DriverManager.getConnection(jdbcUrl)
val stmt = conn.createStatement()
stmt.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE Person (person_id INT NOT NULL GENERATED ALWAYS AS IDENTITY CONSTRAINT person_pk PRIMARY KEY, name VARCHAR(50), age INT)&quot;&lt;/span&gt;)
stmt.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO Person(name, age) VALUES(&lt;span class=&quot;code-quote&quot;&gt;&apos;Armando Carvalho&apos;&lt;/span&gt;, 50)&quot;&lt;/span&gt;)
stmt.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO Person(name, age) VALUES(&lt;span class=&quot;code-quote&quot;&gt;&apos;Lurdes Pereira&apos;&lt;/span&gt;, 23)&quot;&lt;/span&gt;)
stmt.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO Person(name, age) VALUES(&lt;span class=&quot;code-quote&quot;&gt;&apos;Ana Rita Costa&apos;&lt;/span&gt;, 12)&quot;&lt;/span&gt;)
stmt.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO Person(name, age) VALUES(&lt;span class=&quot;code-quote&quot;&gt;&apos;Armando Pereira&apos;&lt;/span&gt;, 32)&quot;&lt;/span&gt;)
stmt.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO Person(name, age) VALUES(&lt;span class=&quot;code-quote&quot;&gt;&apos;Miguel Costa&apos;&lt;/span&gt;, 15)&quot;&lt;/span&gt;)
stmt.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO Person(name, age) VALUES(&lt;span class=&quot;code-quote&quot;&gt;&apos;Anabela Sintra&apos;&lt;/span&gt;, 13)&quot;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If I try to read that table from Spark SQL with lower/upper bounds, like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;val people = sqlContext.jdbc(url = jdbcUrl, table = &lt;span class=&quot;code-quote&quot;&gt;&quot;Person&quot;&lt;/span&gt;,
      columnName = &lt;span class=&quot;code-quote&quot;&gt;&quot;age&quot;&lt;/span&gt;, lowerBound = 0, upperBound = 40, numPartitions = 10)
people.show()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I get this result:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;PERSON_ID NAME             AGE
3         Ana Rita Costa   12 
5         Miguel Costa     15 
6         Anabela Sintra   13 
2         Lurdes Pereira   23 
4         Armando Pereira  32 
1         Armando Carvalho 50 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Which is wrong, considering the defined upper bound has been ignored (I get a person with age 50!).&lt;br/&gt;
Digging the code, I&apos;ve found that in &lt;tt&gt;JDBCRelation.columnPartition&lt;/tt&gt; the WHERE clauses it generates are the following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;(0) age &amp;lt; 4,0
(1) age &amp;gt;= 4  AND age &amp;lt; 8,1
(2) age &amp;gt;= 8  AND age &amp;lt; 12,2
(3) age &amp;gt;= 12 AND age &amp;lt; 16,3
(4) age &amp;gt;= 16 AND age &amp;lt; 20,4
(5) age &amp;gt;= 20 AND age &amp;lt; 24,5
(6) age &amp;gt;= 24 AND age &amp;lt; 28,6
(7) age &amp;gt;= 28 AND age &amp;lt; 32,7
(8) age &amp;gt;= 32 AND age &amp;lt; 36,8
(9) age &amp;gt;= 36,9
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The last condition ignores the upper bound and the other ones may result in repeated rows being read.&lt;/p&gt;

&lt;p&gt;Using the JdbcRDD (and converting it to a DataFrame) I would have something like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;val jdbcRdd = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JdbcRDD(sc, () =&amp;gt; DriverManager.getConnection(jdbcUrl),
      &lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM Person WHERE age &amp;gt;= ? and age &amp;lt;= ?&quot;&lt;/span&gt;, 0, 40, 10,
      rs =&amp;gt; (rs.getInt(1), rs.getString(2), rs.getInt(3)))
val people = jdbcRdd.toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;PERSON_ID&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;NAME&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;AGE&quot;&lt;/span&gt;)
people.show()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Resulting in:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;PERSON_ID NAME            AGE
3         Ana Rita Costa  12 
5         Miguel Costa    15 
6         Anabela Sintra  13 
2         Lurdes Pereira  23 
4         Armando Pereira 32 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Which is correct!&lt;/p&gt;

&lt;p&gt;Confirming the WHERE clauses generated by the JdbcRDD in the &lt;tt&gt;getPartitions&lt;/tt&gt; I&apos;ve found it generates the following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;(0) age &amp;gt;= 0  AND age &amp;lt;= 3
(1) age &amp;gt;= 4  AND age &amp;lt;= 7
(2) age &amp;gt;= 8  AND age &amp;lt;= 11
(3) age &amp;gt;= 12 AND age &amp;lt;= 15
(4) age &amp;gt;= 16 AND age &amp;lt;= 19
(5) age &amp;gt;= 20 AND age &amp;lt;= 23
(6) age &amp;gt;= 24 AND age &amp;lt;= 27
(7) age &amp;gt;= 28 AND age &amp;lt;= 31
(8) age &amp;gt;= 32 AND age &amp;lt;= 35
(9) age &amp;gt;= 36 AND age &amp;lt;= 40
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is the behaviour I was expecting from the Spark SQL version. Is the Spark SQL version buggy or is this some weird expected behaviour?&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows 8.1, Apache Derby DB, Spark 1.3.0 CDH5.4.0, Scala 2.10&lt;/p&gt;</environment>
        <key id="12819637">SPARK-6800</key>
            <summary>Reading from JDBC with SQLContext, using lower/upper bounds and numPartitions gives incorrect results.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="viirya">L. C. Hsieh</assignee>
                                    <reporter username="capitao">Micael Capit&#227;o</reporter>
                        <labels>
                    </labels>
                <created>Thu, 9 Apr 2015 11:22:00 +0000</created>
                <updated>Fri, 24 Apr 2015 00:27:55 +0000</updated>
                            <resolved>Wed, 15 Apr 2015 20:03:12 +0000</resolved>
                                    <version>1.3.0</version>
                                    <fixVersion>1.3.1</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14492244" author="apachespark" created="Mon, 13 Apr 2015 10:26:40 +0000"  >&lt;p&gt;User &apos;viirya&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/5488&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/5488&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14492364" author="capitao" created="Mon, 13 Apr 2015 12:53:20 +0000"  >&lt;p&gt;The above pull request seem to only fix the upper and lower bounds issue. There is still the intermediate queries issue that may result in repeated rows being fetched from a DB.&lt;/p&gt;</comment>
                            <comment id="14495564" author="viirya" created="Wed, 15 Apr 2015 02:32:45 +0000"  >&lt;p&gt;Why the other ones will result in repeated rows being read?&lt;/p&gt;</comment>
                            <comment id="14495570" author="viirya" created="Wed, 15 Apr 2015 02:44:59 +0000"  >&lt;p&gt;And according to the explanation from Michael Armbrust, &lt;tt&gt;lowerBound&lt;/tt&gt; and &lt;tt&gt;upperBound&lt;/tt&gt; are just used to decide partition stride, not for filtering. So all table rows are partitioned. So this is not a bug. But of course the document needs to be updated to clearly state this.&lt;/p&gt;</comment>
                            <comment id="14495921" author="viirya" created="Wed, 15 Apr 2015 09:29:33 +0000"  >&lt;p&gt;The ranges for partitions 1 to 8 are not overlapped. They are:&lt;br/&gt;
(1) 8 &amp;gt; age &amp;gt;= 4&lt;br/&gt;
(2) 12 &amp;gt; age &amp;gt;= 8&lt;br/&gt;
(3) 16 &amp;gt; age &amp;gt;= 12&lt;br/&gt;
(4) 20 &amp;gt; age &amp;gt;= 16&lt;br/&gt;
(5) 24 &amp;gt; age &amp;gt;= 20&lt;br/&gt;
(6) 28 &amp;gt; age &amp;gt;= 24&lt;br/&gt;
(7) 32 &amp;gt; age &amp;gt;= 28&lt;br/&gt;
(8) 36 &amp;gt; age &amp;gt;= 32&lt;/p&gt;</comment>
                            <comment id="14495926" author="capitao" created="Wed, 15 Apr 2015 09:32:56 +0000"  >&lt;p&gt;My fault. I&apos;m sorry. I have looked to the wrong place to retrieve the where clauses.&lt;br/&gt;
&quot;age &amp;gt;= 8  AND age &amp;lt; 12,2&quot; is where=&quot;age &amp;gt;= 8  AND age &amp;lt; 12&quot; and partition=2&lt;/p&gt;

&lt;p&gt;Fixing the lower/upper bounds issue is all is needed.&lt;/p&gt;</comment>
                            <comment id="14495928" author="viirya" created="Wed, 15 Apr 2015 09:34:36 +0000"  >&lt;p&gt;About the upper and lower bounds issue, please refer to the pr page, Michael Armbrust gives the explanation why it is not a bug. Just the document needs to be updated for this issue.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="14495940" author="capitao" created="Wed, 15 Apr 2015 09:43:36 +0000"  >&lt;p&gt;Could you please point me to that page?&lt;br/&gt;
I&apos;m bit confused because not considering the upper/lower bounds would cause the fetch of the whole table and cause the issue I&apos;ve pointed here in which a person with an age out of bound is retrieved.&lt;br/&gt;
Thanks.&lt;/p&gt;</comment>
                            <comment id="14495945" author="viirya" created="Wed, 15 Apr 2015 09:45:19 +0000"  >&lt;p&gt;PR: &lt;a href=&quot;https://github.com/apache/spark/pull/5488&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/5488&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14496813" author="marmbrus" created="Wed, 15 Apr 2015 20:03:12 +0000"  >&lt;p&gt;Issue resolved by pull request 5488&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/5488&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/5488&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 31 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2d0z3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>