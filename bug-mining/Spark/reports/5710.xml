<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:59:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-23697] Accumulators of Spark 1.x no longer work with Spark 2.x</title>
                <link>https://issues.apache.org/jira/browse/SPARK-23697</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I&apos;ve noticed that accumulators of Spark 1.x no longer work with Spark 2.x failing with&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.AssertionError: assertion failed: copyAndReset must &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; a zero value copy&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt; It happens while serializing an accumulator &lt;a href=&quot;https://github.com/apache/spark/blob/4f5bad615b47d743b8932aea1071652293981604/core/src/main/scala/org/apache/spark/util/AccumulatorV2.scala#L165&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val copyAcc = copyAndReset()
&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt;(copyAcc.isZero, &lt;span class=&quot;code-quote&quot;&gt;&quot;copyAndReset must &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; a zero value copy&quot;&lt;/span&gt;)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;... although copyAndReset returns zero-value copy for sure, just consider the accumulator below&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
val concatParam = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AccumulatorParam[jl.StringBuilder] {
&#160; override def zero(initialValue: jl.StringBuilder): jl.StringBuilder = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; jl.StringBuilder()
&#160; override def addInPlace(r1: jl.StringBuilder, r2: jl.StringBuilder): jl.StringBuilder = r1.append(r2)
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So, Spark treats zero value as non-zero due to how &lt;a href=&quot;https://github.com/apache/spark/blob/4f5bad615b47d743b8932aea1071652293981604/core/src/main/scala/org/apache/spark/util/AccumulatorV2.scala#L489&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;isZero&lt;/a&gt; is implemented in LegacyAccumulatorWrapper.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
override def isZero: &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; = _value == param.zero(initialValue)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;All this means that the values to be accumulated must implement equals and hashCode, otherwise isZero is very likely to always return false.&lt;/p&gt;

&lt;p&gt;So I&apos;m wondering whether the assertion&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt;(copyAcc.isZero, &lt;span class=&quot;code-quote&quot;&gt;&quot;copyAndReset must &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; a zero value copy&quot;&lt;/span&gt;)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;is really necessary and whether it can be safely removed from there?&lt;/p&gt;

&lt;p&gt;If not - is it ok to just override writeReplace for LegacyAccumulatorWrapper to prevent such failures?&lt;/p&gt;</description>
                <environment>&lt;p&gt;Spark 2.2.0&lt;br/&gt;
Scala 2.11&lt;/p&gt;</environment>
        <key id="13145496">SPARK-23697</key>
            <summary>Accumulators of Spark 1.x no longer work with Spark 2.x</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="cloud_fan">Wenchen Fan</assignee>
                                    <reporter username="szhemzhitsky">Sergey Zhemzhitsky</reporter>
                        <labels>
                    </labels>
                <created>Thu, 15 Mar 2018 21:53:01 +0000</created>
                <updated>Fri, 4 May 2018 11:23:55 +0000</updated>
                            <resolved>Fri, 4 May 2018 11:23:35 +0000</resolved>
                                    <version>2.2.0</version>
                    <version>2.2.1</version>
                    <version>2.3.0</version>
                                    <fixVersion>2.0.3</fixVersion>
                    <fixVersion>2.1.3</fixVersion>
                    <fixVersion>2.2.2</fixVersion>
                    <fixVersion>2.3.1</fixVersion>
                    <fixVersion>2.4.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16462465" author="apachespark" created="Thu, 3 May 2018 13:49:05 +0000"  >&lt;p&gt;User &apos;cloud-fan&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21229&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21229&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16463746" author="cloud_fan" created="Fri, 4 May 2018 11:23:35 +0000"  >&lt;p&gt;Issue resolved by pull request 21229&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21229&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21229&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 28 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3rd6f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>