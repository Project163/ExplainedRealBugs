<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:48:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-52873] Hint causes semi join results to vary</title>
                <link>https://issues.apache.org/jira/browse/SPARK-52873</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I was running a query in production that was not getting the expected results. I suspect that this query is using an improper join type for a semi join with a non-equal predicate.&#160;&lt;/p&gt;

&lt;p&gt;While my production code has no query hint I am able to reproduce the issue consistently by doing a semi join with a hint in some sample code. In this sample code I create two dataframes, one of which has strings and another that I want to match on the first x characters using a startswith clause. I realize that the substring equality join is logically redundant and could be theoretically removed, but it helps greatly with performance in production. I then run two queries that are nearly identical to find records that match. The only difference between the queries is that the second query has a join hint. Despite being the same logical query they produce different output.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; spark.implicits._

val geohashes = Seq(
  (&lt;span class=&quot;code-quote&quot;&gt;&quot;9ykchgz95z&quot;&lt;/span&gt;),
  (&lt;span class=&quot;code-quote&quot;&gt;&quot;abckd3kdf1&quot;&lt;/span&gt;),
).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;geohash&quot;&lt;/span&gt;)
.repartition(2)
geohashes.createOrReplaceTempView(&lt;span class=&quot;code-quote&quot;&gt;&quot;geohashes&quot;&lt;/span&gt;)

val geohashesToInclude = Seq(
  (&lt;span class=&quot;code-quote&quot;&gt;&quot;9ykchgz91&quot;&lt;/span&gt;),
  (&lt;span class=&quot;code-quote&quot;&gt;&quot;9ykchgz92&quot;&lt;/span&gt;),
  (&lt;span class=&quot;code-quote&quot;&gt;&quot;9ykchgz93&quot;&lt;/span&gt;),
  (&lt;span class=&quot;code-quote&quot;&gt;&quot;9ykchgz94&quot;&lt;/span&gt;),
  (&lt;span class=&quot;code-quote&quot;&gt;&quot;9ykchgz95&quot;&lt;/span&gt;),
  (&lt;span class=&quot;code-quote&quot;&gt;&quot;9ykchgz96&quot;&lt;/span&gt;),
  (&lt;span class=&quot;code-quote&quot;&gt;&quot;9ykchgz97&quot;&lt;/span&gt;),
  (&lt;span class=&quot;code-quote&quot;&gt;&quot;9ykchgz98&quot;&lt;/span&gt;),
  (&lt;span class=&quot;code-quote&quot;&gt;&quot;9ykchgz99&quot;&lt;/span&gt;),
  (&lt;span class=&quot;code-quote&quot;&gt;&quot;9ykchgz90&quot;&lt;/span&gt;),
).toDF(&lt;span class=&quot;code-quote&quot;&gt;&quot;geohash_prefix&quot;&lt;/span&gt;)
.repartition(10)
geohashesToInclude.createOrReplaceTempView(&lt;span class=&quot;code-quote&quot;&gt;&quot;geohashes_to_include&quot;&lt;/span&gt;)

spark.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM geohashes g LEFT SEMI JOIN geohashes_to_include i ON SUBSTRING(g.geohash, 1, 7) = SUBSTRING(i.geohash_prefix, 1, 7) AND STARTSWITH(g.geohash, i.geohash_prefix)&quot;&lt;/span&gt;).show()
+----------+
|   geohash|
+----------+
|9ykchgz95z|
+----------+

spark.sql(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT &lt;span class=&quot;code-comment&quot;&gt;/*+ SHUFFLE_HASH(i) */&lt;/span&gt; * FROM geohashes g LEFT SEMI JOIN geohashes_to_include i ON SUBSTRING(g.geohash, 1, 7) = SUBSTRING(i.geohash_prefix, 1, 7) AND STARTSWITH(g.geohash, i.geohash_prefix)&quot;&lt;/span&gt;).show()
+-------+
|geohash|
+-------+
+-------+ &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I produced the above sample on spark 3.5.3, but I think I have observed similar issues in production code in spark 3.4.1 and 3.5.5 (the latest version on EMR).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13623901">SPARK-52873</key>
            <summary>Hint causes semi join results to vary</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bersprockets">Bruce Robbins</assignee>
                                    <reporter username="pconnolly">Peter Connolly</reporter>
                        <labels>
                            <label>correctness</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 18 Jul 2025 19:02:05 +0000</created>
                <updated>Thu, 28 Aug 2025 01:54:39 +0000</updated>
                            <resolved>Fri, 22 Aug 2025 17:06:42 +0000</resolved>
                                    <version>3.4.1</version>
                    <version>3.5.3</version>
                    <version>3.5.5</version>
                                    <fixVersion>4.1.0</fixVersion>
                    <fixVersion>4.0.1</fixVersion>
                    <fixVersion>3.5.7</fixVersion>
                                    <component>Spark Core</component>
                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="18008136" author="pconnolly" created="Fri, 18 Jul 2025 19:15:24 +0000"  >&lt;p&gt;Worth noting that this problem also seems to impact LEFT ANTI JOIN as well.&lt;/p&gt;</comment>
                            <comment id="18010493" author="bersprockets" created="Mon, 28 Jul 2025 19:24:25 +0000"  >&lt;p&gt;I made a comment on the PR that caused this issue (see &lt;a href=&quot;https://github.com/apache/spark/pull/34247#issuecomment-3128870118&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="18015702" author="ptoth" created="Fri, 22 Aug 2025 17:06:42 +0000"  >&lt;p&gt;Issue fixed with &lt;a href=&quot;https://github.com/apache/spark/pull/52067&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/52067&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="18016373" author="dongjoon" created="Tue, 26 Aug 2025 20:17:37 +0000"  >&lt;p&gt;I removed 3.5.7 from the fixed version fields because this patch didn&apos;t land at `branch-3.5` yet.&lt;/p&gt;</comment>
                            <comment id="18016406" author="dongjoon" created="Wed, 27 Aug 2025 02:03:31 +0000"  >&lt;p&gt;This is backported to branch-3.5 via &lt;a href=&quot;https://github.com/apache/spark/pull/52135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/52135&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1wudk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>