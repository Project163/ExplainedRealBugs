<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:59:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-23004] Structured Streaming raise &quot;llegalStateException: Cannot remove after already committed or aborted&quot;</title>
                <link>https://issues.apache.org/jira/browse/SPARK-23004</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;A structured streaming query with a streaming aggregation can throw the following error in rare cases.&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.IllegalStateException: Cannot remove after already committed or aborted at org.apache.spark.sql.execution.streaming.state.HDFSBackedStateStoreProvider.org$apache$spark$sql$execution$streaming$state$HDFSBackedStateStoreProvider$$verify(HDFSBackedStateStoreProvider.scala:659 ) at org.apache.spark.sql.execution.streaming.state.HDFSBackedStateStoreProvider$HDFSBackedStateStore.remove(HDFSBackedStateStoreProvider.scala:143) at org.apache.spark.sql.execution.streaming.StateStoreSaveExec$$anonfun$doExecute$3$$anon$1.hasNext(statefulOperators.scala:233) at org.apache.spark.sql.execution.aggregate.ObjectAggregationIterator.processInputs(ObjectAggregationIterator.scala:191) at org.apache.spark.sql.execution.aggregate.ObjectAggregationIterator.&amp;lt;init&amp;gt;(ObjectAggregationIterator.scala:80) at org.apache.spark.sql.execution.aggregate.ObjectHashAggregateExec$$anonfun$doExecute$1$$anonfun$2.apply(ObjectHashAggregateExec.scala:111) at org.apache.spark.sql.execution.aggregate.ObjectHashAggregateExec$$anonfun$doExecute$1$$anonfun$2.apply(ObjectHashAggregateExec.scala:103) at org.apache.spark.rdd.RDD$$anonfun$mapPartitionsInternal$1$$anonfun$apply$25.apply(RDD.scala:827) at org.apache.spark.rdd.RDD$$anonfun$mapPartitionsInternal$1$$anonfun$apply$25.apply(RDD.scala:827) at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38) at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:323) at org.apache.spark.rdd.RDD.iterator(RDD.scala:287) at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38) at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:323) at org.apache.spark.rdd.RDD.iterator(RDD.scala:287) at org.apache.spark.scheduler.ResultTask.runTask(ResultTask.scala:87) at org.apache.spark.scheduler.Task.run(Task.scala:108) at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:338) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) 18-01-05 13:29:57 WARN TaskSetManager:66 Lost task 68.0 in stage 1933.0 (TID 196171, localhost, executor driver): java.lang.IllegalStateException: Cannot remove after already committed or aborted at org.apache.spark.sql.execution.streaming.state.HDFSBackedStateStoreProvider.org$apache$spark$sql$execution$streaming$state$HDFSBackedStateStoreProvider$$verify(HDFSBackedStateStoreProvider.scala:659)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This can happen when the following conditions are accidentally hit.&#160;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Streaming aggregation with aggregation function that is a subset of &lt;tt&gt;&lt;a href=&quot;https://github.com/apache/spark/blob/76b8b840ddc951ee6203f9cccd2c2b9671c1b5e8/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/expressions/aggregate/interfaces.scala#L473&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;TypedImperativeAggregation&lt;/a&gt;&lt;/tt&gt; (for example, &lt;tt&gt;collect_set&lt;/tt&gt;, &lt;tt&gt;collect_list&lt;/tt&gt;, &lt;tt&gt;percentile&lt;/tt&gt;, etc.).&#160;&lt;/li&gt;
	&lt;li&gt;Query running in &lt;tt&gt;update&lt;/tt&gt; mode&lt;/li&gt;
	&lt;li&gt;After the shuffle, a partition has exactly 128 records.&#160;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;This happens because of the following.&#160;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The &lt;tt&gt;StateStoreSaveExec&lt;/tt&gt; used in streaming aggregations has the &lt;a href=&quot;https://github.com/apache/spark/blob/76b8b840ddc951ee6203f9cccd2c2b9671c1b5e8/sql/core/src/main/scala/org/apache/spark/sql/execution/streaming/statefulOperators.scala#L359&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;following logic&lt;/a&gt; when used in &lt;tt&gt;update&lt;/tt&gt; mode.
	&lt;ol&gt;
		&lt;li&gt;There is an iterator that reads data from its parent iterator and updates the StateStore.&lt;/li&gt;
		&lt;li&gt;When the parent iterator is fully consumed (i.e. &lt;tt&gt;baseIterator.hasNext&lt;/tt&gt; returns false) then all state changes are committed by calling &lt;tt&gt;StateStore.commit&lt;/tt&gt;.&#160;&lt;/li&gt;
		&lt;li&gt;The implementation of &lt;tt&gt;StateStore.commit()&lt;/tt&gt; in &lt;tt&gt;HDFSBackedStateStore&lt;/tt&gt; does not allow itself to be called twice. However, the logic is such that,&#160;if &lt;tt&gt;hasNext&lt;/tt&gt; is called multiple times after &lt;tt&gt;baseIterator.hasNext&lt;/tt&gt; has returned false then each time it will call &lt;tt&gt;StateStore.commit&lt;/tt&gt;.&lt;/li&gt;
		&lt;li&gt;For most aggregation functions, this is okay because &lt;tt&gt;hasNext&lt;/tt&gt; is only called once. But thats&#160;not the case with &lt;tt&gt;ImperativeTypedAggregates&lt;/tt&gt;.&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;ImperativeTypedAggregates&lt;/tt&gt; are executed using &lt;tt&gt;ObjectHashAggregateExec&lt;/tt&gt; which will try to use two kinds of hashmaps for aggregations.&#160;
	&lt;ol&gt;
		&lt;li&gt;It will first try to use an unsorted hashmap. If the size of the hashmap increases beyond a certain threshold (default 128), then it will switch to using a sorted hashmap.&#160;&lt;/li&gt;
		&lt;li&gt;The &lt;a href=&quot;https://github.com/apache/spark/blob/76b8b840ddc951ee6203f9cccd2c2b9671c1b5e8/sql/core/src/main/scala/org/apache/spark/sql/execution/aggregate/ObjectAggregationIterator.scala&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;switching logic&lt;/a&gt; in &lt;tt&gt;ObjectAggregationIterator&lt;/tt&gt; (used by &lt;tt&gt;ObjectHashAggregateExec&lt;/tt&gt;)&#160;&#160;is such that when the number of records matches the threshold (i.e. 128), it will end up calling the &lt;tt&gt;iterator.hasNext&lt;/tt&gt; twice.&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;When combined with the above two conditions are combined, it leads to the above error. This latent bug has existed since Spark 2.1 when &lt;tt&gt;ObjectHashAggregateExec&lt;/tt&gt; was introduced in Spark.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Run on yarn or local both raise the exception.&lt;/p&gt;</environment>
        <key id="13129503">SPARK-23004</key>
            <summary>Structured Streaming raise &quot;llegalStateException: Cannot remove after already committed or aborted&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tdas">Tathagata Das</assignee>
                                    <reporter username="secfree">deprecated-se</reporter>
                        <labels>
                    </labels>
                <created>Tue, 9 Jan 2018 11:31:20 +0000</created>
                <updated>Fri, 13 Jul 2018 05:30:55 +0000</updated>
                            <resolved>Mon, 23 Apr 2018 20:21:12 +0000</resolved>
                                    <version>2.1.0</version>
                    <version>2.1.1</version>
                    <version>2.1.2</version>
                    <version>2.2.0</version>
                    <version>2.2.1</version>
                    <version>2.3.0</version>
                                    <fixVersion>2.3.1</fixVersion>
                    <fixVersion>2.4.0</fixVersion>
                                    <component>Structured Streaming</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16318738" author="srowen" created="Tue, 9 Jan 2018 16:56:37 +0000"  >&lt;p&gt;There&apos;s no info here about how you get into this situation. Do you have a reproduction or any context?&lt;/p&gt;</comment>
                            <comment id="16447440" author="tdas" created="Mon, 23 Apr 2018 00:42:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=joshrosen&quot; class=&quot;user-hover&quot; rel=&quot;joshrosen&quot;&gt;joshrosen&lt;/a&gt;&#160;hit the issue as well, and thanks to him I could reproduce it. I am updating the description of the Jira to include more details. This is a long-standing crazy issue!&lt;/p&gt;</comment>
                            <comment id="16447441" author="secfree" created="Mon, 23 Apr 2018 00:46:00 +0000"  >&lt;p&gt;secfree &#36190;&#20102;&#24744;&#30340;&#37038;&#20214;&#12290;&lt;br/&gt;
Spark by Readdle&lt;/p&gt;</comment>
                            <comment id="16447449" author="apachespark" created="Mon, 23 Apr 2018 01:30:05 +0000"  >&lt;p&gt;User &apos;tdas&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21124&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16448802" author="tdas" created="Mon, 23 Apr 2018 20:21:12 +0000"  >&lt;p&gt;Issue resolved by pull request 21124&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21124&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 30 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ooif:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12342432">2.3.1</customfieldvalue>
    <customfieldvalue id="12342385">2.4.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>