<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:49:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-18091] Deep if expressions cause Generated SpecificUnsafeProjection code to exceed JVM code size limit</title>
                <link>https://issues.apache.org/jira/browse/SPARK-18091</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;&lt;b&gt;Problem Description:&lt;/b&gt;&lt;br/&gt;
I have an application in which a lot of if-else decisioning is involved to generate output. I&apos;m getting following exception:&lt;br/&gt;
Caused by: org.codehaus.janino.JaninoRuntimeException: Code of method &quot;(Lorg/apache/spark/sql/catalyst/expressions/GeneratedClass$SpecificUnsafeProjection;Lorg/apache/spark/sql/catalyst/InternalRow;)V&quot; of class &quot;org.apache.spark.sql.catalyst.expressions.GeneratedClass$SpecificUnsafeProjection&quot; grows beyond 64 KB&lt;br/&gt;
	at org.codehaus.janino.CodeContext.makeSpace(CodeContext.java:941)&lt;br/&gt;
	at org.codehaus.janino.CodeContext.write(CodeContext.java:874)&lt;br/&gt;
	at org.codehaus.janino.CodeContext.writeBranch(CodeContext.java:965)&lt;br/&gt;
	at org.codehaus.janino.UnitCompiler.writeBranch(UnitCompiler.java:10261)&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Steps to Reproduce:&lt;/b&gt;&lt;br/&gt;
I&apos;ve come up with a unit test which I was able to run in CodeGenerationSuite.scala:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;test(&lt;span class=&quot;code-quote&quot;&gt;&quot;split large &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; expressions into blocks due to JVM code size limit&quot;&lt;/span&gt;) {
    val row = create_row(&lt;span class=&quot;code-quote&quot;&gt;&quot;afafFAFFsqcategory2dadDADcategory8sasasadscategory24&quot;&lt;/span&gt;, 0)
    val inputStr = &apos;a.string.at(0)
    val inputIdx = &apos;a.&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;.at(1)

    val length = 10
    val valuesToCompareTo = &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (i &amp;lt;- 1 to (length + 1)) yield (&lt;span class=&quot;code-quote&quot;&gt;&quot;category&quot;&lt;/span&gt; + i)

    val initCondition = EqualTo(RegExpExtract(inputStr, Literal(&lt;span class=&quot;code-quote&quot;&gt;&quot;category1&quot;&lt;/span&gt;), inputIdx), valuesToCompareTo(0))
    &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; res: Expression = If(initCondition, Literal(&lt;span class=&quot;code-quote&quot;&gt;&quot;category1&quot;&lt;/span&gt;), Literal(&lt;span class=&quot;code-quote&quot;&gt;&quot;NULL&quot;&lt;/span&gt;))
    &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; cummulativeCondition: Expression = Not(initCondition)
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (index &amp;lt;- 1 to length) {
      val valueExtractedFromInput = RegExpExtract(inputStr, Literal(&lt;span class=&quot;code-quote&quot;&gt;&quot;category&quot;&lt;/span&gt; + (index + 1).toString), inputIdx)
      val currComparee = If(cummulativeCondition, valueExtractedFromInput, Literal(&lt;span class=&quot;code-quote&quot;&gt;&quot;NULL&quot;&lt;/span&gt;))
      val currCondition = EqualTo(currComparee, valuesToCompareTo(index))
      val combinedCond = And(cummulativeCondition, currCondition)
      res = If(combinedCond, If(combinedCond, valueExtractedFromInput, Literal(&lt;span class=&quot;code-quote&quot;&gt;&quot;NULL&quot;&lt;/span&gt;)), res)
      cummulativeCondition = And(Not(currCondition), cummulativeCondition)
    }

    val expressions = Seq(res)
    val plan = GenerateUnsafeProjection.generate(expressions, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
    val actual = plan(row).toSeq(expressions.map(_.dataType))
    val expected = Seq(UTF8String.fromString(&lt;span class=&quot;code-quote&quot;&gt;&quot;category2&quot;&lt;/span&gt;))

    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!checkResult(actual, expected)) {
      fail(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Incorrect Evaluation: expressions: $expressions, actual: $actual, expected: $expected&quot;&lt;/span&gt;)
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;Root Cause:&lt;/b&gt;&lt;br/&gt;
Current splitting of Projection codes doesn&apos;t (and can&apos;t) take care of splitting the generated code for individual output column expressions. So it can grow to exceed JVM limit.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Note:&lt;/b&gt; This issue seems related to &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-14887&quot; title=&quot;Generated SpecificUnsafeProjection Exceeds JVM Code Size Limits&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-14887&quot;&gt;&lt;del&gt;SPARK-14887&lt;/del&gt;&lt;/a&gt; but I&apos;m not sure whether the root cause is same&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Proposed Fix:&lt;/b&gt;&lt;br/&gt;
If expression should place it&apos;s predicate, true value and false value expressions&apos; generated code in separate methods in context and call these methods instead of putting the whole code directly in its generated code&lt;/p&gt;</description>
                <environment></environment>
        <key id="13015002">SPARK-18091</key>
            <summary>Deep if expressions cause Generated SpecificUnsafeProjection code to exceed JVM code size limit</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kapilsingh5050">Kapil Singh</assignee>
                                    <reporter username="kapilsingh5050">Kapil Singh</reporter>
                        <labels>
                    </labels>
                <created>Tue, 25 Oct 2016 08:02:30 +0000</created>
                <updated>Thu, 23 Feb 2017 00:58:48 +0000</updated>
                            <resolved>Sun, 4 Dec 2016 09:20:07 +0000</resolved>
                                    <version>1.6.1</version>
                                    <fixVersion>2.0.3</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15604587" author="kapilsingh5050" created="Tue, 25 Oct 2016 08:06:46 +0000"  >&lt;p&gt;I&apos;ve started working on this&lt;/p&gt;</comment>
                            <comment id="15604806" author="apachespark" created="Tue, 25 Oct 2016 09:43:04 +0000"  >&lt;p&gt;User &apos;kapilsingh5050&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15620&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15620&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15722292" author="apachespark" created="Mon, 5 Dec 2016 13:41:05 +0000"  >&lt;p&gt;User &apos;kapilsingh5050&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/16146&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16146&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15871702" author="jsoltren" created="Fri, 17 Feb 2017 11:20:12 +0000"  >&lt;p&gt;FWIW, anyone pulling this fix in the future will also want &lt;a href=&quot;https://github.com/apache/spark/pull/16244&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/16244&lt;/a&gt;, or else a bunch of tests will fail.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 39 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i35cjb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12335644">2.1.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>