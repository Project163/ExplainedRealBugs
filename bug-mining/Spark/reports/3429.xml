<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:41:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-11316] coalesce doesn&apos;t handle UnionRDD with partial locality properly</title>
                <link>https://issues.apache.org/jira/browse/SPARK-11316</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;So I haven&apos;t fully debugged this yet but reporting what I&apos;m seeing and think might be going on.&lt;/p&gt;

&lt;p&gt;I have a graph processing job that is seeing huge slow down in setupGroups in the location iterator where its getting the preferred locations for the coalesce.  They are coalescing from 2400 down to 1200 and its taking 17+ hours to do the calculation.  Killed it at this point so don&apos;t know total time.&lt;/p&gt;

&lt;p&gt;It appears that the job is doing an isEmpty call, a bunch of other transformation, then a coalesce (where it takes so long), other transformations, then finally a count to trigger it.   &lt;/p&gt;

&lt;p&gt;It appears that there is only one node that its finding in the setupGroup call and to get to that node it has to first to through the while loop:&lt;/p&gt;

&lt;p&gt;    while (numCreated &amp;lt; targetLen &amp;amp;&amp;amp; tries &amp;lt; expectedCoupons2) {&lt;br/&gt;
where expectedCoupons2 is around 19000.  It finds very few or none in this loop.  &lt;/p&gt;

&lt;p&gt;Then it does the second loop:&lt;/p&gt;

&lt;p&gt;while (numCreated &amp;lt; targetLen) {  // if we don&apos;t have enough partition groups, create duplicates&lt;br/&gt;
      var (nxt_replica, nxt_part) = rotIt.next()&lt;br/&gt;
      val pgroup = PartitionGroup(nxt_replica)&lt;br/&gt;
      groupArr += pgroup&lt;br/&gt;
      groupHash.getOrElseUpdate(nxt_replica, ArrayBuffer()) += pgroup&lt;br/&gt;
      var tries = 0&lt;br/&gt;
      while (!addPartToPGroup(nxt_part, pgroup) &amp;amp;&amp;amp; tries &amp;lt; targetLen) &lt;/p&gt;
{ // ensure at least one part
        nxt_part = rotIt.next()._2
        tries += 1
      }
&lt;p&gt;      numCreated += 1&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;Where it has an inner while loop and both of those are going 1200 times.  1200*1200 loops.  This is taking a very long time.&lt;/p&gt;

&lt;p&gt;The user can work around the issue by adding in a count() call very close to after the isEmpty call before the coalesce is called.  I also tried putting in a take(10000)  right before the isEmpty call and it seems to work around the issue, took 1 hours with the take vs a few minutes with the count().&lt;/p&gt;</description>
                <environment></environment>
        <key id="12907917">SPARK-11316</key>
            <summary>coalesce doesn&apos;t handle UnionRDD with partial locality properly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tgraves">Thomas Graves</assignee>
                                    <reporter username="tgraves">Thomas Graves</reporter>
                        <labels>
                    </labels>
                <created>Mon, 26 Oct 2015 14:00:33 +0000</created>
                <updated>Wed, 1 Jun 2016 15:38:57 +0000</updated>
                            <resolved>Tue, 3 May 2016 20:43:39 +0000</resolved>
                                    <version>1.5.1</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14974236" author="tgraves" created="Mon, 26 Oct 2015 14:06:58 +0000"  >&lt;p&gt;Note I&quot;m wondering if since the isEmpty call is doing a take(1) if its only finding 1 locations and thus throwing off the setupGroups call.&lt;/p&gt;</comment>
                            <comment id="15131196" author="apachespark" created="Wed, 3 Feb 2016 21:38:03 +0000"  >&lt;p&gt;User &apos;zhuoliu&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/11060&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/11060&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15139658" author="tgraves" created="Tue, 9 Feb 2016 19:59:40 +0000"  >&lt;p&gt;So we ran into this again, here is the scenario and what is happening:&lt;/p&gt;

&lt;p&gt;UnionRDD is being coalesced.  The UnionRDD is made up of mapPartitionRDD with not preferred locations and a checkpointedRDD with preferred locations.&lt;/p&gt;

&lt;p&gt;Its coalescing to a &amp;gt; number of partitions but its not using shuffle so its going to coalesce to same number of partitions.  The UnionRDD has 2 Rdd&apos;s, one with 1020 in MapPartitionsRDD and 960 in CheckPointedRDD, thus its coalescing from 1980 to 1980.   It goes into the setupGroups called to setup 1980 groups, but since the MapPartitionsRDD doesn&apos;t have preferred locations it only has 960 actual preferred locations.  It goes through the first while loop and create partitionsGroups for each of the hosts possible until it hits expectedCoupons2 number. In this has it hits 1661, so it created groups for 1661 of 1980 and a bunch of those groups got partitions assigned (out of the 960).&lt;/p&gt;

&lt;p&gt;It then enters the second while loop to go through the rest of the 1980-1661=319 groups it needs.  Here though for each of the 319 iterations it goes into the inner while loop while (!addPartToPGroup(nxt_part, pgroup) &amp;amp;&amp;amp; tries &amp;lt; targetLen) trying to add a partition to each group.  In this case since there are less partitions then groups it ends up walking through targetLen almost all of the times and never adding a partition to the group because all the partitions are already assigned to groups (because we only have 960 partitions to put into 1980 groups).  The entire process of 319 * 1980 tries takes over 15 minutes (3 seconds per 319 interation).&lt;/p&gt;</comment>
                            <comment id="15159443" author="apachespark" created="Tue, 23 Feb 2016 19:07:06 +0000"  >&lt;p&gt;User &apos;tgravescs&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/11327&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/11327&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15264205" author="tgraves" created="Fri, 29 Apr 2016 15:37:56 +0000"  >&lt;p&gt;Simple steps to reproduce an RDD with partial preferred locations, Any text file will do here:&lt;/p&gt;

&lt;p&gt;val textFile = sc.textFile(&quot;randomtext2.txt&quot;)&lt;br/&gt;
val textFile2 = sc.textFile(&quot;README.md&quot;)&lt;br/&gt;
val wordCounts4 = textFile.flatMap(line =&amp;gt; line.split(&quot; &quot;)).map(word =&amp;gt; (word, 1)).reduceByKey((a, b) =&amp;gt; a + b)&lt;br/&gt;
val wordCounts5 = textFile2.flatMap(line =&amp;gt; line.split(&quot; &quot;)).map(word =&amp;gt; (word, 1)).reduceByKey((a, b) =&amp;gt; a + b)&lt;br/&gt;
sc.setCheckpointDir(&quot;hdfs:///user/tgraves/test10&quot;)&lt;br/&gt;
wordCounts5.checkpoint()&lt;br/&gt;
wordCounts5.take(1)&lt;br/&gt;
val urdd = wordCounts4.union(wordCounts5)&lt;br/&gt;
urdd.coalesce(10).count()&lt;/p&gt;</comment>
                            <comment id="15269547" author="davies" created="Tue, 3 May 2016 20:43:39 +0000"  >&lt;p&gt;Issue resolved by pull request 11327&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/11327&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/11327&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12974258">SPARK-15671</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 28 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2niuf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>