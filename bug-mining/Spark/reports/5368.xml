<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:57:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-22778] Kubernetes scheduler at master failing to run applications successfully</title>
                <link>https://issues.apache.org/jira/browse/SPARK-22778</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Building images based on master and deploying Spark PI results in the following error.&lt;/p&gt;

&lt;p&gt;2017-12-13 19:57:19 INFO  SparkContext:54 - Successfully stopped SparkContext&lt;br/&gt;
Exception in thread &quot;main&quot; org.apache.spark.SparkException: Could not parse Master URL: &apos;k8s:&lt;a href=&quot;https://xx.yy.zz.ww&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://xx.yy.zz.ww&lt;/a&gt;&apos;&lt;br/&gt;
	at org.apache.spark.SparkContext$.org$apache$spark$SparkContext$$createTaskScheduler(SparkContext.scala:2741)&lt;br/&gt;
	at org.apache.spark.SparkContext.&amp;lt;init&amp;gt;(SparkContext.scala:496)&lt;br/&gt;
	at org.apache.spark.SparkContext$.getOrCreate(SparkContext.scala:2490)&lt;br/&gt;
	at org.apache.spark.sql.SparkSession$Builder$$anonfun$7.apply(SparkSession.scala:927)&lt;br/&gt;
	at org.apache.spark.sql.SparkSession$Builder$$anonfun$7.apply(SparkSession.scala:918)&lt;br/&gt;
	at scala.Option.getOrElse(Option.scala:121)&lt;br/&gt;
	at org.apache.spark.sql.SparkSession$Builder.getOrCreate(SparkSession.scala:918)&lt;br/&gt;
	at org.apache.spark.examples.SparkPi$.main(SparkPi.scala:31)&lt;br/&gt;
	at org.apache.spark.examples.SparkPi.main(SparkPi.scala)&lt;br/&gt;
2017-12-13 19:57:19 INFO  ShutdownHookManager:54 - Shutdown hook called&lt;br/&gt;
2017-12-13 19:57:19 INFO  ShutdownHookManager:54 - Deleting directory /tmp/spark-b47515c2-6750-4a37-aa68-6ee12da5d2bd&lt;/p&gt;

&lt;p&gt;This is likely an artifact seen because of changes in master, or our submission code in the reviews. We haven&apos;t seen this on our fork. Hopefully once integration tests are ported against upstream/master, we will catch these issues earlier. &lt;/p&gt;</description>
                <environment></environment>
        <key id="13124774">SPARK-22778</key>
            <summary>Kubernetes scheduler at master failing to run applications successfully</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="liyinan926">Yinan Li</assignee>
                                    <reporter username="foxish">Anirudh Ramanathan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 13 Dec 2017 20:14:29 +0000</created>
                <updated>Sun, 17 May 2020 18:23:27 +0000</updated>
                            <resolved>Thu, 14 Dec 2017 22:03:27 +0000</resolved>
                                    <version>2.3.0</version>
                                    <fixVersion>2.3.0</fixVersion>
                                    <component>Kubernetes</component>
                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16289808" author="foxish" created="Wed, 13 Dec 2017 20:15:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mcheah&quot; class=&quot;user-hover&quot; rel=&quot;mcheah&quot;&gt;mcheah&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kimoonkim&quot; class=&quot;user-hover&quot; rel=&quot;kimoonkim&quot;&gt;kimoonkim&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifilonenko&quot; class=&quot;user-hover&quot; rel=&quot;ifilonenko&quot;&gt;ifilonenko&lt;/a&gt; PTAL&lt;/p&gt;</comment>
                            <comment id="16289815" author="mcheah" created="Wed, 13 Dec 2017 20:18:36 +0000"  >&lt;p&gt;Think that URI should be &apos;k8s://&lt;a href=&quot;https://xx.yy.zz.ww&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://xx.yy.zz.ww&lt;/a&gt;&apos; - notice the extra slashes?&lt;/p&gt;</comment>
                            <comment id="16289818" author="foxish" created="Wed, 13 Dec 2017 20:21:51 +0000"  >&lt;p&gt;I submitted it as `k8s://&lt;a href=&quot;https://xx.yy.zz.ww&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://xx.yy.zz.ww&lt;/a&gt;` to spark submit. However, it seems there is some change in how the validation of said URL occurs on the client-side - which makes us strip out the k8s and add it back in the above format. That might be at fault here. &lt;/p&gt;

&lt;p&gt;Here&apos;s my full spark-submit command:&lt;/p&gt;

&lt;p&gt;bin/spark-submit \&lt;br/&gt;
  --deploy-mode cluster \&lt;br/&gt;
  --class org.apache.spark.examples.SparkPi \&lt;br/&gt;
  --master k8s://&lt;a href=&quot;https://xx.yy.zz.ww&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://xx.yy.zz.ww&lt;/a&gt; \&lt;br/&gt;
  --conf spark.executor.instances=5 \&lt;br/&gt;
  --conf spark.app.name=spark-pi \&lt;br/&gt;
  --conf spark.kubernetes.driver.docker.image=foxish/spark-driver:spark-k8s-master-13dec-11-56 \&lt;br/&gt;
  --conf spark.kubernetes.executor.docker.image=foxish/spark-executor:spark-k8s-master-13dec-11-56 \&lt;br/&gt;
  local:///opt/spark/examples/jars/spark-examples_2.11-2.3.0-SNAPSHOT.jar&lt;/p&gt;</comment>
                            <comment id="16289822" author="liyinan926" created="Wed, 13 Dec 2017 20:23:01 +0000"  >&lt;p&gt;Just some background on this. The validation and parsing of k8s master url has been moved to SparkSubmit as being suggested in the review. The parsed master URL (&lt;a href=&quot;https://&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://&lt;/a&gt;... for example) is appended a &lt;tt&gt;k8s&lt;/tt&gt; prefix after the parsing to satisfy &lt;tt&gt;KubernetesClusterManager&lt;/tt&gt;, whose &lt;tt&gt;canCreate&lt;/tt&gt; method is based on if the master URL starts &lt;tt&gt;k8s&lt;/tt&gt;. That&apos;s why you see the &lt;tt&gt;k8s:&lt;/tt&gt; prefix. The issue seems that in the driver pod &lt;tt&gt;SparkContext&lt;/tt&gt; could not find &lt;tt&gt;KubernetesClusterManager&lt;/tt&gt; based on the debug messages I added. The code that triggered the error (with the debugging I added) is as follows:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; def getClusterManager(url: &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;): Option[ExternalClusterManager] = {
    val loader = Utils.getContextOrSparkClassLoader
    val serviceLoaders =
      ServiceLoader.load(classOf[ExternalClusterManager], loader).asScala
    serviceLoaders.foreach { loader =&amp;gt;
      logInfo(s&lt;span class=&quot;code-quote&quot;&gt;&quot;Found the following external cluster manager: $loader&quot;&lt;/span&gt;)
    }

    val filteredServiceLoaders = serviceLoaders.filter(_.canCreate(url))
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (filteredServiceLoaders.size &amp;gt; 1) {
      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SparkException(
        s&lt;span class=&quot;code-quote&quot;&gt;&quot;Multiple external cluster managers registered &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the url $url: $serviceLoaders&quot;&lt;/span&gt;)
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (filteredServiceLoaders.isEmpty) {
      logWarning(s&lt;span class=&quot;code-quote&quot;&gt;&quot;No external cluster manager registered &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; url $url&quot;&lt;/span&gt;)
    }
    filteredServiceLoaders.headOption
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And I got the following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
No external cluster manager registered &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; url k8s:https:&lt;span class=&quot;code-comment&quot;&gt;//35.226.8.173&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16289836" author="mcheah" created="Wed, 13 Dec 2017 20:27:47 +0000"  >&lt;p&gt;The &lt;tt&gt;canCreate&lt;/tt&gt; method for &lt;tt&gt;KubernetesClusterManager&lt;/tt&gt; should match that URI. The primary possibility I can think of is that the &lt;tt&gt;KubernetesClusterManager&lt;/tt&gt; isn&apos;t being service loaded at all, which would imply that &lt;tt&gt;spark-kubernetes&lt;/tt&gt; isn&apos;t on the classpath. Can we verify that the Docker image contains all of the correct jars?&lt;/p&gt;</comment>
                            <comment id="16289868" author="foxish" created="Wed, 13 Dec 2017 20:41:29 +0000"  >&lt;p&gt;I&apos;ve verified that the image contains the right jars.&lt;br/&gt;
One more thing that changed from underneath us is &lt;a href=&quot;https://github.com/apache/spark/pull/19631&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19631&lt;/a&gt;. Not sure yet if that&apos;s related.&lt;/p&gt;</comment>
                            <comment id="16289871" author="mcheah" created="Wed, 13 Dec 2017 20:45:14 +0000"  >&lt;p&gt;I see the problem. We&apos;re missing the &lt;tt&gt;META-INF.services&lt;/tt&gt; file that tells service loaders to include our implementation. See &lt;a href=&quot;https://github.com/apache-spark-on-k8s/spark/blob/branch-2.2-kubernetes/resource-managers/kubernetes/core/src/main/resources/META-INF/services/org.apache.spark.scheduler.ExternalClusterManager&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache-spark-on-k8s/spark/blob/branch-2.2-kubernetes/resource-managers/kubernetes/core/src/main/resources/META-INF/services/org.apache.spark.scheduler.ExternalClusterManager&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16289875" author="mcheah" created="Wed, 13 Dec 2017 20:45:47 +0000"  >&lt;p&gt;And then notice we don&apos;t even have a &lt;tt&gt;resources&lt;/tt&gt; directory on master: &lt;a href=&quot;https://github.com/apache/spark/tree/master/resource-managers/kubernetes/core/src&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/tree/master/resource-managers/kubernetes/core/src&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16289876" author="liyinan926" created="Wed, 13 Dec 2017 20:46:35 +0000"  >&lt;p&gt;Ah, yes, the PR missed that. OK, I&apos;m gonna give that a try and submit a PR to fix it.&lt;/p&gt;</comment>
                            <comment id="16289881" author="foxish" created="Wed, 13 Dec 2017 20:49:14 +0000"  >&lt;p&gt;Excellent - thanks for the quick debug Matt. Now waiting for confirmation that the fix is sufficient. I also suggest we fix the URL format to prepend `k8s://` as opposed to just `k8s:` in the interest of having a URL looking more well-formed. &lt;/p&gt;</comment>
                            <comment id="16289907" author="liyinan926" created="Wed, 13 Dec 2017 21:03:25 +0000"  >&lt;p&gt;Just verified that the fix worked. I&apos;m gonna send a PR soon.&lt;/p&gt;</comment>
                            <comment id="16289923" author="apachespark" created="Wed, 13 Dec 2017 21:14:05 +0000"  >&lt;p&gt;User &apos;liyinan926&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19972&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19972&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16291689" author="vanzin" created="Thu, 14 Dec 2017 22:03:27 +0000"  >&lt;p&gt;Issue resolved by pull request 19972&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/19972&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/19972&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 48 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3nvhr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>