<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:03:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-26708] Incorrect result caused by inconsistency between a SQL cache&apos;s cached RDD and its physical plan</title>
                <link>https://issues.apache.org/jira/browse/SPARK-26708</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When performing non-cascading cache invalidation,&#160;&lt;tt&gt;recache&lt;/tt&gt;&#160;is called on the other cache entries which are dependent on the cache being invalidated. It leads to the the physical plans of those cache entries being re-compiled. For those cache entries, if the cache RDD has already been persisted, chances are there will be inconsistency between the data and the new plan. It can cause a correctness issue if the new plan&apos;s&#160;&lt;tt&gt;outputPartitioning&lt;/tt&gt;&#160;or&#160;&lt;tt&gt;outputOrdering&lt;/tt&gt;&#160;is different from the that of the actual data, and meanwhile the cache is used by another query that asks for specific&#160;&lt;tt&gt;outputPartitioning&lt;/tt&gt;&#160;or&#160;&lt;tt&gt;outputOrdering&lt;/tt&gt;&#160;which happens to match the new plan but not the actual data.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13211373">SPARK-26708</key>
            <summary>Incorrect result caused by inconsistency between a SQL cache&apos;s cached RDD and its physical plan</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="maryannxue">Wei Xue</assignee>
                                    <reporter username="smilegator">Xiao Li</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Wed, 23 Jan 2019 20:54:41 +0000</created>
                <updated>Wed, 27 Mar 2024 00:58:07 +0000</updated>
                            <resolved>Tue, 29 Jan 2019 12:36:01 +0000</resolved>
                                    <version>2.4.0</version>
                                    <fixVersion>2.4.1</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16751927" author="dongjoon" created="Fri, 25 Jan 2019 06:17:05 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smilegator&quot; class=&quot;user-hover&quot; rel=&quot;smilegator&quot;&gt;smilegator&lt;/a&gt;. Is this only related to Spark 2.4.0?&lt;/p&gt;</comment>
                            <comment id="16752866" author="maropu" created="Sat, 26 Jan 2019 00:49:14 +0000"  >&lt;p&gt;I also want to know that this is related to branch-2.3...&lt;/p&gt;</comment>
                            <comment id="16754300" author="smilegator" created="Mon, 28 Jan 2019 19:43:37 +0000"  >&lt;p&gt;I do not think this affects 2.3&lt;/p&gt;</comment>
                            <comment id="16754499" author="maropu" created="Tue, 29 Jan 2019 01:48:49 +0000"  >&lt;p&gt;Yea, thanks for the answer!&lt;/p&gt;</comment>
                            <comment id="16754960" author="maropu" created="Tue, 29 Jan 2019 12:36:01 +0000"  >&lt;p&gt;Resolved by &lt;a href=&quot;https://github.com/apache/spark/pull/23644&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/23644&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16761289" author="bersprockets" created="Tue, 5 Feb 2019 23:01:07 +0000"  >&lt;p&gt;How does one hit this issue?&lt;/p&gt;

&lt;p&gt;Edit: Ah, never mind. I see there is a test.&lt;/p&gt;</comment>
                            <comment id="17831116" author="ashahid7" created="Wed, 27 Mar 2024 00:50:47 +0000"  >&lt;p&gt;I believe the current caching logic is suboptimal and accordingly the bug test for it is testing a suboptimal approach.&lt;/p&gt;

&lt;p&gt;The bug test for this is&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;test(&quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-26708&quot; title=&quot;Incorrect result caused by inconsistency between a SQL cache&amp;#39;s cached RDD and its physical plan&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-26708&quot;&gt;&lt;del&gt;SPARK-26708&lt;/del&gt;&lt;/a&gt; Cache data and cached plan should stay consistent&quot;) &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {
val df = spark.range(0, 5).toDF(&amp;quot;a&amp;quot;)
val df1 = df.withColumn(&amp;quot;b&amp;quot;, $&amp;quot;a&amp;quot; + 1)
val df2 = df.filter($&amp;quot;a&amp;quot; &amp;gt; 1)

df.cache()
// Add df1 to the CacheManager; the buffer is currently empty.
df1.cache()
// After calling collect(), df1&amp;#39;s buffer has been loaded.
df1.collect()
// Add df2 to the CacheManager; the buffer is currently empty.
df2.cache()

// Verify that df1 is a InMemoryRelation plan with dependency on another cached plan.
assertCacheDependency(df1)
val df1InnerPlan = df1.queryExecution.withCachedData
.asInstanceOf[InMemoryRelation].cacheBuilder.cachedPlan
// Verify that df2 is a InMemoryRelation plan with dependency on another cached plan.
assertCacheDependency(df2)

df.unpersist(blocking = true)

// Verify that df1&amp;#39;s cache has stayed the same, since df1&amp;#39;s cache already has data
// before df.unpersist().
val df1Limit = df1.limit(2)
val df1LimitInnerPlan = df1Limit.queryExecution.withCachedData.collectFirst
Unknown macro}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;assert(df1LimitInnerPlan.isDefined &amp;amp;&amp;amp; df1LimitInnerPlan.get == df1InnerPlan)&lt;/p&gt;

&lt;p&gt;// Verify that df2&apos;s cache has been re-cached, with a new physical plan rid of dependency&lt;br/&gt;
// on df, since df2&apos;s cache had not been loaded before df.unpersist().&lt;br/&gt;
val df2Limit = df2.limit(2)&lt;br/&gt;
val df2LimitInnerPlan = df2Limit.queryExecution.withCachedData.collectFirst&lt;br/&gt;
Unknown macro: { case i}&lt;br/&gt;
assert(df2LimitInnerPlan.isDefined &amp;amp;&amp;amp;&lt;br/&gt;
!df2LimitInnerPlan.get.exists(_.isInstanceOf&lt;span class=&quot;error&quot;&gt;&amp;#91;InMemoryTableScanExec&amp;#93;&lt;/span&gt;))&lt;br/&gt;
}&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The optimal caching should have resulted in df2LimitInnerPlan&#160; actually containing &#160;InMemoryTableScanExec which should have corresponded to df1.&lt;/p&gt;

&lt;p&gt;The reason being that since df1 was already materialized, so it exists in the cache rightly.&lt;/p&gt;

&lt;p&gt;And df2 is derivable from the cached df1 ( it just has extra projection but otherwise can serve the df2).&lt;/p&gt;</comment>
                            <comment id="17831117" author="ashahid7" created="Wed, 27 Mar 2024 00:52:41 +0000"  >&lt;p&gt;Towards that please take a look at ticket &amp;amp; PR:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-45959&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/SPARK-45959&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;and the PR associated with it.&lt;/p&gt;

&lt;p&gt;Though that PR primarily deals with aggressive collapse of projects at the end of analysis . But it also as part of fix, uses enhanced cached plan lookup and thus results in the above behaviour.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 32 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|yi08j4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>