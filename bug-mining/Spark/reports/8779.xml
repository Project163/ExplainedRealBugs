<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:31:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-41008] Isotonic regression result differs from sklearn implementation</title>
                <link>https://issues.apache.org/jira/browse/SPARK-41008</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-python&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; pandas &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; pd
&lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; pyspark.sql.types &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; DoubleType
&lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; sklearn.isotonic &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; IsotonicRegression &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; IsotonicRegression_sklearn
&lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; pyspark.ml.regression &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; IsotonicRegression &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; IsotonicRegression_pyspark

&lt;span class=&quot;code-comment&quot;&gt;# The P(positives | model_score):
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;# 0.6 -&amp;gt; 0.5 (1 out of the 2 labels &lt;span class=&quot;code-keyword&quot;&gt;is&lt;/span&gt; positive)
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;# 0.333 -&amp;gt; 0.333 (1 out of the 3 labels &lt;span class=&quot;code-keyword&quot;&gt;is&lt;/span&gt; positive)
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;# 0.20 -&amp;gt; 0.25 (1 out of the 4 labels &lt;span class=&quot;code-keyword&quot;&gt;is&lt;/span&gt; positive)
&lt;/span&gt;tc_pd = pd.DataFrame({
    &lt;span class=&quot;code-quote&quot;&gt;&quot;model_score&quot;&lt;/span&gt;: [0.6, 0.6, 0.333, 0.333, 0.333, 0.20, 0.20, 0.20, 0.20], &#160; &#160; &#160; &#160; 
    &lt;span class=&quot;code-quote&quot;&gt;&quot;label&quot;&lt;/span&gt;: [1, 0, 0, 1, 0, 1, 0, 0, 0], &#160; &#160; &#160; &#160; 
    &lt;span class=&quot;code-quote&quot;&gt;&quot;weight&quot;&lt;/span&gt;: 1, &#160; &#160; }
)

&lt;span class=&quot;code-comment&quot;&gt;# The fraction of positives &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; each of the distinct model_scores would be the best fit.
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;# Resulting &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; the following expected calibrated model_scores:
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;# &lt;span class=&quot;code-quote&quot;&gt;&quot;calibrated_model_score&quot;&lt;/span&gt;: [0.5, 0.5, 0.333, 0.333, 0.333, 0.25, 0.25, 0.25, 0.25]
&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;# The sklearn implementation of Isotonic Regression.&#160;
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; sklearn.isotonic &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; IsotonicRegression &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; IsotonicRegression_sklearn
tc_regressor_sklearn = IsotonicRegression_sklearn().fit(X=tc_pd[&lt;span class=&quot;code-quote&quot;&gt;&apos;model_score&apos;&lt;/span&gt;], y=tc_pd[&lt;span class=&quot;code-quote&quot;&gt;&apos;label&apos;&lt;/span&gt;], sample_weight=tc_pd[&lt;span class=&quot;code-quote&quot;&gt;&apos;weight&apos;&lt;/span&gt;])
&lt;span class=&quot;code-object&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;sklearn:&quot;&lt;/span&gt;, tc_regressor_sklearn.predict(tc_pd[&lt;span class=&quot;code-quote&quot;&gt;&apos;model_score&apos;&lt;/span&gt;]))
&lt;span class=&quot;code-comment&quot;&gt;# &amp;gt;&amp;gt; sklearn: [0.5 0.5 0.33333333 0.33333333 0.33333333 0.25 0.25 0.25 0.25 ]
&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;# The pyspark implementation of Isotonic Regression.&#160;
&lt;/span&gt;tc_df = spark.createDataFrame(tc_pd)
tc_df = tc_df.withColumn(&lt;span class=&quot;code-quote&quot;&gt;&apos;model_score&apos;&lt;/span&gt;, F.col(&lt;span class=&quot;code-quote&quot;&gt;&apos;model_score&apos;&lt;/span&gt;).cast(DoubleType()))

isotonic_regressor_pyspark = IsotonicRegression_pyspark(featuresCol=&lt;span class=&quot;code-quote&quot;&gt;&apos;model_score&apos;&lt;/span&gt;, labelCol=&lt;span class=&quot;code-quote&quot;&gt;&apos;label&apos;&lt;/span&gt;, weightCol=&lt;span class=&quot;code-quote&quot;&gt;&apos;weight&apos;&lt;/span&gt;)
tc_model = isotonic_regressor_pyspark.fit(tc_df)
tc_pd = tc_model.transform(tc_df).toPandas()
&lt;span class=&quot;code-object&quot;&gt;print&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;pyspark:&quot;&lt;/span&gt;, tc_pd[&lt;span class=&quot;code-quote&quot;&gt;&apos;prediction&apos;&lt;/span&gt;].values)
&lt;span class=&quot;code-comment&quot;&gt;# &amp;gt;&amp;gt;&#160;pyspark: [0.5 0.5 0.33333333 0.33333333 0.33333333 0. 0. 0. 0. ]
&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;# The result &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; the pyspark implementation seems unclear. Similar small toy examples lead to similar non-expected results &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the pyspark implementation.&#160;
&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;# Strangely enough, &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;large&apos;&lt;/span&gt; datasets, the difference between calibrated model_scores generated by both implementations dissapears. &lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13494712">SPARK-41008</key>
            <summary>Isotonic regression result differs from sklearn implementation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ahmed.mahran">Ahmed Mahran</assignee>
                                    <reporter username="arne.koopman">Arne Koopman</reporter>
                        <labels>
                    </labels>
                <created>Thu, 3 Nov 2022 15:51:46 +0000</created>
                <updated>Fri, 9 Dec 2022 07:57:31 +0000</updated>
                            <resolved>Thu, 8 Dec 2022 14:29:28 +0000</resolved>
                                    <version>3.3.1</version>
                                    <fixVersion>3.4.0</fixVersion>
                                    <component>MLlib</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17630143" author="srowen" created="Tue, 8 Nov 2022 02:54:58 +0000"  >&lt;p&gt;Yeah that doesn&apos;t look right. I tried understanding the algorithm and code for an hour and couldn&apos;t quite figure it out. It&apos;s clearly because it wants to group the three 0 values at 0.2 together, and not the (0.2, 1) point. My guess is there needs to be some logic about forcing pooling of adjacent points with the same x values even when the y value changes, but I couldn&apos;t find a straightforward fix&lt;/p&gt;</comment>
                            <comment id="17643255" author="ahmed.mahran" created="Mon, 5 Dec 2022 10:42:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=srowen&quot; class=&quot;user-hover&quot; rel=&quot;srowen&quot;&gt;srowen&lt;/a&gt; I think you are right. Repeated feature/x values are pooled into a single point such that the label/y value is the weighted average of corresponding label/y values.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ve checked sklearn implementation: &lt;a href=&quot;https://github.com/scikit-learn/scikit-learn/blob/f3f51f9b6/sklearn/isotonic.py#L281&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/scikit-learn/scikit-learn/blob/f3f51f9b6/sklearn/isotonic.py#L281&lt;/a&gt; and &lt;a href=&quot;https://github.com/scikit-learn/scikit-learn/blob/f3f51f9b611bf873bd5836748647221480071a87/sklearn/_isotonic.pyx#L66.&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/scikit-learn/scikit-learn/blob/f3f51f9b611bf873bd5836748647221480071a87/sklearn/_isotonic.pyx#L66. &lt;/a&gt;Then I did a draft scala version of the pooling function and it seems to give the same results for different few examples.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;d like to pick this up if possible. Also, should the new pooling be applied always or should there be a new option?&lt;/p&gt;</comment>
                            <comment id="17643373" author="srowen" created="Mon, 5 Dec 2022 14:36:21 +0000"  >&lt;p&gt;No need for an option, this seems like a bug fix. Yes if you can propose a pull request that fixes it, by all means.&lt;/p&gt;</comment>
                            <comment id="17643374" author="ahmed.mahran" created="Mon, 5 Dec 2022 14:39:31 +0000"  >&lt;p&gt;Thanks, I&apos;ll manage to have a PR in a couple of days.&lt;/p&gt;</comment>
                            <comment id="17644313" author="apachespark" created="Wed, 7 Dec 2022 12:37:17 +0000"  >&lt;p&gt;User &apos;ahmed-mahran&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/38966&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/38966&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17644314" author="apachespark" created="Wed, 7 Dec 2022 12:38:13 +0000"  >&lt;p&gt;User &apos;ahmed-mahran&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/38966&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/38966&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17644839" author="srowen" created="Thu, 8 Dec 2022 14:29:28 +0000"  >&lt;p&gt;Issue resolved by pull request 38966&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/38966&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/38966&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17645140" author="apachespark" created="Fri, 9 Dec 2022 07:56:24 +0000"  >&lt;p&gt;User &apos;ahmed-mahran&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/38996&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/38996&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17645141" author="apachespark" created="Fri, 9 Dec 2022 07:57:31 +0000"  >&lt;p&gt;User &apos;ahmed-mahran&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/38996&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/38996&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 48 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1at1k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>