<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:49:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-53535] Missing columns inside a struct in Parquet files are not handled correctly</title>
                <link>https://issues.apache.org/jira/browse/SPARK-53535</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;The mechanism that is used to fill missing columns with NULLs does not work correctly when confronted with a missing column inside of a STRUCT.&lt;/p&gt;

&lt;h3&gt;&lt;a name=&quot;Repro&quot;&gt;&lt;/a&gt;Repro&lt;/h3&gt;

&lt;p&gt;&lt;b&gt;Step 1&lt;/b&gt;: We&#8217;re going to consider three different schemas:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;One with STRUCT&amp;lt;INT a&amp;gt;, which we&#8217;re going to write to disk.&lt;/li&gt;
	&lt;li&gt;One with STRUCT&amp;lt;INT b&amp;gt;, which we&#8217;ll use to demonstrate the missing columns being handled incorrectly.&lt;/li&gt;
	&lt;li&gt;One with STRUCT&amp;lt;INT a, INT b&amp;gt;, which we&#8217;ll use to demonstrate the missing columns being handled well.&lt;/li&gt;
&lt;/ol&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
df_a = sql(&lt;span class=&quot;code-quote&quot;&gt;&apos;SELECT 1 as id, named_struct(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;, 1) AS s&apos;&lt;/span&gt;)
df_b = sql(&lt;span class=&quot;code-quote&quot;&gt;&apos;SELECT 2 as id, named_struct(&lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;, 3) AS s&apos;&lt;/span&gt;)
df_ab = sql(&lt;span class=&quot;code-quote&quot;&gt;&apos;SELECT 2 as id, named_struct(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;, 2, &lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;, 3) AS s&apos;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;b&gt;Step 2&lt;/b&gt;: We write the sample data to disk.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
path = &lt;span class=&quot;code-quote&quot;&gt;&quot;/tmp/missing_col_test&quot;&lt;/span&gt;
df_a.write.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;parquet&quot;&lt;/span&gt;).save(path)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;b&gt;Step 3&lt;/b&gt;: We read this data with the three different schemas explained above.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
# This is the schema that matches the data. We read correct data.
spark.read.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;parquet&quot;&lt;/span&gt;).schema(df_a.schema).load(path).show()
+---+---+
| id|  s|
+---+---+
|  1|{1}| # &amp;lt;- GOOD
+---+---+

# This is the schema that has struct s, but doesn&apos;t have columns
# inside of s in common with what was written to disk.
spark.read.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;parquet&quot;&lt;/span&gt;).schema(df_b.schema).load(path).show()
+---+----+
| id|   s|
+---+----+
|  1|NULL| # &amp;lt;- WRONG! Should be {NULL} instead.
+---+----+

# This is the shcema that has more columns in struct s than what
# was written to disk.
spark.read.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;parquet&quot;&lt;/span&gt;).schema(df_ab.schema).load(path).show()
+---+---------+
| id|        s|
+---+---------+
|  1|{1, NULL}| # &amp;lt;- GOOD
+---+---------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;b&gt;Step 4&lt;/b&gt;: To demonstrate that this is not a display glitch, but genuinely leads to incorrect query results, we can show that we evaluate a function differently depending on the number of columns insidea struct in the read schema.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
from pyspark.sql.functions &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; col

spark.read.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;parquet&quot;&lt;/span&gt;).schema(df_a.schema).load(path).withColumn(&lt;span class=&quot;code-quote&quot;&gt;&quot;isnull&quot;&lt;/span&gt;, col(&lt;span class=&quot;code-quote&quot;&gt;&quot;s&quot;&lt;/span&gt;).isNull()).show()
+---+---+------+
| id|  s|isnull|
+---+---+------+
|  1|{1}| &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;| &amp;lt;- GOOD
+---+---+------+

spark.read.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;parquet&quot;&lt;/span&gt;).schema(df_b.schema).load(path).withColumn(&lt;span class=&quot;code-quote&quot;&gt;&quot;isnull&quot;&lt;/span&gt;, col(&lt;span class=&quot;code-quote&quot;&gt;&quot;s&quot;&lt;/span&gt;).isNull()).show()
+---+----+------+
| id|   s|isnull|
+---+----+------+
|  1|NULL|  &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;| &amp;lt;- WRONG!!! Should be &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;. 
+---+----+------+

spark.read.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;parquet&quot;&lt;/span&gt;).schema(df_ab.schema).load(path).withColumn(&lt;span class=&quot;code-quote&quot;&gt;&quot;isnull&quot;&lt;/span&gt;, col(&lt;span class=&quot;code-quote&quot;&gt;&quot;s&quot;&lt;/span&gt;).isNull()).show()
+---+---------+------+
| id|        s|isnull|
+---+---------+------+
|  1|{1, NULL}| &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;| &amp;lt;- GOOD
+---+---------+------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;h3&gt;&lt;a name=&quot;Solution&quot;&gt;&lt;/a&gt;Solution&lt;/h3&gt;

&lt;p&gt;This is happening when all the fields of the struct we are trying to read is missing in a Parquet file, and we assume null structs because we are not reading any field with definition &amp;amp; repetition levels. We should look at the file schema to see if the struct has another non-requested field, whose definition levels can be used for struct&apos;s nullability.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13628475">SPARK-53535</key>
            <summary>Missing columns inside a struct in Parquet files are not handled correctly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ziyaza">Ziya Mukhtarov</assignee>
                                    <reporter username="ziyaza">Ziya Mukhtarov</reporter>
                        <labels>
                            <label>parquet</label>
                            <label>parquetReader</label>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 9 Sep 2025 11:57:06 +0000</created>
                <updated>Thu, 30 Oct 2025 13:58:35 +0000</updated>
                            <resolved>Mon, 20 Oct 2025 23:47:23 +0000</resolved>
                                    <version>4.0.1</version>
                                    <fixVersion>4.1.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="18019133" author="JIRAUSER310925" created="Tue, 9 Sep 2025 12:06:09 +0000"  >&lt;p&gt;I&apos;m already working on fixing this issue.&lt;/p&gt;</comment>
                            <comment id="18031278" author="cloud_fan" created="Mon, 20 Oct 2025 23:47:23 +0000"  >&lt;p&gt;Issue resolved by pull request 52557&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/52557&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/52557&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1xm9c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>