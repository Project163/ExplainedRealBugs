<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:36:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-11193] Spark 1.5+ Kinesis Streaming - ClassCastException when starting KinesisReceiver</title>
                <link>https://issues.apache.org/jira/browse/SPARK-11193</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;After upgrading from Spark 1.4.x -&amp;gt; 1.5.x, I am now unable to start a Kinesis Spark Streaming application, and am being consistently greeted with this exception:&lt;/p&gt;

&lt;p&gt;java.lang.ClassCastException: scala.collection.mutable.HashMap cannot be cast to scala.collection.mutable.SynchronizedMap&lt;br/&gt;
	at org.apache.spark.streaming.kinesis.KinesisReceiver.onStart(KinesisReceiver.scala:175)&lt;br/&gt;
	at org.apache.spark.streaming.receiver.ReceiverSupervisor.startReceiver(ReceiverSupervisor.scala:148)&lt;br/&gt;
	at org.apache.spark.streaming.receiver.ReceiverSupervisor.start(ReceiverSupervisor.scala:130)&lt;br/&gt;
	at org.apache.spark.streaming.scheduler.ReceiverTracker$ReceiverTrackerEndpoint$$anonfun$9.apply(ReceiverTracker.scala:542)&lt;br/&gt;
	at org.apache.spark.streaming.scheduler.ReceiverTracker$ReceiverTrackerEndpoint$$anonfun$9.apply(ReceiverTracker.scala:532)&lt;br/&gt;
	at org.apache.spark.SparkContext$$anonfun$38.apply(SparkContext.scala:1982)&lt;br/&gt;
	at org.apache.spark.SparkContext$$anonfun$38.apply(SparkContext.scala:1982)&lt;br/&gt;
	at org.apache.spark.scheduler.ResultTask.runTask(ResultTask.scala:66)&lt;br/&gt;
	at org.apache.spark.scheduler.Task.run(Task.scala:88)&lt;br/&gt;
	at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:214)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:745)&lt;/p&gt;


&lt;p&gt;Worth noting that I am able to reproduce this issue locally, and also on Amazon EMR (using the latest emr-release 4.1.0 which packages Spark 1.5.0).&lt;/p&gt;

&lt;p&gt;Also, I am not able to run the included kinesis-asl example.&lt;/p&gt;

&lt;p&gt;Built locally using:&lt;br/&gt;
git checkout v1.5.1&lt;br/&gt;
mvn -Pyarn -Pkinesis-asl -Phadoop-2.6 -DskipTests clean package&lt;/p&gt;

&lt;p&gt;Example run command:&lt;br/&gt;
bin/run-example streaming.KinesisWordCountASL phibit-test kinesis-connector &lt;a href=&quot;https://kinesis.us-east-1.amazonaws.com&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://kinesis.us-east-1.amazonaws.com&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12906074">SPARK-11193</key>
            <summary>Spark 1.5+ Kinesis Streaming - ClassCastException when starting KinesisReceiver</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbonofre">Jean-Baptiste Onofr&#233;</assignee>
                                    <reporter username="phibit">Phil Kallos</reporter>
                        <labels>
                    </labels>
                <created>Mon, 19 Oct 2015 21:03:25 +0000</created>
                <updated>Mon, 28 Dec 2015 08:37:08 +0000</updated>
                            <resolved>Sat, 12 Dec 2015 08:52:18 +0000</resolved>
                                    <version>1.5.0</version>
                    <version>1.5.1</version>
                                    <fixVersion>1.6.0</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>DStreams</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="14965094" author="jbonofre" created="Tue, 20 Oct 2015 13:24:58 +0000"  >&lt;p&gt;Unfortunately, my amazon aws account expired and I don&apos;t have access to kinesis anymore. Let me try to mock in order to reproduce your issue on 1.6.0-SNAPSHOT.&lt;/p&gt;</comment>
                            <comment id="14965118" author="jbonofre" created="Tue, 20 Oct 2015 13:52:26 +0000"  >&lt;p&gt;To thread safe, the HashMap blockIdToSeqNumRanges &quot;extends&quot; SynchronizedMap (with mutable.SynchronizedMap).&lt;/p&gt;

&lt;p&gt;In the onStart() function, we clear the blockIdToSeqNumRanges map. There, the clear() method is the one from SynchronizedMap: it&apos;s where the ClassCastException happens.&lt;/p&gt;

&lt;p&gt;I&apos;m checking why. Do you use Scala 2.11 or 2.10 ?&lt;/p&gt;</comment>
                            <comment id="14965125" author="jbonofre" created="Tue, 20 Oct 2015 13:54:04 +0000"  >&lt;p&gt;By the way, with spark 1.4.x, the KinesisReceiver didn&apos;t use the SynchronizedMap (the code was simpler).&lt;/p&gt;</comment>
                            <comment id="14965133" author="jbonofre" created="Tue, 20 Oct 2015 13:56:38 +0000"  >&lt;p&gt;I guess you used Scala 2.10.4 (default) for the compilation. Can you try to build with -Pscala-2.11 to see if it helps ?&lt;/p&gt;</comment>
                            <comment id="14965210" author="jbonofre" created="Tue, 20 Oct 2015 14:50:01 +0000"  >&lt;p&gt;It looks to work fine to me:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;jbonofre@latitude:~/Workspace/spark/bin$ ./run-example streaming.KinesisWordCountASL jbonofre-test kinesis-connector https:&lt;span class=&quot;code-comment&quot;&gt;//kinesis.us-east-1.amazonaws.com
&lt;/span&gt;Using Spark&apos;s &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; log4j profile: org/apache/spark/log4j-defaults.properties
15/10/20 16:48:09 INFO StreamingExamples: Setting log level to [WARN] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; streaming example. To override add a custom log4j.properties to the classpath.
15/10/20 16:48:10 WARN NativeCodeLoader: Unable to load &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt;-hadoop library &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; your platform... using builtin-java classes where applicable
15/10/20 16:48:10 WARN Utils: Your hostname, latitude resolves to a loopback address: 127.0.1.1; using 192.168.134.10 instead (on &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; eth0)
15/10/20 16:48:10 WARN Utils: Set SPARK_LOCAL_IP &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; you need to bind to another address
15/10/20 16:48:11 WARN MetricsSystem: Using &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; name DAGScheduler &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; source because spark.app.id is not set.
-------------------------------------------
Time: 1445352496000 ms
-------------------------------------------

-------------------------------------------
Time: 1445352498000 ms
-------------------------------------------

-------------------------------------------
Time: 1445352500000 ms
-------------------------------------------

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Let me produce some data on the shards.&lt;/p&gt;</comment>
                            <comment id="14965249" author="jbonofre" created="Tue, 20 Oct 2015 15:17:59 +0000"  >&lt;p&gt;I confirm that it works fine for me (with Spark 1.5.1 and 1.6.0-SNAPSHOT). I&apos;m using Java 8.&lt;br/&gt;
See the attached screenshot.&lt;/p&gt;

&lt;p&gt;What&apos;s your Java version ?&lt;/p&gt;</comment>
                            <comment id="14965311" author="phibit" created="Tue, 20 Oct 2015 16:07:52 +0000"  >&lt;p&gt;Ah yes, I have a different scala and Java version.&lt;/p&gt;

&lt;p&gt;I am using scala 2.10.4 and Java 7. Worth noting that Amazon EMR currently only supports Java 7, so I&apos;m not sure I could upgrade that.&lt;/p&gt;

&lt;p&gt;I will try with 2.11!&lt;/p&gt;</comment>
                            <comment id="14965415" author="jbonofre" created="Tue, 20 Oct 2015 17:17:54 +0000"  >&lt;p&gt;I did the tests with Scala 2.10.4 (Spark default), and at runtime, I used Java 8. Let me try with Java7.&lt;/p&gt;</comment>
                            <comment id="14965525" author="phibit" created="Tue, 20 Oct 2015 18:30:41 +0000"  >&lt;p&gt;Ok, I was able to build Spark 1.5.x using Scala 2.11 (still using Java7 however), and tried to run the KinesisWordCountASL example, but was greeted with the same error:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;15/10/20 11:26:32 WARN TaskSetManager: Lost task 0.0 in stage 30.0 (TID 30, localhost): java.lang.ClassCastException: scala.collection.mutable.HashMap cannot be cast to scala.collection.mutable.SynchronizedMap
	at org.apache.spark.streaming.kinesis.KinesisReceiver.onStart(KinesisReceiver.scala:175)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;May be worth noting that I saw this warning during compilation:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[warn] /Users/pkallos/dev/spark/extras/kinesis-asl/src/main/scala/org/apache/spark/streaming/kinesis/KinesisReceiver.scala:127: trait SynchronizedMap in package mutable is deprecated: Synchronization via traits is deprecated as it is inherently unreliable.  Consider java.util.concurrent.ConcurrentHashMap as an alternative.
[warn]     with mutable.SynchronizedMap[StreamBlockId, SequenceNumberRanges]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m a bit reluctant to switch to Java 8 at this point to test, because I am actively working on a handful of projects that require Java 7.&lt;/p&gt;

&lt;p&gt;Curious if you were able to run this with Java7 + scala2.10/2.11&lt;/p&gt;

&lt;p&gt;Thanks for your help on this JB.&lt;/p&gt;</comment>
                            <comment id="14965530" author="jbonofre" created="Tue, 20 Oct 2015 18:37:33 +0000"  >&lt;p&gt;The warning is interesting, let me check if I have the same on my build.&lt;/p&gt;

&lt;p&gt;I keep you posted.&lt;/p&gt;</comment>
                            <comment id="14965561" author="jbonofre" created="Tue, 20 Oct 2015 19:08:54 +0000"  >&lt;p&gt;I only have one warning during compilation (scala 2.10.4/Java 8), and it&apos;s not the same as you have:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[INFO] --- scala-maven-plugin:3.2.2:compile (scala-compile-first) @ spark-streaming-kinesis-asl_2.10 ---
[WARNING] Zinc server is not available at port 3030 - reverting to normal incremental compile
[INFO] Using incremental compilation
[INFO] Compiling 8 Scala sources and 1 Java source to /home/jbonofre/Workspace/spark/extras/kinesis-asl/target/scala-2.10/classes...
[WARNING] warning: [options] bootstrap &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;path not set in conjunction with -source 1.7
[WARNING] 1 warning
[INFO]
[INFO] --- maven-compiler-plugin:3.3:compile (&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-compile) @ spark-streaming-kinesis-asl_2.10 ---
[INFO] Changes detected - recompiling the module!
[INFO] Compiling 1 source file to /home/jbonofre/Workspace/spark/extras/kinesis-asl/target/scala-2.10/classes
[INFO]
[INFO] --- maven-antrun-plugin:1.8:run (create-tmp-dir) @ spark-streaming-kinesis-asl_2.10 ---
[INFO] Executing tasks

main:
    [mkdir] Created dir: /home/jbonofre/Workspace/spark/extras/kinesis-asl/target/tmp
[INFO] Executed tasks
[INFO]
[INFO] --- maven-resources-plugin:2.6:testResources (&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-testResources) @ spark-streaming-kinesis-asl_2.10 ---
[INFO] Using &lt;span class=&quot;code-quote&quot;&gt;&apos;UTF-8&apos;&lt;/span&gt; encoding to copy filtered resources.
[INFO] Copying 1 resource
[INFO] Copying 3 resources
[INFO]
[INFO] --- scala-maven-plugin:3.2.2:testCompile (scala-test-compile-first) @ spark-streaming-kinesis-asl_2.10 ---
[WARNING] Zinc server is not available at port 3030 - reverting to normal incremental compile
[INFO] Using incremental compilation
[INFO] Compiling 4 Scala sources and 1 Java source to /home/jbonofre/Workspace/spark/extras/kinesis-asl/target/scala-2.10/test-classes...
[WARNING] /home/jbonofre/Workspace/spark/extras/kinesis-asl/src/test/scala/org/apache/spark/streaming/kinesis/KinesisStreamSuite.scala:100: method createStream in object KinesisUtils is deprecated: use other forms of createStream
[WARNING]     val kinesisStream1 = KinesisUtils.createStream(ssc, &lt;span class=&quot;code-quote&quot;&gt;&quot;mySparkStream&quot;&lt;/span&gt;,
[WARNING]                                       ^
[WARNING] one warning found
[WARNING] warning: [options] bootstrap &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;path not set in conjunction with -source 1.7
[WARNING] 1 warning
[INFO]
[INFO] --- maven-compiler-plugin:3.3:testCompile (&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-testCompile) @ spark-streaming-kinesis-asl_2.10 ---
[INFO] Changes detected - recompiling the module!
[INFO] Compiling 1 source file to /home/jbonofre/Workspace/spark/extras/kinesis-asl/target/scala-2.10/test-classes
[INFO]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Let me try the other combinations (Java7/Scala 2.11).&lt;/p&gt;</comment>
                            <comment id="14965567" author="jbonofre" created="Tue, 20 Oct 2015 19:11:16 +0000"  >&lt;p&gt;No warning with Java7 neither.&lt;/p&gt;</comment>
                            <comment id="14965584" author="jbonofre" created="Tue, 20 Oct 2015 19:17:06 +0000"  >&lt;p&gt;OK, I have the same warning as you have if I use Scala 2.11. Let me try with Scala 2.11 if I can reproduce your issue.&lt;/p&gt;</comment>
                            <comment id="14965599" author="phibit" created="Tue, 20 Oct 2015 19:23:46 +0000"  >&lt;p&gt;Have you tried the last combination? scala 2.10.4 + java 7?&lt;/p&gt;

&lt;p&gt;Anecdotally, I have at least one other developer on my team that is able to reproduce. Let me know if there&apos;s specific environment information I could give you that would help?&lt;/p&gt;

&lt;p&gt;Meanwhile I will try different java /scala/spark version combinations to see if I can get it running on my box.&lt;/p&gt;</comment>
                            <comment id="14965605" author="jbonofre" created="Tue, 20 Oct 2015 19:27:00 +0000"  >&lt;p&gt;Can you provide:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Java version and provider&lt;/li&gt;
	&lt;li&gt;Scala version used for the compilation&lt;/li&gt;
	&lt;li&gt;Spark topology (standalone, Yarn, Mesos)&lt;br/&gt;
?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;It would be helpful for me to try to reproduce.&lt;/p&gt;

&lt;p&gt;I&apos;m testing Java7 (Oracle) now.&lt;/p&gt;</comment>
                            <comment id="14965612" author="phibit" created="Tue, 20 Oct 2015 19:32:53 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ java -version
java version &quot;1.7.0_75&quot;
Java(TM) SE Runtime Environment (build 1.7.0_75-b13)
Java HotSpot(TM) 64-Bit Server VM (build 24.75-b04, mixed mode)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ scalac -version
Scala compiler version 2.10.4 -- Copyright 2002-2013, LAMP/EPFL
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Spark topology is generally YARN (again because of Amazon EMR) but I have also tried standalone.&lt;/p&gt;

&lt;p&gt;The exact command I built with was&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;spark git:(4f894dd) $ mvn -Pyarn -Pkinesis-asl -Phadoop-2.6 -DskipTests clean package
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Have also tried the following:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;mvn -Pyarn -Pkinesis-asl -Phadoop-2.2 -DskipTests clean package
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;mvn -Pyarn -Pkinesis-asl -Phadoop-2.2 -DskipTests clean package
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;./dev/change-scala-version.sh 2.11
mvn -Pyarn -Phadoop-2.6 -Dscala-2.11 -Pkinesis-asl -DskipTests clean package
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14966030" author="phibit" created="Wed, 21 Oct 2015 00:28:47 +0000"  >&lt;p&gt;regarding the SynchronizedMap warning, you can find it on the scala doc page here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.scala-lang.org/api/2.11.4/index.html#scala.collection.mutable.SynchronizedMap&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.scala-lang.org/api/2.11.4/index.html#scala.collection.mutable.SynchronizedMap&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;(Since version 2.11.0) Synchronization via traits is deprecated as it is inherently unreliable. Consider java.util.concurrent.ConcurrentHashMap as an alternative.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not sure what the implications are for scala 2.10 and the KinesisReceiver are, however?&lt;/p&gt;

&lt;p&gt;I will try replacing with SynchronizedMap with ConcurrentHashMap and see if I can find out.&lt;/p&gt;</comment>
                            <comment id="14966214" author="jbonofre" created="Wed, 21 Oct 2015 04:28:49 +0000"  >&lt;p&gt;The warning is not a problem. Let me try Java 1.7 (sorry it was late yesterday &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;).&lt;/p&gt;</comment>
                            <comment id="14966405" author="henningp" created="Wed, 21 Oct 2015 08:03:29 +0000"  >&lt;p&gt;We are also greeted with this exception since this morning. We are on 1.5.1 on EC2, and this was working fine yesterday, but not since this moring. All versions have stayed the same. Really odd.&lt;/p&gt;</comment>
                            <comment id="14974481" author="comtef" created="Mon, 26 Oct 2015 16:17:33 +0000"  >&lt;p&gt;Same problem with EMR 4.1.0 and Java 8.&lt;br/&gt;
I am using spark-streaming-kinesis-asl_2.10 in version 1.5.0.&lt;/p&gt;

&lt;p&gt;The ser/de of the receiver fails with the Kryo serializer, everything works fine with the default java serializer.&lt;/p&gt;</comment>
                            <comment id="14974653" author="jbonofre" created="Mon, 26 Oct 2015 17:52:27 +0000"  >&lt;p&gt;Thanks for the update. I&apos;m in vacation up to Wednesday. I will resume my investigation/fix on this next Thursday. &lt;/p&gt;</comment>
                            <comment id="14979274" author="cjchilds" created="Wed, 28 Oct 2015 21:26:20 +0000"  >&lt;p&gt;Fabien&apos;s comment led me to writing up a minimal test case. The ClassCastException points at Kryo writing out the mutable.HashMap and re-instantiating it without the SynchronizedMap trait. Twitter&apos;s Chill library includes default HashMap/Map serializers and using that produces the erroneous behavior seen above.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://gist.github.com/cjchilds/4015a0d8e02868646a33&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/cjchilds/4015a0d8e02868646a33&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I didn&apos;t confirm if it was the Chill mutable.HashMap serializer specifically or the mutable.Map subclass one. If you aren&apos;t bothering with serializing mutable.Map or mutable.HashMaps you can probably alter your custom Kryo serialization registration (see Spark&apos;s KryoRegistrator trait) to not include those.&lt;/p&gt;</comment>
                            <comment id="14979999" author="jbonofre" created="Thu, 29 Oct 2015 07:58:33 +0000"  >&lt;p&gt;Interesting comment from Fabien. And indeed, as Kryo changes the type of the Map (by creating child maps), the serialization trait is lost. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phibit&quot; class=&quot;user-hover&quot; rel=&quot;phibit&quot;&gt;phibit&lt;/a&gt; do you use Kryo on your test case ?&lt;/p&gt;</comment>
                            <comment id="14981355" author="phibit" created="Thu, 29 Oct 2015 21:45:55 +0000"  >&lt;p&gt;Yes I am using Kryo. Also worth noting that Christopher Childs and I are in cahoots working on the same project &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14981972" author="jbonofre" created="Fri, 30 Oct 2015 06:12:48 +0000"  >&lt;p&gt;Oh ok, so it makes sense &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Let me fix that. Thanks guys !&lt;/p&gt;</comment>
                            <comment id="14990574" author="phibit" created="Wed, 4 Nov 2015 22:26:14 +0000"  >&lt;p&gt;Any chance a fix for this will make the 1.6 release milestone?&lt;/p&gt;

&lt;p&gt;If you give us direction on which approach is preferred we can also contribute the change. As far as I can tell the options are:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;just use java.util.concurrent.ConcurrentHashMap&lt;/li&gt;
	&lt;li&gt;augment the Kryo serialization code with a patch like &lt;a href=&quot;https://gist.github.com/cjchilds/4015a0d8e02868646a33&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/cjchilds/4015a0d8e02868646a33&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;some third thing?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14991160" author="jbonofre" created="Thu, 5 Nov 2015 05:31:37 +0000"  >&lt;p&gt;Hi Phil, I&apos;m testing a fix on Kryo right now. I&apos;m testing with different use case. I&apos;m keeping you posted.&lt;/p&gt;</comment>
                            <comment id="15032609" author="phibit" created="Mon, 30 Nov 2015 22:27:48 +0000"  >&lt;p&gt;Any indication whether this fix will make the Spark 1.6 release? Would be nice to see it work its war into the next Amazon EMR package when they adopt 1.6.&lt;/p&gt;</comment>
                            <comment id="15033172" author="jbonofre" created="Tue, 1 Dec 2015 06:21:56 +0000"  >&lt;p&gt;Hi Phil, it&apos;s on my bucket. I should submit the PR today.&lt;/p&gt;</comment>
                            <comment id="15046079" author="jbonofre" created="Tue, 8 Dec 2015 00:51:41 +0000"  >&lt;p&gt;To reproduce the issue, I added the following test in KryoSerializerSuite:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  test(&lt;span class=&quot;code-quote&quot;&gt;&quot;Bug: SPARK-11193&quot;&lt;/span&gt;) {
    val ser = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KryoSerializer(conf.clone.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;spark.kryo.registrationRequired&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&quot;&lt;/span&gt;))
      .newInstance()

    val myMap: mutable.HashMap[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;] = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; mutable.HashMap[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;]
      with mutable.SynchronizedMap[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;]
    myMap.put(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;bar&quot;&lt;/span&gt;)
    val myMapBytes = ser.serialize(myMap)

    val deserialized: mutable.HashMap[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;]
      with mutable.SynchronizedMap[&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;] = ser.deserialize(myMapBytes)

    deserialized.clear()
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When running this test, I got:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;scala.collection.mutable.HashMap cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to scala.collection.mutable.SynchronizedMap
java.lang.ClassCastException: scala.collection.mutable.HashMap cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to scala.collection.mutable.SynchronizedMap
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;similar to what happens in KinesisReceiver.&lt;/p&gt;

&lt;p&gt;I&apos;m figuring out the fix to do in KryoSerializer.&lt;/p&gt;</comment>
                            <comment id="15047027" author="comtef" created="Tue, 8 Dec 2015 16:16:31 +0000"  >&lt;p&gt;Thank you for working on this issue.&lt;br/&gt;
I guess it&apos;s too late for it to be included in the 1.6 release?&lt;/p&gt;</comment>
                            <comment id="15047036" author="jbonofre" created="Tue, 8 Dec 2015 16:22:57 +0000"  >&lt;p&gt;It could be possible. Let me check with the team.&lt;/p&gt;</comment>
                            <comment id="15047056" author="apachespark" created="Tue, 8 Dec 2015 16:53:04 +0000"  >&lt;p&gt;User &apos;jbonofre&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/10203&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/10203&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15052755" author="srowen" created="Fri, 11 Dec 2015 13:38:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phibit&quot; class=&quot;user-hover&quot; rel=&quot;phibit&quot;&gt;phibit&lt;/a&gt; are you able to test the change in &lt;a href=&quot;https://github.com/apache/spark/pull/10203&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/10203&lt;/a&gt; by any chance &amp;#8211; does it look OK to you?&lt;/p&gt;</comment>
                            <comment id="15053639" author="phibit" created="Fri, 11 Dec 2015 21:52:22 +0000"  >&lt;p&gt;yes, code looks great to me, thanks JB and Sean. any indication that this will make the 1.6 release?&lt;/p&gt;</comment>
                            <comment id="15054152" author="srowen" created="Sat, 12 Dec 2015 08:52:18 +0000"  >&lt;p&gt;Issue resolved by pull request 10203&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/10203&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/10203&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12767605" name="screen.png" size="155832" author="jbonofre" created="Tue, 20 Oct 2015 15:18:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 49 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2n7j3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>