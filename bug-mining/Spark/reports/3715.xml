<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:45:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-16164] CombineFilters should keep the ordering in the logical plan</title>
                <link>https://issues.apache.org/jira/browse/SPARK-16164</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cmccubbin&quot; class=&quot;user-hover&quot; rel=&quot;cmccubbin&quot;&gt;cmccubbin&lt;/a&gt; reported a bug when he used StringIndexer in an ML pipeline with additional filters. It seems that during filter pushdown, we changed the ordering in the logical plan. I&apos;m not sure whether we should treat this as a bug.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;val df1 = (0 until 3).map(_.toString).toDF
val indexer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringIndexer()
  .setInputCol(&lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;)
  .setOutputCol(&lt;span class=&quot;code-quote&quot;&gt;&quot;idx&quot;&lt;/span&gt;)
  .setHandleInvalid(&lt;span class=&quot;code-quote&quot;&gt;&quot;skip&quot;&lt;/span&gt;)
  .fit(df1)
val df2 = (0 until 5).map(_.toString).toDF
val predictions = indexer.transform(df2)
predictions.show() &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is okay
&lt;/span&gt;predictions.where(&apos;idx &amp;gt; 2).show() &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; will &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; an exception&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Please see the notebook at &lt;a href=&quot;https://databricks-prod-cloudfront.cloud.databricks.com/public/4027ec902e239c93eaaa8714f173bcfc/1233855/2159162931615821/588180/latest.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://databricks-prod-cloudfront.cloud.databricks.com/public/4027ec902e239c93eaaa8714f173bcfc/1233855/2159162931615821/588180/latest.html&lt;/a&gt; for error messages.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12982219">SPARK-16164</key>
            <summary>CombineFilters should keep the ordering in the logical plan</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dongjoon">Dongjoon Hyun</assignee>
                                    <reporter username="mengxr">Xiangrui Meng</reporter>
                        <labels>
                    </labels>
                <created>Thu, 23 Jun 2016 06:14:08 +0000</created>
                <updated>Tue, 28 Jun 2016 20:45:59 +0000</updated>
                            <resolved>Thu, 23 Jun 2016 22:28:03 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15345945" author="dongjoon" created="Thu, 23 Jun 2016 07:10:16 +0000"  >&lt;p&gt;Hi, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mengxr&quot; class=&quot;user-hover&quot; rel=&quot;mengxr&quot;&gt;mengxr&lt;/a&gt;.&lt;br/&gt;
The root cause seems to be `CombineFilters`. (It is called after predicate push down as you mentioned.)&lt;br/&gt;
Currently, `CombineFilters` makes the final condition with `parent condition &amp;amp; child condition`.&lt;br/&gt;
We should switch them to solve this issue.&lt;br/&gt;
I&apos;ll make a PR soon.&lt;/p&gt;</comment>
                            <comment id="15345958" author="mengxr" created="Thu, 23 Jun 2016 07:26:44 +0000"  >&lt;p&gt;Thanks for identifying the root cause so quickly!&lt;/p&gt;</comment>
                            <comment id="15345971" author="apachespark" created="Thu, 23 Jun 2016 07:36:05 +0000"  >&lt;p&gt;User &apos;dongjoon-hyun&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/13872&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/13872&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15345977" author="dongjoon" created="Thu, 23 Jun 2016 07:36:58 +0000"  >&lt;p&gt;It&apos;s my pleasure. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15347322" author="mengxr" created="Thu, 23 Jun 2016 22:28:03 +0000"  >&lt;p&gt;Issue resolved by pull request 13872&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/13872&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/13872&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15347701" author="lian cheng" created="Fri, 24 Jun 2016 04:53:16 +0000"  >&lt;p&gt;I&apos;m posting a summary of our offline and GitHub discussion about this issue here for future reference.&lt;/p&gt;

&lt;p&gt;The case described in this ticket can be generalized as the following query plan fragment:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Filter p1
 Project ...
  Filter p2
   &amp;lt;child&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In this fragment, predicate &lt;tt&gt;p1&lt;/tt&gt; is actually a partial function, which means it&apos;s not defined for all possible input values (for example, &lt;tt&gt;scala.math.log&lt;/tt&gt; is only defined for positive numbers). Thus this query plan relies on the fact that &lt;tt&gt;p1&lt;/tt&gt; is evaluated after &lt;tt&gt;p2&lt;/tt&gt;, so that &lt;tt&gt;p2&lt;/tt&gt; can reduce the range of input values for &lt;tt&gt;p1&lt;/tt&gt;. However, filter push-down and &lt;tt&gt;CombineFilters&lt;/tt&gt; optimizes this fragment into:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Project ...
 Filter p1 &amp;amp;&amp;amp; p2
  &amp;lt;child&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which forces &lt;tt&gt;p1&lt;/tt&gt; to be evaluated before &lt;tt&gt;p2&lt;/tt&gt;. This causes the exception because now &lt;tt&gt;p1&lt;/tt&gt; may receive invalid input values that are supposed to be filtered out by &lt;tt&gt;p2&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The problem here is that, the SQL optimizer should have the freedom to rearrange filter predicate evaluation order. For example, we may want to evaluate cheap predicates first to shortcut expensive predicates. However, to enable this kind of optimizations, essentially we require all filter predicates to be deterministic &lt;b&gt;full&lt;/b&gt; functions, which is violated in the above case (&lt;tt&gt;p1&lt;/tt&gt; is not a full function).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/spark/pull/13872&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR #13872&lt;/a&gt; &quot;fixes&quot; the specific case mentioned in this ticket by adjusting optimization rule &lt;tt&gt;CombineFilters&lt;/tt&gt;, which is safe. But in general, user applications should NOT make the assumption that filter predicates are always evaluated in the order they appear in the original query.&lt;/p&gt;</comment>
                            <comment id="15348438" author="mengxr" created="Fri, 24 Jun 2016 15:36:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lian+cheng&quot; class=&quot;user-hover&quot; rel=&quot;lian cheng&quot;&gt;lian cheng&lt;/a&gt; See my last comment on GitHub:&lt;/p&gt;

&lt;p&gt;I didn&apos;t use UDF explicitly in a filter expression. It is like the following:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;filter b &amp;gt; 0
set a = udf(b)
filter a &amp;gt; 2
and the optimizer merged them into
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;filter udf(b) &amp;gt; 2 and b &amp;gt; 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This could happen for any UDFs that throw exceptions. Are we assuming that UDFs never throw exceptions?&lt;/p&gt;</comment>
                            <comment id="15351244" author="lian cheng" created="Mon, 27 Jun 2016 15:32:58 +0000"  >&lt;p&gt;I&apos;m not saying that we should make this explicit, but our current implementation does require that a UDF can&apos;t throw exceptions when the UDF is not defined at a given input value.&lt;/p&gt;

&lt;p&gt;We should probably support the use case you hit since it seems to be quite natural. But I&apos;m not sure how to support it in an efficient way (i.e. without sacrificing significant optimization opportunities).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 21 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2zycn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>