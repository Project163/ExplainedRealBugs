<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:49:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-18523] OOM killer may leave SparkContext in broken state causing Connection Refused errors</title>
                <link>https://issues.apache.org/jira/browse/SPARK-18523</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When you run some memory-heavy spark job, Spark driver may consume more memory resources than host available to provide.&lt;/p&gt;

&lt;p&gt;In this case OOM killer comes on scene and successfully kills a spark-submit process.&lt;/p&gt;

&lt;p&gt;The pyspark.SparkContext is not able to handle such state of things and becomes completely broken. &lt;/p&gt;

&lt;p&gt;You cannot stop it as on stop it tries to call stop method of bounded java context (jsc) and fails with Py4JError, because such process no longer exists as like as the connection to it. &lt;/p&gt;

&lt;p&gt;You cannot start new SparkContext because you have your broken one as active one and pyspark still is not able to not have SparkContext as sort of singleton.&lt;/p&gt;

&lt;p&gt;The only thing you can do is shutdown your IPython Notebook and start it over. Or dive into SparkContext internal attributes and reset them manually to initial None state.&lt;/p&gt;

&lt;p&gt;The OOM killer case is just one of the many: any reason of spark-submit crash in the middle of something leaves SparkContext in a broken state.&lt;/p&gt;

&lt;p&gt;Example on error log on &lt;tt&gt;sc.stop()&lt;/tt&gt; in broken state:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR:root:Exception &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; sending command.
Traceback (most recent call last):
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/local/lib/python2.7/site-packages/py4j/java_gateway.py&quot;&lt;/span&gt;, line 883, in send_command
    response = connection.send_command(command)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/local/lib/python2.7/site-packages/py4j/java_gateway.py&quot;&lt;/span&gt;, line 1040, in send_command
    &lt;span class=&quot;code-quote&quot;&gt;&quot;Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; receiving&quot;&lt;/span&gt;, e, proto.ERROR_ON_RECEIVE)
Py4JNetworkError: Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; receiving
ERROR:py4j.java_gateway:An error occurred &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; trying to connect to the Java server (127.0.0.1:59911)
Traceback (most recent call last):
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/local/lib/python2.7/site-packages/py4j/java_gateway.py&quot;&lt;/span&gt;, line 963, in start
    self.socket.connect((self.address, self.port))
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/local/lib/python2.7/socket.py&quot;&lt;/span&gt;, line 224, in meth
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; getattr(self._sock,name)(*args)
error: [Errno 61] Connection refused

---------------------------------------------------------------------------
Py4JError                                 Traceback (most recent call last)
&amp;lt;ipython-input-2-f154e069615b&amp;gt; in &amp;lt;module&amp;gt;()
----&amp;gt; 1 sc.stop()

/usr/local/share/spark/python/pyspark/context.py in stop(self)
    360         &quot;&quot;&quot;
    361         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; getattr(self, &lt;span class=&quot;code-quote&quot;&gt;&quot;_jsc&quot;&lt;/span&gt;, None):
--&amp;gt; 362             self._jsc.stop()
    363             self._jsc = None
    364         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; getattr(self, &lt;span class=&quot;code-quote&quot;&gt;&quot;_accumulatorServer&quot;&lt;/span&gt;, None):

/usr/local/lib/python2.7/site-packages/py4j/java_gateway.pyc in __call__(self, *args)
   1131         answer = self.gateway_client.send_command(command)
   1132         return_value = get_return_value(
-&amp;gt; 1133             answer, self.gateway_client, self.target_id, self.name)
   1134 
   1135         &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; temp_arg in temp_args:

/usr/local/share/spark/python/pyspark/sql/utils.py in deco(*a, **kw)
     43     def deco(*a, **kw):
     44         &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;:
---&amp;gt; 45             &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; f(*a, **kw)
     46         except py4j.protocol.Py4JJavaError as e:
     47             s = e.java_exception.toString()

/usr/local/lib/python2.7/site-packages/py4j/protocol.pyc in get_return_value(answer, gateway_client, target_id, name)
    325             raise Py4JError(
    326                 &lt;span class=&quot;code-quote&quot;&gt;&quot;An error occurred &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; calling {0}{1}{2}&quot;&lt;/span&gt;.
--&amp;gt; 327                 format(target_id, &lt;span class=&quot;code-quote&quot;&gt;&quot;.&quot;&lt;/span&gt;, name))
    328     &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;:
    329         type = answer[1]

Py4JError: An error occurred &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; calling o47.stop
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13022143">SPARK-18523</key>
            <summary>OOM killer may leave SparkContext in broken state causing Connection Refused errors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kxepal">Alexander Shorin</assignee>
                                    <reporter username="kxepal">Alexander Shorin</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Mon, 21 Nov 2016 09:53:38 +0000</created>
                <updated>Mon, 24 Jun 2024 13:27:49 +0000</updated>
                            <resolved>Tue, 29 Nov 2016 02:29:07 +0000</resolved>
                                    <version>1.6.1</version>
                    <version>2.0.0</version>
                                    <fixVersion>2.1.0</fixVersion>
                                    <component>PySpark</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15683200" author="apachespark" created="Mon, 21 Nov 2016 10:58:06 +0000"  >&lt;p&gt;User &apos;kxepal&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/15961&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/15961&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16148544" author="kadeng" created="Thu, 31 Aug 2017 07:05:10 +0000"  >&lt;p&gt;In PySpark 2.2.0 this issue was not really fixed for me. While I could close the SparkContext (with an Exception message), I could not reopen any new spark contexts.&lt;/p&gt;

&lt;p&gt;If I resetted the global SparkContext variables like this, it worked:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;def reset_spark():
    import pyspark
    from threading import RLock
    pyspark.SparkContext._jvm = None
    pyspark.SparkContext._gateway = None
    pyspark.SparkContext._next_accum_id = 0
    pyspark.SparkContext._active_spark_context = None
    pyspark.SparkContext._lock = RLock()
    pyspark.SparkContext._python_includes = None
reset_spark()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16148698" author="kxepal" created="Thu, 31 Aug 2017 09:14:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kadeng&quot; class=&quot;user-hover&quot; rel=&quot;kadeng&quot;&gt;kadeng&lt;/a&gt;&lt;br/&gt;
I don&apos;t have a 2.2.0 in production for now (shame on me!), but will check this. Thanks for report!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                                                <inwardlinks description="is cloned by">
                                        <issuelink>
            <issuekey id="13098756">SPARK-21881</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13028306">SPARK-18876</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13098756">SPARK-21881</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 11 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i36kl3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>