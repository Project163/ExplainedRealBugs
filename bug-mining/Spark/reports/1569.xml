<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:25:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-6313] Fetch File Lock file creation doesnt work when Spark working dir is on a NFS mount</title>
                <link>https://issues.apache.org/jira/browse/SPARK-6313</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;When running in cluster mode and mounting the spark work dir on a NFS volume (or some volume which doesn&apos;t support file locking), the fetchFile (used for downloading JARs etc on the executors) method in Spark Utils class will fail. This file locking was introduced as an improvement with &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-2713&quot; title=&quot;Executors of same application in same host should only download files &amp;amp; jars once&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-2713&quot;&gt;&lt;del&gt;SPARK-2713&lt;/del&gt;&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;See &lt;a href=&quot;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/util/Utils.scala#L415&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/master/core/src/main/scala/org/apache/spark/util/Utils.scala#L415&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;Introduced in 1.2 in commit; &lt;a href=&quot;https://github.com/apache/spark/commit/7aacb7bfad4ec73fd8f18555c72ef696&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/commit/7aacb7bfad4ec73fd8f18555c72ef696&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;As this locking is for optimisation for fetching files, could we take a different approach here to create a temp/advisory lock file? &lt;/p&gt;

&lt;p&gt;Typically you would just mount local disks (in say ext4 format) and provide this as a comma separated list however we are trying to run Spark on MapR. With MapR we can do a loop back mount to a volume on the local node and take advantage of MapRs disk pools. This also means we dont need specific mounts for Spark and improves the generic nature of the cluster. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12781713">SPARK-6313</key>
            <summary>Fetch File Lock file creation doesnt work when Spark working dir is on a NFS mount</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nemccarthy">Nathan McCarthy</assignee>
                                    <reporter username="nemccarthy">Nathan McCarthy</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Mar 2015 04:17:31 +0000</created>
                <updated>Tue, 17 Mar 2015 16:35:53 +0000</updated>
                            <resolved>Tue, 17 Mar 2015 16:34:39 +0000</resolved>
                                    <version>1.2.0</version>
                    <version>1.2.1</version>
                    <version>1.3.0</version>
                                    <fixVersion>1.2.2</fixVersion>
                    <fixVersion>1.3.1</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14359964" author="nemccarthy" created="Fri, 13 Mar 2015 05:32:41 +0000"  >&lt;p&gt;Suggestion along the lines of;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/lucene-solr/blob/5314a56924f46522993baf106e6deca0e48a967f/lucene/core/src/java/org/apache/lucene/store/SimpleFSLockFactory.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/lucene-solr/blob/5314a56924f46522993baf106e6deca0e48a967f/lucene/core/src/java/org/apache/lucene/store/SimpleFSLockFactory.java&lt;/a&gt; &lt;br/&gt;
or&lt;br/&gt;
&lt;a href=&quot;https://github.com/graphhopper/graphhopper/blob/master/core/src/main/java/com/graphhopper/storage/SimpleFSLockFactory.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/graphhopper/graphhopper/blob/master/core/src/main/java/com/graphhopper/storage/SimpleFSLockFactory.java&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14359972" author="nemccarthy" created="Fri, 13 Mar 2015 05:36:56 +0000"  >&lt;p&gt;Since the &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;val lockFileName = s&lt;span class=&quot;code-quote&quot;&gt;&quot;${url.hashCode}${timestamp}_lock&quot;&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; uses a timestamp I can&apos;t see there being too many problems with hanging/left over lock files. &lt;/p&gt;</comment>
                            <comment id="14360842" author="joshrosen" created="Fri, 13 Mar 2015 18:13:32 +0000"  >&lt;p&gt;Could you update this ticket with more details on the error-message or symptom that you&apos;ve observed (such as a stacktrace)?  This would be helpful in order to make this issue more searchable / discoverable.&lt;/p&gt;</comment>
                            <comment id="14360896" author="joshrosen" created="Fri, 13 Mar 2015 18:40:16 +0000"  >&lt;p&gt;Thanks for the pointer to the Lucene lock factory code.&lt;/p&gt;

&lt;p&gt;It&apos;s fine for the locks to be advisory in the sense that things shouldn&apos;t break if multiple executors acquire the lock and try to download the same file, but there&apos;s potentially a problem if the lock isn&apos;t released after the JVM that acquired it exits abnormally, since this could cause other executors to block indefinitely while waiting for the original lock owner to download the file.  One approach might be to write the PID of the original lock owner into the lock file, which would allow blocked executors to timeout and re-attempt the lock acquisition if they detect that the original lock holder died.  This might face its own portability challenges, though, and seems complex.&lt;/p&gt;

&lt;p&gt;A simple hotfix might be to add a SparkConf setting to always force this caching to bypassed (this would be a two-line change to Executor.scala).  This might lose the performance benefits of the caching, though.&lt;/p&gt;

&lt;p&gt;If you&apos;re using NFS and the shared filesystem is mounted at the same path on all nodes, I think that you should be able to use use &lt;tt&gt;local://path/to/nfs/&lt;/tt&gt; to specify the paths to your files / JARs, which will cause them to be read from the executor-local filesystem rather than fetched remotely.  In this case, this would cause them to be read from NFS, so you may be able to use this technique to recover any performance benefits for large files that would be lost in disabling the caching.&lt;/p&gt;

&lt;p&gt;I&apos;d be happy to review patches for this issue.&lt;/p&gt;</comment>
                            <comment id="14362605" author="nemccarthy" created="Sun, 15 Mar 2015 23:13:24 +0000"  >&lt;p&gt;Stacktrace;&lt;/p&gt;

&lt;p&gt;14/12/12 18:18:24 WARN scheduler.TaskSetManager: Lost task 7.0 in stage 0.0 (TID 8, hadoop-016): java.io.IOException: Permission denied&lt;br/&gt;
at sun.nio.ch.FileDispatcherImpl.lock0(Native Method)&lt;br/&gt;
at sun.nio.ch.FileDispatcherImpl.lock(FileDispatcherImpl.java:91)&lt;br/&gt;
at sun.nio.ch.FileChannelImpl.lock(FileChannelImpl.java:1022)&lt;br/&gt;
at java.nio.channels.FileChannel.lock(FileChannel.java:1052)&lt;br/&gt;
at org.apache.spark.util.Utils$.fetchFile(Utils.scala:379)&lt;br/&gt;
at org.apache.spark.executor.Executor$$anonfun$org$apache$spark$executor$Executor$$updateDependencies$6.apply(Executor.scala:350)&lt;br/&gt;
at org.apache.spark.executor.Executor$$anonfun$org$apache$spark$executor$Executor$$updateDependencies$6.apply(Executor.scala:347)&lt;br/&gt;
at scala.collection.TraversableLike$WithFilter$$anonfun$foreach$1.apply(TraversableLike.scala:772)&lt;br/&gt;
at scala.collection.mutable.HashMap$$anonfun$foreach$1.apply(HashMap.scala:98)&lt;br/&gt;
at scala.collection.mutable.HashMap$$anonfun$foreach$1.apply(HashMap.scala:98)&lt;br/&gt;
at scala.collection.mutable.HashTable$class.foreachEntry(HashTable.scala:226)&lt;br/&gt;
at scala.collection.mutable.HashMap.foreachEntry(HashMap.scala:39)&lt;br/&gt;
at scala.collection.mutable.HashMap.foreach(HashMap.scala:98)&lt;br/&gt;
at scala.collection.TraversableLike$WithFilter.foreach(TraversableLike.scala:771)&lt;br/&gt;
at org.apache.spark.executor.Executor.org$apache$spark$executor$Executor$$updateDependencies(Executor.scala:347)&lt;br/&gt;
at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:177)&lt;br/&gt;
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)&lt;br/&gt;
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)&lt;br/&gt;
at java.lang.Thread.run(Thread.java:745)&lt;/p&gt;</comment>
                            <comment id="14362687" author="pwendell" created="Mon, 16 Mar 2015 03:28:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=joshrosen&quot; class=&quot;user-hover&quot; rel=&quot;joshrosen&quot;&gt;joshrosen&lt;/a&gt; changing default caching behavior seems like it could silently regress performance for the vas majority of users who aren&apos;t on NFS. What about a hotfix for 1.3.1 that just exposes the config for NFS users (this is very small population), but doesn&apos;t change the default. That may be sufficient in itself... or if we want a real fix that makes it work out-of-the-box on NDFS, we can put it in 1.4.&lt;/p&gt;</comment>
                            <comment id="14362818" author="apachespark" created="Mon, 16 Mar 2015 06:46:56 +0000"  >&lt;p&gt;User &apos;nemccarthy&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/5036&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/5036&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14362820" author="nemccarthy" created="Mon, 16 Mar 2015 06:47:46 +0000"  >&lt;p&gt;Thanks for the feedback guys. The config option workaround seems like the path of least resistance for now with some more testing being required for a different implementation. For us it would be great if we could get a fix ASAP. Ive created PR 5603 &lt;a href=&quot;https://github.com/apache/spark/pull/5036&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/5036&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14365450" author="joshrosen" created="Tue, 17 Mar 2015 16:34:39 +0000"  >&lt;p&gt;Issue resolved by pull request 5036&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/5036&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/5036&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14365452" author="joshrosen" created="Tue, 17 Mar 2015 16:35:53 +0000"  >&lt;p&gt;I&apos;ve merged Nathan&apos;s patch into 1.4.0, 1.3.1, and 1.2.2.  After this path, users can work around this bug by setting &lt;tt&gt;spark.files.useFetchCache=false&lt;/tt&gt; in their SparkConf.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 36 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i26q3b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12329486">1.3.1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>