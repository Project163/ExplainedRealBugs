<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:00:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-24957] Decimal arithmetic can lead to wrong values using codegen</title>
                <link>https://issues.apache.org/jira/browse/SPARK-24957</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;I noticed a bug when doing arithmetic on a dataframe containing decimal values with codegen enabled.&lt;br/&gt;
I tried to narrow it down on a small repro and got this (executed in spark-shell):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;scala&amp;gt; val df = Seq(
     | (&quot;a&quot;, BigDecimal(&quot;12.0&quot;)),
     | (&quot;a&quot;, BigDecimal(&quot;12.0&quot;)),
     | (&quot;a&quot;, BigDecimal(&quot;11.9999999988&quot;)),
     | (&quot;a&quot;, BigDecimal(&quot;12.0&quot;)),
     | (&quot;a&quot;, BigDecimal(&quot;12.0&quot;)),
     | (&quot;a&quot;, BigDecimal(&quot;11.9999999988&quot;)),
     | (&quot;a&quot;, BigDecimal(&quot;11.9999999988&quot;))
     | ).toDF(&quot;text&quot;, &quot;number&quot;)
df: org.apache.spark.sql.DataFrame = [text: string, number: decimal(38,18)]

scala&amp;gt; val df_grouped_1 = df.groupBy(df.col(&quot;text&quot;)).agg(functions.avg(df.col(&quot;number&quot;)).as(&quot;number&quot;))
df_grouped_1: org.apache.spark.sql.DataFrame = [text: string, number: decimal(38,22)]

scala&amp;gt; df_grouped_1.collect()
res0: Array[org.apache.spark.sql.Row] = Array([a,11.9999999994857142857143])

scala&amp;gt; val df_grouped_2 = df_grouped_1.groupBy(df_grouped_1.col(&quot;text&quot;)).agg(functions.sum(df_grouped_1.col(&quot;number&quot;)).as(&quot;number&quot;))
df_grouped_2: org.apache.spark.sql.DataFrame = [text: string, number: decimal(38,22)]

scala&amp;gt; df_grouped_2.collect()
res1: Array[org.apache.spark.sql.Row] = Array([a,1199999999948571.4285714285714285714286])

scala&amp;gt; val df_total_sum = df_grouped_1.agg(functions.sum(df_grouped_1.col(&quot;number&quot;)).as(&quot;number&quot;))
df_total_sum: org.apache.spark.sql.DataFrame = [number: decimal(38,22)]

scala&amp;gt; df_total_sum.collect()
res2: Array[org.apache.spark.sql.Row] = Array([11.9999999994857142857143])
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The results of &lt;tt&gt;df_grouped_1&lt;/tt&gt; and &lt;tt&gt;df_total_sum&lt;/tt&gt; are correct, whereas the result of &lt;tt&gt;df_grouped_2&lt;/tt&gt; is clearly incorrect (it is the value of the correct result times &lt;tt&gt;10^14&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;When codegen is disabled all results are correct. &lt;/p&gt;</description>
                <environment></environment>
        <key id="13175312">SPARK-24957</key>
            <summary>Decimal arithmetic can lead to wrong values using codegen</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mgaido">Marco Gaido</assignee>
                                    <reporter username="dvogelbacher">David Vogelbacher</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Sat, 28 Jul 2018 04:26:10 +0000</created>
                <updated>Mon, 2 Mar 2020 07:54:33 +0000</updated>
                            <resolved>Mon, 30 Jul 2018 13:02:44 +0000</resolved>
                                    <version>2.0.2</version>
                    <version>2.1.3</version>
                    <version>2.2.2</version>
                    <version>2.3.1</version>
                                    <fixVersion>2.2.3</fixVersion>
                    <fixVersion>2.3.2</fixVersion>
                    <fixVersion>2.4.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16561077" author="mgaido" created="Sun, 29 Jul 2018 10:57:00 +0000"  >&lt;p&gt;I am not sure what you mean by &quot;When codegen is disabled all results are correct.&quot;. I checked and I was able to reproduce both with codegen enabled and with codegen disabled.&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jerryshao&quot; class=&quot;user-hover&quot; rel=&quot;jerryshao&quot;&gt;jerryshao&lt;/a&gt; this doesn&apos;t seem a regression to me but it is a pretty serious bug, I am not sure whether we should include it in the next 2.3 version.&lt;br/&gt;
cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smilegator&quot; class=&quot;user-hover&quot; rel=&quot;smilegator&quot;&gt;smilegator&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cloud_fan&quot; class=&quot;user-hover&quot; rel=&quot;cloud_fan&quot;&gt;cloud_fan&lt;/a&gt; I think we should consider this a blocker for 2.4. What do you think? Thanks.&lt;/p&gt;</comment>
                            <comment id="16561080" author="apachespark" created="Sun, 29 Jul 2018 11:09:04 +0000"  >&lt;p&gt;User &apos;mgaido91&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21910&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21910&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16561277" author="dvogelbacher" created="Sun, 29 Jul 2018 21:53:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mgaido&quot; class=&quot;user-hover&quot; rel=&quot;mgaido&quot;&gt;mgaido&lt;/a&gt; thanks for putting up the PR!&lt;/p&gt;

&lt;p&gt;I wasn&apos;t able to reproduce the incorrectness for the specific example I gave with wholestage codegen disabled:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;scala&amp;gt; spark.conf.set(&quot;spark.sql.codegen.wholeStage&quot;, false)

scala&amp;gt; import org.apache.spark.sql.functions
import org.apache.spark.sql.functions

scala&amp;gt; val df = Seq(
     | (&quot;a&quot;, BigDecimal(&quot;12.0&quot;)),
     | (&quot;a&quot;, BigDecimal(&quot;12.0&quot;)),
     | (&quot;a&quot;, BigDecimal(&quot;11.9999999988&quot;)),
     | (&quot;a&quot;, BigDecimal(&quot;12.0&quot;)),
     | (&quot;a&quot;, BigDecimal(&quot;12.0&quot;)),
     | (&quot;a&quot;, BigDecimal(&quot;11.9999999988&quot;)),
     | (&quot;a&quot;, BigDecimal(&quot;11.9999999988&quot;))
     | ).toDF(&quot;text&quot;, &quot;number&quot;)
df: org.apache.spark.sql.DataFrame = [text: string, number: decimal(38,18)]

scala&amp;gt; val df_grouped_1 = df.groupBy(df.col(&quot;text&quot;)).agg(functions.avg(df.col(&quot;number&quot;)).as(&quot;number&quot;))
df_grouped_1: org.apache.spark.sql.DataFrame = [text: string, number: decimal(38,22)]

scala&amp;gt; df_grouped_1.collect()
res1: Array[org.apache.spark.sql.Row] = Array([a,11.9999999994857142857143])

scala&amp;gt; val df_grouped_2 = df_grouped_1.groupBy(df_grouped_1.col(&quot;text&quot;)).agg(functions.sum(df_grouped_1.col(&quot;number&quot;)).as(&quot;number&quot;))
df_grouped_2: org.apache.spark.sql.DataFrame = [text: string, number: decimal(38,22)]

scala&amp;gt; df_grouped_2.collect()
res2: Array[org.apache.spark.sql.Row] = Array([a,11.9999999994857142857143])

scala&amp;gt; val df_total_sum = df_grouped_1.agg(functions.sum(df_grouped_1.col(&quot;number&quot;)).as(&quot;number&quot;))
df_total_sum: org.apache.spark.sql.DataFrame = [number: decimal(38,22)]

scala&amp;gt; df_total_sum.collect()
res3: Array[org.apache.spark.sql.Row] = Array([11.9999999994857142857143])
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16561334" author="jerryshao" created="Mon, 30 Jul 2018 01:41:41 +0000"  >&lt;p&gt;Not necessary to mark as blocker, we still have plenty of time for 2.4 release, I will mark the target version as 2.4.0.&lt;/p&gt;</comment>
                            <comment id="16561893" author="cloud_fan" created="Mon, 30 Jul 2018 13:02:44 +0000"  >&lt;p&gt;Issue resolved by pull request 21910&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21910&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21910&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16565861" author="apachespark" created="Wed, 1 Aug 2018 19:28:05 +0000"  >&lt;p&gt;User &apos;mgaido91&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21949&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21949&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16566177" author="apachespark" created="Thu, 2 Aug 2018 00:27:04 +0000"  >&lt;p&gt;User &apos;gatorsmile&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/21951&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/21951&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13179580">SPARK-25146</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 15 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3wfkf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12342385">2.4.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>