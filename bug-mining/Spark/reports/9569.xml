<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:40:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-45527] Task fraction resource request is not expected</title>
                <link>https://issues.apache.org/jira/browse/SPARK-45527</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
test(&lt;span class=&quot;code-quote&quot;&gt;&quot;SPARK-XXX&quot;&lt;/span&gt;) {
  &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.spark.resource.{ResourceProfileBuilder, TaskResourceRequests}

  withTempDir { dir =&amp;gt;
    val scriptPath = createTempScriptWithExpectedOutput(dir, &lt;span class=&quot;code-quote&quot;&gt;&quot;gpuDiscoveryScript&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;&quot;{&quot;&lt;/span&gt;name&lt;span class=&quot;code-quote&quot;&gt;&quot;: &quot;&lt;/span&gt;gpu&lt;span class=&quot;code-quote&quot;&gt;&quot;,&quot;&lt;/span&gt;addresses&lt;span class=&quot;code-quote&quot;&gt;&quot;:[&quot;&lt;/span&gt;0&lt;span class=&quot;code-quote&quot;&gt;&quot;]}&quot;&lt;/span&gt;&quot;&quot;)

    val conf = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SparkConf()
      .setAppName(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;)
      .setMaster(&lt;span class=&quot;code-quote&quot;&gt;&quot;local-cluster[1, 12, 1024]&quot;&lt;/span&gt;)
      .set(&lt;span class=&quot;code-quote&quot;&gt;&quot;spark.executor.cores&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;12&quot;&lt;/span&gt;)
    conf.set(TASK_GPU_ID.amountConf, &lt;span class=&quot;code-quote&quot;&gt;&quot;0.08&quot;&lt;/span&gt;)
    conf.set(WORKER_GPU_ID.amountConf, &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;)
    conf.set(WORKER_GPU_ID.discoveryScriptConf, scriptPath)
    conf.set(EXECUTOR_GPU_ID.amountConf, &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;)
    sc = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SparkContext(conf)
    val rdd = sc.range(0, 100, 1, 4)
    &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; rdd1 = rdd.repartition(3)
    val treqs = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TaskResourceRequests().cpus(1).resource(&lt;span class=&quot;code-quote&quot;&gt;&quot;gpu&quot;&lt;/span&gt;, 1.0)
    val rp = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ResourceProfileBuilder().require(treqs).build
    rdd1 = rdd1.withResources(rp)
    &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt;(rdd1.collect().size === 100)
  }
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In the above test, the 3 tasks generated by rdd1 are expected to be executed in sequence as we expect &quot;new TaskResourceRequests().cpus(1).resource(&quot;gpu&quot;, 1.0)&quot; should override &quot;conf.set(TASK_GPU_ID.amountConf, &quot;0.08&quot;)&quot;. However, those 3 tasks are run in parallel in fact.&lt;/p&gt;

&lt;p&gt;The root cause is that ExecutorData#ExecutorResourceInfo#numParts is static. In this case, the &quot;gpu.numParts&quot; is initialized with 12 (1/0.08) and won&apos;t change even if there&apos;s a new task resource request (e.g., resource(&quot;gpu&quot;, 1.0) in this case). Thus, those 3 tasks are able to be executed in parallel.&lt;br/&gt;
&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13553942">SPARK-45527</key>
            <summary>Task fraction resource request is not expected</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="wbo4958">Bobby Wang</assignee>
                                    <reporter username="Ngone51">wuyi</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 13 Oct 2023 01:56:12 +0000</created>
                <updated>Tue, 19 Mar 2024 13:50:17 +0000</updated>
                            <resolved>Thu, 4 Jan 2024 15:21:43 +0000</resolved>
                                    <version>3.2.1</version>
                    <version>3.3.3</version>
                    <version>3.4.1</version>
                    <version>3.5.0</version>
                                    <fixVersion>4.0.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17774756" author="ngone51" created="Fri, 13 Oct 2023 01:58:50 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wbo4958&quot; class=&quot;user-hover&quot; rel=&quot;wbo4958&quot;&gt;wbo4958&lt;/a&gt; &#160; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tgraves&quot; class=&quot;user-hover&quot; rel=&quot;tgraves&quot;&gt;tgraves&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17774957" author="tgraves" created="Fri, 13 Oct 2023 15:30:38 +0000"  >&lt;p&gt;thanks for filing and digging into this. I assume this is only with the TaskResourceRequests and using the default ExecutorResourceRequests.&#160; seems a bug since that functionality was added.&#160; Either way when we fix should add tests similar if we can.&lt;/p&gt;</comment>
                            <comment id="17775948" author="wbo4958" created="Mon, 16 Oct 2023 23:16:50 +0000"  >&lt;p&gt;Working on a PR to fix it.&lt;/p&gt;</comment>
                            <comment id="17821279" author="tgraves" created="Tue, 27 Feb 2024 14:55:15 +0000"  >&lt;p&gt;Note that this is related to &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-39853&quot; title=&quot;Support stage level schedule for standalone cluster when dynamic allocation is disabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-39853&quot;&gt;&lt;del&gt;SPARK-39853&lt;/del&gt;&lt;/a&gt; which was supposed to implement stage level scheduling with dynamic allocation disabled.&#160; That pr did not properly handle resources (gpu, fpga, etc)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13572345">SPARK-47458</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="13473127">SPARK-39853</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 37 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1kx1s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>