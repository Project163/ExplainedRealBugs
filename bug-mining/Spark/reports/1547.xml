<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:24:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-6194] collect() in PySpark will cause memory leak in JVM</title>
                <link>https://issues.apache.org/jira/browse/SPARK-6194</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;It could be reproduced  by:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; i in range(40):
    sc.parallelize(range(5000), 10).flatMap(lambda i: range(10000)).collect()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It will fail after 2 or 3 jobs, and run totally successfully if I add&lt;br/&gt;
`gc.collect()` after each job.&lt;/p&gt;

&lt;p&gt;We could call _detach() for the JavaList returned by collect&lt;br/&gt;
in Java, will send out a PR for this.&lt;/p&gt;

&lt;p&gt;Reported by Michael and commented by Josh&#65306;&lt;/p&gt;

&lt;p&gt;On Thu, Mar 5, 2015 at 2:39 PM, Josh Rosen &amp;lt;joshrosen@databricks.com&amp;gt; wrote:&lt;br/&gt;
&amp;gt; Based on Py4J&apos;s Memory Model page&lt;br/&gt;
&amp;gt; (&lt;a href=&quot;http://py4j.sourceforge.net/advanced_topics.html#py4j-memory-model):&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://py4j.sourceforge.net/advanced_topics.html#py4j-memory-model):&lt;/a&gt;&lt;br/&gt;
&amp;gt;&lt;br/&gt;
&amp;gt;&amp;gt; Because Java objects on the Python side are involved in a circular&lt;br/&gt;
&amp;gt;&amp;gt; reference (JavaObject and JavaMember reference each other), these objects&lt;br/&gt;
&amp;gt;&amp;gt; are not immediately garbage collected once the last reference to the object&lt;br/&gt;
&amp;gt;&amp;gt; is removed (but they are guaranteed to be eventually collected if the Python&lt;br/&gt;
&amp;gt;&amp;gt; garbage collector runs before the Python program exits).&lt;br/&gt;
&amp;gt;&lt;br/&gt;
&amp;gt;&lt;br/&gt;
&amp;gt;&amp;gt;&lt;br/&gt;
&amp;gt;&amp;gt; In doubt, users can always call the detach function on the Python gateway&lt;br/&gt;
&amp;gt;&amp;gt; to explicitly delete a reference on the Java side. A call to gc.collect()&lt;br/&gt;
&amp;gt;&amp;gt; also usually works.&lt;br/&gt;
&amp;gt;&lt;br/&gt;
&amp;gt;&lt;br/&gt;
&amp;gt; Maybe we should be manually calling detach() when the Python-side has&lt;br/&gt;
&amp;gt; finished consuming temporary objects from the JVM.  Do you have a small&lt;br/&gt;
&amp;gt; workload / configuration that reproduces the OOM which we can use to test a&lt;br/&gt;
&amp;gt; fix?  I don&apos;t think that I&apos;ve seen this issue in the past, but this might be&lt;br/&gt;
&amp;gt; because we mistook Java OOMs as being caused by collecting too much data&lt;br/&gt;
&amp;gt; rather than due to memory leaks.&lt;br/&gt;
&amp;gt;&lt;br/&gt;
&amp;gt; On Thu, Mar 5, 2015 at 10:41 AM, Michael Nazario &amp;lt;mnazario@palantir.com&amp;gt;&lt;br/&gt;
&amp;gt; wrote:&lt;br/&gt;
&amp;gt;&amp;gt;&lt;br/&gt;
&amp;gt;&amp;gt; Hi Josh,&lt;br/&gt;
&amp;gt;&amp;gt;&lt;br/&gt;
&amp;gt;&amp;gt; I have a question about how PySpark does memory management in the Py4J&lt;br/&gt;
&amp;gt;&amp;gt; bridge between the Java driver and the Python driver. I was wondering if&lt;br/&gt;
&amp;gt;&amp;gt; there have been any memory problems in this system because the Python&lt;br/&gt;
&amp;gt;&amp;gt; garbage collector does not collect circular references immediately and Py4J&lt;br/&gt;
&amp;gt;&amp;gt; has circular references in each object it receives from Java.&lt;br/&gt;
&amp;gt;&amp;gt;&lt;br/&gt;
&amp;gt;&amp;gt; When I dug through the PySpark code, I seemed to find that most RDD&lt;br/&gt;
&amp;gt;&amp;gt; actions return by calling collect. In collect, you end up calling the Java&lt;br/&gt;
&amp;gt;&amp;gt; RDD collect and getting an iterator from that. Would this be a possible&lt;br/&gt;
&amp;gt;&amp;gt; cause for a Java driver OutOfMemoryException because there are resources in&lt;br/&gt;
&amp;gt;&amp;gt; Java which do not get freed up immediately?&lt;br/&gt;
&amp;gt;&amp;gt;&lt;br/&gt;
&amp;gt;&amp;gt; I have also seen that trying to take a lot of values from a dataset twice&lt;br/&gt;
&amp;gt;&amp;gt; in a row can cause the Java driver to OOM (while just once works). Are there&lt;br/&gt;
&amp;gt;&amp;gt; some other memory considerations that are relevant in the driver?&lt;br/&gt;
&amp;gt;&amp;gt;&lt;br/&gt;
&amp;gt;&amp;gt; Thanks,&lt;br/&gt;
&amp;gt;&amp;gt; Michael&lt;/p&gt;</description>
                <environment></environment>
        <key id="12779949">SPARK-6194</key>
            <summary>collect() in PySpark will cause memory leak in JVM</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davies">Davies Liu</assignee>
                                    <reporter username="davies">Davies Liu</reporter>
                        <labels>
                    </labels>
                <created>Fri, 6 Mar 2015 01:14:24 +0000</created>
                <updated>Mon, 20 Apr 2015 19:07:02 +0000</updated>
                            <resolved>Thu, 2 Apr 2015 17:53:21 +0000</resolved>
                                    <version>1.0.2</version>
                    <version>1.1.1</version>
                    <version>1.2.1</version>
                    <version>1.3.0</version>
                                    <fixVersion>1.2.2</fixVersion>
                    <fixVersion>1.3.1</fixVersion>
                    <fixVersion>1.4.0</fixVersion>
                                    <component>PySpark</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14349803" author="apachespark" created="Fri, 6 Mar 2015 02:15:40 +0000"  >&lt;p&gt;User &apos;davies&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/4923&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/4923&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14360743" author="joshrosen" created="Fri, 13 Mar 2015 17:45:50 +0000"  >&lt;p&gt;I&apos;ve merged this into `master` (1.4.0), `branch-1.3` (1.3.1), and `branch-1.2` (1.2.2).  Not sure if we want to backport it all the way back to 1.1.x or 1.0.x.&lt;/p&gt;</comment>
                            <comment id="14385350" author="srowen" created="Sat, 28 Mar 2015 14:56:17 +0000"  >&lt;p&gt;Same, restored Fix versions. I fixed my query now.&lt;/p&gt;</comment>
                            <comment id="14393026" author="joshrosen" created="Thu, 2 Apr 2015 17:47:31 +0000"  >&lt;p&gt;This patch introduced a rare bug that can cause a hang while calling &lt;tt&gt;collect()&lt;/tt&gt; (&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-6194&quot; title=&quot;collect() in PySpark will cause memory leak in JVM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-6194&quot;&gt;&lt;del&gt;SPARK-6194&lt;/del&gt;&lt;/a&gt;); I&apos;m commenting here so that the issues are linked to ensure that the fixes land in the right branches.&lt;/p&gt;</comment>
                            <comment id="14393034" author="joshrosen" created="Thu, 2 Apr 2015 17:53:21 +0000"  >&lt;p&gt;Going to resolve this as &quot;Fixed&quot; for now, since I don&apos;t think we&apos;re going to backport prior to 1.2.x.&lt;/p&gt;</comment>
                            <comment id="14503444" author="mnazario" created="Mon, 20 Apr 2015 19:07:02 +0000"  >&lt;p&gt;I&apos;m commenting here to fix the link which Josh posted here earlier about a bug which was caused by this. The link he posted was this same ticket when it should have been &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-6294&quot; title=&quot;PySpark task may hang while call take() on in Java/Scala&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-6294&quot;&gt;&lt;del&gt;SPARK-6294&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 31 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i26ffz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310320" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Target Version/s</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12329321">1.2.2</customfieldvalue>
    <customfieldvalue id="12327642">1.3.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>