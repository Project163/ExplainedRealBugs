<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:23:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-33935] Fix CBOs cost function </title>
                <link>https://issues.apache.org/jira/browse/SPARK-33935</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;The parameter spark.sql.cbo.joinReorder.card.weight is decumented as:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;spark.sql.cbo.joinReorder.card.weight&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
The weight of cardinality (number of rows) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; plan cost comparison in join reorder: rows * weight + size * (1 - weight).
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But in the implementation the formula is a bit different:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Current implementation&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    def betterThan(other: JoinPlan, conf: SQLConf): &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; = {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (other.planCost.card == 0 || other.planCost.size == 0) {
        &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        val relativeRows = BigDecimal(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.planCost.card) / BigDecimal(other.planCost.card)
        val relativeSize = BigDecimal(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.planCost.size) / BigDecimal(other.planCost.size)
        relativeRows * conf.joinReorderCardWeight +
          relativeSize * (1 - conf.joinReorderCardWeight) &amp;lt; 1
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This change has an unfortunate consequence: &lt;br/&gt;
given two plans A and B, both A betterThan B and B betterThan A might give the same results. This happes when one has many rows with small sizes and other has few rows with large sizes.&lt;/p&gt;

&lt;p&gt;A example values, that have this fenomen with the default weight value (0.7):&lt;br/&gt;
A.card = 500, B.card = 300&lt;br/&gt;
A.size = 30, B.size = 80&lt;br/&gt;
Both A betterThan B and B betterThan A would have score above 1 and would return false.&lt;/p&gt;

&lt;p&gt;A new implementation is proposed, that matches the documentation:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Proposed implementation&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    def betterThan(other: JoinPlan, conf: SQLConf): &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt; = {
      val oldCost = BigDecimal(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.planCost.card) * conf.joinReorderCardWeight +
        BigDecimal(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.planCost.size) * (1 - conf.joinReorderCardWeight)
      val newCost = BigDecimal(other.planCost.card) * conf.joinReorderCardWeight +
        BigDecimal(other.planCost.size) * (1 - conf.joinReorderCardWeight)
      newCost &amp;lt; oldCost
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13348333">SPARK-33935</key>
            <summary>Fix CBOs cost function </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tanelk">Tanel Kiis</assignee>
                                    <reporter username="tanelk">Tanel Kiis</reporter>
                        <labels>
                    </labels>
                <created>Tue, 29 Dec 2020 17:58:57 +0000</created>
                <updated>Thu, 1 Apr 2021 08:37:10 +0000</updated>
                            <resolved>Tue, 5 Jan 2021 07:05:17 +0000</resolved>
                                    <version>2.4.7</version>
                    <version>3.0.1</version>
                    <version>3.1.0</version>
                    <version>3.2.0</version>
                                    <fixVersion>3.0.2</fixVersion>
                    <fixVersion>3.1.0</fixVersion>
                    <fixVersion>3.2.0</fixVersion>
                                    <component>SQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17256101" author="apachespark" created="Tue, 29 Dec 2020 18:30:17 +0000"  >&lt;p&gt;User &apos;tanelk&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/30965&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/30965&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17256103" author="apachespark" created="Tue, 29 Dec 2020 18:31:38 +0000"  >&lt;p&gt;User &apos;tanelk&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/30965&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/30965&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17258706" author="maropu" created="Tue, 5 Jan 2021 07:05:17 +0000"  >&lt;p&gt;Resolved by&#160;&lt;a href=&quot;https://github.com/apache/spark/pull/30965&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/30965&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17258828" author="apachespark" created="Tue, 5 Jan 2021 10:50:27 +0000"  >&lt;p&gt;User &apos;tanelk&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/31042&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/31042&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17258840" author="apachespark" created="Tue, 5 Jan 2021 11:08:01 +0000"  >&lt;p&gt;User &apos;tanelk&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/31043&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/31043&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17312908" author="apachespark" created="Thu, 1 Apr 2021 06:33:48 +0000"  >&lt;p&gt;User &apos;viirya&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/32020&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/32020&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 32 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0lwrs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>