<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 19:40:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-47036] RocksDB versionID Mismatch in SST files with Compaction</title>
                <link>https://issues.apache.org/jira/browse/SPARK-47036</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;RocksDB compaction can result in version Id mismatch errors if the same version is committed twice from the same executor. (Multiple commits can happen due to Spark Stage/task retry).&lt;/p&gt;

&lt;p&gt;A particular scenario where this can happen is provided below:&#160;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Version V1 is loaded on executor A, RocksDB State Store has 195.sst, 196.sst, 197.sst and 198.sst files.&#160;&lt;br/&gt;
2. State changes are made, which result in creation of a new table file 200.sst.&#160;&lt;br/&gt;
3. State store is committed as version V2. The SST file 200.sst (as 000200-8c80161a-bc23-4e3b-b175-cffe38e427c7.sst) is uploaded to DFS, and previous 4 files are reused. A new metadata file is created to track the exact SST files with unique IDs, and uploaded with RocksDB Manifest as part of V1.zip.&lt;br/&gt;
4. Rocks DB compaction is triggered at the same time. The compaction creates a new L1 file (201.sst), and deletes existing 5 SST files.&lt;br/&gt;
5. Spark Stage is retried.&#160;&lt;br/&gt;
6. Version V1 is reloaded on the same executor. The local files are inspected, and 201.sst is deleted. The 4 SST files in version V1 are downloaded again to local file system.&#160;&lt;br/&gt;
7. Any local files which are deleted (as part of version load) are also removed from local &#8594; DFS file upload tracking. *&lt;b&gt;However, the files already deleted as a result of compaction are not removed from tracking. This is the bug which resulted in the failure.&lt;/b&gt;*&lt;br/&gt;
8. State store is committed as version V1. However, the local mapping of SST files to DFS file path still has 200.sst in its tracking, hence the SST file is not re-uploaded. A new metadata file is created to track the exact SST files with unique IDs, and uploaded with the new RocksDB Manifest as part of V2.zip. (The V2.zip file is overwritten here atomically)&lt;br/&gt;
9. A new executor tried to load version V2. However, the SST files in (1) are now incompatible with Manifest file in (6) resulting in the version Id mismatch failure.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We need to ensure that any files deleted from local filesystem post compaction are not tracked in uploadedDFSFiles mapping if the same version is loaded again.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13568352">SPARK-47036</key>
            <summary>RocksDB versionID Mismatch in SST files with Compaction</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bhuwan.sahni">Bhuwan Sahni</assignee>
                                    <reporter username="bhuwan.sahni">Bhuwan Sahni</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Tue, 13 Feb 2024 21:06:10 +0000</created>
                <updated>Thu, 22 Feb 2024 02:01:00 +0000</updated>
                            <resolved>Wed, 21 Feb 2024 20:33:31 +0000</resolved>
                                    <version>3.5.0</version>
                    <version>3.5.1</version>
                    <version>3.5.2</version>
                    <version>4.0.0</version>
                                    <fixVersion>3.5.2</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                    <component>Structured Streaming</component>
                        <due>Fri, 16 Feb 2024 00:00:00 +0000</due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17819381" author="kabhwan" created="Wed, 21 Feb 2024 20:33:31 +0000"  >&lt;p&gt;Issue resolved by pull request 45092&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/45092&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/45092&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 37 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ndm0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>