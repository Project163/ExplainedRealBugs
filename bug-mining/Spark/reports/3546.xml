<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:43:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-14031] Dataframe to csv IO, system performance enters high CPU state and write operation takes 1 hour to complete</title>
                <link>https://issues.apache.org/jira/browse/SPARK-14031</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;Summary&lt;br/&gt;
When using spark-assembly-2.0.0/spark-shell trying to write out results of dataframe to csv, system performance enters high CPU state and write operation takes 1 hour to complete. &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Affecting: &lt;span class=&quot;error&quot;&gt;&amp;#91;Stage 5:&amp;gt;  (0 + 2) / 21&amp;#93;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;Stage 5 elapsed time 3488272270000ns&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;In comparison, tests where conducted using 1.4, 1.5, 1.6 with same code/data and Stage5 csv write times where between 2 - 22 seconds. &lt;/p&gt;

&lt;p&gt;In addition, Parquet (Stage 3) write tests 1.4, 1.5, 1.6 and 2.0 where similar between 2 - 22 seconds.&lt;/p&gt;

&lt;p&gt;Files &lt;br/&gt;
1. Data File is &quot;2008.csv&quot;&lt;br/&gt;
2. Data file download &lt;a href=&quot;http://stat-computing.org/dataexpo/2009/the-data.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stat-computing.org/dataexpo/2009/the-data.html&lt;/a&gt;&lt;br/&gt;
3. Code &lt;a href=&quot;https://gist.github.com/bigsnarfdude/581b780ce85d7aaecbcb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/bigsnarfdude/581b780ce85d7aaecbcb&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Observation 1 - Setup&lt;br/&gt;
High CPU and 58 minute average completion time &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;MACOSX 10.11.2&lt;/li&gt;
	&lt;li&gt;Macbook Pro 16g - 2.2 GHz Intel Core i7 -1TB&lt;/li&gt;
	&lt;li&gt;spark-assembly-2.0.0&lt;/li&gt;
	&lt;li&gt;spark-csv_2.11-1.4&lt;/li&gt;
	&lt;li&gt;Code: &lt;a href=&quot;https://gist.github.com/bigsnarfdude/581b780ce85d7aaecbcb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/bigsnarfdude/581b780ce85d7aaecbcb&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Observation 2 - Setup&lt;br/&gt;
High CPU and waited over hour for csv write but didnt wait to complete &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Ubuntu14.04&lt;/li&gt;
	&lt;li&gt;4cores 8gb&lt;/li&gt;
	&lt;li&gt;spark-assembly-2.0.0&lt;/li&gt;
	&lt;li&gt;spark-csv_2.11-1.4&lt;br/&gt;
Code Output: &lt;a href=&quot;https://gist.github.com/bigsnarfdude/930f5832c231c3d39651&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/bigsnarfdude/930f5832c231c3d39651&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment>&lt;p&gt;MACOSX 10.11.2 Macbook Pro 16g - 2.2 GHz Intel Core i7 -1TB and Ubuntu14.04 Vagrant 4 Cores 8g&lt;/p&gt;</environment>
        <key id="12951795">SPARK-14031</key>
            <summary>Dataframe to csv IO, system performance enters high CPU state and write operation takes 1 hour to complete</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="davies">Davies Liu</assignee>
                                    <reporter username="vohprecio">Vincent Ohprecio</reporter>
                        <labels>
                    </labels>
                <created>Sun, 20 Mar 2016 15:37:00 +0000</created>
                <updated>Mon, 23 May 2016 17:49:00 +0000</updated>
                            <resolved>Mon, 23 May 2016 17:49:00 +0000</resolved>
                                    <version>2.0.0</version>
                                    <fixVersion>2.0.0</fixVersion>
                                    <component>Spark Shell</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15203335" author="srowen" created="Sun, 20 Mar 2016 15:53:27 +0000"  >&lt;p&gt;What stage is slow? a lot of this is irrelevant. you don&apos;t need to link screenshots or binaries. You should inline a minimal reproduction. &lt;br/&gt;
It&apos;s not clear this is slow relative to the task at hand. Are you in GC thrashing? what are your settings for spark-shell? etc.&lt;/p&gt;</comment>
                            <comment id="15203366" author="vohprecio" created="Sun, 20 Mar 2016 17:11:39 +0000"  >&lt;p&gt;spark-shell has 4g. It looks like its affecting Stage 5.  In version 1.4, 1.5, 1.6 writes are around 22 seconds. Its 60 minutes with 2.0.&lt;br/&gt;
Here is my jstat output: &lt;a href=&quot;https://gist.github.com/bigsnarfdude/f96c2e1f9440673157c9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/bigsnarfdude/f96c2e1f9440673157c9&lt;/a&gt;&lt;br/&gt;
Here is my inline code output: &lt;a href=&quot;https://gist.github.com/bigsnarfdude/fad5a9ba7ac381120e93&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/bigsnarfdude/fad5a9ba7ac381120e93&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15203376" author="srowen" created="Sun, 20 Mar 2016 17:27:19 +0000"  >&lt;p&gt;I think that shows your permgen space is 99% full and GC is taking 40 seconds of the 60. I think your permgen is just too small.&lt;/p&gt;</comment>
                            <comment id="15203605" author="vohprecio" created="Mon, 21 Mar 2016 00:52:06 +0000"  >&lt;p&gt;./bin/spark-shell --packages com.databricks:spark-csv_2.11:1.4.0 --driver-memory 4g --executor-memory 4g --driver-java-options &quot;-XX:MaxPermSize=1024m&quot;&lt;/p&gt;

&lt;p&gt;Stage 5 continued to be 56 minutes. I attached VisualVM and Heap stayed under 2g, and PermGen stayed under 200mb&lt;/p&gt;

&lt;p&gt;Code Output: &lt;a href=&quot;https://gist.github.com/bigsnarfdude/29518daffe4ed77dc5d4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/bigsnarfdude/29518daffe4ed77dc5d4&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15203865" author="srowen" created="Mon, 21 Mar 2016 07:48:40 +0000"  >&lt;p&gt;Hm, but...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;vagrant@data-science-toolbox:~$ jstat -gcutil 5843
  S0     S1     E      O      P     YGC     YGCT    FGC    FGCT     GCT
 71.32  47.61   0.00  11.66  99.77   8299   39.727     0    0.000   39.727
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This says 40 seconds were spent in GC. &lt;br/&gt;
What is stage 5? &lt;/p&gt;</comment>
                            <comment id="15204462" author="vohprecio" created="Mon, 21 Mar 2016 15:38:03 +0000"  >&lt;p&gt;Those are jstats from previous setup with --driver-memory 4g --executor-memory 1g --driver-java-options &quot;-XX:MaxPermSize=256m&quot;.&lt;/p&gt;

&lt;p&gt;The latest run (screenshot attached) is using shell with --driver-memory 4g --executor-memory 4g --driver-java-options &quot;-XX:MaxPermSize=1024m&quot; because you suggested that the GC was thrashing so I bumped the Heap(4g), and PermGen(1G).&lt;/p&gt;

&lt;p&gt;Stage 5 is section of code where program chews thru CPU. &lt;a href=&quot;https://gist.github.com/bigsnarfdude/29518daffe4ed77dc5d4#file-gistfile1-txt-L101&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/bigsnarfdude/29518daffe4ed77dc5d4#file-gistfile1-txt-L101&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15204493" author="srowen" created="Mon, 21 Mar 2016 15:54:39 +0000"  >&lt;p&gt;Yes, but what is being executed in that stage? you&apos;ll see it in the web UI.&lt;br/&gt;
What is the GC activity from your updated run? I suspect it is &lt;em&gt;not&lt;/em&gt; GC this time given how much you&apos;ve increased, but worth looking.&lt;/p&gt;</comment>
                            <comment id="15205300" author="vohprecio" created="Mon, 21 Mar 2016 22:38:51 +0000"  >&lt;p&gt;GC accounts for less than 0.3-1.5% of CPU time.&lt;/p&gt;

&lt;p&gt;Here is the sampler report for CPU:&lt;br/&gt;
com.univorcity.parsers.common.input.DefaultCharAppender.&amp;lt;init&amp;gt;() ... 64%&lt;br/&gt;
io.netty.channel.nio.NioEventLoop.select() ... 21%&lt;br/&gt;
org.spark-project.jetty.io.nio.SelectorManager$SelectSet.doSelect() ... 10%&lt;br/&gt;
org.apache.sparl.sql.execution.datasources.csv.LineCsvWriter.writeRow() ... 4%&lt;/p&gt;

&lt;p&gt;with a stack trace after detaching VisualVM:&lt;br/&gt;
&lt;a href=&quot;https://gist.github.com/bigsnarfdude/9f15fd55da3a6d85582a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/bigsnarfdude/9f15fd55da3a6d85582a&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15206186" author="srowen" created="Tue, 22 Mar 2016 11:11:44 +0000"  >&lt;p&gt;I don&apos;t recognize univorcity. Is it code you call in your app? if so it seems like that where the time is being spent.&lt;/p&gt;</comment>
                            <comment id="15206302" author="vohprecio" created="Tue, 22 Mar 2016 12:59:10 +0000"  >&lt;p&gt;The code an example from Apache Spark docs using the standard package csv library from databricks with a larger csv found here: `&lt;a href=&quot;https://github.com/databricks/spark-csv&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/databricks/spark-csv&lt;/a&gt;`&lt;/p&gt;


&lt;p&gt;Full code to reproduce here:&lt;br/&gt;
`import org.apache.spark.sql.SQLContext&lt;br/&gt;
val sqlContext = new SQLContext(sc)&lt;br/&gt;
val df = sqlContext.read.format(&quot;com.databricks.spark.csv&quot;).option(&quot;header&quot;, &quot;true&quot;).load(&quot;/Users/employee/Downloads/2008.csv&quot;)&lt;br/&gt;
val selectedData = df.select(&quot;Year&quot;, &quot;Cancelled&quot;)&lt;br/&gt;
selectedData.write.format(&quot;com.databricks.spark.csv&quot;).option(&quot;header&quot;, &quot;true&quot;).save(&quot;output.csv&quot;)&lt;br/&gt;
`&lt;/p&gt;</comment>
                            <comment id="15210471" author="vohprecio" created="Thu, 24 Mar 2016 16:08:45 +0000"  >&lt;p&gt;Marco Mistroni (from spark user group) had emailed me advising that he recreated the High CPU issue as well using the above code with 2.0&lt;/p&gt;</comment>
                            <comment id="15294127" author="apachespark" created="Fri, 20 May 2016 20:24:08 +0000"  >&lt;p&gt;User &apos;davies&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/13229&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/13229&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15296726" author="lian cheng" created="Mon, 23 May 2016 17:49:00 +0000"  >&lt;p&gt;Issue resolved by pull request 13229&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/13229&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/13229&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12794438" name="visualVMscreenshot.png" size="240151" author="vohprecio" created="Mon, 21 Mar 2016 00:50:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 26 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2uxg7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>