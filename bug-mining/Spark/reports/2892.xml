<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 18:36:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SPARK-12267] Standalone master keeps references to disassociated workers until they sent no heartbeats</title>
                <link>https://issues.apache.org/jira/browse/SPARK-12267</link>
                <project id="12315420" key="SPARK">Spark</project>
                    <description>&lt;p&gt;While toying with Spark Standalone I&apos;ve noticed the following messages&lt;br/&gt;
in the logs of the master:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;INFO Master: Registering worker 192.168.1.6:59919 with 2 cores, 2.0 GB RAM
INFO Master: localhost:59920 got disassociated, removing it.
...
WARN Master: Removing worker-20151210090708-192.168.1.6-59919 because
we got no heartbeat in 60 seconds
INFO Master: Removing worker worker-20151210090708-192.168.1.6-59919
on 192.168.1.6:59919
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Why does the message &quot;WARN Master: Removing&lt;br/&gt;
worker-20151210090708-192.168.1.6-59919 because we got no heartbeat in&lt;br/&gt;
60 seconds&quot; appear when the worker should&apos;ve been removed already (as&lt;br/&gt;
pointed out in &quot;INFO Master: localhost:59920 got disassociated,&lt;br/&gt;
removing it.&quot;)?&lt;/p&gt;

&lt;p&gt;Could it be that the ids are different - 192.168.1.6:59919 vs localhost:59920?&lt;/p&gt;

&lt;p&gt;I started master using &lt;tt&gt;./sbin/start-master.sh -h localhost&lt;/tt&gt; and the&lt;br/&gt;
workers &lt;tt&gt;./sbin/start-slave.sh spark://localhost:7077&lt;/tt&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12920858">SPARK-12267</key>
            <summary>Standalone master keeps references to disassociated workers until they sent no heartbeats</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zsxwing">Shixiong Zhu</assignee>
                                    <reporter username="jlaskowski">Jacek Laskowski</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Dec 2015 19:21:37 +0000</created>
                <updated>Wed, 16 Dec 2015 00:09:49 +0000</updated>
                            <resolved>Sun, 13 Dec 2015 06:01:23 +0000</resolved>
                                    <version>1.6.0</version>
                                    <fixVersion>1.6.0</fixVersion>
                                    <component>Spark Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="15051502" author="zsxwing" created="Thu, 10 Dec 2015 19:27:40 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vanzin&quot; class=&quot;user-hover&quot; rel=&quot;vanzin&quot;&gt;vanzin&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15051683" author="vanzin" created="Thu, 10 Dec 2015 21:30:10 +0000"  >&lt;p&gt;Pasting Shixiong&apos;s comments from github (&lt;a href=&quot;https://github.com/apache/spark/pull/9138):&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/9138):&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;@vanzin just found an issue about this change. Now if the master receives RegisterWorker, it won&apos;t use the workerRef to send the reply. So there is no connection from Master to the server in Worker. If the Worker is killed now, Master only observes some client is lost, but the address is just a client address in Worker and won&apos;t match the Worker address. So Master cannot remove this dead Worker at once. However, this Worker will be removed in 60 seconds because of no heartbeat.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="15051700" author="vanzin" created="Thu, 10 Dec 2015 21:44:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zsxwing&quot; class=&quot;user-hover&quot; rel=&quot;zsxwing&quot;&gt;zsxwing&lt;/a&gt; you&apos;re right but that&apos;s the wrong PR you picked; I think this is a side-effect of &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-10997&quot; title=&quot;Netty-based RPC env should support a &amp;quot;client-only&amp;quot; mode.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-10997&quot;&gt;&lt;del&gt;SPARK-10997&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Still trying to figure out the best way to fix this.&lt;/p&gt;</comment>
                            <comment id="15051732" author="vanzin" created="Thu, 10 Dec 2015 22:04:36 +0000"  >&lt;p&gt;I think the following would work. The problem right now is that the Worker listens for incoming connections; and when that happens, the &lt;tt&gt;senderAddress&lt;/tt&gt; of RPC messages becomes the listening address of the Worker, instead of the address of the socket sending messages to the Master. When the worker disconnects, the Master sees a disconnection from that client socket, but doesn&apos;t know that it actually relates to that listening address, so doesn&apos;t unregister anything.&lt;/p&gt;

&lt;p&gt;I think instead that, in Netty&apos;s case, &lt;tt&gt;RpcCallContext.senderAddress&lt;/tt&gt; should always be the address of the client socket, regardless of whether the sender is listening. That would fix this problem. RpcEndpoints for those listening processes would still have the listen address of the RpcEnv.&lt;/p&gt;

&lt;p&gt;There are three places where `senderAddress` is used outside of Master:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;MapOutputTrackerMasterEndpoint when handling GetMapOutputStatuses, but that&apos;s only logging&lt;/li&gt;
	&lt;li&gt;in CoarseGrainedSchedulerBackend when handling &lt;tt&gt;RegisterExecutor&lt;/tt&gt;, but that already seems to be doing the right thing (since in Netty&apos;s case executors are not listening)&lt;/li&gt;
	&lt;li&gt;in ReceiverTracker when handling RegisterReceiver, but that&apos;s also only logging&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So the above suggestion should work as far as I can tell.&lt;/p&gt;</comment>
                            <comment id="15051757" author="shixiong@databricks.com" created="Thu, 10 Dec 2015 22:23:00 +0000"  >&lt;p&gt;Sounds correct. But looks a lot changes to &lt;tt&gt;Master.scala&lt;/tt&gt;. Need to pass &lt;tt&gt;senderAddress&lt;/tt&gt; to a lot of places. I think we can just handle it in `NettyRpcHandler` like the previous way.&lt;/p&gt;</comment>
                            <comment id="15051767" author="vanzin" created="Thu, 10 Dec 2015 22:27:41 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think we can just handle it in `NettyRpcHandler` like the previous way.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah that&apos;s my plan.&lt;/p&gt;</comment>
                            <comment id="15051952" author="zsxwing" created="Fri, 11 Dec 2015 01:06:31 +0000"  >&lt;p&gt;Could you send a PR quickly so that we can get the fix into RC2?&lt;/p&gt;</comment>
                            <comment id="15051953" author="zsxwing" created="Fri, 11 Dec 2015 01:06:43 +0000"  >&lt;p&gt;If you don&apos;t have time, I can do it.&lt;/p&gt;</comment>
                            <comment id="15051995" author="vanzin" created="Fri, 11 Dec 2015 01:43:38 +0000"  >&lt;p&gt;My first approach was starting to get unwieldy, so I&apos;m trying a second approach that I hope will be simpler. If you have a fix in mind, please send a PR or a description and we can discuss it.&lt;/p&gt;</comment>
                            <comment id="15052085" author="vanzin" created="Fri, 11 Dec 2015 03:12:12 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zsxwing&quot; class=&quot;user-hover&quot; rel=&quot;zsxwing&quot;&gt;zsxwing&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andrewor14&quot; class=&quot;user-hover&quot; rel=&quot;andrewor14&quot;&gt;andrewor14&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I uploaded my code to &lt;a href=&quot;https://github.com/vanzin/spark/tree/SPARK-12267&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/vanzin/spark/tree/SPARK-12267&lt;/a&gt;. I didn&apos;t file a PR because I&apos;m gonna be out tomorrow and can&apos;t really follow on it. But can one of you run the following test using Shixiong&apos;s PR and see whether that works? His code is simpler, and if it fixes the problems, we should use that for 1.6 instead of my change.&lt;/p&gt;

&lt;p&gt;You&apos;ll need 4 terminals (adjust addresses as needed):&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;run &lt;tt&gt;./bin/spark-class org.apache.spark.deploy.master.Master -p 7077 --webui-port 8080 --properties-file /tmp/ha.conf&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;run &lt;tt&gt;./bin/spark-class org.apache.spark.deploy.master.Master -p 17077 --webui-port 18080 --properties-file /tmp/ha.conf&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;run &lt;tt&gt;./bin/spark-class org.apache.spark.deploy.worker.Worker spark://&amp;lt;ip&amp;gt;:7077,&amp;lt;ip&amp;gt;:17077&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;run &lt;tt&gt;./bin/spark-shell --master spark://&amp;lt;ip&amp;gt;:7077,&amp;lt;ip&amp;gt;:17077&lt;/tt&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;My ha.conf: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;spark.deploy.recoveryMode=ZOOKEEPER
spark.deploy.zookeeper.url=&amp;lt;zookeeper_host&amp;gt;:2181
spark.deploy.zookeeper.dir=/spark
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Once the shell is up and working, kill the active Master (in terminal 1 most probably). Wait for the timeout and make sure the app registers with the other master, and that the other master&apos;s UI works. Then kill the worker, make sure it goes away instantly in the active master&apos;s logs.&lt;/p&gt;

&lt;p&gt;We really need a unit test for this. As far as I can tell none of the worker / app re-registration code in Master.scala is exercised by unit tests.&lt;/p&gt;</comment>
                            <comment id="15052169" author="zsxwing" created="Fri, 11 Dec 2015 04:52:15 +0000"  >&lt;p&gt;I saw the follow exception when following the steps:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.NullPointerException
	at org.apache.spark.deploy.master.ApplicationInfo.curAppUIUrl(ApplicationInfo.scala:143)
	at org.apache.spark.deploy.master.ui.MasterPage.org$apache$spark$deploy$master$ui$MasterPage$$appRow(MasterPage.scala:209)
	at org.apache.spark.deploy.master.ui.MasterPage$$anonfun$6.apply(MasterPage.scala:82)
	at org.apache.spark.deploy.master.ui.MasterPage$$anonfun$6.apply(MasterPage.scala:82)
	at org.apache.spark.ui.UIUtils$$anonfun$listingTable$2.apply(UIUtils.scala:310)
	at org.apache.spark.ui.UIUtils$$anonfun$listingTable$2.apply(UIUtils.scala:310)
	at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:244)
	at scala.collection.TraversableLike$$anonfun$map$1.apply(TraversableLike.scala:244)
	at scala.collection.IndexedSeqOptimized$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;foreach(IndexedSeqOptimized.scala:33)
	at scala.collection.mutable.WrappedArray.foreach(WrappedArray.scala:34)
	at scala.collection.TraversableLike$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;map(TraversableLike.scala:244)
	at scala.collection.AbstractTraversable.map(Traversable.scala:105)
	at org.apache.spark.ui.UIUtils$.listingTable(UIUtils.scala:310)
	at org.apache.spark.deploy.master.ui.MasterPage.render(MasterPage.scala:82)
	at org.apache.spark.ui.WebUI$$anonfun$2.apply(WebUI.scala:79)
	at org.apache.spark.ui.WebUI$$anonfun$2.apply(WebUI.scala:79)
	at org.apache.spark.ui.JettyUtils$$anon$1.doGet(JettyUtils.scala:79)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:735)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:848)
	at org.eclipse.jetty.servlet.ServletHolder.handle(ServletHolder.java:684)
	at org.eclipse.jetty.servlet.ServletHandler.doHandle(ServletHandler.java:501)
	at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1086)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Will investigate&lt;/p&gt;</comment>
                            <comment id="15053041" author="vanzin" created="Fri, 11 Dec 2015 17:17:36 +0000"  >&lt;p&gt;You need this:&lt;br/&gt;
&lt;a href=&quot;https://github.com/vanzin/spark/commit/3848bf5e5bee4aa132aa001baab41dc58d39e5c5#diff-acd05d6d379b6ef6ccf36bd3db5614f6R69&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/vanzin/spark/commit/3848bf5e5bee4aa132aa001baab41dc58d39e5c5#diff-acd05d6d379b6ef6ccf36bd3db5614f6R69&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15053413" author="zsxwing" created="Fri, 11 Dec 2015 19:30:00 +0000"  >&lt;p&gt;This NPE issue was introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-11344&quot; title=&quot;ApplicationDescription should be immutable case class&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-11344&quot;&gt;&lt;del&gt;SPARK-11344&lt;/del&gt;&lt;/a&gt;. I tried Akka and Master HA still failed.&lt;/p&gt;</comment>
                            <comment id="15053450" author="zsxwing" created="Fri, 11 Dec 2015 19:51:40 +0000"  >&lt;p&gt;I just fixed NPE and verified my PR worked as your expectation when following the steps.&lt;/p&gt;</comment>
                            <comment id="15054012" author="apachespark" created="Sat, 12 Dec 2015 03:55:03 +0000"  >&lt;p&gt;User &apos;zsxwing&apos; has created a pull request for this issue:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/spark/pull/10261&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/pull/10261&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15054809" author="zsxwing" created="Sun, 13 Dec 2015 06:01:23 +0000"  >&lt;p&gt;Set 1.6.1 as one of fix versions. If there is RC3, should change it to 1.6.0.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 49 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2pqfr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>