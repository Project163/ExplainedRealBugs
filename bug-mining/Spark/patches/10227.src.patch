diff --git a/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/analysis/ResolveLateralColumnAliasReference.scala b/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/analysis/ResolveLateralColumnAliasReference.scala
index 632d01f18ec..0b529f209e7 100644
--- a/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/analysis/ResolveLateralColumnAliasReference.scala
+++ b/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/analysis/ResolveLateralColumnAliasReference.scala
@@ -113,7 +113,7 @@ import org.apache.spark.sql.internal.SQLConf
  * [[ExtractWindowExpressions]].
  */
 // scalastyle:on line.size.limit
-object ResolveLateralColumnAliasReference extends Rule[LogicalPlan] {
+object ResolveLateralColumnAliasReference extends Rule[LogicalPlan] with AliasHelper {
   case class AliasEntry(alias: Alias, index: Int)
 
   private def assignAlias(expr: Expression): NamedExpression = {
@@ -170,7 +170,7 @@ object ResolveLateralColumnAliasReference extends Rule[LogicalPlan] {
               UnresolvedAttribute(lcaRef.nameParts)
           }.asInstanceOf[NamedExpression]
         }
-        val newProjectList = projectList.zipWithIndex.map {
+        val newProjectList = projectList.map(trimNonTopLevelAliases).zipWithIndex.map {
           case (a: Alias, idx) =>
             val lcaResolved = unwrapLCAReference(a)
             // Insert the original alias instead of rewritten one to detect chained LCA
@@ -269,7 +269,9 @@ object ResolveLateralColumnAliasReference extends Rule[LogicalPlan] {
             }
           }
           val projectExprs = aggregateExpressions.map(
-            extractExpressions(_).asInstanceOf[NamedExpression])
+            expression =>
+              extractExpressions(trimNonTopLevelAliases(expression)).asInstanceOf[NamedExpression]
+          )
           val newProject = Project(
             projectList = projectExprs,
             child = agg.copy(aggregateExpressions = newAggExprs.asScala.toSeq)
diff --git a/sql/core/src/test/resources/sql-tests/analyzer-results/struct.sql.out b/sql/core/src/test/resources/sql-tests/analyzer-results/struct.sql.out
index dba912cdff7..1e55d50ba55 100644
--- a/sql/core/src/test/resources/sql-tests/analyzer-results/struct.sql.out
+++ b/sql/core/src/test/resources/sql-tests/analyzer-results/struct.sql.out
@@ -93,3 +93,29 @@ Project [ID#x, struct(STC, ST#x.C, STD, ST#x.D).STD AS struct(ST.C AS STC, ST.D
       +- Project [cast(ID#x as int) AS ID#x, cast(ST#x as struct<C:string,D:string>) AS ST#x]
          +- SubqueryAlias T
             +- LocalRelation [ID#x, ST#x]
+
+
+-- !query
+SELECT STRUCT(1 AS a) AS b, b AS c
+-- !query analysis
+Project [b#x, b#x AS c#x]
++- Project [struct(a, 1) AS b#x]
+   +- OneRowRelation
+
+
+-- !query
+SELECT STRUCT(1 AS a) AS b, b AS c GROUP BY b
+-- !query analysis
+Project [b#x, b#x AS c#x]
++- Project [struct(1)#x, struct(1)#x AS b#x]
+   +- Aggregate [struct(a, 1)], [struct(a, 1) AS struct(1)#x]
+      +- OneRowRelation
+
+
+-- !query
+SELECT MAX(STRUCT(1 AS a)), 2 AS b, b AS c GROUP BY b
+-- !query analysis
+Project [max(struct(1))#x AS max(struct(1 AS a))#x, b#x, b#x AS c#x]
++- Project [max(struct(1))#x, 2#x, 2#x AS b#x]
+   +- Aggregate [2], [max(struct(a, 1)) AS max(struct(1))#x, 2 AS 2#x]
+      +- OneRowRelation
diff --git a/sql/core/src/test/resources/sql-tests/inputs/struct.sql b/sql/core/src/test/resources/sql-tests/inputs/struct.sql
index 93a1238ab18..cb75b2967dd 100644
--- a/sql/core/src/test/resources/sql-tests/inputs/struct.sql
+++ b/sql/core/src/test/resources/sql-tests/inputs/struct.sql
@@ -24,4 +24,9 @@ SELECT ID, STRUCT(ST.*).C NST FROM tbl_x;
 SELECT ID, STRUCT(ST.C, ST.D).D NST FROM tbl_x;
 
 -- Select an alias from a struct
-SELECT ID, STRUCT(ST.C as STC, ST.D as STD).STD FROM tbl_x;
\ No newline at end of file
+SELECT ID, STRUCT(ST.C as STC, ST.D as STD).STD FROM tbl_x;
+
+-- LCAs with struct columns
+SELECT STRUCT(1 AS a) AS b, b AS c;
+SELECT STRUCT(1 AS a) AS b, b AS c GROUP BY b;
+SELECT MAX(STRUCT(1 AS a)), 2 AS b, b AS c GROUP BY b;
diff --git a/sql/core/src/test/resources/sql-tests/results/struct.sql.out b/sql/core/src/test/resources/sql-tests/results/struct.sql.out
index d642321e218..fb8f0427e95 100644
--- a/sql/core/src/test/resources/sql-tests/results/struct.sql.out
+++ b/sql/core/src/test/resources/sql-tests/results/struct.sql.out
@@ -85,3 +85,27 @@ struct<ID:int,struct(ST.C AS STC, ST.D AS STD).STD:string>
 1	delta
 2	eta
 3	iota
+
+
+-- !query
+SELECT STRUCT(1 AS a) AS b, b AS c
+-- !query schema
+struct<b:struct<a:int>,c:struct<a:int>>
+-- !query output
+{"a":1}	{"a":1}
+
+
+-- !query
+SELECT STRUCT(1 AS a) AS b, b AS c GROUP BY b
+-- !query schema
+struct<b:struct<a:int>,c:struct<a:int>>
+-- !query output
+{"a":1}	{"a":1}
+
+
+-- !query
+SELECT MAX(STRUCT(1 AS a)), 2 AS b, b AS c GROUP BY b
+-- !query schema
+struct<max(struct(1 AS a)):struct<a:int>,b:int,c:int>
+-- !query output
+{"a":1}	2	2
