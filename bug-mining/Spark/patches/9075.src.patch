diff --git a/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/analysis/DeduplicateRelations.scala b/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/analysis/DeduplicateRelations.scala
index 9837fcd29ec..1b43922de27 100644
--- a/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/analysis/DeduplicateRelations.scala
+++ b/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/analysis/DeduplicateRelations.scala
@@ -308,8 +308,14 @@ object DeduplicateRelations extends Rule[LogicalPlan] {
   }
 
   private def newAliases(expressions: Seq[NamedExpression]): Seq[NamedExpression] = {
+    // SPARK-43030: It's important to avoid creating new aliases for duplicate aliases
+    // in the original project list, to avoid assertion failures when rewriting attributes
+    // in transformUpWithNewOutput.
+    val oldAliasToNewAlias = AttributeMap(expressions.collect {
+      case a: Alias => (a.toAttribute, Alias(a.child, a.name)())
+    })
     expressions.map {
-      case a: Alias => Alias(a.child, a.name)()
+      case a: Alias => oldAliasToNewAlias(a.toAttribute)
       case other => other
     }
   }
diff --git a/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/plans/QueryPlan.scala b/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/plans/QueryPlan.scala
index 2b6867b0ff9..59ce4e85580 100644
--- a/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/plans/QueryPlan.scala
+++ b/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/plans/QueryPlan.scala
@@ -322,7 +322,7 @@ abstract class QueryPlan[PlanType <: QueryPlan[PlanType]]
             if (attrMappingForCurrentPlan.nonEmpty) {
               assert(!attrMappingForCurrentPlan.groupBy(_._1.exprId)
                 .exists(_._2.map(_._2.exprId).distinct.length > 1),
-                "Found duplicate rewrite attributes")
+                s"Found duplicate rewrite attributes.\n$plan")
 
               val attributeRewrites = AttributeMap(attrMappingForCurrentPlan)
               // Using attrMapping from the children plans to rewrite their parent node.
diff --git a/sql/catalyst/src/test/scala/org/apache/spark/sql/catalyst/analysis/AnalysisSuite.scala b/sql/catalyst/src/test/scala/org/apache/spark/sql/catalyst/analysis/AnalysisSuite.scala
index e1050e91e59..105753ab3d1 100644
--- a/sql/catalyst/src/test/scala/org/apache/spark/sql/catalyst/analysis/AnalysisSuite.scala
+++ b/sql/catalyst/src/test/scala/org/apache/spark/sql/catalyst/analysis/AnalysisSuite.scala
@@ -1511,6 +1511,14 @@ class AnalysisSuite extends AnalysisTest with Matchers {
       assert(refs.map(_.output).distinct.length == 2)
     }
 
+    withClue("CTE relation has duplicate aliases") {
+      val alias = Alias($"a", "x")()
+      val cteDef = CTERelationDef(testRelation.select(alias, alias).where($"x" === 1))
+      val cteRef = CTERelationRef(cteDef.id, false, Nil)
+      // Should not fail with the assertion failure: Found duplicate rewrite attributes.
+      WithCTE(cteRef.join(cteRef), Seq(cteDef)).analyze
+    }
+
     withClue("references in both CTE relation definition and main query") {
       val cteDef2 = CTERelationDef(cteRef.where($"a" > 2))
       val cteRef2 = CTERelationRef(cteDef2.id, false, Nil)
@@ -1553,4 +1561,31 @@ class AnalysisSuite extends AnalysisTest with Matchers {
     val rel = LocalRelation(attr)
     checkAnalysis(rel.select($"a"), rel.select(attr.markAsAllowAnyAccess()))
   }
+
+  test("SPARK-43030: deduplicate relations with duplicate aliases") {
+    // Should not fail with the assertion failure: Found duplicate rewrite attributes.
+    val alias = Alias($"a", "x")()
+
+    withClue("project") {
+      val plan = testRelation.select(alias, alias).where($"x" === 1)
+      plan.join(plan).analyze
+    }
+
+    withClue("aggregate") {
+      val plan = testRelation.groupBy($"a")(alias, alias).where($"x" === 1)
+      plan.join(plan).analyze
+    }
+
+    withClue("window") {
+      val frame = SpecifiedWindowFrame(RowFrame, UnboundedPreceding, UnboundedFollowing)
+      val spec = windowSpec(Seq($"c"), Seq(), frame)
+      val plan = testRelation2
+        .window(
+          Seq(alias, alias, windowExpr(min($"b"), spec).as("min_b")),
+          Seq($"c"),
+          Seq())
+        .where($"x" === 1)
+      plan.join(plan).analyze
+    }
+  }
 }
