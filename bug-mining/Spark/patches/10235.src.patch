diff --git a/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/analysis/ResolveLateralColumnAliasReference.scala b/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/analysis/ResolveLateralColumnAliasReference.scala
index 0b529f209e7..042e4483a37 100644
--- a/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/analysis/ResolveLateralColumnAliasReference.scala
+++ b/sql/catalyst/src/main/scala/org/apache/spark/sql/catalyst/analysis/ResolveLateralColumnAliasReference.scala
@@ -229,7 +229,9 @@ object ResolveLateralColumnAliasReference extends Rule[LogicalPlan] with AliasHe
             case e => e.children.forall(eligibleToLiftUp)
           }
         }
-        if (!aggregateExpressions.forall(eligibleToLiftUp)) {
+        val aggregateExpressionsWithTrimmedAliases =
+          aggregateExpressions.map(trimNonTopLevelAliases)
+        if (!aggregateExpressionsWithTrimmedAliases.forall(eligibleToLiftUp)) {
           agg
         } else {
           val newAggExprs = new LinkedHashSet[NamedExpression]
@@ -268,9 +270,8 @@ object ResolveLateralColumnAliasReference extends Rule[LogicalPlan] with AliasHe
               case e => e.mapChildren(extractExpressions)
             }
           }
-          val projectExprs = aggregateExpressions.map(
-            expression =>
-              extractExpressions(trimNonTopLevelAliases(expression)).asInstanceOf[NamedExpression]
+          val projectExprs = aggregateExpressionsWithTrimmedAliases.map(
+            extractExpressions(_).asInstanceOf[NamedExpression]
           )
           val newProject = Project(
             projectList = projectExprs,
diff --git a/sql/core/src/test/resources/sql-tests/analyzer-results/struct.sql.out b/sql/core/src/test/resources/sql-tests/analyzer-results/struct.sql.out
index 1e55d50ba55..25bff29fc01 100644
--- a/sql/core/src/test/resources/sql-tests/analyzer-results/struct.sql.out
+++ b/sql/core/src/test/resources/sql-tests/analyzer-results/struct.sql.out
@@ -103,6 +103,14 @@ Project [b#x, b#x AS c#x]
    +- OneRowRelation
 
 
+-- !query
+SELECT STRUCT(col1 AS a) AS b, b AS c FROM VALUES(1)
+-- !query analysis
+Project [b#x, b#x AS c#x]
++- Project [col1#x, struct(a, col1#x) AS b#x]
+   +- LocalRelation [col1#x]
+
+
 -- !query
 SELECT STRUCT(1 AS a) AS b, b AS c GROUP BY b
 -- !query analysis
@@ -112,6 +120,15 @@ Project [b#x, b#x AS c#x]
       +- OneRowRelation
 
 
+-- !query
+SELECT STRUCT(col1 AS a) AS b, b AS c FROM VALUES(1) GROUP BY b
+-- !query analysis
+Project [b#x, b#x AS c#x]
++- Project [struct(col1)#x, struct(col1)#x AS b#x]
+   +- Aggregate [struct(a, col1#x)], [struct(a, col1#x) AS struct(col1)#x]
+      +- LocalRelation [col1#x]
+
+
 -- !query
 SELECT MAX(STRUCT(1 AS a)), 2 AS b, b AS c GROUP BY b
 -- !query analysis
diff --git a/sql/core/src/test/resources/sql-tests/inputs/struct.sql b/sql/core/src/test/resources/sql-tests/inputs/struct.sql
index cb75b2967dd..3d45db5669f 100644
--- a/sql/core/src/test/resources/sql-tests/inputs/struct.sql
+++ b/sql/core/src/test/resources/sql-tests/inputs/struct.sql
@@ -28,5 +28,7 @@ SELECT ID, STRUCT(ST.C as STC, ST.D as STD).STD FROM tbl_x;
 
 -- LCAs with struct columns
 SELECT STRUCT(1 AS a) AS b, b AS c;
+SELECT STRUCT(col1 AS a) AS b, b AS c FROM VALUES(1);
 SELECT STRUCT(1 AS a) AS b, b AS c GROUP BY b;
+SELECT STRUCT(col1 AS a) AS b, b AS c FROM VALUES(1) GROUP BY b;
 SELECT MAX(STRUCT(1 AS a)), 2 AS b, b AS c GROUP BY b;
diff --git a/sql/core/src/test/resources/sql-tests/results/struct.sql.out b/sql/core/src/test/resources/sql-tests/results/struct.sql.out
index fb8f0427e95..1fdb8ebaac6 100644
--- a/sql/core/src/test/resources/sql-tests/results/struct.sql.out
+++ b/sql/core/src/test/resources/sql-tests/results/struct.sql.out
@@ -95,6 +95,14 @@ struct<b:struct<a:int>,c:struct<a:int>>
 {"a":1}	{"a":1}
 
 
+-- !query
+SELECT STRUCT(col1 AS a) AS b, b AS c FROM VALUES(1)
+-- !query schema
+struct<b:struct<a:int>,c:struct<a:int>>
+-- !query output
+{"a":1}	{"a":1}
+
+
 -- !query
 SELECT STRUCT(1 AS a) AS b, b AS c GROUP BY b
 -- !query schema
@@ -103,6 +111,14 @@ struct<b:struct<a:int>,c:struct<a:int>>
 {"a":1}	{"a":1}
 
 
+-- !query
+SELECT STRUCT(col1 AS a) AS b, b AS c FROM VALUES(1) GROUP BY b
+-- !query schema
+struct<b:struct<a:int>,c:struct<a:int>>
+-- !query output
+{"a":1}	{"a":1}
+
+
 -- !query
 SELECT MAX(STRUCT(1 AS a)), 2 AS b, b AS c GROUP BY b
 -- !query schema
