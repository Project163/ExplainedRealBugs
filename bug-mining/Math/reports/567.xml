<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:24:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[MATH-1269] FastMath.exp may return NaN for non-NaN arguments</title>
                <link>https://issues.apache.org/jira/browse/MATH-1269</link>
                <project id="12310485" key="MATH">Commons Math</project>
                    <description>&lt;p&gt;I have observed that FastMath.exp(709.8125) returns NaN. However, the exponential function must never return NaN (if the argument is not NaN). The result must always be non-negative or positive infinity.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12862092">MATH-1269</key>
            <summary>FastMath.exp may return NaN for non-NaN arguments</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="Otmar Ertl">Otmar Ertl</reporter>
                        <labels>
                    </labels>
                <created>Sun, 6 Sep 2015 11:49:24 +0000</created>
                <updated>Mon, 25 Jan 2016 20:27:55 +0000</updated>
                            <resolved>Thu, 5 Nov 2015 20:30:04 +0000</resolved>
                                    <version>4.0</version>
                                    <fixVersion>4.0</fixVersion>
                    <fixVersion>3.6</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14736682" author="erans" created="Wed, 9 Sep 2015 11:21:42 +0000"  >&lt;p&gt;Any objection to the attached trivial patch?&lt;/p&gt;</comment>
                            <comment id="14737181" author="otmar ertl" created="Wed, 9 Sep 2015 16:52:10 +0000"  >&lt;p&gt;I have an objection. The patch changes the result of FastMath.exp(709.0001) from 8.219229343394329E307 to Double.POSITIVE_INFINITY. Although this kind of error is less harmful than that caused by the bug, I would prefer a more rigorous solution.&lt;/p&gt;</comment>
                            <comment id="14737356" author="sebb@apache.org" created="Wed, 9 Sep 2015 18:26:20 +0000"  >&lt;p&gt;I agree that the solution could be improved, as it artificially restricts the range of possible values.&lt;/p&gt;

&lt;p&gt;If the result of the calculation is NaN (and the input was not NaN) can&apos;t you just change the NaN to Infinity?&lt;/p&gt;</comment>
                            <comment id="14737436" author="otmar ertl" created="Wed, 9 Sep 2015 19:22:21 +0000"  >&lt;p&gt;In my opinion simply changing NaNs to infinity can only be a short-term solution. Such a transformation at the end of this function is like admitting that we do not really know how our code works. This is not acceptable for such an essential function as the exponential function.&lt;/p&gt;</comment>
                            <comment id="14737796" author="sebb@apache.org" created="Wed, 9 Sep 2015 23:27:03 +0000"  >&lt;p&gt;It looks like the problem is that the function works fine up to the maximum that can be represented in a double.&lt;/p&gt;

&lt;p&gt;It agrees with j.l.Math up to 709.782712893384 (0x1.62e42fefa39efp9) and for many numbers after that point it shows Infinity also in agreement with j.l.Math.&lt;br/&gt;
However eventually it starts returning NaN instead of Infinity, whereas j.l.Math continues to return Infinity.&lt;/p&gt;

&lt;p&gt;I think there are a couple of options here:&lt;br/&gt;
1) choose a number between 709 and 710 which is correctly calculated in the Infinite range and use that as the max&lt;br/&gt;
2) convert NaN to Infinity as appropriate.&lt;/p&gt;

&lt;p&gt;In either case it would be a good idea to add a test to show that Math and FastMath agree for doubles which are around the max value that can be calculated. Ditto for expm1().&lt;/p&gt;</comment>
                            <comment id="14737879" author="erans" created="Thu, 10 Sep 2015 00:30:26 +0000"  >&lt;p&gt;Why &lt;em&gt;choose&lt;/em&gt; a number?&lt;br/&gt;
Didn&apos;t you determine it precisely above?&lt;/p&gt;

&lt;p&gt;Isn&apos;t just a matter of changing the test from&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (intVal &amp;gt; 709)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (x &amp;gt; 709.782712893384)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;?&lt;/p&gt;</comment>
                            <comment id="14737891" author="sebb@apache.org" created="Thu, 10 Sep 2015 00:38:02 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Didn&amp;#39;t you just choose a number above? ...&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;But yes, one possible code fix is as you suggest, along with a unit test to show that the number has been properly determined.&lt;/p&gt;</comment>
                            <comment id="14738172" author="qualtagh" created="Thu, 10 Sep 2015 05:00:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/commons-math/pull/14&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-math/pull/14&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    If (intVal &amp;gt; 709 || intVal == 709 &amp;amp;&amp;amp; x &amp;gt;= 709.782712893384)&lt;/p&gt;

&lt;p&gt;I had the same thoughts)).&lt;br/&gt;
Test included.&lt;/p&gt;</comment>
                            <comment id="14738393" author="sebb@apache.org" created="Thu, 10 Sep 2015 08:27:23 +0000"  >&lt;p&gt;Thanks. &lt;br/&gt;
However I&apos;m not sure it is necessary to check intVal at all - why not just check x?&lt;/p&gt;</comment>
                            <comment id="14738475" author="sebb@apache.org" created="Thu, 10 Sep 2015 09:23:01 +0000"  >&lt;p&gt;One should be able to use &lt;tt&gt;if (x &amp;gt; Math.log(Double.MAX_VALUE))&lt;/tt&gt;&lt;br/&gt;
(Of course the value should be a static constant)&lt;/p&gt;</comment>
                            <comment id="14738520" author="sebb@apache.org" created="Thu, 10 Sep 2015 09:54:05 +0000"  >&lt;p&gt;Suggested fix - there was already a private constant with the correct value in the FastMath class&lt;/p&gt;</comment>
                            <comment id="14739384" author="otmar ertl" created="Thu, 10 Sep 2015 19:06:29 +0000"  >&lt;p&gt;+1 for 2nd patch, I have run the test over the range (MAX_LONG - 100000000, MAX_LONG + 100000000), I think that should be enough to assume that there is a clean transition from finite to infinite.&lt;/p&gt;</comment>
                            <comment id="14969913" author="tn" created="Thu, 22 Oct 2015 21:21:28 +0000"  >&lt;p&gt;I propose another patch for this issue.&lt;br/&gt;
The polynomial expansion for z = exp(epsilon) - 1.0 is actually returning wrong results in case epsilon = 0.&lt;/p&gt;

&lt;p&gt;The patch handles this case and further fixes the calculation of (1+z)(tempA+tempB) in this case (as z is 0, we only have to add tempA and tempB).&lt;/p&gt;

&lt;p&gt;This would fix your case and other potential cases in the range &lt;span class=&quot;error&quot;&gt;&amp;#91;0, 709&amp;#93;&lt;/span&gt; for which the epsilon is also 0.&lt;/p&gt;</comment>
                            <comment id="14971687" author="otmar ertl" created="Fri, 23 Oct 2015 19:34:27 +0000"  >&lt;p&gt;One more proposal. The problem is the calculation of (1+z)(tempA+tempB) if tempA is infinite. In this case tempC is also infinite. If z &amp;lt; 0 at the same time we get NaN for tempC*z + tempB + tempA. The proposed patch returns infinity for the case tempC is positive infinite. In all other cases tempC*z cannot be negative infinite and the evaluation of tempC*z + tempB + tempA is not a problem even if tempA or tempB are positive infinite.&lt;/p&gt;</comment>
                            <comment id="14990510" author="tn" created="Wed, 4 Nov 2015 21:51:40 +0000"  >&lt;p&gt;your latest patch should be more performant for the same result, thus I would be in favor to apply it.&lt;/p&gt;</comment>
                            <comment id="14992406" author="otmar ertl" created="Thu, 5 Nov 2015 20:29:41 +0000"  >&lt;p&gt;fixed&lt;br/&gt;
3.6: 8aecb842d32464a98eaab722da84902f8126957b&lt;br/&gt;
4.0: a94ff90ab6cd2d92ccb2eb1fd7913b4e5256f02b&lt;/p&gt;</comment>
                            <comment id="15115943" author="luc" created="Mon, 25 Jan 2016 20:27:55 +0000"  >&lt;p&gt;Closing all resolved issues that were included in 3.6 release.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12768389" name="MATH-1269-fix-tempC-infinity.patch" size="720" author="Otmar Ertl" created="Fri, 23 Oct 2015 19:34:27 +0000"/>
                            <attachment id="12755095" name="MATH-1269.patch" size="2792" author="sebb" created="Thu, 10 Sep 2015 09:54:05 +0000"/>
                            <attachment id="12754885" name="MATH-1269.patch" size="1389" author="erans" created="Wed, 9 Sep 2015 11:21:42 +0000"/>
                            <attachment id="12768140" name="MATH-1269_fix_z.patch" size="2672" author="tn" created="Thu, 22 Oct 2015 21:21:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 42 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ju1r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>