<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:24:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[MATH-984] Incorrect (bugged) generating function getNextValue() in .random.EmpiricalDistribution</title>
                <link>https://issues.apache.org/jira/browse/MATH-984</link>
                <project id="12310485" key="MATH">Commons Math</project>
                    <description>&lt;p&gt;The generating function getNextValue() in org.apache.commons.math3.random.EmpiricalDistribution&lt;br/&gt;
will generate wrong values for all Distributions that are single tailed or limited. For example Data which are resembling Exponential or Lognormal distributions.&lt;/p&gt;

&lt;p&gt;The problem could be easily seen in code and tested.&lt;/p&gt;

&lt;p&gt;In last version code&lt;br/&gt;
...&lt;br/&gt;
490               return getKernel(stats).sample();&lt;br/&gt;
...&lt;br/&gt;
it samples from Gaussian distribution to &quot;smooth&quot; in_the_bin. Obviously Gaussian Distribution is not limited and sometimes it does generates numbers outside the bin. In the case when it is the last bin it will generate wrong numbers. &lt;/p&gt;

&lt;p&gt;For example for empirical non-negative data it will generate negative rubbish.&lt;/p&gt;

&lt;p&gt;  Additionally the proposed algorithm boldly returns only the mean value of the bin in case of one value! This last makes the generating function unusable for heavy tailed distributions with small number of values. (for example computer network traffic)&lt;/p&gt;

&lt;p&gt;On the last place usage of Gaussian soothing in the bin will change greatly some empirical distribution properties.&lt;/p&gt;

&lt;p&gt;The proposed method should be reworked to be applicable for real data which have often limited ranges. (either non-negative or both sides limited)&lt;/p&gt;

</description>
                <environment>&lt;p&gt;all&lt;/p&gt;</environment>
        <key id="12649629">MATH-984</key>
            <summary>Incorrect (bugged) generating function getNextValue() in .random.EmpiricalDistribution</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="psteitz">Phil Steitz</assignee>
                                    <reporter username="rtsvet">Radoslav Tsvetkov</reporter>
                        <labels>
                    </labels>
                <created>Tue, 28 May 2013 07:12:21 +0000</created>
                <updated>Fri, 26 Dec 2014 19:50:39 +0000</updated>
                            <resolved>Sun, 22 Jun 2014 18:55:22 +0000</resolved>
                                    <version>3.2</version>
                    <version>3.1.1</version>
                                    <fixVersion>3.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13668469" author="psteitz" created="Tue, 28 May 2013 17:29:11 +0000"  >&lt;p&gt;Ack on the first issue (deviates should be constrained to come from the target bin).  Thanks for raising this issue.  A workaround available since version 3.2 is to provide a custom kernel by subclassing and overriding EmpiricalDistribution&apos;s getKernel method.  Patches are welcome to fix the issue with the current code.  The private method, kB, can be used to get the mass of a bin under its kernel.  In 4.0, we may want to consider a more direct way to plug in an alternative kernel.&lt;/p&gt;

&lt;p&gt;Sorry if I am being dense, but I don&apos;t understand the second issue.  If there is no variation among values in a bin, returning their common value makes sense to me.&lt;/p&gt;</comment>
                            <comment id="13669059" author="rtsvet" created="Wed, 29 May 2013 07:22:43 +0000"  >&lt;p&gt;For the second issue:&lt;br/&gt;
Consider long tailed distribution as shown on &lt;a href=&quot;http://en.wikipedia.org/wiki/Long_tail&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://en.wikipedia.org/wiki/Long_tail&lt;/a&gt;  (In case of network traffic. The biggest 90% data volume comes comes from less then 10% of connections.) &lt;br/&gt;
In this case we have extremely wide spread _&lt;em&gt;important&lt;/em&gt;_ values with only __&lt;em&gt;single&lt;/em&gt; occurrences.&lt;br/&gt;
If we want to generate similar variable (for ex. larger sample) we&apos;ll get fixed values for all this bins in the long tail.&lt;br/&gt;
It signifies 10% of generated values will be _&lt;em&gt;fixed&lt;/em&gt; values - their respective bin means!&lt;/p&gt;


&lt;p&gt;Last Issue: I would question usage of Gaussian Kernel at all. Without having a mathematical prove, I nevertheless suppose it could disturb parameters of generation if we have non Gaussian empirical data. (for ex. Pareto, Tweedie, ..)&lt;/p&gt;

&lt;p&gt;Why we don&apos;t stick with triangular or uniform distribution as default for Kernel within the bean?&lt;/p&gt;</comment>
                            <comment id="13669588" author="psteitz" created="Wed, 29 May 2013 19:11:58 +0000"  >&lt;p&gt;Thanks, I get the second problem now.  To really address that issue, I think we would need to depart from the current simple equal-sized bins model.  I have thought before about either introducing a new class or a config option for EmpiricalDistribution that supported alternative binning structures, such as:&lt;/p&gt;

&lt;p&gt;1. equiprobable bins (so bin size is not constant)&lt;br/&gt;
2. variable bin sizes (break the total range into subranges, allow a number of fixed-size bins to be specified for each range, so grid could become very fine in densely packed subranges).&lt;/p&gt;

&lt;p&gt;Regarding the default kernel choice, in the absence of any information about the within-bin distributions, I would expect the (correctly truncated) Gaussian smoother to perform better than uniform or triangular. I don&apos;t have a proof of this statement either; but I will see if I can hunt down some references, starting with &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, referenced in the class javadoc as what the current implementation is based on.  &lt;/p&gt;

&lt;p&gt;As &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; states, heavy tails create problems for this approach and in some cases an alternative to the Gaussian kernel may work better.  This could actually be tested on a case basis by comparing probabilities computed using the Distribution methods now implemented in the class with &quot;true&quot; empirical probabilities from the raw data.  Some experiments doing this with different kernels and data would be interesting to look at.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://ned.ipac.caltech.edu/level5/March02/Silverman/Silver2_4.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://ned.ipac.caltech.edu/level5/March02/Silverman/Silver2_4.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13671377" author="rtsvet" created="Fri, 31 May 2013 11:59:57 +0000"  >&lt;p&gt;Simplest way would be to use  inverse CDF (quantile funct) with some uniformly distributed input. But unfortunately seems it&apos;s also having Kernel calculations problems. &lt;br/&gt;
I&apos;m getting NotStrictlyPositiveException from EmpiricalDistribution.getKernel l(EmpiricalDistribution.java:846) )&lt;/p&gt;


&lt;p&gt;I thought of looking in what algorithms R is using. &lt;br/&gt;
&lt;a href=&quot;http://en.wikibooks.org/wiki/R_Programming/Random_Number_Generation&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://en.wikibooks.org/wiki/R_Programming/Random_Number_Generation&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13671773" author="psteitz" created="Fri, 31 May 2013 19:43:29 +0000"  >&lt;p&gt;That should work.  Looks like you have hit a new bug, which should be opened as a separate issue if you don&apos;t mind doing that.  What I suspect is going on is that your data has singleton bins, which results in zero variance within bin.  The getKernel method tries to create a NormalDistribution instance using the bin stats.  This throws NotStrictlyPositiveException if the standard deviation parameter is not strictly positive.  This is part of the reason that the singleton check is there in getNextValue.  I forgot to account for this case in inverseCumulativeProbability (added in 3.2).  A unit test demonstrating the bug would be most appreciated.&lt;/p&gt;

&lt;p&gt;I think it would probably be a little more efficient though to keep the direct implementation of getNextValue as it is now, but just fix the bug.&lt;/p&gt;</comment>
                            <comment id="13671779" author="psteitz" created="Fri, 31 May 2013 19:49:58 +0000"  >&lt;p&gt;One more comment on getNextValue implementation.  If we want to just do straight inversion-based sampling, that is available for free from the superclass, AbstractRealDistribution.  To use that, we would just need to reverse the roles of sample() and getNextValue - i.e., have getNextValue call sample() and drop the override of sample() in EmpiricalDistribution.&lt;/p&gt;</comment>
                            <comment id="13672859" author="rtsvet" created="Mon, 3 Jun 2013 06:54:07 +0000"  >&lt;p&gt;To generate some Exception on attempt to calculate St.Dev. from single observation is correct. It&#8217;s just that the &lt;em&gt;Exception Text&lt;/em&gt; generated by getKernel() is not clearly pointing the cause. An average user should dig and search to get to to the &quot;real&quot; cause. But as getKernel() should deliver the &quot;kernel&quot; and not proliferate his chosen internal method restrictions outside, better would be &lt;em&gt;for single observation&lt;/em&gt; to deliver uniformly distributed value. (and perhaps warning).&lt;/p&gt;

&lt;p&gt;generate() within EmpiricalDistribution could be &quot;fixed&quot; easily if it uses truncated Gaussian on the end bins. &lt;/p&gt;

&lt;p&gt;&lt;b&gt;So would propose 2 code changes:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;1. Add generate(double min, double max) function. Where &lt;b&gt;min&lt;/b&gt; and &lt;b&gt;max&lt;/b&gt; should indicate the hard limits of generation. They should be checked if the conform to input data. It means &lt;b&gt;min&lt;/b&gt; should not be greater than the minimal empirically observed value, and &lt;b&gt;max&lt;/b&gt; should be no less then the biggest empirical value. Then the new generate function should use truncated Gaussian on the edges. (open if one implements it through additional getKernel(limits.. ) function )&lt;/p&gt;

&lt;p&gt;2. Change getKernel() to deliver uniformly distributed value on single observation. (and perhaps warning)&lt;/p&gt;


&lt;p&gt;The first change does not touch old code. So, it&apos;s a practically no risk and we retain 100% code compatibility.&lt;br/&gt;
The second change is also low risk and is compatible with old code.&lt;/p&gt;

&lt;p&gt;As a result we have smooth and correct generation and positively fixed  inverse CDF.&lt;/p&gt;</comment>
                            <comment id="13674430" author="psteitz" created="Tue, 4 Jun 2013 14:14:58 +0000"  >&lt;p&gt;Thanks, Radoslav.  I agree with your point 2 and after looking at the code some more, I am going to retract my comment above about direct implementation of getNextValue being more efficient.  I think the simplest and best fix for both of these problems is to fix getKernel to return a uniform distribution on one value for singleton bins, drop the implementation of sample() and have getNextValue delegate to the parent&apos;s (inversion-based) sample() implementation.  The probability methods basically truncate the bin kernels now.  The problem is in the direct implementation of sampling.&lt;/p&gt;</comment>
                            <comment id="13906790" author="luc" created="Thu, 20 Feb 2014 09:20:09 +0000"  >&lt;p&gt;Are there any progress on this issue?&lt;/p&gt;</comment>
                            <comment id="13907010" author="psteitz" created="Thu, 20 Feb 2014 14:44:15 +0000"  >&lt;p&gt;Yes, I am working on it.  Thanks for the nudge.&lt;/p&gt;</comment>
                            <comment id="14040212" author="psteitz" created="Sun, 22 Jun 2014 18:55:22 +0000"  >&lt;p&gt;Fixed in r1604639.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>329956</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 21 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1kxbz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>330291</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>