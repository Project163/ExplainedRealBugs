<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:25:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[MATH-1405] Kolmogorov-Smirnov fixTies can set minDelta too small for jiggler to have significant effect</title>
                <link>https://issues.apache.org/jira/browse/MATH-1405</link>
                <project id="12310485" key="MATH">Commons Math</project>
                    <description>&lt;p&gt;For samples that do not exceed LARGE_SAMPLE_PRODUCT with their product and relatively large values, a minDelta can be calculated in fixTies() that is too small to have any effect on the &quot;tied&quot; values. This results in a MathInternalError, as the jiggling with the ineffective minDelta fails to fix the ties.&lt;/p&gt;

&lt;p&gt;The following arrays exhibit this behavior when run with kolmogorovSmirnovTest(x, y) in 3.6.1&lt;/p&gt;

&lt;p&gt;x = &lt;span class=&quot;error&quot;&gt;&amp;#91;1.3750969645841487, 1.0845460746754014, 1.3693352427126644, 1.329688765445783, 1.3392109491039106, 1.3532766470312723, 1.3187287426697727, 1.386273031970554, 1.3416950149276097, 1.0510872606482404, 1.3532766470312723, 1.3075923871137798, 1.3862730319705543, 1.3814421433922548, 1.0527927570919202, 1.3847314864464313, 1.319362658529506, 1.3579238253227275, 1.2455452272301641, 1.329688765445783, 1.3827781646781876, 1.0755168081687903, 1.2566273460024566, 1.3099622795250825, 1.357440924560318, 1.3519397370266515, 1.0927347979524134, 1.3566357346921618, 1.238800036669969, 1.2931730628634528, 1.048463407884969, 1.3779471642491719, 1.2978533797116658, 1.376230881554943, 1.166901202345226, 1.3690425182006263, 1.166901202345226, 1.2953476417603207, 1.0827945761165951, 1.2942406680885112, 1.224414840377028, 1.3910905417259205, 1.303231085263425, 1.348635183816037, 1.3750969645841487, 1.049648651501274, 1.3119534979602083, 1.0446033225080773, 1.0494686631294756, 1.3862026705844126, 1.2719496963348844, 1.3489938748102903, 1.3780468374004164, 1.3884878389662338, 1.3352682241994538, 1.3348722240568909, 1.3921944407986777, 1.0476833161122294, 1.0845460746754008, 1.344165352323966, 1.298548179079665, 1.1979240079667628, 1.3539078973394736, 1.3187287426697725, 1.082794576116595, 1.3779471642491719, 1.3771347858434184, 1.3921944407986777, 1.193793081523992, 1.362050393265006, 1.076638744462226, 1.3551174562135766, 1.3393693468578751, 1.2470361076952952, 1.3696023478216113, 1.3750969645841487, 1.2964734722088322, 1.2953476417603207, 1.2470361076952952, 1.382661263313539, 1.3862026705844126, 1.3771240109822156, 1.25443884328785, 1.3136690818105938, 1.3853832858443051, 1.3486351838160378, 1.348026557887345, 1.0604869883721861, 1.3352682241994536, 1.3480480718535308, 1.3363233390543028, 1.154658436584056, 1.3921944407986775, 1.1979240079667626, 1.3620503932650059, 1.0881358731694244, 1.369042518200626, 1.3532766470312723, 1.2890012831575908, 1.3735565244300663&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;and&lt;/p&gt;

&lt;p&gt;y = &lt;span class=&quot;error&quot;&gt;&amp;#91;1.1262991662205104, 1.3136690818105938, 1.0446033225080773, 1.3551174562135764, 1.3032310852634252, 1.3806258468851462, 1.2270612333345983, 1.2719496963348844, 1.3601566259413194, 1.3756888280688913, 1.3475322202511097, 1.1937930815239919, 1.0510872606482404, 1.3441653523239654, 1.359738761905118, 1.3382152957887032, 1.0766387444622263, 1.1937930815239919, 1.0820779503060238, 1.1448104521200428, 1.3853832858443051, 1.28757746537949, 1.298548179079665, 1.067255392172351, 1.3168701741293156, 1.3910905417259205, 1.2908594990421354, 1.3750969645841487, 1.329688765445783, 1.386649365275275, 1.285486511663053, 1.2566273460024566, 1.323664826995234, 1.3862730319705538, 1.049346328049449&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;which produce minDelta = 1.11022302462516E-016&lt;/p&gt;</description>
                <environment></environment>
        <key id="13047102">MATH-1405</key>
            <summary>Kolmogorov-Smirnov fixTies can set minDelta too small for jiggler to have significant effect</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="dfinkel">Daniil Finkel</reporter>
                        <labels>
                    </labels>
                <created>Tue, 28 Feb 2017 21:38:30 +0000</created>
                <updated>Sun, 19 Mar 2017 17:53:29 +0000</updated>
                            <resolved>Sun, 19 Mar 2017 17:53:29 +0000</resolved>
                                    <version>3.6.1</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15888931" author="dfinkel" created="Tue, 28 Feb 2017 21:55:37 +0000"  >&lt;p&gt;A temporary solution I&apos;ve found is, in fixTies(), pulling the RealDistribution Object creation inside the do-while loop, and doubling the minDelta with every iteration until it&apos;s large enough:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; {
            LOGGER.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;using minDelta: {}&quot;&lt;/span&gt;, minDelta);
            &lt;span class=&quot;code-comment&quot;&gt;// Add jitter using a fixed seed (so same arguments always give same results),
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// low-initialization-overhead generator
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; RealDistribution dist = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UniformRealDistribution(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JDKRandomGenerator(100), -minDelta, minDelta);

            jitter(x, dist);
            jitter(y, dist);
            ties = hasTies(x, y);
            ct++;
            minDelta *= 2;
        } &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (ties &amp;amp;&amp;amp; ct &amp;lt; 1000);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15889124" author="erans" created="Tue, 28 Feb 2017 23:39:06 +0000"  >&lt;p&gt;Thanks a lot for the report.&lt;/p&gt;

&lt;p&gt;Could you create patches against the &quot;master&quot; branch? I.e.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;set up the example as a Junit test case (and check that it fails with the development version of the library),&lt;/li&gt;
	&lt;li&gt;insert your proposed fix (see below)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;By &quot;temporary solution&quot;, do you mean that there could be problem in adopting it?&lt;/p&gt;

&lt;p&gt;I&apos;d suggest to instantiate the RNG outside the loop, as follows (see &lt;a href=&quot;http://commons.apache.org/rng&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://commons.apache.org/rng&lt;/a&gt; and the distribution class in the development version of Commons Math)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.commons.rng.UniformRandomProvider;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.commons.rng.simple.RandomSource;
&lt;span class=&quot;code-comment&quot;&gt;// ...
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; UniformRandomProvider rng = RandomSource.create(RandomSource.TWO_CMRES);
&lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; {
      &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; RealDistribution.Sampler sampler =
          &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; UniformRealDistribution(-minDelta, minDelta).createSampler(rng);
      jitter(x, sampler);
      jitter(y, sampler);
      ties = hasTies(x, y);
      ct++;
      minDelta *= 2;
} &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (ties &amp;amp;&amp;amp; ct &amp;lt; 1000);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Since &lt;tt&gt;jitter&lt;/tt&gt; is private and used for this single purpose, it would probably be better, performance-wise, to modify it to use the RNG directly; its signature would thus become:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void jitter(&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;[] data, UniformRandomProvider rng, &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; delta) {
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; data.length; i++) {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; d = delta * (2 * rng.nextDouble() - 1);
        data[i] += d;
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15890648" author="dfinkel" created="Wed, 1 Mar 2017 17:42:16 +0000"  >&lt;p&gt;By &quot;temporary solution&quot; I only meant it as a workaround until an optimal solution would be introduced in the next release. I&apos;m working on a patch right now. Should have a PR up soon with your proposed solution.&lt;/p&gt;</comment>
                            <comment id="15890973" author="dfinkel" created="Wed, 1 Mar 2017 20:29:13 +0000"  >&lt;p&gt;PR created &lt;a href=&quot;https://github.com/apache/commons-math/pull/55&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-math/pull/55&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15892321" author="erans" created="Thu, 2 Mar 2017 14:26:18 +0000"  >&lt;p&gt;Thanks.&lt;br/&gt;
Changes applied to &quot;master&quot; in commit 98055455265c04cf7f7a354bdc7aeac428730c5d&lt;/p&gt;

&lt;p&gt;However, I believe that this issue cannot be resolved as such.&lt;br/&gt;
Indeed, the bound for the &quot;ct&quot; variable seems much too large (as it implies that the jitter value could grow up to minDelta * 2^1000).&lt;/p&gt;</comment>
                            <comment id="15892343" author="dfinkel" created="Thu, 2 Mar 2017 14:43:25 +0000"  >&lt;p&gt;Fortunately, it is inside of a do-while, so it should exit as soon as the minDelta gets large enough.&lt;br/&gt;
What maximum value of &quot;ct&quot; do you think would be best? 100? I have personally tested data that requires at least 8 loops before a significant minDelta is reached, so I wouldn&apos;t want to make the value too small.&lt;/p&gt;

&lt;p&gt;Also, you wrote &quot;Changes applied to &quot;master&quot; in commit 98055455265c04cf7f7a354bdc7aeac428730c5d&quot; but I&apos;m not sure what that means. Github is telling me &quot;master&quot; hasn&apos;t been updated in 6 days, I couldn&apos;t find the commit you referenced with a search, and the commit I submitted for review is &quot;18f181ada7826542725fa4a9460307d606695b5d&quot;&lt;/p&gt;</comment>
                            <comment id="15892393" author="erans" created="Thu, 2 Mar 2017 15:16:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;Fortunately, it is inside of a do-while, so it should exit as soon as the minDelta gets large enough.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sure, but it looks wrong for the code to hint that 1000 might be necessary.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I have personally tested data that requires at least 8 loops before a significant minDelta is reached, so I wouldn&apos;t want to make the value too small.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sure.&lt;br/&gt;
Could you make up a unit test that requires that many loops?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;you wrote &quot;Changes applied to &quot;master&quot;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, I forgot to &quot;push&quot;! Sorry.&lt;/p&gt;</comment>
                            <comment id="15894712" author="dfinkel" created="Fri, 3 Mar 2017 17:02:44 +0000"  >&lt;p&gt;After further testing I&apos;ve found a few more edge cases and determined the maximum possible value for the max iterations to be 2048, as opposed to 1000, since the exponent can be expressed in 11 bits. Here is a test I created that shows this.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testTwoSampleWithManyTiesAndExtremeValues_ManyAttempts() {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;[] largeX = {
                &lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;.MAX_VALUE, &lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;.MAX_VALUE,
                1e40, 1e40, 2e40, 2e40, 
                1e30, 2e30, 3e30, 4e30,
                5e10, 6e10, 7e10, 8e10};
        
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;[] smallY = {
                &lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;.MIN_VALUE, (2 * &lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;.MIN_VALUE), 
                1e-40, 1e-40, 2e-40, 2e-40,
                1e-30, 2e-30, 3e-30, 4e-30,
                5e-10, 6e-10, 7e-10, 8e-10};
        
        &lt;span class=&quot;code-comment&quot;&gt;// these values result in an initial calculated minDelta of 4.9E-324 (&lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;.MIN_VALUE),
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// but after 2046 iterations, the delta increases to 1.9958403095347198E292
&lt;/span&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; KolmogorovSmirnovTest test = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KolmogorovSmirnovTest();
        Assert.assertEquals(0.63548496, test.kolmogorovSmirnovTest(largeX, smallY), 1e-6);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There is also separate bug that can occur if there are two instances of Double.NaN, which are treated as a tie but can never be resolved through &quot;jiggling&quot; with a minDelta. I would suggest throwing a descriptive Exception if a NaN is passed into the KS test, instead of waiting for the loop to run through its iterations and throw a MathInternalError.&lt;/p&gt;

&lt;p&gt;The last bug I found occurs if there are ties in the data and the minDelta is equal to Double.MIN_VALUE. At line 1154 in fixTies(), we divide the minDelta by 2, which in this case results in a new minDelta of 0... My method of iteratively doubling the minDelta becomes no longer viable. However, this can easily be resolved by adding an extra line right after:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; minDelta = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.max(minDelta, &lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;.MIN_VALUE);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15895324" author="erans" created="Sat, 4 Mar 2017 00:38:30 +0000"  >&lt;blockquote&gt;&lt;p&gt;after 2046 iterations, the delta increases to 1.9958403095347198E292&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;So it looks to me that the code will then produce nonsense (changing the data so that it has nothing to do with the original).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;largeX ... smallY&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Is there any chance that these two sequences come from the same distribution?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Assert.assertEquals(0.63548496, test.kolmogorovSmirnovTest(largeX, smallY), 1e-6);&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Where does the expected value come from?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The last bug I found occurs if there are ties in the data and the minDelta is equal to Double.MIN_VALUE.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed.&lt;br/&gt;
Could you set up a separate unit test for such a case?&lt;/p&gt;</comment>
                            <comment id="15895689" author="erans" created="Sat, 4 Mar 2017 13:58:17 +0000"  >&lt;p&gt;Could you please review the following suggested changes to &lt;tt&gt;hasTies&lt;/tt&gt;, &lt;tt&gt;fixTies&lt;/tt&gt; and &lt;tt&gt;jitter&lt;/tt&gt;?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; hasTies(&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;[] x, &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;[] y) {
   &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;[] values = MathArrays.unique(MathArrays.concatenate(x, y));
   &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (values.length == x.length + y.length) {
       &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;  &lt;span class=&quot;code-comment&quot;&gt;// There are no ties 
&lt;/span&gt;   }

   &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void fixTies(&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;[] x, &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;[] y) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (hasTies(x, y)) {
        &lt;span class=&quot;code-comment&quot;&gt;// Add jitter using a fixed seed (so same arguments always give same results),
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// low-initialization-overhead generator. 
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; UniformRandomProvider rng = RandomSource.create(RandomSource.TWO_CMRES, 7654321);

        &lt;span class=&quot;code-comment&quot;&gt;// It is theoretically possible that jitter does not &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt; ties, so repeat
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// until all ties are gone.  Bound the loop and &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; MIE &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; bound is exceeded.
&lt;/span&gt;        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; ct = 0;
        &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; ties = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; {
            jitter(x, rng, 10);
            jitter(y, rng, 10);
            ties = hasTies(x, y);
            ++ct;
        } &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (ties &amp;amp;&amp;amp; ct &amp;lt; 10);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ties) {
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MathInternalError(); &lt;span class=&quot;code-comment&quot;&gt;// Should never happen.
&lt;/span&gt;        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void jitter(&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;[] data,
                           UniformRandomProvider rng,
                           &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; ulp) {
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; data.length; i++) {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; rand = rng.nextInt(ulp * 2) - ulp;
        data[i] += rand * &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.ulp(data[i]);
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15897414" author="dfinkel" created="Mon, 6 Mar 2017 14:43:47 +0000"  >&lt;p&gt;I like this solution a lot; I didn&apos;t even know a Math.ulp() method existed, but that makes a lot more sense for this use case, and significantly reduces the lines of code.&lt;/p&gt;

&lt;p&gt;What are your thoughts on throwing an exception in the case of two NaNs appearing in the data, as no amount of jittering could resolve that tie, and a MathInternalError wouldn&apos;t be descriptive enough?&lt;/p&gt;

&lt;p&gt;Also, why switch the RandomSource from JDK to TWO_CMRES?&lt;/p&gt;</comment>
                            <comment id="15899360" author="erans" created="Tue, 7 Mar 2017 12:26:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;I like this solution a lot&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Great. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;All proposed changes are now in &quot;master&quot; (commit b0b23c179ac55334f760aa29fce262c73a909268).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Also, why switch the RandomSource from JDK to TWO_CMRES?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;See &lt;a href=&quot;http://commons.apache.org/proper/commons-rng/userguide/rng.html#a4._Performance&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Commons RNG&lt;/a&gt;: &lt;tt&gt;RandomSource.JDK&lt;/tt&gt; is only for reference purpose, but any of the other alternatives is better, performance-wise and/or quality-wise.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 36 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ar5z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>