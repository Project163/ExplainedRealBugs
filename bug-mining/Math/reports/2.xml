<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:20:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[MATH-151] MathUtils.round incorrect result</title>
                <link>https://issues.apache.org/jira/browse/MATH-151</link>
                <project id="12310485" key="MATH">Commons Math</project>
                    <description>&lt;p&gt;MathUtils.round(39.245, 2) results 39.24, however it should be 39.25, with default rounding mode BigDecimal.ROUND_HALF_UP.&lt;/p&gt;

&lt;p&gt;I found that internally MathUtils.round multiplies the given number by 10^scale.&lt;br/&gt;
 39.245 * 100.0 results 3924.49999...5 , and after this the calculation is not correct any more.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Win2K, Sun JDK1.5.0_05 b05&lt;/p&gt;</environment>
        <key id="12343947">MATH-151</key>
            <summary>MathUtils.round incorrect result</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="buzaz">Buza Zolt&#225;n</reporter>
                        <labels>
                    </labels>
                <created>Mon, 5 Jun 2006 22:22:11 +0000</created>
                <updated>Tue, 18 Jul 2023 18:45:41 +0000</updated>
                            <resolved>Tue, 4 Jul 2006 15:19:28 +0000</resolved>
                                    <version>1.1</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12414956" author="psteitz" created="Tue, 6 Jun 2006 20:40:32 +0000"  >&lt;p&gt;Thanks for reporting this bug.  Could be we want to reconsider the changes applied to address &lt;a href=&quot;http://issues.apache.org/jira/browse/MATH-32&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/MATH-32&lt;/a&gt;.  Patches welcome!&lt;/p&gt;</comment>
                            <comment id="12415048" author="luc" created="Wed, 7 Jun 2006 04:11:25 +0000"  >&lt;p&gt;I think this behaviour is normal.&lt;br/&gt;
Despite 39.245 has a finite representation in decimal, this is not true in base 2, it has a infinite number of digits. For the sake of simplicity, here is the representation in base 16 (much more readable than base 2) :&lt;/p&gt;

&lt;p&gt;  0x27.3EB851EB851EB851EB851...&lt;/p&gt;

&lt;p&gt;Note that the pattern EB851 repeats itself ad infinitum, in base 2 it is a 20 bits pattern.&lt;br/&gt;
If this number could be represented in a virtual infinite register, multiplying it by 100.0 (base 10) would be&lt;br/&gt;
multiplying it by 0x64 (base 16) and the result would be 0xF54.8 which is 3924.5 as could be rounded as expected.&lt;/p&gt;

&lt;p&gt;However, primitive doubles are represented in Java using the IEEE754 norm, where the mantissa is 53 bits long, counting an implicit first bit. This implies that in the previous infinite number only the following is represented in IEE754:&lt;/p&gt;

&lt;p&gt;  0x27.3EB851EB851&lt;/p&gt;

&lt;p&gt;hence, when this number is multiplied by 100, we get the result:&lt;/p&gt;

&lt;p&gt;  0xF54.7FFFFFFFFA4 or 3924.49999999999477040546480566263198...&lt;/p&gt;

&lt;p&gt;So the error is exactly 0x0.0000000005C or 92/16^11 which is approximately 5.229e-12.&lt;/p&gt;

&lt;p&gt;The problem comes from the fact the original number cannot be represented exactly (it is not what is sometimes called a &quot;floating-point number&quot; or &quot;normal number&quot;), and in this case the first neglected hexadecimal digit is large (E) which explains the large error (7 wrong bits after the multiplication).&lt;/p&gt;

&lt;p&gt;I would say this is not an issue with commons-math but with IEE754, we cannot do anything about it.&lt;/p&gt;

&lt;p&gt;Note that the same would occur if we could add one pattern by adding 20 bits. In this case, the final number would be 3924.4999999999999999950126700065666 and the error appoximately 4.987e-18 (92/16^16), but still lesser than 3924.5&lt;/p&gt;</comment>
                            <comment id="12415723" author="psteitz" created="Sun, 11 Jun 2006 07:26:25 +0000"  >&lt;p&gt;Thanks for digging into this, Luc.&lt;/p&gt;

&lt;p&gt;I agree that the source of the problem here is in the decimal - binary conversion; but I don&apos;t want to close this as &quot;invalid&quot; or &quot;wontfix&quot; until we have exhausted all practical means to address the problem from the user standpoint.  In other words, I would prefer to find a workaround if that is possible.  &lt;/p&gt;

&lt;p&gt;One possibility is to revert to the implementation in R226479 or earlier.  See &lt;a href=&quot;http://svn.apache.org/repos/asf/jakarta/commons/proper/math/trunk/src/java/org/apache/commons/math/util/MathUtils.java?revision=226479&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/repos/asf/jakarta/commons/proper/math/trunk/src/java/org/apache/commons/math/util/MathUtils.java?revision=226479&lt;/a&gt; &lt;br/&gt;
where we used BigDecimal rounding.  We changed this partly for efficiency, partly to address &lt;a href=&quot;http://issues.apache.org/jira/browse/MATH-32&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/MATH-32&lt;/a&gt;, which we would have to address in some other way if we go that route.&lt;/p&gt;

&lt;p&gt;Ideas or patches welcome!&lt;/p&gt;</comment>
                            <comment id="12415733" author="luc" created="Sun, 11 Jun 2006 16:04:15 +0000"  >&lt;p&gt;The point is neither on the rounding method not on the scale factor, it is rather on the initial number itself.&lt;br/&gt;
39.245 has no exact representation in IEE754. it lies between two representable numbers (I forgot 4 bits in my previous post):&lt;/p&gt;

&lt;p&gt;      0x139f5c28f5c28f  * 2^-47  &amp;lt; 39.245  &amp;lt;  0x139f5c28f5c290 * 2^-47&lt;br/&gt;
 or 0x27.3eb851eb851e  &amp;lt;  39.245  &amp;lt;  27.3eb851eb8520&lt;br/&gt;
 or 39.2449999999999974420461512636...  &amp;lt;  39.245  &amp;lt;  39.2450000000000045474735088646...&lt;/p&gt;

&lt;p&gt;When we talk about 39.245, we refer to the decimal representation that was parsed either by some data input function using something like Double.parseDouble(String) or we refer to a litteral value in the Java code, which in fact is also parsed at compilation time, probably also by double.parseDouble(String) or a similar function. The virtual machine doesn&apos;t see the 39.245 real number we want, it sees either 0x27.3EB851EB851E  or x27.3EB851EB8520 depending on the parsing behaviour. This is not a Java-related problem, it is also true for languages like C, C++, fortran, whatever.&lt;/p&gt;

&lt;p&gt;In the case discussed here, the value was the low one (i.e. 0x27.3EB851EB851E, or 39.2449999999999974420461...). The parsing method did a good job here in my opinion as this number is the closest one to the real number we wanted (the error is about 2.55e-15 and it would have been 4.54e-15 if the other alternative were chosen).&lt;/p&gt;

&lt;p&gt;Going back to the initial problem, and assuming we now start from 39.2449999999999974420461..., we want to round this number 2 digits after the decimal point. MathUtils.round answer is 39.24 (really 39.2400000000000019895...), which is &quot;only&quot; 0.0049999999999954525264... away from out number. Answering 39.25 (which CAN be represented exactly in IEEE754) would be &quot;0.005000000000002557953848...&quot; away. The initial number is not exactly at a 0.5 * 10^-n boundary, so switching between ROUND_HALF_DOWN, ROUND_HALF_UP or ROUND_HALF_EVEN does not change anything (I have checked this).&lt;/p&gt;</comment>
                            <comment id="12415764" author="psteitz" created="Sun, 11 Jun 2006 23:57:58 +0000"  >&lt;p&gt;I understand and agree with your analysis of the IEEE754 representation, but I would still like to see if there is anyting clever that we can do to work around the problem.   Could be this is hopeless, but I am bothered by the fact that the previous implementation actually handles this correctly.  Sorry I messed up the link in the comment above to the earlier BigDecimal-based impl.  That should have been to &lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc/jakarta/commons/proper/math/trunk/src/java/org/apache/commons/math/util/MathUtils.java?revision=239294&amp;amp;view=markup&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/jakarta/commons/proper/math/trunk/src/java/org/apache/commons/math/util/MathUtils.java?revision=239294&amp;amp;view=markup&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In any case, the impl there, modified to handle the special values included in later tests would be:&lt;br/&gt;
public static double round(double x, int scale, int roundingMethod) {&lt;br/&gt;
        try &lt;/p&gt;
{
            return (new BigDecimal
                   (new Double(x).toString())
                   .setScale(scale, roundingMethod))
                   .doubleValue();
        }
&lt;p&gt; catch (NumberFormatException ex) {&lt;br/&gt;
            if (Double.isInfinite&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;) &lt;/p&gt;
{
                return x;          
            }
&lt;p&gt; else &lt;/p&gt;
{
                return Double.NaN;
            }
&lt;p&gt;        }&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;Before &lt;a href=&quot;http://issues.apache.org/jira/browse/MATH-32&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;http://issues.apache.org/jira/browse/MATH-32&lt;/a&gt;, it was just&lt;br/&gt;
return (new BigDecimal&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.setScale(scale, roundingMethod))&lt;/p&gt;

&lt;p&gt;The code above passes all tests, including even&lt;br/&gt;
double x = 39.0d;&lt;br/&gt;
x = x + 245d/1000d;&lt;br/&gt;
assertEquals(39.25,MathUtils.round(x, 2), 0.0);&lt;/p&gt;</comment>
                            <comment id="12415774" author="psteitz" created="Mon, 12 Jun 2006 00:59:50 +0000"  >&lt;p&gt;Sorry, messed up the link yet again.  Best to just look at&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc/jakarta/commons/proper/math/trunk/src/java/org/apache/commons/math/util/MathUtils.java?view=log&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/jakarta/commons/proper/math/trunk/src/java/org/apache/commons/math/util/MathUtils.java?view=log&lt;/a&gt;&lt;br/&gt;
or use a svn client to examine history. &lt;/p&gt;

&lt;p&gt;I also neglected to mention that part of the reason for the change to the new impl was performance.   I played with some microbenchmarks to confirm this some time ago, seeing about 5x-8x improvement in the direct impl.  It might be a good idea to do this testing rigorously.  &lt;/p&gt;

&lt;p&gt;If we could characterize the inputs somehow that have &quot;bad&quot; IEEE754 representations, perhaps we could use the BigDecimal-based impl just for them.   I don&apos;t see any reliable way to do that, though.&lt;/p&gt;</comment>
                            <comment id="12416287" author="luc" created="Thu, 15 Jun 2006 09:31:51 +0000"  >&lt;p&gt;I was looking for a way to characterize those &quot;bad&quot; IEEE754 representations. Here is one proposal:&lt;br/&gt;
we could had an implementation of  the nextAfter method, either in MathUtils or in a new IeeeFunctions method in case we want also to add other interesting functions defined by the IEEE754 standard. The signature of this method is:&lt;/p&gt;

&lt;p&gt;  static double nextAfter(double d, double direction)&lt;/p&gt;

&lt;p&gt;It returns the next representable number after its first argument which lies on the same side as the second argument. Using this, we could compare the rounding of x and nextAfter(x, x+1) when the rounding mode is ROUND_HALF_UP. If the results is different, the IEEE754 representation of x is on some boundary. In fact, I think we could always return the rounding of nextAfter in this mode (after all if round&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; and round(nextAfter&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;) are the same, we could return either and if they are not the same, we want to return round(nextAfter, at least in some rounding methods). The test could be performed in the roundUnscaled method, and similar tests could be implemented in the other branches of the switch for other rounding methods.&lt;/p&gt;

&lt;p&gt;This would be slower than the current implementation, but probably much faster than going back to rebuild a String and parsing it as a BigDecimal.&lt;/p&gt;

&lt;p&gt;I have written an implementation of nextAfter. It is based on Double.doubleToLongBits, bits twiddling, and  Double.longBitsToDouble.&lt;/p&gt;</comment>
                            <comment id="12416856" author="psteitz" created="Tue, 20 Jun 2006 14:03:54 +0000"  >&lt;p&gt;+1 to nextAfter as addition to MathUtils and for the approach outlined above for resolving this issue.  Thanks in advance for patches. &lt;/p&gt;</comment>
                            <comment id="12418308" author="luc" created="Thu, 29 Jun 2006 03:12:05 +0000"  >&lt;p&gt;This patch is an attempt to solve the issue.&lt;br/&gt;
The principle is to add a nexAfter method in MathUtils and to use it in order to very slightly shift the numbers (by one ulp) in the expected rounding direction in order to avoid some degenerate cases.&lt;br/&gt;
Note that if someone REALLY wants to round a number like 39.2449999999999974420461512636 and NOT 39.245, we will produce a wrong result. I didn&apos;t put any warning about this behaviour in the javadoc, but I think that if this patch is finally applied, the javadoc should be exlpicit.&lt;/p&gt;

&lt;p&gt;I understand the user problem but do not really like answering like that, it seems more like an ad hoc trick to me. I&apos;m not very proud of my first patch &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12419059" author="psteitz" created="Tue, 4 Jul 2006 15:19:27 +0000"  >&lt;p&gt;Patch applied.  Thanks!&lt;/p&gt;

&lt;p&gt;I understand that the patch is not really satisfying, but it makes the code better and resolves the reported problem.   A more elegant solution may be possible, but the patch improves the code and resolves the reported problem, so it should be applied.  If we find a better way to handle correct rounding of &quot;bad&quot; IEEE754 numbers, we can reopen or create a separate issue.&lt;/p&gt;

&lt;p&gt;Thanks for the patch!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13543902">NUMBERS-199</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12336090" name="math-151.patch" size="10754" author="luc" created="Thu, 29 Jun 2006 03:12:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>150383</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            19 years, 21 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0rw7j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>160862</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>