<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:25:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[MATH-1627] ChiSquareTest computes NaN with zero observations</title>
                <link>https://issues.apache.org/jira/browse/MATH-1627</link>
                <project id="12310485" key="MATH">Commons Math</project>
                    <description>&lt;p&gt;Zero observations input to the ChiSquareTest will compute NaN:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ChiSquareTest chi2Test = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ChiSquareTest();
&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;[][] counts = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;[2][2];
&lt;span class=&quot;code-comment&quot;&gt;// NaN
&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; chi2 = chi2Test.chiSquare(counts);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is due to a divide by zero error. This bug was identified by sonarcloud analysis.&lt;/p&gt;

&lt;p&gt;The unit tests use R as a reference. In R this case will raise an error that at least one entry must be positive. Setting a value to 1 allows R to compute a Chi-square test value but the value is not valid:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-r&quot;&gt;
&amp;gt; m &amp;lt;- array(c(1,0,0,0), dim = c(2,2))
&amp;gt; chisq.test(m)

	Pearson&apos;s Chi-squared test

data:  m
X-squared = &lt;span class=&quot;code-keyword&quot;&gt;NaN&lt;/span&gt;, df = 1, p-value = &lt;span class=&quot;code-keyword&quot;&gt;NA&lt;/span&gt;

Warning message:
In chisq.test(m) : Chi-squared approximation may be incorrect
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Other methods in the ChiSquareTest will raise a ZeroException if the observations are zero for an entire array of observations or if a pair of observations in a bin are both zero.&lt;/p&gt;

&lt;p&gt;The Chi square test has assumptions that do not hold when the number of observations are small. The limit for the number of observations per category is variable. The document referenced in the code javadoc recommends an expected level of 5 per bin. To avoid setting limits on the sample size a&#160;suggested fix is to raise a zero exception if the sum of all counts is zero. This will avoid a NaN computation. Use of a suitable number of observations is left to the caller.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13396479">MATH-1627</key>
            <summary>ChiSquareTest computes NaN with zero observations</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="5" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Trivial</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="aherbert">Alex Herbert</reporter>
                        <labels>
                    </labels>
                <created>Sat, 21 Aug 2021 13:04:15 +0000</created>
                <updated>Sun, 22 Aug 2021 20:47:08 +0000</updated>
                            <resolved>Sun, 22 Aug 2021 20:47:08 +0000</resolved>
                                    <version>4.0</version>
                                    <fixVersion>4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="17402614" author="alexherbert" created="Sat, 21 Aug 2021 14:01:17 +0000"  >&lt;p&gt;If there is at least 1 observation (so total is non-zero) this issue still manifests if any row or column in the input contingency table sums to zero due to the division by the expected value:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; sumSq = 0.0d;
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; row = 0; row &amp;lt; nRows; row++) {
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; col = 0; col &amp;lt; nCols; col++) {
        &lt;span class=&quot;code-comment&quot;&gt;// *** Will create NaN &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; expected is zero ***
&lt;/span&gt;        &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; expected = (rowSum[row] * colSum[col]) / total;
        sumSq += ((counts[row][col] - expected) *
                (counts[row][col] - expected)) / expected;
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In this case two options are available:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Raise an exception if any column or row total is zero&lt;/li&gt;
	&lt;li&gt;Ignore the rows and columns from the sum of squared deviations&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Option 2 may be more robust. The columns that are ignored still contribute to the degrees of freedom of the test:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;[][] count = ...;
&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; df = ((&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;) counts.length -1) * ((&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;) counts[0].length - 1);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Note that R will compute NaN for the chi-square statistic in this case but is OK if all columns and rows have at least 1 count above 0:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-r&quot;&gt;
&amp;gt; m &amp;lt;- array(c(1,0,1,0), dim = c(2,2))
&amp;gt; chisq.test(m)

	Pearson&apos;s Chi-squared test

data:  m
X-squared = &lt;span class=&quot;code-keyword&quot;&gt;NaN&lt;/span&gt;, df = 1, p-value = &lt;span class=&quot;code-keyword&quot;&gt;NA&lt;/span&gt;

Warning message:
In chisq.test(m) : Chi-squared approximation may be incorrect

&amp;gt; m &amp;lt;- array(c(1,0,0,1), dim = c(2,2))
&amp;gt; chisq.test(m)

	Pearson&lt;span class=&quot;code-quote&quot;&gt;&apos;s Chi-squared test with Yates&apos;&lt;/span&gt; continuity correction

data:  m
X-squared = 0, df = 1, p-value = 1

Warning message:
In chisq.test(m) : Chi-squared approximation may be incorrect
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Thus R is detecting if all observations are zero (and raising an error) but will not raise an error if rows or columns are zero, instead computing NaN.&lt;/p&gt;

&lt;p&gt;If the rows/columns are ignored (i.e. if expected=0, sum of square deviations=0) then chi-square for this is 0.0. This is true for a 2x2 table irrespective of the number of counts in a single entry:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[400, 0]
[0, 0]

chi2 = 0.0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This effectively ignores rows/columns. Ignoring columns/rows is reducing the degrees of freedom (DoF) of the chi-square statistic. In the 2x2 case it reduces the DoF to a level that is invalid.&lt;/p&gt;

&lt;p&gt;This could be formalised in the class to ignore any column or row with all zero entries. With the current code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ChiSquareTest chi2Test = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ChiSquareTest();

&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;[][] counts = {{1, 2}, {3, 4}};
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(chi2Test.chiSquare(counts));

&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;[][] counts2 = {{1, 0, 2}, {0, 0, 0}, {3, 0, 4}};
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(chi2Test.chiSquare(counts2));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Outputs:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;0.07936507936507939
NaN
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If the rows and columns are ignored when the expected value is zero then the chi-square is computed:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;0.07936507936507939
0.07936507936507939
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This effectively removes from the input contingency table any rows or columns with no data. The degrees of freedom for the chi-square distribution would have to be updated. This adds complexity to the class. It is preferable to leave it to the caller to eliminate categories from the contingency table data that have no observations.&lt;/p&gt;

&lt;p&gt;A suggested fix is:&lt;/p&gt;

&lt;p&gt;Raise a ZeroException if all input counts are zero&lt;/p&gt;

&lt;p&gt;Raise a ZeroException if any column or row total is zero&lt;/p&gt;

&lt;p&gt;The documentation should be updated to make the user aware this is possible. This type of input is invalid for the chi-square computation.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17402876" author="alexherbert" created="Sun, 22 Aug 2021 20:47:08 +0000"  >&lt;p&gt;Throw an exception if a column or row contains only zeros.&lt;/p&gt;

&lt;p&gt;Updated in commit:&lt;/p&gt;

&lt;p&gt;21f80081082ce3b31a1bcd8ecae0e3ae9ac70c05&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 11 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0u4a0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>