<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:24:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[MATH-1131] Kolmogorov-Smirnov Tests takes &apos;forever&apos; on 10,000 item dataset</title>
                <link>https://issues.apache.org/jira/browse/MATH-1131</link>
                <project id="12310485" key="MATH">Commons Math</project>
                    <description>&lt;p&gt;I have code simplified to the following:&lt;/p&gt;

&lt;p&gt;    KolmogorovSmirnovTest kst = new KolmogorovSmirnovTest();&lt;br/&gt;
    NormalDistribution nd = new NormalDistribution(mean,stddev);&lt;br/&gt;
    kst.kolmogorovSmirnovTest(nd,dataset)&lt;/p&gt;

&lt;p&gt;I find that for my dataset of 10,000 items, the call to kolmogorovSmirnovTest takes &apos;forever&apos;. It has not returned after nearly 15minutes and in one my my tests has gone over 150MB in  memory usage. &lt;/p&gt;</description>
                <environment>&lt;p&gt;Java 8&lt;/p&gt;</environment>
        <key id="12723580">MATH-1131</key>
            <summary>Kolmogorov-Smirnov Tests takes &apos;forever&apos; on 10,000 item dataset</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="ysb33r">Schalk W. Cronj&#233;</reporter>
                        <labels>
                    </labels>
                <created>Wed, 25 Jun 2014 08:12:48 +0000</created>
                <updated>Fri, 26 Dec 2014 19:50:30 +0000</updated>
                            <resolved>Fri, 19 Sep 2014 16:23:35 +0000</resolved>
                                    <version>3.3</version>
                                    <fixVersion>3.4</fixVersion>
                                        <due></due>
                            <votes>2</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14043177" author="ysb33r" created="Wed, 25 Jun 2014 08:14:11 +0000"  >&lt;p&gt;Dataset that was used.&lt;/p&gt;</comment>
                            <comment id="14043178" author="ysb33r" created="Wed, 25 Jun 2014 08:14:40 +0000"  >&lt;p&gt;Example Java code to reproduce issue&lt;/p&gt;</comment>
                            <comment id="14043182" author="ysb33r" created="Wed, 25 Jun 2014 08:15:20 +0000"  >&lt;p&gt;Example Groovy code that also reproduces the issue&lt;/p&gt;</comment>
                            <comment id="14043247" author="ysb33r" created="Wed, 25 Jun 2014 09:38:18 +0000"  >&lt;p&gt;See the code examples for the specific &lt;em&gt;mean&lt;/em&gt; &amp;amp; &lt;em&gt;stddev&lt;/em&gt; that was used.&lt;/p&gt;</comment>
                            <comment id="14043712" author="psteitz" created="Wed, 25 Jun 2014 16:37:43 +0000"  >&lt;p&gt;Thanks for reporting this and providing the code and data.  I suspect the problem is in the matrix exponentiation done in the roundedK method.  Anyone interested in patching this should start by looking at the reference in the class javadoc (and other sources) to identify optimizations that can be done for large samples.&lt;/p&gt;</comment>
                            <comment id="14043857" author="tn" created="Wed, 25 Jun 2014 18:14:47 +0000"  >&lt;p&gt;I did briefly debug the example and indeed the calculation hangs when calling roundedK, or more precisely in createH.&lt;/p&gt;

&lt;p&gt;There powers of BigFraction objects are created with really big numerators and denominators. Some of the calculations later on take then forever because of this, e.g. when internally calculating the gcd.&lt;/p&gt;

&lt;p&gt;Looking at the implementation from the referenced paper, there the H values are computed with double precision. Was there a specific reason to use BigFraction in our implementation? Is there a specific need for that level of accuracy for the Kolmogorov-Smirnov Test? The other inference tests do not seem to be so stringent.&lt;/p&gt;

&lt;p&gt;It looks like there is no easy way to limit the maxDenominator when calling multiply() as it is possible when creating a BigFraction object.&lt;/p&gt;</comment>
                            <comment id="14043902" author="ysb33r" created="Wed, 25 Jun 2014 18:43:58 +0000"  >&lt;p&gt;This section of code in createH might be part of the problem. A quick test on my macbook shows that the most of 36 minutes are spent inside there for d=0.029357223978016822, n=9999. (I specifically tried 9,999 as it was one less than 10,000).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; m; ++i) {
  &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; j = 0; j &amp;lt; i + 1; ++j) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (i - j + 1 &amp;gt; 0) {
 	&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; g = 2; g &amp;lt;= i - j + 1; ++g) {
   	  Hdata[i][j] = Hdata[i][j].divide(g);
 	}
    }
  }
}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14044019" author="ysb33r" created="Wed, 25 Jun 2014 20:43:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phil%40steitz.com&quot; class=&quot;user-hover&quot; rel=&quot;phil@steitz.com&quot;&gt;phil@steitz.com&lt;/a&gt; said on the ML:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Sorry for responding to the list but I have only mobile atm .  IIRC the roundedK method should not be creating matrices of BigFractions, but rather using doubles.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I did a quick hack on the test code I used for createH earlier to use double instead and the speed improvement as expected is immense - down from 36min to 9min. I cannot comment on whether the change in precision is significant, but not was not the point of the test.&lt;/p&gt;
</comment>
                            <comment id="14044641" author="tn" created="Thu, 26 Jun 2014 13:15:45 +0000"  >&lt;p&gt;My previous comment wrt performance of matrix.power&amp;#40;n&amp;#41; was wrong.&lt;br/&gt;
This is not the limiting factor when using a BlockRealMatrix as the number of actual matrix multiplications is only log&amp;#40;n&amp;#41;.&lt;/p&gt;

&lt;p&gt;The problem when using so large samples is that the matrix elements quickly grow and lead to NaN computations. The reference code does a special trick when computing power&amp;#40;n&amp;#41;:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;after every multiplication check if the center element is &amp;gt; 1e140 and if so divide the whole matrix by this factor.&lt;/li&gt;
	&lt;li&gt;update the factor each time it is applied to the matrix&lt;/li&gt;
	&lt;li&gt;after computing power&amp;#40;n&amp;#41;, the factor is applied in a reverse manner on the element to be returned.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14045675" author="tn" created="Fri, 27 Jun 2014 07:48:37 +0000"  >&lt;p&gt;Attached a patch that uses doubles to evaluate H for the rounded case.&lt;/p&gt;

&lt;p&gt;This allows to evaluate the test up a N of ~700, for larger datasets overflow happens when calculating H.power&amp;#40;n&amp;#41;.&lt;/p&gt;

&lt;p&gt;We need to decide if we want to implement the same trick as in the reference implementation from the paper.&lt;/p&gt;</comment>
                            <comment id="14046973" author="psteitz" created="Sat, 28 Jun 2014 21:38:27 +0000"  >&lt;p&gt;I think the patch definitely improves things, so +1 to commit that for now.  I am not sure that the Marsaglia-Tsang method is best for large n, though.  It might be best to either a) just use the Kolmogorov approximation or b) use what Simard-L&apos;Ecuyer (&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; in the class javadoc) refer to as the Pelz-Good method for large n (or more precisely large n*d).  I think R does a).  The two-sample tests do a).&lt;/p&gt;</comment>
                            <comment id="14046995" author="psteitz" created="Sat, 28 Jun 2014 22:55:08 +0000"  >&lt;p&gt;A few of comments not directly related to the performance issue, but likely relevant to the OP and anyone using KolmogorovSmirnovTest to evaluate the null hypothesis that a sample comes from a normal (Gaussian) distribution:&lt;/p&gt;

&lt;p&gt;1. The KS test using parameters estimated from the data is in general not the best test to use to test normality.  We do not currently implement the Lillifors or other tests.  Patches welcome &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  (Discuss first on the mailing list, then open separate tickets for these if interested.)&lt;br/&gt;
2.  &lt;b&gt;No&lt;/b&gt; classical frequentist test really works for large samples.  KS, Liilifors, Shapiro-Wilks et al are uniformly too powerful to be meaningful for samples even as small as 5000 observations.  See, e.g. &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;.&lt;br/&gt;
3.  An interesting alternative for large samples is &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;.   Here again, patches welcome.  A similar approach implementable using Commons Math version 3.x would be to bin the data in standard deviation units and then apply a G-test with expected counts computed using quantiles of the normal distribution.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://www.statisticalmisses.nl/index.php/frequently-asked-questions/77-what-is-wrong-with-tests-of-normality&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.statisticalmisses.nl/index.php/frequently-asked-questions/77-what-is-wrong-with-tests-of-normality&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://ideals.illinois.edu/bitstream/handle/2142/29878/largesamplenorma93171bera.pdf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ideals.illinois.edu/bitstream/handle/2142/29878/largesamplenorma93171bera.pdf&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14052472" author="tn" created="Fri, 4 Jul 2014 14:19:19 +0000"  >&lt;p&gt;The implementation of R is a 1:1 copy of the code from the Marsaglia-Tsang paper, including the 1e140 trick.&lt;/p&gt;</comment>
                            <comment id="14052477" author="tn" created="Fri, 4 Jul 2014 14:28:42 +0000"  >&lt;p&gt;Committed patch in r1607864.&lt;/p&gt;

&lt;p&gt;Need to decide what to do with large samples. I would be more confident with the Pelz method though.&lt;/p&gt;</comment>
                            <comment id="14052648" author="psteitz" created="Fri, 4 Jul 2014 20:28:31 +0000"  >&lt;p&gt;Thomas&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;The implementation of R is a 1:1 copy of the code from the Marsaglia-Tsang paper, including the 1e140 trick.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, but from the R code (what calls the C code) and online docs it looks to me like R only does this for n &amp;lt; 100.  Beyond that, it looks like the ks sum is used.  I agree though that based on Lecuyer-Simard&apos;s analysis, the Pelz method would be better, with &quot;exact&quot; computations as we have now for &amp;lt;n, d&amp;gt; up to the bounds they suggest.  I will implement this if there are no objections.&lt;/p&gt;</comment>
                            <comment id="14052662" author="tn" created="Fri, 4 Jul 2014 21:04:31 +0000"  >&lt;p&gt;Ok great and thanks for the info, as I did only look at the c source code in the R project.&lt;/p&gt;

&lt;p&gt;I am happy to review your code and have no objections.&lt;/p&gt;</comment>
                            <comment id="14075491" author="psteitz" created="Sat, 26 Jul 2014 20:56:16 +0000"  >&lt;p&gt;Pelz-Good implemented in r1613723.  &lt;/p&gt;</comment>
                            <comment id="14080883" author="psteitz" created="Thu, 31 Jul 2014 13:43:33 +0000"  >&lt;p&gt;OK to resolve this?&lt;/p&gt;</comment>
                            <comment id="14082369" author="ysb33r" created="Fri, 1 Aug 2014 15:45:30 +0000"  >&lt;p&gt;Before closing, it would be good to have a note in the javadoc to indicate over which value of N samples, performance will become an issue. It will prevent users like me from falling into a pit &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14082719" author="psteitz" created="Fri, 1 Aug 2014 18:41:54 +0000"  >&lt;p&gt;@Schaik:  have you tested with the latest code in trunk?  I would not expect the current code to degrade for large n, unless &quot;exact&quot; is specified and that already has a warning label.&lt;/p&gt;</comment>
                            <comment id="14082789" author="ysb33r" created="Fri, 1 Aug 2014 19:19:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=phil%40steitz.com&quot; class=&quot;user-hover&quot; rel=&quot;phil@steitz.com&quot;&gt;phil@steitz.com&lt;/a&gt; Not yet. But I can try on Monday.&lt;/p&gt;</comment>
                            <comment id="14132803" author="tn" created="Sat, 13 Sep 2014 15:59:58 +0000"  >&lt;p&gt;Code looks good.&lt;/p&gt;

&lt;p&gt;The original problem is also solved, thus I think we can close the issue.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12652357" name="1.txt" size="36910" author="ysb33r" created="Wed, 25 Jun 2014 08:14:11 +0000"/>
                            <attachment id="12652776" name="MATH-1131.patch" size="6201" author="tn" created="Fri, 27 Jun 2014 07:48:37 +0000"/>
                            <attachment id="12652359" name="ReproduceKsIssue.groovy" size="490" author="ysb33r" created="Wed, 25 Jun 2014 08:15:20 +0000"/>
                            <attachment id="12652358" name="ReproduceKsIssue.java" size="1056" author="ysb33r" created="Wed, 25 Jun 2014 08:14:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>401765</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 10 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1x5jz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>401834</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>