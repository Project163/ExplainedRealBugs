<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:24:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[MATH-1138] BicubicSplineInterpolator is returning incorrect interpolated values</title>
                <link>https://issues.apache.org/jira/browse/MATH-1138</link>
                <project id="12310485" key="MATH">Commons Math</project>
                    <description>&lt;p&gt;I have encountered a use case with the BicubicSplineInterpolator where the interpolated values that are being returned seem incorrect.  Furthermore, the values do not match those generated by MatLab using the interp2 &apos;cubic&apos; method.&lt;/p&gt;

&lt;p&gt;Here is a snippet of code that uses the interpolator:&lt;/p&gt;

&lt;p&gt;        double[] xValues = new double[] &lt;/p&gt;
{36, 36.001, 36.002}
&lt;p&gt;;&lt;br/&gt;
        double[] yValues = new double[] {-108.00, -107.999, -107.998};&lt;/p&gt;

&lt;p&gt;        double[][] fValues = new double[][] {{1915, 1906, 1931},&lt;br/&gt;
                                        &lt;/p&gt;
{1877, 1889, 1894}
&lt;p&gt;,&lt;br/&gt;
                                        {1878, 1873, 1888}};&lt;/p&gt;

&lt;p&gt;        BicubicSplineInterpolator interpolator = new BicubicSplineInterpolator();&lt;br/&gt;
        BicubicSplineInterpolatingFunction interpolatorFunction = interpolator.interpolate(xValues, yValues, fValues);&lt;/p&gt;

&lt;p&gt;        double[][] results = new double&lt;span class=&quot;error&quot;&gt;&amp;#91;9&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;9&amp;#93;&lt;/span&gt;;&lt;br/&gt;
        double x = 36;&lt;br/&gt;
        int arrayIndexX = 0, arrayIndexY = 0;&lt;/p&gt;

&lt;p&gt;        while(x &amp;lt;= 36.002) {&lt;br/&gt;
            double y = -108;&lt;br/&gt;
            arrayIndexY = 0;&lt;br/&gt;
            while (y &amp;lt;= -107.998) &lt;/p&gt;
{
                results[arrayIndexX][arrayIndexY] = interpolatorFunction.value(x,  y);
                System.out.println(results[arrayIndexX][arrayIndexY]);
                y = y + 0.00025;
                arrayIndexY++;
            }

&lt;p&gt;            x = x + 0.00025;&lt;br/&gt;
            arrayIndexX++;&lt;br/&gt;
        }&lt;/p&gt;

&lt;p&gt;Attached is a grid showing x and y values and the corresponding interpolated value from both commons math and MatLab.&lt;/p&gt;

&lt;p&gt;The values produced by commons math are far off from those created by MatLab.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12726859">MATH-1138</key>
            <summary>BicubicSplineInterpolator is returning incorrect interpolated values</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="abedrossian">Adam Bedrossian</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Jul 2014 18:51:30 +0000</created>
                <updated>Fri, 26 Dec 2014 19:50:23 +0000</updated>
                            <resolved>Fri, 17 Oct 2014 08:54:56 +0000</resolved>
                                    <version>3.3</version>
                                    <fixVersion>3.4</fixVersion>
                                        <due></due>
                            <votes>2</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14059195" author="abedrossian" created="Fri, 11 Jul 2014 18:52:24 +0000"  >&lt;p&gt;Contains x and y values and the corresponding interpolated values from both CM and MatLab.&lt;/p&gt;</comment>
                            <comment id="14132695" author="hankg" created="Sat, 13 Sep 2014 13:22:39 +0000"  >&lt;p&gt;I have been investigating this much further.  The good news is that from what I can tell the implementation of this function is in line with the Wikipedia article it is based on.  The bad news is that this is just not working.  The unit tests associated with this aren&apos;t even passing a basic 2D linear function test. It should be getting identical results to the expected values. These aren&apos;t even close.&lt;/p&gt;

&lt;p&gt;I re-implemented the WIkipedia implementation in Octave and I get the same results the Apache Math function does.  I rederived the equations from the Wikipedia article and confirmed that the coefficients being used are the correct.  It&apos;s just not working though.&lt;/p&gt;

&lt;p&gt;I looked into how Octave performs the same function.  They do not do it this way.  They do it by building up from a series of cubic splines.  I have a mechanism for implementing it in that way and could take a crack at it if you would like.  I know I just joined the Apache project here so let me know what the proper path forward would be to get this assigned to me and contribute it back. &lt;/p&gt;

&lt;p&gt;If I do get it, I intend to reform the unit tests so that they have more appropriate tolerances for the functions listed.  Even the ones that are passing are doing so because their tolerances are jacked up way too high, which isn&apos;t really testing the function numerical accuracy at all.&lt;/p&gt;</comment>
                            <comment id="14135979" author="erans" created="Tue, 16 Sep 2014 19:02:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;I re-implemented [...] rederived [...] confirmed&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks a lot for this thorough review.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;It&apos;s just not working though. [...] I looked into how Octave performs the same function. They do not do it this way.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It would be interesting to go to the reference mentioned in the Wikipedia article.  Maybe it will reveal where the bugs are.&lt;br/&gt;
A web search came up with this site:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  http://www.paulinternet.nl/?page=bicubic
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;At first sight, there would seem to be a discrepancy with the contents of the matrix...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I have a mechanism for implementing it in that way and could take a crack at it if you would like.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That would be nice but be careful to not use a reference that would forbid inclusion in Commons Math.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;let me know what the proper path forward would be to get this assigned to me and contribute it back.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;One way would be to generate the expected values from another package (e.g. Octave) and create a unit test that will miserably fail with the current code when &quot;reasonable&quot; tolerances are used.&lt;br/&gt;
Then, you are most welcome to fix the implementation, trying to not change the public API.&lt;/p&gt;</comment>
                            <comment id="14137174" author="hankg" created="Wed, 17 Sep 2014 12:55:33 +0000"  >&lt;p&gt;Actually, the source they used for that derivation was not that link, but this one (also in their references section):&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.geovista.psu.edu/sites/geocomp99/Gc99/082/gc_082.htm&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.geovista.psu.edu/sites/geocomp99/Gc99/082/gc_082.htm&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can see in Section 3.8 how they are sampling just the corner points (0,0), (1,0), (0,1) and (1,1) in determining coefficients, just like their derivation.  The reference you cited is sampling a 4x4 grid, which makes more sense to me.  The methodology I was talking about existing in the Octave code is the same as the methodology in his site as well. Specifically, to do a 2D interpolation you call a series of 1D interpolations.  The coefficient term version at the bottom of the reference you cited is useful for when the region being sampled between iterations often stays the same.    &lt;/p&gt;

&lt;p&gt;I am aware that Octave uses GPL, which is not compatible with the Apache license, so I was not going to be using  their code (it is written in Matlab scripting language and FORTRAN too).  I was simply looking at which math algorithm they chose to use.  I did not want to use the code off of the site you listed as a baseline either because there is no mention of licensing rights at all. It simply says, &quot;Anything at this page may be copied and modified.&quot; but it doesn&apos;t list what the requirements are for when you do that.  I thought about e-mailing the author asking them if they could put an explicit license, Creative Commons or something, to address the ambiguity.&lt;/p&gt;

&lt;p&gt;My implementation strategy was going to be as follows: I was therefore going to be implementing the algorithm using existing Apache Math 1D interpolation functions after I created my own validating implementation in Octave source code and a test set of data in Octave as well.  I would then create versions of the test that does random samplings of the interpolation region in Octave to figure out what the statistical distributions of errors are.  I would then use that for the tolerances of the same test implementation in Apache.  &lt;/p&gt;

&lt;p&gt;I believe the public API for this should be fine, but I will not change it without consulting team members here.  I would also like to implement lower order BivariateGridInterpolators.  This can be overkill for a lot of applications.  That would be done in a seperate story/issue though.&lt;/p&gt;
</comment>
                            <comment id="14159640" author="psteitz" created="Sun, 5 Oct 2014 19:05:56 +0000"  >&lt;p&gt;Patch?&lt;/p&gt;</comment>
                            <comment id="14159777" author="hankg" created="Mon, 6 Oct 2014 01:12:22 +0000"  >&lt;p&gt;I&apos;m still working on the new coding up.  I&apos;m trying to investigate why I&apos;m not getting the same numerical accuracies out of my Apache Math implementation as I am out of my Octave implementation.  My linear case is only matching to within 1e-13 while it should be matching to within 1e-14, according to the results I get from Octave&apos;s built in function and my own hand coded function.  My parabaloid test should be within 1e-14 as well, but I&apos;m no where near that.  I&apos;m currently investigating the Spline interpolator.  The sensitivities on that object&apos;s tests aren&apos;t cranked down anywhere near 1e-14/1e-15.  I checked Math.NET unit tests and theirs are cranked down to that level, as are the levels I&apos;m seeing in Octave.  I was therefore going to add some additional tests modeled after the Math.NET tests (the are using an MIT license, so that&apos;s compatible with this project).&lt;/p&gt;</comment>
                            <comment id="14159786" author="hankg" created="Mon, 6 Oct 2014 01:32:08 +0000"  >&lt;p&gt;Nevermind, I&apos;ve modified the tolerances on the test to match those of Octave&apos;s built in functions for the same values.  So that is now properly cranked down to the tolerances for these algorithms for those curve fits.  No changes to the spline interpolator was necessary to match those values.  &lt;/p&gt;</comment>
                            <comment id="14159799" author="hankg" created="Mon, 6 Oct 2014 02:08:24 +0000"  >&lt;p&gt;That said, the spline interpolator is not returning correct values for the Bicubic test data set.  For example, given:&lt;br/&gt;
xi = [    3.0000   4.0000   5.0000   6.5000 ];&lt;br/&gt;
zi = [ 25.000    47.000    73.000   119.500];&lt;/p&gt;

&lt;p&gt;The correct value of the interpolation of z for x = 4.5 is 59.5.  The spline interpolator in Apache Math is returning 59.388... . I&apos;ll continue to investigate this this week.  The accuracy of my implementation will not be correct until I figure out why spline is not working right.  &lt;/p&gt;

&lt;p&gt;Another note, TricubicSplineInterpolator was dependent on the partial derivatives in the original BicubicSplineInterpolatingFunction.  There is no such thing in this implementation therefore TricubicSpline will need to be implemented as a piece-wise spline based on the 2D spline, in the same way that the 2D spline is based on the piece-wise implementation based on the 1D spline.&lt;/p&gt;</comment>
                            <comment id="14160303" author="hankg" created="Mon, 6 Oct 2014 13:55:41 +0000"  >&lt;p&gt;Reviewing Octave and Math.NET I have identified the source of the discrepancy.  It appears that Octave uses B-splines for their spline interpolation.  The implementation in Apache Math is the Natural Spline.  When I use the Math.NET natural spline interpolator I get the same results as I get with the Apache Math method.  However if I use the Akima Cubic Spline algorithm from Math.NET I get valid numbers.  The only disadvantage of the Akima Spline that I see that we don&apos;t have with the standard cubic spline is that it needs a minimum of five elements, not four.  &lt;/p&gt;

&lt;p&gt;Because the current spline works I was going to code up an Akima spline based on the Math.NET implementation (referencing that source (they are a compatible MIT license), plus a book source.  I will then use that as the basis for the splines in the BicubicSpline Interpolation.&lt;/p&gt;</comment>
                            <comment id="14161138" author="hankg" created="Mon, 6 Oct 2014 22:34:54 +0000"  >&lt;p&gt;I&apos;ve finished coding up the Akima spline interpolator, and while it works better than the natural spline it is still nowhere near as close as the b-splines in Octave.  It nails it for linear and quadratic curves, but even a cubic function throws it (and the natural spline) for a loop.  I&apos;ve confirmed the uncertainties of both spline methods by comparing to Math.NET output.  I therefore want to implement a B-Spline.  I found this BSD-licensed B-spline library.  I intend to use for that implementation.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.eol.ucar.edu/homes/granger/bspline/doc/index.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.eol.ucar.edu/homes/granger/bspline/doc/index.html&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="14162995" author="hankg" created="Wed, 8 Oct 2014 03:04:51 +0000"  >&lt;p&gt;I have completed work on this to a point where it is generating substantially better values.  I am using the Akima Spline algorithm.  For the planar test the error off the truth function went from 6 to 6e-14.  On the parabaloid function test it went from 224 to 6e-14.  The corresponding errors on the Akima Spline test for linear, parabolic and cubic functions are 1e-15, 6e-14 and 3.8, respectively.  While that is an improvement over the Natural Spline, that could have errors over 15 on the cubic test, the B-spline would collapse errors on the higher order functions to something comparable to the linear and parabolic tests, and thus further enhance the accuracy of the interpolation of the higher dimension interpolators too.  Patch is attached to this incident.&lt;/p&gt;</comment>
                            <comment id="14162997" author="hankg" created="Wed, 8 Oct 2014 03:05:49 +0000"  >&lt;p&gt;Pull request for this is at:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/commons-math/pull/2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-math/pull/2&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="14174861" author="luc" created="Fri, 17 Oct 2014 08:54:56 +0000"  >&lt;p&gt;Patch applied as of b5e155e.&lt;/p&gt;

&lt;p&gt;Thanks for the patch!&lt;/p&gt;</comment>
                            <comment id="14175918" author="tn" created="Sat, 18 Oct 2014 08:34:46 +0000"  >&lt;p&gt;I do not know if we can already close this issue, as the original problem got now even worse: the minimum number of required data points for the new Akima spline method is 5, thus the above example fails with an InsufficientDataException.&lt;/p&gt;</comment>
                            <comment id="14175940" author="hankg" created="Sat, 18 Oct 2014 11:14:50 +0000"  >&lt;p&gt;Adam was working on a project for me when he uncovered the accuracies issues with the interpolators.  He posted this to the discussion board and then ultimately here to help resolve the matter.  The field we were running our interpolation on was much greater than the number of elements given.  We were just trying to come up with a concise example to send here.  This was before we started tearing into the test harness for these functions, which is when I took over the investigation of the problem.  We ultimately had to write our own bilinear interpolation rather than use the Apache Math libraries due to time constraints, but I do intend to switch that out for this method in a future sprint once this is part of a shipping Apache Math release.&lt;/p&gt;</comment>
                            <comment id="14175947" author="tn" created="Sat, 18 Oct 2014 11:38:04 +0000"  >&lt;p&gt;I understand and appreciate the effort that has been put into this issue, but I just wanted to point out that we might create a potential regression here for people that have been using the interpolator with less than 3 data points.&lt;/p&gt;

&lt;p&gt;To be honest, I do not know exactly how to proceed, as the current code clearly improves the results, maybe we should explicitely note this change in the release notes.&lt;/p&gt;</comment>
                            <comment id="14175966" author="hankg" created="Sat, 18 Oct 2014 11:57:58 +0000"  >&lt;p&gt;We can go back to only requiring four elements if we use the regular spline instead of the Akima spline.  The tolerances on the interpolation tests will have to be significantly loosened however since the regular spline algorithm produces larger deviations from the truth function by the nature of the algorithm.  I was opting for the increased accuracy.  In a future revision we were considering giving people the option to select their interpolation method between regular, Akima and B-Spline.  I just haven&apos;t gotten around to coding that.  Perhaps now would be a good time.  We could default to the regular spline and give people the Akima spline option, noting that it is of higher accuracy.  I do not know what the minimum number of points for the B-spline will be as I haven&apos;t started investigating an implementation yet.  It may be that too is four and thus once all is said and done the default spline algorithm would always be four.&lt;/p&gt;</comment>
                            <comment id="14175973" author="tn" created="Sat, 18 Oct 2014 12:10:43 +0000"  >&lt;p&gt;Giving the user control over the type of spline algorithm used in the interpolator / function would certainly be good imho.&lt;/p&gt;</comment>
                            <comment id="14175978" author="hankg" created="Sat, 18 Oct 2014 13:00:00 +0000"  >&lt;p&gt;Agreed, we just need to discuss it in the message board.  I can create a new JIRA issue and start that process.&lt;/p&gt;</comment>
                            <comment id="14177849" author="hankg" created="Tue, 21 Oct 2014 02:27:06 +0000"  >&lt;p&gt;I have restored the original files but added deprecation and accuracy warnings.  The new interpolators are now in their own &quot;Piecewise&quot; surnamed classes.  All tests in the entire JUnit suite passed. &lt;/p&gt;

&lt;p&gt;You can find the details of the pull request here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/commons-math/pull/3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-math/pull/3&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can browse my version of the repository, or pull your own copy down, here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/HankG/commons-math&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/HankG/commons-math&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This pull request seems to also have all of the changes from apache:master that I fetched and merged with my local repository before I started these edits.  I&apos;m not sure how to get GitHub to ignore those came from the root, nor have I figured out how to select a limited range of changes to get around that.  I also don&apos;t want to let my fork go stale.  Between the two I figured it was better to keep my fork up to date before making changes than it was for the person processing a pull request to try to shoe horn it into whatever the change is. &lt;/p&gt;

&lt;p&gt;Along with these changes I did do a scan of my code to make sure I didn&apos;t miss any defensive programming practices, used magic numbers, et cetera.  Nothing stood out to me, but proofreading your own writing is never a good thing.  If whatever &quot;minor changes&quot; I need to make to get this code &quot;on par with what we had usually committed as new contributions&quot; can be pointed out here or in JIRA I&apos;d appreciate it.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12754541">MATH-1166</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12649848">MATH-985</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12655278" name="Interpolated Values from CM and MatLab.docx" size="15539" author="abedrossian" created="Fri, 11 Jul 2014 18:52:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>404966</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 4 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1xp0n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>405003</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>