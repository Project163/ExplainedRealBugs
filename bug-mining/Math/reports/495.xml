<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:24:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[MATH-1144] LevenbergMarquardtOptimizer does not allow to change current point during optimization</title>
                <link>https://issues.apache.org/jira/browse/MATH-1144</link>
                <project id="12310485" key="MATH">Commons Math</project>
                    <description>&lt;p&gt;It&apos;s a regression to commons-math v2.0.&lt;/p&gt;

&lt;p&gt;Our software uses LevenbergMarquardtOptimizer for surface fitting by sampled points. Our parameterization of the surface we are fitting may be unconstrained, for example it is enough to have only 4 variables to represent cylinder axis and origin (using euler angles and origin distance), but to simplify derivative computation we instead use 6 parameter representation (vector + point). To make sure that the we constrain our search to valid vectors and origins, we need to renormalize and update surface parameters on every step of optimization.&lt;/p&gt;

&lt;p&gt;Please see this article for details of 3d surface fitting and parameter normalization:&lt;br/&gt;
&lt;a href=&quot;http://nvlpubs.nist.gov/nistpubs/jres/103/6/j36sha.pdf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://nvlpubs.nist.gov/nistpubs/jres/103/6/j36sha.pdf&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Attached surface_fitting_tests.zip package with 2 unit tests that reproduce this problem.&lt;br/&gt;
Contents of package:&lt;br/&gt;
1) simple - simple single file test that tests only in/out side effect of patched library&lt;br/&gt;
2) full - complex test that fits cylinder using sampled points (uses cylinder, fit, utils sources)&lt;br/&gt;
3) lib - contains commons-math3 jar libraries: v3.3 and v3.3A1 (patched). There are also library sources.&lt;br/&gt;
4) patch - contains SVN patch file&lt;/p&gt;

&lt;p&gt;To reproduce:&lt;br/&gt;
Run SurfaceFitterFullTest.java and SurfaceFitterSimpleTest.java tests with commons-math3-3.3.jar OR commons-math3-3.3A1.jar libraries.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12733235">MATH-1144</key>
            <summary>LevenbergMarquardtOptimizer does not allow to change current point during optimization</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="10">Implemented</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="omovchan">Olexiy Movchan</reporter>
                        <labels>
                            <label>fitting</label>
                    </labels>
                <created>Mon, 11 Aug 2014 13:35:19 +0000</created>
                <updated>Fri, 26 Dec 2014 19:50:47 +0000</updated>
                            <resolved>Mon, 3 Nov 2014 11:19:25 +0000</resolved>
                                    <version>3.3</version>
                                    <fixVersion>3.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14092762" author="omovchan" created="Mon, 11 Aug 2014 13:40:07 +0000"  >&lt;p&gt;Added patch that fixes this regression in behavior.&lt;/p&gt;

&lt;p&gt;We pass current point by reference to evaluator. So that we allow IN/OUT side effect for current point value.&lt;/p&gt;</comment>
                            <comment id="14096847" author="erans" created="Thu, 14 Aug 2014 11:04:36 +0000"  >&lt;p&gt;It seems that you were using an unspecified and undocumented side-effect of the implementation.&lt;br/&gt;
The new statements (which your patch would revert) specifically intends to forbid IN/OUT arguments (i.e. it&apos;s not a bug).&lt;/p&gt;

&lt;p&gt;Do you implement a custom &quot;Evaluation&quot; class?&lt;/p&gt;

&lt;p&gt;IMO, the feature which you need should be implemented in a proper way, and requires a discussion on the &quot;dev&quot; ML.&lt;/p&gt;</comment>
                            <comment id="14096878" author="omovchan" created="Thu, 14 Aug 2014 11:36:36 +0000"  >&lt;p&gt;No, we use LocalLeastSquaresProblem class with default implementation for evaluation. We use default implementation for Evaluation interface too. &lt;/p&gt;

&lt;p&gt;In any case, it would be nice to have an enhancement that allows to renormalize input points. It&apos;s very hard to implement the surface fitting algorithm without normalization of parameters on every step (or maybe impossible).&lt;/p&gt;</comment>
                            <comment id="14096920" author="erans" created="Thu, 14 Aug 2014 12:43:19 +0000"  >&lt;p&gt;I don&apos;t understand what is going on.&lt;br/&gt;
At line 403 in &quot;LeastSquaresFactory.java&quot;, a defensive copy is performed; so, whether a reallocation is performed or not within &quot;LevenbergMarquardtOptimizer&quot; should not matter (and should not have a side-effect).&lt;/p&gt;

&lt;p&gt;It would be useful if you could provide a minimal example that shows the problem and how your patch works around it.&lt;/p&gt;

&lt;p&gt;Also, please start a discussion on the &quot;dev&quot; ML, perhaps with a pseudo-code showing what should be accessible to the user for the purpose of renormalizing the parameters.&lt;/p&gt;</comment>
                            <comment id="14096938" author="omovchan" created="Thu, 14 Aug 2014 13:09:16 +0000"  >&lt;p&gt;I can try to clarify the problem using pieces of code and my comments.&lt;/p&gt;

&lt;p&gt;What is &quot;dev&quot; ML and where can I find it?&lt;/p&gt;</comment>
                            <comment id="14097020" author="erans" created="Thu, 14 Aug 2014 14:45:09 +0000"  >&lt;blockquote&gt;&lt;p&gt;I can try to clarify the problem using pieces of code and my comments.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;What would be more readily useful is a unit test.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;What is &quot;dev&quot; ML and where can I find it?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;http://commons.apache.org/proper/commons-math/mail-lists.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://commons.apache.org/proper/commons-math/mail-lists.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Please subscribe to the &quot;developers&quot; ML of the Commons project.&lt;br/&gt;
Then you should post with a prefix of &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;Math&amp;#93;&lt;/span&gt;&quot; in the subject line because the ML is shared with many other &quot;Commons&quot; components.&lt;/p&gt;</comment>
                            <comment id="14098487" author="omovchan" created="Fri, 15 Aug 2014 11:56:06 +0000"  >&lt;p&gt;I am working on the unit test now. I will try to factor out the fitting code from our software.&lt;/p&gt;</comment>
                            <comment id="14103697" author="omovchan" created="Wed, 20 Aug 2014 09:57:07 +0000"  >&lt;p&gt;Added surface_fitting_tests.zip package that is split into 2 parts.&lt;br/&gt;
It contains SurfaceFitterFullTest.java and SurfaceFitterSimpleTest.java unit tests that reproduce the problem.&lt;/p&gt;</comment>
                            <comment id="14169644" author="erans" created="Mon, 13 Oct 2014 17:59:30 +0000"  >&lt;p&gt;Here is a patch based on the conclusion of the discussion held on the &quot;dev&quot; ML: a user-defined &lt;tt&gt;ParameterValidator&lt;/tt&gt; can be passed to the &lt;tt&gt;LeastSquaresProblem&lt;/tt&gt;.&lt;br/&gt;
Could you please test it with your problem and let us know if it solves your issue?&lt;/p&gt;</comment>
                            <comment id="14172599" author="omovchan" created="Wed, 15 Oct 2014 17:01:56 +0000"  >&lt;p&gt;Hi Gilles,&lt;br/&gt;
I have applied and tested your patch. My unit tests failed. Unfortunately the patch is incomplete.&lt;/p&gt;

&lt;p&gt;There are 2 conditions in normalization approach:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;point should be normalized before evaluation&lt;/li&gt;
	&lt;li&gt;the updated point should be returned to optimizer&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Your changes made the normalization explicit now and normalized point is returned inside Evaluation object. But &quot;currentPoint&quot; vector is not updated in LevenbergMarquardtOptimizer.optimize():&lt;/p&gt;

&lt;p&gt;        Evaluation current = problem.evaluate(new ArrayRealVector(currentPoint)); // &amp;lt;= currentPoint is not updated&lt;br/&gt;
        double[] currentResiduals = current.getResiduals().toArray();&lt;br/&gt;
        double currentCost = current.getCost();&lt;/p&gt;</comment>
                            <comment id="14172609" author="omovchan" created="Wed, 15 Oct 2014 17:06:11 +0000"  >&lt;p&gt;Probably we can validate currentPoint before passing it to problem.evaluate().&lt;/p&gt;</comment>
                            <comment id="14172900" author="erans" created="Wed, 15 Oct 2014 20:41:55 +0000"  >&lt;p&gt;Thanks for the feedback.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Probably we can validate currentPoint before passing it to problem.evaluate().&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It seems that this would go against the latest design (and require to pass the &lt;tt&gt;ParameterValidator&lt;/tt&gt; to each optimizer).&lt;/p&gt;

&lt;p&gt;In the new version of the patch, I&apos;ve added statements that update the point to be used by the optimizer (retrieving it from the current &lt;tt&gt;Evaluation&lt;/tt&gt; instance).&lt;br/&gt;
Let me know how it goes with this one.&lt;/p&gt;

&lt;p&gt;In the unit test I&apos;ve created, it does not change anything (wrt the previous patch), unfortunately; probably it is too trivial.   Could you provide a simple unit test that we can put in the CM test suite?&lt;/p&gt;</comment>
                            <comment id="14173711" author="omovchan" created="Thu, 16 Oct 2014 12:59:08 +0000"  >&lt;p&gt;I verified the latest patch and it works fine now.&lt;/p&gt;

&lt;p&gt;I attached SurfaceFitterSimpleTest.java unit test that checks one step of optimization. This test depends only on commons-math3 classes.&lt;/p&gt;</comment>
                            <comment id="14173802" author="erans" created="Thu, 16 Oct 2014 14:26:22 +0000"  >&lt;p&gt;bq I verified the latest patch and it works fine now.&lt;/p&gt;

&lt;p&gt;Great.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I attached SurfaceFitterSimpleTest.java unit test that checks one step of optimization.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Actually, I had meant something that would demonstrate the usefulness (in terms of preformance and/or accuracy) of the &quot;validator&quot; feature.&lt;br/&gt;
[My trivial test already showed that the point can be changed, but it is contrived since it replaces it with the optimum found without validator.]&lt;/p&gt;</comment>
                            <comment id="14173823" author="omovchan" created="Thu, 16 Oct 2014 14:43:48 +0000"  >&lt;p&gt;surface_fitting_tests.zip package that is attached to this jira contains SurfaceFitterFullTest.java test. This unit test verifies the fitting of 3d cylinder and validator can be used there. But that&apos;s not very simple unit test.&lt;/p&gt;</comment>
                            <comment id="14194448" author="erans" created="Mon, 3 Nov 2014 11:19:25 +0000"  >&lt;p&gt;Implemented in:&lt;br/&gt;
&lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/commons-math/commit/321fd029&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/commons-math/commit/321fd029&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12660986" name="LevenbergMarquardtOptimizer.java.patch" size="1337" author="omovchan" created="Mon, 11 Aug 2014 13:40:07 +0000"/>
                            <attachment id="12675101" name="MATH-1144.patch" size="18649" author="erans" created="Wed, 15 Oct 2014 20:41:55 +0000"/>
                            <attachment id="12675274" name="SurfaceFitterSimpleTest.java" size="5540" author="omovchan" created="Thu, 16 Oct 2014 12:56:22 +0000"/>
                            <attachment id="12663095" name="surface_fitting_tests.zip.001" size="10485760" author="omovchan" created="Wed, 20 Aug 2014 09:57:07 +0000"/>
                            <attachment id="12663096" name="surface_fitting_tests.zip.002" size="2254528" author="omovchan" created="Wed, 20 Aug 2014 09:57:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>411263</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 2 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1yr6f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>411255</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>