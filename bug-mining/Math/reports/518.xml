<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:24:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[MATH-1146] class Mean returns incorrect result after processing an Infinity value</title>
                <link>https://issues.apache.org/jira/browse/MATH-1146</link>
                <project id="12310485" key="MATH">Commons Math</project>
                    <description>&lt;p&gt;1. Create a Mean object.&lt;br/&gt;
2. call increment() with Double.POSITIVE_INFINITY.&lt;br/&gt;
3. Call getResult(). Result is INFINITY as expected.&lt;br/&gt;
4. call increment() with 0.&lt;br/&gt;
5. Call getResult(). Result is NaN; not INFINITY as expected.&lt;/p&gt;

&lt;p&gt;This is apparently due to the &quot;optimization&quot; for calculating mean described in the javadoc. Rather than accumulating a sum, it maintains a running mean value using the formula &quot;m = m + (new value - m) / (number of observations)&quot;, which unlike the &quot;definition way&quot;, fails after an infinity.&lt;/p&gt;

&lt;p&gt;I was using Mean within a SummaryStatistics. Other statistics also seem to be affected; for example, the standard deviation also incorrectly gives NaN rather than Infinity. I don&apos;t know if that&apos;s due to the error in Mean or if the other stats classes have similar bugs.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12734473">MATH-1146</key>
            <summary>class Mean returns incorrect result after processing an Infinity value</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="psteitz">Phil Steitz</assignee>
                                    <reporter username="cogen">david cogen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 15 Aug 2014 18:03:51 +0000</created>
                <updated>Fri, 26 Dec 2014 19:50:24 +0000</updated>
                            <resolved>Tue, 16 Dec 2014 23:53:56 +0000</resolved>
                                    <version>3.3</version>
                                    <fixVersion>3.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14099436" author="erans" created="Sat, 16 Aug 2014 01:40:37 +0000"  >&lt;p&gt;Here is a tentative patch which I thought would solve the problem.&lt;br/&gt;
However, it makes another unit test fail.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Tests run: 5, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 0.001 sec &amp;lt;&amp;lt;&amp;lt; FAILURE! - in org.apache.commons.math3.stat.descriptive.AggregateSummaryStatisticsTest                                                                                                                                                      
testAggregateSpecialValues(org.apache.commons.math3.stat.descriptive.AggregateSummaryStatisticsTest)  Time elapsed: 0.001 sec  &amp;lt;&amp;lt;&amp;lt; FAILURE!                  
java.lang.AssertionError: expected:&amp;lt;Infinity&amp;gt; but was:&amp;lt;NaN&amp;gt;                                                                                                  
        at org.junit.Assert.fail(Assert.java:88)                                                                                                             
        at org.junit.Assert.failNotEquals(Assert.java:743)                                                                                                   
        at org.junit.Assert.assertEquals(Assert.java:494)                                                                                                    
        at org.apache.commons.math3.TestUtils.assertEquals(TestUtils.java:55)                                                                                
        at org.apache.commons.math3.stat.descriptive.AggregateSummaryStatisticsTest.assertEquals(AggregateSummaryStatisticsTest.java:236)                    
        at org.apache.commons.math3.stat.descriptive.AggregateSummaryStatisticsTest.testAggregateSpecialValues(AggregateSummaryStatisticsTest.java:222)      
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14099446" author="psteitz" created="Sat, 16 Aug 2014 01:53:32 +0000"  >&lt;p&gt;I am leaning toward improving the javadoc to be clear about what happens with infinities (if possible to do consistently).  The updating formulas and setup are designed for fast, accurate computations and I want to make sure we do not add a performance hit for users with standard (non NaN, non-Inf) data so we can return meaningful results in the presence of INFs. &lt;/p&gt;</comment>
                            <comment id="14099461" author="erans" created="Sat, 16 Aug 2014 02:35:31 +0000"  >&lt;p&gt;Is there a consistent policy throughout CM for handling NaN and infinities?&lt;/p&gt;

&lt;p&gt;Unit tests for some statistics classes refer to &quot;special values&quot;, so it looks like they were meant to be handled. If so, shouldn&apos;t we assume that they must be handled correctly, in all cases?&lt;br/&gt;
Alternately, it would be fine to just signal that if special values are passed to those classes, results are undefined (filtering is the caller&apos;s responsibility).&lt;br/&gt;
Anything in between is confusing, IMHO.&lt;/p&gt;

&lt;p&gt;Consistency should come first. Once the policy is defined, we can then look for an efficient way to implement it.&lt;/p&gt;</comment>
                            <comment id="14099638" author="psteitz" created="Sat, 16 Aug 2014 13:41:56 +0000"  >&lt;p&gt;I think the policy should be we document fully our algorithms and NaNs / INFs impact computations according to Java&apos;s extended arithmetic rules.   This is the de facto policy we have in most places now, when you get down to it.  Otherwise, we end up having to pre-process data for users and make (sometimes arbitrary) rules about what computations should actually mean in the presence of these values.  I do think its best to specify behavior though, so I favor improving javadoc where we can.  In the present case, the updating formula is provided in the javadoc, so one could argue there is nothing to do, but I would not be averse to adding a statement describing behavior when a NaN or INF is added to the data.  I am -0 on trying to extend the definition of the mean to datasets including infinities.&lt;/p&gt;</comment>
                            <comment id="14099667" author="erans" created="Sat, 16 Aug 2014 15:02:15 +0000"  >&lt;p&gt;By &quot;policy&quot; here, I don&apos;t mean best coding practices (which includes good documentation).&lt;br/&gt;
But rather, can we state a general policy on handling special values instead of repeating all over the place (and forgetting to do so) that results could be garbage if NaN or infinities are involved?&lt;br/&gt;
There are several places in CM where the implementations do not behave as one would expect from the plain math definition, and it has led to bug reports (recall e.g. &quot;Complex&quot;). I don&apos;t dispute that there may be good reasons, and that the doc may state it clearly enough (although I don&apos;t think it that the doc should contain what could be deemed an implementation detail, such as the actual computation used to maintain the mean); I find it preferrable to state once and for all that if users want to manipulate NaN and infinities, they should not expect that CM will deliver correct results. The rationale being:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;[CM is] designed for fast, accurate computations [... and] we do not add a performance hit for users with standard (non NaN, non-Inf) data [... in order to] return meaningful results in the presence of INFs.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;which is a quite well stated and perfectly acceptable policy IMO.&lt;/p&gt;
</comment>
                            <comment id="14099685" author="psteitz" created="Sat, 16 Aug 2014 15:39:30 +0000"  >&lt;p&gt;I am fine with stating the general policy that NaNs and infinities are not specially handled by commons math.  I think documenting algorithms is important, though, and I will continue to do it where I can.   Most of what we do amounts to providing numerical approximations of mathematically defined quantities.  The numerical algorithms used in the approximation are part of the API contract, IMO, as it is their results that we are returning.   I see no harm in pointing out where possible what happens when infinities or NaNs are included in user-supplied data.  I think there are a few cases where we filter / specially handle these values today.  I am OK agreeing to change this behavior, but we should talk about it on the dev list and target a major release to implement these API changes.&lt;/p&gt;

&lt;p&gt;Back to this issue - I think the right resolution is to edit javadoc to make clear how NaNs and infinities impact the mean computation.  Same for other stats mentioned in this ticket.&lt;/p&gt;</comment>
                            <comment id="14100581" author="cogen" created="Mon, 18 Aug 2014 12:24:33 +0000"  >&lt;p&gt;Phil Steitz says &quot;The updating formulas and setup are designed for fast, accurate computations and I want to make sure we do not add a performance hit for users with standard (non NaN, non-Inf) data so we can return meaningful results in the presence of INFs. &quot;&lt;/p&gt;

&lt;p&gt;I fail to see how the current implementation of Mean could be faster than the definition way: maintaining a sum and dividing by the number of items.&lt;/p&gt;

&lt;p&gt;The current implementation maintains a current average, rather than computing the average from the sum when requested. So the number of divide operations is proportional to N rather than being equal to 1 for the definition way. (Assuming the normal use case of processing a bunch of values then getting the mean at the end. Whereas the current implementation is only an optimization if somebody wants to know the mean often - like after processing each input.)&lt;/p&gt;</comment>
                            <comment id="14100863" author="erans" created="Mon, 18 Aug 2014 17:05:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;[...] fast, accurate [...]&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There is a trade-off; this implementation of &quot;Mean&quot; is going to be accurate for longer sequences than with the other formula.&lt;br/&gt;
But it may be interesting to provide the alternative implementation which, as you indicate, is more efficient (and handles correctly the use-case reported here).&lt;br/&gt;
Could you please request further opinions on the &quot;dev&quot; ML?&lt;/p&gt;</comment>
                            <comment id="14159624" author="psteitz" created="Sun, 5 Oct 2014 18:39:55 +0000"  >&lt;p&gt;Will edit javadoc for 3.4 release.&lt;/p&gt;</comment>
                            <comment id="14249180" author="psteitz" created="Tue, 16 Dec 2014 23:53:56 +0000"  >&lt;p&gt;Javadoc fixes committed in 26e61145839e4da47eb83edfba406ceefc0b67bf&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12662218" name="MATH-1146.patch" size="3835" author="erans" created="Sat, 16 Aug 2014 01:40:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>412413</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 48 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1yy4n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>412400</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>