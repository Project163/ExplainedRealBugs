{"url":"https://api.github.com/repos/serilog/serilog/issues/196","repository_url":"https://api.github.com/repos/serilog/serilog","labels_url":"https://api.github.com/repos/serilog/serilog/issues/196/labels{/name}","comments_url":"https://api.github.com/repos/serilog/serilog/issues/196/comments","events_url":"https://api.github.com/repos/serilog/serilog/issues/196/events","html_url":"https://github.com/serilog/serilog/issues/196","id":40861194,"node_id":"MDU6SXNzdWU0MDg2MTE5NA==","number":196,"title":"LogContext can't be used with System.Data.SqlClient: TargetInvocationException","user":{"login":"michaelnoonan","id":1627582,"node_id":"MDQ6VXNlcjE2Mjc1ODI=","avatar_url":"https://avatars.githubusercontent.com/u/1627582?v=4","gravatar_id":"","url":"https://api.github.com/users/michaelnoonan","html_url":"https://github.com/michaelnoonan","followers_url":"https://api.github.com/users/michaelnoonan/followers","following_url":"https://api.github.com/users/michaelnoonan/following{/other_user}","gists_url":"https://api.github.com/users/michaelnoonan/gists{/gist_id}","starred_url":"https://api.github.com/users/michaelnoonan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/michaelnoonan/subscriptions","organizations_url":"https://api.github.com/users/michaelnoonan/orgs","repos_url":"https://api.github.com/users/michaelnoonan/repos","events_url":"https://api.github.com/users/michaelnoonan/events{/privacy}","received_events_url":"https://api.github.com/users/michaelnoonan/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":28408957,"node_id":"MDU6TGFiZWwyODQwODk1Nw==","url":"https://api.github.com/repos/serilog/serilog/labels/bug","name":"bug","color":"fc2929","default":true,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/serilog/serilog/milestones/8","html_url":"https://github.com/serilog/serilog/milestone/8","labels_url":"https://api.github.com/repos/serilog/serilog/milestones/8/labels","id":655501,"node_id":"MDk6TWlsZXN0b25lNjU1NTAx","number":8,"title":"1.4","description":"","creator":{"login":"nblumhardt","id":342712,"node_id":"MDQ6VXNlcjM0MjcxMg==","avatar_url":"https://avatars.githubusercontent.com/u/342712?v=4","gravatar_id":"","url":"https://api.github.com/users/nblumhardt","html_url":"https://github.com/nblumhardt","followers_url":"https://api.github.com/users/nblumhardt/followers","following_url":"https://api.github.com/users/nblumhardt/following{/other_user}","gists_url":"https://api.github.com/users/nblumhardt/gists{/gist_id}","starred_url":"https://api.github.com/users/nblumhardt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nblumhardt/subscriptions","organizations_url":"https://api.github.com/users/nblumhardt/orgs","repos_url":"https://api.github.com/users/nblumhardt/repos","events_url":"https://api.github.com/users/nblumhardt/events{/privacy}","received_events_url":"https://api.github.com/users/nblumhardt/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":4,"state":"closed","created_at":"2014-05-11T22:12:37Z","updated_at":"2014-12-19T05:17:36Z","due_on":"2014-08-01T07:00:00Z","closed_at":"2014-12-19T05:17:36Z"},"comments":4,"created_at":"2014-08-21T23:25:03Z","updated_at":"2014-09-05T21:02:37Z","closed_at":"2014-08-23T10:20:46Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"We have a scenario where we execute some SQL Scripts against a SQL Server. We've found that when  this code executes in the scope of a `LogContext.PushProperty()` the process fails with a `TargetInvocationException`. The stack trace indicates that the `ImmutibleStack<>` leveraged by `LogContext` fails to deserialize in a new AppDomain because the `Serilog.FullNetFx` can't be loaded.\n\nPertinent parts of the stack trace below:\n\n```\nSystem.Reflection.TargetInvocationException: Exception has been thrown by the target of an invocation. ---> System.TypeInitializationException: The type initializer for '<Module>' threw an exception. ---> System.TypeInitializationException: The type initializer for '<Module>' threw an exception. ---> <CrtImplementationDetails>.ModuleLoadException: The C++ module failed to load while attempting to initialize the default appdomain.\n ---> System.Runtime.Serialization.SerializationException: Unable to find assembly 'Serilog.FullNetFx, Version=1.3.0.0, Culture=neutral, PublicKeyToken=24c2f752a8e58a10'.\n\nServer stack trace: \n   at System.Runtime.Serialization.Formatters.Binary.BinaryAssemblyInfo.GetAssembly()\n   at System.Runtime.Serialization.Formatters.Binary.ObjectReader.GetType(BinaryAssemblyInfo assemblyInfo, String name)\n   at System.Runtime.Serialization.Formatters.Binary.ObjectMap..ctor(String objectName, String[] memberNames, BinaryTypeEnum[] binaryTypeEnumA, Object[] typeInformationA, Int32[] memberAssemIds, ObjectReader objectReader, Int32 objectId, BinaryAssemblyInfo assemblyInfo, SizedArray assemIdToAssemblyTable)\n   at System.Runtime.Serialization.Formatters.Binary.__BinaryParser.ReadObjectWithMapTyped(BinaryObjectWithMapTyped record)\n   at System.Runtime.Serialization.Formatters.Binary.__BinaryParser.Run()\n   at System.Runtime.Serialization.Formatters.Binary.ObjectReader.Deserialize(HeaderHandler handler, __BinaryParser serParser, Boolean fCheck, Boolean isCrossAppDomain, IMethodCallMessage methodCallMessage)\n   at System.Runtime.Serialization.Formatters.Binary.BinaryFormatter.Deserialize(Stream serializationStream, HeaderHandler handler, Boolean fCheck, Boolean isCrossAppDomain, IMethodCallMessage methodCallMessage)\n   at System.Runtime.Remoting.Channels.CrossAppDomainSerializer.DeserializeObject(MemoryStream stm)\n   at System.Runtime.Remoting.Messaging.SmuggledMethodCallMessage.FixupForNewAppDomain()\n   at System.Runtime.Remoting.Channels.CrossAppDomainSink.DoDispatch(Byte[] reqStmBuff, SmuggledMethodCallMessage smuggledMcm, SmuggledMethodReturnMessage& smuggledMrm)\n   at System.Runtime.Remoting.Channels.CrossAppDomainSink.DoTransitionDispatchCallback(Object[] args)\n\nException rethrown at [0]: \n   at System.Runtime.Remoting.Proxies.RealProxy.HandleReturnMessage(IMessage reqMsg, IMessage retMsg)\n   at System.Runtime.Remoting.Proxies.RealProxy.PrivateInvoke(MessageData& msgData, Int32 type)\n   at System.AppDomain.get_Id()\n   at <CrtImplementationDetails>.DoCallBackInDefaultDomain(IntPtr function, Void* cookie)\n   at <CrtImplementationDetails>.LanguageSupport._Initialize(LanguageSupport* )\n   at <CrtImplementationDetails>.LanguageSupport.Initialize(LanguageSupport* )\n   --- End of inner exception stack trace ---\n   at <CrtImplementationDetails>.LanguageSupport.Initialize(LanguageSupport* )\n   at .cctor()\n   --- End of inner exception stack trace ---\n   at <CrtImplementationDetails>.ThrowModuleLoadException(String , Exception )\n   at <CrtImplementationDetails>.LanguageSupport.Initialize(LanguageSupport* )\n   at .cctor()\n   --- End of inner exception stack trace ---\n   at Microsoft.SqlServer.Management.Common.ExecuteBatch.GetStatements(String sqlCommand)\n   --- End of inner exception stack trace ---\n   at System.RuntimeMethodHandle.InvokeMethod(Object target, Object[] arguments, Signature sig, Boolean constructor)\n   at System.Reflection.RuntimeMethodInfo.UnsafeInvokeInternal(Object obj, Object[] parameters, Object[] arguments)\n   at System.Reflection.RuntimeMethodInfo.Invoke(Object obj, BindingFlags invokeAttr, Binder binder, Object[] parameters, CultureInfo culture)\n   at System.RuntimeType.InvokeMember(String name, BindingFlags bindingFlags, Binder binder, Object target, Object[] providedArgs, ParameterModifier[] modifiers, CultureInfo culture, String[] namedParams)\n   at Microsoft.SqlServer.Management.Common.ServerConnection.GetStatements(String query, ExecutionTypes executionType, Int32& statementsToReverse)\n   at Microsoft.SqlServer.Management.Common.ServerConnection.ExecuteNonQuery(String sqlCommand, ExecutionTypes executionType)\n   at NextGen.ConfigurationManager.Core.Provisioning.SqlServer.Scripting.SqlServerScriptExecutor.<>c__DisplayClass2.<ExecuteScript>b__0() in d:\\BuildAgent\\work\\98b5895707ca816\\src\\NextGen.ConfigurationManager.Core\\Provisioning\\SqlServer\\Scripting\\SqlServerScriptExecutor.cs:line 31\n   at System.Threading.Tasks.Task.Execute()\n\n```\n","closed_by":{"login":"nblumhardt","id":342712,"node_id":"MDQ6VXNlcjM0MjcxMg==","avatar_url":"https://avatars.githubusercontent.com/u/342712?v=4","gravatar_id":"","url":"https://api.github.com/users/nblumhardt","html_url":"https://github.com/nblumhardt","followers_url":"https://api.github.com/users/nblumhardt/followers","following_url":"https://api.github.com/users/nblumhardt/following{/other_user}","gists_url":"https://api.github.com/users/nblumhardt/gists{/gist_id}","starred_url":"https://api.github.com/users/nblumhardt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nblumhardt/subscriptions","organizations_url":"https://api.github.com/users/nblumhardt/orgs","repos_url":"https://api.github.com/users/nblumhardt/repos","events_url":"https://api.github.com/users/nblumhardt/events{/privacy}","received_events_url":"https://api.github.com/users/nblumhardt/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/serilog/serilog/issues/196/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/serilog/serilog/issues/196/timeline","performed_via_github_app":null,"state_reason":"completed"}