<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:13:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KARAF-327] Graceful shutdown of Windows service, revisited</title>
                <link>https://issues.apache.org/jira/browse/KARAF-327</link>
                <project id="12311140" key="KARAF">Karaf</project>
                    <description>&lt;p&gt;I&apos;m trying to make my Karaf service more resilient to shutdown. In particular I want my Camel routes to shutdown gracefully. I started this discussion a few months ago, see &lt;a href=&quot;http://www.mail-archive.com/user@karaf.apache.org/msg00084.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.mail-archive.com/user@karaf.apache.org/msg00084.html&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Guillaume created the JIRA ticket &lt;a href=&quot;https://issues.apache.org/jira/browse/KARAF-176&quot; title=&quot;Improve integration to provide a clean shutdown when running as a service&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KARAF-176&quot;&gt;&lt;del&gt;KARAF-176&lt;/del&gt;&lt;/a&gt; which is also resolved. I haven&apos;t had time to test this until now.&lt;/p&gt;

&lt;p&gt;It seems to me that the problem persists. I&apos;m now using Karaf 2.1.2 and Camel 2.5.0. When I run Karaf from the command line and terminates Karaf by pressing &amp;lt;ctrl-D&amp;gt;, Camel will gracefully shutdown. It looks something like this:&lt;/p&gt;

&lt;p&gt;2010-12-09 13:04:51,737 | INFO  | FelixStartLevel  | DefaultShutdownStrategy          | mel.impl.DefaultShutdownStrategy  114 | Starting to graceful shutdown 1 routes (timeout 300 seconds)&lt;br/&gt;
2010-12-09 13:04:51,737 | INFO  | 1 - ShutdownTask | DefaultShutdownStrategy          | ultShutdownStrategy$ShutdownTask  383 | Route: route1 suspended and shutdown deferred, was consuming from: Endpoint&lt;a href=&quot;file://C:devKarafconnectcommon/data/interfaces/sample/file2file?delay=10000&amp;amp;include=%28%3Fi%29.*%28%3F%3C%21%5C.TMP%29&amp;amp;move=archive%2F%24%7Bdate%3Anow%3AyyyyMMdd%7D%2F%24%7Bfile%3Aonlyname%7D&amp;amp;moveFailed=failed%2F%24%7Bfile%3Aonlyname.noext%7D-%24%7Bdate%3Anow%3AyyyyMMddHHmmssSSS%7D.%24%7Bfile%3Aext%7D&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file://C:\dev\Karaf\connect\common/data/interfaces/sample/file2file?delay=10000&amp;amp;include=%28%3Fi%29.*%28%3F%3C%21%5C.TMP%29&amp;amp;move=archive%2F%24%7Bdate%3Anow%3AyyyyMMdd%7D%2F%24%7Bfile%3Aonlyname%7D&amp;amp;moveFailed=failed%2F%24%7Bfile%3Aonlyname.noext%7D-%24%7Bdate%3Anow%3AyyyyMMddHHmmssSSS%7D.%24%7Bfile%3Aext%7D&lt;/a&gt;&lt;br/&gt;
2010-12-09 13:04:51,737 | INFO  | 1 - ShutdownTask | DefaultShutdownStrategy          | ultShutdownStrategy$ShutdownTask  422 | Waiting as there are still 1 inflight and pending exchanges to complete, timeout in 300 seconds.&lt;br/&gt;
2010-12-09 13:04:52,737 | INFO  | 1 - ShutdownTask | DefaultShutdownStrategy          | ultShutdownStrategy$ShutdownTask  422 | Waiting as there are still 1 inflight and pending exchanges to complete, timeout in 299 seconds.&lt;br/&gt;
2010-12-09 13:04:53,737 | INFO  | 1 - ShutdownTask | DefaultShutdownStrategy          | ultShutdownStrategy$ShutdownTask  422 | Waiting as there are still 1 inflight and pending exchanges to complete, timeout in 298 seconds.&lt;br/&gt;
...&lt;br/&gt;
2010-12-09 13:06:54,782 | INFO  | 1 - ShutdownTask | DefaultShutdownStrategy          | ultShutdownStrategy$ShutdownTask  422 | Waiting as there are still 1 inflight and pending exchanges to complete, timeout in 177 seconds.&lt;br/&gt;
2010-12-09 13:06:55,782 | INFO  | 1 - ShutdownTask | DefaultShutdownStrategy          | ultShutdownStrategy$ShutdownTask  442 | Route: route1 shutdown complete.&lt;br/&gt;
2010-12-09 13:06:55,782 | INFO  | FelixStartLevel  | DefaultShutdownStrategy          | mel.impl.DefaultShutdownStrategy  146 | Graceful shutdown of 1 routes completed in 124 seconds&lt;br/&gt;
2010-12-09 13:06:55,798 | INFO  | FelixStartLevel  | DefaultInflightRepository        | l.impl.DefaultInflightRepository   93 | Shutting down with no inflight exchanges.&lt;br/&gt;
2010-12-09 13:06:55,798 | INFO  | FelixStartLevel  | DefaultCamelContext              | e.camel.impl.DefaultCamelContext 1374 | Uptime: 2 minutes&lt;br/&gt;
2010-12-09 13:06:55,798 | INFO  | FelixStartLevel  | DefaultCamelContext              | e.camel.impl.DefaultCamelContext 1375 | Apache Camel 2.5.0 (CamelContext: Sample file transfer from file to file) is shutdown in 2 minutes&lt;br/&gt;
...&lt;/p&gt;

&lt;p&gt;But when Karaf is running as a service (I run on Windows XP SP 3) and stop the service from the control panel. Karaf, and therefore Camel, is abruptly killed. It looks like this:&lt;/p&gt;

&lt;p&gt;2010-12-09 12:36:11,103 | INFO  | FelixStartLevel  | DefaultShutdownStrategy          | mel.impl.DefaultShutdownStrategy  114 | Starting to graceful shutdown 1 routes (timeout 300 seconds)&lt;br/&gt;
2010-12-09 12:36:11,103 | INFO  | 4 - ShutdownTask | DefaultShutdownStrategy          | ultShutdownStrategy$ShutdownTask  383 | Route: route2 suspended and shutdown deferred, was consuming from: Endpoint&lt;a href=&quot;file://C:devKarafconnectcommon/data/interfaces/sample/file2file?delay=10000&amp;amp;include=%28%3Fi%29.*%28%3F%3C%21%5C.TMP%29&amp;amp;move=archive%2F%24%7Bdate%3Anow%3AyyyyMMdd%7D%2F%24%7Bfile%3Aonlyname%7D&amp;amp;moveFailed=failed%2F%24%7Bfile%3Aonlyname.noext%7D-%24%7Bdate%3Anow%3AyyyyMMddHHmmssSSS%7D.%24%7Bfile%3Aext%7D&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;file://C:\dev\Karaf\connect\common/data/interfaces/sample/file2file?delay=10000&amp;amp;include=%28%3Fi%29.*%28%3F%3C%21%5C.TMP%29&amp;amp;move=archive%2F%24%7Bdate%3Anow%3AyyyyMMdd%7D%2F%24%7Bfile%3Aonlyname%7D&amp;amp;moveFailed=failed%2F%24%7Bfile%3Aonlyname.noext%7D-%24%7Bdate%3Anow%3AyyyyMMddHHmmssSSS%7D.%24%7Bfile%3Aext%7D&lt;/a&gt;&lt;br/&gt;
2010-12-09 12:36:11,103 | INFO  | 4 - ShutdownTask | DefaultShutdownStrategy          | ultShutdownStrategy$ShutdownTask  422 | Waiting as there are still 1 inflight and pending exchanges to complete, timeout in 300 seconds.&lt;/p&gt;

&lt;p&gt;Nothing more is logged since the process is killed. I know that there is never a guarantee that Karaf will shutdown gracefully since the process might just die (e g out of power). But it would be nice if the control panel could be used for stopping the service since thats what most operations engineers do. There is always the option to log in to Karaf via SSH and issue the shutdown command before stopping the service but then it becomes too complicated for most people.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows XP SP 3&lt;/p&gt;</environment>
        <key id="12493042">KARAF-327</key>
            <summary>Graceful shutdown of Windows service, revisited</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="achim_nierbeck">Achim Nierbeck</assignee>
                                    <reporter username="rodehav">Bengt Rodehav</reporter>
                        <labels>
                    </labels>
                <created>Mon, 13 Dec 2010 08:19:07 +0000</created>
                <updated>Sat, 15 Sep 2018 05:24:12 +0000</updated>
                            <resolved>Thu, 6 Jan 2011 17:28:51 +0000</resolved>
                                    <version>2.1.2</version>
                                    <fixVersion>2.1.3</fixVersion>
                    <fixVersion>2.2.0</fixVersion>
                                    <component>karaf</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12971864" author="achim_nierbeck" created="Wed, 15 Dec 2010 22:08:09 +0000"  >&lt;p&gt;Just a possible solution I had in my mind: &lt;/p&gt;

&lt;p&gt;How about calling the main.destroy method with true and a optional parameter for a waiting timeout. Now if we let the &quot;Wrapper&quot;-Main register a callback method in the Main method we could call the WrapperManager.signalStopping with the same timeout.&lt;br/&gt;
I will try to fix it like this. &lt;/p&gt;</comment>
                            <comment id="12971984" author="gnt" created="Thu, 16 Dec 2010 07:12:55 +0000"  >&lt;p&gt;This looks like a good way to go.  I don&apos;t recall exactly how JSW works, but not waiting until the framework cleanly shuts down is certainly one cause of the problem.&lt;/p&gt;</comment>
                            <comment id="12972678" author="achim_nierbeck" created="Fri, 17 Dec 2010 22:40:59 +0000"  >&lt;p&gt;Fixed with revision 1050517&lt;/p&gt;</comment>
                            <comment id="12972930" author="pieber" created="Sun, 19 Dec 2010 08:04:27 +0000"  >&lt;p&gt;should be backported to karaf-2.1.x branch&lt;/p&gt;</comment>
                            <comment id="12972931" author="pieber" created="Sun, 19 Dec 2010 08:05:08 +0000"  >&lt;p&gt;Already fixed for trunk, should be backported to karaf-2.1.x branch&lt;/p&gt;</comment>
                            <comment id="12972945" author="rodehav" created="Sun, 19 Dec 2010 09:35:21 +0000"  >&lt;p&gt;Perfect. Will test as soon as possible. Do I have to configure anything (like timeouts) or do I just install Karaf as usual?&lt;/p&gt;</comment>
                            <comment id="12973038" author="achim_nierbeck" created="Sun, 19 Dec 2010 19:24:13 +0000"  >&lt;p&gt;Fixed for 2.1.3 on revision 1050938&lt;/p&gt;

&lt;p&gt;--------------------------------------------------&lt;/p&gt;

&lt;p&gt;Regarding the testing, no special configuration is needed right now. &lt;/p&gt;
</comment>
                            <comment id="12977168" author="rodehav" created="Tue, 4 Jan 2011 08:32:41 +0000"  >&lt;p&gt;Achim, &lt;/p&gt;

&lt;p&gt;Sorry for taking so long to test this. Just got back from christmas vacation and finally tried it out. &lt;/p&gt;

&lt;p&gt;However, I still get the exact same behaviour as before. I install Karaf as a service, I make sure that a Camel route has an inflight exchange and then I stop the service. I then expect the service to keep running until Camel gives up (just like the behaviour when running Karaf from the command line) but the service is stopped instantly. &lt;/p&gt;

&lt;p&gt;What am I doing wrong?&lt;/p&gt;</comment>
                            <comment id="12977178" author="rodehav" created="Tue, 4 Jan 2011 09:05:33 +0000"  >&lt;p&gt;I browsed through the source code and ended up in the class org.apache.karaf.shell.wrapper.Main. Seems like that&apos;s where all the action takes place ...&lt;/p&gt;

&lt;p&gt;If I correctly understand the code then the process is given 1,5 seconds to finish up before it is killed. Since the default Camel behaviour is to keep the process alive up to 300 s if there are any inflight exchanges that explains my problems. I guess I will have to do any of the following:&lt;/p&gt;

&lt;p&gt;a) Make sure that Camel&apos;s inflight timeout is less than Karaf&apos;s timeout. Would it be possible to make Karaf&apos;s exit timeout (currently hardcoded to 1 s) configurable?&lt;br/&gt;
b) Somehow configure Camel to shut down the routes as fast as possible if the service is about to stop.&lt;/p&gt;

&lt;p&gt;What I don&apos;t quite understand is why there is a difference in behaviour when running Karaf as a service compared to running Karaf from the command line. Intuitively I think that the behaviour should be the same. In the command line case, Karaf waits for Camel to finish (even up to 300 s) while in the service case there seems to be no connection between Camel&apos;s timeout (300 s) and Karaf&apos;s stop behaviour. Karaf terminates after 1,5 seconds regardless of what Camel does.&lt;/p&gt;

&lt;p&gt;Do you have any ideas of how this should be configured? Ideally I would like Karaf to wait for Camel no matter how Karaf was started.&lt;/p&gt;

</comment>
                            <comment id="12977186" author="achim_nierbeck" created="Tue, 4 Jan 2011 09:32:50 +0000"  >&lt;p&gt;I reopen it as I guess this didn&apos;t do the trick yet &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;could you please provide a Sample with camel so I can test this?&lt;br/&gt;
You are right, the action takes place in the class org.apache.karaf.shell.wrapper.Main. &lt;br/&gt;
My presumption was that I tell the framework to shut down and wait for it, now I would &lt;br/&gt;
have expected that the camel route can be safely be shut down. &lt;br/&gt;
The actual 1.5 seconds should be the waiting time added to the wrapper during looping. &lt;/p&gt;
</comment>
                            <comment id="12977204" author="rodehav" created="Tue, 4 Jan 2011 10:21:38 +0000"  >&lt;p&gt;It&apos;s not easy for me to provide a complete Camel sample for you since I have a pretty complex setup around the starting of camel routes.&lt;/p&gt;

&lt;p&gt;Basically I create a simple file copy route as follows:&lt;/p&gt;

&lt;p&gt;from(&quot;file:in&quot;).to(&quot;file:out&quot;);&lt;/p&gt;

&lt;p&gt;When I drop a file in the &quot;in&quot; directory, it is copied to the &quot;out&quot; directory. In order to force Camel to have an inflight exchange I configure the redelivery parameters and make sure that the &quot;to&quot; uri is invalid (thus forcing the route to attempt redelivery until it finally gives up). As follows:&lt;/p&gt;

&lt;p&gt;onException(Exception.class).maximumRedeliveries(10).delayPattern(&quot;0:2000;5:10000;10:60000;20:600000;25:1800000&quot;);&lt;br/&gt;
from(&quot;file:in&quot;).to(&quot;file:g:/out&quot;);&lt;/p&gt;

&lt;p&gt;Since I have no &quot;g:&quot; on my computer, Camel cannot copy the file but it will retry for a period of time while I stop the Karaf service (or shutdown Karaf with Ctrl-D from the command line).&lt;/p&gt;

&lt;p&gt;There are probably easier ways to force Camel to have an inflight exchange at the point of shutdown but this is the way I&apos;ve been testing it.&lt;/p&gt;</comment>
                            <comment id="12977988" author="achim_nierbeck" created="Wed, 5 Jan 2011 21:54:50 +0000"  >&lt;p&gt;The current version in Trunk should be better now, please verify it.&lt;br/&gt;
I tried to test it and it did seem to give more time for camel to do the stopping. &lt;br/&gt;
Please verify it. &lt;/p&gt;</comment>
                            <comment id="12978367" author="pieber" created="Thu, 6 Jan 2011 15:32:49 +0000"  >&lt;p&gt;@achim: please also backport your patch to karaf-2.1.x; it cherry-picks clearly&lt;/p&gt;</comment>
                            <comment id="12978372" author="gnt" created="Thu, 6 Jan 2011 15:42:09 +0000"  >&lt;p&gt;I&apos;m testing the fix and will commit a slightly modified version of it today (and backport it too for the release).&lt;/p&gt;</comment>
                            <comment id="12978410" author="achim_nierbeck" created="Thu, 6 Jan 2011 17:13:10 +0000"  >&lt;p&gt;I just wanted to have this fix verified before closing and applying to 2.1.x branch &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12978413" author="gnt" created="Thu, 6 Jan 2011 17:26:11 +0000"  >&lt;p&gt;Yeah, but I&apos;ve spotted a few other problems (like the wrapper does not know if someone calls osgi:shutdown).&lt;br/&gt;
I&apos;m commiting right now.&lt;/p&gt;</comment>
                            <comment id="12978414" author="gnt" created="Thu, 6 Jan 2011 17:28:51 +0000"  >&lt;p&gt;The wrapper shutdown seems to work great now in all the tests i&apos;ve done.&lt;/p&gt;</comment>
                            <comment id="12978668" author="achim_nierbeck" created="Fri, 7 Jan 2011 07:52:19 +0000"  >&lt;p&gt;Just a test camel route, &lt;br/&gt;
to test camel 2.5 needs to be installed. But make sure Spring 3.0.4 is installed. &lt;/p&gt;</comment>
                            <comment id="12978737" author="rodehav" created="Fri, 7 Jan 2011 11:00:54 +0000"  >&lt;p&gt;Sorry for taking so long to test this. I had great problems getting my application to run on Karaf 2.1.99-SNAPSHOT due to dependencies to different versions of Camel. Not sure why but I managed to get my camel routes up at last.&lt;/p&gt;

&lt;p&gt;It now works perfectly fine. When I stop the Windows service, it waits for my Camel route to finish first. Exactly the way I wanted it to work.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;/Bengt&lt;/p&gt;</comment>
                            <comment id="12978739" author="gnt" created="Fri, 7 Jan 2011 11:04:12 +0000"  >&lt;p&gt;The call to framework.stop() doesn&apos;t really wait for the framework to be shut down, but can block until a lock is acquired, so using a different thread makes sense.&lt;br/&gt;
Note that while testing, I found out that spring-dm has a built-in 10s timeout on shutting down spring-dm bundles, so the osgi framework won&apos;t wait for the camel route to be gracefully shutdown.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12472737">KARAF-176</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12467707" name="camel-route.xml" size="838" author="achim_nierbeck" created="Fri, 7 Jan 2011 07:52:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>40789</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 46 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ati7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>61053</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>