<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:13:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KARAF-5798] Karaf slave instance does not write pid or port file until it becomes master</title>
                <link>https://issues.apache.org/jira/browse/KARAF-5798</link>
                <project id="12311140" key="KARAF">Karaf</project>
                    <description>&lt;p&gt;In a Karaf master/slave environment, the slave process does not write its pid or port file until it acquires the lock and becomes the master.&lt;/p&gt;

&lt;p&gt;I am running Karaf 4.0.9 (ServiceMix 7.0.1).&lt;/p&gt;

&lt;p&gt;Karaf is configured as master/slave using the following from system.properties. Master and slave are on different physical nodes.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
karaf.lock=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
karaf.lock.class=org.apache.karaf.main.lock.OracleJDBCLock
karaf.lock.level=79
karaf.lock.delay=10000
karaf.lock.jdbc.url=jdbc:oracle:thin:#REMOVED#
karaf.lock.jdbc.driver=oracle.jdbc.driver.OracleDriver
karaf.lock.jdbc.user=#REMOVED#
karaf.lock.jdbc.password=#REMOVED#
karaf.lock.jdbc.table=KARAF_LOCK
karaf.lock.jdbc.clustername=karaf
karaf.lock.jdbc.timeout=30
karaf.lock.slave.block=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Attempting to stop the slave Karaf process results in &lt;em&gt;&quot;Can&apos;t connect to the container. The container is not running.&quot;&lt;/em&gt; This is not true, as a simple &lt;tt&gt;ps -ef | grep karaf&lt;/tt&gt; confirms that it is in fact running. I am able to enter the Karaf shell just fine, use the web console, etc.&lt;/p&gt;

&lt;p&gt;I have confirmed through multiple tests that the pid and port files don&apos;t get written until the master lock is acquired.&lt;/p&gt;

&lt;p&gt;Steps:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;With the Karaf slave node not started, note the pid and port files do not exist (or contain outdated values from a previous process).&lt;/li&gt;
	&lt;li&gt;Start the Karaf slave process.&lt;/li&gt;
	&lt;li&gt;Note that the pid and port files have not been written.&lt;/li&gt;
	&lt;li&gt;Stop the master process.&lt;/li&gt;
	&lt;li&gt;Observe the slave process acquire the lock and become master.&lt;/li&gt;
	&lt;li&gt;Note that the pid and port files have now been written.&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13169266">KARAF-5798</key>
            <summary>Karaf slave instance does not write pid or port file until it becomes master</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbonofre">Jean-Baptiste Onofr&#233;</assignee>
                                    <reporter username="mzipay">Matthew Zipay</reporter>
                        <labels>
                    </labels>
                <created>Fri, 29 Jun 2018 21:50:32 +0000</created>
                <updated>Thu, 13 Sep 2018 18:59:53 +0000</updated>
                            <resolved>Fri, 3 Aug 2018 09:53:27 +0000</resolved>
                                    <version>4.0.9</version>
                                    <fixVersion>4.1.6</fixVersion>
                    <fixVersion>4.2.1</fixVersion>
                                    <component>karaf</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16528301" author="mzipay" created="Fri, 29 Jun 2018 21:55:43 +0000"  >&lt;p&gt;I found this: &lt;a href=&quot;https://issues.jboss.org/browse/ENTESB-2417&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.jboss.org/browse/ENTESB-2417&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;ENTESB-2417 describes the same issue, though the workaround described does not work for me on ServiceMix 7.0.1 (Karaf 4.0.9).&lt;/p&gt;

&lt;p&gt;Here is the manual workaround that &lt;b&gt;&lt;em&gt;does&lt;/em&gt;&lt;/b&gt; work for me:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;After the Karaf slave process has started, use &lt;tt&gt;ps -ef | grep karaf&lt;/tt&gt; to acquire the Karaf process ID.&lt;/li&gt;
	&lt;li&gt;Use &lt;tt&gt;lsof -P -p $pid | grep LISTEN&lt;/tt&gt; to discover the shutdown port number.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;echo -n $pid &amp;gt; $KARAF_HOME/karaf.pid&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;echo -n $shutdownport &amp;gt; $KARAF_HOME/data/port&lt;/tt&gt;&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="16530029" author="mzipay" created="Mon, 2 Jul 2018 14:50:22 +0000"  >&lt;p&gt;I&apos;ve looked at org.apache.karaf.main.Main and org.apache.karaf.main.InstanceHelper and I believe I&apos;ve found the &quot;culprit&quot; -&lt;/p&gt;

&lt;p&gt;The &lt;em&gt;karaf.pid&lt;/em&gt; file does not get written until &lt;tt&gt;KarafLockCallback.lockAcquired&lt;/tt&gt; calls &lt;tt&gt;InstanceHelper.setupShutdown&lt;/tt&gt;, which in turn calls &lt;tt&gt;InstanceHelper.writePid&lt;/tt&gt;. This confirms my observations.&lt;/p&gt;

&lt;p&gt;But this seems nonsensical, as the pid is known well in advance. (&lt;tt&gt;Main.launch&lt;/tt&gt; actually writes the pid almost immediately to the &lt;em&gt;instance.properties&lt;/em&gt; file (via &lt;tt&gt;InstanceHelper.updateInstancePid&lt;/tt&gt;), so I can&apos;t see any reason why writing &lt;em&gt;karaf.pid&lt;/em&gt; would have to wait until lock acquisition.  (A &lt;a href=&quot;https://github.com/apache/karaf/search?q=pidFile+in%3Afile+language%3Ajava&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;search&lt;/a&gt; for &quot;pidFile&quot; in Kara&apos;fs GitHub repository yields nothing to suggest that &lt;tt&gt;ConfigProperties.pidFile&lt;/tt&gt; is used in any way to influence master/slave locking behavior.)&lt;/p&gt;

&lt;p&gt;On a side note, is there a reason why &lt;tt&gt;InstanceHelper.writePid&lt;/tt&gt; does not use &lt;tt&gt;InstanceHelper.getPid&lt;/tt&gt;? They both obtain the pid by extracting it from &lt;tt&gt;java.lang.management.RuntimeMXBean.getName&lt;/tt&gt;, but the former uses a regex while the latter uses substring &amp;amp; indexOf(&apos;@&apos;). I think &lt;tt&gt;getPid&lt;/tt&gt; should decide on one way to extract the pid and then be called from both &lt;tt&gt;updateInstancePid&lt;/tt&gt; and &lt;tt&gt;writePid&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16532825" author="gnt" created="Wed, 4 Jul 2018 14:23:12 +0000"  >&lt;p&gt;Currently, the &lt;tt&gt;InstanceService&lt;/tt&gt; does not have any knowledge about master/slave configurations.&lt;br/&gt;
So the pid written by &lt;tt&gt;InstanceHelper.updateInstancePid&lt;/tt&gt; should reflect the current running master, and that should be called after grabbing the lock, while the &lt;tt&gt;writePid&lt;/tt&gt; could be called sooner.&lt;br/&gt;
And I agree about the &lt;tt&gt;getPid&lt;/tt&gt; being called from both &lt;tt&gt;updateInstancePid&lt;/tt&gt; and &lt;tt&gt;writePid&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16533010" author="mzipay" created="Wed, 4 Jul 2018 18:53:05 +0000"  >&lt;p&gt;OK that is interesting... it actually happens the opposite way in both 4.0.9 and current (according to &lt;tt&gt;Main.launch&lt;/tt&gt;):&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;InstanceHelper.updateInstancePid&lt;/tt&gt; is called almost immediately, and writes an &lt;em&gt;instance.properties&lt;/em&gt; file on both the master and slave,&#160;while &lt;tt&gt;InstanceHelper.setupShutdown&lt;/tt&gt; (which calls &lt;tt&gt;InstanceHelper.writePid&lt;/tt&gt;) does not get called until the lock is acquired, and so only runs on the master.&lt;/p&gt;

&lt;p&gt;Are you saying this should be the other way around?&lt;/p&gt;</comment>
                            <comment id="16533032" author="mzipay" created="Wed, 4 Jul 2018 20:08:02 +0000"  >&lt;p&gt;&amp;gt;&amp;gt;&#160;So the pid written by&#160;&lt;tt&gt;InstanceHelper.updateInstancePid&lt;/tt&gt;&#160;should reflect the current running master&lt;/p&gt;

&lt;p&gt;This is problematic, I think. It would suffer from the same drawback that the pid and port files do - the slave instance would always have karaf.pid, port&#160;&lt;em&gt;and&lt;/em&gt;&#160;instance.properties files that contain incorrect values!&lt;/p&gt;

&lt;p&gt;That makes administration confusing at best, because now an administrator needs to&#160;inspect with &lt;tt&gt;ps&lt;/tt&gt; and &lt;tt&gt;lsof&lt;/tt&gt; to discover the correct values (and, of course, neither the status nor stop commands work until those values are corrected).&lt;/p&gt;

&lt;p&gt;To put this into context: I have a master/slave node pair running right now. The slave&apos;s karaf.pid file contains 19931. That is not correct. There is no process 19931 running on that host. The slave&apos;s port file contains 33415. That is also incorrect. There is nothing listening on port 33415 on that host. (These are values from a previous instance that is no longer running.) As a result, neither org.apache.karaf.main.Status nor org.apache.karaf.main.Stop&#160;work.&lt;/p&gt;

&lt;p&gt;If I stop the master instance, then the slave acquires the lock, becomes master, and the files get written with correct values. But I don&apos;t think this makes sense. The slave &lt;b&gt;is&lt;/b&gt; a running process. Why should its karaf.pid not reflect the correct value? Likewise, the slave &lt;b&gt;has&lt;/b&gt; a shutdown port - why should its port file not have the correct value?&lt;/p&gt;

&lt;p&gt;IMO, all three of these files should be written before lock acquisition is even attempted, because none of these values have anything to do with master/slave status - they are OS administration values that are needed to manage a JVM process.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16533163" author="mzipay" created="Thu, 5 Jul 2018 01:37:03 +0000"  >&lt;p&gt;Still testing, and I need to amend my workaround - it does &lt;b&gt;not&lt;/b&gt; work completely. Finding the process ID of the slave instance is easy enough, but I had assumed (incorrectly) that the listening port I saw through lsof was the shutdown port - it is something else.&lt;/p&gt;

&lt;p&gt;So I&apos;m back to looking at the lockAcquired callback and how it writes the pid and port files. My question now is:&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Why&lt;/em&gt;&#160;does Karaf wait until it is the master before it writes the pid file, starts the shutdown thread, and writes the port file?&lt;/p&gt;

&lt;p&gt;At least in the case of the pid file, this information is known by RuntimeMXBean well in advance of the instance grabbing the lock, so I still think that should be written even by a slave.&lt;/p&gt;

&lt;p&gt;Is there something &quot;special&quot; about the shutdown thread that would make it impossible or inadvisable for a slave to start it? It looks like it just listens for the shutdown command on a socket and calls &lt;tt&gt;Framework.stop()&lt;/tt&gt;...&#160;is that somehow problematic for a slave instance?&lt;/p&gt;</comment>
                            <comment id="16537552" author="githubbot" created="Mon, 9 Jul 2018 20:49:33 +0000"  >&lt;p&gt;mzipay opened a new pull request #542: &lt;a href=&quot;https://issues.apache.org/jira/browse/KARAF-5798&quot; title=&quot;Karaf slave instance does not write pid or port file until it becomes master&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KARAF-5798&quot;&gt;&lt;del&gt;KARAF-5798&lt;/del&gt;&lt;/a&gt; use a consistent way to get the Karaf process ID; write &#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/karaf/pull/542&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/karaf/pull/542&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &#8230;the pid file when the process launches so that it contains an accurate value for either a master or slave instance; only update the instance PID for the current running master (i.e. once lock is acquired)&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16537555" author="mzipay" created="Mon, 9 Jul 2018 20:50:40 +0000"  >&lt;p&gt;I have a fix tested against 4.2.1-SNAPSHOT that includes the following:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;consistent way to obtain the process ID&lt;/li&gt;
	&lt;li&gt;write the &lt;em&gt;karaf.pid&lt;/em&gt; file as soon as the process launches (so it is correct for either a master or slave instance)&lt;/li&gt;
	&lt;li&gt;new unit tests to verify that &lt;em&gt;karaf.pid&lt;/em&gt; gets written whether or not the lock is acquired&lt;/li&gt;
	&lt;li&gt;wait until lock acquisition before updating the instance PID (so it reflects the current running master)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;PR is &lt;a href=&quot;https://github.com/apache/karaf/pull/542&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/karaf/pull/542&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I need these changes specifically against Karaf 4.0.9, so I have also applied the same changes in a branch based on the 4.0.9 tag. Do you want that as a PR as well or no?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16548775" author="jbonofre" created="Thu, 19 Jul 2018 04:12:14 +0000"  >&lt;p&gt;I gonna review PR #542. No need of another PR for 4.0.x and 4.1.x, I will do the cherry pick.&lt;/p&gt;</comment>
                            <comment id="16549487" author="mzipay" created="Thu, 19 Jul 2018 16:23:43 +0000"  >&lt;p&gt;OK, thank you.&lt;/p&gt;</comment>
                            <comment id="16567998" author="githubbot" created="Fri, 3 Aug 2018 09:29:35 +0000"  >&lt;p&gt;jbonofre closed pull request #542: &lt;a href=&quot;https://issues.apache.org/jira/browse/KARAF-5798&quot; title=&quot;Karaf slave instance does not write pid or port file until it becomes master&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KARAF-5798&quot;&gt;&lt;del&gt;KARAF-5798&lt;/del&gt;&lt;/a&gt; use a consistent way to get the Karaf process ID; write &#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/karaf/pull/542&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/karaf/pull/542&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/main/src/main/java/org/apache/karaf/main/InstanceHelper.java b/main/src/main/java/org/apache/karaf/main/InstanceHelper.java&lt;br/&gt;
index 5cf5826fe8..8ea33be8fd 100644&lt;br/&gt;
&amp;#8212; a/main/src/main/java/org/apache/karaf/main/InstanceHelper.java&lt;br/&gt;
+++ b/main/src/main/java/org/apache/karaf/main/InstanceHelper.java&lt;br/&gt;
@@ -24,7 +24,6 @@&lt;br/&gt;
 import java.io.RandomAccessFile;&lt;br/&gt;
 import java.io.Writer;&lt;br/&gt;
 import java.lang.management.ManagementFactory;&lt;br/&gt;
-import java.lang.management.RuntimeMXBean;&lt;br/&gt;
 import java.net.InetAddress;&lt;br/&gt;
 import java.net.ServerSocket;&lt;br/&gt;
 import java.nio.channels.FileLock;&lt;br/&gt;
@@ -107,27 +106,26 @@ static void updateInstancePid(final File karafHome, final File karafBase, final&lt;br/&gt;
         }&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;+    /* &lt;a href=&quot;https://issues.apache.org/jira/browse/KARAF-5798&quot; title=&quot;Karaf slave instance does not write pid or port file until it becomes master&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KARAF-5798&quot;&gt;&lt;del&gt;KARAF-5798&lt;/del&gt;&lt;/a&gt;: consistent way to obtain the process ID */&lt;br/&gt;
     private static String getPid() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;String pid = ManagementFactory.getRuntimeMXBean().getName();&lt;/li&gt;
	&lt;li&gt;if (pid.indexOf(&apos;@&apos;) &amp;gt; 0) 
{
-            pid = pid.substring(0, pid.indexOf(&apos;@&apos;));
-        }&lt;/li&gt;
	&lt;li&gt;return pid;&lt;/li&gt;
	&lt;li&gt;}&lt;br/&gt;
+        String name = ManagementFactory.getRuntimeMXBean().getName();&lt;br/&gt;
+        /*&lt;br/&gt;
+         * RuntimeMXBean#getName() makes no guarantees about the name, so use a&lt;br/&gt;
+         * regex to match the common&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &quot;pid@host&quot; format&lt;br/&gt;
+         */&lt;br/&gt;
+        Pattern pattern = Pattern.compile(&quot;^(&lt;span class=&quot;error&quot;&gt;&amp;#91;0-9&amp;#93;&lt;/span&gt;&lt;ins&gt;)@.&lt;/ins&gt;$&quot;);&lt;br/&gt;
+        Matcher matcher = pattern.matcher(name);&lt;br/&gt;
+        return matcher.matches() ? matcher.group(1) : name;&lt;br/&gt;
+     }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static void writePid(String pidFile) {&lt;br/&gt;
+    /* &lt;a href=&quot;https://issues.apache.org/jira/browse/KARAF-5798&quot; title=&quot;Karaf slave instance does not write pid or port file until it becomes master&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KARAF-5798&quot;&gt;&lt;del&gt;KARAF-5798&lt;/del&gt;&lt;/a&gt;: now called by Main#launch() */&lt;br/&gt;
+    static void writePid(String pidFile) {&lt;br/&gt;
         try {&lt;br/&gt;
             if (pidFile != null) {&lt;/li&gt;
	&lt;li&gt;RuntimeMXBean rtb = ManagementFactory.getRuntimeMXBean();&lt;/li&gt;
	&lt;li&gt;String processName = rtb.getName();&lt;/li&gt;
	&lt;li&gt;Pattern pattern = Pattern.compile(&quot;^(&lt;span class=&quot;error&quot;&gt;&amp;#91;0-9&amp;#93;&lt;/span&gt;&lt;ins&gt;)@.&lt;/ins&gt;$&quot;, Pattern.CASE_INSENSITIVE);&lt;/li&gt;
	&lt;li&gt;Matcher matcher = pattern.matcher(processName);&lt;/li&gt;
	&lt;li&gt;if (matcher.matches()) 
{
-                    int pid = Integer.parseInt(matcher.group(1));
-                    Writer w = new OutputStreamWriter(new FileOutputStream(pidFile));
-                    w.write(Integer.toString(pid));
-                    w.close();
-                }
&lt;p&gt;+                int pid = Integer.parseInt(getPid());&lt;br/&gt;
+                Writer w = new OutputStreamWriter(new FileOutputStream(pidFile));&lt;br/&gt;
+                w.write(Integer.toString(pid));&lt;br/&gt;
+                w.close();&lt;br/&gt;
             }&lt;br/&gt;
         } catch (Exception e) {&lt;br/&gt;
             e.printStackTrace();&lt;br/&gt;
@@ -135,7 +133,6 @@ private static void writePid(String pidFile) {&lt;br/&gt;
     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     static AutoCloseable setupShutdown(ConfigProperties config, Framework framework) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;writePid(config.pidFile);&lt;br/&gt;
         try {&lt;br/&gt;
             int port = config.shutdownPort;&lt;br/&gt;
             String host = config.shutdownHost;&lt;br/&gt;
diff --git a/main/src/main/java/org/apache/karaf/main/Main.java b/main/src/main/java/org/apache/karaf/main/Main.java&lt;br/&gt;
index 2d80607c03..09c4a9535f 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/main/src/main/java/org/apache/karaf/main/Main.java&lt;br/&gt;
+++ b/main/src/main/java/org/apache/karaf/main/Main.java&lt;br/&gt;
@@ -239,7 +239,8 @@ public void launch() throws Exception {&lt;br/&gt;
         }&lt;br/&gt;
         String log4jConfigPath = System.getProperty(&quot;karaf.etc&quot;) + &quot;/org.ops4j.pax.logging.cfg&quot;;&lt;br/&gt;
         BootstrapLogManager.setProperties(config.props, log4jConfigPath);&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;InstanceHelper.updateInstancePid(config.karafHome, config.karafBase, true);&lt;br/&gt;
+        /* &lt;a href=&quot;https://issues.apache.org/jira/browse/KARAF-5798&quot; title=&quot;Karaf slave instance does not write pid or port file until it becomes master&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KARAF-5798&quot;&gt;&lt;del&gt;KARAF-5798&lt;/del&gt;&lt;/a&gt;: write the PID whether or not the lock has been acquired */&lt;br/&gt;
+        InstanceHelper.writePid(config.pidFile);&lt;br/&gt;
         BootstrapLogManager.configureLogger(LOG);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         for (String provider : config.securityProviders) {&lt;br/&gt;
@@ -746,6 +747,8 @@ public void stopShutdownThread() {&lt;br/&gt;
         @Override&lt;br/&gt;
         public void lockAcquired() &lt;/p&gt;
{
             LOG.info(&quot;Lock acquired. Setting startlevel to &quot; + config.defaultStartLevel);
+            /* KARAF-5798: instance PID should reflect the current running master */
+            InstanceHelper.updateInstancePid(config.karafHome, config.karafBase, true);
             shutdownThread = InstanceHelper.setupShutdown(config, framework);
             setStartLevel(config.defaultStartLevel);
         }
&lt;p&gt;diff --git a/main/src/test/java/org/apache/karaf/main/MainLockingTest.java b/main/src/test/java/org/apache/karaf/main/MainLockingTest.java&lt;br/&gt;
index 78d5a328b4..46585ec288 100644&lt;br/&gt;
&amp;#8212; a/main/src/test/java/org/apache/karaf/main/MainLockingTest.java&lt;br/&gt;
+++ b/main/src/test/java/org/apache/karaf/main/MainLockingTest.java&lt;br/&gt;
@@ -21,9 +21,12 @@&lt;br/&gt;
 import static org.ops4j.pax.tinybundles.core.TinyBundles.withBnd;&lt;/p&gt;

&lt;p&gt; import java.io.File;&lt;br/&gt;
+import java.io.IOException;&lt;/p&gt;

&lt;p&gt; import org.apache.karaf.main.util.Utils;&lt;br/&gt;
+import org.junit.After;&lt;br/&gt;
 import org.junit.Assert;&lt;br/&gt;
+import org.junit.Before;&lt;br/&gt;
 import org.junit.Test;&lt;br/&gt;
 import org.ops4j.pax.tinybundles.core.TinyBundles;&lt;br/&gt;
 import org.osgi.framework.Bundle;&lt;br/&gt;
@@ -32,24 +35,36 @@&lt;br/&gt;
 import org.osgi.framework.startlevel.FrameworkStartLevel;&lt;/p&gt;

&lt;p&gt; public class MainLockingTest {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;/li&gt;
	&lt;li&gt;@Test&lt;/li&gt;
	&lt;li&gt;public void testLostMasterLock() throws Exception {&lt;br/&gt;
+    private File home;&lt;br/&gt;
+&lt;br/&gt;
+    private File data;&lt;br/&gt;
+&lt;br/&gt;
+    @Before&lt;br/&gt;
+    public void setUp() throws IOException 
{
         File basedir = new File(getClass().getClassLoader().getResource(&quot;foo&quot;).getPath()).getParentFile();
-        File home = new File(basedir, &quot;test-karaf-home&quot;);
-        File data = new File(home, &quot;data&quot;);
+        home = new File(basedir, &quot;test-karaf-home&quot;);
+        data = new File(home, &quot;data&quot;);
 
         Utils.deleteDirectory(data);
 
-        String[] args = new String[0];
         System.setProperty(&quot;karaf.home&quot;, home.toString());
         System.setProperty(&quot;karaf.data&quot;, data.toString());
         System.setProperty(&quot;karaf.framework.factory&quot;, &quot;org.apache.felix.framework.FrameworkFactory&quot;);
 
-        System.setProperty(&quot;karaf.lock&quot;,&quot;true&quot;);
-        System.setProperty(&quot;karaf.lock.delay&quot;,&quot;1000&quot;);
-        System.setProperty(&quot;karaf.lock.class&quot;,&quot;org.apache.karaf.main.MockLock&quot;);
+        System.setProperty(&quot;karaf.lock&quot;, &quot;true&quot;);
+        System.setProperty(&quot;karaf.lock.delay&quot;, &quot;1000&quot;);
+        System.setProperty(&quot;karaf.lock.class&quot;, &quot;org.apache.karaf.main.MockLock&quot;);
+    }
&lt;p&gt;+&lt;br/&gt;
+    @After&lt;br/&gt;
+    public void tearDown() &lt;/p&gt;
{
+        home = null;
+        data = null;
+    }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    @Test&lt;br/&gt;
+    public void testLostMasterLock() throws Exception {&lt;br/&gt;
+        String[] args = new String&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;;&lt;br/&gt;
         Main main = new Main(args);&lt;br/&gt;
         main.launch();&lt;br/&gt;
         Framework framework = main.getFramework();&lt;br/&gt;
@@ -89,4 +104,72 @@ public void testLostMasterLock() throws Exception &lt;/p&gt;
{
         // exit framework + lock loop
         main.destroy();
     }
&lt;p&gt;    &lt;br/&gt;
+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testMasterWritesPid() throws Exception {&lt;br/&gt;
+        // use data because it&apos;s always deleted at the beginning of the test&lt;br/&gt;
+        File pidFile = new File(data, &quot;test-karaf.pid&quot;);&lt;br/&gt;
+        System.setProperty(&quot;karaf.pid.file&quot;, pidFile.toString());&lt;br/&gt;
+&lt;br/&gt;
+        try &lt;/p&gt;
{
+            Assert.assertFalse(pidFile.isFile());
+
+            String[] args = new String[0];
+            Main main = new Main(args);
+            main.launch();
+
+            Thread.sleep(1000);
+
+            Framework framework = main.getFramework();
+            FrameworkStartLevel sl = framework.adapt(FrameworkStartLevel.class);
+            Assert.assertEquals(100, sl.getStartLevel());
+
+            MockLock lock = (MockLock) main.getLock();
+
+            Assert.assertTrue(lock.lock());
+            Assert.assertTrue(lock.isAlive());
+            Assert.assertTrue(pidFile.isFile());
+
+            main.destroy();
+        }
&lt;p&gt; finally &lt;/p&gt;
{
+            System.clearProperty(&quot;karaf.pid.file&quot;);
+        }
&lt;p&gt;+    }&lt;br/&gt;
+&lt;br/&gt;
+    @Test&lt;br/&gt;
+    public void testSlaveWritesPid() throws Exception {&lt;br/&gt;
+        // simulate that the lock is not acquired (i.e. instance runs as slave)&lt;br/&gt;
+        System.setProperty(&quot;test.karaf.mocklock.initiallyLocked&quot;, &quot;false&quot;);&lt;br/&gt;
+        System.setProperty(&quot;karaf.lock.level&quot;, &quot;59&quot;);&lt;br/&gt;
+&lt;br/&gt;
+        // use data because it&apos;s always deleted at the beginning of the test&lt;br/&gt;
+        File pidFile = new File(data, &quot;test-karaf.pid&quot;);&lt;br/&gt;
+        System.setProperty(&quot;karaf.pid.file&quot;, pidFile.toString());&lt;br/&gt;
+&lt;br/&gt;
+        try &lt;/p&gt;
{
+            Assert.assertFalse(pidFile.isFile());
+
+            String[] args = new String[0];
+            Main main = new Main(args);
+            main.launch();
+
+            Thread.sleep(1000);
+
+            Framework framework = main.getFramework();
+            FrameworkStartLevel sl = framework.adapt(FrameworkStartLevel.class);
+            Assert.assertEquals(59, sl.getStartLevel());
+
+            MockLock lock = (MockLock) main.getLock();
+
+            Assert.assertFalse(lock.lock());
+            Assert.assertTrue(lock.isAlive());
+            Assert.assertTrue(pidFile.isFile());
+
+            main.destroy();
+        }
&lt;p&gt; finally &lt;/p&gt;
{
+            System.clearProperty(&quot;test.karaf.mocklock.initiallyLocked&quot;);
+            System.clearProperty(&quot;karaf.lock.level&quot;);
+            System.clearProperty(&quot;karaf.pid.file&quot;);
+        }
&lt;p&gt;+    }&lt;br/&gt;
 }&lt;br/&gt;
diff --git a/main/src/test/java/org/apache/karaf/main/MockLock.java b/main/src/test/java/org/apache/karaf/main/MockLock.java&lt;br/&gt;
index e2ac2b25fa..13b7564cb4 100644&lt;br/&gt;
&amp;#8212; a/main/src/test/java/org/apache/karaf/main/MockLock.java&lt;br/&gt;
+++ b/main/src/test/java/org/apache/karaf/main/MockLock.java&lt;br/&gt;
@@ -31,6 +31,8 @@&lt;br/&gt;
     private Object lockLock = new Object();&lt;/p&gt;

&lt;p&gt;     public MockLock(Properties props) &lt;/p&gt;
{
+        /* KARAF-5798: allow tests to simulate slave instances */
+        lock = Boolean.valueOf(System.getProperty(&quot;test.karaf.mocklock.initiallyLocked&quot;, &quot;true&quot;));
     }

&lt;p&gt;     public boolean lock() throws Exception {&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16567999" author="jira-bot" created="Fri, 3 Aug 2018 09:29:36 +0000"  >&lt;p&gt;Commit efa4ffdc420a318d9c926dabd2357ce958a1ffb3 in karaf&apos;s branch refs/heads/master from Zipay, Matthew&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=karaf.git;h=efa4ffd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=karaf.git;h=efa4ffd&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KARAF-5798&quot; title=&quot;Karaf slave instance does not write pid or port file until it becomes master&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KARAF-5798&quot;&gt;&lt;del&gt;KARAF-5798&lt;/del&gt;&lt;/a&gt; use a consistent way to get the Karaf process ID; write the pid file when the process launches so that it contains an accurate value for either a master or slave instance; only update the instance PID for the current running master (i.e. once lock is acquired)&lt;/p&gt;</comment>
                            <comment id="16568000" author="jira-bot" created="Fri, 3 Aug 2018 09:29:38 +0000"  >&lt;p&gt;Commit 77d11a601be54b2627fa86819256f5295c01e1ae in karaf&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jb%40nanthrax.net&quot; class=&quot;user-hover&quot; rel=&quot;jb@nanthrax.net&quot;&gt;jb@nanthrax.net&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=karaf.git;h=77d11a6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=karaf.git;h=77d11a6&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Merge pull request #542 from mzipay/&lt;a href=&quot;https://issues.apache.org/jira/browse/KARAF-5798&quot; title=&quot;Karaf slave instance does not write pid or port file until it becomes master&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KARAF-5798&quot;&gt;&lt;del&gt;KARAF-5798&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KARAF-5798&quot; title=&quot;Karaf slave instance does not write pid or port file until it becomes master&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KARAF-5798&quot;&gt;&lt;del&gt;KARAF-5798&lt;/del&gt;&lt;/a&gt; use a consistent way to get the Karaf process ID; write &#8230;&lt;/p&gt;</comment>
                            <comment id="16568001" author="jira-bot" created="Fri, 3 Aug 2018 09:29:40 +0000"  >&lt;p&gt;Commit 77d11a601be54b2627fa86819256f5295c01e1ae in karaf&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jb%40nanthrax.net&quot; class=&quot;user-hover&quot; rel=&quot;jb@nanthrax.net&quot;&gt;jb@nanthrax.net&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=karaf.git;h=77d11a6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=karaf.git;h=77d11a6&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;Merge pull request #542 from mzipay/&lt;a href=&quot;https://issues.apache.org/jira/browse/KARAF-5798&quot; title=&quot;Karaf slave instance does not write pid or port file until it becomes master&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KARAF-5798&quot;&gt;&lt;del&gt;KARAF-5798&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KARAF-5798&quot; title=&quot;Karaf slave instance does not write pid or port file until it becomes master&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KARAF-5798&quot;&gt;&lt;del&gt;KARAF-5798&lt;/del&gt;&lt;/a&gt; use a consistent way to get the Karaf process ID; write &#8230;&lt;/p&gt;</comment>
                            <comment id="16568028" author="jira-bot" created="Fri, 3 Aug 2018 09:53:23 +0000"  >&lt;p&gt;Commit 796cba8aa09d115d6bbd806f6f76ef6aa9b755ad in karaf&apos;s branch refs/heads/karaf-4.1.x from Zipay, Matthew&lt;br/&gt;
[ &lt;a href=&quot;https://gitbox.apache.org/repos/asf?p=karaf.git;h=796cba8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gitbox.apache.org/repos/asf?p=karaf.git;h=796cba8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KARAF-5798&quot; title=&quot;Karaf slave instance does not write pid or port file until it becomes master&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KARAF-5798&quot;&gt;&lt;del&gt;KARAF-5798&lt;/del&gt;&lt;/a&gt; use a consistent way to get the Karaf process ID; write the pid file when the process launches so that it contains an accurate value for either a master or slave instance; only update the instance PID for the current running master (i.e. once lock is acquired)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 15 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3vekn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>