<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:13:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[KARAF-5315] Race condition during shutdown using SIGTERM</title>
                <link>https://issues.apache.org/jira/browse/KARAF-5315</link>
                <project id="12311140" key="KARAF">Karaf</project>
                    <description>&lt;p&gt;During shutdown using SIGTERM there is a race condition.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Error occurred shutting down framework: java.nio.channels.ClosedChannelException
java.nio.channels.ClosedChannelException
         at sun.nio.ch.FileLockImpl.release(FileLockImpl.java:58)
         at org.apache.karaf.main.lock.SimpleFileLock.release(SimpleFileLock.java:78)
         at org.apache.karaf.main.Main.destroy(Main.java:642)
         at org.apache.karaf.main.Main.main(Main.java:188)
Main process exited, code=exited, status=254
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are several problems in the code of the Main class.&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;The variable indicating the exit condition ( private boolean exiting; line 89) used in several threads is not volatile.&lt;/li&gt;
	&lt;li&gt;The same is true for the lock (private Lock lock; line 87).&lt;/li&gt;
	&lt;li&gt;The signal handler calls Main.this.destroy(); which is called by the main thread again after leaving function awaitShutdown() (line 581)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Because the destroy() function releases the lock in the finally block the lock is released twice. The used implementation is the SimpleFileLock. In there the release() function is not synchronized. Since the channel of the file-lock is closed the second call will result in the exception.&lt;/p&gt;

&lt;p&gt;To get rid of the double release the SimpleFileLock.release() function should be synchronized. But I am not sure if the double call of the Main.destroy() function is an even bigger problem because all activators are stopped twice too.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (timeout &amp;gt; 0) {
                timeout -= step;
                FrameworkEvent event = framework.waitForStop(step);
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (event.getType() != FrameworkEvent.WAIT_TIMEDOUT) {
                    activatorManager.stopKarafActivators();
                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
                }
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Maybe synchronizing the Main.destroy() function is a good idea too or find a different way to have the signal handler stopping the framework by just signaling the stop and waking up the main thread ....&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux using systemd&lt;/p&gt;</environment>
        <key id="13096356">KARAF-5315</key>
            <summary>Race condition during shutdown using SIGTERM</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbonofre">Jean-Baptiste Onofr&#233;</assignee>
                                    <reporter username="martin.krueger">Martin Kr&#252;ger</reporter>
                        <labels>
                    </labels>
                <created>Mon, 21 Aug 2017 07:04:01 +0000</created>
                <updated>Mon, 17 Dec 2018 08:04:59 +0000</updated>
                            <resolved>Wed, 20 Sep 2017 11:18:44 +0000</resolved>
                                    <version>4.0.9</version>
                                    <fixVersion>4.0.10</fixVersion>
                    <fixVersion>4.1.3</fixVersion>
                    <fixVersion>4.2.0.M1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16134961" author="martin.krueger" created="Mon, 21 Aug 2017 09:47:18 +0000"  >&lt;p&gt;Please have a look at the patches. Maybe you find it useful.&lt;/p&gt;</comment>
                            <comment id="16169772" author="githubbot" created="Mon, 18 Sep 2017 09:00:07 +0000"  >&lt;p&gt;GitHub user jbonofre opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/karaf/pull/374&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/karaf/pull/374&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KARAF-5315&quot; title=&quot;Race condition during shutdown using SIGTERM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KARAF-5315&quot;&gt;&lt;del&gt;KARAF-5315&lt;/del&gt;&lt;/a&gt; Synchronize lock methods&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jbonofre/karaf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jbonofre/karaf&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/KARAF-5315&quot; title=&quot;Race condition during shutdown using SIGTERM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KARAF-5315&quot;&gt;&lt;del&gt;KARAF-5315&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/karaf/pull/374.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/karaf/pull/374.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #374&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 9e9a97c5a46b84d239bfbe6841ed6efe37ea8993&lt;br/&gt;
Author: Jean-Baptiste Onofr&#233; &amp;lt;jbonofre@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-09-18T08:51:37Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/KARAF-5315&quot; title=&quot;Race condition during shutdown using SIGTERM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KARAF-5315&quot;&gt;&lt;del&gt;KARAF-5315&lt;/del&gt;&lt;/a&gt; Synchronize lock methods&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16171730" author="jira-bot" created="Tue, 19 Sep 2017 13:55:00 +0000"  >&lt;p&gt;Commit 5761abf97fe6b010b40e2764d9eec6f3fcdd8875 in karaf&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbonofre&quot; class=&quot;user-hover&quot; rel=&quot;jbonofre&quot;&gt;jbonofre&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=karaf.git;h=5761abf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=karaf.git;h=5761abf&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KARAF-5315&quot; title=&quot;Race condition during shutdown using SIGTERM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KARAF-5315&quot;&gt;&lt;del&gt;KARAF-5315&lt;/del&gt;&lt;/a&gt; Synchronize lock methods&lt;/p&gt;</comment>
                            <comment id="16171731" author="jira-bot" created="Tue, 19 Sep 2017 13:55:02 +0000"  >&lt;p&gt;Commit 8b02711e40ae4b90ce61ea90dc982ed4c1f1370c in karaf&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbonofre&quot; class=&quot;user-hover&quot; rel=&quot;jbonofre&quot;&gt;jbonofre&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=karaf.git;h=8b02711&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=karaf.git;h=8b02711&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KARAF-5315&quot; title=&quot;Race condition during shutdown using SIGTERM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KARAF-5315&quot;&gt;&lt;del&gt;KARAF-5315&lt;/del&gt;&lt;/a&gt; This closes #374&lt;/p&gt;</comment>
                            <comment id="16171733" author="githubbot" created="Tue, 19 Sep 2017 13:55:13 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/karaf/pull/374&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/karaf/pull/374&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16172854" author="jira-bot" created="Wed, 20 Sep 2017 07:29:21 +0000"  >&lt;p&gt;Commit b02e7eb569c889b0c6e6f2f4ff360b25dab1cbcb in karaf&apos;s branch refs/heads/karaf-4.1.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbonofre&quot; class=&quot;user-hover&quot; rel=&quot;jbonofre&quot;&gt;jbonofre&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=karaf.git;h=b02e7eb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=karaf.git;h=b02e7eb&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KARAF-5315&quot; title=&quot;Race condition during shutdown using SIGTERM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KARAF-5315&quot;&gt;&lt;del&gt;KARAF-5315&lt;/del&gt;&lt;/a&gt; Synchronize lock methods&lt;/p&gt;</comment>
                            <comment id="16172928" author="jira-bot" created="Wed, 20 Sep 2017 09:03:41 +0000"  >&lt;p&gt;Commit 00c1d82f9cc3fa567396146318d44736db8112ff in karaf&apos;s branch refs/heads/karaf-4.0.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbonofre&quot; class=&quot;user-hover&quot; rel=&quot;jbonofre&quot;&gt;jbonofre&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=karaf.git;h=00c1d82&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=karaf.git;h=00c1d82&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KARAF-5315&quot; title=&quot;Race condition during shutdown using SIGTERM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KARAF-5315&quot;&gt;&lt;del&gt;KARAF-5315&lt;/del&gt;&lt;/a&gt; Avoid race condition during SIGTERM&lt;/p&gt;</comment>
                            <comment id="16172933" author="jira-bot" created="Wed, 20 Sep 2017 09:06:51 +0000"  >&lt;p&gt;Commit d3b3d3f363afe6e3a4b10c191b89c16b51d3c548 in karaf&apos;s branch refs/heads/karaf-4.1.x from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbonofre&quot; class=&quot;user-hover&quot; rel=&quot;jbonofre&quot;&gt;jbonofre&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=karaf.git;h=d3b3d3f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=karaf.git;h=d3b3d3f&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KARAF-5315&quot; title=&quot;Race condition during shutdown using SIGTERM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KARAF-5315&quot;&gt;&lt;del&gt;KARAF-5315&lt;/del&gt;&lt;/a&gt; Synchronize lock release method&lt;/p&gt;</comment>
                            <comment id="16172938" author="jira-bot" created="Wed, 20 Sep 2017 09:10:57 +0000"  >&lt;p&gt;Commit 2e99ce8f6efecf51dc47b11544073319a016ad66 in karaf&apos;s branch refs/heads/master from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbonofre&quot; class=&quot;user-hover&quot; rel=&quot;jbonofre&quot;&gt;jbonofre&lt;/a&gt;&lt;br/&gt;
[ &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=karaf.git;h=2e99ce8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=karaf.git;h=2e99ce8&lt;/a&gt; ]&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/KARAF-5315&quot; title=&quot;Race condition during shutdown using SIGTERM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;KARAF-5315&quot;&gt;&lt;del&gt;KARAF-5315&lt;/del&gt;&lt;/a&gt; Improve Main to deal with SIGTERM&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12882847" name="0001-KARAF-5315-Synchronize-access-to-SimpleFileLock.patch" size="2620" author="martin.krueger" created="Mon, 21 Aug 2017 09:46:56 +0000"/>
                            <attachment id="12882846" name="0002-KARAF-5315-Signal-handler-stops-framework-directly.patch" size="4133" author="martin.krueger" created="Mon, 21 Aug 2017 09:46:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 8 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3j2tj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>