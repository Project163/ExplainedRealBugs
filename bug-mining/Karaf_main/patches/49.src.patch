diff --git a/main/pom.xml b/main/pom.xml
index 4dcebbb05b..ad17acd349 100644
--- a/main/pom.xml
+++ b/main/pom.xml
@@ -61,6 +61,10 @@
             <version>1.1.1</version>
             <scope>test</scope>
         </dependency>
+        <dependency>
+            <groupId>org.apache.karaf</groupId>
+            <artifactId>org.apache.karaf.util</artifactId>
+        </dependency>
     </dependencies>
 
     <build>
@@ -99,8 +103,14 @@
                             org.apache.karaf.info
                         </Export-Package>
                         <Private-Package>
-                            org.apache.karaf.main*
+                            org.apache.karaf.main*,
+                            org.apache.felix.*;-split-package:=merge-first,
+                            org.apache.karaf.util.*;-split-package:=merge-first,
+                            org.eclipse.*;-split-package:=merge-first,
+                            org.osgi.*;-split-package:=merge-first,
+                            META-INF;-split-package:=merge-first
                         </Private-Package>
+                        <Import-Package>!*</Import-Package>
                     </instructions>
                     <unpackBundle>true</unpackBundle>
                 </configuration>
diff --git a/main/src/main/java/org/apache/karaf/main/InstanceHelper.java b/main/src/main/java/org/apache/karaf/main/InstanceHelper.java
index e8aca8fdd8..93f3d2cb0d 100644
--- a/main/src/main/java/org/apache/karaf/main/InstanceHelper.java
+++ b/main/src/main/java/org/apache/karaf/main/InstanceHelper.java
@@ -21,6 +21,7 @@ package org.apache.karaf.main;
 import java.io.File;
 import java.io.FileInputStream;
 import java.io.FileOutputStream;
+import java.io.IOException;
 import java.io.OutputStreamWriter;
 import java.io.Writer;
 import java.lang.management.ManagementFactory;
@@ -31,19 +32,17 @@ import java.util.Properties;
 import java.util.regex.Matcher;
 import java.util.regex.Pattern;
 
+import org.apache.karaf.util.properties.FileLockUtils;
 import org.osgi.framework.launch.Framework;
 
 public class InstanceHelper {
 
-    static void updateInstancePid(File karafHome, File karafBase) {
+    static void updateInstancePid(final File karafHome, File karafBase) {
         try {
-            String instanceName = System.getProperty("karaf.name");
-            String pid = ManagementFactory.getRuntimeMXBean().getName();
-            if (pid.indexOf('@') > 0) {
-                pid = pid.substring(0, pid.indexOf('@'));
-            }
-            
-            boolean isRoot = karafHome.equals(karafBase);
+            final String instanceName = System.getProperty("karaf.name");
+            final String pid = getPid();
+
+            final boolean isRoot = karafHome.equals(karafBase);
             
             if (instanceName != null) {
                 String storage = System.getProperty("karaf.instances");
@@ -52,63 +51,69 @@ public class InstanceHelper {
                         "This property needs to be set to the full path of the instance.properties file.");
                 }
                 File storageFile = new File(storage);
-                File propertiesFile = new File(storageFile, "instance.properties");
-                Properties props = new Properties();
-                if (propertiesFile.exists()) {
-                    FileInputStream fis = new FileInputStream(propertiesFile);
-                    props.load(fis);
-                    int count = Integer.parseInt(props.getProperty("count"));                   
-                    
-                    // update root name if karaf.name got updated since the last container start
-                    if (isRoot) {
-                        for (int i = 0; i < count; i++) {
-                            //looking for root instance entry
-                            String name = props.getProperty("item." + i + ".name");
-                            boolean root = Boolean.parseBoolean(props.getProperty("item." + i + ".root", "false"));
-                            if (name != null && root && !name.equals(instanceName)) {
-                                props.setProperty("item." + i + ".name", instanceName);
-                            }
+                final File propertiesFile = new File(storageFile, "instance.properties");
+                if (!propertiesFile.getParentFile().exists()) {
+                    try {
+                        if (!propertiesFile.getParentFile().mkdirs()) {
+                            throw new Exception("Unable to create directory " + propertiesFile.getParentFile());
                         }
+                    } catch (SecurityException se) {
+                        throw new Exception(se.getMessage());
                     }
-                    
-                    for (int i = 0; i < count; i++) {
-                        String name = props.getProperty("item." + i + ".name");
-                        if (name.equals(instanceName)) {
-                            props.setProperty("item." + i + ".pid", pid);
-                            FileOutputStream fos = new FileOutputStream(propertiesFile);
-                            props.store(fos, null);
-                            fis.close();
-                            fos.close();
-                            return;
-                        }
-                    }
-                    fis.close();
-                    if (!isRoot) {
-                        throw new Exception("Instance " + instanceName + " not found");
-                    } 
-                } else if (isRoot) {
-                    if (!propertiesFile.getParentFile().exists()) {
-                        try {
-                            propertiesFile.getParentFile().mkdirs();
-                        } catch (SecurityException se) {
-                            throw new Exception(se.getMessage());
+                }
+                FileLockUtils.execute(propertiesFile, new FileLockUtils.RunnableWithProperties() {
+                    public void run(org.apache.felix.utils.properties.Properties props) throws IOException {
+                        if (props.isEmpty()) {
+                            if (isRoot) {
+                                props.setProperty("count", "1");
+                                props.setProperty("item.0.name", instanceName);
+                                props.setProperty("item.0.loc", karafHome.getAbsolutePath());
+                                props.setProperty("item.0.pid", pid);
+                                props.setProperty("item.0.root", "true");
+                            } else {
+                                throw new IllegalStateException("Child instance started but no root registered in " + propertiesFile);
+                            }
+                        } else {
+                            int count = Integer.parseInt(props.getProperty("count"));
+                            // update root name if karaf.name got updated since the last container start
+                            if (isRoot) {
+                                for (int i = 0; i < count; i++) {
+                                    //looking for root instance entry
+                                    boolean root = Boolean.parseBoolean(props.getProperty("item." + i + ".root", "false"));
+                                    if (root) {
+                                        props.setProperty("item." + i + ".name", instanceName);
+                                        props.setProperty("item." + i + ".pid", pid);
+                                        return;
+                                    }
+                                }
+                                throw new IllegalStateException("Unable to find root instance in " + propertiesFile);
+                            } else {
+                                for (int i = 0; i < count; i++) {
+                                    String name = props.getProperty("item." + i + ".name");
+                                    if (name.equals(instanceName)) {
+                                        props.setProperty("item." + i + ".pid", pid);
+                                        return;
+                                    }
+                                }
+                                throw new IllegalStateException("Unable to find instance '" + instanceName + "'in " + propertiesFile);
+                            }
                         }
                     }
-                    props.setProperty("count", "1");
-                    props.setProperty("item.0.name", instanceName);
-                    props.setProperty("item.0.loc", karafHome.getAbsolutePath());
-                    props.setProperty("item.0.pid", pid);
-                    props.setProperty("item.0.root", "true");
-                    FileOutputStream fos = new FileOutputStream(propertiesFile);
-                    props.store(fos, null);
-                    fos.close();
-                }
-            }
+                });
+           }
         } catch (Exception e) {
             System.err.println("Unable to update instance pid: " + e.getMessage());
         }
     }
 
+    private static String getPid() {
+        String pid = ManagementFactory.getRuntimeMXBean().getName();
+        if (pid.indexOf('@') > 0) {
+            pid = pid.substring(0, pid.indexOf('@'));
+        }
+        return pid;
+    }
+
     private static void writePid(String pidFile) {
         try {
             if (pidFile != null) {
