diff --git a/main/src/main/java/org/apache/karaf/main/Main.java b/main/src/main/java/org/apache/karaf/main/Main.java
index 2157d47ab8..5682a9a70a 100644
--- a/main/src/main/java/org/apache/karaf/main/Main.java
+++ b/main/src/main/java/org/apache/karaf/main/Main.java
@@ -46,6 +46,7 @@ import java.util.regex.Pattern;
 
 import org.osgi.framework.Bundle;
 import org.osgi.framework.BundleContext;
+import org.osgi.framework.BundleException;
 import org.osgi.framework.Constants;
 import org.osgi.framework.FrameworkEvent;
 import org.osgi.framework.ServiceReference;
@@ -154,6 +155,8 @@ public class Main {
     
     public static final String KARAF_FRAMEWORK = "karaf.framework";
 
+    public static final String KARAF_FRAMEWORK_FACTORY = "karaf.framework.factory";
+
     public static final String KARAF_SHUTDOWN_TIMEOUT = "karaf.shutdown.timeout";
 
     public static final String KARAF_SHUTDOWN_PORT = "karaf.shutdown.port";
@@ -247,10 +250,13 @@ public class Main {
         shutdownTimeout = Integer.parseInt(configProps.getProperty(KARAF_SHUTDOWN_TIMEOUT, Integer.toString(shutdownTimeout)));
         // Start up the OSGI framework
 
-        InputStream is = classLoader.getResourceAsStream("META-INF/services/" + FrameworkFactory.class.getName());
-        BufferedReader br = new BufferedReader(new InputStreamReader(is, "UTF-8"));
-        String factoryClass = br.readLine();
-        br.close();
+        String factoryClass = configProps.getProperty(KARAF_FRAMEWORK_FACTORY);
+        if (factoryClass == null) {
+            InputStream is = classLoader.getResourceAsStream("META-INF/services/" + FrameworkFactory.class.getName());
+            BufferedReader br = new BufferedReader(new InputStreamReader(is, "UTF-8"));
+            factoryClass = br.readLine();
+            br.close();
+        }
         FrameworkFactory factory = (FrameworkFactory) classLoader.loadClass(factoryClass).newInstance();
         framework = factory.newFramework(new StringMap(configProps, false));
         framework.start();
@@ -287,7 +293,15 @@ public class Main {
             // Stop the framework in case it's still active
             exiting = true;
             if (framework.getState() == Bundle.ACTIVE) {
-                framework.stop();
+                new Thread() {
+                    public void run() {
+                        try {
+                            framework.stop();
+                        } catch (BundleException e) {
+                            System.err.println("Error stopping karaf: " + e.getMessage());
+                        }
+                    }
+                }.start();
             }
 
             int timeout = shutdownTimeout;
diff --git a/main/src/test/java/org/apache/karaf/main/MainStartTest.java b/main/src/test/java/org/apache/karaf/main/MainStartTest.java
index d9a7066428..2bbee1f1bd 100644
--- a/main/src/test/java/org/apache/karaf/main/MainStartTest.java
+++ b/main/src/test/java/org/apache/karaf/main/MainStartTest.java
@@ -74,6 +74,8 @@ public class MainStartTest {
 		String[] args = new String[0];
 		System.setProperty("karaf.home", home.toString());
 		System.setProperty("karaf.data", data.toString());
+        System.setProperty("karaf.framework.factory", "org.apache.felix.framework.FrameworkFactory");
+
 
         Main main = new Main(args);
         main.launch();
