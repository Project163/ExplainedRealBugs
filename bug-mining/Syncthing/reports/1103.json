{"url":"https://api.github.com/repos/syncthing/syncthing/issues/4271","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/4271/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/4271/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/4271/events","html_url":"https://github.com/syncthing/syncthing/issues/4271","id":245422583,"node_id":"MDU6SXNzdWUyNDU0MjI1ODM=","number":4271,"title":"Make use of filesystems that can handle copies efficiently. ","user":{"login":"lemmi","id":2631530,"node_id":"MDQ6VXNlcjI2MzE1MzA=","avatar_url":"https://avatars.githubusercontent.com/u/2631530?v=4","gravatar_id":"","url":"https://api.github.com/users/lemmi","html_url":"https://github.com/lemmi","followers_url":"https://api.github.com/users/lemmi/followers","following_url":"https://api.github.com/users/lemmi/following{/other_user}","gists_url":"https://api.github.com/users/lemmi/gists{/gist_id}","starred_url":"https://api.github.com/users/lemmi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lemmi/subscriptions","organizations_url":"https://api.github.com/users/lemmi/orgs","repos_url":"https://api.github.com/users/lemmi/repos","events_url":"https://api.github.com/users/lemmi/events{/privacy}","received_events_url":"https://api.github.com/users/lemmi/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":67767667,"node_id":"MDU6TGFiZWw2Nzc2NzY2Nw==","url":"https://api.github.com/repos/syncthing/syncthing/labels/enhancement","name":"enhancement","color":"0e8a16","default":true,"description":"New features or improvements of some kind, as opposed to a problem (bug)"},{"id":628314330,"node_id":"MDU6TGFiZWw2MjgzMTQzMzA=","url":"https://api.github.com/repos/syncthing/syncthing/labels/frozen-due-to-age","name":"frozen-due-to-age","color":"eeeeee","default":false,"description":"Issues closed and untouched for a long time, together with being locked for discussion"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/syncthing/syncthing/milestones/51","html_url":"https://github.com/syncthing/syncthing/milestone/51","labels_url":"https://api.github.com/repos/syncthing/syncthing/milestones/51/labels","id":5546853,"node_id":"MDk6TWlsZXN0b25lNTU0Njg1Mw==","number":51,"title":"v1.8.0","description":"This release:\r\n\r\n- adds the experimental `copyRangeMethod` config on folders, for use on filesystems with copy-on-write support. Please see https://docs.syncthing.net/advanced/folder-copyrangemethod.html for details.\r\n\r\n- adds TCP hole punching, used to establish high performance TCP connections in certain NAT scenarios where only relay or QUIC connections could be used previously.\r\n\r\n- adds a configuration to file versioning for how often to run cleanup. This defaults to once an hour, but is configurable from very frequently to never.","creator":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":71,"state":"closed","created_at":"2020-06-16T13:44:35Z","updated_at":"2020-08-11T09:10:41Z","due_on":"2020-08-18T07:00:00Z","closed_at":"2020-08-11T09:10:41Z"},"comments":11,"created_at":"2017-07-25T14:34:50Z","updated_at":"2021-06-29T17:01:25Z","closed_at":"2020-06-18T06:15:54Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Context\r\n\r\nCopy-on-Write filesystems like btrfs, aswell as some network filesystems (smb, nfs, probably more, s3 has apis aswell,) can make copying more efficient with\r\n\r\n1. only referencing data instead of copying (deduplication)\r\n2. \"Server side copies\" (no need to roundtrip the data to the client and back to the server).\r\n\r\nThe first case will usually result in instant copies since it's only a metadata operation. The filesystem will take care that changes made to one copy won't affect the other. These are not to be confused with hardlinks!\r\nThe second case will benefit those that run syncthing on a network storage. The fileserver can be instructed to do the copy operation locally. Additionally the server can make use of the first case aswell.\r\n\r\nMaking use of deduplication (first case) has the potential to make file versioning very cheap in the sense that only new data will be written to disk. This is a common scenario if only metadata in image or music files is changed. Usually these types of files locate the data at the beginning of a file, then append the metadata (Exif, ID3 tags,...).\r\n\r\n## Why?\r\n\r\nI use staggered versioning and recently freed up about 100G of disk space by making use of this capabilities. There are tools like [duperemove][dupe] that can identify common datablocks and then rewrite the metadata of files to share common blocks. However this process involves scanning and hashing all files in question, comparing them and applying the metadata transformation afterwards. In my case this took several hours.\r\n\r\n\r\nTo make this work, almost every filesystem capable of such functionality needs to be instructed to do so.\r\nSince syncthing already knows which blocks are shared by files and when files are copied, I'd like to make use of this knowledge right away.\r\n\r\n## How?\r\n\r\nFor this to work seamlessly, it needs to be integrated in some form with the new Filesystem Interface #4228. This is currently WIP and I'd like to arrange for a compatible solution.\r\n \r\nOne option is to add another method that will mimic the syscall [copy_file_range(2)][CopyFileRange] to the Filesystem interface. But this will require every backend to actually implement this Method.\r\n\r\nAnother possibility is to have convenience function test for the capabilities and handle the fallback:\r\n\r\nAdd an interface filesystem backends should implement if they are capable of handling efficient copies:\r\n```go\r\ntype FileRangeCopier interface {\r\n    CopyFileRange(src File, srcoff int64, dst File, dstoff int64, length int) (n int, err error)\r\n}\r\n```\r\nThen provide the function outside the Filesystem interface:\r\n```go\r\npackage fs\r\n// ...\r\nfunc CopyFileRange(fs Filesystem, src File, srcoff int64, dst File, dstoff int64, length int64) (n int, err error) {\r\n    // backend can do fast copy for us and do we want it?\r\n    if frc, ok := fs.(FileRangeCopier); ok && cfg.Options.UseCopyFileRange {\r\n        // Make use of the filesystem functionality\r\n        return frc.CopyFileRange(...)\r\n    }\r\n    // Fallback to normal Copy\r\n}\r\n// Maybe add a shortcut if we want to copy a whole file\r\nfunc Copy(fs Filesystem, src, dst File) (n int, err error) {\r\n    return CopyFileRange(fs, src, 0, dst, 0, src.Size())\r\n}\r\n```\r\n\r\n\r\n## Conclusion\r\n\r\nAs long as we can coordinate \r\n\r\n1. the addition of those convenience functions or the methods the the Filesystem interface\r\n2. implementing all necessary fallbacks first\r\n3. using them consistently throughout the code\r\n\r\nI think this could be worthwhile for a couple of users right now and seeing how more filesystems adopt the CoW strategy ([XFS][xfs], [ReFS][refs], [AFS][afs]) this almost could reach almost everyone in a couple of years.\r\n\r\n[dupe]: https://github.com/markfasheh/duperemove \"Tools for deduping file systems\"\r\n[CopyFileRange]: https://manpages.debian.org/unstable/manpages-dev/copy_file_range.2.en.html \"CopyFileRange\"\r\n[xfs]: https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=0cbbc422d56668528f6efd1234fe908010284082\r\n[refs]: https://en.wikipedia.org/wiki/ReFS\r\n[afs]: https://en.wikipedia.org/wiki/Apple_File_System","closed_by":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/4271/reactions","total_count":9,"+1":8,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/4271/timeline","performed_via_github_app":null,"state_reason":"completed"}