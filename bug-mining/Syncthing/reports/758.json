{"url":"https://api.github.com/repos/syncthing/syncthing/issues/4807","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/4807/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/4807/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/4807/events","html_url":"https://github.com/syncthing/syncthing/issues/4807","id":304525719,"node_id":"MDU6SXNzdWUzMDQ1MjU3MTk=","number":4807,"title":"Support variable sized blocks","user":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":67767667,"node_id":"MDU6TGFiZWw2Nzc2NzY2Nw==","url":"https://api.github.com/repos/syncthing/syncthing/labels/enhancement","name":"enhancement","color":"0e8a16","default":true,"description":"New features or improvements of some kind, as opposed to a problem (bug)"},{"id":79550329,"node_id":"MDU6TGFiZWw3OTU1MDMyOQ==","url":"https://api.github.com/repos/syncthing/syncthing/labels/protocol","name":"protocol","color":"fbca04","default":false,"description":"Issues that require a change to the protocol (BEP, relay, discovery)"},{"id":628314330,"node_id":"MDU6TGFiZWw2MjgzMTQzMzA=","url":"https://api.github.com/repos/syncthing/syncthing/labels/frozen-due-to-age","name":"frozen-due-to-age","color":"eeeeee","default":false,"description":"Issues closed and untouched for a long time, together with being locked for discussion"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/syncthing/syncthing/milestones/22","html_url":"https://github.com/syncthing/syncthing/milestone/22","labels_url":"https://api.github.com/repos/syncthing/syncthing/milestones/22/labels","id":3322372,"node_id":"MDk6TWlsZXN0b25lMzMyMjM3Mg==","number":22,"title":"v0.14.48","description":null,"creator":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":12,"state":"closed","created_at":"2018-05-05T08:40:12Z","updated_at":"2018-06-05T06:31:56Z","due_on":null,"closed_at":"2018-06-05T06:31:56Z"},"comments":5,"created_at":"2018-03-12T20:22:02Z","updated_at":"2019-04-17T07:02:47Z","closed_at":"2018-04-16T18:08:52Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"(I can't believe we didn't already have this in the tracker, but if we did I can't find it.)\r\n\r\nWe should support blocks of other sizes than 128 KiB at the protocol level. The gain is mostly for large files, where the block list becomes much smaller and the corresponding memory and database juggling becomes much lighter. Currently Syncthing will OOM on very large files just due to the block list becoming very large and getting copied & marshalled multiple times.\r\n\r\nThe current 128 KiB block size should become the minimum, with block sizes increasing by factors of two up to a maximum - I suggest 16 MiB. When scanning files we select a block size to keep the number of blocks reasonable - I suggest between 1000 and 2000. (When we've reached the maximum block size files can have more blocks than 2000.) This method of selecting the block size is exemplified in the [three years old wiki post on the subject](https://github.com/syncthing/syncthing/wiki/Variable-Block-Size).\r\n\r\nThere should be a hysteresis mechanism so that block sizes are not changed too often for any given file. Devices must be prepared to handle that a file can have a block size different from what would have been selected without bias, both for hysteresis and legacy reasons.\r\n\r\nWe will still issue requests for data in units of blocks. This makes requests larger for larger files, which is also a gain in throughput, readaheads, etc.\r\n\r\nThe block size will be added as an attribute on the FileInfo message. This saves having to have the actual block list at hand to know the block size used, which is useful when loading just the FileInfo and not the block list from database. When this attribute is zero or absent we assume the old default block size of 128 KiB.\r\n\r\nAs large block support will be at best pseudo backwards compatible it will need to be enabled manually to begin with. At some point in the future it can become the default and only way.","closed_by":{"login":"AudriusButkevicius","id":1144861,"node_id":"MDQ6VXNlcjExNDQ4NjE=","avatar_url":"https://avatars.githubusercontent.com/u/1144861?v=4","gravatar_id":"","url":"https://api.github.com/users/AudriusButkevicius","html_url":"https://github.com/AudriusButkevicius","followers_url":"https://api.github.com/users/AudriusButkevicius/followers","following_url":"https://api.github.com/users/AudriusButkevicius/following{/other_user}","gists_url":"https://api.github.com/users/AudriusButkevicius/gists{/gist_id}","starred_url":"https://api.github.com/users/AudriusButkevicius/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AudriusButkevicius/subscriptions","organizations_url":"https://api.github.com/users/AudriusButkevicius/orgs","repos_url":"https://api.github.com/users/AudriusButkevicius/repos","events_url":"https://api.github.com/users/AudriusButkevicius/events{/privacy}","received_events_url":"https://api.github.com/users/AudriusButkevicius/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/4807/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/4807/timeline","performed_via_github_app":null,"state_reason":"completed"}