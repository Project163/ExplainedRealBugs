{"url":"https://api.github.com/repos/syncthing/syncthing/issues/6961","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/6961/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/6961/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/6961/events","html_url":"https://github.com/syncthing/syncthing/issues/6961","id":695109434,"node_id":"MDU6SXNzdWU2OTUxMDk0MzQ=","number":6961,"title":"Accounting issue with receive-only deleted files causing spurious 95% completion for remote devices","user":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":67767665,"node_id":"MDU6TGFiZWw2Nzc2NzY2NQ==","url":"https://api.github.com/repos/syncthing/syncthing/labels/bug","name":"bug","color":"d93f0b","default":true,"description":"A problem with current functionality, as opposed to missing functionality (enhancement)"},{"id":628314330,"node_id":"MDU6TGFiZWw2MjgzMTQzMzA=","url":"https://api.github.com/repos/syncthing/syncthing/labels/frozen-due-to-age","name":"frozen-due-to-age","color":"eeeeee","default":false,"description":"Issues closed and untouched for a long time, together with being locked for discussion"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/syncthing/syncthing/milestones/54","html_url":"https://github.com/syncthing/syncthing/milestone/54","labels_url":"https://api.github.com/repos/syncthing/syncthing/milestones/54/labels","id":5807421,"node_id":"MDk6TWlsZXN0b25lNTgwNzQyMQ==","number":54,"title":"v1.10.0","description":"This release adds the config option `announceLANAddresses` to enable (the default) or disable announcing private (RFC1918)  LAN IP addresses to global discovery.","creator":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":45,"state":"closed","created_at":"2020-08-25T09:49:15Z","updated_at":"2020-10-06T10:50:34Z","due_on":"2020-10-06T07:00:00Z","closed_at":"2020-10-06T10:50:34Z"},"comments":0,"created_at":"2020-09-07T13:36:23Z","updated_at":"2021-09-08T07:02:32Z","closed_at":"2020-09-07T18:18:25Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"An existing in-sync file can be changed and then deleted on a receive-only device. This results in two updates, (1) a file change and (2) a file delete, each with the invalid version (empty) and the invalid bit set. If the proper version is then withdrawn from the cluster (because all devices that had them are removed from the config, for example) we will \"upgrade\" this locally-changed deleted file to a regular deleted file (no invalid bit) but retain the invalid version to ensure it will never override a real file version, should it reappear.\r\n\r\nThe result in the database is a global file entry with the empty version, and the delete-bit unset. The delete bit is unset because it changed without the version changing between updates 1 and 2. \r\n\r\nA separate but related factor is how we handle delete records for files we don't have: we simply ignore them. This means that most other devices will not announce anything at all for this zero-version deleted file.\r\n\r\nWhen running a database repair or metadata recovery we will look at all global file entries and compute the need requirements for all devices. At this point it looks like there is a valid non-deleted file that is not present in the announcements from other devices, hence it gets added to their \"need\" counter.\r\n\r\nAt this point the need counter is wrong and the device looks like \"95% in sync\" from our perspective...","closed_by":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/6961/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/6961/timeline","performed_via_github_app":null,"state_reason":"completed"}