{"url":"https://api.github.com/repos/syncthing/syncthing/issues/5934","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/5934/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/5934/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/5934/events","html_url":"https://github.com/syncthing/syncthing/issues/5934","id":477508921,"node_id":"MDU6SXNzdWU0Nzc1MDg5MjE=","number":5934,"title":"Dialing regards any established connection as successful / does not check device ID","user":{"login":"olifre","id":166759,"node_id":"MDQ6VXNlcjE2Njc1OQ==","avatar_url":"https://avatars.githubusercontent.com/u/166759?v=4","gravatar_id":"","url":"https://api.github.com/users/olifre","html_url":"https://github.com/olifre","followers_url":"https://api.github.com/users/olifre/followers","following_url":"https://api.github.com/users/olifre/following{/other_user}","gists_url":"https://api.github.com/users/olifre/gists{/gist_id}","starred_url":"https://api.github.com/users/olifre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/olifre/subscriptions","organizations_url":"https://api.github.com/users/olifre/orgs","repos_url":"https://api.github.com/users/olifre/repos","events_url":"https://api.github.com/users/olifre/events{/privacy}","received_events_url":"https://api.github.com/users/olifre/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":67767665,"node_id":"MDU6TGFiZWw2Nzc2NzY2NQ==","url":"https://api.github.com/repos/syncthing/syncthing/labels/bug","name":"bug","color":"d93f0b","default":true,"description":"A problem with current functionality, as opposed to missing functionality (enhancement)"},{"id":628314330,"node_id":"MDU6TGFiZWw2MjgzMTQzMzA=","url":"https://api.github.com/repos/syncthing/syncthing/labels/frozen-due-to-age","name":"frozen-due-to-age","color":"eeeeee","default":false,"description":"Issues closed and untouched for a long time, together with being locked for discussion"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/syncthing/syncthing/milestones/38","html_url":"https://github.com/syncthing/syncthing/milestone/38","labels_url":"https://api.github.com/repos/syncthing/syncthing/milestones/38/labels","id":4534457,"node_id":"MDk6TWlsZXN0b25lNDUzNDQ1Nw==","number":38,"title":"v1.2.2","description":"","creator":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":41,"state":"closed","created_at":"2019-07-30T19:01:21Z","updated_at":"2019-09-03T07:10:18Z","due_on":"2019-09-03T07:00:00Z","closed_at":"2019-09-03T07:10:18Z"},"comments":3,"created_at":"2019-08-06T17:39:16Z","updated_at":"2020-08-09T07:02:27Z","closed_at":"2019-08-09T11:31:50Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Dialing a host's address may end up connecting (successfully) to a different host (to which a connection may already exist). \r\nCurrently, the dialer regards this as success, and the connection is only dropped later when the device ID is checked. This prevents falling back to dialing of other addresses. \r\n\r\nTwo possible solutions come to mind:\r\n- Dialer should check node ID after establishing connection before returning success. \r\n- If a successful connection exists via an address and a different device announces the very same address (including the dialing device's addresses themselves), dialing that and assuming to reach the other device is not logical. This could be suppressed. \r\n\r\nTwo examples in which this causes issues:\r\n1. Two hosts behind the same NAT, one directly reachable via port forwarding, both configured to the same (default) listening port. An outside node successfully connects to the port-forwarded node, then tries to connect to the NATed node using the same external IP and port, and establishes a successful connection - but to the wrong node. \r\n2. Syncthing running on a NATting device itself with other nodes behind the NAT. In this case, the NATting device may be tricked into trying to connect to itself. \r\n\r\nExample logs (anonymized) follow. \r\nCase 1:\r\n```\r\n2019/08/06 19:25:34.081495 structs.go:217: DEBUG: dialing UUID_OF_DEVICE_WE_WANT_TO_REACH tcp://EXTERNAL_IP_OF_NAT:22000 prio 10\r\n2019/08/06 19:25:34.117970 tcp_dial.go:48: DEBUG: Dial (BEP/tcp): setting traffic class: setsockopt: protocol not available\r\n2019/08/06 19:25:34.546076 structs.go:222: DEBUG: dialing UUID_OF_DEVICE_WE_WANT_TO_REACH tcp://EXTERNAL_IP_OF_NAT:22000 success: LOCAL_IP_OF_DIALING_NODE:49308-EXTERNAL_IP_OF_NAT:22000/tcp-client/TLS1.3-TLS_CHACHA20_POLY1305_SHA256\r\n2019/08/06 19:25:34.546099 service.go:872: DEBUG: connected to UUID_OF_DEVICE_WE_WANT_TO_REACH 10 using LOCAL_IP_OF_DIALING_NODE:49308-EXTERNAL_IP_OF_NAT:22000/tcp-client/TLS1.3-TLS_CHACHA20_POLY1305_SHA256 10\r\n...\r\n2019/08/06 19:25:34.546161 service.go:875: DEBUG: discarding 0 connections while connecting to UUID_OF_DEVICE_WE_WANT_TO_REACH 10\r\n...\r\n2019/08/06 19:25:34.546258 service.go:477: DEBUG: sleep until next dial 1m0s\r\n2019/08/06 19:25:34.723211 service.go:282: INFO: Connected to already connected device UUID_OF_OTHER_DEVICE_BEHIND_THE_SAME_NAT (existing: LOCAL_IP_OF_DIALING_NODE:48686-EXTERNAL_IP_OF_NAT:22000/tcp-client/TLS1.3-TLS_CHACHA20_POLY1305_SHA256 new: LOCAL_IP_OF_DIALING_NODE:49308-EXTERNAL_IP_OF_NAT:22000/tcp-client/TLS1.3-TLS_CHACHA20_POLY1305_SHA256)\r\n```\r\n\r\nCase 2:\r\n```\r\n2019/08/06 19:21:34.136916 structs.go:217: DEBUG: dialing UUID_OF_DEVICE_WE_WANT_TO_REACH tcp://EXTERNAL_IP_OF_NATTING_DEVICE:22000 prio 9\r\n2019/08/06 19:21:34.137011 tcp_listen.go:107: DEBUG: Listen (BEP/tcp): connect from EXTERNAL_IP_OF_NATTING_DEVICE:39702\r\n2019/08/06 19:21:34.186905 structs.go:222: DEBUG: dialing UUID_OF_DEVICE_WE_WANT_TO_REACH tcp://EXTERNAL_IP_OF_NATTING_DEVICE:22000 success: EXTERNAL_IP_OF_NATTING_DEVICE:39702-EXTERNAL_IP_OF_NATTING_DEVICE:22000/tcp-client/TLS1.3-TLS_AES_128_GCM_SHA256\r\n2019/08/06 19:21:34.186926 service.go:872: DEBUG: connected to UUID_OF_DEVICE_WE_WANT_TO_REACH 9 using EXTERNAL_IP_OF_NATTING_DEVICE:39702-EXTERNAL_IP_OF_NATTING_DEVICE:22000/tcp-client/TLS1.3-TLS_AES_128_GCM_SHA256 10\r\n2019/08/06 19:21:34.187022 service.go:229: INFO: Connected to myself (UUID_OF_NATTING_DEVICE) at EXTERNAL_IP_OF_NATTING_DEVICE:39702-EXTERNAL_IP_OF_NATTING_DEVICE:22000/tcp-client/TLS1.3-TLS_AES_128_GCM_SHA256 - should not happen\r\n2019/08/06 19:21:34.194114 service.go:229: INFO: Connected to myself (UUID_OF_NATTING_DEVICE) at EXTERNAL_IP_OF_NATTING_DEVICE:22000-EXTERNAL_IP_OF_NATTING_DEVICE:39702/tcp-server/TLS1.3-TLS_AES_128_GCM_SHA256 - should not happen\r\n```\r\n\r\n### Version Information\r\n\r\nSyncthing Version: v1.2.1\r\nOS Version: Gentoo Linux x86_64\r\n\r\n\r\n","closed_by":{"login":"AudriusButkevicius","id":1144861,"node_id":"MDQ6VXNlcjExNDQ4NjE=","avatar_url":"https://avatars.githubusercontent.com/u/1144861?v=4","gravatar_id":"","url":"https://api.github.com/users/AudriusButkevicius","html_url":"https://github.com/AudriusButkevicius","followers_url":"https://api.github.com/users/AudriusButkevicius/followers","following_url":"https://api.github.com/users/AudriusButkevicius/following{/other_user}","gists_url":"https://api.github.com/users/AudriusButkevicius/gists{/gist_id}","starred_url":"https://api.github.com/users/AudriusButkevicius/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AudriusButkevicius/subscriptions","organizations_url":"https://api.github.com/users/AudriusButkevicius/orgs","repos_url":"https://api.github.com/users/AudriusButkevicius/repos","events_url":"https://api.github.com/users/AudriusButkevicius/events{/privacy}","received_events_url":"https://api.github.com/users/AudriusButkevicius/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/5934/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/5934/timeline","performed_via_github_app":null,"state_reason":"completed"}