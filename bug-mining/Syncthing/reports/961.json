{"url":"https://api.github.com/repos/syncthing/syncthing/issues/5882","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/5882/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/5882/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/5882/events","html_url":"https://github.com/syncthing/syncthing/issues/5882","id":471042936,"node_id":"MDU6SXNzdWU0NzEwNDI5MzY=","number":5882,"title":"Folder Meta data inconsistent","user":{"login":"xjtdy888","id":622685,"node_id":"MDQ6VXNlcjYyMjY4NQ==","avatar_url":"https://avatars.githubusercontent.com/u/622685?v=4","gravatar_id":"","url":"https://api.github.com/users/xjtdy888","html_url":"https://github.com/xjtdy888","followers_url":"https://api.github.com/users/xjtdy888/followers","following_url":"https://api.github.com/users/xjtdy888/following{/other_user}","gists_url":"https://api.github.com/users/xjtdy888/gists{/gist_id}","starred_url":"https://api.github.com/users/xjtdy888/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xjtdy888/subscriptions","organizations_url":"https://api.github.com/users/xjtdy888/orgs","repos_url":"https://api.github.com/users/xjtdy888/repos","events_url":"https://api.github.com/users/xjtdy888/events{/privacy}","received_events_url":"https://api.github.com/users/xjtdy888/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":67767665,"node_id":"MDU6TGFiZWw2Nzc2NzY2NQ==","url":"https://api.github.com/repos/syncthing/syncthing/labels/bug","name":"bug","color":"d93f0b","default":true,"description":"A problem with current functionality, as opposed to missing functionality (enhancement)"},{"id":628314330,"node_id":"MDU6TGFiZWw2MjgzMTQzMzA=","url":"https://api.github.com/repos/syncthing/syncthing/labels/frozen-due-to-age","name":"frozen-due-to-age","color":"eeeeee","default":false,"description":"Issues closed and untouched for a long time, together with being locked for discussion"},{"id":753433298,"node_id":"MDU6TGFiZWw3NTM0MzMyOTg=","url":"https://api.github.com/repos/syncthing/syncthing/labels/skip-changelog","name":"skip-changelog","color":"7fffb4","default":false,"description":"Bugs that have never been in a released stable version, and as such excluded from the release notes"}],"state":"closed","locked":true,"assignee":{"login":"imsodin","id":15955093,"node_id":"MDQ6VXNlcjE1OTU1MDkz","avatar_url":"https://avatars.githubusercontent.com/u/15955093?v=4","gravatar_id":"","url":"https://api.github.com/users/imsodin","html_url":"https://github.com/imsodin","followers_url":"https://api.github.com/users/imsodin/followers","following_url":"https://api.github.com/users/imsodin/following{/other_user}","gists_url":"https://api.github.com/users/imsodin/gists{/gist_id}","starred_url":"https://api.github.com/users/imsodin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imsodin/subscriptions","organizations_url":"https://api.github.com/users/imsodin/orgs","repos_url":"https://api.github.com/users/imsodin/repos","events_url":"https://api.github.com/users/imsodin/events{/privacy}","received_events_url":"https://api.github.com/users/imsodin/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"imsodin","id":15955093,"node_id":"MDQ6VXNlcjE1OTU1MDkz","avatar_url":"https://avatars.githubusercontent.com/u/15955093?v=4","gravatar_id":"","url":"https://api.github.com/users/imsodin","html_url":"https://github.com/imsodin","followers_url":"https://api.github.com/users/imsodin/followers","following_url":"https://api.github.com/users/imsodin/following{/other_user}","gists_url":"https://api.github.com/users/imsodin/gists{/gist_id}","starred_url":"https://api.github.com/users/imsodin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imsodin/subscriptions","organizations_url":"https://api.github.com/users/imsodin/orgs","repos_url":"https://api.github.com/users/imsodin/repos","events_url":"https://api.github.com/users/imsodin/events{/privacy}","received_events_url":"https://api.github.com/users/imsodin/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/syncthing/syncthing/milestones/37","html_url":"https://github.com/syncthing/syncthing/milestone/37","labels_url":"https://api.github.com/repos/syncthing/syncthing/milestones/37/labels","id":4476332,"node_id":"MDk6TWlsZXN0b25lNDQ3NjMzMg==","number":37,"title":"v1.2.1","description":"","creator":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":48,"state":"closed","created_at":"2019-07-09T06:41:27Z","updated_at":"2019-08-06T05:40:36Z","due_on":"2019-08-06T07:00:00Z","closed_at":"2019-08-06T05:40:36Z"},"comments":2,"created_at":"2019-07-22T11:31:22Z","updated_at":"2020-07-23T07:02:48Z","closed_at":"2019-07-23T18:39:33Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"https://github.com/syncthing/syncthing/blob/484fa0592e3579ed3ca1447a9cb87663c8ac49b4/lib/model/model.go#L468\r\n```\r\nif !to.Paused {\r\n\t\t// Creating the fileset can take a long time (metadata calculation)\r\n\t\t// so we do it outside of the lock.\r\n\t\tfset = db.NewFileSet(to.ID, to.Filesystem(), m.db)\r\n\t}\r\n```\r\n\r\nWhen we are scanning a folder with a large number of files, if we edit the folder property and trigger the folder restart, since the DB (maybe FileSet.Update) is being updated, the new NewFileSet here uses a new meta data object(load from db), At the same time, the unfinished GO thread writes the meta(Data lost, covered by new meta object). At this point our index exists, but the meta information is lost, which seems to be missing the file, and the file will never be scanned.\r\n\r\nReproduce:\r\n1.  Add a very large number of directories\r\n2.  In the scanning & indexing, modify the folder attributes such as the pull order.\r\n3.  Maybe step 2 is repeated multiple times, each time a few seconds apart\r\n4.  You can see that the number of files in the directory is inconsistent with the actual, and the lost files will never be synchronized.\r\n","closed_by":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/5882/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/5882/timeline","performed_via_github_app":null,"state_reason":"completed"}