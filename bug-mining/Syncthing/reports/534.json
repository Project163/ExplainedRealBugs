{"url":"https://api.github.com/repos/syncthing/syncthing/issues/3500","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/3500/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/3500/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/3500/events","html_url":"https://github.com/syncthing/syncthing/issues/3500","id":170957812,"node_id":"MDU6SXNzdWUxNzA5NTc4MTI=","number":3500,"title":"Auto-update failure -> syncthing binary gone","user":{"login":"scienmind","id":11633330,"node_id":"MDQ6VXNlcjExNjMzMzMw","avatar_url":"https://avatars.githubusercontent.com/u/11633330?v=4","gravatar_id":"","url":"https://api.github.com/users/scienmind","html_url":"https://github.com/scienmind","followers_url":"https://api.github.com/users/scienmind/followers","following_url":"https://api.github.com/users/scienmind/following{/other_user}","gists_url":"https://api.github.com/users/scienmind/gists{/gist_id}","starred_url":"https://api.github.com/users/scienmind/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/scienmind/subscriptions","organizations_url":"https://api.github.com/users/scienmind/orgs","repos_url":"https://api.github.com/users/scienmind/repos","events_url":"https://api.github.com/users/scienmind/events{/privacy}","received_events_url":"https://api.github.com/users/scienmind/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":67767665,"node_id":"MDU6TGFiZWw2Nzc2NzY2NQ==","url":"https://api.github.com/repos/syncthing/syncthing/labels/bug","name":"bug","color":"d93f0b","default":true,"description":"A problem with current functionality, as opposed to missing functionality (enhancement)"},{"id":628314330,"node_id":"MDU6TGFiZWw2MjgzMTQzMzA=","url":"https://api.github.com/repos/syncthing/syncthing/labels/frozen-due-to-age","name":"frozen-due-to-age","color":"eeeeee","default":false,"description":"Issues closed and untouched for a long time, together with being locked for discussion"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2016-08-12T20:58:00Z","updated_at":"2017-08-23T08:13:08Z","closed_at":"2016-08-23T06:53:42Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Following up a brief discussion over IRC:\nFew days ago one of my ST nodes suddenly reverted to v0.13 from v0.14.3.\n\nAccording to the logs, during the auto-update procedure, syncthing binary (syncthing.exe) disappeared from this world, and then upon restart of the OS was reverted to the 0.13 binary shipped with the wrapper (SyncTrayzor):\n\n```\n ...\n [IDIDID] 19:33:39 INFO: Device IDIDIDID-01 folder \"FOLDER-26\" has a new index ID (0xCA2C14FFB8F66F0A)\n [IDIDID] 19:33:39 INFO: Device IDIDIDID-01 folder \"FOLDER-12\" has a new index ID (0x8EA614B817094139)\n [IDIDID] 19:33:39 INFO: Automatic upgrade (current \"v0.14.3\" < latest \"v0.14.4\")\n [IDIDID] 19:33:54 WARNING: Automatic upgrade: rename C:\\Users\\USER-01\\AppData\\Roaming\\SyncTrayzor\\syncthing844288339 C:\\Users\\USER-01\\AppData\\Roaming\\SyncTrayzor\\syncthing.exe: The process cannot access the file because it is being used by another process.\n [IDIDID] 19:33:59 INFO: Established secure connection to IDIDIDID-05 at LOCAL-IPv4-01.13:54604-91.121.160.153:22067 (Relay (Client))\n [IDIDID] 19:33:59 INFO: Device IDIDIDID-05 client is \"syncthing v0.14.4\" named \"DEVICE-05\"\n [IDIDID] 19:33:59 INFO: Connected to device IDIDIDID-05 with a newer version (current \"v0.14.3\" < remote \"v0.14.4\"). Checking for upgrades.\n [IDIDID] 19:34:00 INFO: Device IDIDIDID-05 folder \"FOLDER-17\" has a new index ID (0xF578543A56D85C50)\n [IDIDID] 19:34:00 INFO: Device IDIDIDID-05 folder \"FOLDER-28\" has a new index ID (0x853993BEA1E882B9)\n [IDIDID] 19:34:01 INFO: Automatic upgrade (current \"v0.14.3\" < latest \"v0.14.4\")\n [IDIDID] 19:34:06 INFO: Established secure connection to IDIDIDID-08 at LOCAL-IPv4-01.13:54619-78.46.45.123:22067 (Relay (Client))\n [IDIDID] 19:34:06 INFO: Device IDIDIDID-08 client is \"syncthing v0.14.4\" named \"DEVICE-08\"\n [IDIDID] 19:34:07 INFO: Device IDIDIDID-08 folder \"FOLDER-12\" has a new index ID (0x7DD4C1C6E2890737)\n ...\n [IDIDID] 19:34:25 INFO: Device IDIDIDID-08 folder \"FOLDER-32\" has a new index ID (0xCEBB3A9C0672FBBD)\n [IDIDID] 19:34:26 WARNING: Automatic upgrade: rename C:\\Users\\USER-01\\AppData\\Roaming\\SyncTrayzor\\syncthing.exe C:\\Users\\USER-01\\AppData\\Roaming\\SyncTrayzor\\syncthing.exe.old: The system cannot find the file specified.\n [IDIDID] 19:34:26 INFO: Connected to device IDIDIDID-08 with a newer version (current \"v0.14.3\" < remote \"v0.14.4\"). Checking for upgrades.\n [IDIDID] 19:34:27 INFO: Automatic upgrade (current \"v0.14.3\" < latest \"v0.14.4\")\n [IDIDID] 19:34:27 INFO: Device IDIDIDID-08 folder \"FOLDER-27\" has a new index ID (0x21478973CE9A9B35)\n ...\n [IDIDID] 19:34:37 INFO: Device IDIDIDID-08 folder \"FOLDER-14\" has a new index ID (0x5C81B96863E500DF)\n [IDIDID] 19:34:40 WARNING: Automatic upgrade: rename C:\\Users\\USER-01\\AppData\\Roaming\\SyncTrayzor\\syncthing.exe C:\\Users\\USER-01\\AppData\\Roaming\\SyncTrayzor\\syncthing.exe.old: The system cannot find the file specified.\n [IDIDID] 19:34:51 INFO: Device IDIDIDID-08 folder \"FOLDER-09\" has a new index ID (0xE4C0F8E536E7C3D1)\n [IDIDID] 19:36:02 INFO: Shutting down\n [IDIDID] 19:36:02 INFO: Exiting\n [IDIDID] 23:00:16 INFO: syncthing v0.13.10 \"Copper Cockroach\" (go1.6.2 windows-amd64) WIN-P6RP886TVDJ\\Administrator@WIN-P6RP886TVDJ 2016-07-03 11:29:32 UTC\n [IDIDID] 23:00:16 INFO: My ID: IDIDIDID-12\n [IDIDID] 23:00:17 INFO: Single thread hash performance is ~39 MB/s\n [IDIDID] 23:00:31 INFO: Ready to synchronize FOLDER-01 (readwrite)\n [IDIDID] 23:00:32 INFO: Ready to synchronize FOLDER-13 (readwrite)\n [IDIDID] 23:00:36 INFO: Ready to synchronize FOLDER-19 (readwrite)\n ...\n```\n\nMoreover, turns out its not \"one time thing\" (!). I noticed that another node on the cluster was stuck on v0.14.3 about a day after every other node was auto-upgraded to v0.14.4\nI suspected that the same might have happened there. And surely that was the case. This node was running standalone syncthing instance governed by NSSM, no wrapper. And once the PC was restarted, syncthing was dead there for good. No binary. No wrapper to resurrect it.\n\nInspecting ST's folder on that machine revealed a fat list of temporary binaries (all are bit-wise copies of 0.14.4):\n![image](https://cloud.githubusercontent.com/assets/11633330/17636561/9be4a848-60e6-11e6-97f8-42b510f84b04.png)\nLogs are similar to the first machine:\n\n```\n ...\n [IDIDID] 19:10:36 INFO: Device IDIDIDID-08 folder \"FOLDER-48\" has a new index ID (0xF09B1B83A25B09E5)\n [IDIDID] 19:10:47 WARNING: Automatic upgrade: rename C:\\Program Files\\Syncthing-Service\\Service\\syncthing767851213 C:\\Program Files\\Syncthing-Service\\Service\\syncthing.exe: The process cannot access the file because it is being used by another process.\n [IDIDID] 19:11:28 INFO: Connection to IDIDIDID-08 closed: switching connections\n [IDIDID] 19:11:28 INFO: Established secure connection to IDIDIDID-08 at LOCAL-IPv4-01.3:22000-LOCAL-IPv4-01.2:58038 (TCP (Server))\n [IDIDID] 19:11:28 INFO: Device IDIDIDID-08 client is \"syncthing v0.14.4\" named \"DEVICE-08\"\n [IDIDID] 19:11:28 INFO: Connected to device IDIDIDID-08 with a newer version (current \"v0.14.3\" < remote \"v0.14.4\"). Checking for upgrades.\n [IDIDID] 19:11:28 INFO: Connection to IDIDIDID-08 closed: writing message: write tcp LOCAL-IPv4-01.3:63354->93.180.156.234:22067: use of closed network connection\n [IDIDID] 19:11:28 INFO: Connection to IDIDIDID-08 closed: reading length: read tcp LOCAL-IPv4-01.3:22000->LOCAL-IPv4-01.2:58038: use of closed network connection\n [IDIDID] 19:11:29 INFO: Automatic upgrade (current \"v0.14.3\" < latest \"v0.14.4\")\n [IDIDID] 19:11:37 WARNING: Automatic upgrade: rename C:\\Program Files\\Syncthing-Service\\Service\\syncthing.exe C:\\Program Files\\Syncthing-Service\\Service\\syncthing.exe.old: The system cannot find the file specified.\n [IDIDID] 19:11:56 INFO: Established secure connection to IDIDIDID-08 at LOCAL-IPv4-01.3:22000-LOCAL-IPv4-01.2:58101 (TCP (Server))\n [IDIDID] 19:11:56 INFO: Device IDIDIDID-08 client is \"syncthing v0.14.4\" named \"DEVICE-08\"\n [IDIDID] 19:11:56 INFO: Connected to device IDIDIDID-08 with a newer version (current \"v0.14.3\" < remote \"v0.14.4\"). Checking for upgrades.\n [IDIDID] 19:11:56 INFO: Device IDIDIDID-08 folder \"FOLDER-36\" is delta index compatible (mlv=32259)\n ...\n [IDIDID] 12:03:27 INFO: Device IDIDIDID-07 folder \"FOLDER-23\" is delta index compatible (mlv=1595)\n [IDIDID] 12:09:09 INFO: Established secure connection to IDIDIDID-12 at LOCAL-IPv4-01.3:61254-93.180.156.234:22067 (Relay (Server))\n [IDIDID] 12:09:09 INFO: Device IDIDIDID-12 client is \"syncthing v0.14.4\" named \"DEVICE-12\"\n [IDIDID] 12:09:09 INFO: Connected to device IDIDIDID-12 with a newer version (current \"v0.14.3\" < remote \"v0.14.4\"). Checking for upgrades.\n [IDIDID] 12:09:09 INFO: Device IDIDIDID-12 folder \"FOLDER-29\" is delta index compatible (mlv=32263)\n [IDIDID] 12:09:09 INFO: Device IDIDIDID-12 folder \"FOLDER-18\" is delta index compatible (mlv=35)\n [IDIDID] 12:09:09 INFO: Device IDIDIDID-12 folder \"FOLDER-25\" is delta index compatible (mlv=35518)\n [IDIDID] 12:09:10 INFO: Automatic upgrade (current \"v0.14.3\" < latest \"v0.14.4\")\n [IDIDID] 12:09:17 WARNING: Automatic upgrade: rename C:\\Program Files\\Syncthing-Service\\Service\\syncthing.exe C:\\Program Files\\Syncthing-Service\\Service\\syncthing.exe.old: The system cannot find the file specified.\n [IDIDID] 12:10:57 INFO: Connection to IDIDIDID-07 closed: read timeout\n [IDIDID] 12:11:33 INFO: Established secure connection to IDIDIDID-07 at [IPv6-05%Ethernet]:61304-[IPv6-09%Ethernet]:22000 (TCP (Client))\n [IDIDID] 12:11:33 INFO: Device IDIDIDID-07 client is \"syncthing v0.14.3\" named \"DEVICE-07\"\n [IDIDID] 12:11:33 INFO: Device IDIDIDID-07 folder \"FOLDER-39\" is delta index compatible (mlv=29)\n ...\n```\n\n**TL;DR:** Seems like for some reason renaming of the updated binary from temp to `.exe` failed (maybe due to security software scan, or whatever...), but the original ST binary was already wiped (or renamed to `.old`. And thus node is effectively dead on next boot.\n\nSyncthing should handle binary switching more fail-safe: verify valid access to the new binary before removing the old one, and/or revert back to old one if the new one can't be used.\nEither way, avoid \"floating on the air (RAM)\" as much as possible.\n### Version Information\n\nSyncthing Version: v0.14.3\nOS Version: Windows 10\n","closed_by":{"login":"st-review","id":16196517,"node_id":"MDQ6VXNlcjE2MTk2NTE3","avatar_url":"https://avatars.githubusercontent.com/u/16196517?v=4","gravatar_id":"","url":"https://api.github.com/users/st-review","html_url":"https://github.com/st-review","followers_url":"https://api.github.com/users/st-review/followers","following_url":"https://api.github.com/users/st-review/following{/other_user}","gists_url":"https://api.github.com/users/st-review/gists{/gist_id}","starred_url":"https://api.github.com/users/st-review/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/st-review/subscriptions","organizations_url":"https://api.github.com/users/st-review/orgs","repos_url":"https://api.github.com/users/st-review/repos","events_url":"https://api.github.com/users/st-review/events{/privacy}","received_events_url":"https://api.github.com/users/st-review/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/3500/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/3500/timeline","performed_via_github_app":null,"state_reason":"completed"}