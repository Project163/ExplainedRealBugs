{"url":"https://api.github.com/repos/syncthing/syncthing/issues/4618","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/4618/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/4618/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/4618/events","html_url":"https://github.com/syncthing/syncthing/issues/4618","id":284935026,"node_id":"MDU6SXNzdWUyODQ5MzUwMjY=","number":4618,"title":"More scalable global discovery","user":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":628314330,"node_id":"MDU6TGFiZWw2MjgzMTQzMzA=","url":"https://api.github.com/repos/syncthing/syncthing/labels/frozen-due-to-age","name":"frozen-due-to-age","color":"eeeeee","default":false,"description":"Issues closed and untouched for a long time, together with being locked for discussion"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/syncthing/syncthing/milestones/18","html_url":"https://github.com/syncthing/syncthing/milestone/18","labels_url":"https://api.github.com/repos/syncthing/syncthing/milestones/18/labels","id":3009485,"node_id":"MDk6TWlsZXN0b25lMzAwOTQ4NQ==","number":18,"title":"v0.14.44","description":null,"creator":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":15,"state":"closed","created_at":"2018-01-03T08:10:40Z","updated_at":"2018-02-08T10:55:32Z","due_on":null,"closed_at":"2018-02-08T10:46:00Z"},"comments":13,"created_at":"2017-12-28T15:19:33Z","updated_at":"2019-01-15T07:02:26Z","closed_at":"2018-01-14T08:52:40Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"The current global discovery system doesn't scale - the servers are running at 100% and since they only provide redundancy and not load sharing it's not a solution to add more. They must be made beefier, which gets expensive given the multiplier.\r\n\r\nThe CPU load looks like this:\r\n\r\n<img width=\"858\" alt=\"screen shot 2017-12-29 at 08 49 44\" src=\"https://user-images.githubusercontent.com/125426/34432170-5998dd4e-ec75-11e7-9ab9-0ab2346ecc1c.png\">\r\n\r\nEssentially, nginx is doing TLS termination, stdiscosrv is doing the actual work, postgres doing what it does. The TLS termination is expensive because of the massive amount of requests, mostly lookups. Lookups are hard to reduce without making the user experience sluggish, as most of them are for devices that are offline but we can't know if it's a device that will come online soon and so can't negative-cache for too long.\r\n\r\nThe DHT options still don't look easily actionable - I've looked through the available packages again, but I'd love for someone to prove me wrong and implement it. In the meantime, here's a new centralized but scalable global discovery proposal in two steps. \r\n\r\nIn step one we add a distributed backend. I propose ~~Amazon S3~~ DigitalOcean Spaces, which is S3 compatible but also simpler and for our load cheaper. The current discovery servers use this as a backend key value store. With a dns change and configuration migration the Syncthing clients will do their announces to just one of the servers (any, via dns lb) instead of all. We've won some scalability. For our purposes I think we should use the *actual* Spaces service because that will allow us to get rid of the cost of serving the lookups entirely, but anyone could use one of the open source compatible datastores here if they wanted to build their own private solution. \r\n\r\n> Detail on the KV store. I propose that the stored blobs are encrypted with the device ID as symmetric key and stored under a hash of the device ID and suitable time span (maybe two hours). If you know what device you're looking for it's easy to retrieve and interpret, yet it resists enumeration and provides privacy of the address data against Amazon itself. Blobs automatically expire after two times the interval. Lookup needs to take some clock skew into account and check for both the current and previous interval. \r\n\r\nIn step two, we remove the lookups via our servers and have Syncthing clients grab the appropriate blobs directly from S3. This reduces our load further, and the charge for GET requests to S3 is less than our cost of a VM capable of handling same. We still retain our infrastructure for the announcement, for the purpose of validating certificates, doing the encryption, and preventing some trivial abuse. \r\n\r\nFor self hosted discovery servers we can simply retain support for the older lookup mechanism, or we can recommend deploying in tandem with any of the easily available S3 compatible data stores out there. \r\n\r\nGiven that the data store blobs become encrypted I propose to include device local addresses in the announcement. This solves a couple of problems:\r\n\r\n- Devices can get LAN connections via global discovery\r\n- We don't need to worry as much about v4 versus v6\r\n\r\nFor the latter point we assume that v6 NAT doesn't exist. This is mostly true today, and in the cases where it's not the perpetrator can sort it out themselves. Given that, the device's global v6 address will be included in the set of addresses announced over v4 as well. If the device happens to be behind v4 NAT but anyway has native v6 and announces to the discovery server over v6 we might not get the external v4 address - but the v6 one should work as well. \r\n\r\nFor the privacy paranoid we can add a toggle here in Syncthing to not announce local addresses. \r\n\r\nStep one details:\r\n\r\n- implement new discosrv backend\r\n- start using it\r\n- create new DNS discovery.s.n that wildcards to all servers and a configuration migration to it\r\n- remove all existing discovery addresses apart from one that also becomes a wildcard to all servers\r\n\r\nMigrated configs will talk to the new name, load balanced over all servers. Old configs will fail to talk to all but one, which in turn is load balanced and works. We will need a FAQ response to \"most servers seem down\".\r\n\r\nStep two details:\r\n\r\n- separate global announcement from lookup in the existing code, the existing code becomes announce only\r\n- add new S3 lookup method and configs, migrate accordingly\r\n\r\nThe existing discovery servers bridge between the two, so no impact for nonupgraded clients. We're now down to only having to have servers to handle announcements, and adding more of them scales horizontally. \r\n\r\nOnce enough load has been removed from the existing servers, trim them down to just a single pair and lower the cpu/ram configuration. \r\n\r\nProfit. ","closed_by":{"login":"st-review","id":16196517,"node_id":"MDQ6VXNlcjE2MTk2NTE3","avatar_url":"https://avatars.githubusercontent.com/u/16196517?v=4","gravatar_id":"","url":"https://api.github.com/users/st-review","html_url":"https://github.com/st-review","followers_url":"https://api.github.com/users/st-review/followers","following_url":"https://api.github.com/users/st-review/following{/other_user}","gists_url":"https://api.github.com/users/st-review/gists{/gist_id}","starred_url":"https://api.github.com/users/st-review/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/st-review/subscriptions","organizations_url":"https://api.github.com/users/st-review/orgs","repos_url":"https://api.github.com/users/st-review/repos","events_url":"https://api.github.com/users/st-review/events{/privacy}","received_events_url":"https://api.github.com/users/st-review/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/4618/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/4618/timeline","performed_via_github_app":null,"state_reason":"completed"}