{"url":"https://api.github.com/repos/syncthing/syncthing/issues/7533","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/7533/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/7533/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/7533/events","html_url":"https://github.com/syncthing/syncthing/issues/7533","id":844466082,"node_id":"MDU6SXNzdWU4NDQ0NjYwODI=","number":7533,"title":"Remote completion on untrusted devices is incorrect","user":{"login":"imsodin","id":15955093,"node_id":"MDQ6VXNlcjE1OTU1MDkz","avatar_url":"https://avatars.githubusercontent.com/u/15955093?v=4","gravatar_id":"","url":"https://api.github.com/users/imsodin","html_url":"https://github.com/imsodin","followers_url":"https://api.github.com/users/imsodin/followers","following_url":"https://api.github.com/users/imsodin/following{/other_user}","gists_url":"https://api.github.com/users/imsodin/gists{/gist_id}","starred_url":"https://api.github.com/users/imsodin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imsodin/subscriptions","organizations_url":"https://api.github.com/users/imsodin/orgs","repos_url":"https://api.github.com/users/imsodin/repos","events_url":"https://api.github.com/users/imsodin/events{/privacy}","received_events_url":"https://api.github.com/users/imsodin/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":67767665,"node_id":"MDU6TGFiZWw2Nzc2NzY2NQ==","url":"https://api.github.com/repos/syncthing/syncthing/labels/bug","name":"bug","color":"d93f0b","default":true,"description":"A problem with current functionality, as opposed to missing functionality (enhancement)"},{"id":628314330,"node_id":"MDU6TGFiZWw2MjgzMTQzMzA=","url":"https://api.github.com/repos/syncthing/syncthing/labels/frozen-due-to-age","name":"frozen-due-to-age","color":"eeeeee","default":false,"description":"Issues closed and untouched for a long time, together with being locked for discussion"},{"id":2043110077,"node_id":"MDU6TGFiZWwyMDQzMTEwMDc3","url":"https://api.github.com/repos/syncthing/syncthing/labels/needs-triage","name":"needs-triage","color":"ce23af","default":false,"description":"New issues needed to be validated"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/syncthing/syncthing/milestones/63","html_url":"https://github.com/syncthing/syncthing/milestone/63","labels_url":"https://api.github.com/repos/syncthing/syncthing/milestones/63/labels","id":6628670,"node_id":"MDk6TWlsZXN0b25lNjYyODY3MA==","number":63,"title":"v1.16.0","description":"This release adds untrusted / encrypted devices for public testing. It should still be considered beta / testing-only.","creator":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":40,"state":"closed","created_at":"2021-04-06T06:29:18Z","updated_at":"2021-05-11T08:43:59Z","due_on":"2021-05-04T07:00:00Z","closed_at":"2021-05-04T09:00:11Z"},"comments":2,"created_at":"2021-03-30T12:28:29Z","updated_at":"2022-08-11T07:16:01Z","closed_at":"2021-03-31T06:59:17Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Reported in https://forum.syncthing.net/t/remote-device-status-on-encrypted-end/16577\r\n\r\nThe version vector on an encrypted file info has it's counter set to now whenever it's sent:\r\n\r\n```\r\n\t// The vector is set to something that is higher than any other version sent\r\n\t// previously, assuming people's clocks are correct. We do this because\r\n\t// there is no way for the insecure device on the other end to do proper\r\n\t// conflict resolution, so they will simply accept and keep whatever is the\r\n\t// latest version they see. The secure devices will decrypt the real\r\n\t// FileInfo, see the real Version, and act appropriately regardless of what\r\n\t// this fake version happens to be.\r\n\r\n\tversion := Vector{\r\n\t\tCounters: []Counter{\r\n\t\t\t{\r\n\t\t\t\tID:    1,\r\n\t\t\t\tValue: uint64(time.Now().UnixNano()),\r\n\t\t\t},\r\n\t\t},\r\n\t}\r\n```\r\n\r\nThat means if two devices are connected to an untrusted device, the second device sending an identical file-info, will send it with a newer version. Thus to the untrusted device the first device looks out of sync. The first device, having de-crypted the version, doesn't care.\r\n\r\nSynchronisation still works fine, even if multiple untrusted devices are involved. It just causes a few unnecessary index sends. For the remote status I see three options:\r\n\r\n1. Just don't display the status of remotes on untrusted nodes.\r\n2. Don't encrypt version vectors.\r\n3. Devise some scheme to get consistent encrypted/fake versions on all devices and that still is correctly ordered from the point of view of the untrusted device (e.g. just hashing won't do).\r\n\r\nAn option for 3. would be to keep using id 1, together with the maximum of all counter values in the plain vector (haven't thought much about possible corner cases yet :) ). However I am currently not sure it's worth encrypting the version at all: An untrusted node can already obtain the information about who/when files are modified, by observing from whom and when it receives index updates. That's not always possible (e.g. when receiving indexes indirectly, i.e. not from the device that changed the file) and less precise than having all the counters. Still I am not sure knowing who edited a file and when is sensitive information within our threat model. And the less difference there is between an encrypted file info and a plain one, the less issues like this will crop up with the implementation approach taken (untrusted devices work almost the same as any other device).","closed_by":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/7533/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/7533/timeline","performed_via_github_app":null,"state_reason":"completed"}