{"url":"https://api.github.com/repos/syncthing/syncthing/issues/8851","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/8851/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/8851/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/8851/events","html_url":"https://github.com/syncthing/syncthing/issues/8851","id":1654958715,"node_id":"I_kwDOAOCAEs5ipKp7","number":8851,"title":"\"Running global migration to fix encryption file sizes\" on every start","user":{"login":"Ctrl-Alt-Delight","id":129925856,"node_id":"U_kgDOB76C4A","avatar_url":"https://avatars.githubusercontent.com/u/129925856?v=4","gravatar_id":"","url":"https://api.github.com/users/Ctrl-Alt-Delight","html_url":"https://github.com/Ctrl-Alt-Delight","followers_url":"https://api.github.com/users/Ctrl-Alt-Delight/followers","following_url":"https://api.github.com/users/Ctrl-Alt-Delight/following{/other_user}","gists_url":"https://api.github.com/users/Ctrl-Alt-Delight/gists{/gist_id}","starred_url":"https://api.github.com/users/Ctrl-Alt-Delight/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ctrl-Alt-Delight/subscriptions","organizations_url":"https://api.github.com/users/Ctrl-Alt-Delight/orgs","repos_url":"https://api.github.com/users/Ctrl-Alt-Delight/repos","events_url":"https://api.github.com/users/Ctrl-Alt-Delight/events{/privacy}","received_events_url":"https://api.github.com/users/Ctrl-Alt-Delight/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":67767665,"node_id":"MDU6TGFiZWw2Nzc2NzY2NQ==","url":"https://api.github.com/repos/syncthing/syncthing/labels/bug","name":"bug","color":"d93f0b","default":true,"description":"A problem with current functionality, as opposed to missing functionality (enhancement)"},{"id":628314330,"node_id":"MDU6TGFiZWw2MjgzMTQzMzA=","url":"https://api.github.com/repos/syncthing/syncthing/labels/frozen-due-to-age","name":"frozen-due-to-age","color":"eeeeee","default":false,"description":"Issues closed and untouched for a long time, together with being locked for discussion"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/syncthing/syncthing/milestones/92","html_url":"https://github.com/syncthing/syncthing/milestone/92","labels_url":"https://api.github.com/repos/syncthing/syncthing/milestones/92/labels","id":9243167,"node_id":"MI_kwDOAOCAEs4AjQof","number":92,"title":"v1.23.4","description":"","creator":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":2,"state":"closed","created_at":"2023-04-04T07:24:27Z","updated_at":"2023-04-05T14:00:41Z","due_on":"2023-05-02T07:00:00Z","closed_at":"2023-04-05T14:00:41Z"},"comments":1,"created_at":"2023-04-05T05:24:39Z","updated_at":"2024-04-04T18:44:29Z","closed_at":"2023-04-05T13:26:05Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Does your log mention database corruption?** No\r\n\r\n### Required Information\r\n**Version of Syncthing:** syncthing v1.23.3 \"Fermium Flea\"\r\n**What Happened:** Syncthing will \"Running global migration to fix encryption file sizes\" on every start leaving syncthing unresponsive for over an hour with my 850GB encrypted folder set\r\n**What you expected to happen:** Only run it once on the first occurrence\r\n**Steps to reproduce the problem:**\r\n1. Have a large encrypted folder set\r\n2. Update to 1.23.3\r\n3. Start syncthing\r\n4. let it finish \"Running global migration to fix encryption file sizes\"\r\n5. restart syncthing\r\n6. it will once again \"Running global migration to fix encryption file sizes\"\r\n\r\n### Possible heart of the issue\r\nI am not a go developer, never had the pleasure, but if I am deciphering it correctly it looks like the migration function returns the result of the migration before it has a chance to update the \"globalMigrationVersion\" version to 1 ([line 39](https://github.com/syncthing/syncthing/blob/main/lib/syncthing/globalmigrations.go#L35-L39)) in the database so it will always run the encryptionTrailerSizeMigration function at startup (which is taking over an hour for my instance).\r\n\r\nI have reverted to syncthing v1.23.2 which thankfully downgraded with no issue\r\n","closed_by":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/8851/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/8851/timeline","performed_via_github_app":null,"state_reason":"completed"}