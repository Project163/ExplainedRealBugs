{"url":"https://api.github.com/repos/syncthing/syncthing/issues/2851","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/2851/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/2851/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/2851/events","html_url":"https://github.com/syncthing/syncthing/issues/2851","id":141746874,"node_id":"MDU6SXNzdWUxNDE3NDY4NzQ=","number":2851,"title":"syncthing-inotify + syncthing leading to dropped updates with common prefixes","user":{"login":"DarkHelmet433","id":342419,"node_id":"MDQ6VXNlcjM0MjQxOQ==","avatar_url":"https://avatars.githubusercontent.com/u/342419?v=4","gravatar_id":"","url":"https://api.github.com/users/DarkHelmet433","html_url":"https://github.com/DarkHelmet433","followers_url":"https://api.github.com/users/DarkHelmet433/followers","following_url":"https://api.github.com/users/DarkHelmet433/following{/other_user}","gists_url":"https://api.github.com/users/DarkHelmet433/gists{/gist_id}","starred_url":"https://api.github.com/users/DarkHelmet433/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DarkHelmet433/subscriptions","organizations_url":"https://api.github.com/users/DarkHelmet433/orgs","repos_url":"https://api.github.com/users/DarkHelmet433/repos","events_url":"https://api.github.com/users/DarkHelmet433/events{/privacy}","received_events_url":"https://api.github.com/users/DarkHelmet433/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":67767665,"node_id":"MDU6TGFiZWw2Nzc2NzY2NQ==","url":"https://api.github.com/repos/syncthing/syncthing/labels/bug","name":"bug","color":"d93f0b","default":true,"description":"A problem with current functionality, as opposed to missing functionality (enhancement)"},{"id":628314330,"node_id":"MDU6TGFiZWw2MjgzMTQzMzA=","url":"https://api.github.com/repos/syncthing/syncthing/labels/frozen-due-to-age","name":"frozen-due-to-age","color":"eeeeee","default":false,"description":"Issues closed and untouched for a long time, together with being locked for discussion"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":21,"created_at":"2016-03-18T01:11:09Z","updated_at":"2017-06-16T21:02:26Z","closed_at":"2016-03-18T12:16:36Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Running syncthing-inotify and syncthing 0.12.19 on FreeBSD-11.\n\nUntil recently we were happily using rsync to update a syncthing distribution pool in the freebsd.org cluster.  We rsync from the source-of-truth into the pool, syncthing-inotify notices the changes and informs syncthing.  Syncthing then fans out the data nicely.  All the syncthing nodes are a mesh of peers, the rsync forces them to converge if there's a problem.\n\nAfter our change from 0.12.13 to 0.12.19 we are now seeing dropped updates.   I provoked an update by deleting several directory trees and updating the indexes and signatures.  When the rsync happened, the inotify logs look correct and it appears that syncthing was correctly informed.\n\n```\n# touch index.txt ; touch *.sig\n.... \n[OK] 00:55:00 Syncthing is indexing change in admin-built: [amd64_10.txt.sig amd64_11.txt.sig amd64_9.txt.sig i386_10.txt.sig i386_11.txt.sig ia64_10.txt.sig index.txt index.txt.sig sparc64_10.txt.sig]\n```\n\nThe line in syncthing-inotify's log appears to correctly show that syncthing has received the correct notifications and has acknowledge them all correctly.\n\nHowever, the result is this on the master (the mesh peer receiving the updates):\n\n```\n-rw-r--r--  1 syncthing  syncthing  3421 Mar 17 23:53 index.txt\n-rw-r--r--  1 syncthing  syncthing   512 Mar 17 23:53 index.txt.sig\n-rw-r--r--  1 syncthing  syncthing   512 Mar 17 23:53 amd64_9.txt.sig\n-rw-r--r--  1 syncthing  syncthing   512 Mar 17 23:53 amd64_10.txt.sig\n```\n\nBut the rest of the mesh has:\n\n```\n-rw-r--r--  1 syncthing  syncthing  3421 Mar 17 23:53 index.txt\n-rw-r--r--  1 syncthing  syncthing   512 Mar 17 23:48 index.txt.sig\n-rw-r--r--  1 syncthing  syncthing   512 Mar 17 23:53 amd64_9.txt.sig\n-rw-r--r--  1 syncthing  syncthing   512 Mar 17 23:53 amd64_10.txt.sig\n```\n\nThe problematic file is \"index.txt.sig\". \n\nThe gui reports everything is in sync.  If I hit a 'rescan all' on the master, then the missing changes are discovered and the mesh resyncs. \n\n.stignore on the \"master\" mesh peer looks like this:\n\n```\n// rsync in-flight transfers\n// eg: foo.txz is transferred as .foo.txz.23yXh3\n.*\n```\n\nAnother example, this time not using rsync at all.  This is directly in the monitored file system area.\n\n```\nsyncthing@syncthing.nyi:/home/syncthing/built % touch foo.txt foo.txt.sig\nsyncthing@syncthing.nyi:/home/syncthing/built % ls -lrtT foo*\n-rw-r--r--  1 syncthing  syncthing  0 Mar 18 01:02:34 2016 foo.txt\n-rw-r--r--  1 syncthing  syncthing  0 Mar 18 01:02:34 2016 foo.txt.sig\n...\n[OK] 01:02:34 Syncthing is indexing change in admin-built: [foo.txt foo.txt.sig]\n```\n\nand on the peers:\n\n```\nroot@syncthing.ysv:~syncthing/built # ls -lrtT foo*\n-rw-r--r--  1 syncthing  syncthing  0 Mar 18 01:02:34 2016 foo.txt\n```\n\nfoo.txt.sig didn't even arrive. GUI reports all peers 100% in sync.\n\nThen I hit the 'rescan' button for the admin-built collection, and re-checked the peers:\n\n```\nroot@syncthing.ysv:~syncthing/built # ls -lrtT foo*\n-rw-r--r--  1 syncthing  syncthing  0 Mar 18 01:05:18 2016 foo.txt.sig\n-rw-r--r--  1 syncthing  syncthing  0 Mar 18 01:05:18 2016 foo.txt\n```\n\nIs there some magic involving suffixes that I'm not aware of?  Perhaps there's a prefix/suffix bug in notification handlers inside syncthing?\n\nWhat should I do next to track this down?\n\nPS: If I don't use a common prefix, eg: \"foo.txt and foo.sig\" instead of \"foo.txt and foo.txt.sig\" then it works.\n","closed_by":{"login":"st-review","id":16196517,"node_id":"MDQ6VXNlcjE2MTk2NTE3","avatar_url":"https://avatars.githubusercontent.com/u/16196517?v=4","gravatar_id":"","url":"https://api.github.com/users/st-review","html_url":"https://github.com/st-review","followers_url":"https://api.github.com/users/st-review/followers","following_url":"https://api.github.com/users/st-review/following{/other_user}","gists_url":"https://api.github.com/users/st-review/gists{/gist_id}","starred_url":"https://api.github.com/users/st-review/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/st-review/subscriptions","organizations_url":"https://api.github.com/users/st-review/orgs","repos_url":"https://api.github.com/users/st-review/repos","events_url":"https://api.github.com/users/st-review/events{/privacy}","received_events_url":"https://api.github.com/users/st-review/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/2851/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/2851/timeline","performed_via_github_app":null,"state_reason":"completed"}