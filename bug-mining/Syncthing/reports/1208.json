{"url":"https://api.github.com/repos/syncthing/syncthing/issues/7199","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/7199/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/7199/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/7199/events","html_url":"https://github.com/syncthing/syncthing/issues/7199","id":768246032,"node_id":"MDU6SXNzdWU3NjgyNDYwMzI=","number":7199,"title":"Build script -no-upgrade handling is unintuitive","user":{"login":"philpennock","id":559098,"node_id":"MDQ6VXNlcjU1OTA5OA==","avatar_url":"https://avatars.githubusercontent.com/u/559098?v=4","gravatar_id":"","url":"https://api.github.com/users/philpennock","html_url":"https://github.com/philpennock","followers_url":"https://api.github.com/users/philpennock/followers","following_url":"https://api.github.com/users/philpennock/following{/other_user}","gists_url":"https://api.github.com/users/philpennock/gists{/gist_id}","starred_url":"https://api.github.com/users/philpennock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/philpennock/subscriptions","organizations_url":"https://api.github.com/users/philpennock/orgs","repos_url":"https://api.github.com/users/philpennock/repos","events_url":"https://api.github.com/users/philpennock/events{/privacy}","received_events_url":"https://api.github.com/users/philpennock/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":122660823,"node_id":"MDU6TGFiZWwxMjI2NjA4MjM=","url":"https://api.github.com/repos/syncthing/syncthing/labels/build","name":"build","color":"1d76db","default":false,"description":"Issues caused by or requiring changes to the build system (scripts or Docker image)"},{"id":628314330,"node_id":"MDU6TGFiZWw2MjgzMTQzMzA=","url":"https://api.github.com/repos/syncthing/syncthing/labels/frozen-due-to-age","name":"frozen-due-to-age","color":"eeeeee","default":false,"description":"Issues closed and untouched for a long time, together with being locked for discussion"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/syncthing/syncthing/milestones/62","html_url":"https://github.com/syncthing/syncthing/milestone/62","labels_url":"https://api.github.com/repos/syncthing/syncthing/milestones/62/labels","id":6443170,"node_id":"MDk6TWlsZXN0b25lNjQ0MzE3MA==","number":62,"title":"v1.15.0","description":"This release fixes a vulnerability where Syncthing and the relay server can crash due to malformed relay protocol messages (CVE-2021-21404); see https://github.com/syncthing/syncthing/security/advisories/GHSA-x462-89pf-6r5h.\r\n\r\nThis release updates the CLI to use subcommands and adds the subcommands `cli` (previously standalone `stcli` utility) and `decrypt` (for offline verifying and decrypting encrypted folders).\r\n\r\nWith this release we invite everyone to test the \"untrusted (encrypted) devices\" feature. You should not use it yet on important production data. Thus UI controls are hidden behind a feature flag. For more information, visit: \r\nhttps://forum.syncthing.net/t/testing-untrusted-encrypted-devices/16470","creator":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":88,"state":"closed","created_at":"2021-02-17T10:21:38Z","updated_at":"2021-04-29T20:05:04Z","due_on":"2021-04-06T07:00:00Z","closed_at":"2021-04-06T06:17:01Z"},"comments":1,"created_at":"2020-12-15T22:07:20Z","updated_at":"2022-08-11T07:19:07Z","closed_at":"2021-02-25T08:29:15Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Having discovered that my self-built binary had been auto-upgraded, I went looking to disable that feature.  I found the `build.go` option `-no-upgrade` and it almost works.\r\n\r\n```console\r\n$ git describe\r\nv1.12.1-rc.1-12-g466e8a5c\r\n```\r\n\r\nThe problem is that the `stupgrades` command, understandably, doesn't compile under the `noupgrade` build tag.\r\n\r\nI fixed it for myself the fast and crude way, but I'm not familiar enough with the code base to know what the best structure is, so rather than fork/dance/PR, here's a fast fix which WorksForMeâ„¢; a better fix might be to move a bunch of logic out of `init()` time so that flags are available at the time the data structure is first built.\r\n\r\n```patch\r\ndiff --git a/build.go b/build.go\r\nindex cc23c92d..9c13590f 100644\r\n--- a/build.go\r\n+++ b/build.go\r\n@@ -256,6 +256,18 @@ func main() {\r\n \t\t}()\r\n \t}\r\n \r\n+\tif noupgrade {\r\n+\t\tall := targets[\"all\"]\r\n+\t\tt := make([]string, 0, len(all.buildPkgs))\r\n+\t\tfor _, s := range all.buildPkgs {\r\n+\t\t\tif s != \"github.com/syncthing/syncthing/cmd/stupgrades\" {\r\n+\t\t\t\tt = append(t, s)\r\n+\t\t\t}\r\n+\t\t}\r\n+\t\tall.buildPkgs = t\r\n+\t\ttargets[\"all\"] = all\r\n+\t}\r\n+\r\n \t// Invoking build.go with no parameters at all builds everything (incrementally),\r\n \t// which is what you want for maximum error checking during development.\r\n \tif flag.NArg() == 0 {\r\n```","closed_by":{"login":"imsodin","id":15955093,"node_id":"MDQ6VXNlcjE1OTU1MDkz","avatar_url":"https://avatars.githubusercontent.com/u/15955093?v=4","gravatar_id":"","url":"https://api.github.com/users/imsodin","html_url":"https://github.com/imsodin","followers_url":"https://api.github.com/users/imsodin/followers","following_url":"https://api.github.com/users/imsodin/following{/other_user}","gists_url":"https://api.github.com/users/imsodin/gists{/gist_id}","starred_url":"https://api.github.com/users/imsodin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imsodin/subscriptions","organizations_url":"https://api.github.com/users/imsodin/orgs","repos_url":"https://api.github.com/users/imsodin/repos","events_url":"https://api.github.com/users/imsodin/events{/privacy}","received_events_url":"https://api.github.com/users/imsodin/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/7199/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/7199/timeline","performed_via_github_app":null,"state_reason":"completed"}