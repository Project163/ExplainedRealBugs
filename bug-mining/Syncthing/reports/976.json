{"url":"https://api.github.com/repos/syncthing/syncthing/issues/5948","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/5948/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/5948/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/5948/events","html_url":"https://github.com/syncthing/syncthing/issues/5948","id":480040082,"node_id":"MDU6SXNzdWU0ODAwNDAwODI=","number":5948,"title":"Improve free space checking when syncing","user":{"login":"hiqua","id":3812042,"node_id":"MDQ6VXNlcjM4MTIwNDI=","avatar_url":"https://avatars.githubusercontent.com/u/3812042?v=4","gravatar_id":"","url":"https://api.github.com/users/hiqua","html_url":"https://github.com/hiqua","followers_url":"https://api.github.com/users/hiqua/followers","following_url":"https://api.github.com/users/hiqua/following{/other_user}","gists_url":"https://api.github.com/users/hiqua/gists{/gist_id}","starred_url":"https://api.github.com/users/hiqua/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hiqua/subscriptions","organizations_url":"https://api.github.com/users/hiqua/orgs","repos_url":"https://api.github.com/users/hiqua/repos","events_url":"https://api.github.com/users/hiqua/events{/privacy}","received_events_url":"https://api.github.com/users/hiqua/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":67767667,"node_id":"MDU6TGFiZWw2Nzc2NzY2Nw==","url":"https://api.github.com/repos/syncthing/syncthing/labels/enhancement","name":"enhancement","color":"0e8a16","default":true,"description":"New features or improvements of some kind, as opposed to a problem (bug)"},{"id":628314330,"node_id":"MDU6TGFiZWw2MjgzMTQzMzA=","url":"https://api.github.com/repos/syncthing/syncthing/labels/frozen-due-to-age","name":"frozen-due-to-age","color":"eeeeee","default":false,"description":"Issues closed and untouched for a long time, together with being locked for discussion"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/syncthing/syncthing/milestones/39","html_url":"https://github.com/syncthing/syncthing/milestone/39","labels_url":"https://api.github.com/repos/syncthing/syncthing/milestones/39/labels","id":4644179,"node_id":"MDk6TWlsZXN0b25lNDY0NDE3OQ==","number":39,"title":"v1.3.0","description":"","creator":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":25,"state":"closed","created_at":"2019-09-09T12:43:56Z","updated_at":"2019-10-01T05:38:21Z","due_on":"2019-10-01T07:00:00Z","closed_at":"2019-10-01T05:38:21Z"},"comments":6,"created_at":"2019-08-13T09:00:15Z","updated_at":"2020-08-16T07:02:34Z","closed_at":"2019-08-16T07:40:55Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Summary\r\n\r\nIn case of partial synchronization, the synchronization order and the minimum free disk space parameters are not properly taken into account.\r\n\r\n## Situation\r\n\r\nI have a folder which I want to synchronize in alphabetic order, with a minimum free disk space of 8% (for **this folder**, not the global free disk space parameter of the database) on a device D, synchronized from another device S containing the full folder. I expect this synchronization to be sometimes partial, meaning that the folder can be bigger than there is free space on D.\r\n\r\n## Expected behavior\r\n\r\nIdeally, the partial sync would still take the two parameters into account, meaning that, by the time it gets stuck (because there's no more memory available):\r\n1. the files on D are the first in alphabetic (consecutive) order on S\r\n2. there's still at least 8% free disk space on D\r\n\r\nI would expect Syncthing to compute which files it can download given the current free disk space, and to stop when the minimum free disk space is reached. I would also expect Syncthing to favor one (potentially partial) file over several partial files . At least, I would also expect that no file is partially downloaded if the free space is less than the given parameter.\r\n## Actual behavior\r\n\r\nCurrently, both conditions are violated:\r\n1. fully downloaded files are not in alphabetic consecutive order on S (some files are partially downloaded, i.e., there are multiple -- 4 last time I tried -- .syncthing.$FILENAME files in the folder)\r\n2. there's very little space left (less than 1%).\r\n\r\n## Versions:\r\n* S runs on 1.0.0, Debian Buster\r\n* D on 1.2.0, Android 9 (using the `official` app, not the fork)\r\n\r\nI didn't see anything in the changelog of 1.2.1 that could help mitigate this issue.\r\n\r\nEdit: updated to add details asked in comments","closed_by":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/5948/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/5948/timeline","performed_via_github_app":null,"state_reason":"completed"}