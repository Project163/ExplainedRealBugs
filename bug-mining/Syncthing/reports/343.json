{"url":"https://api.github.com/repos/syncthing/syncthing/issues/2246","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/2246/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/2246/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/2246/events","html_url":"https://github.com/syncthing/syncthing/issues/2246","id":105165671,"node_id":"MDU6SXNzdWUxMDUxNjU2NzE=","number":2246,"title":"Relay stuff panics when disabled","user":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":67767665,"node_id":"MDU6TGFiZWw2Nzc2NzY2NQ==","url":"https://api.github.com/repos/syncthing/syncthing/labels/bug","name":"bug","color":"d93f0b","default":true,"description":"A problem with current functionality, as opposed to missing functionality (enhancement)"},{"id":628314330,"node_id":"MDU6TGFiZWw2MjgzMTQzMzA=","url":"https://api.github.com/repos/syncthing/syncthing/labels/frozen-due-to-age","name":"frozen-due-to-age","color":"eeeeee","default":false,"description":"Issues closed and untouched for a long time, together with being locked for discussion"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2015-09-07T07:59:05Z","updated_at":"2017-06-16T21:05:13Z","closed_at":"2015-09-09T10:59:37Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"In this case because global discovery is disabled.\n\n```\n[I6KAH] 09:39:21 INFO: syncthing v0.12.0-beta0+76-gf2db1c8 \"Beryllium Bedbug\" (go1.5 darwin-amd64 default) jb@syno 2015-09-06 19:24:00 UTC\n...\n[I6KAH] 09:39:21 INFO: Device JMFJCXB-GZDE4BN-OCJE3VF-65GYZNU-AIVJRET-3J6HMRQ-AUQIGJO-FKNHMQU is \"s2\" at [tcp://127.0.0.1:22002]\nPanic at 2015-09-07T09:39:21+02:00\npanic: runtime error: invalid memory address or nil pointer dereference\n[signal 0xb code=0x1 addr=0x0 pc=0x306f98]\n\ngoroutine 73 [running]:\ngithub.com/syncthing/syncthing/lib/relay.(*Svc).ClientStatus(0x0, 0x1)\n        /Users/jb/src/github.com/syncthing/syncthing/lib/relay/relay.go:195 +0x1b8\ngithub.com/syncthing/syncthing/lib/discover.(*Discoverer).announcementPkt(0xc8200b8700, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, ...)\n        /Users/jb/src/github.com/syncthing/syncthing/lib/discover/discover.go:314 +0x23c\ngithub.com/syncthing/syncthing/lib/discover.(*Discoverer).sendLocalAnnouncements(0xc8200b8700)\n        /Users/jb/src/github.com/syncthing/syncthing/lib/discover/discover.go:329 +0x38\ncreated by github.com/syncthing/syncthing/lib/discover.(*Discoverer).StartLocal\n        /Users/jb/src/github.com/syncthing/syncthing/lib/discover/discover.go:95 +0x263\n```\n\nIt's fairly clear cut but a little bit annoying to fix cleanly. Since relaying is disabled, we have `var relaySvc *relay.Svc` in main which is nil, that we then pass to the discovery service. But the discovery service takes a `discovery.relayStatusProvider` interface. Since we're passing a _variable_ that is nil, and not a nil _literal_, the other side gets a \"typed nil\" interface, so the check in there for `relayStatusProvide == nil` ends up being false even though the interface contains a nil pointer.\n\nThe cleanest way is probably\n\n```\nif relaySvc == nil {\n    disc = discover.NewDiscoverer(myID, opts.ListenAddress, nil)\n} else {\n    disc = discover.NewDiscoverer(myID, opts.ListenAddress, relaySvc)\n}\n```\n\nin main.go, but goddamn that looks like crap...\n","closed_by":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/2246/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/2246/timeline","performed_via_github_app":null,"state_reason":"completed"}