{"url":"https://api.github.com/repos/syncthing/syncthing/issues/6372","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/6372/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/6372/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/6372/events","html_url":"https://github.com/syncthing/syncthing/issues/6372","id":571849328,"node_id":"MDU6SXNzdWU1NzE4NDkzMjg=","number":6372,"title":"Reduce database size by optimizing version list storage","user":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":67767667,"node_id":"MDU6TGFiZWw2Nzc2NzY2Nw==","url":"https://api.github.com/repos/syncthing/syncthing/labels/enhancement","name":"enhancement","color":"0e8a16","default":true,"description":"New features or improvements of some kind, as opposed to a problem (bug)"},{"id":628314330,"node_id":"MDU6TGFiZWw2MjgzMTQzMzA=","url":"https://api.github.com/repos/syncthing/syncthing/labels/frozen-due-to-age","name":"frozen-due-to-age","color":"eeeeee","default":false,"description":"Issues closed and untouched for a long time, together with being locked for discussion"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/syncthing/syncthing/milestones/49","html_url":"https://github.com/syncthing/syncthing/milestone/49","labels_url":"https://api.github.com/repos/syncthing/syncthing/milestones/49/labels","id":5409298,"node_id":"MDk6TWlsZXN0b25lNTQwOTI5OA==","number":49,"title":"v1.7.0","description":"This release performs a database migration to optimize for clusters with many devices.","creator":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":51,"state":"closed","created_at":"2020-05-12T06:31:23Z","updated_at":"2020-07-07T06:53:57Z","due_on":"2020-07-07T07:00:00Z","closed_at":"2020-07-07T06:53:57Z"},"comments":14,"created_at":"2020-02-27T06:18:43Z","updated_at":"2021-05-31T07:02:44Z","closed_at":"2020-05-30T07:50:26Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"It's somewhat rare in the grand scheme of things, but there are setups with hundreds of devices in a cluster. In some cases this results in files with hundreds of entries in the version vector. This is fine and expected. In our global version list we keep for each file an array of `(version vector, device, invalid)`. In the case where there are many devices and a long version vector we get that vector repeated for every device and this global entry can grow to hundreds of kilobytes for a single file entry.\r\n\r\nThing is though, in the steady state all these hundreds of version vectors are actually the same. So if we grouped the version list by version vector, with each item being `(version vector, (device, invalid)...)` we'd cut that by a factor hundreds.\r\n\r\nIn one database I'm looking at, the change would be from\r\n\r\n```\r\n 0x00: 1169574 items, 70491 KB keys +  5506325 KB data, 60 B +   4707 B avg,   7634 B max\r\n 0x01:   52634 items,  3004 KB keys +  5412346 KB data, 57 B + 102829 B avg, 517727 B max\r\n 0x02:  259848 items, 23082 KB keys +     1039 KB data, 88 B +      4 B avg,    256 B max\r\n...\r\n Total 1581101 items, 98761 KB keys + 10935349 KB data.\r\n```\r\n\r\nto\r\n\r\n```\r\n 0x00: 1169574 items, 70491 KB keys + 5506325 KB data, 60 B +  4707 B avg,  7634 B max\r\n 0x01:   52634 items,  3004 KB keys +  818664 KB data, 57 B + 15553 B avg, 56103 B max\r\n 0x02:  259848 items, 23082 KB keys +    1039 KB data, 88 B +     4 B avg,   256 B max\r\n...\r\n Total 1581101 items, 98761 KB keys + 6341667 KB data.\r\n```\r\n\r\nor about a 40% reduction in database size. Smaller setups aren't going to gain that, but it won't hurt either.\r\n\r\nThe actual file entries still contain all the copies of the version vectors, so class 0x00 is large. Theoretically we could do the same there as with the block lists and bring that down too, but that would actually hurt small setups with the extra indirection. Although we could just skip the indirection (storing it like we do now) if the version list is smaller than *x*, and have `getFile` handle both the version list being already in place or there being a hash pointer to it.","closed_by":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/6372/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/6372/timeline","performed_via_github_app":null,"state_reason":"completed"}