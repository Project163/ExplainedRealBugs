{"url":"https://api.github.com/repos/syncthing/syncthing/issues/10072","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/10072/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/10072/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/10072/events","html_url":"https://github.com/syncthing/syncthing/issues/10072","id":3023036459,"node_id":"I_kwDOAOCAEs60L-Ar","number":10072,"title":"strelaysrv: `-per-session-rate` parameter seems to not be working as expected","user":{"login":"szu17dmy","id":32405309,"node_id":"MDQ6VXNlcjMyNDA1MzA5","avatar_url":"https://avatars.githubusercontent.com/u/32405309?v=4","gravatar_id":"","url":"https://api.github.com/users/szu17dmy","html_url":"https://github.com/szu17dmy","followers_url":"https://api.github.com/users/szu17dmy/followers","following_url":"https://api.github.com/users/szu17dmy/following{/other_user}","gists_url":"https://api.github.com/users/szu17dmy/gists{/gist_id}","starred_url":"https://api.github.com/users/szu17dmy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szu17dmy/subscriptions","organizations_url":"https://api.github.com/users/szu17dmy/orgs","repos_url":"https://api.github.com/users/szu17dmy/repos","events_url":"https://api.github.com/users/szu17dmy/events{/privacy}","received_events_url":"https://api.github.com/users/szu17dmy/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":67767665,"node_id":"MDU6TGFiZWw2Nzc2NzY2NQ==","url":"https://api.github.com/repos/syncthing/syncthing/labels/bug","name":"bug","color":"d93f0b","default":true,"description":"A problem with current functionality, as opposed to missing functionality (enhancement)"},{"id":2043110077,"node_id":"MDU6TGFiZWwyMDQzMTEwMDc3","url":"https://api.github.com/repos/syncthing/syncthing/labels/needs-triage","name":"needs-triage","color":"ce23af","default":false,"description":"New issues needed to be validated"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/syncthing/syncthing/milestones/121","html_url":"https://github.com/syncthing/syncthing/milestone/121","labels_url":"https://api.github.com/repos/syncthing/syncthing/milestones/121/labels","id":12719462,"node_id":"MI_kwDOAOCAEs4AwhVm","number":121,"title":"v1.29.6","description":"","creator":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":34,"state":"closed","created_at":"2025-04-12T12:51:39Z","updated_at":"2025-05-26T13:22:16Z","due_on":null,"closed_at":"2025-05-26T13:22:16Z"},"comments":1,"created_at":"2025-04-27T12:00:59Z","updated_at":"2025-05-06T07:58:27Z","closed_at":"2025-04-30T14:25:02Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### What happened?\n\nHi everyone,\n\nOur team has been utilizing Syncthing and recently started exploring the `-per-session-rate` parameter to manage bandwidth more granularly.\n\nOur understanding is that `-per-session-rate` should cap each individual device pair's connection speed, but the aggregate speed across all connections could exceed this limit.\n\nHowever, we've encountered behavior where the total aggregate transfer rate seems to be unexpectedly capped at the value set by `-per-session-rate`, even when multiple peers are actively syncing. We wanted to inquire if this is expected or if we might be seeing an issue.\n\n## Actual Observed Behavior\n\nBelow (or attached) is a screenshot from our monitoring of the relay server's network traffic during a relevant period. During this time, the strelaysrv instance was running with parameters including `-global-rate=50000000` and `-per-session-rate=6250000`. \n\n![Image](https://github.com/user-attachments/assets/547241c3-7c34-408b-acff-9b6d5135d4cf)\n\n50000000bytes/s == 50000KB/s == 50MB/s == 400Mbps; approx.\n6250000bytes/s == 6250KB/s == 6.25MB/s == 50Mbps; approx.\n\n## Expected Behavior\n\nWe expected each individual session (e.g., A<->B, C<->D) to be independently capped at approximately 50Mbps.\n\nWe expected the total aggregate transfer rate for them to be the sum of the active session rates, potentially reaching up to 400Mbps if connected to more peers.\n\n## Our Questions\n\nBased on our observations, and after a preliminary review of the relevant code sections, it appears the rate limiter instance associated with the `-per-session-rate` parameter in strelaysrv might be implemented as a single, shared instance across all relayed sessions, rather than as distinct limiters created per session. Could you please confirm if this understanding of the current implementation is accurate?\n\nhttps://github.com/syncthing/syncthing/blob/93e72cc83fac979bc23c201697491c5f824c3918/cmd/strelaysrv/main.go#L54\n\nThanks.\n\n### Syncthing version\n\nv1.22.1, no related changes were made after this version\n\n### Platform & operating system\n\nLinux amd64\n\n### Browser version\n\n_No response_\n\n### Relevant log output\n\n```shell\n\n```","closed_by":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/10072/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/10072/timeline","performed_via_github_app":null,"state_reason":"completed"}