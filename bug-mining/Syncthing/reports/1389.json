{"url":"https://api.github.com/repos/syncthing/syncthing/issues/9033","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/9033/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/9033/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/9033/events","html_url":"https://github.com/syncthing/syncthing/issues/9033","id":1843319150,"node_id":"I_kwDOAOCAEs5t3tFu","number":9033,"title":"Github API rate limit response preventing automatic upgrades","user":{"login":"alyandon","id":852730,"node_id":"MDQ6VXNlcjg1MjczMA==","avatar_url":"https://avatars.githubusercontent.com/u/852730?v=4","gravatar_id":"","url":"https://api.github.com/users/alyandon","html_url":"https://github.com/alyandon","followers_url":"https://api.github.com/users/alyandon/followers","following_url":"https://api.github.com/users/alyandon/following{/other_user}","gists_url":"https://api.github.com/users/alyandon/gists{/gist_id}","starred_url":"https://api.github.com/users/alyandon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alyandon/subscriptions","organizations_url":"https://api.github.com/users/alyandon/orgs","repos_url":"https://api.github.com/users/alyandon/repos","events_url":"https://api.github.com/users/alyandon/events{/privacy}","received_events_url":"https://api.github.com/users/alyandon/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":122660823,"node_id":"MDU6TGFiZWwxMjI2NjA4MjM=","url":"https://api.github.com/repos/syncthing/syncthing/labels/build","name":"build","color":"1d76db","default":false,"description":"Issues caused by or requiring changes to the build system (scripts or Docker image)"},{"id":628314330,"node_id":"MDU6TGFiZWw2MjgzMTQzMzA=","url":"https://api.github.com/repos/syncthing/syncthing/labels/frozen-due-to-age","name":"frozen-due-to-age","color":"eeeeee","default":false,"description":"Issues closed and untouched for a long time, together with being locked for discussion"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":16,"created_at":"2023-08-09T14:02:31Z","updated_at":"2024-08-09T18:44:32Z","closed_at":"2023-08-09T19:01:26Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Versions:  Various - as old as 1.25.0 to current\r\nOS: Windows\r\n\r\nProblem:  This has been an ongoing issue for me where I have multiple Windows machines that refuse to automatically update which forces me to download the latest binary manually and copy it into my syncthing directory.  The error is always \"Automatic upgrade: zip: not a valid zip file\".  I disabled Windows Defender as a first troubleshooting step but that did not resolve the issue.\r\n\r\nI decided to take it upon myself to add some debugging code and build an older version of syncthing so the automatic upgrade triggers when I start it.  Here is an excerpt from the result:\r\n\r\n```\r\n[IDMZY] 2023/08/09 08:44:00 INFO: Automatic upgrade (current \"v1.23.6-dirty\" < latest \"v1.23.7\")\r\n### start my logging changes\r\n[IDMZY] 2023/08/09 08:44:00 INFO: loading \"https://api.github.com/repos/syncthing/syncthing/releases/assets/120749509\"\r\n[IDMZY] 2023/08/09 08:44:00 INFO: readZip is short debug: 279 bytes\r\n[IDMZY] 2023/08/09 08:44:00 INFO: dump: {\"message\":\"API rate limit exceeded for 24.243.x.x. (But here's the good news: Authenticated requests get a higher rate limit. Check out the documentation for more details.)\",\"documentation_url\":\"https://docs.github.com/rest/overview/resources-in-the-rest-api#rate-limiting\"}\r\n### end my logging changes\r\n[IDMZY] 2023/08/09 08:44:00 WARNING: Automatic upgrade: zip: not a valid zip file\r\n```\r\n\r\nSo, it looks like a rate limit error is being returned by Github when syncthing attempts the fetch but the relevant code is assuming the result is always a valid zip file.\r\n\r\nThe problem(s) as I see it:\r\n\r\n1) I have a moderately large swarm with 5 machines behind that 24.243.x.x address.  Syncthing appears to aggressively query that API endpoint repeatedly every time it connects to a peer and the peer reports it is running a later version.\r\n2) \"not a valid zip file\" is not really a useful error to report to the user.  Syncthing should verify that the result of that fetch is actually a zip file before feeding it to readZip.\r\n\r\nWhat happened:\r\nAutomatic upgrades don't work reliably for me.\r\n\r\nWhat should happen:\r\nAutomatic upgrades should Just Work(tm).","closed_by":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/9033/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/9033/timeline","performed_via_github_app":null,"state_reason":"completed"}