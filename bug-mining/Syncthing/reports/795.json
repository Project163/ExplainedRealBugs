{"url":"https://api.github.com/repos/syncthing/syncthing/issues/5025","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/5025/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/5025/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/5025/events","html_url":"https://github.com/syncthing/syncthing/issues/5025","id":335037868,"node_id":"MDU6SXNzdWUzMzUwMzc4Njg=","number":5025,"title":"Stuck in CPU consuming accept loop when out of file descriptors","user":{"login":"jcs","id":9888,"node_id":"MDQ6VXNlcjk4ODg=","avatar_url":"https://avatars.githubusercontent.com/u/9888?v=4","gravatar_id":"","url":"https://api.github.com/users/jcs","html_url":"https://github.com/jcs","followers_url":"https://api.github.com/users/jcs/followers","following_url":"https://api.github.com/users/jcs/following{/other_user}","gists_url":"https://api.github.com/users/jcs/gists{/gist_id}","starred_url":"https://api.github.com/users/jcs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jcs/subscriptions","organizations_url":"https://api.github.com/users/jcs/orgs","repos_url":"https://api.github.com/users/jcs/repos","events_url":"https://api.github.com/users/jcs/events{/privacy}","received_events_url":"https://api.github.com/users/jcs/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":67767665,"node_id":"MDU6TGFiZWw2Nzc2NzY2NQ==","url":"https://api.github.com/repos/syncthing/syncthing/labels/bug","name":"bug","color":"d93f0b","default":true,"description":"A problem with current functionality, as opposed to missing functionality (enhancement)"},{"id":628314330,"node_id":"MDU6TGFiZWw2MjgzMTQzMzA=","url":"https://api.github.com/repos/syncthing/syncthing/labels/frozen-due-to-age","name":"frozen-due-to-age","color":"eeeeee","default":false,"description":"Issues closed and untouched for a long time, together with being locked for discussion"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/syncthing/syncthing/milestones/23","html_url":"https://github.com/syncthing/syncthing/milestone/23","labels_url":"https://api.github.com/repos/syncthing/syncthing/milestones/23/labels","id":3343149,"node_id":"MDk6TWlsZXN0b25lMzM0MzE0OQ==","number":23,"title":"v0.14.49","description":null,"creator":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":78,"state":"closed","created_at":"2018-05-14T07:01:53Z","updated_at":"2018-07-24T20:19:43Z","due_on":null,"closed_at":"2018-07-24T20:19:43Z"},"comments":5,"created_at":"2018-06-22T22:35:08Z","updated_at":"2019-06-27T07:03:02Z","closed_at":"2018-06-27T06:24:34Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Syncthing Version: v0.14.47, OpenBSD (64 bit)\r\nOS Version: OpenBSD 6.3-current\r\nBrowser Version: N/A\r\n\r\nI'm trying to sync a new directory with many subdirectories and files.  A few minutes in, syncthing's web interface starts showing:\r\n\r\n````\r\n 2018-06-22 17:26:51: Listen (BEP/tcp): Accepting connection: accept tcp 0.0.0.0:22000: accept: too many open files \r\n````\r\n\r\nThe two syncthing processes are now eating as much CPU as possible:\r\n\r\n````\r\nUSER       PID %CPU %MEM   VSZ   RSS TT  STAT  STARTED       TIME COMMAND\r\njcs      13038 57.4  1.3 108016 104036 p2  RN/1   5:15PM    5:40.42 /usr/local/bin/syncthing -no-browser\r\njcs      19093 42.5  0.2 28560 19244 p2  R/1    5:15PM    2:21.42 /usr/local/bin/syncthing -no-browser\r\n````\r\n\r\nA `ktrace` shows the first process spinning on `accept` and logging that it has too many files open.\r\n\r\n````\r\njcs@frob:~> fstat -p 13038 | wc -l\r\n    8003\r\n````\r\n\r\nMy login class has a limit of 8000 file descriptors, which I've already raised a bunch of times just trying to get this sync going.  OpenBSD's default process limit is 1024 files.\r\n\r\nSyncthing should be using `getrlimit` at startup to check its open file limit and not open that many files.  At the very least, when it hits the file limit, it should back down and either close connections or something to not spin trying to do the same thing over and over again.","closed_by":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/5025/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/5025/timeline","performed_via_github_app":null,"state_reason":"completed"}