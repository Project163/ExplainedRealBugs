{"url":"https://api.github.com/repos/syncthing/syncthing/issues/7740","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/7740/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/7740/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/7740/events","html_url":"https://github.com/syncthing/syncthing/issues/7740","id":910125405,"node_id":"MDU6SXNzdWU5MTAxMjU0MDU=","number":7740,"title":"Incorrect local state when using negated patterns inside ignored parent folder on both sides","user":{"login":"tomasz1986","id":5626656,"node_id":"MDQ6VXNlcjU2MjY2NTY=","avatar_url":"https://avatars.githubusercontent.com/u/5626656?v=4","gravatar_id":"","url":"https://api.github.com/users/tomasz1986","html_url":"https://github.com/tomasz1986","followers_url":"https://api.github.com/users/tomasz1986/followers","following_url":"https://api.github.com/users/tomasz1986/following{/other_user}","gists_url":"https://api.github.com/users/tomasz1986/gists{/gist_id}","starred_url":"https://api.github.com/users/tomasz1986/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tomasz1986/subscriptions","organizations_url":"https://api.github.com/users/tomasz1986/orgs","repos_url":"https://api.github.com/users/tomasz1986/repos","events_url":"https://api.github.com/users/tomasz1986/events{/privacy}","received_events_url":"https://api.github.com/users/tomasz1986/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":67767665,"node_id":"MDU6TGFiZWw2Nzc2NzY2NQ==","url":"https://api.github.com/repos/syncthing/syncthing/labels/bug","name":"bug","color":"d93f0b","default":true,"description":"A problem with current functionality, as opposed to missing functionality (enhancement)"},{"id":628314330,"node_id":"MDU6TGFiZWw2MjgzMTQzMzA=","url":"https://api.github.com/repos/syncthing/syncthing/labels/frozen-due-to-age","name":"frozen-due-to-age","color":"eeeeee","default":false,"description":"Issues closed and untouched for a long time, together with being locked for discussion"}],"state":"closed","locked":true,"assignee":{"login":"imsodin","id":15955093,"node_id":"MDQ6VXNlcjE1OTU1MDkz","avatar_url":"https://avatars.githubusercontent.com/u/15955093?v=4","gravatar_id":"","url":"https://api.github.com/users/imsodin","html_url":"https://github.com/imsodin","followers_url":"https://api.github.com/users/imsodin/followers","following_url":"https://api.github.com/users/imsodin/following{/other_user}","gists_url":"https://api.github.com/users/imsodin/gists{/gist_id}","starred_url":"https://api.github.com/users/imsodin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imsodin/subscriptions","organizations_url":"https://api.github.com/users/imsodin/orgs","repos_url":"https://api.github.com/users/imsodin/repos","events_url":"https://api.github.com/users/imsodin/events{/privacy}","received_events_url":"https://api.github.com/users/imsodin/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"imsodin","id":15955093,"node_id":"MDQ6VXNlcjE1OTU1MDkz","avatar_url":"https://avatars.githubusercontent.com/u/15955093?v=4","gravatar_id":"","url":"https://api.github.com/users/imsodin","html_url":"https://github.com/imsodin","followers_url":"https://api.github.com/users/imsodin/followers","following_url":"https://api.github.com/users/imsodin/following{/other_user}","gists_url":"https://api.github.com/users/imsodin/gists{/gist_id}","starred_url":"https://api.github.com/users/imsodin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imsodin/subscriptions","organizations_url":"https://api.github.com/users/imsodin/orgs","repos_url":"https://api.github.com/users/imsodin/repos","events_url":"https://api.github.com/users/imsodin/events{/privacy}","received_events_url":"https://api.github.com/users/imsodin/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/syncthing/syncthing/milestones/68","html_url":"https://github.com/syncthing/syncthing/milestone/68","labels_url":"https://api.github.com/repos/syncthing/syncthing/milestones/68/labels","id":6942408,"node_id":"MDk6TWlsZXN0b25lNjk0MjQwOA==","number":68,"title":"v1.18.1","description":"","creator":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":27,"state":"closed","created_at":"2021-07-13T14:49:48Z","updated_at":"2021-08-03T06:52:13Z","due_on":"2021-08-03T07:00:00Z","closed_at":"2021-08-03T06:45:27Z"},"comments":1,"created_at":"2021-06-03T05:53:34Z","updated_at":"2022-08-11T07:12:38Z","closed_at":"2021-06-27T06:48:57Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"I have finally managed to reproduce https://forum.syncthing.net/t/folder-stuck-in-sync-and-non-matching-local-and-global-states/16431.\r\n\r\n1. On Device 1, create a folder called `test1`.\r\n2. In the folder, create a folder `test`, and then inside it another folder `test`.\r\n3. The folder structure now looks like `test1\\test\\test`.\r\n4. Add the `test1` folder to Syncthing with the following ignore patterns.\r\n   ```\r\n   !/*/\r\n   *\r\n   ```\r\n   As expected, both the subfolder and its parent folder have been indexed.\r\n   \r\n   ![image](https://user-images.githubusercontent.com/5626656/120593696-d4317f80-c47a-11eb-844b-e22c93bd0a7d.png)\r\n\r\n5. Share the folder with Device 2, and accept it there with the same ignore patterns as above.\r\n6. The folder state on Device 2 is correct, but the local state on Device 1 has changed. The parent folder has been ignored, despite its child being unignored.\r\n\r\n   ![image](https://user-images.githubusercontent.com/5626656/120593803-f62b0200-c47a-11eb-8f24-3503984eca31.png)\r\n   ![image](https://user-images.githubusercontent.com/5626656/120593806-f7f4c580-c47a-11eb-9700-df1fe3213c7d.png)\r\n\r\nLogs with `model` and `db`:\r\n\r\n[syncthing1.log](https://github.com/syncthing/syncthing/files/6589230/syncthing1.log)\r\n[syncthing2.log](https://github.com/syncthing/syncthing/files/6589231/syncthing2.log)\r\n\r\nOne thing to note is that the folder states are correct when not using the same ignore patterns on the other side. It seems that it is only when the same negate/ignore patterns are applied to both sides that the issue occurs.\r\n","closed_by":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/7740/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/7740/timeline","performed_via_github_app":null,"state_reason":"completed"}