{"url":"https://api.github.com/repos/syncthing/syncthing/issues/3466","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/3466/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/3466/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/3466/events","html_url":"https://github.com/syncthing/syncthing/issues/3466","id":168589546,"node_id":"MDU6SXNzdWUxNjg1ODk1NDY=","number":3466,"title":"Connection switching (relay->direct) causes crash in index sender","user":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":67767665,"node_id":"MDU6TGFiZWw2Nzc2NzY2NQ==","url":"https://api.github.com/repos/syncthing/syncthing/labels/bug","name":"bug","color":"d93f0b","default":true,"description":"A problem with current functionality, as opposed to missing functionality (enhancement)"},{"id":628314330,"node_id":"MDU6TGFiZWw2MjgzMTQzMzA=","url":"https://api.github.com/repos/syncthing/syncthing/labels/frozen-due-to-age","name":"frozen-due-to-age","color":"eeeeee","default":false,"description":"Issues closed and untouched for a long time, together with being locked for discussion"}],"state":"closed","locked":true,"assignee":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":3,"created_at":"2016-08-01T08:07:12Z","updated_at":"2017-08-10T16:13:07Z","closed_at":"2016-08-10T09:37:35Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"From #3448:\n\n```\n[JQHVO] 10:06:22 INFO: Connection to FYOHSB2 closed: switching connections\n[JQHVO] 10:06:22 INFO: Established secure connection to FYOHSB2 at 192.168.181.10:22000-:58180 (TCP (Server))\n[JQHVO] 10:06:22 INFO: Connection to FYOHSB2 closed: reading length: read tcp 192.168.181.10:50169->104.129.57.94:22067: use of closed network connection\n[JQHVO] 10:06:22 INFO: Device FYOHSB2 client is \"syncthing v0.14.3\" named \n[JQHVO] 10:06:22 INFO: Connection to FYOHSB2 closed: reading length: read tcp 192.168.181.10:22000->68.65.72.186:58180: use of closed network connection\n[JQHVO] 10:06:45 INFO: Established secure connection to FYOHSB2 at 192.168.181.10:50186-104.129.57.94:22067 (Relay (Server))\n[JQHVO] 10:06:45 INFO: Device FYOHSB2 client is \"syncthing v0.14.3\" named \n[JQHVO] 10:06:45 INFO: Device FYOHSB2 folder \"9ZTJu-VPHqJ\" is delta index compatible (mlv=75283)\n[JQHVO] 10:06:45 INFO: Device FYOHSB2 folder \"SharedTools\" is delta index compatible (mlv=69294)\n[JQHVO] 10:06:45 INFO: Device FYOHSB2 folder \"randomBulkSync\" is delta index compatible (mlv=69414)\n[JQHVO] 10:06:45 INFO: Device FYOHSB2 folder \"randomMinSync\" is delta index compatible (mlv=72906)\n[JQHVO] 10:06:45 INFO: Device FYOHSB2 folder \"cfzjw-SkHX7\" is delta index compatible (mlv=70180)\n[JQHVO] 10:06:45 INFO: Device FYOHSB2 folder \"DABingeNeedRetire\" is delta index compatible (mlv=76601)\n[JQHVO] 10:07:10 INFO: Connection to FYOHSB2 closed: switching connections\npanic: bug: ClusterConfig called on closed or nonexistent connection\ngoroutine 8184 [running]:\n[JQHVO] 10:07:10 INFO: Established secure connection to FYOHSB2 at 192.168.181.10:22000-:24653 (TCP (Server))\npanic(0xa9b5c0, 0xc08543e870)\n[JQHVO] 10:07:10 INFO: Device FYOHSB2 client is \"syncthing v0.14.3\" named \nc:/go/src/runtime/panic.go:481 +0x3f4\n[JQHVO] 10:07:10 INFO: Connection to FYOHSB2 closed: writing message: write tcp 192.168.181.10:50186->104.129.57.94:22067: use of closed network connection\ngithub.com/syncthing/syncthing/lib/model.(Model).ClusterConfig(0xc082050140, 0xeb96024f07791c2e, 0xf66cc66753f4d053, 0x9aa6d3756b1bc563, 0xcd823ef98efc703b, 0xc082366800, 0x6, 0x8)\nc:/jenkins/workspace/syncthing-release-windows/src/github.com/syncthing/syncthing/lib/model/model.go:655 +0x214\ngithub.com/syncthing/syncthing/lib/protocol.(nativeModel).ClusterConfig(0xc0869c5620, 0xeb96024f07791c2e, 0xf66cc66753f4d053, 0x9aa6d3756b1bc563, 0xcd823ef98efc703b, 0xc082366800, 0x6, 0x8)\n:59 +0x8c\ngithub.com/syncthing/syncthing/lib/protocol.(rawConnection).readerLoop(0xc0825f2c00, 0x0, 0x0)\nc:/jenkins/workspace/syncthing-release-windows/src/github.com/syncthing/syncthing/lib/protocol/protocol.go:305 +0x12d8\ncreated by github.com/syncthing/syncthing/lib/protocol.(rawConnection).Start\nc:/jenkins/workspace/syncthing-release-windows/src/github.com/syncthing/syncthing/lib/protocol/protocol.go:170 +0x40\n```\n\nThe sequence seems to be that we add a new connection, then close the old connection, which removed the connection from the internal maps leaving us connected but with no handle to the connection...\n\n0.14.3\n","closed_by":{"login":"st-review","id":16196517,"node_id":"MDQ6VXNlcjE2MTk2NTE3","avatar_url":"https://avatars.githubusercontent.com/u/16196517?v=4","gravatar_id":"","url":"https://api.github.com/users/st-review","html_url":"https://github.com/st-review","followers_url":"https://api.github.com/users/st-review/followers","following_url":"https://api.github.com/users/st-review/following{/other_user}","gists_url":"https://api.github.com/users/st-review/gists{/gist_id}","starred_url":"https://api.github.com/users/st-review/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/st-review/subscriptions","organizations_url":"https://api.github.com/users/st-review/orgs","repos_url":"https://api.github.com/users/st-review/repos","events_url":"https://api.github.com/users/st-review/events{/privacy}","received_events_url":"https://api.github.com/users/st-review/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/3466/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/3466/timeline","performed_via_github_app":null,"state_reason":"completed"}