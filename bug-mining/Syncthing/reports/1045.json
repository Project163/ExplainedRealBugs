{"url":"https://api.github.com/repos/syncthing/syncthing/issues/6422","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/6422/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/6422/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/6422/events","html_url":"https://github.com/syncthing/syncthing/issues/6422","id":583803175,"node_id":"MDU6SXNzdWU1ODM4MDMxNzU=","number":6422,"title":"\"fatal error: runtime: out of memory\" during database migration on QNAP NAS","user":{"login":"rlvargas","id":938969,"node_id":"MDQ6VXNlcjkzODk2OQ==","avatar_url":"https://avatars.githubusercontent.com/u/938969?v=4","gravatar_id":"","url":"https://api.github.com/users/rlvargas","html_url":"https://github.com/rlvargas","followers_url":"https://api.github.com/users/rlvargas/followers","following_url":"https://api.github.com/users/rlvargas/following{/other_user}","gists_url":"https://api.github.com/users/rlvargas/gists{/gist_id}","starred_url":"https://api.github.com/users/rlvargas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rlvargas/subscriptions","organizations_url":"https://api.github.com/users/rlvargas/orgs","repos_url":"https://api.github.com/users/rlvargas/repos","events_url":"https://api.github.com/users/rlvargas/events{/privacy}","received_events_url":"https://api.github.com/users/rlvargas/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":67767665,"node_id":"MDU6TGFiZWw2Nzc2NzY2NQ==","url":"https://api.github.com/repos/syncthing/syncthing/labels/bug","name":"bug","color":"d93f0b","default":true,"description":"A problem with current functionality, as opposed to missing functionality (enhancement)"},{"id":628314330,"node_id":"MDU6TGFiZWw2MjgzMTQzMzA=","url":"https://api.github.com/repos/syncthing/syncthing/labels/frozen-due-to-age","name":"frozen-due-to-age","color":"eeeeee","default":false,"description":"Issues closed and untouched for a long time, together with being locked for discussion"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/syncthing/syncthing/milestones/45","html_url":"https://github.com/syncthing/syncthing/milestone/45","labels_url":"https://api.github.com/repos/syncthing/syncthing/milestones/45/labels","id":5131386,"node_id":"MDk6TWlsZXN0b25lNTEzMTM4Ng==","number":45,"title":"v1.4.1","description":"","creator":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":36,"state":"closed","created_at":"2020-02-22T08:43:02Z","updated_at":"2020-04-08T08:51:24Z","due_on":"2020-04-07T07:00:00Z","closed_at":"2020-04-07T06:00:20Z"},"comments":5,"created_at":"2020-03-18T15:17:04Z","updated_at":"2021-03-19T07:02:28Z","closed_at":"2020-03-18T19:33:45Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### \"fatal error: runtime: out of memory\" after upgrade syncthing from version 1.3.2 to 1.4.0 on a QNAP NAS TS-419 II \r\n\r\n### Version Information\r\n\r\nSyncthing Version: syncthing v1.4.0 \"Fermium Flea\" (go1.13.8 linux-arm)\r\nOS Version: QNAP firmware version 4.3.3.1161 Build 20200109\r\nBrowser Version: not applicable\r\nNAS Model:      TS-419P II\r\n\r\n - what happened,\r\nSyncthing service crashed after updating from v1.3.2 to v1.4.0. The log shows the problem happened after \"Migrating database to schema version 9...\" entry and the crash report describes a \"fatal error: runtime: out of memory\".  \r\nsee attached files: [sync.log](https://github.com/syncthing/syncthing/files/4349556/sync.log)\r\n[panic-20200318-175040.reported.log](https://github.com/syncthing/syncthing/files/4349518/panic-20200318-175040.reported.log)\r\n\r\n - what you expected to happen instead, and\r\nIndeed the system is an old QNAP NAS with only 512MB of RAM but it have never had problem with previous version updates. The problem persisted even after stopping all services to free up memory before performing the update.\r\n\r\n - any steps to reproduce the problem.\r\nExecute the commands:\r\n\r\n**[/share/MD0_DATA/.qpkg/syncthing] # uname -a**\r\nLinux rv-nas 3.4.6 #1 Thu Jan 9 12:06:35 CST 2020 armv5tel unknown\r\n**[/share/MD0_DATA/.qpkg/syncthing] # /etc/init.d/services.sh stop**\r\nStop services: Stop qpkg service: /etc/rcK.d/QK100QcloudSSLCertificate /etc/rcK.d/QK101opentftp /etc/rcK.d/QK101phpMyAdmin /etc/rcK.d/QK103HybridBackup /etc/rcK.d/QK103HybridBackup: line 296: /home/httpd/cgi-bin/backup/python_dir/bin/python: No such file or directory\r\n/etc/rcK.d/QK104BackupVersion /etc/rcK.d/QK105helpdesk /etc/rcK.d/QK106QsyncServer Shutting down Qsync service: Shutting down Versioning services:.\r\nstop db server\r\nOK\r\n/etc/rcK.d/QK107QVPN Shutting down QVPN services: \r\n/etc/rcK.d/QK108PhotoStation /etc/rcK.d/QK110SickBeard armv5tel\r\nShutting down SickBeard... \r\nSickBeard is not running?\r\n/etc/rcK.d/QK111Entware-ng Disable Entware-ng/opkg\r\n Checking squid...              dead. \r\n/etc/rcK.d/QK112CloudDrive pidfile /var/run/clouddrive.pid does not exist. Daemon not running?\r\n/etc/rcK.d/QK113git Shutting down git... \r\n/etc/rcK.d/QK114CloudLink /etc/rcK.d/QK115syncthing Stop services: syncthing\r\nkillall: syncthing: no process killed\r\n/etc/rcK.d/QK116MusicStation /etc/rcK.d/QK117DownloadStation Shutting down DownloadStation services: \r\n/etc/rcK.d/QK118Syncrify Attempting to stop Syncrify Server: Not running.\r\n/etc/rcK.d/QK119JRE Disable Java Runtime Environment... \r\n/etc/rcK.d/QK121SABnzbdplus SABnzbd is not running?\r\n/etc/rcK.d/QK122CouchPotato2 CouchPotato2 is not running\r\n/etc/rcK.d/QK123Optware Disable Optware/ipkg\r\n/etc/rcK.d/QK124Python Removing Python file links... \r\n/etc/rcK.d/QK899QcloudSSLCertificate .\r\nStop service: ldap_server.sh antivirus.sh iso_mount.sh qsyncman.sh rsyslog.sh snmp lunportman.sh iscsitrgt.sh twonkymedia.sh init_iTune.sh ImRd.sh crond.sh StartMediaService.sh mariadb.sh mysqld.sh recycled.sh Qthttpd.sh atalk.sh nfs ftp.sh smb.sh qsyncsrv_install.sh .\r\n**[/share/MD0_DATA/.qpkg/syncthing] # free**\r\n              total         used         free       shared      buffers\r\n  Mem:       515492       487300        28192            0        30376\r\n Swap:       530124        13508       516616\r\nTotal:      1045616       500808       544808\r\n**[/share/MD0_DATA/.qpkg/syncthing] # ./syncthing.sh restart**\r\nStop services: syncthing\r\nkillall: syncthing: no process killed\r\nsyncthing is already in base of ssl proxy\r\nStart services: syncthing\r\nMoving sync.log.8 to sync.log.9\r\nMoving sync.log.6 to sync.log.7\r\nMoving sync.log.4 to sync.log.5\r\nMoving sync.log.2 to sync.log.3\r\nMoving sync.log to sync.log.1\r\nMoving sync.log.7 to sync.log.8\r\nMoving sync.log.5 to sync.log.6\r\nMoving sync.log.3 to sync.log.4\r\nMoving sync.log.1 to sync.log.2\r\nMoving sync.log to sync.log.1\r\n**[/share/MD0_DATA/.qpkg/syncthing] # tail sync.log**\r\n[monitor] 20:51:45 WARNING: Uploading crash reports is taking a while, please wait...\r\n[monitor] 20:51:46 INFO: Reporting crash found in panic-20200318-205134.log (report ID 3f2b7426) ...\r\n[start] 20:51:55 INFO: syncthing v1.4.0 \"Fermium Flea\" (go1.13.8 linux-arm) teamcity@build.syncthing.net 2020-03-06 19:52:22 UTC\r\n[CKUR5] 20:51:55 INFO: My ID: XXXXXXX-XXXXXXX-XXXXXXX-XXXXXXX-XXXXXXX-XXXXXXX-XXXXXXX-XXXXXXX ## edited ##\r\n[CKUR5] 20:51:56 INFO: Single thread SHA256 performance is 15 MB/s using crypto/sha256 (15 MB/s using minio/sha256-simd).\r\n[CKUR5] 20:51:58 INFO: Hashing performance is 13.74 MB/s\r\n[CKUR5] 20:51:58 INFO: Migrating database to schema version 9...\r\n[CKUR5] 21:13:55 INFO: Paused state detected, possibly woke up from standby. Restarting in 1m0s.\r\n[monitor] 21:15:19 INFO: Syncthing exited: signal: killed\r\n[monitor] 21:15:21 INFO: Signal 15 received; exiting\r\n","closed_by":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/6422/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/6422/timeline","performed_via_github_app":null,"state_reason":"completed"}