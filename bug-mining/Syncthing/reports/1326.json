{"url":"https://api.github.com/repos/syncthing/syncthing/issues/7988","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/7988/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/7988/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/7988/events","html_url":"https://github.com/syncthing/syncthing/issues/7988","id":1014638500,"node_id":"I_kwDOAOCAEs48eiek","number":7988,"title":"Unexpected cleanup behavior for Simple File Versioning","user":{"login":"MrEager","id":91851422,"node_id":"U_kgDOBXmKng","avatar_url":"https://avatars.githubusercontent.com/u/91851422?v=4","gravatar_id":"","url":"https://api.github.com/users/MrEager","html_url":"https://github.com/MrEager","followers_url":"https://api.github.com/users/MrEager/followers","following_url":"https://api.github.com/users/MrEager/following{/other_user}","gists_url":"https://api.github.com/users/MrEager/gists{/gist_id}","starred_url":"https://api.github.com/users/MrEager/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MrEager/subscriptions","organizations_url":"https://api.github.com/users/MrEager/orgs","repos_url":"https://api.github.com/users/MrEager/repos","events_url":"https://api.github.com/users/MrEager/events{/privacy}","received_events_url":"https://api.github.com/users/MrEager/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":67767665,"node_id":"MDU6TGFiZWw2Nzc2NzY2NQ==","url":"https://api.github.com/repos/syncthing/syncthing/labels/bug","name":"bug","color":"d93f0b","default":true,"description":"A problem with current functionality, as opposed to missing functionality (enhancement)"},{"id":628314330,"node_id":"MDU6TGFiZWw2MjgzMTQzMzA=","url":"https://api.github.com/repos/syncthing/syncthing/labels/frozen-due-to-age","name":"frozen-due-to-age","color":"eeeeee","default":false,"description":"Issues closed and untouched for a long time, together with being locked for discussion"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/syncthing/syncthing/milestones/85","html_url":"https://github.com/syncthing/syncthing/milestone/85","labels_url":"https://api.github.com/repos/syncthing/syncthing/milestones/85/labels","id":8285880,"node_id":"MI_kwDOAOCAEs4Afm64","number":85,"title":"v1.22.0","description":"","creator":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":29,"state":"closed","created_at":"2022-08-10T06:42:22Z","updated_at":"2022-10-04T06:15:38Z","due_on":"2022-10-04T07:00:00Z","closed_at":"2022-10-04T06:15:38Z"},"comments":4,"created_at":"2021-10-04T01:38:38Z","updated_at":"2023-10-12T07:55:31Z","closed_at":"2022-09-13T17:20:07Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Issue\r\n\"Clean out after\" setting removes files based on their last modified time (mtime)\r\n### Expected Result\r\nFiles are removed based on when they were deleted (~datestamp tag value)\r\n\r\n## Overview:\r\n\r\nI had been following #6527 and #6884 and finally got around to trying it out in my deployment. Based on the cleanup documentation (https://docs.syncthing.net/users/versioning.html) I expected the behavior to follow \"_If this is set to a positive number of days, files will be removed when they have been in the trash can that long_,\" however, on first run, clean up removed considerably more files than I expected (obviously, these files were already in the .stversions directory, so non-critical in this case). Based on quick look through the code, cleanByDay func called by both the Trash Can and Simple Versioning methods directly reference the file's ModTime (https://github.com/syncthing/syncthing/blob/main/lib/versioner/util.go#L318) and ignore the datestamp applied when the file was archived by the simple versioning process.\r\n\r\n### Example/reproduce\r\n\r\n- Clean out after is set to 30 days, runs once a day\r\n- File (say, a picture) is modified on 2021-04-29\r\n- File is deleted on 2021-10-02, and moved to .stversions\r\n- File's mtime is unchanged (no content change)\r\n- Clean runs later in the day, and immediately deletes the file because mtime is > 30 days in the past, even though the datestamp is less than 24 hours in the past\r\n\r\nThis could lead to a user deleting a file that was last modified greater than the \"Clean out after\" setting, and be unable to recover as the clean task removed it immediately on next run. Additionally, collecting logs for this behavior is difficult as the clean functions do not appear to have any debug logging - I can easily trace where a file is archived, but only see when the clean job is run, not specific files cleaned.\r\n\r\n","closed_by":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/7988/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":1,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/7988/timeline","performed_via_github_app":null,"state_reason":"completed"}