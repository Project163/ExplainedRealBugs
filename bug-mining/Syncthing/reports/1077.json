{"url":"https://api.github.com/repos/syncthing/syncthing/issues/6583","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/6583/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/6583/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/6583/events","html_url":"https://github.com/syncthing/syncthing/issues/6583","id":607896114,"node_id":"MDU6SXNzdWU2MDc4OTYxMTQ=","number":6583,"title":"Distributed deadlock on request","user":{"login":"AudriusButkevicius","id":1144861,"node_id":"MDQ6VXNlcjExNDQ4NjE=","avatar_url":"https://avatars.githubusercontent.com/u/1144861?v=4","gravatar_id":"","url":"https://api.github.com/users/AudriusButkevicius","html_url":"https://github.com/AudriusButkevicius","followers_url":"https://api.github.com/users/AudriusButkevicius/followers","following_url":"https://api.github.com/users/AudriusButkevicius/following{/other_user}","gists_url":"https://api.github.com/users/AudriusButkevicius/gists{/gist_id}","starred_url":"https://api.github.com/users/AudriusButkevicius/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AudriusButkevicius/subscriptions","organizations_url":"https://api.github.com/users/AudriusButkevicius/orgs","repos_url":"https://api.github.com/users/AudriusButkevicius/repos","events_url":"https://api.github.com/users/AudriusButkevicius/events{/privacy}","received_events_url":"https://api.github.com/users/AudriusButkevicius/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":67767665,"node_id":"MDU6TGFiZWw2Nzc2NzY2NQ==","url":"https://api.github.com/repos/syncthing/syncthing/labels/bug","name":"bug","color":"d93f0b","default":true,"description":"A problem with current functionality, as opposed to missing functionality (enhancement)"},{"id":628314330,"node_id":"MDU6TGFiZWw2MjgzMTQzMzA=","url":"https://api.github.com/repos/syncthing/syncthing/labels/frozen-due-to-age","name":"frozen-due-to-age","color":"eeeeee","default":false,"description":"Issues closed and untouched for a long time, together with being locked for discussion"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/syncthing/syncthing/milestones/48","html_url":"https://github.com/syncthing/syncthing/milestone/48","labels_url":"https://api.github.com/repos/syncthing/syncthing/milestones/48/labels","id":5334953,"node_id":"MDk6TWlsZXN0b25lNTMzNDk1Mw==","number":48,"title":"v1.6.0","description":"This release performs a database schema migration, and adds the `BlockPullOrder`, `DisableFsync` and `MaxConcurrentWrites` folder options to the configuration schema.\r\n\r\nThe `LocalChangeDetected` event no longer has the `action` set to `added` for new files, instead showing `modified` for all local file changes.","creator":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":68,"state":"closed","created_at":"2020-04-21T20:45:51Z","updated_at":"2020-06-02T05:40:23Z","due_on":"2020-06-02T07:00:00Z","closed_at":"2020-06-02T05:40:23Z"},"comments":1,"created_at":"2020-04-27T22:29:00Z","updated_at":"2021-05-02T07:02:20Z","closed_at":"2020-05-01T09:09:01Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This is on a new level\r\n\r\n```\r\ngoroutine 11193434 [select, 63 minutes]:\r\ngithub.com/syncthing/syncthing/lib/protocol.(*rawConnection).Request(0xc0113e35f0, 0x10e13c0, 0xc001495880, 0xc0001815e0, 0xb, 0xc010c99340, 0x19, 0x0, 0xd, 0xc010c99380, ...)\r\n\t/opt/tcagent/syncthing-4-work/174e136266f8a219/lib/protocol/protocol.go:312 +0x317\r\ngithub.com/syncthing/syncthing/lib/protocol.wireFormatConnection.Request(0x10ec580, 0xc0113e35f0, 0x10e13c0, 0xc001495880, 0xc0001815e0, 0xb, 0xc010c99340, 0x19, 0x0, 0xd, ...)\r\n\t/opt/tcagent/syncthing-4-work/174e136266f8a219/lib/protocol/wireformat.go:40 +0x110\r\ngithub.com/syncthing/syncthing/lib/model.(*model).requestGlobal(0xc004449500, 0x10e13c0, 0xc001495880, 0x15ccd157e814fe7a, 0xf7a3e7d41cef92de, 0x7df45d739700fead, 0x2847700d8b97c0b2, 0xc0001815e0, 0xb, 0xc010c99340, ...)\r\n\t/opt/tcagent/syncthing-4-work/174e136266f8a219/lib/model/model.go:2054 +0x492\r\ngithub.com/syncthing/syncthing/lib/model.(*sendReceiveFolder).pullBlock(0xc000516900, 0xc001caf900, 0xc010c99380, 0x20, 0x20, 0x0, 0x12a302a80000000d, 0xc01013e3c0)\r\n\t/opt/tcagent/syncthing-4-work/174e136266f8a219/lib/model/folder_sendrecv.go:1458 +0x3a8\r\ngithub.com/syncthing/syncthing/lib/model.(*sendReceiveFolder).pullerRoutine.func1(0x10ded80, 0xc0100c0e70, 0xc00e771e60, 0xd, 0xc000516900, 0xc001caf900, 0xc010c99380, 0x20, 0x20, 0x0, ...)\r\n\t/opt/tcagent/syncthing-4-work/174e136266f8a219/lib/model/folder_sendrecv.go:1405 +0xfb\r\ncreated by github.com/syncthing/syncthing/lib/model.(*sendReceiveFolder).pullerRoutine\r\n\t/opt/tcagent/syncthing-4-work/174e136266f8a219/lib/model/folder_sendrecv.go:1401 +0x32d\r\n```\r\n\r\n```\r\ngoroutine 11152826 [select, 63 minutes]:\r\ngithub.com/syncthing/syncthing/lib/model.(*folder).Scan(0xc000516900, 0xc00d88c480, 0x1, 0x1, 0xffffffffffffffff, 0xc0019b9208)\r\n\t/opt/tcagent/syncthing-4-work/174e136266f8a219/lib/model/folder.go:232 +0x149\r\ngithub.com/syncthing/syncthing/lib/model.(*folder).ForceRescan(0xc000516900, 0xc00d8d0300, 0x19, 0x0, 0x5ea72c0d, 0x37ee1cad0211b944, 0xc00d8d0320, 0x2, 0x2, 0x299b36, ...)\r\n\t/opt/tcagent/syncthing-4-work/174e136266f8a219/lib/model/folder.go:817 +0x16f\r\ngithub.com/syncthing/syncthing/lib/model.(*model).recheckFile(0xc004449500, 0x15ccd157e814fe7a, 0xf7a3e7d41cef92de, 0x7df45d739700fead, 0x2847700d8b97c0b2, 0x10f1980, 0xc005bc50d0, 0xc00ee76000, 0xb, 0xc00ee685a0, ...)\r\n\t/opt/tcagent/syncthing-4-work/174e136266f8a219/lib/model/model.go:1640 +0x2db\r\ngithub.com/syncthing/syncthing/lib/model.(*model).Request(0xc004449500, 0x15ccd157e814fe7a, 0xf7a3e7d41cef92de, 0x7df45d739700fead, 0x2847700d8b97c0b2, 0xc00ee76000, 0xb, 0xc00ee685a0, 0x19, 0xc00000000d, ...)\r\n\t/opt/tcagent/syncthing-4-work/174e136266f8a219/lib/model/model.go:1569 +0x1a71\r\ngithub.com/syncthing/syncthing/lib/protocol.(*rawConnection).handleRequest(0xc0113e35f0, 0x127, 0xc00ee76000, 0xb, 0xc00ee685a0, 0x19, 0x0, 0xd, 0xc00ee685c0, 0x20, ...)\r\n\t/opt/tcagent/syncthing-4-work/174e136266f8a219/lib/protocol/protocol.go:627 +0x112\r\ncreated by github.com/syncthing/syncthing/lib/protocol.(*rawConnection).dispatcherLoop\r\n\t/opt/tcagent/syncthing-4-work/174e136266f8a219/lib/protocol/protocol.go:430 +0x656\r\n```\r\n\r\n1. The Scan() issued by recheck during a request can hang until the pull is finished if request comes in during a pull\r\n2. A pull can hang as long as the other side has not responded to a request\r\n3. The other side can not respond to a request because it's trying to do a recheck which is blocked by a scan.\r\n\r\nGoto 1.\r\n\r\nSeems that all you need is device A to pull some file which hits the recheck condition on device B\r\nand device B to pull some file that hits the recheck condition on device A at the same time.","closed_by":{"login":"imsodin","id":15955093,"node_id":"MDQ6VXNlcjE1OTU1MDkz","avatar_url":"https://avatars.githubusercontent.com/u/15955093?v=4","gravatar_id":"","url":"https://api.github.com/users/imsodin","html_url":"https://github.com/imsodin","followers_url":"https://api.github.com/users/imsodin/followers","following_url":"https://api.github.com/users/imsodin/following{/other_user}","gists_url":"https://api.github.com/users/imsodin/gists{/gist_id}","starred_url":"https://api.github.com/users/imsodin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imsodin/subscriptions","organizations_url":"https://api.github.com/users/imsodin/orgs","repos_url":"https://api.github.com/users/imsodin/repos","events_url":"https://api.github.com/users/imsodin/events{/privacy}","received_events_url":"https://api.github.com/users/imsodin/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/6583/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":1,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/6583/timeline","performed_via_github_app":null,"state_reason":"completed"}