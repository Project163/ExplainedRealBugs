{"url":"https://api.github.com/repos/syncthing/syncthing/issues/7176","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/7176/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/7176/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/7176/events","html_url":"https://github.com/syncthing/syncthing/issues/7176","id":755586916,"node_id":"MDU6SXNzdWU3NTU1ODY5MTY=","number":7176,"title":"Active connections min/max setting","user":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":67767667,"node_id":"MDU6TGFiZWw2Nzc2NzY2Nw==","url":"https://api.github.com/repos/syncthing/syncthing/labels/enhancement","name":"enhancement","color":"0e8a16","default":true,"description":"New features or improvements of some kind, as opposed to a problem (bug)"},{"id":628314330,"node_id":"MDU6TGFiZWw2MjgzMTQzMzA=","url":"https://api.github.com/repos/syncthing/syncthing/labels/frozen-due-to-age","name":"frozen-due-to-age","color":"eeeeee","default":false,"description":"Issues closed and untouched for a long time, together with being locked for discussion"},{"id":2043110077,"node_id":"MDU6TGFiZWwyMDQzMTEwMDc3","url":"https://api.github.com/repos/syncthing/syncthing/labels/needs-triage","name":"needs-triage","color":"ce23af","default":false,"description":"New issues needed to be validated"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/syncthing/syncthing/milestones/59","html_url":"https://github.com/syncthing/syncthing/milestone/59","labels_url":"https://api.github.com/repos/syncthing/syncthing/milestones/59/labels","id":6215237,"node_id":"MDk6TWlsZXN0b25lNjIxNTIzNw==","number":59,"title":"v1.13.0","description":"This release adds configuration options for min/max connections (see https://docs.syncthing.net/advanced/option-connection-limits.html) and moves the storage of pending devices/folders from the config to the database (see https://docs.syncthing.net/dev/rest.html#cluster-endpoints).","creator":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":45,"state":"closed","created_at":"2020-12-15T13:04:43Z","updated_at":"2021-02-02T16:05:22Z","due_on":"2021-02-02T08:00:00Z","closed_at":"2021-02-02T16:05:22Z"},"comments":8,"created_at":"2020-12-02T20:26:59Z","updated_at":"2022-01-12T07:02:44Z","closed_at":"2021-01-11T14:14:51Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"This is a draft for a feature to handle the following two use cases.\r\n\r\n1. I have a lot of low powered devices and want them to communicate in (something that feels like) a full mesh, but without the overhead of each device keeping a hundreds or thousands of connections running.\r\n\r\n2. I have a lot of clients (>1000) connecting to a small number of servers (<10), for load balancing purposes. Clients should automatically balance connections over the servers in question so they can handle one going down, without ending up with too many clients connecting to any given server, potentially overloading it.\r\n\r\nCurrently this is difficult because while it's easy to configure full mesh it's difficult for Syncthing to scale to it. The client-server example requires some fancy configuration management to direct clients to specific servers, and possibly reconfiguring them once a server goes down.\r\n\r\nNow lets assume we had two configuration options available:\r\n\r\n- Minimum active connections (minC)\r\n- Maximum active connections (maxC)\r\n\r\nWhere minC <= maxC and both default to unbounded / infinitely large. These control the connection service in terms of establishing outgoing and incoming connections. Specifically,\r\n\r\n- The connection loop runs as usual to establish outgoing connections while the number of active connections is less than minC. Once minC has been reached we no longer attempt to establish further outgoing connections.\r\n- Incoming connections are accepted as normal as long as we have fewer than maxC connections. Once maxC is reached we stop accepting further incoming connections. (Similar to a paused device.)\r\n\r\nFor some fairness to work out we also make one adjustment to the connection loop:\r\n\r\n- Every time we run the connection loop, the order of devices we connect to is shuffled.\r\n\r\nOur two use cases above then become quite simple.\r\n\r\nFor case one we configure all our devices for full mesh and set minC=10, maxC=20. Each device will end up connected to between ten and twenty other devices. (It's possible that this might result in partitioned sets of devices, but it doesn't seem especially likely. Some calculations could probably be done on how to set minC/maxC for a given cluster size to achieve a certain probability of it being fully connected...)\r\n\r\nFor case two with for example 1000 clients and 5 servers we want about 200 connections per server. We also want to handle one server going down, leaving us with 250 connections per remaining server. We can configure the servers to connect to all clients, and clients to connect to all servers. Clients get maxC=1 -- keep precisely one active connection. Servers get minC=200, maxC=250. Hence the servers will attempt to \"grab\" 200 clients each, clients will attempt to establish one connection to any server. Given randomization it's likely that the distribution ends up fairly even, but it's possible some servers get up to 250 clients and some other servers fewer than 200. If a server goes down there is \"space\" for the clients to migrate to another server.\r\n","closed_by":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/7176/reactions","total_count":2,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":2,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/7176/timeline","performed_via_github_app":null,"state_reason":"completed"}