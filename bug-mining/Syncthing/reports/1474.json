{"url":"https://api.github.com/repos/syncthing/syncthing/issues/6284","repository_url":"https://api.github.com/repos/syncthing/syncthing","labels_url":"https://api.github.com/repos/syncthing/syncthing/issues/6284/labels{/name}","comments_url":"https://api.github.com/repos/syncthing/syncthing/issues/6284/comments","events_url":"https://api.github.com/repos/syncthing/syncthing/issues/6284/events","html_url":"https://github.com/syncthing/syncthing/issues/6284","id":552807317,"node_id":"MDU6SXNzdWU1NTI4MDczMTc=","number":6284,"title":"Database: (optionally) garbage collect deleted files","user":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":67767667,"node_id":"MDU6TGFiZWw2Nzc2NzY2Nw==","url":"https://api.github.com/repos/syncthing/syncthing/labels/enhancement","name":"enhancement","color":"0e8a16","default":true,"description":"New features or improvements of some kind, as opposed to a problem (bug)"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/syncthing/syncthing/milestones/119","html_url":"https://github.com/syncthing/syncthing/milestone/119","labels_url":"https://api.github.com/repos/syncthing/syncthing/milestones/119/labels","id":12635859,"node_id":"MI_kwDOAOCAEs4AwM7T","number":119,"title":"v2.0.0","description":"","creator":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":79,"state":"closed","created_at":"2025-03-29T14:10:29Z","updated_at":"2025-08-12T06:17:02Z","due_on":"2025-08-12T07:00:00Z","closed_at":"2025-08-12T06:17:02Z"},"comments":0,"created_at":"2020-01-21T11:08:19Z","updated_at":"2025-04-02T13:06:22Z","closed_at":"2025-04-02T13:06:22Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"So, large databases again. Here's stats for a block-deduplicated yet still large database. There are a couple of custom classes:\r\n\r\n```\r\n% stindex -mode account index-v0.14.0.db\r\n 0x00:  2206187 items, 182629 KB keys + 1463447 KB data,  82 B +  663 B avg,    2573 B max\r\n 0x01:   185656 items,  10388 KB keys + 1790909 KB data,  55 B + 9646 B avg,  924525 B max\r\n 0x02:   916890 items,  84795 KB keys +    3667 KB data,  92 B +    4 B avg,     192 B max\r\n 0x03:      384 items,     27 KB keys +       5 KB data,  72 B +   15 B avg,      87 B max\r\n 0x04:     1109 items,     17 KB keys +      17 KB data,  15 B +   15 B avg,      69 B max\r\n 0x06:      383 items,      3 KB keys +       0 KB data,   9 B +    2 B avg,      18 B max\r\n 0x07:      510 items,      4 KB keys +      12 KB data,   9 B +   24 B avg,      41 B max\r\n 0x09:      194 items,      0 KB keys +     123 KB data,   5 B +  634 B avg,   11484 B max\r\n 0x0a:        3 items,      0 KB keys +       0 KB data,  14 B +   20 B avg,      58 B max\r\n 0x0b:   181836 items,   2363 KB keys +   10694 KB data,  13 B +   58 B avg,     173 B max\r\n 0x0d:    44282 items,   1461 KB keys +   59899 KB data,  33 B + 1352 B avg, 1606431 B max\r\n 0xf0:   206952 items,  23084 KB keys +   31301 KB data, 111 B +  151 B avg,     340 B max\r\n 0xf1:  6725022 items, 665162 KB keys + 1116642 KB data,  98 B +  166 B avg,    4788 B max\r\n Total 10469408 items, 969939 KB keys + 4476724 KB data.\r\n```\r\n\r\nThe two interesting ones here are f0 (deleted files < 90 days old) and f1 (deleted files > 90 days old). These are actually class 00 that I've just broken out for accounting. Compared to 00 (normal, live files) the old deleted files are almost half of the total volume (1.1 GB out of 1.4+1.1 GB) and a vast majority of the items (6.7 M out of 6.7+2.2 M). The latter especially is a lot of iteration that wouldn't need to happen, when we iterate. Oh, and volume wise it's the vast majority of keys as well.\r\n\r\nI propose that we add a config to garbage collect old, deleted files. We might have it default to a 180 day limit or something conservative like that, or even leave it off by default. But when set we could periodically iterate and clean out entries that are old, when all known devices agree with the delete. That is, only if the global list contains only delete entries and the entry itself is older than the cutoff.\r\n\r\nManual cleanup would also be acceptable, but there's really no way today to clean out deleted items and have them *stay* cleaned out.","closed_by":{"login":"calmh","id":125426,"node_id":"MDQ6VXNlcjEyNTQyNg==","avatar_url":"https://avatars.githubusercontent.com/u/125426?v=4","gravatar_id":"","url":"https://api.github.com/users/calmh","html_url":"https://github.com/calmh","followers_url":"https://api.github.com/users/calmh/followers","following_url":"https://api.github.com/users/calmh/following{/other_user}","gists_url":"https://api.github.com/users/calmh/gists{/gist_id}","starred_url":"https://api.github.com/users/calmh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/calmh/subscriptions","organizations_url":"https://api.github.com/users/calmh/orgs","repos_url":"https://api.github.com/users/calmh/repos","events_url":"https://api.github.com/users/calmh/events{/privacy}","received_events_url":"https://api.github.com/users/calmh/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/syncthing/syncthing/issues/6284/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/syncthing/syncthing/issues/6284/timeline","performed_via_github_app":null,"state_reason":"completed"}