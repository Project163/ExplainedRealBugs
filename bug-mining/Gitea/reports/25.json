{"url":"https://api.github.com/repos/go-gitea/gitea/issues/26129","repository_url":"https://api.github.com/repos/go-gitea/gitea","labels_url":"https://api.github.com/repos/go-gitea/gitea/issues/26129/labels{/name}","comments_url":"https://api.github.com/repos/go-gitea/gitea/issues/26129/comments","events_url":"https://api.github.com/repos/go-gitea/gitea/issues/26129/events","html_url":"https://github.com/go-gitea/gitea/issues/26129","id":1820131194,"node_id":"I_kwDOBFIx285sfP96","number":26129,"title":"Git Hooks (pre-receive) with fail check drops Gitea to 502 Error","user":{"login":"sgabenov","id":15741789,"node_id":"MDQ6VXNlcjE1NzQxNzg5","avatar_url":"https://avatars.githubusercontent.com/u/15741789?v=4","gravatar_id":"","url":"https://api.github.com/users/sgabenov","html_url":"https://github.com/sgabenov","followers_url":"https://api.github.com/users/sgabenov/followers","following_url":"https://api.github.com/users/sgabenov/following{/other_user}","gists_url":"https://api.github.com/users/sgabenov/gists{/gist_id}","starred_url":"https://api.github.com/users/sgabenov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sgabenov/subscriptions","organizations_url":"https://api.github.com/users/sgabenov/orgs","repos_url":"https://api.github.com/users/sgabenov/repos","events_url":"https://api.github.com/users/sgabenov/events{/privacy}","received_events_url":"https://api.github.com/users/sgabenov/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":472744938,"node_id":"MDU6TGFiZWw0NzI3NDQ5Mzg=","url":"https://api.github.com/repos/go-gitea/gitea/labels/type/bug","name":"type/bug","color":"ee0701","default":false,"description":""}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/go-gitea/gitea/milestones/146","html_url":"https://github.com/go-gitea/gitea/milestone/146","labels_url":"https://api.github.com/repos/go-gitea/gitea/milestones/146/labels","id":9711583,"node_id":"MI_kwDOBFIx284AlC_f","number":146,"title":"1.20.3","description":"","creator":{"login":"delvh","id":51889757,"node_id":"MDQ6VXNlcjUxODg5NzU3","avatar_url":"https://avatars.githubusercontent.com/u/51889757?v=4","gravatar_id":"","url":"https://api.github.com/users/delvh","html_url":"https://github.com/delvh","followers_url":"https://api.github.com/users/delvh/followers","following_url":"https://api.github.com/users/delvh/following{/other_user}","gists_url":"https://api.github.com/users/delvh/gists{/gist_id}","starred_url":"https://api.github.com/users/delvh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/delvh/subscriptions","organizations_url":"https://api.github.com/users/delvh/orgs","repos_url":"https://api.github.com/users/delvh/repos","events_url":"https://api.github.com/users/delvh/events{/privacy}","received_events_url":"https://api.github.com/users/delvh/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":68,"state":"closed","created_at":"2023-07-28T16:56:55Z","updated_at":"2023-08-21T14:48:47Z","due_on":null,"closed_at":"2023-08-21T03:06:43Z"},"comments":7,"created_at":"2023-07-25T11:33:15Z","updated_at":"2023-09-25T00:24:07Z","closed_at":"2023-08-10T02:39:23Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description\n\nI have faced a situation where Git Hook drops Gitea to 502 Error.\r\nGit Hook checks commits for some naming templates and raise error if check is not completed. All commits/PRs are blocked if check is failing.\r\n\r\nIssue:\r\nGitea executes Git Hook on PR with non 0 error code. After receiving exit code 1 it drops to 502 Error\r\n\r\nExpected behavior:\r\nShow page with git console and error code from git. Do not drop to 502. \r\n\r\nHow to reproduce:\r\n1. Enable git hooks on Gitea and Configure Git Hook (pre-recive) on server side with this code:\r\n```\r\n#!/bin/bash\r\n\r\n# Error message for BRANCH POLICY\r\nerror_msg_branch=$(cat <<-END\r\n\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@                                                                               @   \r\n@   !!! Push not allowed by BRANCH NAME policy !!!                              @\r\n@                                                                               @  \r\n@   You branch should be named with these templaes:                             @\r\n@     - master                                                                  @\r\n@     - develop                                                                 @\r\n@     - release/RC_*                                                            @\r\n@     - feature/JIRA_ID-000--*                                                  @\r\n@     - bugfix/*                                                                @\r\n@     - hotfix/*                                                                @\r\n@                                                                               @\r\n@   Example: feature/MEC-167--add_new_functionaliry                             @\r\n@                                                                               @\r\n@   Wiki: https://confluence.ncloudtech.ru/display/KDM/Git+branch+naming        @                                                                        @\r\n@                                                                               @\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n    \r\nEND\r\n)\r\n\r\nerror_msg_commit=$(cat <<-END\r\n\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n@                                                                                 @\r\n@   !!! Your Commit does not have a referance to JIRA ticket !!!                  @\r\n@                                                                                 @\r\n@   Please correct your Git messages, and push again.                             @\r\n@   Example: \"[KDM-1234] This is a correct JIRA reference\"                        @\r\n@                                                                                 @\r\n@   Wiki: https://confluence.ncloudtech.ru/pages/viewpage.action?pageId=201708163 @                                                                                @\r\n@                                                                                 @\r\n@   To FORCE push, use \"bugfix\" or \"hotfix\" in your commit message                @                                                                  @\r\n@                                                                                 @\r\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\r\n    \r\nEND\r\n)\r\n\r\n\r\n\r\nwhile read oldrev newrev refname\r\ndo\r\n  #\r\n  # Step 0:\r\n  # Get Git commit information\r\n  #\r\n  BRANCH_NAME_FULL=$refname\r\n  BRANCH_NAME=\"$(echo $BRANCH_NAME_FULL | sed 's/refs\\/heads\\///g')\"\r\n  COMMIT_MESSAGE=$(git log --format=%B -n 1)\r\n  echo \"[INFO] BRANCH NAME: $BRANCH_NAME\"\r\n\r\n  #\r\n  # Step 1:\r\n  # Policy - Check that brunch name is enforced by branch name\r\n  #\r\n\r\n  echo \"[INFO] Policy - Check that brunch name is enforced by branch name\"\r\n  # Regexp for allowed names of branches\r\n  branch_name_format='^master|^main|^develop|^release\\/RC_.*|^feature\\/[a-zA-Z0-9,\\.\\_\\-]+-[0-9]+.*|^hotfix\\/.*|^bugfix\\/.*'\r\n  \r\n  if [[ ! $BRANCH_NAME =~ $branch_name_format ]]; then\r\n      echo \"$error_msg_branch\" >&2\r\n      exit 1\r\n  else\r\n      echo \"Push is successful\"\r\n  fi\r\n\r\n  #\r\n  # Step 2:\r\n  # Policy - Check commit message for JIRA issue number\r\n  #\r\n\r\n  # Configuration\r\n  echo \"[INFO] Policy - Check commit message for JIRA issue number\"\r\n  jiraIdRegex=\"[a-zA-Z0-9,\\.\\_\\-]+-[0-9]+\"\r\n  fixMsgRegex=\"bugfix|hotfix\"\r\n  info_msg=\"[INFO] The commit message looks good\"\r\n  error_msg=\"[POLICY] The commit doesn't reference a JIRA issue\"\r\n\r\n  # Get all commits from this push\r\n  for sha1Commit in $(git rev-list $oldrev..$newrev);\r\n  do\r\n    # Receive git commits sha from git history in chronologic order\r\n    echo \"[INFO] Processing commit with sha: $sha1Commit\";\r\n    # Get commit message from commit\r\n    commitMessage=$(git log --format=%B -n 1 $sha1Commit)\r\n    # Check with RegEX if commit has JIRA reference\r\n    jiraIds=$(echo $commitMessage | grep -Eo $jiraIdRegex)\r\n    fixMsg=$(echo $commitMessage | grep -Eo $fixMsgRegex)\r\n    # Check if this commit urgent e.g. hotfox or bugfix\r\n    if [[ -n \"${fixMsg}\" ]]; then\r\n      echo \"[WARNING] Found \"bugfix|hotfix\" in msg. Force skipping check for JiraID\"\r\n      exit 0\r\n    fi\r\n    # Check for JiraIDs in commit message\r\n    echo \"[INFO] Found JIRA IDs in commit: $jiraIds\"\r\n    if [[ -z \"${jiraIds}\" ]]; then\r\n      echo \"$error_msg: $commitMessage\" >&2\r\n      echo \"$error_msg_commit\" >&2\r\n      exit 1\r\n    fi\r\n  done\r\ndone\r\n\r\n#\r\n# Exit\r\n#\r\nexit 0\r\n```\r\n2. Create new branch `feature/jira-123_some_text` and push to gitea\r\n3. Create PR from `feature/jira-123_some_text` --> master\r\n4. Get Error 502 on Gitea. The reason of this error, bacause git hook check failes. It not allows refs with PRs and exit with error 1. \r\nI expect, that it will show `$error_msg_branch >&2` from bash script in hook redirected to git log (How it is done on client side, if hook failes), but not prop to 502 Error\r\n\r\nIf i change   `branch_name_format='^master|^main|^develop|^release\\/RC_.*|^feature\\/[a-zA-Z0-9,\\.\\_\\-]+-[0-9]+.*|^hotfix\\/.*|^bugfix\\/.*'` to `  branch_name_format='pull|^master|^main|^develop|^release\\/RC_.*|^feature\\/[a-zA-Z0-9,\\.\\_\\-]+-[0-9]+.*|^hotfix\\/.*|^bugfix\\/.*' the check will not fail and PR working\r\n`\r\n\n\n### Gitea Version\n\n1.20.0\n\n### Can you reproduce the bug on the Gitea demo site?\n\nYes\n\n### Log Gist\n\n_No response_\n\n### Screenshots\n\n![Screenshot1](https://github.com/go-gitea/gitea/assets/15741789/8eb053ad-e7a4-4c63-ace5-953ff6fd9864)\r\n![Screenshot2](https://github.com/go-gitea/gitea/assets/15741789/2ae1edbb-766a-4bdd-b8ab-bb7cb89bd56f)\r\n\n\n### Git Version\n\n_No response_\n\n### Operating System\n\nlinux\n\n### How are you running Gitea?\n\ndocker\n\n### Database\n\nPostgreSQL","closed_by":{"login":"silverwind","id":115237,"node_id":"MDQ6VXNlcjExNTIzNw==","avatar_url":"https://avatars.githubusercontent.com/u/115237?v=4","gravatar_id":"","url":"https://api.github.com/users/silverwind","html_url":"https://github.com/silverwind","followers_url":"https://api.github.com/users/silverwind/followers","following_url":"https://api.github.com/users/silverwind/following{/other_user}","gists_url":"https://api.github.com/users/silverwind/gists{/gist_id}","starred_url":"https://api.github.com/users/silverwind/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/silverwind/subscriptions","organizations_url":"https://api.github.com/users/silverwind/orgs","repos_url":"https://api.github.com/users/silverwind/repos","events_url":"https://api.github.com/users/silverwind/events{/privacy}","received_events_url":"https://api.github.com/users/silverwind/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/go-gitea/gitea/issues/26129/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/go-gitea/gitea/issues/26129/timeline","performed_via_github_app":null,"state_reason":"completed"}