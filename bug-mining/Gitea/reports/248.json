{"url":"https://api.github.com/repos/go-gitea/gitea/issues/30074","repository_url":"https://api.github.com/repos/go-gitea/gitea","labels_url":"https://api.github.com/repos/go-gitea/gitea/issues/30074/labels{/name}","comments_url":"https://api.github.com/repos/go-gitea/gitea/issues/30074/comments","events_url":"https://api.github.com/repos/go-gitea/gitea/issues/30074/events","html_url":"https://github.com/go-gitea/gitea/issues/30074","id":2205828314,"node_id":"I_kwDOBFIx286DekTa","number":30074,"title":"Gitea shows outdated commit status with distributed DB backend (eg. TiDB)","user":{"login":"stevapple","id":26525394,"node_id":"MDQ6VXNlcjI2NTI1Mzk0","avatar_url":"https://avatars.githubusercontent.com/u/26525394?v=4","gravatar_id":"","url":"https://api.github.com/users/stevapple","html_url":"https://github.com/stevapple","followers_url":"https://api.github.com/users/stevapple/followers","following_url":"https://api.github.com/users/stevapple/following{/other_user}","gists_url":"https://api.github.com/users/stevapple/gists{/gist_id}","starred_url":"https://api.github.com/users/stevapple/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stevapple/subscriptions","organizations_url":"https://api.github.com/users/stevapple/orgs","repos_url":"https://api.github.com/users/stevapple/repos","events_url":"https://api.github.com/users/stevapple/events{/privacy}","received_events_url":"https://api.github.com/users/stevapple/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":472744938,"node_id":"MDU6TGFiZWw0NzI3NDQ5Mzg=","url":"https://api.github.com/repos/go-gitea/gitea/labels/type/bug","name":"type/bug","color":"ee0701","default":false,"description":""}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2024-03-25T13:56:57Z","updated_at":"2024-06-26T10:09:27Z","closed_at":"2024-03-28T08:01:16Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description\r\n\r\nGitea doesn’t always show the latest commit status (i.e. being outdated) if you use some distributed database as backend. An `auto_increment` primary key, though being expected to bump at a step of 1 at every `INSERT`, may be designed to bump independently on each nodes.\r\n\r\nWe should update `commit_status.go` to use the ``(max(`index`), repo_id, sha)`` triple to determine the latest commit status, instead of relying on `max(id)`.\r\n\r\n### Gitea Version\r\n\r\n1.21.9\r\n\r\n### Can you reproduce the bug on the Gitea demo site?\r\n\r\nNo\r\n\r\n### Log Gist\r\n\r\n_No response_\r\n\r\n### Screenshots\r\n\r\n_No response_\r\n\r\n### Git Version\r\n\r\n_No response_\r\n\r\n### Operating System\r\n\r\n_No response_\r\n\r\n### How are you running Gitea?\r\n\r\nI’m running Gitea on a Kubernetes cluster, which also hosts Woodpecker CI v2.3.0 and TiDB v7.5.1. Gitea uses TiDB (through `mysql`) as backend and Woodpecker uses Gitea as forge.\r\n\r\nThe problem was originally identified as “randomly dropping commit status on either Woodpecker, Gitea and TiDB side”, but after digging into the database it turns out that all commit statuses were there.\r\n\r\n### Database\r\n\r\nMySQL/MariaDB","closed_by":{"login":"lunny","id":81045,"node_id":"MDQ6VXNlcjgxMDQ1","avatar_url":"https://avatars.githubusercontent.com/u/81045?v=4","gravatar_id":"","url":"https://api.github.com/users/lunny","html_url":"https://github.com/lunny","followers_url":"https://api.github.com/users/lunny/followers","following_url":"https://api.github.com/users/lunny/following{/other_user}","gists_url":"https://api.github.com/users/lunny/gists{/gist_id}","starred_url":"https://api.github.com/users/lunny/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lunny/subscriptions","organizations_url":"https://api.github.com/users/lunny/orgs","repos_url":"https://api.github.com/users/lunny/repos","events_url":"https://api.github.com/users/lunny/events{/privacy}","received_events_url":"https://api.github.com/users/lunny/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/go-gitea/gitea/issues/30074/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/go-gitea/gitea/issues/30074/timeline","performed_via_github_app":null,"state_reason":"completed"}