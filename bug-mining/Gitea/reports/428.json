{"url":"https://api.github.com/repos/go-gitea/gitea/issues/32394","repository_url":"https://api.github.com/repos/go-gitea/gitea","labels_url":"https://api.github.com/repos/go-gitea/gitea/issues/32394/labels{/name}","comments_url":"https://api.github.com/repos/go-gitea/gitea/issues/32394/comments","events_url":"https://api.github.com/repos/go-gitea/gitea/issues/32394/events","html_url":"https://github.com/go-gitea/gitea/issues/32394","id":2627464455,"node_id":"I_kwDOBFIx286cm-0H","number":32394,"title":"PR reviewers list contains invalid options","user":{"login":"jackHay22","id":23248839,"node_id":"MDQ6VXNlcjIzMjQ4ODM5","avatar_url":"https://avatars.githubusercontent.com/u/23248839?v=4","gravatar_id":"","url":"https://api.github.com/users/jackHay22","html_url":"https://github.com/jackHay22","followers_url":"https://api.github.com/users/jackHay22/followers","following_url":"https://api.github.com/users/jackHay22/following{/other_user}","gists_url":"https://api.github.com/users/jackHay22/gists{/gist_id}","starred_url":"https://api.github.com/users/jackHay22/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jackHay22/subscriptions","organizations_url":"https://api.github.com/users/jackHay22/orgs","repos_url":"https://api.github.com/users/jackHay22/repos","events_url":"https://api.github.com/users/jackHay22/events{/privacy}","received_events_url":"https://api.github.com/users/jackHay22/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":472744938,"node_id":"MDU6TGFiZWw0NzI3NDQ5Mzg=","url":"https://api.github.com/repos/go-gitea/gitea/labels/type/bug","name":"type/bug","color":"ee0701","default":false,"description":""},{"id":2579882050,"node_id":"MDU6TGFiZWwyNTc5ODgyMDUw","url":"https://api.github.com/repos/go-gitea/gitea/labels/topic/pr","name":"topic/pr","color":"c396ea","default":false,"description":"Issues related to pull requests"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/go-gitea/gitea/milestones/168","html_url":"https://github.com/go-gitea/gitea/milestone/168","labels_url":"https://api.github.com/repos/go-gitea/gitea/milestones/168/labels","id":11696303,"node_id":"MI_kwDOBFIx284Asniv","number":168,"title":"1.22.4","description":"","creator":{"login":"lunny","id":81045,"node_id":"MDQ6VXNlcjgxMDQ1","avatar_url":"https://avatars.githubusercontent.com/u/81045?v=4","gravatar_id":"","url":"https://api.github.com/users/lunny","html_url":"https://github.com/lunny","followers_url":"https://api.github.com/users/lunny/followers","following_url":"https://api.github.com/users/lunny/following{/other_user}","gists_url":"https://api.github.com/users/lunny/gists{/gist_id}","starred_url":"https://api.github.com/users/lunny/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lunny/subscriptions","organizations_url":"https://api.github.com/users/lunny/orgs","repos_url":"https://api.github.com/users/lunny/repos","events_url":"https://api.github.com/users/lunny/events{/privacy}","received_events_url":"https://api.github.com/users/lunny/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":66,"state":"closed","created_at":"2024-10-09T03:24:10Z","updated_at":"2024-11-26T18:22:23Z","due_on":null,"closed_at":"2024-11-25T20:59:59Z"},"comments":0,"created_at":"2024-10-31T17:45:12Z","updated_at":"2025-02-20T16:05:43Z","closed_at":"2024-11-22T15:44:49Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description\r\n\r\nSteps to reproduce:\r\n1. Create a repository owned by an organization.\r\n2. Create a team in the org with the following permissions. Note: the team has read permission for at least one unit but _not for pull requests_\r\n<img width=\"1054\" alt=\"Screen Shot 2024-10-31 at 1 35 54 PM\" src=\"https://github.com/user-attachments/assets/c0f798ca-f342-4291-9e4b-3902ad813132\">\r\n\r\n3. Add a user to this team which is not a repo collaborator or part of any other team in the org. Notably, they do not have read permission for pull requests\r\n4. They will show up as an option in the reviewers list in a pull request within this org:\r\n<img width=\"1072\" alt=\"Screen Shot 2024-10-31 at 1 35 33 PM\" src=\"https://github.com/user-attachments/assets/aee7e6f7-9e27-4924-ad29-6cd701ea3cbc\">\r\n5. If selected, they will not be added and there is no error message\r\n\r\n```\r\n2024/10/31 13:34:51 ...rs/web/repo/issue.go:2532:UpdatePullReviewRequest() [W] UpdatePullReviewRequest: refusing to add invalid review request for <User 12:testsamluser> to <Repository 4:AuditOrg/Test-Repo>#1: Error: Reviewer can't read [user_id: 1, repo_id: 4]\r\n```\r\nNotes: \r\n```go\r\n\r\nfunc GetReviewers(ctx context.Context, repo *Repository, doerID, posterID int64) ([]*user_model.User, error) {\r\n        ...\r\n\tcond = cond.And(builder.In(\"`user`.id\",\r\n\t\tbuilder.Select(\"user_id\").From(\"access\").Where(\r\n\t\t\tbuilder.Eq{\"repo_id\": repo.ID}.\r\n\t\t\t\tAnd(builder.Gte{\"mode\": perm.AccessModeRead}),\r\n\t\t),\r\n\t))\r\n```\r\nThe `GetReviewers` function checks the `access` table to determine review eligibility. However, this table explicit stores the _highest_ level of access for a user within a repository:\r\n\r\n```go\r\n// Access represents the highest access level of a user to the repository. The only access type\r\n// that is not in this table is the real owner of a repository. In case of an organization\r\n// repository, the members of the owners team are in this table.\r\ntype Access struct {\r\n\tID     int64 `xorm:\"pk autoincr\"`\r\n\tUserID int64 `xorm:\"UNIQUE(s)\"`\r\n\tRepoID int64 `xorm:\"UNIQUE(s)\"`\r\n\tMode   perm.AccessMode\r\n}\r\n```\r\n\r\nIn this case, the `access` table will show the user as having read permission incorrectly.\r\n\r\n### Gitea Version\r\n\r\nmain\r\n\r\n### Can you reproduce the bug on the Gitea demo site?\r\n\r\nYes\r\n\r\n### Log Gist\r\n\r\n_No response_\r\n\r\n### Screenshots\r\n\r\n_No response_\r\n\r\n### Git Version\r\n\r\n_No response_\r\n\r\n### Operating System\r\n\r\n_No response_\r\n\r\n### How are you running Gitea?\r\n\r\ncommand-lin\r\n\r\n### Database\r\n\r\nNone","closed_by":{"login":"techknowlogick","id":164197,"node_id":"MDQ6VXNlcjE2NDE5Nw==","avatar_url":"https://avatars.githubusercontent.com/u/164197?v=4","gravatar_id":"","url":"https://api.github.com/users/techknowlogick","html_url":"https://github.com/techknowlogick","followers_url":"https://api.github.com/users/techknowlogick/followers","following_url":"https://api.github.com/users/techknowlogick/following{/other_user}","gists_url":"https://api.github.com/users/techknowlogick/gists{/gist_id}","starred_url":"https://api.github.com/users/techknowlogick/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/techknowlogick/subscriptions","organizations_url":"https://api.github.com/users/techknowlogick/orgs","repos_url":"https://api.github.com/users/techknowlogick/repos","events_url":"https://api.github.com/users/techknowlogick/events{/privacy}","received_events_url":"https://api.github.com/users/techknowlogick/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/go-gitea/gitea/issues/32394/reactions","total_count":2,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/go-gitea/gitea/issues/32394/timeline","performed_via_github_app":null,"state_reason":"completed"}