{"url":"https://api.github.com/repos/go-gitea/gitea/issues/34358","repository_url":"https://api.github.com/repos/go-gitea/gitea","labels_url":"https://api.github.com/repos/go-gitea/gitea/issues/34358/labels{/name}","comments_url":"https://api.github.com/repos/go-gitea/gitea/issues/34358/comments","events_url":"https://api.github.com/repos/go-gitea/gitea/issues/34358/events","html_url":"https://github.com/go-gitea/gitea/issues/34358","id":3037829908,"node_id":"I_kwDOBFIx2861EZsU","number":34358,"title":"Integration with OIDC is misbehaving","user":{"login":"flixman","id":11373728,"node_id":"MDQ6VXNlcjExMzczNzI4","avatar_url":"https://avatars.githubusercontent.com/u/11373728?v=4","gravatar_id":"","url":"https://api.github.com/users/flixman","html_url":"https://github.com/flixman","followers_url":"https://api.github.com/users/flixman/followers","following_url":"https://api.github.com/users/flixman/following{/other_user}","gists_url":"https://api.github.com/users/flixman/gists{/gist_id}","starred_url":"https://api.github.com/users/flixman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/flixman/subscriptions","organizations_url":"https://api.github.com/users/flixman/orgs","repos_url":"https://api.github.com/users/flixman/repos","events_url":"https://api.github.com/users/flixman/events{/privacy}","received_events_url":"https://api.github.com/users/flixman/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":472744940,"node_id":"MDU6TGFiZWw0NzI3NDQ5NDA=","url":"https://api.github.com/repos/go-gitea/gitea/labels/type/enhancement","name":"type/enhancement","color":"84b6eb","default":false,"description":"An improvement of existing functionality"},{"id":2575787454,"node_id":"MDU6TGFiZWwyNTc1Nzg3NDU0","url":"https://api.github.com/repos/go-gitea/gitea/labels/topic/authentication","name":"topic/authentication","color":"f4b6ab","default":false,"description":""}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":17,"created_at":"2025-05-04T07:23:01Z","updated_at":"2025-09-08T11:40:10Z","closed_at":"2025-06-09T20:57:46Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description\n\nI am using gitea behind authelia, for which I have already set up an OIDC client. The client is set up this way:\n```\ngitea admin auth add-oauth --name authelia --provider openidConnect --key gitea --secret {{ authelia.apps.gitea_password }} --auto-discover-url \"https://auth.{{ domain }}/.well-known/openid-configuration\" --scopes 'openid email profile groups' --admin-group gitea_admin\n```\n\nFor unprivileged users, I get the consent form, login, logout, log back in and... everything works.\n\nFor admin users, that is not the case:\n* The first time I log in, I get the consent form, then I confirm the username and email and all works\n* For any other login, I get a 500 error with this message on the logs:\n```\n2025/05/04 09:03:29 ...rs/web/auth/oauth.go:351:handleOAuth2SignIn() [E] UpdateUser: can not delete the last admin user [uid: 1]\n```\nShould I create a static (local) admin user with a random password (so that there is one admin user left always), then using the OIDC user works... but, although it is still in the admin group, it gets created as an unprivileged user. Authelia is still sending the group information:\n\n```\ntime=\"2025-05-04T07:12:48Z\" level=debug msg=\"Check authorization of subject username=appadmin groups=harbor_admin,gitea_admin ip=10.42.0.1 and object https://gitea.test.local/user/oauth2/authelia/callback?code=authelia_ac_xuKzjjvjSDN5jChi3nH1onld9A8u1c6JiP6Qa8p82Uc.9qzzwoc214JC4BZ_pXBIozwfXU24dhsaIwAr7N_XQuE&iss=https%3A%2F%2Fauth.test.local&scope=openid+email+profile+groups&state=72f8a6cc-8a6d-4d5e-99fe-f6cdde3820c1 (method GET).\"\ntime=\"2025-05-04T07:12:48Z\" level=debug msg=\"Access Request with id '11cf7b62-12e9-4e6e-aab7-a9632d41e672' on client with id 'gitea' is being processed\" method=POST path=/api/oidc/token remote_ip=10.42.0.1\ntime=\"2025-05-04T07:12:48Z\" level=debug msg=\"Access Request with id '11cf7b62-12e9-4e6e-aab7-a9632d41e672' on client with id 'gitea' has successfully been processed\" method=POST path=/api/oidc/token remote_ip=10.42.0.1\n```\nif I then list the users in gitea, I get the following:\n```\ngitea admin user list\nID   Username Email               IsActive IsAdmin 2FA\n1    appadmin appadmin@test.local true     **false**   false\n2    appuser  appuser@test.local  true     false   false\n3    admin    admin@local         true     true    false\n```\nso... seems that the groups information is not properly read by gitea on any logins after the first?\n\n### Gitea Version\n\n1.23.7\n\n### Can you reproduce the bug on the Gitea demo site?\n\nNo\n\n### Log Gist\n\n_No response_\n\n### Screenshots\n\n_No response_\n\n### Git Version\n\nthe one coming with the container docker.io/gitea/gitea:latest\n\n### Operating System\n\n_No response_\n\n### How are you running Gitea?\n\nthrough podman, from the image docker.io/gitea/gitea:latest\n\n### Database\n\nPostgreSQL","closed_by":{"login":"lunny","id":81045,"node_id":"MDQ6VXNlcjgxMDQ1","avatar_url":"https://avatars.githubusercontent.com/u/81045?v=4","gravatar_id":"","url":"https://api.github.com/users/lunny","html_url":"https://github.com/lunny","followers_url":"https://api.github.com/users/lunny/followers","following_url":"https://api.github.com/users/lunny/following{/other_user}","gists_url":"https://api.github.com/users/lunny/gists{/gist_id}","starred_url":"https://api.github.com/users/lunny/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lunny/subscriptions","organizations_url":"https://api.github.com/users/lunny/orgs","repos_url":"https://api.github.com/users/lunny/repos","events_url":"https://api.github.com/users/lunny/events{/privacy}","received_events_url":"https://api.github.com/users/lunny/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/go-gitea/gitea/issues/34358/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/go-gitea/gitea/issues/34358/timeline","performed_via_github_app":null,"state_reason":"completed"}