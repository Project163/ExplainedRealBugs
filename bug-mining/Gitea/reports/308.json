{"url":"https://api.github.com/repos/go-gitea/gitea/issues/30923","repository_url":"https://api.github.com/repos/go-gitea/gitea","labels_url":"https://api.github.com/repos/go-gitea/gitea/issues/30923/labels{/name}","comments_url":"https://api.github.com/repos/go-gitea/gitea/issues/30923/comments","events_url":"https://api.github.com/repos/go-gitea/gitea/issues/30923/events","html_url":"https://github.com/go-gitea/gitea/issues/30923","id":2287946054,"node_id":"I_kwDOBFIx286IX0lG","number":30923,"title":"CSRF validation errors when OAuth is not enabled","user":{"login":"bohde","id":58237,"node_id":"MDQ6VXNlcjU4MjM3","avatar_url":"https://avatars.githubusercontent.com/u/58237?v=4","gravatar_id":"","url":"https://api.github.com/users/bohde","html_url":"https://github.com/bohde","followers_url":"https://api.github.com/users/bohde/followers","following_url":"https://api.github.com/users/bohde/following{/other_user}","gists_url":"https://api.github.com/users/bohde/gists{/gist_id}","starred_url":"https://api.github.com/users/bohde/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bohde/subscriptions","organizations_url":"https://api.github.com/users/bohde/orgs","repos_url":"https://api.github.com/users/bohde/repos","events_url":"https://api.github.com/users/bohde/events{/privacy}","received_events_url":"https://api.github.com/users/bohde/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":472744938,"node_id":"MDU6TGFiZWw0NzI3NDQ5Mzg=","url":"https://api.github.com/repos/go-gitea/gitea/labels/type/bug","name":"type/bug","color":"ee0701","default":false,"description":""}],"state":"closed","locked":true,"assignee":{"login":"wxiaoguang","id":2114189,"node_id":"MDQ6VXNlcjIxMTQxODk=","avatar_url":"https://avatars.githubusercontent.com/u/2114189?v=4","gravatar_id":"","url":"https://api.github.com/users/wxiaoguang","html_url":"https://github.com/wxiaoguang","followers_url":"https://api.github.com/users/wxiaoguang/followers","following_url":"https://api.github.com/users/wxiaoguang/following{/other_user}","gists_url":"https://api.github.com/users/wxiaoguang/gists{/gist_id}","starred_url":"https://api.github.com/users/wxiaoguang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wxiaoguang/subscriptions","organizations_url":"https://api.github.com/users/wxiaoguang/orgs","repos_url":"https://api.github.com/users/wxiaoguang/repos","events_url":"https://api.github.com/users/wxiaoguang/events{/privacy}","received_events_url":"https://api.github.com/users/wxiaoguang/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"wxiaoguang","id":2114189,"node_id":"MDQ6VXNlcjIxMTQxODk=","avatar_url":"https://avatars.githubusercontent.com/u/2114189?v=4","gravatar_id":"","url":"https://api.github.com/users/wxiaoguang","html_url":"https://github.com/wxiaoguang","followers_url":"https://api.github.com/users/wxiaoguang/followers","following_url":"https://api.github.com/users/wxiaoguang/following{/other_user}","gists_url":"https://api.github.com/users/wxiaoguang/gists{/gist_id}","starred_url":"https://api.github.com/users/wxiaoguang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wxiaoguang/subscriptions","organizations_url":"https://api.github.com/users/wxiaoguang/orgs","repos_url":"https://api.github.com/users/wxiaoguang/repos","events_url":"https://api.github.com/users/wxiaoguang/events{/privacy}","received_events_url":"https://api.github.com/users/wxiaoguang/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":2,"created_at":"2024-05-09T15:35:35Z","updated_at":"2024-08-12T23:36:31Z","closed_at":"2024-05-14T14:21:40Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description\n\nWhen upgrading to 1.21, we began experiencing sporadic CSRF validation errors on form submissions. We run a multi-container Docker setup, and found this issue only happened when the container that issued the CSRF token was not the same container that handled the form submission. In investigating the container logs, we found the following log line which seems to be the root cause:\r\n\r\n```\r\n...es/setting/oauth2.go:164:GetGeneralTokenSigningSecret() [W] OAuth2 is not enabled, unable to use a persistent signing secret, a new one is generated, which is not persistent between restarts and cluster nodes\r\n```\r\n\r\nIt is possible to reproduce without multiple containers, using the following steps:\r\n\r\n1. Run a server with the following in the config file:\r\n```\r\n[oauth2]\r\nENABLE = false\r\n```\r\n2. Visit any form, such as repository settings, to have a CSRF token generated\r\n3. Restart the server\r\n4. Submit the form\r\n5. The user is now redirected to the home page, and the form submission did not work\r\n\r\n\r\n\r\nIt appears this log message, and the change to CSRF token generation was introduced in https://github.com/go-gitea/gitea/pull/29205\n\n### Gitea Version\n\n1.21.11\n\n### Can you reproduce the bug on the Gitea demo site?\n\nYes\n\n### Log Gist\n\n_No response_\n\n### Screenshots\n\n_No response_\n\n### Git Version\n\n_No response_\n\n### Operating System\n\n_No response_\n\n### How are you running Gitea?\n\nMulti-container Docker\n\n### Database\n\nNone","closed_by":{"login":"wxiaoguang","id":2114189,"node_id":"MDQ6VXNlcjIxMTQxODk=","avatar_url":"https://avatars.githubusercontent.com/u/2114189?v=4","gravatar_id":"","url":"https://api.github.com/users/wxiaoguang","html_url":"https://github.com/wxiaoguang","followers_url":"https://api.github.com/users/wxiaoguang/followers","following_url":"https://api.github.com/users/wxiaoguang/following{/other_user}","gists_url":"https://api.github.com/users/wxiaoguang/gists{/gist_id}","starred_url":"https://api.github.com/users/wxiaoguang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wxiaoguang/subscriptions","organizations_url":"https://api.github.com/users/wxiaoguang/orgs","repos_url":"https://api.github.com/users/wxiaoguang/repos","events_url":"https://api.github.com/users/wxiaoguang/events{/privacy}","received_events_url":"https://api.github.com/users/wxiaoguang/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/go-gitea/gitea/issues/30923/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/go-gitea/gitea/issues/30923/timeline","performed_via_github_app":null,"state_reason":"completed"}