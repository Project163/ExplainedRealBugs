{"url":"https://api.github.com/repos/go-gitea/gitea/issues/31752","repository_url":"https://api.github.com/repos/go-gitea/gitea","labels_url":"https://api.github.com/repos/go-gitea/gitea/issues/31752/labels{/name}","comments_url":"https://api.github.com/repos/go-gitea/gitea/issues/31752/comments","events_url":"https://api.github.com/repos/go-gitea/gitea/issues/31752/events","html_url":"https://github.com/go-gitea/gitea/issues/31752","id":2443073612,"node_id":"I_kwDOBFIx286RnlhM","number":31752,"title":"Feature Request for better performance on paging and lees memory usage on database","user":{"login":"somera","id":8334250,"node_id":"MDQ6VXNlcjgzMzQyNTA=","avatar_url":"https://avatars.githubusercontent.com/u/8334250?v=4","gravatar_id":"","url":"https://api.github.com/users/somera","html_url":"https://github.com/somera","followers_url":"https://api.github.com/users/somera/followers","following_url":"https://api.github.com/users/somera/following{/other_user}","gists_url":"https://api.github.com/users/somera/gists{/gist_id}","starred_url":"https://api.github.com/users/somera/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/somera/subscriptions","organizations_url":"https://api.github.com/users/somera/orgs","repos_url":"https://api.github.com/users/somera/repos","events_url":"https://api.github.com/users/somera/events{/privacy}","received_events_url":"https://api.github.com/users/somera/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":474393850,"node_id":"MDU6TGFiZWw0NzQzOTM4NTA=","url":"https://api.github.com/repos/go-gitea/gitea/labels/type/proposal","name":"type/proposal","color":"5319e7","default":false,"description":"The new feature has not been accepted yet but needs to be discussed first."},{"id":1743290619,"node_id":"MDU6TGFiZWwxNzQzMjkwNjE5","url":"https://api.github.com/repos/go-gitea/gitea/labels/performance/speed","name":"performance/speed","color":"db78d3","default":false,"description":"performance issues with slow downs"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":26,"created_at":"2024-08-01T18:07:28Z","updated_at":"2024-12-02T01:41:36Z","closed_at":"2024-09-02T19:05:10Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Feature Description\r\n\r\nI'm again. The gitea user with 3655 organisations and 22573 repos.\r\n\r\nI wondered that my paging is slow. Not on the first pages.\r\n\r\nFirst page need 1-3 seconds. 1 second if the data is precached.\r\n\r\n![image](https://github.com/user-attachments/assets/bf6b89fb-ae81-4ff3-819e-d2f2a2aa7fae)\r\n\r\nOn the last pages ...\r\n\r\n![image](https://github.com/user-attachments/assets/210c9434-f106-4d2f-b80f-2dc613afe36f)\r\n\r\nBut this is after my 1st optimisation.\r\n\r\nYou made this queries\r\n\r\n1. SELECT count(*) FROM \"action\" INNER JOIN \"repository\" ON \"repository\".id = \"action\".repo_id WHERE user_id=$1 AND is_deleted=$2\r\n2. SELECT action.* FROM action INNER JOIN repository ON repository.id = action.repo_id WHERE user_id='1' AND is_deleted='f' ORDER BY action.created_unix DESC LIMIT 20 OFFSET 2043740\r\n\r\non pagging.\r\n\r\nExplain for the count query is\r\n\r\n![image](https://github.com/user-attachments/assets/65b6cbb4-ebf3-4a1b-ac40-11a4a0868c58)\r\n\r\nAnd than I changed the query to\r\n\r\nSELECT count(action.id) FROM \"action\" INNER JOIN \"repository\" ON \"repository\".id = \"action\".repo_id WHERE user_id=$1 AND is_deleted=$2\r\n\r\nand ...\r\n\r\n![image](https://github.com/user-attachments/assets/d64de64e-d109-4327-ae93-5b971af6f402)\r\n\r\nit's faster.\r\n\r\n\r\nExplain for the SELECT query is\r\n\r\n![image](https://github.com/user-attachments/assets/f11ccb17-de32-44d9-8fb6-e1795a8275f5)\r\n\r\nvery bad. I increased work_mem to 6GB and it's better now\r\n\r\n![image](https://github.com/user-attachments/assets/88c5bc6f-8bfa-47ce-a826-36766447d0b2)\r\n\r\nAfter this fix it need ~11 seconds.\r\n\r\nBut it can be better. Cause the problem is this\r\n\r\nSELECT action.* FROM action INNER JOIN repository ON repository.id = action.repo_id WHERE user_id='1' AND is_deleted='f' ORDER BY action.created_unix DESC LIMIT 20 OFFSET 2043740\r\n\r\nquery. When you change it to\r\n\r\nSELECT action.id FROM action INNER JOIN repository ON repository.id = action.repo_id WHERE user_id='1' AND is_deleted='f' ORDER BY action.created_unix DESC LIMIT 20 OFFSET 2043740\r\n\r\n-> you will get 20 action.id's than explain is\r\n\r\n![image](https://github.com/user-attachments/assets/fef9d0b1-ea10-4ae4-b968-768732474543)\r\n\r\nand need ~5 seconds and a very less memory on the database.\r\n\r\nThan gitea should get the action.* infos only for the 20 id's in the new query.\r\n\r\nThis optimisation will be good for all gitea users.\r\n\r\n\r\n### Screenshots\r\n\r\n_No response_","closed_by":{"login":"lunny","id":81045,"node_id":"MDQ6VXNlcjgxMDQ1","avatar_url":"https://avatars.githubusercontent.com/u/81045?v=4","gravatar_id":"","url":"https://api.github.com/users/lunny","html_url":"https://github.com/lunny","followers_url":"https://api.github.com/users/lunny/followers","following_url":"https://api.github.com/users/lunny/following{/other_user}","gists_url":"https://api.github.com/users/lunny/gists{/gist_id}","starred_url":"https://api.github.com/users/lunny/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lunny/subscriptions","organizations_url":"https://api.github.com/users/lunny/orgs","repos_url":"https://api.github.com/users/lunny/repos","events_url":"https://api.github.com/users/lunny/events{/privacy}","received_events_url":"https://api.github.com/users/lunny/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/go-gitea/gitea/issues/31752/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/go-gitea/gitea/issues/31752/timeline","performed_via_github_app":null,"state_reason":"completed"}