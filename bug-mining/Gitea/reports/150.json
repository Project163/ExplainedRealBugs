{"url":"https://api.github.com/repos/go-gitea/gitea/issues/28155","repository_url":"https://api.github.com/repos/go-gitea/gitea","labels_url":"https://api.github.com/repos/go-gitea/gitea/issues/28155/labels{/name}","comments_url":"https://api.github.com/repos/go-gitea/gitea/issues/28155/comments","events_url":"https://api.github.com/repos/go-gitea/gitea/issues/28155/events","html_url":"https://github.com/go-gitea/gitea/issues/28155","id":2003790044,"node_id":"I_kwDOBFIx2853b2jc","number":28155,"title":"Slow MySQL Query when loading startpage","user":{"login":"gunman808","id":146823,"node_id":"MDQ6VXNlcjE0NjgyMw==","avatar_url":"https://avatars.githubusercontent.com/u/146823?v=4","gravatar_id":"","url":"https://api.github.com/users/gunman808","html_url":"https://github.com/gunman808","followers_url":"https://api.github.com/users/gunman808/followers","following_url":"https://api.github.com/users/gunman808/following{/other_user}","gists_url":"https://api.github.com/users/gunman808/gists{/gist_id}","starred_url":"https://api.github.com/users/gunman808/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gunman808/subscriptions","organizations_url":"https://api.github.com/users/gunman808/orgs","repos_url":"https://api.github.com/users/gunman808/repos","events_url":"https://api.github.com/users/gunman808/events{/privacy}","received_events_url":"https://api.github.com/users/gunman808/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":472744938,"node_id":"MDU6TGFiZWw0NzI3NDQ5Mzg=","url":"https://api.github.com/repos/go-gitea/gitea/labels/type/bug","name":"type/bug","color":"ee0701","default":false,"description":""},{"id":1743290619,"node_id":"MDU6TGFiZWwxNzQzMjkwNjE5","url":"https://api.github.com/repos/go-gitea/gitea/labels/performance/speed","name":"performance/speed","color":"db78d3","default":false,"description":"performance issues with slow downs"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2023-11-21T09:04:42Z","updated_at":"2024-03-01T00:03:51Z","closed_at":"2024-01-14T14:34:27Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description\r\n\r\nEvery time the startpage of gitea is loading it took a very long time (>8s). We have activated the mysql-slow-query-log to inspect what is happening and there is a query which tooks a very long time:\r\n\r\n```\r\nSELECT `action`.* FROM `action` INNER JOIN `repository` ON `repository`.id = `action`.repo_id WHERE user_id=7 AND is_deleted=0 ORDER BY `action`.`created_unix` DESC LIMIT 20;\r\n# Time: 2023-11-20T10:19:43.302946Z\r\n# User@Host: gitea[gitea] @  [198.18.4.243]  Id:   266\r\n# Query_time: 8.203707  Lock_time: 0.000028 Rows_sent: 20  Rows_examined: 64560\r\n```\r\n\r\nAfter using mysql explain to analyze the query, it shows the query is not using the correct index:\r\n```\r\nmysql> explain SELECT `action`.* FROM `action` INNER JOIN `repository` ON `repository`.id = `action`.repo_id WHERE user_id=7 AND is_deleted=0 ORDER BY `action`.`created_unix` DESC LIMIT 20;\r\n+----+-------------+------------+------------+-------+------------------+------------------------+---------+---------------------------------+------+----------+----------------------------------------------+\r\n| id | select_type | table      | partitions | type  | possible_keys    | key                    | key_len | ref                             | rows | filtered | Extra                                        |\r\n+----+-------------+------------+------------+-------+------------------+------------------------+---------+---------------------------------+------+----------+----------------------------------------------+\r\n|  1 | SIMPLE      | repository | NULL       | index | PRIMARY          | IDX_repository_is_fork | 1       | NULL                            |  170 |   100.00 | Using index; Using temporary; Using filesort |\r\n|  1 | SIMPLE      | action     | NULL       | ref   | IDX_action_r_u_d | IDX_action_r_u_d       | 19      | gitea.repository.id,const,const |  273 |   100.00 | NULL                                         |\r\n+----+-------------+------------+------------+-------+------------------+------------------------+---------+---------------------------------+------+----------+----------------------------------------------+\r\n2 rows in set, 1 warning (0.01 sec)\r\n```\r\nFor testing purpose we removed the index **IDX_action_r_u_d** and started the explain again:\r\n```\r\nmysql> drop index IDX_action_r_u_d on action;\r\nQuery OK, 0 rows affected (0.01 sec)\r\nRecords: 0  Duplicates: 0  Warnings: 0\r\n```\r\n```\r\nmysql> explain SELECT `action`.* FROM `action` INNER JOIN `repository` ON `repository`.id = `action`.repo_id WHERE user_id=7 AND is_deleted=0 ORDER BY `action`.`created_unix` DESC LIMIT 20;\r\n+----+-------------+------------+------------+--------+---------------+------------------+---------+----------------------+------+----------+-------------+\r\n| id | select_type | table      | partitions | type   | possible_keys | key              | key_len | ref                  | rows | filtered | Extra       |\r\n+----+-------------+------------+------------+--------+---------------+------------------+---------+----------------------+------+----------+-------------+\r\n|  1 | SIMPLE      | action     | NULL       | index  | NULL          | IDX_action_c_u_d | 19      | NULL                 |   20 |     1.00 | Using where |\r\n|  1 | SIMPLE      | repository | NULL       | eq_ref | PRIMARY       | PRIMARY          | 8       | gitea.action.repo_id |    1 |   100.00 | Using index |\r\n+----+-------------+------------+------------+--------+---------------+------------------+---------+----------------------+------+----------+-------------+\r\n2 rows in set, 1 warning (0.01 sec)\r\n```\r\nNow the query is using the IDX_action_c_u_d and the primary index.\r\nThe query is now incredibly fast in comparison. It took\r\n`20 rows in set (0.00 sec)`\r\nBefore removing the index it took `20 rows in set (8.18 sec)`.\r\n\r\nCan you check this behaviour of the index in mysql. Maybe the removed index is needed in other situations.\r\n\r\nThe workaround of removing the index is working fine for us, but every time restarting the gitea instance, the index will be created again.\r\n\r\n### Gitea Version\r\n\r\n1.20.5\r\n\r\n### Can you reproduce the bug on the Gitea demo site?\r\n\r\nNo\r\n\r\n### Log Gist\r\n\r\n_No response_\r\n\r\n### Screenshots\r\n\r\n_No response_\r\n\r\n### Git Version\r\n\r\n2.40.1\r\n\r\n### Operating System\r\n\r\nDebian 11\r\n\r\n### How are you running Gitea?\r\n\r\nIt is running in the official docker container.\r\nThe following images are used:\r\n    image: gitea:1.20.5\r\n    image: mysql:5.7\r\n    image: gitea-runner\r\n\r\n\r\n### Database\r\n\r\nMySQL/MariaDB","closed_by":{"login":"delvh","id":51889757,"node_id":"MDQ6VXNlcjUxODg5NzU3","avatar_url":"https://avatars.githubusercontent.com/u/51889757?v=4","gravatar_id":"","url":"https://api.github.com/users/delvh","html_url":"https://github.com/delvh","followers_url":"https://api.github.com/users/delvh/followers","following_url":"https://api.github.com/users/delvh/following{/other_user}","gists_url":"https://api.github.com/users/delvh/gists{/gist_id}","starred_url":"https://api.github.com/users/delvh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/delvh/subscriptions","organizations_url":"https://api.github.com/users/delvh/orgs","repos_url":"https://api.github.com/users/delvh/repos","events_url":"https://api.github.com/users/delvh/events{/privacy}","received_events_url":"https://api.github.com/users/delvh/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/go-gitea/gitea/issues/28155/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/go-gitea/gitea/issues/28155/timeline","performed_via_github_app":null,"state_reason":"completed"}