{"url":"https://api.github.com/repos/go-gitea/gitea/issues/28764","repository_url":"https://api.github.com/repos/go-gitea/gitea","labels_url":"https://api.github.com/repos/go-gitea/gitea/issues/28764/labels{/name}","comments_url":"https://api.github.com/repos/go-gitea/gitea/issues/28764/comments","events_url":"https://api.github.com/repos/go-gitea/gitea/issues/28764/events","html_url":"https://github.com/go-gitea/gitea/issues/28764","id":2076840606,"node_id":"I_kwDOBFIx2857yhKe","number":28764,"title":"GetCommitStatuses API errors when requesting the second page","user":{"login":"Pentiva","id":2913565,"node_id":"MDQ6VXNlcjI5MTM1NjU=","avatar_url":"https://avatars.githubusercontent.com/u/2913565?v=4","gravatar_id":"","url":"https://api.github.com/users/Pentiva","html_url":"https://github.com/Pentiva","followers_url":"https://api.github.com/users/Pentiva/followers","following_url":"https://api.github.com/users/Pentiva/following{/other_user}","gists_url":"https://api.github.com/users/Pentiva/gists{/gist_id}","starred_url":"https://api.github.com/users/Pentiva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Pentiva/subscriptions","organizations_url":"https://api.github.com/users/Pentiva/orgs","repos_url":"https://api.github.com/users/Pentiva/repos","events_url":"https://api.github.com/users/Pentiva/events{/privacy}","received_events_url":"https://api.github.com/users/Pentiva/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":472744938,"node_id":"MDU6TGFiZWw0NzI3NDQ5Mzg=","url":"https://api.github.com/repos/go-gitea/gitea/labels/type/bug","name":"type/bug","color":"ee0701","default":false,"description":""}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/go-gitea/gitea/milestones/154","html_url":"https://github.com/go-gitea/gitea/milestone/154","labels_url":"https://api.github.com/repos/go-gitea/gitea/milestones/154/labels","id":10337390,"node_id":"MI_kwDOBFIx284Anbxu","number":154,"title":"1.21.4","description":"","creator":{"login":"lunny","id":81045,"node_id":"MDQ6VXNlcjgxMDQ1","avatar_url":"https://avatars.githubusercontent.com/u/81045?v=4","gravatar_id":"","url":"https://api.github.com/users/lunny","html_url":"https://github.com/lunny","followers_url":"https://api.github.com/users/lunny/followers","following_url":"https://api.github.com/users/lunny/following{/other_user}","gists_url":"https://api.github.com/users/lunny/gists{/gist_id}","starred_url":"https://api.github.com/users/lunny/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lunny/subscriptions","organizations_url":"https://api.github.com/users/lunny/orgs","repos_url":"https://api.github.com/users/lunny/repos","events_url":"https://api.github.com/users/lunny/events{/privacy}","received_events_url":"https://api.github.com/users/lunny/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":65,"state":"closed","created_at":"2023-12-21T08:32:13Z","updated_at":"2024-01-17T02:49:27Z","due_on":"2024-01-05T08:00:00Z","closed_at":"2024-01-17T02:49:27Z"},"comments":1,"created_at":"2024-01-11T14:38:31Z","updated_at":"2024-03-01T00:03:18Z","closed_at":"2024-01-15T14:07:33Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description\n\nI am running renovate on my self hosted gitea instance and it fails to get the statuses of a commit if the commit has more statuses than the default limit (requiring renovate to request a second page). \r\n\r\nHere are what I believe to be the relevant logs (first group is the successful first request, second group is the failure):\r\n```logs\r\nmodels/auth/token.go:173:GetAccessTokenBySHA() [I] [SQL] SELECT `id`, `uid`, `name`, `token_hash`, `token_salt`, `token_last_eight`, `scope`, `created_unix`, `updated_unix` FROM `access_token` WHERE (token_last_eight = ?) [a152dcca] - 171.416µs\r\n...vices/auth/oauth2.go:145:Verify() [I] [SQL] UPDATE `access_token` SET `uid` = ?, `name` = ?, `token_hash` = ?, `token_salt` = ?, `token_last_eight` = ?, `scope` = ?, `updated_unix` = ? WHERE `id`=? [<redacted>] - 4.416784ms\r\nmodels/user/user.go:915:GetUserByID() [I] [SQL] SELECT `id`, `lower_name`, `name`, `full_name`, `email`, `keep_email_private`, `email_notifications_preference`, `passwd`, `passwd_hash_algo`, `must_change_password`, `login_type`, `login_source`, `login_name`, `type`, `location`, `website`, `rands`, `salt`, `language`, `description`, `created_unix`, `updated_unix`, `last_login_unix`, `last_repo_visibility`, `max_repo_creation`, `is_active`, `is_admin`, `is_restricted`, `allow_git_hook`, `allow_import_local`, `allow_create_organization`, `prohibit_login`, `avatar`, `avatar_email`, `use_custom_avatar`, `num_followers`, `num_following`, `num_stars`, `num_repos`, `num_teams`, `num_members`, `visibility`, `repo_admin_change_team_access`, `diff_view_style`, `theme`, `keep_activity_private` FROM `user` WHERE `id`=? LIMIT 1 [10] - 277.353µs\r\nmodels/user/user.go:972:GetUserByName() [I] [SQL] SELECT `id`, `lower_name`, `name`, `full_name`, `email`, `keep_email_private`, `email_notifications_preference`, `passwd`, `passwd_hash_algo`, `must_change_password`, `login_type`, `login_source`, `login_name`, `type`, `location`, `website`, `rands`, `salt`, `language`, `description`, `created_unix`, `updated_unix`, `last_login_unix`, `last_repo_visibility`, `max_repo_creation`, `is_active`, `is_admin`, `is_restricted`, `allow_git_hook`, `allow_import_local`, `allow_create_organization`, `prohibit_login`, `avatar`, `avatar_email`, `use_custom_avatar`, `num_followers`, `num_following`, `num_stars`, `num_repos`, `num_teams`, `num_members`, `visibility`, `repo_admin_change_team_access`, `diff_view_style`, `theme`, `keep_activity_private` FROM `user` WHERE `lower_name`=? LIMIT 1 [<redacted>] - 185.771µs\r\n...orm@v1.3.4/engine.go:1246:Get() [I] [SQL] SELECT `id`, `owner_id`, `owner_name`, `lower_name`, `name`, `description`, `website`, `original_service_type`, `original_url`, `default_branch`, `num_watches`, `num_stars`, `num_forks`, `num_issues`, `num_closed_issues`, `num_pulls`, `num_closed_pulls`, `num_milestones`, `num_closed_milestones`, `num_projects`, `num_closed_projects`, `num_action_runs`, `num_closed_action_runs`, `is_private`, `is_empty`, `is_archived`, `is_mirror`, `status`, `is_fork`, `fork_id`, `is_template`, `template_id`, `size`, `git_size`, `lfs_size`, `is_fsck_enabled`, `close_issues_via_commit_in_any_branch`, `topics`, `trust_model`, `avatar`, `created_unix`, `updated_unix`, `archived_unix` FROM `repository` WHERE `owner_id`=? AND `lower_name`=? LIMIT 1 [3 <redacted>] - 130.185µs\r\n...epo/collaboration.go:84:IsCollaborator() [I] [SQL] SELECT `id`, `repo_id`, `user_id`, `mode`, `created_unix`, `updated_unix` FROM `collaboration` WHERE `repo_id`=? AND `user_id`=? LIMIT 1 [49 10] - 68.119µs\r\n...ls/repo/repo_unit.go:268:getUnitsByRepoID() [I] [SQL] SELECT `id`, `repo_id`, `type`, `config`, `created_unix` FROM `repo_unit` WHERE (repo_id = ?) [49] - 97.757µs\r\nmodels/db/context.go:178:GetByBean() [I] [SQL] SELECT `id`, `user_id`, `repo_id`, `mode` FROM `access` WHERE `user_id`=? AND `repo_id`=? LIMIT 1 [10 49] - 55.576µs\r\n...pi/v1/repo/status.go:197:getCommitStatuses() [I] [SQL] SELECT count(*) FROM `commit_status` WHERE (repo_id = ?) AND (sha = ?) LIMIT 30 [49 <redacted>] - 149.412µs\r\n...git/commit_status.go:248:GetCommitStatuses() [I] [SQL] SELECT `id`, `index`, `repo_id`, `state`, `sha`, `target_url`, `description`, `context_hash`, `context`, `creator_id`, `created_unix`, `updated_unix` FROM `commit_status` WHERE (repo_id = ?) AND (sha = ?) ORDER BY `created_unix` DESC LIMIT 30 [49 <redacted>] - 150.464µs\r\nmodels/repo/repo.go:779:GetRepositoryByID() [I] [SQL] SELECT `id`, `owner_id`, `owner_name`, `lower_name`, `name`, `description`, `website`, `original_service_type`, `original_url`, `default_branch`, `num_watches`, `num_stars`, `num_forks`, `num_issues`, `num_closed_issues`, `num_pulls`, `num_closed_pulls`, `num_milestones`, `num_closed_milestones`, `num_projects`, `num_closed_projects`, `num_action_runs`, `num_closed_action_runs`, `is_private`, `is_empty`, `is_archived`, `is_mirror`, `status`, `is_fork`, `fork_id`, `is_template`, `template_id`, `size`, `git_size`, `lfs_size`, `is_fsck_enabled`, `close_issues_via_commit_in_any_branch`, `topics`, `trust_model`, `avatar`, `created_unix`, `updated_unix`, `archived_unix` FROM `repository` WHERE `id`=? LIMIT 1 [49] - 653.254µs\r\nmodels/user/user.go:915:GetUserByID() [I] [SQL] SELECT `id`, `lower_name`, `name`, `full_name`, `email`, `keep_email_private`, `email_notifications_preference`, `passwd`, `passwd_hash_algo`, `must_change_password`, `login_type`, `login_source`, `login_name`, `type`, `location`, `website`, `rands`, `salt`, `language`, `description`, `created_unix`, `updated_unix`, `last_login_unix`, `last_repo_visibility`, `max_repo_creation`, `is_active`, `is_admin`, `is_restricted`, `allow_git_hook`, `allow_import_local`, `allow_create_organization`, `prohibit_login`, `avatar`, `avatar_email`, `use_custom_avatar`, `num_followers`, `num_following`, `num_stars`, `num_repos`, `num_teams`, `num_members`, `visibility`, `repo_admin_change_team_access`, `diff_view_style`, `theme`, `keep_activity_private` FROM `user` WHERE `id`=? LIMIT 1 [3] - 125.167µs\r\n\r\nmodels/auth/token.go:173:GetAccessTokenBySHA() [I] [SQL] SELECT `id`, `uid`, `name`, `token_hash`, `token_salt`, `token_last_eight`, `scope`, `created_unix`, `updated_unix` FROM `access_token` WHERE (token_last_eight = ?) [<redacted>] - 157.565µs\r\n...vices/auth/oauth2.go:145:Verify() [I] [SQL] UPDATE `access_token` SET `uid` = ?, `name` = ?, `token_hash` = ?, `token_salt` = ?, `token_last_eight` = ?, `scope` = ?, `updated_unix` = ? WHERE `id`=? [<redacted>] - 6.455588ms\r\nmodels/user/user.go:915:GetUserByID() [I] [SQL] SELECT `id`, `lower_name`, `name`, `full_name`, `email`, `keep_email_private`, `email_notifications_preference`, `passwd`, `passwd_hash_algo`, `must_change_password`, `login_type`, `login_source`, `login_name`, `type`, `location`, `website`, `rands`, `salt`, `language`, `description`, `created_unix`, `updated_unix`, `last_login_unix`, `last_repo_visibility`, `max_repo_creation`, `is_active`, `is_admin`, `is_restricted`, `allow_git_hook`, `allow_import_local`, `allow_create_organization`, `prohibit_login`, `avatar`, `avatar_email`, `use_custom_avatar`, `num_followers`, `num_following`, `num_stars`, `num_repos`, `num_teams`, `num_members`, `visibility`, `repo_admin_change_team_access`, `diff_view_style`, `theme`, `keep_activity_private` FROM `user` WHERE `id`=? LIMIT 1 [10] - 155.729µs\r\nmodels/user/user.go:972:GetUserByName() [I] [SQL] SELECT `id`, `lower_name`, `name`, `full_name`, `email`, `keep_email_private`, `email_notifications_preference`, `passwd`, `passwd_hash_algo`, `must_change_password`, `login_type`, `login_source`, `login_name`, `type`, `location`, `website`, `rands`, `salt`, `language`, `description`, `created_unix`, `updated_unix`, `last_login_unix`, `last_repo_visibility`, `max_repo_creation`, `is_active`, `is_admin`, `is_restricted`, `allow_git_hook`, `allow_import_local`, `allow_create_organization`, `prohibit_login`, `avatar`, `avatar_email`, `use_custom_avatar`, `num_followers`, `num_following`, `num_stars`, `num_repos`, `num_teams`, `num_members`, `visibility`, `repo_admin_change_team_access`, `diff_view_style`, `theme`, `keep_activity_private` FROM `user` WHERE `lower_name`=? LIMIT 1 [<redacted>] - 125.594µs\r\n...orm@v1.3.4/engine.go:1246:Get() [I] [SQL] SELECT `id`, `owner_id`, `owner_name`, `lower_name`, `name`, `description`, `website`, `original_service_type`, `original_url`, `default_branch`, `num_watches`, `num_stars`, `num_forks`, `num_issues`, `num_closed_issues`, `num_pulls`, `num_closed_pulls`, `num_milestones`, `num_closed_milestones`, `num_projects`, `num_closed_projects`, `num_action_runs`, `num_closed_action_runs`, `is_private`, `is_empty`, `is_archived`, `is_mirror`, `status`, `is_fork`, `fork_id`, `is_template`, `template_id`, `size`, `git_size`, `lfs_size`, `is_fsck_enabled`, `close_issues_via_commit_in_any_branch`, `topics`, `trust_model`, `avatar`, `created_unix`, `updated_unix`, `archived_unix` FROM `repository` WHERE `owner_id`=? AND `lower_name`=? LIMIT 1 [3 <redacted>] - 94.56µs\r\n...epo/collaboration.go:84:IsCollaborator() [I] [SQL] SELECT `id`, `repo_id`, `user_id`, `mode`, `created_unix`, `updated_unix` FROM `collaboration` WHERE `repo_id`=? AND `user_id`=? LIMIT 1 [49 10] - 62.068µs\r\n...ls/repo/repo_unit.go:268:getUnitsByRepoID() [I] [SQL] SELECT `id`, `repo_id`, `type`, `config`, `created_unix` FROM `repo_unit` WHERE (repo_id = ?) [49] - 103.589µs\r\nmodels/db/context.go:178:GetByBean() [I] [SQL] SELECT `id`, `user_id`, `repo_id`, `mode` FROM `access` WHERE `user_id`=? AND `repo_id`=? LIMIT 1 [10 49] - 28.62µs\r\n...pi/v1/repo/status.go:197:getCommitStatuses() [I] [SQL] SELECT count(*) FROM `commit_status` WHERE (repo_id = ?) AND (sha = ?) LIMIT 30 OFFSET 30 [49 <redacted>] - 133.356µs\r\n...git/commit_status.go:240:GetCommitStatuses() [E] Count PRs: sql: no rows in result set\r\n...pi/v1/repo/status.go:203:getCommitStatuses() [E] GetCommitStatuses: GetCommitStatuses[<redacted>, <redacted>, 2]: sql: no rows in result set\r\n...eb/routing/logger.go:102:func1() [I] router: completed GET /api/v1/repos/<redacted>/<redacted>/commits/<redacted>/statuses?page=2 for 162.158.111.145:0, 500 Internal Server Error in 56.1ms @ repo/status.go:129(repo.GetCommitStatusesByRef)\r\n```\r\n\r\nIt looks like the SQL command is applying the OFFSET of the page to the final count rather than the actual query. \r\nhttps://github.com/go-gitea/gitea/blob/669bbbaf243ae1e65d6667eb91d2a963b526ebd7/models/git/commit_status.go#L237-L239\r\n\r\nThe renovate error message (which I don't think is necessary, as I believe it is doing what it should) is:\r\n\r\n```json\r\n{\r\n  \"name\": \"HTTPError\",\r\n  \"code\": \"ERR_NON_2XX_3XX_RESPONSE\",\r\n  \"timings\": {\r\n    \"start\": 1704979100676,\r\n    \"socket\": 1704979100677,\r\n    \"lookup\": 1704979100678,\r\n    \"connect\": 1704979100680,\r\n    \"secureConnect\": 1704979100686,\r\n    \"upload\": 1704979100686,\r\n    \"response\": 1704979100765,\r\n    \"end\": 1704979100765,\r\n    \"phases\": {\r\n      \"wait\": 1,\r\n      \"dns\": 1,\r\n      \"tcp\": 2,\r\n      \"tls\": 6,\r\n      \"request\": 0,\r\n      \"firstByte\": 79,\r\n      \"download\": 0,\r\n      \"total\": 89\r\n    }\r\n  },\r\n  \"message\": \"Response code 500 (Internal Server Error)\",\r\n  \"stack\": \"HTTPError: Response code 500 (Internal Server Error)\\n    at Request.<anonymous> (/opt/containerbase/tools/renovate/37.128.4/node_modules/got/dist/source/as-promise/index.js:118:42)\\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\",\r\n  \"options\": {\r\n    \"headers\": {\r\n      \"user-agent\": \"RenovateBot/37.128.4 (https://github.com/renovatebot/renovate)\",\r\n      \"accept\": \"application/json\",\r\n      \"authorization\": \"***********\",\r\n      \"accept-encoding\": \"gzip, deflate, br\"\r\n    },\r\n    \"url\": \"https://<redacted>/api/v1/repos/<redacted>/<redacted>/commits/<redacted>/statuses?page=2\",\r\n    \"hostType\": \"gitea\",\r\n    \"username\": \"\",\r\n    \"password\": \"\",\r\n    \"method\": \"GET\",\r\n    \"http2\": false\r\n  },\r\n  \"response\": {\r\n    \"statusCode\": 500,\r\n    \"statusMessage\": \"Internal Server Error\",\r\n    \"body\": {\r\n      \"message\": \"\",\r\n      \"url\": \"https://<redacted>/api/swagger\"\r\n    },\r\n    \"headers\": {\r\n      \"date\": \"Thu, 11 Jan 2024 13:18:20 GMT\",\r\n      \"content-type\": \"application/json;charset=utf-8\",\r\n      \"content-length\": \"55\",\r\n      \"connection\": \"close\",\r\n      \"cache-control\": \"max-age=0, private, must-revalidate, no-transform\",\r\n      \"x-content-type-options\": \"nosniff\",\r\n      \"x-frame-options\": \"SAMEORIGIN\",\r\n      \"cf-cache-status\": \"DYNAMIC\",\r\n      \"nel\": \"{\\\"success_fraction\\\":0,\\\"report_to\\\":\\\"cf-nel\\\",\\\"max_age\\\":604800}\",\r\n      \"server\": \"cloudflare\",\r\n      \"alt-svc\": \"h3=\\\":443\\\"; ma=86400\"\r\n    },\r\n    \"httpVersion\": \"1.1\",\r\n    \"retryCount\": 2\r\n  }\r\n}\r\n```\n\n### Gitea Version\n\n1.21.3\n\n### Can you reproduce the bug on the Gitea demo site?\n\nNo\n\n### Log Gist\n\n_No response_\n\n### Screenshots\n\n_No response_\n\n### Git Version\n\n2.43.0\n\n### Operating System\n\nLinux Ubuntu 23.10\n\n### How are you running Gitea?\n\nOfficial binary\n\n### Database\n\nSQLite","closed_by":{"login":"lunny","id":81045,"node_id":"MDQ6VXNlcjgxMDQ1","avatar_url":"https://avatars.githubusercontent.com/u/81045?v=4","gravatar_id":"","url":"https://api.github.com/users/lunny","html_url":"https://github.com/lunny","followers_url":"https://api.github.com/users/lunny/followers","following_url":"https://api.github.com/users/lunny/following{/other_user}","gists_url":"https://api.github.com/users/lunny/gists{/gist_id}","starred_url":"https://api.github.com/users/lunny/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lunny/subscriptions","organizations_url":"https://api.github.com/users/lunny/orgs","repos_url":"https://api.github.com/users/lunny/repos","events_url":"https://api.github.com/users/lunny/events{/privacy}","received_events_url":"https://api.github.com/users/lunny/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/go-gitea/gitea/issues/28764/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/go-gitea/gitea/issues/28764/timeline","performed_via_github_app":null,"state_reason":"completed"}