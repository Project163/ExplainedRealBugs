{"url":"https://api.github.com/repos/go-gitea/gitea/issues/34852","repository_url":"https://api.github.com/repos/go-gitea/gitea","labels_url":"https://api.github.com/repos/go-gitea/gitea/issues/34852/labels{/name}","comments_url":"https://api.github.com/repos/go-gitea/gitea/issues/34852/comments","events_url":"https://api.github.com/repos/go-gitea/gitea/issues/34852/events","html_url":"https://github.com/go-gitea/gitea/issues/34852","id":3173584635,"node_id":"I_kwDOBFIx2869KQ77","number":34852,"title":"Private+Anonymous Read repo: `/api/../archive/` fails with \"The target couldn't be found.\"","user":{"login":"pbsds","id":140964,"node_id":"MDQ6VXNlcjE0MDk2NA==","avatar_url":"https://avatars.githubusercontent.com/u/140964?v=4","gravatar_id":"","url":"https://api.github.com/users/pbsds","html_url":"https://github.com/pbsds","followers_url":"https://api.github.com/users/pbsds/followers","following_url":"https://api.github.com/users/pbsds/following{/other_user}","gists_url":"https://api.github.com/users/pbsds/gists{/gist_id}","starred_url":"https://api.github.com/users/pbsds/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pbsds/subscriptions","organizations_url":"https://api.github.com/users/pbsds/orgs","repos_url":"https://api.github.com/users/pbsds/repos","events_url":"https://api.github.com/users/pbsds/events{/privacy}","received_events_url":"https://api.github.com/users/pbsds/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":472744938,"node_id":"MDU6TGFiZWw0NzI3NDQ5Mzg=","url":"https://api.github.com/repos/go-gitea/gitea/labels/type/bug","name":"type/bug","color":"ee0701","default":false,"description":""}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2025-06-24T23:29:02Z","updated_at":"2025-09-24T00:34:39Z","closed_at":"2025-06-25T06:55:21Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description\n\nThe header of my repo displays these labels:\n\n![Image](https://github.com/user-attachments/assets/a202f366-b969-41c6-8b8f-d50d25f57a3a)\n\nRepo settings:\n\n![Image](https://github.com/user-attachments/assets/b2584be5-a0af-431f-bf98-7d7a9bcf13bd)\n\nFetching an archive of a repo works:\n\n```shell\n$ curl -I https://{hostname}/{owner}/{repo}/archive/main.tar.gz\nHTTP/2 200\nserver: nginx\ndate: Tue, 24 Jun 2025 23:07:11 GMT\ncontent-type: application/octet-stream\ncontent-length: 655169\naccept-ranges: bytes\naccess-control-expose-headers: Content-Disposition\ncache-control: max-age=0, private, must-revalidate, no-transform\ncontent-disposition: attachment; filename=\"{repo}-main.tar.gz\"; filename*=UTF-8''{repo}-main.tar.gz\nlast-modified: Mon, 23 Jun 2025 22:20:43 GMT\nlink: <https://{hostname}/api/v1/repos{owner}/{repo}/archive/fb7b0a7e70754cf368de7d7c469dabe71b2f1c78.tar.gz?rev=fb7b0a7e70754cf368de7d7c469dabe71b2f1c78>; rel=\"immutable\"\nno-gzip-compression: 1\nset-cookie: session=fe2e418eb5a7a3fd; Path=/; HttpOnly; Secure; SameSite=Lax\nset-cookie: _csrf=Ylk7fhmB5R1FCoTGyC7ax5Y4ebQ6MTc1MDgwNjQzMTIzMzcwMTc4Mw; Path=/; Max-Age=86400; HttpOnly; Secure; SameSite=Lax\nx-content-type-options: nosniff\nx-frame-options: SAMEORIGIN\n```\n\nTools like `nix flake lock` will use the url from `link` header for reproducibility. It however does not work:\n\n```shell\n$ curl -I https://{hostname}/api/v1/repos/{owner}/{repo}/archive/fb7b0a7e70754cf368de7d7c469dabe71b2f1c78.tar.gz?rev=fb7b0a7e70754cf368de7d7c469dabe71b2f1c78\nHTTP/2 405\nserver: nginx\ndate: Tue, 24 Jun 2025 23:11:22 GMT\nallow: GET\ncache-control: max-age=0, private, must-revalidate, no-transform\nx-content-type-options: nosniff\nx-frame-options: SAMEORIGIN\n```\n\n```shell\n$ curl https://{hostname}/api/v1/repos/{owner}/{repo}/archive/fb7b0a7e70754cf368de7d7c469dabe71b2f1c78.tar.gz?rev=fb7b0a7e70754cf368de7d7c469dabe71b2f1c78\n{\"errors\":null,\"message\":\"The target couldn't be found.\",\"url\":\"https://{hostname}/api/swagger\"}\n```\n\nInterestingly however it works when I use the non-`/api/v1/repos/` endpoint:\n\n```shell\n$ curl https://{hostname}/{owner}/{repo}/archive/fb7b0a7e70754cf368de7d7c469dabe71b2f1c78.tar.gz?rev=fb7b0a7e70754cf368de7d7c469dabe71b2f1c78\nWarning: Binary output can mess up your terminal. Use \"--output -\" to tell curl to output it to your terminal anyway, or consider \"--output <FILE>\" to save to a file.\n```\n\nAs such I assume this bug is https://github.com/go-gitea/gitea/issues/8649 / https://github.com/go-gitea/gitea/pull/33127 not applying to `/api/` endpoints.\n\n\n### Gitea Version\n\n1.24.0\n\n### Can you reproduce the bug on the Gitea demo site?\n\nYes\n\n### Log Gist\n\n_No response_\n\n### Screenshots\n\nFrom the demo instance:\n\n![Image](https://github.com/user-attachments/assets/533c438f-65f9-4bce-8493-148769811597)\n\n![Image](https://github.com/user-attachments/assets/5aac1c96-5cc1-400f-ba08-c26e3d320968)\n\n```shell\n$ curl -I https://demo.gitea.com/pbsds/asd/archive/main.zip\nHTTP/2 200\naccept-ranges: bytes\naccess-control-expose-headers: Content-Disposition\nalt-svc: h3=\":443\"; ma=2592000\ncache-control: max-age=0, private, must-revalidate, no-transform\ncontent-disposition: attachment; filename=\"asd-main.zip\"; filename*=UTF-8''asd-main.zip\ncontent-type: application/octet-stream\ndate: Tue, 24 Jun 2025 23:26:13 GMT\nlast-modified: Tue, 24 Jun 2025 23:26:12 GMT\nlink: <https://demo.gitea.com/api/v1/repos/pbsds/asd/archive/2b369676dcf0c63d043d40b454c6dac29ba5200d.tar.gz?rev=2b369676dcf0c63d043d40b454c6dac29ba5200d>; rel=\"immutable\"\nno-gzip-compression: 1\nserver: Caddy\nset-cookie: i_like_gitea=f8abf4e28a620ef7; Path=/; HttpOnly; Secure; SameSite=Lax\nset-cookie: _csrf=_0iXbqCgf9umvJNC56urX0Bf7cA6MTc1MDgwNzU2ODc2NDI5MDcwMA; Path=/; Max-Age=86400; HttpOnly; Secure; SameSite=Lax\nx-content-type-options: nosniff\nx-frame-options: SAMEORIGIN\ncontent-length: 286\n\n$ curl -I http://demo.gitea.com/api/v1/repos/pbsds/asd/archive/2b369676dcf0c63d043d40b454c6dac29ba5200d.tar.gz?rev=2b369676dcf0c63d043d40b454c6dac29ba5200d\nHTTP/1.1 308 Permanent Redirect\nConnection: close\nLocation: https://demo.gitea.com/api/v1/repos/pbsds/asd/archive/2b369676dcf0c63d043d40b454c6dac29ba5200d.tar.gz?rev=2b369676dcf0c63d043d40b454c6dac29ba5200d\nServer: Caddy\nDate: Tue, 24 Jun 2025 23:26:23 GMT\n\n$ curl -I https://demo.gitea.com/api/v1/repos/pbsds/asd/archive/2b369676dcf0c63d043d40b454c6dac29ba5200d.tar.gz?rev=2b369676dcf0c63d043d40b454c6dac29ba5200d\nHTTP/2 405\nallow: GET\nalt-svc: h3=\":443\"; ma=2592000\ncache-control: max-age=0, private, must-revalidate, no-transform\ndate: Tue, 24 Jun 2025 23:26:43 GMT\nserver: Caddy\nx-content-type-options: nosniff\nx-frame-options: SAMEORIGIN\n\n$ curl https://demo.gitea.com/api/v1/repos/pbsds/asd/archive/2b369676dcf0c63d043d40b454c6dac29ba5200d.tar.gz?rev=2b369676dcf0c63d043d40b454c6dac29ba5200d\n{\"errors\":null,\"message\":\"not found\",\"url\":\"https://demo.gitea.com/api/swagger\"}\n```\n\n### Git Version\n\n_No response_\n\n### Operating System\n\n_No response_\n\n### How are you running Gitea?\n\nWe use the nixos module which in turn uses nginx\n\n### Database\n\nPostgreSQL","closed_by":{"login":"wxiaoguang","id":2114189,"node_id":"MDQ6VXNlcjIxMTQxODk=","avatar_url":"https://avatars.githubusercontent.com/u/2114189?v=4","gravatar_id":"","url":"https://api.github.com/users/wxiaoguang","html_url":"https://github.com/wxiaoguang","followers_url":"https://api.github.com/users/wxiaoguang/followers","following_url":"https://api.github.com/users/wxiaoguang/following{/other_user}","gists_url":"https://api.github.com/users/wxiaoguang/gists{/gist_id}","starred_url":"https://api.github.com/users/wxiaoguang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wxiaoguang/subscriptions","organizations_url":"https://api.github.com/users/wxiaoguang/orgs","repos_url":"https://api.github.com/users/wxiaoguang/repos","events_url":"https://api.github.com/users/wxiaoguang/events{/privacy}","received_events_url":"https://api.github.com/users/wxiaoguang/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/go-gitea/gitea/issues/34852/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/go-gitea/gitea/issues/34852/timeline","performed_via_github_app":null,"state_reason":"completed"}