{"url":"https://api.github.com/repos/go-gitea/gitea/issues/31202","repository_url":"https://api.github.com/repos/go-gitea/gitea","labels_url":"https://api.github.com/repos/go-gitea/gitea/issues/31202/labels{/name}","comments_url":"https://api.github.com/repos/go-gitea/gitea/issues/31202/comments","events_url":"https://api.github.com/repos/go-gitea/gitea/issues/31202/events","html_url":"https://github.com/go-gitea/gitea/issues/31202","id":2328184033,"node_id":"I_kwDOBFIx286KxUTh","number":31202,"title":"Sign in not possible behind tinyproxy with sub-path","user":{"login":"LauKr","id":37706897,"node_id":"MDQ6VXNlcjM3NzA2ODk3","avatar_url":"https://avatars.githubusercontent.com/u/37706897?v=4","gravatar_id":"","url":"https://api.github.com/users/LauKr","html_url":"https://github.com/LauKr","followers_url":"https://api.github.com/users/LauKr/followers","following_url":"https://api.github.com/users/LauKr/following{/other_user}","gists_url":"https://api.github.com/users/LauKr/gists{/gist_id}","starred_url":"https://api.github.com/users/LauKr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/LauKr/subscriptions","organizations_url":"https://api.github.com/users/LauKr/orgs","repos_url":"https://api.github.com/users/LauKr/repos","events_url":"https://api.github.com/users/LauKr/events{/privacy}","received_events_url":"https://api.github.com/users/LauKr/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":474800073,"node_id":"MDU6TGFiZWw0NzQ4MDAwNzM=","url":"https://api.github.com/repos/go-gitea/gitea/labels/issue/needs-feedback","name":"issue/needs-feedback","color":"1d76db","default":false,"description":"For bugs, we need more details. For features, the feature must be described in more detail"},{"id":1888766647,"node_id":"MDU6TGFiZWwxODg4NzY2NjQ3","url":"https://api.github.com/repos/go-gitea/gitea/labels/issue/not-a-bug","name":"issue/not-a-bug","color":"8feabf","default":false,"description":"The reported issue is the intended behavior or the problem is not inside Gitea"}],"state":"closed","locked":true,"assignee":{"login":"wxiaoguang","id":2114189,"node_id":"MDQ6VXNlcjIxMTQxODk=","avatar_url":"https://avatars.githubusercontent.com/u/2114189?v=4","gravatar_id":"","url":"https://api.github.com/users/wxiaoguang","html_url":"https://github.com/wxiaoguang","followers_url":"https://api.github.com/users/wxiaoguang/followers","following_url":"https://api.github.com/users/wxiaoguang/following{/other_user}","gists_url":"https://api.github.com/users/wxiaoguang/gists{/gist_id}","starred_url":"https://api.github.com/users/wxiaoguang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wxiaoguang/subscriptions","organizations_url":"https://api.github.com/users/wxiaoguang/orgs","repos_url":"https://api.github.com/users/wxiaoguang/repos","events_url":"https://api.github.com/users/wxiaoguang/events{/privacy}","received_events_url":"https://api.github.com/users/wxiaoguang/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"wxiaoguang","id":2114189,"node_id":"MDQ6VXNlcjIxMTQxODk=","avatar_url":"https://avatars.githubusercontent.com/u/2114189?v=4","gravatar_id":"","url":"https://api.github.com/users/wxiaoguang","html_url":"https://github.com/wxiaoguang","followers_url":"https://api.github.com/users/wxiaoguang/followers","following_url":"https://api.github.com/users/wxiaoguang/following{/other_user}","gists_url":"https://api.github.com/users/wxiaoguang/gists{/gist_id}","starred_url":"https://api.github.com/users/wxiaoguang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wxiaoguang/subscriptions","organizations_url":"https://api.github.com/users/wxiaoguang/orgs","repos_url":"https://api.github.com/users/wxiaoguang/repos","events_url":"https://api.github.com/users/wxiaoguang/events{/privacy}","received_events_url":"https://api.github.com/users/wxiaoguang/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":20,"created_at":"2024-05-31T16:19:43Z","updated_at":"2024-09-09T21:05:19Z","closed_at":"2024-06-11T12:58:40Z","author_association":"NONE","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description\n\nRunning Gitea behind a Reverse Proxy using a sub-path doesn't allow login.\r\nThis issue was first occurring with the update 1.21.10 -> 1.21.11 and\r\ncontinues with 1.22.0.\r\n\r\nAfter entering credentials and pressing the \"Sign In\" button, the\r\nunauthenticated \"root\" site is shown again, like after a logout.\r\n\r\nFrom the [release notes](https://github.com/go-gitea/gitea/releases/tag/v1.21.11)\r\nwe noted the following change which seems suspicious:\r\n\r\n> Fix to delete the cookie when AppSubURL is non-empty ([#30375](https://github.com/go-gitea/gitea/pull/30375)) ([#30468](https://github.com/go-gitea/gitea/pull/30468))\r\n\r\nTherefore, we checked our configurations and ensured, they used trailing slashes:\r\n\r\n```\r\n$ grep -r \"git-staging\" /etc/gitea-staging /etc/tinyproxy/ \r\n/etc/gitea-staging/app.ini:ROOT_URL = https://192.168.1.12/git-staging/\r\n/etc/tinyproxy/tinyproxy.conf:ReversePath \"/git-staging/\" \"http://127.0.0.1:3333/\"\r\n```\r\n\r\nThe logs from our reverse proxy show a behavior as requested by the\r\ndocumentation:\r\n\r\n```\r\nMay 29 16:16:31 debian-git tinyproxy[390434]: Connect (file descriptor 5): 127.0.0.1\r\nMay 29 16:16:31 debian-git tinyproxy[390434]: Request (file descriptor 5): POST /git-staging/user/login HTTP/1.1\r\nMay 29 16:16:31 debian-git tinyproxy[390434]: Rewriting URL: /git-staging/user/login -> http://127.0.0.1:3333/user/login\r\nMay 29 16:16:31 debian-git tinyproxy[390434]: No upstream proxy for 127.0.0.1\r\nMay 29 16:16:31 debian-git tinyproxy[390434]: opensock: opening connection to 127.0.0.1:3333\r\nMay 29 16:16:31 debian-git tinyproxy[390434]: opensock: getaddrinfo returned for 127.0.0.1:3333\r\nMay 29 16:16:31 debian-git tinyproxy[390434]: Established connection to host \"127.0.0.1\" using file descriptor 6.\r\nMay 29 16:16:31 debian-git tinyproxy[390434]: Closed connection between local client (fd:5) and remote client (fd:6)\r\nMay 29 16:16:31 debian-git tinyproxy[390434]: Connect (file descriptor 5): 127.0.0.1\r\nMay 29 16:16:31 debian-git tinyproxy[390434]: Request (file descriptor 5): GET /git-staging/ HTTP/1.1\r\nMay 29 16:16:31 debian-git tinyproxy[390434]: Rewriting URL: /git-staging/ -> http://127.0.0.1:3333/\r\nMay 29 16:16:31 debian-git tinyproxy[390434]: No upstream proxy for 127.0.0.1\r\nMay 29 16:16:31 debian-git tinyproxy[390434]: opensock: opening connection to 127.0.0.1:3333\r\nMay 29 16:16:31 debian-git tinyproxy[390434]: opensock: getaddrinfo returned for 127.0.0.1:3333\r\nMay 29 16:16:31 debian-git tinyproxy[390434]: Established connection to host \"127.0.0.1\" using file descriptor 6.\r\nMay 29 16:16:31 debian-git tinyproxy[390434]: Closed connection between local client (fd:5) and remote client (fd:6)\r\n```\r\n\r\nWe see the equivalent to\r\n\r\n> `Make the reverse-proxy pass https://common.example.com/gitea/foo to http://gitea:3000/foo`\r\n\r\n```\r\nRewriting URL: /git-staging/user/login -> http://127.0.0.1:3333/user/login\r\n```\r\n\r\nThe corresponding Gitea logs are:\r\n\r\n```\r\nMay 29 16:53:07 debian-git gitea[390439]: 2024/05/29 16:53:07 ...eb/routing/logger.go:102:func1() [I] router: completed POST /user/login for 127.0.0.1:56322, 303 See Other in 68.6ms @ auth/auth.go:196(auth.SignInPost)\r\nMay 29 16:53:07 debian-git gitea[390439]: 2024/05/29 16:53:07 .../context_response.go:70:HTML() [D] Template: home\r\nMay 29 16:53:07 debian-git gitea[390439]: 2024/05/29 16:53:07 ...eb/routing/logger.go:102:func1() [I] router: completed GET / for 127.0.0.1:56324, 200 OK in 3.6ms @ web/home.go:32(web.Home)\r\n```\r\n\r\nAccess logs in Gitea:\r\n\r\n```\r\n127.0.0.1 - - [29/May/2024:16:52:57 +0200] \"GET /user/login HTTP/1.1\" 200 10629 \"\" \"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:126.0) Gecko/20100101 Firefox/126.0\"\r\n127.0.0.1 - - [29/May/2024:16:53:00 +0200] \"POST /user/login HTTP/1.1\" 303 0 \"\" \"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:126.0) Gecko/20100101 Firefox/126.0\"\r\n127.0.0.1 - - [29/May/2024:16:53:00 +0200] \"GET / HTTP/1.1\" 200 14214 \"\" \"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:126.0) Gecko/20100101 Firefox/126.0\"\r\n127.0.0.1 - - [29/May/2024:16:53:02 +0200] \"GET /user/login?redirect_to=%2fgit-staging%2f HTTP/1.1\" 200 10629 \"\" \"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:126.0) Gecko/20100101 Firefox/126.0\"\r\n127.0.0.1 - - [29/May/2024:16:53:07 +0200] \"POST /user/login HTTP/1.1\" 303 0 \"\" \"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:126.0) Gecko/20100101 Firefox/126.0\"\r\n127.0.0.1 - - [29/May/2024:16:53:07 +0200] \"GET / HTTP/1.1\" 200 14214 \"\" \"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:126.0) Gecko/20100101 Firefox/126.0\"\r\n```\r\n\r\n### Resolving\r\n\r\nAfter reverting commit b18c04ebde94e23d97da4958173faea843d5344f (and commenting\r\nout two sections undefined afterwards, see patch), we are able to use the normal\r\nlogin again, when using our custom built binary. Thus, this also shows that our\r\nerror is connected to this change.\r\n\n\n### Gitea Version\n\n1.21.11 and 1.22.0\n\n### Can you reproduce the bug on the Gitea demo site?\n\nNo\n\n### Log Gist\n\n_No response_\n\n### Screenshots\n\n_No response_\n\n### Git Version\n\n2.39.2\n\n### Operating System\n\nDebian Bookworm\n\n### How are you running Gitea?\n\nThe binary is pulled from the official server. Execution is happening through systemd on Debian 6.1.85-1 (2024-04-11)  86_64.\r\nThe Gitea server is listening locally via HTTP and is served by a tinyproxy reverse proxy. TLS is terminated by stunnel in front of tinyproxy.\n\n### Database\n\nSQLite","closed_by":{"login":"wxiaoguang","id":2114189,"node_id":"MDQ6VXNlcjIxMTQxODk=","avatar_url":"https://avatars.githubusercontent.com/u/2114189?v=4","gravatar_id":"","url":"https://api.github.com/users/wxiaoguang","html_url":"https://github.com/wxiaoguang","followers_url":"https://api.github.com/users/wxiaoguang/followers","following_url":"https://api.github.com/users/wxiaoguang/following{/other_user}","gists_url":"https://api.github.com/users/wxiaoguang/gists{/gist_id}","starred_url":"https://api.github.com/users/wxiaoguang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wxiaoguang/subscriptions","organizations_url":"https://api.github.com/users/wxiaoguang/orgs","repos_url":"https://api.github.com/users/wxiaoguang/repos","events_url":"https://api.github.com/users/wxiaoguang/events{/privacy}","received_events_url":"https://api.github.com/users/wxiaoguang/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/go-gitea/gitea/issues/31202/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/go-gitea/gitea/issues/31202/timeline","performed_via_github_app":null,"state_reason":"completed"}