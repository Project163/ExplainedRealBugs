{"url":"https://api.github.com/repos/go-gitea/gitea/issues/28144","repository_url":"https://api.github.com/repos/go-gitea/gitea","labels_url":"https://api.github.com/repos/go-gitea/gitea/issues/28144/labels{/name}","comments_url":"https://api.github.com/repos/go-gitea/gitea/issues/28144/comments","events_url":"https://api.github.com/repos/go-gitea/gitea/issues/28144/events","html_url":"https://github.com/go-gitea/gitea/issues/28144","id":2003214869,"node_id":"I_kwDOBFIx2853ZqIV","number":28144,"title":"Template repo files should be cleaned up after an error","user":{"login":"jtran","id":10803,"node_id":"MDQ6VXNlcjEwODAz","avatar_url":"https://avatars.githubusercontent.com/u/10803?v=4","gravatar_id":"","url":"https://api.github.com/users/jtran","html_url":"https://github.com/jtran","followers_url":"https://api.github.com/users/jtran/followers","following_url":"https://api.github.com/users/jtran/following{/other_user}","gists_url":"https://api.github.com/users/jtran/gists{/gist_id}","starred_url":"https://api.github.com/users/jtran/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtran/subscriptions","organizations_url":"https://api.github.com/users/jtran/orgs","repos_url":"https://api.github.com/users/jtran/repos","events_url":"https://api.github.com/users/jtran/events{/privacy}","received_events_url":"https://api.github.com/users/jtran/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":472744938,"node_id":"MDU6TGFiZWw0NzI3NDQ5Mzg=","url":"https://api.github.com/repos/go-gitea/gitea/labels/type/bug","name":"type/bug","color":"ee0701","default":false,"description":""},{"id":474799156,"node_id":"MDU6TGFiZWw0NzQ3OTkxNTY=","url":"https://api.github.com/repos/go-gitea/gitea/labels/issue/critical","name":"issue/critical","color":"fbca04","default":false,"description":"This issue should be fixed ASAP. If it is a PR, the PR should be merged ASAP"}],"state":"closed","locked":true,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/go-gitea/gitea/milestones/178","html_url":"https://github.com/go-gitea/gitea/milestone/178","labels_url":"https://api.github.com/repos/go-gitea/gitea/milestones/178/labels","id":12689621,"node_id":"MI_kwDOBFIx284AwaDV","number":178,"title":"1.23.8","description":"","creator":{"login":"lunny","id":81045,"node_id":"MDQ6VXNlcjgxMDQ1","avatar_url":"https://avatars.githubusercontent.com/u/81045?v=4","gravatar_id":"","url":"https://api.github.com/users/lunny","html_url":"https://github.com/lunny","followers_url":"https://api.github.com/users/lunny/followers","following_url":"https://api.github.com/users/lunny/following{/other_user}","gists_url":"https://api.github.com/users/lunny/gists{/gist_id}","starred_url":"https://api.github.com/users/lunny/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lunny/subscriptions","organizations_url":"https://api.github.com/users/lunny/orgs","repos_url":"https://api.github.com/users/lunny/repos","events_url":"https://api.github.com/users/lunny/events{/privacy}","received_events_url":"https://api.github.com/users/lunny/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":32,"state":"closed","created_at":"2025-04-07T18:31:43Z","updated_at":"2025-05-13T02:11:30Z","due_on":null,"closed_at":"2025-05-12T22:08:10Z"},"comments":2,"created_at":"2023-11-21T00:01:16Z","updated_at":"2025-07-07T10:44:01Z","closed_at":"2025-04-08T05:12:56Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":"resolved","sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Description\r\n\r\nSteps to reproduce:\r\n\r\n1. Create a repo from a template repo\r\n2. Create fails due to some reason (repo-avatar file not found, in my case)\r\n3. 500 error\r\n4. Go back in the browser to the new repository form\r\n5. Try to create an empty repo with the same name and owner (without the problematic template)\r\n\r\nI expected the creation of an empty repo to work for a repo name that isn't used. However, the repo creation fails with an error message:\r\n\r\n> Files already exist for this repository. Contact the system administrator.\r\n\r\nTo fix it, the admin needs to delete the bare git repo from the filesystem using `rm -r`. This makes the repo name available again.\r\n\r\nIn this case, one cause is the original file not found. However, filesystem changes like creating the bare git repo should get reverted in the case of an error, the same way that database changes are reverted using a transaction.\r\n\r\nHere is the database transaction that reverts db changes. As far as I know, there is no equivalent clean-up for the filesystem.\r\n\r\nhttps://github.com/go-gitea/gitea/blob/0c72256ab4e6e6f6c6cd6d4949b37d32a7816785/services/repository/template.go#L74\r\n\r\nContrast this with `CreateRepositoryDirectly()` (not from a repo template), which cleans up.\r\n\r\nhttps://github.com/go-gitea/gitea/blob/0c72256ab4e6e6f6c6cd6d4949b37d32a7816785/services/repository/create.go#L304-L306\r\n\r\nHowever, it's unclear to me that the above code calling `DeleteRepositoryDirectly()` (first introduced in #14384) actually cleans up the files because it first looks for the repo in the database, and if it's not there, returns early. At the point it's being called, the repo _wouldn't_ be in the database because the transaction has been rolled back.\r\n\r\n### Gitea Version\r\n\r\n1.20.5\r\n\r\n### Can you reproduce the bug on the Gitea demo site?\r\n\r\nNo\r\n\r\n### Log Gist\r\n\r\n_No response_\r\n\r\n### Screenshots\r\n\r\n_No response_\r\n\r\n### Git Version\r\n\r\n_No response_\r\n\r\n### Operating System\r\n\r\nLinux\r\n\r\n### How are you running Gitea?\r\n\r\ndocker\r\n\r\n### Database\r\n\r\nPostgreSQL","closed_by":{"login":"lunny","id":81045,"node_id":"MDQ6VXNlcjgxMDQ1","avatar_url":"https://avatars.githubusercontent.com/u/81045?v=4","gravatar_id":"","url":"https://api.github.com/users/lunny","html_url":"https://github.com/lunny","followers_url":"https://api.github.com/users/lunny/followers","following_url":"https://api.github.com/users/lunny/following{/other_user}","gists_url":"https://api.github.com/users/lunny/gists{/gist_id}","starred_url":"https://api.github.com/users/lunny/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lunny/subscriptions","organizations_url":"https://api.github.com/users/lunny/orgs","repos_url":"https://api.github.com/users/lunny/repos","events_url":"https://api.github.com/users/lunny/events{/privacy}","received_events_url":"https://api.github.com/users/lunny/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/go-gitea/gitea/issues/28144/reactions","total_count":4,"+1":4,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/go-gitea/gitea/issues/28144/timeline","performed_via_github_app":null,"state_reason":"completed"}