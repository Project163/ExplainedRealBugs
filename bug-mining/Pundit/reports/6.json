{"url":"https://api.github.com/repos/varvet/pundit/issues/207","repository_url":"https://api.github.com/repos/varvet/pundit","labels_url":"https://api.github.com/repos/varvet/pundit/issues/207/labels{/name}","comments_url":"https://api.github.com/repos/varvet/pundit/issues/207/comments","events_url":"https://api.github.com/repos/varvet/pundit/issues/207/events","html_url":"https://github.com/varvet/pundit/issues/207","id":42293038,"node_id":"MDU6SXNzdWU0MjI5MzAzOA==","number":207,"title":"Ensuring policy_scope is used in controller even if views fetch resources with policy_scope","user":{"login":"valscion","id":482561,"node_id":"MDQ6VXNlcjQ4MjU2MQ==","avatar_url":"https://avatars.githubusercontent.com/u/482561?v=4","gravatar_id":"","url":"https://api.github.com/users/valscion","html_url":"https://github.com/valscion","followers_url":"https://api.github.com/users/valscion/followers","following_url":"https://api.github.com/users/valscion/following{/other_user}","gists_url":"https://api.github.com/users/valscion/gists{/gist_id}","starred_url":"https://api.github.com/users/valscion/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/valscion/subscriptions","organizations_url":"https://api.github.com/users/valscion/orgs","repos_url":"https://api.github.com/users/valscion/repos","events_url":"https://api.github.com/users/valscion/events{/privacy}","received_events_url":"https://api.github.com/users/valscion/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2014-09-09T10:46:26Z","updated_at":"2015-03-30T07:12:27Z","closed_at":"2015-03-30T07:12:27Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hi,\n\nwe're having a pickle with the `verify_policy_scoped` function, used to ensure controllers perform authorization checking even when fetching scopes.\n\nThe problem is that in our application, we need to show users a count of resources of one type where they have access to. To do this, we use `policy_scope(Resource).size` to fetch the size.\n\nBut, alas, there lies the issue. We can no longer rely on `after_action :verify_policy_scoped, only: :index` to catch our leaky index controller actions, because of [`policy_scope` method setting a flag always when called](https://github.com/elabs/pundit/blob/c67d05d082173993d0132b7179f44c202fd9701d/lib/pundit.rb#L81).\n\nWe are a little baffled and would like your opinion on how to move forward and whether this could be remedied with some sort of an improvement to the `policy_scope` method. We thought of:\n1. Adding a new, optional parameter to the `policy_scope` method which stops the `@_pundit_policy_scoped` instance variable from being set\n2. Creating a new method for ensuring the model class which was loaded (say, `Comment`) was resolved with `policy_scope` in `CommentsController` by checking that the controller name matches the model which was loaded\n3. Removing the `after_action :verify_policy_scoped` callback altogether as it brings us false sense of security\n\nWe would really like your opinion on this before moving forward with any solution. If we can come up with a solution that pleases everyone, I believe we'd be able to craft a PR for it.\n\nThanks for the amazing work with Pundit!\n","closed_by":{"login":"jnicklas","id":134,"node_id":"MDQ6VXNlcjEzNA==","avatar_url":"https://avatars.githubusercontent.com/u/134?v=4","gravatar_id":"","url":"https://api.github.com/users/jnicklas","html_url":"https://github.com/jnicklas","followers_url":"https://api.github.com/users/jnicklas/followers","following_url":"https://api.github.com/users/jnicklas/following{/other_user}","gists_url":"https://api.github.com/users/jnicklas/gists{/gist_id}","starred_url":"https://api.github.com/users/jnicklas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jnicklas/subscriptions","organizations_url":"https://api.github.com/users/jnicklas/orgs","repos_url":"https://api.github.com/users/jnicklas/repos","events_url":"https://api.github.com/users/jnicklas/events{/privacy}","received_events_url":"https://api.github.com/users/jnicklas/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/varvet/pundit/issues/207/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/varvet/pundit/issues/207/timeline","performed_via_github_app":null,"state_reason":"completed"}