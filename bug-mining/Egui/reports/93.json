{"url":"https://api.github.com/repos/emilk/egui/issues/5341","repository_url":"https://api.github.com/repos/emilk/egui","labels_url":"https://api.github.com/repos/emilk/egui/issues/5341/labels{/name}","comments_url":"https://api.github.com/repos/emilk/egui/issues/5341/comments","events_url":"https://api.github.com/repos/emilk/egui/issues/5341/events","html_url":"https://github.com/emilk/egui/issues/5341","id":2630434891,"node_id":"I_kwDOCd2s286cyUBL","number":5341,"title":"Some image urls don't load after #5324","user":{"login":"lucasmerlin","id":8009393,"node_id":"MDQ6VXNlcjgwMDkzOTM=","avatar_url":"https://avatars.githubusercontent.com/u/8009393?v=4","gravatar_id":"","url":"https://api.github.com/users/lucasmerlin","html_url":"https://github.com/lucasmerlin","followers_url":"https://api.github.com/users/lucasmerlin/followers","following_url":"https://api.github.com/users/lucasmerlin/following{/other_user}","gists_url":"https://api.github.com/users/lucasmerlin/gists{/gist_id}","starred_url":"https://api.github.com/users/lucasmerlin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lucasmerlin/subscriptions","organizations_url":"https://api.github.com/users/lucasmerlin/orgs","repos_url":"https://api.github.com/users/lucasmerlin/repos","events_url":"https://api.github.com/users/lucasmerlin/events{/privacy}","received_events_url":"https://api.github.com/users/lucasmerlin/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1191600517,"node_id":"MDU6TGFiZWwxMTkxNjAwNTE3","url":"https://api.github.com/repos/emilk/egui/labels/bug","name":"bug","color":"FBCA04","default":true,"description":"Something is broken"},{"id":5404599124,"node_id":"LA_kwDOCd2s288AAAABQiOjVA","url":"https://api.github.com/repos/emilk/egui/labels/egui","name":"egui","color":"fbca04","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/emilk/egui/milestones/7","html_url":"https://github.com/emilk/egui/milestone/7","labels_url":"https://api.github.com/repos/emilk/egui/milestones/7/labels","id":11994819,"node_id":"MI_kwDOCd2s284AtwbD","number":7,"title":"0.30.0 - Modals and other goodies","description":"","creator":{"login":"emilk","id":1148717,"node_id":"MDQ6VXNlcjExNDg3MTc=","avatar_url":"https://avatars.githubusercontent.com/u/1148717?v=4","gravatar_id":"","url":"https://api.github.com/users/emilk","html_url":"https://github.com/emilk","followers_url":"https://api.github.com/users/emilk/followers","following_url":"https://api.github.com/users/emilk/following{/other_user}","gists_url":"https://api.github.com/users/emilk/gists{/gist_id}","starred_url":"https://api.github.com/users/emilk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/emilk/subscriptions","organizations_url":"https://api.github.com/users/emilk/orgs","repos_url":"https://api.github.com/users/emilk/repos","events_url":"https://api.github.com/users/emilk/events{/privacy}","received_events_url":"https://api.github.com/users/emilk/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":2,"state":"closed","created_at":"2024-12-04T15:19:09Z","updated_at":"2024-12-27T13:39:33Z","due_on":"2024-12-19T08:00:00Z","closed_at":"2024-12-27T13:39:33Z"},"comments":4,"created_at":"2024-11-02T12:40:34Z","updated_at":"2024-12-05T06:33:04Z","closed_at":"2024-12-05T06:33:04Z","author_association":"COLLABORATOR","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\n#5324 introduced stricter image uri and mime detection. While this makes sense for e.g. file urls where the extensions are likely correct, I don't think we should check extensions for http urls, as they are not reliable at all. \r\n\r\nSome imaginary cases I can think of where the new checks would break:\r\n- Query params, e.g. to change the image size\r\n  - e.g. http://example.com/myimage.png?width=200\r\n  - also common, presigned s3 urls: https://my-bucket.s3-provider.com/img.webp?X-Amz-Algorithm=AWS4-HMAC-SHA256[...]\r\n- Hash fragments, often used for cache busting\r\n  - e.g. http://example.com/myimage.png#1234 \r\n- Urls that look like they have an an extension but it's not an extension at all\r\n  - e.g. http://example.com/api/user_images?username=lucas.merlin (.merlin would be detected as an extension with our logic)\r\n- Urls that have a wrong extension\r\n  - e.g. http://example.com/render_html_to_image/my_document.html (which would return my_document rendered as an image)\r\n\r\nSome of these cases might be bad api design. If you have full control over the backend that might not be a problem but if you e.g. build a chat app where people can send an image url and the app tries to load the image preview from the external url, you would want to support as many urls as possible. \r\n\r\nWe could try stripping the query params and fragments when checking for the extensions, but I don't think the extra complexity is worth it, considering that this is optimizing the failure case.\r\n\r\n\r\nThe mime check is probably more reliable, but might not always be true. When uploading an image to s3 and you forget to set the mime type, it will have `application/octet-stream`. I believe, when showing such an image in a `<img>` tag, the browser will still show it successfully (but I'm not 100% sure). \r\nSince we already have the image downloaded when checking the mime type, we might as well just get the type via `image::guess_format`.\r\n\r\nAlso, we aren't even using the mime type when loading the image, instead relying on the image crate to guess the format, meaning currently `image` has to guess the type twice (once when we call 'image::guess_type' and once more when we actually decode the image).\r\n\r\nI think we should at least make this behavior configurable, and turn it off by default. \r\n\r\n**To Reproduce**\r\nSteps to reproduce the behavior:\r\n1. Run `cargo run -p egui_demo_app --features image_viewer` from the egui repo on the current master\r\n2. Open the image viewer app\r\n3. Try opening e.g. https://images.pexels.com/photos/45201/kitty-cat-kitten-pet-45201.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2  (copied from here: https://www.pexels.com/photo/white-and-grey-kitten-on-brown-and-black-leopard-print-textile-45201/)\r\n4. Notice how it won't load\r\n\r\n**Expected behavior**\r\nImages should load, no matter the url\r\n\r\n\r\n**Additional context**\r\nrelevant pr: #5324 ","closed_by":{"login":"emilk","id":1148717,"node_id":"MDQ6VXNlcjExNDg3MTc=","avatar_url":"https://avatars.githubusercontent.com/u/1148717?v=4","gravatar_id":"","url":"https://api.github.com/users/emilk","html_url":"https://github.com/emilk","followers_url":"https://api.github.com/users/emilk/followers","following_url":"https://api.github.com/users/emilk/following{/other_user}","gists_url":"https://api.github.com/users/emilk/gists{/gist_id}","starred_url":"https://api.github.com/users/emilk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/emilk/subscriptions","organizations_url":"https://api.github.com/users/emilk/orgs","repos_url":"https://api.github.com/users/emilk/repos","events_url":"https://api.github.com/users/emilk/events{/privacy}","received_events_url":"https://api.github.com/users/emilk/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/emilk/egui/issues/5341/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/emilk/egui/issues/5341/timeline","performed_via_github_app":null,"state_reason":"completed"}