{"url":"https://api.github.com/repos/emilk/egui/issues/5224","repository_url":"https://api.github.com/repos/emilk/egui","labels_url":"https://api.github.com/repos/emilk/egui/issues/5224/labels{/name}","comments_url":"https://api.github.com/repos/emilk/egui/issues/5224/comments","events_url":"https://api.github.com/repos/emilk/egui/issues/5224/events","html_url":"https://github.com/emilk/egui/issues/5224","id":2568592425,"node_id":"I_kwDOCd2s286ZGZwp","number":5224,"title":"eframe with wgpu panics when unloading texture in same frame as rendering it","user":{"login":"Rusty-Cube","id":183405087,"node_id":"U_kgDOCu6KHw","avatar_url":"https://avatars.githubusercontent.com/u/183405087?v=4","gravatar_id":"","url":"https://api.github.com/users/Rusty-Cube","html_url":"https://github.com/Rusty-Cube","followers_url":"https://api.github.com/users/Rusty-Cube/followers","following_url":"https://api.github.com/users/Rusty-Cube/following{/other_user}","gists_url":"https://api.github.com/users/Rusty-Cube/gists{/gist_id}","starred_url":"https://api.github.com/users/Rusty-Cube/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rusty-Cube/subscriptions","organizations_url":"https://api.github.com/users/Rusty-Cube/orgs","repos_url":"https://api.github.com/users/Rusty-Cube/repos","events_url":"https://api.github.com/users/Rusty-Cube/events{/privacy}","received_events_url":"https://api.github.com/users/Rusty-Cube/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1191600517,"node_id":"MDU6TGFiZWwxMTkxNjAwNTE3","url":"https://api.github.com/repos/emilk/egui/labels/bug","name":"bug","color":"FBCA04","default":true,"description":"Something is broken"},{"id":2598730798,"node_id":"MDU6TGFiZWwyNTk4NzMwNzk4","url":"https://api.github.com/repos/emilk/egui/labels/eframe","name":"eframe","color":"0E8A16","default":false,"description":"Relates to epi and eframe"},{"id":4445848959,"node_id":"LA_kwDOCd2s288AAAABCP5Ffw","url":"https://api.github.com/repos/emilk/egui/labels/egui-wgpu","name":"egui-wgpu","color":"0e8a16","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2024-10-06T10:45:42Z","updated_at":"2024-11-13T08:54:41Z","closed_at":"2024-10-06T18:50:11Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\nWhen using eframe with the wgpu renderer the program may panic, if you drop a `TextureHandle` in the same frame as it is used for rendering. The panic happens when `egui_wgpu::winit::Painter::paint_and_update_textures` submits the `wgpu::Queue` in [crates/egui-wgpu/src/winit.rs:688](https://github.com/emilk/egui/blob/0f2b427ff4c0a8c68f6622ec7d0afb7ba7e71bba/crates/egui-wgpu/src/winit.rs#L688). The unloading of the texture happens _before_ that in [line 673](https://github.com/emilk/egui/blob/0f2b427ff4c0a8c68f6622ec7d0afb7ba7e71bba/crates/egui-wgpu/src/winit.rs#L673). I barely understand any of the code in that function, but if I just move the texture unloading to after the queue submitting (e.g. [line 693](https://github.com/emilk/egui/blob/0f2b427ff4c0a8c68f6622ec7d0afb7ba7e71bba/crates/egui-wgpu/src/winit.rs#L693)), my code doesn't crash anymore.\r\nIf this is the correct fix, this means that destroying a texture is not a queued command. I tried to find out about that, but only found:\r\n- The [documentation](https://docs.rs/wgpu/latest/wgpu/struct.Texture.html#method.destroy) of `Texture::destroy`: \"Destroy the associated native resources as soon as possible.\"\r\n- [This issue](https://github.com/gfx-rs/wgpu/issues/964) with associated PR which covers the topic of destroying buffers and textures, and _may_ imply my above assumption.\r\nIf this is not the correct fix, there may be a bug in wgpu itself.\r\n\r\n**To Reproduce**\r\nSteps to reproduce the behavior:\r\n1. Run the following eframe program with the egui-wgpu feature enabled:\r\n```rust\r\nuse eframe::{\r\n    self,\r\n    egui,\r\n};\r\n\r\nstruct MyApp {}\r\n\r\nimpl eframe::App for MyApp {\r\n    fn update(&mut self, context: &egui::Context, _frame: &mut eframe::Frame) {\r\n        // load texture\r\n        let texture = context.load_texture(\"my image\", egui::ColorImage::example(), Default::default());\r\n\r\n        // use texture\r\n        egui::CentralPanel::default().show(context, |ui| {\r\n            ui.image(egui::ImageSource::Texture((&texture).into()));\r\n        });\r\n\r\n        context.request_repaint();\r\n        // texture is destroyed\r\n    }\r\n}\r\n\r\nfn main() -> eframe::Result {\r\n    let native_options = eframe::NativeOptions {\r\n        renderer: eframe::Renderer::Wgpu,\r\n        ..Default::default()\r\n    };\r\n    eframe::run_native(\"My App\", native_options, Box::new(|_| Ok(Box::new(MyApp{}))))\r\n}\r\n```\r\n2. See the panic with the following message:\r\n```\r\nError in Queue::submit: Validation Error\r\n\r\nCaused by:\r\n  Texture with 'egui_texid_Managed(1)' label has been destroyed\r\n```\r\n\r\n**Expected behavior**\r\nThe example picture should be shown in a window and the code should not panic.\r\n\r\n**Additional context**\r\nI encountered this issue in a project in which I want to display the image files in a folder as described in #5200. Since I may not be able to hold all images in memory, I unload them regularly depending on the selection of the user. If I scroll through the images too quickly, the crash occurs.\r\nIn my project the crash happens quite randomly, but with the example program above I can reliably produce a panic on frame 1. I'm not sure if this will work on every machine though.\r\n","closed_by":{"login":"emilk","id":1148717,"node_id":"MDQ6VXNlcjExNDg3MTc=","avatar_url":"https://avatars.githubusercontent.com/u/1148717?v=4","gravatar_id":"","url":"https://api.github.com/users/emilk","html_url":"https://github.com/emilk","followers_url":"https://api.github.com/users/emilk/followers","following_url":"https://api.github.com/users/emilk/following{/other_user}","gists_url":"https://api.github.com/users/emilk/gists{/gist_id}","starred_url":"https://api.github.com/users/emilk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/emilk/subscriptions","organizations_url":"https://api.github.com/users/emilk/orgs","repos_url":"https://api.github.com/users/emilk/repos","events_url":"https://api.github.com/users/emilk/events{/privacy}","received_events_url":"https://api.github.com/users/emilk/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/emilk/egui/issues/5224/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/emilk/egui/issues/5224/timeline","performed_via_github_app":null,"state_reason":"completed"}