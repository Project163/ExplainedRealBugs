{"url":"https://api.github.com/repos/forem/forem/issues/16347","repository_url":"https://api.github.com/repos/forem/forem","labels_url":"https://api.github.com/repos/forem/forem/issues/16347/labels{/name}","comments_url":"https://api.github.com/repos/forem/forem/issues/16347/comments","events_url":"https://api.github.com/repos/forem/forem/issues/16347/events","html_url":"https://github.com/forem/forem/issues/16347","id":1117600803,"node_id":"I_kwDOBGPKJs5CnTwj","number":16347,"title":"Test Ecosystem: Rails.application.routes.default_url_option and URL.domain return inconsistent results","user":{"login":"jeremyf","id":2130,"node_id":"MDQ6VXNlcjIxMzA=","avatar_url":"https://avatars.githubusercontent.com/u/2130?v=4","gravatar_id":"","url":"https://api.github.com/users/jeremyf","html_url":"https://github.com/jeremyf","followers_url":"https://api.github.com/users/jeremyf/followers","following_url":"https://api.github.com/users/jeremyf/following{/other_user}","gists_url":"https://api.github.com/users/jeremyf/gists{/gist_id}","starred_url":"https://api.github.com/users/jeremyf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeremyf/subscriptions","organizations_url":"https://api.github.com/users/jeremyf/orgs","repos_url":"https://api.github.com/users/jeremyf/repos","events_url":"https://api.github.com/users/jeremyf/events{/privacy}","received_events_url":"https://api.github.com/users/jeremyf/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":480869965,"node_id":"MDU6TGFiZWw0ODA4Njk5NjU=","url":"https://api.github.com/repos/forem/forem/labels/bug","name":"bug","color":"E99695","default":true,"description":"always open for contribution"},{"id":1489217418,"node_id":"MDU6TGFiZWwxNDg5MjE3NDE4","url":"https://api.github.com/repos/forem/forem/labels/area:%20tests","name":"area: tests","color":"2a75b2","default":false,"description":"issues related to tests"}],"state":"closed","locked":false,"assignee":{"login":"jeremyf","id":2130,"node_id":"MDQ6VXNlcjIxMzA=","avatar_url":"https://avatars.githubusercontent.com/u/2130?v=4","gravatar_id":"","url":"https://api.github.com/users/jeremyf","html_url":"https://github.com/jeremyf","followers_url":"https://api.github.com/users/jeremyf/followers","following_url":"https://api.github.com/users/jeremyf/following{/other_user}","gists_url":"https://api.github.com/users/jeremyf/gists{/gist_id}","starred_url":"https://api.github.com/users/jeremyf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeremyf/subscriptions","organizations_url":"https://api.github.com/users/jeremyf/orgs","repos_url":"https://api.github.com/users/jeremyf/repos","events_url":"https://api.github.com/users/jeremyf/events{/privacy}","received_events_url":"https://api.github.com/users/jeremyf/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"jeremyf","id":2130,"node_id":"MDQ6VXNlcjIxMzA=","avatar_url":"https://avatars.githubusercontent.com/u/2130?v=4","gravatar_id":"","url":"https://api.github.com/users/jeremyf","html_url":"https://github.com/jeremyf","followers_url":"https://api.github.com/users/jeremyf/followers","following_url":"https://api.github.com/users/jeremyf/following{/other_user}","gists_url":"https://api.github.com/users/jeremyf/gists{/gist_id}","starred_url":"https://api.github.com/users/jeremyf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeremyf/subscriptions","organizations_url":"https://api.github.com/users/jeremyf/orgs","repos_url":"https://api.github.com/users/jeremyf/repos","events_url":"https://api.github.com/users/jeremyf/events{/privacy}","received_events_url":"https://api.github.com/users/jeremyf/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":1,"created_at":"2022-01-28T16:31:52Z","updated_at":"2022-01-31T14:18:13Z","closed_at":"2022-01-31T14:18:13Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\n\r\nIn the development environment we have the following:\r\n\r\n```sh\r\n> Rails.application.routes.default_url_options\r\n=> {:host=>\"localhost:3000\"}\r\n\r\n> URL.domain\r\n=> localhost:3000\r\n```\r\n\r\nIn the test environment, we have a disagreement between the url options:\r\n\r\n```sh\r\n> Rails.application.routes.default_url_options\r\n=> {:host=>\"test.host\"}\r\n\r\n> URL.domain\r\n=> localhost:3000\r\n```\r\n\r\nWhy is this a problem?  When we're coercing URLs via [URL.url](https://github.com/forem/forem/blob/6a69d9bc61aafb3202fe20c2527e46185f81d42a/app/lib/url.rb#L15-L20) we end up with one host.  However if we use things like `Rails.application.routes.url_helpers.root_url` we can get different results from `URL.url(\"/\")`.  This makes testing difficult, especially in regards to \"Do we have a listings\\_path/listings\\_url\" in our database.\r\n\r\n**To Reproduce**\r\n\r\nThe following rails runner for the **test** environment demonstrates the discrepency:\r\n\r\n```sh\r\n❯ bin/rails runner -e test \"puts Rails.application.routes.default_url_options.inspect; puts URL.domain.inspect\"\r\n{:host=>\"test.host\"}\r\n\"localhost:3000\"\r\n```\r\n\r\nWhereas in **development** we have:\r\n\r\n```sh\r\n❯ bin/rails runner -e development \"puts Rails.application.routes.default_url_options.inspect; puts URL.domain.inspect\"\r\n{:host=>\"localhost:3000\"}\r\n\"localhost:3000\"\r\n```\r\n\r\n**Expected behavior**\r\n\r\nI would expect these two ways of getting the host to be in agreement in the test environment.\r\n\r\nRelated to forem/rfcs#291","closed_by":{"login":"jeremyf","id":2130,"node_id":"MDQ6VXNlcjIxMzA=","avatar_url":"https://avatars.githubusercontent.com/u/2130?v=4","gravatar_id":"","url":"https://api.github.com/users/jeremyf","html_url":"https://github.com/jeremyf","followers_url":"https://api.github.com/users/jeremyf/followers","following_url":"https://api.github.com/users/jeremyf/following{/other_user}","gists_url":"https://api.github.com/users/jeremyf/gists{/gist_id}","starred_url":"https://api.github.com/users/jeremyf/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeremyf/subscriptions","organizations_url":"https://api.github.com/users/jeremyf/orgs","repos_url":"https://api.github.com/users/jeremyf/repos","events_url":"https://api.github.com/users/jeremyf/events{/privacy}","received_events_url":"https://api.github.com/users/jeremyf/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/forem/forem/issues/16347/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/forem/forem/issues/16347/timeline","performed_via_github_app":null,"state_reason":"completed"}