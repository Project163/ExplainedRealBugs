{"url":"https://api.github.com/repos/forem/forem/issues/13293","repository_url":"https://api.github.com/repos/forem/forem","labels_url":"https://api.github.com/repos/forem/forem/issues/13293/labels{/name}","comments_url":"https://api.github.com/repos/forem/forem/issues/13293/comments","events_url":"https://api.github.com/repos/forem/forem/issues/13293/events","html_url":"https://github.com/forem/forem/issues/13293","id":852425642,"node_id":"MDU6SXNzdWU4NTI0MjU2NDI=","number":13293,"title":"When creating a new user, the cached 404 api response should be cleared","user":{"login":"djuber","id":1237369,"node_id":"MDQ6VXNlcjEyMzczNjk=","avatar_url":"https://avatars.githubusercontent.com/u/1237369?v=4","gravatar_id":"","url":"https://api.github.com/users/djuber","html_url":"https://github.com/djuber","followers_url":"https://api.github.com/users/djuber/followers","following_url":"https://api.github.com/users/djuber/following{/other_user}","gists_url":"https://api.github.com/users/djuber/gists{/gist_id}","starred_url":"https://api.github.com/users/djuber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/djuber/subscriptions","organizations_url":"https://api.github.com/users/djuber/orgs","repos_url":"https://api.github.com/users/djuber/repos","events_url":"https://api.github.com/users/djuber/events{/privacy}","received_events_url":"https://api.github.com/users/djuber/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1412215719,"node_id":"MDU6TGFiZWwxNDEyMjE1NzE5","url":"https://api.github.com/repos/forem/forem/labels/area:%20API","name":"area: API","color":"2a75b2","default":false,"description":"api or request related issues"},{"id":1494054606,"node_id":"MDU6TGFiZWwxNDk0MDU0NjA2","url":"https://api.github.com/repos/forem/forem/labels/area:%20caching","name":"area: caching","color":"2a75b2","default":false,"description":""}],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2021-04-07T13:44:36Z","updated_at":"2021-04-23T16:50:26Z","closed_at":null,"author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"When requesting users by id using the api [/api/users/:id](https://docs.forem.com/api/#operation/getUser) - and requesting an id greater than the max user id, a 404 is correctly returned.\r\n\r\nWhen requesting the same user id again, a cached 404 is returned.\r\n\r\nAfter the user is created, the 404 still is returned (it could now have been a 200) to the same user (user agent, request, ip), and the x-cache header indicates a hit from one of the CDN layers:\r\n\r\n`X-Cache: MISS, HIT`\r\n\r\nRequests from the same IP and another user agent (like the browser) give a 200 with the correct response.\r\n\r\nIn a local instance (no cdn) the response is a 200 with the json user data (this condition was verified on dev.to and not reproducible on a local server).\r\n\r\n**Expected behavior**\r\n\r\nWhen a user  is created, subsequent requests to /api/users/:id should give a 200, even if a 404 response was given.\r\n\r\n**Screenshots**\r\n\r\n**Additional context**\r\n\r\nReported in a dev.to post where the author was attempting to find the most recent users (ostensibly to welcome them) and using id enumeration to find the maximum valid id. \r\n\r\nThe 404 on the existing and valid user after a few minutes (when the ID had been assigned and the successive ID's did return 200's) was seen as confusing behavior.\r\n\r\nThis problem fixes itself within an hour or so, and the `X-Cache` header for 200 requests always indicate a miss (we're only caching 404 and other error pages)?\r\n\r\nThere is an `Age` header that increments and an `X-Cache-Hits` counter that also increments for the same user. \r\n\r\nI think I'm suggesting `EdgeCache::Bust.call(\"/api/users/#{user.id}\")` be triggered on create but I might not understand what's in play here.","closed_by":{"login":"djuber","id":1237369,"node_id":"MDQ6VXNlcjEyMzczNjk=","avatar_url":"https://avatars.githubusercontent.com/u/1237369?v=4","gravatar_id":"","url":"https://api.github.com/users/djuber","html_url":"https://github.com/djuber","followers_url":"https://api.github.com/users/djuber/followers","following_url":"https://api.github.com/users/djuber/following{/other_user}","gists_url":"https://api.github.com/users/djuber/gists{/gist_id}","starred_url":"https://api.github.com/users/djuber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/djuber/subscriptions","organizations_url":"https://api.github.com/users/djuber/orgs","repos_url":"https://api.github.com/users/djuber/repos","events_url":"https://api.github.com/users/djuber/events{/privacy}","received_events_url":"https://api.github.com/users/djuber/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/forem/forem/issues/13293/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/forem/forem/issues/13293/timeline","performed_via_github_app":null,"state_reason":null}