{"url":"https://api.github.com/repos/forem/forem/issues/16927","repository_url":"https://api.github.com/repos/forem/forem","labels_url":"https://api.github.com/repos/forem/forem/issues/16927/labels{/name}","comments_url":"https://api.github.com/repos/forem/forem/issues/16927/comments","events_url":"https://api.github.com/repos/forem/forem/issues/16927/events","html_url":"https://github.com/forem/forem/issues/16927","id":1174348985,"node_id":"I_kwDOBGPKJs5F_yS5","number":16927,"title":"NoMethodError at `/api/listings`: undefined method `delete' for nil:NilClass","user":{"login":"karvounis","id":9452845,"node_id":"MDQ6VXNlcjk0NTI4NDU=","avatar_url":"https://avatars.githubusercontent.com/u/9452845?v=4","gravatar_id":"","url":"https://api.github.com/users/karvounis","html_url":"https://github.com/karvounis","followers_url":"https://api.github.com/users/karvounis/followers","following_url":"https://api.github.com/users/karvounis/following{/other_user}","gists_url":"https://api.github.com/users/karvounis/gists{/gist_id}","starred_url":"https://api.github.com/users/karvounis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/karvounis/subscriptions","organizations_url":"https://api.github.com/users/karvounis/orgs","repos_url":"https://api.github.com/users/karvounis/repos","events_url":"https://api.github.com/users/karvounis/events{/privacy}","received_events_url":"https://api.github.com/users/karvounis/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":480869965,"node_id":"MDU6TGFiZWw0ODA4Njk5NjU=","url":"https://api.github.com/repos/forem/forem/labels/bug","name":"bug","color":"E99695","default":true,"description":"always open for contribution"},{"id":1412215719,"node_id":"MDU6TGFiZWwxNDEyMjE1NzE5","url":"https://api.github.com/repos/forem/forem/labels/area:%20API","name":"area: API","color":"2a75b2","default":false,"description":"api or request related issues"}],"state":"closed","locked":false,"assignee":{"login":"djuber","id":1237369,"node_id":"MDQ6VXNlcjEyMzczNjk=","avatar_url":"https://avatars.githubusercontent.com/u/1237369?v=4","gravatar_id":"","url":"https://api.github.com/users/djuber","html_url":"https://github.com/djuber","followers_url":"https://api.github.com/users/djuber/followers","following_url":"https://api.github.com/users/djuber/following{/other_user}","gists_url":"https://api.github.com/users/djuber/gists{/gist_id}","starred_url":"https://api.github.com/users/djuber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/djuber/subscriptions","organizations_url":"https://api.github.com/users/djuber/orgs","repos_url":"https://api.github.com/users/djuber/repos","events_url":"https://api.github.com/users/djuber/events{/privacy}","received_events_url":"https://api.github.com/users/djuber/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"djuber","id":1237369,"node_id":"MDQ6VXNlcjEyMzczNjk=","avatar_url":"https://avatars.githubusercontent.com/u/1237369?v=4","gravatar_id":"","url":"https://api.github.com/users/djuber","html_url":"https://github.com/djuber","followers_url":"https://api.github.com/users/djuber/followers","following_url":"https://api.github.com/users/djuber/following{/other_user}","gists_url":"https://api.github.com/users/djuber/gists{/gist_id}","starred_url":"https://api.github.com/users/djuber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/djuber/subscriptions","organizations_url":"https://api.github.com/users/djuber/orgs","repos_url":"https://api.github.com/users/djuber/repos","events_url":"https://api.github.com/users/djuber/events{/privacy}","received_events_url":"https://api.github.com/users/djuber/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":5,"created_at":"2022-03-19T20:27:52Z","updated_at":"2022-03-29T06:51:13Z","closed_at":"2022-03-28T18:40:01Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\n\r\nI am trying to create a new listing through the API following [this guide](https://developers.forem.com/api#operation/createListing). I am running a local Docker installation of Forem, that is listening on `http://localhost:3000`. However, when I am trying to send the example API curl request, I get an error `NoMethodError at /api/listings`.\r\n\r\n**To Reproduce**\r\n\r\n1. Have the `docker-compose` services up and running for Forem.\r\n```\r\n        Name                       Command               State                     Ports                  \r\n----------------------------------------------------------------------------------------------------------\r\nforem_bundle            ./scripts/entrypoint.sh ./ ...   Exit 0                                           \r\nforem_postgresql        docker-entrypoint.sh postgres    Up       0.0.0.0:5432->5432/tcp,:::5432->5432/tcp\r\nforem_postgresql_test   docker-entrypoint.sh postgres    Up       5432/tcp                                \r\nforem_rails             dockerize -wait tcp://db:5 ...   Up       0.0.0.0:3000->3000/tcp,:::3000->3000/tcp\r\nforem_redis             docker-entrypoint.sh redis ...   Up       0.0.0.0:6379->6379/tcp,:::6379->6379/tcp\r\nforem_seed              dockerize -wait tcp://db:5 ...   Exit 0                                           \r\nforem_sidekiq           dockerize -wait tcp://db:5 ...   Up                                               \r\nforem_webpacker         dockerize -wait file:///op ...   Up                                               \r\nforem_yarn              ./scripts/entrypoint.sh ya ...   Exit 0                                           \r\n```\r\n\r\n2. Send the following curl request to the API\r\n\r\n```\r\ncurl  -X POST -H \"Content-Type: application/json\" -H \"api-key: <your_key>\" -d '{\"listing\":{\"title\":\"Title\",\"body_markdown\":\"Body\",\"category\":\"cfp\",\"tags\":[\"python\"]}}' \"http://localhost:3000/api/listings\"\r\n```\r\n\r\n**Expected behavior**\r\n\r\nThe expected behavior would be to successfully create a new listing through the API endpoint `api/listings`.\r\n\r\nThe `API_KEY` I am using is a key I created for the admin Forem user and it has 69 credits. I have successfully managed to create a listing from the browser but not through the API.\r\n\r\n**Desktop (please complete the following information):**\r\n\r\n- OS, version: Ubuntu 20.04.4 LTS (focal) \r\n- API, version: DEV API (beta) (0.9.7)\r\n\r\n**Additional context**\r\n\r\n```\r\n$ curl  -X POST -H \"Content-Type: application/json\" -H \"api-key: ${FOREM_API_KEY}\" -d '{\"listing\":{\"title\":\"Title\",\"body_markdown\":\"Body\",\"category\":\"cfp\",\"tags\":[\"python\"]}}' \"http://localhost:3000/api/listings\"\r\n\r\nNoMethodError at /api/listings\r\n==============================\r\n\r\nundefined method `delete' for nil:NilClass\r\n\r\n> To access an interactive console with this error, point your browser to: /__better_errors\r\n\r\n\r\napp/controllers/concerns/listings_toolkit.rb, line 40\r\n-----------------------------------------------------\r\n\r\n   35       expires_at location organization_id action\r\n   36     ].freeze\r\n   37   \r\n   38     # Filter for a set of known safe params\r\n   39     def listing_params\r\n>  40       tags = params[\"listing\"].delete(\"tags\")\r\n   41       if tags.present?\r\n   42         params[\"listing\"][\"tag_list\"] = tags.join(\", \")\r\n   43       end\r\n   44       params.require(:listing).permit(ALLOWED_PARAMS)\r\n   45     end\r\n\r\nApp backtrace\r\n-------------\r\n\r\n - app/controllers/concerns/listings_toolkit.rb:40:in `listing_params'\r\n - app/controllers/api/v0/listings_controller.rb:100:in `listing_params'\r\n - app/controllers/concerns/listings_toolkit.rb:8:in `create'\r\n\r\nFull backtrace\r\n--------------\r\n\r\n - app/controllers/concerns/listings_toolkit.rb:40:in `listing_params'\r\n - app/controllers/api/v0/listings_controller.rb:100:in `listing_params'\r\n - app/controllers/concerns/listings_toolkit.rb:8:in `create'\r\n - actionpack (6.1.4.6) lib/action_controller/metal/basic_implicit_render.rb:6:in `send_action'\r\n - actionpack (6.1.4.6) lib/abstract_controller/base.rb:228:in `process_action'\r\n - ddtrace (0.54.2) lib/ddtrace/contrib/action_pack/action_controller/instrumentation.rb:127:in `process_action'\r\n - actionpack (6.1.4.6) lib/action_controller/metal/rendering.rb:30:in `process_action'\r\n - actionpack (6.1.4.6) lib/abstract_controller/callbacks.rb:42:in `block in process_action'\r\n - activesupport (6.1.4.6) lib/active_support/callbacks.rb:117:in `block in run_callbacks'\r\n - ahoy_matey (4.0.3) lib/ahoy/controller.rb:45:in `set_ahoy_request_store'\r\n - activesupport (6.1.4.6) lib/active_support/callbacks.rb:126:in `block in run_callbacks'\r\n - activesupport (6.1.4.6) lib/active_support/callbacks.rb:137:in `run_callbacks'\r\n - actionpack (6.1.4.6) lib/abstract_controller/callbacks.rb:41:in `process_action'\r\n - actionpack (6.1.4.6) lib/action_controller/metal/rescue.rb:22:in `process_action'\r\n - actionpack (6.1.4.6) lib/action_controller/metal/instrumentation.rb:34:in `block in process_action'\r\n - activesupport (6.1.4.6) lib/active_support/notifications.rb:203:in `block in instrument'\r\n - activesupport (6.1.4.6) lib/active_support/notifications/instrumenter.rb:24:in `instrument'\r\n - activesupport (6.1.4.6) lib/active_support/notifications.rb:203:in `instrument'\r\n - actionpack (6.1.4.6) lib/action_controller/metal/instrumentation.rb:33:in `process_action'\r\n - actionpack (6.1.4.6) lib/action_controller/metal/params_wrapper.rb:249:in `process_action'\r\n - activerecord (6.1.4.6) lib/active_record/railties/controller_runtime.rb:27:in `process_action'\r\n - actionpack (6.1.4.6) lib/abstract_controller/base.rb:165:in `process'\r\n - actionview (6.1.4.6) lib/action_view/rendering.rb:39:in `process'\r\n - actionpack (6.1.4.6) lib/action_controller/metal.rb:190:in `dispatch'\r\n - actionpack (6.1.4.6) lib/action_controller/metal.rb:254:in `dispatch'\r\n - actionpack (6.1.4.6) lib/action_dispatch/routing/route_set.rb:50:in `dispatch'\r\n - actionpack (6.1.4.6) lib/action_dispatch/routing/route_set.rb:33:in `serve'\r\n - actionpack (6.1.4.6) lib/action_dispatch/routing/mapper.rb:19:in `block in <class:Constraints>'\r\n - actionpack (6.1.4.6) lib/action_dispatch/routing/mapper.rb:49:in `serve'\r\n - actionpack (6.1.4.6) lib/action_dispatch/journey/router.rb:50:in `block in serve'\r\n - actionpack (6.1.4.6) lib/action_dispatch/journey/router.rb:32:in `each'\r\n - actionpack (6.1.4.6) lib/action_dispatch/journey/router.rb:32:in `serve'\r\n - actionpack (6.1.4.6) lib/action_dispatch/routing/route_set.rb:842:in `call'\r\n - omniauth (2.0.4) lib/omniauth/strategy.rb:202:in `call!'\r\n - omniauth (2.0.4) lib/omniauth/strategy.rb:169:in `call'\r\n - omniauth (2.0.4) lib/omniauth/strategy.rb:202:in `call!'\r\n - omniauth (2.0.4) lib/omniauth/strategy.rb:169:in `call'\r\n - omniauth (2.0.4) lib/omniauth/strategy.rb:202:in `call!'\r\n - omniauth (2.0.4) lib/omniauth/strategy.rb:169:in `call'\r\n - omniauth (2.0.4) lib/omniauth/strategy.rb:202:in `call!'\r\n - omniauth (2.0.4) lib/omniauth/strategy.rb:169:in `call'\r\n - omniauth (2.0.4) lib/omniauth/strategy.rb:202:in `call!'\r\n - omniauth (2.0.4) lib/omniauth/strategy.rb:169:in `call'\r\n - omniauth (2.0.4) lib/omniauth/strategy.rb:202:in `call!'\r\n - omniauth (2.0.4) lib/omniauth/strategy.rb:169:in `call'\r\n - bullet (7.0.1) lib/bullet/rack.rb:15:in `call'\r\n - jquery-fileupload-rails (0.4.7) lib/jquery/fileupload/rails/middleware.rb:14:in `_call'\r\n - jquery-fileupload-rails (0.4.7) lib/jquery/fileupload/rails/middleware.rb:10:in `call'\r\n - rack-attack (6.6.0) lib/rack/attack.rb:127:in `call'\r\n - flipper (0.24.0) lib/flipper/middleware/memoizer.rb:77:in `memoized_call'\r\n - flipper (0.24.0) lib/flipper/middleware/memoizer.rb:42:in `call'\r\n - rack (2.2.3) lib/rack/deflater.rb:44:in `call'\r\n - warden (1.2.9) lib/warden/manager.rb:36:in `block in call'\r\n - warden (1.2.9) lib/warden/manager.rb:34:in `catch'\r\n - warden (1.2.9) lib/warden/manager.rb:34:in `call'\r\n - rack (2.2.3) lib/rack/tempfile_reaper.rb:15:in `call'\r\n - rack (2.2.3) lib/rack/etag.rb:27:in `call'\r\n - rack (2.2.3) lib/rack/conditional_get.rb:40:in `call'\r\n - rack (2.2.3) lib/rack/head.rb:12:in `call'\r\n - actionpack (6.1.4.6) lib/action_dispatch/http/permissions_policy.rb:22:in `call'\r\n - actionpack (6.1.4.6) lib/action_dispatch/http/content_security_policy.rb:18:in `call'\r\n - rack (2.2.3) lib/rack/session/abstract/id.rb:266:in `context'\r\n - rack (2.2.3) lib/rack/session/abstract/id.rb:260:in `call'\r\n - actionpack (6.1.4.6) lib/action_dispatch/middleware/cookies.rb:689:in `call'\r\n - activerecord (6.1.4.6) lib/active_record/migration.rb:601:in `call'\r\n - actionpack (6.1.4.6) lib/action_dispatch/middleware/callbacks.rb:27:in `block in call'\r\n - activesupport (6.1.4.6) lib/active_support/callbacks.rb:98:in `run_callbacks'\r\n - actionpack (6.1.4.6) lib/action_dispatch/middleware/callbacks.rb:26:in `call'\r\n - actionpack (6.1.4.6) lib/action_dispatch/middleware/executor.rb:14:in `call'\r\n - actionpack (6.1.4.6) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'\r\n - ddtrace (0.54.2) lib/ddtrace/contrib/rails/middlewares.rb:18:in `call'\r\n - better_errors (2.9.1) lib/better_errors/middleware.rb:87:in `protected_app_call'\r\n - better_errors (2.9.1) lib/better_errors/middleware.rb:82:in `better_errors_call'\r\n - better_errors (2.9.1) lib/better_errors/middleware.rb:60:in `call'\r\n - actionpack (6.1.4.6) lib/action_dispatch/middleware/debug_exceptions.rb:29:in `call'\r\n - web-console (4.2.0) lib/web_console/middleware.rb:132:in `call_app'\r\n - web-console (4.2.0) lib/web_console/middleware.rb:28:in `block in call'\r\n - web-console (4.2.0) lib/web_console/middleware.rb:17:in `catch'\r\n - web-console (4.2.0) lib/web_console/middleware.rb:17:in `call'\r\n - honeycomb-beeline (2.8.2) lib/honeycomb/integrations/rack.rb:79:in `call_with_hook'\r\n - honeycomb-beeline (2.8.2) lib/honeycomb/integrations/rails.rb:94:in `call_with_hook'\r\n - honeycomb-beeline (2.8.2) lib/honeycomb/integrations/rack.rb:52:in `block in call'\r\n - honeycomb-beeline (2.8.2) lib/honeycomb/client.rb:62:in `start_span'\r\n - honeycomb-beeline (2.8.2) lib/honeycomb/integrations/rack.rb:36:in `call'\r\n - actionpack (6.1.4.6) lib/action_dispatch/middleware/show_exceptions.rb:33:in `call'\r\n - railties (6.1.4.6) lib/rails/rack/logger.rb:37:in `call_app'\r\n - railties (6.1.4.6) lib/rails/rack/logger.rb:26:in `block in call'\r\n - activesupport (6.1.4.6) lib/active_support/tagged_logging.rb:99:in `block in tagged'\r\n - activesupport (6.1.4.6) lib/active_support/tagged_logging.rb:37:in `tagged'\r\n - activesupport (6.1.4.6) lib/active_support/tagged_logging.rb:99:in `tagged'\r\n - railties (6.1.4.6) lib/rails/rack/logger.rb:26:in `call'\r\n - ahoy_matey (4.0.3) lib/ahoy/engine.rb:22:in `call_with_quiet_ahoy'\r\n - sprockets-rails (3.4.2) lib/sprockets/rails/quiet_assets.rb:13:in `call'\r\n - actionpack (6.1.4.6) lib/action_dispatch/middleware/remote_ip.rb:81:in `call'\r\n - rack-timeout (0.6.0) lib/rack/timeout/core.rb:151:in `block in call'\r\n - rack-timeout (0.6.0) lib/rack/timeout/support/timeout.rb:19:in `timeout'\r\n - rack-timeout (0.6.0) lib/rack/timeout/core.rb:150:in `call'\r\n - request_store (1.5.1) lib/request_store/middleware.rb:19:in `call'\r\n - actionpack (6.1.4.6) lib/action_dispatch/middleware/request_id.rb:26:in `call'\r\n - rack (2.2.3) lib/rack/method_override.rb:24:in `call'\r\n - rack (2.2.3) lib/rack/runtime.rb:22:in `call'\r\n - activesupport (6.1.4.6) lib/active_support/cache/strategy/local_cache_middleware.rb:29:in `call'\r\n - actionpack (6.1.4.6) lib/action_dispatch/middleware/executor.rb:14:in `call'\r\n - actionpack (6.1.4.6) lib/action_dispatch/middleware/static.rb:24:in `call'\r\n - rack (2.2.3) lib/rack/sendfile.rb:110:in `call'\r\n - actionpack (6.1.4.6) lib/action_dispatch/middleware/host_authorization.rb:119:in `call'\r\n - rack-cors (1.1.1) lib/rack/cors.rb:100:in `call'\r\n - ddtrace (0.54.2) lib/ddtrace/contrib/rack/middlewares.rb:88:in `call'\r\n - honeybadger (4.11.0) lib/honeybadger/rack/error_notifier.rb:33:in `block in call'\r\n - honeybadger (4.11.0) lib/honeybadger/agent.rb:426:in `with_rack_env'\r\n - honeybadger (4.11.0) lib/honeybadger/rack/error_notifier.rb:30:in `call'\r\n - honeybadger (4.11.0) lib/honeybadger/rack/user_feedback.rb:31:in `call'\r\n - honeybadger (4.11.0) lib/honeybadger/rack/user_informer.rb:21:in `call'\r\n - webpacker (5.4.3) lib/webpacker/dev_server_proxy.rb:25:in `perform_request'\r\n - rack-proxy (0.7.0) lib/rack/proxy.rb:63:in `call'\r\n - railties (6.1.4.6) lib/rails/engine.rb:539:in `call'\r\n - puma (5.6.2) lib/puma/configuration.rb:252:in `call'\r\n - puma (5.6.2) lib/puma/request.rb:77:in `block in handle_request'\r\n - puma (5.6.2) lib/puma/thread_pool.rb:340:in `with_force_shutdown'\r\n - puma (5.6.2) lib/puma/request.rb:76:in `handle_request'\r\n - puma (5.6.2) lib/puma/server.rb:441:in `process_client'\r\n - puma (5.6.2) lib/puma/thread_pool.rb:147:in `block in spawn_thread'\r\n```\r\n\r\n\r\nLogs from the `rails` service:\r\n\r\n```\r\nrails_1      | Started POST \"/api/listings\" for 172.23.0.1 at 2022-03-19 20:14:57 +0000\r\nrails_1      |    (0.8ms)  SELECT \"flipper_features\".\"key\" AS feature_key, \"flipper_gates\".\"key\", \"flipper_gates\".\"value\" FROM \"flipper_features\" LEFT OUTER JOIN \"flipper_gates\" ON \"flipper_features\".\"key\" = \"flipper_gates\".\"feature_key\"\r\nrails_1      | Processing by Api::V0::ListingsController#create as JSON\r\nrails_1      |   Parameters: {\"listing\"=>{\"title\"=>\"Title\", \"body_markdown\"=>\"Body\", \"category\"=>\"cfp\", \"action\"=>\"draft\"}, \"locale\"=>nil}\r\nrails_1      |   ApiSecret Load (0.6ms)  SELECT \"api_secrets\".* FROM \"api_secrets\" WHERE \"api_secrets\".\"secret\" = $1 LIMIT $2  [[\"secret\", \"LG8JJHEuA56FdPZhNBSv8ng6\"], [\"LIMIT\", 1]]\r\nrails_1      |   ↳ app/controllers/api/v0/api_controller.rb:102:in `authenticate_with_api_key'\r\nrails_1      |   User Load (0.7ms)  SELECT \"users\".* FROM \"users\" WHERE \"users\".\"id\" = $1  [[\"id\", 11]]\r\nrails_1      |   ↳ app/controllers/api/v0/api_controller.rb:102:in `authenticate_with_api_key'\r\nrails_1      | Completed 500 Internal Server Error in 11ms (ActiveRecord: 1.3ms | Allocations: 4056)\r\nrails_1      | \r\nrails_1      | \r\nrails_1      | \r\nrails_1      | NoMethodError - undefined method `delete' for nil:NilClass:\r\nrails_1      |   app/controllers/concerns/listings_toolkit.rb:40:in `listing_params'\r\nrails_1      |   app/controllers/api/v0/listings_controller.rb:100:in `listing_params'\r\nrails_1      |   app/controllers/concerns/listings_toolkit.rb:8:in `create'\r\n```","closed_by":{"login":"djuber","id":1237369,"node_id":"MDQ6VXNlcjEyMzczNjk=","avatar_url":"https://avatars.githubusercontent.com/u/1237369?v=4","gravatar_id":"","url":"https://api.github.com/users/djuber","html_url":"https://github.com/djuber","followers_url":"https://api.github.com/users/djuber/followers","following_url":"https://api.github.com/users/djuber/following{/other_user}","gists_url":"https://api.github.com/users/djuber/gists{/gist_id}","starred_url":"https://api.github.com/users/djuber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/djuber/subscriptions","organizations_url":"https://api.github.com/users/djuber/orgs","repos_url":"https://api.github.com/users/djuber/repos","events_url":"https://api.github.com/users/djuber/events{/privacy}","received_events_url":"https://api.github.com/users/djuber/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/forem/forem/issues/16927/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/forem/forem/issues/16927/timeline","performed_via_github_app":null,"state_reason":"completed"}