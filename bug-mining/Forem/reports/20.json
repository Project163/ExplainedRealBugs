{"url":"https://api.github.com/repos/forem/forem/issues/16059","repository_url":"https://api.github.com/repos/forem/forem","labels_url":"https://api.github.com/repos/forem/forem/issues/16059/labels{/name}","comments_url":"https://api.github.com/repos/forem/forem/issues/16059/comments","events_url":"https://api.github.com/repos/forem/forem/issues/16059/events","html_url":"https://github.com/forem/forem/issues/16059","id":1099487187,"node_id":"I_kwDOBGPKJs5BiNfT","number":16059,"title":"users aren't getting onboarding broadcast messages","user":{"login":"djuber","id":1237369,"node_id":"MDQ6VXNlcjEyMzczNjk=","avatar_url":"https://avatars.githubusercontent.com/u/1237369?v=4","gravatar_id":"","url":"https://api.github.com/users/djuber","html_url":"https://github.com/djuber","followers_url":"https://api.github.com/users/djuber/followers","following_url":"https://api.github.com/users/djuber/following{/other_user}","gists_url":"https://api.github.com/users/djuber/gists{/gist_id}","starred_url":"https://api.github.com/users/djuber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/djuber/subscriptions","organizations_url":"https://api.github.com/users/djuber/orgs","repos_url":"https://api.github.com/users/djuber/repos","events_url":"https://api.github.com/users/djuber/events{/privacy}","received_events_url":"https://api.github.com/users/djuber/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"djuber","id":1237369,"node_id":"MDQ6VXNlcjEyMzczNjk=","avatar_url":"https://avatars.githubusercontent.com/u/1237369?v=4","gravatar_id":"","url":"https://api.github.com/users/djuber","html_url":"https://github.com/djuber","followers_url":"https://api.github.com/users/djuber/followers","following_url":"https://api.github.com/users/djuber/following{/other_user}","gists_url":"https://api.github.com/users/djuber/gists{/gist_id}","starred_url":"https://api.github.com/users/djuber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/djuber/subscriptions","organizations_url":"https://api.github.com/users/djuber/orgs","repos_url":"https://api.github.com/users/djuber/repos","events_url":"https://api.github.com/users/djuber/events{/privacy}","received_events_url":"https://api.github.com/users/djuber/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"djuber","id":1237369,"node_id":"MDQ6VXNlcjEyMzczNjk=","avatar_url":"https://avatars.githubusercontent.com/u/1237369?v=4","gravatar_id":"","url":"https://api.github.com/users/djuber","html_url":"https://github.com/djuber","followers_url":"https://api.github.com/users/djuber/followers","following_url":"https://api.github.com/users/djuber/following{/other_user}","gists_url":"https://api.github.com/users/djuber/gists{/gist_id}","starred_url":"https://api.github.com/users/djuber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/djuber/subscriptions","organizations_url":"https://api.github.com/users/djuber/orgs","repos_url":"https://api.github.com/users/djuber/repos","events_url":"https://api.github.com/users/djuber/events{/privacy}","received_events_url":"https://api.github.com/users/djuber/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":1,"created_at":"2022-01-11T18:21:14Z","updated_at":"2022-01-11T20:34:19Z","closed_at":"2022-01-11T20:34:19Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"\r\n**Describe the bug**\r\n\r\nWe expect to send a sequence of welcome notifications to users during the first week after signup. This is failing after the initial follow up (participate in the welcome thread), and related to an error raised when checking for authentication providers.\r\n\r\nThe Broadcasts::WelcomeNotification::Generator checks to see which authentication methods a user has not enabled, and suggests the first one as an option.\r\n\r\nFor most users on DEV, this will be to sign in with an Apple id.\r\n\r\nHowever, there's no Broadcast created with this title \"Welcome Notification: apple_connect\", and the generator raises a (captured) error about the record not being found, then stops, preventing both the authentication message, and all further messages from being sent.\r\n\r\n**To Reproduce**\r\n\r\nSet a user's created_at to 3.days.ago.\r\nEnsure the user does not have apple identity configured, and that apple is an enabled identity provider.\r\nDestroy all notifications (or all notifications for this user, or all notifications of type broadcast for this user)\r\n\r\nCall Broadcasts::WelcomeNotification::Generator.call(user.id)\r\n\r\nObserve that a notification is created for welcome_thread (as a sidekiq job)\r\n\r\nCall the generator on this user again\r\n\r\nObserve that no job is enqueued, no new notification is created. The last query was to load the (missing) apple_connect broadcast:\r\n\r\n```\r\n  Broadcast Load (0.3ms)  SELECT \"broadcasts\".* FROM \"broadcasts\" WHERE \"broadcasts\".\"active\" = $1 AND \"broadcasts\".\"title\" = $2 LIMIT $3  [[\"active\", true], [\"title\", \"Welcome Notification: apple_connect\"], [\"LIMIT\", 1]]\r\n```\r\n\r\n**Expected behavior**\r\n\r\nAn auth notification is sent, and on subsequent days the remaining messages are sent (customize feed, customize experience, ask questions). \r\n\r\n**Screenshots**\r\n\r\n**Additional context**\r\n\r\nThe solution to this issue likely involves both an update script to create the missing Broadcast message, as well as a modification to the way the error handling is performed in Generator#call (when any step in the flow raises an error, the process for this user is halted, and since each day the checks run in order, the next day the same error will be raised).\r\n\r\nIdeally, an individual step raising an error would not block subsequent steps. Creating the message resolves the most common failure location.\r\n\r\n","closed_by":{"login":"djuber","id":1237369,"node_id":"MDQ6VXNlcjEyMzczNjk=","avatar_url":"https://avatars.githubusercontent.com/u/1237369?v=4","gravatar_id":"","url":"https://api.github.com/users/djuber","html_url":"https://github.com/djuber","followers_url":"https://api.github.com/users/djuber/followers","following_url":"https://api.github.com/users/djuber/following{/other_user}","gists_url":"https://api.github.com/users/djuber/gists{/gist_id}","starred_url":"https://api.github.com/users/djuber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/djuber/subscriptions","organizations_url":"https://api.github.com/users/djuber/orgs","repos_url":"https://api.github.com/users/djuber/repos","events_url":"https://api.github.com/users/djuber/events{/privacy}","received_events_url":"https://api.github.com/users/djuber/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/forem/forem/issues/16059/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/forem/forem/issues/16059/timeline","performed_via_github_app":null,"state_reason":"completed"}