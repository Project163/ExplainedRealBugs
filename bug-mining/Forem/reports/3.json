{"url":"https://api.github.com/repos/forem/forem/issues/13006","repository_url":"https://api.github.com/repos/forem/forem","labels_url":"https://api.github.com/repos/forem/forem/issues/13006/labels{/name}","comments_url":"https://api.github.com/repos/forem/forem/issues/13006/comments","events_url":"https://api.github.com/repos/forem/forem/issues/13006/events","html_url":"https://github.com/forem/forem/issues/13006","id":832993517,"node_id":"MDU6SXNzdWU4MzI5OTM1MTc=","number":13006,"title":"User#trusted memoization should be boolean aware","user":{"login":"djuber","id":1237369,"node_id":"MDQ6VXNlcjEyMzczNjk=","avatar_url":"https://avatars.githubusercontent.com/u/1237369?v=4","gravatar_id":"","url":"https://api.github.com/users/djuber","html_url":"https://github.com/djuber","followers_url":"https://api.github.com/users/djuber/followers","following_url":"https://api.github.com/users/djuber/following{/other_user}","gists_url":"https://api.github.com/users/djuber/gists{/gist_id}","starred_url":"https://api.github.com/users/djuber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/djuber/subscriptions","organizations_url":"https://api.github.com/users/djuber/orgs","repos_url":"https://api.github.com/users/djuber/repos","events_url":"https://api.github.com/users/djuber/events{/privacy}","received_events_url":"https://api.github.com/users/djuber/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1901676140,"node_id":"MDU6TGFiZWwxOTAxNjc2MTQw","url":"https://api.github.com/repos/forem/forem/labels/internal%20team%20only","name":"internal team only","color":"D4C5F9","default":false,"description":"internal tasks only for Forem team members"}],"state":"closed","locked":false,"assignee":{"login":"djuber","id":1237369,"node_id":"MDQ6VXNlcjEyMzczNjk=","avatar_url":"https://avatars.githubusercontent.com/u/1237369?v=4","gravatar_id":"","url":"https://api.github.com/users/djuber","html_url":"https://github.com/djuber","followers_url":"https://api.github.com/users/djuber/followers","following_url":"https://api.github.com/users/djuber/following{/other_user}","gists_url":"https://api.github.com/users/djuber/gists{/gist_id}","starred_url":"https://api.github.com/users/djuber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/djuber/subscriptions","organizations_url":"https://api.github.com/users/djuber/orgs","repos_url":"https://api.github.com/users/djuber/repos","events_url":"https://api.github.com/users/djuber/events{/privacy}","received_events_url":"https://api.github.com/users/djuber/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"djuber","id":1237369,"node_id":"MDQ6VXNlcjEyMzczNjk=","avatar_url":"https://avatars.githubusercontent.com/u/1237369?v=4","gravatar_id":"","url":"https://api.github.com/users/djuber","html_url":"https://github.com/djuber","followers_url":"https://api.github.com/users/djuber/followers","following_url":"https://api.github.com/users/djuber/following{/other_user}","gists_url":"https://api.github.com/users/djuber/gists{/gist_id}","starred_url":"https://api.github.com/users/djuber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/djuber/subscriptions","organizations_url":"https://api.github.com/users/djuber/orgs","repos_url":"https://api.github.com/users/djuber/repos","events_url":"https://api.github.com/users/djuber/events{/privacy}","received_events_url":"https://api.github.com/users/djuber/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":1,"created_at":"2021-03-16T16:33:30Z","updated_at":"2021-03-16T23:58:57Z","closed_at":"2021-03-16T23:58:57Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\n\r\nWhen checking if a `User` is trusted, we use instance variable memoization, however the two values we expect are true and false, and for false values we always refetch (defeating the cache). To put it another way, we always remember if a user is trusted, but never remember that they're not.\r\n\r\n**To Reproduce**\r\n\r\nConfirming there's no cache used,  caching when user _is_ trusted\r\n\r\n```\r\n[10] pry(main)> u = User.first\r\n[11] pry(main)> u.trusted\r\n  Role Load (1.7ms)  SELECT \"roles\".* FROM \"roles\" INNER JOIN \"users_roles\" ON \"roles\".\"id\" = \"users_roles\".\"role_id\" WHERE \"users_roles\".\"user_id\" = $1 AND (((roles.name = 'trusted') AND (roles.resource_type IS NULL) AND (roles.resource_id IS NULL)))  [[\"user_id\", 1]]\r\n=> true\r\n[12] pry(main)> u.trusted\r\n=> true                  \r\n[13] pry(main)> u.trusted\r\n=> true                  \r\n[14] pry(main)> u.trusted\r\n=> true                  \r\n[15] pry(main)> u.trusted\r\n=> true                  \r\n[16] pry(main)> u.trusted\r\n=> true                 \r\n\r\n[17] pry(main)> u = User.second\r\n[18] pry(main)> u.trusted  Role Load (1.7ms)  SELECT \"roles\".* FROM \"roles\" INNER JOIN \"users_roles\" ON \"roles\".\"id\" = \"users_roles\".\"role_id\" WHERE \"users_roles\".\"user_id\" = $1 AND (((roles.name = 'trusted') AND (roles.resource_type IS NULL) AND (roles.resource_id IS NULL)))  [[\"user_id\", 2]]\r\n=> false\r\n[19] pry(main)> u.trusted\r\n  Role Load (1.8ms)  SELECT \"roles\".* FROM \"roles\" INNER JOIN \"users_roles\" ON \"roles\".\"id\" = \"users_roles\".\"role_id\" WHERE \"users_roles\".\"user_id\" = $1 AND (((roles.name = 'trusted') AND (roles.resource_type IS NULL) AND (roles.resource_id IS NULL)))  [[\"user_id\", 2]]\r\n=> false\r\n[20] pry(main)> u.trusted\r\n  Role Load (1.7ms)  SELECT \"roles\".* FROM \"roles\" INNER JOIN \"users_roles\" ON \"roles\".\"id\" = \"users_roles\".\"role_id\" WHERE \"users_roles\".\"user_id\" = $1 AND (((roles.name = 'trusted') AND (roles.resource_type IS NULL) AND (roles.resource_id IS NULL)))  [[\"user_id\", 2]]\r\n=> false\r\n```\r\n\r\nif memoization worked as intended we would not be seeing Role Load logging locally, and would just return false immediately.\r\n\r\n\r\n**Expected behavior**\r\n\r\nOnly check remote cache, or the database for the role, if the instance variable is not defined (or nil)\r\n\r\n**Additional context**\r\n\r\nNoticed this benchmarking Article scoring and seeing the black box spaminess checks.","closed_by":{"login":"djuber","id":1237369,"node_id":"MDQ6VXNlcjEyMzczNjk=","avatar_url":"https://avatars.githubusercontent.com/u/1237369?v=4","gravatar_id":"","url":"https://api.github.com/users/djuber","html_url":"https://github.com/djuber","followers_url":"https://api.github.com/users/djuber/followers","following_url":"https://api.github.com/users/djuber/following{/other_user}","gists_url":"https://api.github.com/users/djuber/gists{/gist_id}","starred_url":"https://api.github.com/users/djuber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/djuber/subscriptions","organizations_url":"https://api.github.com/users/djuber/orgs","repos_url":"https://api.github.com/users/djuber/repos","events_url":"https://api.github.com/users/djuber/events{/privacy}","received_events_url":"https://api.github.com/users/djuber/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/forem/forem/issues/13006/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/forem/forem/issues/13006/timeline","performed_via_github_app":null,"state_reason":"completed"}