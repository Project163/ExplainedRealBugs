{"url":"https://api.github.com/repos/forem/forem/issues/13008","repository_url":"https://api.github.com/repos/forem/forem","labels_url":"https://api.github.com/repos/forem/forem/issues/13008/labels{/name}","comments_url":"https://api.github.com/repos/forem/forem/issues/13008/comments","events_url":"https://api.github.com/repos/forem/forem/issues/13008/events","html_url":"https://github.com/forem/forem/issues/13008","id":833015092,"node_id":"MDU6SXNzdWU4MzMwMTUwOTI=","number":13008,"title":"Scoring articles sends the current score, not the new score, to the blackbox","user":{"login":"djuber","id":1237369,"node_id":"MDQ6VXNlcjEyMzczNjk=","avatar_url":"https://avatars.githubusercontent.com/u/1237369?v=4","gravatar_id":"","url":"https://api.github.com/users/djuber","html_url":"https://github.com/djuber","followers_url":"https://api.github.com/users/djuber/followers","following_url":"https://api.github.com/users/djuber/following{/other_user}","gists_url":"https://api.github.com/users/djuber/gists{/gist_id}","starred_url":"https://api.github.com/users/djuber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/djuber/subscriptions","organizations_url":"https://api.github.com/users/djuber/orgs","repos_url":"https://api.github.com/users/djuber/repos","events_url":"https://api.github.com/users/djuber/events{/privacy}","received_events_url":"https://api.github.com/users/djuber/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":1901676140,"node_id":"MDU6TGFiZWwxOTAxNjc2MTQw","url":"https://api.github.com/repos/forem/forem/labels/internal%20team%20only","name":"internal team only","color":"D4C5F9","default":false,"description":"internal tasks only for Forem team members"}],"state":"closed","locked":false,"assignee":{"login":"djuber","id":1237369,"node_id":"MDQ6VXNlcjEyMzczNjk=","avatar_url":"https://avatars.githubusercontent.com/u/1237369?v=4","gravatar_id":"","url":"https://api.github.com/users/djuber","html_url":"https://github.com/djuber","followers_url":"https://api.github.com/users/djuber/followers","following_url":"https://api.github.com/users/djuber/following{/other_user}","gists_url":"https://api.github.com/users/djuber/gists{/gist_id}","starred_url":"https://api.github.com/users/djuber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/djuber/subscriptions","organizations_url":"https://api.github.com/users/djuber/orgs","repos_url":"https://api.github.com/users/djuber/repos","events_url":"https://api.github.com/users/djuber/events{/privacy}","received_events_url":"https://api.github.com/users/djuber/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"djuber","id":1237369,"node_id":"MDQ6VXNlcjEyMzczNjk=","avatar_url":"https://avatars.githubusercontent.com/u/1237369?v=4","gravatar_id":"","url":"https://api.github.com/users/djuber","html_url":"https://github.com/djuber","followers_url":"https://api.github.com/users/djuber/followers","following_url":"https://api.github.com/users/djuber/following{/other_user}","gists_url":"https://api.github.com/users/djuber/gists{/gist_id}","starred_url":"https://api.github.com/users/djuber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/djuber/subscriptions","organizations_url":"https://api.github.com/users/djuber/orgs","repos_url":"https://api.github.com/users/djuber/repos","events_url":"https://api.github.com/users/djuber/events{/privacy}","received_events_url":"https://api.github.com/users/djuber/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":1,"created_at":"2021-03-16T16:58:26Z","updated_at":"2021-03-18T19:20:28Z","closed_at":"2021-03-18T19:20:28Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\nWhen updating the score for an article, we calculate the new score for the article, and pass it to the BlackBox to calculate hotness and spaminess, however this `self` doesn't have the newly computed score set so the hotness and spaminess are using less than current information.\r\n\r\n**To Reproduce**\r\n\r\nI'll get a test case in place for this - but the key point is when changing the articles score (via a reaction, for example) the BlackBox calculation should include the new score.\r\n\r\nTo demonstrate this to myself (and make certain update_columns wasn't doing anything magical) I added the following locally\r\n\r\n```\r\nArticle.first.update_score\r\nUPDATE \"articles\" SET \"score\" = $1, \"comment_score\" = $2, \"hotness_score\" = $3, \"spaminess_rating\" = $4 WHERE \"articles\".\"id\" = $5  [[\"score\", 0], [\"comment_score\", 0], [\"hotness_score\", 353163], [\"spaminess_rating\", 0], [\"id\", 1]]\r\n=> true\r\n\r\nclass Article\r\n  def minimal_score_change(newscore)\r\n    update_columns(score: newscore, hotness_score: BlackBox.article_hotness_score(self))\r\n  end  \r\nend    \r\n=> :minimal_score_change\r\n\r\nArticle.first.minimal_score_change(100)  Article Load (1.9ms)  SELECT \"articles\".* FROM \"articles\" ORDER BY \"articles\".\"id\" ASC LIMIT $1  [[\"LIMIT\", 1]]  \r\n  Article Update (47.1ms)  UPDATE \"articles\" SET \"score\" = $1, \"hotness_score\" = $2 WHERE \"articles\".\"id\" = $3  [[\"score\", 100], [\"hotness_score\", 353163], [\"id\", 1]]\r\n=> true\r\n\r\nArticle.first.minimal_score_change(100)\r\n  Article Load (1.9ms)  SELECT \"articles\".* FROM \"articles\" ORDER BY \"articles\".\"id\" ASC LIMIT $1  [[\"LIMIT\", 1]]  \r\n  Article Update (47.3ms)  UPDATE \"articles\" SET \"score\" = $1, \"hotness_score\" = $2 WHERE \"articles\".\"id\" = $3  [[\"score\", 100], [\"hotness_score\", 353413], [\"id\", 1]]\r\n=> true\r\n\r\nArticle.first.minimal_score_change(100)\r\n  Article Load (2.0ms)  SELECT \"articles\".* FROM \"articles\" ORDER BY \"articles\".\"id\" ASC LIMIT $1  [[\"LIMIT\", 1]]  \r\n  Article Update (42.2ms)  UPDATE \"articles\" SET \"score\" = $1, \"hotness_score\" = $2 WHERE \"articles\".\"id\" = $3  [[\"score\", 100], [\"hotness_score\", 353413], [\"id\", 1]]\r\n=> true\r\n```\r\n\r\nIt's observable that passing the article as it existed before the update to the blackbox gives one calculation, calling it a second time gives a second (presumably correct) value including the score information. I expect to always see hotness as 353413, but the first time  (when the article score was still 0) I get 353163 instead. \r\n\r\n\r\n**Expected behavior**\r\n\r\nBlackBox should get the new score, subsequent calls to update_score with no scoring input changes should set the same values for spaminess and hotness. Put another way, the update_score calculation should be memoryless.\r\n\r\n\r\n**Additional context**\r\n\r\nNoticed when testing article scoring.","closed_by":{"login":"djuber","id":1237369,"node_id":"MDQ6VXNlcjEyMzczNjk=","avatar_url":"https://avatars.githubusercontent.com/u/1237369?v=4","gravatar_id":"","url":"https://api.github.com/users/djuber","html_url":"https://github.com/djuber","followers_url":"https://api.github.com/users/djuber/followers","following_url":"https://api.github.com/users/djuber/following{/other_user}","gists_url":"https://api.github.com/users/djuber/gists{/gist_id}","starred_url":"https://api.github.com/users/djuber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/djuber/subscriptions","organizations_url":"https://api.github.com/users/djuber/orgs","repos_url":"https://api.github.com/users/djuber/repos","events_url":"https://api.github.com/users/djuber/events{/privacy}","received_events_url":"https://api.github.com/users/djuber/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/forem/forem/issues/13008/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/forem/forem/issues/13008/timeline","performed_via_github_app":null,"state_reason":"completed"}