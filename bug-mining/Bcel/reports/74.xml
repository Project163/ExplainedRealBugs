<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:14:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BCEL-273] Regressions running FindBugs on BCEL6</title>
                <link>https://issues.apache.org/jira/browse/BCEL-273</link>
                <project id="12314220" key="BCEL">Commons BCEL</project>
                    <description>&lt;h5&gt;&lt;a name=&quot;PREFACE&quot;&gt;&lt;/a&gt;PREFACE&lt;/h5&gt;
&lt;p&gt;I&apos;m trying to port FindBugs to the latest greatest BCEL 6 state from trunk, see &lt;a href=&quot;https://github.com/findbugsproject/findbugs/issues/106&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/findbugsproject/findbugs/issues/106&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;In short, FindBugs was using some manually created BCEL 5.2 fork which allowed us somehow run BCEL on Java 8 and even Java 9.&lt;/p&gt;

&lt;p&gt;Unfortunately I have no idea how to rebuild that fork, because no one in the project left any documentation.&lt;/p&gt;

&lt;p&gt;So anyway, my goal was to use unmodified BCEL6, therefore I fixed all compile issues caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/BCEL-222&quot; title=&quot;Major release of BCEL requires updating package name and maven coordinate&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BCEL-222&quot;&gt;&lt;del&gt;BCEL-222&lt;/del&gt;&lt;/a&gt; (&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/thumbs_down.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;) and was able to run FB with BCEL6 head.&lt;/p&gt;

&lt;p&gt;Unfortunately I found some regressions.&lt;/p&gt;

&lt;h5&gt;&lt;a name=&quot;Environment&quot;&gt;&lt;/a&gt;Environment&lt;/h5&gt;
&lt;p&gt;I&apos;m using my own git clone from BCEL mirror &lt;a href=&quot;https://github.com/iloveeclipse/commons-bcel/commits/trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/iloveeclipse/commons-bcel/commits/trunk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The clone only adds few Eclipse files and fixes some obvious errors, nothing worth to mention here. The reason why I&apos;m not using svn because it is too slow and I won&apos;t waste my time.&lt;/p&gt;

&lt;p&gt;To see commits I needed to port FB to BCEL6 port, go to &lt;a href=&quot;https://github.com/findbugsproject/findbugs/tree/java9_bcel6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/findbugsproject/findbugs/tree/java9_bcel6&lt;/a&gt;&lt;/p&gt;

&lt;h5&gt;&lt;a name=&quot;Howtoreproduce&quot;&gt;&lt;/a&gt;How to reproduce&lt;/h5&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;git clone https:&lt;span class=&quot;code-comment&quot;&gt;//github.com/findbugsproject/findbugs.git
&lt;/span&gt;cd findbugs
git checkout java9_bcel6
cd findbugs
ant
cd ../findbugsTestCases
ant
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;You should run Java 8.&lt;br/&gt;
After running tests, you should see many various errors, like: &lt;a href=&quot;https://github.com/findbugsproject/findbugs/files/300401/bcel6_test_result.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/findbugsproject/findbugs/files/300401/bcel6_test_result.txt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;None of those error appear with the old private patched BCEL5.2 snapshot we&apos;ve used before.&lt;/p&gt;

&lt;p&gt;It would be nice to fix the errors before the BCEL release.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12976062">BCEL-273</key>
            <summary>Regressions running FindBugs on BCEL6</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="iloveeclipse">Andrey Loskutov</reporter>
                        <labels>
                    </labels>
                <created>Mon, 6 Jun 2016 13:15:18 +0000</created>
                <updated>Thu, 14 Jul 2016 12:48:23 +0000</updated>
                            <resolved>Fri, 10 Jun 2016 12:08:10 +0000</resolved>
                                    <version>6.0</version>
                                    <fixVersion>6.0</fixVersion>
                                    <component>Main</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15316478" author="iloveeclipse" created="Mon, 6 Jun 2016 13:17:22 +0000"  >&lt;p&gt;bcel6_test_result.txt: test results of FindBugs running with BCEL6.&lt;/p&gt;</comment>
                            <comment id="15316480" author="iloveeclipse" created="Mon, 6 Jun 2016 13:18:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dbrosius&quot; class=&quot;user-hover&quot; rel=&quot;dbrosius&quot;&gt;dbrosius&lt;/a&gt;: can you please take a look?&lt;/p&gt;</comment>
                            <comment id="15316584" author="dbrosius" created="Mon, 6 Jun 2016 14:50:31 +0000"  >&lt;p&gt;Thanks I&apos;ll debug your fork tonight&lt;/p&gt;</comment>
                            <comment id="15317579" author="dbrosius" created="Tue, 7 Jun 2016 00:48:20 +0000"  >&lt;p&gt;i believe FindBug&apos;s DismantleBytecode.java is wrong, in how it handles invoke dynamic. I&apos;d attached a patch file that i believe fixes the issue&lt;/p&gt;</comment>
                            <comment id="15317582" author="dbrosius" created="Tue, 7 Jun 2016 00:48:48 +0000"  >&lt;p&gt;process invoke dynamic before CP&lt;/p&gt;</comment>
                            <comment id="15317609" author="dbrosius" created="Tue, 7 Jun 2016 01:16:42 +0000"  >&lt;p&gt;I see this problem&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; Exception analyzing FPEnumValueOf using detector edu.umd.cs.findbugs.detect.NoteNonnullReturnValues
    java.lang.IllegalArgumentException: Cannot be used on an array type
      At org.apache.commons.bcel6.&lt;span class=&quot;code-keyword&quot;&gt;generic&lt;/span&gt;.InvokeInstruction.getClassName(InvokeInstruction.java:135)
      At edu.umd.cs.findbugs.ba.Hierarchy2.findExactMethod(Hierarchy2.java:84)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And it does seem to be a problem with BCEL, due to a new construct that i didn&apos;t notice before, namely for enums, the generated values() method of enum looks like&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; FPEnumValueOf[] values();
    descriptor: ()[LFPEnumValueOf;
    flags: ACC_PUBLIC, ACC_STATIC
    Code:
      stack=1, locals=0, args_size=0
         0: getstatic     #1                  &lt;span class=&quot;code-comment&quot;&gt;// Field $VALUES:[LFPEnumValueOf;
&lt;/span&gt;         3: invokevirtual #2                  &lt;span class=&quot;code-comment&quot;&gt;// Method &lt;span class=&quot;code-quote&quot;&gt;&quot;[LFPEnumValueOf;&quot;&lt;/span&gt;.clone:()Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;
&lt;/span&gt;         6: checkcast     #3                  &lt;span class=&quot;code-comment&quot;&gt;// class &lt;span class=&quot;code-quote&quot;&gt;&quot;[LFPEnumValueOf;&quot;&lt;/span&gt;
&lt;/span&gt;         9: areturn
      LineNumberTable:
        line 56: 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;notice the call to clone on an array!!&lt;/p&gt;

&lt;p&gt;and in the constant pool, is this&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Constant pool:
   #1 = Fieldref           #4.#40         &lt;span class=&quot;code-comment&quot;&gt;// FPEnumValueOf.$VALUES:[LFPEnumValueOf;
&lt;/span&gt;   #2 = Methodref          #41.#42        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-quote&quot;&gt;&quot;[LFPEnumValueOf;&quot;&lt;/span&gt;.clone:()Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So java 8 is calling methods on arrays that bcel doesn&apos;t expect. I&apos;ll see if i can track down where that is handled. In theory, you can call toString() on an array, and BCEL doesn&apos;t have a fit, so we should be able to address this.&lt;/p&gt;

&lt;p&gt;I&apos;ll keep looking&lt;/p&gt;
</comment>
                            <comment id="15317708" author="dbrosius" created="Tue, 7 Jun 2016 02:44:06 +0000"  >&lt;p&gt;Array problem fixed here&lt;/p&gt;

&lt;p&gt;r1747124 | dbrosius | 2016-06-06 22:43:06 -0400 (Mon, 06 Jun 2016) | 1 line&lt;/p&gt;

&lt;p&gt;revert erroneous override of getClassName in InvokeInstruction, introduced in r1702349&lt;/p&gt;</comment>
                            <comment id="15317758" author="dbrosius" created="Tue, 7 Jun 2016 03:30:37 +0000"  >&lt;p&gt;I see this problem&lt;/p&gt;

&lt;p&gt;Exception analyzing JPAI_Sample$MyEntity using detector edu.umd.cs.findbugs.detect.NoteUnconditionalParamDerefs&lt;br/&gt;
    java.lang.ClassCastException: edu.umd.cs.findbugs.bcel.generic.NULL2Z cannot be cast to org.apache.commons.bcel6.generic.BranchInstruction&lt;br/&gt;
      At org.apache.commons.bcel6.generic.BranchHandle.getBI(BranchHandle.java:64)&lt;br/&gt;
      At org.apache.commons.bcel6.generic.BranchHandle.getPosition(BranchHandle.java:73)&lt;br/&gt;
      At edu.umd.cs.findbugs.ba.BetterCFGBuilder2$Subroutine.addInstruction(BetterCFGBuilder2.java:296)&lt;br/&gt;
      At edu.umd.cs.findbugs.ba.BetterCFGBuilder2.build(BetterCFGBuilder2.java:867)&lt;/p&gt;


&lt;p&gt;This is caused by Findbugs optimization pass in BetterCFGBuilder2.optimize, specifically&lt;br/&gt;
`&lt;br/&gt;
                            if (nullIsTrue) &lt;/p&gt;
{
                                // System.out.println(&quot;Found NULL2Z instruction&quot;);
                                head.swapInstruction(new NULL2Z());

                            }
&lt;p&gt; else &lt;/p&gt;
{
                                // System.out.println(&quot;Found NONNULL2Z instruction&quot;);
                                head.swapInstruction(new NONNULL2Z());
                            }
&lt;p&gt;`&lt;/p&gt;

&lt;p&gt;This takes an IFNONNULL BranchHandle, and injects a special NULL2Z BranchInstruction into it. It does not however change what head is, and so head is still a BranchHandle  that is holding a ConversionInstruction. &lt;/p&gt;

&lt;p&gt;Really, the head BranchHandle should be removed from the InstructionList, and replaced with the NULL2Z (or at least a non-BranchHandle), but it does not.&lt;/p&gt;

&lt;p&gt;Now this broke because of Sebb&apos;s changes, to BranchHandle.java, here&lt;/p&gt;

&lt;p&gt;    private BranchInstruction getBI() &lt;/p&gt;
{
        return (BranchInstruction) super.getInstruction();
    }

&lt;p&gt;   @Override&lt;br/&gt;
    public int getPosition() &lt;/p&gt;
{
        return getBI().getPosition();
    }

&lt;p&gt;where getBI() assumes, (probably correctly) the the instruction is going to be of type BranchInstruction, but NULL2Z is a ConversionInstruction.&lt;/p&gt;

&lt;p&gt;So while this was caused by BCEL changes, i actually think the changes were right, and findbugs needs to rewrite the InstructionList to take out the BranchHandle and replace it with a plain InstructionHandle. &lt;/p&gt;

</comment>
                            <comment id="15320691" author="iloveeclipse" created="Wed, 8 Jun 2016 14:55:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dbrosius&quot; class=&quot;user-hover&quot; rel=&quot;dbrosius&quot;&gt;dbrosius&lt;/a&gt;: thanks for the pointers! &lt;/p&gt;

&lt;p&gt;I&apos;ve pushed &lt;a href=&quot;https://github.com/findbugsproject/findbugs/commits/java9_bcel6_old&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/findbugsproject/findbugs/commits/java9_bcel6_old&lt;/a&gt; branch which applies the DismantleBytecode fix proposed earlier - this works!&lt;/p&gt;

&lt;p&gt;The current (last visible) problem is ClassCastException in org.apache.commons.bcel6.generic.BranchHandle.getBI(BranchHandle.java:64).&lt;/p&gt;

&lt;p&gt;If I change BranchHandle.java to &lt;a href=&quot;https://github.com/iloveeclipse/commons-bcel/commit/25dfa20fd99e4053e68b6054ff21f55fd915e003&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/iloveeclipse/commons-bcel/commit/25dfa20fd99e4053e68b6054ff21f55fd915e003&lt;/a&gt;, the CCE disappear and all FB tests pass on Java 8.&lt;/p&gt;

&lt;p&gt;However I&apos;ve failed to do a fix on the FB side which would NOT require &lt;a href=&quot;https://github.com/iloveeclipse/commons-bcel/commit/25dfa20fd99e4053e68b6054ff21f55fd915e003&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/iloveeclipse/commons-bcel/commit/25dfa20fd99e4053e68b6054ff21f55fd915e003&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;If I change FB code, see attached BetterCFGBuilder2.java, I see other errors, and tests are still failing.&lt;/p&gt;

&lt;p&gt;I&apos;ve never used BCEL before, so my primitive fix was to replace calls to &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;InstructionHandle head;
Instruction replacement;
...
head.swapInstruction(replacement);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;with &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;...
   head = swapInstruction(instructionList, head, replacement);
...
    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; InstructionHandle swapInstruction(InstructionList list, InstructionHandle handle, Instruction i){
        InstructionHandle newOne = list.insert(handle, i);
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            list.delete(handle);
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (TargetLostException e) {
            &lt;span class=&quot;code-comment&quot;&gt;// TODO Auto-generated &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; block
&lt;/span&gt;            e.printStackTrace();
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; newOne;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m not sure if replacing BranchInstruction by ConversionInstruction in the way as it shown above is a good idea (I see that the TargetLostException are flying around which means we have some loose ends in the list). But honestly speaking, I have no clue how the BetterCFGBuilder2 code works and how to fix it in the &quot;right&quot; way.&lt;/p&gt;

&lt;p&gt;In that sense, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sebb%40apache.org&quot; class=&quot;user-hover&quot; rel=&quot;sebb@apache.org&quot;&gt;sebb@apache.org&lt;/a&gt;: WDYT about &lt;a href=&quot;https://github.com/iloveeclipse/commons-bcel/commit/25dfa20fd99e4053e68b6054ff21f55fd915e003?&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/iloveeclipse/commons-bcel/commit/25dfa20fd99e4053e68b6054ff21f55fd915e003?&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15322080" author="githubbot" created="Thu, 9 Jun 2016 07:35:08 +0000"  >&lt;p&gt;GitHub user iloveeclipse opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/commons-bcel/pull/6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-bcel/pull/6&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/BCEL-273&quot; title=&quot;Regressions running FindBugs on BCEL6&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BCEL-273&quot;&gt;&lt;del&gt;BCEL-273&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Fixes &lt;a href=&quot;https://issues.apache.org/jira/browse/BCEL-273&quot; title=&quot;Regressions running FindBugs on BCEL6&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BCEL-273&quot;&gt;&lt;del&gt;BCEL-273&lt;/del&gt;&lt;/a&gt; by partly reverting adf9fc13b37f866d731c73a09071170d50bfa807.&lt;/p&gt;

&lt;p&gt;    This allows FindBugs to run on latest greatest BCEL state and avoid exceptions below:&lt;/p&gt;

&lt;p&gt;    java.lang.ClassCastException: edu.umd.cs.findbugs.bcel.generic.NULL2Z&lt;br/&gt;
    cannot be cast to org.apache.commons.bcel6.generic.BranchInstruction&lt;br/&gt;
    At&lt;br/&gt;
    org.apache.commons.bcel6.generic.BranchHandle.getBI(BranchHandle.java:64)&lt;br/&gt;
    At&lt;br/&gt;
    org.apache.commons.bcel6.generic.BranchHandle.getPosition(BranchHandle.java:73)&lt;br/&gt;
    At&lt;br/&gt;
    edu.umd.cs.findbugs.ba.BetterCFGBuilder2$Subroutine.addInstruction(BetterCFGBuilder2.java:296)&lt;br/&gt;
    At&lt;br/&gt;
    edu.umd.cs.findbugs.ba.BetterCFGBuilder2.build(BetterCFGBuilder2.java:867)&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/iloveeclipse/commons-bcel&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/iloveeclipse/commons-bcel&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/BCEL-273&quot; title=&quot;Regressions running FindBugs on BCEL6&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BCEL-273&quot;&gt;&lt;del&gt;BCEL-273&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/commons-bcel/pull/6.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-bcel/pull/6.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #6&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 25dfa20fd99e4053e68b6054ff21f55fd915e003&lt;br/&gt;
Author: Andrey Loskutov &amp;lt;loskutov@gmx.de&amp;gt;&lt;br/&gt;
Date:   2016-06-08T13:27:07Z&lt;/p&gt;

&lt;p&gt;    Fixes &lt;a href=&quot;https://issues.apache.org/jira/browse/BCEL-273&quot; title=&quot;Regressions running FindBugs on BCEL6&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BCEL-273&quot;&gt;&lt;del&gt;BCEL-273&lt;/del&gt;&lt;/a&gt; by partly reverting&lt;br/&gt;
    adf9fc13b37f866d731c73a09071170d50bfa807.&lt;/p&gt;

&lt;p&gt;    java.lang.ClassCastException: edu.umd.cs.findbugs.bcel.generic.NULL2Z&lt;br/&gt;
    cannot be cast to org.apache.commons.bcel6.generic.BranchInstruction&lt;br/&gt;
    At&lt;br/&gt;
    org.apache.commons.bcel6.generic.BranchHandle.getBI(BranchHandle.java:64)&lt;br/&gt;
    At&lt;br/&gt;
    org.apache.commons.bcel6.generic.BranchHandle.getPosition(BranchHandle.java:73)&lt;br/&gt;
    At&lt;br/&gt;
    edu.umd.cs.findbugs.ba.BetterCFGBuilder2$Subroutine.addInstruction(BetterCFGBuilder2.java:296)&lt;br/&gt;
    At&lt;br/&gt;
    edu.umd.cs.findbugs.ba.BetterCFGBuilder2.build(BetterCFGBuilder2.java:867)&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15322274" author="sebb@apache.org" created="Thu, 9 Jun 2016 09:57:32 +0000"  >&lt;p&gt;The stack trace looks very odd.&lt;/p&gt;

&lt;p&gt;It looks like you are mixing two different versions of BCEL using different package names and/or creating your own classes which are not BranchInstructions.&lt;/p&gt;

&lt;p&gt;If the following patch comment is true, then there should be no reason for the CCE:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; BranchInstruction bi; &lt;span class=&quot;code-comment&quot;&gt;// An alias in fact, but saves lots of casts&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m not keen to re-introduce a local copy of the instruction, as it makes testing harder.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot;If there are two copies of a piece of data, at least one of them may be wrong&amp;quot;&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;I would rather see the casts.&lt;/p&gt;</comment>
                            <comment id="15322282" author="iloveeclipse" created="Thu, 9 Jun 2016 10:02:56 +0000"  >&lt;p&gt;The problem are not two different BCEL versions but the BCEL API, which allows you to swap the instruction on InstructionHandle without using setInstruction(): org.apache.bcel.generic.InstructionHandle.swapInstruction(Instruction). If the code uses swapInstruction() and then calls any of BranchHandle methods, we will get a CCE without the patch.&lt;/p&gt;</comment>
                            <comment id="15322284" author="iloveeclipse" created="Thu, 9 Jun 2016 10:06:36 +0000"  >&lt;p&gt;BTW, I&apos;m not saying the BCEL swapInstruction API is/was good, but it was invented to serve some purposes, it was published and it was used, so the original patch, which makes sense from the clean code point of view, unintentionally broke existing clients which just used that public API.&lt;/p&gt;</comment>
                            <comment id="15322772" author="sebb@apache.org" created="Thu, 9 Jun 2016 16:09:29 +0000"  >&lt;p&gt;The Javadoc for swapInstruction says:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Temporarily swap the current instruction, without disturbing&lt;/li&gt;
	&lt;li&gt;anything. Meant to be used by a debugger, implementing&lt;/li&gt;
	&lt;li&gt;breakpoints. Current instruction is returned.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If the method is being used for anything else, then I think the user has to be aware it may break things.&lt;/p&gt;

&lt;p&gt;They should not expect the class to be have normally until the original instruction has been restored.&lt;/p&gt;</comment>
                            <comment id="15322777" author="sebb@apache.org" created="Thu, 9 Jun 2016 16:11:39 +0000"  >&lt;p&gt;AFAICT Dave Brosius agrees with me on this; Findbugs should not be (ab)using the method this way.&lt;/p&gt;</comment>
                            <comment id="15322780" author="iloveeclipse" created="Thu, 9 Jun 2016 16:13:12 +0000"  >&lt;p&gt;That&apos;s right, but we should not make things worse. If one API allows to swap instructions on handle, the handle should not fail if the swapped instruction is requested.&lt;/p&gt;

&lt;p&gt;BTW &quot;meant to be used&quot; is not &quot;shall be used only for&quot;.&lt;/p&gt;</comment>
                            <comment id="15322806" author="sebb@apache.org" created="Thu, 9 Jun 2016 16:30:20 +0000"  >&lt;p&gt;AFAICT it&apos;s not possible to fix the code so that it works properly once the swapInstruction method has been used.&lt;/p&gt;

&lt;p&gt;Caching the original instruction avoids the CCE, but means that the other methods return stale data.&lt;/p&gt;

&lt;p&gt;Caveat emptor.&lt;/p&gt;</comment>
                            <comment id="15322863" author="dbrosius" created="Thu, 9 Jun 2016 17:01:50 +0000"  >&lt;p&gt;While I think Sebb&apos;s changes in&lt;br/&gt;
BranchHandle are technically correct,  I&apos;m not sure they add any significant value,  and so reverting that probably is the safe option. &lt;/p&gt;</comment>
                            <comment id="15322871" author="iloveeclipse" created="Thu, 9 Jun 2016 17:07:08 +0000"  >&lt;p&gt;Agree. &lt;br/&gt;
I don&apos;t think the old state was buggy, otherwise we would see bug reports. Cleaning the code base is OK, but sometimes existing API can not be cleaned because it is simply not well designed. There was a reason for original author of swapInstruction to allow instruction handles have different instructions, and the branch handle worked well with that approach. The CCE we see on changed code in FindBugs will appear also in other tools used that API. To be consistent and clean, swapInstruction must be removed entirely.&lt;br/&gt;
Compromise: release patch with 6.0 and remove that inconsistent API in 7.0.&lt;/p&gt;</comment>
                            <comment id="15324326" author="sebb@apache.org" created="Fri, 10 Jun 2016 11:45:48 +0000"  >&lt;p&gt;OK, but I think we need to carefully document the restrictions on the use of swapInstruction if used with a BranchHandle.&lt;/p&gt;</comment>
                            <comment id="15324342" author="sebb@apache.org" created="Fri, 10 Jun 2016 12:08:11 +0000"  >&lt;p&gt;URL: &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1747689&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1747689&amp;amp;view=rev&lt;/a&gt;&lt;br/&gt;
Log:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/BCEL-273&quot; title=&quot;Regressions running FindBugs on BCEL6&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BCEL-273&quot;&gt;&lt;del&gt;BCEL-273&lt;/del&gt;&lt;/a&gt; - Regressions running FindBugs on BCEL6&lt;br/&gt;
Reverted to previous code; added comments&lt;/p&gt;

&lt;p&gt;Modified:&lt;br/&gt;
    commons/proper/bcel/trunk/src/main/java/org/apache/bcel/generic/BranchHandle.java&lt;br/&gt;
    commons/proper/bcel/trunk/src/main/java/org/apache/bcel/generic/InstructionHandle.java&lt;/p&gt;</comment>
                            <comment id="15327210" author="githubbot" created="Mon, 13 Jun 2016 11:52:40 +0000"  >&lt;p&gt;Github user iloveeclipse closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/commons-bcel/pull/6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-bcel/pull/6&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12808948" name="BetterCFGBuilder2.java" size="50992" author="iloveeclipse" created="Wed, 8 Jun 2016 14:55:52 +0000"/>
                            <attachment id="12808380" name="bcel6_test_result.txt" size="13641121" author="iloveeclipse" created="Mon, 6 Jun 2016 13:17:22 +0000"/>
                            <attachment id="12808521" name="invokedynamic.txt" size="2496" author="dbrosius" created="Tue, 7 Jun 2016 00:48:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 22 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2z0uf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>