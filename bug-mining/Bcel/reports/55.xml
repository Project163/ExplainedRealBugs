<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:13:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BCEL-202] StackMap[Table]Entry.copy() needs to be deep; Improved support for StackMaps</title>
                <link>https://issues.apache.org/jira/browse/BCEL-202</link>
                <project id="12314220" key="BCEL">Commons BCEL</project>
                    <description>&lt;p&gt;There are several ways a user can modify a Java class file that should cause BCEL to update the StackMaps automatically.  Unfortunately, it does not.  These additional methods at least allow users to take care of these issues for themselves.&lt;/p&gt;

&lt;p&gt;The patch also fixes a bug - StackMapTableEntry.copy() needs to be a deep copy to prevent StackMapTypes from being reused.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12772547">BCEL-202</key>
            <summary>StackMap[Table]Entry.copy() needs to be deep; Improved support for StackMaps</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="markro">Mark Roberts</reporter>
                        <labels>
                    </labels>
                <created>Thu, 5 Feb 2015 00:10:04 +0000</created>
                <updated>Thu, 14 Jul 2016 12:48:26 +0000</updated>
                            <resolved>Fri, 21 Aug 2015 21:33:10 +0000</resolved>
                                                    <fixVersion>6.0</fixVersion>
                                        <due></due>
                            <votes>4</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14395240" author="daniel.stuber@corix.ch" created="Fri, 3 Apr 2015 23:14:11 +0000"  >&lt;p&gt;Some more work needs to be done for allowing users to adjust a method&apos;s stack-map-table.&lt;/p&gt;

&lt;p&gt;Some entry-types have their offset-delta stored in the frame-type. Thus altering the offset-delta may need altering the frame-type, too. It can therefore not be final any more. &lt;/p&gt;

&lt;p&gt;I also suggest to rename the getEntryByteSize() method reduce its visibility to package-private as follows:&lt;br/&gt;
StackMapTableEntry.java:&lt;br/&gt;
    int calculateLength() {&lt;br/&gt;
      if (frame_type &amp;gt;= Constants.SAME_FRAME &amp;amp;&amp;amp; frame_type &amp;lt;= Constants.SAME_FRAME_MAX) &lt;/p&gt;
{
        return 1;
      }
&lt;p&gt; else if (frame_type &amp;gt;= Constants.SAME_LOCALS_1_STACK_ITEM_FRAME &amp;amp;&amp;amp; frame_type &amp;lt;= Constants.SAME_LOCALS_1_STACK_ITEM_FRAME_MAX) &lt;/p&gt;
{
          return 1 + (types_of_stack_items[0].hasIndex() ? 3 : 1);
      }
&lt;p&gt; else if (frame_type == Constants.SAME_LOCALS_1_STACK_ITEM_FRAME_EXTENDED) &lt;/p&gt;
{
          return 3 + (types_of_stack_items[0].hasIndex() ? 3 : 1);
      }
&lt;p&gt; else if (frame_type &amp;gt;= Constants.CHOP_FRAME &amp;amp;&amp;amp; frame_type &amp;lt;= Constants.CHOP_FRAME_MAX) &lt;/p&gt;
{
        return 3;
      } else if (frame_type == Constants.SAME_FRAME_EXTENDED) {        return 3;      }
&lt;p&gt; else if (frame_type &amp;gt;= Constants.APPEND_FRAME &amp;amp;&amp;amp; frame_type &amp;lt;= Constants.APPEND_FRAME_MAX) {&lt;br/&gt;
        int len = 3;&lt;br/&gt;
          for (int i = 0; i &amp;lt; types_of_locals.length; i++) &lt;/p&gt;
{
              len += types_of_locals[i].hasIndex() ? 3 : 1;
          }
&lt;p&gt;          return len;&lt;br/&gt;
      } else if (frame_type == Constants.FULL_FRAME) {        &lt;br/&gt;
        int len = 7;&lt;br/&gt;
          for (int i = 0; i &amp;lt; types_of_locals.length; i++) &lt;/p&gt;
{
              len += types_of_locals[i].hasIndex() ? 3 : 1;
          }
&lt;p&gt;          for (int i = 0; i &amp;lt; types_of_stack_items.length; i++) &lt;/p&gt;
{
              len += types_of_stack_items[i].hasIndex() ? 3 : 1;
          }
&lt;p&gt;          return len;&lt;br/&gt;
      } else &lt;/p&gt;
{
          /* Can&apos;t happen */
          throw new ClassFormatException (&quot;Invalid Stack map table tag: &quot; + frame_type);
      }
&lt;p&gt;    }&lt;/p&gt;


&lt;p&gt;Furthermore it might be necessary to completely replace a stack-map-entry with another element resulting in a different length of the whole stack-map-table. I do this as follows:&lt;br/&gt;
StackMapTable.java&lt;br/&gt;
    public final void setStackMapTable( StackMapTableEntry[] map ) {&lt;br/&gt;
        this.map = map;&lt;/p&gt;

&lt;p&gt;        int len = 2;&lt;br/&gt;
        for (int i = 0; i &amp;lt; map.length; i++) &lt;/p&gt;
{
          len += map[i].calculateLength();
        }
&lt;p&gt;        setLength(len);&lt;br/&gt;
    }&lt;/p&gt;

&lt;p&gt;This enforces a slight change in one constructor by directly setting the map variable rather than calling setStackMapTable(...):&lt;br/&gt;
    public StackMapTable(int name_index, int length, StackMapTableEntry[] map, ConstantPool constant_pool) &lt;/p&gt;
{
        super(Constants.ATTR_STACK_MAP_TABLE, name_index, length, constant_pool);
        this.map = map;
    }</comment>
                            <comment id="14602028" author="kdabuss" created="Thu, 25 Jun 2015 22:01:56 +0000"  >&lt;p&gt;I just checked this out. There is no &quot;number_of_locals&quot; or &quot;number_of_stack_items&quot; field, but you constantly refer to them in getEntryByteSize() and copy().&lt;br/&gt;
Unless you&apos;re using a different branch &apos;cause I just used trunk.&lt;/p&gt;</comment>
                            <comment id="14603230" author="markro" created="Fri, 26 Jun 2015 17:19:40 +0000"  >&lt;p&gt;My diff was relative to 1651903; version 1664574 deleted these members&lt;/p&gt;
</comment>
                            <comment id="14604258" author="kdabuss" created="Sat, 27 Jun 2015 17:19:24 +0000"  >&lt;p&gt;Ah, that makes sense. In any case, just adding&lt;/p&gt;

&lt;p&gt;int number_of_locals = (types_of_locals == null) ? 0 : types_of_locals.length;&lt;/p&gt;

&lt;p&gt;and similar for number_of_stack_items to the beginning of those two methods seems to work just fine.&lt;br/&gt;
Thank you so much for this .diff, by the way, it absolutely saved my Bachelor&apos;s thesis. I did notice, though, that the StackMapTable&apos;s &quot;length&quot; attribute is not recalculated based on the StackMapTableEntry instances contained within, so you have to manually set the StackMapTable&apos;s length before dumping it.&lt;br/&gt;
That seems like a thing that BCEL should do automatically, but at least I now have the tools to correctly do that myself by using the getEntryByteSize() method.&lt;/p&gt;</comment>
                            <comment id="14703487" author="markro" created="Wed, 19 Aug 2015 18:05:48 +0000"  >&lt;p&gt;Okay, I have studied Daniel&apos;s comments and will be working on revised versions of StackMapTable and StackMapTableEntry today.  Will advise as soon as I have tested with our Daikon tools that modify class files: Chicory and DynComp .&lt;/p&gt;</comment>
                            <comment id="14706104" author="markro" created="Fri, 21 Aug 2015 01:58:07 +0000"  >&lt;p&gt;I have removed the old diff file and attached a new one.  These changes address/incorporate all of Daniel&apos;s comments.  Pleas note that per &lt;a href=&quot;https://issues.apache.org/jira/browse/BCEL-248&quot; title=&quot;StackMapTable[Entry] should be removed and improvements merged into StackMap[Entry]&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BCEL-248&quot;&gt;&lt;del&gt;BCEL-248&lt;/del&gt;&lt;/a&gt; I have made my changes to StackMap.java and StackMapEntry.java NOT the newer versions (StackMapTable.java and StackMapTableEntry.java).  I have attached another diff file to &lt;a href=&quot;https://issues.apache.org/jira/browse/BCEL-248&quot; title=&quot;StackMapTable[Entry] should be removed and improvements merged into StackMap[Entry]&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BCEL-248&quot;&gt;&lt;del&gt;BCEL-248&lt;/del&gt;&lt;/a&gt; that shows the changes necessary to delete the two latter files.  I have modified our Daikon tools and tested them with these changes and all looks good.&lt;/p&gt;</comment>
                            <comment id="14706587" author="sebb@apache.org" created="Fri, 21 Aug 2015 12:10:49 +0000"  >&lt;p&gt;The patch changes the public constructor parameters.&lt;br/&gt;
It would be better to keep the original one in case we can restore binary compat with 5.2; I will add it back in and deprecate it&lt;/p&gt;

&lt;p&gt;The setStackMap() method uses &quot;int len = 2&apos;;&quot; without explanation. What does that represent?&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;No need to update the patch; I can update the code directly&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="14706702" author="sebb@apache.org" created="Fri, 21 Aug 2015 12:52:08 +0000"  >&lt;p&gt;URL: &lt;a href=&quot;http://svn.apache.org/r1696959&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/r1696959&lt;/a&gt;&lt;br/&gt;
Log:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/BCEL-202&quot; title=&quot;StackMap[Table]Entry.copy() needs to be deep; Improved support for StackMaps&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BCEL-202&quot;&gt;&lt;del&gt;BCEL-202&lt;/del&gt;&lt;/a&gt; StackMapTableEntry.copy() needs to be deep; Improved support for StackMaps&lt;/p&gt;

&lt;p&gt;Modified:&lt;br/&gt;
    commons/proper/bcel/trunk/src/changes/changes.xml&lt;br/&gt;
    commons/proper/bcel/trunk/src/main/java/org/apache/commons/bcel6/classfile/StackMap.java&lt;br/&gt;
    commons/proper/bcel/trunk/src/main/java/org/apache/commons/bcel6/classfile/StackMapEntry.java&lt;/p&gt;</comment>
                            <comment id="14706721" author="markro" created="Fri, 21 Aug 2015 13:14:40 +0000"  >&lt;p&gt;The len=2 is accounting for the &apos;number_of_entries&apos; field prior to the array of stack maps.&lt;/p&gt;

&lt;p&gt;I suppose you could put the number_of_locals and number_of_stack_items arguments back in the constructor with a comment that these items are now ignored and the lengths are derived from the matching array arguments.&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12751639" name="stack-map.diff" size="13083" author="markro" created="Fri, 21 Aug 2015 01:52:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 13 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i257nb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>