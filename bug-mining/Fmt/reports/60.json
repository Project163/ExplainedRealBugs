{"url":"https://api.github.com/repos/fmtlib/fmt/issues/4487","repository_url":"https://api.github.com/repos/fmtlib/fmt","labels_url":"https://api.github.com/repos/fmtlib/fmt/issues/4487/labels{/name}","comments_url":"https://api.github.com/repos/fmtlib/fmt/issues/4487/comments","events_url":"https://api.github.com/repos/fmtlib/fmt/issues/4487/events","html_url":"https://github.com/fmtlib/fmt/issues/4487","id":3205872066,"node_id":"I_kwDOAGurSs6_FbnC","number":4487,"title":"`fmt::basic_memory_buffer<...,std::pmr::polymorphic_allocator>` is not moveable","user":{"login":"dlex","id":6086652,"node_id":"MDQ6VXNlcjYwODY2NTI=","avatar_url":"https://avatars.githubusercontent.com/u/6086652?v=4","gravatar_id":"","url":"https://api.github.com/users/dlex","html_url":"https://github.com/dlex","followers_url":"https://api.github.com/users/dlex/followers","following_url":"https://api.github.com/users/dlex/following{/other_user}","gists_url":"https://api.github.com/users/dlex/gists{/gist_id}","starred_url":"https://api.github.com/users/dlex/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dlex/subscriptions","organizations_url":"https://api.github.com/users/dlex/orgs","repos_url":"https://api.github.com/users/dlex/repos","events_url":"https://api.github.com/users/dlex/events{/privacy}","received_events_url":"https://api.github.com/users/dlex/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2025-07-06T01:01:47Z","updated_at":"2025-08-09T15:14:17Z","closed_at":"2025-08-09T15:14:17Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"`std::pmr::polymorphic_allocator` is a non-propagating allocator: `std::allocator_traits<std::pmr::polymorphic_allocator>::propagate_on_container_move_assignment::value` is `false` and correspondingly, it has its move assignment operator deleted. \n\nSince `basic_memory_buffer::operator=(basic_memory_buffer&& other)` unconditionally calls\n\nhttps://github.com/fmtlib/fmt/blob/40626af88bd7df9a5fb80be7b25ac85b122d6c21/include/fmt/format.h#L829-L830\n\nfor both propagating and non-propagating allocators, a snippet like this won't compile:\n\n```c++\n    std::pmr::unsynchronized_pool_resource r1;\n    using pmr_memory_buffer = fmt::basic_memory_buffer<char,10,std::pmr::polymorphic_allocator<char>>;\n    pmr_memory_buffer b1{ &r1 };\n    pmr_memory_buffer b2{ &r1 };\n    ......\n    b2 = std::move( b1 );\n```\n\nA bit more practical snippet can be found here: [Compiler Explorer](https://www.godbolt.org/#g:!((g:!((g:!((h:codeEditor,i:(filename:'1',fontScale:14,fontUsePx:'0',j:1,lang:c%2B%2B,selection:(endColumn:1,endLineNumber:23,positionColumn:1,positionLineNumber:23,selectionStartColumn:1,selectionStartLineNumber:23,startColumn:1,startLineNumber:23),source:'%23include+%3Cfmt/format.h%3E%0A%23include+%3Cstring%3E%0A%23include+%3Cmemory_resource%3E%0A%0Aint+main()+%7B%0A++++//+Ensure+no+allocations+are+made+from+the+default+resource%0A++++std::pmr::set_default_resource(std::pmr::null_memory_resource())%3B%0A%0A++++std::pmr::unsynchronized_pool_resource+r1%3B%0A++++%0A++++using+pmr_memory_buffer+%3D+fmt::basic_memory_buffer%3Cchar,10,std::pmr::polymorphic_allocator%3Cchar%3E%3E%3B%0A+%0A++++pmr_memory_buffer+b%7B%26r1%7D%3B%0A++++std::pmr::string+s1+%7B+%22s1............................%22,+%26r1+%7D%3B%0A++++fmt::format_to(std::back_inserter(b),+%22s1:+%7B%7D%22,+s1)%3B%0A%0A++++std::pmr::vector%3Cpmr_memory_buffer%3E+bv+%7B%26r1%7D%3B%0A%0A++++//+This+does+not+compile+because+pmr::polymorphic_allocator+does+not+have+a+move+ctor%0A++++//+because+it!'s+a+non-propagaing+allocator%0A++++bv.push_back+(+std::move(b)+)%3B%0A%7D%0A'),l:'5',n:'0',o:'C%2B%2B+source+%231',t:'0')),k:50,l:'4',n:'0',o:'',s:0,t:'0'),(g:!((h:executor,i:(argsPanelShown:'1',compilationPanelShown:'0',compiler:g151,compilerName:'',compilerOutShown:'0',execArgs:'',execStdin:'',fontScale:14,fontUsePx:'0',j:1,lang:c%2B%2B,libs:!((name:fmt,ver:trunk)),options:'',overrides:!(),runtimeTools:!(),source:1,stdinPanelShown:'1',wrap:'1'),l:'5',n:'0',o:'Executor+x86-64+gcc+15.1+(C%2B%2B,+Editor+%231)',t:'0')),header:(),k:50,l:'4',n:'0',o:'',s:0,t:'0')),l:'2',n:'0',o:'',t:'0')),version:4). It was inspired by the way `fmt::memory_buffer` class is used in [spdlog](https://github.com/gabime/spdlog). Its `ringbuffer_sink` [declares](https://github.com/gabime/spdlog/blob/287333ee00555aaece5a5cf6acc9040563c6f642/include/spdlog/sinks/ringbuffer_sink.h#L59) a circular buffer of basically `fmt::memory_buffer`s, and `move()`ing instances of `fmt::memory_buffer`s into it when they are ready.\n\nI'm considering a fix where the move-propagating allocators will behave as before, whereas those that don't propagate on move will check whether the allocators (and the memory resources) are the same for the source and for the target. If source and target allocator instances are the same, `move()` can proceed as usual, passing ownership of the underlying buffer. If the allocators are different, the buffer is then copied. That would replicate the behaviour of standard library containers.","closed_by":{"login":"vitaut","id":576385,"node_id":"MDQ6VXNlcjU3NjM4NQ==","avatar_url":"https://avatars.githubusercontent.com/u/576385?v=4","gravatar_id":"","url":"https://api.github.com/users/vitaut","html_url":"https://github.com/vitaut","followers_url":"https://api.github.com/users/vitaut/followers","following_url":"https://api.github.com/users/vitaut/following{/other_user}","gists_url":"https://api.github.com/users/vitaut/gists{/gist_id}","starred_url":"https://api.github.com/users/vitaut/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vitaut/subscriptions","organizations_url":"https://api.github.com/users/vitaut/orgs","repos_url":"https://api.github.com/users/vitaut/repos","events_url":"https://api.github.com/users/vitaut/events{/privacy}","received_events_url":"https://api.github.com/users/vitaut/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/fmtlib/fmt/issues/4487/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/fmtlib/fmt/issues/4487/timeline","performed_via_github_app":null,"state_reason":"completed"}