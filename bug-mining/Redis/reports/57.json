{"url":"https://api.github.com/repos/redis/redis/issues/9410","repository_url":"https://api.github.com/repos/redis/redis","labels_url":"https://api.github.com/repos/redis/redis/issues/9410/labels{/name}","comments_url":"https://api.github.com/repos/redis/redis/issues/9410/comments","events_url":"https://api.github.com/repos/redis/redis/issues/9410/events","html_url":"https://github.com/redis/redis/issues/9410","id":979465335,"node_id":"MDU6SXNzdWU5Nzk0NjUzMzU=","number":9410,"title":"[BUG] XTRIM MINID may delete messages whose IDs are higher than threshold","user":{"login":"stefanodefaria","id":10980198,"node_id":"MDQ6VXNlcjEwOTgwMTk4","avatar_url":"https://avatars.githubusercontent.com/u/10980198?v=4","gravatar_id":"","url":"https://api.github.com/users/stefanodefaria","html_url":"https://github.com/stefanodefaria","followers_url":"https://api.github.com/users/stefanodefaria/followers","following_url":"https://api.github.com/users/stefanodefaria/following{/other_user}","gists_url":"https://api.github.com/users/stefanodefaria/gists{/gist_id}","starred_url":"https://api.github.com/users/stefanodefaria/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stefanodefaria/subscriptions","organizations_url":"https://api.github.com/users/stefanodefaria/orgs","repos_url":"https://api.github.com/users/stefanodefaria/repos","events_url":"https://api.github.com/users/stefanodefaria/events{/privacy}","received_events_url":"https://api.github.com/users/stefanodefaria/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"guybe7","id":19590683,"node_id":"MDQ6VXNlcjE5NTkwNjgz","avatar_url":"https://avatars.githubusercontent.com/u/19590683?v=4","gravatar_id":"","url":"https://api.github.com/users/guybe7","html_url":"https://github.com/guybe7","followers_url":"https://api.github.com/users/guybe7/followers","following_url":"https://api.github.com/users/guybe7/following{/other_user}","gists_url":"https://api.github.com/users/guybe7/gists{/gist_id}","starred_url":"https://api.github.com/users/guybe7/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/guybe7/subscriptions","organizations_url":"https://api.github.com/users/guybe7/orgs","repos_url":"https://api.github.com/users/guybe7/repos","events_url":"https://api.github.com/users/guybe7/events{/privacy}","received_events_url":"https://api.github.com/users/guybe7/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"guybe7","id":19590683,"node_id":"MDQ6VXNlcjE5NTkwNjgz","avatar_url":"https://avatars.githubusercontent.com/u/19590683?v=4","gravatar_id":"","url":"https://api.github.com/users/guybe7","html_url":"https://github.com/guybe7","followers_url":"https://api.github.com/users/guybe7/followers","following_url":"https://api.github.com/users/guybe7/following{/other_user}","gists_url":"https://api.github.com/users/guybe7/gists{/gist_id}","starred_url":"https://api.github.com/users/guybe7/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/guybe7/subscriptions","organizations_url":"https://api.github.com/users/guybe7/orgs","repos_url":"https://api.github.com/users/guybe7/repos","events_url":"https://api.github.com/users/guybe7/events{/privacy}","received_events_url":"https://api.github.com/users/guybe7/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":1,"created_at":"2021-08-25T17:30:53Z","updated_at":"2022-01-07T13:31:06Z","closed_at":"2022-01-07T13:31:06Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\nIn a certain scenario, the XTRIM command will delete messages with IDs higher than the threshold provided by the MINID option. In fact, all messages in the stream get deleted in this specific scenario.\r\n\r\n**To reproduce**\r\nOne must add a message to the stream providing an ID, say \"10-1\". Then other messages must be added to the stream, but without providing an ID (using the \"*\" character).\r\nIf we call XTRIM passing one of the auto-generated IDs as the MINID, all messages in the stream will be deleted - even those with ID higher than the threshold provided.\r\n\r\nFor example:\r\n```\r\nreids:6379> scan 0\r\n1) \"0\"\r\n2) (empty array)\r\nreids:6379> xadd mystream 10-1 key value\r\n\"10-1\"\r\nreids:6379> xadd mystream * key value\r\n\"1629903486170-0\"\r\nreids:6379> xadd mystream * key value\r\n\"1629903486920-0\"\r\nreids:6379> xadd mystream * key value\r\n\"1629903487256-0\"\r\nreids:6379> xadd mystream * key value\r\n\"1629903487544-0\"\r\nreids:6379> xread STREAMS mystream 0-0\r\n1) 1) \"mystream\"\r\n   2) 1) 1) \"10-1\"\r\n         2) 1) \"key\"\r\n            2) \"value\"\r\n      2) 1) \"1629903486170-0\"\r\n         2) 1) \"key\"\r\n            2) \"value\"\r\n      3) 1) \"1629903486920-0\"\r\n         2) 1) \"key\"\r\n            2) \"value\"\r\n      4) 1) \"1629903487256-0\"\r\n         2) 1) \"key\"\r\n            2) \"value\"\r\n      5) 1) \"1629903487544-0\"\r\n         2) 1) \"key\"\r\n            2) \"value\"\r\nreids:6379> xtrim mystream MINID 1629903486920-0\r\n(integer) 5\r\nreids:6379> xread STREAMS mystream 0-0\r\n(nil)\r\n```\r\nNote that all messages got removed from the stream.\r\n\r\n**Expected behavior**\r\nOnly messages with IDs lower than `1629903486920-0` get removed. In this case, they would be `1629903486170-0` and `10-1`.\r\n\r\n**Additional Information**\r\nReproduced locally on a single redis node running as a container (imageId=ddcca4b8a6f0), redis_version=6.2.5.\r\nI was also able to reproduce the problem using a java client (lettuce), so most likely this is not related to redis-cli.","closed_by":{"login":"oranagra","id":7045099,"node_id":"MDQ6VXNlcjcwNDUwOTk=","avatar_url":"https://avatars.githubusercontent.com/u/7045099?v=4","gravatar_id":"","url":"https://api.github.com/users/oranagra","html_url":"https://github.com/oranagra","followers_url":"https://api.github.com/users/oranagra/followers","following_url":"https://api.github.com/users/oranagra/following{/other_user}","gists_url":"https://api.github.com/users/oranagra/gists{/gist_id}","starred_url":"https://api.github.com/users/oranagra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/oranagra/subscriptions","organizations_url":"https://api.github.com/users/oranagra/orgs","repos_url":"https://api.github.com/users/oranagra/repos","events_url":"https://api.github.com/users/oranagra/events{/privacy}","received_events_url":"https://api.github.com/users/oranagra/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/redis/issues/9410/reactions","total_count":1,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":1},"timeline_url":"https://api.github.com/repos/redis/redis/issues/9410/timeline","performed_via_github_app":null,"state_reason":"completed"}