{"url":"https://api.github.com/repos/redis/redis/issues/11578","repository_url":"https://api.github.com/repos/redis/redis","labels_url":"https://api.github.com/repos/redis/redis/issues/11578/labels{/name}","comments_url":"https://api.github.com/repos/redis/redis/issues/11578/comments","events_url":"https://api.github.com/repos/redis/redis/issues/11578/events","html_url":"https://github.com/redis/redis/issues/11578","id":1475330034,"node_id":"I_kwDOAAJhcs5X77_y","number":11578,"title":"[CRASH] ZINTER betwen SET and ZSET crashes","user":{"login":"hbina","id":6733660,"node_id":"MDQ6VXNlcjY3MzM2NjA=","avatar_url":"https://avatars.githubusercontent.com/u/6733660?v=4","gravatar_id":"","url":"https://api.github.com/users/hbina","html_url":"https://github.com/hbina","followers_url":"https://api.github.com/users/hbina/followers","following_url":"https://api.github.com/users/hbina/following{/other_user}","gists_url":"https://api.github.com/users/hbina/gists{/gist_id}","starred_url":"https://api.github.com/users/hbina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hbina/subscriptions","organizations_url":"https://api.github.com/users/hbina/orgs","repos_url":"https://api.github.com/users/hbina/repos","events_url":"https://api.github.com/users/hbina/events{/privacy}","received_events_url":"https://api.github.com/users/hbina/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2022-12-05T00:13:29Z","updated_at":"2022-12-09T15:08:03Z","closed_at":"2022-12-09T15:08:02Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Crash report**\r\n\r\nPaste the complete crash log between the quotes below. Please include a few lines from the log preceding the crash report to provide some context.\r\n\r\n```\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n51320:M 05 Dec 2022 08:10:35.109 # ------------------------------------------------\r\n51320:M 05 Dec 2022 08:10:35.109 # !!! Software Failure. Press left mouse button to continue\r\n51320:M 05 Dec 2022 08:10:35.109 # Guru Meditation: Unknown set encoding #t_zset.c:2279\r\n\r\n------ STACK TRACE ------\r\n\r\nBacktrace:\r\n/home/hbina/git/redis/src/redis-server 127.0.0.1:6379(+0xee79f)[0x55555564279f]\r\n/home/hbina/git/redis/src/redis-server 127.0.0.1:6379(zunionInterDiffGenericCommand+0xbda)[0x55555564347a]\r\n/home/hbina/git/redis/src/redis-server 127.0.0.1:6379(call+0xe2)[0x5555555dcae2]\r\n/home/hbina/git/redis/src/redis-server 127.0.0.1:6379(processCommand+0xb10)[0x5555555de020]\r\n/home/hbina/git/redis/src/redis-server 127.0.0.1:6379(processInputBuffer+0x107)[0x5555555febd7]\r\n/home/hbina/git/redis/src/redis-server 127.0.0.1:6379(readQueryFromClient+0x348)[0x5555555ff138]\r\n/home/hbina/git/redis/src/redis-server 127.0.0.1:6379(+0x1ade9c)[0x555555701e9c]\r\n/home/hbina/git/redis/src/redis-server 127.0.0.1:6379(aeMain+0xf1)[0x5555555d2ab1]\r\n/home/hbina/git/redis/src/redis-server 127.0.0.1:6379(main+0x3d4)[0x5555555c8254]\r\n/lib/x86_64-linux-gnu/libc.so.6(+0x29d90)[0x7ffff7c29d90]\r\n/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0x80)[0x7ffff7c29e40]\r\n/home/hbina/git/redis/src/redis-server 127.0.0.1:6379(_start+0x25)[0x5555555c89b5]\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:255.255.255\r\nredis_git_sha1:61c85a2b\r\nredis_git_dirty:0\r\nredis_build_id:ce6e622df897e510\r\nredis_mode:standalone\r\nos:Linux 6.0.9-060009-generic x86_64\r\narch_bits:64\r\nmonotonic_clock:POSIX clock_gettime\r\nmultiplexing_api:epoll\r\natomicvar_api:c11-builtin\r\ngcc_version:11.3.0\r\nprocess_id:51320\r\nprocess_supervised:no\r\nrun_id:bfb2eb674e0616154f7e79c17e39fbfc7c5b340f\r\ntcp_port:6379\r\nserver_time_usec:1670199035109087\r\nuptime_in_seconds:117\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:9254651\r\nexecutable:/home/hbina/git/redis/src/redis-server\r\nconfig_file:/home/hbina/git/redis/redis.conf\r\nio_threads_active:0\r\nlistener0:name=tcp,bind=127.0.0.1,bind=-::1,port=6379\r\n\r\n# Clients\r\nconnected_clients:1\r\ncluster_connections:0\r\nmaxclients:10000\r\nclient_recent_max_input_buffer:20480\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:990144\r\nused_memory_human:966.94K\r\nused_memory_rss:7516160\r\nused_memory_rss_human:7.17M\r\nused_memory_peak:1112776\r\nused_memory_peak_human:1.06M\r\nused_memory_peak_perc:88.98%\r\nused_memory_overhead:867368\r\nused_memory_startup:865272\r\nused_memory_dataset:122776\r\nused_memory_dataset_perc:98.32%\r\nallocator_allocated:1526896\r\nallocator_active:1904640\r\nallocator_resident:6438912\r\ntotal_system_memory:33047990272\r\ntotal_system_memory_human:30.78G\r\nused_memory_lua:31744\r\nused_memory_vm_eval:31744\r\nused_memory_lua_human:31.00K\r\nused_memory_scripts_eval:0\r\nnumber_of_cached_scripts:0\r\nnumber_of_functions:0\r\nnumber_of_libraries:0\r\nused_memory_vm_functions:32768\r\nused_memory_vm_total:64512\r\nused_memory_vm_total_human:63.00K\r\nused_memory_functions:184\r\nused_memory_scripts:184\r\nused_memory_scripts_human:184B\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:1.25\r\nallocator_frag_bytes:377744\r\nallocator_rss_ratio:3.38\r\nallocator_rss_bytes:4534272\r\nrss_overhead_ratio:1.17\r\nrss_overhead_bytes:1077248\r\nmem_fragmentation_ratio:7.61\r\nmem_fragmentation_bytes:6528912\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:0\r\nmem_total_replication_buffers:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:1800\r\nmem_cluster_links:0\r\nmem_aof_buffer:0\r\nmem_allocator:jemalloc-5.2.1\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\nasync_loading:0\r\ncurrent_cow_peak:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:7\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1670199029\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_saves:0\r\nrdb_last_cow_size:0\r\nrdb_last_load_keys_expired:0\r\nrdb_last_load_keys_loaded:0\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_rewrites:0\r\naof_rewrites_consecutive_failures:0\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:1\r\ntotal_commands_processed:4\r\ninstantaneous_ops_per_sec:0\r\ntotal_net_input_bytes:212\r\ntotal_net_output_bytes:200352\r\ntotal_net_repl_input_bytes:0\r\ntotal_net_repl_output_bytes:0\r\ninstantaneous_input_kbps:0.00\r\ninstantaneous_output_kbps:0.00\r\ninstantaneous_input_repl_kbps:0.00\r\ninstantaneous_output_repl_kbps:0.00\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:3\r\nevicted_keys:0\r\nevicted_clients:0\r\ntotal_eviction_exceeded_time:0\r\ncurrent_eviction_exceeded_time:0\r\nkeyspace_hits:2\r\nkeyspace_misses:0\r\npubsub_channels:0\r\npubsub_patterns:0\r\npubsubshard_channels:0\r\nlatest_fork_usec:0\r\ntotal_forks:0\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntotal_active_defrag_time:0\r\ncurrent_active_defrag_time:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:0\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:5\r\ntotal_writes_processed:6\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\nreply_buffer_shrinks:1\r\nreply_buffer_expands:0\r\nacl_access_denied_auth:0\r\nacl_access_denied_cmd:0\r\nacl_access_denied_key:0\r\nacl_access_denied_channel:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_failover_state:no-failover\r\nmaster_replid:acfdf4ca028008dfe4493fd8694c70987c2b735d\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:0\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:0.132816\r\nused_cpu_user:0.070558\r\nused_cpu_sys_children:0.000000\r\nused_cpu_user_children:0.000000\r\nused_cpu_sys_main_thread:0.132267\r\nused_cpu_user_main_thread:0.070267\r\n\r\n# Modules\r\n\r\n# Commandstats\r\ncmdstat_sadd:calls=1,usec=15,usec_per_call=15.00,rejected_calls=0,failed_calls=0\r\ncmdstat_command|docs:calls=1,usec=1588,usec_per_call=1588.00,rejected_calls=0,failed_calls=0\r\ncmdstat_zadd:calls=1,usec=41,usec_per_call=41.00,rejected_calls=0,failed_calls=0\r\ncmdstat_flushall:calls=1,usec=19022,usec_per_call=19022.00,rejected_calls=0,failed_calls=0\r\n\r\n# Errorstats\r\n\r\n# Latencystats\r\nlatency_percentiles_usec_sadd:p50=15.039,p99=15.039,p99.9=15.039\r\nlatency_percentiles_usec_command|docs:p50=1589.247,p99=1589.247,p99.9=1589.247\r\nlatency_percentiles_usec_zadd:p50=41.215,p99=41.215,p99.9=41.215\r\nlatency_percentiles_usec_flushall:p50=19136.511,p99=19136.511,p99.9=19136.511\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb0:keys=2,expires=0,avg_ttl=0\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=3 addr=127.0.0.1:56792 laddr=127.0.0.1:6379 fd=8 name= age=7 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=41 qbuf-free=20433 argv-mem=13 multi-mem=0 rbs=1024 rbp=0 obl=0 oll=0 omem=0 tot-mem=22317 events=r cmd=zdiff user=default redir=-1 resp=2\r\n\r\n------ CURRENT CLIENT INFO ------\r\nid=3 addr=127.0.0.1:56792 laddr=127.0.0.1:6379 fd=8 name= age=7 idle=0 flags=N db=0 sub=0 psub=0 ssub=0 multi=-1 qbuf=41 qbuf-free=20433 argv-mem=13 multi-mem=0 rbs=1024 rbp=0 obl=0 oll=0 omem=0 tot-mem=22317 events=r cmd=zdiff user=default redir=-1 resp=2\r\nargv[0]: '\"zdiff\"'\r\nargv[1]: '\"2\"'\r\nargv[2]: '\"key\"'\r\nargv[3]: '\"key2\"'\r\n\r\n------ MODULES INFO OUTPUT ------\r\n\r\n------ CONFIG DEBUG OUTPUT ------\r\nclient-query-buffer-limit 1gb\r\nlazyfree-lazy-eviction no\r\nio-threads-do-reads no\r\nreplica-read-only yes\r\nlazyfree-lazy-server-del no\r\nactivedefrag no\r\nlist-compress-depth 0\r\nsanitize-dump-payload no\r\nrepl-diskless-sync yes\r\nlazyfree-lazy-expire no\r\nproto-max-bulk-len 512mb\r\nlazyfree-lazy-user-del no\r\nslave-read-only yes\r\nlazyfree-lazy-user-flush no\r\nrepl-diskless-load disabled\r\nio-threads 1\r\n\r\n------ FAST MEMORY TEST ------\r\n51320:M 05 Dec 2022 08:10:35.116 # Bio thread for job type #0 terminated\r\n51320:M 05 Dec 2022 08:10:35.117 # Bio thread for job type #1 terminated\r\n51320:M 05 Dec 2022 08:10:35.117 # Bio thread for job type #2 terminated\r\n*** Preparing to test memory region 5555558c2000 (2441216 bytes)\r\n*** Preparing to test memory region 7ffff4b7c000 (2621440 bytes)\r\n*** Preparing to test memory region 7ffff4dfd000 (8388608 bytes)\r\n*** Preparing to test memory region 7ffff55fe000 (8388608 bytes)\r\n*** Preparing to test memory region 7ffff5dff000 (8388608 bytes)\r\n*** Preparing to test memory region 7ffff6600000 (8388608 bytes)\r\n*** Preparing to test memory region 7ffff7400000 (8388608 bytes)\r\n*** Preparing to test memory region 7ffff7e1b000 (53248 bytes)\r\n*** Preparing to test memory region 7ffff7eb9000 (16384 bytes)\r\n*** Preparing to test memory region 7ffff7fbb000 (8192 bytes)\r\n.O.O.O.O.O.O.O.O.O.O\r\nFast memory test PASSED, however your memory can still be broken. Please run a memory test for several hours if possible.\r\n\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n\r\n       Please report the crash by opening an issue on github:\r\n\r\n           http://github.com/redis/redis/issues\r\n\r\n  If a Redis module was involved, please open in the module's repo instead.\r\n\r\n  Suspect RAM error? Use redis-server --test-memory to verify it.\r\n\r\n  Some other issues could be detected by redis-server --check-system\r\n```\r\n\r\n**Additional information**\r\n\r\n1. Screenfetch\r\n\r\n```shell\r\nhbina@akarin ~> screenfetch -n\r\n hbina@akarin\r\n OS: Ubuntu 22.04 jammy\r\n Kernel: x86_64 Linux 6.0.9-060009-generic\r\n Uptime: 1h 24m\r\n Packages: 2535\r\n Shell: fish 3.3.1\r\n Resolution: 1920x1080\r\n DE: GNOME 41.7\r\n WM: Mutter\r\n WM Theme: Adwaita\r\n GTK Theme: Yaru-red-dark [GTK2/3]\r\n Icon Theme: Yaru-red\r\n Font: Ubuntu 11\r\n Disk: 290G / 436G (71%)\r\n CPU: AMD Ryzen 7 4800U with Radeon Graphics @ 16x 1.8GHz\r\n GPU: AMD/ATI\r\n RAM: 6676MiB / 31517MiB\r\n ```\r\n \r\n## Reproduction Steps (works every time!)\r\n\r\n1. Build from source (61c85a2b2081dffaf45eb8c6b7754b8d9a80c60d)\r\n2. Run the following commands:\r\n\r\n```shell\r\nhbina@akarin ~/g/redis (unstable)> redis-cli -p 6379\r\n127.0.0.1:6379> zadd key 2 a 7 b 9 d 12 c\r\n(integer) 4\r\n127.0.0.1:6379> sadd key2 a b c\r\n(integer) 3\r\n127.0.0.1:6379> zdiff 2 key key2\r\nError: Server closed the connection\r\n(231.17s)\r\nnot connected>\r\n```\r\n3. Boom\r\n\r\nI tried to look into the source code and the only thing I can worked out is that `key2` is being stored as a `OBJ_ENCODING_LISTPACK` but the [diff algorithm](https://github.com/redis/redis/blob/unstable/src/t_zset.c#L2259-L2280) doesn't consider this possibility and just panics. Adding the following simple change\r\n\r\n```c\r\nelse if (op->encoding == OBJ_ENCODING_LISTPACK) {\r\n            zuiSdsFromValue(val);\r\n            if (zzlFind(op->subject->ptr,val->ele,score) != NULL) {\r\n                /* Score is already set by zzlFind. */\r\n                return 1;\r\n            } else {\r\n                return 0;\r\n            }\r\n        }\r\n```\r\n\r\ndoes not fix the issue becase `zzlFind` will also crash. I tried to debug `zzFind` but debugger doesn't really work (lots of things get optimized out) and its honestly such a mess of code it'll take me a very long time to decipher it. I'd be very interested to know how you fix it!","closed_by":{"login":"oranagra","id":7045099,"node_id":"MDQ6VXNlcjcwNDUwOTk=","avatar_url":"https://avatars.githubusercontent.com/u/7045099?v=4","gravatar_id":"","url":"https://api.github.com/users/oranagra","html_url":"https://github.com/oranagra","followers_url":"https://api.github.com/users/oranagra/followers","following_url":"https://api.github.com/users/oranagra/following{/other_user}","gists_url":"https://api.github.com/users/oranagra/gists{/gist_id}","starred_url":"https://api.github.com/users/oranagra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/oranagra/subscriptions","organizations_url":"https://api.github.com/users/oranagra/orgs","repos_url":"https://api.github.com/users/oranagra/repos","events_url":"https://api.github.com/users/oranagra/events{/privacy}","received_events_url":"https://api.github.com/users/oranagra/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/redis/issues/11578/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/redis/issues/11578/timeline","performed_via_github_app":null,"state_reason":"completed"}