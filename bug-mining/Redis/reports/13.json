{"url":"https://api.github.com/repos/redis/redis/issues/5849","repository_url":"https://api.github.com/repos/redis/redis","labels_url":"https://api.github.com/repos/redis/redis/issues/5849/labels{/name}","comments_url":"https://api.github.com/repos/redis/redis/issues/5849/comments","events_url":"https://api.github.com/repos/redis/redis/issues/5849/events","html_url":"https://github.com/redis/redis/issues/5849","id":411807965,"node_id":"MDU6SXNzdWU0MTE4MDc5NjU=","number":5849,"title":"two slaves which are replicated to one master may have the same IP when use v5.0.3 to build redis cluster service","user":{"login":"clareying100","id":16914173,"node_id":"MDQ6VXNlcjE2OTE0MTcz","avatar_url":"https://avatars.githubusercontent.com/u/16914173?v=4","gravatar_id":"","url":"https://api.github.com/users/clareying100","html_url":"https://github.com/clareying100","followers_url":"https://api.github.com/users/clareying100/followers","following_url":"https://api.github.com/users/clareying100/following{/other_user}","gists_url":"https://api.github.com/users/clareying100/gists{/gist_id}","starred_url":"https://api.github.com/users/clareying100/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clareying100/subscriptions","organizations_url":"https://api.github.com/users/clareying100/orgs","repos_url":"https://api.github.com/users/clareying100/repos","events_url":"https://api.github.com/users/clareying100/events{/privacy}","received_events_url":"https://api.github.com/users/clareying100/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2019-02-19T08:45:14Z","updated_at":"2019-02-21T04:42:07Z","closed_at":null,"author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"We do Redis upgrade work from v4.0.11 to v5.0.3. \r\nUse command “redis-cli --cluster create host1:port1 ... hostN:portN --cluster-replicas 2” to build Redis cluster service.\r\n\r\n\r\n- ### **Our usage scenario**:\r\nWe build a Redis cluster containing 3 masters and 6 slaves.\r\nIn our usage scenario, there are 3 VMs with different IPs and each VM has 3 Redis instances.\r\nSo, the redis cluster will have 3 masters, and each master has two slaves. If mark one master and it’s two slaves as one group, then will have 3 groups.\r\nAfter cluster build successful, \r\nwe expect one master and it’s two slaves all with different IP in each group. Also expect when two of the three VMs down, the Redis cluster still can provide service.\r\n\r\n\r\n- ### **Test result:**\r\nActual test results are show, there’s high probability that two slaves which are replicated to one master will have the same IP. **But this has not appeared in version Redis 4.0.11.**\r\nResult show as below:\r\n192.168.1.13:6380> cluster nodes\r\n**8a973e82efbda4afcb664539b3a2b827700e1b73** 192.168.1.13:6380@16380 myself,master - 0 1550212750000 1 connected 0-5460\r\n180091e5775db8bfc215eea311a7bfaa821c4b54 192.168.1.20:6381@16381 slave **8a973e82efbda4afcb664539b3a2b827700e1b73** 0 1550212750915 8 connected\r\n5202b88ace54fc9eada6df32b8c64d7268700eb2 192.168.1.20:6382@16382 slave **8a973e82efbda4afcb664539b3a2b827700e1b73** 0 1550212750915 9 connected\r\nda48b6e77d9afb4ad0e906389befc9428358c8db 192.168.1.18:6380@16380 master - 0 1550212750915 4 connected 5461-10922\r\nb6fb8391eaff9ec39b50243adce4671393a4e884 192.168.1.13:6381@16381 slave da48b6e77d9afb4ad0e906389befc9428358c8db 0 1550212750915 4 connected\r\n8be87c36872a73eccfe1de644a909f71cc843734 192.168.1.13:6382@16382 slave da48b6e77d9afb4ad0e906389befc9428358c8db 0 1550212750915 4 connected\r\nf8ae2618b3aa9a5714cdee9544f7f6e01c1de838 192.168.1.20:6380@16380 master - 0 1550212750915 7 connected 10923-16383\r\n2e935a58e4522c3e581e9116c47e00685a7fcab8 192.168.1.18:6381@16381 slave f8ae2618b3aa9a5714cdee9544f7f6e01c1de838 0 1550212750915 7 connected\r\nb6d1ff664367fa815647e0f0ff65a08c9e75b202 192.168.1.18:6382@16382 slave f8ae2618b3aa9a5714cdee9544f7f6e01c1de838 0 1550212750915 7 connected\r\n\r\nEach master have his two slave, but these two slaves have the same IP.\r\nIf this happens, then the algorithm used in function clusterManagerOptimizeAntiAffinity will not work, no matter how many times you loop.\r\nIf this happens, when two of the three VMs down, the Redis cluster will failed and can’t provide service.\r\n\r\n\r\n- ### **Summary:**\r\nThere is no problem when use “redis-trib” command to create Redis cluster service in version 4.0.11, but have this issue when use “redis-cli --cluster” command in v5.0.3.\r\n\r\n\r\nSo I post this ticket to raise this issues. And have a patch to fix it. If you had noticed this issue and have better solution you can ignore it. Thanks.\r\n","closed_by":null,"reactions":{"url":"https://api.github.com/repos/redis/redis/issues/5849/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/redis/issues/5849/timeline","performed_via_github_app":null,"state_reason":null}