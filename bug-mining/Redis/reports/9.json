{"url":"https://api.github.com/repos/redis/redis/issues/5570","repository_url":"https://api.github.com/repos/redis/redis","labels_url":"https://api.github.com/repos/redis/redis/issues/5570/labels{/name}","comments_url":"https://api.github.com/repos/redis/redis/issues/5570/comments","events_url":"https://api.github.com/repos/redis/redis/issues/5570/events","html_url":"https://github.com/redis/redis/issues/5570","id":380800713,"node_id":"MDU6SXNzdWUzODA4MDA3MTM=","number":5570,"title":"XREADGROUP repeats entries when using XADD with MAXLEN","user":{"login":"alex-appetiti","id":7533268,"node_id":"MDQ6VXNlcjc1MzMyNjg=","avatar_url":"https://avatars.githubusercontent.com/u/7533268?v=4","gravatar_id":"","url":"https://api.github.com/users/alex-appetiti","html_url":"https://github.com/alex-appetiti","followers_url":"https://api.github.com/users/alex-appetiti/followers","following_url":"https://api.github.com/users/alex-appetiti/following{/other_user}","gists_url":"https://api.github.com/users/alex-appetiti/gists{/gist_id}","starred_url":"https://api.github.com/users/alex-appetiti/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alex-appetiti/subscriptions","organizations_url":"https://api.github.com/users/alex-appetiti/orgs","repos_url":"https://api.github.com/users/alex-appetiti/repos","events_url":"https://api.github.com/users/alex-appetiti/events{/privacy}","received_events_url":"https://api.github.com/users/alex-appetiti/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2018-11-14T17:12:22Z","updated_at":"2018-11-19T17:40:13Z","closed_at":"2018-11-19T16:04:16Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Probably related to: https://github.com/antirez/redis/issues/5544\r\n\r\n## Context\r\nConsider the following scenario (redis 5.0.0):\r\n```\r\n> XGROUP CREATE mystream mygroup $ mkstream\r\nOK\r\n> XADD mystream 1 field1 value1\r\n\"1-0\"\r\n> XREADGROUP GROUP mygroup myconsumer STREAMS mystream >\r\n1) 1) \"mystream\"\r\n   2) 1) 1) \"1-0\"\r\n      2) 1) \"field1\"\r\n         2) \"value1\"\r\n> XADD mystream MAXLEN 1 2 field1 value2\r\n\"2-0\"\r\n> XREADGROUP GROUP mygroup myconsumer STREAMS mystream >\r\n1) 1) \"mystream\"\r\n   2) 1) 1) \"2-0\"\r\n      2) 1) \"field1\"\r\n         2) \"value2\"\r\n```\r\n`myconsumer` now has two pending entries, which we can see via `XPENDING`:\r\n```\r\n> XPENDING mystream mygroup\r\n1) (integer) 2\r\n2) \"1-0\"\r\n3) \"2-0\"\r\n4) 1) 1) \"myconsumer\"\r\n      2) \"2\"\r\n```\r\nHowever things get weird when I try and see the pending entries:\r\n```\r\n> XREADGROUP GROUP mygroup myconsumer STREAMS mystream 0-1\r\n1) 1) \"mystream\"\r\n   2) 1) 1) \"2-0\"\r\n         2) 1) \"field1\"\r\n            2) \"value2\"\r\n      2) 1) \"2-0\"\r\n         2) 1) \"field1\"\r\n            2) \"value2\"\r\n```\r\nAlthough it is correct that there are two elements that are pending, they are duplicates of the entry associated with `2-0`.\r\n\r\nIs this behaviour expected?\r\n\r\nI thought it might also be worth mentioning the following:\r\n\r\nBy calling `XACK mystream mygroup` on `1-0` and `2-0`, the entries in `XPENDING` and `XREADGROUP ... 0-1` get cleared up correctly.\r\n\r\nFurthermore, `XPENDING mystream mygroup - + 2` works as expected, returning the correct un-acked ids.\r\n\r\n## Discussion\r\nFirstly, I appreciate this is a rare edge case in the wild - the only scenario in which this can happen is if the consumer is so slow that the stream culls the message its processing before it can `XACK` it. This is possible if the `MAXLEN` parameter in `XADD` is misconfigured.\r\n\r\nWould there be any downside to automatically `XACK`ing (or just removing from the PEL) messages that get culled in this way?\r\n\r\nAside from clients needing to be able to handle the case described above, in the context of consumers `XCLAIM`ing messages we have the following:\r\n```\r\n> XCLAIM mystream mygroup myconsumer2 0 1-0\r\n1) 1) \"2-0\"\r\n   2) 1) \"field1\"\r\n      2) \"value2\"\r\n```\r\n\r\n`XACK` in this scenario loses part of its meaning, and only serves to free up Redis memory (by removing it from the PEL). Further, consumers run this risk of processing the wrong message, or the same message multiple times.\r\n","closed_by":{"login":"antirez","id":65632,"node_id":"MDQ6VXNlcjY1NjMy","avatar_url":"https://avatars.githubusercontent.com/u/65632?v=4","gravatar_id":"","url":"https://api.github.com/users/antirez","html_url":"https://github.com/antirez","followers_url":"https://api.github.com/users/antirez/followers","following_url":"https://api.github.com/users/antirez/following{/other_user}","gists_url":"https://api.github.com/users/antirez/gists{/gist_id}","starred_url":"https://api.github.com/users/antirez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antirez/subscriptions","organizations_url":"https://api.github.com/users/antirez/orgs","repos_url":"https://api.github.com/users/antirez/repos","events_url":"https://api.github.com/users/antirez/events{/privacy}","received_events_url":"https://api.github.com/users/antirez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/redis/issues/5570/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/redis/issues/5570/timeline","performed_via_github_app":null,"state_reason":"completed"}