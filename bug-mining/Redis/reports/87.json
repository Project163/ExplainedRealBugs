{"url":"https://api.github.com/repos/redis/redis/issues/11894","repository_url":"https://api.github.com/repos/redis/redis","labels_url":"https://api.github.com/repos/redis/redis/issues/11894/labels{/name}","comments_url":"https://api.github.com/repos/redis/redis/issues/11894/comments","events_url":"https://api.github.com/repos/redis/redis/issues/11894/events","html_url":"https://github.com/redis/redis/issues/11894","id":1616886309,"node_id":"I_kwDOAAJhcs5gX7ol","number":11894,"title":"[BUG] reprocessed block commands go through module command filter again, but used cached lookup","user":{"login":"sjpotter","id":1659735,"node_id":"MDQ6VXNlcjE2NTk3MzU=","avatar_url":"https://avatars.githubusercontent.com/u/1659735?v=4","gravatar_id":"","url":"https://api.github.com/users/sjpotter","html_url":"https://github.com/sjpotter","followers_url":"https://api.github.com/users/sjpotter/followers","following_url":"https://api.github.com/users/sjpotter/following{/other_user}","gists_url":"https://api.github.com/users/sjpotter/gists{/gist_id}","starred_url":"https://api.github.com/users/sjpotter/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sjpotter/subscriptions","organizations_url":"https://api.github.com/users/sjpotter/orgs","repos_url":"https://api.github.com/users/sjpotter/repos","events_url":"https://api.github.com/users/sjpotter/events{/privacy}","received_events_url":"https://api.github.com/users/sjpotter/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2023-03-09T10:21:55Z","updated_at":"2023-03-20T06:04:15Z","closed_at":"2023-03-20T06:04:15Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\n\r\nIn working with https://github.com/redis/redis/pull/11568, I have a module that I was issuing a brpoplpush in blocking mode, but also filtering it to add an argument to the front of the command (so it was no longer a brpoplpush, but something I'd wrap and issue an underlying brpoplpush).\r\n\r\nBut, I was getting an error that it had an invalid timeout.  In inspecting it, it seemed it was trying to calculate a timeout on what would have been the argv[2] (i.e. dest key), but it was now at argv[3].\r\n\r\nwas really confused, till @MeirShpilraien figured out when I mentioned command filter.\r\n\r\nthe existing code does\r\n\r\n```\r\n    moduleCallCommandFilters(c);\r\n\r\n     /* in case we are starting to ProcessCommand and we already have a command we assume\r\n      * this is a reprocessing of this command, so we do not want to perform some of the actions again. */\r\n     int client_reprocessing_command = c->cmd ? 1 : 0;\r\n```\r\n\r\nthe problem is below, the code does\r\n\r\n```\r\n    if (!client_reprocessing_command) {\r\n        c->cmd = c->lastcmd = c->realcmd = lookupCommand(c->argv,c->argc);\r\n    ...\r\n    }\r\n```\r\n\r\ni.e. it cached the lookup.\r\n\r\nFor progress purposes I changed the code to \r\n\r\n```\r\n     /* in case we are starting to ProcessCommand and we already have a command we assume\r\n      * this is a reprocessing of this command, so we do not want to perform some of the actions again. */\r\n     int client_reprocessing_command = c->cmd ? 1 : 0;\r\n \r\n    /* only run command filter if not reprocessing command */\r\n    if (!client_reprocessing_command) {\r\n        moduleCallCommandFilters(c);\r\n    }\r\n```\r\n\r\nand caching the lookup is now fine.\r\n\r\nbut that's not necessarily the correct fix.\r\n\r\nThe Q to answer is, should the command filter be run when a command is reprocessed.  If the answer is yes, we can't cache the lookup.  If a command that is reprocessed should run exactly as it did before, then the answer is that it shouldn't be run through the command filter and caching is fine.  \r\n\r\nMy feeling is that caching is fine, and shouldn't run through command filter again, but perhaps there are use cases where it would need to (But then can't ever cache, at least if run through a filter, and then would have to modify filter callbacks to indicate if they modified the argv or not)\r\n\r\n**To reproduce**\r\n\r\na module that uses a command filter to change execution of a command that will block.\r\n\r\n**Expected behavior**\r\n\r\ndescribed above, but to repeat\r\n\r\nThe Q to answer is, should the command filter be run when a command is reprocessed.  If the answer is yes, we can't cache the lookup.  If a command that is reprocessed should run exactly as it did before, then the answer is that it shouldn't be run through the command filter and caching is fine.  \r\n","closed_by":{"login":"oranagra","id":7045099,"node_id":"MDQ6VXNlcjcwNDUwOTk=","avatar_url":"https://avatars.githubusercontent.com/u/7045099?v=4","gravatar_id":"","url":"https://api.github.com/users/oranagra","html_url":"https://github.com/oranagra","followers_url":"https://api.github.com/users/oranagra/followers","following_url":"https://api.github.com/users/oranagra/following{/other_user}","gists_url":"https://api.github.com/users/oranagra/gists{/gist_id}","starred_url":"https://api.github.com/users/oranagra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/oranagra/subscriptions","organizations_url":"https://api.github.com/users/oranagra/orgs","repos_url":"https://api.github.com/users/oranagra/repos","events_url":"https://api.github.com/users/oranagra/events{/privacy}","received_events_url":"https://api.github.com/users/oranagra/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/redis/issues/11894/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/redis/issues/11894/timeline","performed_via_github_app":null,"state_reason":"completed"}