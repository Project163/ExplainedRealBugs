{"url":"https://api.github.com/repos/redis/redis/issues/6842","repository_url":"https://api.github.com/repos/redis/redis","labels_url":"https://api.github.com/repos/redis/redis/issues/6842/labels{/name}","comments_url":"https://api.github.com/repos/redis/redis/issues/6842/comments","events_url":"https://api.github.com/repos/redis/redis/issues/6842/events","html_url":"https://github.com/redis/redis/issues/6842","id":560816416,"node_id":"MDU6SXNzdWU1NjA4MTY0MTY=","number":6842,"title":"Writable replica may use the data of expired keys","user":{"login":"guybe7","id":19590683,"node_id":"MDQ6VXNlcjE5NTkwNjgz","avatar_url":"https://avatars.githubusercontent.com/u/19590683?v=4","gravatar_id":"","url":"https://api.github.com/users/guybe7","html_url":"https://github.com/guybe7","followers_url":"https://api.github.com/users/guybe7/followers","following_url":"https://api.github.com/users/guybe7/following{/other_user}","gists_url":"https://api.github.com/users/guybe7/gists{/gist_id}","starred_url":"https://api.github.com/users/guybe7/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/guybe7/subscriptions","organizations_url":"https://api.github.com/users/guybe7/orgs","repos_url":"https://api.github.com/users/guybe7/repos","events_url":"https://api.github.com/users/guybe7/events{/privacy}","received_events_url":"https://api.github.com/users/guybe7/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/redis/redis/milestones/11","html_url":"https://github.com/redis/redis/milestone/11","labels_url":"https://api.github.com/repos/redis/redis/milestones/11/labels","id":5684243,"node_id":"MDk6TWlsZXN0b25lNTY4NDI0Mw==","number":11,"title":"Next major backlog","description":"","creator":{"login":"oranagra","id":7045099,"node_id":"MDQ6VXNlcjcwNDUwOTk=","avatar_url":"https://avatars.githubusercontent.com/u/7045099?v=4","gravatar_id":"","url":"https://api.github.com/users/oranagra","html_url":"https://github.com/oranagra","followers_url":"https://api.github.com/users/oranagra/followers","following_url":"https://api.github.com/users/oranagra/following{/other_user}","gists_url":"https://api.github.com/users/oranagra/gists{/gist_id}","starred_url":"https://api.github.com/users/oranagra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/oranagra/subscriptions","organizations_url":"https://api.github.com/users/oranagra/orgs","repos_url":"https://api.github.com/users/oranagra/repos","events_url":"https://api.github.com/users/oranagra/events{/privacy}","received_events_url":"https://api.github.com/users/oranagra/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":22,"closed_issues":9,"state":"open","created_at":"2020-07-21T09:08:33Z","updated_at":"2024-03-23T22:31:04Z","due_on":null,"closed_at":null},"comments":16,"created_at":"2020-02-06T06:55:24Z","updated_at":"2021-11-28T09:26:29Z","closed_at":"2021-11-28T09:26:29Z","author_association":"COLLABORATOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"for example, using SUNIONSTORE:\r\n\r\nmaster:\r\n```\r\n127.0.0.1:6379> DEBUG set-active-expire 0\r\nOK\r\n127.0.0.1:6379> SADD s1 a b c\r\n(integer) 3\r\n127.0.0.1:6379> SADD s2 1 2 3\r\n(integer) 3\r\n127.0.0.1:6379> EXPIRE s1 5\r\n(integer) 1\r\n```\r\n\r\nreplica:\r\n```\r\n127.0.0.1:12345> REPLICAOF localhost 6379\r\nOK\r\n127.0.0.1:12345> CONFIG SET replica-read-only no\r\nOK\r\n127.0.0.1:12345> DEBUG set-active-expire 0\r\nOK\r\n127.0.0.1:12345> SMEMBERS s1\r\n1) \"b\"\r\n2) \"a\"\r\n3) \"c\"\r\n127.0.0.1:12345> SMEMBERS s2\r\n1) \"1\"\r\n2) \"2\"\r\n3) \"3\"\r\n127.0.0.1:12345> DEBUG sleep 6\r\nOK\r\n(6.00s)\r\n127.0.0.1:12345> SMEMBERS s1\r\n(empty array)\r\n127.0.0.1:12345> SUNIONSTORE s3 s1 s2\r\n(integer) 6\r\n127.0.0.1:12345> SMEMBERS s3\r\n1) \"1\"\r\n2) \"c\"\r\n3) \"3\"\r\n4) \"b\"\r\n5) \"a\"\r\n6) \"2\"\r\n```\r\n\r\nThe problem is that `lookupKeyRead` behaves differently than `lookupKeyWrite` in the context of writable replicas with expiration.\r\nActually, I'm not even sure why the source sets are opened in write-mode.. Is there a reason for that?\r\nThe same problem affects SUNIONSTORE, SDIFFSTORE, SINTERSTORE, ZUNIONSTORE and ZINTERSTORE. For those commands it's enough to just use `lookupKeyRead` but the occurs in other commands that modify existing value (e.g. INCR, APPEND, etc.):\r\n\r\nmaster:\r\n```\r\n127.0.0.1:6379> DEBUG set-active-expire 0\r\nOK\r\n127.0.0.1:6379> SET c 100\r\nOK\r\n127.0.0.1:6379> EXPIRE c 5\r\n(integer) 1\r\n```\r\n\r\nreplica:\r\n```\r\n127.0.0.1:12345> REPLICAOF localhost 6379\r\nOK\r\n127.0.0.1:12345> DEBUG set-active-expire 0\r\nOK\r\n127.0.0.1:12345> CONFIG SET replica-read-only no\r\nOK\r\n127.0.0.1:12345> GET c\r\n\"100\"\r\n127.0.0.1:12345> DEBUG sleep 6\r\nOK\r\n(6.00s)\r\n127.0.0.1:12345> GET c\r\n(nil)\r\n127.0.0.1:12345> INCR c\r\n(integer) 101\r\n``` \r\n\r\nThe solution is either to mirror that logic from `lookupKeyRead` into `lookupKeyWrite`, or eliminate the latter and share code.\r\n","closed_by":{"login":"oranagra","id":7045099,"node_id":"MDQ6VXNlcjcwNDUwOTk=","avatar_url":"https://avatars.githubusercontent.com/u/7045099?v=4","gravatar_id":"","url":"https://api.github.com/users/oranagra","html_url":"https://github.com/oranagra","followers_url":"https://api.github.com/users/oranagra/followers","following_url":"https://api.github.com/users/oranagra/following{/other_user}","gists_url":"https://api.github.com/users/oranagra/gists{/gist_id}","starred_url":"https://api.github.com/users/oranagra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/oranagra/subscriptions","organizations_url":"https://api.github.com/users/oranagra/orgs","repos_url":"https://api.github.com/users/oranagra/repos","events_url":"https://api.github.com/users/oranagra/events{/privacy}","received_events_url":"https://api.github.com/users/oranagra/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/redis/issues/6842/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/redis/issues/6842/timeline","performed_via_github_app":null,"state_reason":"completed"}