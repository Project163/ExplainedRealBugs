{"url":"https://api.github.com/repos/redis/redis/issues/4527","repository_url":"https://api.github.com/repos/redis/redis","labels_url":"https://api.github.com/repos/redis/redis/issues/4527/labels{/name}","comments_url":"https://api.github.com/repos/redis/redis/issues/4527/comments","events_url":"https://api.github.com/repos/redis/redis/issues/4527/events","html_url":"https://github.com/redis/redis/issues/4527","id":281212612,"node_id":"MDU6SXNzdWUyODEyMTI2MTI=","number":4527,"title":"Off-by-one read in stringmatchlen()","user":{"login":"ghost","id":10137,"node_id":"MDQ6VXNlcjEwMTM3","avatar_url":"https://avatars.githubusercontent.com/u/10137?v=4","gravatar_id":"","url":"https://api.github.com/users/ghost","html_url":"https://github.com/ghost","followers_url":"https://api.github.com/users/ghost/followers","following_url":"https://api.github.com/users/ghost/following{/other_user}","gists_url":"https://api.github.com/users/ghost/gists{/gist_id}","starred_url":"https://api.github.com/users/ghost/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ghost/subscriptions","organizations_url":"https://api.github.com/users/ghost/orgs","repos_url":"https://api.github.com/users/ghost/repos","events_url":"https://api.github.com/users/ghost/events{/privacy}","received_events_url":"https://api.github.com/users/ghost/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2017-12-12T00:15:12Z","updated_at":"2017-12-14T11:21:33Z","closed_at":"2017-12-14T11:21:33Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"In [`utils.c`](https://github.com/antirez/redis/blob/unstable/src/util.c#L47), `stringmatchlen` implements a pattern-matching function which is then called by various commands (eg. `KEYS`). \r\nWhen handling an expression starting with `[\\`, the following code block is reached:\r\nhttps://github.com/antirez/redis/blob/522760fac79536eb68dc5fc70e9166f689eb76dc/src/util.c#L87-L91\r\nPointer `pattern` is incremented and then `pattern[0]` is accessed, but nothing tries to make sure that `patternLen` is still greater than 0, leading to a off-by-one read (here compiled with `-fsanitize=address`:\r\n\r\n```\r\n./src/redis-server\r\n5630:C 12 Dec 01:08:14.910 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo\r\n5630:C 12 Dec 01:08:14.911 # Redis version=999.999.999, bits=64, commit=522760fa, modified=1, pid=5630, just started\r\n5630:C 12 Dec 01:08:14.911 # Warning: no config file specified, using the default config. In order to specify a config file use ./src/redis-server /path/to/redis.conf\r\n5630:M 12 Dec 01:08:14.914 * Increased maximum number of open files to 10032 (it was originally set to 7168).\r\n                _._\r\n           _.-``__ ''-._\r\n      _.-``    `.  `_.  ''-._           Redis 999.999.999 (522760fa/1) 64 bit\r\n  .-`` .-```.  ```\\/    _.,_ ''-._\r\n (    '      ,       .-`  | `,    )     Running in standalone mode\r\n |`-._`-...-` __...-.``-._|'` _.-'|     Port: 6379\r\n |    `-._   `._    /     _.-'    |     PID: 5630\r\n  `-._    `-._  `-./  _.-'    _.-'\r\n |`-._`-._    `-.__.-'    _.-'_.-'|\r\n |    `-._`-._        _.-'_.-'    |           http://redis.io\r\n  `-._    `-._`-.__.-'_.-'    _.-'\r\n |`-._`-._    `-.__.-'    _.-'_.-'|\r\n |    `-._`-._        _.-'_.-'    |\r\n  `-._    `-._`-.__.-'_.-'    _.-'\r\n      `-._    `-.__.-'    _.-'\r\n          `-._        _.-'\r\n              `-.__.-'\r\n\r\n5630:M 12 Dec 01:08:14.918 # Server initialized\r\n5630:M 12 Dec 01:08:14.918 * DB loaded from disk: 0.000 seconds\r\n5630:M 12 Dec 01:08:14.918 * Ready to accept connections\r\n=================================================================\r\n==5630==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x603000009ec6 at pc 0x000104feaaf4 bp 0x7ffeeac7d180 sp 0x7ffeeac7d178\r\nREAD of size 1 at 0x603000009ec6 thread T0\r\n    #0 0x104feaaf3 in stringmatchlen util.c\r\n    #1 0x104ffb812 in keysCommand db.c:521\r\n    #2 0x104fa82ec in call server.c:2242\r\n    #3 0x104fa9f90 in processCommand server.c:2524\r\n    #4 0x104fe4ead in processInputBuffer networking.c:1363\r\n    #5 0x104f8f5fa in aeProcessEvents ae.c:421\r\n    #6 0x104f90290 in aeMain ae.c:464\r\n    #7 0x104fb2328 in main server.c:3912\r\n    #8 0x7fff626ca144 in start (libdyld.dylib:x86_64+0x1144)\r\n\r\n0x603000009ec6 is located 0 bytes to the right of 22-byte region [0x603000009eb0,0x603000009ec6)\r\nallocated by thread T0 here:\r\n    #0 0x10540ba83 in wrap_malloc (libclang_rt.asan_osx_dynamic.dylib:x86_64h+0x56a83)\r\n    #1 0x104fc107e in zmalloc zmalloc.c:98\r\n    #2 0x104fedd81 in createStringObject object.c:85\r\n    #3 0x104fe3bfa in processMultibulkBuffer networking.c:1302\r\n    #4 0x104fe4e71 in processInputBuffer networking.c:1353\r\n    #5 0x104f8f5fa in aeProcessEvents ae.c:421\r\n    #6 0x104f90290 in aeMain ae.c:464\r\n    #7 0x104fb2328 in main server.c:3912\r\n    #8 0x7fff626ca144 in start (libdyld.dylib:x86_64+0x1144)\r\n\r\nSUMMARY: AddressSanitizer: heap-buffer-overflow util.c in stringmatchlen\r\nShadow bytes around the buggy address:\r\n  0x1c0600001380: fa fa fd fd fd fa fa fa fd fd fd fa fa fa fd fd\r\n  0x1c0600001390: fd fa fa fa fd fd fd fa fa fa fd fd fd fa fa fa\r\n  0x1c06000013a0: fd fd fd fa fa fa fd fd fd fa fa fa fd fd fd fa\r\n  0x1c06000013b0: fa fa fd fd fd fa fa fa fd fd fd fa fa fa fd fd\r\n  0x1c06000013c0: fd fa fa fa fd fd fd fa fa fa fd fd fd fa fa fa\r\n=>0x1c06000013d0: 00 00 00 fa fa fa 00 00[06]fa fa fa 00 00 00 fa\r\n  0x1c06000013e0: fa fa 00 00 00 fa fa fa fa fa fa fa fa fa fa fa\r\n  0x1c06000013f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\r\n  0x1c0600001400: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\r\n  0x1c0600001410: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\r\n  0x1c0600001420: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\r\nShadow byte legend (one shadow byte represents 8 application bytes):\r\n  Addressable:           00\r\n  Partially addressable: 01 02 03 04 05 06 07\r\n  Heap left redzone:       fa\r\n  Freed heap region:       fd\r\n  Stack left redzone:      f1\r\n  Stack mid redzone:       f2\r\n  Stack right redzone:     f3\r\n  Stack after return:      f5\r\n  Stack use after scope:   f8\r\n  Global redzone:          f9\r\n  Global init order:       f6\r\n  Poisoned by user:        f7\r\n  Container overflow:      fc\r\n  Array cookie:            ac\r\n  Intra object redzone:    bb\r\n  ASan internal:           fe\r\n  Left alloca redzone:     ca\r\n  Right alloca redzone:    cb\r\n==5630==ABORTING\r\n[1]    5630 abort      ./src/redis-server\r\n```","closed_by":{"login":"antirez","id":65632,"node_id":"MDQ6VXNlcjY1NjMy","avatar_url":"https://avatars.githubusercontent.com/u/65632?v=4","gravatar_id":"","url":"https://api.github.com/users/antirez","html_url":"https://github.com/antirez","followers_url":"https://api.github.com/users/antirez/followers","following_url":"https://api.github.com/users/antirez/following{/other_user}","gists_url":"https://api.github.com/users/antirez/gists{/gist_id}","starred_url":"https://api.github.com/users/antirez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antirez/subscriptions","organizations_url":"https://api.github.com/users/antirez/orgs","repos_url":"https://api.github.com/users/antirez/repos","events_url":"https://api.github.com/users/antirez/events{/privacy}","received_events_url":"https://api.github.com/users/antirez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/redis/issues/4527/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/redis/issues/4527/timeline","performed_via_github_app":null,"state_reason":"completed"}