{"url":"https://api.github.com/repos/redis/redis/issues/8531","repository_url":"https://api.github.com/repos/redis/redis","labels_url":"https://api.github.com/repos/redis/redis/issues/8531/labels{/name}","comments_url":"https://api.github.com/repos/redis/redis/issues/8531/comments","events_url":"https://api.github.com/repos/redis/redis/issues/8531/events","html_url":"https://github.com/redis/redis/issues/8531","id":814250973,"node_id":"MDU6SXNzdWU4MTQyNTA5NzM=","number":8531,"title":"[BUG] Redis fails to compile if HAVE_MALLOC_SIZE is not defined","user":{"login":"botovq","id":11229187,"node_id":"MDQ6VXNlcjExMjI5MTg3","avatar_url":"https://avatars.githubusercontent.com/u/11229187?v=4","gravatar_id":"","url":"https://api.github.com/users/botovq","html_url":"https://github.com/botovq","followers_url":"https://api.github.com/users/botovq/followers","following_url":"https://api.github.com/users/botovq/following{/other_user}","gists_url":"https://api.github.com/users/botovq/gists{/gist_id}","starred_url":"https://api.github.com/users/botovq/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/botovq/subscriptions","organizations_url":"https://api.github.com/users/botovq/orgs","repos_url":"https://api.github.com/users/botovq/repos","events_url":"https://api.github.com/users/botovq/events{/privacy}","received_events_url":"https://api.github.com/users/botovq/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2021-02-23T08:51:20Z","updated_at":"2021-02-23T15:08:50Z","closed_at":"2021-02-23T15:08:50Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\n\r\nCompiling Redis 6.2.0 on a system without `malloc_usable_size()` or similar with `USE_JEMALLOC=No` results in a build failure. The following is seen on OpenBSD -current (amd64 with clang 10.0.1):\r\n\r\n```\r\nzmalloc.c:60:5: error: function-like macro 'sizeof' is not defined\r\n#if PREFIX_SIZE > 0\r\n    ^\r\nzmalloc.c:56:22: note: expanded from macro 'PREFIX_SIZE'\r\n#define PREFIX_SIZE (sizeof(size_t))\r\n                     ^\r\n1 error generated.\r\n```\r\n\r\nhttps://github.com/redis/redis/blob/8e83bcd2acb18370e2d6cea3718339792322e80f/src/zmalloc.c#L60-L64\r\n\r\nThe issue is that at the preprocessing stage keywords like sizeof do not exist (see C11 6.10, footnote 166), so if HAVE_MALLOC_SIZE is not defined, the above conditional won't be accepted by either clang or gcc.\r\n\r\nhttps://github.com/redis/redis/blob/8e83bcd2acb18370e2d6cea3718339792322e80f/src/zmalloc.c#L50-L58\r\n\r\n**To reproduce**\r\n\r\nCompile Redis 6.2.0 on a system without `malloc_usable_size()` or similar with `USE_JEMALLOC=No`.\r\n\r\n**Expected behavior**\r\n\r\nRedis compiles\r\n\r\n**Additional information**\r\n\r\nI think the following diff would make sense, which I can submit as a PR if that's acceptable.\r\nI expect all versions having a version of https://github.com/redis/redis/pull/8522 to be affected.\r\n\r\n```diff\r\n--- src/zmalloc.c.orig\r\n+++ src/zmalloc.c\r\n@@ -28,6 +28,7 @@\r\n  * POSSIBILITY OF SUCH DAMAGE.\r\n  */\r\n\r\n+#include <assert.h>\r\n #include <stdio.h>\r\n #include <stdlib.h>\r\n #include <stdint.h>\r\n@@ -57,7 +58,7 @@ void zlibc_free(void *ptr) {\r\n #endif\r\n #endif\r\n\r\n-#if PREFIX_SIZE > 0\r\n+#ifndef HAVE_MALLOC_SIZE\r\n #define ASSERT_NO_SIZE_OVERFLOW(sz) assert((sz) + PREFIX_SIZE > (sz))\r\n #else\r\n #define ASSERT_NO_SIZE_OVERFLOW(sz)\r\n```\r\n","closed_by":{"login":"yossigo","id":1481195,"node_id":"MDQ6VXNlcjE0ODExOTU=","avatar_url":"https://avatars.githubusercontent.com/u/1481195?v=4","gravatar_id":"","url":"https://api.github.com/users/yossigo","html_url":"https://github.com/yossigo","followers_url":"https://api.github.com/users/yossigo/followers","following_url":"https://api.github.com/users/yossigo/following{/other_user}","gists_url":"https://api.github.com/users/yossigo/gists{/gist_id}","starred_url":"https://api.github.com/users/yossigo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yossigo/subscriptions","organizations_url":"https://api.github.com/users/yossigo/orgs","repos_url":"https://api.github.com/users/yossigo/repos","events_url":"https://api.github.com/users/yossigo/events{/privacy}","received_events_url":"https://api.github.com/users/yossigo/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/redis/issues/8531/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/redis/issues/8531/timeline","performed_via_github_app":null,"state_reason":"completed"}