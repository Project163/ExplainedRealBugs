{"url":"https://api.github.com/repos/redis/redis/issues/7215","repository_url":"https://api.github.com/repos/redis/redis","labels_url":"https://api.github.com/repos/redis/redis/issues/7215/labels{/name}","comments_url":"https://api.github.com/repos/redis/redis/issues/7215/comments","events_url":"https://api.github.com/repos/redis/redis/issues/7215/events","html_url":"https://github.com/redis/redis/issues/7215","id":614209291,"node_id":"MDU6SXNzdWU2MTQyMDkyOTE=","number":7215,"title":"redis 6.0 doesn't free clients that disconnect during loading","user":{"login":"oranagra","id":7045099,"node_id":"MDQ6VXNlcjcwNDUwOTk=","avatar_url":"https://avatars.githubusercontent.com/u/7045099?v=4","gravatar_id":"","url":"https://api.github.com/users/oranagra","html_url":"https://github.com/oranagra","followers_url":"https://api.github.com/users/oranagra/followers","following_url":"https://api.github.com/users/oranagra/following{/other_user}","gists_url":"https://api.github.com/users/oranagra/gists{/gist_id}","starred_url":"https://api.github.com/users/oranagra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/oranagra/subscriptions","organizations_url":"https://api.github.com/users/oranagra/orgs","repos_url":"https://api.github.com/users/oranagra/repos","events_url":"https://api.github.com/users/oranagra/events{/privacy}","received_events_url":"https://api.github.com/users/oranagra/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-05-07T17:03:06Z","updated_at":"2020-05-27T06:31:43Z","closed_at":"2020-05-27T06:31:43Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"@antirez In 6.0 you changed readQueryFromClient to call freeClientAsync rather than freeClient (it was for threaded IO).\r\n\r\nso although redis 6.0 now calls freeClientsInAsyncFreeQueue from beforeSleep rather than serverCron, neither of them is called while loading.\r\n\r\nthis means that now if a client connects and drops during loading, it is added to clients_to_close and remains alive (listed as a client, and socket not closed) until loading is done.\r\n\r\nif there are some stats monitoring tools and watchdogs sampling the loading progress by re-opening and closing the connection repeatedly, over time, on a long loading, thousands of connections accumulate. (i have circumstantial evidence showing that this can also slow down the loading process, i'll post details in the next post)\r\n\r\nit is interesting to note that processEventsWhileBlocked does call afterSleep (4 times), but does not call beforeSleep.\r\nthis looks very odd, so one possible solution is to move the call to beforeSleep from aeMain to aeProcessEvents (right before aeApiPoll and afterSleep).\r\n\r\nwe need to carefully consider what side effects such a change can cause, and if we can't afford it, maybe just call freeClientsInAsyncFreeQueue from processEventsWhileBlocked (which is very very specifically crafted function anyway).\r\n\r\nit is important to note however, that in some cases (diskless replica) processEventsWhileBlocked is called from within a read event handler (readSyncBulkPayload), but i suppose it won't detect the master disconnected and try to free it from that call path, so maybe it's still ok.","closed_by":{"login":"oranagra","id":7045099,"node_id":"MDQ6VXNlcjcwNDUwOTk=","avatar_url":"https://avatars.githubusercontent.com/u/7045099?v=4","gravatar_id":"","url":"https://api.github.com/users/oranagra","html_url":"https://github.com/oranagra","followers_url":"https://api.github.com/users/oranagra/followers","following_url":"https://api.github.com/users/oranagra/following{/other_user}","gists_url":"https://api.github.com/users/oranagra/gists{/gist_id}","starred_url":"https://api.github.com/users/oranagra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/oranagra/subscriptions","organizations_url":"https://api.github.com/users/oranagra/orgs","repos_url":"https://api.github.com/users/oranagra/repos","events_url":"https://api.github.com/users/oranagra/events{/privacy}","received_events_url":"https://api.github.com/users/oranagra/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/redis/issues/7215/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/redis/issues/7215/timeline","performed_via_github_app":null,"state_reason":"completed"}