{"url":"https://api.github.com/repos/redis/redis/issues/8507","repository_url":"https://api.github.com/repos/redis/redis","labels_url":"https://api.github.com/repos/redis/redis/issues/8507/labels{/name}","comments_url":"https://api.github.com/repos/redis/redis/issues/8507/comments","events_url":"https://api.github.com/repos/redis/redis/issues/8507/events","html_url":"https://github.com/redis/redis/issues/8507","id":810713287,"node_id":"MDU6SXNzdWU4MTA3MTMyODc=","number":8507,"title":"[QUESTION] Sentinel host name support not working as expected.","user":{"login":"satheeshaGowda","id":7914152,"node_id":"MDQ6VXNlcjc5MTQxNTI=","avatar_url":"https://avatars.githubusercontent.com/u/7914152?v=4","gravatar_id":"","url":"https://api.github.com/users/satheeshaGowda","html_url":"https://github.com/satheeshaGowda","followers_url":"https://api.github.com/users/satheeshaGowda/followers","following_url":"https://api.github.com/users/satheeshaGowda/following{/other_user}","gists_url":"https://api.github.com/users/satheeshaGowda/gists{/gist_id}","starred_url":"https://api.github.com/users/satheeshaGowda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/satheeshaGowda/subscriptions","organizations_url":"https://api.github.com/users/satheeshaGowda/orgs","repos_url":"https://api.github.com/users/satheeshaGowda/repos","events_url":"https://api.github.com/users/satheeshaGowda/events{/privacy}","received_events_url":"https://api.github.com/users/satheeshaGowda/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2021-02-18T03:02:52Z","updated_at":"2021-02-21T09:22:36Z","closed_at":"2021-02-21T09:22:36Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hello @yossigo , thank you for adding #8282 , this is the much awaited PR .\r\n\r\nwe have spent sometime testing that feature on `redis:6.2-rc3` from dockerhub with the configuration suggested here #8282 (comment)\r\n\r\nat the outset Sentinel vends out the host name of the shard master when we query `SENTINEL get-master-addr-by-name mymaster`, but after we trigger a failover , it started vending out IPs again, isnt the expectation is to return host name?\r\n\r\nhere is the yaml spec we used, if it helps you reproduce . \r\n\r\n**Redis**\r\n```\r\napiVersion: apps/v1\r\nkind: StatefulSet\r\nmetadata:\r\n  name: redis\r\nspec:\r\n  serviceName: redis\r\n  replicas: 5\r\n  selector:\r\n    matchLabels:\r\n      app: redis\r\n  template:\r\n    metadata:\r\n      labels:\r\n        app: redis\r\n    spec:\r\n      initContainers:\r\n      - name: config\r\n        image: redis:6.2-rc3\r\n        command: [ \"bash\", \"-c\" ]\r\n        args:\r\n          - |\r\n            cp /tmp/redis/redis.conf /etc/redis/redis.conf\r\n\r\n            MASTER_FQDN=redis-0.redis.REDACTED\r\n            POD_FQDN=$(hostname -f)\r\n            echo \"replica-announce-ip  $POD_FQDN\" >> /etc/redis/redis.conf\r\n            echo \"replica-announce-port 6379\" >> /etc/redis/redis.conf\r\n            if [ \"$POD_FQDN\" =  \"$MASTER_FQDN\" ]; then\r\n                echo \"this is master, not updating config...\"\r\n            else\r\n                echo \"updating replica redis.conf...\"\r\n                echo \"replicaof $MASTER_FQDN 6379\" >> /etc/redis/redis.conf\r\n            fi\r\n            cat /etc/redis/redis.conf\r\n        volumeMounts:\r\n        - name: redis-config\r\n          mountPath: /etc/redis/\r\n        - name: config\r\n          mountPath: /tmp/redis/\r\n      containers:\r\n      - name: redis\r\n        image: redis:6.2-rc3\r\n        command: [\"redis-server\"]\r\n        args: [\"/etc/redis/redis.conf\"]\r\n        ports:\r\n        - containerPort: 6379\r\n          name: redis\r\n        volumeMounts:\r\n        - name: data\r\n          mountPath: /data\r\n        - name: redis-config\r\n          mountPath: /etc/redis/\r\n      volumes:\r\n      - name: redis-config\r\n        emptyDir: {}\r\n      - name: config\r\n        configMap:\r\n          name: redis-config\r\n  volumeClaimTemplates:\r\n  - metadata:\r\n      name: data\r\n    spec:\r\n      accessModes: [ \"ReadWriteOnce\" ]\r\n      storageClassName: scaleio\r\n      resources:\r\n        requests:\r\n          storage: 100Mi\r\n\r\n---\r\napiVersion: v1\r\nkind: Service\r\nmetadata:\r\n  name: redis\r\nspec:\r\n  clusterIP: None\r\n  ports:\r\n  - port: 6379\r\n    targetPort: 6379\r\n    name: redis\r\n  selector:\r\n    app: redis\r\n```\r\n\r\n**Sentinel**\r\n```\r\napiVersion: apps/v1\r\nkind: StatefulSet\r\nmetadata:\r\n  name: sentinel\r\nspec:\r\n  serviceName: sentinel\r\n  replicas: 3\r\n  selector:\r\n    matchLabels:\r\n      app: sentinel\r\n  template:\r\n    metadata:\r\n      labels:\r\n        app: sentinel\r\n    spec:\r\n      initContainers:\r\n      - name: config\r\n        image: redis:6.2-rc3\r\n        command: [ \"sh\", \"-c\" ]\r\n        args:\r\n          - |\r\n            REDIS_PASSWORD=testpassword\r\n            MASTER_FQDN=redis-0.redis.REDACTED\r\n            POD_FQDN=$(hostname -f)\r\n            echo \"port 26379\r\n            protected-mode no\r\n            sentinel resolve-hostnames yes\r\n            sentinel announce-hostnames yes\r\n            sentinel announce-ip $POD_FQDN\r\n            sentinel announce-port 26379\r\n            sentinel monitor mymaster $MASTER_FQDN 6379 2\r\n            sentinel down-after-milliseconds mymaster 5000\r\n            sentinel failover-timeout mymaster 60000\r\n            sentinel parallel-syncs mymaster 1\r\n            sentinel auth-pass mymaster $REDIS_PASSWORD\r\n            \" > /etc/redis/sentinel.conf\r\n            cat /etc/redis/sentinel.conf\r\n        volumeMounts:\r\n        - name: redis-config\r\n          mountPath: /etc/redis/\r\n      containers:\r\n      - name: sentinel\r\n        image: redis:6.2-rc3\r\n        command: [\"redis-server\", \"/etc/redis/sentinel.conf\", \"--sentinel\"]\r\n        ports:\r\n        - containerPort: 26379\r\n          name: sentinel\r\n        volumeMounts:\r\n        - name: redis-config\r\n          mountPath: /etc/redis/\r\n        - name: data\r\n          mountPath: /data\r\n      volumes:\r\n      - name: redis-config\r\n        emptyDir: {}\r\n  volumeClaimTemplates:\r\n  - metadata:\r\n      name: data\r\n    spec:\r\n      accessModes: [ \"ReadWriteOnce\" ]\r\n      storageClassName: scaleio\r\n      resources:\r\n        requests:\r\n          storage: 100Mi\r\n\r\n---\r\napiVersion: v1\r\nkind: Service\r\nmetadata:\r\n  name: sentinel\r\nspec:\r\n  clusterIP: None\r\n  ports:\r\n  - port: 26379\r\n    targetPort: 26379\r\n    name: sentinel\r\n  selector:\r\n    app: sentinel\r\n```\r\n\r\n","closed_by":{"login":"yossigo","id":1481195,"node_id":"MDQ6VXNlcjE0ODExOTU=","avatar_url":"https://avatars.githubusercontent.com/u/1481195?v=4","gravatar_id":"","url":"https://api.github.com/users/yossigo","html_url":"https://github.com/yossigo","followers_url":"https://api.github.com/users/yossigo/followers","following_url":"https://api.github.com/users/yossigo/following{/other_user}","gists_url":"https://api.github.com/users/yossigo/gists{/gist_id}","starred_url":"https://api.github.com/users/yossigo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yossigo/subscriptions","organizations_url":"https://api.github.com/users/yossigo/orgs","repos_url":"https://api.github.com/users/yossigo/repos","events_url":"https://api.github.com/users/yossigo/events{/privacy}","received_events_url":"https://api.github.com/users/yossigo/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/redis/issues/8507/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/redis/issues/8507/timeline","performed_via_github_app":null,"state_reason":"completed"}