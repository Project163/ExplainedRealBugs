{"url":"https://api.github.com/repos/redis/redis/issues/10077","repository_url":"https://api.github.com/repos/redis/redis","labels_url":"https://api.github.com/repos/redis/redis/issues/10077/labels{/name}","comments_url":"https://api.github.com/repos/redis/redis/issues/10077/comments","events_url":"https://api.github.com/repos/redis/redis/issues/10077/events","html_url":"https://github.com/redis/redis/issues/10077","id":1096822279,"node_id":"I_kwDOAAJhcs5BYC4H","number":10077,"title":"[BUG] During Bgsave, failed to disconnect idle client connection properly","user":{"login":"Neway13","id":20969338,"node_id":"MDQ6VXNlcjIwOTY5MzM4","avatar_url":"https://avatars.githubusercontent.com/u/20969338?v=4","gravatar_id":"","url":"https://api.github.com/users/Neway13","html_url":"https://github.com/Neway13","followers_url":"https://api.github.com/users/Neway13/followers","following_url":"https://api.github.com/users/Neway13/following{/other_user}","gists_url":"https://api.github.com/users/Neway13/gists{/gist_id}","starred_url":"https://api.github.com/users/Neway13/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Neway13/subscriptions","organizations_url":"https://api.github.com/users/Neway13/orgs","repos_url":"https://api.github.com/users/Neway13/repos","events_url":"https://api.github.com/users/Neway13/events{/privacy}","received_events_url":"https://api.github.com/users/Neway13/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"enjoy-binbin","id":22811481,"node_id":"MDQ6VXNlcjIyODExNDgx","avatar_url":"https://avatars.githubusercontent.com/u/22811481?v=4","gravatar_id":"","url":"https://api.github.com/users/enjoy-binbin","html_url":"https://github.com/enjoy-binbin","followers_url":"https://api.github.com/users/enjoy-binbin/followers","following_url":"https://api.github.com/users/enjoy-binbin/following{/other_user}","gists_url":"https://api.github.com/users/enjoy-binbin/gists{/gist_id}","starred_url":"https://api.github.com/users/enjoy-binbin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/enjoy-binbin/subscriptions","organizations_url":"https://api.github.com/users/enjoy-binbin/orgs","repos_url":"https://api.github.com/users/enjoy-binbin/repos","events_url":"https://api.github.com/users/enjoy-binbin/events{/privacy}","received_events_url":"https://api.github.com/users/enjoy-binbin/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"enjoy-binbin","id":22811481,"node_id":"MDQ6VXNlcjIyODExNDgx","avatar_url":"https://avatars.githubusercontent.com/u/22811481?v=4","gravatar_id":"","url":"https://api.github.com/users/enjoy-binbin","html_url":"https://github.com/enjoy-binbin","followers_url":"https://api.github.com/users/enjoy-binbin/followers","following_url":"https://api.github.com/users/enjoy-binbin/following{/other_user}","gists_url":"https://api.github.com/users/enjoy-binbin/gists{/gist_id}","starred_url":"https://api.github.com/users/enjoy-binbin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/enjoy-binbin/subscriptions","organizations_url":"https://api.github.com/users/enjoy-binbin/orgs","repos_url":"https://api.github.com/users/enjoy-binbin/repos","events_url":"https://api.github.com/users/enjoy-binbin/events{/privacy}","received_events_url":"https://api.github.com/users/enjoy-binbin/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":6,"created_at":"2022-01-08T03:35:23Z","updated_at":"2022-11-04T16:46:39Z","closed_at":"2022-11-04T16:46:39Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\n\r\nDuring Bgsave, the client’s command blocked for 4771ms and threw an IOException. By capturing packets, the server did not properly disconnect idle client connection. Normally, the server would have sent the FIN packet, but it didn't.\r\n\r\n\r\n\r\n**To reproduce**\r\n\r\nService side:\r\n\r\n> Deployment: A 6 nodes cluster.\r\n>\r\n> Key configurations: \r\n>\r\n> ```\r\n> timeout 10\r\n> save '60 1'\r\n> loglevel verbose\r\n> ```\r\n>\r\n> used_memory_human: 2.06G\r\n\r\nClient side\r\n\r\n> Pool size: The minimum size is 8\r\n>\r\n> Command frequency: One command every 3 seconds.\r\n\r\n\r\n\r\n**Expected behavior**\r\n\r\nDuring Bgsave, the server can properly disconnect idle client  connections.\r\n\r\n\r\n\r\n**Additional information**\r\n\r\nThe client sends the set command at 01:17:39.940 and throws an exception at 01:17:44.711. It blocked for 4771ms.\r\n\r\n```\r\n2022-01-08 01:17:44.711  WARN 5468 --- [ntloop-thread-7] c.c.m.c.m.c.RedisTestController : The time spent on the set command：4771ms\r\n2022-01-08 01:17:44.711 ERROR 5468 --- [ntloop-thread-7] c.c.m.c.m.c.RedisTestController : error:\r\n\r\njava.io.IOException: An existing connection was forcibly closed by the remote host\r\n\tat sun.nio.ch.SocketDispatcher.read0(Native Method)\r\n\tat sun.nio.ch.SocketDispatcher.read(SocketDispatcher.java:43)\r\n\tat sun.nio.ch.IOUtil.readIntoNativeBuffer(IOUtil.java:223)\r\n\tat sun.nio.ch.IOUtil.read(IOUtil.java:192)\r\n\tat sun.nio.ch.SocketChannelImpl.read(SocketChannelImpl.java:380)\r\n\tat io.netty.buffer.PooledByteBuf.setBytes(PooledByteBuf.java:253)\r\n\tat io.netty.buffer.AbstractByteBuf.writeBytes(AbstractByteBuf.java:1133)\r\n\tat io.netty.channel.socket.nio.NioSocketChannel.doReadBytes(NioSocketChannel.java:350)\r\n\tat io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:148)\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:714)\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:650)\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:576)\r\n\tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:493)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:989)\r\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n\tat java.lang.Thread.run(Thread.java:745)\r\n```\r\n\r\n\r\n**packets  of client side:**\r\n\r\nserver: 192.168.100.13:6371\r\n\r\nclient: 192.168.100.3:53901\r\n\r\nNote: The time difference between the client and the server is less than 1s.\r\n\r\n![image](https://user-images.githubusercontent.com/20969338/148629962-37705c19-8e1a-4b98-a1fb-b8221454f58b.png)\r\n\r\n\r\n**The log of server:**\r\n\r\n```\r\nlatest_fork_usec:41966\r\nrdb_last_bgsave_time_sec:16\r\n```\r\n![image](https://user-images.githubusercontent.com/20969338/148629977-92e8cbe0-0975-4c3c-b859-1e167c79015c.png)\r\n\r\nI have captured the packets and analyzed the connection that timed out and threw an IOException.\r\n\r\n| Client action                               | Time line    | server action                                 |\r\n| ------------------------------------------- | ------------ | --------------------------------------------- |\r\n| last packet                                 | 01:17:27.931 |                                               |\r\n|                                             | 01:17:28.698 | log: Background saving started                |\r\n| Expected but did not receive the fin packet | 01:17:38.080 | log: Closing idle client                      |\r\n| command send                                | 01:17:39.940 |                                               |\r\n|                                             | 01:17:44.100 | log:Background saving terminated with success |\r\n| connection threw an IOException             | 01:17:44.711 |                                               |\r\n\r\nTwo phenomena indicate that there is something wrong with the server:\r\n\r\n1. 10 seconds after the last packet, the server had a log that closed the idle connection, but the client does not receive it.\r\n2. An exception is not thrown until the end of the bgsave.\r\n\r\n\r\n\r\nI will try to analyze the server code and solve it. Thanks.\r\n","closed_by":{"login":"oranagra","id":7045099,"node_id":"MDQ6VXNlcjcwNDUwOTk=","avatar_url":"https://avatars.githubusercontent.com/u/7045099?v=4","gravatar_id":"","url":"https://api.github.com/users/oranagra","html_url":"https://github.com/oranagra","followers_url":"https://api.github.com/users/oranagra/followers","following_url":"https://api.github.com/users/oranagra/following{/other_user}","gists_url":"https://api.github.com/users/oranagra/gists{/gist_id}","starred_url":"https://api.github.com/users/oranagra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/oranagra/subscriptions","organizations_url":"https://api.github.com/users/oranagra/orgs","repos_url":"https://api.github.com/users/oranagra/repos","events_url":"https://api.github.com/users/oranagra/events{/privacy}","received_events_url":"https://api.github.com/users/oranagra/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/redis/issues/10077/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/redis/issues/10077/timeline","performed_via_github_app":null,"state_reason":"completed"}