{"url":"https://api.github.com/repos/redis/redis/issues/8369","repository_url":"https://api.github.com/repos/redis/redis","labels_url":"https://api.github.com/repos/redis/redis/issues/8369/labels{/name}","comments_url":"https://api.github.com/repos/redis/redis/issues/8369/comments","events_url":"https://api.github.com/repos/redis/redis/issues/8369/events","html_url":"https://github.com/redis/redis/issues/8369","id":789899110,"node_id":"MDU6SXNzdWU3ODk4OTkxMTA=","number":8369,"title":"[BUG] security: config rewrites of sentinel.conf set insecure file permissions","user":{"login":"tokred","id":12331973,"node_id":"MDQ6VXNlcjEyMzMxOTcz","avatar_url":"https://avatars.githubusercontent.com/u/12331973?v=4","gravatar_id":"","url":"https://api.github.com/users/tokred","html_url":"https://github.com/tokred","followers_url":"https://api.github.com/users/tokred/followers","following_url":"https://api.github.com/users/tokred/following{/other_user}","gists_url":"https://api.github.com/users/tokred/gists{/gist_id}","starred_url":"https://api.github.com/users/tokred/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tokred/subscriptions","organizations_url":"https://api.github.com/users/tokred/orgs","repos_url":"https://api.github.com/users/tokred/repos","events_url":"https://api.github.com/users/tokred/events{/privacy}","received_events_url":"https://api.github.com/users/tokred/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2021-01-20T11:35:33Z","updated_at":"2021-01-20T19:57:25Z","closed_at":"2021-01-20T19:57:25Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\n\r\nRunning Sentinel, as soon as an automatic config rewrite is performed, the file permissions of sentinel.conf are set to `0644` and redis:redis (user/group under which sentinel is running), irrespective of the original file permissions and ignoring `UMask` setting of systemd service unit. This exposes sensitive data by setting the file world-readable, e.g. `requirepass`/`auth-pass`.\r\n\r\n**To reproduce**\r\n\r\n- Creating `/etc/redis/sentinel.conf` with intended config parameters\r\n- Setting ownership to `root:redis` (i.e. user under which sentinel is invoked)\r\n- Setting file permissions to `0660`, to allow sentinel to write the file\r\n- Setting directory ownership and permissions of `/etc/redis/` to `root:redis` and `0770`\r\n- Start redis-sentinel\r\n\r\nprepared environment:\r\n```\r\ndrwxrwx---  2 root redis 4.0K Jan 20 12:23 .\r\ndrwxr-xr-x 69 root root  4.0K Jan 19 16:27 ..\r\n-rw-r-----  1 root redis 2.2K Jan 19 18:55 redis.conf\r\n-rw-rw----  1 root redis  599 Jan 20 12:23 sentinel.conf\r\n```\r\n\r\nafter starting redis-sentinel, the config is rewritten (`# Generated by CONFIG REWRITE` is added and some parameters) AND permissions are altered:\r\n```\r\ndrwxrwx---  2 root  redis 4.0K Jan 20 12:23 .\r\ndrwxr-xr-x 69 root  root  4.0K Jan 19 16:27 ..\r\n-rw-r-----  1 root  redis 2.2K Jan 19 18:55 redis.conf\r\n-rw-r--r--  1 redis redis  883 Jan 20 12:23 sentinel.conf\r\n```\r\n\r\n**Expected behavior**\r\n\r\nThe config rewrite is not supposed to alter file ownership nor permissions, especially not to **_insecure world-readable_**, putting sensitive data at risk.\r\n\r\n**Additional information**\r\n\r\nRunning on Debian 10, with recent redis-sentinel 6.0.9-2~bpo10+1 from buster-backports\r\nusing Debian's systemd unit, i.e. `User=redis`, `Group=redis`, `UMask=0007`","closed_by":{"login":"yossigo","id":1481195,"node_id":"MDQ6VXNlcjE0ODExOTU=","avatar_url":"https://avatars.githubusercontent.com/u/1481195?v=4","gravatar_id":"","url":"https://api.github.com/users/yossigo","html_url":"https://github.com/yossigo","followers_url":"https://api.github.com/users/yossigo/followers","following_url":"https://api.github.com/users/yossigo/following{/other_user}","gists_url":"https://api.github.com/users/yossigo/gists{/gist_id}","starred_url":"https://api.github.com/users/yossigo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yossigo/subscriptions","organizations_url":"https://api.github.com/users/yossigo/orgs","repos_url":"https://api.github.com/users/yossigo/repos","events_url":"https://api.github.com/users/yossigo/events{/privacy}","received_events_url":"https://api.github.com/users/yossigo/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/redis/issues/8369/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/redis/issues/8369/timeline","performed_via_github_app":null,"state_reason":"completed"}