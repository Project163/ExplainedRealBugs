{"url":"https://api.github.com/repos/redis/redis/issues/10439","repository_url":"https://api.github.com/repos/redis/redis","labels_url":"https://api.github.com/repos/redis/redis/issues/10439/labels{/name}","comments_url":"https://api.github.com/repos/redis/redis/issues/10439/comments","events_url":"https://api.github.com/repos/redis/redis/issues/10439/events","html_url":"https://github.com/redis/redis/issues/10439","id":1173210072,"node_id":"I_kwDOAAJhcs5F7cPY","number":10439,"title":"[CRASH] Redis-Server Crashed after failed to save rdb when receive shutdown command","user":{"login":"warriorguo","id":180805,"node_id":"MDQ6VXNlcjE4MDgwNQ==","avatar_url":"https://avatars.githubusercontent.com/u/180805?v=4","gravatar_id":"","url":"https://api.github.com/users/warriorguo","html_url":"https://github.com/warriorguo","followers_url":"https://api.github.com/users/warriorguo/followers","following_url":"https://api.github.com/users/warriorguo/following{/other_user}","gists_url":"https://api.github.com/users/warriorguo/gists{/gist_id}","starred_url":"https://api.github.com/users/warriorguo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/warriorguo/subscriptions","organizations_url":"https://api.github.com/users/warriorguo/orgs","repos_url":"https://api.github.com/users/warriorguo/repos","events_url":"https://api.github.com/users/warriorguo/events{/privacy}","received_events_url":"https://api.github.com/users/warriorguo/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2022-03-18T05:45:09Z","updated_at":"2022-03-20T13:18:53Z","closed_at":"2022-03-20T13:18:53Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Crash report**\r\n\r\nPaste the complete crash log between the quotes below. Please include a few lines from the log preceding the crash report to provide some context.\r\n\r\n```\r\n=== REDIS BUG REPORT START: Cut & paste starting from here ===\r\n12396:M 18 Mar 2022 12:24:56.236 # Redis 255.255.255 crashed by signal: 11, si_code: 1\r\n12396:M 18 Mar 2022 12:24:56.236 # Accessing address: 0x60\r\n12396:M 18 Mar 2022 12:24:56.236 # Killed by PID: 0, UID: 0\r\n12396:M 18 Mar 2022 12:24:56.236 # Crashed running the instruction at: 0x1092fae2a\r\n\r\n------ STACK TRACE ------\r\nEIP:\r\n0   redis-server                        0x00000001092fae2a call + 650\r\n\r\nBacktrace:\r\n0   libsystem_platform.dylib            0x00007ff81b6b0e2d _sigtramp + 29\r\n1   ???                                 0x692065726f6d2072 0x0 + 7575166115407274098\r\n2   redis-server                        0x00000001092fbd3f processCommand + 2735\r\n3   redis-server                        0x0000000109316c5a processInputBuffer + 362\r\n4   redis-server                        0x000000010930e853 readQueryFromClient + 1123\r\n5   redis-server                        0x00000001093c8a86 connSocketEventHandler + 294\r\n6   redis-server                        0x00000001092f0a24 aeProcessEvents + 772\r\n7   redis-server                        0x00000001092f0c9d aeMain + 29\r\n8   redis-server                        0x0000000109302b23 main + 2083\r\n9   dyld                                0x0000000117c1f4fe start + 462\r\n\r\n------ REGISTERS ------\r\n12396:M 18 Mar 2022 12:24:56.244 #\r\nRAX:0000000000000000 RBX:000000010948b3a8\r\nRCX:0000000000000098 RDX:0000000000000000\r\nRDI:0000600000741440 RSI:0000000000000000\r\nRBP:00007ff7b6c14600 RSP:00007ff7b6c145a0\r\nR8 :00000da5fc4a7acc R9 :000000000086fbf9\r\nR10:00000000000007fb R11:0000000000000400\r\nR12:000000000000000f R13:00007fad097045e0\r\nR14:000000010949e690 R15:0000000000000098\r\nRIP:00000001092fae2a EFL:0000000000010283\r\nCS :000000000000002b FS:0000000000000000  GS:0000000000000000\r\n12396:M 18 Mar 2022 12:24:56.244 # (00007ff7b6c145af) -> 00000001093168d8\r\n12396:M 18 Mar 2022 12:24:56.244 # (00007ff7b6c145ae) -> 0000000000000001\r\n12396:M 18 Mar 2022 12:24:56.244 # (00007ff7b6c145ad) -> 00000001092fbd3f\r\n12396:M 18 Mar 2022 12:24:56.244 # (00007ff7b6c145ac) -> 00007ff7b6c14670\r\n12396:M 18 Mar 2022 12:24:56.244 # (00007ff7b6c145ab) -> 00000000ffffffff\r\n12396:M 18 Mar 2022 12:24:56.244 # (00007ff7b6c145aa) -> 00007fad097045e0\r\n12396:M 18 Mar 2022 12:24:56.244 # (00007ff7b6c145a9) -> 0000000000000000\r\n12396:M 18 Mar 2022 12:24:56.244 # (00007ff7b6c145a8) -> 000000010949e690\r\n12396:M 18 Mar 2022 12:24:56.244 # (00007ff7b6c145a7) -> 0000000000000000\r\n12396:M 18 Mar 2022 12:24:56.244 # (00007ff7b6c145a6) -> 0000000000950013\r\n12396:M 18 Mar 2022 12:24:56.244 # (00007ff7b6c145a5) -> 0000000000000014\r\n12396:M 18 Mar 2022 12:24:56.244 # (00007ff7b6c145a4) -> 0000000000000014\r\n12396:M 18 Mar 2022 12:24:56.244 # (00007ff7b6c145a3) -> 000000010948b3a8\r\n12396:M 18 Mar 2022 12:24:56.244 # (00007ff7b6c145a2) -> 0000000000000000\r\n12396:M 18 Mar 2022 12:24:56.244 # (00007ff7b6c145a1) -> 0000600000039a1a\r\n12396:M 18 Mar 2022 12:24:56.244 # (00007ff7b6c145a0) -> 0000000062340998\r\n\r\n------ INFO OUTPUT ------\r\n# Server\r\nredis_version:255.255.255\r\nredis_git_sha1:b69636d3\r\nredis_git_dirty:1\r\nredis_build_id:b32c284c00f7e639\r\nredis_mode:standalone\r\nos:Darwin 21.2.0 x86_64\r\narch_bits:64\r\nmultiplexing_api:kqueue\r\natomicvar_api:c11-builtin\r\ngcc_version:4.2.1\r\nprocess_id:12396\r\nprocess_supervised:no\r\nrun_id:1459808a1bfb61d6893d39363cddc30bdf24f659\r\ntcp_port:21111\r\nserver_time_usec:1647577496236058\r\nuptime_in_seconds:0\r\nuptime_in_days:0\r\nhz:10\r\nconfigured_hz:10\r\nlru_clock:3410328\r\nexecutable:/***/backend/redis/src/redis-server\r\nconfig_file:/***/backend/redis/./tests/tmp/redis.conf.12377.2\r\nio_threads_active:0\r\n\r\n# Clients\r\nconnected_clients:1\r\ncluster_connections:0\r\nmaxclients:10000\r\nclient_recent_max_input_buffer:16896\r\nclient_recent_max_output_buffer:0\r\nblocked_clients:0\r\ntracking_clients:0\r\nclients_in_timeout_table:0\r\n\r\n# Memory\r\nused_memory:1233776\r\nused_memory_human:1.18M\r\nused_memory_rss:3239936\r\nused_memory_rss_human:3.09M\r\nused_memory_peak:1233776\r\nused_memory_peak_human:1.18M\r\nused_memory_peak_perc:100.16%\r\nused_memory_overhead:1106744\r\nused_memory_startup:1071472\r\nused_memory_dataset:127032\r\nused_memory_dataset_perc:78.27%\r\nallocator_allocated:1231632\r\nallocator_active:3202048\r\nallocator_resident:3202048\r\ntotal_system_memory:8589934592\r\ntotal_system_memory_human:8.00G\r\nused_memory_lua:37888\r\nused_memory_vm_eval:37888\r\nused_memory_lua_human:37.00K\r\nused_memory_scripts_eval:0\r\nnumber_of_cached_scripts:0\r\nnumber_of_functions:0\r\nnumber_of_libraries:0\r\nused_memory_vm_functions:37888\r\nused_memory_vm_total:75776\r\nused_memory_vm_total_human:74.00K\r\nused_memory_functions:216\r\nused_memory_scripts:216\r\nused_memory_scripts_human:216B\r\nmaxmemory:0\r\nmaxmemory_human:0B\r\nmaxmemory_policy:noeviction\r\nallocator_frag_ratio:2.60\r\nallocator_frag_bytes:1970416\r\nallocator_rss_ratio:1.00\r\nallocator_rss_bytes:0\r\nrss_overhead_ratio:1.01\r\nrss_overhead_bytes:37888\r\nmem_fragmentation_ratio:2.63\r\nmem_fragmentation_bytes:2008304\r\nmem_not_counted_for_evict:0\r\nmem_replication_backlog:0\r\nmem_total_replication_buffers:0\r\nmem_clients_slaves:0\r\nmem_clients_normal:34000\r\nmem_cluster_links:0\r\nmem_aof_buffer:0\r\nmem_allocator:libc\r\nactive_defrag_running:0\r\nlazyfree_pending_objects:0\r\nlazyfreed_objects:0\r\n\r\n# Persistence\r\nloading:0\r\nasync_loading:0\r\ncurrent_cow_peak:0\r\ncurrent_cow_size:0\r\ncurrent_cow_size_age:0\r\ncurrent_fork_perc:0.00\r\ncurrent_save_keys_processed:0\r\ncurrent_save_keys_total:0\r\nrdb_changes_since_last_save:20\r\nrdb_bgsave_in_progress:0\r\nrdb_last_save_time:1647577496\r\nrdb_last_bgsave_status:ok\r\nrdb_last_bgsave_time_sec:-1\r\nrdb_current_bgsave_time_sec:-1\r\nrdb_saves:0\r\nrdb_last_cow_size:0\r\nrdb_last_load_keys_expired:0\r\nrdb_last_load_keys_loaded:0\r\naof_enabled:0\r\naof_rewrite_in_progress:0\r\naof_rewrite_scheduled:0\r\naof_last_rewrite_time_sec:-1\r\naof_current_rewrite_time_sec:-1\r\naof_last_bgrewrite_status:ok\r\naof_rewrites:0\r\naof_last_write_status:ok\r\naof_last_cow_size:0\r\nmodule_fork_in_progress:0\r\nmodule_fork_last_cow_size:0\r\n\r\n# Stats\r\ntotal_connections_received:2\r\ntotal_commands_processed:24\r\ninstantaneous_ops_per_sec:14\r\ntotal_net_input_bytes:656\r\ntotal_net_output_bytes:4856\r\ninstantaneous_input_kbps:0.38\r\ninstantaneous_output_kbps:2.93\r\nrejected_connections:0\r\nsync_full:0\r\nsync_partial_ok:0\r\nsync_partial_err:0\r\nexpired_keys:0\r\nexpired_stale_perc:0.00\r\nexpired_time_cap_reached_count:0\r\nexpire_cycle_cpu_milliseconds:0\r\nevicted_keys:0\r\nevicted_clients:0\r\ntotal_eviction_exceeded_time:0\r\ncurrent_eviction_exceeded_time:0\r\nkeyspace_hits:0\r\nkeyspace_misses:0\r\npubsub_channels:0\r\npubsub_patterns:0\r\nlatest_fork_usec:0\r\ntotal_forks:0\r\nmigrate_cached_sockets:0\r\nslave_expires_tracked_keys:0\r\nactive_defrag_hits:0\r\nactive_defrag_misses:0\r\nactive_defrag_key_hits:0\r\nactive_defrag_key_misses:0\r\ntotal_active_defrag_time:0\r\ncurrent_active_defrag_time:0\r\ntracking_total_keys:0\r\ntracking_total_items:0\r\ntracking_total_prefixes:0\r\nunexpected_error_replies:0\r\ntotal_error_replies:1\r\ndump_payload_sanitizations:0\r\ntotal_reads_processed:26\r\ntotal_writes_processed:24\r\nio_threaded_reads_processed:0\r\nio_threaded_writes_processed:0\r\nreply_buffer_shrinks:0\r\nreply_buffer_expands:0\r\n\r\n# Replication\r\nrole:master\r\nconnected_slaves:0\r\nmaster_failover_state:no-failover\r\nmaster_replid:d12e064dd81600a754c62ac66347eedf9ccb70b8\r\nmaster_replid2:0000000000000000000000000000000000000000\r\nmaster_repl_offset:0\r\nsecond_repl_offset:-1\r\nrepl_backlog_active:0\r\nrepl_backlog_size:1048576\r\nrepl_backlog_first_byte_offset:0\r\nrepl_backlog_histlen:0\r\n\r\n# CPU\r\nused_cpu_sys:0.006237\r\nused_cpu_user:0.005119\r\nused_cpu_sys_children:0.000000\r\nused_cpu_user_children:0.000000\r\n\r\n# Modules\r\n\r\n# Commandstats\r\ncmdstat_select:calls=1,usec=6,usec_per_call=6.00,rejected_calls=0,failed_calls=0\r\ncmdstat_config|get:calls=1,usec=49,usec_per_call=49.00,rejected_calls=0,failed_calls=0\r\ncmdstat_ping:calls=1,usec=3,usec_per_call=3.00,rejected_calls=0,failed_calls=0\r\ncmdstat_shutdown:calls=0,usec=0,usec_per_call=0.00,rejected_calls=0,failed_calls=1\r\ncmdstat_info:calls=1,usec=68,usec_per_call=68.00,rejected_calls=0,failed_calls=0\r\ncmdstat_set:calls=20,usec=63,usec_per_call=3.15,rejected_calls=0,failed_calls=0\r\n\r\n# Errorstats\r\nerrorstat_ERR:count=1\r\n\r\n# Latencystats\r\nlatency_percentiles_usec_select:p50=6.015,p99=6.015,p99.9=6.015\r\nlatency_percentiles_usec_config|get:p50=49.151,p99=49.151,p99.9=49.151\r\nlatency_percentiles_usec_ping:p50=3.007,p99=3.007,p99.9=3.007\r\nlatency_percentiles_usec_info:p50=68.095,p99=68.095,p99.9=68.095\r\nlatency_percentiles_usec_set:p50=3.007,p99=10.047,p99.9=10.047\r\n\r\n# Cluster\r\ncluster_enabled:0\r\n\r\n# Keyspace\r\ndb9:keys=20,expires=0,avg_ttl=0\r\n\r\n------ CLIENT LIST OUTPUT ------\r\nid=4 addr=127.0.0.1:52730 laddr=127.0.0.1:21111 fd=12 name= age=0 idle=0 flags=u db=9 sub=0 psub=0 multi=-1 qbuf=18 qbuf-free=16872 argv-mem=0 multi-mem=0 rbs=16384 rbp=45 obl=45 oll=0 omem=0 tot-mem=34000 events=r cmd=shutdown user=default redir=-1 resp=2\r\n\r\n------ CURRENT CLIENT INFO ------\r\nid=4 addr=127.0.0.1:52730 laddr=127.0.0.1:21111 fd=12 name= age=0 idle=0 flags=u db=9 sub=0 psub=0 multi=-1 qbuf=18 qbuf-free=16872 argv-mem=0 multi-mem=0 rbs=16384 rbp=45 obl=45 oll=0 omem=0 tot-mem=34000 events=r cmd=shutdown user=default redir=-1 resp=2\r\n\r\n------ MODULES INFO OUTPUT ------\r\n\r\n------ CONFIG DEBUG OUTPUT ------\r\nlazyfree-lazy-user-flush no\r\nio-threads 1\r\nlazyfree-lazy-user-del no\r\nio-threads-do-reads no\r\nlazyfree-lazy-expire no\r\nactivedefrag no\r\nlazyfree-lazy-eviction no\r\nslave-read-only yes\r\nrepl-diskless-sync yes\r\nlist-compress-depth 0\r\nsanitize-dump-payload no\r\nclient-query-buffer-limit 1gb\r\nlazyfree-lazy-server-del no\r\nproto-max-bulk-len 512mb\r\nrepl-diskless-load disabled\r\nreplica-read-only yes\r\n\r\n------ DUMPING CODE AROUND EIP ------\r\nSymbol: call (base: 0x1092faba0)\r\nModule: /***/redis/src/redis-server (base 0x1092eb000)\r\n$ xxd -r -p /tmp/dump.hex /tmp/dump.bin\r\n$ objdump --adjust-vma=0x1092faba0 -D -b binary -m i386:x86-64 /tmp/dump.bin\r\n------\r\n12396:M 18 Mar 2022 12:24:56.245 # dump of function (hexdump of 778 bytes):\r\n554889e54157415641554154534883ec384189f74989fd488b9780000000488b87e0000000488945b04825ff3fe7ff488987e00000004c8d35b33a1a00418b8ee800000089f083e010894dd409c8750b41c786e800000001000000488955b8498b86380b0000488945c0498b8698070000488905f8d51900498b8628040000488d480149898e280400004885c0756b488d7da031f6e87e261100486945a040420f0048634da84801c148bacff753e3a59bc4204889c848f7ea49898ee00e00004889d048c1e83f48c1fa074801c2498996d80e000048badb34b6d782de1b434889c848f7ea4889d048c1e83f48c1fa124801c2498996c00e000041838630040000014c8d25bf391a0041ff14244889c3498b45704c89efff505041ff14244829d84889c2498985c8000000498b86380b0000488945c841838630040000ff498b8698070000488b5db84885db741a483b051bd519007e1148838380010000014889050ad51900eb1948890501d519004983bdb00000000074084883838001000001498b85e0000000480fbae028731848b9bffffffffffeffff4821c84883c840498985e00000004589fc4183e4fca900010000450f44e74183bea405000000450f44e7a9000100004989d77423498b8e900f00004885c974176685c00f8839030000a90040000074078089e10000004041f6c4010f848c000000498b8ec00f000048bacff753e3a59bc4204c89f848f7ea4885c974344889d048c1e83f48c1fa074801c24839ca7c21f7436000400000488d058a5a1100488d3d765a1100480f44f84889d6e8c65c090041f685e0000000107532f6436110752c498b45604889c64885c07504498b7550498d4d5c498d55484885c0480f44ca8b114c89ef4c89f9e81a8b0700498b45700fb74060a910080000741541f685e000000010744d41f6c4027559e9e3000000498b45604889c14885c07504498b4d50498d555c498d75484885c0480f44d6448b02498bb6e0020000498b45188b50284c89efe86ea9020041f685e00000001075b34c89efe8ac76010041f6c4020f848f000000f30f6f8368010000660f6f0d\r\nFunction at 0x109390ab0 is latencyAddSample\r\nFunction at 0x109373940 is slowlogPushEntryIfNeeded\r\nFunction at 0x1093257f0 is replicationFeedMonitors\r\nFunction at 0x109312540 is freeClientOriginalArgv\r\n\r\n=== REDIS BUG REPORT END. Make sure to include from START to END. ===\r\n```\r\n\r\n**Additional information**\r\n\r\n1. OS distribution and version\r\nMac Monterey 12.1, Redis version: Redis 7.0rc2\r\n2. Steps to reproduce\r\na. launch the Redis process with nobody, `sudo -u nobody src/redis-server`\r\nb. set the rdb file to readonly, for example `chmod 0444 dump.rdb`\r\nc. send `shutdown` command to the server, the server will crash directly\r\n","closed_by":{"login":"oranagra","id":7045099,"node_id":"MDQ6VXNlcjcwNDUwOTk=","avatar_url":"https://avatars.githubusercontent.com/u/7045099?v=4","gravatar_id":"","url":"https://api.github.com/users/oranagra","html_url":"https://github.com/oranagra","followers_url":"https://api.github.com/users/oranagra/followers","following_url":"https://api.github.com/users/oranagra/following{/other_user}","gists_url":"https://api.github.com/users/oranagra/gists{/gist_id}","starred_url":"https://api.github.com/users/oranagra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/oranagra/subscriptions","organizations_url":"https://api.github.com/users/oranagra/orgs","repos_url":"https://api.github.com/users/oranagra/repos","events_url":"https://api.github.com/users/oranagra/events{/privacy}","received_events_url":"https://api.github.com/users/oranagra/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/redis/issues/10439/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/redis/issues/10439/timeline","performed_via_github_app":null,"state_reason":"completed"}