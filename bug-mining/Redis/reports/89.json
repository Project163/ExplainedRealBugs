{"url":"https://api.github.com/repos/redis/redis/issues/12808","repository_url":"https://api.github.com/repos/redis/redis","labels_url":"https://api.github.com/repos/redis/redis/issues/12808/labels{/name}","comments_url":"https://api.github.com/repos/redis/redis/issues/12808/comments","events_url":"https://api.github.com/repos/redis/redis/issues/12808/events","html_url":"https://github.com/redis/redis/issues/12808","id":2010988246,"node_id":"I_kwDOAAJhcs533T7W","number":12808,"title":"[BUG] Module's events are called though module load had failed","user":{"login":"alonre24","id":28729016,"node_id":"MDQ6VXNlcjI4NzI5MDE2","avatar_url":"https://avatars.githubusercontent.com/u/28729016?v=4","gravatar_id":"","url":"https://api.github.com/users/alonre24","html_url":"https://github.com/alonre24","followers_url":"https://api.github.com/users/alonre24/followers","following_url":"https://api.github.com/users/alonre24/following{/other_user}","gists_url":"https://api.github.com/users/alonre24/gists{/gist_id}","starred_url":"https://api.github.com/users/alonre24/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alonre24/subscriptions","organizations_url":"https://api.github.com/users/alonre24/orgs","repos_url":"https://api.github.com/users/alonre24/repos","events_url":"https://api.github.com/users/alonre24/events{/privacy}","received_events_url":"https://api.github.com/users/alonre24/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2359025022,"node_id":"MDU6TGFiZWwyMzU5MDI1MDIy","url":"https://api.github.com/repos/redis/redis/labels/state:help-wanted","name":"state:help-wanted","color":"56a7b7","default":false,"description":"No member is currently implementing this change"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2023-11-26T10:38:26Z","updated_at":"2023-11-27T15:26:34Z","closed_at":"2023-11-27T15:26:34Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\n\r\nDetected with `valgrind` - after calling `MODULE LOAD` command for loading a module where loading fails due to `REDISMODULE_ERR` status, we expect that server events to which the module subscribed prior to the failure upon loading will not be handeled. However, this is not the behavior, and handling these events causes accessing invalid memory.\r\n\r\n**To reproduce**\r\n\r\n1. Launch redis-server without modules.\r\n2. Call `module load` command and the `RedisModule_OnLoad` callback in the module code fails (returning `REDISMODULE_ERR`). As part of the cleanup, module context is freed (`moduleFreeModuleStructure(ctx.module);`)\r\n3. Before the failure, upon initialization, module was registered to `RedisModuleEvent_FlushDB` event.\r\n4. Call `FLUSHALL` command. `emptyData` is called -> `moduleFireServerEvent` is called and the callback of the module that was sent to the `RedisModuleEvent_FlushDB` is called as it is still registered.\r\n5. `moduleFireServerEvent` accessing the module context that was freed.\r\n\r\n**Expected behavior**\r\n\r\nModules' callbacks will not be called if nodule loading has failed. \r\n","closed_by":{"login":"oranagra","id":7045099,"node_id":"MDQ6VXNlcjcwNDUwOTk=","avatar_url":"https://avatars.githubusercontent.com/u/7045099?v=4","gravatar_id":"","url":"https://api.github.com/users/oranagra","html_url":"https://github.com/oranagra","followers_url":"https://api.github.com/users/oranagra/followers","following_url":"https://api.github.com/users/oranagra/following{/other_user}","gists_url":"https://api.github.com/users/oranagra/gists{/gist_id}","starred_url":"https://api.github.com/users/oranagra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/oranagra/subscriptions","organizations_url":"https://api.github.com/users/oranagra/orgs","repos_url":"https://api.github.com/users/oranagra/repos","events_url":"https://api.github.com/users/oranagra/events{/privacy}","received_events_url":"https://api.github.com/users/oranagra/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/redis/issues/12808/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/redis/issues/12808/timeline","performed_via_github_app":null,"state_reason":"completed"}