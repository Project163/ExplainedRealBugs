{"url":"https://api.github.com/repos/redis/redis/issues/7014","repository_url":"https://api.github.com/repos/redis/redis","labels_url":"https://api.github.com/repos/redis/redis/issues/7014/labels{/name}","comments_url":"https://api.github.com/repos/redis/redis/issues/7014/comments","events_url":"https://api.github.com/repos/redis/redis/issues/7014/events","html_url":"https://github.com/redis/redis/issues/7014","id":585429746,"node_id":"MDU6SXNzdWU1ODU0Mjk3NDY=","number":7014,"title":"Clarification about READONLY errors inside a transaction","user":{"login":"luin","id":635902,"node_id":"MDQ6VXNlcjYzNTkwMg==","avatar_url":"https://avatars.githubusercontent.com/u/635902?v=4","gravatar_id":"","url":"https://api.github.com/users/luin","html_url":"https://github.com/luin","followers_url":"https://api.github.com/users/luin/followers","following_url":"https://api.github.com/users/luin/following{/other_user}","gists_url":"https://api.github.com/users/luin/gists{/gist_id}","starred_url":"https://api.github.com/users/luin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/luin/subscriptions","organizations_url":"https://api.github.com/users/luin/orgs","repos_url":"https://api.github.com/users/luin/repos","events_url":"https://api.github.com/users/luin/events{/privacy}","received_events_url":"https://api.github.com/users/luin/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2020-03-21T04:47:03Z","updated_at":"2020-03-23T10:48:57Z","closed_at":"2020-03-23T10:48:57Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hi, I'm collaborating on [a pull request in ioredis repo](https://github.com/luin/ioredis/pull/1010) for handling READONLY errors inside a transaction. I think the behavior is inconsistent with the documentation so I'd just want to make sure here if it's a bug or something intentional.\r\n\r\n### Current behavior\r\n\r\nGiven two Redis servers (v5.0.6) A & B, A is the master and B is a read only replica (set up with `replicaof A.host A.port`), run the following commands in redis-cli against B:\r\n\r\n```\r\nB> multi\r\nOK\r\nB> set foo bar\r\n(error) READONLY You can't write against a read only replica.\r\nB> echo hi\r\nQUEUED\r\nB> exec\r\n1) \"hi\"\r\n```\r\n\r\n`EXEC` command gives a partial result for the two command, which isn't expected.\r\n\r\n### Expected behavior\r\nI think the whole transaction should be discarded.\r\n\r\nIn our documentation about transactions:\r\n\r\n> Before Redis 2.6.5 the behavior was to execute the transaction **with just the subset of commands queued successfully in case the client called EXEC regardless of previous errors**. The new behavior makes it much more simple to mix transactions with pipelining, so that the whole transaction can be sent at once, reading all the replies later at once.\r\n\r\nIt seems current behavior (that executing the transaction with the subset of commands queued successfully) is only normal for Redis < 2.6.5.\r\n\r\nI checked the code and it seems READONLY is the only case that would fail without flagging the transaction. Is there any reasons behind this? If that's the case I think we should update the documentation accordingly.\r\n\r\nhttps://github.com/antirez/redis/blob/1e16b9384d6aa3680ec5629fc0842ab53bf1655e/src/server.c#L3502-L3510\r\n","closed_by":{"login":"antirez","id":65632,"node_id":"MDQ6VXNlcjY1NjMy","avatar_url":"https://avatars.githubusercontent.com/u/65632?v=4","gravatar_id":"","url":"https://api.github.com/users/antirez","html_url":"https://github.com/antirez","followers_url":"https://api.github.com/users/antirez/followers","following_url":"https://api.github.com/users/antirez/following{/other_user}","gists_url":"https://api.github.com/users/antirez/gists{/gist_id}","starred_url":"https://api.github.com/users/antirez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antirez/subscriptions","organizations_url":"https://api.github.com/users/antirez/orgs","repos_url":"https://api.github.com/users/antirez/repos","events_url":"https://api.github.com/users/antirez/events{/privacy}","received_events_url":"https://api.github.com/users/antirez/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/redis/redis/issues/7014/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/redis/redis/issues/7014/timeline","performed_via_github_app":null,"state_reason":"completed"}