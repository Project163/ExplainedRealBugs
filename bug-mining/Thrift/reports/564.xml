<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:04:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-1394] Treatment of optional fields is not consistent between C++ and Java</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-1394</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;&lt;b&gt;Motivation&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;We are trying to implement message signing in the application layer for an internal project. The transport is over Thrift &amp;#8211; the server side is using Java and the client side is using C++. We noticed that the message signing would fail because the client and server would serialize the same Thrift object in different ways.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Problem&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The semantics of &quot;optional&quot; fields differ between thrift code generated for Java and CPP. In CPP, all optional fields are guarded by the &lt;tt&gt;isset&lt;/tt&gt; helper struct. On Java, however, the generated code takes advantage of nullable types: for containers, structs, exceptions, enums, and, notably, strings, the generator elides explicit use of an &quot;isset&quot; bit vector and instead emits checks of the form &quot;field null&quot;. This leads to varying behavior between the two languages: an optional string field with a default value will have &lt;tt&gt;isset&lt;span class=&quot;error&quot;&gt;&amp;#91;fieldid&amp;#93;&lt;/span&gt;&lt;/tt&gt; false on C, but the equivalent test in Java will be true.&lt;/p&gt;

&lt;p&gt;To be concrete, consider the following example:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;struct Foo {
    1: optional string bar = &lt;span class=&quot;code-quote&quot;&gt;&quot;hello&quot;&lt;/span&gt;;
    2: optional i32 baz;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In C++, the checks for &apos;bar&apos; and &apos;i&apos; are similar:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;-&amp;gt;__isset.bar) {
    xfer += oprot-&amp;gt;writeFieldBegin(&lt;span class=&quot;code-quote&quot;&gt;&quot;bar&quot;&lt;/span&gt;, ::apache::thrift::protocol::T_STRING, 1);
    xfer += oprot-&amp;gt;writeString(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;-&amp;gt;bar);
    xfer += oprot-&amp;gt;writeFieldEnd();
  }
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;-&amp;gt;__isset.baz) {
    xfer += oprot-&amp;gt;writeFieldBegin(&lt;span class=&quot;code-quote&quot;&gt;&quot;baz&quot;&lt;/span&gt;, ::apache::thrift::protocol::T_I32, 2);
    xfer += oprot-&amp;gt;writeI32(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;-&amp;gt;baz);
    xfer += oprot-&amp;gt;writeFieldEnd();
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, in Java, the checks are different:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-comment&quot;&gt;/** Returns &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; field bar is set (has been assigned a value) and &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; otherwise */&lt;/span&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isSetBar() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.bar != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
  }
  &lt;span class=&quot;code-comment&quot;&gt;/** Returns &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; field baz is set (has been assigned a value) and &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; otherwise */&lt;/span&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isSetBaz() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; __isset_bit_vector.get(__BAZ_ISSET_ID);
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As a result, when the Java object is serialized, the value for &apos;bar&apos; &lt;em&gt;is&lt;/em&gt; included. But when the C++ object is serialized, the value for &apos;bar&apos; is NOT included.&lt;/p&gt;

&lt;p&gt;For a system like Thrift, I would eschew a few bytes saved over correctness and reliability. As a user of Thrift, I &lt;b&gt;do&lt;/b&gt; expect that the wire data generated for identical Thrift objects will be identical, regardless of the language used.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Proposal&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;We already use a BitSet to track primitive types in Java. The compiler should extend the bit vector to also guard nullable types, to be consistent with C++. This is pretty easy and low impact &amp;#8211; I&apos;m happy to provide a patch.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Mac OSX, Thrift trunk&lt;/p&gt;</environment>
        <key id="12527646">THRIFT-1394</key>
            <summary>Treatment of optional fields is not consistent between C++ and Java</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="diwaker">Diwaker Gupta</assignee>
                                    <reporter username="diwaker">Diwaker Gupta</reporter>
                        <labels>
                            <label>C++</label>
                            <label>Java</label>
                    </labels>
                <created>Tue, 18 Oct 2011 20:34:01 +0000</created>
                <updated>Mon, 25 Feb 2013 09:49:25 +0000</updated>
                            <resolved>Fri, 27 Jan 2012 04:48:57 +0000</resolved>
                                    <version>0.7</version>
                                    <fixVersion>0.9</fixVersion>
                                    <component>C++ - Compiler</component>
                    <component>Java - Compiler</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13131320" author="jfarrell" created="Thu, 20 Oct 2011 03:41:53 +0000"  >&lt;p&gt;Diwaker, this patch fixes the immediate problem you have with c++ and java, but what about other client libraries (ruby, python, php, etc..) ?&lt;/p&gt;</comment>
                            <comment id="13167961" author="diwaker" created="Tue, 13 Dec 2011 00:02:17 +0000"  >&lt;p&gt;Jake, considering that the current C++ &amp;lt;-&amp;gt; Java wire translation is inconsistent and likely to be inconsistent across other languages as well AND considering that this hasn&apos;t been a huge issue in the community so far, my sense is that most Thrift users just haven&apos;t run into this.&lt;/p&gt;

&lt;p&gt;Given our limited resources, we are unable to provide patches for other client libraries. But I don&apos;t see why that should prevent this patch from going in &amp;#8211; it passes all tests and doesn&apos;t break any existing clients and/or functionality.&lt;/p&gt;

&lt;p&gt;What would it take to get this patch into the next release?&lt;/p&gt;</comment>
                            <comment id="13191481" author="diwaker" created="Mon, 23 Jan 2012 21:34:27 +0000"  >&lt;p&gt;Bump. Jake?&lt;/p&gt;</comment>
                            <comment id="13194452" author="jfarrell" created="Fri, 27 Jan 2012 04:48:57 +0000"  >&lt;p&gt;Committed&lt;/p&gt;</comment>
                            <comment id="13194478" author="hudson" created="Fri, 27 Jan 2012 05:28:54 +0000"  >&lt;p&gt;Integrated in Thrift #398 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/398/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/398/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1394&quot; title=&quot;Treatment of optional fields is not consistent between C++ and Java&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1394&quot;&gt;&lt;del&gt;THRIFT-1394&lt;/del&gt;&lt;/a&gt;:Treatment of optional fields is not consistent between C++ and Java&lt;br/&gt;
Client: cpp&lt;br/&gt;
Patch: Diwaker Gupta&lt;/p&gt;

&lt;p&gt;In CPP, all optional fields are guarded by the isset helper struct. On Java, however, the generated code takes advantage of nullable types: for containers, structs, exceptions, enums, and, notably, strings, the generator elides explicit use of an &quot;isset&quot; bit vector and instead emits checks of the form &quot;field null&quot;. This leads to varying behavior between the two languages: an optional string field with a default value will have &lt;tt&gt;isset&lt;span class=&quot;error&quot;&gt;&amp;#91;fieldid&amp;#93;&lt;/span&gt;&lt;/tt&gt; false on C, but the equivalent test in Java will be true.&lt;/p&gt;

&lt;p&gt;jfarrell : &lt;a href=&quot;http://svn.apache.org/viewvc/?view=rev&amp;amp;rev=1236529&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/?view=rev&amp;amp;rev=1236529&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/thrift/trunk/compiler/cpp/src/generate/t_cpp_generator.cc&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/test/OptionalRequiredTest.cpp&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/test/OptionalRequiredTest.thrift&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12633534">THRIFT-1862</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12499604" name="THRIFT-1394.patch" size="2055" author="diwaker" created="Tue, 18 Oct 2011 22:10:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>88905</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 43 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i083pj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>45200</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>