<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:26:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-4237] Go TServerSocket Race Conditions</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-4237</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;Run the following test with &lt;tt&gt;go test -race -run TestSocketConcurrency&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;func TestSocketConcurrency(t *testing.T) {
	host := &lt;span class=&quot;code-quote&quot;&gt;&quot;127.0.0.1&quot;&lt;/span&gt;
	port := 9090
	addr := fmt.Sprintf(&lt;span class=&quot;code-quote&quot;&gt;&quot;%s:%d&quot;&lt;/span&gt;, host, port)

	socket := CreateServerSocket(t, addr)
	go func() { socket.Listen() }()
	go func() { socket.Interrupt() }()
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This will result in an error from the race detector. It looks like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;go test -v -race -run TestSocketConcurrency
=== RUN   TestSocketConcurrency
--- PASS: TestSocketConcurrency (0.00s)
==================
WARNING: DATA RACE
Write at 0x00c420016870 by goroutine 7:
  git.apache.org/thrift.git/lib/go/thrift.(*TServerSocket).Listen()
      /Users/zwass/dev/go/src/git.apache.org/thrift.git/lib/go/thrift/server_socket.go:63 +0x134
  git.apache.org/thrift.git/lib/go/thrift.TestSocketConcurrency.func1()
      /Users/zwass/dev/go/src/git.apache.org/thrift.git/lib/go/thrift/server_socket_test.go:50 +0x38

Previous read at 0x00c420016870 by goroutine 8:
  git.apache.org/thrift.git/lib/go/thrift.(*TServerSocket).Close()
      /Users/zwass/dev/go/src/git.apache.org/thrift.git/lib/go/thrift/server_socket.go:114 +0x7b
  git.apache.org/thrift.git/lib/go/thrift.(*TServerSocket).Interrupt()
      /Users/zwass/dev/go/src/git.apache.org/thrift.git/lib/go/thrift/server_socket.go:123 +0x6b
  git.apache.org/thrift.git/lib/go/thrift.TestSocketConcurrency.func2()
      /Users/zwass/dev/go/src/git.apache.org/thrift.git/lib/go/thrift/server_socket_test.go:51 +0x38

Goroutine 7 (running) created at:
  git.apache.org/thrift.git/lib/go/thrift.TestSocketConcurrency()
      /Users/zwass/dev/go/src/git.apache.org/thrift.git/lib/go/thrift/server_socket_test.go:50 +0x1a8
  testing.tRunner()
      /usr/local/Cellar/go/1.8/libexec/src/testing/testing.go:657 +0x107

Goroutine 8 (running) created at:
  git.apache.org/thrift.git/lib/go/thrift.TestSocketConcurrency()
      /Users/zwass/dev/go/src/git.apache.org/thrift.git/lib/go/thrift/server_socket_test.go:51 +0x1ca
  testing.tRunner()
      /usr/local/Cellar/go/1.8/libexec/src/testing/testing.go:657 +0x107
==================
==================
WARNING: DATA RACE
Write at 0x00c420016870 by goroutine 8:
  git.apache.org/thrift.git/lib/go/thrift.(*TServerSocket).Close.func1()
      /Users/zwass/dev/go/src/git.apache.org/thrift.git/lib/go/thrift/server_socket.go:112 +0x3b
  git.apache.org/thrift.git/lib/go/thrift.(*TServerSocket).Close()
      /Users/zwass/dev/go/src/git.apache.org/thrift.git/lib/go/thrift/server_socket.go:117 +0xe6
  git.apache.org/thrift.git/lib/go/thrift.(*TServerSocket).Interrupt()
      /Users/zwass/dev/go/src/git.apache.org/thrift.git/lib/go/thrift/server_socket.go:123 +0x6b
  git.apache.org/thrift.git/lib/go/thrift.TestSocketConcurrency.func2()
      /Users/zwass/dev/go/src/git.apache.org/thrift.git/lib/go/thrift/server_socket_test.go:51 +0x38

Previous read at 0x00c420016870 by goroutine 7:
  git.apache.org/thrift.git/lib/go/thrift.(*TServerSocket).Listen()
      /Users/zwass/dev/go/src/git.apache.org/thrift.git/lib/go/thrift/server_socket.go:56 +0x48
  git.apache.org/thrift.git/lib/go/thrift.TestSocketConcurrency.func1()
      /Users/zwass/dev/go/src/git.apache.org/thrift.git/lib/go/thrift/server_socket_test.go:50 +0x38

Goroutine 8 (running) created at:
  git.apache.org/thrift.git/lib/go/thrift.TestSocketConcurrency()
      /Users/zwass/dev/go/src/git.apache.org/thrift.git/lib/go/thrift/server_socket_test.go:51 +0x1ca
  testing.tRunner()
      /usr/local/Cellar/go/1.8/libexec/src/testing/testing.go:657 +0x107

Goroutine 7 (finished) created at:
  git.apache.org/thrift.git/lib/go/thrift.TestSocketConcurrency()
      /Users/zwass/dev/go/src/git.apache.org/thrift.git/lib/go/thrift/server_socket_test.go:50 +0x1a8
  testing.tRunner()
      /usr/local/Cellar/go/1.8/libexec/src/testing/testing.go:657 +0x107
==================
FAIL
exit status 1
FAIL	git.apache.org/thrift.git/lib/go/thrift	0.186s
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I believe this is because &lt;tt&gt;Interrupt()&lt;/tt&gt;&lt;br/&gt;
 (&lt;a href=&quot;https://github.com/apache/thrift/blob/master/lib/go/thrift/server_socket.go#L120&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/blob/master/lib/go/thrift/server_socket.go#L120&lt;/a&gt;) and &lt;tt&gt;Listen()&lt;/tt&gt; (&lt;a href=&quot;https://github.com/apache/thrift/blob/master/lib/go/thrift/server_socket.go#L55&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/blob/master/lib/go/thrift/server_socket.go#L55&lt;/a&gt;) both read and write &lt;tt&gt;p.listener&lt;/tt&gt;, but only &lt;tt&gt;Interrupt()&lt;/tt&gt; locks the mutex.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13082669">THRIFT-4237</key>
            <summary>Go TServerSocket Race Conditions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zwass">Zach Wasserman</assignee>
                                    <reporter username="zwass">Zach Wasserman</reporter>
                        <labels>
                            <label>concurrency</label>
                    </labels>
                <created>Tue, 27 Jun 2017 00:03:02 +0000</created>
                <updated>Thu, 14 Dec 2017 13:56:11 +0000</updated>
                            <resolved>Sat, 8 Jul 2017 13:37:26 +0000</resolved>
                                    <version>0.10.0</version>
                                    <fixVersion>0.11.0</fixVersion>
                                    <component>Go - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16064964" author="githubbot" created="Tue, 27 Jun 2017 15:01:59 +0000"  >&lt;p&gt;GitHub user zwass opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1300&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1300&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4237&quot; title=&quot;Go TServerSocket Race Conditions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4237&quot;&gt;&lt;del&gt;THRIFT-4237&lt;/del&gt;&lt;/a&gt; Fix data races in Go TServerSocket&lt;/p&gt;

&lt;p&gt;    Incorrect lock semantics resulted in a race condition in the TServerSocket&lt;br/&gt;
    implementation. This commit adds a unit test that detects this, and fixes up&lt;br/&gt;
    the locking semantics.&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4237&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/THRIFT-4237&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/zwass/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/zwass/thrift&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4237&quot; title=&quot;Go TServerSocket Race Conditions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4237&quot;&gt;&lt;del&gt;THRIFT-4237&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1300.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1300.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1300&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit d8ea850be897689cca7f2c30174d6c0d6a5e4716&lt;br/&gt;
Author: Zachary Wasserman &amp;lt;zachwass2000@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-06-27T14:58:13Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4237&quot; title=&quot;Go TServerSocket Race Conditions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4237&quot;&gt;&lt;del&gt;THRIFT-4237&lt;/del&gt;&lt;/a&gt; Fix data races in Go TServerSocket&lt;/p&gt;

&lt;p&gt;    Incorrect lock semantics resulted in a race condition in the TServerSocket&lt;br/&gt;
    implementation. This commit adds a unit test that detects this, and fixes up&lt;br/&gt;
    the locking semantics.&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4237&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/THRIFT-4237&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16065773" author="githubbot" created="Wed, 28 Jun 2017 01:27:05 +0000"  >&lt;p&gt;Github user zwass commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1300&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1300&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @Jens-G it appears I&apos;ve introduced some issue that causes the tests to hang. Is there a good way to run just the Go tests in verbose mode? I&apos;ve connected directly to a shell in the docker build container but haven&apos;t yet found a way.&lt;/p&gt;</comment>
                            <comment id="16071253" author="githubbot" created="Sat, 1 Jul 2017 14:06:29 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1300&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1300&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16071255" author="jensg" created="Sat, 1 Jul 2017 14:06:44 +0000"  >&lt;p&gt;Commited, thanks again!&lt;/p&gt;</comment>
                            <comment id="16071256" author="jensg" created="Sat, 1 Jul 2017 14:09:37 +0000"  >&lt;p&gt;Wait ... what? Is that not still unsolved then? I did not had any hangs but that may not mean anything ...&lt;/p&gt;</comment>
                            <comment id="16075286" author="zwass" created="Wed, 5 Jul 2017 19:41:57 +0000"  >&lt;p&gt;I believed this to be an appropriate solution, but then it looked like CI hung on the tests. If everything seems to be working, I think this is good. It works for us in our use of the library.&lt;/p&gt;</comment>
                            <comment id="16075344" author="jensg" created="Wed, 5 Jul 2017 20:22:24 +0000"  >&lt;p&gt;It only hangs sometimes, but then with an interesting message:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Making check in test
make[3]: Entering directory `/thrift/src/lib/go/test&apos;
mkdir -p gopath/src
grep -v list.*map.*list.*map ../../../test/ThriftTest.thrift | grep -v &lt;span class=&quot;code-quote&quot;&gt;&apos;set&amp;lt;Insanity&amp;gt;&apos;&lt;/span&gt; &amp;gt; ThriftTest.thrift
../../../compiler/cpp/thrift -out gopath/src/ --gen go:thrift_import=thrift -r IncludesTest.thrift
[WARNING:/thrift/src/lib/go/test/ThriftTest.thrift:45] No generator named &lt;span class=&quot;code-quote&quot;&gt;&apos;noexist&apos;&lt;/span&gt; could be found!
[WARNING:/thrift/src/lib/go/test/ThriftTest.thrift:47] cpp generator does not accept &lt;span class=&quot;code-quote&quot;&gt;&apos;noexist&apos;&lt;/span&gt; as sub-namespace!
[WARNING:/thrift/src/lib/go/test/ThriftTest.thrift:45] No generator named &lt;span class=&quot;code-quote&quot;&gt;&apos;noexist&apos;&lt;/span&gt; could be found!
[WARNING:/thrift/src/lib/go/test/ThriftTest.thrift:47] cpp generator does not accept &lt;span class=&quot;code-quote&quot;&gt;&apos;noexist&apos;&lt;/span&gt; as sub-namespace!
../../../compiler/cpp/thrift -out gopath/src/ --gen go:thrift_import=thrift BinaryKeyTest.thrift
../../../compiler/cpp/thrift -out gopath/src/ --gen go:thrift_import=thrift MultiplexedProtocolTest.thrift
../../../compiler/cpp/thrift -out gopath/src/ --gen go:thrift_import=thrift OnewayTest.thrift
../../../compiler/cpp/thrift -out gopath/src/ --gen go:thrift_import=thrift OptionalFieldsTest.thrift
../../../compiler/cpp/thrift -out gopath/src/ --gen go:thrift_import=thrift ServicesTest.thrift
../../../compiler/cpp/thrift -out gopath/src/ --gen go:thrift_import=thrift GoTagTest.thrift
../../../compiler/cpp/thrift -out gopath/src/ --gen go:thrift_import=thrift TypedefFieldTest.thrift
../../../compiler/cpp/thrift -out gopath/src/ --gen go:thrift_import=thrift RefAnnotationFieldsTest.thrift
../../../compiler/cpp/thrift -out gopath/src/ --gen go:thrift_import=thrift UnionDefaultValueTest.thrift
../../../compiler/cpp/thrift -out gopath/src/ --gen go:thrift_import=thrift ErrorTest.thrift
../../../compiler/cpp/thrift -out gopath/src/ --gen go:thrift_import=thrift NamesTest.thrift
../../../compiler/cpp/thrift -out gopath/src/ --gen go:thrift_import=thrift InitialismsTest.thrift
../../../compiler/cpp/thrift -out gopath/src/ --gen go:thrift_import=thrift,read_write_private DontExportRWTest.thrift
../../../compiler/cpp/thrift -out gopath/src/ --gen go:thrift_import=thrift,ignore_initialisms IgnoreInitialismsTest.thrift
GOPATH=`pwd`/gopath /usr/local/go/bin/go get github.com/golang/mock/gomock
ln -nfs ../../../thrift gopath/src/thrift
ln -nfs ../../tests gopath/src/tests
cp -r ./dontexportrwtest gopath/src
touch gopath
GOPATH=`pwd`/gopath /usr/local/go/bin/go build \
				includestest \
				binarykeytest \
				servicestest \
				typedeffieldtest \
				refannotationfieldstest \
				errortest	\
				namestest \
				initialismstest \
				dontexportrwtest \
				ignoreinitialismstest
GOPATH=`pwd`/gopath /usr/local/go/bin/go test thrift tests dontexportrwtest
ok  	thrift	0.027s


No output has been received in the last 10m0s, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; potentially indicates a stalled build or something wrong with the build itself.
Check the details on how to adjust your build configuration on: https:&lt;span class=&quot;code-comment&quot;&gt;//docs.travis-ci.com/user/common-build-problems/#Build-times-out-because-no-output-was-received
&lt;/span&gt;
The build has been terminated
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16075409" author="zwass" created="Wed, 5 Jul 2017 20:52:20 +0000"  >&lt;p&gt;Can you help me understand which test is failing? And how I can run that test locally? I am happy to debug this, but I can&apos;t even tell from this output what is failing.&lt;/p&gt;</comment>
                            <comment id="16075423" author="jensg" created="Wed, 5 Jul 2017 21:00:08 +0000"  >&lt;p&gt;From what I can see its &lt;tt&gt;make check&lt;/tt&gt; in the &lt;tt&gt;/lib/go&lt;/tt&gt; folder.&lt;/p&gt;</comment>
                            <comment id="16075492" author="zwass" created="Wed, 5 Jul 2017 21:52:25 +0000"  >&lt;p&gt;Presumably &lt;tt&gt;make check&lt;/tt&gt; runs some set of tests? How can I find which test it is that fails? And how I can run the tests on my local machine? When I do &lt;tt&gt;make check&lt;/tt&gt; in that directory, I get the following:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;$ make check
 cd ../.. &amp;amp;&amp;amp; /bin/bash /thrift/src/missing automake-1.14 --foreign lib/go/Makefile
/bin/bash: /thrift/src/missing: No such file or directory
make: *** [Makefile.in] Error 127
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16076671" author="githubbot" created="Thu, 6 Jul 2017 15:10:34 +0000"  >&lt;p&gt;Github user econner commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1300&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1300&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Does running ``make check`` from ``/thrift/src/test/go`` not do what you want?&lt;/p&gt;</comment>
                            <comment id="16076676" author="econner724" created="Thu, 6 Jul 2017 15:14:45 +0000"  >&lt;p&gt;Oops, just seeing the discussion here.  Disregard my comment above.&lt;/p&gt;</comment>
                            <comment id="16076682" author="githubbot" created="Thu, 6 Jul 2017 15:20:03 +0000"  >&lt;p&gt;Github user zwass commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1300&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1300&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    ```&lt;br/&gt;
    $ pwd&lt;br/&gt;
    /Users/zwass/dev/go/src/git.apache.org/thrift.git/lib/go&lt;br/&gt;
    $ make check&lt;br/&gt;
     cd ../.. &amp;amp;&amp;amp; /bin/bash /thrift/src/missing automake-1.14 --foreign lib/go/Makefile&lt;br/&gt;
    /bin/bash: /thrift/src/missing: No such file or directory&lt;br/&gt;
    make: *** &lt;span class=&quot;error&quot;&gt;&amp;#91;Makefile.in&amp;#93;&lt;/span&gt; Error 127&lt;br/&gt;
    ```&lt;/p&gt;</comment>
                            <comment id="16076701" author="econner724" created="Thu, 6 Jul 2017 15:30:18 +0000"  >&lt;p&gt;Have you tried running from inside the docker container?&lt;/p&gt;

&lt;p&gt;Here is how I have been able to run the tests locally on macos,&lt;br/&gt;
cd build/docker&lt;br/&gt;
docker build ubuntu&lt;/p&gt;

&lt;p&gt;Once the image is finished building get the image id via&lt;br/&gt;
docker images&lt;/p&gt;

&lt;p&gt;Run the docker image &amp;amp; open a shell,&lt;br/&gt;
docker run -v /Users/eric/Documents/thrift:/thrift/src -it &lt;em&gt;&amp;lt;image_id&amp;gt;&lt;/em&gt; /bin/bash&lt;/p&gt;

&lt;p&gt;Run&lt;br/&gt;
./bootstrap.sh&lt;br/&gt;
./configure&lt;br/&gt;
make&lt;/p&gt;

&lt;p&gt;Then make check from wherever.&lt;/p&gt;
</comment>
                            <comment id="16077415" author="zwass" created="Fri, 7 Jul 2017 00:38:31 +0000"  >&lt;p&gt;Thank you for the assistance, Eric. I had issues running the tests from within the docker container, but I was able to get things going locally on my mac by following your instructions.&lt;/p&gt;

&lt;p&gt;My original patch introduces what is effectively a deadlock when trying to close the socket. The problem manifests by hanging the tests at this line: &lt;a href=&quot;https://github.com/apache/thrift/blob/master/lib/go/test/tests/multiplexed_protocol_test.go#L156&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/blob/master/lib/go/test/tests/multiplexed_protocol_test.go#L156&lt;/a&gt;. The program is not truly deadlocked, because the &lt;tt&gt;Accept()&lt;/tt&gt; call could return, but we need to relinquish the lock before blocking on the &lt;tt&gt;Accept()&lt;/tt&gt; (so that &lt;tt&gt;Interrupt()&lt;/tt&gt; can acquire it).&lt;/p&gt;

&lt;p&gt;I will PR a fix to this that should leave the race conditions resolved while fixing the effective deadlock.&lt;/p&gt;</comment>
                            <comment id="16077418" author="githubbot" created="Fri, 7 Jul 2017 00:40:55 +0000"  >&lt;p&gt;GitHub user zwass opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1304&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1304&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4237&quot; title=&quot;Go TServerSocket Race Conditions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4237&quot;&gt;&lt;del&gt;THRIFT-4237&lt;/del&gt;&lt;/a&gt; Fix effective deadlock introduced by original patch&lt;/p&gt;

&lt;p&gt;    See discussion in &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4237&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/THRIFT-4237&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/zwass/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/zwass/thrift&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4237&quot; title=&quot;Go TServerSocket Race Conditions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4237&quot;&gt;&lt;del&gt;THRIFT-4237&lt;/del&gt;&lt;/a&gt;-fix&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1304.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1304.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1304&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 6e9d0e79a98e62aef86aaada2da7fc0e04795d28&lt;br/&gt;
Author: Zachary Wasserman &amp;lt;zachwass2000@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-07-07T00:39:55Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4237&quot; title=&quot;Go TServerSocket Race Conditions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4237&quot;&gt;&lt;del&gt;THRIFT-4237&lt;/del&gt;&lt;/a&gt; Fix effective deadlock introduced by original patch&lt;/p&gt;

&lt;p&gt;    See discussion in &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4237&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/THRIFT-4237&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16077562" author="econner724" created="Fri, 7 Jul 2017 04:36:32 +0000"  >&lt;p&gt;Thanks Zach.  I would review this code, but am not familiar enough with Go to understand it.&lt;/p&gt;

&lt;p&gt;It appears I&apos;ve introduced another change which breaks a test :-/.  I will put up a PR to fix that and then we should be green!&lt;/p&gt;</comment>
                            <comment id="16078415" author="zwass" created="Fri, 7 Jul 2017 17:27:32 +0000"  >&lt;p&gt;Eric, I&apos;d encourage you to review it anyway. Always happier to get more eyes on it. Go code pretty much always does just what it looks like. The only thing I&apos;d add is that &lt;tt&gt;defer&lt;/tt&gt; statements are executed when the enclosing function returns.&lt;/p&gt;

&lt;p&gt;Should I rebase to fix up the tests?&lt;/p&gt;</comment>
                            <comment id="16078442" author="githubbot" created="Fri, 7 Jul 2017 17:55:52 +0000"  >&lt;p&gt;Github user econner commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1304#discussion_r126207049&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1304#discussion_r126207049&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/go/thrift/server_socket.go &amp;#8212;&lt;br/&gt;
    @@ -68,15 +68,18 @@ func (p *TServerSocket) Listen() error {&lt;/p&gt;

&lt;p&gt;     func (p *TServerSocket) Accept() (TTransport, error) {&lt;br/&gt;
     	p.mu.RLock()&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;defer p.mu.RUnlock()&lt;br/&gt;
    +	listener := p.listener&lt;br/&gt;
    +	interrupted := p.interrupted&lt;br/&gt;
    +	p.mu.RUnlock()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Hmm.  It seems safest to me to unlock this mutex after the value of ``interrupted`` has been read (assuming it is only intended to protect ``interrupted``).&lt;/p&gt;

&lt;p&gt;    For example, &lt;br/&gt;
    Thread 1 reads the value of interrupted as false&lt;br/&gt;
    Thread 1 gets interrupted at line 74&lt;br/&gt;
    Thread 2 sets p.interrupted to true&lt;br/&gt;
    Thread 1 sees interrupted == false at line 75&lt;/p&gt;

&lt;p&gt;    The question is would we want thread 1 to see interrupted == true ?&lt;/p&gt;

&lt;p&gt;    This is possibly a case that does not happen.  I have very limited knowledge of what this code is doing.&lt;/p&gt;</comment>
                            <comment id="16078528" author="githubbot" created="Fri, 7 Jul 2017 18:58:49 +0000"  >&lt;p&gt;Github user Jens-G commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1304#discussion_r126221534&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1304#discussion_r126221534&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/go/thrift/server_socket.go &amp;#8212;&lt;br/&gt;
    @@ -68,15 +68,18 @@ func (p *TServerSocket) Listen() error {&lt;/p&gt;

&lt;p&gt;     func (p *TServerSocket) Accept() (TTransport, error) {&lt;br/&gt;
     	p.mu.RLock()&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;defer p.mu.RUnlock()&lt;br/&gt;
    +	listener := p.listener&lt;br/&gt;
    +	interrupted := p.interrupted&lt;br/&gt;
    +	p.mu.RUnlock()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Agree. Looks strange. and the comment even says&lt;/p&gt;

&lt;p&gt;          // Protects the interrupted value to make it thread safe.&lt;/p&gt;

&lt;p&gt;    What about moving the ```listener := p.listener``` line down just before it is used? Or do I overlook sth?&lt;/p&gt;</comment>
                            <comment id="16078585" author="githubbot" created="Fri, 7 Jul 2017 19:47:24 +0000"  >&lt;p&gt;Github user zwass commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1304#discussion_r126230574&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1304#discussion_r126230574&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/go/thrift/server_socket.go &amp;#8212;&lt;br/&gt;
    @@ -68,15 +68,18 @@ func (p *TServerSocket) Listen() error {&lt;/p&gt;

&lt;p&gt;     func (p *TServerSocket) Accept() (TTransport, error) {&lt;br/&gt;
     	p.mu.RLock()&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;defer p.mu.RUnlock()&lt;br/&gt;
    +	listener := p.listener&lt;br/&gt;
    +	interrupted := p.interrupted&lt;br/&gt;
    +	p.mu.RUnlock()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I will admit I also only have limited knowledge of what the code is doing. I am guessing as to the intended behavior based on the implementation. Is the expected behavior documented somewhere?&lt;/p&gt;

&lt;p&gt;    @econner This is something I considered, and here&apos;s what I reasoned out: &lt;br/&gt;
    Ideally, we would ensure that the scenario you describe does not take place by continuing to hold the lock. In reality, the call to `listener.Accept()` may block, and if the lock was held this would prevent the `Interrupt()` method from acquiring the lock (resulting in the &quot;deadlock&quot; experienced previously). In the case that the instructions are interleaved as you describe, we will still return an error (albeit a different one) on line 84.&lt;/p&gt;

&lt;p&gt;    @Jens-G That does look viable to me.&lt;/p&gt;
</comment>
                            <comment id="16079135" author="githubbot" created="Sat, 8 Jul 2017 13:36:26 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1304&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1304&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16079136" author="jensg" created="Sat, 8 Jul 2017 13:37:26 +0000"  >&lt;p&gt;Committed, thanks!&lt;/p&gt;</comment>
                            <comment id="16079206" author="zwass" created="Sat, 8 Jul 2017 16:14:38 +0000"  >&lt;p&gt;Thank you for your patience while we resolved that. I think I have identified some other potential issues, so you&apos;ll probably be hearing from me again soon. Cheers!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 19 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3grcv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>