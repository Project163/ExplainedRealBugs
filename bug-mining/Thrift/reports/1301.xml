<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:19:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-3224] Fix TNamedPipeServer unpredictable behavior on accept</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-3224</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;Application bahavior utilizing TNamedPipeServer is unpredictable due misuse of TAutoHandle.&lt;/p&gt;

&lt;p&gt;Project uses TAutoHandle class, an analogy of std::unique_ptr, for managing WIN32 handles. The dangerous members of this concept are: the direct getter &quot;HANDLE TAutoHandle::h&quot; and release method &quot;void __thiscall TAutoHandle::release()&quot; &lt;/p&gt;

&lt;p&gt;Below code citation introduces serous bug:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;{
    TAutoCrit lock(pipe_protect_);
    GlobalOutput.printf(&lt;span class=&quot;code-quote&quot;&gt;&quot;Client connected.&quot;&lt;/span&gt;);
    shared_ptr&amp;lt;TPipe&amp;gt; client(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TPipe(Pipe_.h));
    Pipe_.release();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The getter is  used in TNamedPipeServer::acceptImpl() to pass internal  handle value to c-tor of TPipe and just after c-tion HANDLE__thiscall TAutoHandle::release() is called to release ownership. That means the TPipe object is expected to take ownership of the resource, but if TPipe c-tor throws the d-tor of TAutoHandle is called releasing the resource and the incomplete TPipe object does the same. Since now it is impossible to ensure that the second free of the handle value was not performed on a resource that was opened in meantime by other thread.&lt;/p&gt;

&lt;p&gt;I propose to solve the issue by ensuring the handle is not owned by two objects at a time.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows&lt;/p&gt;</environment>
        <key id="12843157">THRIFT-3224</key>
            <summary>Fix TNamedPipeServer unpredictable behavior on accept</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pjanicki">Pawe&#322; Janicki</assignee>
                                    <reporter username="pjanicki">Pawe&#322; Janicki</reporter>
                        <labels>
                            <label>patch</label>
                    </labels>
                <created>Tue, 7 Jul 2015 11:00:14 +0000</created>
                <updated>Tue, 21 Jul 2015 02:21:08 +0000</updated>
                            <resolved>Thu, 16 Jul 2015 13:15:06 +0000</resolved>
                                    <version>0.9.2</version>
                                    <fixVersion>0.9.3</fixVersion>
                                    <component>C++ - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="7200">2h</timeoriginalestimate>
                            <timeestimate seconds="7200">2h</timeestimate>
                                        <comments>
                            <comment id="14617344" author="ben.craig" created="Tue, 7 Jul 2015 20:36:10 +0000"  >&lt;p&gt;This patch leaks pipes if the TPipe ctor throws.&lt;/p&gt;

&lt;p&gt;There is a bug here, but this isn&apos;t the right place to fix it.&lt;/p&gt;

&lt;p&gt;The pattern that needs to be followed is &apos;do everything that can fail first, then commit&apos;.  The existing code messes that up in TPipe.cpp, TWaitableNamedPipeImpl ctor.  Pipe_ shouldn&apos;t be given ownership of the passed in pipe until after all the failing operations have completed (mainly buffer.resize() and beginAsyncRead() ).&lt;/p&gt;</comment>
                            <comment id="14617829" author="githubbot" created="Wed, 8 Jul 2015 01:56:47 +0000"  >&lt;p&gt;GitHub user ben-craig opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/544&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/544&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3224&quot; title=&quot;Fix TNamedPipeServer unpredictable behavior on accept&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3224&quot;&gt;&lt;del&gt;THRIFT-3224&lt;/del&gt;&lt;/a&gt; Fix TNamedPipeServer unpredictable behavior on accept&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/ben-craig/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ben-craig/thrift&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3224&quot; title=&quot;Fix TNamedPipeServer unpredictable behavior on accept&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3224&quot;&gt;&lt;del&gt;THRIFT-3224&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/544.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/544.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #544&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 1b73af1a4f59e2c85127a70d537712f130329462&lt;br/&gt;
Author: Ben Craig &amp;lt;bencraig@apache.org&amp;gt;&lt;br/&gt;
Date:   2015-07-08T01:54:50Z&lt;/p&gt;

&lt;p&gt;    Fixing double pipe close&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14620435" author="pjanicki" created="Thu, 9 Jul 2015 12:34:45 +0000"  >&lt;p&gt;I&apos;ve rewieved your pull request &lt;a href=&quot;https://github.com/apache/thrift/pull/544&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/544&lt;/a&gt; and it is risky solution while it makes two TAutoHandle assigned with the same handle at a time, and it is just matter of time when one will forget to call release().&lt;/p&gt;

&lt;p&gt;Lets improve the solution by passing a reference of TAutoHandle to c-tor of TWaitableNamedPipeImpl. See proposed patch 0002.&lt;/p&gt;</comment>
                            <comment id="14620464" author="pjanicki" created="Thu, 9 Jul 2015 13:04:13 +0000"  >&lt;p&gt;Fixed some formatting in patch 0003&lt;/p&gt;</comment>
                            <comment id="14620518" author="pjanicki" created="Thu, 9 Jul 2015 13:44:51 +0000"  >&lt;p&gt;After testing in runtime found that I forget to update raw handles.  Published patch 0004&lt;/p&gt;</comment>
                            <comment id="14620524" author="ben.craig" created="Thu, 9 Jul 2015 13:47:15 +0000"  >&lt;p&gt;I agree that TAutoHandle references can make this less error prone.  I&apos;ll work on this patch a bit more tonight.  Thanks for your patience!&lt;/p&gt;</comment>
                            <comment id="14621612" author="ben.craig" created="Fri, 10 Jul 2015 02:18:25 +0000"  >&lt;p&gt;updated my pull request.  Take a look at that when you get a chance.  I haven&apos;t had time to test the changes.  I&apos;m hoping to add some tests tomorrow, and hopefully push this through at that point.&lt;/p&gt;</comment>
                            <comment id="14621910" author="pjanicki" created="Fri, 10 Jul 2015 07:43:18 +0000"  >&lt;p&gt;@Ben you early acquire handle by initialization list. Why not do it as last operation in c-tor body, following the rule &quot;do everything what can fail first, then commit&quot;. In case exception is thrown if the handle will not be closed and the constructing thread has more possibilites left to continue execution.&lt;/p&gt;</comment>
                            <comment id="14627073" author="ben.craig" created="Tue, 14 Jul 2015 21:24:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pjanicki&quot; class=&quot;user-hover&quot; rel=&quot;pjanicki&quot;&gt;pjanicki&lt;/a&gt; I have updated my pull request.  It adds a test, and should also fix &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3225&quot; title=&quot;Fix TPipeServer unpredictable behavior on interrupt()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3225&quot;&gt;&lt;del&gt;THRIFT-3225&lt;/del&gt;&lt;/a&gt;.  If you get a chance, take a look at it and see if it fixes your uses as well.&lt;/p&gt;</comment>
                            <comment id="14629696" author="githubbot" created="Thu, 16 Jul 2015 13:14:31 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/544&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/544&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14629867" author="hudson" created="Thu, 16 Jul 2015 15:13:41 +0000"  >&lt;p&gt;SUCCESS: Integrated in Thrift #1613 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/1613/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/1613/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3224&quot; title=&quot;Fix TNamedPipeServer unpredictable behavior on accept&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3224&quot;&gt;&lt;del&gt;THRIFT-3224&lt;/del&gt;&lt;/a&gt; Fix TNamedPipeServer unpredictable behavior on accept (ben.craig: rev af2d9c8b88c4fc7045177f1ce6081189627f6413)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;lib/cpp/test/CMakeLists.txt&lt;/li&gt;
	&lt;li&gt;lib/cpp/src/thrift/transport/TPipe.cpp&lt;/li&gt;
	&lt;li&gt;lib/cpp/src/thrift/transport/TPipe.h&lt;/li&gt;
	&lt;li&gt;lib/cpp/test/Makefile.am&lt;/li&gt;
	&lt;li&gt;lib/cpp/src/thrift/transport/TPipeServer.cpp&lt;/li&gt;
	&lt;li&gt;lib/cpp/test/TPipeInterruptTest.cpp&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12743945" name="0001-THRIFT-3224.-cpp-Fix-TNamedPipeServer-unpredictable-.patch" size="2849" author="pjanicki" created="Tue, 7 Jul 2015 11:35:38 +0000"/>
                            <attachment id="12744480" name="0002-THRIFT-3224.-cpp-Fix-TNamedPipeServer-unpredictable-.patch" size="5396" author="pjanicki" created="Thu, 9 Jul 2015 12:35:01 +0000"/>
                            <attachment id="12744487" name="0003-THRIFT-3224.-cpp-Fix-TNamedPipeServer-unpredictable-.patch" size="5263" author="pjanicki" created="Thu, 9 Jul 2015 13:04:13 +0000"/>
                            <attachment id="12744499" name="0004-THRIFT-3224.-cpp-Fix-TNamedPipeServer-unpredictable-.patch" size="5346" author="pjanicki" created="Thu, 9 Jul 2015 13:44:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 18 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2gxlr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>