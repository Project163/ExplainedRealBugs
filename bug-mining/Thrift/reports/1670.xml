<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:25:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-3932] C++ ThreadManager has a rare termination race</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-3932</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;&lt;tt&gt;ThreadManger::join&lt;/tt&gt; calls &lt;tt&gt;stopImpl(true)&lt;/tt&gt;, which in turn calls &lt;tt&gt;removeWorker(workerCount_);&lt;/tt&gt;. The latter waits until &lt;tt&gt;while (workerCount_ != workerMaxCount_)&lt;/tt&gt;. Within the &lt;tt&gt;run&lt;/tt&gt; method of the workers, the last thread that detects &lt;tt&gt;workerCount_ == workerMaxCount_&lt;/tt&gt; notifies &lt;tt&gt;removeWorker&lt;/tt&gt;. The &lt;tt&gt;run&lt;/tt&gt; method has the following additional code that is executed at the very end:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    {
      Synchronized s(manager_-&amp;gt;workerMonitor_);
      manager_-&amp;gt;deadWorkers_.insert(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;-&amp;gt;thread());
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (notifyManager) {
        manager_-&amp;gt;workerMonitor_.notify();
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is an independent synchronized block. Now assume 2 threads. One of them has &lt;tt&gt;notifyManager=true&lt;/tt&gt; as it detected the &lt;tt&gt;workerCount_ == workerMaxCount_&lt;/tt&gt; condition earlier. It is possible that this thread gets to execute  the above code block first, &lt;tt&gt;ThreadManager&lt;/tt&gt;&apos;s &lt;tt&gt;removeWorker&lt;/tt&gt; method unblocks, and eventually &lt;tt&gt;ThreadManager&lt;/tt&gt;&apos;s &lt;tt&gt;join&lt;/tt&gt; returns and the object is destructed. When the other thread reaches the synchronized block above, it will crash, as the manager is not around anymore.&lt;/p&gt;

&lt;p&gt;Besides, &lt;tt&gt;ThreadManager&lt;/tt&gt; never joins its threads.&lt;/p&gt;

&lt;p&gt;Attached is a patch.&lt;/p&gt;

&lt;div class=&quot;panel&quot; style=&quot;background-color: #FFFFCE;border-color: #ccc;border-style: dashed;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: dashed;border-bottom-color: #ccc;background-color: #F7D6C1;&quot;&gt;&lt;b&gt;Resolution Details&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;panelContent&quot; style=&quot;background-color: #FFFFCE;&quot;&gt;
&lt;p&gt;A fair number of things were improved with this pull request:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;There are three monitors used for signaling; two of them use the same mutex and then the workerMonitor is using its own. I made all three use the same mutex.&lt;/li&gt;
	&lt;li&gt;I replaced all calls to Synchronize with Guard on the mutex_ so it is a bit clearer that there is one lock protecting everything.&lt;/li&gt;
	&lt;li&gt;The worker run loop expires tasks as it encounters them. Now we only call removeExpiredTasks if there&apos;s no room during add.&lt;/li&gt;
	&lt;li&gt;I found that when worker threads are removed they are not joined; if a thread is not detached we now join those threads.&lt;/li&gt;
	&lt;li&gt;I added better documentation and simplified the Worker::run() a little so it is easier to understand, but the logic is the same. idle_ was not used and removed.&lt;/li&gt;
	&lt;li&gt;I found that remove(Task) simply wasn&apos;t implemented at all! so I added code for that and tests.&lt;/li&gt;
	&lt;li&gt;Release mode tests of thread manager would not fail on error because they use assert() to verify results! If we only do release builds in CI, these tests may have been silently failing for a long time.&lt;/li&gt;
	&lt;li&gt;ThreadManager::join() is unnecessary, as stop() will join worker threads (as will removeWorker) depending on the ThreadFactory&apos;s detached disposition.&lt;/li&gt;
	&lt;li&gt;Cleaned up some technical debt from the TServerFramework refactoring:&lt;/li&gt;
	&lt;li&gt;Cleaned up some things in the different platform thread factories. Some abstractions were unnecessary.&lt;/li&gt;
	&lt;li&gt;Reduced overall time on concurrency test to about 30 seconds on my dev system while increasing the reliability and improving test coverage significantly. I ran it 100 times in a loop.&lt;/li&gt;
	&lt;li&gt;Added tests for most of the ThreadManager APIs.&lt;/li&gt;
	&lt;li&gt;Tested with posix, std, and boost threads on linux.&lt;/li&gt;
	&lt;li&gt;Tested on Windows.&lt;/li&gt;
	&lt;li&gt;Fixed a math error in time calculation that was present on Windows (with VS2010) which made expiring tasks impossible (unit test proved the issue and the fix).&lt;/li&gt;
	&lt;li&gt;Re-enable unit tests in the appveyor build that are no longer unstable.&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13006129">THRIFT-3932</key>
            <summary>C++ ThreadManager has a rare termination race</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jking3">James E. King III</assignee>
                                    <reporter username="bgedik">Bu&#287;ra Gedik</reporter>
                        <labels>
                    </labels>
                <created>Tue, 20 Sep 2016 07:45:42 +0000</created>
                <updated>Thu, 11 Jan 2018 12:43:01 +0000</updated>
                            <resolved>Sat, 12 Nov 2016 20:22:50 +0000</resolved>
                                                    <fixVersion>0.10.0</fixVersion>
                                    <component>C++ - Library</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="61200">17h</timespent>
                                <comments>
                            <comment id="15523358" author="jking3" created="Mon, 26 Sep 2016 15:21:41 +0000"  >&lt;p&gt;I am planning on reviewing this, apply it locally, and if successful submitting a pull request for it unless you beat me to it.&lt;/p&gt;</comment>
                            <comment id="15523383" author="bgedik" created="Mon, 26 Sep 2016 15:31:00 +0000"  >&lt;p&gt;Please go ahead.&lt;/p&gt;</comment>
                            <comment id="15523411" author="bgedik" created="Mon, 26 Sep 2016 15:42:34 +0000"  >&lt;p&gt;Btw, the change I made to the initialization of &lt;tt&gt;workerMonitor_&lt;/tt&gt; is most likely not needed, but does not hurt. I&apos;ll appreciate if you review and update as you see fit.&lt;/p&gt;</comment>
                            <comment id="15533786" author="jking3" created="Thu, 29 Sep 2016 19:21:58 +0000"  >&lt;p&gt;Could you rework your patch on master?  The code in ThreadManager has changed since 0.9.3 was released and your patch does not apply.  The issues you mentioned may have already been resolved.  Specifically I worked on &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3233&quot; title=&quot;Fix C++ ThreadManager::Impl::removeWorker worker join&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3233&quot;&gt;&lt;del&gt;THRIFT-3233&lt;/del&gt;&lt;/a&gt; which may have resolved the issue.  See:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/thrift/commits/master/lib/cpp/src/thrift/concurrency/ThreadManager.cpp&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/commits/master/lib/cpp/src/thrift/concurrency/ThreadManager.cpp&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(ignore &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3768&quot; title=&quot;TThreadedServer may crash if it is destroyed immediately after it returns from serve(); TThreadedServer disconnects clients when they connec&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3768&quot;&gt;&lt;del&gt;THRIFT-3768&lt;/del&gt;&lt;/a&gt; as it was applied and then reverted, because that particular fix was bad)&lt;/p&gt;</comment>
                            <comment id="15533833" author="bgedik" created="Thu, 29 Sep 2016 19:39:43 +0000"  >&lt;p&gt;You are right, that one addresses the same issue. I looked at the code from here:  &lt;a href=&quot;https://github.com/apache/thrift/pull/992/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/992/files&lt;/a&gt; However, incrementing &lt;tt&gt;workerCount_&lt;/tt&gt; under one monitor (&lt;tt&gt;monitor_&lt;/tt&gt;), and decrementing it under another monitor (&lt;tt&gt;workerMonitor_&lt;/tt&gt;) that does not share its mutex with the first one seems odd to me.&lt;/p&gt;</comment>
                            <comment id="15534011" author="jking3" created="Thu, 29 Sep 2016 20:49:41 +0000"  >&lt;p&gt;I agree; this is not providing the protection desired.  It needs to be corrected.&lt;/p&gt;</comment>
                            <comment id="15536687" author="jking3" created="Fri, 30 Sep 2016 18:38:04 +0000"  >&lt;p&gt;I&apos;ve done a fair bit of work in here today, I&apos;ll post a summary once it passes all the old tests (and some new ones).&lt;/p&gt;</comment>
                            <comment id="15536702" author="bgedik" created="Fri, 30 Sep 2016 18:40:25 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jking&quot; class=&quot;user-hover&quot; rel=&quot;jking&quot;&gt;jking&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15537932" author="githubbot" created="Sat, 1 Oct 2016 05:30:34 +0000"  >&lt;p&gt;GitHub user jeking3 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3932&quot; title=&quot;C++ ThreadManager has a rare termination race&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3932&quot;&gt;&lt;del&gt;THRIFT-3932&lt;/del&gt;&lt;/a&gt;: fixed ThreadManager concurrency issues, added more tests in that area, did a little refactoring and prettying up along the way&lt;/p&gt;

&lt;p&gt;    See the &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3932&quot; title=&quot;C++ ThreadManager has a rare termination race&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3932&quot;&gt;&lt;del&gt;THRIFT-3932&lt;/del&gt;&lt;/a&gt; ticket for more details.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jeking3/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jeking3/thrift&lt;/a&gt; defect/&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3932&quot; title=&quot;C++ ThreadManager has a rare termination race&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3932&quot;&gt;&lt;del&gt;THRIFT-3932&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1103&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 3691db3af28d02e348b79d2c76e527432448b3c6&lt;br/&gt;
Author: James E. King, III &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2016-09-30T22:41:17Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3932&quot; title=&quot;C++ ThreadManager has a rare termination race&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3932&quot;&gt;&lt;del&gt;THRIFT-3932&lt;/del&gt;&lt;/a&gt;: fixed ThreadManager concurrency issues, added more tests in that area, did a little refactoring and prettying up along the way&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15537938" author="jking3" created="Sat, 1 Oct 2016 05:34:55 +0000"  >&lt;p&gt;I found a number of issues that needed fixing:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;There are three monitors used for signaling; two of them use the same mutex and then the workerMonitor is using its own.  I made all three use the same mutex.&lt;/li&gt;
	&lt;li&gt;I replaced all calls to Synchronize with Guard on the mutex_ so it is a bit clearer that there is one lock protecting everything.&lt;/li&gt;
	&lt;li&gt;The worker run loop expires tasks as it encounters them.  Now we only call removeExpiredTasks if there&apos;s no room during add.&lt;/li&gt;
	&lt;li&gt;I found that when worker threads are removed they are not joined; if the thread manager is not detached we now join those threads.&lt;/li&gt;
	&lt;li&gt;I added better documentation and simplified the Worker::run() a little so it is easier to understand, but the logic is the same.  idle_ was not used and removed.&lt;/li&gt;
	&lt;li&gt;I found that remove(Task) simply wasn&apos;t implemented at all! so I added code for that and tests.&lt;/li&gt;
	&lt;li&gt;Release mode tests of thread manager would not fail on error because they use assert() to verify results!  If we only do release builds in CI, these tests may have been silently failing for a long time.&lt;/li&gt;
	&lt;li&gt;ThreadManager::join() is unnecessary, as stop() will join worker threads (as will removeWorker) depending on the ThreadFactory&apos;s detached disposition.&lt;/li&gt;
	&lt;li&gt;Cleaned up some technical debt from the TServerFramework refactoring:
	&lt;ol&gt;
		&lt;li&gt;removed ThreadFactory::setDetached() - changing detached setting while running is dangerous!&lt;/li&gt;
		&lt;li&gt;enforce detached disposition in constructor of TThreadPool (it only works with joinable threads)&lt;/li&gt;
		&lt;li&gt;fix default arguments for TThreadPool to use joinable ThreadFactory&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;Cleaned up some things in the different platform thread factories.  Some abstractions were unnecessary.&lt;/li&gt;
	&lt;li&gt;Reduced overall time on concurrency test to about 30 seconds on my dev system while increasing the reliability and improving test coverage significantly.  I ran it 100 times in a loop.&lt;/li&gt;
	&lt;li&gt;Added tests for most of the ThreadManager APIs.&lt;/li&gt;
	&lt;li&gt;Tested with posix, std, and boost threads on linux.&lt;/li&gt;
	&lt;li&gt;Tested on Windows.&lt;/li&gt;
	&lt;li&gt;Fixed a math error in time calculation that was present on Windows (with VS2010) which made expiring tasks impossible (unit test proved the issue and the fix).&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;in progress&amp;#93;&lt;/span&gt; Re-enable unit tests in the appveyor build that are no longer unstable.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15538134" author="bgedik" created="Sat, 1 Oct 2016 08:02:10 +0000"  >&lt;p&gt;Looks good to me. Great work!&lt;/p&gt;</comment>
                            <comment id="15538551" author="githubbot" created="Sat, 1 Oct 2016 13:45:52 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    It is pretty frustrating when you build, test, repeat many many times and everything looks good, and then the CI build fails, but that&apos;s why it&apos;s there right?&lt;/p&gt;</comment>
                            <comment id="15538724" author="jking3" created="Sat, 1 Oct 2016 15:55:43 +0000"  >&lt;p&gt;Ah, the original logic in removeExpiredTasks was meant to minimize the impact on the thread adding one over the limit of pending tasks... I changed it so it walks through all open tasks and removes all expired which could cause a small performance blip for that thread.  I&apos;m going to put it back to removing just one to make room for the one coming in.&lt;/p&gt;</comment>
                            <comment id="15538745" author="jking3" created="Sat, 1 Oct 2016 16:09:59 +0000"  >&lt;p&gt;Done.&lt;/p&gt;</comment>
                            <comment id="15538952" author="githubbot" created="Sat, 1 Oct 2016 18:13:53 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    It looks like we have a number of tests disabled on Appveyor that were not behaving well... I&apos;m going to re-enable as many as I can since they seem to be pretty stable for me locally, starting with concurrency_test.&lt;/p&gt;</comment>
                            <comment id="15539134" author="jking3" created="Sat, 1 Oct 2016 20:44:02 +0000"  >&lt;p&gt;I tried to re-enable some tests on appveyor.  It looks like we have a performance problem with the concurrency test which I see some signs of locally; on a Linux system the test runs in about 30 seconds but on my VS2010 system it takes about 110 seconds.  In the Appveyor build system it times out at 600 seconds.&lt;/p&gt;

&lt;p&gt;I also see signs that non-blocking may be flaky on Windows, if processor_test and StressTestNonBlocking are failing.&lt;br/&gt;
Once I do what I can here I will file additional Jira tickets for each of these issues if they are not resolved here.&lt;/p&gt;</comment>
                            <comment id="15539162" author="githubbot" created="Sat, 1 Oct 2016 21:08:40 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I think I found the reason for the poor test performance on Windows - the minimum granularity of a sleep call on Windows as defined by thrift_usleep() is 1 millisecond.  So in a test where we create 100,000 things there will be 100 seconds of delay.&lt;/p&gt;</comment>
                            <comment id="15539293" author="githubbot" created="Sat, 1 Oct 2016 22:59:24 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    By removing the THRIFT_SLEEP_USEC(1) calls in the test it gets much faster, which is great, however as part of this effort I have discovered our boost implementation is broken in some way.  I haven&apos;t gotten to the root cause yet, but I can easily get concurrency_test to hang on Linux with boost 1.54 and Windows with boost 1.58 after fixing the logic in ThreadManagerTests.h / blockTest to be correct.  The symptom is that notifyAll() isn&apos;t waking up all the threads it is supposed to.  It seems to wake up about 64 threads before it gives up.  If you run blockTest by itself (comment out the other thread-manager tests in Tests.cpp) it will wait 1 out of 2 times, and if you look at things in the debugger you will see a bunch of threads blocking on blockMonitor_ waiting for the notification from the test thread.  They are properly synchronized but not all of them wake up all the time.&lt;/p&gt;</comment>
                            <comment id="15540152" author="bgedik" created="Sun, 2 Oct 2016 10:27:12 +0000"  >&lt;p&gt;Could it be that the notification goes too early, before the threads wait on the monitor?&lt;/p&gt;</comment>
                            <comment id="15540302" author="githubbot" created="Sun, 2 Oct 2016 12:44:01 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Okay disregard that comment about boost... it turns out the blockTest was using a std::set to store the tasks it put into the thread manager so they were getting reordered.  I changed it to a vector and it resolved that issue so I am going to re-enable the concurrency test on windows builds.&lt;/p&gt;</comment>
                            <comment id="15540309" author="githubbot" created="Sun, 2 Oct 2016 12:49:03 +0000"  >&lt;p&gt;Github user nsuke commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103#discussion_r81467563&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103#discussion_r81467563&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/concurrency/ThreadManager.cpp &amp;#8212;&lt;br/&gt;
    @@ -339,103 +357,88 @@ void ThreadManager::Impl::addWorker(size_t value) {&lt;br/&gt;
         idMap_.insert(std::pair&amp;lt;const Thread::id_t, shared_ptr&amp;lt;Thread&amp;gt; &amp;gt;((*ix)-&amp;gt;getId(), *ix));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    `getId` always returns invalid ID for detached boost/std threads.&lt;br/&gt;
    It only affects `add` method called from inside worker threads, which does not seem to be happening in thrift servers&apos; code (not completely sure).&lt;br/&gt;
    A warning or an exception when passed such thread factories would be nice.&lt;/p&gt;</comment>
                            <comment id="15540310" author="githubbot" created="Sun, 2 Oct 2016 12:49:03 +0000"  >&lt;p&gt;Github user nsuke commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103#discussion_r81467452&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103#discussion_r81467452&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/concurrency/ThreadManager.cpp &amp;#8212;&lt;br/&gt;
    @@ -339,103 +357,88 @@ void ThreadManager::Impl::addWorker(size_t value) &lt;/p&gt;
{
         idMap_.insert(std::pair&amp;lt;const Thread::id_t, shared_ptr&amp;lt;Thread&amp;gt; &amp;gt;((*ix)-&amp;gt;getId(), *ix));
       }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;{&lt;/li&gt;
	&lt;li&gt;Synchronized s(workerMonitor_);&lt;/li&gt;
	&lt;li&gt;while (workerCount_ != workerMaxCount_) 
{
    -      workerMonitor_.wait();
    -    }
&lt;p&gt;    +  while (workerCount_ != workerMaxCount_) &lt;/p&gt;
{
    +    workerMonitor_.wait();
       }
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     void ThreadManager::Impl::start() {&lt;br/&gt;
    -&lt;br/&gt;
    +  Guard g(mutex_);&lt;br/&gt;
       if (state_ == ThreadManager::STOPPED) &lt;/p&gt;
{
         return;
       }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;{&lt;/li&gt;
	&lt;li&gt;Synchronized s(monitor_);&lt;/li&gt;
	&lt;li&gt;if (state_ == ThreadManager::UNINITIALIZED) {&lt;/li&gt;
	&lt;li&gt;if (!threadFactory_) 
{
    -        throw InvalidArgumentException();
    -      }&lt;/li&gt;
	&lt;li&gt;state_ = ThreadManager::STARTED;&lt;/li&gt;
	&lt;li&gt;monitor_.notifyAll();&lt;br/&gt;
    +  if (state_ == ThreadManager::UNINITIALIZED) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +    if (!threadFactory_) {
    +      throw InvalidArgumentException();
         }    +    state_ = ThreadManager}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;while (state_ == STARTING) 
{
    -      monitor_.wait();
    -    }
&lt;p&gt;    +  while (state_ == STARTING) &lt;/p&gt;
{
    +    monitor_.wait();
       }
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    -void ThreadManager::Impl::stopImpl(bool join) {&lt;br/&gt;
    +void ThreadManager::Impl::stop() {&lt;br/&gt;
    +  Guard g(mutex_);&lt;br/&gt;
       bool doStop = false;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (state_ == ThreadManager::STOPPED) 
{
    -    return;
    -  }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;{&lt;/li&gt;
	&lt;li&gt;Synchronized s(monitor_);&lt;/li&gt;
	&lt;li&gt;if (state_ != ThreadManager::STOPPING &amp;amp;&amp;amp; state_ != ThreadManager::JOINING&lt;/li&gt;
	&lt;li&gt;&amp;amp;&amp;amp; state_ != ThreadManager::STOPPED) 
{
    -      doStop = true;
    -      state_ = join ? ThreadManager::JOINING : ThreadManager::STOPPING;
    -    }
&lt;p&gt;    +  if (state_ != ThreadManager::STOPPING &amp;amp;&amp;amp; state_ != ThreadManager::JOINING&lt;br/&gt;
    +      &amp;amp;&amp;amp; state_ != ThreadManager::STOPPED) &lt;/p&gt;
{
    +    doStop = true;
    +    state_ = ThreadManager::JOINING;
       }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;       if (doStop) &lt;/p&gt;
{
    -    removeWorker(workerCount_);
    +    removeWorkersUnderLock(workerCount_);
       }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// XXX&lt;/li&gt;
	&lt;li&gt;// should be able to block here for transition to STOPPED since we&apos;re no&lt;/li&gt;
	&lt;li&gt;// using shared_ptrs&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;{
    -    Synchronized s(monitor_);
    -    state_ = ThreadManager::STOPPED;
    -  }
&lt;p&gt;    +  state_ = ThreadManager::STOPPED;&lt;br/&gt;
     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     void ThreadManager::Impl::removeWorker(size_t value) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;std::set&amp;lt;shared_ptr&amp;lt;Thread&amp;gt; &amp;gt; removedThreads;&lt;/li&gt;
	&lt;li&gt;{&lt;/li&gt;
	&lt;li&gt;Synchronized s(monitor_);&lt;/li&gt;
	&lt;li&gt;if (value &amp;gt; workerMaxCount_) 
{
    -      throw InvalidArgumentException();
    -    }
&lt;p&gt;    +  Guard g(mutex_);&lt;br/&gt;
    +  removeWorkersUnderLock(value);&lt;br/&gt;
    +}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;workerMaxCount_ -= value;&lt;br/&gt;
    +void ThreadManager::Impl::removeWorkersUnderLock(size_t value) {&lt;br/&gt;
    +  if (value &amp;gt; workerMaxCount_) 
{
    +    throw InvalidArgumentException();
    +  }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (idleCount_ &amp;lt; value) {&lt;/li&gt;
	&lt;li&gt;for (size_t ix = 0; ix &amp;lt; idleCount_; ix++) 
{
    -        monitor_.notify();
    -      }&lt;/li&gt;
	&lt;li&gt;} else {&lt;/li&gt;
	&lt;li&gt;monitor_.notifyAll();&lt;br/&gt;
    +  workerMaxCount_ -= value;&lt;br/&gt;
    +&lt;br/&gt;
    +  if (idleCount_ &amp;lt; value) {&lt;br/&gt;
    +    for (size_t ix = 0; ix &amp;lt; idleCount_; ix++) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I know it&apos;s not your code but shouldn&apos;t it be&lt;/p&gt;

&lt;p&gt;        if (idleCount_ &amp;gt; value) {&lt;br/&gt;
            for( ...; ix &amp;lt; value; ...)&lt;/p&gt;

&lt;p&gt;    ?&lt;br/&gt;
    If insufficient or equal number of people are sleeping, let&apos;s wake them up all, otherwise do it one by one.&lt;/p&gt;</comment>
                            <comment id="15540311" author="githubbot" created="Sun, 2 Oct 2016 12:49:03 +0000"  >&lt;p&gt;Github user nsuke commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103#discussion_r81464488&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103#discussion_r81464488&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/concurrency/PosixThreadFactory.h &amp;#8212;&lt;br/&gt;
    @@ -39,7 +39,14 @@ class PosixThreadFactory : public ThreadFactory {&lt;br/&gt;
       /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;POSIX Thread scheduler policies&lt;br/&gt;
        */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;enum POLICY 
{ OTHER, FIFO, ROUND_ROBIN }
&lt;p&gt;;&lt;br/&gt;
    +  class Policy {&lt;br/&gt;
    +  public:&lt;br/&gt;
    +    enum value &lt;/p&gt;
{
    +      OTHER       = 0,
    +      FIFO        = 1,
    +      ROUND_ROBIN = 2
    +    }
&lt;p&gt;;&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    What is the purpose here ?&lt;br/&gt;
    At first glance I thought you were emulating C++11 enum class, but it does not provide type safety, and method signatures get noisy with ::value.&lt;br/&gt;
    There&apos;s certainly a way to avoid ::value and provide limited type-safety, but not sure if it&apos;s worth changing public API.&lt;/p&gt;</comment>
                            <comment id="15540312" author="githubbot" created="Sun, 2 Oct 2016 12:49:03 +0000"  >&lt;p&gt;Github user nsuke commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103#discussion_r81466362&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103#discussion_r81466362&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/concurrency/ThreadManager.cpp &amp;#8212;&lt;br/&gt;
    @@ -292,28 +310,30 @@ class ThreadManager::Worker : public Runnable &lt;/p&gt;
{
                 GlobalOutput.printf(&quot;[ERROR] task-&amp;gt;run() raised an unknown exception&quot;);
               }
&lt;p&gt;             }&lt;br/&gt;
    +        else if (task-&amp;gt;state_ == ThreadManager::Task::TIMEDOUT &amp;amp;&amp;amp; manager_-&amp;gt;expireCallback_) &lt;/p&gt;
{
    +          manager_-&amp;gt;expireCallback_(task-&amp;gt;getRunnable());
    +          manager_-&amp;gt;expiredCount_++;
    +        }
&lt;p&gt;    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Looks problematic after `mutex_.unlock()` above.&lt;br/&gt;
    I guess you intend to unlock inside `if`.&lt;/p&gt;</comment>
                            <comment id="15540322" author="githubbot" created="Sun, 2 Oct 2016 12:58:38 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103#discussion_r81469715&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103#discussion_r81469715&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/concurrency/PosixThreadFactory.h &amp;#8212;&lt;br/&gt;
    @@ -39,7 +39,14 @@ class PosixThreadFactory : public ThreadFactory {&lt;br/&gt;
       /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;POSIX Thread scheduler policies&lt;br/&gt;
        */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;enum POLICY 
{ OTHER, FIFO, ROUND_ROBIN }
&lt;p&gt;;&lt;br/&gt;
    +  class Policy {&lt;br/&gt;
    +  public:&lt;br/&gt;
    +    enum value &lt;/p&gt;
{
    +      OTHER       = 0,
    +      FIFO        = 1,
    +      ROUND_ROBIN = 2
    +    }
&lt;p&gt;;&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Intention was to make it more readable.&lt;/p&gt;

&lt;p&gt;    In code, OTHER, FIFO, ROUND_ROBIN mixed with NORMAL, LOWER, HIGHER... this adds a scope to them, i.e. &quot;Policy::FIFO&quot; and &quot;Priority::NORMAL&quot;.&lt;/p&gt;

&lt;p&gt;    I can revert it if needed, I just wanted to make the code more maintainable.  I suspect these options are not used that often anyway.&lt;/p&gt;</comment>
                            <comment id="15540324" author="githubbot" created="Sun, 2 Oct 2016 12:59:05 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103#discussion_r81469719&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103#discussion_r81469719&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/concurrency/ThreadManager.cpp &amp;#8212;&lt;br/&gt;
    @@ -292,28 +310,30 @@ class ThreadManager::Worker : public Runnable &lt;/p&gt;
{
                 GlobalOutput.printf(&quot;[ERROR] task-&amp;gt;run() raised an unknown exception&quot;);
               }
&lt;p&gt;             }&lt;br/&gt;
    +        else if (task-&amp;gt;state_ == ThreadManager::Task::TIMEDOUT &amp;amp;&amp;amp; manager_-&amp;gt;expireCallback_) &lt;/p&gt;
{
    +          manager_-&amp;gt;expireCallback_(task-&amp;gt;getRunnable());
    +          manager_-&amp;gt;expiredCount_++;
    +        }
&lt;p&gt;    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Yes, that needs to re-lock.  I will fix that.&lt;/p&gt;</comment>
                            <comment id="15540326" author="githubbot" created="Sun, 2 Oct 2016 13:00:08 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103#discussion_r81469729&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103#discussion_r81469729&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/concurrency/ThreadManager.cpp &amp;#8212;&lt;br/&gt;
    @@ -339,103 +357,88 @@ void ThreadManager::Impl::addWorker(size_t value) &lt;/p&gt;
{
         idMap_.insert(std::pair&amp;lt;const Thread::id_t, shared_ptr&amp;lt;Thread&amp;gt; &amp;gt;((*ix)-&amp;gt;getId(), *ix));
       }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;{&lt;/li&gt;
	&lt;li&gt;Synchronized s(workerMonitor_);&lt;/li&gt;
	&lt;li&gt;while (workerCount_ != workerMaxCount_) 
{
    -      workerMonitor_.wait();
    -    }
&lt;p&gt;    +  while (workerCount_ != workerMaxCount_) &lt;/p&gt;
{
    +    workerMonitor_.wait();
       }
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     void ThreadManager::Impl::start() {&lt;br/&gt;
    -&lt;br/&gt;
    +  Guard g(mutex_);&lt;br/&gt;
       if (state_ == ThreadManager::STOPPED) &lt;/p&gt;
{
         return;
       }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;{&lt;/li&gt;
	&lt;li&gt;Synchronized s(monitor_);&lt;/li&gt;
	&lt;li&gt;if (state_ == ThreadManager::UNINITIALIZED) {&lt;/li&gt;
	&lt;li&gt;if (!threadFactory_) 
{
    -        throw InvalidArgumentException();
    -      }&lt;/li&gt;
	&lt;li&gt;state_ = ThreadManager::STARTED;&lt;/li&gt;
	&lt;li&gt;monitor_.notifyAll();&lt;br/&gt;
    +  if (state_ == ThreadManager::UNINITIALIZED) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +    if (!threadFactory_) {
    +      throw InvalidArgumentException();
         }    +    state_ = ThreadManager}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;while (state_ == STARTING) 
{
    -      monitor_.wait();
    -    }
&lt;p&gt;    +  while (state_ == STARTING) &lt;/p&gt;
{
    +    monitor_.wait();
       }
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    -void ThreadManager::Impl::stopImpl(bool join) {&lt;br/&gt;
    +void ThreadManager::Impl::stop() {&lt;br/&gt;
    +  Guard g(mutex_);&lt;br/&gt;
       bool doStop = false;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (state_ == ThreadManager::STOPPED) 
{
    -    return;
    -  }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;{&lt;/li&gt;
	&lt;li&gt;Synchronized s(monitor_);&lt;/li&gt;
	&lt;li&gt;if (state_ != ThreadManager::STOPPING &amp;amp;&amp;amp; state_ != ThreadManager::JOINING&lt;/li&gt;
	&lt;li&gt;&amp;amp;&amp;amp; state_ != ThreadManager::STOPPED) 
{
    -      doStop = true;
    -      state_ = join ? ThreadManager::JOINING : ThreadManager::STOPPING;
    -    }
&lt;p&gt;    +  if (state_ != ThreadManager::STOPPING &amp;amp;&amp;amp; state_ != ThreadManager::JOINING&lt;br/&gt;
    +      &amp;amp;&amp;amp; state_ != ThreadManager::STOPPED) &lt;/p&gt;
{
    +    doStop = true;
    +    state_ = ThreadManager::JOINING;
       }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;       if (doStop) &lt;/p&gt;
{
    -    removeWorker(workerCount_);
    +    removeWorkersUnderLock(workerCount_);
       }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// XXX&lt;/li&gt;
	&lt;li&gt;// should be able to block here for transition to STOPPED since we&apos;re no&lt;/li&gt;
	&lt;li&gt;// using shared_ptrs&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;{
    -    Synchronized s(monitor_);
    -    state_ = ThreadManager::STOPPED;
    -  }
&lt;p&gt;    +  state_ = ThreadManager::STOPPED;&lt;br/&gt;
     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     void ThreadManager::Impl::removeWorker(size_t value) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;std::set&amp;lt;shared_ptr&amp;lt;Thread&amp;gt; &amp;gt; removedThreads;&lt;/li&gt;
	&lt;li&gt;{&lt;/li&gt;
	&lt;li&gt;Synchronized s(monitor_);&lt;/li&gt;
	&lt;li&gt;if (value &amp;gt; workerMaxCount_) 
{
    -      throw InvalidArgumentException();
    -    }
&lt;p&gt;    +  Guard g(mutex_);&lt;br/&gt;
    +  removeWorkersUnderLock(value);&lt;br/&gt;
    +}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;workerMaxCount_ -= value;&lt;br/&gt;
    +void ThreadManager::Impl::removeWorkersUnderLock(size_t value) {&lt;br/&gt;
    +  if (value &amp;gt; workerMaxCount_) 
{
    +    throw InvalidArgumentException();
    +  }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (idleCount_ &amp;lt; value) {&lt;/li&gt;
	&lt;li&gt;for (size_t ix = 0; ix &amp;lt; idleCount_; ix++) 
{
    -        monitor_.notify();
    -      }&lt;/li&gt;
	&lt;li&gt;} else {&lt;/li&gt;
	&lt;li&gt;monitor_.notifyAll();&lt;br/&gt;
    +  workerMaxCount_ -= value;&lt;br/&gt;
    +&lt;br/&gt;
    +  if (idleCount_ &amp;lt; value) {&lt;br/&gt;
    +    for (size_t ix = 0; ix &amp;lt; idleCount_; ix++) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I will look at this more closely.&lt;/p&gt;</comment>
                            <comment id="15540364" author="githubbot" created="Sun, 2 Oct 2016 13:34:33 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103#discussion_r81470201&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103#discussion_r81470201&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/concurrency/ThreadManager.cpp &amp;#8212;&lt;br/&gt;
    @@ -292,28 +310,30 @@ class ThreadManager::Worker : public Runnable &lt;/p&gt;
{
                 GlobalOutput.printf(&quot;[ERROR] task-&amp;gt;run() raised an unknown exception&quot;);
               }
&lt;p&gt;             }&lt;br/&gt;
    +        else if (task-&amp;gt;state_ == ThreadManager::Task::TIMEDOUT &amp;amp;&amp;amp; manager_-&amp;gt;expireCallback_) &lt;/p&gt;
{
    +          manager_-&amp;gt;expireCallback_(task-&amp;gt;getRunnable());
    +          manager_-&amp;gt;expiredCount_++;
    +        }
&lt;p&gt;    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I just pushed a fix for this.&lt;/p&gt;</comment>
                            <comment id="15540365" author="githubbot" created="Sun, 2 Oct 2016 13:34:39 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103#discussion_r81470203&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103#discussion_r81470203&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/concurrency/ThreadManager.cpp &amp;#8212;&lt;br/&gt;
    @@ -339,103 +357,88 @@ void ThreadManager::Impl::addWorker(size_t value) &lt;/p&gt;
{
         idMap_.insert(std::pair&amp;lt;const Thread::id_t, shared_ptr&amp;lt;Thread&amp;gt; &amp;gt;((*ix)-&amp;gt;getId(), *ix));
       }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;{&lt;/li&gt;
	&lt;li&gt;Synchronized s(workerMonitor_);&lt;/li&gt;
	&lt;li&gt;while (workerCount_ != workerMaxCount_) 
{
    -      workerMonitor_.wait();
    -    }
&lt;p&gt;    +  while (workerCount_ != workerMaxCount_) &lt;/p&gt;
{
    +    workerMonitor_.wait();
       }
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     void ThreadManager::Impl::start() {&lt;br/&gt;
    -&lt;br/&gt;
    +  Guard g(mutex_);&lt;br/&gt;
       if (state_ == ThreadManager::STOPPED) &lt;/p&gt;
{
         return;
       }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;{&lt;/li&gt;
	&lt;li&gt;Synchronized s(monitor_);&lt;/li&gt;
	&lt;li&gt;if (state_ == ThreadManager::UNINITIALIZED) {&lt;/li&gt;
	&lt;li&gt;if (!threadFactory_) 
{
    -        throw InvalidArgumentException();
    -      }&lt;/li&gt;
	&lt;li&gt;state_ = ThreadManager::STARTED;&lt;/li&gt;
	&lt;li&gt;monitor_.notifyAll();&lt;br/&gt;
    +  if (state_ == ThreadManager::UNINITIALIZED) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +    if (!threadFactory_) {
    +      throw InvalidArgumentException();
         }    +    state_ = ThreadManager}&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;while (state_ == STARTING) 
{
    -      monitor_.wait();
    -    }
&lt;p&gt;    +  while (state_ == STARTING) &lt;/p&gt;
{
    +    monitor_.wait();
       }
&lt;p&gt;     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    -void ThreadManager::Impl::stopImpl(bool join) {&lt;br/&gt;
    +void ThreadManager::Impl::stop() {&lt;br/&gt;
    +  Guard g(mutex_);&lt;br/&gt;
       bool doStop = false;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (state_ == ThreadManager::STOPPED) 
{
    -    return;
    -  }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;{&lt;/li&gt;
	&lt;li&gt;Synchronized s(monitor_);&lt;/li&gt;
	&lt;li&gt;if (state_ != ThreadManager::STOPPING &amp;amp;&amp;amp; state_ != ThreadManager::JOINING&lt;/li&gt;
	&lt;li&gt;&amp;amp;&amp;amp; state_ != ThreadManager::STOPPED) 
{
    -      doStop = true;
    -      state_ = join ? ThreadManager::JOINING : ThreadManager::STOPPING;
    -    }
&lt;p&gt;    +  if (state_ != ThreadManager::STOPPING &amp;amp;&amp;amp; state_ != ThreadManager::JOINING&lt;br/&gt;
    +      &amp;amp;&amp;amp; state_ != ThreadManager::STOPPED) &lt;/p&gt;
{
    +    doStop = true;
    +    state_ = ThreadManager::JOINING;
       }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;       if (doStop) &lt;/p&gt;
{
    -    removeWorker(workerCount_);
    +    removeWorkersUnderLock(workerCount_);
       }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// XXX&lt;/li&gt;
	&lt;li&gt;// should be able to block here for transition to STOPPED since we&apos;re no&lt;/li&gt;
	&lt;li&gt;// using shared_ptrs&lt;br/&gt;
    -&lt;/li&gt;
	&lt;li&gt;{
    -    Synchronized s(monitor_);
    -    state_ = ThreadManager::STOPPED;
    -  }
&lt;p&gt;    +  state_ = ThreadManager::STOPPED;&lt;br/&gt;
     }&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     void ThreadManager::Impl::removeWorker(size_t value) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;std::set&amp;lt;shared_ptr&amp;lt;Thread&amp;gt; &amp;gt; removedThreads;&lt;/li&gt;
	&lt;li&gt;{&lt;/li&gt;
	&lt;li&gt;Synchronized s(monitor_);&lt;/li&gt;
	&lt;li&gt;if (value &amp;gt; workerMaxCount_) 
{
    -      throw InvalidArgumentException();
    -    }
&lt;p&gt;    +  Guard g(mutex_);&lt;br/&gt;
    +  removeWorkersUnderLock(value);&lt;br/&gt;
    +}&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;workerMaxCount_ -= value;&lt;br/&gt;
    +void ThreadManager::Impl::removeWorkersUnderLock(size_t value) {&lt;br/&gt;
    +  if (value &amp;gt; workerMaxCount_) 
{
    +    throw InvalidArgumentException();
    +  }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (idleCount_ &amp;lt; value) {&lt;/li&gt;
	&lt;li&gt;for (size_t ix = 0; ix &amp;lt; idleCount_; ix++) 
{
    -        monitor_.notify();
    -      }&lt;/li&gt;
	&lt;li&gt;} else {&lt;/li&gt;
	&lt;li&gt;monitor_.notifyAll();&lt;br/&gt;
    +  workerMaxCount_ -= value;&lt;br/&gt;
    +&lt;br/&gt;
    +  if (idleCount_ &amp;lt; value) {&lt;br/&gt;
    +    for (size_t ix = 0; ix &amp;lt; idleCount_; ix++) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I just pushed a fix for this.&lt;/p&gt;</comment>
                            <comment id="15540376" author="githubbot" created="Sun, 2 Oct 2016 13:40:29 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103#discussion_r81470274&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103#discussion_r81470274&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/concurrency/ThreadManager.cpp &amp;#8212;&lt;br/&gt;
    @@ -339,103 +357,88 @@ void ThreadManager::Impl::addWorker(size_t value) {&lt;br/&gt;
         idMap_.insert(std::pair&amp;lt;const Thread::id_t, shared_ptr&amp;lt;Thread&amp;gt; &amp;gt;((*ix)-&amp;gt;getId(), *ix));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This means canSleep() will always return true, which is correct; when adding a task without a timeout you will get TooManyPendingTasksException.  When adding a task with a timeout you may get a TimedOutException.  &lt;/p&gt;</comment>
                            <comment id="15540389" author="githubbot" created="Sun, 2 Oct 2016 13:50:32 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    The latest AppVeyor build failed because the thread factory monitor test assumes that a monitor wait(milliseconds) will wake up at &quot;milliseconds&quot; however the only guarantee is that it will sleep &quot;at least milliseconds&quot;.  As we see in a busy Appveyor build environment, there are significant delays, but it meets the criteria of sleeping &quot;at least milliseconds&quot; which is the only guarantee, so I am going to fix that test.&lt;/p&gt;</comment>
                            <comment id="15540402" author="githubbot" created="Sun, 2 Oct 2016 13:59:57 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I pushed a fix for the failing monitor timing test as described above; this resolves the appveyor issue with concurrency_test that was previously discovered.  I intend to leave concurrency_test enabled in appveyor so if it breaks again I&apos;ll see what&apos;s up.&lt;/p&gt;</comment>
                            <comment id="15540426" author="githubbot" created="Sun, 2 Oct 2016 14:13:00 +0000"  >&lt;p&gt;Github user nsuke commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103#discussion_r81470710&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103#discussion_r81470710&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/concurrency/PosixThreadFactory.h &amp;#8212;&lt;br/&gt;
    @@ -39,7 +39,14 @@ class PosixThreadFactory : public ThreadFactory {&lt;br/&gt;
       /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;POSIX Thread scheduler policies&lt;br/&gt;
        */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;enum POLICY 
{ OTHER, FIFO, ROUND_ROBIN }
&lt;p&gt;;&lt;br/&gt;
    +  class Policy {&lt;br/&gt;
    +  public:&lt;br/&gt;
    +    enum value &lt;/p&gt;
{
    +      OTHER       = 0,
    +      FIFO        = 1,
    +      ROUND_ROBIN = 2
    +    }
&lt;p&gt;;&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I understand your point, although I wouldn&apos;t personally do this as it feels fighting against language.&lt;br/&gt;
    If we do this, IMO we should introduce implicit conversion from inner enum to outer class to remove the `::value` in method signatures.&lt;br/&gt;
    But I think it&apos;s completely separate issue and should be handled separately from this patch.&lt;/p&gt;</comment>
                            <comment id="15540445" author="githubbot" created="Sun, 2 Oct 2016 14:26:01 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103#discussion_r81470853&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103#discussion_r81470853&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/concurrency/PosixThreadFactory.h &amp;#8212;&lt;br/&gt;
    @@ -39,7 +39,14 @@ class PosixThreadFactory : public ThreadFactory {&lt;br/&gt;
       /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;POSIX Thread scheduler policies&lt;br/&gt;
        */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;enum POLICY 
{ OTHER, FIFO, ROUND_ROBIN }
&lt;p&gt;;&lt;br/&gt;
    +  class Policy {&lt;br/&gt;
    +  public:&lt;br/&gt;
    +    enum value &lt;/p&gt;
{
    +      OTHER       = 0,
    +      FIFO        = 1,
    +      ROUND_ROBIN = 2
    +    }
&lt;p&gt;;&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I&apos;ll revert the enum changes.&lt;/p&gt;</comment>
                            <comment id="15540466" author="githubbot" created="Sun, 2 Oct 2016 14:40:27 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I reverted the PosixThreadManager enum changes per @nsuke &apos;s request.&lt;/p&gt;</comment>
                            <comment id="15540503" author="githubbot" created="Sun, 2 Oct 2016 15:13:42 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    It looks like the processor_test is failing now. ;(&lt;/p&gt;</comment>
                            <comment id="15540555" author="githubbot" created="Sun, 2 Oct 2016 15:51:14 +0000"  >&lt;p&gt;Github user nsuke commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    It looks succeeding to me :tada:&lt;/p&gt;</comment>
                            <comment id="15540560" author="githubbot" created="Sun, 2 Oct 2016 15:55:39 +0000"  >&lt;p&gt;Github user nsuke commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103#discussion_r81472348&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103#discussion_r81472348&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/concurrency/ThreadManager.cpp &amp;#8212;&lt;br/&gt;
    @@ -339,103 +357,88 @@ void ThreadManager::Impl::addWorker(size_t value) {&lt;br/&gt;
         idMap_.insert(std::pair&amp;lt;const Thread::id_t, shared_ptr&amp;lt;Thread&amp;gt; &amp;gt;((*ix)-&amp;gt;getId(), *ix));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Removing seems quite safe to me too.&lt;br/&gt;
    But if you intend this for 0.10.0, it may not be the best timing.&lt;br/&gt;
    Thought ?&lt;br/&gt;
    Otherwise it looks good to me, thanks.&lt;/p&gt;</comment>
                            <comment id="15540909" author="githubbot" created="Sun, 2 Oct 2016 20:05:02 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://travis-ci.org/apache/thrift/builds/164436835&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/apache/thrift/builds/164436835&lt;/a&gt;&lt;br/&gt;
    Job 3025.17&lt;br/&gt;
    &lt;a href=&quot;https://travis-ci.org/apache/thrift/jobs/164436856&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/apache/thrift/jobs/164436856&lt;/a&gt; has in it:&lt;br/&gt;
    ctest -VV -E &quot;(concurrency_test|processor_test)&quot;&lt;br/&gt;
    Are we sure that processor_test runs in the Travis CI environment?&lt;/p&gt;</comment>
                            <comment id="15541375" author="githubbot" created="Mon, 3 Oct 2016 02:40:08 +0000"  >&lt;p&gt;Github user nsuke commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Oh, good catch, concurrency_test definitely needs to be enabled for Linux cmake CI and autotools.&lt;/p&gt;

&lt;p&gt;    Somehow thought that you were referring to concurrency_test in the last comment,&lt;br/&gt;
    but `processor_test` worked without your patch for you ?&lt;br/&gt;
    For me it didn&apos;t, actually I don&apos;t remember a single instance it did.&lt;br/&gt;
    According to &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1336&quot; title=&quot; thrift: added server and processor test code
&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1336&quot;&gt;&lt;del&gt;THRIFT-1336&lt;/del&gt;&lt;/a&gt;, it was disabled since the day 1.&lt;/p&gt;</comment>
                            <comment id="15542065" author="githubbot" created="Mon, 3 Oct 2016 10:17:40 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I made this single change:&lt;/p&gt;

&lt;p&gt;    &amp;gt; +++ b/lib/cpp/test/processor/ProcessorTest.cpp&lt;br/&gt;
    &amp;gt;  uint32_t checkNewConnEvents(const boost::shared_ptr&amp;lt;EventLog&amp;gt;&amp;amp; log) {&lt;br/&gt;
    &amp;gt;    // Check for an ET_CONN_CREATED event&lt;br/&gt;
    &amp;gt;   Event event = log-&amp;gt;waitForEvent(2000);                                // &amp;lt;&amp;lt;&amp;lt; I added &quot;2000&quot;&lt;br/&gt;
    &amp;gt;    BOOST_CHECK_EQUAL(EventLog::ET_CONN_CREATED, event.type);&lt;/p&gt;

&lt;p&gt;    After making that change I can run processor_test:&lt;/p&gt;

&lt;p&gt;    &amp;gt; jking@jking-dvm51-buildenv-2:~/thrift-build$ ctest -R processor_test&lt;br/&gt;
    &amp;gt; Test project /home/jking/thrift-build&lt;br/&gt;
    &amp;gt;     Start 19: processor_test&lt;br/&gt;
    &amp;gt; 1/1 Test #19: processor_test ...................   Passed   33.84 sec&lt;br/&gt;
    &amp;gt; &lt;br/&gt;
    &amp;gt; 100% tests passed, 0 tests failed out of 1&lt;br/&gt;
    &amp;gt; &lt;br/&gt;
    &amp;gt; Total Test time (real) =  33.88 sec&lt;/p&gt;

&lt;p&gt;    Looks like it&apos;s time to re-enable these tests!&lt;/p&gt;</comment>
                            <comment id="15542090" author="githubbot" created="Mon, 3 Oct 2016 10:32:07 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103#discussion_r81525567&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103#discussion_r81525567&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/concurrency/ThreadManager.cpp &amp;#8212;&lt;br/&gt;
    @@ -339,103 +357,88 @@ void ThreadManager::Impl::addWorker(size_t value) {&lt;br/&gt;
         idMap_.insert(std::pair&amp;lt;const Thread::id_t, shared_ptr&amp;lt;Thread&amp;gt; &amp;gt;((*ix)-&amp;gt;getId(), *ix));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I feel the changes in here are substantial and quite useful, in that I have added tests and re-enabled a number of tests, and ctest on windows runs in about a minute now.  As for getting rid of idMap_ and canSleep, I see no reason to keep them.  As for 0.10.0, all of these changes are pretty substantial and I don&apos;t know if they make it in or not.  I think they are substantial improvements in correctness and stability, and should be considered at least.&lt;/p&gt;</comment>
                            <comment id="15542093" author="githubbot" created="Mon, 3 Oct 2016 10:34:31 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103#discussion_r81525843&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103#discussion_r81525843&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/concurrency/ThreadManager.cpp &amp;#8212;&lt;br/&gt;
    @@ -339,103 +357,88 @@ void ThreadManager::Impl::addWorker(size_t value) {&lt;br/&gt;
         idMap_.insert(std::pair&amp;lt;const Thread::id_t, shared_ptr&amp;lt;Thread&amp;gt; &amp;gt;((*ix)-&amp;gt;getId(), *ix));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    In addition, if you look at the logic around canSleep and the use of a timeout, it isn&apos;t even correct.  It checks to see if a timeout was requested then proceeds into an infinite loop waiting for a slot to add the task.&lt;/p&gt;</comment>
                            <comment id="15542125" author="githubbot" created="Mon, 3 Oct 2016 10:51:24 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103#discussion_r81527972&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103#discussion_r81527972&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/concurrency/ThreadManager.cpp &amp;#8212;&lt;br/&gt;
    @@ -339,103 +357,88 @@ void ThreadManager::Impl::addWorker(size_t value) {&lt;br/&gt;
         idMap_.insert(std::pair&amp;lt;const Thread::id_t, shared_ptr&amp;lt;Thread&amp;gt; &amp;gt;((*ix)-&amp;gt;getId(), *ix));&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Okay actually that comment was wrong.  maxMonitor_ will wake under two conditions - one is that there&apos;s enough room to add a task.  The other was not coded and that is during stop.  If there was a thread in add() and someone called stop() it needs to signal maxMonitor_ and if the thread manager is no longer started we need to throw the illegal state exception since it&apos;s bieng stopped.&lt;/p&gt;</comment>
                            <comment id="15542525" author="githubbot" created="Mon, 3 Oct 2016 14:19:19 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I re-enabled these tests and they have all passed in Travis and in Appveyor.  I also brought the time on TInterruptTest down by 90 seconds.  The entire suite runs in about 60 seconds on Windows without nonblocking tests; definitely runs in just a few minutes with all the tests enabled.&lt;/p&gt;</comment>
                            <comment id="15549639" author="githubbot" created="Wed, 5 Oct 2016 18:53:35 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    How will a decision be made as to whether this gets into 0.10.0 or not?  Obviously it is not a trivial change but I think it solidifies parts of the C++ engine that have been neglected; adds much better test coverage; improves the reliability and decreases the runtime of many unit tests; it also re-enables some tests that have been disabled in CI for a long time.&lt;/p&gt;</comment>
                            <comment id="15571808" author="jfarrell" created="Thu, 13 Oct 2016 12:44:34 +0000"  >&lt;p&gt;Ran through the patch and with the size and number of files that this is touching in the C++ lib I would error on the side of caution and look at committing this right after 0.10.0 is released so it does not block the release and it can get proper testing and soak time in before 0.11.0 gets cut. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ben.craig&quot; class=&quot;user-hover&quot; rel=&quot;ben.craig&quot;&gt;ben.craig&lt;/a&gt; do you have a second to review this patch?&lt;/p&gt;</comment>
                            <comment id="15572126" author="githubbot" created="Thu, 13 Oct 2016 14:43:49 +0000"  >&lt;p&gt;Github user ben-craig commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Removing setDetached and the old thread factory ctors breaks client code loudly.  It doesn&apos;t fix the underlying problem, and it exchanges one problem (don&apos;t forget to set the detached mode!) for another (what does the &apos;false&apos; in that parameter list mean?).&lt;/p&gt;

&lt;p&gt;    I&apos;m great with adding ctors that would make the code less buggy.  I&apos;m also okay with the minor breakage of making isDetached and setDetached non-virtual.  But removing setDetached just breaks too much code without a strong benefit.&lt;/p&gt;

&lt;p&gt;    If your change ripples out to completely unrelated tests, you need a strong motivation for it.  Please separate out the refactors from the fixes.&lt;/p&gt;</comment>
                            <comment id="15582164" author="githubbot" created="Mon, 17 Oct 2016 12:54:12 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @ben-craig changing the &quot;detached&quot; behavior of an active thread manager seems like a bug to me which is why I removed it.  What is the use case for it?&lt;/p&gt;</comment>
                            <comment id="15582271" author="jking3" created="Mon, 17 Oct 2016 13:31:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jfarrell&quot; class=&quot;user-hover&quot; rel=&quot;jfarrell&quot;&gt;jfarrell&lt;/a&gt; sounds good.&lt;/p&gt;</comment>
                            <comment id="15582485" author="githubbot" created="Mon, 17 Oct 2016 15:01:48 +0000"  >&lt;p&gt;Github user ben-craig commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    PlatformThreadFactory f;&lt;br/&gt;
    f.setDetached(false);&lt;/p&gt;

&lt;p&gt;    Prior to this change, that was the only way to portably change the detached state.  The PosixThreadFactory didn&apos;t have a ctor that would permit that.  The tests were even using this pattern.&lt;/p&gt;

&lt;p&gt;    I see that you have added a PosixThreadFactory ctor that lets you set the detached state in a portable way, and that&apos;s great.  It doesn&apos;t change that this pattern is already out there in a lot of production code.  It even broke tests which made no use of ThreadManager.&lt;/p&gt;

&lt;p&gt;    If you need to fix the tests after making a change, chances are high that you have introduced a source breaking change that needs to be strongly considered.&lt;/p&gt;</comment>
                            <comment id="15582535" author="githubbot" created="Mon, 17 Oct 2016 15:26:12 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    What you described is a failing in the original set of thread factories to provide common functionality (detached, policy, priority) in the base class.  Only PosixThreadFactory has policy and priority, and yet it&apos;s quite likely that all of them would benefit from these.  I moved the detached information into the base class as a first step.  I could certainly add back setDetached into the base and mark it deprecated, however that breaks the contract that the servers require - that the detached disposition cannot change while the server is running, so it really doesn&apos;t belong... I still have no valid use case for changing detached disposition of a thread manager while it is in use.&lt;/p&gt;

&lt;p&gt;    Now that said, I believe that Thread knows if it is detached or not; if Thread had a &quot;joinIfJoinable()&quot; method then that server requirement would go away since the TConnectedClient could just call that and it would do the right thing, and setDetached() could be added back in avoiding that particular breaking change.&lt;/p&gt;

&lt;p&gt;    I don&apos;t find breaking changes to be a problem when they remove behavior that has no use case to support it, however.  There&apos;s a lot of technical debt in the concurrency area that still could be addressed - this was a first pass as trying to shore it up and ensure functions provided are actually tested and work, and that tests don&apos;t take 100 seconds each.&lt;/p&gt;</comment>
                            <comment id="15582594" author="githubbot" created="Mon, 17 Oct 2016 15:54:17 +0000"  >&lt;p&gt;Github user ben-craig commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I&apos;m fine with you adding back setDetached and marking it deprecated.  If you really want, you could even put in some logic so that you assert or throw an error if someone calls setDetached after a thread is created by the factory.  Just don&apos;t break the two-stage initialization that is in existing code.&lt;/p&gt;</comment>
                            <comment id="15655192" author="githubbot" created="Thu, 10 Nov 2016 21:26:10 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I decided to leave setDetached and not deprecate it.  I don&apos;t see a reason for someone to change from detachable to joinable (or the reverse) while running but I believe all of the servers will properly support it because all three join implementations check if the thread is detached_.  Therefore I am doing a force push on this one and rebased it on master as of earlier today.  Please check it and let me know if there are any more concerns; since we&apos;re getting into the beginning of 0.11.0 development I want to get it in as early as possible to get as much soak time as possible, given the area of work.&lt;/p&gt;</comment>
                            <comment id="15660226" author="githubbot" created="Sat, 12 Nov 2016 20:22:23 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1103&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16152958" author="bgedik" created="Mon, 4 Sep 2017 21:40:34 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jking3&quot; class=&quot;user-hover&quot; rel=&quot;jking3&quot;&gt;jking3&lt;/a&gt;. Do you know if there are any release plans that would contain this fix? Is there a publicly available resource that talks about release plans? Thanks!&lt;/p&gt;</comment>
                            <comment id="16153036" author="jking3" created="Tue, 5 Sep 2017 02:11:04 +0000"  >&lt;p&gt;This was fixed and released into thrift-0.10.0.&lt;/p&gt;</comment>
                            <comment id="16153037" author="bgedik" created="Tue, 5 Sep 2017 02:14:47 +0000"  >&lt;p&gt;Sorry, I commented on the wrong Jira item. I meant to comment on &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3891&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/THRIFT-3891&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16153061" author="jking3" created="Tue, 5 Sep 2017 02:55:03 +0000"  >&lt;p&gt;Recommend you send your request to the release mailing list.  We seem to be on one release per year right now, and we do need to make that better.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://thrift.apache.org/mailing&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://thrift.apache.org/mailing&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12987832">THRIFT-3873</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13103495">THRIFT-4336</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12424649">THRIFT-487</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12745262">THRIFT-2755</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12843815">THRIFT-3233</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12955957">THRIFT-3777</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12830346" name="thrift-patch" size="1568" author="bgedik" created="Mon, 26 Sep 2016 15:17:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 11 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i33tz3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>