<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 07:57:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-836] Race condition causes CancelledKeyException in TAsyncClientManager</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-836</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;Currently, TAsyncClientMethod cancels its selection key on a successful method call. The current model assumes the key goes away and the client gets a new key on the next Selector registration, which is incorrect - the cancelled key can hang around, with the implication that the developer needs to check key.isValid() on the next selector action, which TAsyncClientMethod currently does. However, if the developer re-uses the client for another call, you can get a CancelledKeyException from the Selector#register call, which crashes the SelectorThread. This occurs once you have sufficient concurrency on the Selector - cancelled key cleanup takes longer, so we hit this condition.&lt;/p&gt;

&lt;p&gt;Attached is a patch with fix and regression test. Summary of fix:&lt;/p&gt;

&lt;p&gt;1) Don&apos;t cancel() the key after a successful method call.&lt;br/&gt;
2) Catch CancelledKeyException in the SelectorThread, so the manager can&apos;t die.&lt;br/&gt;
3) Add an onError method to TAsyncMethodCall, so that the SelectorThread can notify the client of an error on selector registration.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12470674">THRIFT-836</key>
            <summary>Race condition causes CancelledKeyException in TAsyncClientManager</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="1" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">Blocker</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bryanduxbury">Bryan Duxbury</assignee>
                                    <reporter username="ning">Ning Liang</reporter>
                        <labels>
                    </labels>
                <created>Mon, 2 Aug 2010 20:40:48 +0000</created>
                <updated>Thu, 5 Aug 2010 21:14:23 +0000</updated>
                            <resolved>Thu, 5 Aug 2010 21:14:23 +0000</resolved>
                                                    <fixVersion>0.4</fixVersion>
                                    <component>Java - Library</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12894710" author="ning" created="Mon, 2 Aug 2010 21:01:35 +0000"  >&lt;p&gt;Summary:&lt;/p&gt;

&lt;p&gt;1) Only cancel key on error&lt;br/&gt;
2) Catch runtime exceptions in TAsyncClientManager&apos;s SelectorThread&lt;br/&gt;
3) Notify TAsyncMethodCall of error on bad registration, and propagate to client and user (via error callback)&lt;br/&gt;
4) Regression test&lt;/p&gt;</comment>
                            <comment id="12894715" author="ning" created="Mon, 2 Aug 2010 21:20:35 +0000"  >&lt;p&gt;Handle ClosedChannelException explicitly, and catch all further runtime errors. These are:&lt;/p&gt;

&lt;p&gt;    IllegalBlockingModeException - If this channel is in blocking mode &lt;br/&gt;
    IllegalSelectorException - If this channel was not created by the same provider as the given selector&lt;br/&gt;
    IllegalArgumentException - If a bit in ops does not correspond to an operation that is supported by this channel, that is, if set &amp;amp; ~validOps() != 0&lt;/p&gt;</comment>
                            <comment id="12894726" author="ning" created="Mon, 2 Aug 2010 21:56:04 +0000"  >&lt;p&gt;One more catch statement... need to catch the ClosedSelectorException from the key iteration block&lt;/p&gt;</comment>
                            <comment id="12895809" author="bryanduxbury" created="Thu, 5 Aug 2010 21:14:23 +0000"  >&lt;p&gt;I just committed this. Thanks for the patch, Ning!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12451083" name="async_client_catch_all.diff" size="7987" author="ning" created="Mon, 2 Aug 2010 21:56:04 +0000"/>
                            <attachment id="12451078" name="async_thrift.diff" size="5976" author="ning" created="Mon, 2 Aug 2010 21:01:35 +0000"/>
                            <attachment id="12451079" name="async_thrift_catch_except.diff" size="6699" author="ning" created="Mon, 2 Aug 2010 21:20:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>186985</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 16 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i16efz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>245472</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>