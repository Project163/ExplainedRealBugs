<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 07:54:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-96] TSocket.peek fails on FreeBSD</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-96</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;POSIX says what recv(2) should returns 0 if peer has performed a shutdown. This feature uses in TBufferedTransport &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  bool peek() {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (rBase_ == rBound_) {
      setReadBuffer(rBuf_.get(), transport_-&amp;gt;read(rBuf_.get(), rBufSize_));
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (rBound_ &amp;gt; rBase_);
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The decision works fine on linux, but fails on freebsd. In freebsd, recv returns -1 and errno==ECONNRESET.&lt;/p&gt;</description>
                <environment>&lt;p&gt;FreeBSD&lt;/p&gt;</environment>
        <key id="12401021">THRIFT-96</key>
            <summary>TSocket.peek fails on FreeBSD</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="shigin">Alexander Shigin</assignee>
                                    <reporter username="shigin">Alexander Shigin</reporter>
                        <labels>
                    </labels>
                <created>Fri, 25 Jul 2008 14:50:40 +0000</created>
                <updated>Mon, 11 May 2009 20:15:16 +0000</updated>
                            <resolved>Thu, 5 Mar 2009 21:06:09 +0000</resolved>
                                                                    <component>C++ - Library</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="12616916" author="shigin" created="Fri, 25 Jul 2008 14:54:13 +0000"  >&lt;p&gt;&lt;a href=&quot;http://git.thrift-rpc.org/?p=thrift.git;a=shortlog;h=refs/heads/pri/shigin/peek&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git.thrift-rpc.org/?p=thrift.git;a=shortlog;h=refs/heads/pri/shigin/peek&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;There is two changes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;create new TUnderlyingTransport to share common code with TBufferedTransport and TFramedTransport. The change need because TBufferedTransport doesn&apos;t call peek of underlying transport.&lt;/li&gt;
	&lt;li&gt;fix TSocket.peek for freebsd.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12616989" author="dreiss" created="Fri, 25 Jul 2008 18:24:17 +0000"  >&lt;p&gt;mcslee, can you give us some insight into why the current version of TBufferedTransport::peek does a read instead of calling the underlying peek?&lt;/p&gt;</comment>
                            <comment id="12616999" author="dreiss" created="Fri, 25 Jul 2008 18:37:45 +0000"  >&lt;p&gt;Alexander, what would you think about doing the following instead?  Make TSocket::read return 0 even when recv returns ECONNRESET.  This would basically be forcing TSocket to use the POSIX semantics even on FreeBSD.&lt;/p&gt;</comment>
                            <comment id="12617052" author="shigin" created="Fri, 25 Jul 2008 20:51:20 +0000"  >&lt;p&gt;You are right, TSocket::read should follow the same semantic on a different  platform (I don&apos;t have an OpenSolaris but it seems recv acts like one on FreeBSD).&lt;/p&gt;

&lt;p&gt;But I think the patch should be applied anyway: it reduces copy-paste in code.&lt;/p&gt;</comment>
                            <comment id="12618754" author="shigin" created="Thu, 31 Jul 2008 16:46:35 +0000"  >&lt;p&gt;This patch makes TSocket::read to act on FreeBSD as on a normal platform.&lt;/p&gt;</comment>
                            <comment id="12618755" author="shigin" created="Thu, 31 Jul 2008 16:49:15 +0000"  >&lt;p&gt;The new version of patch checks ECONNRESET only if FreeBSD is target platform.&lt;/p&gt;</comment>
                            <comment id="12637648" author="dreiss" created="Tue, 7 Oct 2008 20:54:32 +0000"  >&lt;p&gt;I think the TSocket change is solid.  The TUnderlyingTransport change is mostly good, but it does change two behaviors.&lt;/p&gt;

&lt;p&gt;1/ TBufferedTransport now uses the underlying peek instead of trying to read.  mcslee, can you give us some insight into why the current version of TBufferedTransport::peek does a read instead of calling the underlying peek?&lt;/p&gt;

&lt;p&gt;2/ The read buffer for TFramedTransport is allocated unnecessarily at construction time.  This is not optimal, but I guess it is not a big deal since we reuse it if it is big enough.&lt;/p&gt;</comment>
                            <comment id="12637650" author="mcslee" created="Tue, 7 Oct 2008 20:58:24 +0000"  >&lt;p&gt;I believe the reason for doing read() instead of peek() with TBufferedTransport was a mini-optimization. Since you&apos;re buffering the reads anyway, you might as well actually pull the data into your buffer if you&apos;re going to check for its existence. This way, you don&apos;t make a peek() call and a read() call, which is beneficial in the default case of using a buffered socket. This means 1 syscall to read() instead of 2 syscalls.&lt;/p&gt;

&lt;p&gt;I&apos;d be fine with switching this to use peek() on the underlying transport, since in some cases read() may have side effects that aren&apos;t wanted on the peek() operation (though I would expect this to be quite rare). But I&apos;d also be fine with making the interface contract specify that calls to read() must not have any side effects that a peek() call would not also want.&lt;/p&gt;</comment>
                            <comment id="12637653" author="dreiss" created="Tue, 7 Oct 2008 21:05:18 +0000"  >&lt;p&gt;peek is still virtual, right?  I think we should just keep the original version of peek defined in TBufferedTransport and leave the current version as the default in TUnderlying.  What do you guys think?&lt;/p&gt;</comment>
                            <comment id="12660846" author="ahfeel" created="Mon, 5 Jan 2009 18:37:26 +0000"  >&lt;p&gt;What&apos;s this issue status ? I agree with David&apos;s last comment, leaving the current version of peek in TUnderlying sounds good without changing the current behavior of TBufferedTransport. Reviewed the patch, looks good to me.&lt;/p&gt;</comment>
                            <comment id="12677126" author="starcon" created="Thu, 26 Feb 2009 20:04:48 +0000"  >&lt;p&gt;What&apos;s the status of JIRA?&lt;/p&gt;</comment>
                            <comment id="12678675" author="shigin" created="Wed, 4 Mar 2009 10:17:58 +0000"  >&lt;p&gt;Sorry for a long time before response. I&apos;ve changed the patch according to the last David comment.&lt;/p&gt;</comment>
                            <comment id="12678677" author="shigin" created="Wed, 4 Mar 2009 10:19:47 +0000"  >&lt;p&gt;oops, forget to choose the right radio button&lt;/p&gt;</comment>
                            <comment id="12678834" author="kclark" created="Wed, 4 Mar 2009 18:39:29 +0000"  >&lt;p&gt;Are there any other issues with this ticket, or can I push?&lt;/p&gt;</comment>
                            <comment id="12679238" author="kclark" created="Thu, 5 Mar 2009 16:46:22 +0000"  >&lt;p&gt;Last call. I&apos;m going to push in the next few hours unless I get hear objections.&lt;/p&gt;</comment>
                            <comment id="12679352" author="kclark" created="Thu, 5 Mar 2009 21:06:09 +0000"  >&lt;p&gt;Ok, pushed in 750585.&lt;/p&gt;

&lt;p&gt;Sorry for the wait.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12425137">THRIFT-497</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12387297" name="thrift-freebsd-read.patch" size="692" author="shigin" created="Thu, 31 Jul 2008 16:46:35 +0000"/>
                            <attachment id="12401397" name="thrift-peek-fix-2.patch" size="9193" author="shigin" created="Wed, 4 Mar 2009 10:19:47 +0000"/>
                            <attachment id="12387298" name="thrift-peek-fix.patch" size="8891" author="shigin" created="Thu, 31 Jul 2008 16:49:15 +0000"/>
                            <attachment id="12386891" name="thrift-peek-fix.patch" size="6932" author="shigin" created="Fri, 25 Jul 2008 14:54:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>186345</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 38 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i16eyv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>245557</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>