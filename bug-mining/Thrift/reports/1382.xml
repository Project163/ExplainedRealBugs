<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:21:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-3392] Java TZlibTransport does not close its wrapper streams upon close()</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-3392</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;While setting up a short demo project using the new Java TZlibTransport in 0.9.3, I wrote code like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (TProtocol proto = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TJSONProtocol(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TZlibTransport(...))) {
  Blog blog = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Blog();
  &lt;span class=&quot;code-comment&quot;&gt;// set up fields in blog
&lt;/span&gt;  proto.write(blog);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, when I went to look at the file, I found it mostly empty (with only the header bytes). I had a look at the TZlibTransport code, which seems to be a subclass of TIOStreamTransport that wraps its underlying transport using Java inflater/deflater streams:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; TZlibTransport(TTransport transport, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; compressionLevel) {
  transport_ = transport;
  inputStream_ = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InflaterInputStream(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TTransportInputStream(transport_), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Inflater());
  outputStream_ = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DeflaterOutputStream(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TTransportOutputStream(transport_), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Deflater(compressionLevel, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;), &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, on its close method it only closes the transport and not the underlying streams, forcing users to flush the transport before closing if they really want to write everything:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close() {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (transport_.isOpen()) {
          transport_.close();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I think it would be better if we simply relied on the close() method of the TIOStreamTransport, which closes the input and output streams if they have been created. Additionally, it would be better to create the input stream on the first read and the output stream on the first write: otherwise, we will get an error during closing if we&apos;re only reading (as TIOStreamTransport will still try to close the output side, resulting in writes from the deflater).&lt;/p&gt;

&lt;p&gt;I have a first version of a fix for these issues: I&apos;ll turn it into a pull request on Github.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12905783">THRIFT-3392</key>
            <summary>Java TZlibTransport does not close its wrapper streams upon close()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="codesf">Randy Abernethy</assignee>
                                    <reporter username="bluezio">Antonio Garc&#237;a</reporter>
                        <labels>
                    </labels>
                <created>Sun, 18 Oct 2015 13:15:23 +0000</created>
                <updated>Wed, 6 Jan 2016 02:06:16 +0000</updated>
                            <resolved>Sun, 18 Oct 2015 15:11:05 +0000</resolved>
                                    <version>0.9.3</version>
                                    <fixVersion>0.10.0</fixVersion>
                                    <component>Java - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14962371" author="githubbot" created="Sun, 18 Oct 2015 13:18:01 +0000"  >&lt;p&gt;GitHub user bluezio opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/655&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/655&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3392&quot; title=&quot;Java TZlibTransport does not close its wrapper streams upon close()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3392&quot;&gt;&lt;del&gt;THRIFT-3392&lt;/del&gt;&lt;/a&gt; Java TZlibTransport: ensure inflater/deflater are closed upon close()&lt;/p&gt;

&lt;p&gt;    More information available on the JIRA issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3392&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/THRIFT-3392&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/bluezio/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/bluezio/thrift&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3392&quot; title=&quot;Java TZlibTransport does not close its wrapper streams upon close()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3392&quot;&gt;&lt;del&gt;THRIFT-3392&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/655.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/655.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #655&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit e413701b53a4aa0069b5e5d873847c147308581e&lt;br/&gt;
Author: Antonio Garc&#237;a-Dom&#237;nguez &amp;lt;nyoescape@gmail.com&amp;gt;&lt;br/&gt;
Date:   2015-10-18T13:16:02Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3392&quot; title=&quot;Java TZlibTransport does not close its wrapper streams upon close()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3392&quot;&gt;&lt;del&gt;THRIFT-3392&lt;/del&gt;&lt;/a&gt; Java TZlibTransport: ensure inflater/deflater are closed upon close()&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14962427" author="githubbot" created="Sun, 18 Oct 2015 15:09:15 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/655&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/655&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14962430" author="codesf" created="Sun, 18 Oct 2015 15:11:05 +0000"  >&lt;p&gt;committed, thanks for the issue, patch and especially the test!&lt;/p&gt;

&lt;p&gt;I modified the patch to super.close() on close() to preserve the close of the underlying transport (which could be a file, socket, named pipe, etc.).&lt;/p&gt;</comment>
                            <comment id="14962464" author="hudson" created="Sun, 18 Oct 2015 15:48:26 +0000"  >&lt;p&gt;SUCCESS: Integrated in Thrift #1692 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/1692/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/1692/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3392&quot; title=&quot;Java TZlibTransport does not close its wrapper streams upon close()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3392&quot;&gt;&lt;del&gt;THRIFT-3392&lt;/del&gt;&lt;/a&gt;:ZLib does not flush wrapper streams on close Client: Java (ra: rev f593dd3a96dddbcd4063690d20fee98d395bb360)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;lib/java/src/org/apache/thrift/transport/TZlibTransport.java&lt;/li&gt;
	&lt;li&gt;lib/java/test/org/apache/thrift/transport/TestTZlibTransport.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 5 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2n5uf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>