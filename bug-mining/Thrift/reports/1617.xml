<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:24:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-3805] Golang server susceptible to memory spike from malformed message</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-3805</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;When a thrift server is started through the Go library, using the default TServerSocket, the processor from the generated files, and a SimpleServer2 (which uses BinaryProtocol), it listens on the created socket for incoming messages.  However, if the incoming message is &lt;b&gt;not&lt;/b&gt; from another Thrift server, and thus the data submitted over the connection does not conform to the Thrift message serialization format (for us, this was triggered by automated security scanners connecting to the exposed port and sending it data to see how it would react), it triggers a massive memory spike.&lt;/p&gt;

&lt;p&gt;This appears to happen because the BinaryProtocol expects the first 4 bytes of the file to indicate the size of the following message, interpreted as a signed Int32 in BigEndian format.  If this value is positive, it reads that many bytes from the connection.&lt;/p&gt;

&lt;p&gt;However, to do this, it first &lt;b&gt;allocates&lt;/b&gt; a slice of that many bytes.  If the provided message is not a thrift serialization, this signed Int32 can be massive (we&apos;re typically seeing it have a value of 1-2 billion), causing it to allocate &lt;b&gt;hundreds&lt;/b&gt; of megabytes of data.  This slice is retained until the expected number of bytes are received (which generally doesn&apos;t happen for a malformed connection), or until the connection is closed from the client end.  When either happen, the BinaryProtocol then type-casts the entire array to a String type, which causes a &lt;b&gt;second&lt;/b&gt; allocation of equal size, before returning the message to be processed.  &lt;/p&gt;

&lt;p&gt;Since this processing fails, both the byte slice and the string are discarded and reclaimed on the next garbage collection cycle, but in the mean type, it will have allocated an amount of memory equal to double the value of that Int32, in bytes.  We&apos;re typically seeing this allocation exceed 800-1000 MB per variable (so 800 MB when the connection is received, and another 800-1000 MB when it&apos;s closed).  The first allocation will persist as long as the connection is maintained, and other connections that are similarly malformed will cause concurrent allocation spikes, which can easily crash the server.&lt;/p&gt;

&lt;p&gt;To demonstrate this, one can make an extremely simple single-method thrift contract, start a server, then netcat to the host port and feed it at least 4 characters of data.&lt;/p&gt;

&lt;p&gt;To fix this, we implemented an iterative buffered read into the BinaryProtocol itself.  Instead of allocating the entire array at once, if the message indicates it is larger than a certain size (we have it set at 32kb, but the actual value is largely arbitrary), it instead reads the message in increments of that size, and joins them using the standard library bytes.Buffer type.  Here&apos;s a diff of our changes:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://gist.github.com/kaedys/53b8fd05690d5d8f202afa7878d6e3d5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/kaedys/53b8fd05690d5d8f202afa7878d6e3d5&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This fixes the issue of having a massive initial allocation due to a malformed request, while still allowing messages of arbitrary incoming size.  It will likely marginally slow down the reading of extremely large messages (ones substantially larger than the constant defined), but the bytes.Buffer type is well optimized for growing itself as it is written to.  I also realize that this only occurs with malformed requests to the server, but I would think a server package should be relatively hardened against malformed data being submitted to it.&lt;/p&gt;</description>
                <environment>&lt;p&gt;OSX 10.10.5, Debian 7.10&lt;/p&gt;</environment>
        <key id="12963669">THRIFT-3805</key>
            <summary>Golang server susceptible to memory spike from malformed message</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kaedys">Michael Scott Leuthaeuser</assignee>
                                    <reporter username="kaedys">Michael Scott Leuthaeuser</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Apr 2016 21:28:52 +0000</created>
                <updated>Fri, 12 Aug 2016 01:29:48 +0000</updated>
                            <resolved>Sat, 28 May 2016 11:36:07 +0000</resolved>
                                    <version>0.9.3</version>
                                    <fixVersion>0.10.0</fixVersion>
                                    <component>Go - Library</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15263252" author="jensg" created="Thu, 28 Apr 2016 23:29:41 +0000"  >&lt;p&gt;Thanks, good catch! &lt;/p&gt;

&lt;p&gt;If you could &lt;a href=&quot;http://thrift.apache.org/docs/HowToContribute&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;put it into a patch or PR&lt;/a&gt; I will look at it.&lt;/p&gt;</comment>
                            <comment id="15264208" author="kaedys" created="Fri, 29 Apr 2016 15:39:55 +0000"  >&lt;p&gt;Verifying with workplace that I&apos;m allowed to submit such a patch, since the fix was found, investigated, and coded on company time.  Will get back to you.&lt;/p&gt;</comment>
                            <comment id="15274615" author="kaedys" created="Fri, 6 May 2016 19:36:39 +0000"  >&lt;p&gt;Apologies for the delay.  Attacking patch to issue.&lt;/p&gt;

&lt;p&gt;My workplace requested that it be credited to &quot;(c) Rackspace&quot;.  Not sure how that works for an open-source project like this.&lt;/p&gt;</comment>
                            <comment id="15275738" author="zariel" created="Sun, 8 May 2016 21:09:16 +0000"  >&lt;p&gt;The check for the buffer size should be, size &amp;lt;= cap(buffer) as it can still be expanded.&lt;/p&gt;</comment>
                            <comment id="15278220" author="kaedys" created="Tue, 10 May 2016 14:55:34 +0000"  >&lt;p&gt;p.buffer is a fixed-length array, not a slice.  Cap = Len for arrays, and neither can be changed at run time.&lt;/p&gt;</comment>
                            <comment id="15303044" author="kaedys" created="Thu, 26 May 2016 22:06:54 +0000"  >&lt;p&gt;Wanted to poke in and see what the status of this was.  There a chance it can make it into Thrift 0.9.4?&lt;/p&gt;</comment>
                            <comment id="15303928" author="jensg" created="Fri, 27 May 2016 10:58:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Zariel&quot; class=&quot;user-hover&quot; rel=&quot;zariel&quot;&gt;Zariel&lt;/a&gt;, any comments from your side?&lt;/p&gt;</comment>
                            <comment id="15305314" author="jensg" created="Sat, 28 May 2016 11:36:07 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12802725" name="thrift_golang_memory_spike_fix.patch" size="1574" author="kaedys" created="Fri, 6 May 2016 19:37:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 25 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2wxmf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>