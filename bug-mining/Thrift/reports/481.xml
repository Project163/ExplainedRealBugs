<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:01:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-1205] port server unduly fragile with arbitrary input</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-1205</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;Telnetting to the port and type a couple of arbitrary characters crashes the server almost immediately as follows. I haven&apos;t glanced at the relevant code. Is this reproducible on other platforms?&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ ./run-server.sh 
Starting the simple server...
Exception in thread &quot;Thread-0&quot; java.lang.OutOfMemoryError: Java heap space
        at org.apache.thrift.protocol.TBinaryProtocol.readStringBody(TBinaryProtocol.java:353)
        at org.apache.thrift.protocol.TBinaryProtocol.readMessageBegin(TBinaryProtocol.java:215)
        at SimonSays$Processor.process(Unknown Source)
        at org.apache.thrift.server.TSimpleServer.serve(TSimpleServer.java:70)
        at JavaServer.simple(Unknown Source)
        at JavaServer$1.run(Unknown Source)
        at java.lang.Thread.run(Thread.java:613)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;javac 1.5.0_19, OS X 10.4.11&lt;/p&gt;</environment>
        <key id="12510389">THRIFT-1205</key>
            <summary>port server unduly fragile with arbitrary input</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kingryan">Ryan King</assignee>
                                    <reporter username="qu1j0t3">Toby Thain</reporter>
                        <labels>
                            <label>security</label>
                    </labels>
                <created>Wed, 15 Jun 2011 02:40:54 +0000</created>
                <updated>Thu, 11 Aug 2011 19:39:01 +0000</updated>
                            <resolved>Thu, 11 Aug 2011 18:54:26 +0000</resolved>
                                    <version>0.6.1</version>
                                    <fixVersion>0.8</fixVersion>
                                    <component>Java - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13049582" author="qu1j0t3" created="Wed, 15 Jun 2011 02:42:18 +0000"  >&lt;p&gt;I should have linked to my program source:&lt;br/&gt;
&lt;a href=&quot;https://github.com/qu1j0t3/thriftwork&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/qu1j0t3/thriftwork&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13050723" author="bryanduxbury" created="Thu, 16 Jun 2011 20:51:23 +0000"  >&lt;p&gt;You should make use of the max frame size parameter to protect yourself from situations like these.&lt;/p&gt;</comment>
                            <comment id="13050814" author="qu1j0t3" created="Thu, 16 Jun 2011 23:49:06 +0000"  >&lt;p&gt;So you&apos;re saying that it&apos;s acceptable for the server to crash if anyone merely telnets into a public facing Thrift server (0.6.1) and types a couple of characters? And you don&apos;t consider that a security bug?&lt;/p&gt;</comment>
                            <comment id="13050815" author="kingryan" created="Thu, 16 Jun 2011 23:51:42 +0000"  >&lt;p&gt;Thrift is not design for public facing services.&lt;/p&gt;

&lt;p&gt;Bryan- perhaps there should be a (large) default max frame size?&lt;/p&gt;</comment>
                            <comment id="13050819" author="qu1j0t3" created="Fri, 17 Jun 2011 00:07:01 +0000"  >&lt;p&gt;Fair enough, but:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;it will inevitably be used in this way, unless (even if) there is a big disclaimer somewhere (did I miss it?)&lt;/li&gt;
	&lt;li&gt;doesn&apos;t Facebook use it for public facing services? What about their puzzle server?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13050886" author="bryanduxbury" created="Fri, 17 Jun 2011 03:33:28 +0000"  >&lt;p&gt;@Toby - The problem is that &quot;typing a bunch of characters&quot; is indistinguishable from the first few bytes of a really long message. I&apos;d really like to have a good solution to this problem so I can point to that in the future, but so far no one has managed to propose a workable solution.&lt;/p&gt;

&lt;p&gt;@Ryan - I&apos;d accept a patch for decreasing the default size to something reasonably large, if you spun a good argument for it.&lt;/p&gt;</comment>
                            <comment id="13051009" author="qu1j0t3" created="Fri, 17 Jun 2011 12:09:18 +0000"  >&lt;p&gt;@Bryan - yes, I inferred that from the nature of the crash.&lt;/p&gt;

&lt;p&gt;I agree that (apart from a default limit, which should be a decent workaround), solving this is tricky. I haven&apos;t looked at the code yet, but it might be possible to guard against this by simply not allocating the entire buffer immediately, but rather a smaller interim buffer, and waiting to see if a valid message is forthcoming. This would work best if the rest of the unmarshalling code had thorough validity checks. This should avoid the attempt to allocate a meaninglessly large buffer in the case that the message can be rejected on other grounds. Of course, an attacker who&apos;s willing to craft a valid, extremely large Thrift message can still eat up server resources &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I can look at this approach if you think it has merit.&lt;/p&gt;</comment>
                            <comment id="13051123" author="bryanduxbury" created="Fri, 17 Jun 2011 15:03:38 +0000"  >&lt;p&gt;The &quot;partial allocation&quot; approach actually isn&apos;t workable. The Thrift deserialization code depends on the call stack for keeping state, so if it runs out of data, there&apos;s no nonblocking way for it to give up control and wait for more data to arrive. The whole premise of the nonblocking server is that we can know when all the bytes for a message have arrived without doing any actual deserialization, hence the requirement for framed transport.&lt;/p&gt;</comment>
                            <comment id="13051233" author="kingryan" created="Fri, 17 Jun 2011 18:13:44 +0000"  >&lt;p&gt;Bryan-&lt;/p&gt;

&lt;p&gt;The default maxLength is now 2GB. I propose we set it to something like 64MB (or even less). I think that&apos;s still significantly bigger than the common use case. We should make the normal case (relatively small frames) safer and put the burden of customization on the rare cases.&lt;/p&gt;</comment>
                            <comment id="13051404" author="qu1j0t3" created="Fri, 17 Jun 2011 23:52:20 +0000"  >&lt;p&gt;@Ryan - I&apos;d recommend less, maybe 1MB, and make this limit (and how to lift it) clear in the doc, along with the recommendation that Thrift not be used public-facing, due to these DoS risks. Or, better, float the proposal on the mailing list; I bet that even 1MB covers the vast majority of use cases.&lt;/p&gt;</comment>
                            <comment id="13051417" author="bryanduxbury" created="Sat, 18 Jun 2011 00:45:53 +0000"  >&lt;p&gt;I think 1MB is too small. This is a really tricky issue, because the bottom line is that people are definitely going to bump their heads into it before they go looking for the option, if they ever do.&lt;/p&gt;</comment>
                            <comment id="13051434" author="qu1j0t3" created="Sat, 18 Jun 2011 01:40:57 +0000"  >&lt;p&gt;But the exception in this situation can clearly state why it&apos;s being thrown, what the option is, and where to find it.&lt;/p&gt;</comment>
                            <comment id="13051526" author="qu1j0t3" created="Sat, 18 Jun 2011 14:41:25 +0000"  >&lt;p&gt;Actually, readFrame() is free to read the frame in chunks of any size, avoiding the need for upfront allocation, though when (if) fully read they would need to be assembled into a single byte[] given the current deserializer interface.&lt;/p&gt;

&lt;p&gt;It seems to me that this can be solved for all transports by having the deserializer ask for chunks instead of walking a whole frame: it&apos;s trivial to pretend a complete buffer is a nonblocking stream but pretending a blocking stream is a buffer leads to difficulties like those discussed here. &lt;/p&gt;</comment>
                            <comment id="13052066" author="bryanduxbury" created="Mon, 20 Jun 2011 16:57:25 +0000"  >&lt;blockquote&gt;&lt;p&gt;Actually, readFrame() is free to read the frame in chunks of any size, avoiding the need for upfront allocation&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is true for FramedTransport, but not for the nonblocking servers themselves. We make an important distinction between the IO part of the request and the deserialization part of the request.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;this can be solved for all transports by having the deserializer ask for chunks instead of walking a whole frame&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think you should underestimate the amount of work this would be. It&apos;s a completely different scheme for deserialization.&lt;/p&gt;</comment>
                            <comment id="13052170" author="kingryan" created="Mon, 20 Jun 2011 19:19:51 +0000"  >&lt;p&gt;reopening so i can attach a patch&lt;/p&gt;</comment>
                            <comment id="13052171" author="kingryan" created="Mon, 20 Jun 2011 19:20:20 +0000"  >&lt;p&gt;Reduces the default frame limit to 16MB.&lt;/p&gt;</comment>
                            <comment id="13083387" author="bryanduxbury" created="Thu, 11 Aug 2011 18:54:26 +0000"  >&lt;p&gt;I just committed this. Thanks for the patch.&lt;/p&gt;</comment>
                            <comment id="13083425" author="hudson" created="Thu, 11 Aug 2011 19:39:01 +0000"  >&lt;p&gt;Integrated in Thrift #218 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/218/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/218/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1205&quot; title=&quot;port server unduly fragile with arbitrary input&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1205&quot;&gt;&lt;del&gt;THRIFT-1205&lt;/del&gt;&lt;/a&gt;. java: port server unduly fragile with arbitrary input&lt;/p&gt;

&lt;p&gt;Increase the default max frame size to 16MB.&lt;/p&gt;

&lt;p&gt;Patch: Ryan King&lt;/p&gt;

&lt;p&gt;bryanduxbury : &lt;a href=&quot;http://svn.apache.org/viewvc/?view=rev&amp;amp;rev=1156731&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/?view=rev&amp;amp;rev=1156731&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/thrift/trunk/lib/java/src/org/apache/thrift/transport/TFramedTransport.java&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/java/src/org/apache/thrift/transport/TFastFramedTransport.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12483193" name="0001-THRIFT-1205-reduce-the-default-frame-size-to-16MB.patch" size="1848" author="kingryan" created="Mon, 20 Jun 2011 19:20:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>65332</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 15 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i084ef:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>45312</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>