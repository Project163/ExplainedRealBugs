<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 07:57:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-601] sending random data crashes thrift service</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-601</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;Sending random data to a Java thrift service causes it to crash with extreme prejudice.&lt;/p&gt;

&lt;p&gt;dd if=/dev/urandom count=1 | nc $host 9160&lt;/p&gt;

&lt;p&gt;... produces ...&lt;/p&gt;

&lt;p&gt;java.lang.OutOfMemoryError: Java heap space&lt;br/&gt;
        at org.apache.thrift.protocol.TBinaryProtocol.readStringBody(TBinaryProtocol.java:296)&lt;br/&gt;
        at org.apache.thrift.protocol.TBinaryProtocol.readMessageBegin(TBinaryProtocol.java:203)&lt;br/&gt;
        at org.apache.cassandra.service.Cassandra$Processor.process(Cassandra.java:615)&lt;br/&gt;
        at org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadPoolServer.java:253)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:636)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12437439">THRIFT-601</key>
            <summary>sending random data crashes thrift service</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dreiss">David Reiss</assignee>
                                    <reporter username="urandom">Eric Evans</reporter>
                        <labels>
                            <label>gsoc</label>
                    </labels>
                <created>Tue, 6 Oct 2009 22:18:52 +0000</created>
                <updated>Mon, 28 Apr 2014 09:33:05 +0000</updated>
                            <resolved>Mon, 26 Apr 2010 19:44:08 +0000</resolved>
                                    <version>0.2</version>
                                    <fixVersion>0.3</fixVersion>
                                    <component>Java - Library</component>
                        <due></due>
                            <votes>5</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="12762815" author="dreiss" created="Tue, 6 Oct 2009 23:44:13 +0000"  >&lt;p&gt;Thrift is meant for for RPC between cooperating applications, not handling random data.  That said, check out setReadLength in TBinaryProtocol.&lt;/p&gt;</comment>
                            <comment id="12762817" author="bryanduxbury" created="Tue, 6 Oct 2009 23:48:27 +0000"  >&lt;p&gt;Or, use TNonblockingServer and set a max memory buffer size.&lt;/p&gt;</comment>
                            <comment id="12762820" author="dreiss" created="Tue, 6 Oct 2009 23:55:39 +0000"  >&lt;p&gt;You might actually need both, because you could have a small frame header to trick the server, then a large (fake) string size.&lt;/p&gt;</comment>
                            <comment id="12763524" author="jbellis" created="Thu, 8 Oct 2009 15:32:13 +0000"  >&lt;p&gt;&quot;Thrift is meant for for RPC between cooperating applications&quot; is true but meaningless.  It&apos;s easy to achieve the same result through human error (e.g. sufficiently incompatible protocols for the &quot;same&quot; service, or connecting to the wrong port on a machine running two thrift services, or ...).  This is about being un-fragile, not protecting against malice.&lt;/p&gt;</comment>
                            <comment id="12763575" author="dreiss" created="Thu, 8 Oct 2009 17:21:38 +0000"  >&lt;p&gt;&quot;That said, check out setReadLength in TBinaryProtocol.&quot;&lt;/p&gt;</comment>
                            <comment id="12763577" author="jbellis" created="Thu, 8 Oct 2009 17:25:46 +0000"  >&lt;p&gt;i did.  it&apos;s not very useful.&lt;/p&gt;</comment>
                            <comment id="12763582" author="dreiss" created="Thu, 8 Oct 2009 17:31:58 +0000"  >&lt;p&gt;Neither is your description of the problem.  To clarify, setting the maximum read size will prevent this exception.  Why don&apos;t you think it is useful?&lt;/p&gt;</comment>
                            <comment id="12763588" author="jbellis" created="Thu, 8 Oct 2009 17:43:21 +0000"  >&lt;p&gt;The problem is adequately described.  But since you apparently want me to describe a solution too, here is what I would do given my limited understanding of the internals:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;readMessageBegin needs to know what the range of possible message names are, and reject messages whose name length would be longer/shorter than the max/min possible.&lt;/li&gt;
	&lt;li&gt;string and bytes should be able to specify a max length, because one size does not fit all&lt;/li&gt;
	&lt;li&gt;string and byte max length should be typedef-able&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12775197" author="esteve" created="Mon, 9 Nov 2009 23:54:04 +0000"  >&lt;p&gt;We agreed (well, kindof) to use the framed transport by default and leave the buffered one as optional. Does this happen using the framed transport too? It shouldn&apos;t, but I&apos;m not sure. In any case, I&apos;m with Eric and Jonathan here, this looks pretty serious to me.&lt;/p&gt;</comment>
                            <comment id="12775231" author="brandon.williams" created="Tue, 10 Nov 2009 01:00:48 +0000"  >&lt;p&gt;Yes, this happens with either the framed or nonframed transport.  I too find this issue to be pretty serious, it&apos;s far too easy to accidentally crash the server and it makes port monitoring difficult.&lt;/p&gt;</comment>
                            <comment id="12776012" author="esteve" created="Tue, 10 Nov 2009 19:04:07 +0000"  >&lt;p&gt;This is a very simple patch which just closes an incoming connection if the frame size is too big. It probably doesn&apos;t address all the implied issues, so be careful.&lt;/p&gt;

&lt;p&gt;As for adding limits to string, bytes, etc. I&apos;m not against it, but I believe it belongs in a separate ticket, as it will affect all of the languages supported by Thrift.&lt;/p&gt;</comment>
                            <comment id="12776066" author="brandon.williams" created="Tue, 10 Nov 2009 20:33:44 +0000"  >&lt;p&gt;+1, this patch works for me if I tweak DEFAULT_MAX_LENGTH to a sane value.  The connection is closed, but the server does not crash.&lt;/p&gt;</comment>
                            <comment id="12776072" author="jbellis" created="Tue, 10 Nov 2009 20:43:12 +0000"  >&lt;p&gt;I don&apos;t know how valuable this is, though...&lt;/p&gt;

&lt;p&gt;(1) you can still crash the server with a bogus int anywhere but the frame size&lt;br/&gt;
(2) it requres client-side support to warn users if they&apos;re trying to build a command that is too long for the frame size &amp;#8211; and since the default is a no-op, the server needs to communicate what the actual limit is, if any, to the client first.  is that protocol change worth it, given the limitations of (1)?&lt;/p&gt;</comment>
                            <comment id="12776195" author="esteve" created="Wed, 11 Nov 2009 00:42:20 +0000"  >&lt;p&gt;You&apos;re right Jonathan, maybe the framed transports should advertise their maximum length? It&apos;s not perfect either, but it&apos;s a small step in the right direction &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12846069" author="garo" created="Tue, 16 Mar 2010 18:50:00 +0000"  >&lt;p&gt;I have crashed an application using thrift as a server a few times by telnetting to a wrong port. This is the only case I know telnetting to a wrong port will cause a service crash and it&apos;s just stupid. Hopefully a sane fix can be found as soon as possible.&lt;/p&gt;</comment>
                            <comment id="12846096" author="jking" created="Tue, 16 Mar 2010 19:55:26 +0000"  >&lt;p&gt;Would a simple port scan (open socket, close) cause a crash as well?  This looks like it will be runtime implementation specific - are any others affected?&lt;/p&gt;</comment>
                            <comment id="12851523" author="bryanduxbury" created="Tue, 30 Mar 2010 19:24:44 +0000"  >&lt;p&gt;How about this patch? It makes sure that &lt;b&gt;any&lt;/b&gt; kind of error while processing is caught and won&apos;t take the server down. As it was already coded, this was the objective, but OutOfMemoryErrors turn out not to be Exception descendants. Oops.&lt;/p&gt;</comment>
                            <comment id="12851529" author="dreiss" created="Tue, 30 Mar 2010 19:34:09 +0000"  >&lt;p&gt;I don&apos;t think catching OOM from the handler is a good idea.  In C++, at least, we have found that it is rarely recoverable at the process level and keeping the process running in this state just prevents your system from recovering.&lt;/p&gt;</comment>
                            <comment id="12851535" author="jbellis" created="Tue, 30 Mar 2010 19:45:17 +0000"  >&lt;p&gt;the same applies to the JVM in my experience wrt OOME.&lt;/p&gt;</comment>
                            <comment id="12851539" author="bryanduxbury" created="Tue, 30 Mar 2010 19:51:06 +0000"  >&lt;p&gt;Put that way, it&apos;s basically impossible to catch an OOM ever, and the only real solution is to change the way we &lt;b&gt;allocate&lt;/b&gt; memory. You can already do this in some ways, but it seems cumbersome. &lt;/p&gt;

&lt;p&gt;We could impose a thrift-wide limit on the size of method names, which would help a bit. However, it wouldn&apos;t help in situations when the server genuinely runs out of memory, for instance as a result of a legitimately overlarge RPC call. Per-field limits don&apos;t really seem like a solution either, I think, because a lot of people are likely to set the limits to &quot;unlimited&quot;.&lt;/p&gt;

&lt;p&gt;I believe that the Nonblocking server (as well as HsHa) won&apos;t really suffer from this problem, as long as you set a sane read buffer size. Maybe we should make the readbuffer setting mandatory? Or perhaps expand the readbuffer thing to the thread pool server?&lt;/p&gt;</comment>
                            <comment id="12851544" author="dreiss" created="Tue, 30 Mar 2010 19:52:55 +0000"  >&lt;p&gt;Sorry, I don&apos;t understand why setting a max read length on the TBinaryProtocol doesn&apos;t make this go away.  Evernote (which contributed that feature) has exposed their Thrift server to the Internet, so I assume they are not getting OOMs all over the place.&lt;/p&gt;</comment>
                            <comment id="12851547" author="dreiss" created="Tue, 30 Mar 2010 19:54:29 +0000"  >&lt;p&gt;Sorry, I wrote my response before I read yours.  I guess I meant setting the read length on the binary protocol plus the patch to limit the frame size.&lt;/p&gt;</comment>
                            <comment id="12859491" author="dreiss" created="Wed, 21 Apr 2010 19:23:55 +0000"  >&lt;p&gt;Bryan, I think that if we apply Esteve&apos;s patch and suggest that users set a sane max frame size (for the transport frame) and max message size (in TBinaryProtocol), that will solve the problem.  I think we should do this.  Do you agree?&lt;/p&gt;</comment>
                            <comment id="12859606" author="bryanduxbury" created="Thu, 22 Apr 2010 00:37:51 +0000"  >&lt;p&gt;Sounds OK to me.&lt;/p&gt;</comment>
                            <comment id="12860070" author="dreiss" created="Thu, 22 Apr 2010 23:47:26 +0000"  >&lt;p&gt;Okay.  I&apos;ve tested out this patch and it fixes the large frame problem for the thread pool server.  There is still the problem of protocol-level problems (like the one in the bug report).  It turns out that TBinaryProtocol.Factory doesn&apos;t have a way to call setReadLength on the protocol objects it creates, so I&apos;ll have to add that.&lt;/p&gt;</comment>
                            <comment id="12860133" author="dreiss" created="Fri, 23 Apr 2010 05:27:22 +0000"  >&lt;p&gt;This implements the change I mentioned.  With this, the HsHa server and threadpool server appear to be noise-proof, including the case of a valid frame followed by noise.&lt;/p&gt;</comment>
                            <comment id="12860577" author="bryanduxbury" created="Sat, 24 Apr 2010 20:22:45 +0000"  >&lt;p&gt;Looks good to me.&lt;/p&gt;</comment>
                            <comment id="12861064" author="dreiss" created="Mon, 26 Apr 2010 19:44:08 +0000"  >&lt;p&gt;Sorry, I messed up the commit message for r938206, which is also relevant to this issue.&lt;/p&gt;</comment>
                            <comment id="13031443" author="kingryan" created="Tue, 10 May 2011 22:45:53 +0000"  >&lt;p&gt;It appears that this doesn&apos;t cover every case. If you give it less garbage than the frame size (or what it things the frame size is) it will hang forever in the selector thread, which will stall the whole server.&lt;/p&gt;</comment>
                            <comment id="13034112" author="bryanduxbury" created="Mon, 16 May 2011 17:20:58 +0000"  >&lt;p&gt;@Ryan - I&apos;m not sure I follow your comment. If you send a large frame size and then never provide the data, it&apos;s true that that socket will &quot;hang&quot;, insofar as there won&apos;t ever be a timeout or whatnot, but it won&apos;t prevent the selector from servicing other sockets. The socket channel read methods never block - they&apos;ll only read as much as is available.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                                                <inwardlinks description="is cloned by">
                                        <issuelink>
            <issuekey id="12710864">THRIFT-2500</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12710864">THRIFT-2500</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12442645" name="t601-p2.patch" size="1444" author="dreiss" created="Fri, 23 Apr 2010 05:27:22 +0000"/>
                            <attachment id="12440268" name="thrift-601-v2.patch" size="638" author="bryanduxbury" created="Tue, 30 Mar 2010 19:24:44 +0000"/>
                            <attachment id="12424489" name="thrift-601.patch" size="1786" author="esteve" created="Tue, 10 Nov 2009 19:04:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>186772</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 28 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i16apz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>244869</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>