<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 07:59:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-347] PHP TSocket Timeout Issues</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-347</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;I&apos;m working with the Hive thrift service and I get the following exception when I execute a SELECT statement:&lt;/p&gt;

&lt;p&gt;PHP Fatal error:  Uncaught exception &apos;TException&apos; with message &apos;TSocket: timed out reading 4 bytes from localhost:10000&apos; in /root/leap/dev/servers/hive/thriftroot/&lt;br/&gt;
transport/TSocket.php:228&lt;br/&gt;
Stack trace:&lt;br/&gt;
#0 /root/leap/dev/servers/hive/thriftroot/protocol/TBinaryProtocol.php(292): TSocket-&amp;gt;readAll(4)&lt;br/&gt;
#1 /root/leap/dev/servers/hive/thriftroot/protocol/TBinaryProtocol.php(184): TBinaryProtocol-&amp;gt;readI32(NULL)&lt;br/&gt;
#2 /root/leap/dev/servers/hive/thriftroot/packages/hive_service/ThriftHive.php(59): TBinaryProtocol-&amp;gt;readMessageBegin(NULL, 0, 0)&lt;br/&gt;
#3 /root/leap/dev/servers/hive/thriftroot/packages/hive_service/ThriftHive.php(28): ThriftHiveClient-&amp;gt;recv_execute()&lt;br/&gt;
#4 /root/leap/dev/servers/hive/testscript.php(30): ThriftHiveClient-&amp;gt;execute(&apos;SELECT num FROM...&apos;)&lt;br/&gt;
#5 &lt;/p&gt;
{main}
&lt;p&gt;  thrown in /root/leap/dev/servers/hive/thriftroot/transport/TSocket.php on line 228&lt;/p&gt;

&lt;p&gt;The script I&apos;m using to cause this is:&lt;/p&gt;

&lt;p&gt;======================================&lt;br/&gt;
#!/usr/bin/php&lt;br/&gt;
&amp;lt;?php&lt;/p&gt;

&lt;p&gt;$GLOBALS&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;#39;THRIFT_ROOT&amp;#39;&amp;#93;&lt;/span&gt; = &apos;thriftroot/&apos;;&lt;/p&gt;

&lt;p&gt;require_once $GLOBALS&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;#39;THRIFT_ROOT&amp;#39;&amp;#93;&lt;/span&gt; . &apos;packages/hive_service/ThriftHive.php&apos;;&lt;br/&gt;
require_once $GLOBALS&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;#39;THRIFT_ROOT&amp;#39;&amp;#93;&lt;/span&gt; . &apos;transport/TSocket.php&apos;;&lt;br/&gt;
require_once $GLOBALS&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;#39;THRIFT_ROOT&amp;#39;&amp;#93;&lt;/span&gt; . &apos;protocol/TBinaryProtocol.php&apos;;&lt;/p&gt;

&lt;p&gt;$transport = new TSocket(&apos;localhost&apos;, 10000);&lt;br/&gt;
$protocol = new TBinaryProtocol($transport);&lt;br/&gt;
$client = new ThriftHiveClient($protocol);&lt;br/&gt;
$transport-&amp;gt;open();&lt;/p&gt;

&lt;p&gt;try&lt;br/&gt;
{&lt;br/&gt;
    $client-&amp;gt;execute(&apos;DROP TABLE testOverThrift&apos;);&lt;br/&gt;
}&lt;br/&gt;
catch (Exception $e)&lt;br/&gt;
{&lt;br/&gt;
    error_log(&quot;Got exception while trying to drop table: &quot; . $e-&amp;gt;getMessage());&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;$client-&amp;gt;execute(&apos;CREATE TABLE testOverThrift (num int)&apos;);&lt;/p&gt;

&lt;p&gt;$client-&amp;gt;execute(&apos;LOAD DATA LOCAL&lt;br/&gt;
		 INPATH &quot;/root/testdata.txt&quot;&lt;br/&gt;
		 INTO TABLE testOverThrift&apos;);&lt;/p&gt;

&lt;p&gt;$client-&amp;gt;execute(&apos;SELECT num FROM testOverThrift WHERE num &amp;lt; 5&apos;);&lt;/p&gt;

&lt;p&gt;$result = $client-&amp;gt;fetchAll();&lt;/p&gt;

&lt;p&gt;var_dump($result);&lt;br/&gt;
==================================&lt;/p&gt;

&lt;p&gt;I have a patch that fixes the problem that I&apos;ll attach. It looks like fetchAll() doesn&apos;t know the difference between a timeout and a blocking port.&lt;/p&gt;

</description>
                <environment>&lt;p&gt;Fedora 8, 64bit, php 5.2.4&lt;/p&gt;</environment>
        <key id="12415421">THRIFT-347</key>
            <summary>PHP TSocket Timeout Issues</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thobbs">Tom Hobbs</assignee>
                                    <reporter username="gary.richardson">Gary Richardson</reporter>
                        <labels>
                    </labels>
                <created>Mon, 23 Feb 2009 23:18:50 +0000</created>
                <updated>Wed, 7 Jan 2015 23:01:57 +0000</updated>
                            <resolved>Fri, 19 Nov 2010 00:10:38 +0000</resolved>
                                                    <fixVersion>0.6</fixVersion>
                                    <component>PHP - Library</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="12688479" author="bryanduxbury" created="Mon, 23 Mar 2009 23:59:47 +0000"  >&lt;p&gt;Can any php folks chime in on whether this patch should be committed? &lt;/p&gt;</comment>
                            <comment id="12688977" author="mcslee" created="Wed, 25 Mar 2009 02:39:54 +0000"  >&lt;p&gt;Hmm, seems okay. But how are these sockets getting into blocking mode? Presumably this requires a call to stream_set_blocking(), which we never do in TSocket.php.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure if the rest of the code recovers properly in this case. When you debug log on your system, do you actually get the socket call coming back with the &apos;blocked&apos; key set?&lt;/p&gt;

&lt;p&gt;My concern is that with this change, fetchAll could potentially infinite loop, continuously receiving empty string back. That probably won&apos;t happen, but it does seem like it could use up more than the timeout, due to teh while(true). I&apos;m not sure how the PHP streams lib handles timeouts in blocking mode. As long as you can verify it still handles timeouts appropriately, then consider this diff approved.&lt;/p&gt;

&lt;p&gt;But yeah, my main question is how you&apos;re getting client sockets in blocking mode here?&lt;/p&gt;</comment>
                            <comment id="12688984" author="gary.richardson" created="Wed, 25 Mar 2009 03:17:11 +0000"  >&lt;p&gt;I&apos;ve moved on from the code, so it&apos;s a bit hazy now. From what I remember, yes, the socket call came with with &apos;blocked&apos;. &lt;/p&gt;</comment>
                            <comment id="12735911" author="wadearnold" created="Tue, 28 Jul 2009 04:09:21 +0000"  >&lt;p&gt;I ran into this issue intermittently with calls against Cassandra. I am going to try and hunt down the issue but it seems to happen after no requests have been made for a period and then the first subsequent request creates the error. If you follow this code and just run it randomly over and over it will fail eventually fail. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://wiki.apache.org/cassandra/ClientExamples&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://wiki.apache.org/cassandra/ClientExamples&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12765768" author="lenn0x" created="Wed, 14 Oct 2009 21:44:37 +0000"  >&lt;p&gt;Mark,&lt;/p&gt;

&lt;p&gt;By default when calling this in TSocket:&lt;/p&gt;

&lt;p&gt;      $this-&amp;gt;handle_ = @fsockopen($this-&amp;gt;host_,&lt;br/&gt;
                                  $this-&amp;gt;port_,&lt;br/&gt;
                                  $errno,&lt;br/&gt;
                                  $errstr,&lt;br/&gt;
                                  $this-&amp;gt;sendTimeout_/1000.0);&lt;/p&gt;


&lt;p&gt;Here is an excerpt from php.net:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://us3.php.net/fsockopen&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://us3.php.net/fsockopen&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The socket will by default be opened in blocking mode. You can switch it to non-blocking mode by using stream_set_blocking(). &lt;/p&gt;</comment>
                            <comment id="12765772" author="lenn0x" created="Wed, 14 Oct 2009 21:56:41 +0000"  >&lt;p&gt;Wade Arnold,&lt;/p&gt;

&lt;p&gt;Can you provide a test case for this so I can reproduce? I haven&apos;t run into this issue.&lt;/p&gt;</comment>
                            <comment id="12768782" author="lenn0x" created="Thu, 22 Oct 2009 17:54:20 +0000"  >&lt;p&gt;I tested out this patch, as one of our developers came across this issue. We were using FramedTransport in PHP, and ran into the 4 bytes error. Applying this patch worked for us.&lt;/p&gt;</comment>
                            <comment id="12771078" author="dreiss" created="Wed, 28 Oct 2009 19:30:00 +0000"  >&lt;p&gt;So, I&apos;m looking at &lt;a href=&quot;http://us3.php.net/manual/en/function.stream-get-meta-data.php&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://us3.php.net/manual/en/function.stream-get-meta-data.php&lt;/a&gt;.  The &quot;blocked&quot; field is really poorly named.  It indicates whether the stream in in block*ing* mode, which should always be true.  Are you seeing this coming up as false at any time?  Also, could someone clarify in the description what the expected behavior is?&lt;/p&gt;</comment>
                            <comment id="12779518" author="ecopoesis" created="Wed, 18 Nov 2009 16:40:14 +0000"  >&lt;p&gt;I&apos;ve tested this patch. I was using regular (not framed) transport against Cassandra. This patch fixed the 4 bytes error I would get after large data loads.&lt;/p&gt;</comment>
                            <comment id="12798442" author="marz" created="Sun, 10 Jan 2010 03:07:47 +0000"  >&lt;p&gt;I ran into a very similar issue, but applying this patch did not help. After applying the patch, the client hangs forever and never times out.&lt;/p&gt;

&lt;p&gt;The client only times out when there is a large object returned - when the returned object is relatively small the socket works fine.&lt;/p&gt;</comment>
                            <comment id="12830393" author="bombino" created="Sat, 6 Feb 2010 00:46:09 +0000"  >&lt;p&gt;+1 for the patch.  Solved TSocket timeout issues on CentOS 5.3,  PHP 5.2,  talking to a Ruby Thrift server running on localhost.  I have no idea how it solves the problem, or what was causing the problem, but we&apos;ve been using this patch in production for a few months with no further errors.&lt;/p&gt;

&lt;p&gt;EDIT:  upon further review, while this patch did prevent errors from being shown, it did not address the root issue.  Sorry for adding confusion to the matter.&lt;/p&gt;</comment>
                            <comment id="12854942" author="cpegeric" created="Thu, 8 Apr 2010 13:58:51 +0000"  >&lt;p&gt;One of the reason is &quot;function overloading&quot; feature of mbstring that changes the behavior of strlen. &lt;/p&gt;

&lt;p&gt;Disable the mbstring.func_overload in php.ini solved this issue for me.&lt;/p&gt;

&lt;p&gt;It may not be the only cause though.&lt;/p&gt;</comment>
                            <comment id="12859150" author="mlerch223" created="Wed, 21 Apr 2010 00:49:48 +0000"  >&lt;p&gt;Same issue here as Nathan Marz. Everything was working great until I tried to retrieve a larger bit of data (about 5kb). Before applying the patch, the request would fail with the &apos;TSocket: timed out reading 4 bytes from&apos; message. After the patch, the script hangs indefinitely using 100% CPU.&lt;/p&gt;

&lt;p&gt;Tried TBuffered, TFramed, and standard TSocket connections, all with the same result.&lt;/p&gt;

&lt;p&gt;Does not happen with other client libraries, only PHP, which tells me it isn&apos;t the server itself.&lt;/p&gt;

&lt;p&gt;Any advice?&lt;/p&gt;</comment>
                            <comment id="12859571" author="mlerch223" created="Wed, 21 Apr 2010 22:58:03 +0000"  >&lt;p&gt;Wanted to follow-up on what we found. Somehow a null value was stored in one of the Cassandra values. Removing that fixed our issue.&lt;/p&gt;</comment>
                            <comment id="12859634" author="cysin" created="Thu, 22 Apr 2010 03:10:05 +0000"  >&lt;p&gt;I am still having the same issue with phpcassa &lt;a href=&quot;http://github.com/hoan/phpcassa&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://github.com/hoan/phpcassa&lt;/a&gt; , any one could share your solution here?&lt;/p&gt;</comment>
                            <comment id="12882291" author="tupshin" created="Thu, 24 Jun 2010 19:21:27 +0000"  >&lt;p&gt;Kevin: Have you tried combining this patch with the two patches attached to &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-638&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/THRIFT-638&lt;/a&gt;&lt;br/&gt;
?&lt;/p&gt;</comment>
                            <comment id="12892998" author="loretoparisi" created="Wed, 28 Jul 2010 00:16:42 +0000"  >&lt;p&gt;There is a similar problem in socket write, described here:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-826&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/THRIFT-826&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12919600" author="doublefree" created="Sun, 10 Oct 2010 12:57:47 +0000"  >&lt;p&gt;I found similar problem on Hive (thirft v0.50), and patch on this page was not enough for my case.&lt;br/&gt;
This is the patch for my case.&lt;/p&gt;

&lt;p&gt;By using this patch, my php code below is working.&lt;/p&gt;

&lt;p&gt;// Set up the transport/protocol/client&lt;br/&gt;
$transport = new TSocket(&apos;localhost&apos;, 10000);&lt;br/&gt;
$protocol = new TBinaryProtocol($transport);&lt;br/&gt;
$client = new ThriftHiveClient($protocol);&lt;br/&gt;
$transport-&amp;gt;open();&lt;br/&gt;
$client-&amp;gt;execute(&apos;SELECT * from sample order by id desc&apos;);&lt;br/&gt;
var_dump($client-&amp;gt;fetchAll());&lt;br/&gt;
$transport-&amp;gt;close();&lt;/p&gt;</comment>
                            <comment id="12933169" author="thobbs" created="Wed, 17 Nov 2010 21:24:05 +0000"  >&lt;p&gt;The patch I&apos;ve attached seems to resolve this issue with TFramedTransport and TBinaryProtocolAccelerated using thrift_protocol.so.  It&apos;s similar to Gary&apos;s original patch, and is against the version in Thrift 0.5.0.  I do not know how well this works with other transports and protocols.&lt;/p&gt;

&lt;p&gt;phpcassa (&lt;a href=&quot;https://github.com/thobbs/phpcassa&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/thobbs/phpcassa&lt;/a&gt;) ships with this patch applied.&lt;/p&gt;</comment>
                            <comment id="12933189" author="tjake" created="Wed, 17 Nov 2010 22:11:11 +0000"  >&lt;p&gt;Thanks for the patch Tyler!&lt;/p&gt;

&lt;p&gt; We&apos;ll wait for any feedback than add this for inclusion in 0.6 if left uncontested.&lt;/p&gt;</comment>
                            <comment id="12933620" author="bryanduxbury" created="Fri, 19 Nov 2010 00:10:38 +0000"  >&lt;p&gt;I just committed Tyler&apos;s patch. Thanks for knocking this one out!&lt;/p&gt;</comment>
                            <comment id="13397441" author="ruben.devries" created="Wed, 20 Jun 2012 11:56:15 +0000"  >&lt;p&gt;afaik this issue is back in hive-0.8.1, probally since regenerating the PHP libs with thrift reintroduces the bug&lt;/p&gt;</comment>
                            <comment id="13397443" author="ruben.devries" created="Wed, 20 Jun 2012 11:57:01 +0000"  >&lt;p&gt;nvm, ignore that, wrong issue tracker &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/tongue.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                                                <inwardlinks description="is superceded by">
                                        <issuelink>
            <issuekey id="12441880">THRIFT-638</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12400800" name="TSocket.php.diff" size="857" author="gary.richardson" created="Mon, 23 Feb 2009 23:21:16 +0000"/>
                            <attachment id="12456805" name="TSocket.php.patch" size="1005" author="doublefree" created="Sun, 10 Oct 2010 13:00:29 +0000"/>
                            <attachment id="12459833" name="thrift-347-0.5.0.txt" size="1567" author="thobbs" created="Wed, 17 Nov 2010 21:24:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>186559</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 22 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i168yn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>244584</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>