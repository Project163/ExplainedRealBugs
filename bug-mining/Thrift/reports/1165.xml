<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:16:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-2933] v0.9.2: doubles encoded in node with compact protocol cannot be decoded by python</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-2933</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;I&apos;ve noticed that with Thrift v0.9.2, using the Compact protocol, I can&apos;t encode doubles in node and decode them in python.  It looks like in python, we&apos;re decoding little-endian for compact and big-endian for binary, and in node, writing big-endian in all cases (therefore, Binary works fine).  I&apos;ve attached a test program to show this behavior.  I have not found the thrift binary spec, so I&apos;m not sure which side is wrong. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[~/thrift-&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;]$ thrift --version
Thrift version 0.9.2
[~/thrift-&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;]$ grep -i thrift &lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt;.json 
    &lt;span class=&quot;code-quote&quot;&gt;&quot;thrift&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;0.9.2&quot;&lt;/span&gt;
    &lt;span class=&quot;code-quote&quot;&gt;&quot;compile&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;thrift --gen js:node --gen py test.thrift&quot;&lt;/span&gt;
[~/thrift-&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;]$ pip show thrift
---
Name: thrift
Version: 0.9.2
Location: /Library/Python/2.7/site-packages
Requires: 
[~/thrift-&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;]$ npm run compile

&amp;gt; &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;-decode-bug@0.0.1 compile /Users/dh/thrift-&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;
&amp;gt; thrift --gen js:node --gen py test.thrift

[~/thrift-&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;]$ node test.js binary | python test.py binary
Trying to send { intField: 100, doubleField: 99.88 }
Reading with binary protocol.
Got test object: TestType(intField=100, doubleField=99.88)
[~/thrift-&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;]$ node test.js compact  | python test.py compact
Trying to send { intField: 100, doubleField: 99.88 }
Reading with compact protocol.
Got test object: TestType(intField=100, doubleField=-2.24248483894553e-38)
[~/thrift-&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;]$ 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I notice the following snippets.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;TBinaryProtocol.py: network format (big-endian)
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  def readDouble(self):
    buff = self.trans.readAll(8)
    val, = unpack(&lt;span class=&quot;code-quote&quot;&gt;&apos;!d&apos;&lt;/span&gt;, buff)
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; val
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;TCompactProtocol.py: little-endian
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  def readDouble(self):
    buff = self.trans.readAll(8)
    val, = unpack(&lt;span class=&quot;code-quote&quot;&gt;&apos;&amp;lt;d&apos;&lt;/span&gt;, buff)
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; val
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;binary.js: my best IEEE floating point days are behind me but this looks big-endian.  In any case it&apos;s used for both compact and binary.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;exports.writeDouble = function(buff, v) {
  &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; m, e, c;

  buff[0] = (v &amp;lt; 0 ? 0x80 : 0x00);

  v = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.abs(v);
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (v !== v) {
    &lt;span class=&quot;code-comment&quot;&gt;// NaN, use QNaN IEEE format
&lt;/span&gt;    m = 2251799813685248;
    e = 2047;
  } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (v === Infinity) {
    m = 0;
    e = 2047;
  } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
    e = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.floor(&lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.log(v) / &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.LN2);
    c = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.pow(2, -e);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (v * c &amp;lt; 1) {
      e--;
      c *= 2;
    }

    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (e + 1023 &amp;gt;= 2047)
    {
      &lt;span class=&quot;code-comment&quot;&gt;// Overflow
&lt;/span&gt;      m = 0;
      e = 2047;
    }
    &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (e + 1023 &amp;gt;= 1)
    {
      &lt;span class=&quot;code-comment&quot;&gt;// Normalized - term order matters, as &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.pow(2, 52-e) and v*&lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.pow(2, 52) can overflow
&lt;/span&gt;      m = (v*c-1) * POW_52;
      e += 1023;
    }
    &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
    {
      &lt;span class=&quot;code-comment&quot;&gt;// Denormalized - also catches the &lt;span class=&quot;code-quote&quot;&gt;&apos;0&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;, somewhat by chance
&lt;/span&gt;      m = (v * POW_1022) * POW_52;
      e = 0;
    }
  }

  buff[1] = (e &amp;lt;&amp;lt; 4) &amp;amp; 0xf0;
  buff[0] |= (e &amp;gt;&amp;gt; 4) &amp;amp; 0x7f;

  buff[7] = m &amp;amp; 0xff;
  m = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.floor(m / POW_8);
  buff[6] = m &amp;amp; 0xff;
  m = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.floor(m / POW_8);
  buff[5] = m &amp;amp; 0xff;
  m = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.floor(m / POW_8);
  buff[4] = m &amp;amp; 0xff;
  m &amp;gt;&amp;gt;= 8;
  buff[3] = m &amp;amp; 0xff;
  m &amp;gt;&amp;gt;= 8;
  buff[2] = m &amp;amp; 0xff;
  m &amp;gt;&amp;gt;= 8;
  buff[1] |= m &amp;amp; 0x0f;

  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; buff;
};

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12765492">THRIFT-2933</key>
            <summary>v0.9.2: doubles encoded in node with compact protocol cannot be decoded by python</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="codesf">Randy Abernethy</assignee>
                                    <reporter username="dh">Dan Heller</reporter>
                        <labels>
                    </labels>
                <created>Wed, 7 Jan 2015 23:18:04 +0000</created>
                <updated>Tue, 21 Jul 2015 02:21:13 +0000</updated>
                            <resolved>Mon, 2 Feb 2015 12:48:18 +0000</resolved>
                                    <version>0.9.2</version>
                                    <fixVersion>0.9.3</fixVersion>
                                    <component>Node.js - Library</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14269793" author="dh" created="Thu, 8 Jan 2015 18:12:44 +0000"  >&lt;p&gt;Confirmed that if I encode doubles little-endian, I can talk node -&amp;gt; python with Compact.  Attaching a patch which seems to work, which I do not assert to be optimal of course.&lt;/p&gt;</comment>
                            <comment id="14274076" author="codesf" created="Mon, 12 Jan 2015 20:03:36 +0000"  >&lt;p&gt;Hey Dan,&lt;/p&gt;

&lt;p&gt;Thanks for the patch! Any chance we could get you to update it to just replace the broken readDouble() method with the correct code rather than adding readDoubleLittleEndian()?&lt;/p&gt;

&lt;p&gt;-Randy&lt;/p&gt;</comment>
                            <comment id="14274362" author="dh" created="Mon, 12 Jan 2015 23:03:14 +0000"  >&lt;p&gt;Thanks for taking a look &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=codesf&quot; class=&quot;user-hover&quot; rel=&quot;codesf&quot;&gt;codesf&lt;/a&gt;!  I&apos;m not quite sure I understand the change you are requesting (please bear with me).  I &lt;em&gt;think&lt;/em&gt; that both little endian and big endian methods for reading doubles are needed, for the compact and binary protocols respectively.  Does that sound correct?  Or are you proposing a different layering?  &lt;/p&gt;</comment>
                            <comment id="14274600" author="codesf" created="Tue, 13 Jan 2015 02:12:57 +0000"  >&lt;p&gt;Hey Dan,&lt;/p&gt;

&lt;p&gt;Sorry for the confusion, my fault actually. Because the Apache Thrift Node JS implementation has evolved from a handy tidbit to a fairly full implementation in 0.9.2, much of the internals and file layout are still distinct from the rest of Apache Thrift. When I add bits I try to massage things in the direction of the larger Apache Thrift library to improve over all consistency.&lt;/p&gt;

&lt;p&gt;The TProtocol interface in the reference implementations (CPP/Java) defines a set of methods which are then implemented by every protocol. Though JS doesn&apos;t really have formal interfaces, it would be preferable to stick with the interface driven function names (writeDouble(), readDouble(), writeI64(), etc.) in each protocol implementation. The protocol.js and binary.js files are artifacts from a time when there was only one protocol in this lib.  I was hoping you could provide your little endian Double implementation in the protocol.js, &quot;TCompactProtocol.prototype.writeDouble = function(dub)&quot; body on line 682. This will make it easier to keep the TBinaryProtocol code in binary.js segregated until someone has time to sort things into proper modules (TBinaryProtocol.js, TCompactProtocol.js, etc.).&lt;/p&gt;

&lt;p&gt;As you have noted each protocol is responsible for defining its own wire layout which all languages must adhere to. As you have surmized, TBinaryProtocol uses TCP/IP network byte order (big endian) on the wire  and TCompactProtocol uses little endian on the wire for doubles. So Node Doubles are broken presently, making this a patch we definitely need to get into the trunk.&lt;/p&gt;

&lt;p&gt;Best,&lt;br/&gt;
Randy&lt;/p&gt;</comment>
                            <comment id="14274602" author="codesf" created="Tue, 13 Jan 2015 02:15:40 +0000"  >&lt;p&gt;P.S. If you don&apos;t have time, let me know, and I will commit it as is.&lt;/p&gt;</comment>
                            <comment id="14275615" author="dh" created="Tue, 13 Jan 2015 17:58:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=codesf&quot; class=&quot;user-hover&quot; rel=&quot;codesf&quot;&gt;codesf&lt;/a&gt; thanks for explaining.  Sure, I can do it that way.  I&apos;ll take a crack at it now.&lt;/p&gt;</comment>
                            <comment id="14275680" author="dh" created="Tue, 13 Jan 2015 18:40:26 +0000"  >&lt;p&gt;Uploading new patch.&lt;/p&gt;</comment>
                            <comment id="14276041" author="sh1mmer" created="Tue, 13 Jan 2015 22:05:23 +0000"  >&lt;p&gt;I disagree with this approach a bit. I think that having it in binary.js is a good thing since JavaScript doesn&apos;t have good native support for these encodings we should put in one place. This would make it easy to replace with specific optimized implementations for Node or the browser using either Buffers, TypedArrays or whatever other method in the future.&lt;/p&gt;

&lt;p&gt;I would say that if we put them into protocol.js we should at the least we should put the double encoding/decoding functions into helpers not directly into the interface methods.&lt;/p&gt;</comment>
                            <comment id="14277300" author="codesf" created="Wed, 14 Jan 2015 17:45:39 +0000"  >&lt;p&gt;Hey Tom,&lt;/p&gt;

&lt;p&gt;Thanks for the comment. Perhaps we agree conceptually. Here&apos;s where I am going with this:&lt;/p&gt;

&lt;p&gt;I would like to see all node protocol code migrated into files something like this:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;thrift/lib/nodejs/TBinaryProtocol.js&lt;/li&gt;
	&lt;li&gt;thrift/lib/nodejs/TCompactProtocol.js&lt;/li&gt;
	&lt;li&gt;thrift/lib/nodejs/TJSONProtocol.js&lt;br/&gt;
with protocol.js as a pass through requirer for compatibility.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;and all nodejs transports in files something like this:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;thrift/lib/nodejs/TFramedTransport.js&lt;/li&gt;
	&lt;li&gt;thrift/lib/nodejs/TBufferedTransport.js&lt;br/&gt;
same story with transport.js (we also need to allow transports to be stacked like most other language implementations)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So at the end of the day TBinaryProtocol (the object inside protocol.js) and binary.js (the entire file) will move into TBinaryProtocol.js. This will provide an implementation pattern and file isolation for those wishing to add new protocols and transports (TCipherTransport, TSnappyProtocol, etc.). &lt;/p&gt;

&lt;p&gt;The code file location and file naming convention above is adhered to by almost all of the Apache Thrift languages, making Node.js harder to navigate right now for folks familiar with Thrift. It also artificially intertwines protocols/transports that really have nothing to do with each other. Interesting to note that the only call (coupling) TCompactProtocol has to binary.js is writeDouble(), which is the exact cause of this bug ( ! ). Had I not tried to reuse and instead focused more on encapsulation this bug would not have ended up in the code. &lt;/p&gt;

&lt;p&gt;Hopefully with this road map the request makes more sense.&lt;/p&gt;

&lt;p&gt;-Randy  &lt;/p&gt;
</comment>
                            <comment id="14279080" author="dh" created="Thu, 15 Jan 2015 18:40:42 +0000"  >&lt;p&gt;Uploading updated patch.&lt;/p&gt;</comment>
                            <comment id="14289573" author="aiden" created="Fri, 23 Jan 2015 17:39:13 +0000"  >&lt;p&gt;Hey Randy,&lt;/p&gt;

&lt;p&gt;The reorganization makes a lot of sense, but perhaps would be better as a separate patch? We are working on a few changes to the Node library and would like to contribute them back, but all are based off of the master branch and would be a potentially gnarly rebase.&lt;/p&gt;

&lt;p&gt;&#8212;Aiden&lt;/p&gt;</comment>
                            <comment id="14299205" author="andrewdeandrade" created="Fri, 30 Jan 2015 20:48:42 +0000"  >&lt;p&gt;I actually want this reorganization into separate files for browserify reasons (i.e. there no reason to include all protocols in the browser if you only need one). &lt;/p&gt;

&lt;p&gt;Randy, if you go ahead and accept this patch as is, I&apos;ll split apart the transport and protocol files and upload a patch to this issue I just created. &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2964&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/THRIFT-2964&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ve taken care to note in that issue that readDouble is different for both implementations, and I&apos;ve referenced this issue.&lt;/p&gt;</comment>
                            <comment id="14301227" author="codesf" created="Mon, 2 Feb 2015 12:48:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dh&quot; class=&quot;user-hover&quot; rel=&quot;dh&quot;&gt;dh&lt;/a&gt;  many thanks, committed.&lt;/p&gt;</comment>
                            <comment id="14301255" author="hudson" created="Mon, 2 Feb 2015 13:16:16 +0000"  >&lt;p&gt;SUCCESS: Integrated in Thrift #1437 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/1437/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/1437/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2933&quot; title=&quot;v0.9.2: doubles encoded in node with compact protocol cannot be decoded by python&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2933&quot;&gt;&lt;del&gt;THRIFT-2933&lt;/del&gt;&lt;/a&gt;: Repairs incorrect double byte order in Node compact proto (ra: rev 4e1e132142f78cafa4e83526dd7a613833715cd3)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;lib/nodejs/lib/thrift/protocol.js&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12692560" name="double-endianness-2.patch" size="3310" author="dh" created="Thu, 15 Jan 2015 18:41:34 +0000"/>
                            <attachment id="12690900" name="little-endian.patch" size="5449" author="dh" created="Thu, 8 Jan 2015 18:12:58 +0000"/>
                            <attachment id="12690655" name="thrift-double.tgz" size="1077" author="dh" created="Wed, 7 Jan 2015 23:18:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 42 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i241xj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>