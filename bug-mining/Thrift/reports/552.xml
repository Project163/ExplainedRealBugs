<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:04:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-1468] Memory leak in TSaslServerTransport</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-1468</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;I&apos;m working on the HCatalog project. HCatalog uses a (slightly dated) version of Hive that in turn depends on libthrift-0.5.0. The HCatalog-server is a continuously running process that serves (meta)data over thrift. (The bug I describe is related to &lt;a href=&quot;https://issues.apache.org/jira/browse/HCATALOG-183&quot; title=&quot;Memory leak in HCat 0.1/0.2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HCATALOG-183&quot;&gt;HCATALOG-183&lt;/a&gt;.)&lt;/p&gt;

&lt;p&gt;We observed that on running the HCatalog-server with continuous client-requests, the memory footprint of the server grows steadily, until we see an OutOfMemoryError exception. I took a memory snapshot of the running process, to check for leaks. I noticed that the majority of the memory (over 1.3GB) was being consumed by the org.apache.thrift.transport.TSaslServerTransport$Factory::transportMap. There were over 52000 instances of WeakHashMap$Entry, consuming 3MB of shallow-heap, and 1.3GB of retained heap.&lt;/p&gt;

&lt;p&gt;I suspect that entries in the WeakHashMap (transportMap) are not being collected during GC, as is expected in code. That would only be so if there are outstanding hard-references to the key in the map (TTransport).&lt;/p&gt;

&lt;p&gt;From the code in TSaslTransport and TSaslServerTransport, it appears that there is an inadvertent cyclic reference that the runtime is unable to detect:&lt;br/&gt;
1. TSaslTransport has a (hard) back-reference to the &quot;underlyingTransport&quot;, i.e. TTransport.&lt;br/&gt;
2. TSaslServerTransport::Factory::transportMap is a WeakHashMap&amp;lt; TTransport, TSaslServerTransport &amp;gt;. Here, the &quot;underlyingTransport&quot; is mapped back to the decorating TSaslServerTransport.&lt;/p&gt;

&lt;p&gt;From #2, an entry can only be GCed if there&apos;s no outstanding hard-reference to the TTransport. But from #1, the hard-reference comes from the value-part of the hashmap entry. The runtime can&apos;t deduce that there&apos;s a cycle, presumably because it&apos;s not explicit.&lt;/p&gt;

&lt;p&gt;(I&apos;ll be attaching a sample program to better illustrate the WeakHashMap behaviour, in case I&apos;ve botched the explanation above.)&lt;/p&gt;

&lt;p&gt;The simple solution would be to change the back-reference in #1 into a WeakReference. I&apos;ll attach a patch here that might be suitable.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12535418">THRIFT-1468</key>
            <summary>Memory leak in TSaslServerTransport</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mithun">Mithun Radhakrishnan</assignee>
                                    <reporter username="mithun">Mithun Radhakrishnan</reporter>
                        <labels>
                            <label>OOM</label>
                            <label>WeakHashMap</label>
                            <label>WeakReference</label>
                    </labels>
                <created>Fri, 16 Dec 2011 08:10:27 +0000</created>
                <updated>Thu, 12 Jan 2012 19:42:50 +0000</updated>
                            <resolved>Thu, 22 Dec 2011 19:05:18 +0000</resolved>
                                    <version>0.5</version>
                    <version>0.9</version>
                                    <fixVersion>0.9</fixVersion>
                                    <component>Java - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13170821" author="mithun" created="Fri, 16 Dec 2011 08:18:12 +0000"  >&lt;p&gt;Uploading test-code that illustrates how the WeakHashMap might not be working. (The proposed fix is also in the file.)&lt;/p&gt;</comment>
                            <comment id="13170823" author="mithun" created="Fri, 16 Dec 2011 08:22:56 +0000"  >&lt;p&gt;Uploading the patch with the proposed fix. (Changing the back-reference to a WeakReference.)&lt;/p&gt;</comment>
                            <comment id="13170825" author="mithun" created="Fri, 16 Dec 2011 08:24:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/HCATALOG-183&quot; title=&quot;Memory leak in HCat 0.1/0.2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;HCATALOG-183&quot;&gt;HCATALOG-183&lt;/a&gt; depends on this. If this is fixed, it would be great to have the fix available for 0.5 and 0.7. &lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="13171057" author="tlipcon" created="Fri, 16 Dec 2011 16:36:15 +0000"  >&lt;p&gt;By chance are you using the CMS GC? There was a bug recently in CMS where some types of references would fail to be collected. You can try -XX:-CMSConcurrentMTEnabled and see if it fixes the issue&lt;/p&gt;</comment>
                            <comment id="13172405" author="bryanduxbury" created="Mon, 19 Dec 2011 17:12:25 +0000"  >&lt;p&gt;I&apos;d love to hear if that switch Todd suggests fixes the problem.&lt;/p&gt;</comment>
                            <comment id="13172621" author="mithun" created="Mon, 19 Dec 2011 21:21:24 +0000"  >&lt;p&gt;@Bryan, @Todd: I&apos;m sorry to say that the twiddling the GC options does not fix the issue. I&apos;m not completely done with the testing, but so far, it doesn&apos;t look like this can be worked around. (Thank you for the suggestion, though.)&lt;/p&gt;

&lt;p&gt;Please consider the implementation note in the WeakHashMap&apos;s javadoc:&lt;br/&gt;
&lt;a href=&quot;http://docs.oracle.com/javase/6/docs/api/java/util/WeakHashMap.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/javase/6/docs/api/java/util/WeakHashMap.html&lt;/a&gt;&lt;br/&gt;
&quot;... care should be taken to ensure that value objects do not strongly refer to their own keys, either directly or indirectly, since that will prevent the keys from being discarded. &quot;&lt;/p&gt;

&lt;p&gt;This is precisely the condition we&apos;re facing. Introducing the WeakReference would fix this. (My tests are still running.)&lt;/p&gt;</comment>
                            <comment id="13172645" author="tlipcon" created="Mon, 19 Dec 2011 21:44:58 +0000"  >&lt;p&gt;I see now what you&apos;re saying. Sorry for the red herring JVM bug.&lt;/p&gt;

&lt;p&gt;Rather than introducing the weakreference in TSaslServerTransport, I think it would make more sense to have the map use WeakReference&amp;lt;TSaslServerTransport&amp;gt; as values &amp;#8211; that keeps the TSaslTransport implementation from having to work around the implementation details of the factory&lt;/p&gt;</comment>
                            <comment id="13172783" author="mithun" created="Tue, 20 Dec 2011 00:29:17 +0000"  >&lt;p&gt;Right, I agree. That&apos;s cleaner. (Sorry. It didn&apos;t occur to me till this morning.)&lt;/p&gt;</comment>
                            <comment id="13173728" author="mithun" created="Wed, 21 Dec 2011 01:17:50 +0000"  >&lt;p&gt;On second thoughts, I&apos;m not sure if that&apos;s ideal. Remember: we need the WeakHashMap because client-code (of the factory) caches the key, i.e. the underlying TTransport object, and not the value (returned from the factory).&lt;/p&gt;

&lt;p&gt;So if we make the value a WeakReference, the TSaslTransport might be aggressively collected &lt;b&gt;before&lt;/b&gt; the key has been collected. The next time the factory is invoked, a fresh TSaslTransport would have to be set up. It&apos;ll work, but there is a perf-hit.&lt;/p&gt;

&lt;p&gt;My way, there&apos;s no way the TSaslTransport can be collected before the underlying TTransport is collected. (That&apos;s because the users of the factory already have a handle to the TTransport. If it didn&apos;t, we wouldn&apos;t even be using the cache.) The safety checks I&apos;ve put in TSaslTransport are &quot;just in case&quot;.&lt;/p&gt;

&lt;p&gt;I can confirm that this fix does fix the mem-leak. It would be good if the patch could please be reviewed for correctness.&lt;/p&gt;</comment>
                            <comment id="13173896" author="atm" created="Wed, 21 Dec 2011 06:18:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;On second thoughts, I&apos;m not sure if that&apos;s ideal. Remember: we need the WeakHashMap because client-code (of the factory) caches the key, i.e. the underlying TTransport object, and not the value (returned from the factory).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I haven&apos;t looked at the code in a while, but I&apos;m pretty sure that&apos;s not the case. The reason for the hash map is because the TServer implementations don&apos;t reuse the same TTransport instance for input and output, even when the same TTransportFactory instance is used for both the input and output factory. This is a requirement for the TSaslTransports. Once TSaslServerTransport#Factory#getTransport is called once, the result is indeed cached by the client-code of the factory - the TServer implementations. So, there will be a hard reference to the value, and that will in turn have a hard reference to the key.&lt;/p&gt;

&lt;p&gt;I agree with Todd that storing a WeakReference&amp;lt;TSaslServerTransport&amp;gt; should solve the problem. Mithun, would you mind testing this out?&lt;/p&gt;</comment>
                            <comment id="13173910" author="ashutoshc" created="Wed, 21 Dec 2011 06:40:32 +0000"  >&lt;p&gt;On a semi-related note, it appears to me that there is a race condition in TSaslServerTransport::getTransport()&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;TSaslServerTransport ret = transportMap.get(base);
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ret == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        LOGGER.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;transport map does not contain key&quot;&lt;/span&gt;, base);
        ret = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TSaslServerTransport(serverDefinitionMap, base);
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
          ret.open();
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (TTransportException e) {
        }
        transportMap.put(base, ret);
      } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        LOGGER.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;transport map does contain key {}&quot;&lt;/span&gt;, base);
      }
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ret;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;transport map is synchronized, but I think putIfAbsent() semantics is needed here instead of null checking and then adding.&lt;/p&gt;</comment>
                            <comment id="13173912" author="mithun" created="Wed, 21 Dec 2011 06:46:09 +0000"  >&lt;p&gt;Thank you for clarifying, Aaron. I might have misread the code that uses TSST::Factory::getTransport(). I could try out changing to a WeakReference, and post results shortly.&lt;/p&gt;</comment>
                            <comment id="13173913" author="atm" created="Wed, 21 Dec 2011 06:47:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;On a semi-related note, it appears to me that there is a race condition in TSaslServerTransport::getTransport()&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I disagree. Again, the only reason for the map is to make sure that a single given TServer instance gets the same TSaslServerTransport instance for the input and output transports on successive calls to TSaslServerTransport#Factory#getTransport. Thus, we can conclude that concurrent callers of getTransport() will always be passing different base transports.&lt;/p&gt;

&lt;p&gt;See &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-876&quot; title=&quot;Add SASL support&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-876&quot;&gt;&lt;del&gt;THRIFT-876&lt;/del&gt;&lt;/a&gt; for most of the history on the implementation of the TSasl* classes.&lt;/p&gt;</comment>
                            <comment id="13174301" author="bryanduxbury" created="Wed, 21 Dec 2011 18:49:45 +0000"  >&lt;p&gt;@Aaron - I can see how your explanation handles the race condition, but it might be nice to put a little comment in the code to clarify that, since it&apos;s likely to be a mistake people make again.&lt;/p&gt;</comment>
                            <comment id="13174332" author="atm" created="Wed, 21 Dec 2011 19:18:04 +0000"  >&lt;p&gt;@Bryan - I totally agree. Mithun, would you mind adding a comment to that affect to whatever patch you post for this issue? If not, I&apos;ll file a separate JIRA to add the comment.&lt;/p&gt;</comment>
                            <comment id="13174555" author="mithun" created="Thu, 22 Dec 2011 01:21:06 +0000"  >&lt;p&gt;Uploading new patch (with TSaslServerTransport&apos;s transportMap holding values as weak-references).&lt;/p&gt;

&lt;p&gt;Tests are ongoing. I&apos;ll post results.&lt;/p&gt;

&lt;p&gt;In the meantime, Aaron, could I please enquire where the return-value from getTransport() is cached? Were you referring to TThreadPoolServer and TSimpleServer?&lt;/p&gt;</comment>
                            <comment id="13174923" author="mithun" created="Thu, 22 Dec 2011 17:45:05 +0000"  >&lt;p&gt;I can confirm that the newest patch works. (This patch also has the comments you&apos;d requested for.) Ran overnight, and the latest heap-dumps don&apos;t indicate a build-up of WeakHashMap$Entry objects.&lt;/p&gt;

&lt;p&gt;Would it be possible to get this patch into a build of 0.5.0 (on a maven-repository), and not just 0.9? That&apos;d let Hive and HCatalog take advantage of this fix.&lt;/p&gt;</comment>
                            <comment id="13174930" author="bryanduxbury" created="Thu, 22 Dec 2011 17:53:56 +0000"  >&lt;p&gt;Hm, I&apos;m not too excited at the prospect of releasing a new 0.5 with this fix. If the patch applies cleanly to 0.5, it might be possible, but I&apos;d much rather encourage projects to move forward in versions instead.&lt;/p&gt;</comment>
                            <comment id="13174966" author="mithun" created="Thu, 22 Dec 2011 18:56:08 +0000"  >&lt;p&gt;@Bryan: Hey, I had to try. ;] Thank you for your candour.&lt;/p&gt;</comment>
                            <comment id="13174972" author="atm" created="Thu, 22 Dec 2011 19:01:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;I can confirm that the newest patch works. (This patch also has the comments you&apos;d requested for.) Ran overnight, and the latest heap-dumps don&apos;t indicate a build-up of WeakHashMap$Entry objects.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s great! Thanks a lot for testing that out, Mithun. The patch and the comment you added look good to me.&lt;/p&gt;</comment>
                            <comment id="13174974" author="bryanduxbury" created="Thu, 22 Dec 2011 19:05:19 +0000"  >&lt;p&gt;I just committed this.&lt;/p&gt;</comment>
                            <comment id="13175055" author="hudson" created="Thu, 22 Dec 2011 20:58:33 +0000"  >&lt;p&gt;Integrated in Thrift #372 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/372/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/372/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1468&quot; title=&quot;Memory leak in TSaslServerTransport&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1468&quot;&gt;&lt;del&gt;THRIFT-1468&lt;/del&gt;&lt;/a&gt;. java: Memory leak in TSaslServerTransport&lt;/p&gt;

&lt;p&gt;This patch changes a particular map element to a WeakReference and thus avoids some awkward un-GC-ableness.&lt;/p&gt;

&lt;p&gt;Patch: Mithun Radhakrishnan&quot;&lt;/p&gt;

&lt;p&gt;bryanduxbury : &lt;a href=&quot;http://svn.apache.org/viewvc/?view=rev&amp;amp;rev=1222397&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/?view=rev&amp;amp;rev=1222397&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/thrift/trunk/lib/java/src/org/apache/thrift/transport/TSaslServerTransport.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12535414">HCATALOG-183</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12538256">HIVE-2715</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12507663" name="Main.java" size="1395" author="mithun" created="Fri, 16 Dec 2011 08:18:11 +0000"/>
                            <attachment id="12508333" name="THRIFT-1468-Memory_leak_in_TSaslServerTransport.patch" size="2342" author="mithun" created="Thu, 22 Dec 2011 01:21:05 +0000"/>
                            <attachment id="12507664" name="thrift-1468.patch" size="7114" author="mithun" created="Fri, 16 Dec 2011 08:22:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>221102</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 48 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i083tj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>45218</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>