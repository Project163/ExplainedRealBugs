<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:33:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-5430] FieldMetaData synchronized method can trigger deadlock during static class initialization in JVM native code</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-5430</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;We (Pinterest) hit the following deadlock during JVM classloading of Thrift classes. The root cause was triggering sClass.newInstance() while holding the synchronized lock on FieldMetaData.class::getStructMetaDataMap(..)&lt;/p&gt;

&lt;p&gt;Here&apos;s the stacktraces of interest:&#160;&lt;br/&gt;
 Thread 1:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Stack Trace is:
at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)&#160; &lt;span class=&quot;code-comment&quot;&gt;// stuck here &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &amp;gt; 30 mins
&lt;/span&gt;at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)
at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.newInstance(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;.java:442) &lt;span class=&quot;code-comment&quot;&gt;// creating an object via reflection.
&lt;/span&gt;at org.apache.thrift.meta_data.FieldMetaData.getStructMetaDataMap(FieldMetaData.java:61)- locked java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;@346242bb &lt;span class=&quot;code-comment&quot;&gt;// Lock held on FieldMetaData.class
&lt;/span&gt;at com.pinterest.commons.thrift.ThriftStructDescriptor.&amp;lt;init&amp;gt;(ThriftStructDescriptor.java:56)
at com.pinterest.commons.thrift.ThriftStructDescriptor.getDescriptor(ThriftStructDescriptor.java:38) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Thread 2:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Stack Trace is:
at org.apache.thrift.meta_data.FieldMetaData.addStructMetaDataMap(FieldMetaData.java:49)
- blocked on java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;@346242bb&#160; &lt;span class=&quot;code-comment&quot;&gt;// Lock held by &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; 1.
&lt;/span&gt;at com.pinterest.schemas.search.query.NavboostScore.&amp;lt;clinit&amp;gt;(NavboostScore.java:146)
at com.pinterest.schemas.search.query.NavboostScores.read(NavboostScores.java:334)
at com.pinterest.schemas.search.query.SupplementaryTerm.read(SupplementaryTerm.java:1209)
at com.pinterest.schemas.search.query.SupplementaryTerms.read(SupplementaryTerms.java:335)
at com.pinterest.schemas.search.query.QueryJoin.read(QueryJoin.java:6514)
at com.pinterest.pinpin.thrift.SerializedResourceContainer.read(SerializedResourceContainer.java:2867)
at org.apache.thrift.TDeserializer.deserialize(TDeserializer.java:69) &lt;span class=&quot;code-comment&quot;&gt;// General Thrift deserialize. &lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here&apos;s the code of interest:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/thrift/blob/65fb49bb41f852375b278c9057d52c9472f0cb3a/lib/java/src/org/apache/thrift/meta_data/FieldMetaData.java#L61&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/blob/65fb49bb41f852375b278c9057d52c9472f0cb3a/lib/java/src/org/apache/thrift/meta_data/FieldMetaData.java#L61&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thread 1 has the following lock acquisition order:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;FieldMetaData.class::getStructMetaDataMap 
-&amp;gt; lock FieldMetaData.class (LOCK 1)
  -&amp;gt; sClass.newInstance() 
  -&amp;gt; load sClass 
    -&amp;gt; JVM init_lock (native) lock and release. (LOCK 2)
      -&amp;gt; waiting for Thread 2 to complete static initialization and notify thread 1.&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Thread 2 has the following lock acquisition order:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;sClass.newInstance() (from new ThriftObject() / deserialization) 
  -&amp;gt;  load sClass 
  -&amp;gt; static initialization 
  -&amp;gt; try locking FieldMetaData.class when calling FieldMetaData.addStructMetaDataMap (WAIT on LOCK 1 which is never released)
     ---&amp;gt; does not ever trigger the next step: 
       ---&amp;gt; Notify Thread 1 that static initialization of the class has completed (releasing LOCK 2 on Thread 1 which will eventually release LOCK 1 by returning from native code).&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Internally, this was a fairly detailed investigation. Would be great if we agree on a Fix approach. This deadlock affects all versions of Thrift since 0.9 which introduced the synchronized keyword. Versions prior to 0.9 are simply thread unsafe (because there&apos;s no lock on FieldMetaData&apos;s internal HashMap and the two static method calls can race). I didn&apos;t check versions below 0.5 but probably this extends all the way back.&#160;&lt;/p&gt;

&lt;p&gt;This is not an issue in fbThrift, which correctly uses a ConcurrentHashMap and does not take a lock on FieldMetaData. See this code here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/facebook/fbthrift/blob/c0f8ffb345d847df512ae9c404a58379fcd51cb9/thrift/lib/java/src/main/java/com/facebook/thrift/meta_data/FieldMetaData.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/facebook/fbthrift/blob/c0f8ffb345d847df512ae9c404a58379fcd51cb9/thrift/lib/java/src/main/java/com/facebook/thrift/meta_data/FieldMetaData.java&lt;/a&gt;&#160;vs the buggy code here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/thrift/blob/v0.14.1/lib/java/src/org/apache/thrift/meta_data/FieldMetaData.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/blob/v0.14.1/lib/java/src/org/apache/thrift/meta_data/FieldMetaData.java&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Another alternative approach is to use&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (structMap} {
 ... 
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;instead of the synchronized keyword on the methods.&#160;&lt;/p&gt;

&lt;p&gt;Please confirm which approach is preferred and we can send a PR on Github.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Here&apos;s the original deadlock hypothesis as outlined by Jiahuan Liu:&lt;/p&gt;

&lt;p&gt;The hypothesis of the deadlock:&lt;br/&gt;
 ThriftStructDescriptor.get is used in many places for deserialization and it calls FieldMetaData.getStructMetaDataMap. inside this method, it tries to load the thrift class if the thrift has not been loaded yet. thrift classes call FieldMetaData.addStructMetaDataMap in a static block. so the deadlock may happen when:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;thread A is trying to deserialize -&amp;gt; getStructMetaDataMap -&amp;gt; class loading&lt;/li&gt;
	&lt;li&gt;if thread B is already trying to load the same thrift, it requires addStructMetaDataMap to complete but this method is blocked by thread A getStructMetaDataMap&lt;/li&gt;
	&lt;li&gt;the class loading in thread A will be blocked by thread B because class loading is also synchronized by java. see this section in java spec:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;If the Class object for C indicates that initialization is in progress for C by some other thread, then release LC and block the current thread until informed that the in-progress initialization has completed, at which time repeat this step.&lt;/p&gt;

&lt;p&gt;Here&apos;s the classloading spec in java 8:&lt;br/&gt;
 &lt;a href=&quot;https://docs.oracle.com/javase/specs/jls/se8/html/jls-12.html#jls-12.4.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javase/specs/jls/se8/html/jls-12.html#jls-12.4.2&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thread 1 is stuck in step 2 of the initialization (waiting for Thread 2 to notify in Step 10).&lt;br/&gt;
 Thread 2 is stuck in step 9 of the initialization and never makes it to step 10.&#160;&lt;br/&gt;
 Precondition: this is the first object creation for that Thrift object and at-least 2 threads are racing to create the object, one of which holds a lock on FieldMetaData.class.&#160;&lt;/p&gt;

&lt;p&gt;Please reach out if this is unclear. This hypothesis was validated by reading through the native JVM code on the class load -&amp;gt; static_initialization path.&#160;&lt;/p&gt;

&lt;p&gt;Here&apos;s the native JVM code if you&apos;re interested: &lt;a href=&quot;https://github.com/AdoptOpenJDK/openjdk-jdk8u/blob/f0eac5a3aff7d413e2ef0532d7464a58d7a15237/hotspot/src/share/vm/oops/instanceKlass.cpp#L833&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;InstanceKlass::initialize_impl&lt;/a&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;AdoptJDK 1.8 (Java 8) ; Linux, AWS machines.&#160;&lt;/p&gt;

&lt;p&gt;Deadlock is environment independent and occurs in conformance with the JRE 8 spec.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</environment>
        <key id="13383101">THRIFT-5430</key>
            <summary>FieldMetaData synchronized method can trigger deadlock during static class initialization in JVM native code</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dkapoor1">Divye Kapoor</assignee>
                                    <reporter username="dkapoor1">Divye Kapoor</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Jun 2021 06:55:29 +0000</created>
                <updated>Sat, 11 Sep 2021 12:30:46 +0000</updated>
                            <resolved>Wed, 23 Jun 2021 19:11:09 +0000</resolved>
                                    <version>0.6</version>
                    <version>0.6.1</version>
                    <version>0.7</version>
                    <version>0.8</version>
                    <version>0.9</version>
                    <version>0.9.1</version>
                    <version>0.9.2</version>
                    <version>0.9.3</version>
                    <version>0.9.3.1</version>
                    <version>0.10.0</version>
                    <version>0.11.0</version>
                    <version>0.12.0</version>
                    <version>0.13.0</version>
                    <version>0.14.0</version>
                    <version>0.14.1</version>
                                    <fixVersion>0.15.0</fixVersion>
                                    <component>Java - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="17360608" author="dkapoor1" created="Thu, 10 Jun 2021 07:03:31 +0000"  >&lt;p&gt;Workaround (if you&apos;re stuck on an older Thrift version):&lt;/p&gt;

&lt;p&gt;Always create an instance of the Thrift object before calling any of the FieldMetaData methods. That will avoid the sClass.newInstance() call and avoid the deadlock.&#160;&lt;/p&gt;</comment>
                            <comment id="17360849" author="jensg" created="Thu, 10 Jun 2021 12:30:50 +0000"  >&lt;p&gt;Thanks for the thorough analysis. Would you be able to provide a pull request?&lt;/p&gt;</comment>
                            <comment id="17361048" author="dkapoor1" created="Thu, 10 Jun 2021 16:02:31 +0000"  >&lt;p&gt;Sure.&lt;/p&gt;</comment>
                            <comment id="17362017" author="dkapoor1" created="Fri, 11 Jun 2021 20:22:16 +0000"  >&lt;p&gt;Trying to send this out at the earliest, but heavily booked at work. Please be patient, this is on our radar.&#160;&lt;/p&gt;</comment>
                            <comment id="17365025" author="dkapoor1" created="Thu, 17 Jun 2021 17:07:05 +0000"  >&lt;p&gt;I wanted to put this in as a comment within the code, but it&apos;s too long and might pollute the code needlessly, leaving it here for anyone who will be interested in following up from the code references which will point to this ticket.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// Note: Do not use &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; on &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; method declaration - it leads to a deadlock.
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// Similarly, &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not trigger sClass.newInstance() &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; holding a lock on structMap,
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// it will lead to the same deadlock.
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// See: https://issues.apache.org/jira/browse/THRIFT-5430 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; details.&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Map&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; TFieldIdEnum, FieldMetaData&amp;gt; getStructMetaDataMap(
    &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; TBase&amp;gt; sClass) {
&lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// Please keep in mind that the call to sClass.newInstance() below is meant to trigger the
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; initializer process in &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; JVM code on the CURRENT thread.
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// The process is described here:
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// https://docs.oracle.com/javase/specs/jls/se8/html/jls-12.html#jls-12.4.2
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// If another thread is also triggering the SAME &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; initializer code in &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; JVM
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// through a different code path (eg. via &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ThriftObject()), the two threads will compete
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// on which one of them will actually execute the &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; initializer.
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// This decision is taken in JVM &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; code. (Example: as part of the
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// instanceKlass::initialize_impl method below)
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// https://github.com/AdoptOpenJDK/openjdk-jdk8u/blob/f0eac5a3aff7d413e2ef0532d7464a58d7a15237/hotspot/src/share/vm/oops/instanceKlass.cpp#L833
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// If the CURRENT thread wins and executes the &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; initializer, there is no problem.
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// The &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; initializer of the Thrift Struct will call
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// code similar to &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;:
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//  &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; {
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//    Map&amp;lt;_Fields, FieldMetaData&amp;gt; tmpMap = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; EnumMap&amp;lt;_Fields, FieldMetaData&amp;gt;(_Fields
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//    .class);
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//    Set&amp;lt;FieldValueMetaData&amp;gt; tmpSet = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet&amp;lt;FieldValueMetaData&amp;gt;();
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//    tmpMap.put(_Fields.EVENT_TYPE, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FieldMetaData(&lt;span class=&quot;code-quote&quot;&gt;&quot;eventType&quot;&lt;/span&gt;, TFieldRequirementType
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//    .OPTIONAL,
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//      &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; EnumMetaData(TType.ENUM, EventType.class)));
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//    tmpMap.put(_Fields.TIMESTAMP, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FieldMetaData(&lt;span class=&quot;code-quote&quot;&gt;&quot;timestamp&quot;&lt;/span&gt;, TFieldRequirementType
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//    .OPTIONAL,
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//      &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FieldValueMetaData(TType.I64)));
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//    metaDataMap = Collections.unmodifiableMap(tmpMap);
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//    binaryFieldValueMetaDatas = Collections.unmodifiableSet(tmpSet);
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//    FieldMetaData.addStructMetaDataMap(IndexDataEvent.class, metaDataMap);  // Re-entrant call
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//  }
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// The &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; lock &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; FieldMetaData.&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;will be granted (because &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; thread is
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// allowed to lock a lock it already holds). Here&apos;s the Java Spec on &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; issue:
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// https://docs.oracle.com/javase/specs/jls/se8/html/jls-17.html#jls-17.1
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// &quot;Each object in Java is associated with a monitor, which a thread can lock or unlock.
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// Only one thread at a time may hold a lock on a monitor. Any other threads attempting to
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// lock that monitor are blocked until they can obtain a lock on that monitor. A thread t
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// may lock a particular monitor multiple times; each unlock reverses the effect of
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// one lock operation.&quot;
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// If the OTHER thread wins and executes the &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; initalizer though, the CURRENT thread
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// is STUCK in &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; code in Step 2 of the &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;initialization process:
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// &quot;If the &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; object &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; C indicates that initialization is in progress &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; C by some
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// other thread, then release LC and block the current thread until informed that the
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// in-progress initialization has completed, at which time repeat &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; step.&quot;
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// The OTHER thread is also blocked in Step 9 because it won&apos;t ever finish the &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// initialization call (the re-entrant call tries to acquire a lock that is held by the
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// CURRENT thread). Therefore, we have a deadlock.
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// How to avoid the deadlock: Don&apos;t hold any locks when calling sClass
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// .newInstance() because of the re-entrant call to &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;from the &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; initializer. 
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!structMap.containsKey(sClass)){ &lt;span class=&quot;code-comment&quot;&gt;// Load &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it hasn&apos;t been loaded
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;{
      sClass.newInstance();
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InstantiationException e){
      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;InstantiationException &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; TBase class: &quot;&lt;/span&gt; + sClass.getName() + &lt;span class=&quot;code-quote&quot;&gt;&quot;, message: &quot;&lt;/span&gt; + e.getMessage());
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IllegalAccessException e){
      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;IllegalAccessException &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; TBase class: &quot;&lt;/span&gt; + sClass.getName() + &lt;span class=&quot;code-quote&quot;&gt;&quot;, message: &quot;&lt;/span&gt; + e.getMessage());
    }
  }
  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; structMap.get(sClass);
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17366845" author="dkapoor1" created="Mon, 21 Jun 2021 21:57:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jensg&quot; class=&quot;user-hover&quot; rel=&quot;jensg&quot;&gt;jensg&lt;/a&gt; - Pull request is here: &lt;a href=&quot;https://github.com/apache/thrift/pull/2411&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/2411&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Changes both the Java SE and Java ME implementations (both have the same issue).&lt;/p&gt;</comment>
                            <comment id="17366915" author="dkapoor1" created="Tue, 22 Jun 2021 00:21:57 +0000"  >&lt;p&gt;CI builds seem to be failing with an error (potentially unrelated):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;34: ((FLET SB-FASL::LOAD-STREAM :IN LOAD) #&amp;lt;SB-SYS:FD-STREAM for &quot;file /thrift/src/test/cl/make-test-server.lisp&quot; {100154E873}&amp;gt; NIL)1836035: (LOAD #&amp;lt;SB-SYS:FD-STREAM for &quot;file /thrift/src/test/cl/make-test-server.lisp&quot; {100154E873}&amp;gt; :VERBOSE NIL :PRINT NIL :IF-DOES-NOT-EXIST T :EXTERNAL-FORMAT :DEFAULT)1836136: ((FLET SB-IMPL::LOAD-SCRIPT :IN SB-IMPL::PROCESS-SCRIPT) #&amp;lt;SB-SYS:FD-STREAM for &quot;file /thrift/src/test/cl/make-test-server.lisp&quot; {100154E873}&amp;gt;)1836237: ((FLET SB-UNIX::BODY :IN SB-IMPL::PROCESS-SCRIPT))1836338: ((FLET &quot;WITHOUT-INTERRUPTS-BODY-2&quot; :IN SB-IMPL::PROCESS-SCRIPT))1836439: (SB-IMPL::PROCESS-SCRIPT &quot;make-test-server.lisp&quot;)1836540: (SB-IMPL::TOPLEVEL-INIT)1836641: ((FLET SB-UNIX::BODY :IN SAVE-LISP-AND-DIE))1836742: ((FLET &quot;WITHOUT-INTERRUPTS-BODY-7&quot; :IN SAVE-LISP-AND-DIE))1836843: ((LABELS SB-IMPL::RESTART-LISP :IN SAVE-LISP-AND-DIE))1836918370unhandled condition in --disable-debugger mode, quitting18371Makefile:626: recipe for target &apos;TestServer&apos; failed18372make[2]: *** [TestServer] Error 1
unhandled condition in --disable-debugger mode, quitting

Makefile:626: recipe for target &apos;TestServer&apos; failed
make[2]: *** [TestServer] Error make[2]: Leaving directory &apos;/thrift/src/test/cl&apos;
Makefile:919: recipe for target &apos;precross-cl&apos; failed
make[1]: *** [precross-cl] Error 
make[1]: Leaving directory &apos;/thrift/src/test&apos;
Makefile:1122: recipe for target &apos;precross-test&apos; failed
make: *** [precross-test] Error 
make: *** Waiting for unfinished jobs.... &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Can someone confirm that this is a CI related infra issue and not a PR issue? I found this (related) issue online: &lt;a href=&quot;https://bugzilla.redhat.com/show_bug.cgi?id=214568&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bugzilla.redhat.com/show_bug.cgi?id=214568&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17367542" author="jensg" created="Tue, 22 Jun 2021 17:25:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;Can someone confirm that this &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt; not a PR issue?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Not your fault.&lt;/p&gt;
</comment>
                            <comment id="17367641" author="dkapoor1" created="Tue, 22 Jun 2021 19:46:54 +0000"  >&lt;p&gt;Thanks. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jensg&quot; class=&quot;user-hover&quot; rel=&quot;jensg&quot;&gt;jensg&lt;/a&gt;&#160;- next steps for merging the PR in?&lt;/p&gt;</comment>
                            <comment id="17367937" author="jensg" created="Wed, 23 Jun 2021 08:01:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;heavily booked at work. Please be patient, this is on our radar. &lt;/p&gt;&lt;/blockquote&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 21 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0rttc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>