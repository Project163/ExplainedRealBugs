<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 07:59:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-904] C# TSocket should disable nagle and linger</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-904</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;Java sets&lt;/p&gt;

&lt;p&gt;      socket_.setSoLinger(false, 0);&lt;br/&gt;
      socket_.setTcpNoDelay(true);&lt;/p&gt;

&lt;p&gt;C# should do the equivalent.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12474467">THRIFT-904</key>
            <summary>C# TSocket should disable nagle and linger</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dlex">Alexey Biryukov</assignee>
                                    <reporter username="jbellis">Jonathan Ellis</reporter>
                        <labels>
                    </labels>
                <created>Sat, 18 Sep 2010 08:43:18 +0000</created>
                <updated>Tue, 1 Nov 2011 02:52:00 +0000</updated>
                            <resolved>Thu, 27 Jan 2011 03:02:38 +0000</resolved>
                                                    <fixVersion>0.6</fixVersion>
                                    <component>C# - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="12921470" author="jking" created="Fri, 15 Oct 2010 17:56:04 +0000"  >&lt;p&gt;I get excellent performance out of the C# runtime (in &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-66&quot; title=&quot;Java: Allow multiplexing multiple services over a single TCP connection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-66&quot;&gt;&lt;del&gt;THRIFT-66&lt;/del&gt;&lt;/a&gt;) without the need to do this...&lt;/p&gt;</comment>
                            <comment id="12945551" author="dlex" created="Sat, 27 Nov 2010 05:06:27 +0000"  >&lt;p&gt;I&apos;m observing the throughput decline due to Nagle/Linger in the following conditions:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;client and server are on different hosts&lt;/li&gt;
	&lt;li&gt;TFramedTransport is used&lt;/li&gt;
	&lt;li&gt;Message size sent in arguments is 1K or less&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;My opinion is instead of turning off Nagle, TFramedTransport should be made Nagle-aware. Currently it is sending frame in 2 syscalls and, therefore, in 2 TCP segments, the first being only 4 bytes long. And if the second segment did not fill the data up to MSS, it waits for ACK which is delayed by the peer for 40 ms due to lack of response data.&lt;/p&gt;

&lt;p&gt;If TFramedTransport used just one write() call per frame, there is no need for setNoTcpDelay.&lt;/p&gt;

&lt;p&gt;I&apos;m currently working on this fix and will submit it soon.&lt;/p&gt;

</comment>
                            <comment id="12960272" author="dlex" created="Sat, 27 Nov 2010 06:00:55 +0000"  >&lt;p&gt;Here is the fix to make TFramedTransport &quot;Nagle-aware&quot;. &lt;/p&gt;

&lt;p&gt;First patch adds a relevant testcase to the tests. It adds support for TFramedTransport in both server and client mode (use &lt;tt&gt;ThriftTest server 9090 framed&lt;/tt&gt; and &lt;tt&gt;ThriftTest.exe client -f&lt;/tt&gt;), and adds &quot;Calltime&quot; testcase that calls testVoid() 1000 times and calculates average call time. &lt;/p&gt;

&lt;p&gt;It clearly shows the problem:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;dlex@build1:~/misc/thrift/new$ ./ThriftTest.exe client -f -h abiryukov-xp-dt:9090
Using framed transport
testVoid() = void
....
Test Oneway(1)
Test Calltime() = 202.166668 ms a testVoid() call
Total time: 00:03:31.5856840
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Another patch fixes the issue. Now every time TFramedTransport initializes its buffer, it reserves 4 bytes in the beginning that are used later in flush() to inject frame header. Then the buffer is transmitted with a single call to transport.Write().&lt;/p&gt;

&lt;p&gt;After applying the patch:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;dlex@build1:~/misc/thrift/new$ ./ThriftTest.exe client -f -h abiryukov-xp-dt:9090
Using framed transport
testVoid() = void
.........
Test Oneway(1)
Test Calltime() = 1.639454 ms a testVoid() call
Total time: 00:00:07.0190670
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12964794" author="dlex" created="Mon, 29 Nov 2010 16:16:11 +0000"  >&lt;p&gt;Patches updated to match tab policy used in the original sources&lt;/p&gt;</comment>
                            <comment id="12987361" author="tjake" created="Thu, 27 Jan 2011 03:02:38 +0000"  >&lt;p&gt;Thanks Alexey, committed&lt;/p&gt;</comment>
                            <comment id="12991630" author="chmorgan" created="Mon, 7 Feb 2011 21:48:55 +0000"  >&lt;p&gt;The Cpp TSocket.cpp and TServerSocket.cpp both set TCP_NODELAY. Why shouldn&apos;t the c# TSocket.cs and TServerSocket.cs do the same?&lt;/p&gt;</comment>
                            <comment id="12994861" author="dlex" created="Tue, 15 Feb 2011 16:19:21 +0000"  >&lt;p&gt;I have tried both approaches with a custom made RPC framework few years ago. My tests showed that leaving Nagle enabled while implementing synchronous RPC actually enforces better TCP usage practices. Throughput performance gain with enabled Nagle was from 5% with smallest size of payload per call, reaching the maximum of almost 50% with payload about 256-512 bytes long, and decreasing back to nothing with over ten-kB payloads. &lt;/p&gt;

&lt;p&gt;Besides that, the Nagle-off solution would produce a tinygram or two per each call that could be avoidable otherwise.&lt;/p&gt;

&lt;p&gt;I suppose that these are good reasons to leave Nagle on, send out data in solid TCP segments, and consider doing the same changes in c++ implementation as well.&lt;/p&gt;</comment>
                            <comment id="12994862" author="chmorgan" created="Tue, 15 Feb 2011 16:26:42 +0000"  >&lt;p&gt;Nagle is disabled in TSocket and TSocketServer for C# in trunk as of last week to match c++ and java.&lt;/p&gt;

&lt;p&gt;Is the frame transport more complex than the straight socket approach? Is the difference that the framed approach buffers the data whereas the socket approach sends it directly? I&apos;m wondering if having nagle off for the simple case and on for the more advanced cases that can buffer/group the send up is the best approach.&lt;/p&gt;</comment>
                            <comment id="13000722" author="dlex" created="Tue, 1 Mar 2011 05:10:54 +0000"  >&lt;p&gt;I wish it was not in any implementation. My reasons for that are explained above.&lt;/p&gt;

&lt;p&gt;The difference between framed transport and others is in additional 4 byte header (as far as I remember) that is prepended to each packet. If the header is put to TCP with a separate call (as it had been in the code I was fixing), you will have 2 segments going one after another in the same direction, first of them being only a few bytes long. This is what Nagle/Linger are intended to prevent, and this is preventable. IMO disabling Nagle/Linger in this case is like fighting the symptom but not the cause. And there&apos;s nothing about simple or advanced cases, just give the whole packet to TCP and that&apos;s it. (Alternatively, you can use TCP_CORK on Linux, but this is in no way portable solution.)&lt;/p&gt;</comment>
                            <comment id="13000890" author="chmorgan" created="Tue, 1 Mar 2011 14:27:13 +0000"  >&lt;p&gt;I agree that we don&apos;t want nagle disabled for any implementation the issue is:&lt;/p&gt;

&lt;p&gt;1. TSimpleServer/Client runs VERY poorly with nagle enabled&lt;br/&gt;
2. Previously C/Java and others disabled nagle but C# didn&apos;t.&lt;/p&gt;

&lt;p&gt;Today we&apos;ve fixed the second issue, Thrift is now uniform in how it handles nagle for the simple case.&lt;/p&gt;

&lt;p&gt;Now if we can make the simple server use a single packet instead of sending the 4 byte header separately then we can disable nagle for everyone again. If this conflicts with the server being &quot;simple&quot; then I think we should just document the issue, the workaround (disabling nagle), and suggest that for better performance users should use the frame transport.&lt;/p&gt;

&lt;p&gt;Chris&lt;/p&gt;</comment>
                            <comment id="13000897" author="jbellis" created="Tue, 1 Mar 2011 14:56:39 +0000"  >&lt;p&gt;The problem is that tcp delayed ack pretty much renders nagle an obsolete feature (&lt;a href=&quot;http://www.stuartcheshire.org/papers/NagleDelayedAck/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.stuartcheshire.org/papers/NagleDelayedAck/&lt;/a&gt;); this is the source of the poor performance reported here.  You really have to &quot;manually nagle&quot; (i.e. buffer) instead of hoping the tcp stack does it for you.&lt;/p&gt;</comment>
                            <comment id="13000900" author="chmorgan" created="Tue, 1 Mar 2011 15:02:31 +0000"  >&lt;p&gt;I think the issue deserves some time in the faq, on the website, or in documentation in the code, since it isn&apos;t trivial and the justification for the decisions may be forgotten.&lt;/p&gt;

&lt;p&gt;Chris&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12464874" name="thrift-904.patch" size="2511" author="dlex" created="Mon, 29 Nov 2010 16:16:11 +0000"/>
                            <attachment id="12464875" name="thrift-904.tests.patch" size="3604" author="dlex" created="Mon, 29 Nov 2010 16:16:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>187040</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 39 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i16bmv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>245017</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>