<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:34:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-5480] TThreadPoolAsyncServer using TFramedTransport mistakenly drops client</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-5480</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;TThreadPoolAsyncServer using TFramedTransport silently drops a client service using oneway methods when the second message is bigger than the first one.&lt;/p&gt;

&lt;p&gt;I have an application implementing a one way service, depending on it&apos;s state. I created a TThreadpoolAsync server using the netstd 0.15 version, and I noticed that after a point, the notifications stopped coming, but there was no error on either side. The methods all worked individually, but some did not work after others.&lt;/p&gt;

&lt;p&gt;Eliminating all possible causes on my side, I debugged the source code, and discovered that a transport exception was thrown from TEndpointTransport when a message size was bigger than the proceeding one, because TFramedTransport.ReadFrameAsync was not resetting the message size when it was done reading it, thus causing TEndpointTransport.UpdateKnownMessageSize to throw the exception. The server interpreted the exception as if the client had disconnected, so it silently ignored it.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ve attached a patch that corrects this behaviour&lt;/p&gt;</description>
                <environment></environment>
        <key id="13411606">THRIFT-5480</key>
            <summary>TThreadPoolAsyncServer using TFramedTransport mistakenly drops client</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jensg">Jens Geyer</assignee>
                                    <reporter username="io">Ioannis Efthymiou</reporter>
                        <labels>
                            <label>Oneway</label>
                            <label>TFramedTransport</label>
                            <label>TThreadPoolAsyncServer</label>
                    </labels>
                <created>Sat, 13 Nov 2021 10:16:28 +0000</created>
                <updated>Tue, 15 Feb 2022 21:41:50 +0000</updated>
                            <resolved>Sat, 13 Nov 2021 23:27:09 +0000</resolved>
                                    <version>0.15.0</version>
                                    <fixVersion>0.16.0</fixVersion>
                                    <component>netstd - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="17443090" author="jensg" created="Sat, 13 Nov 2021 12:25:14 +0000"  >&lt;p&gt;But TFramed works perfectly in other scenarios. Sure you fixed the right place?&#160;&lt;/p&gt;

&lt;p&gt;Also, by resetting the msgsize at that particular place you essentially disable the check entirely. Lets throw it out then since we don&apos;t need it anyway, should we? No, we should not, because there is a good reason for these checks.&lt;/p&gt;

&lt;p&gt;Long story short: &lt;b&gt;Would be helpful if you could provide a full test case.&lt;/b&gt; Possible?&lt;/p&gt;</comment>
                            <comment id="17443120" author="JIRAUSER280113" created="Sat, 13 Nov 2021 15:09:36 +0000"  >&lt;p&gt;I added a minimal example server, and a python client. You could try different versions of clients as well. You can see that you can&apos;t call the first method after you&apos;ve called the second method. As a matter of fact, the transport will be closed on the server side, from TEndpointTransport.ResetConsumedMessageSize throwing a TTransportException.&lt;/p&gt;

&lt;p&gt;I was under the impression that the check disabled, it&apos;s just reset for the next time it&apos;s needed. I suppose I missed something&lt;/p&gt;</comment>
                            <comment id="17443159" author="jensg" created="Sat, 13 Nov 2021 18:05:16 +0000"  >&lt;p&gt;Thanks, will have a look. &lt;/p&gt;

&lt;p&gt;The proposed reset effectively puts the maximum allowed value back into place. This is unfortunate here, because framed enables us to to know the real size and the patch just decides to forget it, hence all operations that happen afterwards will check again against the maximum instead of the real size. The patch fixes the actual symptom by making the checks weaker.&lt;/p&gt;</comment>
                            <comment id="17443218" author="jensg" created="Sat, 13 Nov 2021 23:27:18 +0000"  >&lt;p&gt;Good catch, thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13036057" name="0001-Reset-message-size-in-TFramedTransport.ReadFrameAsyn-1.patch" size="1083" author="io" created="Sat, 13 Nov 2021 10:12:52 +0000"/>
                            <attachment id="13036061" name="ThriftBug.zip" size="16449" author="io" created="Sat, 13 Nov 2021 14:58:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                            <customfield id="customfield_12314421" key="com.atlassian.jira.plugin.system.customfieldtypes:labels">
                        <customfieldname>Language</customfieldname>
                        <customfieldvalues>
                                        <label>C#</label>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0wpfk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>