<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:17:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-2441] Cannot shutdown TThreadedServer when clients are still connected</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-2441</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;When calling stop() on the TThreadedServer no interrupts are sent to the client threads. This means the stop() call blocks on tasksMonitor.wait() until all client naturally disconnect.&lt;/p&gt;

&lt;p&gt;How can we tell the client thread connections to close/exit during the TThreadedServer::stop() call?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12706127">THRIFT-2441</key>
            <summary>Cannot shutdown TThreadedServer when clients are still connected</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jking3">James E. King III</assignee>
                                    <reporter username="chris5287">Chris Stylianou</reporter>
                        <labels>
                    </labels>
                <created>Wed, 2 Apr 2014 09:05:10 +0000</created>
                <updated>Fri, 1 Feb 2019 05:44:20 +0000</updated>
                            <resolved>Fri, 24 Apr 2015 13:59:26 +0000</resolved>
                                    <version>0.9.1</version>
                                    <fixVersion>0.9.3</fixVersion>
                                    <component>C++ - Library</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="13959749" author="chris5287" created="Fri, 4 Apr 2014 08:06:44 +0000"  >&lt;p&gt;This looks like a possible solution: &lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/incubator-thrift-dev/200907.mbox/raw/%3CFA84B8053078CD418E46F66E2246A54C02912BF6@UKDCDX01.cbs.ad.cbs.net%3E/2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://mail-archives.apache.org/mod_mbox/incubator-thrift-dev/200907.mbox/raw/%3CFA84B8053078CD418E46F66E2246A54C02912BF6@UKDCDX01.cbs.ad.cbs.net%3E/2&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14215134" author="hcma" created="Mon, 17 Nov 2014 20:43:21 +0000"  >&lt;p&gt;Since this bug is still open, this is more or less obvious, but I can confirm that  it also affects 0.9.2.&lt;/p&gt;</comment>
                            <comment id="14382706" author="jking3" created="Thu, 26 Mar 2015 21:25:58 +0000"  >&lt;p&gt;I can verify the fix posted on 04/Apr/14 does resolve this issue as we experienced this issue and we have been using this fix for a long time.  It is actually present back to at least 0.8.0.&lt;/p&gt;</comment>
                            <comment id="14385892" author="roger.meier" created="Sun, 29 Mar 2015 18:59:17 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="14385896" author="hudson" created="Sun, 29 Mar 2015 19:16:28 +0000"  >&lt;p&gt;SUCCESS: Integrated in Thrift #1486 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/1486/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/1486/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; ccp: Cannot shutdown TThreadedServer when clients are still connected (roger: rev 6fc2115e187e34101515aa0bb509d83549c157d0)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;lib/cpp/src/thrift/server/TThreadedServer.cpp&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14386093" author="ben.craig" created="Mon, 30 Mar 2015 02:09:40 +0000"  >&lt;p&gt;-1 for this specific fix.  Closing a socket that is currently in use results in undefined behavior.  Even worse... it will usually work (as has been observed).&lt;/p&gt;

&lt;p&gt;Here is a scenario that I&apos;ve run into when others have used this pattern.  I&apos;ve had to fix this in real code, it is not just a hypothetical.&lt;/p&gt;

&lt;p&gt;Thread 1 is the primary thread dealing with a socket.  This socket happens to have the value 42.  At this exact moment, it is just about to call recv on the socket, but the function call hasn&apos;t happened yet.&lt;/p&gt;

&lt;p&gt;Thread 2 calls close on socket 42.&lt;/p&gt;

&lt;p&gt;Thread 3 (the listen / accept thread) gets a new connection.  It assigns this new connection a socket, and it gives this new socket the number 42.&lt;/p&gt;

&lt;p&gt;Thread 1 finally invokes recv, but not on the connection that it wanted, but on a connection it basically stole from elsewhere.  The two sockets only happened to have the same numeric value.&lt;/p&gt;



&lt;p&gt;The correct way to fix this involves calling something like select() before every recv().  The select() call is watching both the socket of interest, as well as a control socket.  When you want to tear down the threaded server, you push a byte into the control socket to wake up all the worker threads.  The worker threads can then see some boolean &apos;isDead&apos; flag and tear down.&lt;/p&gt;

&lt;p&gt;This approach does cost an extra system call on every recv(), and it requires an extra socket_pair().  But it doesn&apos;t have data corruption issues.&lt;/p&gt;</comment>
                            <comment id="14386277" author="codesf" created="Mon, 30 Mar 2015 06:39:16 +0000"  >&lt;p&gt;Hey Ben,&lt;/p&gt;

&lt;p&gt;I agree with your rational, however this patch applies after the listening socket has already been shutdown/closed, so the nasty case you describe is avoided. &lt;/p&gt;

&lt;p&gt;The exposure we are left with is an abortive close of a stream socket independent of the control thread. This could certainly cause a communications error but so could a broken network link (one of those things you just need to code for). While I don&apos;t think this server was broken before (it just waited for clients to close before exiting), I don&apos;t think it is broken now post patch either. Folks just need to know how stop() works. Now it means stop listening (first) and then disconnect all clients regardless of what they are in the middle of. Pull the plug. &lt;/p&gt;

&lt;p&gt;Signalling server threads to let them finish any in-progress RPC would certainly be nice but I might prefer the abortive close, used once in a rare while, to the extra clean shutdown overhead, used on every single recv.  &lt;/p&gt;

&lt;p&gt;-Randy&lt;/p&gt;</comment>
                            <comment id="14386646" author="jking3" created="Mon, 30 Mar 2015 12:45:13 +0000"  >&lt;p&gt;I believe this change is an improvement for the reason Randy suggested - this is analogous to a network disconnect, and all Thrift based implementations that require idempotent behavior must already account for that, therefore this change imposes no additional requirements on any implementation.&lt;/p&gt;

&lt;p&gt;One could certainly file an enhancement request to change stop to take a &lt;tt&gt;const boost::posix_time::time_duration&amp;amp;&lt;/tt&gt; so that the caller can decide how long to wait for the open handler requests to complete if folks want the ability to control this.  That would not be difficult to do.  &lt;/p&gt;</comment>
                            <comment id="14386681" author="ben.craig" created="Mon, 30 Mar 2015 13:18:00 +0000"  >&lt;p&gt;&quot;however this patch applies after the listening socket has already been shutdown/closed&quot;&lt;/p&gt;

&lt;p&gt;That is making the assumption that this Thrift server is the only thing in the process dealing with sockets.  I routinely deal with processes that have three or four different &apos;things&apos; dealing with sockets.  The thrift worker thread may end up &apos;stealing&apos; an http connection from an entirely different code base.  The case that I had to fix in the wild involved a Microsoft RPC server connection getting stolen by some mDNS IPC code that was using a closed socket, pretty much in exactly this kind of use case.&lt;/p&gt;</comment>
                            <comment id="14386696" author="ben.craig" created="Mon, 30 Mar 2015 13:24:44 +0000"  >&lt;p&gt;When there is a network disconnect, the socket handle is still valid, even though the underlying connection is dead.  The code for ThreadedServer prior to this change didn&apos;t ever touch a transport after the transport had been closed, even in cases where a connection was reset / aborted.&lt;/p&gt;</comment>
                            <comment id="14386751" author="jking3" created="Mon, 30 Mar 2015 14:28:01 +0000"  >&lt;p&gt;The code in TSocket and TSSLSocket both protect against a double close by setting the socket value to something invalid and testing for it.  Any transport close() must defend against this behavior.  This means socket close happens once and only once, however since the TThreadedServer::Task::run() calls close() in the task thread and the newly added stop() calls close() in another thread, they need to be mutually exclusive for it truly to be &quot;once and only once&quot;, and this patch doesn&apos;t do that.  Thank you for pointing this out.&lt;/p&gt;</comment>
                            <comment id="14386763" author="ben.craig" created="Mon, 30 Mar 2015 14:33:44 +0000"  >&lt;p&gt;I am leery in general of closing a transport in one thread and reading from the transport in another thread, without any thread synchronization between them.&lt;/p&gt;</comment>
                            <comment id="14386836" author="jking3" created="Mon, 30 Mar 2015 15:13:48 +0000"  >&lt;p&gt;I understand now, and your original comment makes sense.  As such, it sounds like we should back out this change for now, as we need a fix that can properly force a close from the server side without the possibility of reading from an unexpected file descriptor.&lt;/p&gt;

&lt;p&gt;Another reference for this discussion, although it is over 4 years old:&lt;br/&gt;
&lt;a href=&quot;http://stackoverflow.com/questions/3624365/blocking-recv-doesnt-exit-when-closing-socket-from-another-thread&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/questions/3624365/blocking-recv-doesnt-exit-when-closing-socket-from-another-thread&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14386953" author="codesf" created="Mon, 30 Mar 2015 16:41:53 +0000"  >&lt;p&gt;Indeed, good example.&lt;/p&gt;</comment>
                            <comment id="14388456" author="jking3" created="Tue, 31 Mar 2015 12:32:13 +0000"  >&lt;p&gt;Looking over TServerSocket.cpp I see socket pairs being used there; is this for the very same reason - to ensure ::accept() is not called on a reallocated file descriptor?  The control socket used to shutdown the server socket could be passed down to the accepted client sockets so they can follow the same pattern.&lt;/p&gt;</comment>
                            <comment id="14388513" author="ben.craig" created="Tue, 31 Mar 2015 13:25:12 +0000"  >&lt;p&gt;TServerSocket&apos;s pattern is basically what I had in mind for the client sockets.  There are a number of ways that a control socket could be plumbed through, and the way you mention sounds reasonable.&lt;/p&gt;

&lt;p&gt;The tricky aspect is the performance degradation.  It seems like there should be some option / choice made by the client as to whether they want prompt teardown, or whether they would prefer faster reads and writes.  One way this could be approached is by having a different transport class handle one of the cases.  It could also be handled by a different TServerSocket constructor.&lt;/p&gt;</comment>
                            <comment id="14388756" author="jking3" created="Tue, 31 Mar 2015 16:08:20 +0000"  >&lt;p&gt;I would argue against allowing the client to hold the server in a particular state.  As it stands today in 0.9.2, someone can telnet to a thrift port and leave it open, and prevent a thrift server from ever shutting down.  It should not be possible for the client to impose this level of control on the server.  The server should be the authority in stop behavior.  I need to fix this in order to upgrade a project using the older patch (first comment) and I am starting on this today.&lt;/p&gt;</comment>
                            <comment id="14388768" author="ben.craig" created="Tue, 31 Mar 2015 16:14:59 +0000"  >&lt;p&gt;I agree that the issue is a real one, and should be fixed (or at least give clients a path to making it work right).  It has caused me some issues in the past as well.  The solution I chose at the time was to use a different server type that was already based on select().  That server type hasn&apos;t been upstreamed though, so it doesn&apos;t really help you out.&lt;/p&gt;</comment>
                            <comment id="14389405" author="jking3" created="Tue, 31 Mar 2015 21:03:56 +0000"  >&lt;p&gt;Reviewing the &lt;tt&gt;TServerTransport&lt;/tt&gt; class I find the comment on &lt;tt&gt;interrupt()&lt;/tt&gt; interesting:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  /**
   * For &quot;smart&quot; TServerTransport implementations that work in a multi
   * threaded context this can be used to break out of an accept() call.
   * It is expected that the transport will throw a TTransportException
   * with the interrupted error code.
   */
  virtual void interrupt() {}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Can any one define what a &quot;smart&quot; implementation is (as opposed to one that is not) and why it would need to break out of an accept() call for any reason other than shutting down?&lt;/p&gt;</comment>
                            <comment id="14389585" author="codesf" created="Tue, 31 Mar 2015 23:03:56 +0000"  >&lt;p&gt;The interrupt() method allows the TServerSocket to be well encapsulated. It owns the listening socket and handles socket all actions on the socket (like closing). A server might call TServerSocket::interrupt() to break out of the accept call and stop accepting connections (in a pause type of operation) without disconnecting existing clients or closing the listening socket. The server could then again call accept() on the TSocketServer when it would like to once again begin accepting connections, in the meantime connections would backlog up to the backlog limit. &lt;/p&gt;

&lt;p&gt;For example TSimpleServer, TThreadedServer and TThreadPoolServer all trap TTransportException::INTERRUPTED exceptions during serve() processing (though they just continue after the catch). Apache Thrift is a framework though and you do not have to use the prebuilt servers to leverage the framework. Thus TServerSocket needs to be a well encapsulated and generally useful class for encapsulating listening sockets. You may choose not to use the prebuilt servers but find TServerSocket useful (this discussion and those like it are exactly why many roll their own servers).&lt;/p&gt;</comment>
                            <comment id="14390255" author="roger.meier" created="Wed, 1 Apr 2015 09:06:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ben.craig&quot; class=&quot;user-hover&quot; rel=&quot;ben.craig&quot;&gt;ben.craig&lt;/a&gt; feel free to revert to commit and provide a better option.&lt;br/&gt;
-roger&lt;/p&gt;</comment>
                            <comment id="14390576" author="jking3" created="Wed, 1 Apr 2015 13:56:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roger.meier&quot; class=&quot;user-hover&quot; rel=&quot;roger.meier&quot;&gt;roger.meier&lt;/a&gt; the patch that was pulled in providing stop() inside TThreadedServer.cpp works against 0.8.0 (although incorrect as this discussion shows) but against 0.9.2, TThreadedServer.h provides stop() so this won&apos;t even compile.  It should be backed out, pending a working solution folks agree is acceptable.&lt;/p&gt;</comment>
                            <comment id="14390581" author="jking3" created="Wed, 1 Apr 2015 13:59:38 +0000"  >&lt;p&gt;Let&apos;s discuss a potential solution to this issue:&lt;/p&gt;

&lt;p&gt;1. Create transport/TInterruptable, providing interrupt(), returns&lt;br/&gt;
   a boolean indicating if interrupt is supported.&lt;/p&gt;

&lt;p&gt;2. Change TServerTransport to inherit from interrupt().&lt;/p&gt;

&lt;p&gt;3. Change TTransport to inherit from interrupt().&lt;/p&gt;

&lt;p&gt;4. Add a mechanism in TSocket that is similar to TServerSocket for&lt;br/&gt;
   interruption.  Each client TSocket behavior will remain fully&lt;br/&gt;
   encapsulated.  Possibly extract this common shared behavior to&lt;br/&gt;
   another class.&lt;/p&gt;

&lt;p&gt;5. Change TSocket::read to select and recv, and handle interrupt&lt;br/&gt;
   in much the same way that TServerSocket does.&lt;/p&gt;

&lt;p&gt;6. Fix up each TServer to properly handle stop() by ending its serve(),&lt;br/&gt;
   which must guarantee that the server transport and all tracked client&lt;br/&gt;
   transports/tasks are interrupted and then closed before returning.&lt;/p&gt;

&lt;p&gt;Stop will therefore happen like this (with TThreadedServer):&lt;/p&gt;

&lt;p&gt;1. TThreadedServer implements stop() which sets a stop flag and&lt;br/&gt;
   then calls interrupt() on the TServerTransport.&lt;br/&gt;
   This is existing behavior.&lt;/p&gt;

&lt;p&gt;2. stop() joins to the TThreadedServer serve() thread.&lt;br/&gt;
   stop() will not return until things have actually stopped.&lt;br/&gt;
   This is new behavior.&lt;/p&gt;

&lt;p&gt;3. The interrupt unblocks the TServerTransport accept and that in turn&lt;br/&gt;
   throws a TTransportException of type INTERRUPTED.&lt;br/&gt;
   This is existing behavior.&lt;/p&gt;

&lt;p&gt;4. TServerTransport::serve() falls out of the processing loop.&lt;br/&gt;
   In handling the INTERRUPTED if the stop_ flag is set, serve()&lt;br/&gt;
   proceeds to teardown.&lt;br/&gt;
   This is new behavior.&lt;/p&gt;

&lt;p&gt;5. serve() teardown iterates each Task and interrupts it.  This means&lt;br/&gt;
   each Task is a TInterruptable, and interrupt is asynchronous.&lt;br/&gt;
   This is new behavior.&lt;/p&gt;

&lt;p&gt;6. serve() blocks on a drain event.&lt;br/&gt;
   This is existing behavior.&lt;/p&gt;

&lt;p&gt;7. Each Task blocked in recv is interrupted and throws a TTransportException&lt;br/&gt;
   of type INTERRUPTED.&lt;br/&gt;
   This is new behavior.&lt;/p&gt;

&lt;p&gt;8. Each Task falls out of its processing loop and closes the transport.&lt;br/&gt;
   When the last task disappears, the drain event is set.&lt;br/&gt;
   This is existing behavior.&lt;/p&gt;

&lt;p&gt;9. serve() unblocks on the drain event and returns.&lt;/p&gt;

&lt;p&gt;10. TThreadedServer::stop joins as serve() returns and stop is complete.&lt;/p&gt;

&lt;p&gt;Discussion points:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Did not provide a way to maintain the current behavior of blocking stop() until&lt;br/&gt;
  all clients disconnect.  I view this as a defect, however it is the current behavior.&lt;br/&gt;
  Is it a requirement to be able to continue to provide this behavior?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Each TSocket will have its own SOCKET_PAIR to facilitate interruption.&lt;br/&gt;
  This is fully encapsulated, but it also requires more resources.  &lt;br/&gt;
  Would this count as 3 open file descriptors per client instead of one?&lt;br/&gt;
  Is that acceptable, or should the TServer provide each TTransport with a common way&lt;br/&gt;
  to be interrupted that is transport-agnostic?  That would be substantially&lt;br/&gt;
  more work.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14391440" author="ben.craig" created="Wed, 1 Apr 2015 20:53:32 +0000"  >&lt;p&gt;&quot;Did not provide a way to maintain the current behavior of blocking stop() until&lt;br/&gt;
all clients disconnect. I view this as a defect, however it is the current behavior.&lt;br/&gt;
Is it a requirement to be able to continue to provide this behavior?&quot;&lt;/p&gt;

&lt;p&gt;As stated, no, it is not a requirement that stop() block until all clients disconnect.  What is a requirement though is to continue providing a version of read() that only makes one system call to recv(), and not two calls (one to select() and one to recv()).&lt;/p&gt;


&lt;p&gt;&quot;Would this count as 3 open file descriptors per client instead of one?&quot;&lt;/p&gt;

&lt;p&gt;Yes it would.  I&apos;ve had that cause problems before.&lt;/p&gt;


&lt;p&gt;&quot;Is that acceptable, or should the TServer provide each TTransport with a common way&lt;br/&gt;
to be interrupted that is transport-agnostic?&quot;&lt;/p&gt;

&lt;p&gt;I know of no such method.  On Windows, sockets are very different from named pipes, and I don&apos;t know of a way to wait on both at the same time without spawning off extra threads or entirely abandoning the bsd socket implementation.&lt;/p&gt;





&lt;p&gt;I do like the idea of a ServerTransport&apos;s interrupt causing child Transports to get interrupted.  I think that would make it easier for there to be a bool somewhere on the server transport to turn off the behavior in order to regain performance.&lt;/p&gt;

&lt;p&gt;So here&apos;s my counter proposal...&lt;/p&gt;

&lt;p&gt;1. Add a constructor to TSocket... TSocket(THRIFT_SOCKET real_socket, THRIFT_SOCKET death_listener)&lt;br/&gt;
2. Add a getter / setter to TServerSocket to allow people to disable the behavior.  My preference is that the new, robust, but slow behavior be the default.&lt;br/&gt;
3. Inside TServerSocket::createSocket, check the above flag.  If you want the old behavior, call the one-socket constructor.  If you want the new behavior, call the two-socket constructor with intSock2_ as the death_listener.&lt;br/&gt;
4. Inside of TSocker, base which read behavior you want on whether death_listener was set or not.&lt;/p&gt;

&lt;p&gt;Other transports may need to do more elaborate book keeping instead of just passing around an extra socket descriptor, but this leaves the exact mechanism up to those implementations.&lt;/p&gt;
</comment>
                            <comment id="14391544" author="jking3" created="Wed, 1 Apr 2015 21:49:49 +0000"  >&lt;p&gt;That seems reasonable, however the interrupt mechanism in TServerSocket does not know if it is being interrupted or being stopped.  Per Randy&apos;s provided use case we need to maintain that functionality, so it would be necessary to add a stop() method that first sets a boolean stop flag, and then calls interrupt in much the same way.  It would also be necessary to have the death_listener be a third socket pair that is independent of the interrupt socket pair, where the server socket owns the sending side and the server socket + client sockets communally own the receiving side of the death_listener, and the clients do not attempt to read off it to clear the condition when it is set.  For that reason I would make the death_listener a shared pointer with a custom deletion method to allow the server socket to complete stop() and return to the TServer&apos;s stop, which will in turn exit the main serve() loop and cause the TThreadedServer to wait for the drain event it already has (all tasks, i.e. all clients, drained).  As the last TSocket child of that particular TServerSocket is destroyed, that death_listener socket will destroy itself.&lt;/p&gt;

&lt;p&gt;This isolates the majority of the changes to TServerSocket and TSocket without needing to touch TServerTransport, TTransport, or TServer.  Not certain how to translate this to Windows yet.&lt;/p&gt;

&lt;p&gt;It is a shame that the socket shutdown() call does not unblock a recv call.  That would atomically set the socket to a state where recv cannot be called again, and break it out of the loop, and allow it to be closed safely.&lt;/p&gt;</comment>
                            <comment id="14391596" author="codesf" created="Wed, 1 Apr 2015 22:16:48 +0000"  >&lt;p&gt;+1 for any patches involving identifiers with the name &quot;death_listener&quot;&lt;/p&gt;</comment>
                            <comment id="14392880" author="ben.craig" created="Thu, 2 Apr 2015 16:00:06 +0000"  >&lt;p&gt;I think we&apos;re converging on a great answer.  Thanks for being patient with me &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.  I&apos;ll pick apart this reply now, and offer some suggestions on the details.&lt;/p&gt;

&lt;p&gt;&quot;It would also be necessary to have the death_listener be a third socket pair that is independent of the interrupt socket pair, where the server socket owns the sending side and the server socket + client sockets communally own the receiving side of the death_listener, and the clients do not attempt to read off it to clear the condition when it is set. &quot;&lt;/p&gt;

&lt;p&gt;I think this is a reasonable middle ground.  A server socket is &quot;fat&quot; in that it creates five file descriptors, but each connected client only makes one additional file descriptor (as opposed to the three additional that prior proposals required).&lt;/p&gt;

&lt;p&gt;&quot;Per Randy&apos;s provided use case we need to maintain that functionality, so it would be necessary to add a stop() method that first sets a boolean stop flag, and then calls interrupt in much the same way.&quot;&lt;/p&gt;

&lt;p&gt;So here are the two big source compatibility cases that we need to watch out for...&lt;br/&gt;
Pre-existing custom transport used with TThreadedServer&lt;br/&gt;
TServerSocket and TSocket used with a custom server&lt;/p&gt;

&lt;p&gt;Here&apos;s an approach that might fix both...&lt;br/&gt;
1. In TServerTransport, add a virtual method &quot;interruptServerAndChildren()&quot;, and give it a default implementation that just forwards directly to &quot;interrupt()&quot;&lt;br/&gt;
   a. The default implementation is important so that we don&apos;t break custom transports&lt;br/&gt;
2. Implement &quot;interruptServerAndChildren()&quot; in TServerSocket such that it calls &quot;interrupt()&quot;, then writes to the extra socket pair that children are listening to.&lt;br/&gt;
   a. This leaves the semantics of &quot;interrupt()&quot; untouched, so that old servers still do the same thing&lt;br/&gt;
3. Retrofit TThreadedServer, TThreadPoolServer, and TSimpleServer so that they call &quot;interruptServerAndChildren()&quot; instead of &quot;interrupt()&quot;.&lt;br/&gt;
   a. TNonBlockingServer is its own special beast.  Messing with that seems like it is out of the scope of these changes.&lt;/p&gt;

&lt;p&gt;&quot;For that reason I would make the death_listener a shared pointer with a custom deletion method...&quot;&lt;br/&gt;
Yep, sounds great.  Nice catch on lifetime management of this particular resource.&lt;/p&gt;</comment>
                            <comment id="14392929" author="jking3" created="Thu, 2 Apr 2015 16:44:13 +0000"  >&lt;p&gt;The only gotcha I see in this is that the socket-specific server transport needs to know at creation time of the accepted client whether it is able to interrupt the client or not, per your requirement that we maintain the old behavior for folks who cannot tolerate the performance hit of the select call.  This is however an implementation detail of the solution we&apos;ve been discussing.  If we can remove the requirement to maintain the previous behavior then we could do as you suggest; the death_listener would always exist and be used, and would only be used by the TServers provided by the project until anyone&apos;s custom implementation caught up, otherwise I think it would make more sense to follow your previous suggestion and encapsulate this logic as a contract between TServerSocket and TSocket.&lt;/p&gt;

&lt;p&gt;I believe your previous suggestion was already backwards compatible, since this new behavior would only be triggered by a call to stop() on the TServerTransport.  A call to interrupt() would behave the same as it does today so custom TServer implementations could continue to use interrupt() if they want.  I would add stop() to TServerTransport as well as something to indicate whether the lifetime of the children of the server transport are tied to the lifetime of the server transport, and change the three TServer implementations to call stop() instead of interrupt(); the implementer can decide the behavior by setting it on the TServerSocket, and the default would be to have the lifetime of the child transports managed by the server transport.&lt;/p&gt;
</comment>
                            <comment id="14393112" author="ben.craig" created="Thu, 2 Apr 2015 18:33:23 +0000"  >&lt;p&gt;I guess I skipped a few items in my approach.  Here they come now...&lt;br/&gt;
4. Add a &apos;death_listener&apos; constructor to TSocket.  This is in addition to the current THRIFT_SOCKET TSocket constructor.&lt;br/&gt;
a. If the death_listener constructor is used, read will have an extra select call.  If the single argument THRIFT_SOCKET constructor is used, read will not have the extra select call.&lt;br/&gt;
5. Add a &apos;enableChildInterruption(bool)&apos; function on TServerSocket.  This is pretty much the &apos;setter&apos; from my first proposal.&lt;br/&gt;
a. If child interruption is enabled, the death_listener TSocket constructor will be used during accept.  If child interruption is disabled, the single argument THRIFT_SOCKET constructor is used.&lt;br/&gt;
b. Regardless of the &apos;enableChildInterruption&apos; state, interruptServerAndChildren() would write to the death_writer end of the socket_pair.  There may not be anyone listening though.&lt;/p&gt;

&lt;p&gt;I think I prefer the name &apos;interruptServerAndChildren()&apos; to &apos;stop()&apos;.  TServerTransport already has an interrupt() and a close() method, and it would be really confusing to have a method named stop().  It isn&apos;t clear in that case how stop() relates to close() and interrupt().  I think the longer name better conveys the relation between the methods.  I do think that both of us are talking about the same method though, we are just calling it different things.&lt;/p&gt;</comment>
                            <comment id="14393216" author="jking3" created="Thu, 2 Apr 2015 19:27:48 +0000"  >&lt;p&gt;I was able to eliminate the need for a stop() call in TServerTransport and TServerSocket.  It was sufficient to put the behavior into TServerSocket::close().  I named it TServerSocket::setInterruptClientsOnClose(bool).  I believe we&apos;re on the same page.  There was very little change to TServerSocket.  TSocket on the other hand has a crazy complex read loop.  I think I put in the right sequence of branches to handle all the cases, but this one&apos;s going to need a lot of review and consideration.  I added some unit testing for TServerSocket into my pull request for &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1025&quot; title=&quot;C++ ServerSocket should inherit from Socket with the necessary Ctor to listen on connections from a specific host (similar to perl library)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1025&quot;&gt;&lt;del&gt;THRIFT-1025&lt;/del&gt;&lt;/a&gt; and I was hoping I would be able to use that to help test this...&lt;/p&gt;</comment>
                            <comment id="14393274" author="jking3" created="Thu, 2 Apr 2015 20:03:18 +0000"  >&lt;p&gt;I realized that I could handle everything except the TSimpleServer with the changes I made, as they all relied on there being a separate thread for accept than for the client.  I&apos;ve implemented your suggested changes and I&apos;m starting some testing of the solution.&lt;/p&gt;</comment>
                            <comment id="14393314" author="jking3" created="Thu, 2 Apr 2015 20:22:37 +0000"  >&lt;p&gt;interrupt() means the TServerTransport breaks out of a blocking call and throws TTransportException(INTERRUPTED).&lt;/p&gt;

&lt;p&gt;So it makes sense that interruptServerAndChildren() would cause both the server and every child to do the same thing.&lt;br/&gt;
Unfortunately there is no precedent for handling INTERRUPTED in TServer/TTransport(child) processing loops.  If anyone is providing their own TServer, they may not expect INTERRUPTED in the processor loop and that may turn into an error message.&lt;/p&gt;

&lt;p&gt;Do you think it is better to maintain the meaning of interrupt() and throw an INTERRUPTED from the child read() and let people update their server implementations to handle this without an error, or is it better to return 0 from the TTransport::read() when interrupted and let all existing TServers (Thrift&#8217;s and third party) to handle it as if the client disconnected?  My concern about the latter is that is makes &#8220;interrupt&#8221; mean something different for the clients than it does for the server, and it should really mean the same thing.  I&apos;m going to proceed with the child, if interrupted, throw a TTransportException(INTERRUPTED) and update the three TServers to ignore this (right now they would log it because it isn&apos;t END_OF_FILE).&lt;/p&gt;</comment>
                            <comment id="14393488" author="jking3" created="Thu, 2 Apr 2015 21:38:43 +0000"  >&lt;p&gt;I have attached a preview patch (not complete - for example no specific tests for disabling the new functionality, but passes build and test).  It may not apply cleanly to 0.9.2 or thrift:master as this patch was made on top of some other patches on the machine I generated it on, but this should be enough for an early preview to ensure all are happy with the direction.&lt;/p&gt;

&lt;p&gt;Key difference from the discussion is that there is no interruptServerAndChildren() call, but instead there is an interruptChildren() call, and the TServer implementations stop() methods call interrupt() then interruptChildren().  If a TServerTransport doesn&apos;t support interruptChildren() then it will behave the way it used to.&lt;/p&gt;

&lt;p&gt;I am also planning on taking the three per-client processing loops found in TSimpleServer, TThreadedServer, and TThreadPoolServer and consolidating the common code there (by adding a TConnectedClient class).  This would have simplified maintenance I needed to do on the three TServers, and will bring consistency to the exception handling among them.  This will be in the next patch / pull request.&lt;/p&gt;</comment>
                            <comment id="14394389" author="ben.craig" created="Fri, 3 Apr 2015 13:07:22 +0000"  >&lt;p&gt;I approve of the direction of this patch.  &lt;/p&gt;

&lt;p&gt;I like that you split &apos;interruptServerAndChildren()&apos; into the old &apos;interrupt()&apos; and &apos;interruptChildren()&apos;.  I think that&apos;s better than what I was suggesting earlier.  There is still one mention of &apos;interruptServerAndChildren()&apos; in the TServerSocket comments that you will want to fix, but in general, I&apos;m happy with how this has gone.&lt;/p&gt;

&lt;p&gt;&quot;I am also planning on taking the three per-client processing loops found in TSimpleServer, TThreadedServer, and TThreadPoolServer and consolidating the common code there (by adding a TConnectedClient class). This would have simplified maintenance I needed to do on the three TServers, and will bring consistency to the exception handling among them. This will be in the next patch / pull request.&quot;&lt;/p&gt;

&lt;p&gt;I think this is a good idea... but I would prefer it be in a different ticket and patch.  That will make it easier for me (and others) to review.  When a patch is intended to change behavior, I like to focus on the changes to behavior.  When a patch is intended to clean things up, I like to focus on how behavior hasn&apos;t changed.  Mixing the two gets rough.&lt;/p&gt;</comment>
                            <comment id="14394525" author="jking3" created="Fri, 3 Apr 2015 14:46:28 +0000"  >&lt;p&gt;I opened &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3081&quot; title=&quot;C++ Consolidate client processing loops in TServers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3081&quot;&gt;&lt;del&gt;THRIFT-3081&lt;/del&gt;&lt;/a&gt; to track that change.  Can we get &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1025&quot; title=&quot;C++ ServerSocket should inherit from Socket with the necessary Ctor to listen on connections from a specific host (similar to perl library)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1025&quot;&gt;&lt;del&gt;THRIFT-1025&lt;/del&gt;&lt;/a&gt; reviewed and merged into the project so that I can finalize a pull request for this one (with tests)?&lt;/p&gt;</comment>
                            <comment id="14394778" author="jking3" created="Fri, 3 Apr 2015 17:57:17 +0000"  >&lt;p&gt;In each of the three threaded servers we call process() then we call peek().  Can someone describe why the peek is needed?  It would seem to me that process() will be sufficient as it will go fetch the next message from the connection if it&apos;s there.  Is calling peek() an inefficiency we can remove from these?&lt;/p&gt;

&lt;p&gt;Motivation here is that if it cannot be removed then I need to perform a select on the recv(MSG_PEEK) in TSocket::peek() too, which means every loop through a message is guaranteed to be poll/recv(peek)/poll/recv(noflags).&lt;/p&gt;</comment>
                            <comment id="14394837" author="ben.craig" created="Fri, 3 Apr 2015 18:23:23 +0000"  >&lt;p&gt;I don&apos;t know why the peek is there.  In the server class that I have written, I did not include the peek call, and things seemed to work fine with Windows named pipes, and sockets on all platforms.&lt;/p&gt;</comment>
                            <comment id="14394851" author="jking3" created="Fri, 3 Apr 2015 18:30:07 +0000"  >&lt;p&gt;I rewrote peek to use THRIFT_POLL instead of recv(MSG_PEEK) so it can optionally interrupt based on the work we&apos;ve discussed.  Given this is the hot path for reads, I&apos;m going to try an experiment at some point and get rid of peek all together to see if things &quot;just work&quot;.  I suspect peek was put there to deal with incorrect disconnect handling or some other bug in the code, and it got left there.  This will end up as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3081&quot; title=&quot;C++ Consolidate client processing loops in TServers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3081&quot;&gt;&lt;del&gt;THRIFT-3081&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14395519" author="jking3" created="Sat, 4 Apr 2015 04:04:58 +0000"  >&lt;p&gt;I&apos;m separating the test so that it does not depend on changes made in &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1025&quot; title=&quot;C++ ServerSocket should inherit from Socket with the necessary Ctor to listen on connections from a specific host (similar to perl library)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1025&quot;&gt;&lt;del&gt;THRIFT-1025&lt;/del&gt;&lt;/a&gt; so that these two can be independent in terms of getting in a pull request.&lt;/p&gt;</comment>
                            <comment id="14395897" author="githubbot" created="Sat, 4 Apr 2015 19:34:08 +0000"  >&lt;p&gt;GitHub user jeking3 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; prevent client connections from delaying server stop&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jeking3/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jeking3/thrift&lt;/a&gt; bugfix/&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt;-disconnect-clients-on-server-stop&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #424&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 4113f4f50bc4a6a1488b56db14a15e96527c44a7&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-04T19:26:54Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; prevent client connections from delaying server stop&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14481296" author="githubbot" created="Mon, 6 Apr 2015 15:13:50 +0000"  >&lt;p&gt;GitHub user jeking3 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/428&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/428&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Bugfix/thrift 3081 consolidate client processing loops&lt;/p&gt;

&lt;p&gt;    The pull request consolidates the client processing loop contained within TSimpleServer, TThreadedServer, TThreadPoolServer that were all similar but not functionally identical.  This will improve maintainability.&lt;/p&gt;

&lt;p&gt;    This pull request and the open one for &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; will collide slightly.  Whichever one gets pulled in first, I will update the other...&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jeking3/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jeking3/thrift&lt;/a&gt; bugfix/&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3081&quot; title=&quot;C++ Consolidate client processing loops in TServers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3081&quot;&gt;&lt;del&gt;THRIFT-3081&lt;/del&gt;&lt;/a&gt;-consolidate-client-processing-loops&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/428.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/428.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #428&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 44713020d03c38776432642d0798ea8d9f3e4168&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-05T16:32:03Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3081&quot; title=&quot;C++ Consolidate client processing loops in TServers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3081&quot;&gt;&lt;del&gt;THRIFT-3081&lt;/del&gt;&lt;/a&gt; consolidate C++ client processing loops&lt;/p&gt;

&lt;p&gt;commit 3cc72ce101f2214b5b9698473523a93820219388&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-06T15:10:50Z&lt;/p&gt;

&lt;p&gt;    Merge branch &apos;master&apos; of &lt;a href=&quot;https://github.com/apache/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift&lt;/a&gt; into bugfix/&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3081&quot; title=&quot;C++ Consolidate client processing loops in TServers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3081&quot;&gt;&lt;del&gt;THRIFT-3081&lt;/del&gt;&lt;/a&gt;-consolidate-client-processing-loops&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14481322" author="jking3" created="Mon, 6 Apr 2015 15:42:58 +0000"  >&lt;p&gt;Please ignore item 428, it is for &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3081&quot; title=&quot;C++ Consolidate client processing loops in TServers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3081&quot;&gt;&lt;del&gt;THRIFT-3081&lt;/del&gt;&lt;/a&gt; however I mentioned this one in the pull request notes and the github asf bot tagged it to this instead.&lt;/p&gt;</comment>
                            <comment id="14487599" author="jking3" created="Thu, 9 Apr 2015 16:18:56 +0000"  >&lt;p&gt;What&apos;s the next step I need to do in order to move this forward?&lt;/p&gt;</comment>
                            <comment id="14487648" author="ben.craig" created="Thu, 9 Apr 2015 16:48:29 +0000"  >&lt;p&gt;oh, sorry about that.  I wasn&apos;t sure if this had become stable or not.  I will try to review it over the next couple of days.&lt;/p&gt;</comment>
                            <comment id="14487663" author="jking3" created="Thu, 9 Apr 2015 16:58:27 +0000"  >&lt;p&gt;Note that although peek had to take the heavier poll then recv as well, I&apos;ve removed it from the consolidated client processing loop in &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3081&quot; title=&quot;C++ Consolidate client processing loops in TServers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3081&quot;&gt;&lt;del&gt;THRIFT-3081&lt;/del&gt;&lt;/a&gt;, so when combined with that change the end result is exactly as we discussed; if the new functionality is enabled (it is by default) there will be a poll then a recv per data in.  With the feature disabled, it goes back to the way it was.  So:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; + &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3081&quot; title=&quot;C++ Consolidate client processing loops in TServers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3081&quot;&gt;&lt;del&gt;THRIFT-3081&lt;/del&gt;&lt;/a&gt; = poll then recv per read loop&lt;br/&gt;
Existing code without these changes = recv + recv(PEEK) per read loop&lt;/p&gt;

&lt;p&gt;This means the number of syscalls won&apos;t change if we take both.  The other one is also ready for review. :&amp;gt;&lt;/p&gt;</comment>
                            <comment id="14488717" author="githubbot" created="Fri, 10 Apr 2015 01:26:59 +0000"  >&lt;p&gt;Github user ben-craig commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#discussion_r28117469&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#discussion_r28117469&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/server/TThreadPoolServer.h &amp;#8212;&lt;br/&gt;
    @@ -105,19 +105,16 @@ class TThreadPoolServer : public TServer {&lt;br/&gt;
           timeout_(0),&lt;br/&gt;
           taskExpiration_(0) {}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;virtual ~TThreadPoolServer();&lt;br/&gt;
    +  virtual ~TThreadPoolServer() {}
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This is nit-picky... but I would prefer you revert this particular change.  Please leave the virtual dtor out-of-lined.  An inlined virtual destructor can cause significant object size bloat.  This doesn&apos;t end up leaking into final binaries, but it can make build times and file copy times longer.&lt;/p&gt;</comment>
                            <comment id="14488726" author="githubbot" created="Fri, 10 Apr 2015 01:36:11 +0000"  >&lt;p&gt;Github user ben-craig commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#discussion_r28117754&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#discussion_r28117754&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/test/TServerSocketTest.cpp &amp;#8212;&lt;br/&gt;
    @@ -46,7 +40,8 @@ BOOST_AUTO_TEST_CASE( test_bind_to_address )&lt;br/&gt;
         accepted-&amp;gt;close();&lt;br/&gt;
         sock1.close();&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TServerSocket sock2(&quot;this.is.truly.an.unrecognizable.address.&quot;, m_serverPort);&lt;br/&gt;
    +    std::cout &amp;lt;&amp;lt; &quot;An error message from getaddrinfo on the console is expected:&quot; &amp;lt;&amp;lt; std::endl;&lt;br/&gt;
    +    TServerSocket sock2(&quot;257.258.259.260&quot;, m_serverPort);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Are you sure this IP address isn&apos;t real?  I think I saw someone use it on a TV show.&lt;/p&gt;

&lt;p&gt;    /kidding&lt;/p&gt;</comment>
                            <comment id="14488729" author="githubbot" created="Fri, 10 Apr 2015 01:39:01 +0000"  >&lt;p&gt;Github user ben-craig commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#discussion_r28117844&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#discussion_r28117844&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/test/TSocketInterruptTest.cpp &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,147 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements. See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership. The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License. You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *   &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing,&lt;br/&gt;
    + * software distributed under the License is distributed on an&lt;br/&gt;
    + * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY&lt;br/&gt;
    + * KIND, either express or implied. See the License for the&lt;br/&gt;
    + * specific language governing permissions and limitations&lt;br/&gt;
    + * under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +#define BOOST_TEST_MODULE TSocketInterruptTest&lt;br/&gt;
    +#include &amp;lt;boost/test/auto_unit_test.hpp&amp;gt;&lt;br/&gt;
    +&lt;br/&gt;
    +#include &amp;lt;boost/bind.hpp&amp;gt;&lt;br/&gt;
    +#include &amp;lt;boost/chrono/duration.hpp&amp;gt;&lt;br/&gt;
    +#include &amp;lt;boost/date_time/posix_time/posix_time_duration.hpp&amp;gt;&lt;br/&gt;
    +#include &amp;lt;boost/thread/thread.hpp&amp;gt;&lt;br/&gt;
    +#include &amp;lt;thrift/transport/TSocket.h&amp;gt;&lt;br/&gt;
    +#include &amp;lt;thrift/transport/TServerSocket.h&amp;gt;&lt;br/&gt;
    +#include &quot;TestPortFixture.h&quot;&lt;br/&gt;
    +#include &quot;TestTServerSocket.h&quot;&lt;br/&gt;
    +&lt;br/&gt;
    +using apache::thrift::transport::TServerSocket;&lt;br/&gt;
    +using apache::thrift::transport::TSocket;&lt;br/&gt;
    +using apache::thrift::transport::TTransport;&lt;br/&gt;
    +using apache::thrift::transport::TTransportException;&lt;br/&gt;
    +&lt;br/&gt;
    +BOOST_FIXTURE_TEST_SUITE ( TSocketInterruptTest, TestPortFixture )&lt;br/&gt;
    +&lt;br/&gt;
    +void readerWorker(boost::shared_ptr&amp;lt;TTransport&amp;gt; tt, uint32_t expectedResult)&lt;br/&gt;
    +&lt;/p&gt;
{
    +    uint8_t buf[4];
    +    BOOST_CHECK_EQUAL(expectedResult, tt-&amp;gt;read(buf, 4));
    +}
&lt;p&gt;    +&lt;br/&gt;
    +void readerWorkerMustThrow(boost::shared_ptr&amp;lt;TTransport&amp;gt; tt)&lt;br/&gt;
    +{&lt;br/&gt;
    +    try&lt;br/&gt;
    +    &lt;/p&gt;
{
    +        uint8_t buf[4];
    +        tt-&amp;gt;read(buf, 4);
    +        BOOST_ERROR(&quot;should not have gotten here&quot;);
    +    }
&lt;p&gt;    +    catch (const TTransportException&amp;amp; tx)&lt;br/&gt;
    +    &lt;/p&gt;
{
    +        BOOST_CHECK_EQUAL(TTransportException::INTERRUPTED, tx.getType());
    +    }
&lt;p&gt;    +}&lt;br/&gt;
    +&lt;br/&gt;
    +BOOST_AUTO_TEST_CASE( test_interruptable_child_read )&lt;br/&gt;
    +{&lt;br/&gt;
    +    TestTServerSocket sock1(&quot;localhost&quot;, m_serverPort);&lt;br/&gt;
    +    sock1.listen();&lt;br/&gt;
    +    TSocket clientSock(&quot;localhost&quot;, m_serverPort);&lt;br/&gt;
    +    clientSock.open();&lt;br/&gt;
    +    boost::shared_ptr&amp;lt;TTransport&amp;gt; accepted = sock1.acceptImpl();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This should really be &apos;accept()&apos; and not &apos;acceptImpl()&apos;.&lt;/p&gt;</comment>
                            <comment id="14488735" author="githubbot" created="Fri, 10 Apr 2015 01:43:14 +0000"  >&lt;p&gt;Github user ben-craig commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#discussion_r28117983&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#discussion_r28117983&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/test/TestTServerSocket.h &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,31 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements. See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership. The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License. You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *   &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing,&lt;br/&gt;
    + * software distributed under the License is distributed on an&lt;br/&gt;
    + * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY&lt;br/&gt;
    + * KIND, either express or implied. See the License for the&lt;br/&gt;
    + * specific language governing permissions and limitations&lt;br/&gt;
    + * under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +#pragma once&lt;br/&gt;
    +&lt;br/&gt;
    +#include &amp;lt;thrift/transport/TServerSocket.h&amp;gt;&lt;br/&gt;
    +&lt;br/&gt;
    +class TestTServerSocket : public apache::thrift::transport::TServerSocket&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I am confused.  Why is this class necessary?  It doesn&apos;t seem like it is adding anything of use.&lt;/p&gt;

&lt;p&gt;    I recommend either commenting why you need / want it in the code, or deleting it.&lt;/p&gt;</comment>
                            <comment id="14488738" author="githubbot" created="Fri, 10 Apr 2015 01:46:08 +0000"  >&lt;p&gt;Github user ben-craig commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#issuecomment-91397955&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#issuecomment-91397955&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    All of the concerns I have with this request are minor.  Once these are fixed, I give it a +1.  Note that the out-of-line destructor comment applies to the other destructors that got inlined.&lt;/p&gt;

&lt;p&gt;    I will not personally be able to do the commit for another week or two, but if someone else is able to (after these fixes), then I will be much appreciative.&lt;/p&gt;</comment>
                            <comment id="14488816" author="githubbot" created="Fri, 10 Apr 2015 03:14:14 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#discussion_r28120420&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#discussion_r28120420&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/server/TThreadPoolServer.h &amp;#8212;&lt;br/&gt;
    @@ -105,19 +105,16 @@ class TThreadPoolServer : public TServer {&lt;br/&gt;
           timeout_(0),&lt;br/&gt;
           taskExpiration_(0) {}&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;virtual ~TThreadPoolServer();&lt;br/&gt;
    +  virtual ~TThreadPoolServer() {}
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I did this so that it would be the same as other classes in the project, as TSimpleServer and TThreadedServer do this.  If I change this I would change all three servers to be the same.&lt;/p&gt;

&lt;p&gt;    Personally, I don&apos;t like having implementations in headers at all even if they are trivial, because when you need to change the implementation (and not the signature of the call) you end up rebuilding too much.&lt;/p&gt;</comment>
                            <comment id="14488819" author="githubbot" created="Fri, 10 Apr 2015 03:15:09 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#discussion_r28120438&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#discussion_r28120438&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/test/TServerSocketTest.cpp &amp;#8212;&lt;br/&gt;
    @@ -46,7 +40,8 @@ BOOST_AUTO_TEST_CASE( test_bind_to_address )&lt;br/&gt;
         accepted-&amp;gt;close();&lt;br/&gt;
         sock1.close();&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;TServerSocket sock2(&quot;this.is.truly.an.unrecognizable.address.&quot;, m_serverPort);&lt;br/&gt;
    +    std::cout &amp;lt;&amp;lt; &quot;An error message from getaddrinfo on the console is expected:&quot; &amp;lt;&amp;lt; std::endl;&lt;br/&gt;
    +    TServerSocket sock2(&quot;257.258.259.260&quot;, m_serverPort);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Initially I used a bogus DNS name however it took 15 seconds to fail.  This was much faster. :&amp;gt;&lt;/p&gt;</comment>
                            <comment id="14488823" author="githubbot" created="Fri, 10 Apr 2015 03:15:54 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#discussion_r28120466&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#discussion_r28120466&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/test/TSocketInterruptTest.cpp &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,147 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements. See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership. The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License. You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *   &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing,&lt;br/&gt;
    + * software distributed under the License is distributed on an&lt;br/&gt;
    + * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY&lt;br/&gt;
    + * KIND, either express or implied. See the License for the&lt;br/&gt;
    + * specific language governing permissions and limitations&lt;br/&gt;
    + * under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +#define BOOST_TEST_MODULE TSocketInterruptTest&lt;br/&gt;
    +#include &amp;lt;boost/test/auto_unit_test.hpp&amp;gt;&lt;br/&gt;
    +&lt;br/&gt;
    +#include &amp;lt;boost/bind.hpp&amp;gt;&lt;br/&gt;
    +#include &amp;lt;boost/chrono/duration.hpp&amp;gt;&lt;br/&gt;
    +#include &amp;lt;boost/date_time/posix_time/posix_time_duration.hpp&amp;gt;&lt;br/&gt;
    +#include &amp;lt;boost/thread/thread.hpp&amp;gt;&lt;br/&gt;
    +#include &amp;lt;thrift/transport/TSocket.h&amp;gt;&lt;br/&gt;
    +#include &amp;lt;thrift/transport/TServerSocket.h&amp;gt;&lt;br/&gt;
    +#include &quot;TestPortFixture.h&quot;&lt;br/&gt;
    +#include &quot;TestTServerSocket.h&quot;&lt;br/&gt;
    +&lt;br/&gt;
    +using apache::thrift::transport::TServerSocket;&lt;br/&gt;
    +using apache::thrift::transport::TSocket;&lt;br/&gt;
    +using apache::thrift::transport::TTransport;&lt;br/&gt;
    +using apache::thrift::transport::TTransportException;&lt;br/&gt;
    +&lt;br/&gt;
    +BOOST_FIXTURE_TEST_SUITE ( TSocketInterruptTest, TestPortFixture )&lt;br/&gt;
    +&lt;br/&gt;
    +void readerWorker(boost::shared_ptr&amp;lt;TTransport&amp;gt; tt, uint32_t expectedResult)&lt;br/&gt;
    +&lt;/p&gt;
{
    +    uint8_t buf[4];
    +    BOOST_CHECK_EQUAL(expectedResult, tt-&amp;gt;read(buf, 4));
    +}
&lt;p&gt;    +&lt;br/&gt;
    +void readerWorkerMustThrow(boost::shared_ptr&amp;lt;TTransport&amp;gt; tt)&lt;br/&gt;
    +{&lt;br/&gt;
    +    try&lt;br/&gt;
    +    &lt;/p&gt;
{
    +        uint8_t buf[4];
    +        tt-&amp;gt;read(buf, 4);
    +        BOOST_ERROR(&quot;should not have gotten here&quot;);
    +    }
&lt;p&gt;    +    catch (const TTransportException&amp;amp; tx)&lt;br/&gt;
    +    &lt;/p&gt;
{
    +        BOOST_CHECK_EQUAL(TTransportException::INTERRUPTED, tx.getType());
    +    }
&lt;p&gt;    +}&lt;br/&gt;
    +&lt;br/&gt;
    +BOOST_AUTO_TEST_CASE( test_interruptable_child_read )&lt;br/&gt;
    +{&lt;br/&gt;
    +    TestTServerSocket sock1(&quot;localhost&quot;, m_serverPort);&lt;br/&gt;
    +    sock1.listen();&lt;br/&gt;
    +    TSocket clientSock(&quot;localhost&quot;, m_serverPort);&lt;br/&gt;
    +    clientSock.open();&lt;br/&gt;
    +    boost::shared_ptr&amp;lt;TTransport&amp;gt; accepted = sock1.acceptImpl();&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I am specifically trying to test the implementation here, and not TServerTransport::accept.&lt;/p&gt;</comment>
                            <comment id="14488824" author="githubbot" created="Fri, 10 Apr 2015 03:16:20 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#discussion_r28120482&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#discussion_r28120482&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/test/TestTServerSocket.h &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,31 @@&lt;br/&gt;
    +/*&lt;br/&gt;
    + * Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
    + * or more contributor license agreements. See the NOTICE file&lt;br/&gt;
    + * distributed with this work for additional information&lt;br/&gt;
    + * regarding copyright ownership. The ASF licenses this file&lt;br/&gt;
    + * to you under the Apache License, Version 2.0 (the&lt;br/&gt;
    + * &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
    + * with the License. You may obtain a copy of the License at&lt;br/&gt;
    + *&lt;br/&gt;
    + *   &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    + *&lt;br/&gt;
    + * Unless required by applicable law or agreed to in writing,&lt;br/&gt;
    + * software distributed under the License is distributed on an&lt;br/&gt;
    + * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY&lt;br/&gt;
    + * KIND, either express or implied. See the License for the&lt;br/&gt;
    + * specific language governing permissions and limitations&lt;br/&gt;
    + * under the License.&lt;br/&gt;
    + */&lt;br/&gt;
    +&lt;br/&gt;
    +#pragma once&lt;br/&gt;
    +&lt;br/&gt;
    +#include &amp;lt;thrift/transport/TServerSocket.h&amp;gt;&lt;br/&gt;
    +&lt;br/&gt;
    +class TestTServerSocket : public apache::thrift::transport::TServerSocket&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    It allows acceptImpl() to be called directly by the test.&lt;/p&gt;</comment>
                            <comment id="14489382" author="githubbot" created="Fri, 10 Apr 2015 11:00:13 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#discussion_r28136618&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#discussion_r28136618&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/server/TSimpleServer.cpp &amp;#8212;&lt;br/&gt;
    @@ -88,7 +88,7 @@ void TSimpleServer::serve() &lt;/p&gt;
{
           string errStr = string(&quot;Some kind of accept exception: &quot;) + tx.what();
           GlobalOutput(errStr.c_str());
           continue;
    -    }
&lt;p&gt; catch (string s) &lt;/p&gt;
{
    +    }
&lt;p&gt; catch (const string&amp;amp; s) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I&apos;m curious, is there anything actually throwing a bare string?  I don&apos;t see anything, and in general concerned about the inability to debug errors caused by catching too much stuff.&lt;/p&gt;</comment>
                            <comment id="14490578" author="githubbot" created="Sat, 11 Apr 2015 00:07:53 +0000"  >&lt;p&gt;Github user ben-craig commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#discussion_r28189195&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#discussion_r28189195&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/server/TSimpleServer.cpp &amp;#8212;&lt;br/&gt;
    @@ -88,7 +88,7 @@ void TSimpleServer::serve() &lt;/p&gt;
{
           string errStr = string(&quot;Some kind of accept exception: &quot;) + tx.what();
           GlobalOutput(errStr.c_str());
           continue;
    -    }
&lt;p&gt; catch (string s) &lt;/p&gt;
{
    +    }
&lt;p&gt; catch (const string&amp;amp; s) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I don&apos;t know of any code in thrift that intentionally throws a string.  Throwing a string (or anything without a vtable really) is certainly a poor practice.&lt;/p&gt;</comment>
                            <comment id="14490579" author="ben.craig" created="Sat, 11 Apr 2015 00:08:58 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14491324" author="githubbot" created="Sun, 12 Apr 2015 04:40:20 +0000"  >&lt;p&gt;Github user jeking3 commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#issuecomment-91989278&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#issuecomment-91989278&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    As part of work on &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3084&quot; title=&quot;C++ add concurrent client limit to threaded servers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3084&quot;&gt;&lt;del&gt;THRIFT-3084&lt;/del&gt;&lt;/a&gt; I added a TServer integration test, and found that the shutdown behavior and the rules for when you can call setInterruptableChildren() had to be tightened up for a couple cases.  I am going to close this pull request until this is resolved so that it doesn&apos;t get merged in until the test passes.&lt;/p&gt;</comment>
                            <comment id="14491325" author="githubbot" created="Sun, 12 Apr 2015 04:40:21 +0000"  >&lt;p&gt;Github user jeking3 closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14491411" author="githubbot" created="Sun, 12 Apr 2015 10:44:10 +0000"  >&lt;p&gt;Github user jeking3 commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#issuecomment-92031586&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#issuecomment-92031586&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Added an integration test to prove behavior is correct; re-opening for CI build.&lt;/p&gt;</comment>
                            <comment id="14491412" author="githubbot" created="Sun, 12 Apr 2015 10:44:10 +0000"  >&lt;p&gt;GitHub user jeking3 reopened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; prevent client connections from delaying server stop&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jeking3/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jeking3/thrift&lt;/a&gt; bugfix/&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt;-disconnect-clients-on-server-stop&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #424&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 4113f4f50bc4a6a1488b56db14a15e96527c44a7&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-04T19:26:54Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; prevent client connections from delaying server stop&lt;/p&gt;

&lt;p&gt;commit 730877b51d6ef96f84cad34e055f01fd9503aa96&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-04T23:09:16Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; fix stop handling of simple, threaded server&lt;/p&gt;

&lt;p&gt;commit ad68c576a75257dcca26b2c1b88fab27dcd967f0&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-10T04:10:37Z&lt;/p&gt;

&lt;p&gt;    Merge branch &apos;master&apos; of github.com:jeking3/thrift into bugfix/&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt;-disconnect-clients-on-server-stop&lt;/p&gt;

&lt;p&gt;commit 251d4d4a2edb3ee95f7b200c70333d7fdc8171c8&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-10T04:44:10Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; addressed code review concerns&lt;/p&gt;

&lt;p&gt;commit 0ca766bfd4c8be98481c7295f1bec5e040959ffc&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-12T10:42:21Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; added TServerIntegrationTest to prove combined behavior is correct; fixed TSocket handling of ECONNRESET&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14491415" author="githubbot" created="Sun, 12 Apr 2015 11:02:13 +0000"  >&lt;p&gt;Github user jeking3 closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14491416" author="githubbot" created="Sun, 12 Apr 2015 11:02:13 +0000"  >&lt;p&gt;Github user jeking3 commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#issuecomment-92032827&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#issuecomment-92032827&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Closing and reopening because three builds failed with &quot;build.ninja not found&quot;.  Seems unrelated to changes made.&lt;/p&gt;</comment>
                            <comment id="14491417" author="githubbot" created="Sun, 12 Apr 2015 11:02:14 +0000"  >&lt;p&gt;GitHub user jeking3 reopened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; prevent client connections from delaying server stop&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jeking3/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jeking3/thrift&lt;/a&gt; bugfix/&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt;-disconnect-clients-on-server-stop&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #424&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 4113f4f50bc4a6a1488b56db14a15e96527c44a7&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-04T19:26:54Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; prevent client connections from delaying server stop&lt;/p&gt;

&lt;p&gt;commit 730877b51d6ef96f84cad34e055f01fd9503aa96&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-04T23:09:16Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; fix stop handling of simple, threaded server&lt;/p&gt;

&lt;p&gt;commit ad68c576a75257dcca26b2c1b88fab27dcd967f0&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-10T04:10:37Z&lt;/p&gt;

&lt;p&gt;    Merge branch &apos;master&apos; of github.com:jeking3/thrift into bugfix/&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt;-disconnect-clients-on-server-stop&lt;/p&gt;

&lt;p&gt;commit 251d4d4a2edb3ee95f7b200c70333d7fdc8171c8&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-10T04:44:10Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; addressed code review concerns&lt;/p&gt;

&lt;p&gt;commit 0ca766bfd4c8be98481c7295f1bec5e040959ffc&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-12T10:42:21Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; added TServerIntegrationTest to prove combined behavior is correct; fixed TSocket handling of ECONNRESET&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14491418" author="githubbot" created="Sun, 12 Apr 2015 11:07:24 +0000"  >&lt;p&gt;Github user jeking3 commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#issuecomment-92033000&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#issuecomment-92033000&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Nevermind, it is my fault - fixing it..&lt;/p&gt;</comment>
                            <comment id="14491419" author="githubbot" created="Sun, 12 Apr 2015 11:07:24 +0000"  >&lt;p&gt;Github user jeking3 closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14491422" author="githubbot" created="Sun, 12 Apr 2015 11:14:23 +0000"  >&lt;p&gt;GitHub user jeking3 reopened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; prevent client connections from delaying server stop&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jeking3/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jeking3/thrift&lt;/a&gt; bugfix/&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt;-disconnect-clients-on-server-stop&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #424&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 4113f4f50bc4a6a1488b56db14a15e96527c44a7&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-04T19:26:54Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; prevent client connections from delaying server stop&lt;/p&gt;

&lt;p&gt;commit 730877b51d6ef96f84cad34e055f01fd9503aa96&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-04T23:09:16Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; fix stop handling of simple, threaded server&lt;/p&gt;

&lt;p&gt;commit ad68c576a75257dcca26b2c1b88fab27dcd967f0&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-10T04:10:37Z&lt;/p&gt;

&lt;p&gt;    Merge branch &apos;master&apos; of github.com:jeking3/thrift into bugfix/&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt;-disconnect-clients-on-server-stop&lt;/p&gt;

&lt;p&gt;commit 251d4d4a2edb3ee95f7b200c70333d7fdc8171c8&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-10T04:44:10Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; addressed code review concerns&lt;/p&gt;

&lt;p&gt;commit 0ca766bfd4c8be98481c7295f1bec5e040959ffc&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-12T10:42:21Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; added TServerIntegrationTest to prove combined behavior is correct; fixed TSocket handling of ECONNRESET&lt;/p&gt;

&lt;p&gt;commit 49153dd33b63d054c72d6e28e5048b2ee80e5cf6&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-12T11:12:46Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; fix cmake error with new integration test using EmptyService&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14491423" author="githubbot" created="Sun, 12 Apr 2015 11:15:52 +0000"  >&lt;p&gt;Github user jeking3 commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#issuecomment-92034746&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#issuecomment-92034746&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Wow, this really isn&apos;t my morning...&lt;/p&gt;</comment>
                            <comment id="14491424" author="githubbot" created="Sun, 12 Apr 2015 11:15:52 +0000"  >&lt;p&gt;Github user jeking3 closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14491435" author="githubbot" created="Sun, 12 Apr 2015 11:47:58 +0000"  >&lt;p&gt;GitHub user jeking3 reopened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; prevent client connections from delaying server stop&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jeking3/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jeking3/thrift&lt;/a&gt; bugfix/&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt;-disconnect-clients-on-server-stop&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #424&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 4113f4f50bc4a6a1488b56db14a15e96527c44a7&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-04T19:26:54Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; prevent client connections from delaying server stop&lt;/p&gt;

&lt;p&gt;commit 730877b51d6ef96f84cad34e055f01fd9503aa96&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-04T23:09:16Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; fix stop handling of simple, threaded server&lt;/p&gt;

&lt;p&gt;commit ad68c576a75257dcca26b2c1b88fab27dcd967f0&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-10T04:10:37Z&lt;/p&gt;

&lt;p&gt;    Merge branch &apos;master&apos; of github.com:jeking3/thrift into bugfix/&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt;-disconnect-clients-on-server-stop&lt;/p&gt;

&lt;p&gt;commit 251d4d4a2edb3ee95f7b200c70333d7fdc8171c8&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-10T04:44:10Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; addressed code review concerns&lt;/p&gt;

&lt;p&gt;commit 0ca766bfd4c8be98481c7295f1bec5e040959ffc&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-12T10:42:21Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; added TServerIntegrationTest to prove combined behavior is correct; fixed TSocket handling of ECONNRESET&lt;/p&gt;

&lt;p&gt;commit 49153dd33b63d054c72d6e28e5048b2ee80e5cf6&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-12T11:12:46Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; fix cmake error with new integration test using EmptyService&lt;/p&gt;

&lt;p&gt;commit e9997d921b7d864bee19ba0b9cf5bb27eb817594&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-04-12T11:45:49Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; fix cmake build and enhance TServerIntegrationTest to test more code paths&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14491475" author="jking3" created="Sun, 12 Apr 2015 14:16:16 +0000"  >&lt;p&gt;Okay, &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; is ready to re-review based on a couple changes I made as a result of additional testing.  In addition, &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3081&quot; title=&quot;C++ Consolidate client processing loops in TServers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3081&quot;&gt;&lt;del&gt;THRIFT-3081&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3083&quot; title=&quot;C++ Consolidate server processing loops in TSimpleServer, TThreadedServer, TThreadPoolServer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3083&quot;&gt;&lt;del&gt;THRIFT-3083&lt;/del&gt;&lt;/a&gt;, and &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3084&quot; title=&quot;C++ add concurrent client limit to threaded servers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3084&quot;&gt;&lt;del&gt;THRIFT-3084&lt;/del&gt;&lt;/a&gt; are now ready and need to go in that order so I will submit each one as the dependency is resolved.  Sorry for the build/CI thrashing this morning.  Thanks!&lt;/p&gt;</comment>
                            <comment id="14491486" author="githubbot" created="Sun, 12 Apr 2015 14:27:37 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#discussion_r28203871&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#discussion_r28203871&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/server/TSimpleServer.cpp &amp;#8212;&lt;br/&gt;
    @@ -88,7 +88,7 @@ void TSimpleServer::serve() &lt;/p&gt;
{
           string errStr = string(&quot;Some kind of accept exception: &quot;) + tx.what();
           GlobalOutput(errStr.c_str());
           continue;
    -    }
&lt;p&gt; catch (string s) &lt;/p&gt;
{
    +    }
&lt;p&gt; catch (const string&amp;amp; s) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I removed this logic in &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3083&quot; title=&quot;C++ Consolidate server processing loops in TSimpleServer, TThreadedServer, TThreadPoolServer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3083&quot;&gt;&lt;del&gt;THRIFT-3083&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14491536" author="githubbot" created="Sun, 12 Apr 2015 15:45:05 +0000"  >&lt;p&gt;Github user bufferoverflow commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#discussion_r28204494&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#discussion_r28204494&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/transport/TSocket.cpp &amp;#8212;&lt;br/&gt;
    @@ -493,29 +585,9 @@ uint32_t TSocket::read(uint8_t* buf, uint32_t len) &lt;/p&gt;
{
           goto try_again;
         }

&lt;p&gt;    -#if defined _&lt;em&gt;FreeBSD&lt;/em&gt;_ || defined _&lt;em&gt;MACH&lt;/em&gt;_&lt;br/&gt;
         if (errno_copy == THRIFT_ECONNRESET) &lt;/p&gt;
{
    -      /* shigin: freebsd doesn&apos;t follow POSIX semantic of recv and fails with
    -       * THRIFT_ECONNRESET if peer performed shutdown
    -       * edhall: eliminated close() since we do that in the destructor.
    -       */
           return 0;
         }
&lt;p&gt;    -#endif&lt;br/&gt;
    -&lt;br/&gt;
    -#ifdef _WIN32&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This sequence is needed for some platforms, did you some tests on windows?&lt;/p&gt;</comment>
                            <comment id="14491618" author="githubbot" created="Sun, 12 Apr 2015 17:59:43 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#discussion_r28205714&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#discussion_r28205714&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/transport/TSocket.cpp &amp;#8212;&lt;br/&gt;
    @@ -493,29 +585,9 @@ uint32_t TSocket::read(uint8_t* buf, uint32_t len) &lt;/p&gt;
{
           goto try_again;
         }

&lt;p&gt;    -#if defined _&lt;em&gt;FreeBSD&lt;/em&gt;_ || defined _&lt;em&gt;MACH&lt;/em&gt;_&lt;br/&gt;
         if (errno_copy == THRIFT_ECONNRESET) &lt;/p&gt;
{
    -      /* shigin: freebsd doesn&apos;t follow POSIX semantic of recv and fails with
    -       * THRIFT_ECONNRESET if peer performed shutdown
    -       * edhall: eliminated close() since we do that in the destructor.
    -       */
           return 0;
         }
&lt;p&gt;    -#endif&lt;br/&gt;
    -&lt;br/&gt;
    -#ifdef _WIN32&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Hi Roger, thanks for inspecting this closely.  I determined that if one called read() on a closed socket, it was not returning 0 like it should.  It turns out that the block seen above which was limiting the logic for handling ECONNRESET to _&lt;em&gt;FreeBSD&lt;/em&gt;_ and _&lt;em&gt;MACH&lt;/em&gt;_ should be ubiquitous.  If a read() errors with ECONNRESET the proper response is to return 0 indicating EOF.&lt;/p&gt;

&lt;p&gt;    The WIN32 block is the same, given THRIFT_ECONNRESET == WSAECONNRESET when _WIN32 is enabled.  As such, now all platforms respond to connection reset during read with 0, meaning EOF.&lt;/p&gt;

&lt;p&gt;    Does the CI build test framework test Windows and run the CMake tests?  If so, then the TServerIntegrationTest will test your concern.  I did not run this code on Windows to make sure it builds or passes tests, but I can do that on Monday if needed.&lt;/p&gt;</comment>
                            <comment id="14492894" author="githubbot" created="Mon, 13 Apr 2015 19:15:41 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#discussion_r28269576&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#discussion_r28269576&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/transport/TSocket.cpp &amp;#8212;&lt;br/&gt;
    @@ -493,29 +585,9 @@ uint32_t TSocket::read(uint8_t* buf, uint32_t len) &lt;/p&gt;
{
           goto try_again;
         }

&lt;p&gt;    -#if defined _&lt;em&gt;FreeBSD&lt;/em&gt;_ || defined _&lt;em&gt;MACH&lt;/em&gt;_&lt;br/&gt;
         if (errno_copy == THRIFT_ECONNRESET) &lt;/p&gt;
{
    -      /* shigin: freebsd doesn&apos;t follow POSIX semantic of recv and fails with
    -       * THRIFT_ECONNRESET if peer performed shutdown
    -       * edhall: eliminated close() since we do that in the destructor.
    -       */
           return 0;
         }
&lt;p&gt;    -#endif&lt;br/&gt;
    -&lt;br/&gt;
    -#ifdef _WIN32&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I spent a few hours trying to get a MinGW environment set up, but I wasn&apos;t able to so I am switching to Cygwin instead.  Is there a MinGW 64-bit environment out there that has everything you need for Thrift?  MinGW-w64 seemed like it had promise but it was missing the autotool chain.&lt;/p&gt;</comment>
                            <comment id="14492919" author="githubbot" created="Mon, 13 Apr 2015 19:22:45 +0000"  >&lt;p&gt;Github user bufferoverflow commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#discussion_r28270114&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#discussion_r28270114&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/transport/TSocket.cpp &amp;#8212;&lt;br/&gt;
    @@ -493,29 +585,9 @@ uint32_t TSocket::read(uint8_t* buf, uint32_t len) &lt;/p&gt;
{
           goto try_again;
         }

&lt;p&gt;    -#if defined _&lt;em&gt;FreeBSD&lt;/em&gt;_ || defined _&lt;em&gt;MACH&lt;/em&gt;_&lt;br/&gt;
         if (errno_copy == THRIFT_ECONNRESET) &lt;/p&gt;
{
    -      /* shigin: freebsd doesn&apos;t follow POSIX semantic of recv and fails with
    -       * THRIFT_ECONNRESET if peer performed shutdown
    -       * edhall: eliminated close() since we do that in the destructor.
    -       */
           return 0;
         }
&lt;p&gt;    -#endif&lt;br/&gt;
    -&lt;br/&gt;
    -#ifdef _WIN32&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Thanks Jim, I&apos;m fine with your explanations, CMake build on appveyor currently fails and I try to get it up and runnning again. I think Windows platform users shall use Visual Studio instead of cygwin and MinGW or as a better choice clang&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;
</comment>
                            <comment id="14494710" author="githubbot" created="Tue, 14 Apr 2015 19:26:25 +0000"  >&lt;p&gt;Github user jeking3 commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#issuecomment-93028344&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#issuecomment-93028344&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Getting a windows build going has been really difficult, which is bizarre because it used to be easy.  I&apos;ve tried MinGW, and cygwin, and native with cmake.  Each time I have run into some roadblock that keeps me from making any progress.  I want to run the cmake unit tests (make check) on Windows to assist in verifying this change, but it hasn&apos;t been easy to do, yet...&lt;/p&gt;</comment>
                            <comment id="14500841" author="jking3" created="Fri, 17 Apr 2015 22:47:36 +0000"  >&lt;p&gt;I have the thrift compiler built by using cmake, and the thrift C++ library built using the canned solution (this should be moved to cmake as soon as possible!).  I ran into &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3105&quot; title=&quot;C++ libthriftnb library on Windows build failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3105&quot;&gt;&lt;del&gt;THRIFT-3105&lt;/del&gt;&lt;/a&gt; during this process, but now I have the compiler and libraries built.  I don&apos;t see a windows project for the tests anywhere however.  Is there one?  If not, then I&apos;m not sure what additional tests folks would like me to run before this can be committed?&lt;/p&gt;</comment>
                            <comment id="14501092" author="jking3" created="Sat, 18 Apr 2015 04:45:08 +0000"  >&lt;p&gt;I got a little further using the development tip and cmake 3.2.2 on Windows.  I build boost-1.58 and got libevent, zlib, openssl built and found by the cmake build environment.  I guess if I keep going I can run tests, so I will do that.  Right now I&apos;m running into multiply defined boost symbols at link time.  The static and dynamic boost libraries seem to be linking into libthrift even though I specifically did a cmake with -DWITH_STATIC_LIB=OFF.&lt;/p&gt;</comment>
                            <comment id="14506429" author="jking3" created="Wed, 22 Apr 2015 05:07:47 +0000"  >&lt;p&gt;With the work done in &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2850&quot; title=&quot;Have the cmake build system run make cross&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2850&quot;&gt;THRIFT-2850&lt;/a&gt; I was able to merge this locally into an environment where cmake unit tests can run, and I ran them to ensure things work on Windows as well as on Linux.  I submitted a one line test change for windows compatibility which will trigger a new CI build.&lt;/p&gt;

&lt;p&gt;This is now ready to be merged.&lt;/p&gt;</comment>
                            <comment id="14507062" author="githubbot" created="Wed, 22 Apr 2015 13:30:01 +0000"  >&lt;p&gt;Github user jeking3 commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#issuecomment-95177941&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#issuecomment-95177941&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    To make the (hopefully) impending merge easier, I merged master into this branch and there was one conflict to resolve so I took care of it.&lt;/p&gt;</comment>
                            <comment id="14510799" author="githubbot" created="Fri, 24 Apr 2015 10:53:27 +0000"  >&lt;p&gt;Github user jeking3 commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#issuecomment-95891841&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#issuecomment-95891841&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I rebased with master after &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3000&quot; title=&quot;.NET implementation has trouble with mixed IP modes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3000&quot;&gt;&lt;del&gt;THRIFT-3000&lt;/del&gt;&lt;/a&gt; was reverted to ensure that in Travis CI, job #1 passes.&lt;/p&gt;</comment>
                            <comment id="14511098" author="ben.craig" created="Fri, 24 Apr 2015 13:57:16 +0000"  >&lt;p&gt;committed.  Thanks jeking3!&lt;/p&gt;</comment>
                            <comment id="14511148" author="hudson" created="Fri, 24 Apr 2015 14:41:48 +0000"  >&lt;p&gt;SUCCESS: Integrated in Thrift #1517 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/1517/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/1517/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2441&quot; title=&quot;Cannot shutdown TThreadedServer when clients are still connected&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2441&quot;&gt;&lt;del&gt;THRIFT-2441&lt;/del&gt;&lt;/a&gt; Cannot shutdown TThreadedServer when clients are still connected (bencraig: rev 1684c429501e9df9387cb518e660691f032d7926)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;lib/cpp/src/thrift/server/TThreadPoolServer.cpp&lt;/li&gt;
	&lt;li&gt;lib/cpp/test/TServerSocketTest.cpp&lt;/li&gt;
	&lt;li&gt;lib/cpp/test/Makefile.am&lt;/li&gt;
	&lt;li&gt;lib/cpp/src/thrift/server/TSimpleServer.cpp&lt;/li&gt;
	&lt;li&gt;lib/cpp/src/thrift/server/TThreadPoolServer.h&lt;/li&gt;
	&lt;li&gt;lib/cpp/src/thrift/server/TSimpleServer.h&lt;/li&gt;
	&lt;li&gt;lib/cpp/test/TServerIntegrationTest.cpp&lt;/li&gt;
	&lt;li&gt;lib/cpp/test/TServerTransportTest.cpp&lt;/li&gt;
	&lt;li&gt;configure.ac&lt;/li&gt;
	&lt;li&gt;lib/cpp/src/thrift/server/TThreadedServer.h&lt;/li&gt;
	&lt;li&gt;lib/cpp/src/thrift/transport/TServerSocket.h&lt;/li&gt;
	&lt;li&gt;lib/cpp/src/thrift/transport/TSocket.h&lt;/li&gt;
	&lt;li&gt;.gitignore&lt;/li&gt;
	&lt;li&gt;lib/cpp/src/thrift/transport/TServerSocket.cpp&lt;/li&gt;
	&lt;li&gt;lib/cpp/test/CMakeLists.txt&lt;/li&gt;
	&lt;li&gt;lib/cpp/src/thrift/transport/TServerTransport.h&lt;/li&gt;
	&lt;li&gt;lib/cpp/src/thrift/transport/TSocket.cpp&lt;/li&gt;
	&lt;li&gt;lib/cpp/test/TSocketInterruptTest.cpp&lt;/li&gt;
	&lt;li&gt;lib/cpp/src/thrift/server/TThreadedServer.cpp&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14511157" author="githubbot" created="Fri, 24 Apr 2015 14:46:10 +0000"  >&lt;p&gt;Github user jeking3 commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424#issuecomment-95952386&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424#issuecomment-95952386&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Committed - closing pull request.&lt;/p&gt;</comment>
                            <comment id="14511158" author="githubbot" created="Fri, 24 Apr 2015 14:46:10 +0000"  >&lt;p&gt;Github user jeking3 closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/424&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/424&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12788005">THRIFT-3081</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12916132">THRIFT-3447</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12659496">THRIFT-2099</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13141280">THRIFT-4500</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13087569">THRIFT-4252</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12935585">THRIFT-3590</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12786782">THRIFT-3061</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13020070">THRIFT-3970</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12709074" name="THRIFT-2441-prelim.patch" size="24301" author="jking3" created="Thu, 2 Apr 2015 21:38:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>384450</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 30 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1u8db:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>384718</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>