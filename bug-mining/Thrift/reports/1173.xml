<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:16:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-2932] Node.js Thrift connection libraries throw Exceptions into event emitter</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-2932</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;I&apos;ve been investigating using the Node.js client in a project however it seems like there are instances which don&apos;t follow Node.js best practices. &lt;/p&gt;

&lt;p&gt;In particular http_connection.js and connection.js throw errors during callbacks. This is considered an anti-pattern in Node because it both removes the Exception from the context of the callback making it hard to associate with a request as well as throwing it in the context of the EventEmitter code which can cause inconsistencies in the Node process.&lt;/p&gt;

&lt;p&gt;This means under some error conditions an uncaught exception would be thrown or at least an &apos;error&apos; event on the singleton client (again removing it from the request context).&lt;/p&gt;

&lt;p&gt;Both transport receivers share the same copy-pasta code which contains:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-javascript&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (e) {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (e &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; ttransport.InputBufferUnderrunError) {
        transport_with_data.rollbackPosition();
      }
      &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
      }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m working on a patch, but I&apos;m curious about some of the history of the code. In particular the exception based loop flow control and the using the seqid to track the callback which makes it hard to properly associate it with exception handling.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12765298">THRIFT-2932</key>
            <summary>Node.js Thrift connection libraries throw Exceptions into event emitter</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="codesf">Randy Abernethy</assignee>
                                    <reporter username="sh1mmer">Tom Croucher</reporter>
                        <labels>
                    </labels>
                <created>Wed, 7 Jan 2015 05:51:21 +0000</created>
                <updated>Tue, 21 Jul 2015 02:21:10 +0000</updated>
                            <resolved>Sat, 14 Feb 2015 23:02:36 +0000</resolved>
                                    <version>0.9.2</version>
                                    <fixVersion>0.9.3</fixVersion>
                                    <component>Node.js - Library</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14291343" author="andrewdeandrade" created="Mon, 26 Jan 2015 01:23:48 +0000"  >&lt;p&gt;+1 On knowing more about this as well. &lt;/p&gt;

&lt;p&gt;I&apos;m about to start work on using the Thrift JavaScript client in the browser, and would like to know about the history of the JavaScript code. I&apos;m especially curious to know why there isn&apos;t more code sharing between the js node thrift libraries and the js browser thrift library. &lt;/p&gt;</comment>
                            <comment id="14294207" author="codesf" created="Tue, 27 Jan 2015 21:21:33 +0000"  >&lt;p&gt;Both of these libs predate my involvement in Thrift but when first exposed to them a couple years ago they were primordial and supporting only very limited functionality. The browser lib only did JSON/XHR/HTTP and Node only did Binary/Socket so they could not talk to each other (browser was/is tested against Java). No npm or bower support at that time either. &lt;/p&gt;

&lt;p&gt;The libs are now out on npm and bower (which is a mess due to the whole repo download thing). Compact and JSON protocols were added to Node. Many things that didn&apos;t work at all were fixed and lots of tests were added. Other than the tests (which were needed just to get things working more broadly) all of this work has been feature oriented and incremental. People tend to provide patches to fix or add things they need, not clean up stuff that is a mess (partly because it might break existing code, for example changing the call back interface in the browser to add error objects). So we have some baggage...&lt;/p&gt;

&lt;p&gt;That said, you are not alone. Many would like to see the kind of improvements mentioned here and in other tickets. There&apos;s still time to make a big push before Thrift v1.0. Patches welcome!&lt;/p&gt;</comment>
                            <comment id="14303930" author="andrewdeandrade" created="Tue, 3 Feb 2015 20:37:56 +0000"  >&lt;p&gt;Randy, here is a single consolidate patch for all the previous patches. This applies cleanly to the current HEAD on master.&lt;/p&gt;</comment>
                            <comment id="14305990" author="codesf" created="Wed, 4 Feb 2015 21:22:52 +0000"  >&lt;p&gt;Hey Andrew,&lt;/p&gt;

&lt;p&gt;Thanks for the consolidated patch. Several nice improvements here. I am concerned about the new sequence id modification though. It propagates the sequencing data into the transport. This may seem reasonable in isolation but the transport should not be involved at this level of abstraction. &lt;/p&gt;

&lt;p&gt;In Apache Thrift, Protocols are responsible for the physical layout of bits (on the wire, on disk or in memory).  This includes where, how and if sequence numbers are packaged. Transports are responsible for transmission of the data only. This may involve packetizing, framing, encrypting or what have you, but the key is that the Protocol and the Transport are isolated. The Transport receives/returns an opaque block of bits from/to the Protocol. &lt;/p&gt;

&lt;p&gt;The current node implementation is not clean in this regards and ultimately needs some structural refactoring. For example the multiplexing read implementation is a hack (paying no attention to the service name in the payload and rather wiring everything to seqid lookups). I think we should try to migrate things in the direction of the generalized Apache Thrift model. This is non-trivial due to the pure async approach of JavaScript (a late model option in the reference CPP and Java implementations). &lt;/p&gt;

&lt;p&gt;The heart of the node problem here is that Apache Thrift is a layered system. Lower layers provide services to upper layers and services do what you tell them, they don&#8217;t call you with demands. The node implementation wires callbacks from the bottom up (with several call chains back down from proto to trans in the process). These conflicting approaches are merged with unsatisfactory results in my opinion. To respect the Apache Thrift layered approach the &#8220;data&#8221; event needs to be handled by the client (or by a much more focused connection helper) and this piece of code needs to then call down the layered stack like all other languages (client-&amp;gt;proto-&amp;gt;trans) for reads or writes. &lt;/p&gt;

&lt;p&gt;In short, getting the node client side call return in order is a fair size chunk of work and should fall into a separate issue.&lt;/p&gt;


&lt;p&gt;Specific comments (line nos post patch):&lt;br/&gt;
----------------------------------------------------------&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;lib/nodejs/lib/thrift/http_connection.js LINE  157: This is an exotic case where the client does not implement a receive handler for the server message. An extreme edge case that by definition can have no callback, so emit error is probably the only reasonable out. Also keep in mind that prior to deserializing at the protocol level we have no idea what the transmitted seqid is. Without a seqid we cannot know the callback to invoke.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;lib/nodejs/lib/thrift/http_connection.js LINE  184: Here we are communicating normal application behavior using exceptions, which always smells a bit (this is not your code but it is making things murky here). If a real exception arises here it is appropriately scoped to the client rather than the call. It will be something like &#8220;the connection failed&#8221;. Call context exceptions should be transmitted by the protocol, received successfully around line 145 and presented to the callback in the err position. Anything else should be handled at a higher level of abstraction. If I am writing a client I don&#8217;t want to have to handle call failure in every callback, that logic should be provided in a single error event handler across all calls.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;lib/nodejs/lib/thrift/thrift.js LINE 148: This appears to be an in house utility, also &quot;self.called&quot; never appears to be set anywhere.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If you are fixing a specific problem in this code or if I am missing the point let me know and maybe give me an example case to look over. In the meantime I&#8217;m going to patch commit the hunks that are clear improvements here (nextTick additions and the like).  You can close this ticket and open new specific tickets for individual issues not handled here or we can carry on here, up to you. I will attach the partial patch committed.&lt;/p&gt;

&lt;p&gt;Best,&lt;br/&gt;
Randy&lt;/p&gt;
</comment>
                            <comment id="14305998" author="codesf" created="Wed, 4 Feb 2015 21:29:53 +0000"  >&lt;p&gt;hunks committed from original patch.&lt;/p&gt;</comment>
                            <comment id="14306053" author="andrewdeandrade" created="Wed, 4 Feb 2015 21:56:53 +0000"  >&lt;p&gt;The general idea is that with NodeJS code you never ever throw (in fact the only native part of the language that throws on user supplied input AFAIK is JSON.parse and that&apos;s a historical anomaly due to the way Crockford first implemented it). Instead of throwing you should always return the error back to it&apos;s caller as the first argument of the callback. When that isn&apos;t possible, emitting &quot;error&quot; events is the next best thing. Throwing of an error should only occur if no callback has been bound to the &quot;error&quot; event. Overall throwing errors is never used for flow control.&lt;/p&gt;

&lt;p&gt;Regarding the specifics for this patch, I have pinged Tom on this issue to get his feedback. He knows more about what he was thinking when he made these changes and will be better able to address the points you raised. &lt;/p&gt;

&lt;p&gt;I&apos;ll dig through these changes in light of your comment and see what else I might be able to add.&lt;/p&gt;

&lt;p&gt;None of the other patches I submitted are dependent on this change, but let me know if you need me to re-roll them in light of only accepting some of the changes in this patch. &lt;/p&gt;
</comment>
                            <comment id="14306068" author="hudson" created="Wed, 4 Feb 2015 22:05:49 +0000"  >&lt;p&gt;SUCCESS: Integrated in Thrift #1447 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/1447/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/1447/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2932&quot; title=&quot;Node.js Thrift connection libraries throw Exceptions into event emitter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2932&quot;&gt;&lt;del&gt;THRIFT-2932&lt;/del&gt;&lt;/a&gt;: Node.js Thrift connection libraries throw Exceptions into event emitter (ra: rev a7270074d31a25cd5e3965db7013446ac5d21c52)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;lib/nodejs/lib/thrift/http_connection.js&lt;/li&gt;
	&lt;li&gt;lib/nodejs/test/thrift_test_driver.js&lt;/li&gt;
	&lt;li&gt;lib/nodejs/README.md&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14321744" author="codesf" created="Sat, 14 Feb 2015 23:02:36 +0000"  >&lt;p&gt;Seems like future progress in this area is carrying on in other tickets. I am resolving this one as fixed. Please reopen if we need to revisit things.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12696563" name="0001-minor-node-http-connection-clean-up.patch" size="3214" author="codesf" created="Wed, 4 Feb 2015 21:29:53 +0000"/>
                            <attachment id="12696277" name="0001-nodejs-exceptions-to-callbacks-instead-of-throws-int.patch" size="17393" author="andrewdeandrade" created="Tue, 3 Feb 2015 20:37:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 40 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i240r3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>