<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:16:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-2870] C++ TJSONProtocol using locale dependent formatting</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-2870</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;I&apos;m using Thrift for serializing objects (in C++) into JSON strings, which I then store as files. This usually works fine, but if the locale of my system is set to a locale where the decimal separator is &apos;,&apos; instead of &apos;.&apos; (for instance in Denmark), then the TJSONProtocol (specifically the writeJSONDouble function that does the double to string conversion through a boost::lexical_cast) will also use this separator when serializing doubles. &lt;/p&gt;

&lt;p&gt;This kinda plays havoc with the JSON specification, which does not allow for localized formatting, and depends on always using &apos;.&apos; as a decimal separator. I could imagine that there may be other more subtle places where the local can have an effect, but this is currently the only place I&apos;ve been having trouble with.&lt;/p&gt;

&lt;p&gt;I can see that the same problem has been fixed for C# (commit&lt;br/&gt;
3da317bda100130b2f615034c46b0944888f0f14 / &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1245&quot; title=&quot;C# JSON Protocol uses culture-dependant decimal separator for double&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1245&quot;&gt;&lt;del&gt;THRIFT-1245&lt;/del&gt;&lt;/a&gt; C# JSON Protocol uses culture-dependant decimal separator for double) but it doesn&apos;t seem as if there&apos;s a similarly easy way to fix boost::lexical_cast...&lt;/p&gt;

&lt;p&gt;Note that I&apos;m using Thrift 0.9.0, but as far as I can see there hasn&apos;t been any relevant changes to TJSONProtocol.cpp since.&lt;/p&gt;

&lt;p&gt;Relevant thread on thrift-user mailing list can be found here: &lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/thrift-user/201412.mbox/%3c7c2463f510dbb7548b4718e202ac1e45@mail.gmail.com%3e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://mail-archives.apache.org/mod_mbox/thrift-user/201412.mbox/%3c7c2463f510dbb7548b4718e202ac1e45@mail.gmail.com%3e&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ve also attached a quick patch that works on my setup (see the patch file comments for more information).&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux, Boost 1.51&lt;/p&gt;</environment>
        <key id="12758914">THRIFT-2870</key>
            <summary>C++ TJSONProtocol using locale dependent formatting</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hcorg">Konrad Grochowski</assignee>
                                    <reporter username="simonfalsig">Simon Falsig</reporter>
                        <labels>
                    </labels>
                <created>Tue, 2 Dec 2014 14:58:04 +0000</created>
                <updated>Tue, 21 Jul 2015 02:21:14 +0000</updated>
                            <resolved>Mon, 23 Feb 2015 17:24:17 +0000</resolved>
                                    <version>0.9</version>
                                    <fixVersion>0.9.3</fixVersion>
                                    <component>C++ - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14231574" author="simonfalsig" created="Tue, 2 Dec 2014 15:02:25 +0000"  >&lt;p&gt;I&apos;ve tried putting together a quick patch (against my own Thrift 0.9.0), where I&apos;ve exchanged the boost::lexical_cast with an ostringstream with an imbued locale. However, I&apos;m in no way sure if my solution covers all corner cases, and I haven&apos;t done any performance testing either - but a quick initial test shows that it works on my setup, independent of the currently selected global locale.&lt;/p&gt;</comment>
                            <comment id="14231617" author="hcorg" created="Tue, 2 Dec 2014 15:25:01 +0000"  >&lt;p&gt;I&apos;ll try to look into it later. I&apos;ve once heard that std::ios_base::imbue is not thread-safe in some implementations... (it may be using std::setlocale....) But it was long time ago...&lt;/p&gt;

&lt;p&gt;I&apos;ll also apply locale for printing int&apos;s, somebody may have set thousands separator &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ll see how this patch applies against master.&lt;/p&gt;</comment>
                            <comment id="14234704" author="hcorg" created="Thu, 4 Dec 2014 22:15:41 +0000"  >&lt;p&gt;can you try adding &lt;tt&gt;#define BOOST_LEXICAL_CAST_ASSUME_C_LOCALE&lt;/tt&gt; before boost/lexical_cast include and see if it helps? That could save us better performance than sstreams... &lt;/p&gt;

&lt;p&gt;current patch failed tests at my machine - probably NaNs etc are treated differently in sstream.&lt;/p&gt;</comment>
                            <comment id="14235208" author="simonfalsig" created="Fri, 5 Dec 2014 07:23:24 +0000"  >&lt;p&gt;Hmm - I remember looking at using that, but dismissed it for some reason that I can&apos;t recall. I&apos;ll try it out though, although I probably won&apos;t have time for it until Monday.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="14237823" author="simonfalsig" created="Mon, 8 Dec 2014 12:25:48 +0000"  >&lt;p&gt;Nope - adding the &lt;tt&gt;#define BOOST_LEXICAL_CAST_ASSUME_C_LOCALE&lt;/tt&gt; doesn&apos;t seem to do anything in my setup - I still end up with commas for decimalseparators...&lt;/p&gt;

&lt;p&gt;After looking at the boost lexical_cast.hpp, I&apos;ve tried with &lt;tt&gt;#define BOOST_NO_STD_LOCALE&lt;/tt&gt; also - but this didn&apos;t do anything either.&lt;/p&gt;

&lt;p&gt;From a quick glance through lexical_cast.hpp it seems that the part that does the conversion from double/float to string is simply using &lt;tt&gt;sprintf()&lt;/tt&gt;, without considering any of the two defines mentioned at all...&lt;/p&gt;</comment>
                            <comment id="14237838" author="hcorg" created="Mon, 8 Dec 2014 12:51:50 +0000"  >&lt;p&gt;so bigger change may be required - &apos;manual&apos; support for NaNs etc...&lt;/p&gt;</comment>
                            <comment id="14327391" author="simonfalsig" created="Thu, 19 Feb 2015 13:21:27 +0000"  >&lt;p&gt;Konrad - I&apos;ve finally had some more time to play around with this, based on the tests in lib/cpp/test (by running &lt;tt&gt;make check-TESTS&lt;/tt&gt;):&lt;/p&gt;

&lt;p&gt;All tests are on my own KUbuntu 12.04 with Thrift 0.9.2 and boost 1.57 - see files attached to the bug report for output.&lt;/p&gt;

&lt;p&gt;Initial (no changes to the code): All 15 tests passed&lt;/p&gt;

&lt;p&gt;Failing (I added a &lt;tt&gt;setlocale(LC_ALL, &quot;da_DK&quot;));&lt;/tt&gt; to the beginning of the JSONProtoTest.cpp): JSONProtoTest fails (doubles now use &apos;,&apos; for decimal separators)&lt;/p&gt;

&lt;p&gt;Fixed (keeping the new locale, adding my previously posted patch): All 15 tests passed. Doing a diff on the JSON output from JSONProtoTest, it matches the output from the initial test exactly.&lt;/p&gt;


&lt;p&gt;You were mentioning that it failed testing on your machine - what tests are you using?&lt;/p&gt;</comment>
                            <comment id="14327393" author="simonfalsig" created="Thu, 19 Feb 2015 13:26:45 +0000"  >&lt;p&gt;Test results added, see &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2870?focusedCommentId=14327391&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14327391&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/THRIFT-2870?focusedCommentId=14327391&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14327391&lt;/a&gt; for more info&lt;/p&gt;</comment>
                            <comment id="14327397" author="hcorg" created="Thu, 19 Feb 2015 13:31:36 +0000"  >&lt;p&gt;I don&apos;t recall right now, but I&apos;ve probably just executed &lt;tt&gt;make check&lt;/tt&gt; on whole repo. Probably some tests in test/cpp (not in lib/cpp/test) failed.&lt;/p&gt;</comment>
                            <comment id="14327591" author="simonfalsig" created="Thu, 19 Feb 2015 14:50:52 +0000"  >&lt;p&gt;Hmm - &lt;tt&gt;make check&lt;/tt&gt; fails here (same errors as in &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2845&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/THRIFT-2845&lt;/a&gt;)...&lt;/p&gt;</comment>
                            <comment id="14330207" author="hcorg" created="Sat, 21 Feb 2015 12:46:45 +0000"  >&lt;p&gt;There were some problems with your patch:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;it didn&apos;t apply on master (at least git apply refused it, I haven&apos;t check exactly why, I&apos;d still have to change it - see second point)&lt;/li&gt;
	&lt;li&gt;it was using C+&lt;ins&gt;11 features, which we have to avoid in default C&lt;/ins&gt;+ lib (new one is in development...)&lt;/li&gt;
	&lt;li&gt;JSONProtocolTest was failing - readDouble also had to be changed&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Please check attached patch if it solves your problem (it&apos;s made against master) and if so I&apos;ll commit it.&lt;/p&gt;</comment>
                            <comment id="14333149" author="simonfalsig" created="Mon, 23 Feb 2015 09:36:00 +0000"  >&lt;p&gt;Ah - that makes sense - thanks for the clarification! I did a quick test of the patch which seems fine, but to be sure I&apos;ll run it through one of our machines later today and report back...&lt;/p&gt;</comment>
                            <comment id="14333261" author="simonfalsig" created="Mon, 23 Feb 2015 12:18:45 +0000"  >&lt;p&gt;Your patch works fine on our machines too. Had to tweak it slightly to get it to apply to the Thrift 0.9 that we&apos;re still using in production, but nothing that changes any of the functionality.&lt;/p&gt;

&lt;p&gt;Thanks for the help!&lt;/p&gt;</comment>
                            <comment id="14333541" author="hcorg" created="Mon, 23 Feb 2015 17:24:17 +0000"  >&lt;p&gt;Commited, thanks for help with testing &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14333667" author="hudson" created="Mon, 23 Feb 2015 19:11:38 +0000"  >&lt;p&gt;SUCCESS: Integrated in Thrift #1463 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/1463/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/1463/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2870&quot; title=&quot;C++ TJSONProtocol using locale dependent formatting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2870&quot;&gt;&lt;del&gt;THRIFT-2870&lt;/del&gt;&lt;/a&gt; - C++: JSON protocol will read &amp;amp; write doubles using &quot;C&quot; locale (hcorg: rev 12b06e4f8ccf90de5e993eaf9ed7bec450c723e6)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;lib/cpp/src/thrift/protocol/TJSONProtocol.cpp&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12699665" name="failing.txt" size="2132" author="simonfalsig" created="Thu, 19 Feb 2015 13:26:45 +0000"/>
                            <attachment id="12699666" name="fixed.txt" size="2049" author="simonfalsig" created="Thu, 19 Feb 2015 13:26:45 +0000"/>
                            <attachment id="12699667" name="initial.txt" size="2049" author="simonfalsig" created="Thu, 19 Feb 2015 13:26:45 +0000"/>
                            <attachment id="12700030" name="json_double_with_boost_math.patch" size="3242" author="hcorg" created="Sat, 21 Feb 2015 12:46:45 +0000"/>
                            <attachment id="12684666" name="use-classic-locale-for-cpp-json_4.patch" size="1835" author="simonfalsig" created="Tue, 2 Dec 2014 15:02:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 39 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i22yv3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>