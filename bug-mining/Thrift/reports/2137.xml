<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:33:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-5299] rs implementation compact protocol seq_id should not use zigzag encoding.</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-5299</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;While reviewing code, I discovered a bug in compact protocol.&lt;/p&gt;

&lt;p&gt;The seq_id in message header is decoded with integer-encoding&apos;s i32, which uses zigzag decode implicitly.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;EDIT: correct the title and desc.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13337565">THRIFT-5299</key>
            <summary>rs implementation compact protocol seq_id should not use zigzag encoding.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="allengeorge">Allen George</assignee>
                                    <reporter username="shuoli84">shuo li</reporter>
                        <labels>
                    </labels>
                <created>Wed, 28 Oct 2020 04:11:38 +0000</created>
                <updated>Mon, 22 Feb 2021 01:18:43 +0000</updated>
                            <resolved>Mon, 22 Feb 2021 01:18:43 +0000</resolved>
                                    <version>0.13.0</version>
                                    <fixVersion>0.14.1</fixVersion>
                                    <component>Rust - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="17221957" author="shuoli84" created="Wed, 28 Oct 2020 05:22:10 +0000"  >&lt;p&gt;After reading other lang implementations, current impl is correct, though the specification should be cleaner.&lt;/p&gt;</comment>
                            <comment id="17221958" author="shuoli84" created="Wed, 28 Oct 2020 05:24:10 +0000"  >&lt;p&gt;reopen it, the sequence number&apos;s impl is wrong, which uses zigzag encoding.&#160;&lt;/p&gt;</comment>
                            <comment id="17222023" author="jensg" created="Wed, 28 Oct 2020 08:07:30 +0000"  >&lt;p&gt;Testcase?&lt;/p&gt;</comment>
                            <comment id="17222636" author="shuoli84" created="Thu, 29 Oct 2020 00:53:44 +0000"  >&lt;p&gt;I opened an issue on integer-encoding: &lt;a href=&quot;https://github.com/dermesser/integer-encoding-rs/issues/14&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dermesser/integer-encoding-rs/issues/14&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17222639" author="shuoli84" created="Thu, 29 Oct 2020 01:02:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=allengeorge&quot; class=&quot;user-hover&quot; rel=&quot;allengeorge&quot;&gt;allengeorge&lt;/a&gt;&#160;shed some light on this issue too? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/tongue.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17222640" author="shuoli84" created="Thu, 29 Oct 2020 01:06:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jensg&quot; class=&quot;user-hover&quot; rel=&quot;jensg&quot;&gt;jensg&lt;/a&gt;&#160;thanks for reply, I think the problem is well described and a test case does little value on this.&#160;&lt;/p&gt;</comment>
                            <comment id="17222751" author="jensg" created="Thu, 29 Oct 2020 07:43:15 +0000"  >&lt;p&gt;Sure, who needs testcases anyway. Stupid me. It is always on us to prove it works, not on you who is claiming there is an error. How did I dare to even ask for a testcase? What was in my mind?&lt;/p&gt;</comment>
                            <comment id="17223371" author="shuoli84" created="Fri, 30 Oct 2020 02:59:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jensg&quot; class=&quot;user-hover&quot; rel=&quot;jensg&quot;&gt;jensg&lt;/a&gt;&#160;I&apos;ve been reading through all the rust code and also other lang(python cpp golang)&apos;s, then confirmed this is an issue. Also I issued a bug in integer-encoding crate, which the author also confirmed the problem. Currently most of thrift impl is round trip test, which means as long as the encode and decode use same impl, then the test passed. Which means writing a test case to confirm this issue more effort.&lt;/p&gt;

&lt;p&gt;Anyway, you are the boss, feel free to close this issue if it is not helping.&lt;/p&gt;</comment>
                            <comment id="17223479" author="jensg" created="Fri, 30 Oct 2020 07:49:18 +0000"  >&lt;p&gt;&amp;gt;  Also I issued a bug in integer-encoding crate, which the author also confirmed the problem&lt;/p&gt;

&lt;p&gt;Good. Thanks. I was missing that piece of the puzzle.&lt;/p&gt;

&lt;p&gt;&amp;gt;  you are the boss,&lt;/p&gt;

&lt;p&gt;Very certainly not. But did you know you can become a &quot;boss&quot; too?&lt;br/&gt;
&lt;a href=&quot;https://www.apache.org/foundation/getinvolved.html#become-a-committer&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.apache.org/foundation/getinvolved.html#become-a-committer&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17223685" author="allengeorge" created="Fri, 30 Oct 2020 14:46:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shuoli84&quot; class=&quot;user-hover&quot; rel=&quot;shuoli84&quot;&gt;shuoli84&lt;/a&gt; I&apos;m sorry - I&apos;m a little confused by what&apos;s being reported here. Is this a problem with the rust library, or &lt;tt&gt;integer_encoding&lt;/tt&gt;&apos;s implementation of &lt;tt&gt;read_varint&lt;/tt&gt; and &lt;tt&gt;write_varint&lt;/tt&gt; or both?&lt;/p&gt;

&lt;p&gt;It appears that the desired state is:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Sequence number: varint&lt;/li&gt;
	&lt;li&gt;All other instances of numbers: varint(zigzag)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;My understanding of the problem is that currently in the Rust compact impl the sequence number is *&lt;b&gt;also&lt;/b&gt;* in varint(zigzag), which is wrong. Fixing this in &lt;tt&gt;integer-encoding-rs&lt;/tt&gt; appears to be a breaking API change. Probably the simplest thing to do is add two new methods to the compact implementation:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;read_i32_seq_num&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;write_i32_seq_num&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Which works around the problem within the lib itself. Does that seem right?&lt;/p&gt;</comment>
                            <comment id="17224414" author="shuoli84" created="Mon, 2 Nov 2020 03:40:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=allengeorge&quot; class=&quot;user-hover&quot; rel=&quot;allengeorge&quot;&gt;allengeorge&lt;/a&gt;&#160;Correct, another workaround could be read u32 which not zigzagged, then cast back to i32.&lt;/p&gt;

&lt;p&gt;Actually, I think it is also a good idea to implement zigzag and varint in thrift-rs. Other lang&apos;s implementation already did this. And we can remove one dependency.&lt;/p&gt;</comment>
                            <comment id="17235545" author="allengeorge" created="Thu, 19 Nov 2020 15:22:11 +0000"  >&lt;p&gt;II was curious about why this didn&apos;t break all the cross tests, so I took a look at the code again. I noticed that the &lt;b&gt;only&lt;/b&gt; time the compact protocol spec uses (varint, non-zigzag) for a signed integer is for:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;collection, message, name sizes&lt;/li&gt;
	&lt;li&gt;sequence numbers&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;It makes no sense for collection sizes and lengths to be negative, and indeed the spec states that in a number of places. For example: &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;byte length is the length of the byte array, using var int encoding (must be &amp;gt;= 0)&lt;/tt&gt; (Binary encoding)&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;name length is the byte length of the name field, a signed 32 bit integer encoded as a var int (must be &amp;gt;= 0).&lt;/tt&gt; (Message)&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;size is the size, a var int (int32), positive values 15 or higher&lt;/tt&gt; (List and set)&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;size is the size, a var int (int32), strictly positive values&lt;/tt&gt; (Map)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Indeed, for sizes the rust implementation takes an &lt;tt&gt;i32&lt;/tt&gt; and immediately casts it to a &lt;tt&gt;u32&lt;/tt&gt; before encoding it onto the wire. I also checked &lt;tt&gt;integer-rs&lt;/tt&gt;, and as expected unsigned ints are encoded in varint-only form. So, as far as the spec is concerned, for sizes the rust compact protocol implementation is doing the right thing (there&apos;s a separate question as to why sizes should &lt;b&gt;ever&lt;/b&gt; be negative in the library; I&apos;ll look into changing all sizes into &lt;tt&gt;u32&lt;/tt&gt;, and what the blast radius of that change should be).&lt;/p&gt;

&lt;p&gt;This leaves the sequence number, which is signed and unzigzagged as the only problem. I also checked, and I think there &lt;b&gt;may&lt;/b&gt; be another issue with writing out &lt;tt&gt;i16&lt;/tt&gt; integers. The protobuf varint spec says that &lt;tt&gt;i16&lt;/tt&gt; should be written in no more bits than an &lt;tt&gt;i32&lt;/tt&gt;; I&apos;ll have to check and see if that&apos;s the case.&lt;/p&gt;

&lt;p&gt;TL;DR:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Only the sequence number may be a problem here.&lt;/li&gt;
	&lt;li&gt;I&apos;ll have to check if writing &lt;tt&gt;i16&lt;/tt&gt; uses more bytes than necessary.&lt;/li&gt;
	&lt;li&gt;Field ids and collection/binary/other sizes should be represented in the rust lib as &lt;tt&gt;usize&lt;/tt&gt; or &lt;tt&gt;u##&lt;/tt&gt; types instead of &lt;tt&gt;i##&lt;/tt&gt; types.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17235906" author="allengeorge" created="Fri, 20 Nov 2020 05:11:23 +0000"  >&lt;p&gt;Note: The reason why signed ints are used everywhere for lengths in the Rust lib is (of course) for compatibility between languages.&lt;/p&gt;</comment>
                            <comment id="17288119" author="allengeorge" created="Mon, 22 Feb 2021 01:18:43 +0000"  >&lt;p&gt;Fixed in &lt;a href=&quot;https://github.com/apache/thrift/pull/2336&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/2336&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 38 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0k2eg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>