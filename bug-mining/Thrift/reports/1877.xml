<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:28:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-4187] Dart -&gt; Rust Framed cross tests fail</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-4187</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;For some reason the Dart (client) -&amp;gt; Rust (server) framed-transport cross tests fail. Initial investigation shows that &lt;b&gt;somehow&lt;/b&gt; the dart client think the socket was closed, which means it doesn&apos;t read the message from the underlying transport.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13068144">THRIFT-4187</key>
            <summary>Dart -&gt; Rust Framed cross tests fail</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="allengeorge">Allen George</assignee>
                                    <reporter username="allengeorge">Allen George</reporter>
                        <labels>
                    </labels>
                <created>Mon, 1 May 2017 15:07:09 +0000</created>
                <updated>Thu, 27 Dec 2018 15:25:05 +0000</updated>
                            <resolved>Tue, 20 Mar 2018 20:29:26 +0000</resolved>
                                                    <fixVersion>0.12.0</fixVersion>
                                    <component>Rust - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15991934" author="allengeorge" created="Tue, 2 May 2017 01:18:05 +0000"  >&lt;p&gt;So, AFAICT, this happens because the Dart client can&apos;t handle framed writes that come in two pieces.&lt;/p&gt;

&lt;p&gt;The Rust server is doing the following:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Write the header bytes (i.e. message length)&lt;/li&gt;
	&lt;li&gt;Write the body&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;In this situation it seems like the dart client can&apos;t read a complete frame. Changing the rust server to do the write in one piece (i.e. header and body at the same time) seems to avoid the failure.&lt;/p&gt;</comment>
                            <comment id="15992151" author="jking3" created="Tue, 2 May 2017 03:20:08 +0000"  >&lt;p&gt;I&apos;d say the Dart client is at fault.  RPC systems should never rely on the size of a frame, since it can change too easily.  Just add a VPN client to your system and your MTU might change when connecting to some systems, for example.  Then again, having rust send once is more efficient, so that should be done anyway BUT only if it doesn&apos;t impose memory requirements that are too onerous to buffer the entire message just to prepend the length.&lt;/p&gt;</comment>
                            <comment id="15992714" author="allengeorge" created="Tue, 2 May 2017 11:11:36 +0000"  >&lt;p&gt;Yeah - the Dart client is definitely at fault. I think it&apos;s because it&apos;s layering a blocking-style API onto an event-driven system without actually blocking. Basically, the sequence of events is as follows:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Dart socket receives data&lt;/li&gt;
	&lt;li&gt;Handler invoked, socket data placed into transport read buffer&lt;/li&gt;
	&lt;li&gt;Thrift code makes read call&lt;/li&gt;
	&lt;li&gt;Framed transport code reads header (i.e. message size)&lt;/li&gt;
	&lt;li&gt;Framed transport code &lt;b&gt;immediately&lt;/b&gt; reads message body; if &lt;a href=&quot;https://github.com/apache/thrift/blob/0.10.0/lib/dart/lib/src/transport/t_transport.dart#L46&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;none is available&lt;/a&gt; (i.e. bytes are 0) it assumes remote side closed&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Obviously the last point is false. The remote may be slow, or message sizes too small or what not. Just changing the linked line to `&amp;lt; 0` wouldn&apos;t help AFAICT because there&apos;s no way to indicate an error state in the current code. (NOTE: I may be wrong because I don&apos;t know Dart)&lt;/p&gt;</comment>
                            <comment id="15992721" author="allengeorge" created="Tue, 2 May 2017 11:15:16 +0000"  >&lt;p&gt;I can try to implement a gathering write in Rust which should both get around this issue (in the short term) and reduce the number of socket calls. The right thing to do is fix the Dart transport - and I try figure out how to do that.&lt;/p&gt;</comment>
                            <comment id="15992945" author="markerickson-wk" created="Tue, 2 May 2017 13:59:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=allengeorge&quot; class=&quot;user-hover&quot; rel=&quot;allengeorge&quot;&gt;allengeorge&lt;/a&gt; I agree with your conclusions and the assessment that the challenge with the Dart implementation is adapting an async (non-blocking) system to a blocking-style API. If Dart needs to support reading the header in a separate message from the body, then there will be some rework needed to collect messages in the buffer before attempting to read.  I haven&apos;t put much thought into it lately, but let me know if you get stuck and I (or some of my colleagues) can try to help.&lt;/p&gt;</comment>
                            <comment id="15999925" author="allengeorge" created="Sun, 7 May 2017 16:29:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markerickson-wk&quot; class=&quot;user-hover&quot; rel=&quot;markerickson-wk&quot;&gt;markerickson-wk&lt;/a&gt; I think I can put together a first pass in a bit and have you comment on it. I&apos;ve done some work like this in the past, so it&apos;s not entirely new for me. I&apos;ll ping you when I&apos;ve got something you can critique.&lt;/p&gt;

&lt;p&gt;Thanks for letting me know I was looking in the right direction!&lt;/p&gt;</comment>
                            <comment id="16009769" author="githubbot" created="Sun, 14 May 2017 15:27:23 +0000"  >&lt;p&gt;GitHub user allengeorge opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4187&quot; title=&quot;Dart -&amp;gt; Rust Framed cross tests fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4187&quot;&gt;&lt;del&gt;THRIFT-4187&lt;/del&gt;&lt;/a&gt; Allow dart framed transport to read incomplete frame&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/allengeorge/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/allengeorge/thrift&lt;/a&gt; allen/thrift-4187-final&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1269&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit ebcc53c36cdd34d7d7c33a849ebda1cff3aa7241&lt;br/&gt;
Author: Allen George &amp;lt;allen.george@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-05-13T17:41:20Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4187&quot; title=&quot;Dart -&amp;gt; Rust Framed cross tests fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4187&quot;&gt;&lt;del&gt;THRIFT-4187&lt;/del&gt;&lt;/a&gt; Allow dart framed transport to read incomplete frame&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16009770" author="allengeorge" created="Sun, 14 May 2017 15:29:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markerickson-wk&quot; class=&quot;user-hover&quot; rel=&quot;markerickson-wk&quot;&gt;markerickson-wk&lt;/a&gt; I&apos;d really appreciate it if you could give this PR a once-over. FWIW, there no longer seem to be any issues with the Rust server and dart client communicating.&lt;/p&gt;

&lt;p&gt;The only two things I&apos;m not clear about:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Do I have to make my own completer a &quot;sync&quot;&lt;/li&gt;
	&lt;li&gt;Do I actually have to return something in the Future (right now I&apos;m returning an object, because I don&apos;t see the need to return the actual bytes)&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="16010520" author="githubbot" created="Mon, 15 May 2017 13:35:10 +0000"  >&lt;p&gt;Github user markerickson-wf commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269#discussion_r116491360&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269#discussion_r116491360&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/dart/lib/src/transport/t_framed_transport.dart &amp;#8212;&lt;br/&gt;
    @@ -51,33 +58,112 @@ class TFramedTransport extends TBufferedTransport &lt;/p&gt;
{
           if (got &amp;gt; 0) return got;
         }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;_readFrame();&lt;br/&gt;
    +    // IMPORTANT: by the time you&apos;ve got here,&lt;br/&gt;
    +    // an entire frame is available for reading&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         return super.read(buffer, offset, length);&lt;br/&gt;
       }&lt;/p&gt;

&lt;p&gt;       void _readFrame() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;_transport.readAll(headerBytes, 0, headerByteCount);&lt;/li&gt;
	&lt;li&gt;int size = headerBytes.buffer.asByteData().getUint32(0);&lt;br/&gt;
    +    if (_body == null) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +      bool gotFullHeader = _readFrameHeader();    +      if (!gotFullHeader) {
    +        return;
    +      }    +    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;    +&lt;br/&gt;
    +    _readFrameBody();&lt;br/&gt;
    +  }&lt;br/&gt;
    +&lt;br/&gt;
    +  bool _readFrameHeader() {&lt;br/&gt;
    +    var remainingHeaderBytes = headerByteCount - _receivedHeaderBytes;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (size &amp;lt; 0) {&lt;br/&gt;
    +    int got = _transport.read(_headerBytes, _receivedHeaderBytes, remainingHeaderBytes);&lt;br/&gt;
    +    if (got &amp;lt; 0) 
{
           throw new TTransportError(
    -          TTransportErrorType.UNKNOWN, &quot;Read a negative frame size: $size&quot;);
    +          TTransportErrorType.UNKNOWN, &quot;Socket closed during frame header read&quot;);
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Uint8List buffer = new Uint8List(size);&lt;/li&gt;
	&lt;li&gt;_transport.readAll(buffer, 0, size);&lt;/li&gt;
	&lt;li&gt;_setReadBuffer(buffer);&lt;br/&gt;
    +    _receivedHeaderBytes += got;&lt;br/&gt;
    +&lt;br/&gt;
    +    if (_receivedHeaderBytes == headerByteCount) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +      int size = _headerBytes.buffer.asByteData().getUint32(0);    +    +      _receivedHeaderBytes = 0;    +    +      if (size &amp;lt; 0) {
    +        throw new TTransportError(
    +            TTransportErrorType.UNKNOWN, &quot;Read a negative frame size: $size&quot;);
    +      }    +    +      _bodySize = size;    +      _body = new Uint8List(_bodySize);    +      _receivedBodyBytes = 0;    +    +      return true;    +    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; else &lt;/p&gt;
{
    +      _registerForReadableBytes();
    +      return false;
    +    }
&lt;p&gt;    +  }&lt;br/&gt;
    +&lt;br/&gt;
    +  void _readFrameBody() {&lt;br/&gt;
    +    var remainingBodyBytes = _bodySize - _receivedBodyBytes;&lt;br/&gt;
    +&lt;br/&gt;
    +    int got = _transport.read(_body, _receivedBodyBytes, remainingBodyBytes);&lt;br/&gt;
    +    if (got &amp;lt; 0) &lt;/p&gt;
{
    +      throw new TTransportError(
    +          TTransportErrorType.UNKNOWN, &quot;Socket closed during frame body read&quot;);
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    _receivedBodyBytes += got;&lt;br/&gt;
    +&lt;br/&gt;
    +    if (_receivedBodyBytes == _bodySize) {&lt;br/&gt;
    +      var body = _body;&lt;br/&gt;
    +&lt;br/&gt;
    +      _bodySize = 0;&lt;br/&gt;
    +      _body = null;&lt;br/&gt;
    +      _receivedBodyBytes = 0;&lt;br/&gt;
    +&lt;br/&gt;
    +      _setReadBuffer(body);&lt;br/&gt;
    +&lt;br/&gt;
    +      var completer = _frameCompleter;&lt;br/&gt;
    +      _frameCompleter = null;&lt;br/&gt;
    +      completer.complete(new Object());&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    `completer` is typed as a `Completer&amp;lt;Uint8List&amp;gt;`, so the Dart analyzer complains about passing `Object` here.&lt;/p&gt;</comment>
                            <comment id="16010521" author="githubbot" created="Mon, 15 May 2017 13:35:59 +0000"  >&lt;p&gt;Github user markerickson-wf commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269#discussion_r116491597&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269#discussion_r116491597&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/dart/lib/src/transport/t_framed_transport.dart &amp;#8212;&lt;br/&gt;
    @@ -51,33 +58,112 @@ class TFramedTransport extends TBufferedTransport &lt;/p&gt;
{
           if (got &amp;gt; 0) return got;
         }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;_readFrame();&lt;br/&gt;
    +    // IMPORTANT: by the time you&apos;ve got here,&lt;br/&gt;
    +    // an entire frame is available for reading&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         return super.read(buffer, offset, length);&lt;br/&gt;
       }&lt;/p&gt;

&lt;p&gt;       void _readFrame() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;_transport.readAll(headerBytes, 0, headerByteCount);&lt;/li&gt;
	&lt;li&gt;int size = headerBytes.buffer.asByteData().getUint32(0);&lt;br/&gt;
    +    if (_body == null) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +      bool gotFullHeader = _readFrameHeader();    +      if (!gotFullHeader) {
    +        return;
    +      }    +    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;    +&lt;br/&gt;
    +    _readFrameBody();&lt;br/&gt;
    +  }&lt;br/&gt;
    +&lt;br/&gt;
    +  bool _readFrameHeader() {&lt;br/&gt;
    +    var remainingHeaderBytes = headerByteCount - _receivedHeaderBytes;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (size &amp;lt; 0) {&lt;br/&gt;
    +    int got = _transport.read(_headerBytes, _receivedHeaderBytes, remainingHeaderBytes);&lt;br/&gt;
    +    if (got &amp;lt; 0) 
{
           throw new TTransportError(
    -          TTransportErrorType.UNKNOWN, &quot;Read a negative frame size: $size&quot;);
    +          TTransportErrorType.UNKNOWN, &quot;Socket closed during frame header read&quot;);
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Uint8List buffer = new Uint8List(size);&lt;/li&gt;
	&lt;li&gt;_transport.readAll(buffer, 0, size);&lt;/li&gt;
	&lt;li&gt;_setReadBuffer(buffer);&lt;br/&gt;
    +    _receivedHeaderBytes += got;&lt;br/&gt;
    +&lt;br/&gt;
    +    if (_receivedHeaderBytes == headerByteCount) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +      int size = _headerBytes.buffer.asByteData().getUint32(0);    +    +      _receivedHeaderBytes = 0;    +    +      if (size &amp;lt; 0) {
    +        throw new TTransportError(
    +            TTransportErrorType.UNKNOWN, &quot;Read a negative frame size: $size&quot;);
    +      }    +    +      _bodySize = size;    +      _body = new Uint8List(_bodySize);    +      _receivedBodyBytes = 0;    +    +      return true;    +    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; else &lt;/p&gt;
{
    +      _registerForReadableBytes();
    +      return false;
    +    }
&lt;p&gt;    +  }&lt;br/&gt;
    +&lt;br/&gt;
    +  void _readFrameBody() &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +    var remainingBodyBytes = _bodySize - _receivedBodyBytes;    +    +    int got = _transport.read(_body, _receivedBodyBytes, remainingBodyBytes);    +    if (got &amp;lt; 0) {
    +      throw new TTransportError(
    +          TTransportErrorType.UNKNOWN, &quot;Socket closed during frame body read&quot;);
    +    }    +    +    _receivedBodyBytes += got;    +    +    if (_receivedBodyBytes == _bodySize) {
    +      var body = _body;
    +
    +      _bodySize = 0;
    +      _body = null;
    +      _receivedBodyBytes = 0;
    +
    +      _setReadBuffer(body);
    +
    +      var completer = _frameCompleter;
    +      _frameCompleter = null;
    +      completer.complete(new Object());
    +    } else {
    +      _registerForReadableBytes();
    +    }       }&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;       Future flush() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Uint8List buffer = consumeWriteBuffer();&lt;/li&gt;
	&lt;li&gt;int length = buffer.length;&lt;br/&gt;
    +    if (_frameCompleter == null) {&lt;br/&gt;
    +      Uint8List buffer = consumeWriteBuffer();&lt;br/&gt;
    +      int length = buffer.length;&lt;br/&gt;
    +&lt;br/&gt;
    +      _headerBytes.buffer.asByteData().setUint32(0, length);&lt;br/&gt;
    +      _transport.write(_headerBytes, 0, headerByteCount);&lt;br/&gt;
    +      _transport.write(buffer, 0, length);&lt;br/&gt;
    +&lt;br/&gt;
    +      _frameCompleter  = new Completer&amp;lt;Object&amp;gt;(); // FIXME: .sync?!
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Did you mean to address this `FIXME`?&lt;/p&gt;</comment>
                            <comment id="16010563" author="githubbot" created="Mon, 15 May 2017 14:01:30 +0000"  >&lt;p&gt;Github user markerickson-wf commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    There are a couple of related unit tests that are failing in `t_socket_transport_test.dart`.  You can run `pub run test test/` from the `lib/dart` directory to see those.&lt;/p&gt;</comment>
                            <comment id="16010602" author="githubbot" created="Mon, 15 May 2017 14:22:46 +0000"  >&lt;p&gt;Github user markerickson-wf commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @allengeorge I think this approach looks pretty good at my first pass.  I left a couple of comments, and we&apos;ll probably want unit tests around the state transitions to ensure that all paths are covered  (setting / unsetting completers, resetting read counters, etc).  I&apos;ll also ask couple of other devs I know to review (they have done some recent work using framed transports in Dart).  Thanks for submitting the PR!&lt;/p&gt;</comment>
                            <comment id="16010626" author="githubbot" created="Mon, 15 May 2017 14:41:14 +0000"  >&lt;p&gt;Github user markerickson-wf commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269#discussion_r116509027&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269#discussion_r116509027&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/dart/lib/src/transport/t_framed_transport.dart &amp;#8212;&lt;br/&gt;
    @@ -51,33 +58,112 @@ class TFramedTransport extends TBufferedTransport &lt;/p&gt;
{
           if (got &amp;gt; 0) return got;
         }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;_readFrame();&lt;br/&gt;
    +    // IMPORTANT: by the time you&apos;ve got here,&lt;br/&gt;
    +    // an entire frame is available for reading&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         return super.read(buffer, offset, length);&lt;br/&gt;
       }&lt;/p&gt;

&lt;p&gt;       void _readFrame() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;_transport.readAll(headerBytes, 0, headerByteCount);&lt;/li&gt;
	&lt;li&gt;int size = headerBytes.buffer.asByteData().getUint32(0);&lt;br/&gt;
    +    if (_body == null) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +      bool gotFullHeader = _readFrameHeader();    +      if (!gotFullHeader) {
    +        return;
    +      }    +    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;    +&lt;br/&gt;
    +    _readFrameBody();&lt;br/&gt;
    +  }&lt;br/&gt;
    +&lt;br/&gt;
    +  bool _readFrameHeader() {&lt;br/&gt;
    +    var remainingHeaderBytes = headerByteCount - _receivedHeaderBytes;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (size &amp;lt; 0) {&lt;br/&gt;
    +    int got = _transport.read(_headerBytes, _receivedHeaderBytes, remainingHeaderBytes);&lt;br/&gt;
    +    if (got &amp;lt; 0) 
{
           throw new TTransportError(
    -          TTransportErrorType.UNKNOWN, &quot;Read a negative frame size: $size&quot;);
    +          TTransportErrorType.UNKNOWN, &quot;Socket closed during frame header read&quot;);
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Uint8List buffer = new Uint8List(size);&lt;/li&gt;
	&lt;li&gt;_transport.readAll(buffer, 0, size);&lt;/li&gt;
	&lt;li&gt;_setReadBuffer(buffer);&lt;br/&gt;
    +    _receivedHeaderBytes += got;&lt;br/&gt;
    +&lt;br/&gt;
    +    if (_receivedHeaderBytes == headerByteCount) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +      int size = _headerBytes.buffer.asByteData().getUint32(0);    +    +      _receivedHeaderBytes = 0;    +    +      if (size &amp;lt; 0) {
    +        throw new TTransportError(
    +            TTransportErrorType.UNKNOWN, &quot;Read a negative frame size: $size&quot;);
    +      }    +    +      _bodySize = size;    +      _body = new Uint8List(_bodySize);    +      _receivedBodyBytes = 0;    +    +      return true;    +    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; else {&lt;br/&gt;
    +      _registerForReadableBytes();&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Does this create a synchronous cycle if the header bytes are not available?  `_registerForReadableBytes`&lt;del&gt;&amp;gt;`_readFrame`&lt;/del&gt;&amp;gt;`readFrameHeader`&lt;del&gt;&amp;gt;`_registerForReadableBytes`&lt;/del&gt;&amp;gt;...   It seems like this would cause an unresponsive browser?&lt;/p&gt;</comment>
                            <comment id="16010629" author="githubbot" created="Mon, 15 May 2017 14:48:00 +0000"  >&lt;p&gt;Github user markerickson-wf commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269#discussion_r116510886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269#discussion_r116510886&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/dart/lib/src/transport/t_framed_transport.dart &amp;#8212;&lt;br/&gt;
    @@ -51,33 +58,112 @@ class TFramedTransport extends TBufferedTransport &lt;/p&gt;
{
           if (got &amp;gt; 0) return got;
         }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;_readFrame();&lt;br/&gt;
    +    // IMPORTANT: by the time you&apos;ve got here,&lt;br/&gt;
    +    // an entire frame is available for reading&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         return super.read(buffer, offset, length);&lt;br/&gt;
       }&lt;/p&gt;

&lt;p&gt;       void _readFrame() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;_transport.readAll(headerBytes, 0, headerByteCount);&lt;/li&gt;
	&lt;li&gt;int size = headerBytes.buffer.asByteData().getUint32(0);&lt;br/&gt;
    +    if (_body == null) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +      bool gotFullHeader = _readFrameHeader();    +      if (!gotFullHeader) {
    +        return;
    +      }    +    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;    +&lt;br/&gt;
    +    _readFrameBody();&lt;br/&gt;
    +  }&lt;br/&gt;
    +&lt;br/&gt;
    +  bool _readFrameHeader() {&lt;br/&gt;
    +    var remainingHeaderBytes = headerByteCount - _receivedHeaderBytes;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (size &amp;lt; 0) {&lt;br/&gt;
    +    int got = _transport.read(_headerBytes, _receivedHeaderBytes, remainingHeaderBytes);&lt;br/&gt;
    +    if (got &amp;lt; 0) 
{
           throw new TTransportError(
    -          TTransportErrorType.UNKNOWN, &quot;Read a negative frame size: $size&quot;);
    +          TTransportErrorType.UNKNOWN, &quot;Socket closed during frame header read&quot;);
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Uint8List buffer = new Uint8List(size);&lt;/li&gt;
	&lt;li&gt;_transport.readAll(buffer, 0, size);&lt;/li&gt;
	&lt;li&gt;_setReadBuffer(buffer);&lt;br/&gt;
    +    _receivedHeaderBytes += got;&lt;br/&gt;
    +&lt;br/&gt;
    +    if (_receivedHeaderBytes == headerByteCount) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +      int size = _headerBytes.buffer.asByteData().getUint32(0);    +    +      _receivedHeaderBytes = 0;    +    +      if (size &amp;lt; 0) {
    +        throw new TTransportError(
    +            TTransportErrorType.UNKNOWN, &quot;Read a negative frame size: $size&quot;);
    +      }    +    +      _bodySize = size;    +      _body = new Uint8List(_bodySize);    +      _receivedBodyBytes = 0;    +    +      return true;    +    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; else {&lt;br/&gt;
    +      _registerForReadableBytes();&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    At first I was reading it as causing a cycle, but `_registerForReadableBytes` will make an async call to `_transport.flush`, so I think this is okay on second thought.&lt;/p&gt;</comment>
                            <comment id="16010669" author="githubbot" created="Mon, 15 May 2017 15:09:04 +0000"  >&lt;p&gt;Github user allengeorge commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269#discussion_r116516987&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269#discussion_r116516987&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/dart/lib/src/transport/t_framed_transport.dart &amp;#8212;&lt;br/&gt;
    @@ -51,33 +58,112 @@ class TFramedTransport extends TBufferedTransport &lt;/p&gt;
{
           if (got &amp;gt; 0) return got;
         }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;_readFrame();&lt;br/&gt;
    +    // IMPORTANT: by the time you&apos;ve got here,&lt;br/&gt;
    +    // an entire frame is available for reading&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         return super.read(buffer, offset, length);&lt;br/&gt;
       }&lt;/p&gt;

&lt;p&gt;       void _readFrame() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;_transport.readAll(headerBytes, 0, headerByteCount);&lt;/li&gt;
	&lt;li&gt;int size = headerBytes.buffer.asByteData().getUint32(0);&lt;br/&gt;
    +    if (_body == null) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +      bool gotFullHeader = _readFrameHeader();    +      if (!gotFullHeader) {
    +        return;
    +      }    +    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;    +&lt;br/&gt;
    +    _readFrameBody();&lt;br/&gt;
    +  }&lt;br/&gt;
    +&lt;br/&gt;
    +  bool _readFrameHeader() {&lt;br/&gt;
    +    var remainingHeaderBytes = headerByteCount - _receivedHeaderBytes;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (size &amp;lt; 0) {&lt;br/&gt;
    +    int got = _transport.read(_headerBytes, _receivedHeaderBytes, remainingHeaderBytes);&lt;br/&gt;
    +    if (got &amp;lt; 0) 
{
           throw new TTransportError(
    -          TTransportErrorType.UNKNOWN, &quot;Read a negative frame size: $size&quot;);
    +          TTransportErrorType.UNKNOWN, &quot;Socket closed during frame header read&quot;);
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Uint8List buffer = new Uint8List(size);&lt;/li&gt;
	&lt;li&gt;_transport.readAll(buffer, 0, size);&lt;/li&gt;
	&lt;li&gt;_setReadBuffer(buffer);&lt;br/&gt;
    +    _receivedHeaderBytes += got;&lt;br/&gt;
    +&lt;br/&gt;
    +    if (_receivedHeaderBytes == headerByteCount) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +      int size = _headerBytes.buffer.asByteData().getUint32(0);    +    +      _receivedHeaderBytes = 0;    +    +      if (size &amp;lt; 0) {
    +        throw new TTransportError(
    +            TTransportErrorType.UNKNOWN, &quot;Read a negative frame size: $size&quot;);
    +      }    +    +      _bodySize = size;    +      _body = new Uint8List(_bodySize);    +      _receivedBodyBytes = 0;    +    +      return true;    +    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; else &lt;/p&gt;
{
    +      _registerForReadableBytes();
    +      return false;
    +    }
&lt;p&gt;    +  }&lt;br/&gt;
    +&lt;br/&gt;
    +  void _readFrameBody() {&lt;br/&gt;
    +    var remainingBodyBytes = _bodySize - _receivedBodyBytes;&lt;br/&gt;
    +&lt;br/&gt;
    +    int got = _transport.read(_body, _receivedBodyBytes, remainingBodyBytes);&lt;br/&gt;
    +    if (got &amp;lt; 0) &lt;/p&gt;
{
    +      throw new TTransportError(
    +          TTransportErrorType.UNKNOWN, &quot;Socket closed during frame body read&quot;);
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    _receivedBodyBytes += got;&lt;br/&gt;
    +&lt;br/&gt;
    +    if (_receivedBodyBytes == _bodySize) {&lt;br/&gt;
    +      var body = _body;&lt;br/&gt;
    +&lt;br/&gt;
    +      _bodySize = 0;&lt;br/&gt;
    +      _body = null;&lt;br/&gt;
    +      _receivedBodyBytes = 0;&lt;br/&gt;
    +&lt;br/&gt;
    +      _setReadBuffer(body);&lt;br/&gt;
    +&lt;br/&gt;
    +      var completer = _frameCompleter;&lt;br/&gt;
    +      _frameCompleter = null;&lt;br/&gt;
    +      completer.complete(new Object());&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I was a little worried about returning the frame bytes, but I guess it doesn&apos;t matter. Also, I assume that each call to `iterator` returns a completely separate iterator with a view to the underlying buffer.&lt;/p&gt;

&lt;p&gt;    I&apos;ll change it. BTW, it&apos;s a little weird that `flush()` returns bytes...&lt;/p&gt;</comment>
                            <comment id="16010671" author="githubbot" created="Mon, 15 May 2017 15:10:05 +0000"  >&lt;p&gt;Github user allengeorge commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269#discussion_r116517213&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269#discussion_r116517213&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/dart/lib/src/transport/t_framed_transport.dart &amp;#8212;&lt;br/&gt;
    @@ -51,33 +58,112 @@ class TFramedTransport extends TBufferedTransport &lt;/p&gt;
{
           if (got &amp;gt; 0) return got;
         }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;_readFrame();&lt;br/&gt;
    +    // IMPORTANT: by the time you&apos;ve got here,&lt;br/&gt;
    +    // an entire frame is available for reading&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         return super.read(buffer, offset, length);&lt;br/&gt;
       }&lt;/p&gt;

&lt;p&gt;       void _readFrame() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;_transport.readAll(headerBytes, 0, headerByteCount);&lt;/li&gt;
	&lt;li&gt;int size = headerBytes.buffer.asByteData().getUint32(0);&lt;br/&gt;
    +    if (_body == null) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +      bool gotFullHeader = _readFrameHeader();    +      if (!gotFullHeader) {
    +        return;
    +      }    +    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;    +&lt;br/&gt;
    +    _readFrameBody();&lt;br/&gt;
    +  }&lt;br/&gt;
    +&lt;br/&gt;
    +  bool _readFrameHeader() {&lt;br/&gt;
    +    var remainingHeaderBytes = headerByteCount - _receivedHeaderBytes;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (size &amp;lt; 0) {&lt;br/&gt;
    +    int got = _transport.read(_headerBytes, _receivedHeaderBytes, remainingHeaderBytes);&lt;br/&gt;
    +    if (got &amp;lt; 0) 
{
           throw new TTransportError(
    -          TTransportErrorType.UNKNOWN, &quot;Read a negative frame size: $size&quot;);
    +          TTransportErrorType.UNKNOWN, &quot;Socket closed during frame header read&quot;);
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Uint8List buffer = new Uint8List(size);&lt;/li&gt;
	&lt;li&gt;_transport.readAll(buffer, 0, size);&lt;/li&gt;
	&lt;li&gt;_setReadBuffer(buffer);&lt;br/&gt;
    +    _receivedHeaderBytes += got;&lt;br/&gt;
    +&lt;br/&gt;
    +    if (_receivedHeaderBytes == headerByteCount) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +      int size = _headerBytes.buffer.asByteData().getUint32(0);    +    +      _receivedHeaderBytes = 0;    +    +      if (size &amp;lt; 0) {
    +        throw new TTransportError(
    +            TTransportErrorType.UNKNOWN, &quot;Read a negative frame size: $size&quot;);
    +      }    +    +      _bodySize = size;    +      _body = new Uint8List(_bodySize);    +      _receivedBodyBytes = 0;    +    +      return true;    +    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; else &lt;/p&gt;
{
    +      _registerForReadableBytes();
    +      return false;
    +    }
&lt;p&gt;    +  }&lt;br/&gt;
    +&lt;br/&gt;
    +  void _readFrameBody() &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +    var remainingBodyBytes = _bodySize - _receivedBodyBytes;    +    +    int got = _transport.read(_body, _receivedBodyBytes, remainingBodyBytes);    +    if (got &amp;lt; 0) {
    +      throw new TTransportError(
    +          TTransportErrorType.UNKNOWN, &quot;Socket closed during frame body read&quot;);
    +    }    +    +    _receivedBodyBytes += got;    +    +    if (_receivedBodyBytes == _bodySize) {
    +      var body = _body;
    +
    +      _bodySize = 0;
    +      _body = null;
    +      _receivedBodyBytes = 0;
    +
    +      _setReadBuffer(body);
    +
    +      var completer = _frameCompleter;
    +      _frameCompleter = null;
    +      completer.complete(new Object());
    +    } else {
    +      _registerForReadableBytes();
    +    }       }&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;       Future flush() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Uint8List buffer = consumeWriteBuffer();&lt;/li&gt;
	&lt;li&gt;int length = buffer.length;&lt;br/&gt;
    +    if (_frameCompleter == null) {&lt;br/&gt;
    +      Uint8List buffer = consumeWriteBuffer();&lt;br/&gt;
    +      int length = buffer.length;&lt;br/&gt;
    +&lt;br/&gt;
    +      _headerBytes.buffer.asByteData().setUint32(0, length);&lt;br/&gt;
    +      _transport.write(_headerBytes, 0, headerByteCount);&lt;br/&gt;
    +      _transport.write(buffer, 0, length);&lt;br/&gt;
    +&lt;br/&gt;
    +      _frameCompleter  = new Completer&amp;lt;Object&amp;gt;(); // FIXME: .sync?!
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Ah. Actually I need advice from you as to whether this has to be a `sync` `Completer` or not &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; It&apos;s not quite clear to me when one would choose one, and whether that&apos;s necessary at this point.&lt;/p&gt;</comment>
                            <comment id="16010674" author="githubbot" created="Mon, 15 May 2017 15:10:49 +0000"  >&lt;p&gt;Github user allengeorge commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269#discussion_r116517412&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269#discussion_r116517412&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/dart/lib/src/transport/t_framed_transport.dart &amp;#8212;&lt;br/&gt;
    @@ -51,33 +58,112 @@ class TFramedTransport extends TBufferedTransport &lt;/p&gt;
{
           if (got &amp;gt; 0) return got;
         }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;_readFrame();&lt;br/&gt;
    +    // IMPORTANT: by the time you&apos;ve got here,&lt;br/&gt;
    +    // an entire frame is available for reading&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         return super.read(buffer, offset, length);&lt;br/&gt;
       }&lt;/p&gt;

&lt;p&gt;       void _readFrame() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;_transport.readAll(headerBytes, 0, headerByteCount);&lt;/li&gt;
	&lt;li&gt;int size = headerBytes.buffer.asByteData().getUint32(0);&lt;br/&gt;
    +    if (_body == null) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +      bool gotFullHeader = _readFrameHeader();    +      if (!gotFullHeader) {
    +        return;
    +      }    +    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;    +&lt;br/&gt;
    +    _readFrameBody();&lt;br/&gt;
    +  }&lt;br/&gt;
    +&lt;br/&gt;
    +  bool _readFrameHeader() {&lt;br/&gt;
    +    var remainingHeaderBytes = headerByteCount - _receivedHeaderBytes;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (size &amp;lt; 0) {&lt;br/&gt;
    +    int got = _transport.read(_headerBytes, _receivedHeaderBytes, remainingHeaderBytes);&lt;br/&gt;
    +    if (got &amp;lt; 0) 
{
           throw new TTransportError(
    -          TTransportErrorType.UNKNOWN, &quot;Read a negative frame size: $size&quot;);
    +          TTransportErrorType.UNKNOWN, &quot;Socket closed during frame header read&quot;);
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Uint8List buffer = new Uint8List(size);&lt;/li&gt;
	&lt;li&gt;_transport.readAll(buffer, 0, size);&lt;/li&gt;
	&lt;li&gt;_setReadBuffer(buffer);&lt;br/&gt;
    +    _receivedHeaderBytes += got;&lt;br/&gt;
    +&lt;br/&gt;
    +    if (_receivedHeaderBytes == headerByteCount) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +      int size = _headerBytes.buffer.asByteData().getUint32(0);    +    +      _receivedHeaderBytes = 0;    +    +      if (size &amp;lt; 0) {
    +        throw new TTransportError(
    +            TTransportErrorType.UNKNOWN, &quot;Read a negative frame size: $size&quot;);
    +      }    +    +      _bodySize = size;    +      _body = new Uint8List(_bodySize);    +      _receivedBodyBytes = 0;    +    +      return true;    +    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; else {&lt;br/&gt;
    +      _registerForReadableBytes();&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    It shouldn&apos;t cause a cycle, but I may have missed something? It&apos;s the first time I&apos;ve done anything with Dart.&lt;/p&gt;</comment>
                            <comment id="16010676" author="githubbot" created="Mon, 15 May 2017 15:11:34 +0000"  >&lt;p&gt;Github user allengeorge commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @markerickson-wf My bad - I should definitely have run the unit tests. I&apos;ll check them and fix them up. Also, I&apos;ll look into how to create a reasonable set of unit tests for the framed transport.&lt;/p&gt;</comment>
                            <comment id="16010685" author="githubbot" created="Mon, 15 May 2017 15:16:40 +0000"  >&lt;p&gt;Github user markerickson-wf commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269#discussion_r116519094&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269#discussion_r116519094&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/dart/lib/src/transport/t_framed_transport.dart &amp;#8212;&lt;br/&gt;
    @@ -51,33 +58,112 @@ class TFramedTransport extends TBufferedTransport &lt;/p&gt;
{
           if (got &amp;gt; 0) return got;
         }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;_readFrame();&lt;br/&gt;
    +    // IMPORTANT: by the time you&apos;ve got here,&lt;br/&gt;
    +    // an entire frame is available for reading&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         return super.read(buffer, offset, length);&lt;br/&gt;
       }&lt;/p&gt;

&lt;p&gt;       void _readFrame() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;_transport.readAll(headerBytes, 0, headerByteCount);&lt;/li&gt;
	&lt;li&gt;int size = headerBytes.buffer.asByteData().getUint32(0);&lt;br/&gt;
    +    if (_body == null) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +      bool gotFullHeader = _readFrameHeader();    +      if (!gotFullHeader) {
    +        return;
    +      }    +    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;    +&lt;br/&gt;
    +    _readFrameBody();&lt;br/&gt;
    +  }&lt;br/&gt;
    +&lt;br/&gt;
    +  bool _readFrameHeader() {&lt;br/&gt;
    +    var remainingHeaderBytes = headerByteCount - _receivedHeaderBytes;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (size &amp;lt; 0) {&lt;br/&gt;
    +    int got = _transport.read(_headerBytes, _receivedHeaderBytes, remainingHeaderBytes);&lt;br/&gt;
    +    if (got &amp;lt; 0) 
{
           throw new TTransportError(
    -          TTransportErrorType.UNKNOWN, &quot;Read a negative frame size: $size&quot;);
    +          TTransportErrorType.UNKNOWN, &quot;Socket closed during frame header read&quot;);
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Uint8List buffer = new Uint8List(size);&lt;/li&gt;
	&lt;li&gt;_transport.readAll(buffer, 0, size);&lt;/li&gt;
	&lt;li&gt;_setReadBuffer(buffer);&lt;br/&gt;
    +    _receivedHeaderBytes += got;&lt;br/&gt;
    +&lt;br/&gt;
    +    if (_receivedHeaderBytes == headerByteCount) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +      int size = _headerBytes.buffer.asByteData().getUint32(0);    +    +      _receivedHeaderBytes = 0;    +    +      if (size &amp;lt; 0) {
    +        throw new TTransportError(
    +            TTransportErrorType.UNKNOWN, &quot;Read a negative frame size: $size&quot;);
    +      }    +    +      _bodySize = size;    +      _body = new Uint8List(_bodySize);    +      _receivedBodyBytes = 0;    +    +      return true;    +    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; else {&lt;br/&gt;
    +      _registerForReadableBytes();&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Yeah, I think it should be okay, sorry for raising the false alarm on my deleted comment.&lt;/p&gt;</comment>
                            <comment id="16010714" author="githubbot" created="Mon, 15 May 2017 15:32:14 +0000"  >&lt;p&gt;Github user markerickson-wf commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269#discussion_r116523611&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269#discussion_r116523611&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/dart/lib/src/transport/t_framed_transport.dart &amp;#8212;&lt;br/&gt;
    @@ -51,33 +58,112 @@ class TFramedTransport extends TBufferedTransport &lt;/p&gt;
{
           if (got &amp;gt; 0) return got;
         }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;_readFrame();&lt;br/&gt;
    +    // IMPORTANT: by the time you&apos;ve got here,&lt;br/&gt;
    +    // an entire frame is available for reading&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         return super.read(buffer, offset, length);&lt;br/&gt;
       }&lt;/p&gt;

&lt;p&gt;       void _readFrame() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;_transport.readAll(headerBytes, 0, headerByteCount);&lt;/li&gt;
	&lt;li&gt;int size = headerBytes.buffer.asByteData().getUint32(0);&lt;br/&gt;
    +    if (_body == null) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +      bool gotFullHeader = _readFrameHeader();    +      if (!gotFullHeader) {
    +        return;
    +      }    +    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;    +&lt;br/&gt;
    +    _readFrameBody();&lt;br/&gt;
    +  }&lt;br/&gt;
    +&lt;br/&gt;
    +  bool _readFrameHeader() {&lt;br/&gt;
    +    var remainingHeaderBytes = headerByteCount - _receivedHeaderBytes;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (size &amp;lt; 0) {&lt;br/&gt;
    +    int got = _transport.read(_headerBytes, _receivedHeaderBytes, remainingHeaderBytes);&lt;br/&gt;
    +    if (got &amp;lt; 0) 
{
           throw new TTransportError(
    -          TTransportErrorType.UNKNOWN, &quot;Read a negative frame size: $size&quot;);
    +          TTransportErrorType.UNKNOWN, &quot;Socket closed during frame header read&quot;);
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Uint8List buffer = new Uint8List(size);&lt;/li&gt;
	&lt;li&gt;_transport.readAll(buffer, 0, size);&lt;/li&gt;
	&lt;li&gt;_setReadBuffer(buffer);&lt;br/&gt;
    +    _receivedHeaderBytes += got;&lt;br/&gt;
    +&lt;br/&gt;
    +    if (_receivedHeaderBytes == headerByteCount) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +      int size = _headerBytes.buffer.asByteData().getUint32(0);    +    +      _receivedHeaderBytes = 0;    +    +      if (size &amp;lt; 0) {
    +        throw new TTransportError(
    +            TTransportErrorType.UNKNOWN, &quot;Read a negative frame size: $size&quot;);
    +      }    +    +      _bodySize = size;    +      _body = new Uint8List(_bodySize);    +      _receivedBodyBytes = 0;    +    +      return true;    +    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; else &lt;/p&gt;
{
    +      _registerForReadableBytes();
    +      return false;
    +    }
&lt;p&gt;    +  }&lt;br/&gt;
    +&lt;br/&gt;
    +  void _readFrameBody() {&lt;br/&gt;
    +    var remainingBodyBytes = _bodySize - _receivedBodyBytes;&lt;br/&gt;
    +&lt;br/&gt;
    +    int got = _transport.read(_body, _receivedBodyBytes, remainingBodyBytes);&lt;br/&gt;
    +    if (got &amp;lt; 0) &lt;/p&gt;
{
    +      throw new TTransportError(
    +          TTransportErrorType.UNKNOWN, &quot;Socket closed during frame body read&quot;);
    +    }
&lt;p&gt;    +&lt;br/&gt;
    +    _receivedBodyBytes += got;&lt;br/&gt;
    +&lt;br/&gt;
    +    if (_receivedBodyBytes == _bodySize) {&lt;br/&gt;
    +      var body = _body;&lt;br/&gt;
    +&lt;br/&gt;
    +      _bodySize = 0;&lt;br/&gt;
    +      _body = null;&lt;br/&gt;
    +      _receivedBodyBytes = 0;&lt;br/&gt;
    +&lt;br/&gt;
    +      _setReadBuffer(body);&lt;br/&gt;
    +&lt;br/&gt;
    +      var completer = _frameCompleter;&lt;br/&gt;
    +      _frameCompleter = null;&lt;br/&gt;
    +      completer.complete(new Object());&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Yeah, I don&apos;t think you need to type `Completer` at all, and you can just `complete()`.  In this case the Future is just a signal of completion, I agree we don&apos;t need to return the bytes.&lt;/p&gt;</comment>
                            <comment id="16010726" author="githubbot" created="Mon, 15 May 2017 15:37:18 +0000"  >&lt;p&gt;Github user markerickson-wf commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269#discussion_r116525084&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269#discussion_r116525084&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/dart/lib/src/transport/t_framed_transport.dart &amp;#8212;&lt;br/&gt;
    @@ -51,33 +58,112 @@ class TFramedTransport extends TBufferedTransport &lt;/p&gt;
{
           if (got &amp;gt; 0) return got;
         }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;_readFrame();&lt;br/&gt;
    +    // IMPORTANT: by the time you&apos;ve got here,&lt;br/&gt;
    +    // an entire frame is available for reading&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         return super.read(buffer, offset, length);&lt;br/&gt;
       }&lt;/p&gt;

&lt;p&gt;       void _readFrame() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;_transport.readAll(headerBytes, 0, headerByteCount);&lt;/li&gt;
	&lt;li&gt;int size = headerBytes.buffer.asByteData().getUint32(0);&lt;br/&gt;
    +    if (_body == null) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +      bool gotFullHeader = _readFrameHeader();    +      if (!gotFullHeader) {
    +        return;
    +      }    +    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;    +&lt;br/&gt;
    +    _readFrameBody();&lt;br/&gt;
    +  }&lt;br/&gt;
    +&lt;br/&gt;
    +  bool _readFrameHeader() {&lt;br/&gt;
    +    var remainingHeaderBytes = headerByteCount - _receivedHeaderBytes;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (size &amp;lt; 0) {&lt;br/&gt;
    +    int got = _transport.read(_headerBytes, _receivedHeaderBytes, remainingHeaderBytes);&lt;br/&gt;
    +    if (got &amp;lt; 0) 
{
           throw new TTransportError(
    -          TTransportErrorType.UNKNOWN, &quot;Read a negative frame size: $size&quot;);
    +          TTransportErrorType.UNKNOWN, &quot;Socket closed during frame header read&quot;);
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Uint8List buffer = new Uint8List(size);&lt;/li&gt;
	&lt;li&gt;_transport.readAll(buffer, 0, size);&lt;/li&gt;
	&lt;li&gt;_setReadBuffer(buffer);&lt;br/&gt;
    +    _receivedHeaderBytes += got;&lt;br/&gt;
    +&lt;br/&gt;
    +    if (_receivedHeaderBytes == headerByteCount) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +      int size = _headerBytes.buffer.asByteData().getUint32(0);    +    +      _receivedHeaderBytes = 0;    +    +      if (size &amp;lt; 0) {
    +        throw new TTransportError(
    +            TTransportErrorType.UNKNOWN, &quot;Read a negative frame size: $size&quot;);
    +      }    +    +      _bodySize = size;    +      _body = new Uint8List(_bodySize);    +      _receivedBodyBytes = 0;    +    +      return true;    +    }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; else &lt;/p&gt;
{
    +      _registerForReadableBytes();
    +      return false;
    +    }
&lt;p&gt;    +  }&lt;br/&gt;
    +&lt;br/&gt;
    +  void _readFrameBody() &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {    +    var remainingBodyBytes = _bodySize - _receivedBodyBytes;    +    +    int got = _transport.read(_body, _receivedBodyBytes, remainingBodyBytes);    +    if (got &amp;lt; 0) {
    +      throw new TTransportError(
    +          TTransportErrorType.UNKNOWN, &quot;Socket closed during frame body read&quot;);
    +    }    +    +    _receivedBodyBytes += got;    +    +    if (_receivedBodyBytes == _bodySize) {
    +      var body = _body;
    +
    +      _bodySize = 0;
    +      _body = null;
    +      _receivedBodyBytes = 0;
    +
    +      _setReadBuffer(body);
    +
    +      var completer = _frameCompleter;
    +      _frameCompleter = null;
    +      completer.complete(new Object());
    +    } else {
    +      _registerForReadableBytes();
    +    }       }&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;       Future flush() {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Uint8List buffer = consumeWriteBuffer();&lt;/li&gt;
	&lt;li&gt;int length = buffer.length;&lt;br/&gt;
    +    if (_frameCompleter == null) {&lt;br/&gt;
    +      Uint8List buffer = consumeWriteBuffer();&lt;br/&gt;
    +      int length = buffer.length;&lt;br/&gt;
    +&lt;br/&gt;
    +      _headerBytes.buffer.asByteData().setUint32(0, length);&lt;br/&gt;
    +      _transport.write(_headerBytes, 0, headerByteCount);&lt;br/&gt;
    +      _transport.write(buffer, 0, length);&lt;br/&gt;
    +&lt;br/&gt;
    +      _frameCompleter  = new Completer&amp;lt;Object&amp;gt;(); // FIXME: .sync?!
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    &lt;a href=&quot;https://api.dartlang.org/stable/1.23.0/dart-async/Completer/Completer.sync.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://api.dartlang.org/stable/1.23.0/dart-async/Completer/Completer.sync.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Despite the warning above, I used `sync` &lt;span class=&quot;error&quot;&gt;&amp;#91;in t_http_transport&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/thrift/blob/master/lib/dart/lib/src/transport/t_http_transport.dart#L52&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/blob/master/lib/dart/lib/src/transport/t_http_transport.dart#L52&lt;/a&gt;).  If I recall correctly, this is a symptom of adapting the sync API to an async system.  If two subsequent messages arrive on the socket, the second could stomp on the first before the listener has a chance to react.  i.e. `flush`&lt;del&gt;&amp;gt;`complete message 1`&lt;/del&gt;&amp;gt;`complete message 2`&lt;del&gt;&amp;gt;`read`&lt;/del&gt;&amp;gt;`read`.  By using a sync completer, I think the first listener should be able to read before the second message is completed.&lt;/p&gt;</comment>
                            <comment id="16175366" author="githubbot" created="Thu, 21 Sep 2017 20:03:19 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This pull request needs to be completed.  &lt;b&gt;nudge&lt;/b&gt;&lt;/p&gt;</comment>
                            <comment id="16176324" author="allengeorge" created="Fri, 22 Sep 2017 12:09:05 +0000"  >&lt;p&gt;Ooops. Yup - will get on this soon!&lt;/p&gt;</comment>
                            <comment id="16218794" author="githubbot" created="Wed, 25 Oct 2017 14:44:08 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @allengeorge if you add framed transport in dart to the cross test, that would test a lot... but it would not test error conditions such as this one.  Just a reminder, this needs to move forward.&lt;/p&gt;</comment>
                            <comment id="16218805" author="githubbot" created="Wed, 25 Oct 2017 14:47:04 +0000"  >&lt;p&gt;Github user allengeorge commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Hi James - I&#8217;m really sorry for the delay; slammed at work. I&#8217;ll work on it this weekend.&lt;/p&gt;

&lt;p&gt;    Again, super sorry about this&lt;/p&gt;

&lt;p&gt;    ________________________________&lt;br/&gt;
    From: James E. King, III &amp;lt;notifications@github.com&amp;gt;&lt;br/&gt;
    Sent: Wednesday, October 25, 2017 10:44:19 AM&lt;br/&gt;
    To: apache/thrift&lt;br/&gt;
    Cc: Allen George; Mention&lt;br/&gt;
    Subject: Re: &lt;span class=&quot;error&quot;&gt;&amp;#91;apache/thrift&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4187&quot; title=&quot;Dart -&amp;gt; Rust Framed cross tests fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4187&quot;&gt;&lt;del&gt;THRIFT-4187&lt;/del&gt;&lt;/a&gt; Allow dart framed transport to read incomplete frame (#1269)&lt;/p&gt;


&lt;p&gt;    @allengeorge&amp;lt;&lt;a href=&quot;https://github.com/allengeorge&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/allengeorge&lt;/a&gt;&amp;gt; if you add framed transport in dart to the cross test, that would test a lot... but it would not test error conditions such as this one. Just a reminder, this needs to move forward.&lt;/p&gt;

&lt;p&gt;    &#8212;&lt;br/&gt;
    You are receiving this because you were mentioned.&lt;br/&gt;
    Reply to this email directly, view it on GitHub&amp;lt;&lt;a href=&quot;https://github.com/apache/thrift/pull/1269#issuecomment-339353877&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269#issuecomment-339353877&lt;/a&gt;&amp;gt;, or mute the thread&amp;lt;&lt;a href=&quot;https://github.com/notifications/unsubscribe-auth/AAEO9HLOiegU2gF0E4zeUS7XjKsp5ZJlks5sv0lDgaJpZM4NaaLl&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/notifications/unsubscribe-auth/AAEO9HLOiegU2gF0E4zeUS7XjKsp5ZJlks5sv0lDgaJpZM4NaaLl&lt;/a&gt;&amp;gt;.&lt;/p&gt;
</comment>
                            <comment id="16218816" author="githubbot" created="Wed, 25 Oct 2017 14:49:48 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Don&apos;t worry, I&apos;m just doing my usual &quot;push things forward&quot; bit. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  I got the backlog down to 52 open PRs, but that&apos;s still about 45 too many for my taste.&lt;/p&gt;</comment>
                            <comment id="16239037" author="allengeorge" created="Sat, 4 Nov 2017 14:26:07 +0000"  >&lt;p&gt;Just a ping that I&apos;m restarting work on this now. Will re-learn Dart and try write some tests &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16386835" author="githubbot" created="Mon, 5 Mar 2018 22:11:02 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This needs to be rebased and completed.&lt;/p&gt;</comment>
                            <comment id="16397134" author="githubbot" created="Tue, 13 Mar 2018 15:48:35 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This needs to be rebased and completed.&lt;/p&gt;</comment>
                            <comment id="16397190" author="githubbot" created="Tue, 13 Mar 2018 16:17:05 +0000"  >&lt;p&gt;Github user allengeorge commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Yup. Will do. I&apos;m a gonna set myself a target to get it done by end of next week. I&apos;ve been lax on this :/&lt;/p&gt;</comment>
                            <comment id="16403473" author="githubbot" created="Sat, 17 Mar 2018 15:05:41 +0000"  >&lt;p&gt;Github user allengeorge commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @jeking3 Fixed up the failing tests. Confirming that precross works.&lt;/p&gt;</comment>
                            <comment id="16404764" author="githubbot" created="Mon, 19 Mar 2018 12:55:55 +0000"  >&lt;p&gt;Github user allengeorge commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @jeking3 I&apos;ve added unit tests around this behavior and enabled more cross tests! Do you want me to roll that into this PR, or should I create another bug and PR?&lt;/p&gt;</comment>
                            <comment id="16406194" author="githubbot" created="Tue, 20 Mar 2018 11:40:09 +0000"  >&lt;p&gt;Github user allengeorge commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @jeking3 Any chance this could be merged? TY!&lt;/p&gt;</comment>
                            <comment id="16406222" author="githubbot" created="Tue, 20 Mar 2018 11:56:08 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I&apos;d suggest waiting to see how the CI build fares given a change was made.  So today is a distinct possibility.  Also, you can commit your own changes.  There&apos;s no rule against it. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16406569" author="githubbot" created="Tue, 20 Mar 2018 16:09:05 +0000"  >&lt;p&gt;Github user markerickson-wf commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    +1&lt;/p&gt;</comment>
                            <comment id="16406949" author="githubbot" created="Tue, 20 Mar 2018 20:16:55 +0000"  >&lt;p&gt;Github user allengeorge commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    No problem! I&apos;m sorry I was lax and left it so long :/&lt;/p&gt;

&lt;p&gt;    Looks like the tests passed, so it&apos;s good to merge. Not 100% of the process, so I&apos;ll follow up via email.&lt;/p&gt;</comment>
                            <comment id="16406952" author="githubbot" created="Tue, 20 Mar 2018 20:23:11 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16406962" author="githubbot" created="Tue, 20 Mar 2018 20:29:13 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Remember to resolve &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4187&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/THRIFT-4187&lt;/a&gt; as fixed in 0.12.0.&lt;/p&gt;</comment>
                            <comment id="16406963" author="allengeorge" created="Tue, 20 Mar 2018 20:29:26 +0000"  >&lt;p&gt;Fixed as of b4960838a3b20e6bcf61727f21214a47418a2ca5&lt;/p&gt;</comment>
                            <comment id="16406968" author="githubbot" created="Tue, 20 Mar 2018 20:30:22 +0000"  >&lt;p&gt;Github user allengeorge commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1269&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @jeking3 Yup - just did that. Is there a way to do it automatically, or is it a manual process (for now)?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 35 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ebgn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>