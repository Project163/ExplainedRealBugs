<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:30:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-4805] Suppress excessive logging of SASL TTransportExceptions in case of END_OF_FILE </title>
                <link>https://issues.apache.org/jira/browse/THRIFT-4805</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;This has to do with the fix checked in for &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3769&quot; title=&quot;Fix logic of THRIFT-2268&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3769&quot;&gt;&lt;del&gt;THRIFT-3769&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2268&quot; title=&quot;Modify TSaslTransport to ignore TCP health checks from loadbalancers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2268&quot;&gt;&lt;del&gt;THRIFT-2268&lt;/del&gt;&lt;/a&gt;, which was to mute the noise from&#160;&lt;tt&gt;TSaslTransportExceptions&lt;/tt&gt; raised from load-balancer health-checks for Thrift services, such as the Hive metastore. Please consider &lt;a href=&quot;https://github.com/apache/thrift/blob/master/lib/java/src/org/apache/thrift/server/TThreadPoolServer.java#L322&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the code in TThreadPoolServer::run()&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;TThreadPoolServer.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (TException tx) {
        LOGGER.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Thrift error occurred during processing of message.&quot;&lt;/span&gt;, tx);
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception x) {
        &lt;span class=&quot;code-comment&quot;&gt;// We&apos;ll usually receive RuntimeException types here
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// Need to unwrap to ascertain real causing exception before we choose to ignore
&lt;/span&gt;        Throwable realCause = x.getCause();
        &lt;span class=&quot;code-comment&quot;&gt;// Ignore err-logging all transport-level/type exceptions
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((realCause != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; realCause &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; TTransportException)
            || (x &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; TTransportException)) {
          LOGGER.debug(
              &lt;span class=&quot;code-quote&quot;&gt;&quot;Received TTransportException during processing of message. Ignoring.&quot;&lt;/span&gt;,
              x);
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
          &lt;span class=&quot;code-comment&quot;&gt;// Log the exception at error level and &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;
&lt;/span&gt;          LOGGER.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Error occurred during processing of message.&quot;&lt;/span&gt;, x);
        }
      } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {...}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The logic here is solid for &lt;tt&gt;RuntimeExceptions&lt;/tt&gt; that wrap &lt;tt&gt;TTansportExceptions&lt;/tt&gt;. But it slips up on handling the condition being checked for at &lt;a href=&quot;https://github.com/apache/thrift/blob/master/lib/java/src/org/apache/thrift/server/TThreadPoolServer.java#L323&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;line#323&lt;/a&gt;, i.e.:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;TThreadPoolServer.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            || (x &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; TTransportException)) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The &lt;tt&gt;catch (Exception x)&lt;/tt&gt; comes &lt;b&gt;after&lt;/b&gt; the &lt;tt&gt;catch (TException tx)&lt;/tt&gt;, so it&apos;s a guarantee that &lt;tt&gt;!(x instanceof TTransportException)&lt;/tt&gt;. When a &lt;tt&gt;TTransportException&lt;/tt&gt; (or &lt;tt&gt;TSaslTransportException&lt;/tt&gt;) is thrown, it will be caught in the first catch block, and logged. This rather defeats the purpose of the fix. The error manifests with the following stack-trace filling up my logs:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.thrift.transport.TTransportException
        at org.apache.thrift.transport.TIOStreamTransport.read(TIOStreamTransport.java:132)
        at org.apache.thrift.transport.TTransport.readAll(TTransport.java:86)
        at org.apache.thrift.transport.TSaslTransport.readLength(TSaslTransport.java:374)
        at org.apache.thrift.transport.TSaslTransport.readFrame(TSaslTransport.java:451)
        at org.apache.thrift.transport.TSaslTransport.read(TSaslTransport.java:433)
        at org.apache.thrift.transport.TSaslServerTransport.read(TSaslServerTransport.java:43)
        at org.apache.thrift.transport.TTransport.readAll(TTransport.java:86)
        at org.apache.thrift.protocol.TBinaryProtocol.readAll(TBinaryProtocol.java:425)
        at org.apache.thrift.protocol.TBinaryProtocol.readI32(TBinaryProtocol.java:321)
        at org.apache.thrift.protocol.TBinaryProtocol.readMessageBegin(TBinaryProtocol.java:225)
        at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:27)
        at org.apache.hive.service.cli.thrift.ThriftCLIMetricsProcessor.process(ThriftCLIMetricsProcessor.java:63)
        at org.apache.hadoop.hive.thrift.HadoopThriftAuthBridge$Server$TUGIAssumingProcessor$2.run(HadoopThriftAuthBridge.java:777)
        at org.apache.hadoop.hive.thrift.HadoopThriftAuthBridge$Server$TUGIAssumingProcessor$2.run(HadoopThriftAuthBridge.java:773)
        at java.security.AccessController.doPrivileged(Native Method)
        at javax.security.auth.Subject.doAs(Subject.java:422)
        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1953)
        at org.apache.hadoop.hive.thrift.HadoopThriftAuthBridge$Server$TUGIAssumingProcessor.process(HadoopThriftAuthBridge.java:773)
        at org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadPoolServer.java:310)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
        at java.lang.Thread.run(Thread.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The fix is simple. I&apos;ll upload it shortly, for review.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13216113">THRIFT-4805</key>
            <summary>Suppress excessive logging of SASL TTransportExceptions in case of END_OF_FILE </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mithun">Mithun Radhakrishnan</assignee>
                                    <reporter username="mithun">Mithun Radhakrishnan</reporter>
                        <labels>
                            <label>Breaking-Change</label>
                    </labels>
                <created>Sat, 16 Feb 2019 00:07:37 +0000</created>
                <updated>Fri, 15 Jan 2021 12:47:27 +0000</updated>
                            <resolved>Mon, 8 Jul 2019 13:57:17 +0000</resolved>
                                    <version>0.12.0</version>
                                    <fixVersion>0.13.0</fixVersion>
                                    <component>Java - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="16769897" author="mithun" created="Sat, 16 Feb 2019 00:21:50 +0000"  >&lt;p&gt;CC-ing the chaps who worked on this originally, for their expertise: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thiruvel&quot; class=&quot;user-hover&quot; rel=&quot;thiruvel&quot;&gt;thiruvel&lt;/a&gt;,&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vihangk1&quot; class=&quot;user-hover&quot; rel=&quot;vihangk1&quot;&gt;vihangk1&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jking3&quot; class=&quot;user-hover&quot; rel=&quot;jking3&quot;&gt;jking3&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16769910" author="vihangk1" created="Sat, 16 Feb 2019 00:42:55 +0000"  >&lt;p&gt;I thought we wanted to log such exceptions but ignore the RuntimeExceptions which were thrown by the loadbalancer health checks. The patch attached will ignore all the TTransportExceptions. Is that intentional?&lt;/p&gt;</comment>
                            <comment id="16769929" author="mithun" created="Sat, 16 Feb 2019 01:04:36 +0000"  >&lt;p&gt;In the first patch&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12958947/THRIFT-4805.1.patch&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;THRIFT-4805.1.patch&lt;/a&gt;, I aim to correct the behaviour introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3769&quot; title=&quot;Fix logic of THRIFT-2268&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3769&quot;&gt;&lt;del&gt;THRIFT-3769&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;One possible fault (in my patch above, and in the original fix to &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3769&quot; title=&quot;Fix logic of THRIFT-2268&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3769&quot;&gt;&lt;del&gt;THRIFT-3769&lt;/del&gt;&lt;/a&gt;) is that all &lt;tt&gt;TTransportExceptions&lt;/tt&gt; are suppressed. But there might be legitimate instances where &lt;tt&gt;TTransportExceptions&lt;/tt&gt; would need to be bubbled upwards. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thiruvel&quot; class=&quot;user-hover&quot; rel=&quot;thiruvel&quot;&gt;thiruvel&lt;/a&gt;&apos;s original intention in &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2268&quot; title=&quot;Modify TSaslTransport to ignore TCP health checks from loadbalancers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2268&quot;&gt;&lt;del&gt;THRIFT-2268&lt;/del&gt;&lt;/a&gt; was to specifically catch and suppress only the &lt;tt&gt;TTransportException.END_OF_FILE&lt;/tt&gt; case, for &lt;tt&gt;TSaslServerTransport&lt;/tt&gt;, as is evidenced by &lt;a href=&quot;https://github.com/apache/thrift/blob/master/lib/java/src/org/apache/thrift/transport/TSaslTransport.java#L319&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the error-handling in &lt;tt&gt;TSaslTransport::open()&lt;/tt&gt;&lt;/a&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;TSaslTransport.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!readSaslHeader &amp;amp;&amp;amp; e.getType() == TTransportException.END_OF_FILE) {
        underlyingTransport.close();
        LOGGER.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;No data or no sasl data in the stream&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TSaslTransportException(&lt;span class=&quot;code-quote&quot;&gt;&quot;No data or no sasl data in the stream during negotiation&quot;&lt;/span&gt;, e);
      }
      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; e;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Apropos, I have a bonus patch that changes the blanket suppression of &lt;tt&gt;TTransportExceptions&lt;/tt&gt; to a more narrow &lt;tt&gt;END_OF_FILE&lt;/tt&gt; case. I&apos;ll attach it herewith.&lt;br/&gt;
This should handle &lt;tt&gt;TSaslTransportExceptions&lt;/tt&gt; (wrapped in &lt;tt&gt;RuntimeExceptions&lt;/tt&gt;, or not), raised both from &lt;tt&gt;TSaslTransport::open()&lt;/tt&gt; and &lt;tt&gt;TSaslTransport::read()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vihangk1&quot; class=&quot;user-hover&quot; rel=&quot;vihangk1&quot;&gt;vihangk1&lt;/a&gt;, does it sound agreeable to narrow the focus down to this kind of failure? These are pretty much what I see in production, with VIP/load-balancers, but I&apos;d like to be sure that this covers your cases as well.&lt;/p&gt;</comment>
                            <comment id="16769932" author="jking3" created="Sat, 16 Feb 2019 01:12:11 +0000"  >&lt;p&gt;If you could open a pull request that will get it into our CI environment for QA.&lt;/p&gt;</comment>
                            <comment id="16769958" author="mithun" created="Sat, 16 Feb 2019 01:45:03 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I thought we wanted to log such exceptions but ignore the RuntimeExceptions which were thrown by the loadbalancer health checks.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;(Sorry, I missed your question while I was typing my last reply.)&lt;/p&gt;

&lt;p&gt;The load-balancer checks need not manifest only as RTEs. They turn up as &lt;tt&gt;TSaslTransportExceptions&lt;/tt&gt; with message containing &lt;tt&gt;&quot;No data or no sasl data in the stream&quot;&lt;/tt&gt;. These exceptions may or may not be wrapped in RTEs. The point of a &lt;tt&gt;TSaslTransportException&lt;/tt&gt; is to capture the &lt;tt&gt;TTransportException.END_OF_FILE&lt;/tt&gt; condition, which is hit by load-balancer checks.&lt;/p&gt;

&lt;p&gt;I realize that this patch is now busted by &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4773&quot; title=&quot;TSaslTransport should relay underlying TTransportException to TSaslTransportException &quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4773&quot;&gt;&lt;del&gt;THRIFT-4773&lt;/del&gt;&lt;/a&gt;, on &lt;tt&gt;master&lt;/tt&gt;. :/ I&apos;ll upload a less brittle version, but this is the intention.&lt;/p&gt;</comment>
                            <comment id="16771327" author="jking3" created="Mon, 18 Feb 2019 19:37:33 +0000"  >&lt;p&gt;Please submit a pull request instead of a patch file.&lt;/p&gt;</comment>
                            <comment id="16771354" author="mithun" created="Mon, 18 Feb 2019 20:06:48 +0000"  >&lt;blockquote&gt;&lt;p&gt;Please submit a pull request instead of a patch file.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Right you are. Will do, very shortly.&lt;/p&gt;

&lt;p&gt;Edit:&#160;&lt;a href=&quot;https://github.com/apache/thrift/pull/1746&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1746&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16772182" author="mithun" created="Tue, 19 Feb 2019 18:15:32 +0000"  >&lt;p&gt;+&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thiruvel&quot; class=&quot;user-hover&quot; rel=&quot;thiruvel&quot;&gt;thiruvel&lt;/a&gt;, who started it all. :]&lt;/p&gt;</comment>
                            <comment id="16775495" author="vihangk1" created="Fri, 22 Feb 2019 18:43:10 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mithun&quot; class=&quot;user-hover&quot; rel=&quot;mithun&quot;&gt;mithun&lt;/a&gt; thanks for providing the patch. I am a bit confused when you say &quot;.. correct the behavior of &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3769&quot; title=&quot;Fix logic of THRIFT-2268&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3769&quot;&gt;&lt;del&gt;THRIFT-3769&lt;/del&gt;&lt;/a&gt;&quot;. Can you give a example stack trace which was not being printed before and gets logged after &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3769&quot; title=&quot;Fix logic of THRIFT-2268&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3769&quot;&gt;&lt;del&gt;THRIFT-3769&lt;/del&gt;&lt;/a&gt;? My understanding is that with this patch we are suppressing types of exceptions which is a super-set of the ones suppressed by &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3769&quot; title=&quot;Fix logic of THRIFT-2268&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3769&quot;&gt;&lt;del&gt;THRIFT-3769&lt;/del&gt;&lt;/a&gt;. Is that not correct?&lt;/p&gt;</comment>
                            <comment id="16775496" author="vihangk1" created="Fri, 22 Feb 2019 18:43:53 +0000"  >&lt;p&gt;Linking &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3769&quot; title=&quot;Fix logic of THRIFT-2268&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3769&quot;&gt;&lt;del&gt;THRIFT-3769&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16775739" author="mithun" created="Sat, 23 Feb 2019 01:40:43 +0000"  >&lt;p&gt;Hey, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vihangk1&quot; class=&quot;user-hover&quot; rel=&quot;vihangk1&quot;&gt;vihangk1&lt;/a&gt;.&#160;I&apos;m grateful&#160;for your continued interest and scrutiny of this patch.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I am a bit confused when you say &quot;.. correct the behavior of&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3769&quot; title=&quot;Fix logic of THRIFT-2268&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3769&quot;&gt;&lt;del&gt;THRIFT-3769&lt;/del&gt;&lt;/a&gt;&quot;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I apologize for my lack of clarity. I&apos;d be happy to consider changing the title of this Jira, based on our discussion here.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Can you give a example stack trace which was not being printed before and gets logged after&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3769&quot; title=&quot;Fix logic of THRIFT-2268&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3769&quot;&gt;&lt;del&gt;THRIFT-3769&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;The stack-trace included in the description of this Jira is the primary example. When we switched from Thrift 0.9.3 to Thrift 0.12.0, we saw&#160;the exception listed above filling up our server logs. Looking at the snippet of code in the description, we see that &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3769&quot; title=&quot;Fix logic of THRIFT-2268&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3769&quot;&gt;&lt;del&gt;THRIFT-3769&lt;/del&gt;&lt;/a&gt; is not entirely to blame for this. For some reason, with Thrift 0.12.0, the health-checks cause &lt;tt&gt;TTransportExceptions&lt;/tt&gt; that aren&apos;t wrapped by RTEs, so the current code didn&apos;t detect and handle them. They&apos;re caught and logged by the &lt;tt&gt;catch (TException)&lt;/tt&gt; block.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;My understanding is that with this patch we are suppressing types of exceptions which is a super-set of the ones suppressed by &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3769&quot; title=&quot;Fix logic of THRIFT-2268&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3769&quot;&gt;&lt;del&gt;THRIFT-3769&lt;/del&gt;&lt;/a&gt;. Is that not correct?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That would be a legitimate concern, but unless I&apos;m mistaken, that&apos;s not what my proposed fix in &lt;a href=&quot;https://github.com/apache/thrift/pull/1746/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the pull request&lt;/a&gt; does. That is not my intent, either.&lt;/p&gt;

&lt;p&gt;Let&apos;s briefly take a step back:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2268&quot; title=&quot;Modify TSaslTransport to ignore TCP health checks from loadbalancers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2268&quot;&gt;&lt;del&gt;THRIFT-2268&lt;/del&gt;&lt;/a&gt; intended to suppress only those &lt;tt&gt;TExceptions&lt;/tt&gt; that arise from &lt;tt&gt;TTransportException.END_OF_FILE&lt;/tt&gt; in  &lt;a href=&quot;https://github.com/apache/thrift/blob/master/lib/java/src/org/apache/thrift/transport/TSaslTransport.java#L317&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;TSaslTransport.java&lt;/a&gt;. That&apos;s why &lt;tt&gt;TSaslTransportException&lt;/tt&gt; was introduced: to represent the &lt;tt&gt;END_OF_FILE&lt;/tt&gt; case.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3769&quot; title=&quot;Fix logic of THRIFT-2268&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3769&quot;&gt;&lt;del&gt;THRIFT-3769&lt;/del&gt;&lt;/a&gt; removed the special handling for &lt;tt&gt;TSaslTransportException&lt;/tt&gt;, and attempted to handle it transparently as a &lt;tt&gt;TTransportException&lt;/tt&gt;, as follows:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;TThreadpoolServer.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (TException tx) {
        LOGGER.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Thrift error occurred during processing of message.&quot;&lt;/span&gt;, tx);
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception x) {
        &lt;span class=&quot;code-comment&quot;&gt;// We&apos;ll usually receive RuntimeException types here
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// Need to unwrap to ascertain real causing exception before we choose to ignore
&lt;/span&gt;        Throwable realCause = x.getCause();
        &lt;span class=&quot;code-comment&quot;&gt;// Ignore err-logging all transport-level/type exceptions
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((realCause != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; realCause &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; TTransportException)
            || (x &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; TTransportException)) {...}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;From the &lt;tt&gt;x instanceof TTransportException&lt;/tt&gt;, it appears that the author &lt;b&gt;intended&lt;/b&gt; here to suppress &lt;b&gt;all&lt;/b&gt; &lt;tt&gt;TTransportExceptions&lt;/tt&gt; (wrapped inside other exceptions, or not), but erred. Notice how &lt;tt&gt;|| (x instanceof TTransportException)&lt;/tt&gt; will never be satisfied, because of the preceding &lt;tt&gt;catch (TException)&lt;/tt&gt; block, so it&apos;s a superfluous check. Given the error, I can&apos;t be completely sure of the intention. :|&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Regardless, I propose narrowing the suppression to &lt;tt&gt;TSaslTransportExceptions&lt;/tt&gt; (i.e. the &lt;tt&gt;END_OF_FILE&lt;/tt&gt; case). Testing it in our load-balancer environments, they appear &lt;b&gt;not&lt;/b&gt; to be wrapped inside RTEs in Thrift 0.12, so my fix checks both the caught exception &lt;b&gt;and&lt;/b&gt; the &lt;tt&gt;getCause()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Please ignore the patches attached to this Jira. (They&apos;re already stale.) The proposed fix is here:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/thrift/pull/1746/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1746/files&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Your review and recommendations will be greatly appreciated.&lt;/p&gt;</comment>
                            <comment id="16804488" author="ctubbsii" created="Fri, 29 Mar 2019 00:44:43 +0000"  >&lt;p&gt;A request: please use more informative subject lines for issues. &quot;Fix logic of X&quot; does nothing to summarize the problem. In this case, the summary could be something like:&lt;br/&gt;
&quot;TThreadPoolServer does not log TTransportExceptions at the correct level&quot;&lt;/p&gt;</comment>
                            <comment id="16804499" author="mithun" created="Fri, 29 Mar 2019 01:13:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ctubbsii&quot; class=&quot;user-hover&quot; rel=&quot;ctubbsii&quot;&gt;ctubbsii&lt;/a&gt;, I agree. (I was feebly basing this on the description of &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3769&quot; title=&quot;Fix logic of THRIFT-2268&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3769&quot;&gt;&lt;del&gt;THRIFT-3769&lt;/del&gt;&lt;/a&gt;. I could&apos;ve tried harder.) &lt;/p&gt;

&lt;p&gt;Please let me know if the following isn&apos;t a reasonable replacement:&lt;/p&gt;
&lt;h6&gt;&lt;a name=&quot;SuppressexcessiveloggingofSASLTTransportExceptionsincaseofENDOFFILE&quot;&gt;&lt;/a&gt;Suppress excessive logging of SASL TTransportExceptions in case of END_OF_FILE&lt;/h6&gt;

&lt;p&gt;I&apos;ll update the commit-message and the &lt;tt&gt;CHANGES.md&lt;/tt&gt;, based on your approval.&lt;/p&gt;</comment>
                            <comment id="16804524" author="ctubbsii" created="Fri, 29 Mar 2019 02:06:21 +0000"  >&lt;p&gt;I&apos;ll trust you to decide. I merely wished to offer the suggestion. &#128513;&lt;/p&gt;</comment>
                            <comment id="16808994" author="mithun" created="Wed, 3 Apr 2019 18:07:06 +0000"  >&lt;p&gt;I&apos;ve updated the commit-message, the merge comment, and the &lt;tt&gt;CHANGES.md&lt;/tt&gt;. And I&apos;ve rebased for master.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13253426">THRIFT-4943</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13352477">SPARK-34128</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13231538">THRIFT-4858</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12955214">THRIFT-3769</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13253426">THRIFT-4943</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12958947" name="THRIFT-4805.1.patch" size="1576" author="mithun" created="Sat, 16 Feb 2019 00:19:27 +0000"/>
                            <attachment id="12958950" name="THRIFT-4805.bonus.patch" size="3050" author="mithun" created="Sat, 16 Feb 2019 01:04:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 32 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|yi11o8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>