<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:19:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-3175] fastbinary.c python deserialize can cause huge allocations from garbage</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-3175</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;In the fastbinary python deserializer, allocating a list is done like so:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    len = readI32(input);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!check_ssize_t_32(len)) {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; NULL;
    }

    ret = PyList_New(len);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The only validation of len is that it&apos;s under INT_MAX. I&apos;ve encountered a situation where upon receiving garbage input, and having len be read as something like 1 billion, the library treated this as a valid input, allocated gigs of RAM,  and caused a server to crash. &lt;/p&gt;

&lt;p&gt;The quick fix I made was to limit list sizes to a sane value of a few thousands that more than suits my personal needs. &lt;/p&gt;

&lt;p&gt;But IMO this should be dealt with properly. One way that comes to mind is not pre-allocating the entire list in advance in case it&apos;s really big, and resizing it in smaller steps while reading the input. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12834185">THRIFT-3175</key>
            <summary>fastbinary.c python deserialize can cause huge allocations from garbage</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dvirsky">Dvir Volk</assignee>
                                    <reporter username="dvirsky">Dvir Volk</reporter>
                        <labels>
                    </labels>
                <created>Mon, 1 Jun 2015 08:46:37 +0000</created>
                <updated>Wed, 25 Aug 2021 15:13:07 +0000</updated>
                            <resolved>Wed, 3 Jun 2015 09:47:17 +0000</resolved>
                                                    <fixVersion>0.9.3</fixVersion>
                                    <component>Python - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14567954" author="roger.meier" created="Mon, 1 Jun 2015 20:36:19 +0000"  >&lt;p&gt;Thanks for catching this! Could you provide a patch?&lt;/p&gt;</comment>
                            <comment id="14567971" author="dvirsky" created="Mon, 1 Jun 2015 20:49:23 +0000"  >&lt;p&gt;I can provide the simplistic patch we did, which is simply to define MAX_LIST_SIZE to be 10,000 and check it. It fixed the issue for us (some race condition on the client side sends garbled messages when 2 threads try to serialize a message at once). If that&apos;s good enough - sure. Do you accept pull requests via github or patches attached to tickets like in the pre-git days? I haven&apos;t committed to thrift in ~4 years &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14568013" author="roger.meier" created="Mon, 1 Jun 2015 21:15:05 +0000"  >&lt;p&gt;Starting with a simple patch limiting the size is worth to do.&lt;br/&gt;
pull request is ok, see CONTRIBUTING.md file&lt;br/&gt;
;-r&lt;/p&gt;

</comment>
                            <comment id="14568732" author="githubbot" created="Tue, 2 Jun 2015 07:59:26 +0000"  >&lt;p&gt;GitHub user dvirsky opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/511&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/511&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Limit lists to 10,000 items in fastbinary decoding to avoid crashing &#8230;&lt;/p&gt;

&lt;p&gt;    &#8230;servers from huge allocations on junk/mallicious input&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3175&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/THRIFT-3175&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/EverythingMe/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/EverythingMe/thrift&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3175&quot; title=&quot;fastbinary.c python deserialize can cause huge allocations from garbage&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3175&quot;&gt;&lt;del&gt;THRIFT-3175&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/511.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/511.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #511&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 988defdbdc12d2f087c0a87f8f6205b41f8588aa&lt;br/&gt;
Author: Dvir Volk &amp;lt;dvirsky@gmail.com&amp;gt;&lt;br/&gt;
Date:   2015-06-02T07:55:43Z&lt;/p&gt;

&lt;p&gt;    Limit lists to 10,000 items in fastbinary decoding to avoid crashing servers from huge allocations on junk/mallicious input&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14568733" author="dvirsky" created="Tue, 2 Jun 2015 08:00:12 +0000"  >&lt;p&gt;This is the PR.&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/thrift/pull/511&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/511&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The FastBinaryProtocol doesn&apos;t have any tests at all BTW, so I had nowhere to add a test for it to.&lt;/p&gt;</comment>
                            <comment id="14570549" author="roger.meier" created="Wed, 3 Jun 2015 09:47:17 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="14570550" author="githubbot" created="Wed, 3 Jun 2015 09:47:24 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/511&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/511&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14570603" author="hudson" created="Wed, 3 Jun 2015 10:21:53 +0000"  >&lt;p&gt;SUCCESS: Integrated in Thrift #1568 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/1568/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/1568/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3175&quot; title=&quot;fastbinary.c python deserialize can cause huge allocations from garbage&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3175&quot;&gt;&lt;del&gt;THRIFT-3175&lt;/del&gt;&lt;/a&gt; python: fastbinary.c python deserialize can cause huge allocations from garbage (roger: rev 7daf00ceb1b6d52f7ab612b03f63907866381ff1)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;lib/py/src/protocol/fastbinary.c&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15056830" author="jrf" created="Mon, 14 Dec 2015 22:23:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=roger.meier&quot; class=&quot;user-hover&quot; rel=&quot;roger.meier&quot;&gt;roger.meier&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dvirsky&quot; class=&quot;user-hover&quot; rel=&quot;dvirsky&quot;&gt;dvirsky&lt;/a&gt;,  this &quot;enhancement&quot; is actually a problem.  Thrift messages that were previously valid are now invalid &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/warning.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; and the only remedy is to [pin on v0.9.2 of the python package, which we have now done in streamcorpus|https://github.com/diffeo/streamcorpus/commit/71a3d50e3c89e4284c1868a5d671c2919a7e586e ].  It&apos;s not uncommon for an automatic data extractor to detect long lists, and expressing them in Thrift is a natural step.  We had no trouble creating such messages... and now they cannot be read with the latest version of the python library!&lt;/p&gt;

&lt;p&gt;I can understand how big lists cause problems in the JVM, but fixing that way down in the transport layer with a hard coded limit is obviously a flawed solution.  &lt;/p&gt;

&lt;p&gt;That said, we&apos;ve been systematically moving away from Thrift to &lt;a href=&quot;http://cbor.io&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;cbor&lt;/a&gt; and, wherever practical, just json.  This max-list-size issue  is going to accelerate that transition, which is sad.  As a former long-time fan of Thrift, I&apos;d love to see Thrift move toward a more cbor-like implementation, maybe even taking cbor as a wireline format.&lt;/p&gt;

&lt;p&gt;Sorry to be a downer on this, and hopefully future iterations of Thrift can learn from these kinds of challenges.&lt;/p&gt;</comment>
                            <comment id="15056882" author="dvirsky" created="Mon, 14 Dec 2015 22:53:07 +0000"  >&lt;p&gt;I agree it&apos;s not a good solution, although it was a problem not in the JVM but in python code. I would suggest a simpler heuristic - whether an allocated a list of the requested size be applicable to the message length. i.e. it&apos;s clear to see that there&apos;s no use in allocating 2G elements for a message that&apos;s 1K in length...&lt;/p&gt;</comment>
                            <comment id="15087805" author="nsuke" created="Thu, 7 Jan 2016 18:14:19 +0000"  >&lt;p&gt;I&apos;m planning to lift 10,000 limitation by &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3532&quot; title=&quot;Add configurable string and container read size limit to Python protocols&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3532&quot;&gt;&lt;del&gt;THRIFT-3532&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="13391086">IMPALA-10816</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                                                <inwardlinks description="is superceded by">
                                        <issuelink>
            <issuekey id="12928388">THRIFT-3532</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 45 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2fg53:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>