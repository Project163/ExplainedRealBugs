<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:32:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-4963] TNonblockingServer blocked int addTask(IOThread) and notify(workerThread)</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-4963</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;hello!&lt;/p&gt;

&lt;p&gt;when using c++ TNonblockingServer(with thread pool)&#65292;I found it blocked in high QPS status.&lt;/p&gt;

&lt;p&gt;I used pstack to print thread stack and found worker thread and IO thread blocked at:&lt;/p&gt;

&lt;p&gt;The worker thread will call&#160;notifyIOThread when it handle expired task, then call&#160;TNonblockingIOThread::notify and wait for POLLOUT in poll without timeout.&#160;&lt;/p&gt;

&lt;p&gt;The IO thread will call&#160;addTask when it gets requests. And IO threads will lock threadManager-&amp;gt;mutex_ in addTask without a timeout&lt;/p&gt;

&lt;p&gt;Is it a bug of thrift 0.12.0?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13258443">THRIFT-4963</key>
            <summary>TNonblockingServer blocked int addTask(IOThread) and notify(workerThread)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kanishthkarthik">Kanishth Karthik</assignee>
                                    <reporter username="chenguang9239">chenguang9239</reporter>
                        <labels>
                    </labels>
                <created>Tue, 24 Sep 2019 04:03:35 +0000</created>
                <updated>Thu, 11 Feb 2021 22:26:10 +0000</updated>
                            <resolved>Sun, 29 Mar 2020 16:31:56 +0000</resolved>
                                    <version>0.12.0</version>
                                    <fixVersion>0.14.0</fixVersion>
                                    <component>C++ - Library</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16937190" author="jensg" created="Tue, 24 Sep 2019 21:03:02 +0000"  >&lt;p&gt;Could that be a duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4962&quot; title=&quot;Deadlock in TimerManager::stop&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4962&quot;&gt;&lt;del&gt;THRIFT-4962&lt;/del&gt;&lt;/a&gt; &quot;Fix deadlock in TimerManager::stop&quot;? &lt;/p&gt;</comment>
                            <comment id="16940274" author="fesun" created="Sun, 29 Sep 2019 07:34:10 +0000"  >&lt;p&gt;We saw this deadlock too.&lt;/p&gt;

&lt;p&gt;The IO thread wait forever as the max pending tasks reached limit while the worker thread poll forever to send notify data back to IO thread.&lt;/p&gt;</comment>
                            <comment id="16940792" author="fesun" created="Mon, 30 Sep 2019 09:41:22 +0000"  >&lt;p&gt;The problem is that worker threads use the non-blocking socket returned by socketpair to notify the io thread to finish the task(call poll api without timeout to check if writable), while io threads need to add task to pending task queue and wait forever if the task queue is full. If the socket write buffer and task queue are both full, then deadlock.&lt;/p&gt;

&lt;p&gt;I modified the cpp thrift&#160;tutorial to demo this, see attached&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12981762/12981762_CppClient.cpp&quot; title=&quot;CppClient.cpp attached to THRIFT-4963&quot;&gt;CppClient.cpp&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; and&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12981763/12981763_CppServer.cpp&quot; title=&quot;CppServer.cpp attached to THRIFT-4963&quot;&gt;CppServer.cpp&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;To reproduce the deadlock:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Set tcp write buffer to 2048&lt;/li&gt;
	&lt;li&gt;run server:&#160;./server -io_thread_num 1 -pending_tasks 100 -task_timeout 60000 -worker_thread_num 10&lt;/li&gt;
	&lt;li&gt;run client:&#160;./client -conn_timeout 60000 -recv_timeout 60000 -send_timeout 60000 -thread_num 2000&lt;/li&gt;
	&lt;li&gt;Then the server quickly fall into deadlock. After the client exit, run another client with thread_num=1, that client will timeout.&lt;/li&gt;
	&lt;li&gt;gdb the server and you will find the call stack like this: &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12981765/12981765_deadlock_thread.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="16940809" author="fesun" created="Mon, 30 Sep 2019 10:04:33 +0000"  >&lt;p&gt;The deadlock doesn&apos;t occur very frequently, as usually the write buffer is large enough(for example 100KB) and thrift only needs 8 bytes for each task. One possible solution could be wait with timeout and remove the expired pending tasks if the task queue is still full, so the non-blocking server should be able to recover from &quot;deadlock&quot;, though it will not recover immediately and need to wait for the pending task to be expired.&lt;/p&gt;

&lt;p&gt;Any more ideas? Or we can just ignore this and ask users to disable max pending task count?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;file:&#160;lib/cpp/src/thrift/concurrency/ThreadManager.cpp &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12981768/12981768_wait_timeout.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17067673" author="kanishthkarthik" created="Thu, 26 Mar 2020 13:18:30 +0000"  >&lt;p&gt;I encountered the same issue in thrift 0.10.0 and it still persists in thrift 0.14.0. I have created a pull request to resolve this.&#160;&lt;/p&gt;

&lt;p&gt;The problem is that the IO thread is stuck trying to obtain the lock on the first line in add (as shown in the image above) and this lock is held by the worker (case of when the task has expired) that is trying to notify the IO thread but can&apos;t if the buffer is full and will wait endlessly. Both will not let go before the other resulting in a deadlock.&lt;/p&gt;

&lt;p&gt;This can be resolved if we&#160;release the lock before closing the connection and notifying just like the case of processing when the task is not expired and acquire it back once that is done.&lt;/p&gt;

&lt;p&gt;Refer:&#160;ThreadManager::Task::run() for the same.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12981762" name="CppClient.cpp" size="2568" author="fesun" created="Mon, 30 Sep 2019 09:35:40 +0000"/>
                            <attachment id="12981763" name="CppServer.cpp" size="5870" author="fesun" created="Mon, 30 Sep 2019 09:35:40 +0000"/>
                            <attachment id="12981765" name="deadlock_thread.png" size="30731" author="fesun" created="Mon, 30 Sep 2019 09:40:07 +0000"/>
                            <attachment id="12981768" name="wait_timeout.png" size="40705" author="fesun" created="Mon, 30 Sep 2019 09:59:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 33 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z06y08:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>