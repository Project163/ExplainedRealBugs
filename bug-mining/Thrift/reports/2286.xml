<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:35:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-5823] Fix illegal uses of exceptions as normal struct type</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-5823</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;Fix illegal uses of exvceptions as normal struct type, which it really isn&apos;t. Applies to a number of test IDL files and various tickets.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13594987">THRIFT-5823</key>
            <summary>Fix illegal uses of exceptions as normal struct type</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jensg">Jens Geyer</assignee>
                                    <reporter username="jensg">Jens Geyer</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Oct 2024 00:37:33 +0000</created>
                <updated>Mon, 6 Jan 2025 10:37:24 +0000</updated>
                            <resolved>Mon, 14 Oct 2024 21:07:00 +0000</resolved>
                                                    <fixVersion>0.22.0</fixVersion>
                                    <component>Compiler (General)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="5400">1.5h</timespent>
                                <comments>
                            <comment id="17898717" author="fishywang" created="Fri, 15 Nov 2024 18:18:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jensg&quot; class=&quot;user-hover&quot; rel=&quot;jensg&quot;&gt;jensg&lt;/a&gt; can we reconsider this issue/discuss it more? Using exception type as a field to a struct/exception is actually used in the wild occasionally, and this change will break them (those thrift files won&apos;t compile anymore with 0.22.0).&lt;/p&gt;

&lt;p&gt;The most common case this is currently used is to return partial errors/success. Thrift does not allow return both a response and an exception, so when an endpoint could return partial success, they choose to add the partial error info into the response struct, something like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
struct FooResponse {
  1: optional Bar some_data;
  2: optional FooException partial_error;
}

service Foo {
  FooResponse foo(...) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; (1: FooException error);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Of course they can define another struct to be used for the partial_error field, but that require additional work of migration to the new field on the wire protocol.&lt;/p&gt;

&lt;p&gt;What&apos;s the consequence of allowing exception types to be used as struct fields? Is it that in some languages thrift supports, it&apos;s not allowed to have a nested exception type? From my understanding most languages allow that (java, go, python, to name a few).&lt;/p&gt;</comment>
                            <comment id="17898788" author="jensg" created="Fri, 15 Nov 2024 21:53:24 +0000"  >&lt;p&gt;This is from the &lt;a href=&quot;https://thrift.apache.org/static/files/thrift-20070401.pdf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;whitepaper&lt;/a&gt; (the only real spec we have):&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;2.4 Exceptions&lt;br/&gt;
Exceptions are syntactically and functionally equivalent to structs&#160;except that they are declared using the exception keyword instead&#160;of the struct keyword.&#160;The generated objects inherit from an exception base class as appropriate in each target programming language, &lt;br/&gt;
in order to seamlessly integrate with native exception handling in any given language. Again, the design emphasis is on making the code &lt;br/&gt;
familiar&#160;to the application developer.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Given the (rather incomplete and raw) IDL syntax alone both on the web site and in &lt;tt&gt;thriftl.ll&lt;/tt&gt;, and ignoring anything else, it is not fully clear what the intention was. But if we also look at the paragraph above and at the test cases that were originally given, at least to me it looks pretty much as if nobody had that such a use case in mind even remotely. Particularly the emphasized special case &quot;inherit from an exception base class &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt; to seamlessly integrate with native exception handling in any given language&quot; would have implied a strong need for such test cases, because it is not only obvious, but &lt;ins&gt;expected&lt;/ins&gt; that exceptions and structs are different beasts in most (if not all) languages, thus requiring special care and tests. But such tests never existed (not counting the two deeply buried under lib/go that were added much later).&lt;/p&gt;

&lt;p&gt;So from the overall picture I think it is fair to say that the original design did even remotely have in mind to really use exceptions where structs are allowed, hence the part &quot;syntactically and functionally equivalent to structs&quot; above should most likely be interpreted as &quot;regarding wire representation of the data&quot;. I agree there&apos;s a lot of interpretation in this, but I think we can safely summarize it as: &quot;That&apos;s really not how it was meant to be used at all.&quot;&lt;/p&gt;

&lt;p&gt;On the other hand, of course, the WP like any other spec is not a sacred holy document and surely can evolve and change.&lt;/p&gt;

&lt;p&gt;So what we could do is to make in an official feature and allow that an exception could be treated like any struct data type, only with the additional feature that it can be thrown and caught. That would require to make sure that all target languages understand that conceptual change (which they do not as it is now - whole reason why I came across this) and thus have a dedicated test case for it in the test suite, similar to what I we did with the uuid data type. That&apos;s where it should start IMHO.&lt;/p&gt;

&lt;p&gt;Last not least, we should have a separate ticket for it.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;PS: TBH I find the term &quot;partial error&quot; quite irritating. What is a partial error again? It failed, but only a bit? Could that still be an idempotent operation? I gave you 10 bookings about 100 dollar each and got a partial error &quot;some money could not be send to your bank account&quot;. Now what do I do with that information? Can I throw and catch that error? Or better not, because at least I got some money, just not all of it? And which of the bookings did fail? How money do I have now? Hard to tell ...&lt;/p&gt;</comment>
                            <comment id="17898791" author="fishywang" created="Fri, 15 Nov 2024 22:15:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;but expected that exceptions and structs are different beasts in most (if not all) languages&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;My reading from the part of the whitepaper you quoted is different. My reading is that it would work the same/similarly to a struct, with the addition that the type can be throw/catch in the language. In languages like java, python, go, etc., it&apos;s trivial (and currently implemented so) to make exceptions that both implements TStruct and the language&apos;s exception base class, through multiple inheritance or other means.&lt;/p&gt;

&lt;p&gt;Re your PS: not every operation needs to be idempotent. Use batch operation (idempotent or not) to save multiple round trips is a common practice, and batch operations can have partial failures (again, idempotent or not), for example:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
struct GetRequest {
  1: string id;
  ...
}

struct GetResponse {
  ...
}

struct BatchGetRequest {
  1: list&amp;lt;GetRequest&amp;gt; requests
}

struct BatchGetResponse {
  1: map&amp;lt;string, GetRequest&amp;gt; responses,  &lt;span class=&quot;code-comment&quot;&gt;// key is id
&lt;/span&gt;  2: map&amp;lt;string, SomeErrorDetail&amp;gt; errors,  &lt;span class=&quot;code-comment&quot;&gt;// key is id
&lt;/span&gt;}

service Foo {
  GetResponse get(1: GetRequest request) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt;(1: SomeException error);
  BatchGetResponse batchGet(1: BatchGetRequest request) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt;(1: SomeException error); &lt;span class=&quot;code-comment&quot;&gt;// may or may not be the same exception type, only &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; exception when full request failed
&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For money moving requests, you would have the same idempotentation issue with full failures, partial failures does not change that.&lt;/p&gt;</comment>
                            <comment id="17898854" author="jensg" created="Sat, 16 Nov 2024 09:20:52 +0000"  >&lt;p&gt;&lt;blockquote&gt;&lt;p&gt;&#160;My reading is that it would work the same/similarly to a struct, with the addition that the type can be throw/catch in the language.&#160;&lt;/p&gt;&lt;/blockquote&gt;&#160;&lt;/p&gt;

&lt;p&gt;But there are still no testcases. And given the stated, expected difference in implementation there should be at least some. Anyway, as I said we can still change the design.. But then let&apos;s do it right and not sneak it in.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13344116">THRIFT-5320</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13524890">THRIFT-5685</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13471629">THRIFT-5605</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13072167" name="THRIFT-5823.thrift" size="1472" author="jensg" created="Sat, 12 Oct 2024 23:55:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            51 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1rwu8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>