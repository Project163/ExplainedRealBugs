<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:06:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-1795] Race condition in TThreadedServerPool java implementation</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-1795</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;While running unit tests on flume&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, it was discovered that there have been intermittent failures on Redhat Linux 5.x derivatives and SUSE Linux environments (or the failures where more pronounced in those environments).   While trying to debug this issue and removing Flume specific issues,  I think there is a race condition in Thrift TThreadPool server implementation. We can reduce the problem to the basic issue&lt;/p&gt;

&lt;p&gt;The server is written in as below in its serve() method&lt;/p&gt;

&lt;p&gt;stopped_ = false&lt;/p&gt;

&lt;p&gt;while (!stopped_) &lt;br/&gt;
   try&lt;br/&gt;
        serve request&lt;br/&gt;
   except&lt;br/&gt;
       log message&lt;/p&gt;

&lt;p&gt;The stop method (executed typically from another thread) is implemented thus&lt;/p&gt;

&lt;p&gt;stopped_ = false&lt;br/&gt;
interrupt and cleanup server transport&lt;/p&gt;



&lt;p&gt;The basic thought is that stopped_ being volatile, the writes to stopped_ will always be seen by the reading thread and there is no other synchronization required, essentially relying on the JSR 133 volatile description.&lt;/p&gt;

&lt;p&gt;The problem is that there is no check in the server run method whether it was asked to stop or not&lt;/p&gt;

&lt;p&gt;For example, the Flume unit test, once again reduced to what is needed for this discussion, does the following for testing the flume source lifecycle&lt;/p&gt;

&lt;p&gt;server.start &amp;#8211; which means starting a thread, whose run method will call  TThreadPoolServer.serve described above&lt;br/&gt;
server.stop&lt;/p&gt;

&lt;p&gt;It so happens that on Redhat Linux 5.x systems or more specifically with Linux kernels before the CFQ scheduler, there is a higher chance that server.stop can run before server thread&apos;s serve method is invoked.   This means that the setting of stopped_ flag in the stop method is overwritten in the serve method.    This causes the server to enter an infinite loop and eventually, the test timeout kicks in&lt;/p&gt;

&lt;p&gt;There is an easy fix - just set stopped_ to false in the constructor.   But then it probably violates the contract on the state of a constructed server object.   I see that in couple of other TServer implementations, stopped_ is initialize to true and only during the listen processing, stopped_ is set to false.&lt;/p&gt;

&lt;p&gt;If preserving this semantics is important, we should introduce another volatile variable (say started_),  and carefully set started_ and stopped_ in places where we are not sure stopped_ might be overwritten, and check for both flags also in key locations (right after a thread starts with the server() method.&lt;/p&gt;

&lt;p&gt;This same issue can be evidenced in other variations of TServer implementations also.&lt;/p&gt;

&lt;p&gt;I can provide a patch if it is agreed that this is a bug that needs to be fixed.  I can create a patch introducing a new started_ flag (which respects the current behavior in some of the classes where stopped_ is initialized to true), or initialize the Servers to initialize stopped_ to false and then not reset the stopped_ flag during the server execution (which is simplere and easy to fix, but makes a server just constructed to be not in stopped state).   I don&apos;t know how important it is to maintain that behavior or if there is any reliance on that behavior&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;

&lt;p&gt;Venkat&lt;/p&gt;</description>
                <environment>&lt;p&gt;RHEL 5.x derivatives, SUSE linux are the systems where this is intermittently reproducible&lt;/p&gt;</environment>
        <key id="12624381">THRIFT-1795</key>
            <summary>Race condition in TThreadedServerPool java implementation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jfarrell">Jake Farrell</assignee>
                                    <reporter username="venkatnrangan">Venkat Ranganathan</reporter>
                        <labels>
                    </labels>
                <created>Tue, 18 Dec 2012 00:54:07 +0000</created>
                <updated>Mon, 14 May 2018 23:27:09 +0000</updated>
                            <resolved>Mon, 19 Aug 2013 15:59:55 +0000</resolved>
                                    <version>0.6.1</version>
                    <version>0.7</version>
                    <version>0.8</version>
                    <version>0.9</version>
                                    <fixVersion>0.9.1</fixVersion>
                                    <component>Java - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13535292" author="roger.meier" created="Tue, 18 Dec 2012 20:46:09 +0000"  >&lt;p&gt;I think your proposal makes sense.&lt;/p&gt;

&lt;p&gt;Could you provide a patch?&lt;br/&gt;
Did you ran our test suite with that patch?&lt;br/&gt;
and the cross test suite test/test.sh ?&lt;/p&gt;

&lt;p&gt;;-r&lt;/p&gt;</comment>
                            <comment id="13535365" author="venkatnrangan" created="Tue, 18 Dec 2012 21:35:34 +0000"  >&lt;p&gt;Thanks for the quick review of the bug.  I have the patch ready.   will provide the patch after running the cross testsuite&lt;/p&gt;</comment>
                            <comment id="13536430" author="venkatnrangan" created="Wed, 19 Dec 2012 21:23:02 +0000"  >&lt;p&gt;I attached a patch after verifying with test/test.sh - I tested only with C++, Java and python.  Hopefully that is OK.  &lt;/p&gt;</comment>
                            <comment id="13538567" author="venkatnrangan" created="Sat, 22 Dec 2012 00:17:57 +0000"  >&lt;p&gt;I don&apos;t have contributor access to Thrift - so I can&apos;t assign the bug to myself or mark state as patch available.   Please review the current patch&lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
Venkat&lt;/p&gt;</comment>
                            <comment id="13538582" author="carlyeks" created="Sat, 22 Dec 2012 00:37:31 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;LGTM&lt;/p&gt;</comment>
                            <comment id="13539041" author="venkatnrangan" created="Sun, 23 Dec 2012 15:37:38 +0000"  >&lt;p&gt;Thanks Carl. &lt;/p&gt;

&lt;p&gt;Please let me know if this needs further review before committing&lt;br/&gt;
Thanks&lt;/p&gt;

&lt;p&gt;Venkat&lt;/p&gt;</comment>
                            <comment id="13539049" author="roger.meier" created="Sun, 23 Dec 2012 16:21:59 +0000"  >&lt;p&gt;just committed&lt;/p&gt;</comment>
                            <comment id="13539055" author="venkatnrangan" created="Sun, 23 Dec 2012 16:50:10 +0000"  >&lt;p&gt;Thanks Roger&lt;/p&gt;

&lt;p&gt;Venkat&lt;/p&gt;</comment>
                            <comment id="13583549" author="venkatnrangan" created="Thu, 21 Feb 2013 21:06:56 +0000"  >&lt;p&gt;Which Thrift version will this get in (I assume 1.0?)   &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-1796&quot; title=&quot;Upgrade Thrift due to race condition in TThreadSeverPool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-1796&quot;&gt;FLUME-1796&lt;/a&gt; depends on this so that I can request an update to the Thrift version used in Flume&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;

&lt;p&gt;Venkat &lt;/p&gt;</comment>
                            <comment id="13586533" author="venkatnrangan" created="Tue, 26 Feb 2013 00:46:31 +0000"  >&lt;p&gt;Pinging again.  The thrift version is empty.   Is it going into 1.0?   The Fix version is empty in this&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="13586692" author="jfarrell" created="Tue, 26 Feb 2013 03:31:25 +0000"  >&lt;p&gt;Next release will be versioned at 9.1 or 1.0 depending on whats contained within that release. I&apos;m assuming that &lt;a href=&quot;https://issues.apache.org/jira/browse/FLUME-917&quot; title=&quot;Thrift Support&quot; class=&quot;issue-link&quot; data-issue-key=&quot;FLUME-917&quot;&gt;&lt;del&gt;FLUME-917&lt;/del&gt;&lt;/a&gt; is a blocker for this&lt;/p&gt;</comment>
                            <comment id="13586710" author="venkatnrangan" created="Tue, 26 Feb 2013 03:58:28 +0000"  >&lt;p&gt;Flume-1898 is marked as Duplicate of FLume-917 and resolved.  I don&apos;t now why Flume-917 is not marked as resolved&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="13743483" author="venkatnrangan" created="Mon, 19 Aug 2013 02:17:06 +0000"  >&lt;p&gt;Pinging again.   I see 0.9.1 RC being out.  Is this fix in that version?&lt;/p&gt;</comment>
                            <comment id="13743574" author="jfarrell" created="Mon, 19 Aug 2013 06:16:25 +0000"  >&lt;p&gt;This patch is in commit 0193149842924b65c5d3761d60055d298470d3ab and is in the Apache Thrift 0.9.1-rc.&lt;/p&gt;</comment>
                            <comment id="13743890" author="venkatnrangan" created="Mon, 19 Aug 2013 15:16:35 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jfarrel&quot; class=&quot;user-hover&quot; rel=&quot;jfarrel&quot;&gt;jfarrel&lt;/a&gt;.   I think the fix version is still not updated and that is why it probably did not make it into the CHANGES.   Can the fix version be updated?&lt;/p&gt;

&lt;p&gt;Thanks again&lt;/p&gt;</comment>
                            <comment id="13743941" author="jfarrell" created="Mon, 19 Aug 2013 16:03:08 +0000"  >&lt;p&gt;Updated fix version&lt;/p&gt;</comment>
                            <comment id="16475036" author="jamison.bennett" created="Mon, 14 May 2018 23:27:09 +0000"  >&lt;p&gt;I identified another case where this failure still happens and I have a patch for it. It looks like the patch fixes TNonblockinServer, TSimpleServer, TThreadSelectServer, and part of TThreadPoolServer.&lt;/p&gt;

&lt;p&gt;In TThreadPoolServer it is still possible have the same race condition&#160;that was fixed in&#160;TNonblockinServer, TSimpleServer, and TThreadSelectServer where stop() is called in a unittest&#160;while at the same time the thread executing the serve() method&#160;overwrites the stopped_ variable. The code has been refactored a little bit since the original fix, but the same logic holds. Its just now the stoppped_ variable is set in preServe().&lt;/p&gt;

&lt;p&gt;Here is my fix:&#160;&lt;a href=&quot;https://github.com/jamisonbennett/thrift/commit/b0a0d7634636bdecf12730ff10b2761f97dd1e88&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jamisonbennett/thrift/commit/b0a0d7634636bdecf12730ff10b2761f97dd1e88&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Is it possible to have this reopened or should a new issue be created?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12624382">FLUME-1788</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12624505">FLUME-1796</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12561786" name="Thrift-1795.diff" size="3426" author="venkatnrangan" created="Wed, 19 Dec 2012 21:21:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>299220</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 27 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i160c7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>243187</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>