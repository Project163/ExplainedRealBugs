<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 07:59:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-867] PHP accelerator module&apos;s output transport is incompatible with TFramedTransport</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-867</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;I think we&apos;ve figured out the cause of everyone&apos;s problems with &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-837&quot; title=&quot;PHP accelerator bug for writes &amp;gt; 8k&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-837&quot;&gt;&lt;del&gt;THRIFT-837&lt;/del&gt;&lt;/a&gt;. The patch itself is fine; however, in fixing that bug, we&apos;ve exposed the fact that PHPOutputTransport erroneously calls down to the underlying PHP transport&apos;s flush() method every time the internal 8k buffer is flushed. This is fine for the buffered transport, but unacceptable for the framed transport, which should only be flushed once per RPC call.&lt;/p&gt;

&lt;p&gt;It seems like what we need to do is separate the &quot;internal&quot; buffer flushes from the &quot;external&quot; transport flushes. If we do that, everything should work out fine.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12472427">THRIFT-867</key>
            <summary>PHP accelerator module&apos;s output transport is incompatible with TFramedTransport</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="bryanduxbury">Bryan Duxbury</reporter>
                        <labels>
                    </labels>
                <created>Tue, 24 Aug 2010 23:26:44 +0000</created>
                <updated>Fri, 4 Mar 2011 01:35:30 +0000</updated>
                            <resolved>Fri, 4 Mar 2011 01:35:30 +0000</resolved>
                                    <version>0.4</version>
                                    <fixVersion>0.7</fixVersion>
                                    <component>PHP - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="12904500" author="arya" created="Tue, 31 Aug 2010 02:10:34 +0000"  >&lt;p&gt;Actually, after investigating this more, I figured the problem is not with buffered being flushed once for FramedTransport, but that FramedTransport cares to exactly read the number of bytes as dictated to it by the first 4 bytes of the stream, otherwise it behaves incorrectly to the point that your operation will no succeed. The problem was that  Accelerated Module, PHPOutputTransport class had a destructor calling out flush(). However the flush is called by the thrift_protocol_write_binary function inside the exception wrappers right where it needs to be after all the data is serialized into the stream, thus the extra flush inside destructor is not needed at all. This was not a problem for Buffered Transport because it reads everything it gets but this was causing problem for FramedTransport because it was causing an extra 0 (size of empty buffer after last flush) to be packed and placed at the end of stream making it confuse FramedTransport. So, attached please find the one liner patch to php_thrift_protocol.cpp. I tested this with Cassandra using FramedTransport up to 15Mb where I have it configured for max Frame size, and for variety of BufferTransport sizes. Feel free to do you own QA. &lt;/p&gt;</comment>
                            <comment id="12905645" author="tkho" created="Thu, 2 Sep 2010 19:17:59 +0000"  >&lt;p&gt;Arya, would it be better to modify TFramedTransport not to write an empty frames on flush?&lt;/p&gt;</comment>
                            <comment id="12905664" author="arya" created="Thu, 2 Sep 2010 20:09:19 +0000"  >&lt;p&gt;I did not try that and here is why:&lt;/p&gt;

&lt;p&gt; I think the transport, socket, and accelerated module have a degree of separation in which each handle specific task associated with themselves. For example TFramedTransport-&amp;gt;flush(), does a write followed by flush and it formats its stream according to framed specification of size+buffer not knowing what was in its buffer. You are proposing to have a check in the flush() function which eliminates writing of empty sized buffers. I am not 100% sure if there is no use case in which writing of empty buffer is required, so I did not do it. But since the non accelerated module worked perfectly fine, it clearly says there is something not right with the other execution path. And there will be an extra if check for every flush which does not make sense when flush() after flush() is the problem. Thus, I stick with this patch unless it is causing some issue or I missed something I did not understand. &lt;/p&gt;

&lt;p&gt;Feel free to take a lead on this if you have a better solution. &lt;/p&gt;</comment>
                            <comment id="12906090" author="tkho" created="Fri, 3 Sep 2010 20:58:22 +0000"  >&lt;p&gt;Ah okay. Your explanation makes sense. Just want to note, though, that there&apos;s still a possibility for more than one transport flush to happen in sending a request since flush() is called whenever the buffer will overflow. I think your change only removes the sending of an empty frame. (Maybe there&apos;s a server bug in handling an empty frame?)&lt;/p&gt;</comment>
                            <comment id="12933175" author="thobbs" created="Wed, 17 Nov 2010 21:29:06 +0000"  >&lt;p&gt;phpcassa (&lt;a href=&quot;https://github.com/thobbs/phpcassa&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/thobbs/phpcassa&lt;/a&gt;) ships with Arya&apos;s patch applied, and I haven&apos;t seen any problems with it using TFramedTransport.&lt;/p&gt;</comment>
                            <comment id="13001463" author="nicktelford" created="Wed, 2 Mar 2011 15:59:29 +0000"  >&lt;p&gt;On Arya&apos;s points on the best place to fix this:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Arya&apos;s patch for the extension fixes a bug (namely that flush() gets called when it shouldn&apos;t). Whether or not this causes things to break is besides the point, it&apos;s unintended and should definitely be fixed.&lt;/li&gt;
	&lt;li&gt;Having TFramedTransport write empty frames on flush, whether you&apos;re using the extension or some other exotic protocol/transport, breaks servers that adhere to the FramedTransport format. While I&apos;ve not seen a specification for this format, it seems implied that empty frames are not permitted. If this is the case, we should definitely have TFramedTransport::flush() check the frame isn&apos;t empty before writing it.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;My argument for the second point is one of coupling: a method should never rely on it&apos;s caller to call it in a particular order or validate it&apos;s state.&lt;/p&gt;</comment>
                            <comment id="13001512" author="bryanduxbury" created="Wed, 2 Mar 2011 18:16:43 +0000"  >&lt;p&gt;@Nicholas - should we commit this patch as-is then?&lt;/p&gt;</comment>
                            <comment id="13001517" author="nicktelford" created="Wed, 2 Mar 2011 18:22:32 +0000"  >&lt;p&gt;Yes definitely. My point is that we should also be patching TFramedTransport. I&apos;ll quickly roll a patch for that now.&lt;/p&gt;</comment>
                            <comment id="13001518" author="nicktelford" created="Wed, 2 Mar 2011 18:24:57 +0000"  >&lt;p&gt;Patch to make TFramedTransport::flush() only write a new frame to the underlying transport if there is some data to write.&lt;/p&gt;</comment>
                            <comment id="13001531" author="bryanduxbury" created="Wed, 2 Mar 2011 18:35:47 +0000"  >&lt;p&gt;I just tried to apply Arya&apos;s original patch, and it has at least one failing hunk. Nicholas, could I impose on you to see if you can massage it to apply cleanly and repost a combined patch for both changes?&lt;/p&gt;</comment>
                            <comment id="13001541" author="nicktelford" created="Wed, 2 Mar 2011 18:52:06 +0000"  >&lt;p&gt;Bryan, looking at the offending code in trunk, it&apos;s already been commented out. Seems like someone else has already applied a similar change.&lt;/p&gt;</comment>
                            <comment id="13001929" author="tantra" created="Thu, 3 Mar 2011 09:04:52 +0000"  >&lt;p&gt;see &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1067&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/THRIFT-1067&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13002389" author="bryanduxbury" created="Fri, 4 Mar 2011 01:35:30 +0000"  >&lt;p&gt;I just committed this to trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12453491" name="thrift-867.diff" size="430" author="arya" created="Tue, 31 Aug 2010 02:10:34 +0000"/>
                            <attachment id="12472436" name="thrift-tframedtransport-867.patch" size="471" author="nicktelford" created="Wed, 2 Mar 2011 18:24:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>187009</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 38 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i16d7r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>245273</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>