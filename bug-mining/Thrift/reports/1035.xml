<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:14:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-1266] generated C code for iterating over nested maps is wrong</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-1266</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;We are working with Cassandra API in C generated by Thrift and have noticed a bug in the generated code for cassandra_client_send_batch_mutate().&lt;/p&gt;

&lt;p&gt;Full code that Thrift generates for this function is attached, but here is the specification for Cassandra&apos;s batch_mutate method:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;/**
  Mutate many columns or &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt; columns &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; many row keys. See also: Mutation.

  mutation_map maps key to column family to a list of Mutation objects to take place at that scope.
**/
void batch_mutate(1:required map&amp;lt;binary, map&amp;lt;string, list&amp;lt;Mutation&amp;gt;&amp;gt;&amp;gt; mutation_map,
                  2:required ConsistencyLevel consistency_level=ConsistencyLevel.ONE)
     &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; (1:InvalidRequestException ire, 2:UnavailableException ue, 3:TimedOutException te),
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If we now look at the generated code, we will notice the following fragment:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;GPtrArray * value;
g_hash_table_foreach ((GHashTable *)  value, thrift_hash_table_get_keys, &amp;amp;key_list); &lt;span class=&quot;code-comment&quot;&gt;/* LINE A */&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We can see that in line A it uses the variable &quot;value&quot; as GHashTable, even though the GHashTable &quot;value&quot; was shadowed by GPtrArray &quot;value&quot; a line before.&lt;/p&gt;

&lt;p&gt;Similarly, we can see another fragment below that one, where one instance of variable &quot;value&quot; shadows another instance:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;value = (GPtrArray *) g_hash_table_lookup (((GHashTable *)  value), (gpointer) key); &lt;span class=&quot;code-comment&quot;&gt;/* LINE B */&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We have worked around the bug in our particular case by renaming one of the &quot;value&quot; variables to &quot;value2&quot; (see &quot;svn di -c 21176 svn://svn.zabbix.com/branches/dev/ZBXNEXT-844/src/libs/zbxcassa/cassandra.c@21176&quot; for a diff), but it would be nice to fix it in Thrift, too.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Revision 1158683 of &lt;a href=&quot;http://svn.apache.org/repos/asf/thrift/trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/repos/asf/thrift/trunk&lt;/a&gt;.&lt;/p&gt;</environment>
        <key id="12519111">THRIFT-1266</key>
            <summary>generated C code for iterating over nested maps is wrong</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="simonsouth">Simon South</assignee>
                                    <reporter username="asaveljevs">Aleksandrs Saveljevs</reporter>
                        <labels>
                            <label>c_glib</label>
                            <label>cassandra</label>
                    </labels>
                <created>Wed, 17 Aug 2011 13:38:56 +0000</created>
                <updated>Wed, 5 Nov 2014 04:48:15 +0000</updated>
                            <resolved>Wed, 3 Sep 2014 22:18:27 +0000</resolved>
                                    <version>0.8</version>
                                    <fixVersion>0.9.2</fixVersion>
                                    <component>C glib - Compiler</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13284527" author="roger.meier" created="Mon, 28 May 2012 19:30:14 +0000"  >&lt;p&gt;could you please provide a test case if possible and a patch?&lt;/p&gt;

&lt;p&gt;see &lt;a href=&quot;http://thrift.apache.org/docs/HowToContribute&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://thrift.apache.org/docs/HowToContribute&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13292639" author="asaveljevs" created="Mon, 11 Jun 2012 04:28:15 +0000"  >&lt;p&gt;Unfortunately, neither a reduced test case, nor a patch would be possible, because none of us are experts on Thrift. We are simply Cassandra users and, as such, the bug should have been reported by Cassandra developers.&lt;/p&gt;

&lt;p&gt;However, I have just tried Thrift 0.8.0 on Cassandra 1.1.1. It generates the same code for batch_mutate() method, so it seems the problem has not been fixed yet and is easily reproducible.&lt;/p&gt;

&lt;p&gt;In order to reproduce the problem using Cassandra, you can do the following:&lt;br/&gt;
(1) download Cassandra source from &lt;a href=&quot;http://cassandra.apache.org/download/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassandra.apache.org/download/&lt;/a&gt; ;&lt;br/&gt;
(2) from Cassandra source root, run Thrift using &quot;thrift --gen c_glib interface/cassandra.thrift&quot;;&lt;br/&gt;
(3) open &quot;gen-c_glib/cassandra.c&quot; and observe that &quot;value&quot; variable is incorrectly shadowed inside cassandra_client_send_batch_mutate().&lt;/p&gt;</comment>
                            <comment id="14119193" author="simonsouth" created="Wed, 3 Sep 2014 02:08:19 +0000"  >&lt;p&gt;In the &quot;better late than never&quot; category:&lt;/p&gt;

&lt;p&gt;I&apos;ve added a patch that fixes this problem. It modifies &lt;tt&gt;t_c_glib_generator::generate_serialize_container&lt;/tt&gt; so variables representing hash-table keys and values are named with a unique suffix, eliminating the possibility of a collision. (This is the same solution used in &lt;tt&gt;generate_const_initializer&lt;/tt&gt;.)&lt;/p&gt;

&lt;p&gt;No specific test case, but the server half of the integration test suite for c_glib will trigger this bug without the patch applied.&lt;/p&gt;

&lt;p&gt;With this fix, the relevant parts of the code generated for Cassandra 1.1.1 now look like this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;GPtrArray * val75 = NULL;
g_hash_table_foreach ((GHashTable *)  val73, thrift_hash_table_get_keys, &amp;amp;key_list);

...

val75 = (GPtrArray *) g_hash_table_lookup (((GHashTable *)  val73), (gpointer) key74);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14120581" author="roger.meier" created="Wed, 3 Sep 2014 22:18:27 +0000"  >&lt;p&gt;Great work, thanks Simon!&lt;br/&gt;
;-r&lt;/p&gt;</comment>
                            <comment id="14120679" author="hudson" created="Wed, 3 Sep 2014 23:31:52 +0000"  >&lt;p&gt;FAILURE: Integrated in Thrift #1270 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/1270/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/1270/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1266&quot; title=&quot;generated C code for iterating over nested maps is wrong&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1266&quot;&gt;&lt;del&gt;THRIFT-1266&lt;/del&gt;&lt;/a&gt; generated C code for iterating over nested maps is wrong (roger: rev d62473c3b0fff3f50f5d1f7e9dd6f8bdf91d4a66)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;compiler/cpp/src/generate/t_c_glib_generator.cc&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14122080" author="hudson" created="Thu, 4 Sep 2014 22:14:27 +0000"  >&lt;p&gt;FAILURE: Integrated in Thrift-Test #18 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift-Test/18/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift-Test/18/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1266&quot; title=&quot;generated C code for iterating over nested maps is wrong&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1266&quot;&gt;&lt;del&gt;THRIFT-1266&lt;/del&gt;&lt;/a&gt; generated C code for iterating over nested maps is wrong (roger: rev d62473c3b0fff3f50f5d1f7e9dd6f8bdf91d4a66)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;compiler/cpp/src/generate/t_c_glib_generator.cc&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14197478" author="hudson" created="Wed, 5 Nov 2014 04:48:15 +0000"  >&lt;p&gt;SUCCESS: Integrated in Thrift #1331 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/1331/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/1331/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1266&quot; title=&quot;generated C code for iterating over nested maps is wrong&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1266&quot;&gt;&lt;del&gt;THRIFT-1266&lt;/del&gt;&lt;/a&gt; generated C code for iterating over nested maps is wrong (roger: rev d62473c3b0fff3f50f5d1f7e9dd6f8bdf91d4a66)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;compiler/cpp/src/generate/t_c_glib_generator.cc&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                                                <inwardlinks description="is required by">
                                        <issuelink>
            <issuekey id="12738836">THRIFT-2690</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12490649" name="batch_mutate.c" size="4445" author="asaveljevs" created="Wed, 17 Aug 2011 13:39:33 +0000"/>
                            <attachment id="12666120" name="thrift-1266-c_glib-variable-collision-serializing-nested-maps.patch" size="2483" author="simonsouth" created="Wed, 3 Sep 2014 02:08:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>56998</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 3 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i14i7j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>234413</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>