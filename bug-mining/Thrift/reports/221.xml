<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 07:56:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-632] Constants of enum types don&apos;t behave well</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-632</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;It turns out that &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-551&quot; title=&quot;Enumeration doesn&amp;#39;t generate real enum in Java&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-551&quot;&gt;&lt;del&gt;THRIFT-551&lt;/del&gt;&lt;/a&gt; missed the case of constants defined of enum types. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12441214">THRIFT-632</key>
            <summary>Constants of enum types don&apos;t behave well</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bryanduxbury">Bryan Duxbury</assignee>
                                    <reporter username="bryanduxbury">Bryan Duxbury</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 Nov 2009 18:31:03 +0000</created>
                <updated>Fri, 18 Dec 2009 19:41:43 +0000</updated>
                            <resolved>Fri, 18 Dec 2009 19:41:43 +0000</resolved>
                                    <version>0.2</version>
                                    <fixVersion>0.3</fixVersion>
                                    <component>Java - Compiler</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12780192" author="bryanduxbury" created="Thu, 19 Nov 2009 18:33:41 +0000"  >&lt;p&gt;This patch does a few things:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Change the compiler to behave better when parsing constant declarations that should contain named values&lt;/li&gt;
	&lt;li&gt;Change the compiler to validate constants of enum types are set correctly&lt;/li&gt;
	&lt;li&gt;Update the Java compiler to generate the right stuff in Constants.java&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;All in all this is a good bunch of improvements. I&apos;d love those with compiler hacking experience to chime in on my design decisions.&lt;/p&gt;</comment>
                            <comment id="12780263" author="dreiss" created="Thu, 19 Nov 2009 20:51:23 +0000"  >&lt;p&gt;+      const vector&amp;lt;t_enum_value*&amp;gt; enum_values = ((t_enum*)type)-&amp;gt;get_constants();&lt;/p&gt;

&lt;p&gt;That should be a vector reference (add a &amp;amp; after the &amp;gt; ).&lt;/p&gt;

&lt;p&gt;The main issues I see:&lt;/p&gt;

&lt;p&gt;1/ No longer possible to have a constant value be the name of another constant.  I don&apos;t know if anyone is using this feature.&lt;br/&gt;
2/ Generated C++ code is broken since it uses get_integer() for enum constants.&lt;/p&gt;

&lt;p&gt;One possible solution for #1 is to only make the constant an enum value if the constant lookup fails (and fail if any enum name matches a constant name).&lt;/p&gt;

&lt;p&gt;One possible solution for #2 is to fix all of the generators.  Another is to replace set_identifier with a &quot;set_enum&quot; that sets both the enum name and the integer value.  This might require having access to the enumeration in the parser clause that reads the const value.  I can help with that if you want to go that route.  Also, it looks like we don&apos;t really verify constant value types anywhere, which is weird.&lt;/p&gt;</comment>
                            <comment id="12780887" author="bryanduxbury" created="Sat, 21 Nov 2009 02:13:56 +0000"  >&lt;p&gt;Here&apos;s an incomplete solution to the problem. When I encounter a constant of an enum type, I store the identifier and generate code with that later on down the road. If it happens not to be one of the enumerated values in the enum type, then I check if it&apos;s a constant and fail otherwise.&lt;/p&gt;

&lt;p&gt;I added some code so that libraries that don&apos;t support this behavior directly when rendering constants can still do the get_integer call, but it&apos;s not perfect. I think the problems I&apos;ve run into are that when the constant is a map (and probably list or set), then there&apos;s no parsing step I&apos;ve messed with yet that gives it the opportunity to inject the enum type, and the compiler fails. I think the solution is some sort of recursive enum type propagation thing in the code for const defs, but I&apos;m not sure. &lt;/p&gt;

&lt;p&gt;I&apos;d love input on this solution.&lt;/p&gt;</comment>
                            <comment id="12781547" author="bryanduxbury" created="Mon, 23 Nov 2009 19:08:11 +0000"  >&lt;p&gt;Ok. This patch seems to do everything we needed. Here&apos;s what I did:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Created a method on t_scope called &quot;resolve_const_value&quot; that recursively finds const values that need to be tagged with their enum types. It also resolves constants referenced by name.&lt;/li&gt;
	&lt;li&gt;Changed t_const_value&apos;s get_integer method to return the integer value of the appropriate enum constant when t_const_value is of IDENTIFIER type.&lt;/li&gt;
	&lt;li&gt;Create a method on t_enum called &quot;resolve_values&quot; that directly assigns values to implicit enum constants. This makes sure the values will be available for the resolve_const_value call. It uses a somewhat naive enum value assignment algorithm, so that might be an area to improve.&lt;/li&gt;
	&lt;li&gt;Small changes to thrifty.yy to make calls to the appropriate methods above when needed.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;There&apos;s a fair amount of code changed in this patch, so I&apos;d love some reviews.&lt;/p&gt;</comment>
                            <comment id="12781577" author="bryanduxbury" created="Mon, 23 Nov 2009 19:43:29 +0000"  >&lt;p&gt;Oops, screwed up that last patch a bit. Changed some names and includes without testing.&lt;/p&gt;</comment>
                            <comment id="12781703" author="bryanduxbury" created="Mon, 23 Nov 2009 23:57:28 +0000"  >&lt;p&gt;Found some more issues. This patch makes it safe to define constant structs that include enums now, too.&lt;/p&gt;</comment>
                            <comment id="12783780" author="dreiss" created="Mon, 30 Nov 2009 18:36:10 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;-    if (value-&amp;gt;get_type() != t_const_value::CV_INTEGER) {
+    if (value-&amp;gt;get_type() != t_const_value::CV_IDENTIFIER) {
       throw &quot;type error: const \&quot;&quot; + name + &quot;\&quot; was declared as enum&quot;;
+    } else {
+      const vector&amp;lt;t_enum_value*&amp;gt;&amp;amp; enum_values = ((t_enum*)type)-&amp;gt;get_constants();
+      vector&amp;lt;t_enum_value*&amp;gt;::const_iterator c_iter;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;No need for an &quot;else&quot; since the &quot;throw&quot; transfers control.  The code can just continue after the &quot;if&quot;.&lt;/p&gt;

&lt;p&gt;Also, does this break the ability to use an integer as an enum constant.  That is going to be pretty annoying since it doesn&apos;t allow for a graceful upgrade.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;       pdebug(&quot;Const -&amp;gt; tok_const FieldType tok_identifier = ConstValue&quot;);
+//      printf(&quot;first: %d last: %d\n&quot;, @2.first_line, @2.last_line);
+      //g_scope-&amp;gt;resolve_const_value($5, $2);
       if (g_parse_mode == PROGRAM) {
+        g_scope-&amp;gt;resolve_const_value($5, $2);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Drop the debug code.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;       if (g_parse_mode == INCLUDES) {
+//        printf(&quot;ignoring %s on line %d because we are in include mode!&quot;, $1, yylineno);
         // Ignore identifiers in include mode
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Same.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+        } else {
+          // pwarning(1, &quot;No enum value or constant found named \&quot;%s\&quot;\n&quot;, get_identifier().c_str());
+          throw &quot;No enum value or constant found named \&quot;&quot; + const_val-&amp;gt;get_identifier() + &quot;\&quot;!&quot;;
+        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Move this up to the top of that if block (and reverse the test) so the common path doesn&apos;t need to be indented.&lt;br/&gt;
Also, drop debug code.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+      } else {
+        // printf(&quot;setting enum for %s to %s\n&quot;, const_val-&amp;gt;get_identifier().c_str(), ttype-&amp;gt;get_name().c_str());
+        const_val-&amp;gt;set_enum((t_enum*)ttype);
+      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Again, make this the &quot;if&quot; branch and the big block of code the &quot;else&quot; branch.&lt;br/&gt;
And remove debug code.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+      if (enum_ != NULL) {
+        t_enum_value* val = enum_-&amp;gt;get_constant_by_name(get_identifier());
+        return val-&amp;gt;get_value();
+      } else {
+        throw &quot;have identifier \&quot;&quot; + get_identifier() + &quot;\&quot;, but unset enum on line!&quot;;
+      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Reverse the branches.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+  void set_value(int val) {
+    has_value_ = true;
+    value_ = val;
+  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Is this going to cause us to start generating explicit values for all enums?  I guess that is okay, but I&apos;d prefer to see that as a separate commit, just in case is causes some problem.&lt;/p&gt;</comment>
                            <comment id="12783877" author="bryanduxbury" created="Mon, 30 Nov 2009 22:11:59 +0000"  >&lt;p&gt;Here&apos;s an updated version of the patch. I made the organizational and stylistic changes suggested.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure I understand your comment about ints and constants. Can you give me an example?&lt;/p&gt;

&lt;p&gt;As you&apos;ve noticed, this patch makes the values for enum constants &quot;explicit&quot; ahead of when it has been happening up to this point. That is, instead of the individual language generators deciding the values for &quot;valueless&quot; enum constants, now, they will be set during the grammar parsing phase. The values themselves should remain consistent.&lt;/p&gt;</comment>
                            <comment id="12783893" author="dreiss" created="Mon, 30 Nov 2009 22:26:56 +0000"  >&lt;p&gt;Right now, I can right&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;enum MyEnum {
  LOW = 1,
  MEDIUM = 2,
  HIGH = 3,
}
const MyEnum best_value = 2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And it will work.  With your patch, it doesn&apos;t, right?&lt;/p&gt;</comment>
                            <comment id="12787012" author="bryanduxbury" created="Mon, 7 Dec 2009 17:50:32 +0000"  >&lt;p&gt;You&apos;re right. Let me see if I can whip something up to resolve this.&lt;/p&gt;</comment>
                            <comment id="12787136" author="bryanduxbury" created="Mon, 7 Dec 2009 21:46:45 +0000"  >&lt;p&gt;OK. This version of the patch allows you to declare enum constants by their given numeric value. Internally it just converts them back to the correct named value.&lt;/p&gt;</comment>
                            <comment id="12791093" author="engberg" created="Wed, 16 Dec 2009 00:42:29 +0000"  >&lt;p&gt;This patch seems to break some uses of numeric constants.  Specifically, an i16 constant can&apos;t be used as an i16 parameter default:&lt;/p&gt;

&lt;p&gt;/tmp $ cat TestConst.thrift &lt;br/&gt;
const i16 CONST1 = 1&lt;br/&gt;
const i32 CONST2 = 2&lt;br/&gt;
service TestConst {&lt;br/&gt;
  void foo(1: i16 p1 = CONST1, 2: i32 p2 = CONST2)&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;/tmp $ thrift -gen java TestConst.thrift &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;FAILURE:/tmp/TestConst.thrift:4&amp;#93;&lt;/span&gt; type error: const &quot;p1&quot; was declared as i16&lt;/p&gt;


&lt;p&gt;This works in a non-patched 0.2.0 release.&lt;/p&gt;</comment>
                            <comment id="12791095" author="engberg" created="Wed, 16 Dec 2009 00:45:45 +0000"  >&lt;p&gt;Actually, it&apos;s not specific to i16 ... the patch (applied on 0.2.0) doesn&apos;t permit any named constants for parameter defaults:&lt;/p&gt;

&lt;p&gt;/tmp $ cat TestConst.thrift &lt;br/&gt;
const i32 CONST1 = 1&lt;br/&gt;
service TestConst {&lt;br/&gt;
  void foo(1: i32 p1 = CONST1) &lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;/tmp $ thrift -gen java TestConst.thrift &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;FAILURE:/tmp/TestConst.thrift:3&amp;#93;&lt;/span&gt; type error: const &quot;p1&quot; was declared as i32&lt;/p&gt;</comment>
                            <comment id="12791114" author="bryanduxbury" created="Wed, 16 Dec 2009 01:37:31 +0000"  >&lt;p&gt;Hm, the validation code in the compiler probably just needs a look. I&apos;ll see what I can do.&lt;/p&gt;</comment>
                            <comment id="12792049" author="bryanduxbury" created="Thu, 17 Dec 2009 18:26:19 +0000"  >&lt;p&gt;OK, I think this fixes the problem with using constants as default argument values. Can you try it out and let me know if it fixes your problem?&lt;/p&gt;</comment>
                            <comment id="12792058" author="bryanduxbury" created="Thu, 17 Dec 2009 18:36:21 +0000"  >&lt;p&gt;Oops, introduced a trivial test compile error in that last patch.&lt;/p&gt;</comment>
                            <comment id="12792343" author="tjake" created="Fri, 18 Dec 2009 04:58:04 +0000"  >&lt;p&gt;+1 fixed the issue for me.&lt;/p&gt;</comment>
                            <comment id="12792585" author="dreiss" created="Fri, 18 Dec 2009 19:06:34 +0000"  >&lt;p&gt;I&apos;m probably not going to be able to review this until January.  The last version I looked at was pretty close to being okay, and the test cases look good, so if you&apos;re jonesing to get this checked in, I&apos;m fine with you committing it now and I&apos;ll take a closer look when I have some time.&lt;/p&gt;</comment>
                            <comment id="12792610" author="bryanduxbury" created="Fri, 18 Dec 2009 19:41:43 +0000"  >&lt;p&gt;I just committed this. Thanks to all who reviewed and tested this patch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12425696" name="thrift-632-v2.patch" size="6411" author="bryanduxbury" created="Sat, 21 Nov 2009 02:13:56 +0000"/>
                            <attachment id="12425870" name="thrift-632-v3.patch" size="10631" author="bryanduxbury" created="Mon, 23 Nov 2009 19:08:11 +0000"/>
                            <attachment id="12425872" name="thrift-632-v4.patch" size="10715" author="bryanduxbury" created="Mon, 23 Nov 2009 19:43:29 +0000"/>
                            <attachment id="12425910" name="thrift-632-v5.patch" size="13415" author="bryanduxbury" created="Mon, 23 Nov 2009 23:57:28 +0000"/>
                            <attachment id="12426455" name="thrift-632-v6.patch" size="12655" author="bryanduxbury" created="Mon, 30 Nov 2009 22:11:59 +0000"/>
                            <attachment id="12427238" name="thrift-632-v7.patch" size="13781" author="bryanduxbury" created="Mon, 7 Dec 2009 21:46:45 +0000"/>
                            <attachment id="12428322" name="thrift-632-v8.patch" size="14314" author="bryanduxbury" created="Thu, 17 Dec 2009 18:26:19 +0000"/>
                            <attachment id="12428327" name="thrift-632-v9.patch" size="14921" author="bryanduxbury" created="Thu, 17 Dec 2009 18:36:21 +0000"/>
                            <attachment id="12425506" name="thrift-632.patch" size="4308" author="bryanduxbury" created="Thu, 19 Nov 2009 18:33:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>186801</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 49 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i16euv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>245539</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>