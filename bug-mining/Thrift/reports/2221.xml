<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:34:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-5609] TJSONProtocol is unsafe to be used with TDeserializerPool</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-5609</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;We just realized that when using TJSONProtocol with TDeserializerPool like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-go&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; deserializerPool = thrift.NewTDeserializerPoolSizeFactory(1024, thrift.NewTJSONProtocolFactory())
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It only works when it never fails (e.g. it never encounters invalid json blobs). Whenever a failure happens, because of the internal state stack and other states in TJSONProtocol, it will be put back into the pool with the wrong state, and when it&apos;s next used it will fail again.&lt;/p&gt;

&lt;p&gt;There are a few approaches we can take to fix it:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;The simplest &quot;fix&quot; would be just document in TDeserializerPool and TSerializerPool that TJSONProtocol and TSimpleJSONProtocol are not safe to be used, and maybe provide some examples of how to use them (only pool the TMemoryBuffer and recreate TProtocol every time)&lt;/li&gt;
	&lt;li&gt;In TJSONProtocol and TSimpleJSONProtocol&apos;s &lt;span class=&quot;error&quot;&gt;&amp;#91;Read|Write&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Message|Struct&amp;#93;&lt;/span&gt;Begin, implicitly reset the internal state. But I&apos;m not sure how safe that is&lt;/li&gt;
	&lt;li&gt;Make a breaking change to TProtocol to add a Reset (or maybe ResetState) API to be used by TDeserializer/TSerializer (similar to how they always reset the TMemoryBuffer before doing anything)&lt;/li&gt;
	&lt;li&gt;Similar to 3 but less breaking, just add a Reset/ResetState to TJSONProtocol and TSimpleJSONProtocol (but not TProtocol), and in TDeserializer/TSerializer do a type assertion and call the Reset API on the protocol if it exists.&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13475504">THRIFT-5609</key>
            <summary>TJSONProtocol is unsafe to be used with TDeserializerPool</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fishywang">Yuxuan Wang</assignee>
                                    <reporter username="fishywang">Yuxuan Wang</reporter>
                        <labels>
                    </labels>
                <created>Fri, 5 Aug 2022 21:42:26 +0000</created>
                <updated>Wed, 26 Oct 2022 23:46:24 +0000</updated>
                            <resolved>Sat, 6 Aug 2022 15:25:38 +0000</resolved>
                                    <version>0.16.0</version>
                                    <fixVersion>0.17.0</fixVersion>
                                    <component>Go - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17576063" author="calcifer" created="Fri, 5 Aug 2022 21:59:45 +0000"  >&lt;p&gt;4 is clean and safe, but 2 is cleaner. Can you think of a legitimate use case that would be broken by 2? Nothing comes to mind.&lt;/p&gt;</comment>
                            <comment id="17576066" author="fishywang" created="Fri, 5 Aug 2022 22:16:13 +0000"  >&lt;p&gt;It looks like there are cases we call ReadStructBegin after ReadMessageBegin, so trying to reset the state in ReadStructBegin will mess things up.&lt;/p&gt;</comment>
                            <comment id="17576067" author="fishywang" created="Fri, 5 Aug 2022 22:16:38 +0000"  >&lt;p&gt;Also just found out &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3735&quot; title=&quot;JSON protocol left in incorrect state when an exception is thrown during read or write operations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3735&quot;&gt;&lt;del&gt;THRIFT-3735&lt;/del&gt;&lt;/a&gt; when I&apos;m trying to work on a fix &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17576069" author="fishywang" created="Fri, 5 Aug 2022 22:37:20 +0000"  >&lt;p&gt;Also updated the issue to be only about TJSONProtocol and TDeserializerPool (removed TSimpleJSONProtocol and TSerializerPool), because:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;A TSerializerPool cannot really fail (the only possible failure is write fail and the TMemoryBuffer cannot fail to write)&lt;/li&gt;
	&lt;li&gt;TSimpleJSONProtocol cannot be deserialized to begin with (even without a pool)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;But I did also add Reset call to TSerializer.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 14 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z17j8g:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>