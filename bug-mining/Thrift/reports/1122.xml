<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:15:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-2789] TNonblockingServer leaks socket FD&apos;s under load</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-2789</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;I checked 0.9.2 and 1.0, but code didn&apos;t seem to change in 1.2 either.&lt;/p&gt;

&lt;p&gt;Problem is that network threads and worker threads use non-blocking socket (pipe) to communicate. Under heavy load writes to that pipe might fail with EAGAIN. While &apos;notifyIOThread&apos; method carefully checks for the error and communicates the result via return value, not all callers check result of &apos;notify&apos;.&lt;/p&gt;

&lt;p&gt;Generally it&apos;s hard to tell what appropriate handling of such a failure would be, but it&apos;s clear sockets shouldn&apos;t leak. Please use attached patch for the reference, but I do not insist what I did there is the best way to fix the problem.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12749020">THRIFT-2789</key>
            <summary>TNonblockingServer leaks socket FD&apos;s under load</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jensg">Jens Geyer</assignee>
                                    <reporter username="drigh">Sergey</reporter>
                        <labels>
                    </labels>
                <created>Sat, 18 Oct 2014 01:25:00 +0000</created>
                <updated>Wed, 22 Mar 2017 18:52:46 +0000</updated>
                            <resolved>Thu, 4 Dec 2014 20:53:18 +0000</resolved>
                                                    <fixVersion>0.9.3</fixVersion>
                                    <component>C++ - Library</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14175781" author="drigh" created="Sat, 18 Oct 2014 01:26:51 +0000"  >&lt;p&gt;Like I said in description, this solution is not perfect, but it helps to at least avoid leaking FD&apos;s.&lt;/p&gt;</comment>
                            <comment id="14225628" author="qiaomuf" created="Wed, 26 Nov 2014 02:53:32 +0000"  >&lt;p&gt;I may have the same issue here.&lt;/p&gt;

&lt;p&gt;I had a running TNonblockingServer of pid 106129 listening to port 3643. After all clients killed, what I found was:&lt;br/&gt;
$:/proc/106129/fd# ls -l|wc -l&lt;br/&gt;
59310&lt;br/&gt;
$:/proc/106129/fd# netstat -an|grep 3643|wc -l&lt;br/&gt;
136&lt;/p&gt;

&lt;p&gt;It&apos;s hard to reproduce under light load. And once I encounter this, I have to restart the server to solve the problem.&lt;/p&gt;

&lt;p&gt;If you need more information, please tell me.&lt;/p&gt;</comment>
                            <comment id="14227285" author="qiaomuf" created="Thu, 27 Nov 2014 05:37:18 +0000"  >&lt;p&gt;I checked Sergey&apos;s patch and it shouldn&apos;t work. It&apos;s not the problem with PIPE. Otherwise the server should have already crashed as no one catch these exceptions.&lt;/p&gt;</comment>
                            <comment id="14227895" author="drigh" created="Thu, 27 Nov 2014 18:53:14 +0000"  >&lt;p&gt;Qiao, could you please try this patch on your system? It doesn&apos;t change exception handling (except logging), main thing it does is closing connection on errors.&lt;/p&gt;

&lt;p&gt;For me reliable way to reproduce FD leak was to attach strace to a running process (strace -p &amp;lt;PID&amp;gt;), makes process consistently leaking descriptors even under light load.&lt;/p&gt;</comment>
                            <comment id="14228048" author="qiaomuf" created="Fri, 28 Nov 2014 02:30:06 +0000"  >&lt;p&gt;I tried your strace approach but I can&apos;t reproduce FD leak.&lt;/p&gt;

&lt;p&gt;From what I see,  you close connection before throwing an exception. But even if you didn&apos;t close the connection, there&apos;s no code catching that exception so the program should terminate. That also means there is no error on calling notifyIOThread for me as my program hasn&apos;t ever crashed for this.&lt;/p&gt;</comment>
                            <comment id="14228320" author="drigh" created="Fri, 28 Nov 2014 15:00:01 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// XXX need to log this&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;it used to be an empty catch-block that handled the exception being thrown&lt;/p&gt;

&lt;p&gt;if you think those &apos;throw&apos; statements have never been hit, my patch should be a no-op, so there&apos;s no harm in trying it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;optionally, you could only apply &apos;ThreadManager.cpp&apos; changes to make sure those &apos;catch&apos; blocks do get triggered.&lt;/p&gt;</comment>
                            <comment id="14231305" author="qiaomuf" created="Tue, 2 Dec 2014 10:56:15 +0000"  >&lt;p&gt;Finally I reproduced the issue and fixed it. Sergey was right about the PIPE, although I didn&apos;t get it at the first place. I&apos;ve uploaded a cleaner version that fixes the most important cause of the leak.&lt;/p&gt;

&lt;p&gt;The root cause is TNonblockingServer::TConnection::Task::run() throws an TException when notifyIOThread returns false. Then ThreadManager just simply ignores the exception (the comment in ThreadManager says &quot;XXX need to log this&quot; but it never does). So from the user view, we don&apos;t see any error except a never-return connection and have to use timeout to work around.&lt;/p&gt;

&lt;p&gt;When there&apos;s high load for IOThread, it&apos;s common to see notifyIOThread fails. More specifically, the send method inside TNonblockingIOThread::notify returns -1 and errno is set to EAGAIN.&lt;/p&gt;

&lt;p&gt;The patch closes the connection in such case as Sergey did. It&apos;s simple and enough for me. I also tried with select and a short  timeout, it did not work well. &lt;/p&gt;

&lt;p&gt;This bug exists for a very long time and it&apos;s still not fixed yet. Could anybody please look into this issue?&lt;/p&gt;</comment>
                            <comment id="14232089" author="jensg" created="Tue, 2 Dec 2014 20:29:42 +0000"  >&lt;p&gt;@&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=drigh&quot; class=&quot;user-hover&quot; rel=&quot;drigh&quot;&gt;drigh&lt;/a&gt;, what do you think?&lt;/p&gt;</comment>
                            <comment id="14232093" author="drigh" created="Tue, 2 Dec 2014 20:39:06 +0000"  >&lt;p&gt;Patch that Qiao uploaded will fix the problem. My original patch will also fix couple of other places in code where same problem could potentially occur (yet, didn&apos;t).&lt;/p&gt;

&lt;p&gt;All my hesitation is that closing connection on EAGAIN error seems overly harsh, yet I don&apos;t see any other way to handle that (and keep server truly nonblocking). I.e. while it certainly fixes the resource leak and improves overall state, I can&apos;t call it a complete fix.&lt;/p&gt;</comment>
                            <comment id="14234607" author="jensg" created="Thu, 4 Dec 2014 20:51:25 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12685170/12685170_THRIFT-2789-TNonblockingServer-leaks-socket-FD-s-und.patch&quot; title=&quot;THRIFT-2789-TNonblockingServer-leaks-socket-FD-s-und.patch attached to THRIFT-2789&quot;&gt;Condsoldidated and rebased version of the patches&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="14234609" author="jensg" created="Thu, 4 Dec 2014 20:53:18 +0000"  >&lt;p&gt;Committed, thank you both!&lt;/p&gt;</comment>
                            <comment id="14234633" author="hudson" created="Thu, 4 Dec 2014 21:19:44 +0000"  >&lt;p&gt;SUCCESS: Integrated in Thrift #1385 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/1385/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/1385/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2789&quot; title=&quot;TNonblockingServer leaks socket FD&amp;#39;s under load&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2789&quot;&gt;&lt;del&gt;THRIFT-2789&lt;/del&gt;&lt;/a&gt; TNonblockingServer leaks socket FD&apos;s under load (jensg: rev fb05cf67db2d9515186acb94aa41160d2a1281fc)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;lib/cpp/src/thrift/concurrency/ThreadManager.cpp&lt;/li&gt;
	&lt;li&gt;lib/cpp/src/thrift/server/TNonblockingServer.cpp&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14234919" author="drigh" created="Fri, 5 Dec 2014 01:57:39 +0000"  >&lt;p&gt;great to see it fixed! thank you!&lt;/p&gt;</comment>
                            <comment id="14234955" author="qiaomuf" created="Fri, 5 Dec 2014 02:30:17 +0000"  >&lt;p&gt;Great! Thank you!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="13058354">THRIFT-4129</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12684618" name="0001-Close-connection-when-failed-to-notify-IO-thread.patch" size="929" author="qiaomuf" created="Tue, 2 Dec 2014 10:56:43 +0000"/>
                            <attachment id="12675637" name="D10015.diff" size="2268" author="drigh" created="Sat, 18 Oct 2014 01:26:51 +0000"/>
                            <attachment id="12685170" name="THRIFT-2789-TNonblockingServer-leaks-socket-FD-s-und.patch" size="3136" author="jensg" created="Thu, 4 Dec 2014 20:50:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 50 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i21bgn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>