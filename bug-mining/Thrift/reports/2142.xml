<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:33:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-4451] Rust cross test client fails to communicate with multiplexed servers</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-4451</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;As stated in description. Minimal case is to comment out everything in the Rust &lt;tt&gt;test_client&lt;/tt&gt; leaving only the &lt;tt&gt;SecondService&lt;/tt&gt; call behind.&lt;/p&gt;

&lt;p&gt;From what I can tell the Rust socket isn&apos;t getting &lt;b&gt;any&lt;/b&gt; bytes at all for the response (i.e. it can&apos;t even get the first 4 bytes of the message header). There is a &lt;tt&gt;flush()&lt;/tt&gt; call on the remote side - so that&apos;s puzzling.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13130188">THRIFT-4451</key>
            <summary>Rust cross test client fails to communicate with multiplexed servers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="allengeorge">Allen George</assignee>
                                    <reporter username="allengeorge">Allen George</reporter>
                        <labels>
                    </labels>
                <created>Thu, 11 Jan 2018 12:36:53 +0000</created>
                <updated>Mon, 1 Mar 2021 01:42:47 +0000</updated>
                            <resolved>Mon, 1 Mar 2021 01:42:47 +0000</resolved>
                                                                    <component>Rust - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16407860" author="allengeorge" created="Wed, 21 Mar 2018 12:58:11 +0000"  >&lt;p&gt;I&apos;m noticing weird behavior where the rust client opens multiple tcp connections to the perl server (as an example).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;E..&amp;lt;..@.@.&amp;lt;.............U!..._k......0.........                                                                                                                                                                                      [49/1830]
.f...f......
12:48:59.767657 IP (tos 0x0, ttl 64, id 36675, offset 0, flags [DF], proto TCP (6), length 52)
    127.0.0.1.52406 &amp;gt; 127.0.0.1.45773: Flags [.], cksum 0xfe28 (incorrect -&amp;gt; 0xe90b), seq 1, ack 1, win 342, options [nop,nop,TS val 6743292 ecr 6743292], length 0
E..4.C@.@..~............._k.U!.....V.(.....
.f...f..
12:48:59.767908 IP (tos 0x0, ttl 64, id 57595, offset 0, flags [DF], proto TCP (6), length 60)
    127.0.0.1.52408 &amp;gt; 127.0.0.1.45773: Flags [S], cksum 0xfe30 (incorrect -&amp;gt; 0xed41), seq 1325204487, win 43690, options [mss 65495,sackOK,TS val 6743292 ecr 0,nop,wscale 7], length 0
E..&amp;lt;..@.@.[.............N............0.........
.f..........
12:48:59.767923 IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto TCP (6), length 60)
    127.0.0.1.45773 &amp;gt; 127.0.0.1.52408: Flags [S.], cksum 0xfe30 (incorrect -&amp;gt; 0xafd8), seq 2054544767, ack 1325204488, win 43690, options [mss 65495,sackOK,TS val 6743292 ecr 6743292,nop,wscale 7], length 0
E..&amp;lt;..@.@.&amp;lt;.............zu..N........0.........
.f...f......
12:48:59.767937 IP (tos 0x0, ttl 64, id 57596, offset 0, flags [DF], proto TCP (6), length 52)
    127.0.0.1.52408 &amp;gt; 127.0.0.1.45773: Flags [.], cksum 0xfe28 (incorrect -&amp;gt; 0x821d), seq 1, ack 1, win 342, options [nop,nop,TS val 6743292 ecr 6743292], length 0
E..4..@.@.[.............N...zu.....V.(.....
.f...f..
12:48:59.769584 IP (tos 0x0, ttl 64, id 36676, offset 0, flags [DF], proto TCP (6), length 84)
    127.0.0.1.52406 &amp;gt; 127.0.0.1.45773: Flags [P.], cksum 0xfe48 (incorrect -&amp;gt; 0x8b06), seq 1:33, ack 1, win 342, options [nop,nop,TS val 6743292 ecr 6743292], length 32
E..T.D@.@..]............._k.U!.....V.H.....
.f...f..........ThriftTest:testVoid.....
12:48:59.769599 IP (tos 0x0, ttl 64, id 30002, offset 0, flags [DF], proto TCP (6), length 52)
    127.0.0.1.45773 &amp;gt; 127.0.0.1.52406: Flags [.], cksum 0xfe28 (incorrect -&amp;gt; 0xe8eb), seq 1, ack 33, win 342, options [nop,nop,TS val 6743292 ecr 6743292], length 0
E..4u2@.@...............U!..._k....V.(.....
.f...f..
12:48:59.771085 IP (tos 0x0, ttl 64, id 30003, offset 0, flags [DF], proto TCP (6), length 73)
    127.0.0.1.45773 &amp;gt; 127.0.0.1.52406: Flags [P.], cksum 0xfe3d (incorrect -&amp;gt; 0xc114), seq 1:22, ack 33, win 342, options [nop,nop,TS val 6743292 ecr 6743292], length 21
E..Iu3@.@..y............U!..._k....V.=.....
.f...f..........testVoid.....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The above shows two different connections involved here. It&apos;s unclear if this is the cause of the issues, but it explains why bytes being flushed out of the perl server never seem to show up at the rust client.&lt;/p&gt;

&lt;p&gt;FWIW, I &lt;b&gt;have&lt;/b&gt; confirmed that the flushed bytes appear on the wire:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;12:49:05.752416 IP (tos 0x0, ttl 64, id 14717, offset 0, flags [DF], proto TCP (6), length 126)
    127.0.0.1.45773 &amp;gt; 127.0.0.1.52408: Flags [P.], cksum 0xfe72 (incorrect -&amp;gt; 0x2820), seq 1:75, ack 63, win 342, options [nop,nop,TS val 6743890 ecr 6743890], length 74
E..~9}@.@...............zu..N..F...V.r.....
.f.R.f.R........secondtestString..........&amp;amp;allen-return-testString(&quot;test_string&quot;).
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16407862" author="allengeorge" created="Wed, 21 Mar 2018 13:02:10 +0000"  >&lt;p&gt;Weirdly enough, here&apos;s the sequence of back and forth. The perl server is listening on 45773&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;lt;---- REQUEST
12:48:59.775728 IP (tos 0x0, ttl 64, id 57597, offset 0, flags [DF], proto TCP (6), length 113)                                                                                                                                       [6/1830]
    127.0.0.1.52408 &amp;gt; 127.0.0.1.45773: Flags [P.], cksum 0xfe65 (incorrect -&amp;gt; 0xa11f), seq 1:62, ack 1, win 342, options [nop,nop,TS val 6743292 ecr 6743292], length 61
E..q..@.@.[.............N...zu.....V.e.....
.f...f..........SecondService:secondtestString...........test_string.

WHAT IS THIS?!
12:48:59.775740 IP (tos 0x0, ttl 64, id 14716, offset 0, flags [DF], proto TCP (6), length 52)
    127.0.0.1.45773 &amp;gt; 127.0.0.1.52408: Flags [.], cksum 0xfe28 (incorrect -&amp;gt; 0x81e0), seq 1, ack 62, win 342, options [nop,nop,TS val 6743292 ecr 6743292], length 0
E..49|@.@..F............zu..N..E...V.(.....
.f...f..

WHAT IS THIS?
12:49:05.748396 IP (tos 0x0, ttl 64, id 57598, offset 0, flags [DF], proto TCP (6), length 52)
    127.0.0.1.52408 &amp;gt; 127.0.0.1.45773: Flags [F.], cksum 0xfe28 (incorrect -&amp;gt; 0x7f89), seq 62, ack 1, win 342, options [nop,nop,TS val 6743890 ecr 6743292], length 0
E..4..@.@.[.............N..Ezu.....V.(.....
.f.R.f..

---&amp;gt; RESPONSE
12:49:05.752416 IP (tos 0x0, ttl 64, id 14717, offset 0, flags [DF], proto TCP (6), length 126)
    127.0.0.1.45773 &amp;gt; 127.0.0.1.52408: Flags [P.], cksum 0xfe72 (incorrect -&amp;gt; 0x2820), seq 1:75, ack 63, win 342, options [nop,nop,TS val 6743890 ecr 6743890], length 74
E..~9}@.@...............zu..N..F...V.r.....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m assuming the &quot;WHAT IS THIS&quot; lines are TCP-level packets?&lt;/p&gt;</comment>
                            <comment id="16674610" author="allengeorge" created="Mon, 5 Nov 2018 02:33:18 +0000"  >&lt;p&gt;Noticing the same problem with cpp servers as well.&lt;/p&gt;</comment>
                            <comment id="16679271" author="allengeorge" created="Thu, 8 Nov 2018 03:39:59 +0000"  >&lt;p&gt;Somehow the client is shutting down the connection before it receives the replies. I&apos;m seeing &lt;/p&gt;
{FIN}
&lt;p&gt;s from the client-&amp;gt; server. I&apos;m sure it&apos;s a lifetime issue...&lt;/p&gt;</comment>
                            <comment id="16681366" author="allengeorge" created="Fri, 9 Nov 2018 12:07:16 +0000"  >&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12947571/12947571_Screen+Shot+2018-11-09+at+07.03.39.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;Here&apos;s a representative sample of what I&apos;m seeing. Specifically, after the call to the second-test server is sent and the server responds with an &lt;tt&gt;ACK&lt;/tt&gt;, the client immediately sends out a &lt;tt&gt;FIN&lt;/tt&gt;. Now, once the server sends its response the client thinks the connection is dead, and so of course nothing is read.&lt;/p&gt;

&lt;p&gt;AFAICT, I&apos;m not invoking &lt;tt&gt;shutdown()&lt;/tt&gt; explicitly, neither is &lt;tt&gt;Drop&lt;/tt&gt; on the &lt;tt&gt;TcpStream&lt;/tt&gt; getting called.&lt;/p&gt;</comment>
                            <comment id="16763671" author="jking3" created="Fri, 8 Feb 2019 15:00:31 +0000"  >&lt;p&gt;I&apos;ve added multiplex support to the python cross test server and rust is misbehaving here as well.  Here&apos;s an example:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;root@539e8f5f880a:/thrift/src# test/test.py --server java,py,py3 --client cpp,java,rs --regex=&apos;.*multi_buffered-ip.*&apos;
Apache Thrift - Integration Test Suite
Fri Feb 08 14:56:14 2019
===============================================================================
server-client:          protocol:         transport:               result:
java-java               multi             buffered-ip              success
java-java               multi             buffered-ip-ssl          success
java-rs                 multi             buffered-ip              success
py-java                 multi             buffered-ip-ssl          success
java-cpp                multi             buffered-ip-ssl          success
java-cpp                multi             buffered-ip              success
py-java                 multia-multi      buffered-ip              success
py-java                 multi             buffered-ip              success
py-java                 multia-multi      buffered-ip-ssl          success
py-cpp                  multi             buffered-ip              success
py-cpp                  multi             buffered-ip-ssl          success
py-cpp                  multia-multi      buffered-ip-ssl          success
py-cpp                  multia-multi      buffered-ip              success
py3-java                multi             buffered-ip-ssl          success
py3-java                multi             buffered-ip              success
py3-java                multia-multi      buffered-ip-ssl          success
py3-java                multia-multi      buffered-ip              success
py3-cpp                 multi             buffered-ip-ssl          success
py3-cpp                 multi             buffered-ip              success
py3-cpp                 multia-multi      buffered-ip-ssl          success
py-rs                   multi             buffered-ip              failure(timeout)
py-rs                   multia-multi      buffered-ip              failure(timeout)
py3-cpp                 multia-multi      buffered-ip              success
py3-rs                  multi             buffered-ip              failure(timeout)
py3-rs                  multia-multi      buffered-ip              failure(timeout)
===============================================================================
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16763674" author="allengeorge" created="Fri, 8 Feb 2019 15:02:44 +0000"  >&lt;p&gt;Yeah - I&apos;m 100% sure this is a problem on the Rust side, but am somewhat stuck on how to debug it :/&lt;/p&gt;

&lt;p&gt;That said, TY for adding support to PY as well. It helps to have a language I&apos;m very, very familiar with to work with during the test-debug cycle.&lt;/p&gt;</comment>
                            <comment id="17292204" author="allengeorge" created="Sat, 27 Feb 2021 19:02:27 +0000"  >&lt;p&gt;I made some time recently to work on the Rust Thrift implementation again and decided to look at this with fresh eyes.&lt;/p&gt;

&lt;h3&gt;&lt;a name=&quot;What%27sfailing&quot;&gt;&lt;/a&gt;What&apos;s failing&lt;/h3&gt;

&lt;p&gt;I started off by evaluating the state of the world. There have been quite a few changes/bugfixes to the Rust implementation over the past two years, and I wanted to see where things were.&lt;/p&gt;

&lt;p&gt;The first interesting thing I noticed was that the Rust multi &lt;em&gt;server&lt;/em&gt; implementation was solid; every client was able to communicate with it without issues. The second interesting thing I noticed was that the Rust multi &lt;em&gt;client&lt;/em&gt; implementation only failed with some languages, not others. Notably, communication with Java multi servers was totally fine.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;root@3cec70e4dd34:/thrift/src# test/test.py --client rs
Apache Thrift - Integration Test Suite
Mon Feb 22 20:19:10 2021
===============================================================================
server-client:          protocol:         transport:               result:
c_glib-rs               multi-binary      buffered-ip              success
c_glib-rs               multic-compact    buffered-ip              success
c_glib-rs               multi-binary      framed-ip                success
c_glib-rs               multic-compact    framed-ip                success
c_glib-rs               multi-binary      buffered-ip              success
c_glib-rs               multi-binary      framed-ip                success
c_glib-rs               multi             framed-ip                failure(timeout)
c_glib-rs               multi             buffered-ip              failure(timeout)
c_glib-rs               multic-compact    buffered-ip              success
c_glib-rs               multic-compact    framed-ip                success
cl-rs                   multi-binary      buffered-ip              failure(1)
cl-rs                   multi-binary      framed-ip                failure(1)
cl-rs                   binary            buffered-ip              failure(1)
cl-rs                   binary            framed-ip                failure(1)
c_glib-rs               multic            framed-ip                failure(timeout)
c_glib-rs               multic            buffered-ip              failure(timeout)
cl-rs                   multi             framed-ip                failure(timeout)
cl-rs                   multi             buffered-ip              failure(timeout)
java-rs                 multi             buffered-ip              success
java-rs                 multi             fastframed-framed-ip     success
java-rs                 multi             framed-ip                success
java-rs                 multi-binary      buffered-ip              success
java-rs                 multi-binary      fastframed-framed-ip     success
java-rs                 multi-binary      framed-ip                success
java-rs                 multic-compact    buffered-ip              success
java-rs                 multic-compact    fastframed-framed-ip     success
java-rs                 multic-compact    framed-ip                success
java-rs                 multi-binary      buffered-ip              success
java-rs                 multi-binary      fastframed-framed-ip     success
java-rs                 multi-binary      framed-ip                success
java-rs                 multic            fastframed-framed-ip     success
java-rs                 multic            buffered-ip              success
java-rs                 multic            framed-ip                success
java-rs                 multic-compact    buffered-ip              success
java-rs                 multic-compact    fastframed-framed-ip     success
java-rs                 multic-compact    framed-ip                success
py-rs                   multi             framed-ip                failure(65)
py-rs                   multi             buffered-ip              failure(65)
py-rs                   multi-binary      framed-ip                failure(65)
py-rs                   multi-binary      buffered-ip              failure(65)
py-rs                   binary            framed-ip                failure(65)
py-rs                   binary            buffered-ip              failure(65)
py-rs                   compact           framed-ip                failure(65)
py-rs                   compact           buffered-ip              failure(65)
py-rs                   multic            framed-ip                failure(65)
py-rs                   multic            buffered-ip              failure(65)
py-rs                   multic-compact    framed-ip                failure(65)
py-rs                   multic-compact    buffered-ip              failure(65)
py-rs                   accelc-compact    framed-ip                failure(65)
py-rs                   accelc-compact    buffered-ip              failure(65)
py-rs                   accel-binary      framed-ip                failure(65)
py-rs                   accel-binary      buffered-ip              failure(65)
py-rs                   multiac-multic    framed-ip                failure(65)
py-rs                   multiac-multic    buffered-ip              failure(65)
py-rs                   multiac-compact   framed-ip                failure(65)
py-rs                   multiac-compact   buffered-ip              failure(65)
py-rs                   multia-multi      framed-ip                failure(65)
py-rs                   multia-binary     buffered-ip              failure(65)
py-rs                   multia-multi      buffered-ip              failure(65)
py-rs                   multia-binary     framed-ip                failure(65)
py3-rs                  multi-binary      buffered-ip              success
py3-rs                  multi-binary      framed-ip                success
py3-rs                  multic-compact    buffered-ip              success
py3-rs                  multic-compact    framed-ip                success
py3-rs                  multi             framed-ip                failure(timeout)
py3-rs                  multi             buffered-ip              failure(timeout)
py3-rs                  multiac-compact   buffered-ip              success
py3-rs                  multic            framed-ip                failure(timeout)
py3-rs                  multiac-compact   framed-ip                success
py3-rs                  multic            buffered-ip              failure(timeout)
py3-rs                  multia-binary     buffered-ip              success
py3-rs                  multia-binary     framed-ip                success
py3-rs                  multiac-multic    framed-ip                failure(timeout)
py3-rs                  multiac-multic    buffered-ip              failure(timeout)
cpp-rs                  multi-binary      buffered-ip              success
cpp-rs                  multic-compact    buffered-ip              success
cpp-rs                  multi-binary      framed-ip                success
py3-rs                  multia-multi      framed-ip                failure(timeout)
cpp-rs                  multic-compact    framed-ip                success
cpp-rs                  multi-binary      buffered-ip              success
py3-rs                  multia-multi      buffered-ip              failure(timeout)
cpp-rs                  multi             buffered-ip              failure(timeout)
cpp-rs                  multi-binary      framed-ip                success
cpp-rs                  multic-compact    buffered-ip              success
cpp-rs                  multi             framed-ip                failure(timeout)
cpp-rs                  multic-compact    framed-ip                success
cpp-rs                  multic            buffered-ip              failure(timeout)
cpp-rs                  multic            framed-ip                failure(timeout)
perl-rs                 multi-binary      buffered-ip              success
perl-rs                 multi-binary      buffered-ip              success
perl-rs                 multi-binary      framed-ip                success
perl-rs                 multi-binary      framed-ip                success
perl-rs                 multi             framed-ip                failure(timeout)
perl-rs                 multi             buffered-ip              failure(timeout)
rs-rs                   multi             buffered-ip              success
rs-rs                   multi-binary      buffered-ip              success
rs-rs                   multic-compact    buffered-ip              success
rs-rs                   multi             framed-ip                success
rs-rs                   multi-binary      framed-ip                success
rs-rs                   multic-compact    framed-ip                success
rs-rs                   multi-binary      buffered-ip              success
rs-rs                   multi-binary      framed-ip                success
rs-rs                   multic            buffered-ip              success
rs-rs                   multic-compact    buffered-ip              success
rs-rs                   multic            framed-ip                success
rs-rs                   multic-compact    framed-ip                success
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;These failures were independent of protocol (compact, binary) OR transport (buffered, framed). They &lt;em&gt;also&lt;/em&gt; only occurred if the client was started with the &lt;tt&gt;multi&lt;/tt&gt; or &lt;tt&gt;multic&lt;/tt&gt; argument; if a regular client connected to a &lt;tt&gt;multi&lt;/tt&gt; server there were no issues.&lt;/p&gt;

&lt;p&gt;I decided to focus on the interaction between the Rust client and the Python/CPP servers. I chose Python/CPP because those Thrift implementations appear heavily-used and receive a lot of community contributions.&lt;/p&gt;

&lt;h3&gt;&lt;a name=&quot;Whatdoesthecrosstestdo%3F&quot;&gt;&lt;/a&gt;What does the cross-test do?&lt;/h3&gt;

&lt;p&gt;The Rust client implements &lt;tt&gt;multi&lt;/tt&gt; and &lt;tt&gt;multic&lt;/tt&gt; support as follows:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;It creates a TCP connection for the first client (&lt;tt&gt;ThriftTest&lt;/tt&gt;), opens a connection to the remote server, splits this connection into a read half/write half, and then wraps the halves in the appropriate &lt;tt&gt;T*Transport&lt;/tt&gt; and &lt;tt&gt;T*Protocol&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;It creates a &lt;em&gt;new&lt;/em&gt; TCP connection for the second client (&lt;tt&gt;SecondService&lt;/tt&gt;), opens a connection to the remote server, splits this new connection into a read half/write half, and then wraps the halves in the appropriate &lt;tt&gt;T*Transport&lt;/tt&gt; and &lt;tt&gt;T*Protocol&lt;/tt&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;When &lt;tt&gt;multi&lt;/tt&gt; or &lt;tt&gt;multic&lt;/tt&gt; is passed to the Rust client it makes a series of service calls to &lt;tt&gt;ThriftTest&lt;/tt&gt;, followed by a single call to &lt;tt&gt;SecondService&lt;/tt&gt;, and then finally finishes up with a few calls to &lt;tt&gt;ThriftTest&lt;/tt&gt; again. The client always hangs waiting for a response to its &lt;tt&gt;SecondService&lt;/tt&gt; call.&lt;/p&gt;

&lt;p&gt;A typical interaction between a &lt;tt&gt;multi&lt;/tt&gt; Rust client and a &lt;tt&gt;multiprocessing&lt;/tt&gt; server looks like this:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Tue Feb 23 02:14:20 2021
Executing: python3 TestServer.py --verbose --genpydir=gen-py --protocol=multi --transport=buffered --port=33047 TSimpleServer
Directory: /thrift/src/test/py
config:delay: 5
config:timeout: 6
===============================================================================
INFO:root:testVoid()
INFO:root:testString(thing)
INFO:root:testBool(true)
INFO:root:testBool(false)
INFO:root:testByte(42)
INFO:root:testI32(1159348374)
INFO:root:testI64(-9223372036854775808)
INFO:root:testDouble(42.420000)
INFO:root:testTypedef(2348)
INFO:root:testEnum(2)
INFO:root:testBinary()
INFO:root:testStruct({foo, 12, 219129, 12938492818})
INFO:root:testNest(Xtruct2(byte_thing=32, struct_thing=Xtruct(string_thing=&apos;foo&apos;, byte_thing=1, i32_thing=324382098, i64_thing=12938492818), i32_thing=293481098))
===============================================================================
Return code: -1 (negative values indicate kill by signal)
Test execution took 6.3 seconds.
Tue Feb 23 02:14:27 2021
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;h3&gt;&lt;a name=&quot;Debugging&quot;&gt;&lt;/a&gt;Debugging&lt;/h3&gt;

&lt;p&gt;I started off by verifying that indeed, the &lt;tt&gt;SecondService&lt;/tt&gt; call was being made successfully through some &lt;tt&gt;println!&lt;/tt&gt; usage and &lt;tt&gt;tcpdump&lt;/tt&gt; (&lt;tt&gt;tcpdump -i any -tttt -XX -vv tcp port 33047 -w capture_0.pcap&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13021317/13021317_Screen+Shot+2021-02-27+at+13.31.21.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;The two connections initiations are for the &lt;tt&gt;ThriftTest&lt;/tt&gt; client (source port: 44834) and the &lt;tt&gt;SecondService&lt;/tt&gt; client (source port: 44836). We can see immediately that the &lt;tt&gt;SecondService&lt;/tt&gt; client &lt;tt&gt;CALL&lt;/tt&gt; bytes are going over the wire, but the remote server (whether CPP or PY3) was returning anything. (Note that I&apos;d made a mistake in my analysis two years ago: the &lt;tt&gt;FIN&lt;/tt&gt; I&apos;d seen was not caused by lifetime issues or &lt;tt&gt;Drop&lt;/tt&gt; etc. - it was simply because I&apos;d shut the client down. Doh.)&lt;/p&gt;

&lt;p&gt;This behaviour was very puzzling: it implied that there was a problem on the &lt;em&gt;server&lt;/em&gt; side, not the &lt;em&gt;client&lt;/em&gt; side - contrary to what I expected. I also noticed that this behaviour happened &lt;em&gt;regardless&lt;/em&gt; of order:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;tt&gt;ThriftTest&lt;/tt&gt; calls &lt;em&gt;before&lt;/em&gt; the &lt;tt&gt;SecondService&lt;/tt&gt; call&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;SecondService&lt;/tt&gt; call, followed by &lt;tt&gt;ThriftService&lt;/tt&gt; calls&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I started to suspect that the server was actually blocking waiting for bytes on the &lt;tt&gt;ThriftTest&lt;/tt&gt; connection and &lt;em&gt;flipped&lt;/em&gt; the order in which the &lt;tt&gt;ThriftTest&lt;/tt&gt; and &lt;tt&gt;SecondService&lt;/tt&gt; connection were created. When I flipped the order of connection creation, immediately &lt;tt&gt;SecondService&lt;/tt&gt; calls completed successfully and it was &lt;tt&gt;ThriftTest&lt;/tt&gt; calls that blocked. This was a real facepalm moment for me, because, looking at the way the CPP/PY3 servers were created, they were both &lt;em&gt;unthreaded&lt;/em&gt;, &lt;em&gt;blocking&lt;/em&gt; servers. So, of course, the &lt;em&gt;first&lt;/em&gt; connection the server received would be the one it would `recv()` on and service. A quick &lt;tt&gt;strace&lt;/tt&gt; proved this:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;bind(3, {sa_family=AF_INET6, sin6_port=htons(33047), inet_pton(AF_INET6, &quot;::&quot;, &amp;amp;sin6_addr), sin6_flowinfo=htonl(0), sin6_scope_id=0}, 28) = 0
listen(3, 128)                          = 0
accept4(3, {sa_family=AF_INET6, sin6_port=htons(44834), inet_pton(AF_INET6, &quot;::ffff:127.0.0.1&quot;, &amp;amp;sin6_addr), sin6_flowinfo=htonl(0), sin6_scope_id=0}, [28], SOCK_CLOEXEC) = 4
recvfrom(4, 0x1b699d0, 4096, 0, NULL, NULL) = ? ERESTARTSYS (To be restarted if SA_RESTART is set)
--- SIGWINCH {si_signo=SIGWINCH, si_code=SI_KERNEL} ---
recvfrom(4, 0x1b699d0, 4096, 0, NULL, NULL) = ? ERESTARTSYS (To be restarted if SA_RESTART is set)
--- SIGWINCH {si_signo=SIGWINCH, si_code=SI_KERNEL} ---
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Indeed, changing the CPP server to use a &lt;tt&gt;threaded&lt;/tt&gt; server type worked successfully with the Rust client:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;root@3cec70e4dd34:/thrift/src# /thrift/src/test/cpp/TestServer --protocol=multi --transport=buffered --port=45849 --server-type threaded
Starting &quot;threaded&quot; server (buffered/multi) listen on: 45849
secondTestString({&quot;thing&quot;})
testList({29384, 238, 32498})
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looking at the PY3 client it was immediately obvious how this wasn&apos;t an issue for it (or other clients). It&apos;s because, unlike the Rust client, the underlying connection is &lt;em&gt;shared&lt;/em&gt; between all Thrift client/protocol/transport instances (from &lt;tt&gt;test/py/TestClient.py&lt;/tt&gt;):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; self.transport = TTransport.TBufferedTransport(socket)
            if options.trans == &apos;framed&apos;:
                self.transport = TTransport.TFramedTransport(socket)
            elif options.trans == &apos;buffered&apos;:
                self.transport = TTransport.TBufferedTransport(socket)
            elif options.trans == &apos;&apos;:
                raise AssertionError(&apos;Unknown --transport option: %s&apos; % options.trans)
            if options.zlib:
                self.transport = TZlibTransport.TZlibTransport(self.transport, 9)
        self.transport.open()

        # IMPORTANT: &amp;lt;&amp;lt;&amp;lt;---- notice that self.transport is used for _both_ ThriftTest.Client and SecondService.Client

        protocol = self.get_protocol(self.transport)
        self.client = ThriftTest.Client(protocol)
        # for multiplexed services:
        protocol2 = self.get_protocol2(self.transport)
        self.client2 = SecondService.Client(protocol2) if protocol2 is not None else None
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;h3&gt;&lt;a name=&quot;Summary&quot;&gt;&lt;/a&gt;Summary&lt;/h3&gt;

&lt;p&gt;In summary, the problem occurs because:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The Rust cross-test client creates &lt;em&gt;two&lt;/em&gt; connections: one for the &lt;tt&gt;ThriftTest&lt;/tt&gt; service and a second for the &lt;tt&gt;SecondService&lt;/tt&gt; service&lt;/li&gt;
	&lt;li&gt;The Rust cross-test client is connecting to &lt;em&gt;unthreaded, nonblocking&lt;/em&gt; servers. With these servers, only the first {{accept()}}ed connection will be {{recv()}}ed from and processed&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The solution is to somehow modify the Rust clients to allow the underlying connections (not the transports) to be shared.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;In hindsight I should have quickly looked at how the Java/CPP cross-test servers were being invoked and I would have noticed immediately that the Java server was multithreaded and the CPP one was not.&lt;/em&gt;&lt;/p&gt;</comment>
                            <comment id="17292421" author="allengeorge" created="Sun, 28 Feb 2021 15:05:51 +0000"  >&lt;p&gt;Made change to share the underlying &lt;tt&gt;TCPStream&lt;/tt&gt; between clients. Post change:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Ran rs server cross tests. Only failures were &lt;tt&gt;dotnetstd&lt;/tt&gt;, which for some reason I can&apos;t build on the docker image.&lt;/li&gt;
	&lt;li&gt;Ran rs client cross tests. Only failures were &lt;tt&gt;dotnetstd&lt;/tt&gt;, &lt;tt&gt;cl&lt;/tt&gt; and &lt;tt&gt;py&lt;/tt&gt;. &lt;tt&gt;dotnetstd&lt;/tt&gt; doesn&apos;t build on the docker image. &lt;tt&gt;py&lt;/tt&gt; can&apos;t find a Thrift lib (unsure why), and &lt;tt&gt;cl&lt;/tt&gt; seems to be broken on &lt;em&gt;its&lt;/em&gt; side.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Looks like the fix works.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12651921">THRIFT-2013</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12947571" name="Screen Shot 2018-11-09 at 07.03.39.png" size="325930" author="allengeorge" created="Fri, 9 Nov 2018 12:03:49 +0000"/>
                            <attachment id="13021317" name="Screen Shot 2021-02-27 at 13.31.21.png" size="140094" author="allengeorge" created="Sat, 27 Feb 2021 18:32:03 +0000"/>
                            <attachment id="13021332" name="rs_client_tests_post_change.txt" size="15044" author="allengeorge" created="Sun, 28 Feb 2021 15:06:41 +0000"/>
                            <attachment id="13021331" name="rs_server_tests_post_change.txt" size="17673" author="allengeorge" created="Sun, 28 Feb 2021 15:03:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 37 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3oso7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>