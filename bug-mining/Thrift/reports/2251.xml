<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:34:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-5716] TMemoryBuffer resizing might shrink the buffer size due to uint32_t overflow</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-5716</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;In TMemoryBuffer::ensureCanWrite(), the calculation of &apos;required_buffer_size&apos; might overflow since it&apos;s the sum of two uint32_t values. The type of &apos;required_buffer_size&apos; should be uint64_t.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-cpp&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;void&lt;/span&gt;&lt;/span&gt; TMemoryBuffer::ensureCanWrite(uint32_t len) {
  &lt;span class=&quot;code-comment&quot;&gt;// Check available space
&lt;/span&gt;  uint32_t avail = available_write();
  if (len &amp;lt;= avail) {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
  }

  if (!owner_) {
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; TTransportException(&lt;span class=&quot;code-quote-red&quot;&gt;&quot;Insufficient space in external MemoryBuffer&quot;&lt;/span&gt;);
  }

  &lt;span class=&quot;code-comment&quot;&gt;// Grow the buffer as necessary.
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;const&lt;/span&gt; uint32_t current_used = bufferSize_ - avail;
  &lt;span class=&quot;code-keyword&quot;&gt;const&lt;/span&gt; uint32_t required_buffer_size = len + current_used; &lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;-- This could overflow
&lt;/span&gt;  if (required_buffer_size &amp;gt; maxBufferSize_) {
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; TTransportException(TTransportException::BAD_ARGS,
                              &lt;span class=&quot;code-quote-red&quot;&gt;&quot;Internal buffer size overflow when requesting a buffer of size &quot;&lt;/span&gt; + &lt;span class=&quot;code-keyword&quot;&gt;std&lt;/span&gt;::to_string(required_buffer_size));
  }

  &lt;span class=&quot;code-comment&quot;&gt;// Always grow to the next bigger power of two:
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;&lt;/span&gt; suggested_buffer_size = &lt;span class=&quot;code-keyword&quot;&gt;std&lt;/span&gt;::exp2(&lt;span class=&quot;code-keyword&quot;&gt;std&lt;/span&gt;::ceil(&lt;span class=&quot;code-keyword&quot;&gt;std&lt;/span&gt;::log2(required_buffer_size)));
  &lt;span class=&quot;code-comment&quot;&gt;// Unless the power of two exceeds maxBufferSize_:
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;const&lt;/span&gt; uint64_t new_size = &lt;span class=&quot;code-keyword&quot;&gt;static_cast&lt;/span&gt;&lt;span class=&quot;code-quote-red&quot;&gt;&amp;lt;uint64_t&amp;gt;&lt;/span&gt;((&lt;span class=&quot;code-keyword&quot;&gt;std&lt;/span&gt;::min)(suggested_buffer_size, &lt;span class=&quot;code-keyword&quot;&gt;static_cast&lt;/span&gt;&lt;span class=&quot;code-quote-red&quot;&gt;&amp;lt;&lt;span class=&quot;code-keyword&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;&lt;/span&gt;&amp;gt;&lt;/span&gt;(maxBufferSize_)));

  &lt;span class=&quot;code-comment&quot;&gt;// Allocate into a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; pointer so we don&apos;t bork ours&lt;span class=&quot;code-keyword&quot;&gt; if&lt;/span&gt; it fails.
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;auto&lt;/span&gt;* new_buffer = &lt;span class=&quot;code-keyword&quot;&gt;static_cast&lt;/span&gt;&lt;span class=&quot;code-quote-red&quot;&gt;&amp;lt;uint8_t*&amp;gt;&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;std&lt;/span&gt;::realloc(buffer_, &lt;span class=&quot;code-keyword&quot;&gt;static_cast&lt;/span&gt;&lt;span class=&quot;code-quote-red&quot;&gt;&amp;lt;&lt;span class=&quot;code-keyword&quot;&gt;std&lt;/span&gt;::size_t&amp;gt;&lt;/span&gt;(new_size)));
  if (new_buffer == &lt;span class=&quot;code-keyword&quot;&gt;nullptr&lt;/span&gt;) {
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;std&lt;/span&gt;::bad_alloc();
  }

  rBase_ = new_buffer + (rBase_ - buffer_);
  rBound_ = new_buffer + (rBound_ - buffer_);
  wBase_ = new_buffer + (wBase_ - buffer_);
  wBound_ = new_buffer + new_size;
  &lt;span class=&quot;code-comment&quot;&gt;// Note: with realloc() we &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;not&lt;/span&gt; need to free the previous buffer:
&lt;/span&gt;  buffer_ = new_buffer;
  bufferSize_ = &lt;span class=&quot;code-keyword&quot;&gt;static_cast&lt;/span&gt;&lt;span class=&quot;code-quote-red&quot;&gt;&amp;lt;uint32_t&amp;gt;&lt;/span&gt;(new_size);
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Overflow example:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;len=1066587646, current_used=4167372953, required_buffer_size=938993303&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The buffer is not expanded if &apos;required_buffer_size&apos; overflow. TMemoryBuffer::writeSlow() would finally writes to invalid address and crash the process:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-cpp&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;void&lt;/span&gt;&lt;/span&gt; TMemoryBuffer::writeSlow(&lt;span class=&quot;code-keyword&quot;&gt;const&lt;/span&gt; uint8_t* buf, uint32_t len) {
  ensureCanWrite(len);

  &lt;span class=&quot;code-comment&quot;&gt;// Copy into the buffer &lt;span class=&quot;code-keyword&quot;&gt;and&lt;/span&gt; increment wBase_.
&lt;/span&gt;  memcpy(wBase_, buf, len);  &lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;-- This could crash
&lt;/span&gt;  wBase_ += len;
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13540398">THRIFT-5716</key>
            <summary>TMemoryBuffer resizing might shrink the buffer size due to uint32_t overflow</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stigahuang">Quanlong Huang</assignee>
                                    <reporter username="stigahuang">Quanlong Huang</reporter>
                        <labels>
                    </labels>
                <created>Fri, 16 Jun 2023 12:50:32 +0000</created>
                <updated>Sat, 2 Sep 2023 11:53:37 +0000</updated>
                            <resolved>Thu, 22 Jun 2023 06:53:00 +0000</resolved>
                                    <version>0.14.0</version>
                    <version>0.15.0</version>
                    <version>0.14.1</version>
                    <version>0.14.2</version>
                    <version>0.16.0</version>
                    <version>0.17.0</version>
                    <version>0.18.0</version>
                    <version>0.18.1</version>
                                    <fixVersion>0.19.0</fixVersion>
                                    <component>C++ - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3600">1h</timespent>
                                    <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13540399">IMPALA-12223</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13287224">THRIFT-5114</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12966363">THRIFT-3821</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 21 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1im08:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>