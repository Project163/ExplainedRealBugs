<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:12:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-1908] Using php thrift_protocol accelerated transfer causes core dump</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-1908</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;Unfortunately, this is a bit of a Heisenbug among a complex code base and I&lt;br/&gt;
wasn&apos;t able to make a small reproducible example that actually crashes.&lt;br/&gt;
However, I might have been able to make a small example that shows possible&lt;br/&gt;
memory corruption that leads to the crash.&lt;/p&gt;

&lt;p&gt;The crash happens as my script terminates, so it does appear to be memory&lt;br/&gt;
corruption. Here is the gdb stack trace:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;(gdb) bt
#0  0x00007f6e7dad4ad9 in gc_zval_possible_root ()
   from /etc/httpd/modules/libphp5.so
#1  0x00007f6e7dac36db in zend_hash_destroy ()
   from /etc/httpd/modules/libphp5.so
#2  0x00007f6e7dab6a6f in _zval_dtor_func () from
/etc/httpd/modules/libphp5.so
#3  0x00007f6e7daab0da in _zval_ptr_dtor () from /etc/httpd/modules/libphp5.so
#4  0x00007f6e7dac36db in zend_hash_destroy ()
   from /etc/httpd/modules/libphp5.so
#5  0x00007f6e7dad60c9 in zend_object_std_dtor ()
   from /etc/httpd/modules/libphp5.so
#6  0x00007f6e7dad60e9 in zend_objects_free_object_storage ()
   from /etc/httpd/modules/libphp5.so
#7  0x00007f6e7dad95bc in zend_objects_store_free_object_storage ()
   from /etc/httpd/modules/libphp5.so
#8  0x00007f6e7daab4e4 in ?? () from /etc/httpd/modules/libphp5.so
#9  0x00007f6e7dab7792 in ?? () from /etc/httpd/modules/libphp5.so
#10 0x00007f6e7da658e5 in php_request_shutdown ()
   from /etc/httpd/modules/libphp5.so
#11 0x00007f6e7db3fbd7 in ?? () from /etc/httpd/modules/libphp5.so
#12 0x00007f6e88f9abb0 in ap_run_handler ()
#13 0x00007f6e88f9e46e in ap_invoke_handler ()
#14 0x00007f6e88fa9b30 in ap_process_request ()
#15 0x00007f6e88fa69a8 in ?? ()
#16 0x00007f6e88fa26b8 in ap_run_process_connection ()
#17 0x00007f6e88fae977 in ?? ()
#18 0x00007f6e88faec8a in ?? ()
#19 0x00007f6e88faefbb in ap_mpm_run ()
#20 0x00007f6e88f86900 in main ()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;One thing I noticed in tracking this down was that a php data structure&lt;br/&gt;
that I sent to the thrift call came back modified, which I don&apos;t think is&lt;br/&gt;
normal behavior. This is the behavior I was able to reproduce. This example&lt;br/&gt;
is loosely based on the tutorial.&lt;/p&gt;

&lt;p&gt;Thrift File (smallbug.thrift):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;namespace php tutorial

struct Date_Range {
    1: string low_date,
    2: string high_date
}

service Calculator {

   Date_Range List_Range( 1:string session_id,
        2:map&amp;lt;string,string&amp;gt; options),

}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Client File client.php:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;#!/usr/bin/env php
&amp;lt;?php

error_reporting(E_ALL);
define(&apos;THRIFT_ROOT&apos;, &apos;/home/tim/projects/inquisic/thrift-0.9.0/lib/php/lib&apos;);

require_once(THRIFT_ROOT . &apos;/Thrift/ClassLoader/ThriftClassLoader.php&apos;);
use Thrift\ClassLoader\ThriftClassLoader;

$GEN_DIR = &apos;/home/tim/public_html/smallbug/gen-php&apos;;

$loader = new ThriftClassLoader();
$loader-&amp;gt;registerNamespace(&apos;Thrift&apos;, THRIFT_ROOT);
$loader-&amp;gt;registerDefinition(&apos;shared&apos;, $GEN_DIR);
$loader-&amp;gt;registerDefinition(&apos;tutorial&apos;, $GEN_DIR);
$loader-&amp;gt;register();

use Thrift\Protocol\TBinaryProtocol;
use Thrift\Protocol\TBinaryProtocolAccelerated;
use Thrift\Transport\TSocket;
use Thrift\Transport\THttpClient;
use Thrift\Transport\TBufferedTransport;
use Thrift\Exception\TException;

try {
  $socket = new THttpClient(&apos;localhost&apos;, 8383, &apos;/~tim/smallbug/server.php&apos;);
  $transport = new TBufferedTransport($socket, 1024, 1024);
  $protocol = new TBinaryProtocolAccelerated($transport);

  $client = new \tutorial\CalculatorClient($protocol);
  $transport-&amp;gt;open();

  $options = array(
            &apos;type&apos; =&amp;gt; &apos;C&apos;,
            &apos;all&apos; =&amp;gt; 1,
            &apos;client&apos; =&amp;gt; 1 );

print &quot;before: options = &quot; . print_r($options, true);
  $client-&amp;gt;List_Range(&apos;session_id&apos;, $options);
print &quot;afterward: options = &quot; . print_r($options, true);

  $transport-&amp;gt;close();

} catch (TException $tx) {
  print &apos;TException: &apos;.$tx-&amp;gt;getMessage().&quot;\n&quot;;
}

?&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Server File server.php:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;lt;?php
namespace tutorial\php;

error_reporting(E_ALL);
define(&apos;THRIFT_ROOT&apos;, &apos;/home/tim/projects/inquisic/thrift-0.9.0/lib/php/lib&apos;);
require_once(THRIFT_ROOT . &apos;/Thrift/ClassLoader/ThriftClassLoader.php&apos;);
use Thrift\ClassLoader\ThriftClassLoader;
$GEN_DIR = &apos;/home/tim/public_html/smallbug/gen-php&apos;;

$loader = new ThriftClassLoader();
$loader-&amp;gt;registerNamespace(&apos;Thrift&apos;, THRIFT_ROOT);
$loader-&amp;gt;registerDefinition(&apos;tutorial&apos;, $GEN_DIR);
$loader-&amp;gt;register();

if (php_sapi_name() == &apos;cli&apos;) {
  ini_set(&quot;display_errors&quot;, &quot;stderr&quot;);
}

use Thrift\Protocol\TBinaryProtocol;
use Thrift\Protocol\TBinaryProtocolAccelerated;
use Thrift\Transport\TPhpStream;
use Thrift\Transport\TBufferedTransport;

class CalculatorHandler implements \tutorial\CalculatorIf {
  public function List_Range($session_id, $options) {
    error_log(&quot;List_Range()&quot;);

    $ret = new \tutorial\Date_Range;
    return $ret;
  }
};

header(&apos;Content-Type&apos;, &apos;application/x-thrift&apos;);
if (php_sapi_name() == &apos;cli&apos;) {
  echo &quot;\r\n&quot;;
}

$handler = new CalculatorHandler();
$processor = new \tutorial\CalculatorProcessor($handler);

$transport = new TBufferedTransport(new TPhpStream(TPhpStream::MODE_R | TPhpStream::MODE_W));
$protocol = new TBinaryProtocolAccelerated($transport, true, true);
error_log(&quot;protocol = &quot; . get_class($protocol));

$transport-&amp;gt;open();
$processor-&amp;gt;process($protocol, $protocol);
$transport-&amp;gt;close();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Output after running the test program:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;before: options = Array
(
    [type] =&amp;gt; C
    [all] =&amp;gt; 1
    [client] =&amp;gt; 1
)
afterward: options = Array
(
    [type] =&amp;gt; C
    [all] =&amp;gt;
    [client] =&amp;gt;
)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As you can see, the $options array was corrupted on return. This does not&lt;br/&gt;
happen when using the non-accelerated class.&lt;/p&gt;

&lt;p&gt;WARNING! If you run this example, please make sure the accelerated protocol&lt;br/&gt;
is really being used! Take a look at my other bug report; the normal PHP&lt;br/&gt;
Thrift library has a bug where the accelerated thrift_protocol module will&lt;br/&gt;
not be used. It&apos;s bug &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1903&quot; title=&quot;PHP namespaces cause binary protocols to not be used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1903&quot;&gt;&lt;del&gt;THRIFT-1903&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Thanks for your help.&lt;/p&gt;</description>
                <environment>&lt;p&gt;CentOS 6.4 64 bit&lt;/p&gt;</environment>
        <key id="12639715">THRIFT-1908</key>
            <summary>Using php thrift_protocol accelerated transfer causes core dump</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thobbs">Tom Hobbs</assignee>
                                    <reporter username="siliconengine">Tim Behrendsen</reporter>
                        <labels>
                            <label>accelerated</label>
                            <label>core</label>
                            <label>dump</label>
                            <label>php</label>
                            <label>thrift_protocol</label>
                    </labels>
                <created>Fri, 29 Mar 2013 00:05:28 +0000</created>
                <updated>Fri, 11 Apr 2014 06:08:28 +0000</updated>
                            <resolved>Fri, 11 Apr 2014 04:17:49 +0000</resolved>
                                    <version>0.9</version>
                                    <fixVersion>0.9.2</fixVersion>
                                    <component>PHP - Library</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13636863" author="thobbs" created="Fri, 19 Apr 2013 20:44:38 +0000"  >&lt;p&gt;I&apos;ve been digging into this, and &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1453&quot; title=&quot;Don&amp;#39;t change types of arguments when serializing with thrift php extension
&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1453&quot;&gt;&lt;del&gt;THRIFT-1453&lt;/del&gt;&lt;/a&gt; is definitely the cause. With the changes in &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1453&quot; title=&quot;Don&amp;#39;t change types of arguments when serializing with thrift php extension
&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1453&quot;&gt;&lt;del&gt;THRIFT-1453&lt;/del&gt;&lt;/a&gt;, I can consistently reproduce, and with the changes reversed, there are no problems. (I&apos;m also working with the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1903&quot; title=&quot;PHP namespaces cause binary protocols to not be used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1903&quot;&gt;&lt;del&gt;THRIFT-1903&lt;/del&gt;&lt;/a&gt; applied so that the extension will be used.)&lt;/p&gt;</comment>
                            <comment id="13935993" author="siliconengine" created="Sat, 15 Mar 2014 05:01:14 +0000"  >&lt;p&gt;Update: I just tried the accelerated protocol with thrift 0.9.1, still on Centos 6.4. I get the same symptom where Apache core dumps. The stack traceback looks pretty much the same as my original report.&lt;/p&gt;

&lt;p&gt;When I try my small test program, it also still gives me the possibly corrupted $options array.&lt;/p&gt;

&lt;p&gt;However! I just tried something different. I did a loop of the client call, and that caused a core dump:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; ($i = 0; $i &amp;lt; 20; ++$i) {
    $client-&amp;gt;List_Range(&lt;span class=&quot;code-quote&quot;&gt;&apos;session_id&apos;&lt;/span&gt;, $options);
    print &lt;span class=&quot;code-quote&quot;&gt;&quot;afterward: options = &quot;&lt;/span&gt; . print_r($options, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This produced:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ php client.php
before: options = Array
(
    [type] =&amp;gt; C
    [all] =&amp;gt; 1
    [client] =&amp;gt; 1
)
afterward: options = Array
(
    [type] =&amp;gt; C
    [all] =&amp;gt;
    [client] =&amp;gt;
)
afterward: options = Array
(
    [type] =&amp;gt; C
    [all] =&amp;gt; 11
    [client] =&amp;gt; 11
)
Segmentation fault (core dumped)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Tyler Hobbs posted on this issue about 11 months ago; did anything come of that?&lt;/p&gt;

&lt;p&gt;If anyone has any workarounds (or a fix!), it would be greatly appreciated. The binary protocol is much faster, but I&apos;m stuck using the php-native protocol. Or is there another way people do the binary protocol? I would think others must be running into this problem.&lt;/p&gt;

&lt;p&gt;Thanks in advance for any help!&lt;/p&gt;</comment>
                            <comment id="13939653" author="thobbs" created="Tue, 18 Mar 2014 19:01:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=siliconengine&quot; class=&quot;user-hover&quot; rel=&quot;siliconengine&quot;&gt;siliconengine&lt;/a&gt; as a workaround, I suggest reversing the changes in &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1453&quot; title=&quot;Don&amp;#39;t change types of arguments when serializing with thrift php extension
&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1453&quot;&gt;&lt;del&gt;THRIFT-1453&lt;/del&gt;&lt;/a&gt;.  I&apos;ve been shipping a php driver for Cassandra with that patch reversed for a year now without any issues.  Of course, I&apos;d also like to see that reversal committed to make it a permanent fix.&lt;/p&gt;</comment>
                            <comment id="13965748" author="thobbs" created="Thu, 10 Apr 2014 19:31:44 +0000"  >&lt;p&gt;The attached thrift-1908-trunk.txt patch reverts the patch from &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1453&quot; title=&quot;Don&amp;#39;t change types of arguments when serializing with thrift php extension
&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1453&quot;&gt;&lt;del&gt;THRIFT-1453&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13966214" author="jfarrell" created="Fri, 11 Apr 2014 04:17:49 +0000"  >&lt;p&gt;committed to trunk, thanks for the patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13966269" author="hudson" created="Fri, 11 Apr 2014 06:08:28 +0000"  >&lt;p&gt;SUCCESS: Integrated in Thrift #1127 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/1127/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/1127/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1908&quot; title=&quot;Using php thrift_protocol accelerated transfer causes core dump&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1908&quot;&gt;&lt;del&gt;THRIFT-1908&lt;/del&gt;&lt;/a&gt;: Using php thrift_protocol accelerated transfer causes core dump (jfarrell: rev 26c68ea149e33f77b1e3cbfba9921c8ccdb6a30b)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;lib/php/src/ext/thrift_protocol/php_thrift_protocol.cpp&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12639636" name="thrift-1908-trunk.txt" size="6299" author="thobbs" created="Thu, 10 Apr 2014 19:31:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>320184</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 32 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1j8u7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>320525</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>