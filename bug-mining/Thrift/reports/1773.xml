<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:27:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-2642] Recursive structs don&apos;t work in python</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-2642</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;Recursive structs in 0.9.2 work fine in c++ &amp;amp; c#, but not in python, because generated code trying to use objects which not constructed yet.&lt;/p&gt;

&lt;p&gt;Struct:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;struct Recursive {
1: list&amp;lt;Recursive&amp;gt; Children
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Python code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Recursive:
  thrift_spec = (
    None, # 0
    (1, TType.LIST, &lt;span class=&quot;code-quote&quot;&gt;&apos;Children&apos;&lt;/span&gt;, (TType.STRUCT,(Recursive, Recursive.thrift_spec)), None, ), # 1
  )
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Error message:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Traceback (most recent call last):
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;ttypes.py&quot;&lt;/span&gt;, line 20, in &amp;lt;module&amp;gt;
    &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Recursive:
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;ttypes.py&quot;&lt;/span&gt;, line 28, in Recursive
    (1, TType.LIST, &lt;span class=&quot;code-quote&quot;&gt;&apos;Children&apos;&lt;/span&gt;, (TType.STRUCT,(Recursive, Recursive.thrift_spec)), None, ), # 1
NameError: name &lt;span class=&quot;code-quote&quot;&gt;&apos;Recursive&apos;&lt;/span&gt; is not defined
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12730761">THRIFT-2642</key>
            <summary>Recursive structs don&apos;t work in python</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="econner724">Eric Conner</assignee>
                                    <reporter username="isanych">Igor Kostenko</reporter>
                        <labels>
                    </labels>
                <created>Wed, 30 Jul 2014 10:58:59 +0000</created>
                <updated>Fri, 24 Aug 2018 10:08:38 +0000</updated>
                            <resolved>Thu, 6 Jul 2017 21:00:53 +0000</resolved>
                                    <version>0.9.2</version>
                                    <fixVersion>0.11.0</fixVersion>
                                    <component>Python - Compiler</component>
                    <component>Python - Library</component>
                        <due></due>
                            <votes>6</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="14539571" author="juliengreard" created="Tue, 12 May 2015 09:21:57 +0000"  >&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;Is there a work around for this bug ? Do you know when it&apos;s going to be fixed ?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="14539620" author="juliengreard" created="Tue, 12 May 2015 10:13:33 +0000"  >&lt;p&gt;I did my own work around:&lt;br/&gt;
in the example above, I replaced the code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Recursive:
    thrift_spec = (
    None, # 0
    (1, TType.LIST, &lt;span class=&quot;code-quote&quot;&gt;&apos;Children&apos;&lt;/span&gt;, (TType.STRUCT,(Recursive, Recursive.thrift_spec)), None, ), # 1
    )
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;by&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Recursive:
    pass


Recursive.thrift_spec = None
depth = 0
max_depth = 50
&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (depth &amp;lt; max_depth):
    depth += 1
    Recursive. thrift_spec = (
    None, # 0
    (1, TType.LIST, &lt;span class=&quot;code-quote&quot;&gt;&apos;Children&apos;&lt;/span&gt;, (TType.STRUCT,(Recursive, Recursive.thrift_spec)), None, ), # 1
    )
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Which seems to do the job... It&apos;s ugly because I have to edit the generated code afterward, but I didn&apos;t want to touch at the code generator in Thrift code... what do you think ?&lt;/p&gt;</comment>
                            <comment id="14540703" author="jensg" created="Tue, 12 May 2015 20:52:36 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;there is a &quot;help&quot; icon which lists all the possible formattings. &lt;/p&gt;

&lt;p&gt;Any chance that you could create a patch out of your findings and/or workaround for the Python generator? We accept patch files and pull requests, see &lt;a href=&quot;http://thrift.apache.org/docs/HowToContribute&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; for details.&lt;/p&gt;</comment>
                            <comment id="14541728" author="juliengreard" created="Wed, 13 May 2015 11:07:29 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;Thanks for the indication about the formatting,&lt;/p&gt;

&lt;p&gt;For the patch, I&apos;ll test my solution for a while and I&apos;ll look at the python generator. But I&apos;m not sure I&apos;ll be able to make something clean. &lt;/p&gt;
</comment>
                            <comment id="14542749" author="jensg" created="Wed, 13 May 2015 21:19:10 +0000"  >&lt;p&gt;You will be, just fire away &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;

&lt;p&gt;Just remember, that you may ask on the mailing lists and/or freenode at any time if you get stuck or have questions. Finally, the people who are going to review your patch/PR will tell how you did, and help you over the hurdles (if there are any at all). &lt;/p&gt;
</comment>
                            <comment id="14635029" author="juliengreard" created="Tue, 21 Jul 2015 12:23:50 +0000"  >&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;Do you know if this bug is planned to be corrected soon ? I haven&apos;t been able to do any progress on a patch yet, and I probably won&apos;t have the time to look at it in the next months...&lt;/p&gt;

&lt;p&gt;I just need to know if I have to wait for a correction or if I have to get rid of the recursivity&lt;/p&gt;</comment>
                            <comment id="14635689" author="jensg" created="Tue, 21 Jul 2015 19:38:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=juliengreard&quot; class=&quot;user-hover&quot; rel=&quot;juliengreard&quot;&gt;juliengreard&lt;/a&gt; What do you have so far? &lt;/p&gt;

&lt;p&gt;Any other Pythonians around that could help and/or assist Julien?&lt;/p&gt;</comment>
                            <comment id="14635740" author="juliengreard" created="Tue, 21 Jul 2015 20:13:51 +0000"  >&lt;p&gt;Right now, I have a workaround, I have to edit the generated files by hand. It&apos;s working, but each time I update my objects data structure or create new ones, I have to do it. I just need to know if this bugs is major enought according to Thrift community&apos;s point of view to be fixed soon for my ^next developements: I can use recursive data struct if this bug is fixed soon, otherwise, I&apos;ll find another pattern, no worries ^^&lt;/p&gt;</comment>
                            <comment id="14970521" author="econner724" created="Fri, 23 Oct 2015 06:21:01 +0000"  >&lt;p&gt;The problem is in thrift_spec which is used only by fastbinary.  Right now the only option seems to be to manually modify the code as Julien has suggested.&lt;/p&gt;

&lt;p&gt;As far as fixing this for fastbinary it gets tricky.  &lt;br/&gt;
1) The thrift_spec either needs to move from the class level into a method or thrift_spec should be added to the class after it is defined.&lt;/p&gt;

&lt;p&gt;2) As written the thrift_spec tuple tries to be self-referential which is not really possible in python unless you create lots of inner copies of the tuple.  It&apos;d work in C with a pointer back to the object since fastbinary is really just reading the tuple to see what fields to expect.  It may be possible to modify fastbinary to handle this case specifically, but the generated python would also need to change as well and its not clear to me how to do that.  Maybe just using some sentinel value that fastbinary looks for which means &quot;ref to myself&quot;.&lt;/p&gt;</comment>
                            <comment id="15387504" author="mytalala" created="Thu, 21 Jul 2016 10:32:18 +0000"  >&lt;p&gt;Hello from 2016.&lt;br/&gt;
We still have this problem.&lt;/p&gt;

&lt;p&gt;I am using Julien&apos;s solution, but this kinda weird.&lt;br/&gt;
For full automation it required bash script, that&apos;s change this errors.&lt;br/&gt;
Maybe someone figure out how we can do it better?&lt;/p&gt;

&lt;p&gt;EDIT:&lt;br/&gt;
Do we need &quot;Recursive.thrift_spec&quot;?&lt;br/&gt;
This kinda werid. I remove this on my project (and also fix following code for checking is None). &lt;/p&gt;</comment>
                            <comment id="15856364" author="lyschoening" created="Tue, 7 Feb 2017 17:29:06 +0000"  >&lt;p&gt;I also just came across this issue. Fbthrift has a straightforward enough fix for this. I don&apos;t fully understand the IP situation with fbthrift, so maybe using their approach is out of the question.&lt;/p&gt;

&lt;p&gt;In either case, there are two parts to this problem: &lt;br/&gt;
(1) to solve recursive and cyclic dependencies between structs themselves, (2) solve cycles of &lt;tt&gt;&amp;lt;Struct&amp;gt;.thrift_spec&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The first part is adequately solved by setting &lt;tt&gt;&amp;lt;Struct&amp;gt;.thrift_spec&lt;/tt&gt; at the bottom of the file.&lt;/p&gt;

 &lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;A(object):
    thrift_spec = None

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;B(object):
    thrift_spec = None

A.thrift_spec = # (...)
B.thrift_spec = # (...)

 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, since the thrift_spec tuple has the format &lt;tt&gt;(&amp;lt;Struct&amp;gt;, &amp;lt;Struct&amp;gt;.thrift_spec)&lt;/tt&gt;, this won&apos;t work. There are three approaches now. The fbthrift approach is to change &lt;tt&gt;(&amp;lt;Struct&amp;gt;, &amp;lt;Struct&amp;gt;.thrift_spec)&lt;/tt&gt; to a list &lt;tt&gt;[&amp;lt;Struct&amp;gt;, None]&lt;/tt&gt; and fill in the missing bit with a function call.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/facebook/fbthrift/blob/3ef868c969464e935b39e336807af1486b2739c3/thrift/lib/py/util/Recursive.py&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/facebook/fbthrift/blob/3ef868c969464e935b39e336807af1486b2739c3/thrift/lib/py/util/Recursive.py&lt;/a&gt;&lt;/p&gt;

&lt;p&gt; A simpler alternative is to make &lt;tt&gt;thrift_spec&lt;/tt&gt; itself a list and update the code like so:&lt;/p&gt;

 &lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Cyclic(object):
    thrift_spec = []


Cyclic.thrift_spec += # [...]

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I don&apos;t know what the performance implications are. Iterating over a tuple should be slightly faster than iterating over a list, however the fbthrift solution also requires accessing lists. Both solutions make &lt;tt&gt;thrift_spec&lt;/tt&gt; mutable.&lt;/p&gt;

&lt;p&gt;The third alternative is to change  &lt;tt&gt;(&amp;lt;Struct&amp;gt;, &amp;lt;Struct&amp;gt;.thrift_spec)&lt;/tt&gt;  to just &lt;tt&gt;&amp;lt;Struct&amp;gt;&lt;/tt&gt;. As far as I can see &lt;tt&gt;thrift_spec&lt;/tt&gt; is only  used by &lt;tt&gt;TProtocol.readStruct()&lt;/tt&gt;. So the signature of &lt;tt&gt;TProtocol.readStruct(self, obj, thrift_spec, is_immutable=False)&lt;/tt&gt; should be changed to &lt;tt&gt;TProtocol.readStruct(self, obj, is_immutable=False)&lt;/tt&gt; and the access to &lt;tt&gt;thrift_spec&lt;/tt&gt; should be changed to &lt;tt&gt;obj.thrift_spec&lt;/tt&gt;. As far as I can see, &lt;tt&gt;readStruct()&lt;/tt&gt; is only called from &lt;tt&gt;TBase.read()&lt;/tt&gt; and &lt;tt&gt;TFrozenBase.read()&lt;/tt&gt;, so this would be a simple change. The method is also undocumented. But I don&apos;t know how you feel about signature changes. &lt;/p&gt;</comment>
                            <comment id="16005819" author="allengeorge" created="Thu, 11 May 2017 02:54:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jensg&quot; class=&quot;user-hover&quot; rel=&quot;jensg&quot;&gt;jensg&lt;/a&gt; Can I implement the approach discussed above?&lt;/p&gt;</comment>
                            <comment id="16008223" author="jensg" created="Fri, 12 May 2017 14:37:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=allengeorge&quot; class=&quot;user-hover&quot; rel=&quot;allengeorge&quot;&gt;allengeorge&lt;/a&gt;, &lt;/p&gt;

&lt;p&gt;I am fine with it as long as &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the proposed changes are local to Python stuff (.i.e. there are no changes necessary that affect other languages or question the infrastructure in general)&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lyschoening&quot; class=&quot;user-hover&quot; rel=&quot;lyschoening&quot;&gt;lyschoening&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=myTalala&quot; class=&quot;user-hover&quot; rel=&quot;myTalala&quot;&gt;myTalala&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=econner724&quot; class=&quot;user-hover&quot; rel=&quot;econner724&quot;&gt;econner724&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=isanych&quot; class=&quot;user-hover&quot; rel=&quot;isanych&quot;&gt;isanych&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=juliengreard&quot; class=&quot;user-hover&quot; rel=&quot;juliengreard&quot;&gt;juliengreard&lt;/a&gt; agree with your pull request&lt;/li&gt;
	&lt;li&gt;all builds are fine&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I can surely do a general review, but my Python expertise is limited, so I would not rely on my own opinion alone. Especially not with such a topic. But if you 5 guys come to someething you are happy with as a group, we should have enough backing to get it merged.  At the end, this is open source.&lt;/p&gt;</comment>
                            <comment id="16008272" author="juliengreard" created="Fri, 12 May 2017 15:18:40 +0000"  >&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;I agree with Jens and I&apos;m available for giving my opinion even if I don&apos;t&lt;br/&gt;
know much about thrift architecture.&lt;/p&gt;

&lt;p&gt;Wish you luck !&lt;/p&gt;

&lt;p&gt;Julien&lt;/p&gt;

</comment>
                            <comment id="16008348" author="mytalala" created="Fri, 12 May 2017 16:36:57 +0000"  >&lt;p&gt;Actualy my team switched to java, but if you need help you can contact with me.&lt;br/&gt;
Dont think, that i totaly forget python for 6mo&lt;/p&gt;</comment>
                            <comment id="16056824" author="econner724" created="Wed, 21 Jun 2017 01:55:43 +0000"  >&lt;p&gt;Hi everyone,&lt;/p&gt;

&lt;p&gt;I finally had some time to take a stab at fixing this.  &lt;/p&gt;

&lt;p&gt;I followed the fbthrift approach.  At a high level, the change:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Moves all thrift_spec definitions to the end of the ttypes file. Or, in the case of a service, after the service definition.&lt;/li&gt;
	&lt;li&gt;Changes the initial declaration of the spec for a TStruct to &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;lt;Struct&amp;gt;, None&amp;#93;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;Uses a method call ``fix_spec`` to fill in the spec to &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;lt;Struct&amp;gt;, &amp;lt;Struct&amp;gt;.thrift_spec&amp;#93;&lt;/span&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;b&gt;Edit&lt;/b&gt;:&lt;br/&gt;
Originally I had tried to keep spec as a tuple, but as far as I can tell it has to be a list as it needs to be a reference type for recursive structures to work.  I added tests to SerializationTest.py. Note that co-recursive structures do not work. There is an infinite loop when they are serialized. fbthrift also suffers from this problem.&lt;/p&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lyschoening&quot; class=&quot;user-hover&quot; rel=&quot;lyschoening&quot;&gt;lyschoening&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=myTalala&quot; class=&quot;user-hover&quot; rel=&quot;myTalala&quot;&gt;myTalala&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=isanych&quot; class=&quot;user-hover&quot; rel=&quot;isanych&quot;&gt;isanych&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=juliengreard&quot; class=&quot;user-hover&quot; rel=&quot;juliengreard&quot;&gt;juliengreard&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jensg&quot; class=&quot;user-hover&quot; rel=&quot;jensg&quot;&gt;jensg&lt;/a&gt;&lt;/p&gt;


</comment>
                            <comment id="16056825" author="githubbot" created="Wed, 21 Jun 2017 01:55:54 +0000"  >&lt;p&gt;GitHub user econner opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1293&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1293&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2642&quot; title=&quot;Recursive structs don&amp;#39;t work in python&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2642&quot;&gt;&lt;del&gt;THRIFT-2642&lt;/del&gt;&lt;/a&gt; Recursive structs don&apos;t work in python&lt;/p&gt;

&lt;p&gt;    See &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2642&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/THRIFT-2642&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/econner/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/econner/thrift&lt;/a&gt; master&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1293.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1293.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1293&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit d62798144b68353c8def2e80388b9ae5e368e9fb&lt;br/&gt;
Author: Eric Conner &amp;lt;eric@pinterest.com&amp;gt;&lt;br/&gt;
Date:   2017-06-21T01:34:12Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2642&quot; title=&quot;Recursive structs don&amp;#39;t work in python&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2642&quot;&gt;&lt;del&gt;THRIFT-2642&lt;/del&gt;&lt;/a&gt; Recursive structs don&apos;t work in python&lt;/p&gt;

&lt;p&gt;    See &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2642&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/THRIFT-2642&lt;/a&gt;.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16057106" author="juliengreard" created="Wed, 21 Jun 2017 07:46:00 +0000"  >&lt;p&gt;Hi&lt;/p&gt;

&lt;p&gt;Thanks for the work, I&apos;ll have a look this week. I don&apos;t know yet how to&lt;br/&gt;
review code on JIRA but I&apos;m sure it&apos;s well documented.&lt;/p&gt;


</comment>
                            <comment id="16057819" author="githubbot" created="Wed, 21 Jun 2017 16:45:22 +0000"  >&lt;p&gt;Github user econner commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1293&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1293&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    As written this will not work.  The spec for a Struct needs to be a reference type such as a list for recursion to work correctly so there is more work to be done here.&lt;/p&gt;</comment>
                            <comment id="16057820" author="githubbot" created="Wed, 21 Jun 2017 16:45:23 +0000"  >&lt;p&gt;Github user econner closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1293&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1293&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16057851" author="githubbot" created="Wed, 21 Jun 2017 17:07:13 +0000"  >&lt;p&gt;GitHub user econner reopened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1293&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1293&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2642&quot; title=&quot;Recursive structs don&amp;#39;t work in python&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2642&quot;&gt;&lt;del&gt;THRIFT-2642&lt;/del&gt;&lt;/a&gt; Recursive structs don&apos;t work in python&lt;/p&gt;

&lt;p&gt;    See &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2642&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/THRIFT-2642&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/econner/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/econner/thrift&lt;/a&gt; master&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1293.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1293.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1293&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit d62798144b68353c8def2e80388b9ae5e368e9fb&lt;br/&gt;
Author: Eric Conner &amp;lt;eric@pinterest.com&amp;gt;&lt;br/&gt;
Date:   2017-06-21T01:34:12Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2642&quot; title=&quot;Recursive structs don&amp;#39;t work in python&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2642&quot;&gt;&lt;del&gt;THRIFT-2642&lt;/del&gt;&lt;/a&gt; Recursive structs don&apos;t work in python&lt;/p&gt;

&lt;p&gt;    See &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2642&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/THRIFT-2642&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;commit b178f8109e6a0f94005ed65db506e2b14ac41a9d&lt;br/&gt;
Author: Eric Conner &amp;lt;eric@pinterest.com&amp;gt;&lt;br/&gt;
Date:   2017-06-21T14:52:44Z&lt;/p&gt;

&lt;p&gt;    Fix build issues.&lt;/p&gt;

&lt;p&gt;commit 7eb8e319385185904161185602f902bee0ff4544&lt;br/&gt;
Author: Eric Conner &amp;lt;eric@pinterest.com&amp;gt;&lt;br/&gt;
Date:   2017-06-21T17:00:57Z&lt;/p&gt;

&lt;p&gt;    Convert spec for TStruct to list in python.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16057856" author="githubbot" created="Wed, 21 Jun 2017 17:10:38 +0000"  >&lt;p&gt;Github user econner commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1293&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1293&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Ok, I&apos;ve updated the PR to use a list (reference type) instead of a tuple.  I also added some serialization tests for recursive structures. Hopefully everything works now.&lt;/p&gt;</comment>
                            <comment id="16074774" author="econner724" created="Wed, 5 Jul 2017 13:47:20 +0000"  >&lt;p&gt;Hi everyone,&lt;br/&gt;
Just curious if there&apos;s still any desire to get this working.&lt;/p&gt;

&lt;p&gt;Here&apos;s the PR: &lt;a href=&quot;https://github.com/apache/thrift/pull/1293&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1293&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16074792" author="juliengreard" created="Wed, 5 Jul 2017 13:56:00 +0000"  >&lt;p&gt; Hi,&lt;/p&gt;

&lt;p&gt;My company uses thrift &amp;amp; python. We use a workaround for the recursive&lt;br/&gt;
structures and it&apos;s kind of works but I think that&apos;s thrift should be&lt;br/&gt;
working the same no matter the language (that&apos;s the point of thrift I&lt;br/&gt;
believe).&lt;/p&gt;

&lt;p&gt;In my opinion, there are 3 options:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;disable recursive structures for everyone&lt;/li&gt;
	&lt;li&gt;make it work for Python&lt;/li&gt;
	&lt;li&gt;live with it as we do for now, but a bug like that shows a bad image and&lt;br/&gt;
will possibly make someone who uses thrift switch to another language,&lt;br/&gt;
isn&apos;t it?&lt;/li&gt;
&lt;/ul&gt;




</comment>
                            <comment id="16075330" author="jensg" created="Wed, 5 Jul 2017 20:14:43 +0000"  >&lt;p&gt;&amp;gt; I think that&apos;s thrift should be  working the same no matter the language (that&apos;s the point of thrift I believe).&lt;/p&gt;

&lt;p&gt;Yep.&lt;/p&gt;

&lt;p&gt;&amp;gt; disable recursive structures for everyone&lt;/p&gt;

&lt;p&gt;Ehm, no. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;A bit of history and background may help: This particular feature has been added based on the impl in fbthrift, and it is one of the additions with the most impact on Thrift in my opinion. But since Thrift&apos;s target language base is much larger compare to fbthrift, we unfortunately do not yet have suitable support in some of them, e.g. Python. &lt;/p&gt;

&lt;p&gt;There are similar other features that do also not have broad language support, for several reasons. For example, the THeader stuff is currently only available for C++. Nevertheless, the fact that not all &amp;gt; 20 languages do offer it &lt;b&gt;today&lt;/b&gt; does not imply that we will throw it out. It is a cool feature, and whoever needs it for his language of choice will contribute a patch sooner or later. That&apos;s how open source works. It doesn&apos;t have to be perfect from the beginning (which is especially a stretching goal if there is a target language base as large as Thrift&apos;s). &lt;/p&gt;

&lt;p&gt;So my favourite would be:&lt;/p&gt;

&lt;p&gt;&amp;gt; make it work for Python&lt;/p&gt;

&lt;p&gt;However I would be a bad implementor, because I very rarely use Python myself and I probably only make it worse. But what if you two guys take a stab on it together? Could that work? What do you think? Anyone else reading this who wants to try his luck?&lt;/p&gt;

</comment>
                            <comment id="16075348" author="econner724" created="Wed, 5 Jul 2017 20:24:17 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jensg&quot; class=&quot;user-hover&quot; rel=&quot;jensg&quot;&gt;jensg&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thanks for the follow up.  This pull request &lt;a href=&quot;https://github.com/apache/thrift/pull/1293&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1293&lt;/a&gt; is my attempt at a fix (which I linked above).  Can someone review it?&lt;/p&gt;

&lt;p&gt;I also outlined the approach above.  Copied here:&lt;/p&gt;

&lt;p&gt;I followed the fbthrift approach. At a high level, the change&lt;br/&gt;
Moves all thrift_spec definitions to the end of the ttypes file. Or, in the case of a service, after the service definition.&lt;br/&gt;
Changes the initial declaration of the spec for a TStruct to &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;lt;Struct&amp;gt;, None&amp;#93;&lt;/span&gt;&lt;br/&gt;
Uses a method call ``fix_spec`` to fill in the spec to &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;lt;Struct&amp;gt;, &amp;lt;Struct&amp;gt;.thrift_spec&amp;#93;&lt;/span&gt;&lt;br/&gt;
(Basically exactly what fbthrift does)&lt;/p&gt;

&lt;p&gt;I should note that this does not solve the case of co-recursive structures, a problem that fbthrift also suffers from.  Co-recursive structs can be created but they cannot be serialized or deserialized (leads to infinite loop).&lt;/p&gt;</comment>
                            <comment id="16075360" author="jensg" created="Wed, 5 Jul 2017 20:27:56 +0000"  >&lt;p&gt;&amp;gt; Thanks for the follow up. This pull request &lt;a href=&quot;https://github.com/apache/thrift/pull/1293&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1293&lt;/a&gt; is my attempt at a fix (which I linked above). Can someone review it?&lt;/p&gt;

&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=isanych&quot; class=&quot;user-hover&quot; rel=&quot;isanych&quot;&gt;isanych&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=juliengreard&quot; class=&quot;user-hover&quot; rel=&quot;juliengreard&quot;&gt;juliengreard&lt;/a&gt; could you help out?&lt;/p&gt;</comment>
                            <comment id="16075370" author="githubbot" created="Wed, 5 Jul 2017 20:32:24 +0000"  >&lt;p&gt;Github user Jens-G commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1293#discussion_r125749743&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1293#discussion_r125749743&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/py/src/TRecursive.py &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,63 @@&lt;br/&gt;
    +# MODIFIED June 20, 2017, Eric Conner&lt;br/&gt;
    +#&lt;br/&gt;
    +#&lt;br/&gt;
    +# Original source copyright 2014-present Facebook, Inc.&lt;br/&gt;
    +#&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Where does line 1 to 5 come from? That&apos;s not part of the standard ASF license header.&lt;/p&gt;</comment>
                            <comment id="16075394" author="githubbot" created="Wed, 5 Jul 2017 20:41:14 +0000"  >&lt;p&gt;Github user econner commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1293#discussion_r125751862&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1293#discussion_r125751862&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/py/src/TRecursive.py &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,63 @@&lt;br/&gt;
    +# MODIFIED June 20, 2017, Eric Conner&lt;br/&gt;
    +#&lt;br/&gt;
    +#&lt;br/&gt;
    +# Original source copyright 2014-present Facebook, Inc.&lt;br/&gt;
    +#&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Yea, I&apos;m not very experienced with the whole issue of licensing.  I mainly put these lines because of the fbthrift license and I used this file more or less verbatim from fbthrift.  (&lt;a href=&quot;https://github.com/facebook/fbthrift/blob/master/LICENSE#L97&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/facebook/fbthrift/blob/master/LICENSE#L97&lt;/a&gt;) (&lt;a href=&quot;https://github.com/facebook/fbthrift/blob/master/thrift/lib/py/util/Recursive.py&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/facebook/fbthrift/blob/master/thrift/lib/py/util/Recursive.py&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;    &amp;gt;       (b) You must cause any modified files to carry prominent notices&lt;br/&gt;
              stating that You changed the files; and&lt;/p&gt;

&lt;p&gt;          (c) You must retain, in the Source form of any Derivative Works&lt;br/&gt;
              that You distribute, all copyright, patent, trademark, and&lt;br/&gt;
              attribution notices from the Source form of the Work,&lt;br/&gt;
              excluding those notices that do not pertain to any part of&lt;br/&gt;
              the Derivative Works; and&lt;/p&gt;

&lt;p&gt;    But perhaps it is fine to use verbatim since fbthrift is itself a branch of thrift?  Not really sure what the protocol here is...&lt;/p&gt;</comment>
                            <comment id="16075429" author="juliengreard" created="Wed, 5 Jul 2017 21:03:00 +0000"  >&lt;p&gt;Hi,&lt;br/&gt;
I&apos;ll try a review, but it&apos;s my first one on github and I don&apos;t know thrift&lt;br/&gt;
source code well, so forgive me if I&apos;m wrong &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

</comment>
                            <comment id="16075452" author="juliengreard" created="Wed, 5 Jul 2017 21:25:00 +0000"  >&lt;p&gt;Ok it&apos;s done, do you see my comments/reviews?&lt;/p&gt;

</comment>
                            <comment id="16075519" author="econner724" created="Wed, 5 Jul 2017 22:14:02 +0000"  >&lt;p&gt;Hi Julien,&lt;br/&gt;
I cannot see your comments.  Did you submit them via github?  Or somewhere else?&lt;br/&gt;
Thank you.&lt;/p&gt;</comment>
                            <comment id="16075527" author="githubbot" created="Wed, 5 Jul 2017 22:23:28 +0000"  >&lt;p&gt;Github user juliengreard commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1293#discussion_r125759386&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1293#discussion_r125759386&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/py/src/ext/types.cpp &amp;#8212;&lt;br/&gt;
    @@ -20,6 +20,8 @@&lt;br/&gt;
     #include &quot;ext/types.h&quot;&lt;br/&gt;
     #include &quot;ext/protocol.h&quot;&lt;/p&gt;

&lt;p&gt;    +#include &amp;lt;iostream&amp;gt;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I usually include built-in lib first&lt;/p&gt;</comment>
                            <comment id="16075528" author="githubbot" created="Wed, 5 Jul 2017 22:23:28 +0000"  >&lt;p&gt;Github user juliengreard commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1293#discussion_r125761010&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1293#discussion_r125761010&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: test/py/SerializationTest.py &amp;#8212;&lt;br/&gt;
    @@ -285,6 +290,67 @@ def testIntegerLimits(self):&lt;br/&gt;
             for value in bad_values:&lt;br/&gt;
                 self.assertRaises(Exception, self._serialize, value)&lt;/p&gt;

&lt;p&gt;    +    def testRecTree(self):&lt;br/&gt;
    +        &quot;&quot;&quot;Ensure recursive tree node can be created.&quot;&quot;&quot;&lt;br/&gt;
    +        children = []&lt;br/&gt;
    +        for idx in range(1, 5):&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    where do the &quot;5&quot; comes from ? Is it a limit for the implementation (you can&apos;t have recursive struct with more than 5 recursions? if so, it should be highlighted (maybe it is already, but I didn&apos;t see it). What happens if I have a struct with more than 5 recursions in it (i.e. myObject.leaf.leaf.leaf.leaf.leaf.leaf.leaf.leaf is not None)?&lt;/p&gt;</comment>
                            <comment id="16075529" author="githubbot" created="Wed, 5 Jul 2017 22:23:28 +0000"  >&lt;p&gt;Github user juliengreard commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1293#discussion_r125756848&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1293#discussion_r125756848&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: compiler/cpp/src/thrift/generate/t_py_generator.cc &amp;#8212;&lt;br/&gt;
    @@ -610,11 +623,22 @@ string t_py_generator::render_const_value(t_type* type, t_const_value* value) &lt;/p&gt;
{
       return out.str();
     }

&lt;p&gt;    +/** &lt;br/&gt;
    + * Generates the &quot;forward declarations&quot; for python structs.&lt;br/&gt;
    + * These are actually full class definitions so that calls to generate_struct&lt;br/&gt;
    + * can add the thrift_spec field.  This is needed so that all thrift_spec &lt;br/&gt;
    + * definitions are grouped at the end of the file to enable co-recursive structs.&lt;br/&gt;
    + */&lt;br/&gt;
    +void t_py_generator::generate_forward_declaration(t_struct* tstruct) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I dont&apos;t see where this function is called. Maybe I don&apos;t have the full diff in front of me&lt;/p&gt;</comment>
                            <comment id="16075530" author="githubbot" created="Wed, 5 Jul 2017 22:23:28 +0000"  >&lt;p&gt;Github user juliengreard commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1293#discussion_r125759228&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1293#discussion_r125759228&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/py/src/TRecursive.py &amp;#8212;&lt;br/&gt;
    @@ -0,0 +1,63 @@&lt;br/&gt;
    +# MODIFIED June 20, 2017, Eric Conner&lt;br/&gt;
    +#&lt;br/&gt;
    +#&lt;br/&gt;
    +# Original source copyright 2014-present Facebook, Inc.&lt;br/&gt;
    +#&lt;br/&gt;
    +#&lt;br/&gt;
    +# Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);&lt;br/&gt;
    +# you may not use this file except in compliance with the License.&lt;br/&gt;
    +# You may obtain a copy of the License at&lt;br/&gt;
    +#&lt;br/&gt;
    +#   &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
    +#&lt;br/&gt;
    +# Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
    +# distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
    +# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
    +# See the License for the specific language governing permissions and&lt;br/&gt;
    +# limitations under the License.&lt;br/&gt;
    +&lt;br/&gt;
    +from _&lt;em&gt;future&lt;/em&gt;_ import absolute_import&lt;br/&gt;
    +from _&lt;em&gt;future&lt;/em&gt;_ import division&lt;br/&gt;
    +from _&lt;em&gt;future&lt;/em&gt;_ import print_function&lt;br/&gt;
    +from _&lt;em&gt;future&lt;/em&gt;_ import unicode_literals&lt;br/&gt;
    +&lt;br/&gt;
    +from thrift.Thrift import TType&lt;br/&gt;
    +&lt;br/&gt;
    +&lt;br/&gt;
    +def fix_spec(all_structs):&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Well I&apos;m sorry but I dont understand this file. Maybe explaining what the functions are doing would help. You could also use named variables instead of using directly &apos;magic&apos; numbers (like const static int name = 1). But I may be wrong, I&apos;m a complete stranger to the source code of thrift, so maybe it&apos;s the way to do it&lt;/p&gt;</comment>
                            <comment id="16075531" author="githubbot" created="Wed, 5 Jul 2017 22:23:28 +0000"  >&lt;p&gt;Github user juliengreard commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1293#discussion_r125757042&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1293#discussion_r125757042&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: compiler/cpp/src/thrift/generate/t_py_generator.cc &amp;#8212;&lt;br/&gt;
    @@ -610,11 +623,22 @@ string t_py_generator::render_const_value(t_type* type, t_const_value* value) &lt;/p&gt;
{
       return out.str();
     }

&lt;p&gt;    +/** &lt;br/&gt;
    + * Generates the &quot;forward declarations&quot; for python structs.&lt;br/&gt;
    + * These are actually full class definitions so that calls to generate_struct&lt;br/&gt;
    + * can add the thrift_spec field.  This is needed so that all thrift_spec &lt;br/&gt;
    + * definitions are grouped at the end of the file to enable co-recursive structs.&lt;br/&gt;
    + */&lt;br/&gt;
    +void t_py_generator::generate_forward_declaration(t_struct* tstruct) &lt;/p&gt;
{
    +    generate_py_struct(tstruct, tstruct-&amp;gt;is_xception());
    +}
&lt;p&gt;    +&lt;br/&gt;
     /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Generates a python struct&lt;br/&gt;
      */&lt;br/&gt;
     void t_py_generator::generate_struct(t_struct* tstruct) {&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;generate_py_struct(tstruct, false);&lt;br/&gt;
    +  //generate_py_struct(tstruct, false);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    bad idea to leave commented code - if you really want to leave it there, leave also a comment explaining why&lt;/p&gt;</comment>
                            <comment id="16075532" author="githubbot" created="Wed, 5 Jul 2017 22:23:28 +0000"  >&lt;p&gt;Github user juliengreard commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1293#discussion_r125757570&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1293#discussion_r125757570&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: compiler/cpp/src/thrift/generate/t_py_generator.cc &amp;#8212;&lt;br/&gt;
    @@ -634,6 +659,49 @@ void t_py_generator::generate_py_struct(t_struct* tstruct, bool is_exception) &lt;/p&gt;
{
       generate_py_struct_definition(f_types_, tstruct, is_exception);
     }

&lt;p&gt;    +&lt;br/&gt;
    +/**&lt;br/&gt;
    + * Generate the thrift_spec for a struct&lt;br/&gt;
    + * e.g. (4, TType.LIST, &apos;struct_list&apos;, (TType.STRUCT, (RandomStuff, None), False), None, ),  # 4&lt;br/&gt;
    + */&lt;br/&gt;
    +void t_py_generator::generate_py_thrift_spec(ofstream&amp;amp; out,&lt;br/&gt;
    +                                             t_struct* tstruct,&lt;br/&gt;
    +                                             bool /&lt;b&gt;is_exception&lt;/b&gt;/) {&lt;br/&gt;
    +  const vector&amp;lt;t_field*&amp;gt;&amp;amp; sorted_members = tstruct-&amp;gt;get_sorted_members();&lt;br/&gt;
    +  vector&amp;lt;t_field*&amp;gt;::const_iterator m_iter;&lt;br/&gt;
    +&lt;br/&gt;
    +  // Add struct definition to list so thrift_spec can be fixed for recursive structures.&lt;br/&gt;
    +  indent(out) &amp;lt;&amp;lt; &quot;all_structs.append(&quot; &amp;lt;&amp;lt; tstruct-&amp;gt;get_name() &amp;lt;&amp;lt; &quot;)&quot; &amp;lt;&amp;lt; endl;&lt;br/&gt;
    +&lt;br/&gt;
    +  if (sorted_members.empty() || (sorted_members&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;-&amp;gt;get_key() &amp;gt;= 0)) {&lt;br/&gt;
    +    indent(out) &amp;lt;&amp;lt; tstruct-&amp;gt;get_name() &amp;lt;&amp;lt; &quot;.thrift_spec = (&quot; &amp;lt;&amp;lt; endl;&lt;br/&gt;
    +    indent_up();&lt;br/&gt;
    +&lt;br/&gt;
    +    int sorted_keys_pos = 0;&lt;br/&gt;
    +    for (m_iter = sorted_members.begin(); m_iter != sorted_members.end(); ++m_iter) {&lt;br/&gt;
    +&lt;br/&gt;
    +      for (; sorted_keys_pos != (*m_iter)-&amp;gt;get_key(); sorted_keys_pos++) &lt;/p&gt;
{
    +        indent(out) &amp;lt;&amp;lt; &quot;None,  # &quot; &amp;lt;&amp;lt; sorted_keys_pos &amp;lt;&amp;lt; endl;
    +      }
&lt;p&gt;    +&lt;br/&gt;
    +      indent(out) &amp;lt;&amp;lt; &quot;(&quot; &amp;lt;&amp;lt; (*m_iter)&lt;del&gt;&amp;gt;get_key() &amp;lt;&amp;lt; &quot;, &quot; &amp;lt;&amp;lt; type_to_enum((*m_iter)&lt;/del&gt;&amp;gt;get_type())&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    a comment showing an example of the python code generated from this peace of code would be a plus&lt;/p&gt;</comment>
                            <comment id="16075536" author="juliengreard" created="Wed, 5 Jul 2017 22:25:00 +0000"  >&lt;p&gt;Ok it should be better now !&lt;/p&gt;

</comment>
                            <comment id="16075575" author="githubbot" created="Wed, 5 Jul 2017 22:52:41 +0000"  >&lt;p&gt;Github user econner commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1293#discussion_r125776706&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1293#discussion_r125776706&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: compiler/cpp/src/thrift/generate/t_py_generator.cc &amp;#8212;&lt;br/&gt;
    @@ -610,11 +623,22 @@ string t_py_generator::render_const_value(t_type* type, t_const_value* value) &lt;/p&gt;
{
       return out.str();
     }

&lt;p&gt;    +/** &lt;br/&gt;
    + * Generates the &quot;forward declarations&quot; for python structs.&lt;br/&gt;
    + * These are actually full class definitions so that calls to generate_struct&lt;br/&gt;
    + * can add the thrift_spec field.  This is needed so that all thrift_spec &lt;br/&gt;
    + * definitions are grouped at the end of the file to enable co-recursive structs.&lt;br/&gt;
    + */&lt;br/&gt;
    +void t_py_generator::generate_forward_declaration(t_struct* tstruct) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This is an interface method that&apos;s called by the thrift compiler.  One attribute of this change is to move most of the code that generates python code into ``generate_forward_declaration`` and then output the ``thrift_spec`` via the ``generate_struct`` method.&lt;/p&gt;</comment>
                            <comment id="16075576" author="githubbot" created="Wed, 5 Jul 2017 22:54:06 +0000"  >&lt;p&gt;Github user econner commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1293#discussion_r125776924&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1293#discussion_r125776924&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/py/src/ext/types.cpp &amp;#8212;&lt;br/&gt;
    @@ -20,6 +20,8 @@&lt;br/&gt;
     #include &quot;ext/types.h&quot;&lt;br/&gt;
     #include &quot;ext/protocol.h&quot;&lt;/p&gt;

&lt;p&gt;    +#include &amp;lt;iostream&amp;gt;&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    Mm I believe this was a holdover from testing &amp;amp; using print statements.  It should be safe to remove.  Thanks for catching.&lt;/p&gt;</comment>
                            <comment id="16075577" author="githubbot" created="Wed, 5 Jul 2017 22:54:41 +0000"  >&lt;p&gt;Github user econner commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1293#discussion_r125777018&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1293#discussion_r125777018&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: test/py/SerializationTest.py &amp;#8212;&lt;br/&gt;
    @@ -285,6 +290,67 @@ def testIntegerLimits(self):&lt;br/&gt;
             for value in bad_values:&lt;br/&gt;
                 self.assertRaises(Exception, self._serialize, value)&lt;/p&gt;

&lt;p&gt;    +    def testRecTree(self):&lt;br/&gt;
    +        &quot;&quot;&quot;Ensure recursive tree node can be created.&quot;&quot;&quot;&lt;br/&gt;
    +        children = []&lt;br/&gt;
    +        for idx in range(1, 5):&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This is just a test to ensure you can make a tree with some children.  There is no limit on the number of recursions (I guess besides the maximum allowed by python).&lt;/p&gt;</comment>
                            <comment id="16076667" author="econner724" created="Thu, 6 Jul 2017 15:07:13 +0000"  >&lt;p&gt;Ok &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=juliengreard&quot; class=&quot;user-hover&quot; rel=&quot;juliengreard&quot;&gt;juliengreard&lt;/a&gt; I believe I have addressed all of your comments.  Would you mind taking another look?&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="16076684" author="juliengreard" created="Thu, 6 Jul 2017 15:22:00 +0000"  >&lt;p&gt;Just did it, looks fine to me&lt;/p&gt;

</comment>
                            <comment id="16077194" author="jensg" created="Thu, 6 Jul 2017 21:00:53 +0000"  >&lt;p&gt;Thank you both, committed.&lt;/p&gt;</comment>
                            <comment id="16077195" author="githubbot" created="Thu, 6 Jul 2017 21:01:05 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1293&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1293&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13143044">THRIFT-4510</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="13180808">THRIFT-4623</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>408834</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 19 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ycf3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>408832</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>