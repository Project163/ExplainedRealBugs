<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:05:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-1690] Sockets and Pipe Handles truncated on Win64</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-1690</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;On 64-bit Windows, &quot;int&quot; is a 32-bit value.  SOCKET and HANDLE are 64-bit.&lt;/p&gt;

&lt;p&gt;All of the files dealing with sockets in thrift use &quot;int&quot; as the type of a socket, as this is the idiomatic way to handle sockets on POSIX systems.  For portability, a SOCKET typedef is probably needed.&lt;/p&gt;

&lt;p&gt;For the Pipe Server and Pipe Transport, HANDLEs are cast to ints to store as member variables for some reason (maybe to avoid #including &amp;lt;windows.h&amp;gt; in a header?).&lt;/p&gt;

&lt;p&gt;Both of these situations can result in invalid handles being used (and valid handles being leaked) when the system is under load.&lt;/p&gt;</description>
                <environment>&lt;p&gt;64-bit Windows&lt;/p&gt;</environment>
        <key id="12606880">THRIFT-1690</key>
            <summary>Sockets and Pipe Handles truncated on Win64</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roger">Roger Meier</assignee>
                                    <reporter username="ben.craig">Ben Craig</reporter>
                        <labels>
                    </labels>
                <created>Mon, 10 Sep 2012 14:23:48 +0000</created>
                <updated>Fri, 1 Mar 2013 22:07:24 +0000</updated>
                            <resolved>Sat, 6 Oct 2012 06:01:50 +0000</resolved>
                                    <version>0.9</version>
                                                    <component>C++ - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="172800">48h</timeoriginalestimate>
                            <timeestimate seconds="172800">48h</timeestimate>
                                        <comments>
                            <comment id="13459042" author="ben.craig" created="Wed, 19 Sep 2012 20:13:07 +0000"  >&lt;p&gt;libthrift_pipe_size resolves pipe specific issues.&lt;/p&gt;

&lt;p&gt;libthrift_warning_purge resolves a lot of issues.  Specifics are mentioned in the prologue of the .patch itself.&lt;/p&gt;

&lt;p&gt;This is related to &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1695&quot; title=&quot;allow warning-free compilation in VS 2012 and GNU 4.6&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1695&quot;&gt;&lt;del&gt;THRIFT-1695&lt;/del&gt;&lt;/a&gt;.  libthrift_warning_purge is also linked on &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1695&quot; title=&quot;allow warning-free compilation in VS 2012 and GNU 4.6&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1695&quot;&gt;&lt;del&gt;THRIFT-1695&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13469561" author="roger.meier" created="Thu, 4 Oct 2012 18:04:47 +0000"  >&lt;p&gt;Thanks Ben, committed!&lt;/p&gt;

&lt;p&gt;Could you please create future patches according to&lt;br/&gt;
&lt;a href=&quot;http://thrift.apache.org/docs/HowToContribute/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://thrift.apache.org/docs/HowToContribute/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;=&amp;gt; this simplifies and speeds up review/commit phase.&lt;/p&gt;

&lt;p&gt;thanks&lt;br/&gt;
roger&lt;/p&gt;</comment>
                            <comment id="13469586" author="hudson" created="Thu, 4 Oct 2012 18:38:48 +0000"  >&lt;p&gt;Integrated in Thrift #543 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/543/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/543/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1690&quot; title=&quot;Sockets and Pipe Handles truncated on Win64&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1690&quot;&gt;&lt;del&gt;THRIFT-1690&lt;/del&gt;&lt;/a&gt; Sockets and Pipe Handles truncated on Win64&lt;br/&gt;
Patch: Ben Craig (Revision 1394182)&lt;/p&gt;

&lt;p&gt;     Result = FAILURE&lt;br/&gt;
roger : &lt;a href=&quot;http://svn.apache.org/viewvc/?view=rev&amp;amp;rev=1394182&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/?view=rev&amp;amp;rev=1394182&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/concurrency/BoostMonitor.cpp&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/concurrency/TimerManager.cpp&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/concurrency/Util.cpp&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/concurrency/Util.h&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/protocol/TBinaryProtocol.tcc&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/protocol/TDebugProtocol.cpp&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/protocol/TDenseProtocol.cpp&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/protocol/TJSONProtocol.cpp&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/protocol/TProtocol.h&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/server/TThreadPoolServer.cpp&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/transport/TBufferTransports.cpp&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/transport/TBufferTransports.h&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/transport/TFDTransport.cpp&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/transport/TFileTransport.cpp&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/transport/TFileTransport.h&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/transport/THttpClient.cpp&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/transport/THttpServer.cpp&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/transport/THttpTransport.cpp&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/transport/TPipe.cpp&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/transport/TPipe.h&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/transport/TPipeServer.cpp&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/transport/TPipeServer.h&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/transport/TServerSocket.cpp&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/transport/TServerSocket.h&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/transport/TSocket.cpp&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/transport/TSocket.h&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/transport/TSocketPool.cpp&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/transport/TSocketPool.h&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/windows/SocketPair.cpp&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/windows/SocketPair.h&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/windows/StdAfx.h&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/windows/WinFcntl.cpp&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/windows/WinFcntl.h&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/windows/config.h&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/windows/force_inc.h&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13469653" author="ben.craig" created="Thu, 4 Oct 2012 20:30:51 +0000"  >&lt;p&gt;Roger,&lt;br/&gt;
I will be glad to better follow process in the future.  I&apos;m not sure what I messed up with my last submission though.  What should I do better in the future?  Single .patch for the entire fix?  Remove the commentary in the .patch file?&lt;/p&gt;</comment>
                            <comment id="13469709" author="roger.meier" created="Thu, 4 Oct 2012 21:12:35 +0000"  >&lt;p&gt;one patch per issue made acording to &lt;a href=&quot;http://thrift.apache.org/docs/HowToContribute&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://thrift.apache.org/docs/HowToContribute&lt;/a&gt;&lt;br/&gt;
would be great, diff&apos;s made within a subtree are not that easy to handle.&lt;br/&gt;
simplification, that&apos;s all...&lt;/p&gt;

&lt;p&gt;thanks for the patch!&lt;br/&gt;
roger&lt;/p&gt;

</comment>
                            <comment id="13470237" author="pavlin" created="Fri, 5 Oct 2012 11:42:06 +0000"  >&lt;p&gt;The patch (Revision 1394182) broke the compilation for non-Linux UNIX&lt;br/&gt;
systems, because SOCKET is not defined. The compilation error below&lt;br/&gt;
is on FreeBSD-9.0:&lt;/p&gt;


&lt;p&gt;/bin/sh ../../libtool  --tag=CXX   --mode=compile g++ -DHAVE_CONFIG_H -I. -I../..  -I/usr/local/include -I./src -I./src/thrift  -Wall -g -O2 -MT THttpClient.lo -MD -MP -MF .deps/THttpClient.Tpo -c -o THttpClient.lo `test -f &apos;src/thrift/transport/THttpClient.cpp&apos; || echo &apos;./&apos;`src/thrift/transport/THttpClient.cpp&lt;br/&gt;
libtool: compile:  g++ -DHAVE_CONFIG_H -I. -I../.. -I/usr/local/include -I./src -I./src/thrift -Wall -g -O2 -MT THttpClient.lo -MD -MP -MF .deps/THttpClient.Tpo -c src/thrift/transport/THttpClient.cpp  -fPIC -DPIC -o .libs/THttpClient.o&lt;br/&gt;
In file included from ./src/thrift/transport/TSocket.h:27,&lt;br/&gt;
                 from src/thrift/transport/THttpClient.cpp:25:&lt;br/&gt;
./src/thrift/transport/TServerSocket.h:64: error: &apos;SOCKET&apos; has not been declared&lt;br/&gt;
./src/thrift/transport/TServerSocket.h:69: error: &apos;SOCKET&apos; does not name a type&lt;br/&gt;
./src/thrift/transport/TServerSocket.h:79: error: &apos;SOCKET&apos; does not name a type&lt;br/&gt;
./src/thrift/transport/TServerSocket.h:80: error: &apos;SOCKET&apos; does not name a type&lt;br/&gt;
In file included from src/thrift/transport/THttpClient.cpp:25:&lt;br/&gt;
./src/thrift/transport/TSocket.h:203: error: &apos;SOCKET&apos; does not name a type&lt;br/&gt;
./src/thrift/transport/TSocket.h:234: error: expected `)&apos; before &apos;socket&apos;&lt;br/&gt;
./src/thrift/transport/TSocket.h:265: error: &apos;SOCKET&apos; does not name a type&lt;br/&gt;
gmake&lt;span class=&quot;error&quot;&gt;&amp;#91;4&amp;#93;&lt;/span&gt;: *** &lt;span class=&quot;error&quot;&gt;&amp;#91;THttpClient.lo&amp;#93;&lt;/span&gt; Error 1&lt;br/&gt;
gmake&lt;span class=&quot;error&quot;&gt;&amp;#91;4&amp;#93;&lt;/span&gt;: Leaving directory `/usr/home/pavlin/tmp/thrift/thrift-svn/lib/cpp&apos;&lt;br/&gt;
gmake&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;: *** &lt;span class=&quot;error&quot;&gt;&amp;#91;all-recursive&amp;#93;&lt;/span&gt; Error 1&lt;br/&gt;
gmake&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;: Leaving directory `/usr/home/pavlin/tmp/thrift/thrift-svn/lib/cpp&apos;&lt;br/&gt;
gmake&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;: *** &lt;span class=&quot;error&quot;&gt;&amp;#91;all-recursive&amp;#93;&lt;/span&gt; Error 1&lt;br/&gt;
gmake&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;: Leaving directory `/usr/home/pavlin/tmp/thrift/thrift-svn/lib&apos;&lt;br/&gt;
gmake&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;: *** &lt;span class=&quot;error&quot;&gt;&amp;#91;all-recursive&amp;#93;&lt;/span&gt; Error 1&lt;br/&gt;
gmake&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;: Leaving directory `/usr/home/pavlin/tmp/thrift/thrift-svn&apos;&lt;br/&gt;
gmake: *** &lt;span class=&quot;error&quot;&gt;&amp;#91;all&amp;#93;&lt;/span&gt; Error 2&lt;br/&gt;
Exit 2&lt;/p&gt;


&lt;p&gt;The root cause is the following conditional definition inside file TSocket.h:&lt;/p&gt;


&lt;p&gt;#ifdef _&lt;em&gt;linux&lt;/em&gt;_&lt;br/&gt;
   typedef int SOCKET;&lt;br/&gt;
#endif&lt;/p&gt;


&lt;p&gt;Obviously, this is not portable. The proper solution would be to check&lt;br/&gt;
for &quot;SOCKET&quot; inside configure.ac and conditionally typedef it for&lt;br/&gt;
all systems that don&apos;t have it.&lt;/p&gt;</comment>
                            <comment id="13470244" author="pavlin" created="Fri, 5 Oct 2012 11:47:42 +0000"  >&lt;p&gt;Clarification to the above comment:&lt;br/&gt;
The same conditional typedef of SOCKET in TSocket.h&lt;br/&gt;
is repeated in file TServerSocket.h as well:&lt;/p&gt;

&lt;p&gt;#ifdef &lt;em&gt;linux&lt;/em&gt;&lt;br/&gt;
typedef int SOCKET;&lt;br/&gt;
#endif&lt;/p&gt;</comment>
                            <comment id="13470296" author="roger.meier" created="Fri, 5 Oct 2012 13:06:12 +0000"  >&lt;p&gt;sorry about that! &lt;/p&gt;

&lt;p&gt;do you already have a patch?&lt;/p&gt;</comment>
                            <comment id="13470318" author="ben.craig" created="Fri, 5 Oct 2012 13:40:39 +0000"  >&lt;p&gt;One decent short term possibility is to change those two #ifdef linux&apos;s to #ifndef _WIN32.&lt;/p&gt;

&lt;p&gt;A longer term solution is to stop providing unnatural aliases.  Turning int -&amp;gt; SOCKET on non-Windows is one example.  Turning errno into WSAGetLastError is similarly bad on Windows.&lt;/p&gt;</comment>
                            <comment id="13470405" author="ben.craig" created="Fri, 5 Oct 2012 15:44:06 +0000"  >&lt;p&gt;Fix for non-linux, non-windows builds of C++ library.  Only tested on Linux and Windows, to make sure I didn&apos;t make things worse.&lt;/p&gt;</comment>
                            <comment id="13470408" author="ben.craig" created="Fri, 5 Oct 2012 15:44:55 +0000"  >&lt;p&gt;Hopefully that patch will do the trick.  As mentioned on the comments, I haven&apos;t actually tested it on non-Linux, non-Windows builds.&lt;/p&gt;</comment>
                            <comment id="13470927" author="roger.meier" created="Sat, 6 Oct 2012 06:01:50 +0000"  >&lt;p&gt;Thanks Craig for this quick fix!&lt;/p&gt;</comment>
                            <comment id="13470941" author="hudson" created="Sat, 6 Oct 2012 07:24:23 +0000"  >&lt;p&gt;Integrated in Thrift #550 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/550/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/550/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1690&quot; title=&quot;Sockets and Pipe Handles truncated on Win64&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1690&quot;&gt;&lt;del&gt;THRIFT-1690&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
Non-linux OSes use int&apos;s in bsd socket calls as well. (Revision 1394931)&lt;/p&gt;

&lt;p&gt;     Result = ABORTED&lt;br/&gt;
roger : &lt;a href=&quot;http://svn.apache.org/viewvc/?view=rev&amp;amp;rev=1394931&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/?view=rev&amp;amp;rev=1394931&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/transport/TServerSocket.h&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/cpp/src/thrift/transport/TSocket.h&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13471103" author="pavlin" created="Sat, 6 Oct 2012 22:16:21 +0000"  >&lt;p&gt;A follow-up on my earlier comment:&lt;br/&gt;
   The proper solution would be to check&lt;br/&gt;
   for &quot;SOCKET&quot; inside configure.ac and conditionally typedef it for&lt;br/&gt;
   all systems that don&apos;t have it.&lt;/p&gt;

&lt;p&gt;Apparently, both header files TSocket.h and&lt;br/&gt;
TServerSocket.h are installed on the system&lt;br/&gt;
(by default in /usr/local/include/thrift/transport).&lt;br/&gt;
As such, the conditional typedef must use symbols&lt;br/&gt;
that are pre-defined for the client software that&lt;br/&gt;
might include those header files.&lt;br/&gt;
I.e., it must be a symbol defined in some of the other Thrift&lt;br/&gt;
header files installed on the system, or a&lt;br/&gt;
symbol defined by the system itself.&lt;br/&gt;
The &quot;#ifndef _WIN32&quot; solution is fine, because it&lt;br/&gt;
belongs to the latter category.&lt;/p&gt;
</comment>
                            <comment id="13496471" author="peace" created="Tue, 13 Nov 2012 19:32:57 +0000"  >&lt;p&gt;The fixes are very much appreciated. We&apos;re not building 64-bit yet but when the time comes this will be beneficial.&lt;/p&gt;

&lt;p&gt;A consequence of the restructuring (wrapping the Pipe classes with #ifdef _WIN32 and typedef&apos;ing the name for *NIX) is that it&apos;s more difficult to implement anonymous pipes for *NIX. It&apos;ll be alot of duplicated code since all the Pipe related methods will need to be replicated for *NIX. It also makes the calling code less platform-agnostic. With these changes, the calling code can&apos;t be cross-platform for Windows &amp;amp; *NIX because, for example, setPipename doesn&apos;t exist in TServerSocket. You&apos;ve just moved the burden of the #ifdefs from the abstract Pipe class to the calling code. That was the motivation for casting HANDLE to int and vice-versa. Perhaps we could cast between IntPtr instead?&lt;/p&gt;</comment>
                            <comment id="13496527" author="ben.craig" created="Tue, 13 Nov 2012 20:47:02 +0000"  >&lt;p&gt;The old code was a bit of a portability mess.  The new code is a different portability mess.  The toy program that I&apos;ve been using for my own testing has gotten away without needing to touch the raw HANDLE / file descriptor.  I would prefer to solve most use cases in that way, but still provide access to the underlying OS object when platform specific things are needed.  I think #ifdefs are inevitable there.  There is still significant room to improve though.  I don&apos;t think IntPtr is the answer though, as that is too large on 64-bit *nix platforms.&lt;/p&gt;

&lt;p&gt;The projects I am working on care a lot about named pipes and named AF_UNIX sockets.  This is for Mac, Windows, and Linux, both 32 and 64-bit.  I am actively working on making it easy to use these in cross-platform code.  I hope to have patches for the following problems in the next month:&lt;br/&gt;
1. Portable naming.  I want to be able to construct my TTransport (or TServerTransport) without ifdefs.  That means that &quot;MyPipe&quot; needs to have the appropriate slashes added on Windows (already done).  It also means that &quot;MyPipe&quot; needs to either be put in a special folder on *nix, or needs to be an abstract socket.  Putting the socket file in the app&apos;s current working directory probably isn&apos;t desirable.&lt;br/&gt;
2. Better cleanup.  Stop doesn&apos;t currently work on TPipeServer.  Stopping AF_UNIX sockets doesn&apos;t clean up the file (and I&apos;m not sure it can safely).  Both of these cases are important to me, because my use cases aren&apos;t of the &quot;launch the app and let it run 2 years&quot; variety.  My clients and servers start and stop in interactive scenarios.&lt;/p&gt;

&lt;p&gt;I don&apos;t have a personal need / interest in anonymous pipes.  I wasn&apos;t trying to break them, but I also didn&apos;t have tests for them.  I think the correct way to handle these is to have a new TServerTransport class specifically for anonymous pipes.  It may forward to TPipeServer and TServerSocket, but it can have the constructors that make sense for anonymous pipes, and not carry the baggage of named pipes.  &lt;/p&gt;

&lt;p&gt;For the record, I&apos;m not thrilled with the &quot;multi-purpose&quot; transports like TSocket, TPipe, and their server counterparts.  Porting single aspects of those classes is normally easy, but porting all of the aspects often doesn&apos;t work.  My preferred approach would have involved TTCPSocket, TNamedSocket&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;, TAnonymousSocket, and the like.  A lot of them would have similar implementations (possibly forwarding to helper classes), but it would make for more portable client code.&lt;/p&gt;</comment>
                            <comment id="13497213" author="peace" created="Wed, 14 Nov 2012 16:41:48 +0000"  >&lt;p&gt;One of the goals was to abstract away the platform-specific code (#ifdefs and such) into the transport, allowing the calling code to be uniform across platforms. As it stands now, both the Pipe transport code has #ifdefs, and code that calls it needs to employ #ifdefs. The calling code shouldn&apos;t care how the transport implements it, just that it&apos;s a local transport, be it named pipes or domain sockets. Otherwise apps that use Thrift would needlessly require redundant code &quot;if (Windows) -&amp;gt; use Pipe code, if (Unix) -&amp;gt; use dskt code&quot;.&lt;/p&gt;

&lt;p&gt;I agree the #ifdefs are ugly and I wish they could be avoided. I think you&apos;d agree that if they have to be there, it&apos;s better to abstract it away into the transport instead of placing that burden on every code that uses it.&lt;/p&gt;</comment>
                            <comment id="13497222" author="ben.craig" created="Wed, 14 Nov 2012 16:55:26 +0000"  >&lt;p&gt;I think we are agreeing (at least on some parts).  I don&apos;t want client code to require #ifdefs.  I think we might be disagreeing (or at least not understanding each other) on how to go about that.&lt;/p&gt;

&lt;p&gt;My proposal (that I don&apos;t have immediate plans on implementing) is to have a TAnonymousPipe / TAnonymousSocket transport.  I think that would provide the appropriate level of abstraction in client code.&lt;/p&gt;

&lt;p&gt;I would like TPipe to be focused on named pipes / AF_UNIX sockets.&lt;/p&gt;

&lt;p&gt;If you have a specific suggestion for a way to merge the two in a way that is not client hostile, I would be glad to review it.  I am open to being proven wrong.  Of course, in the end, I&apos;m not the one you need to convince, as I&apos;m not a maintainer &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13497238" author="peace" created="Wed, 14 Nov 2012 17:17:45 +0000"  >&lt;p&gt;I don&apos;t have any objection to moving the anonymous pipe transport to its own class. There wouldn&apos;t be an anonymous socket though (domain sockets are always named). On *NIX, an unnamed pipe can be created and the resulting file R/W descriptors passed on to the child process, conceptually similar to Windows&apos; handles created from CreatePipe.&lt;/p&gt;

&lt;p&gt;Take a look at contrib/transport-sample for cross-platform code that uses pipe transport. There are still some #ifdefs in there, many of which can&apos;t be avoided simply due to general platform differences. A portion of the #ifdefs are in the anonymous pipe section which could potentially be abstracted.&lt;/p&gt;

&lt;p&gt;Upon reviewing it, I see a few potential things that could be pulled into the transport. For instance, there&apos;s an unlink called in RunThriftServer in ThriftCommon.cpp. It&apos;s there in case the same domain socket had been previously used. Perhaps that could be placed in the destructor to address the cleanup concerns?&lt;/p&gt;</comment>
                            <comment id="13497239" author="peace" created="Wed, 14 Nov 2012 17:21:24 +0000"  >&lt;p&gt;PS: You&apos;re probably aware but just in case - that sample won&apos;t work with the current pipe transport. It&apos;ll require additional #ifdefs to set up the pipe transport on Windows (calls which don&apos;t exist in the *NIX pipe typedef).&lt;/p&gt;</comment>
                            <comment id="13497471" author="jensg" created="Wed, 14 Nov 2012 21:28:04 +0000"  >&lt;p&gt;Regarding &quot;moving the anonymous pipe transport to its own class&quot;: I used the C# code to write the Delphi Version, first version was a nearly 1:1 port. It worked fine so far, but somehow I was not happy with it.&lt;/p&gt;

&lt;p&gt;After three iterations I finally ended up with some more classes, but much smaller ones, the code became much clearer after I decided to split them up. &lt;/p&gt;

&lt;p&gt;I did that after it became clear to me that there were really two classes merged into one, causing a lot of the methods being in fact two methods rolled into one: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( is_anonymous_case)
{
  a lot of code
}
&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
{
  even more code
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, I do not have enough practice with *NIX platforms yet to be able to give any advice. I just wanted to mention my experiences with the C# code (and I still think about refactoring that one as well ... maybe, not today).&lt;/p&gt;


</comment>
                            <comment id="13497482" author="ben.craig" created="Wed, 14 Nov 2012 21:36:16 +0000"  >&lt;p&gt;So what is the expectation of source compatibility with Thrift?  If I change TSocket and TServerSocket to be TCP only, TPipe and TServerPipe to be localhost named transports, and create TAnonymousPipe classes, would the code breaks be met with insurmountable resistance?&lt;/p&gt;</comment>
                            <comment id="13497495" author="peace" created="Wed, 14 Nov 2012 21:47:15 +0000"  >&lt;p&gt;From what I can tell, alot of people rely on domain sockets in T&lt;span class=&quot;error&quot;&gt;&amp;#91;Server&amp;#93;&lt;/span&gt;Socket. Consider also that domain sockets are handled very similarly to TCP sockets so you&apos;d end up with alot of redundant code from the socket transport.&lt;/p&gt;

&lt;p&gt;I recommend reverting to the #ifdefs that were originally in the pipe transports to retain better cross-platform support. Pull out the anonymous pipe portion and place that into its own class. We&apos;ll need to solve how to cleanly cast HANDLE to/from 32 &amp;amp; 64-bit types since *NIX doesn&apos;t have HANDLEs. Could we typedef a 32/64-bit long to HANDLE on *NIX systems, assuming bitness can be detected by the preprocessor?&lt;/p&gt;</comment>
                            <comment id="13590993" author="peace" created="Fri, 1 Mar 2013 22:07:24 +0000"  >&lt;p&gt;Please see &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1870&quot; title=&quot;Enhance TPipe / TPipeServer transport to support both Windows 64-bit and cross-platform *NIX support&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1870&quot;&gt;THRIFT-1870&lt;/a&gt; for a patch that adds Win64-bit support while retaining *NIX cross-platform compatibility. A working cross-platform usage example is in contrib/transport-sample. Basically all that needs to be done from Windows is to cast HANDLE to std::ptrdiff_t when passing it to the TPipe() constructor.&lt;/p&gt;

&lt;p&gt;I&apos;ve left the anonymous pipe support in there for now. If someone would like to pull that out into its own transport, feel free to have at it.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12547996" name="lib_socket_typedef.patch" size="853" author="ben.craig" created="Fri, 5 Oct 2012 15:44:06 +0000"/>
                            <attachment id="12545790" name="libthrift_pipe_size.patch" size="21955" author="ben.craig" created="Wed, 19 Sep 2012 20:13:07 +0000"/>
                            <attachment id="12545791" name="libthrift_warning_purge.patch" size="41031" author="ben.craig" created="Wed, 19 Sep 2012 20:13:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>240551</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 38 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i013an:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4303</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>