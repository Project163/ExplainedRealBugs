<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:31:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-4858] Java TThreadPoolServer: confusing error message on closed socket</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-4858</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;I&apos;ve spotted an error in using java libthrift that I&apos;d like to call to your attention. It is in version 0.12.0, but I see it in other versions. I will comment about the other versions at the end, please read - it may be very &lt;b&gt;important&lt;/b&gt; to you.&lt;/p&gt;

&lt;p&gt;I create a TThreadPoolServer, and when my client calls a method, the server spawns off a worker thread and when it gets to this line (in TThreadPoolServer):&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;if(stopped_ || !processor.process(inputProtocol, outputProtocol)) {&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;break;&lt;/tt&gt;&lt;br/&gt;
 }&lt;/p&gt;

&lt;p&gt;It will call a TBaseProcessor&apos;s process method, which can only return either True or throw an Exception. In my case, it gets to the very bottom and calls the ProcessFunction fn properly:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;fn.process(msg.seqid, in, out, iface);&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Followed by returning true. However, since the TThreadPoolServer will not &quot;break&quot; out of the while(true) loop it is in, it will attempt to call the&#160;TBaseProcessor&apos;s process method again and this time around I get an exception when this line is called on TBaseProcessor&apos;s process method:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;TMessage msg = in.readMessageBegin();&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Exception is:&lt;/p&gt;

&lt;p&gt;17844 &lt;span class=&quot;error&quot;&gt;&amp;#91;pool-6-thread-5&amp;#93;&lt;/span&gt; ERROR org.apache.thrift.server.TThreadPoolServer - Thrift error occurred during processing of message.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;org.apache.thrift.transport.TTransportException&lt;/tt&gt;&lt;br/&gt;
 at org.apache.thrift.transport.TIOStreamTransport.read(TIOStreamTransport.java:132&lt;br/&gt;
 at org.apache.thrift.transport.TTransport.readAll(TTransport.java:86)&lt;br/&gt;
 at org.apache.thrift.transport.TFramedTransport.readFrame(TFramedTransport.java:132)&lt;br/&gt;
 at org.apache.thrift.transport.TFramedTransport.read(TFramedTransport.java:100)&lt;br/&gt;
 at org.apache.thrift.transport.TTransport.readAll(TTransport.java:86)&lt;br/&gt;
 at org.apache.thrift.protocol.TBinaryProtocol.readAll(TBinaryProtocol.java:425)&lt;br/&gt;
 at org.apache.thrift.protocol.TBinaryProtocol.readI32(TBinaryProtocol.java:321)&lt;br/&gt;
 at org.apache.thrift.protocol.TBinaryProtocol.readMessageBegin(TBinaryProtocol.java:225)&lt;br/&gt;
 at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:33)&lt;br/&gt;
 at org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadPoolServer.java:318)&lt;br/&gt;
 at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)&lt;br/&gt;
 at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)&lt;br/&gt;
 at java.lang.Thread.run(Thread.java:748)&lt;/p&gt;

&lt;p&gt;I surmise because my TProtocol in has already sent the bytes (I am using a TBinaryProtocol) to the process function, there is nothing left to read and thus we never make it to the next line:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;ProcessFunction fn = processMap.get(msg.name);&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;For giggles, I decided to remove the ! from the logic, and sure enough it gets by but it appears to perhaps cause other problems when a client calls a method with zero parameters (e.g. &quot;ping()&quot;).&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Other versions:&lt;/b&gt;&#160;So far as I can tell this exact same code set up is in java libthrift 0.9.0, 0.9.1, and 0.9.3.1. However, my Java code works just fine in those. I only discovered this problem when I went to upgrade my code to Thrift 0.12.0. I honestly can&apos;t make sense of why that would be OK in those older versions but, I&apos;ve been blissfully unaware of this problem until the upgrade. It is possible I need to now do something that I did not before. That is because before, I used TThreadPoolServer with 0.9.x&#160;as I want to do now in 0.12.x. I figured perhaps something else is happening in Thrift with my TThreadPoolServer. Finally, I did see the problem in 0.12.1 and did not test it, though it appears changed in the master branch - we tried it and it still has errors.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Here is some information on my environment and code that calls Thrift.&lt;/p&gt;

&lt;p&gt;Environment: Red Hat Linux 7.6, Java 1.8, Thrift 0.12.0. Both my client and server are in Java. However, I have also seen this when a Python client calls the Java server.&lt;/p&gt;

&lt;p&gt;Here is what I do to set up the server, my service Iface name is &quot;AlgorithmRepository&quot; ...&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;TServerTransport transport = new TServerSocket(10202);&lt;/tt&gt;&lt;br/&gt;
{{ TProcessor processor = new AlgorithmRepository.Processor&amp;lt;&amp;gt;(this);}}&lt;br/&gt;
{{ Args args = new TThreadPoolServer.Args(transport).processor(processor).inputTransportFactory(new TFramedTransport.Factory()).outputTransportFactory(new TFramedTransport.Factory()).protocolFactory(new TBinaryProtocol.Factory());}}&lt;br/&gt;
{{ final TServer server = new TThreadPoolServer(args);}}&lt;br/&gt;
{{ new Thread(server::serve).start();}}&lt;/p&gt;

&lt;p&gt;That last line corresponds to the Thread you see at the bottom of the exception.&lt;/p&gt;

&lt;p&gt;It is worth noting we did also set the Input and Output Protocol Factories too and it had no affect on the result.&lt;/p&gt;

&lt;p&gt;We saw on stackoverflow that if you don&apos;t have the same Transport type, it will fail to function. Here is client code that sets this up:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;TTransport transport =&#160;new TFramedTransport(new TSocket(host, port, socketTimeoutMillis));&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;I&apos;d be happy to share more client code if you felt it was something the client is doing wrong.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</environment>
        <key id="13231538">THRIFT-4858</key>
            <summary>Java TThreadPoolServer: confusing error message on closed socket</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nsuke">Nobuaki Sukegawa</assignee>
                                    <reporter username="mczajkow">Michael Czajkowski</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 May 2019 21:18:06 +0000</created>
                <updated>Wed, 16 Oct 2019 22:28:00 +0000</updated>
                            <resolved>Fri, 20 Sep 2019 07:05:03 +0000</resolved>
                                    <version>0.12.0</version>
                                    <fixVersion>0.13.0</fixVersion>
                                    <component>Java - Library</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>8</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16895361" author="benpavon" created="Mon, 29 Jul 2019 15:27:35 +0000"  >&lt;p&gt;I am seeing the same error on 0.12.0.&lt;/p&gt;</comment>
                            <comment id="16895401" author="benpavon" created="Mon, 29 Jul 2019 16:10:13 +0000"  >&lt;p&gt;I tested having my test client invoke the same service function several times and sleeping for a period of time before closing the transport.&lt;/p&gt;

&lt;p&gt;I found that the exception occurs when the transport is closed.&lt;/p&gt;</comment>
                            <comment id="16923486" author="osayankin" created="Thu, 5 Sep 2019 14:32:57 +0000"  >&lt;p&gt;Absolutely the same happens when user closes connection to HiveServer2. See class &lt;tt&gt;TThreadPoolServer&lt;/tt&gt; method &lt;tt&gt;run()&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {

            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (eventHandler != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
              eventHandler.processContext(connectionContext, inputTransport, outputTransport);
            }

            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(stopped_ || !processor.process(inputProtocol, outputProtocol)) {
              &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
            }
        }
      } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (TException tx) {
        LOGGER.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Thrift error occurred during processing of message.&quot;&lt;/span&gt;, tx);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;JVM executes&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
processor.process(inputProtocol, outputProtocol)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;during the connection closure, and &lt;tt&gt;processor.process(...)&lt;/tt&gt; returns &lt;tt&gt;true&lt;/tt&gt; since connection was successfully closed. Then it goes to the next iteration of &lt;tt&gt;while(true)&lt;/tt&gt; loop and tries to process it again but can&apos;t read bytes and throws &lt;tt&gt;TTransportException&lt;/tt&gt; at &lt;tt&gt;org.apache.thrift.transport.TIOStreamTransport.read(TIOStreamTransport.java:132)&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16934133" author="nsuke" created="Fri, 20 Sep 2019 06:54:16 +0000"  >&lt;p&gt;The excessive error message was likely to be introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3769&quot; title=&quot;Fix logic of THRIFT-2268&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3769&quot;&gt;&lt;del&gt;THRIFT-3769&lt;/del&gt;&lt;/a&gt; (0.12.0) and subsequently been fixed by &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4805&quot; title=&quot;Suppress excessive logging of SASL TTransportExceptions in case of END_OF_FILE &quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4805&quot;&gt;&lt;del&gt;THRIFT-4805&lt;/del&gt;&lt;/a&gt; (upcoming release).&lt;/p&gt;</comment>
                            <comment id="16934141" author="nsuke" created="Fri, 20 Sep 2019 07:05:03 +0000"  >&lt;p&gt;Please reopen if this persists with current master or anywhere after&#160;&lt;a href=&quot;https://github.com/apache/thrift/commit/c35ed736d26a1dfd8965ae197a67904ed9b4fba3#diff-c6a81da7e9ec5ce3c040a3386a790b69R321&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/commit/c35ed736d26a1dfd8965ae197a67904ed9b4fba3#diff-c6a81da7e9ec5ce3c040a3386a790b69R321&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16934224" author="q.xu" created="Fri, 20 Sep 2019 09:12:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nsuke&quot; class=&quot;user-hover&quot; rel=&quot;nsuke&quot;&gt;nsuke&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I don&apos;t think it&apos;s related to&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3769&quot; title=&quot;Fix logic of THRIFT-2268&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3769&quot;&gt;&lt;del&gt;THRIFT-3769&lt;/del&gt;&lt;/a&gt;&#160;, neither will fix of &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4805&quot; title=&quot;Suppress excessive logging of SASL TTransportExceptions in case of END_OF_FILE &quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4805&quot;&gt;&lt;del&gt;THRIFT-4805&lt;/del&gt;&lt;/a&gt; solve this problem. In fact, the problem reported from&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4805&quot; title=&quot;Suppress excessive logging of SASL TTransportExceptions in case of END_OF_FILE &quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4805&quot;&gt;&lt;del&gt;THRIFT-4805&lt;/del&gt;&lt;/a&gt; is some excessive error messages when the server socket tries to accept incoming connections (especially because it&apos;s `TSaslServerTransport` and it expects sasl messages). On the other hand, this ticket is about the worker threads raising some meaningless / incomprehensible errors when the processor tries to read from a closed socket.&lt;/p&gt;

&lt;p&gt;So could you reopen it again while waiting for the fix?&lt;/p&gt;</comment>
                            <comment id="16934230" author="q.xu" created="Fri, 20 Sep 2019 09:20:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mczajkow&quot; class=&quot;user-hover&quot; rel=&quot;mczajkow&quot;&gt;mczajkow&lt;/a&gt;&#160;To summarize, the error messages you see are not something critical. Those errors happens when a worker thread (under the hood, it&apos;s TProcessor which is doing the work) tries to read from a closed InputStream, and it is most likely because the underlying connection is closed by its peer (client). This is also what &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=osayankin&quot; class=&quot;user-hover&quot; rel=&quot;osayankin&quot;&gt;osayankin&lt;/a&gt;&#160;witnessed.&lt;/p&gt;

&lt;p&gt;This error is late caught by the worker thread and logged as an ERROR message, so nothing harmful in the end. It&apos;s just the error message is meaningless and makes noises for people maintaining the service.&lt;/p&gt;

&lt;p&gt;I propose a PR to address this by giving an explicit message to the error to avoid confusion.&lt;/p&gt;</comment>
                            <comment id="16934316" author="nsuke" created="Fri, 20 Sep 2019 11:47:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=q.xu&quot; class=&quot;user-hover&quot; rel=&quot;q.xu&quot;&gt;q.xu&lt;/a&gt;&#160;please take a look at the actual changes in the associated PRs for these tickets. They changed how TTransportException are handled in&#160;TThreadPoolServer.&lt;/p&gt;</comment>
                            <comment id="16934777" author="q.xu" created="Fri, 20 Sep 2019 21:35:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nsuke&quot; class=&quot;user-hover&quot; rel=&quot;nsuke&quot;&gt;nsuke&lt;/a&gt; Indeed, it seems the PR&#160;should have filtered out this error in the case of `TThreadPoolServer`. Thanks for the hint!&lt;/p&gt;

&lt;p&gt;The PR () is quite straightforward, and it simply drops out some types of error messages for the&#160;`TThreadPoolServer`. But I have some concerns regarding to this:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;It fixes only&#160;`TThreadPoolServer`, which means when we got such error (EOF) in other server implementations, in logs we will still see such incomprehensible messages&lt;/li&gt;
	&lt;li&gt;In the case of `TThreadPoolServer`, I&apos;m not quite confortable with the idea of dropping errors silently. This makes troubleshootings difficult in some cases, what if there is some unexpected socket disconnection&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Do you think we should address these points in this ticket? Or would it better to create a new one?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="12955214">THRIFT-3769</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13247231">ZEPPELIN-4279</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13216113">THRIFT-4805</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 8 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z02dt4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>