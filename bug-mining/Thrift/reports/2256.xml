<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:34:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-5733] Building code with circular `include`s can result in tons of memory usage and eventual segfault</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-5733</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;If I try to build the following thrift code, it pretty quickly segfaults:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;setup:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ cat foo.thrift
include &lt;span class=&quot;code-quote&quot;&gt;&quot;bar.thrift&quot;&lt;/span&gt;
$ cat bar.thrift
include &lt;span class=&quot;code-quote&quot;&gt;&quot;foo.thrift&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;b&gt;build:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ thrift --allow-64bit-consts --gen py:slots foo.thrift
[2] 210654 segmentation fault (core dumped) thrift --allow-64bit-consts --gen py:slots foo.thrift&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Not very user friendly error message I&apos;ve ever received &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;, but pretty must just a cosmetic issue (maybe there&apos;s a buffer overflow somewhere and some potential security exploit to worry about if you&apos;re compiling untrusted thrift code, but I personally never do that, so it doesn&apos;t stress me out).&lt;/p&gt;

&lt;p&gt;However, if you add a 3rd file to the mix, things can get &lt;em&gt;really weird&lt;/em&gt;. If I try to build the following code, it&apos;ll suck up all 32 GiB of RAM on my machine and render my computer completely unusable. If you reduce the number of entries in &lt;tt&gt;LargeEnum&lt;/tt&gt;, you can get the thrift compiler to use a ton of RAM before it finally segfaults as in the first example. I&apos;ve attached a screenshot so you can see how RAM and CPU gets used on my machine while attempting to build the above code.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;problematic code:&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ cat foo.thrift
include &lt;span class=&quot;code-quote&quot;&gt;&quot;bar.thrift&quot;&lt;/span&gt;
$ cat bar.thrift
include &lt;span class=&quot;code-quote&quot;&gt;&quot;large-&lt;span class=&quot;code-keyword&quot;&gt;enum&lt;/span&gt;.thrift&quot;&lt;/span&gt;
include &lt;span class=&quot;code-quote&quot;&gt;&quot;foo.thrift&quot;&lt;/span&gt;
$ cat large-&lt;span class=&quot;code-keyword&quot;&gt;enum&lt;/span&gt;.thrift
&lt;span class=&quot;code-keyword&quot;&gt;enum&lt;/span&gt; LargeEnum {
&#160; &#160; FOO0 = 0,
&#160; &#160; FOO1 = 1,
&#160; &#160; ... [FOO2 through FOO1998] ...
&#160; &#160; FOO1999 = 1999,
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I&apos;ve also put together a simple repro on &lt;a href=&quot;https://github.com/jfly/2023-09-01-thrift-circular-import&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jfly/2023-09-01-thrift-circular-import&lt;/a&gt; which can autogenerate the 3 files described above. (Just be careful when running it that you kill it before it soaks up all of your ram!)&lt;/p&gt;

&lt;p&gt;Yesterday, this explosive use of RAM brought our company&apos;s build server (with 128 GiB of RAM!) to its knees. We spent a lot of time flailing around before we finally tracked it down to one problematic PR that introduced a circular include.&lt;/p&gt;</description>
                <environment>&lt;p&gt;I&apos;m on Linux, but this also happens to my coworkers on macOS.&lt;/p&gt;</environment>
        <key id="13549474">THRIFT-5733</key>
            <summary>Building code with circular `include`s can result in tons of memory usage and eventual segfault</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jensg">Jens Geyer</assignee>
                                    <reporter username="jfly">Jeremy Fleischman</reporter>
                        <labels>
                    </labels>
                <created>Sat, 2 Sep 2023 19:05:49 +0000</created>
                <updated>Fri, 22 Mar 2024 23:06:24 +0000</updated>
                            <resolved>Sun, 3 Sep 2023 08:55:49 +0000</resolved>
                                    <version>0.18.1</version>
                                    <fixVersion>0.20.0</fixVersion>
                                    <component>Compiler (General)</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17761495" author="jensg" created="Sat, 2 Sep 2023 19:50:37 +0000"  >&lt;p&gt;&lt;blockquote&gt;&lt;p&gt;things can get &lt;em&gt;really weird&lt;/em&gt;. &lt;/p&gt;&lt;/blockquote&gt; because ...&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17761496" author="JIRAUSER302089" created="Sat, 2 Sep 2023 20:00:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jensg&quot; class=&quot;user-hover&quot; rel=&quot;jensg&quot;&gt;jensg&lt;/a&gt;, I don&apos;t know why this is happening, I haven&apos;t dug into the thrift source code to try to understand.&lt;/p&gt;

&lt;p&gt;Or maybe you were asking about &lt;em&gt;what&lt;/em&gt; exactly is weird? I just reworded my original post to hopefully be clearer about the behavior I&apos;m seeing.&lt;/p&gt;</comment>
                            <comment id="17761499" author="jensg" created="Sat, 2 Sep 2023 20:55:58 +0000"  >&lt;p&gt;testcase see attachment, run with e.g. &lt;b&gt;thrift -r -gen java .\test.thrift&lt;/b&gt;&lt;/p&gt;</comment>
                            <comment id="17761500" author="jensg" created="Sat, 2 Sep 2023 22:03:34 +0000"  >&lt;p&gt;Feel free to test with the patch. If there are no objections I&apos;m going to merge it.&lt;/p&gt;</comment>
                            <comment id="17761501" author="JIRAUSER302089" created="Sat, 2 Sep 2023 22:14:49 +0000"  >&lt;p&gt;&amp;gt; testcase see attachment, run with e.g.&#160;&lt;b&gt;thrift -r -gen java .\test.thrift&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Is this the right command to run? When I try to run this with the attachment, I get this error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ thrift -r -gen java .\test.thrift
[FAILURE:arguments:1] Could not open input file with realpath: .test.thrift &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If I change this to reference a file that actually exists, it compiles quickly and without error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ time thrift -r -gen java test.thrift
real &#160; &#160;0.01s
user &#160; &#160;0.00s
sys &#160; &#160;0.00s
$ echo $?
0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&amp;gt; Feel free to test with the patch&lt;/p&gt;

&lt;p&gt;What patch? I&apos;d be happy to test this out if you show me where it is.&lt;/p&gt;</comment>
                            <comment id="17761509" author="jensg" created="Sat, 2 Sep 2023 23:58:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/thrift/pull/2851&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/2851&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;thrift -r -gen java test.thrift&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Apropos: The Link above is somehow broken. Copypasta works, click does not.&lt;/p&gt;</comment>
                            <comment id="17761511" author="JIRAUSER302089" created="Sun, 3 Sep 2023 01:36:43 +0000"  >&lt;p&gt;Sorry about the broken link, it&apos;s fixed now (I &lt;b&gt;really&lt;/b&gt; don&apos;t understand Jira&apos;s text editor).&lt;/p&gt;

&lt;p&gt;&amp;gt;&#160;thrift -r -gen java test.thrift&lt;/p&gt;

&lt;p&gt;Yes, I did try this command with your testcase, and it ran quickly and without error (see my message above).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13062672" name="2023-09-01_16-30-26_pattern.png" size="76086" author="jfly" created="Sat, 2 Sep 2023 19:00:11 +0000"/>
                            <attachment id="13062675" name="testcase.zip" size="994" author="jensg" created="Sat, 2 Sep 2023 20:55:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 10 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1k5ig:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>