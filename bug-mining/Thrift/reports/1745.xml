<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:26:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-4164] Core in TSSLSocket cleanupOpenSSL when destroying a mutex used by openssl</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-4164</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;In a project where thrift is used, i was investigating a core in an assertion in apache::thrift::concurrency::~Mutex (pthread variety).  The mutex in question was one of the locking mutexes that thrift gives to openssl.  The core occurred in TSSLSocket::cleanupOpenSSL() where the mutexes are destroyed (on the last line).&lt;/p&gt;

&lt;p&gt;I suspect that we might be changing the locking callbacks too early in the cleanup process; perhaps one of the other cleanup calls that follows it would have released a mutex in some situations?  In any case, this needs to be investigated and I am assigning it to myself.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Ubuntu 14.04, openssl (version 1.0.2k)&lt;/p&gt;</environment>
        <key id="13061135">THRIFT-4164</key>
            <summary>Core in TSSLSocket cleanupOpenSSL when destroying a mutex used by openssl</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jking3">James E. King III</assignee>
                                    <reporter username="jking3">James E. King III</reporter>
                        <labels>
                            <label>breaking_change</label>
                    </labels>
                <created>Mon, 3 Apr 2017 14:24:40 +0000</created>
                <updated>Thu, 14 Dec 2017 13:55:39 +0000</updated>
                            <resolved>Tue, 4 Apr 2017 13:37:13 +0000</resolved>
                                    <version>0.10.0</version>
                                    <fixVersion>0.11.0</fixVersion>
                                    <component>C++ - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15953686" author="githubbot" created="Mon, 3 Apr 2017 15:45:52 +0000"  >&lt;p&gt;GitHub user jeking3 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1235&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1235&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4164&quot; title=&quot;Core in TSSLSocket cleanupOpenSSL when destroying a mutex used by openssl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4164&quot;&gt;&lt;del&gt;THRIFT-4164&lt;/del&gt;&lt;/a&gt;: update openssl cleanup to match current requirements&lt;/p&gt;

&lt;p&gt;    Ran ctest -T MemCheck which runs all tests through valgrind and all passed.  Manually inspected the TInterruptTest which includes TSSLInterruptTest and runs the initialize and cleanup methods running valgrind interactively and no issues (and no leaks).&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jeking3/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jeking3/thrift&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4164&quot; title=&quot;Core in TSSLSocket cleanupOpenSSL when destroying a mutex used by openssl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4164&quot;&gt;&lt;del&gt;THRIFT-4164&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1235.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1235.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1235&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit aa18ccaaf472b06617a104f2cdbb9674e9c2bae5&lt;br/&gt;
Author: James E. King, III &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2017-04-03T15:43:54Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4164&quot; title=&quot;Core in TSSLSocket cleanupOpenSSL when destroying a mutex used by openssl&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4164&quot;&gt;&lt;del&gt;THRIFT-4164&lt;/del&gt;&lt;/a&gt;: update openssl cleanup to match current requirements&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15954145" author="jking3" created="Mon, 3 Apr 2017 20:45:18 +0000"  >&lt;p&gt;In the pull request where the first four builds failed with cores, I was able to reproduce it locally as well.  It is very interesting.  We were resetting the openssl thread safety/locking callbacks to NULL as part of destruction of the last TSSLSocketFactory instance.  In the test, we hold on to this socket factory through the test and then it gets destroyed:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;(gdb) bt
#0  apache::thrift::transport::cleanupOpenSSL () at src/thrift/transport/TSSLSocket.cpp:137
#1  0x00007ffff7fa10a5 in apache::thrift::transport::TSSLSocketFactory::~TSSLSocketFactory (this=0x48d6c0, __in_chrg=&amp;lt;optimized out&amp;gt;) at src/thrift/transport/TSSLSocket.cpp:696
#2  0x00007ffff7fa1199 in apache::thrift::transport::TSSLSocketFactory::~TSSLSocketFactory (this=0x48d6c0, __in_chrg=&amp;lt;optimized out&amp;gt;) at src/thrift/transport/TSSLSocket.cpp:698
#3  0x0000000000417d6a in boost::detail::sp_counted_base::release (this=0x4a95c0) at /usr/include/boost/smart_ptr/detail/sp_counted_base_gcc_x86.hpp:146
#4  0x0000000000414407 in release (this=0x4a95c0) at /usr/include/boost/smart_ptr/detail/sp_counted_base_gcc_x86.hpp:144
#5  ~shared_count (this=&amp;lt;synthetic pointer&amp;gt;, __in_chrg=&amp;lt;optimized out&amp;gt;) at /usr/include/boost/smart_ptr/detail/shared_count.hpp:371
#6  ~shared_ptr (this=&amp;lt;synthetic pointer&amp;gt;, __in_chrg=&amp;lt;optimized out&amp;gt;) at /usr/include/boost/smart_ptr/shared_ptr.hpp:328
#7  main (argc=&amp;lt;optimized out&amp;gt;, argv=&amp;lt;optimized out&amp;gt;) at src/TestClient.cpp:235
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Then later on in the test, we close a TSSLSocket that the factory created:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;(gdb) bt
#0  0x00007ffff6c56cc9 in __GI_raise (sig=sig@entry=6) at ../nptl/sysdeps/unix/sysv/linux/raise.c:56
#1  0x00007ffff6c5a0d8 in __GI_abort () at abort.c:89
#2  0x00007ffff6c4fb86 in __assert_fail_base (fmt=0x7ffff6da0830 &quot;%s%s%s:%u: %s%sAssertion `%s&apos; failed.\n%n&quot;, assertion=assertion@entry=0x7ffff7fcf106 &quot;px != 0&quot;, file=file@entry=0x7ffff7fd1400 &quot;/usr/include/boost/smart_ptr/shared_array.hpp&quot;, line=line@entry=194, 
    function=function@entry=0x7ffff7fd5fa0 &amp;lt;boost::shared_array&amp;lt;apache::thrift::concurrency::Mutex&amp;gt;::operator[](long) const::__PRETTY_FUNCTION__&amp;gt; &quot;T&amp;amp; boost::shared_array&amp;lt;T&amp;gt;::operator[](std::ptrdiff_t) const [with T = apache::thrift::concurrency::Mutex; std::ptrdiff_t = long int]&quot;) at assert.c:92
#3  0x00007ffff6c4fc32 in __GI___assert_fail (assertion=assertion@entry=0x7ffff7fcf106 &quot;px != 0&quot;, file=file@entry=0x7ffff7fd1400 &quot;/usr/include/boost/smart_ptr/shared_array.hpp&quot;, line=line@entry=194, 
    function=function@entry=0x7ffff7fd5fa0 &amp;lt;boost::shared_array&amp;lt;apache::thrift::concurrency::Mutex&amp;gt;::operator[](long) const::__PRETTY_FUNCTION__&amp;gt; &quot;T&amp;amp; boost::shared_array&amp;lt;T&amp;gt;::operator[](std::ptrdiff_t) const [with T = apache::thrift::concurrency::Mutex; std::ptrdiff_t = long int]&quot;) at assert.c:101
#4  0x00007ffff7fa039d in operator[] (this=&amp;lt;optimized out&amp;gt;, i=&amp;lt;optimized out&amp;gt;) at /usr/include/boost/smart_ptr/shared_array.hpp:194
#5  apache::thrift::transport::callbackLocking (mode=&amp;lt;optimized out&amp;gt;, n=&amp;lt;optimized out&amp;gt;) at src/thrift/transport/TSSLSocket.cpp:73
#6  0x00007ffff6644877 in CRYPTO_add_lock (pointer=0x4a8894, amount=-1, type=12, file=0x7ffff6a08c4a &quot;ssl_lib.c&quot;, line=1944) at cryptlib.c:632
#7  0x00007ffff69f840c in SSL_CTX_free (a=0x4a8800) at ssl_lib.c:1944
#8  0x00007ffff7fa0209 in apache::thrift::transport::SSLContext::~SSLContext (this=0x4a85c0, __in_chrg=&amp;lt;optimized out&amp;gt;) at src/thrift/transport/TSSLSocket.cpp:199
#9  0x00007ffff7fa5832 in release (this=0x4a95a0) at /usr/include/boost/smart_ptr/detail/sp_counted_base_gcc_x86.hpp:146
#10 ~shared_count (this=0x4a9f20, __in_chrg=&amp;lt;optimized out&amp;gt;) at /usr/include/boost/smart_ptr/detail/shared_count.hpp:371
#11 ~shared_ptr (this=0x4a9f18, __in_chrg=&amp;lt;optimized out&amp;gt;) at /usr/include/boost/smart_ptr/shared_ptr.hpp:328
#12 apache::thrift::transport::TSSLSocket::~TSSLSocket (this=0x4a9e80, __in_chrg=&amp;lt;optimized out&amp;gt;) at src/thrift/transport/TSSLSocket.cpp:238
#13 0x00007ffff7fa58a9 in apache::thrift::transport::TSSLSocket::~TSSLSocket (this=0x4a9e80, __in_chrg=&amp;lt;optimized out&amp;gt;) at src/thrift/transport/TSSLSocket.cpp:240
#14 0x00007ffff7fad03a in release (this=0x4a9f40) at /usr/include/boost/smart_ptr/detail/sp_counted_base_gcc_x86.hpp:146
#15 ~shared_count (this=0x4ad640, __in_chrg=&amp;lt;optimized out&amp;gt;) at /usr/include/boost/smart_ptr/detail/shared_count.hpp:371
#16 ~shared_ptr (this=0x4ad638, __in_chrg=&amp;lt;optimized out&amp;gt;) at /usr/include/boost/smart_ptr/shared_ptr.hpp:328
#17 ~TBufferedTransport (this=0x4ad610, __in_chrg=&amp;lt;optimized out&amp;gt;) at ./src/thrift/transport/TBufferTransports.h:184
#18 apache::thrift::transport::TBufferedTransport::~TBufferedTransport (this=0x4ad610, __in_chrg=&amp;lt;optimized out&amp;gt;) at ./src/thrift/transport/TBufferTransports.h:184
#19 0x0000000000417d6a in boost::detail::sp_counted_base::release (this=0x4ae910) at /usr/include/boost/smart_ptr/detail/sp_counted_base_gcc_x86.hpp:146
#20 0x000000000041446f in release (this=&amp;lt;optimized out&amp;gt;) at /usr/include/boost/smart_ptr/detail/sp_counted_base_gcc_x86.hpp:144
#21 ~shared_count (this=0x7fffffffdc98, __in_chrg=&amp;lt;optimized out&amp;gt;) at /usr/include/boost/smart_ptr/detail/shared_count.hpp:371
#22 ~shared_ptr (this=0x7fffffffdc90, __in_chrg=&amp;lt;optimized out&amp;gt;) at /usr/include/boost/smart_ptr/shared_ptr.hpp:328
#23 main (argc=&amp;lt;optimized out&amp;gt;, argv=&amp;lt;optimized out&amp;gt;) at src/TestClient.cpp:231
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;At this point where we destroy the TSSLSocket, which calls into SSL_CTX_free, which wants to use one of the locks to be threadsafe, it cannot use the lock because we destroyed it already when the TSSLSocketFactory was destroyed.  We need to guarantee the lifetime of the TSSLSocketFactory outlives any TSSLSocket that it makes, since destruction of the last TSSLSocketFactory causes an openssl teardown.&lt;/p&gt;</comment>
                            <comment id="15954194" author="jking3" created="Mon, 3 Apr 2017 21:39:55 +0000"  >&lt;p&gt;PR #1235 exposed the fact that before that PR, we were quietly stopping openssl from using the locking callbacks we were providing.  This would lead to unsafe multi-thread behavior during shutdown.  &lt;/p&gt;

&lt;p&gt;I looked at guaranteeing this in core: I noodled through it and the solutions were all a bit ugly, involving the factory to keep a smart pointer of each socket it made, and a callback from TSSLSocket::close() to the factory to take it out of a set of sockets it had made.  Then in ~TSSLSocketFactory we would need to guarantee the set of sockets left in the factory were the last instance (nobody else was holding onto them as well) so we could guarantee that when the set of sockets is reset, all the sockets the factory ever made were released.Then the factory could clean up openssl safely.&lt;/p&gt;

&lt;p&gt;OR, we clearly document the requirement that a factory must outlive any sockets it makes.  This is what I&apos;m going to do, so will revise the PR to fix our own TestClient.cpp which was in violation of the requirement that a TSSLSocketFactory must outlive any TSSLSocket it creates when the TSSLSocketFactory is managing openssl initialization and destruction, which was causing the build failures.&lt;/p&gt;</comment>
                            <comment id="15955145" author="githubbot" created="Tue, 4 Apr 2017 13:40:46 +0000"  >&lt;p&gt;Github user jeking3 closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1235&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1235&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 33 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3d4u7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>