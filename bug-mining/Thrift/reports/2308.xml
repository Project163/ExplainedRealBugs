<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:35:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-5322] Go compact_protocol allocating unreasonable buffer size</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-5322</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;I don&apos;t yet know all the pieces to this puzzle, and it&apos;s quite possible that the problem is on our side, but we use the Thrift Go library in the Jaeger Agent and we are seeing a case where the memory consumption for a payload of 4k bytes to result in a buffer allocation in the compact_protocol.go with unreasonable sizes. I found buffers of 1.4GiB while debugging the issue.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This is the code that we are seeing this memory usage:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/thrift/blob/b75e88a33d67ae05ef9b5fa001d2a63a2effe377/lib/go/thrift/compact_protocol.go#L556-L577&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/blob/b75e88a33d67ae05ef9b5fa001d2a63a2effe377/lib/go/thrift/compact_protocol.go#L556-L577&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Here&apos;s more information about this, including a reproducer and initial diagnostics:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/jaegertracing/jaeger/issues/2638#issuecomment-741848201&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jaegertracing/jaeger/issues/2638#issuecomment-741848201&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;As mentioned above, I&apos;m still getting all the pieces together, but perhaps you&apos;ve seen this before or know what might be going on. What I know for sure at the moment is that this happens on malformed payloads, but I would expect the library to have an upper limit on the buffer size.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13345298">THRIFT-5322</key>
            <summary>Go compact_protocol allocating unreasonable buffer size</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="fishywang">Yuxuan Wang</assignee>
                                    <reporter username="jpkroehling">Juraci Paix&#227;o Kr&#246;hling</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Dec 2020 13:16:12 +0000</created>
                <updated>Fri, 26 Mar 2021 00:17:34 +0000</updated>
                            <resolved>Fri, 26 Mar 2021 00:17:34 +0000</resolved>
                                    <version>0.13.0</version>
                                    <fixVersion>0.14.0</fixVersion>
                                    <component>Go - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="12000">3h 20m</timespent>
                                <comments>
                            <comment id="17247254" author="calcifer" created="Thu, 10 Dec 2020 13:59:17 +0000"  >&lt;p&gt;Buffer size limits have been implemented&#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; for a number of languages in the aftermath of CVE-2019-11939 &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; but nobody has done so for Go yet. PRs are very welcome.&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; Java example: &lt;a href=&quot;https://github.com/apache/thrift/pull/2191&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/2191&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://nvd.nist.gov/vuln/detail/CVE-2019-11939&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://nvd.nist.gov/vuln/detail/CVE-2019-11939&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17247309" author="jpkroehling" created="Thu, 10 Dec 2020 15:28:21 +0000"  >&lt;p&gt;I&apos;m not quite sure the problem is in the message size: the message itself is under 5k in size, but due to the fact that the message is malformed, the buffer size at that method becomes huge. I still couldn&apos;t come up with a valid explanation for it, and I can&apos;t check what gets parsed as a result as there&apos;s only one field that results in this huge memory usage and I get an EOF instead of getting a call to my handler.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The attached source file can be used to reproduce the problem. Some times, the memory consumption in the &quot;after&quot; phase is 400MiB, sometimes it&apos;s ~800MiB.&lt;/p&gt;</comment>
                            <comment id="17247324" author="fishywang" created="Thu, 10 Dec 2020 15:43:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jpkroehling&quot; class=&quot;user-hover&quot; rel=&quot;jpkroehling&quot;&gt;jpkroehling&lt;/a&gt; If it&apos;s indeed from ReadString function, and the message is indeed malformed, then this is expected (from the current implementation) as for ReadString, it basically first read the length of the string and then allocate that many bytes and read the full string into the memory. Since the message is malformed, it&apos;s likely that the string length it reads in is unreasonably large.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcelasun&quot; class=&quot;user-hover&quot; rel=&quot;dcelasun&quot;&gt;dcelasun&lt;/a&gt; please correct me if I&apos;m wrong but I don&apos;t think there&apos;s max string length defined anywhere in the spec. I guess I can just use the same limit we use for framed transportations for strings, as a single string certainly cannot be larger than the whole message.&lt;/p&gt;</comment>
                            <comment id="17247325" author="jpkroehling" created="Thu, 10 Dec 2020 15:50:21 +0000"  >&lt;p&gt;There really needs to be an upper bound to what&apos;s &quot;acceptable&quot;. If I&apos;m reading this correctly, the current situation opens a window for a DoS attack, in that a malicious client would just send malformed messages to a Thrift Compact processor and make it use GiB&apos;s of junk data in memory. It&apos;s not that critical in our case, as the Jaeger Agent is supposed to be serving only local applications, so, the surface attack is minimal, but I suspect other folks might have Thrift Compact services exposed to the public internet out there.&lt;/p&gt;</comment>
                            <comment id="17247328" author="fishywang" created="Thu, 10 Dec 2020 15:54:46 +0000"  >&lt;p&gt;yes I agree. I&apos;m just trying to figure out an appropriate limit to use that&apos;s in comply with the spec. &lt;/p&gt;</comment>
                            <comment id="17247334" author="jpkroehling" created="Thu, 10 Dec 2020 16:06:40 +0000"  >&lt;p&gt;Is there a way to determine whether the message is malformed in the first place? Perhaps a check could be done early on and just return an error in that case.&lt;/p&gt;</comment>
                            <comment id="17247459" author="shkuro" created="Thu, 10 Dec 2020 19:44:37 +0000"  >&lt;p&gt;The actual message size would be a reasonable upper bound on any internal data element of that message. If the string allocation didn&apos;t panic/OOM then the malformness of the message would probably be discovered on reading the following elements.&lt;/p&gt;</comment>
                            <comment id="17247466" author="fishywang" created="Thu, 10 Dec 2020 19:53:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Shkuro&quot; class=&quot;user-hover&quot; rel=&quot;Shkuro&quot;&gt;Shkuro&lt;/a&gt; TProtocol doesn&apos;t have the knowledge of the actual message size. If the underlying transport is actually framed (either TFramedTransport or framed THeaderTransport) then it could be get there, but that&apos;s not always the case, and when it&apos;s framed it could be wrapped by other TTransport to make it inaccessible.&lt;/p&gt;

&lt;p&gt;I&apos;ll just follow java&apos;s and python&apos;s example of allowing manually set of the length limit on the TProtocol implementations.&lt;/p&gt;</comment>
                            <comment id="17247479" author="shkuro" created="Thu, 10 Dec 2020 20:03:19 +0000"  >&lt;p&gt;Yeah, that would work fine, at least for us, as we know the message size upfront&lt;/p&gt;</comment>
                            <comment id="17247517" author="fishywang" created="Thu, 10 Dec 2020 21:23:39 +0000"  >&lt;p&gt;Actually scratch that. We already have a good implementation &lt;a href=&quot;https://github.com/apache/thrift/blob/70792f2191e5e7345bf08f766638e166d5937f32/lib/go/thrift/binary_protocol.go#L482-L516&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;in go&apos;s TBinaryProtocol to protect against insanely large string sizes&lt;/a&gt;. I&apos;ll just copy that into TCompactProtocol.&lt;/p&gt;</comment>
                            <comment id="17247548" author="fishywang" created="Thu, 10 Dec 2020 22:51:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Shkuro&quot; class=&quot;user-hover&quot; rel=&quot;Shkuro&quot;&gt;Shkuro&lt;/a&gt; &amp;amp; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jpkroehling&quot; class=&quot;user-hover&quot; rel=&quot;jpkroehling&quot;&gt;jpkroehling&lt;/a&gt;: please take a look at &lt;a href=&quot;https://github.com/apache/thrift/pull/2292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/2292&lt;/a&gt; and provide feedback.&lt;/p&gt;</comment>
                            <comment id="17248183" author="jensg" created="Fri, 11 Dec 2020 21:11:52 +0000"  >&lt;p&gt;I would like to bring into the discussion the general concepts documented in &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-5021&quot; title=&quot;Implement MAX_MESSAGE_SIZE and consolidate limits into a TConfiguration class&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-5021&quot;&gt;&lt;del&gt;THRIFT-5021&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-5027&quot; title=&quot;Implement remaining read bytes checks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-5027&quot;&gt;&lt;del&gt;THRIFT-5027&lt;/del&gt;&lt;/a&gt; and last not least &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-5037&quot; title=&quot;Documentation for TConfiguration&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-5037&quot;&gt;&lt;del&gt;THRIFT-5037&lt;/del&gt;&lt;/a&gt;. One of the goals is a more general version of what you are trying to achieve for string and binary. The other goal is to consolidate the various limits scattered through the codebase into one, configurable place.&lt;/p&gt;</comment>
                            <comment id="17248227" author="fishywang" created="Fri, 11 Dec 2020 22:35:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jensg&quot; class=&quot;user-hover&quot; rel=&quot;jensg&quot;&gt;jensg&lt;/a&gt; Thanks for the pointer. I did not know that TConfiguration is in the spec. This will actually suit the go implementation better than the string length limit and container length limit currently implemented in Java and python, which was the first approach I tried in the go fix. I discarded that approach because of the zero value feature in go will make it either a breaking change or behave differently from existing Java/python implementations.&lt;/p&gt;

&lt;p&gt;But I do not think implementing TConfiguration in go is required to fix this issue. The current fix &lt;a href=&quot;https://github.com/apache/thrift/pull/2292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;#2292&lt;/a&gt; fixes the issue in a way that no additional limit is needed, we just avoid doing the whole allocation up front. Implementing TConfiguration can be added on top of that, either by create a new ticket or reuse this ticket.&lt;/p&gt;</comment>
                            <comment id="17248546" author="jensg" created="Sun, 13 Dec 2020 10:00:47 +0000"  >&lt;blockquote&gt;
&lt;p&gt;But I do not think implementing TConfiguration in go is required to fix this issue&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;You are absolutely right, its not needed to fix the ssue at hand. &lt;/p&gt;

&lt;p&gt;My primary goal was to make you aware of a) what we already have implemented to prevent people from doing double work and b) that the problem might be slightly bigger than the actual issue suggests. Because we also have lists/sets/maps where memory effectively is allocated based on the number of elements which also imply a certain minimum amount of data that has to follow - same as with binary/strings.&lt;/p&gt;

&lt;p&gt;Last not least, TConfiguration is merely an attempt to consolidate and (wherevere necessary) standardize the defaults of all of those limits we have accumulated during the years and make them configurable in a standardized way for all target languages. So technically it does not solve a thing w/regard to this ticket at all. Nevertheless it seems a good thing to have for the future.&lt;/p&gt;</comment>
                            <comment id="17250506" author="fishywang" created="Wed, 16 Dec 2020 18:02:11 +0000"  >&lt;p&gt;The reported issue is fixed on master with the merge of &lt;a href=&quot;https://github.com/apache/thrift/commit/37c2ceb737cb40377346c63a05f407da1c119ba0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/commit/37c2ceb737cb40377346c63a05f407da1c119ba0&lt;/a&gt;. I&apos;m keeping this issue open to track the work of adding TConfiguration support to go library.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13271098">THRIFT-5037</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13016867" name="main.go" size="12410" author="jpkroehling" created="Thu, 10 Dec 2020 16:43:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 47 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0le1s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>