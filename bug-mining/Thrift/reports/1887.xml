<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:28:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-4373] Extending Thrift class results in &quot;Attempt serialize from non-Thrift object&quot;</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-4373</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;This happens when using php extension. thrift_protocol_write_binary will check Z_TYPE_P of spec and expects to be array (IS_ARRAY). However, PHP7 will set it as reference (IS_REFERENCE).&lt;/p&gt;

&lt;p&gt;Example:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$s = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Serializer\TBinarySerializer();

&lt;span class=&quot;code-comment&quot;&gt;// Foo is a Thrift type class
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;FooExtended &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Foo {}

$o = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Foo();
$o2 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; FooExtended();

&lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; works just fine:
&lt;/span&gt;$s-&amp;gt;serialize($o); &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; uses thrift_protocol_write_binary &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; available
&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;// Next line &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; \Thrift\Exception\TProtocolException &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; thrift_protocol_write_binary is used
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// However, it doesn&apos;t &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; no extension is available.
&lt;/span&gt;$s-&amp;gt;serialize($o);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Proposed solution is to dereference using ZVAL_DEREF before checking types (attached). Alternative would be to mark struct type classes as final, but that break compatibility.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux 4.13.3-1-ARCH&lt;br/&gt;
PHP 7.1.10&lt;/p&gt;</environment>
        <key id="13112090">THRIFT-4373</key>
            <summary>Extending Thrift class results in &quot;Attempt serialize from non-Thrift object&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jking3">James E. King III</assignee>
                                    <reporter username="sokac">Josip Sokcevic</reporter>
                        <labels>
                    </labels>
                <created>Wed, 25 Oct 2017 20:09:44 +0000</created>
                <updated>Thu, 27 Dec 2018 15:25:07 +0000</updated>
                            <resolved>Mon, 9 Apr 2018 12:47:58 +0000</resolved>
                                    <version>0.10.0</version>
                                    <fixVersion>0.12.0</fixVersion>
                                    <component>PHP - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16219452" author="githubbot" created="Wed, 25 Oct 2017 20:14:37 +0000"  >&lt;p&gt;GitHub user sokac opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1401&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1401&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4373&quot; title=&quot;Extending Thrift class results in &amp;quot;Attempt serialize from non-Thrift object&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4373&quot;&gt;&lt;del&gt;THRIFT-4373&lt;/del&gt;&lt;/a&gt;: Derefer PHP zval _TSPEC&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/sokac/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/sokac/thrift&lt;/a&gt; php&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1401.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1401.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1401&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit d6d493d0f0dcae2f892fe0f5ed99884689069e13&lt;br/&gt;
Author: Josip Sokcevic &amp;lt;jsokcevic@thumbtack.com&amp;gt;&lt;br/&gt;
Date:   2017-10-25T16:45:16Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4373&quot; title=&quot;Extending Thrift class results in &amp;quot;Attempt serialize from non-Thrift object&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4373&quot;&gt;&lt;del&gt;THRIFT-4373&lt;/del&gt;&lt;/a&gt;: Derefer PHP zval _TSPEC&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16220018" author="githubbot" created="Thu, 26 Oct 2017 06:14:23 +0000"  >&lt;p&gt;Github user RobberPhex commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1401#discussion_r147051880&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1401#discussion_r147051880&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/php/src/ext/thrift_protocol/php_thrift_protocol.cpp &amp;#8212;&lt;br/&gt;
    @@ -537,6 +537,9 @@ void binary_deserialize(int8_t thrift_typeID, PHPInputTransport&amp;amp; transport, zval&lt;br/&gt;
           }&lt;/p&gt;

&lt;p&gt;           zval* spec = zend_read_static_property(Z_OBJCE_P(return_value), &quot;_TSPEC&quot;, sizeof(&quot;_TSPEC&quot;)-1, false);&lt;br/&gt;
    +      if (spec) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    After `zend_read_static_property` with `slient=false`, we should detect exception.&lt;br/&gt;
    If no exception, we needn&apos;t detect spec is null.&lt;/p&gt;

&lt;p&gt;    but we need detect that `Z_TYPE_P(prop) == IS_REFERENCE`&lt;/p&gt;</comment>
                            <comment id="16220019" author="githubbot" created="Thu, 26 Oct 2017 06:14:23 +0000"  >&lt;p&gt;Github user RobberPhex commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1401#discussion_r147052024&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1401#discussion_r147052024&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/php/src/ext/thrift_protocol/php_thrift_protocol.cpp &amp;#8212;&lt;br/&gt;
    @@ -699,6 +702,9 @@ void binary_serialize_hashtable_key(int8_t keytype, PHPOutputTransport&amp;amp; transpor&lt;/p&gt;

&lt;p&gt;     static&lt;br/&gt;
     void binary_serialize(int8_t thrift_typeID, PHPOutputTransport&amp;amp; transport, zval* value, HashTable* fieldspec) {&lt;br/&gt;
    +  if (value) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    `Z_TYPE_P(prop) == IS_REFERENCE`&lt;/p&gt;</comment>
                            <comment id="16220020" author="githubbot" created="Thu, 26 Oct 2017 06:14:23 +0000"  >&lt;p&gt;Github user RobberPhex commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1401#discussion_r147052177&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1401#discussion_r147052177&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/php/src/ext/thrift_protocol/php_thrift_protocol.cpp &amp;#8212;&lt;br/&gt;
    @@ -709,6 +715,9 @@ void binary_serialize(int8_t thrift_typeID, PHPOutputTransport&amp;amp; transport, zval*&lt;br/&gt;
             throw_tprotocolexception(&quot;Attempt to send non-object type as a T_STRUCT&quot;, INVALID_DATA);&lt;br/&gt;
           }&lt;br/&gt;
           zval* spec = zend_read_static_property(Z_OBJCE_P(value), &quot;_TSPEC&quot;, sizeof(&quot;_TSPEC&quot;)-1, true);&lt;br/&gt;
    +      if (spec) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    I think `Z_TYPE_P(prop) == IS_REFERENCE`&lt;/p&gt;</comment>
                            <comment id="16220023" author="githubbot" created="Thu, 26 Oct 2017 06:15:54 +0000"  >&lt;p&gt;Github user RobberPhex commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1401&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1401&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    If we want process REFERENCE everywhere.&lt;br/&gt;
    I think we should review every line of `zval` used, is it?&lt;/p&gt;</comment>
                            <comment id="16221464" author="githubbot" created="Thu, 26 Oct 2017 23:46:00 +0000"  >&lt;p&gt;Github user sokac commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1401#discussion_r147295629&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1401#discussion_r147295629&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/php/src/ext/thrift_protocol/php_thrift_protocol.cpp &amp;#8212;&lt;br/&gt;
    @@ -537,6 +537,9 @@ void binary_deserialize(int8_t thrift_typeID, PHPInputTransport&amp;amp; transport, zval&lt;br/&gt;
           }&lt;/p&gt;

&lt;p&gt;           zval* spec = zend_read_static_property(Z_OBJCE_P(return_value), &quot;_TSPEC&quot;, sizeof(&quot;_TSPEC&quot;)-1, false);&lt;br/&gt;
    +      if (spec) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    ZVAL_DEREF checks is reference:&lt;br/&gt;
    &lt;a href=&quot;https://github.com/php/php-src/blob/ffc734b2a455e2f2748f18a54ab597f7e0c715ba/Zend/zend_types.h#L944&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/php/php-src/blob/ffc734b2a455e2f2748f18a54ab597f7e0c715ba/Zend/zend_types.h#L944&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I removed if statement &lt;/p&gt;</comment>
                            <comment id="16221465" author="githubbot" created="Thu, 26 Oct 2017 23:46:15 +0000"  >&lt;p&gt;Github user sokac commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1401#discussion_r147295660&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1401#discussion_r147295660&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/php/src/ext/thrift_protocol/php_thrift_protocol.cpp &amp;#8212;&lt;br/&gt;
    @@ -699,6 +702,9 @@ void binary_serialize_hashtable_key(int8_t keytype, PHPOutputTransport&amp;amp; transpor&lt;/p&gt;

&lt;p&gt;     static&lt;br/&gt;
     void binary_serialize(int8_t thrift_typeID, PHPOutputTransport&amp;amp; transport, zval* value, HashTable* fieldspec) {&lt;br/&gt;
    +  if (value) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    removed if statement&lt;/p&gt;</comment>
                            <comment id="16221466" author="githubbot" created="Thu, 26 Oct 2017 23:46:29 +0000"  >&lt;p&gt;Github user sokac commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1401#discussion_r147295690&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1401#discussion_r147295690&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/php/src/ext/thrift_protocol/php_thrift_protocol.cpp &amp;#8212;&lt;br/&gt;
    @@ -709,6 +715,9 @@ void binary_serialize(int8_t thrift_typeID, PHPOutputTransport&amp;amp; transport, zval*&lt;br/&gt;
             throw_tprotocolexception(&quot;Attempt to send non-object type as a T_STRUCT&quot;, INVALID_DATA);&lt;br/&gt;
           }&lt;br/&gt;
           zval* spec = zend_read_static_property(Z_OBJCE_P(value), &quot;_TSPEC&quot;, sizeof(&quot;_TSPEC&quot;)-1, true);&lt;br/&gt;
    +      if (spec) {&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    removed if statement&lt;/p&gt;</comment>
                            <comment id="16241241" author="githubbot" created="Tue, 7 Nov 2017 00:27:58 +0000"  >&lt;p&gt;Github user sokac commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1401&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1401&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @RobberPhex how does this look now? I don&apos;t have lots of context for other zval values so I&apos;d leave that for another review.&lt;/p&gt;</comment>
                            <comment id="16277464" author="githubbot" created="Mon, 4 Dec 2017 20:45:01 +0000"  >&lt;p&gt;Github user james-johnston-thumbtack commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1401&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1401&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @RobberPhex  Any word on getting this merged?  Using the extension in PHP 7.0 is kinda broken otherwise... this is fixing a common issue that affected many PHP extensions moving to PHP 7.0.&lt;/p&gt;</comment>
                            <comment id="16311418" author="githubbot" created="Thu, 4 Jan 2018 14:42:57 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1401&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1401&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Need to see if pass the CI build - please squash to a single commit, rebase on master, and force push.&lt;/p&gt;</comment>
                            <comment id="16311883" author="githubbot" created="Thu, 4 Jan 2018 19:16:54 +0000"  >&lt;p&gt;Github user sokac commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1401&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1401&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    @jeking3 squashed and rebased. Looks like CI has some troubles, though&lt;/p&gt;</comment>
                            <comment id="16430473" author="githubbot" created="Mon, 9 Apr 2018 12:47:50 +0000"  >&lt;p&gt;jeking3 closed pull request #1401: &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4373&quot; title=&quot;Extending Thrift class results in &amp;quot;Attempt serialize from non-Thrift object&amp;quot;&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4373&quot;&gt;&lt;del&gt;THRIFT-4373&lt;/del&gt;&lt;/a&gt;: Derefer PHP zval _TSPEC&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/thrift/pull/1401&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1401&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/lib/php/src/ext/thrift_protocol/php_thrift_protocol.cpp b/lib/php/src/ext/thrift_protocol/php_thrift_protocol.cpp&lt;br/&gt;
index 75ef2ec8f8..5ac557ffd7 100644&lt;br/&gt;
&amp;#8212; a/lib/php/src/ext/thrift_protocol/php_thrift_protocol.cpp&lt;br/&gt;
+++ b/lib/php/src/ext/thrift_protocol/php_thrift_protocol.cpp&lt;br/&gt;
@@ -537,6 +537,7 @@ void binary_deserialize(int8_t thrift_typeID, PHPInputTransport&amp;amp; transport, zval&lt;br/&gt;
       }&lt;/p&gt;

&lt;p&gt;       zval* spec = zend_read_static_property(Z_OBJCE_P(return_value), &quot;_TSPEC&quot;, sizeof(&quot;_TSPEC&quot;)-1, false);&lt;br/&gt;
+      ZVAL_DEREF(spec);&lt;br/&gt;
       if (EG(exception)) {&lt;br/&gt;
         zend_object *ex = EG(exception);&lt;br/&gt;
         EG(exception) = nullptr;&lt;br/&gt;
@@ -699,6 +700,9 @@ void binary_serialize_hashtable_key(int8_t keytype, PHPOutputTransport&amp;amp; transpor&lt;/p&gt;

&lt;p&gt; static&lt;br/&gt;
 void binary_serialize(int8_t thrift_typeID, PHPOutputTransport&amp;amp; transport, zval* value, HashTable* fieldspec) {&lt;br/&gt;
+  if (value) &lt;/p&gt;
{
+    ZVAL_DEREF(value);
+  }
&lt;p&gt;   // At this point the typeID (and field num, if applicable) should&apos;ve already been written to the output so all we need to do is write the payload.&lt;br/&gt;
   switch (thrift_typeID) &lt;/p&gt;
{
     case T_STOP:
@@ -709,6 +713,9 @@ void binary_serialize(int8_t thrift_typeID, PHPOutputTransport&amp;amp; transport, zval*
         throw_tprotocolexception(&quot;Attempt to send non-object type as a T_STRUCT&quot;, INVALID_DATA);
       }
&lt;p&gt;       zval* spec = zend_read_static_property(Z_OBJCE_P(value), &quot;_TSPEC&quot;, sizeof(&quot;_TSPEC&quot;)-1, true);&lt;br/&gt;
+      if (spec &amp;amp;&amp;amp; Z_TYPE_P(spec) == IS_REFERENCE) &lt;/p&gt;
{
+        ZVAL_DEREF(spec);
+      }
&lt;p&gt;       if (!spec || Z_TYPE_P(spec) != IS_ARRAY) &lt;/p&gt;
{
         throw_tprotocolexception(&quot;Attempt to send non-Thrift object as a T_STRUCT&quot;, INVALID_DATA);
       }
&lt;p&gt;@@ -893,7 +900,13 @@ static&lt;br/&gt;
 void validate_thrift_object(zval* object) {&lt;br/&gt;
     zend_class_entry* object_class_entry = Z_OBJCE_P(object);&lt;br/&gt;
     zval* is_validate = zend_read_static_property(object_class_entry, &quot;isValidate&quot;, sizeof(&quot;isValidate&quot;)-1, true);&lt;br/&gt;
+    if (is_validate) &lt;/p&gt;
{
+      ZVAL_DEREF(is_validate);
+    }
&lt;p&gt;     zval* spec = zend_read_static_property(object_class_entry, &quot;_TSPEC&quot;, sizeof(&quot;_TSPEC&quot;)-1, true);&lt;br/&gt;
+    if (spec) &lt;/p&gt;
{
+      ZVAL_DEREF(spec);
+    }&lt;br/&gt;
     HashPosition key_ptr;&lt;br/&gt;
     zval* val_ptr;&lt;br/&gt;
 &lt;br/&gt;
@@ -1027,6 +1040,9 @@ PHP_FUNCTION(thrift_protocol_write_binary) {&lt;br/&gt;
 &lt;br/&gt;
   try {&lt;br/&gt;
     zval* spec = zend_read_static_property(Z_OBJCE_P(request_struct), &quot;_TSPEC&quot;, sizeof(&quot;_TSPEC&quot;)-1, true);&lt;br/&gt;
+    if (spec) {+      ZVAL_DEREF(spec);+    }

&lt;p&gt;     if (!spec || Z_TYPE_P(spec) != IS_ARRAY) {&lt;br/&gt;
       throw_tprotocolexception(&quot;Attempt serialize from non-Thrift object&quot;, INVALID_DATA);&lt;br/&gt;
@@ -1091,6 +1107,7 @@ PHP_FUNCTION(thrift_protocol_read_binary) {&lt;br/&gt;
       zval ex;&lt;br/&gt;
       createObject(&quot;\\Thrift\\Exception&lt;br class=&quot;atl-forced-newline&quot; /&gt;TApplicationException&quot;, &amp;amp;ex);&lt;br/&gt;
       zval* spec = zend_read_static_property(Z_OBJCE(ex), &quot;_TSPEC&quot;, sizeof(&quot;_TPSEC&quot;)-1, false);&lt;br/&gt;
+      ZVAL_DEREF(spec);&lt;br/&gt;
       if (EG(exception)) {&lt;br/&gt;
         zend_object *ex = EG(exception);&lt;br/&gt;
         EG(exception) = nullptr;&lt;br/&gt;
@@ -1102,6 +1119,9 @@ PHP_FUNCTION(thrift_protocol_read_binary) {&lt;/p&gt;

&lt;p&gt;     createObject(ZSTR_VAL(obj_typename), return_value);&lt;br/&gt;
     zval* spec = zend_read_static_property(Z_OBJCE_P(return_value), &quot;_TSPEC&quot;, sizeof(&quot;_TSPEC&quot;)-1, true);&lt;br/&gt;
+    if (spec) &lt;/p&gt;
{
+      ZVAL_DEREF(spec);
+    }
&lt;p&gt;     if (!spec || Z_TYPE_P(spec) != IS_ARRAY) &lt;/p&gt;
{
       throw_tprotocolexception(&quot;Attempt deserialize to non-Thrift object&quot;, INVALID_DATA);
     }
&lt;p&gt;@@ -1135,6 +1155,7 @@ PHP_FUNCTION(thrift_protocol_read_binary_after_message_begin) &lt;/p&gt;
{
 
     createObject(ZSTR_VAL(obj_typename), return_value);
     zval* spec = zend_read_static_property(Z_OBJCE_P(return_value), &quot;_TSPEC&quot;, sizeof(&quot;_TSPEC&quot;)-1, false);
+    ZVAL_DEREF(spec);
     binary_deserialize_spec(return_value, transport, Z_ARRVAL_P(spec));
   }
&lt;p&gt; catch (const PHPExceptionWrapper&amp;amp; ex) {&lt;br/&gt;
     // ex will be destructed, so copy to a zval that zend_throw_exception_object can take ownership of&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12894022" name="0001-THRIFT-4373-Derefer-PHP-zval-_TSPEC.patch" size="3942" author="sokac" created="Wed, 25 Oct 2017 20:14:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 32 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3lpgn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>