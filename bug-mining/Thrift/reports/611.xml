<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:05:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-1632] ruby: data corruption in thrift_native implementation of MemoryBufferTransport</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-1632</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;Detected a failure when serializing, then deserializing a specific object&lt;br/&gt;
(I think the object needs to be large enough, AND probably must have non zero data at a specific offset)&lt;/p&gt;


&lt;p&gt;$ /usr/bin/thrift --gen rb test.thrift &amp;amp;&amp;amp; ruby test.rb &lt;br/&gt;
Caught Thrift::ProtocolException exception: Invalid value of field x1!&lt;br/&gt;
Trace:&lt;br/&gt;
  ./gen-rb/test_types.rb:34:in `validate&apos;&lt;br/&gt;
  test.rb:15:in `read&apos;&lt;br/&gt;
  test.rb:15&lt;/p&gt;</description>
                <environment>&lt;p&gt;Tested on Linux/Centos 6.0, with thrift_native.so installed&lt;/p&gt;</environment>
        <key id="12595195">THRIFT-1632</key>
            <summary>ruby: data corruption in thrift_native implementation of MemoryBufferTransport</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nhed">Nevo Hed</assignee>
                                    <reporter username="nhed">Nevo Hed</reporter>
                        <labels>
                            <label>newbie</label>
                            <label>patch</label>
                    </labels>
                <created>Wed, 20 Jun 2012 01:54:42 +0000</created>
                <updated>Fri, 29 Jun 2012 01:27:03 +0000</updated>
                            <resolved>Fri, 29 Jun 2012 00:21:58 +0000</resolved>
                                    <version>0.7</version>
                    <version>0.8</version>
                    <version>0.9</version>
                                    <fixVersion>0.9</fixVersion>
                                    <component>Ruby - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13397215" author="nhed" created="Wed, 20 Jun 2012 01:56:32 +0000"  >&lt;p&gt;Data definition used for test.rb&lt;/p&gt;</comment>
                            <comment id="13397217" author="nhed" created="Wed, 20 Jun 2012 02:07:45 +0000"  >&lt;p&gt;Test showing the failure&lt;/p&gt;

&lt;p&gt;/usr/bin/thrift --gen rb test.thrift&lt;br/&gt;
ruby test.rb&lt;br/&gt;
echo $?&lt;/p&gt;
</comment>
                            <comment id="13397220" author="nhed" created="Wed, 20 Jun 2012 02:13:50 +0000"  >&lt;p&gt;1) I confirmed this problem to &lt;br/&gt;
   occur with 0.8.0 &amp;amp; trunk from svn&lt;/p&gt;

&lt;p&gt;2) I also narrowed it down to &lt;br/&gt;
   rb_thrift_memory_buffer_read_into_buffer&lt;br/&gt;
   in lib/rb/ext/memory_buffer.c&lt;br/&gt;
   (disable binding this function and the&lt;br/&gt;
   test passes, i.e. the ruby&lt;br/&gt;
   implementation, rather than the &lt;br/&gt;
   native, is executed)&lt;/p&gt;

&lt;p&gt;3) without actually trying to understand&lt;br/&gt;
   the actual code, I noticed a difference&lt;br/&gt;
   between the ruby &amp;amp; C versions where the&lt;br/&gt;
   &quot;index&quot; vs &quot;GARBAGE_BUFFER_SIZE&quot;&lt;br/&gt;
   comparison (and what I assume is a&lt;br/&gt;
   flush) was outside of the loop in Ruby,&lt;br/&gt;
   and inside the loop in &quot;C&quot;.&lt;/p&gt;


&lt;p&gt;The attached patch makes the C side behave more like the well-behaving ruby side.  It moves the the above mentioned comparison after the loop.  Also note that I moved the  initialization of index outside of the loop to resolve a compiler warning.&lt;/p&gt;</comment>
                            <comment id="13397251" author="nhed" created="Wed, 20 Jun 2012 04:27:27 +0000"  >&lt;p&gt;Updated test.rb to also compare the original and the deserialized objects.  Also increased the number of hash elements for roubustness&lt;/p&gt;</comment>
                            <comment id="13403216" author="bryanduxbury" created="Thu, 28 Jun 2012 16:57:21 +0000"  >&lt;p&gt;After staring at this for a bit, I think I&apos;ve figured out the bug in this function and why your patch solves the issue.&lt;/p&gt;

&lt;p&gt;The way that this is supposed to work is that when we&apos;ve consumed enough of the memory buffer, we reallocate a new one without the used-up space in the front. This is intended to save memory. However, the issue is that when we decide to resize the buffer, we don&apos;t reassign the &quot;buf&quot; variable to the new buffer - we&apos;ve still got a pointer to the old one. But we reset the index pointer as though we have switched, which means that when you start reading again, you&apos;ll be getting the wrong data.&lt;/p&gt;

&lt;p&gt;Your patch fixes this issue by only doing a garbage resize once after all the reading is done, thus guaranteeing that the buffer pointer and its index remain valid throughout the lifetime of the method. &lt;/p&gt;</comment>
                            <comment id="13403298" author="nhed" created="Thu, 28 Jun 2012 17:52:48 +0000"  >&lt;p&gt;Bryan,&lt;/p&gt;

&lt;p&gt;Thanks for looking at this.  I definitely approached this from an outsider perspective looking at the two versions (C-ruby-lib vs ruby module) and attempted to make the broken one that does not seem to obliterate the data.&lt;/p&gt;

&lt;p&gt;So my question is - is my change functionaly different than what is already in the ruby read_into_buffer() method? &lt;span class=&quot;error&quot;&gt;&amp;#91;lib/rb/lib/thrift/transport/memory_buffer_transport.rb&amp;#93;&lt;/span&gt;&lt;/p&gt;
</comment>
                            <comment id="13403618" author="bryanduxbury" created="Fri, 29 Jun 2012 00:21:59 +0000"  >&lt;p&gt;I just committed a slightly modified version of this to TRUNK. Thanks for finding the bug and for drafting the original patch, Nevo!&lt;/p&gt;</comment>
                            <comment id="13403646" author="hudson" created="Fri, 29 Jun 2012 01:27:03 +0000"  >&lt;p&gt;Integrated in Thrift #508 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/508/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/508/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1632&quot; title=&quot;ruby: data corruption in thrift_native implementation of MemoryBufferTransport&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1632&quot;&gt;&lt;del&gt;THRIFT-1632&lt;/del&gt;&lt;/a&gt;. rb: ruby: data corruption in thrift_native implementation of MemoryBufferTransport&lt;/p&gt;

&lt;p&gt;This patch fixes a subtle bug whereby the read buffer was being resized but the method continued to read from the original, unresized buffer but at the wrong location. (Revision 1355198)&lt;/p&gt;

&lt;p&gt;     Result = SUCCESS&lt;br/&gt;
bryanduxbury : &lt;a href=&quot;http://svn.apache.org/viewvc/?view=rev&amp;amp;rev=1355198&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/?view=rev&amp;amp;rev=1355198&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/thrift/trunk/lib/rb/ext/memory_buffer.c&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12532635" name="patch" size="1075" author="nhed" created="Wed, 20 Jun 2012 02:13:50 +0000"/>
                            <attachment id="12532642" name="test.rb" size="336" author="nhed" created="Wed, 20 Jun 2012 04:27:27 +0000"/>
                            <attachment id="12532633" name="test.thrift" size="326" author="nhed" created="Wed, 20 Jun 2012 01:56:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>245657</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 21 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i06chb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>34956</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>