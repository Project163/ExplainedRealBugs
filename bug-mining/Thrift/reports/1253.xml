<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:18:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-1642] Miscalculation lead to throw unexpected &quot;TTransportException::TIMED_OUT&quot;(or called &quot;EAGAIN (timed out)&quot;) exception</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-1642</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;In function &apos;uint32_t TSocket::read(uint8_t* buf, uint32_t len)&apos;, there&apos;s an miscalculation which can lead to wrong judgment:&lt;/p&gt;

&lt;p&gt;struct timeval begin;&lt;br/&gt;
gettimeofday(&amp;amp;begin, NULL);&lt;br/&gt;
//&lt;br/&gt;
// do some thing&lt;br/&gt;
//&lt;br/&gt;
struct timeval end;&lt;br/&gt;
gettimeofday(&amp;amp;end, NULL);&lt;br/&gt;
uint32_t readElapsedMicros =  (((end.tv_sec - begin.tv_sec) * 1000 * 1000)&lt;br/&gt;
                               + (((uint64_t)(end.tv_usec - begin.tv_usec))));&lt;/p&gt;

&lt;p&gt;&apos;readElapsedMicros&apos; will be very large when &apos;end.tv_usec &amp;lt; begin.tv_usec&apos;.&lt;br/&gt;
This will lead to throw unexpected &quot;TTransportException::TIMED_OUT&quot;(or called &quot;EAGAIN (timed out)&quot;) exception sometimes.&lt;/p&gt;



&lt;p&gt;Besides, &lt;br/&gt;
(1)I don&apos;t think the &quot;usleep(50);&quot; call in the same function above is necessary, I think delete this call could improve performance.&lt;br/&gt;
(2)I don&apos;t know why &apos;readElapsedMicros&apos; compare with &apos;eagainThresholdMicros&apos;, which is not the value (recvTimeout_*1000), but:&lt;br/&gt;
   eagainThresholdMicros = (recvTimeout_*1000)/ ((maxRecvRetries_&amp;gt;0) ? maxRecvRetries_ : 2);&lt;br/&gt;
   can anyone tell me someting about this? Thank you!&lt;/p&gt;</description>
                <environment>&lt;p&gt;GNU/Linux x86_64&lt;/p&gt;</environment>
        <key id="12597392">THRIFT-1642</key>
            <summary>Miscalculation lead to throw unexpected &quot;TTransportException::TIMED_OUT&quot;(or called &quot;EAGAIN (timed out)&quot;) exception</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jking3">James E. King III</assignee>
                                    <reporter username="catxl">catxl</reporter>
                        <labels>
                    </labels>
                <created>Wed, 4 Jul 2012 02:29:33 +0000</created>
                <updated>Tue, 21 Jul 2015 02:21:12 +0000</updated>
                            <resolved>Sun, 10 May 2015 12:44:01 +0000</resolved>
                                    <version>0.8</version>
                                    <fixVersion>0.9.3</fixVersion>
                                    <component>C++ - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="3600">1h</timeoriginalestimate>
                            <timeestimate seconds="3600">1h</timeestimate>
                                        <comments>
                            <comment id="13406413" author="catxl" created="Wed, 4 Jul 2012 10:05:48 +0000"  >&lt;p&gt;Correction calculation error of elapse time.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://svn.apache.org/repos/asf/thrift/trunk/lib/cpp/src/thrift/transport/TSocket.cpp&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/thrift/trunk/lib/cpp/src/thrift/transport/TSocket.cpp&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13406442" author="klickverbot" created="Wed, 4 Jul 2012 11:00:10 +0000"  >&lt;p&gt;The point of the &lt;tt&gt;usleep&lt;/tt&gt; call is to avoid busy-spinning if the system might already be in need of some CPU power to handle networking. &lt;tt&gt;eagainThresholdMicros&lt;/tt&gt; is explained in the comment right above the line you changed.&lt;/p&gt;</comment>
                            <comment id="13406477" author="catxl" created="Wed, 4 Jul 2012 12:29:08 +0000"  >&lt;p&gt;Users will set timeout(ms), so i don&apos;t think we need do usleep.&lt;/p&gt;</comment>
                            <comment id="13567674" author="kuldeepgupta" created="Thu, 31 Jan 2013 14:38:05 +0000"  >&lt;p&gt;In read function of TSocket.cpp &lt;br/&gt;
eagainThresholdMicros is calculated using recvTimeout_ and maxRecvRetries_ variables.&lt;/p&gt;

&lt;p&gt;TSocket.cpp provides 2 useful API&apos;s setMaxRecvRetries and setRecvTimeout.&lt;br/&gt;
Both variables can be set using these API&apos;s setMaxRecvRetries(int maxRecvRetries) and setRecvTimeout(int ms)&lt;br/&gt;
It is User&apos;s responsibility to set these Variables.&lt;/p&gt;

&lt;p&gt;If the user is not setting these variables, by default value will be used , which may cause EAGAIN (timed out) or EAGAIN (unavailable resources) in a heavy or concurrent Running Server where multiple Requests are processed at runtime in a mutithreaded environment.&lt;/p&gt;</comment>
                            <comment id="14326512" author="aehusain" created="Wed, 18 Feb 2015 20:35:33 +0000"  >&lt;p&gt;Kuldeep,&lt;/p&gt;

&lt;p&gt;The reasoning for setting timeout and retires hold true. BUT, still their is a issue in a way computation for &quot;readElapsedMicros&quot; is done:&lt;/p&gt;

&lt;p&gt;&quot;&lt;br/&gt;
      uint32_t readElapsedMicros =  (((end.tv_sec - begin.tv_sec) * 1000 * 1000)&lt;br/&gt;
                                     + (((uint64_t)(end.tv_usec - begin.tv_usec))));&lt;br/&gt;
&quot;&lt;/p&gt;

&lt;p&gt;it should be:&lt;br/&gt;
&quot;&lt;br/&gt;
      uint32_t readElapsedMicros =  (((end.tv_sec - begin.tv_sec) * 1000 * 1000)&lt;br/&gt;
                                     + (((int64_t)(end.tv_usec - begin.tv_usec))));&lt;br/&gt;
&apos;&lt;/p&gt;

&lt;p&gt;Would it make sense to port this change upstream given it leads to mis-calculation very easily.&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="14533831" author="jking3" created="Fri, 8 May 2015 04:20:48 +0000"  >&lt;p&gt;I think the use of gettimeofday() is dangerous; this should be replaced with something like boost::chrono::time_point.&lt;/p&gt;</comment>
                            <comment id="14537130" author="jking3" created="Sun, 10 May 2015 10:58:06 +0000"  >&lt;p&gt;My guess is this code path is rarely taken since the bug has been there for a while.  There are far too many modes of operation inside TSocket that complicate the code tremendously.  This loop is definitely one of them.  I took your signedness fix but I have left the sleep and the timeout calculation alone, given this code is likely not tested in the current set of tests.  To test these code paths properly we would need a low level socket API abstraction that we could use something like GMock on, so that a call to recv() could mock return EAGAIN reliably; also gettimeofday would need a similar mock.  These are all quite possible to do with a little refactoring...&lt;/p&gt;</comment>
                            <comment id="14537132" author="githubbot" created="Sun, 10 May 2015 11:00:48 +0000"  >&lt;p&gt;GitHub user jeking3 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/485&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/485&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1642&quot; title=&quot;Miscalculation lead to throw unexpected &amp;quot;TTransportException::TIMED_OUT&amp;quot;(or called &amp;quot;EAGAIN (timed out)&amp;quot;) exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1642&quot;&gt;&lt;del&gt;THRIFT-1642&lt;/del&gt;&lt;/a&gt; pull in patch from Jira to fix signedness issue in timeout calculation&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jeking3/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jeking3/thrift&lt;/a&gt; bugfix/&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1642&quot; title=&quot;Miscalculation lead to throw unexpected &amp;quot;TTransportException::TIMED_OUT&amp;quot;(or called &amp;quot;EAGAIN (timed out)&amp;quot;) exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1642&quot;&gt;&lt;del&gt;THRIFT-1642&lt;/del&gt;&lt;/a&gt;-socket-timeout-false-positive&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/485.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/485.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #485&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 6c200ce69ecf72267213d0bd7880424c1b842fc9&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-05-10T10:59:17Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1642&quot; title=&quot;Miscalculation lead to throw unexpected &amp;quot;TTransportException::TIMED_OUT&amp;quot;(or called &amp;quot;EAGAIN (timed out)&amp;quot;) exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1642&quot;&gt;&lt;del&gt;THRIFT-1642&lt;/del&gt;&lt;/a&gt; pull in patch from Jira to fix signedness issue in timeout calculation&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14537158" author="githubbot" created="Sun, 10 May 2015 12:10:18 +0000"  >&lt;p&gt;Github user jeking3 closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/485&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/485&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14537159" author="githubbot" created="Sun, 10 May 2015 12:10:19 +0000"  >&lt;p&gt;GitHub user jeking3 reopened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/485&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/485&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1642&quot; title=&quot;Miscalculation lead to throw unexpected &amp;quot;TTransportException::TIMED_OUT&amp;quot;(or called &amp;quot;EAGAIN (timed out)&amp;quot;) exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1642&quot;&gt;&lt;del&gt;THRIFT-1642&lt;/del&gt;&lt;/a&gt; pull in patch from Jira to fix signedness issue in timeout calculation&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jeking3/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jeking3/thrift&lt;/a&gt; bugfix/&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1642&quot; title=&quot;Miscalculation lead to throw unexpected &amp;quot;TTransportException::TIMED_OUT&amp;quot;(or called &amp;quot;EAGAIN (timed out)&amp;quot;) exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1642&quot;&gt;&lt;del&gt;THRIFT-1642&lt;/del&gt;&lt;/a&gt;-socket-timeout-false-positive&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/485.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/485.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #485&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 6c200ce69ecf72267213d0bd7880424c1b842fc9&lt;br/&gt;
Author: Jim King &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-05-10T10:59:17Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1642&quot; title=&quot;Miscalculation lead to throw unexpected &amp;quot;TTransportException::TIMED_OUT&amp;quot;(or called &amp;quot;EAGAIN (timed out)&amp;quot;) exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1642&quot;&gt;&lt;del&gt;THRIFT-1642&lt;/del&gt;&lt;/a&gt; pull in patch from Jira to fix signedness issue in timeout calculation&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14537162" author="githubbot" created="Sun, 10 May 2015 12:43:47 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/485&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/485&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14537172" author="hudson" created="Sun, 10 May 2015 13:36:41 +0000"  >&lt;p&gt;SUCCESS: Integrated in Thrift #1541 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/1541/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/1541/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1642&quot; title=&quot;Miscalculation lead to throw unexpected &amp;quot;TTransportException::TIMED_OUT&amp;quot;(or called &amp;quot;EAGAIN (timed out)&amp;quot;) exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1642&quot;&gt;&lt;del&gt;THRIFT-1642&lt;/del&gt;&lt;/a&gt; pull in patch from Jira to fix signedness issue in timeout calculation (roger: rev 9f85468eb6acab173dd45a5e8d2c8a87e77923a7)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;lib/cpp/src/thrift/transport/TSocket.cpp&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12535066" name="TSocket.cpp.patch" size="1146" author="catxl" created="Wed, 4 Jul 2012 10:05:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>296913</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 28 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i14i5b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>234403</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>