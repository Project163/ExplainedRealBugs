<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:20:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-2936] Minor memory leak in SSL</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-2936</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;Valgrind shows that Thrift clients that use SSL leak 64 bytes in two chunks. This is because the list of available compression methods is not freed.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Ubuntu 14.04.1 LTS&lt;/p&gt;</environment>
        <key id="12765971">THRIFT-2936</key>
            <summary>Minor memory leak in SSL</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jking3">James E. King III</assignee>
                                    <reporter username="cklein">Cristian Klein</reporter>
                        <labels>
                            <label>easyfix</label>
                            <label>newbie</label>
                            <label>patch</label>
                    </labels>
                <created>Fri, 9 Jan 2015 08:49:33 +0000</created>
                <updated>Mon, 2 Apr 2018 22:47:21 +0000</updated>
                            <resolved>Fri, 25 Sep 2015 02:40:39 +0000</resolved>
                                    <version>0.9.3</version>
                                    <fixVersion>0.9.3</fixVersion>
                                    <component>C++ - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="3600">1h</timeoriginalestimate>
                            <timeestimate seconds="3600">1h</timeestimate>
                                        <comments>
                            <comment id="14270781" author="cklein" created="Fri, 9 Jan 2015 08:53:46 +0000"  >&lt;p&gt;Patch to fix bug&lt;/p&gt;</comment>
                            <comment id="14271985" author="codesf" created="Fri, 9 Jan 2015 22:35:15 +0000"  >&lt;p&gt;thanks for the patch (valgrind rules!), committed.&lt;/p&gt;</comment>
                            <comment id="14272009" author="hudson" created="Fri, 9 Jan 2015 22:46:02 +0000"  >&lt;p&gt;SUCCESS: Integrated in Thrift #1429 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/1429/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/1429/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2936&quot; title=&quot;Minor memory leak in SSL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2936&quot;&gt;&lt;del&gt;THRIFT-2936&lt;/del&gt;&lt;/a&gt; Minor memory leak in CPP SSL (ra: rev da80afe740ec2c97c22b806b96c9ac6650688908)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;lib/cpp/src/thrift/transport/TSSLSocket.cpp&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14804307" author="jking3" created="Thu, 17 Sep 2015 19:12:33 +0000"  >&lt;p&gt;I&apos;ve found that this causes a crash similar to the one described here:&lt;br/&gt;
&lt;a href=&quot;https://bugs.eclipse.org/bugs/show_bug.cgi?id=462780&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bugs.eclipse.org/bugs/show_bug.cgi?id=462780&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I had to remove it in order not to crash in any application that opens one socket at a time then closes everything, such as a set of unit tests.&lt;br/&gt;
The stack I get is:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;==11727== Invalid read of size 8
==11727==    at 0x5E0D539: sk_free (in /lib/x86_64-linux-gnu/libcrypto.so.1.0.0)
==11727==    by 0x66BED1D: apache::thrift::transport::cleanupOpenSSL() (TSSLSocket.cpp:127)
==11727==    by 0x66C32B7: apache::thrift::transport::TSSLSocketFactory::~TSSLSocketFactory() (TSSLSocket.cpp:469)
==11727==    by 0x4D665A4: TLSOnlyTSSLServerSocketFactory::~TLSOnlyTSSLServerSocketFactory() (in /var/tmp/build/lib/libcommon.so)
==11727==    by 0x4D665C8: TLSOnlyTSSLServerSocketFactory::~TLSOnlyTSSLServerSocketFactory() (rpctlsserver.cpp:25)
==11727==    by 0x4D6698A: void boost::checked_delete&amp;lt;TLSOnlyTSSLServerSocketFactory&amp;gt;(TLSOnlyTSSLServerSocketFactory*) (checked_delete.hpp:34)
==11727==    by 0x4D66A08: boost::detail::sp_counted_impl_p&amp;lt;TLSOnlyTSSLServerSocketFactory&amp;gt;::dispose() (sp_counted_impl.hpp:78)
==11727==    by 0x44A808: boost::detail::sp_counted_base::release() (sp_counted_base_clang.hpp:112)
==11727==    by 0x44A7A9: boost::detail::shared_count::~shared_count() (shared_count.hpp:467)
==11727==    by 0x4D664C8: boost::shared_ptr&amp;lt;apache::thrift::transport::TSSLSocketFactory&amp;gt;::~shared_ptr() (in /var/tmp/build/lib/libcommon.so)
==11727==    by 0x4D65725: RpcTlsServer::getSSLSocketFactory() (rpctlsserver.cpp:79)
==11727==    by 0x4D65939: RpcTlsServer::start() (rpctlsserver.cpp:92)
==11727==  Address 0xaa27858 is 8 bytes inside a block of size 32 free&apos;d
==11727==    at 0x402E36D: free (vg_replace_malloc.c:473)
==11727==    by 0x5D87F8C: CRYPTO_free (in /lib/x86_64-linux-gnu/libcrypto.so.1.0.0)
==11727==    by 0x66BED1D: apache::thrift::transport::cleanupOpenSSL() (TSSLSocket.cpp:127)
==11727==    by 0x66C32B7: apache::thrift::transport::TSSLSocketFactory::~TSSLSocketFactory() (TSSLSocket.cpp:469)
==11727==    by 0x4D665A4: TLSOnlyTSSLServerSocketFactory::~TLSOnlyTSSLServerSocketFactory() (in /var/tmp/build/lib/libcommon.so)
==11727==    by 0x4D665C8: TLSOnlyTSSLServerSocketFactory::~TLSOnlyTSSLServerSocketFactory() (rpctlsserver.cpp:25)
==11727==    by 0x4D6698A: void boost::checked_delete&amp;lt;TLSOnlyTSSLServerSocketFactory&amp;gt;(TLSOnlyTSSLServerSocketFactory*) (checked_delete.hpp:34)
==11727==    by 0x4D66A08: boost::detail::sp_counted_impl_p&amp;lt;TLSOnlyTSSLServerSocketFactory&amp;gt;::dispose() (sp_counted_impl.hpp:78)
==11727==    by 0x44A808: boost::detail::sp_counted_base::release() (sp_counted_base_clang.hpp:112)
==11727==    by 0x44A7A9: boost::detail::shared_count::~shared_count() (shared_count.hpp:467)
==11727==    by 0x4D664C8: boost::shared_ptr&amp;lt;apache::thrift::transport::TSSLSocketFactory&amp;gt;::~shared_ptr() (in /var/tmp/build/lib/libcommon.so)
==11727==    by 0x4D65725: RpcTlsServer::getSSLSocketFactory() (rpctlsserver.cpp:79)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As such, we should consider backing this change out.&lt;br/&gt;
The following &quot;cleanupOpenSSL&quot; works for me:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;void cleanupOpenSSL() {
  if (!openSSLInitialized) {
    return;
  }
  openSSLInitialized = false;
#if (OPENSSL_VERSION_NUMBER &amp;lt; OPENSSL_VERSION_NO_THREAD_ID)
  CRYPTO_set_id_callback(NULL);
#endif
  CRYPTO_set_locking_callback(NULL);
  CRYPTO_set_dynlock_create_callback(NULL);
  CRYPTO_set_dynlock_lock_callback(NULL);
  CRYPTO_set_dynlock_destroy_callback(NULL);
  ERR_free_strings();
  EVP_cleanup();
  CRYPTO_cleanup_all_ex_data();
  ERR_remove_state(0);
  mutexes.reset();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I reordered the sequence of where CRYPTO_cleanup_all_ex_data is called based on the eclipse bug report&apos;s resolution of the same issue.&lt;/p&gt;

&lt;p&gt;This was tested against Ubuntu 14.04, openssl library version 1.0.1f-1ubuntu2.12.&lt;/p&gt;

&lt;p&gt;I ran valgrind against this change and there were no leaks:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;==12346== LEAK SUMMARY:
==12346==    definitely lost: 0 bytes in 0 blocks
==12346==    indirectly lost: 0 bytes in 0 blocks
==12346==      possibly lost: 0 bytes in 0 blocks
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14903176" author="githubbot" created="Tue, 22 Sep 2015 18:35:25 +0000"  >&lt;p&gt;GitHub user jeking3 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/619&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/619&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2936&quot; title=&quot;Minor memory leak in SSL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2936&quot;&gt;&lt;del&gt;THRIFT-2936&lt;/del&gt;&lt;/a&gt;: fix crash in memory handling in cleanupOpenSSL that was introduced in 0.9.3&lt;/p&gt;

&lt;p&gt;    fix crash in memory handling if executable calls cleanupOpenSSL more than once&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jeking3/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jeking3/thrift&lt;/a&gt; bugfix/&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2936&quot; title=&quot;Minor memory leak in SSL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2936&quot;&gt;&lt;del&gt;THRIFT-2936&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/619.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/619.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #619&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 10453446b3a4dd72b90200ef61eac1c00ec12188&lt;br/&gt;
Author: James E. King, III &amp;lt;jim.king@simplivity.com&amp;gt;&lt;br/&gt;
Date:   2015-09-22T18:33:42Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2936&quot; title=&quot;Minor memory leak in SSL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2936&quot;&gt;&lt;del&gt;THRIFT-2936&lt;/del&gt;&lt;/a&gt;: fix crash in memory handling if executable calls cleanupOpenSSL more than once&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14907454" author="jfarrell" created="Fri, 25 Sep 2015 02:40:39 +0000"  >&lt;p&gt;Thanks for the patch, committed&lt;/p&gt;</comment>
                            <comment id="14907455" author="githubbot" created="Fri, 25 Sep 2015 02:40:43 +0000"  >&lt;p&gt;Github user jfarrell closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/619&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/619&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14907504" author="hudson" created="Fri, 25 Sep 2015 03:24:58 +0000"  >&lt;p&gt;SUCCESS: Integrated in Thrift #1663 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/1663/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/1663/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2936&quot; title=&quot;Minor memory leak in SSL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2936&quot;&gt;&lt;del&gt;THRIFT-2936&lt;/del&gt;&lt;/a&gt;:Minor memory leak in SSL (jfarrell: rev 27be411ee0eb8799861262275c9745017031c3c4)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;lib/cpp/src/thrift/transport/TSSLSocket.cpp&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13149555">IMPALA-6792</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12691088" name="0001-THRIFT-2936-Fix-minor-memory-leak-in-SSL.patch" size="853" author="cklein" created="Fri, 9 Jan 2015 08:53:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 8 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2444v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>