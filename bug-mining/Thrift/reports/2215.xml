<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:34:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-5569] generated Go code crashes when reading invalid map/set/list</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-5569</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;We&apos;re using the Thrift compiler to generate Go code for our &lt;a href=&quot;https://github.com/fraugster/parquet-go&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;parquet-go&lt;/a&gt; library. The parquet file format uses Thrift to serialize many of its internal data structures. A user advised us in an issue report that invalid&#160; input can cause the generated Go parser code for parquet&apos;s thrift data structure to crash, see e.g. here:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;panic: runtime error: makeslice: cap out of range&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;goroutine 1 &lt;span class=&quot;error&quot;&gt;&amp;#91;running&amp;#93;&lt;/span&gt;:&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;github.com/fraugster/parquet-go/parquet.(*ColumnMetaData).ReadField2(0xc0001342c0, 0x6e5230, 0xc0000160c8, 0x6e6990, 0xc000118aa0, 0x2000f, 0x0)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; &#160; &#160; /home/andreas/go/src/github.com/fraugster/parquet-go/parquet/parquet.go:7800 +0xd9&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;github.com/fraugster/parquet-go/parquet.(*ColumnMetaData).Read(0xc0001342c0, 0x6e5230, 0xc0000160c8, 0x6e6990, 0xc000118aa0, 0x0, 0x0)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; &#160; &#160; /home/andreas/go/src/github.com/fraugster/parquet-go/parquet/parquet.go:7611 +0x56a&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;github.com/fraugster/parquet-go/parquet.(*ColumnChunk).ReadField3(0xc000060360, 0x6e5230, 0xc0000160c8, 0x6e6990, 0xc000118aa0, 0x3000c, 0x0)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; &#160; &#160; /home/andreas/go/src/github.com/fraugster/parquet-go/parquet/parquet.go:9071 +0xa5&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;github.com/fraugster/parquet-go/parquet.(*ColumnChunk).Read(0xc000060360, 0x6e5230, 0xc0000160c8, 0x6e6990, 0xc000118aa0, 0x0, 0x0)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; &#160; &#160; /home/andreas/go/src/github.com/fraugster/parquet-go/parquet/parquet.go:8965 +0x730&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;github.com/fraugster/parquet-go/parquet.(*RowGroup).ReadField1(0xc000060300, 0x6e5230, 0xc0000160c8, 0x6e6990, 0xc000118aa0, 0x1000f, 0x0)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; &#160; &#160; /home/andreas/go/src/github.com/fraugster/parquet-go/parquet/parquet.go:9584 +0x19d&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;github.com/fraugster/parquet-go/parquet.(*RowGroup).Read(0xc000060300, 0x6e5230, 0xc0000160c8, 0x6e6990, 0xc000118aa0, 0x0, 0x0)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; &#160; &#160; /home/andreas/go/src/github.com/fraugster/parquet-go/parquet/parquet.go:9480 +0x271&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;github.com/fraugster/parquet-go/parquet.(*FileMetaData).ReadField4(0xc000118a00, 0x6e5230, 0xc0000160c8, 0x6e6990, 0xc000118aa0, 0x4000f, 0x0)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; &#160; &#160; /home/andreas/go/src/github.com/fraugster/parquet-go/parquet/parquet.go:11886 +0x1bd&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;github.com/fraugster/parquet-go/parquet.(*FileMetaData).Read(0xc000118a00, 0x6e5230, 0xc0000160c8, 0x6e6990, 0xc000118aa0, 0x673ea0, 0x1)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; &#160; &#160; /home/andreas/go/src/github.com/fraugster/parquet-go/parquet/parquet.go:11753 +0x985&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;github.com/fraugster/parquet-go.readThrift(0x6e5230, 0xc0000160c8, 0x6e2060, 0xc000118a00, 0x6e20c0, 0xc00000e0d8, 0x0, 0x0)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; &#160; &#160; /home/andreas/go/src/github.com/fraugster/parquet-go/helpers.go:108 +0xe7&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;github.com/fraugster/parquet-go.ReadFileMetaDataWithContext(0x6e5230, 0xc0000160c8, 0x6e3750, 0xc000074ea0, 0xc00005e201, 0x0, 0x0, 0x0)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; &#160; &#160; /home/andreas/go/src/github.com/fraugster/parquet-go/file_meta.go:69 +0x56a&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;github.com/fraugster/parquet-go.ReadFileMetaData(0x6e3750, 0xc000074ea0, 0x1, 0x1, 0x0, 0x0)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; &#160; &#160; /home/andreas/go/src/github.com/fraugster/parquet-go/file_meta.go:19 +0x8a&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;github.com/fraugster/parquet-go.NewFileReaderWithOptions(0x6e3750, 0xc000074ea0, 0xc00011fde8, 0x1, 0x1, 0x28, 0x67afa0, 0x489001)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; &#160; &#160; /home/andreas/go/src/github.com/fraugster/parquet-go/file_reader.go:37 +0x472&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;github.com/fraugster/parquet-go.NewFileReader(0x6e3750, 0xc000074ea0, 0x0, 0x0, 0x0, 0x1872827b00000009, 0x625fd794, 0xc00011fe60)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; &#160; &#160; /home/andreas/go/src/github.com/fraugster/parquet-go/file_reader.go:140 +0xa5&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;github.com/fraugster/parquet-go.FuzzFileReader(0x7fbfa1bfe000, 0x40, 0x40, 0x4)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; &#160; &#160; /home/andreas/go/src/github.com/fraugster/parquet-go/reader_fuzz.go:13 +0xca&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;go-fuzz-dep.Main(0xc00011ff30, 0x9, 0x9)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; &#160; &#160; go-fuzz-dep/main.go:36 +0x1b8&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;main.main()&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; &#160; &#160; github.com/fraugster/parquet-go/go.fuzz.main/main.go:31 +0xcd&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;exit status 2&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;parquet.go:7800 in this case is this line of code:&#160;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160; &#160; &#160; &#160; _, size, err := iprot.ReadListBegin(ctx)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; &#160; &#160; if err != nil {&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; return thrift.PrependError(&quot;error reading list begin: &quot;, err)&lt;/tt&gt;&lt;br/&gt;
{{&#160; &#160; &#160; &#160; }}}&lt;br/&gt;
&lt;tt&gt;&#160; &#160; &#160; &#160; tSlice := make([]Encoding, 0, size)&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;When debugging this, I&apos;ve able to track this down to the generated code for ReadListBegin et al not checking the value of size before passing it on to make. This can cause the third parameter (slice capacity) to be negative, which in turn causes the panic above. I&apos;m currently preparing a PR that fixes this issue which I will post shortly.&lt;/p&gt;</description>
                <environment>&lt;p&gt;I&apos;m running this on Ubuntu 20.04.4 LTS with Go version 1.16.3. I was able to reproduce this issue with both thrift 0.16.0 and the latest master.&lt;/p&gt;</environment>
        <key id="13440669">THRIFT-5569</key>
            <summary>generated Go code crashes when reading invalid map/set/list</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="akrennmair">Andreas Krennmair</assignee>
                                    <reporter username="akrennmair">Andreas Krennmair</reporter>
                        <labels>
                    </labels>
                <created>Wed, 20 Apr 2022 11:45:53 +0000</created>
                <updated>Wed, 26 Oct 2022 23:46:25 +0000</updated>
                            <resolved>Wed, 20 Apr 2022 21:30:05 +0000</resolved>
                                    <version>0.16.0</version>
                    <version>0.17.0</version>
                                    <fixVersion>0.17.0</fixVersion>
                                    <component>Go - Compiler</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3600">1h</timespent>
                                <comments>
                            <comment id="17534564" author="fishywang" created="Tue, 10 May 2022 20:14:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=akrennmair&quot; class=&quot;user-hover&quot; rel=&quot;akrennmair&quot;&gt;akrennmair&lt;/a&gt; sorry I missed the original issue and PR review. This is actually a bug from TCompactProtocol&apos;s size check logic, and fixing it from the compiler is not a great way to do it.&lt;/p&gt;

&lt;p&gt;The current fix in the compiler would generate go code like this:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
func (p *ReddarAudit) &#160;ReadField5(ctx context.Context, iprot thrift.TProtocol) error {
 &#160;_, size, err := iprot.ReadListBegin(ctx)
 &#160;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; size &amp;lt; 0 {
 &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; errors.New(&lt;span class=&quot;code-quote&quot;&gt;&quot;list size is negative&quot;&lt;/span&gt;)
 &#160;}
 &#160;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; err != nil {
 &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; thrift.PrependError(&lt;span class=&quot;code-quote&quot;&gt;&quot;error reading list begin: &quot;&lt;/span&gt;, err)
 &#160;} 
  ...&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Which has the issues of:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;It returns a generic error, instead of one of the TException implementations&lt;/li&gt;
	&lt;li&gt;It does the size check before the error check&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I&apos;m going to revert the compiler fix and do the proper fix in TCompactProtocol instead.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 27 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z11mtk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>