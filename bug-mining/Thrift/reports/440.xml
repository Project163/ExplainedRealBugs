<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:00:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-1182] Native deserializer segfaults on incorrect list element type</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-1182</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;There is a pretty major bug in the native Ruby deserializer that causes it to segfault on certain bad inputs. Basically when deserializing a list that is expected to contain elements of a basic type, but is claiming in the list header to be a list of structs, the native deserializer segfaults and crashes the ruby process. I will be attaching code that reproduces this shortly.&lt;/p&gt;

&lt;p&gt;I need to have a fix for this ASAP, and am willing to work on it, however I need some guidance, as I&apos;m not sure what the desired behavior is. Basically the case is:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Expecting a list&amp;lt;string&amp;gt; (or list&amp;lt;i32&amp;gt;, list&amp;lt;i16&amp;gt;, etc.)&lt;/li&gt;
	&lt;li&gt;Get something that claims to be a list&amp;lt;struct&amp;gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This can be caused by a buggy and/or malicious client, or by accidentally making a backwards-incompatible change to a .thrift definition and running both versions concurrently. Regardless of the cause, crashing on arbitrary inputs is not an option for my use case so I have to handle it somehow. I see 2 possible solutions:&lt;/p&gt;

&lt;p&gt;1) Raise some kind of Type Mismatch error and catch it higher up, thus aborting parsing of the entire thrift struct&lt;br/&gt;
2) Skip the list with mismatched type but attempt to parse the rest of the struct.&lt;/p&gt;

&lt;p&gt;Of course, if the list header is wrong about the element type it could be wrong about the list length as well so it&apos;s not clear how many bytes should be skipped. Basically once such a type error is detected, the contents of the serialized struct can no longer be trusted. For this reason, I would lean towards option 1.&lt;/p&gt;

&lt;p&gt;Right now it doesn&apos;t look like the deserializer does much type checking while deserializing, so such a change in behavior could break numerous existing users and should probably be optional (i.e. right now you could have a list&amp;lt;i64&amp;gt; declared but a list&amp;lt;i32&amp;gt; come across the wire, I &lt;b&gt;think&lt;/b&gt; the native deserializer will just read the list of i32s and happily convert them to Ruby Fixnums so everything will work. Adding the type checks I suggest would break this case.)&lt;/p&gt;</description>
                <environment>&lt;p&gt;OS X 10.6 i686, Linux x86_64&lt;/p&gt;</environment>
        <key id="12508639">THRIFT-1182</key>
            <summary>Native deserializer segfaults on incorrect list element type</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ilyam">Ilya Maykov</assignee>
                                    <reporter username="ilyam">Ilya Maykov</reporter>
                        <labels>
                    </labels>
                <created>Sun, 29 May 2011 02:11:54 +0000</created>
                <updated>Tue, 31 May 2011 20:47:12 +0000</updated>
                            <resolved>Tue, 31 May 2011 20:04:13 +0000</resolved>
                                    <version>0.6.1</version>
                                    <fixVersion>0.7</fixVersion>
                                    <component>Ruby - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13040724" author="ilyam" created="Sun, 29 May 2011 02:16:41 +0000"  >&lt;p&gt;Attached simple repro. Run with thrift 0.6.0 gem, tested on ruby 1.8.7 and 1.9.2.&lt;/p&gt;</comment>
                            <comment id="13040743" author="ilyam" created="Sun, 29 May 2011 04:45:11 +0000"  >&lt;p&gt;Per IRC chat with Bryan Duxbury, the deserializer should skip over list fields (presumably also sets, maps) with unexpected element types, but should keep trying to parse the rest of the struct.&lt;/p&gt;</comment>
                            <comment id="13040761" author="ilyam" created="Sun, 29 May 2011 08:05:58 +0000"  >&lt;p&gt;Attaching patch.&lt;/p&gt;

&lt;p&gt;With this patch, the deserializer will skip any maps / lists / sets whose key/value/element types do not match the expected key/value/element types for that field.&lt;/p&gt;

&lt;p&gt;Tested with all combinations of:&lt;br/&gt;
protocols: BinaryProtocol, BinaryProtocolAccelerated, CompactProtocol&lt;br/&gt;
rubies: 1.8.7, 1.9.2&lt;br/&gt;
native extensions: enabled, disabled&lt;/p&gt;</comment>
                            <comment id="13040763" author="ilyam" created="Sun, 29 May 2011 08:09:12 +0000"  >&lt;p&gt;Wrong file attached last time, here goes try 2.&lt;/p&gt;</comment>
                            <comment id="13040764" author="ilyam" created="Sun, 29 May 2011 08:09:51 +0000"  >&lt;p&gt;Sorry the patch is against a copy of the source that i&apos;ve mirrored on our own git repo, so the file paths may look funky.&lt;/p&gt;</comment>
                            <comment id="13041419" author="ilyam" created="Tue, 31 May 2011 04:56:35 +0000"  >&lt;p&gt;The original patch didn&apos;t call read&amp;#95;(list|map|set)&amp;#95;end if the contents were skipped, which is incorrect. It happens to work for Binary and Compact protocols because the read&amp;#95;(list|map|set)&amp;#95;methods are no-ops, but would fail with a future implementation of JSON protocol, for example.&lt;/p&gt;</comment>
                            <comment id="13041792" author="bryanduxbury" created="Tue, 31 May 2011 20:04:13 +0000"  >&lt;p&gt;I just committed this patch. Thanks, Ilya!&lt;/p&gt;</comment>
                            <comment id="13041820" author="hudson" created="Tue, 31 May 2011 20:47:12 +0000"  >&lt;p&gt;Integrated in Thrift #150 (See &lt;a href=&quot;https://builds.apache.org/hudson/job/Thrift/150/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/hudson/job/Thrift/150/&lt;/a&gt;)&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1182&quot; title=&quot;Native deserializer segfaults on incorrect list element type&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1182&quot;&gt;&lt;del&gt;THRIFT-1182&lt;/del&gt;&lt;/a&gt;. rb: Native deserializer segfaults on incorrect list element type&lt;/p&gt;

&lt;p&gt;This patch causes both the pure ruby and native extension code paths to check if the data in lists, sets, and maps is of the expected type before deserlizing it. When it&apos;s not the right type, it now skips the bad data correctly.&lt;/p&gt;

&lt;p&gt;Patch: Ilya Maykov&lt;/p&gt;

&lt;p&gt;bryanduxbury : &lt;a href=&quot;http://svn.apache.org/viewvc/?view=rev&amp;amp;rev=1129892&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/?view=rev&amp;amp;rev=1129892&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/thrift/trunk/lib/rb/lib/thrift/struct_union.rb&lt;/li&gt;
	&lt;li&gt;/thrift/trunk/lib/rb/ext/struct.c&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12480899" name="patch-THRIFT-1182-2.txt" size="2133" author="ilyam" created="Tue, 31 May 2011 04:56:35 +0000"/>
                            <attachment id="12480772" name="patch-THRIFT-1182.txt" size="8692" author="ilyam" created="Sun, 29 May 2011 08:09:12 +0000"/>
                            <attachment id="12480759" name="thrift_crash.rb" size="1873" author="ilyam" created="Sun, 29 May 2011 02:16:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>187255</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 26 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i16cvj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>245218</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>