<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:30:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-4384] Using a concurrent client with cpp async is not safe.</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-4384</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;I&apos;m using the generated *ServiceConcurrentClient classes. They should allow me to call multiple functions at the same time.&lt;/p&gt;

&lt;p&gt;The issue as that the ::apache::thrift::async::TConcurrentClientSyncInfo class is a member of the generated service. If I have a project with multiple services sharing the same connection (protocol) with each other, the services will not be mutually excluded from reading on the same socket. &lt;/p&gt;

&lt;p&gt;I did a small test with patching the generated code and injecting the same instance of TConcurrentClientSyncInfo into all my services and everything was fine.&lt;/p&gt;

&lt;p&gt;Question: Do you need a small project to reproduce this or is it obvious enough? Just check out any generated code and you will see that the TConcurrentClientSyncInfo is not shared between different services.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Should affect all platforms but has been noticed first on Windows, x86_64.&lt;/p&gt;</environment>
        <key id="13117958">THRIFT-4384</key>
            <summary>Using a concurrent client with cpp async is not safe.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jking3">James E. King III</assignee>
                                    <reporter username="MichaelE1000">Michael Eiler</reporter>
                        <labels>
                            <label>async</label>
                    </labels>
                <created>Mon, 13 Nov 2017 14:59:05 +0000</created>
                <updated>Wed, 16 Oct 2019 22:26:52 +0000</updated>
                            <resolved>Sun, 3 Feb 2019 03:10:56 +0000</resolved>
                                    <version>0.10.0</version>
                    <version>0.11.0</version>
                    <version>0.12.0</version>
                                    <fixVersion>0.13.0</fixVersion>
                                    <component>C++ - Compiler</component>
                    <component>C++ - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16264278" author="michaele1000" created="Thu, 23 Nov 2017 12:49:28 +0000"  >&lt;p&gt;Currently I solved the problem for us like shown here:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;
diff --git a/compiler/cpp/src/thrift/generate/t_cpp_generator.cc b/compiler/cpp/src/thrift/generate/t_cpp_generator.cc
index cbe8da2..515e0e2 100644
--- a/compiler/cpp/src/thrift/generate/t_cpp_generator.cc
+++ b/compiler/cpp/src/thrift/generate/t_cpp_generator.cc
@@ -1616,6 +1616,8 @@ void t_cpp_generator::generate_service(t_service* tservice) {
               &amp;lt;&amp;lt; &quot;namespace apache { namespace thrift { namespace async {&quot; &amp;lt;&amp;lt; endl
               &amp;lt;&amp;lt; &quot;class TAsyncChannel;&quot; &amp;lt;&amp;lt; endl &amp;lt;&amp;lt; &quot;}}}&quot; &amp;lt;&amp;lt; endl;
   }
+  f_header_ &amp;lt;&amp;lt; &quot;#include &amp;lt;boost/make_shared.hpp&amp;gt;&quot; &amp;lt;&amp;lt; endl;
+  f_header_ &amp;lt;&amp;lt; &quot;#include &amp;lt;boost/shared_ptr.hpp&amp;gt;&quot; &amp;lt;&amp;lt; endl;
   f_header_ &amp;lt;&amp;lt; &quot;#include &amp;lt;thrift/TDispatchProcessor.h&amp;gt;&quot; &amp;lt;&amp;lt; endl;
   if (gen_cob_style_) {
     f_header_ &amp;lt;&amp;lt; &quot;#include &amp;lt;thrift/async/TAsyncDispatchProcessor.h&amp;gt;&quot; &amp;lt;&amp;lt; endl;
@@ -2169,7 +2171,14 @@ void t_cpp_generator::generate_service_client(t_service* tservice, string style)
   indent_up();
   if (style != &quot;Cob&quot;) {
     f_header_ &amp;lt;&amp;lt; indent() &amp;lt;&amp;lt; service_name_ &amp;lt;&amp;lt; style &amp;lt;&amp;lt; &quot;Client&quot; &amp;lt;&amp;lt; short_suffix &amp;lt;&amp;lt; &quot;(&quot; &amp;lt;&amp;lt; prot_ptr
-              &amp;lt;&amp;lt; &quot; prot) &quot;;
+		&amp;lt;&amp;lt; &quot; prot&quot;;
+	if (style == &quot;Concurrent&quot;) {
+		f_header_ &amp;lt;&amp;lt; &quot;, boost::shared_ptr&amp;lt;::apache::thrift::async::TConcurrentClientSyncInfo&amp;gt; sync = boost::make_shared&amp;lt;::apache::thrift::async::TConcurrentClientSyncInfo&amp;gt;()&quot;
+			&amp;lt;&amp;lt; &quot;) : sync_(sync) &quot;;
+	}
+	else {
+		f_header_ &amp;lt;&amp;lt; &quot;) &quot;;
+	}
 
     if (extends.empty()) {
       f_header_ &amp;lt;&amp;lt; &quot;{&quot; &amp;lt;&amp;lt; endl;
@@ -2182,7 +2191,15 @@ void t_cpp_generator::generate_service_client(t_service* tservice, string style)
     }
 
     f_header_ &amp;lt;&amp;lt; indent() &amp;lt;&amp;lt; service_name_ &amp;lt;&amp;lt; style &amp;lt;&amp;lt; &quot;Client&quot; &amp;lt;&amp;lt; short_suffix &amp;lt;&amp;lt; &quot;(&quot; &amp;lt;&amp;lt; prot_ptr
-              &amp;lt;&amp;lt; &quot; iprot, &quot; &amp;lt;&amp;lt; prot_ptr &amp;lt;&amp;lt; &quot; oprot) &quot;;
+		&amp;lt;&amp;lt; &quot; iprot, &quot; &amp;lt;&amp;lt; prot_ptr &amp;lt;&amp;lt; &quot; oprot&quot;;
+	if (style == &quot;Concurrent&quot;) {
+		f_header_ &amp;lt;&amp;lt; &quot;, boost::shared_ptr&amp;lt;::apache::thrift::async::TConcurrentClientSyncInfo&amp;gt; sync = boost::make_shared&amp;lt;::apache::thrift::async::TConcurrentClientSyncInfo&amp;gt;()&quot;
+			&amp;lt;&amp;lt; &quot;) : sync_(sync) &quot;;
+	}
+	else {
+		f_header_ &amp;lt;&amp;lt; &quot;) &quot;;
+	}
+	
     if (extends.empty()) {
       f_header_ &amp;lt;&amp;lt; &quot;{&quot; &amp;lt;&amp;lt; endl;
       f_header_ &amp;lt;&amp;lt; indent() &amp;lt;&amp;lt; &quot;  setProtocol&quot; &amp;lt;&amp;lt; short_suffix &amp;lt;&amp;lt; &quot;(iprot,oprot);&quot; &amp;lt;&amp;lt; endl
@@ -2328,7 +2345,7 @@ void t_cpp_generator::generate_service_client(t_service* tservice, string style)
 
     if (style == &quot;Concurrent&quot;) {
       f_header_ &amp;lt;&amp;lt;
-        indent() &amp;lt;&amp;lt; &quot;::apache::thrift::async::TConcurrentClientSyncInfo sync_;&quot;&amp;lt;&amp;lt;endl;
+        indent() &amp;lt;&amp;lt; &quot;boost::shared_ptr&amp;lt;::apache::thrift::async::TConcurrentClientSyncInfo&amp;gt; sync_;&quot;&amp;lt;&amp;lt;endl;
     }
     indent_down();
   }
@@ -2434,7 +2451,7 @@ void t_cpp_generator::generate_service_client(t_service* tservice, string style)
       string cseqidVal = &quot;0&quot;;
       if (style == &quot;Concurrent&quot;) {
         if (!(*f_iter)-&amp;gt;is_oneway()) {
-          cseqidVal = &quot;this-&amp;gt;sync_.generateSeqId()&quot;;
+          cseqidVal = &quot;this-&amp;gt;sync_-&amp;gt;generateSeqId()&quot;;
         }
       }
       // Serialize the request
@@ -2442,7 +2459,7 @@ void t_cpp_generator::generate_service_client(t_service* tservice, string style)
         indent() &amp;lt;&amp;lt; &quot;int32_t cseqid = &quot; &amp;lt;&amp;lt; cseqidVal &amp;lt;&amp;lt; &quot;;&quot; &amp;lt;&amp;lt; endl;
       if(style == &quot;Concurrent&quot;) {
         out &amp;lt;&amp;lt;
-          indent() &amp;lt;&amp;lt; &quot;::apache::thrift::async::TConcurrentSendSentry sentry(&amp;amp;this-&amp;gt;sync_);&quot; &amp;lt;&amp;lt; endl;
+          indent() &amp;lt;&amp;lt; &quot;::apache::thrift::async::TConcurrentSendSentry sentry(this-&amp;gt;sync_.get());&quot; &amp;lt;&amp;lt; endl;
       }
       if (style == &quot;Cob&quot;) {
         out &amp;lt;&amp;lt;
@@ -2507,7 +2524,7 @@ void t_cpp_generator::generate_service_client(t_service* tservice, string style)
             endl &amp;lt;&amp;lt;
             indent() &amp;lt;&amp;lt; &quot;// the read mutex gets dropped and reacquired as part of waitForWork()&quot; &amp;lt;&amp;lt; endl &amp;lt;&amp;lt;
             indent() &amp;lt;&amp;lt; &quot;// The destructor of this sentry wakes up other clients&quot; &amp;lt;&amp;lt; endl &amp;lt;&amp;lt;
-            indent() &amp;lt;&amp;lt; &quot;::apache::thrift::async::TConcurrentRecvSentry sentry(&amp;amp;this-&amp;gt;sync_, seqid);&quot; &amp;lt;&amp;lt; endl;
+            indent() &amp;lt;&amp;lt; &quot;::apache::thrift::async::TConcurrentRecvSentry sentry(this-&amp;gt;sync_.get(), seqid);&quot; &amp;lt;&amp;lt; endl;
         }
         if (style == &quot;Cob&quot; &amp;amp;&amp;amp; !gen_no_client_completion_) {
           out &amp;lt;&amp;lt; indent() &amp;lt;&amp;lt; &quot;bool completed = false;&quot; &amp;lt;&amp;lt; endl &amp;lt;&amp;lt; endl &amp;lt;&amp;lt; indent() &amp;lt;&amp;lt; &quot;try {&quot;;
@@ -2517,7 +2534,7 @@ void t_cpp_generator::generate_service_client(t_service* tservice, string style)
         if (style == &quot;Concurrent&quot;) {
           out &amp;lt;&amp;lt;
             indent() &amp;lt;&amp;lt; &quot;while(true) {&quot; &amp;lt;&amp;lt; endl &amp;lt;&amp;lt;
-            indent() &amp;lt;&amp;lt; &quot;  if(!this-&amp;gt;sync_.getPending(fname, mtype, rseqid)) {&quot; &amp;lt;&amp;lt; endl;
+            indent() &amp;lt;&amp;lt; &quot;  if(!this-&amp;gt;sync_-&amp;gt;getPending(fname, mtype, rseqid)) {&quot; &amp;lt;&amp;lt; endl;
           indent_up();
           indent_up();
         }
@@ -2661,10 +2678,10 @@ void t_cpp_generator::generate_service_client(t_service* tservice, string style)
           out &amp;lt;&amp;lt;
             indent() &amp;lt;&amp;lt; &quot;  }&quot; &amp;lt;&amp;lt; endl &amp;lt;&amp;lt;
             indent() &amp;lt;&amp;lt; &quot;  // seqid != rseqid&quot; &amp;lt;&amp;lt; endl &amp;lt;&amp;lt;
-            indent() &amp;lt;&amp;lt; &quot;  this-&amp;gt;sync_.updatePending(fname, mtype, rseqid);&quot; &amp;lt;&amp;lt; endl &amp;lt;&amp;lt;
+            indent() &amp;lt;&amp;lt; &quot;  this-&amp;gt;sync_-&amp;gt;updatePending(fname, mtype, rseqid);&quot; &amp;lt;&amp;lt; endl &amp;lt;&amp;lt;
             endl &amp;lt;&amp;lt;
             indent() &amp;lt;&amp;lt; &quot;  // this will temporarily unlock the readMutex, and let other clients get work done&quot; &amp;lt;&amp;lt; endl &amp;lt;&amp;lt;
-            indent() &amp;lt;&amp;lt; &quot;  this-&amp;gt;sync_.waitForWork(seqid);&quot; &amp;lt;&amp;lt; endl &amp;lt;&amp;lt;
+            indent() &amp;lt;&amp;lt; &quot;  this-&amp;gt;sync_-&amp;gt;waitForWork(seqid);&quot; &amp;lt;&amp;lt; endl &amp;lt;&amp;lt;
             indent() &amp;lt;&amp;lt; &quot;} // end while(true)&quot; &amp;lt;&amp;lt; endl;
         }
         if (style == &quot;Cob&quot; &amp;amp;&amp;amp; !gen_no_client_completion_) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;( &lt;a href=&quot;https://github.com/MichaelE1000/thrift/commit/44ec66e550d90cf8e0074cd46769b5be0d29253b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/MichaelE1000/thrift/commit/44ec66e550d90cf8e0074cd46769b5be0d29253b&lt;/a&gt; )&lt;/p&gt;

&lt;p&gt;Do you see any issues with this approach?&lt;/p&gt;

&lt;p&gt;Best Regards&lt;/p&gt;</comment>
                            <comment id="16353678" author="michaele1000" created="Tue, 6 Feb 2018 10:17:35 +0000"  >&lt;p&gt;So far this solution seems to work quite well for us.&#160;I am suprised that no one else has the requirement to synchronize multiple services. Is there a better solution one should use?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Best Regards&lt;/p&gt;</comment>
                            <comment id="16724214" author="jking3" created="Tue, 18 Dec 2018 16:27:17 +0000"  >&lt;p&gt;Submitting a pull request will help get this resolved...&lt;/p&gt;</comment>
                            <comment id="16753439" author="jking3" created="Sun, 27 Jan 2019 15:41:40 +0000"  >&lt;p&gt;Fix makes sense to me.  Each instance was getting its own TConcurrentClientSyncInfo and therefore there was no syncing at all.  By making it shared, that handles the root cause.  I&apos;ll submit a PR.&lt;/p&gt;</comment>
                            <comment id="16753664" author="jking3" created="Mon, 28 Jan 2019 03:09:38 +0000"  >&lt;p&gt;The patch as posted does not apply clean.  Non-trivial to fix it up, please submit a pull request.&lt;/p&gt;</comment>
                            <comment id="16759057" author="jking3" created="Sat, 2 Feb 2019 15:27:08 +0000"  >&lt;p&gt;I am working on this, I got the codegen working and I have updated the cmake build to use the new code by running a StressTest with --client-type=concurrent.&#160; This will exercise (and would have caught) the issue/fix.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 41 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3mpl3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>