<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:32:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-5186] AI_ADDRCONFIG: Thrift libraries crash with localhost-only network.</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-5186</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2539&quot; title=&quot;Tsocket.cpp addrinfo ai_flags = AI_ADDRCONFIG&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2539&quot;&gt;&lt;del&gt;THRIFT-2539&lt;/del&gt;&lt;/a&gt; has been reported, and fixed &#8212; but for win32 only, for no apparent reason. The exact same problem reproduces on POSIX.&lt;/p&gt;

&lt;p&gt;Namely, when no network interfaces besides &lt;tt&gt;lo&lt;/tt&gt; (the 127.0.0.1 loopback interface) are up, C++ and Python apps linked with Thrift-generated code, both clients and servers &#8212; &lt;b&gt;crash by throwing an exception&lt;/b&gt;. Even when the intention is exactly to run them on localhost only.&lt;/p&gt;

&lt;p&gt;This happens because Thrift library code for TSocket, TServerSocket, TNonblockingServerSocket calls &lt;a href=&quot;http://man7.org/linux/man-pages/man3/getaddrinfo.3.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;getaddrinfo()&lt;/tt&gt;&lt;/a&gt; to resolve target hostname to connect to/listen on, into concrete IP address (v4 or v6, whichever the system is configured for). To that call, it &lt;b&gt;passes the &lt;tt&gt;AI_ADDRCONFIG&lt;/tt&gt; hint&lt;/b&gt; which effectively turns a localhost-only situation into:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;tt&gt;Could not resolve host for client socket.&lt;/tt&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;and into this (server-side):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#1075;&#1088;&#1091; 23 13:52:13 localhost.localdomain systemd[1]: db_cache.service: Main process exited, code=dumped, status=6/ABRT
&#1075;&#1088;&#1091; 23 13:52:13 localhost.localdomain systemd[1]: db_cache.service: Failed with result &lt;span class=&quot;code-quote&quot;&gt;&apos;core-dump&apos;&lt;/span&gt;.
&#1075;&#1088;&#1091; 23 13:52:17 localhost.localdomain db_cache[12912]: Thrift: Mon Dec 23 13:52:15 2019 TSocket::open() getaddrinfo() &amp;lt;Host: 127.0.0.1 Port: 1302&amp;gt;Address family &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; hostname not supported
&#1075;&#1088;&#1091; 23 13:52:17 localhost.localdomain db_cache[12912]: Thrift: Mon Dec 23 13:52:15 2019 TSocket::open() getaddrinfo() &amp;lt;Host: 127.0.0.1 Port: 8345&amp;gt;Address family &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; hostname not supported
&#1075;&#1088;&#1091; 23 13:52:17 localhost.localdomain db_cache[12912]: Thrift: Mon Dec 23 13:52:15 2019 TNonblocking: using dedicated listener thread, io threads: 16
&#1075;&#1088;&#1091; 23 13:52:17 localhost.localdomain db_cache[12912]: Thrift: Mon Dec 23 13:52:15 2019 getaddrinfo -9: Address family &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; hostname not supported
&#1075;&#1088;&#1091; 23 13:52:17 localhost.localdomain db_cache[12912]: terminate called after throwing an instance of &lt;span class=&quot;code-quote&quot;&gt;&apos;apache::thrift::transport::TTransportException&apos;&lt;/span&gt;
&#1075;&#1088;&#1091; 23 13:52:17 localhost.localdomain db_cache[12912]:   what():  Could not resolve host &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; server socket.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I fail to understand the original reason to pass that &lt;tt&gt;AI_ADDRCONFIG&lt;/tt&gt; hint. It shouldn&apos;t be there as I see it.&lt;/p&gt;

&lt;p&gt;Further, since Thrift 0.9.2, windows builds of thrift apps don&apos;t pass that hint anymore (see &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2539&quot; title=&quot;Tsocket.cpp addrinfo ai_flags = AI_ADDRCONFIG&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2539&quot;&gt;&lt;del&gt;THRIFT-2539&lt;/del&gt;&lt;/a&gt;), and it seems to be okay.&lt;/p&gt;

&lt;p&gt;For comprehension, I&apos;m attaching a sample patch to remove&#160;&lt;tt&gt;AI_ADDRCONFIG&lt;/tt&gt; from &lt;tt&gt;lib/cpp&lt;/tt&gt; and &lt;tt&gt;lib/py&lt;/tt&gt;. The main change will be landing via GitHub, per Thrift&apos;s contribution process, so please follow there too.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Red Hat Enterprise Linux 8.0&lt;/p&gt;</environment>
        <key id="13301279">THRIFT-5186</key>
            <summary>AI_ADDRCONFIG: Thrift libraries crash with localhost-only network.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ulidtko">Max</assignee>
                                    <reporter username="ulidtko">Max</reporter>
                        <labels>
                            <label>getaddrinfo</label>
                            <label>localhost</label>
                            <label>sockets</label>
                    </labels>
                <created>Mon, 27 Apr 2020 13:40:58 +0000</created>
                <updated>Thu, 11 Feb 2021 22:26:08 +0000</updated>
                            <resolved>Tue, 9 Jun 2020 21:11:55 +0000</resolved>
                                    <version>0.13.0</version>
                                    <fixVersion>0.14.0</fixVersion>
                                    <component>C++ - Library</component>
                    <component>Delphi - Library</component>
                    <component>Python - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="24000">6h 40m</timespent>
                                <comments>
                            <comment id="17102330" author="jensg" created="Fri, 8 May 2020 07:25:57 +0000"  >&lt;p&gt;Good catch!&lt;/p&gt;</comment>
                            <comment id="17105379" author="emmenlau" created="Tue, 12 May 2020 12:26:22 +0000"  >&lt;p&gt;Since updating from master commit 7c4bdf9 to 55680af I get errors in dockerized tests on Ubuntu 18.04 vanilla. I&apos;ve tried to isolate the problem, and I&apos;m under the impression that this PR is at fault (commit 9b9567b &quot;&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-5186&quot; title=&quot;AI_ADDRCONFIG: Thrift libraries crash with localhost-only network.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-5186&quot;&gt;&lt;del&gt;THRIFT-5186&lt;/del&gt;&lt;/a&gt;: Don&apos;t pass AI_ADDRCONFIG to getaddrinfo()&quot;). When reverting this commit everything works again as expected.&lt;/p&gt;

&lt;p&gt;With the commit, the errors I get are in multiple tests, all of the form:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
409: Thrift: Tue May 12 11:34:13 2020 TServerSocket::listen() Could not bind to 0
409: unknown location(0): fatal error: in &lt;span class=&quot;code-quote&quot;&gt;&quot;TServerSocketTest/test_bind_to_address&quot;&lt;/span&gt;: apache::thrift::transport::TTransportException: Could not bind: Cannot assign requested address
409: /home/bdaci01/builds/37284781/0/BioDataAnalysis/thrift/lib/cpp/test/TServerSocketTest.cpp(35): last checkpoint: &lt;span class=&quot;code-quote&quot;&gt;&quot;test_bind_to_address&quot;&lt;/span&gt; test entry
409: 
409: *** 1 failure is detected in the test module &lt;span class=&quot;code-quote&quot;&gt;&quot;thrift&quot;&lt;/span&gt;
409: 
409/440 Test #409: UnitTests ..................................***Failed    0.62 sec
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The following tests FAILED:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;409 - UnitTests (Failed)&lt;/li&gt;
	&lt;li&gt;410 - TInterruptTest (Failed)&lt;/li&gt;
	&lt;li&gt;411 - TServerIntegrationTest (Failed)&lt;/li&gt;
	&lt;li&gt;431 - SecurityTest (Timeout)&lt;/li&gt;
	&lt;li&gt;432 - SecurityFromBufferTest (Timeout)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17106160" author="ulidtko" created="Wed, 13 May 2020 09:37:00 +0000"  >&lt;p&gt;Hey Mario!&lt;/p&gt;

&lt;p&gt;How can I replicate the test failure? I did run &lt;tt&gt;make test&lt;/tt&gt; before sending this patch, there wasn&apos;t new breakage &amp;#8211; but also Travis CI on GitHub was green. &lt;a href=&quot;https://github.com/apache/thrift/pull/2124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/2124&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;From the message, &lt;tt&gt;TServerSocket::listen() Could not bind to 0&lt;/tt&gt; &#8212; I get the impression that tests are trying to listen on port 0. Which might be correct thing to request (like INADDR_ANY; asks to allocate a free port), and might be incorrect, depending on socket options and flags.&lt;/p&gt;

&lt;p&gt;I really need to reproduce it first, before saying for sure.&lt;/p&gt;</comment>
                            <comment id="17106172" author="emmenlau" created="Wed, 13 May 2020 09:57:53 +0000"  >&lt;p&gt;Hey,&lt;/p&gt;

&lt;p&gt;thanks for the feedback! I was also quite surprised to see this problem because we run tests on a number of platforms and I can only trigger the issue in a dockerized test. Windows, MacOS and Linux without docker work fine for me too.&lt;/p&gt;

&lt;p&gt;The failing tests are mostly default Apache Thrift tests that I run unmodified. I would assume that the use of port 0 is intentional and should select a random free port - at least this is something we also use a lot in production with Thrift servers. Also, without your patch these same tests work fine, so there seems to be some causality.&lt;/p&gt;

&lt;p&gt;I assume the issue must be related to the Docker network setup. That would make some sense to me, as your PR also mentions specifically cases where hosts may have an untypical small network setup, like no IPv4/no IPv6/only loopback. This may be true for my Docker containers.&lt;/p&gt;

&lt;p&gt;The problem is I&apos;m using a relatively default docker setup for gitlab runner. So I did not configure the network myself. I can&apos;t say much about how its configured. Is there something specific that may be helpful for you to know? I can run Linux commands in the test setup, albeit with some effort. Would it help to list the available devices and the routing table? Or do you have access to a Docker container?&lt;/p&gt;</comment>
                            <comment id="17106179" author="emmenlau" created="Wed, 13 May 2020 10:13:00 +0000"  >&lt;p&gt;For what its worth, here is the documentation about the default gitlab runner Docker network setup: &lt;a href=&quot;https://docs.gitlab.com/runner/executors/docker.html#networking&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.gitlab.com/runner/executors/docker.html#networking&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The default network mode supposedly uses &lt;a href=&quot;https://docs.docker.com/network/links/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Legacy container links&lt;/a&gt; with the default &lt;a href=&quot;https://docs.docker.com/engine/reference/run/#network-settings&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Docker bridge mode&lt;/a&gt; to link the job container with the services.&lt;/p&gt;</comment>
                            <comment id="17106191" author="ulidtko" created="Wed, 13 May 2020 10:40:42 +0000"  >&lt;p&gt;Also, I&apos;d like to inspect the setup of docker environment, to see if cause of the issue is rooted there.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;TServerIntegrationTest&lt;/b&gt; &#8212; which you mention is failing in that environment &#8212; is passing in my local build on 55680af.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ulidtko@pasocon ~/s/thrift (master)&amp;gt; BUILD/bin/TServerIntegrationTest -r detailed
Running 13 test cases...

Test module &lt;span class=&quot;code-quote&quot;&gt;&quot;TServerIntegrationTest&quot;&lt;/span&gt; has passed with:
  13 test cases out of 13 passed
  21 assertions out of 21 passed

  Test suite &lt;span class=&quot;code-quote&quot;&gt;&quot;constructors&quot;&lt;/span&gt; has passed with:
    10 test cases out of 10 passed
    10 assertions out of 10 passed

    Test &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;constructors/test_simple_factory&quot;&lt;/span&gt; has passed with:
      1 assertion out of 1 passed

    Test &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;constructors/test_simple&quot;&lt;/span&gt; has passed with:
      1 assertion out of 1 passed

    Test &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;constructors/test_threaded_factory&quot;&lt;/span&gt; has passed with:
      1 assertion out of 1 passed

    Test &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;constructors/test_threaded&quot;&lt;/span&gt; has passed with:
      1 assertion out of 1 passed

    Test &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;constructors/test_threaded_bound&quot;&lt;/span&gt; has passed with:
      1 assertion out of 1 passed

    Test &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;constructors/test_threaded_stress&quot;&lt;/span&gt; has passed with:
      1 assertion out of 1 passed

    Test &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;constructors/test_threadpool_factory&quot;&lt;/span&gt; has passed with:
      1 assertion out of 1 passed

    Test &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;constructors/test_threadpool&quot;&lt;/span&gt; has passed with:
      1 assertion out of 1 passed

    Test &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;constructors/test_threadpool_bound&quot;&lt;/span&gt; has passed with:
      1 assertion out of 1 passed

    Test &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;constructors/test_threadpool_stress&quot;&lt;/span&gt; has passed with:
      1 assertion out of 1 passed

  Test suite &lt;span class=&quot;code-quote&quot;&gt;&quot;TServerIntegrationTest&quot;&lt;/span&gt; has passed with:
    3 test cases out of 3 passed
    11 assertions out of 11 passed

    Test &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;TServerIntegrationTest/test_stop_with_interruptable_clients_connected&quot;&lt;/span&gt; has passed with:
      2 assertions out of 2 passed

    Test &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;TServerIntegrationTest/test_stop_with_uninterruptable_clients_connected&quot;&lt;/span&gt; has passed with:
      1 assertion out of 1 passed

    Test &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;TServerIntegrationTest/test_concurrent_client_limit&quot;&lt;/span&gt; has passed with:
      8 assertions out of 8 passed
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;ve run this 10 times, and got 10 consequent passes.&lt;/p&gt;

&lt;p&gt;Likewise for &lt;b&gt;BUILD/bin/UnitTests&lt;/b&gt; &#8212; which actually do call listen on &lt;tt&gt;(&quot;localhost&quot;, 0)&lt;/tt&gt; (see in &lt;tt&gt;lib/cpp/test/TServerSocketTest.cpp&lt;/tt&gt;). Passes every time for me. Moreover, TTransportException is correctly raised by &lt;tt&gt;TServerSocket(&quot;257.258.259.260&quot;, 0)&lt;/tt&gt;, as it should, on line 47 of TServerSocketTest.cpp.&lt;/p&gt;

&lt;p&gt;Travis doesn&apos;t run these unit tests (?!?), at least it seems so from the build logs: &lt;a href=&quot;https://travis-ci.org/github/apache/thrift/builds/680570631&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/github/apache/thrift/builds/680570631&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This difference in behavior makes me think that it&apos;s not the patch which is causing the failures, but an environment difference. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=emmenlau&quot; class=&quot;user-hover&quot; rel=&quot;emmenlau&quot;&gt;emmenlau&lt;/a&gt; please tell me which scripts/steps to follow to replicate &#8212; I can take a look into that.&lt;/p&gt;</comment>
                            <comment id="17106203" author="ulidtko" created="Wed, 13 May 2020 10:51:58 +0000"  >&lt;p&gt;Okay, thanks for getting back to me. I&apos;m okay with Docker, but replicating a GitLab runner independently is going to be a bit difficult.&lt;/p&gt;

&lt;p&gt;Can we meet somewhere in chat maybe to try to figure this out quickly?&lt;/p&gt;</comment>
                            <comment id="17106215" author="ulidtko" created="Wed, 13 May 2020 11:16:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;...&#160;no IPv4/no IPv6/only loopback. This may be true for my Docker containers.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Unlikely; the default bridge interface in Docker container would be an additional interface, like&#160;&lt;tt&gt;eth0&lt;/tt&gt; here:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ulidtko@pasocon ~/s/thrift (master)&amp;gt; docker run --rm -it alpine ifconfig
Unable to find image &lt;span class=&quot;code-quote&quot;&gt;&apos;alpine:latest&apos;&lt;/span&gt; locally
latest: Pulling from library/alpine
cbdbe7a5bc2a: Already exists 
Digest: sha256:9a839e63dad54c3a6d1834e29692c8492d93f90c59c978c1ed79109ea4fb9a54
Status: Downloaded newer image &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; alpine:latest
eth0      Link encap:Ethernet  HWaddr 02:42:AC:11:00:02  
          inet addr:172.17.0.2  Bcast:172.17.255.255  Mask:255.255.0.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:3 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:310 (310.0 B)  TX bytes:0 (0.0 B)lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;There might be capabilities/permissions issues (unless Gitlab runs containers with &lt;tt&gt;--privileged&lt;/tt&gt; which I think it doesn&apos;t).&lt;/p&gt;

&lt;p&gt;Some info might be seen in `docker inspect &amp;lt;container_id&amp;gt;` output... What I&apos;d do is run the compiled test in the container under &lt;tt&gt;strace&lt;/tt&gt;, to see what&apos;s the kernel response to the bind syscall.&lt;/p&gt;</comment>
                            <comment id="17106454" author="ulidtko" created="Wed, 13 May 2020 16:40:49 +0000"  >&lt;p&gt;Keeping today&apos;s findings posted. Still not sure if this is to be fixed with further patches, or if one would claim it&apos;s a&#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;pervasively common&amp;#93;&lt;/span&gt; misconfiguration (e.g. Docker default). Probably the former.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;TServerSocket::listen() has this piece, setting IPV6_V6ONLY on AF_INET6 sockets:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
#ifdef IPV6_V6ONLY
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (path_.empty() &amp;amp;&amp;amp; res-&amp;gt;ai_family == AF_INET6) {
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; zero = 0;
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (-1 == setsockopt(serverSocket_,
                         IPPROTO_IPV6,
                         IPV6_V6ONLY,
                         cast_sockopt(&amp;amp;zero),
                         sizeof(zero))) {
      GlobalOutput.perror(&lt;span class=&quot;code-quote&quot;&gt;&quot;TServerSocket::listen() IPV6_V6ONLY &quot;&lt;/span&gt;, THRIFT_GET_SOCKET_ERROR);    
    }
  }
#endif &lt;span class=&quot;code-comment&quot;&gt;// #ifdef IPV6_V6ONLY&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;More importantly, this is how &lt;tt&gt;getaddrinfo()&lt;/tt&gt; results are processed in TServerSocket::listen():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-comment&quot;&gt;// Pick the ipv6 address first since ipv4 addresses can be mapped
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// into ipv6 space.
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (res = info.res(); res; res = res-&amp;gt;ai_next) {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (res-&amp;gt;ai_family == AF_INET6 || res-&amp;gt;ai_next == nullptr)
        &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I.e. IPv6 results are unconditionally preferred.&lt;/p&gt;

&lt;p&gt;This, together with &lt;tt&gt;::1 localhost&lt;/tt&gt; entry in &lt;tt&gt;/etc/hosts&lt;/tt&gt;, and removed &lt;tt&gt;AI_ADDRCONFIG&lt;/tt&gt; hint &#8212; leads to funny result: &lt;tt&gt;localhost&lt;/tt&gt; resolves to something which you can&apos;t connect() to, at least in Docker containers with the default v4-only bridge network.&lt;/p&gt;

&lt;p&gt;The issue goes away if I configure IPv6 in Docker. &lt;a href=&quot;https://docs.docker.com/config/daemon/ipv6/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.docker.com/config/daemon/ipv6/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The issue goes away if I comment out the &lt;tt&gt;::1 localhost&lt;/tt&gt; entry in container&apos;s /etc/hosts.&lt;/p&gt;

&lt;p&gt;The issue also goes away if I bring back &lt;tt&gt;AI_ADDRCONFIG&lt;/tt&gt; hint. But then, I get &quot;getaddrinfo() &amp;lt;Host: 127.0.0.1 Port: 1302&amp;gt;Address family for hostname not supported&quot; with loopback-only network. Hmmm.&lt;/p&gt;

&lt;p&gt;Current conclusion at this point: in that do-while bind()-retry loop, TServerSocket should also loop over the individual &lt;tt&gt;getaddrinfo&lt;/tt&gt; results. That way, it would work around this (seemingly standard and OK!) situation:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[root@04dd07b70038 /]# ping -6 localhost
ping: connect: Cannot assign requested address
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17107470" author="ulidtko" created="Thu, 14 May 2020 16:55:30 +0000"  >&lt;p&gt;Look how curl does it!&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ulidtko@pasocon ~/s/enlightenment&amp;gt; curl -v localhost:8001/index.&lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt;
* Trying ::1:8001...
* connect to ::1 port 8001 failed: Connection refused
* Trying 127.0.0.1:8001...
* Connected to localhost (127.0.0.1) port 8001 (#0)
&amp;gt; GET /index.&lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; HTTP/1.1
&amp;gt; Host: localhost:8001
&amp;gt; User-Agent: curl/7.70.0
&amp;gt; Accept: */*
&amp;gt; 
...

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Now, I&apos;m convinced we should loop over &lt;tt&gt;getaddrinfo&lt;/tt&gt; results, and just try until one works.&lt;/p&gt;</comment>
                            <comment id="17107512" author="emmenlau" created="Thu, 14 May 2020 17:53:11 +0000"  >&lt;p&gt;This sounds very reasonable, and in any case I could not see how this would &lt;b&gt;not&lt;/b&gt; be better than the current behavior. Picking one random try and possibly failing while other interfaces may work seems inferior to your proposal.&lt;/p&gt;</comment>
                            <comment id="17112055" author="ulidtko" created="Wed, 20 May 2020 11:00:46 +0000"  >&lt;p&gt;Status update: I&apos;ve written &amp;amp; am testing now another patch, which implements curl-like behavior in TSocketServer (iteration over getaddrinfo() results, until one works).&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;make test&lt;/tt&gt; seems to be good!&lt;/p&gt;

&lt;p&gt;Now I only need to replicate the change on TNonBlockingSocketServer too.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=emmenlau&quot; class=&quot;user-hover&quot; rel=&quot;emmenlau&quot;&gt;emmenlau&lt;/a&gt; which scripts/techniques you use to test thrift besides CMake&apos;s &lt;tt&gt;make test&lt;/tt&gt;, would you share?&lt;/p&gt;

&lt;p&gt;Also: I think I can automate tests running in different network environments (loopback-only, usual IPv4 bridge, dual IPv4-IPv6) using Docker; that&apos;s how I test it manually. Any suggestions on where/how to add a script like that?&lt;/p&gt;</comment>
                            <comment id="17112196" author="emmenlau" created="Wed, 20 May 2020 13:27:31 +0000"  >&lt;p&gt;Dear &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ulidtko&quot; class=&quot;user-hover&quot; rel=&quot;ulidtko&quot;&gt;ulidtko&lt;/a&gt;, awesome, this sounds like a useful improvement, looking forward!&lt;/p&gt;

&lt;p&gt;About testing, its (sadly) not super trivial. I personally only use cmake with &quot;make test&quot;, but the official build system is still based on autotools. For C++ I think they are mostly identical, but the CI system may run some more checks or cross-implementation-checks only when used in AppVeyor or Travis. I&apos;m not super experienced in this &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
You can find everything related to building and testing in the &quot;build/&quot; directory. But depending how familiar you are with AppVeyor and Travis, I did not find it completely trivial to extend the tests.&lt;/p&gt;</comment>
                            <comment id="17129807" author="jensg" created="Tue, 9 Jun 2020 21:11:30 +0000"  >
&lt;p&gt;Original comment from &lt;a href=&quot;https://github.com/apache/thrift/pull/2151&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/2151&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;My previous patch (9b9567b23378c821b460cfe54b70b9d189bf194d) has exposed&lt;br/&gt;
an issue shared by TServerSocket and TNonblockingServerSocket:&lt;br/&gt;
the results of getaddrinfo() call aren&apos;t used &quot;in full&quot; &amp;#8211; just a single&lt;br/&gt;
address is picked, and then bind() is retried in a loop on that single address.&lt;/p&gt;

&lt;p&gt;This leads to poor results if we start varying the network conditions.&lt;br/&gt;
Like I show in the Jira issue, this is normal:&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;root@04dd07b70038 /&amp;#93;&lt;/span&gt;# ping -6 localhost&lt;br/&gt;
    ping: connect: Cannot assign requested address&lt;/p&gt;

&lt;p&gt;&amp;#8211; same with `ping -6 $(hostname)` &amp;#8211; a hostname may resolve to IPv6 address&lt;br/&gt;
which we might not be able to connect to; and vice-versa, connecting to&lt;br/&gt;
IPv4 addresses may fail on IPv6-only systems.&lt;/p&gt;

&lt;p&gt;The solution is to iterate over what getaddrinfo() returns while retrying&lt;br/&gt;
failed bind(). This is what this patch implements. Server-side analogue&lt;br/&gt;
of this behavior of curl:&lt;/p&gt;

&lt;p&gt;    &amp;gt; curl -v localhost:8001/index.do&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Trying ::1:8001...&lt;/li&gt;
	&lt;li&gt;connect to ::1 port 8001 failed: Connection refused&lt;/li&gt;
	&lt;li&gt;Trying 127.0.0.1:8001...&lt;/li&gt;
	&lt;li&gt;Connected to localhost (127.0.0.1) port 8001 (#0)&lt;br/&gt;
    &amp;gt; GET /index.do HTTP/1.1&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;To achieve that, I throw away the TGetAddrInfoWrapper, and roll a proper one.&lt;/p&gt;

&lt;p&gt;The bind-retrying loop had to be restructured: since sa_family will vary&lt;br/&gt;
from retry to retry, the socket() call has to be within the loop.&lt;/p&gt;

&lt;p&gt;All the setsockopt() business factored away into side-methods: ~hundred&lt;br/&gt;
repetitive #ifdef-rich lines in the middle of important loop do get in the way.&lt;/p&gt;

&lt;p&gt;This patch has quite a lot of code movement; git config diff.colormoved zebra&lt;br/&gt;
is strongly advised to the reader.&lt;/p&gt;

&lt;p&gt;Tested manually on Linux, by running CMake&apos;s `make test` in 3 Docker environments:&lt;br/&gt;
 1) loopback-only (--net=none)&lt;br/&gt;
 2) classic IPv4-only bridge&lt;br/&gt;
 3) dual IPv6-IPv4 bridge&lt;br/&gt;
The only failing test was 88 - PythonTestSSLSocket, which currently also&lt;br/&gt;
fails on master for me (due to NULL cipher being unexpectedly accepted).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13001326" name="0001-THRIFT-5186-Dont-pass-AI_ADDRCONFIG-to-getaddrinfo.patch" size="3907" author="ulidtko" created="Mon, 27 Apr 2020 13:44:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 23 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0e4cg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>