<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:29:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-4620] TZlibTransport.cpp doesn&apos;t ensure that there is enough space for the zlib flush marker in the buffer.</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-4620</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;I asked &lt;a href=&quot;https://stackoverflow.com/questions/51784225/how-does-thrift-handle-zlib-flush-markers-being-split-over-multiple-messages&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this question&lt;/a&gt; on stack overflow related to a crash that I have been getting with Thrift.&lt;/p&gt;

&lt;p&gt;The problem occurs when using TZlibTransport.cpp. After writing to the buffer a few times, we do a flush. If there isn&apos;t enough space in cwbuf_ , the Thrift flush marker is split across two messages, which causes an error in the client, as a deflate stream can&apos;t start with a partial flush marker, ff.&lt;/p&gt;

&lt;p&gt;Thrift should assure that there will be enough space in the buffer for the complete flush marker, before a deflate.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13178546">THRIFT-4620</key>
            <summary>TZlibTransport.cpp doesn&apos;t ensure that there is enough space for the zlib flush marker in the buffer.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jking3">James E. King III</assignee>
                                    <reporter username="ldsrc">Dominic Coyne</reporter>
                        <labels>
                            <label>c++</label>
                            <label>zlib</label>
                    </labels>
                <created>Mon, 13 Aug 2018 09:23:53 +0000</created>
                <updated>Thu, 27 Dec 2018 15:25:12 +0000</updated>
                            <resolved>Sun, 16 Sep 2018 10:52:45 +0000</resolved>
                                    <version>0.9</version>
                                    <fixVersion>0.12.0</fixVersion>
                                    <component>C++ - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16610565" author="githubbot" created="Tue, 11 Sep 2018 13:20:48 +0000"  >&lt;p&gt;domscoyne opened a new pull request #1591: &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4620&quot; title=&quot;TZlibTransport.cpp doesn&amp;#39;t ensure that there is enough space for the zlib flush marker in the buffer.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4620&quot;&gt;&lt;del&gt;THRIFT-4620&lt;/del&gt;&lt;/a&gt;: Ensure enough space for for zlib flush marker&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/thrift/pull/1591&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1591&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Client: lib/cpp&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16611132" author="githubbot" created="Tue, 11 Sep 2018 19:26:16 +0000"  >&lt;p&gt;jeking3 commented on issue #1591: &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4620&quot; title=&quot;TZlibTransport.cpp doesn&amp;#39;t ensure that there is enough space for the zlib flush marker in the buffer.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4620&quot;&gt;&lt;del&gt;THRIFT-4620&lt;/del&gt;&lt;/a&gt;: Ensure enough space for for zlib flush marker&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/thrift/pull/1591#issuecomment-420393230&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1591#issuecomment-420393230&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   I don&apos;t believe that the cross test framework will test zlib changes; not sure if the unit tests do a good job at that either.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16611135" author="githubbot" created="Tue, 11 Sep 2018 19:28:55 +0000"  >&lt;p&gt;jeking3 edited a comment on issue #1591: &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4620&quot; title=&quot;TZlibTransport.cpp doesn&amp;#39;t ensure that there is enough space for the zlib flush marker in the buffer.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4620&quot;&gt;&lt;del&gt;THRIFT-4620&lt;/del&gt;&lt;/a&gt;: Ensure enough space for for zlib flush marker&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/thrift/pull/1591#issuecomment-420393230&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1591#issuecomment-420393230&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   I don&apos;t believe that the cross test framework will test zlib changes; not sure if the unit tests do a good job at that either.  If anyone else has an opinion on this, let me know.  Looks fine to me otherwise, but I don&apos;t see any explicit test that would use a zlib transport and flush empty to force this.  Is there a way to modify the zlib unit test to force this condition during the test?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16616302" author="githubbot" created="Sat, 15 Sep 2018 13:59:07 +0000"  >&lt;p&gt;jeking3 edited a comment on issue #1591: &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4620&quot; title=&quot;TZlibTransport.cpp doesn&amp;#39;t ensure that there is enough space for the zlib flush marker in the buffer.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4620&quot;&gt;&lt;del&gt;THRIFT-4620&lt;/del&gt;&lt;/a&gt;: Ensure enough space for for zlib flush marker&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/thrift/pull/1591#issuecomment-420393230&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1591#issuecomment-420393230&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   I don&apos;t believe that the cross test framework will test zlib changes; not sure if the unit tests do a good job at that either.  If anyone else has an opinion on this, let me know.  Looks fine to me otherwise, but I don&apos;t see any explicit test that would use a zlib transport and flush empty to force this.  Is there a way to modify the zlib unit test to force this condition during the test?&lt;/p&gt;

&lt;p&gt;   I see that the golang test client and server support zlib; I&apos;m going to add the bits to test zlib transport in the C++ client and server and have them cross test, and I&apos;ll push that back into your branch to re-run in CI.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16616667" author="githubbot" created="Sun, 16 Sep 2018 10:51:42 +0000"  >&lt;p&gt;jeking3 closed pull request #1591: &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4620&quot; title=&quot;TZlibTransport.cpp doesn&amp;#39;t ensure that there is enough space for the zlib flush marker in the buffer.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4620&quot;&gt;&lt;del&gt;THRIFT-4620&lt;/del&gt;&lt;/a&gt;: Ensure enough space for for zlib flush marker&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/thrift/pull/1591&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1591&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/lib/cpp/src/thrift/transport/TZlibTransport.cpp b/lib/cpp/src/thrift/transport/TZlibTransport.cpp&lt;br/&gt;
index fb5cc5da16..e426dc390c 100644&lt;br/&gt;
&amp;#8212; a/lib/cpp/src/thrift/transport/TZlibTransport.cpp&lt;br/&gt;
+++ b/lib/cpp/src/thrift/transport/TZlibTransport.cpp&lt;br/&gt;
@@ -255,6 +255,15 @@ void TZlibTransport::flush() &lt;/p&gt;
{
     throw TTransportException(TTransportException::BAD_ARGS, &quot;flush() called after finish()&quot;);
   }

&lt;p&gt;+  flushToZlib(uwbuf_, uwpos_, Z_BLOCK);&lt;br/&gt;
+  uwpos_ = 0;&lt;br/&gt;
+&lt;br/&gt;
+  if(wstream_-&amp;gt;avail_out &amp;lt; 6)&lt;/p&gt;
{
+    transport_-&amp;gt;write(cwbuf_, cwbuf_size_ - wstream_-&amp;gt;avail_out);
+    wstream_-&amp;gt;next_out = cwbuf_;
+    wstream_-&amp;gt;avail_out = cwbuf_size_;
+  }
&lt;p&gt;+&lt;br/&gt;
   flushToTransport(Z_FULL_FLUSH);&lt;br/&gt;
 }&lt;/p&gt;

&lt;p&gt;@@ -285,7 +294,7 @@ void TZlibTransport::flushToZlib(const uint8_t* buf, int len, int flush) {&lt;br/&gt;
   wstream_-&amp;gt;avail_in = len;&lt;/p&gt;

&lt;p&gt;   while (true) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (flush == Z_NO_FLUSH &amp;amp;&amp;amp; wstream_-&amp;gt;avail_in == 0) {&lt;br/&gt;
+    if ((flush == Z_NO_FLUSH || flush == Z_BLOCK) &amp;amp;&amp;amp; wstream_-&amp;gt;avail_in == 0) 
{
       break;
     }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;diff --git a/test/cpp/CMakeLists.txt b/test/cpp/CMakeLists.txt&lt;br/&gt;
index cdd63dbf0d..95d2991f8b 100755&lt;br/&gt;
&amp;#8212; a/test/cpp/CMakeLists.txt&lt;br/&gt;
+++ b/test/cpp/CMakeLists.txt&lt;br/&gt;
@@ -28,6 +28,9 @@ include_directories(SYSTEM &quot;${OPENSSL_INCLUDE_DIR}&quot;)&lt;br/&gt;
 find_package(Libevent REQUIRED)  # Libevent comes with CMake support from upstream&lt;br/&gt;
 include_directories(SYSTEM ${LIBEVENT_INCLUDE_DIRS})&lt;/p&gt;

&lt;p&gt;+find_package(ZLIB REQUIRED)&lt;br/&gt;
+include_directories(SYSTEM ${ZLIB_INCLUDE_DIRS})&lt;br/&gt;
+&lt;br/&gt;
 #Make sure gen-cpp files can be included&lt;br/&gt;
 include_directories(&quot;${CMAKE_CURRENT_BINARY_DIR}&quot;)&lt;br/&gt;
 include_directories(&quot;${CMAKE_CURRENT_BINARY_DIR}/gen-cpp&quot;)&lt;br/&gt;
diff --git a/test/cpp/src/TestClient.cpp b/test/cpp/src/TestClient.cpp&lt;br/&gt;
index 87bb0283ab..54b43dba85 100644&lt;br/&gt;
&amp;#8212; a/test/cpp/src/TestClient.cpp&lt;br/&gt;
+++ b/test/cpp/src/TestClient.cpp&lt;br/&gt;
@@ -31,6 +31,7 @@&lt;br/&gt;
 #include &amp;lt;thrift/transport/TTransportUtils.h&amp;gt;&lt;br/&gt;
 #include &amp;lt;thrift/transport/TSocket.h&amp;gt;&lt;br/&gt;
 #include &amp;lt;thrift/transport/TSSLSocket.h&amp;gt;&lt;br/&gt;
+#include &amp;lt;thrift/transport/TZlibTransport.h&amp;gt;&lt;br/&gt;
 #include &amp;lt;thrift/async/TEvhttpClientChannel.h&amp;gt;&lt;br/&gt;
 #include &amp;lt;thrift/server/TNonblockingServer.h&amp;gt; // &amp;lt;event.h&amp;gt;&lt;/p&gt;

&lt;p&gt;@@ -154,6 +155,7 @@ int main(int argc, char** argv) {&lt;br/&gt;
   int port = 9090;&lt;br/&gt;
   int numTests = 1;&lt;br/&gt;
   bool ssl = false;&lt;br/&gt;
+  bool zlib = false;&lt;br/&gt;
   string transport_type = &quot;buffered&quot;;&lt;br/&gt;
   string protocol_type = &quot;binary&quot;;&lt;br/&gt;
   string domain_socket = &quot;&quot;;&lt;br/&gt;
@@ -179,12 +181,14 @@ int main(int argc, char** argv) {&lt;br/&gt;
           &quot; (no connection with filesystem pathnames)&quot;)&lt;br/&gt;
       (&quot;transport&quot;,&lt;br/&gt;
           boost::program_options::value&amp;lt;string&amp;gt;(&amp;amp;transport_type)-&amp;gt;default_value(transport_type),&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&quot;Transport: buffered, framed, http, evhttp&quot;)&lt;br/&gt;
+          &quot;Transport: buffered, framed, http, evhttp, zlib&quot;)&lt;br/&gt;
       (&quot;protocol&quot;,&lt;br/&gt;
           boost::program_options::value&amp;lt;string&amp;gt;(&amp;amp;protocol_type)-&amp;gt;default_value(protocol_type),&lt;br/&gt;
           &quot;Protocol: binary, compact, header, json, multi, multic, multih, multij&quot;)&lt;br/&gt;
       (&quot;ssl&quot;,&lt;br/&gt;
           &quot;Encrypted Transport using SSL&quot;)&lt;br/&gt;
+      (&quot;zlib&quot;,&lt;br/&gt;
+          &quot;Wrap Transport with Zlib&quot;)&lt;br/&gt;
       (&quot;testloops,n&quot;,&lt;br/&gt;
           boost::program_options::value&amp;lt;int&amp;gt;(&amp;amp;numTests)-&amp;gt;default_value(numTests),&lt;br/&gt;
           &quot;Number of Tests&quot;)&lt;br/&gt;
@@ -220,6 +224,8 @@ int main(int argc, char** argv) {&lt;br/&gt;
       } else if (transport_type == &quot;framed&quot;) {&lt;br/&gt;
       } else if (transport_type == &quot;http&quot;) {&lt;br/&gt;
       } else if (transport_type == &quot;evhttp&quot;) 
{
+      } else if (transport_type == &quot;zlib&quot;) {
+        // crosstest will pass zlib as a transport and as a flag right now..
       } else {
         throw invalid_argument(&quot;Unknown transport type &quot; + transport_type);
       }&lt;br/&gt;
@@ -235,6 +241,10 @@ int main(int argc, char** argv) {
     ssl = true;
   }&lt;br/&gt;
 &lt;br/&gt;
+  if (vm.count(&quot;zlib&quot;)) {
+    zlib = true;
+  }&lt;br/&gt;
+&lt;br/&gt;
   if (vm.count(&quot;abstract-namespace&quot;)) {
     abstract_namespace = true;
   }&lt;br/&gt;
@@ -278,14 +288,15 @@ int main(int argc, char** argv) {&lt;br/&gt;
   }&lt;br/&gt;
 &lt;br/&gt;
   if (transport_type.compare(&quot;http&quot;) == 0) {
-    stdcxx::shared_ptr&amp;lt;TTransport&amp;gt; httpSocket(new THttpClient(socket, host, &quot;/service&quot;));
-    transport = httpSocket;
+    transport = stdcxx::make_shared&amp;lt;THttpClient&amp;gt;(socket, host, &quot;/service&quot;);
   } else if (transport_type.compare(&quot;framed&quot;) == 0) {
-    stdcxx::shared_ptr&amp;lt;TFramedTransport&amp;gt; framedSocket(new TFramedTransport(socket));
-    transport = framedSocket;
+    transport = stdcxx::make_shared&amp;lt;TFramedTransport&amp;gt;(socket);
   } else {
-    stdcxx::shared_ptr&amp;lt;TBufferedTransport&amp;gt; bufferedSocket(new TBufferedTransport(socket));
-    transport = bufferedSocket;
+    transport = stdcxx::make_shared&amp;lt;TBufferedTransport&amp;gt;(socket);
+  }&lt;br/&gt;
+&lt;br/&gt;
+  if (zlib) {
+    transport = stdcxx::make_shared&amp;lt;TZlibTransport&amp;gt;(transport);
   }&lt;br/&gt;
 &lt;br/&gt;
   if (protocol_type == &quot;json&quot; || protocol_type == &quot;multij&quot;) {&lt;br/&gt;
diff --git a/test/cpp/src/TestServer.cpp b/test/cpp/src/TestServer.cpp&lt;br/&gt;
index 1c38124102..323f873547 100644&lt;br/&gt;
&amp;#8212; a/test/cpp/src/TestServer.cpp&lt;br/&gt;
+++ b/test/cpp/src/TestServer.cpp&lt;br/&gt;
@@ -39,6 +39,7 @@&lt;br/&gt;
 #include &amp;lt;thrift/transport/TSSLSocket.h&amp;gt;&lt;br/&gt;
 #include &amp;lt;thrift/transport/TServerSocket.h&amp;gt;&lt;br/&gt;
 #include &amp;lt;thrift/transport/TTransportUtils.h&amp;gt;&lt;br/&gt;
+#include &amp;lt;thrift/transport/TZlibTransport.h&amp;gt;&lt;br/&gt;
 &lt;br/&gt;
 #include &quot;SecondService.h&quot;&lt;br/&gt;
 #include &quot;ThriftTest.h&quot;&lt;br/&gt;
@@ -571,6 +572,7 @@ int main(int argc, char** argv) {&lt;br/&gt;
 #endif&lt;br/&gt;
   int port = 9090;&lt;br/&gt;
   bool ssl = false;&lt;br/&gt;
+  bool zlib = false;&lt;br/&gt;
   string transport_type = &quot;buffered&quot;;&lt;br/&gt;
   string protocol_type = &quot;binary&quot;;&lt;br/&gt;
   string server_type = &quot;simple&quot;;&lt;br/&gt;
@@ -587,9 +589,10 @@ int main(int argc, char** argv) {&lt;br/&gt;
     (&quot;domain-socket&quot;, po::value&amp;lt;string&amp;gt;(&amp;amp;domain_socket) -&amp;gt;default_value(domain_socket), &quot;Unix Domain Socket (e.g. /tmp/ThriftTest.thrift)&quot;)&lt;br/&gt;
     (&quot;abstract-namespace&quot;, &quot;Create the domain socket in the Abstract Namespace (no connection with filesystem pathnames)&quot;)&lt;br/&gt;
     (&quot;server-type&quot;, po::value&amp;lt;string&amp;gt;(&amp;amp;server_type)-&amp;gt;default_value(server_type), &quot;type of server, \&quot;simple\&quot;, \&quot;thread-pool\&quot;, \&quot;threaded\&quot;, or \&quot;nonblocking\&quot;&quot;)&lt;br/&gt;
-    (&quot;transport&quot;, po::value&amp;lt;string&amp;gt;(&amp;amp;transport_type)-&amp;gt;default_value(transport_type), &quot;transport: buffered, framed, http&quot;)&lt;br/&gt;
+    (&quot;transport&quot;, po::value&amp;lt;string&amp;gt;(&amp;amp;transport_type)-&amp;gt;default_value(transport_type), &quot;transport: buffered, framed, http, zlib&quot;)&lt;br/&gt;
     (&quot;protocol&quot;, po::value&amp;lt;string&amp;gt;(&amp;amp;protocol_type)-&amp;gt;default_value(protocol_type), &quot;protocol: binary, compact, header, json, multi, multic, multih, multij&quot;)&lt;br/&gt;
     (&quot;ssl&quot;, &quot;Encrypted Transport using SSL&quot;)&lt;br/&gt;
+    (&quot;zlib&quot;, &quot;Wrapped Transport using Zlib&quot;)&lt;br/&gt;
     (&quot;processor-events&quot;, &quot;processor-events&quot;)&lt;br/&gt;
     (&quot;workers,n&quot;, po::value&amp;lt;size_t&amp;gt;(&amp;amp;workers)-&amp;gt;default_value(workers), &quot;Number of thread pools workers. Only valid for thread-pool server type&quot;)&lt;br/&gt;
     (&quot;string-limit&quot;, po::value&amp;lt;int&amp;gt;(&amp;amp;string_limit))&lt;br/&gt;
@@ -633,6 +636,8 @@ int main(int argc, char** argv) {&lt;br/&gt;
       if (transport_type == &quot;buffered&quot;) {&lt;br/&gt;
       } else if (transport_type == &quot;framed&quot;) {&lt;br/&gt;
       } else if (transport_type == &quot;http&quot;) {+      }
&lt;p&gt; else if (transport_type == &quot;zlib&quot;) &lt;/p&gt;
{
+        // crosstester will pass zlib as a flag and a transport right now...
       }
&lt;p&gt; else &lt;/p&gt;
{
         throw invalid_argument(&quot;Unknown transport type &quot; + transport_type);
       }
&lt;p&gt;@@ -648,6 +653,10 @@ int main(int argc, char** argv) &lt;/p&gt;
{
     ssl = true;
   }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+  if (vm.count(&quot;zlib&quot;)) &lt;/p&gt;
{
+    zlib = true;
+  }
&lt;p&gt;+&lt;br/&gt;
 #if defined(HAVE_SIGNAL_H) &amp;amp;&amp;amp; defined(SIGPIPE)&lt;br/&gt;
   if (ssl) {&lt;br/&gt;
     signal(SIGPIPE, SIG_IGN); // for OpenSSL, otherwise we end abruptly&lt;br/&gt;
@@ -719,14 +728,16 @@ int main(int argc, char** argv) {&lt;br/&gt;
   stdcxx::shared_ptr&amp;lt;TTransportFactory&amp;gt; transportFactory;&lt;/p&gt;

&lt;p&gt;   if (transport_type == &quot;http&quot; &amp;amp;&amp;amp; server_type != &quot;nonblocking&quot;) &lt;/p&gt;
{
-    stdcxx::shared_ptr&amp;lt;TTransportFactory&amp;gt; httpTransportFactory(new THttpServerTransportFactory());
-    transportFactory = httpTransportFactory;
+    transportFactory = stdcxx::make_shared&amp;lt;THttpServerTransportFactory&amp;gt;();
   }
&lt;p&gt; else if (transport_type == &quot;framed&quot;) &lt;/p&gt;
{
-    stdcxx::shared_ptr&amp;lt;TTransportFactory&amp;gt; framedTransportFactory(new TFramedTransportFactory());
-    transportFactory = framedTransportFactory;
+    transportFactory = stdcxx::make_shared&amp;lt;TFramedTransportFactory&amp;gt;();
   }
&lt;p&gt; else &lt;/p&gt;
{
-    stdcxx::shared_ptr&amp;lt;TTransportFactory&amp;gt; bufferedTransportFactory(new TBufferedTransportFactory());
-    transportFactory = bufferedTransportFactory;
+    transportFactory = stdcxx::make_shared&amp;lt;TBufferedTransportFactory&amp;gt;();
+  }
&lt;p&gt;+&lt;br/&gt;
+  if (zlib) &lt;/p&gt;
{
+    // hmm.. doesn&apos;t seem to be a way to make it wrap the others...
+    transportFactory = stdcxx::make_shared&amp;lt;TZlibTransportFactory&amp;gt;();
   }

&lt;p&gt;   // Server Info&lt;br/&gt;
diff --git a/test/crossrunner/test.py b/test/crossrunner/test.py&lt;br/&gt;
index 633e926169..0e912843ab 100644&lt;br/&gt;
&amp;#8212; a/test/crossrunner/test.py&lt;br/&gt;
+++ b/test/crossrunner/test.py&lt;br/&gt;
@@ -66,11 +66,19 @@ def _socket_args(self, socket, port):&lt;br/&gt;
             &apos;abstract&apos;: &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;#39;--abstract-namespace&amp;#39;, &amp;#39;--domain-socket=%s&amp;#39; % domain_socket_path(port)&amp;#93;&lt;/span&gt;,&lt;br/&gt;
         }.get(socket, None)&lt;/p&gt;

&lt;p&gt;+    def _transport_args(self, transport):&lt;br/&gt;
+        return &lt;/p&gt;
{
+            &apos;zlib&apos;: [&apos;--zlib&apos;],
+        }
&lt;p&gt;.get(transport, None)&lt;br/&gt;
+&lt;br/&gt;
     def build_command(self, port):&lt;br/&gt;
         cmd = copy.copy(self._base_command)&lt;br/&gt;
         args = copy.copy(self._extra_args2)&lt;br/&gt;
         args.append(&apos;--protocol=&apos; + self.protocol)&lt;br/&gt;
         args.append(&apos;--transport=&apos; + self.transport)&lt;br/&gt;
+        transport_args = self._transport_args(self.transport)&lt;br/&gt;
+        if transport_args:&lt;br/&gt;
+            args += transport_args&lt;br/&gt;
         socket_args = self._socket_args(self.socket, port)&lt;br/&gt;
         if socket_args:&lt;br/&gt;
             args += socket_args&lt;br/&gt;
diff --git a/test/go/src/bin/testclient/main.go b/test/go/src/bin/testclient/main.go&lt;br/&gt;
index 20104f9e12..4357ee83f9 100644&lt;br/&gt;
&amp;#8212; a/test/go/src/bin/testclient/main.go&lt;br/&gt;
+++ b/test/go/src/bin/testclient/main.go&lt;br/&gt;
@@ -35,6 +35,7 @@ var domain_socket = flag.String(&quot;domain-socket&quot;, &quot;&quot;, &quot;Domain Socket (e.g. /tmp/t&lt;br/&gt;
 var transport = flag.String(&quot;transport&quot;, &quot;buffered&quot;, &quot;Transport: buffered, framed, http, zlib&quot;)&lt;br/&gt;
 var protocol = flag.String(&quot;protocol&quot;, &quot;binary&quot;, &quot;Protocol: binary, compact, json&quot;)&lt;br/&gt;
 var ssl = flag.Bool(&quot;ssl&quot;, false, &quot;Encrypted Transport using SSL&quot;)&lt;br/&gt;
+var zlib = flag.Bool(&quot;zlib&quot;, false, &quot;Wrapped Transport using Zlib&quot;)&lt;br/&gt;
 var testloops = flag.Int(&quot;testloops&quot;, 1, &quot;Number of Tests&quot;)&lt;/p&gt;

&lt;p&gt; func main() {&lt;br/&gt;
diff --git a/test/go/src/bin/testserver/main.go b/test/go/src/bin/testserver/main.go&lt;br/&gt;
index 0bf833d1d8..ca2d967b62 100644&lt;br/&gt;
&amp;#8212; a/test/go/src/bin/testserver/main.go&lt;br/&gt;
+++ b/test/go/src/bin/testserver/main.go&lt;br/&gt;
@@ -34,6 +34,7 @@ var domain_socket = flag.String(&quot;domain-socket&quot;, &quot;&quot;, &quot;Domain Socket (e.g. /tmp/T&lt;br/&gt;
 var transport = flag.String(&quot;transport&quot;, &quot;buffered&quot;, &quot;Transport: buffered, framed, http, zlib&quot;)&lt;br/&gt;
 var protocol = flag.String(&quot;protocol&quot;, &quot;binary&quot;, &quot;Protocol: binary, compact, json&quot;)&lt;br/&gt;
 var ssl = flag.Bool(&quot;ssl&quot;, false, &quot;Encrypted Transport using SSL&quot;)&lt;br/&gt;
+var zlib = flag.Bool(&quot;zlib&quot;, false, &quot;Wrapped Transport using Zlib&quot;)&lt;br/&gt;
 var certPath = flag.String(&quot;certPath&quot;, &quot;keys&quot;, &quot;Directory that contains SSL certificates&quot;)&lt;/p&gt;

&lt;p&gt; func main() {&lt;br/&gt;
diff --git a/test/known_failures_Linux.json b/test/known_failures_Linux.json&lt;br/&gt;
index 9d6d54bcf3..24ce997fb5 100644&lt;br/&gt;
&amp;#8212; a/test/known_failures_Linux.json&lt;br/&gt;
+++ b/test/known_failures_Linux.json&lt;br/&gt;
@@ -311,6 +311,10 @@&lt;br/&gt;
   &quot;go-java_compact_http-ip-ssl&quot;,&lt;br/&gt;
   &quot;go-java_json_http-ip&quot;,&lt;br/&gt;
   &quot;go-java_json_http-ip-ssl&quot;,&lt;br/&gt;
+  &quot;go-py3_binary-accel_zlib-ip-ssl&quot;,&lt;br/&gt;
+  &quot;go-py3_compact-accelc_zlib-ip-ssl&quot;,&lt;br/&gt;
+  &quot;go-py_binary-accel_zlib-ip-ssl&quot;,&lt;br/&gt;
+  &quot;go-py_compact-accelc_zlib-ip-ssl&quot;,&lt;br/&gt;
   &quot;hs-csharp_binary_buffered-ip&quot;,&lt;br/&gt;
   &quot;hs-csharp_binary_framed-ip&quot;,&lt;br/&gt;
   &quot;hs-csharp_compact_buffered-ip&quot;,&lt;br/&gt;
@@ -377,8 +381,12 @@&lt;br/&gt;
   &quot;perl-rs_multi_framed-ip&quot;,&lt;br/&gt;
   &quot;py-cpp_accel-binary_http-ip&quot;,&lt;br/&gt;
   &quot;py-cpp_accel-binary_http-ip-ssl&quot;,&lt;br/&gt;
+  &quot;py-cpp_accel-binary_zlib-ip&quot;,&lt;br/&gt;
+  &quot;py-cpp_accel-binary_zlib-ip-ssl&quot;,&lt;br/&gt;
   &quot;py-cpp_accelc-compact_http-ip&quot;,&lt;br/&gt;
   &quot;py-cpp_accelc-compact_http-ip-ssl&quot;,&lt;br/&gt;
+  &quot;py-cpp_accelc-compact_zlib-ip&quot;,&lt;br/&gt;
+  &quot;py-cpp_accelc-compact_zlib-ip-ssl&quot;,&lt;br/&gt;
   &quot;py-cpp_binary_http-ip&quot;,&lt;br/&gt;
   &quot;py-cpp_binary_http-ip-ssl&quot;,&lt;br/&gt;
   &quot;py-cpp_compact_http-ip&quot;,&lt;br/&gt;
@@ -425,8 +433,12 @@&lt;br/&gt;
   &quot;py-lua_json_http-ip&quot;,&lt;br/&gt;
   &quot;py3-cpp_accel-binary_http-ip&quot;,&lt;br/&gt;
   &quot;py3-cpp_accel-binary_http-ip-ssl&quot;,&lt;br/&gt;
+  &quot;py3-cpp_accel-binary_zlib-ip&quot;,&lt;br/&gt;
+  &quot;py3-cpp_accel-binary_zlib-ip-ssl&quot;,&lt;br/&gt;
   &quot;py3-cpp_accelc-compact_http-ip&quot;,&lt;br/&gt;
   &quot;py3-cpp_accelc-compact_http-ip-ssl&quot;,&lt;br/&gt;
+  &quot;py3-cpp_accelc-compact_zlib-ip&quot;,&lt;br/&gt;
+  &quot;py3-cpp_accelc-compact_zlib-ip-ssl&quot;,&lt;br/&gt;
   &quot;py3-cpp_binary_http-ip&quot;,&lt;br/&gt;
   &quot;py3-cpp_binary_http-ip-ssl&quot;,&lt;br/&gt;
   &quot;py3-cpp_compact_http-ip&quot;,&lt;br/&gt;
@@ -477,4 +489,4 @@&lt;br/&gt;
   &quot;rb-cpp_json_framed-domain&quot;,&lt;br/&gt;
   &quot;rb-cpp_json_framed-ip&quot;,&lt;br/&gt;
   &quot;rb-cpp_json_framed-ip-ssl&quot;&lt;br/&gt;
-]&lt;br/&gt;
+]&lt;br/&gt;
\ No newline at end of file&lt;br/&gt;
diff --git a/test/tests.json b/test/tests.json&lt;br/&gt;
index 85a0c0797a..27e75cc218 100644&lt;br/&gt;
&amp;#8212; a/test/tests.json&lt;br/&gt;
+++ b/test/tests.json&lt;br/&gt;
@@ -105,7 +105,8 @@&lt;br/&gt;
     &quot;transports&quot;: [&lt;br/&gt;
       &quot;buffered&quot;,&lt;br/&gt;
       &quot;framed&quot;,&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&quot;http&quot;&lt;br/&gt;
+      &quot;http&quot;,&lt;br/&gt;
+      &quot;zlib&quot;&lt;br/&gt;
     ],&lt;br/&gt;
     &quot;sockets&quot;: [&lt;br/&gt;
       &quot;ip&quot;,&lt;br/&gt;
@@ -262,7 +263,8 @@&lt;br/&gt;
     &quot;transports&quot;: [&lt;br/&gt;
       &quot;buffered&quot;,&lt;br/&gt;
       &quot;framed&quot;,&lt;/li&gt;
	&lt;li&gt;&quot;http&quot;&lt;br/&gt;
+      &quot;http&quot;,&lt;br/&gt;
+      &quot;zlib&quot;&lt;br/&gt;
     ],&lt;br/&gt;
     &quot;sockets&quot;: [&lt;br/&gt;
       &quot;ip&quot;,&lt;br/&gt;
@@ -309,7 +311,8 @@&lt;br/&gt;
     &quot;transports&quot;: [&lt;br/&gt;
       &quot;buffered&quot;,&lt;br/&gt;
       &quot;framed&quot;,&lt;/li&gt;
	&lt;li&gt;&quot;http&quot;&lt;br/&gt;
+      &quot;http&quot;,&lt;br/&gt;
+      &quot;zlib&quot;&lt;br/&gt;
     ],&lt;br/&gt;
     &quot;sockets&quot;: [&lt;br/&gt;
       &quot;ip&quot;,&lt;br/&gt;
@@ -353,7 +356,8 @@&lt;br/&gt;
     &quot;transports&quot;: [&lt;br/&gt;
       &quot;buffered&quot;,&lt;br/&gt;
       &quot;http&quot;,&lt;/li&gt;
	&lt;li&gt;&quot;framed&quot;&lt;br/&gt;
+      &quot;framed&quot;,&lt;br/&gt;
+      &quot;zlib&quot;&lt;br/&gt;
     ],&lt;br/&gt;
     &quot;sockets&quot;: [&lt;br/&gt;
       &quot;ip&quot;,&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16616668" author="jking3" created="Sun, 16 Sep 2018 10:52:45 +0000"  >&lt;p&gt;Committed along with some changes that enable zlib wrapping buffered transport in cpp,go,py,py3 for crosstest.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 9 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3wz87:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>