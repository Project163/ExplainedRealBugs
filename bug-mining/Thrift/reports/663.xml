<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:06:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-1699] Native Union#read has extra read_field_end call</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-1699</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;The native implementation of the Union#read method has an extraneous call to read_field_end. This makes no difference to most protocols because read_field_end is a no-op, but it breaks JSON (in this case my own class, not the one in trunk), which does do something in this method.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12608474">THRIFT-1699</key>
            <summary>Native Union#read has extra read_field_end call</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jensg">Jens Geyer</assignee>
                                    <reporter username="radsaq">Kevin Radloff</reporter>
                        <labels>
                    </labels>
                <created>Thu, 20 Sep 2012 14:20:03 +0000</created>
                <updated>Sat, 8 Jun 2013 03:15:47 +0000</updated>
                            <resolved>Sat, 8 Jun 2013 03:15:47 +0000</resolved>
                                    <version>0.8</version>
                                    <fixVersion>0.9.1</fixVersion>
                                    <component>Ruby - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13505491" author="radsaq" created="Wed, 28 Nov 2012 14:32:53 +0000"  >&lt;p&gt;Anybody out there? It would be nice to get this merged before 1.0.&lt;/p&gt;</comment>
                            <comment id="13505902" author="nbeyer" created="Wed, 28 Nov 2012 21:22:06 +0000"  >&lt;p&gt;Why do you believe that the read_field_end is extraneous? In looking at the code prior to the read_field_end, there is a read_field_begin that seemingly needs this call to read_field_end.&lt;/p&gt;</comment>
                            <comment id="13505913" author="jensg" created="Wed, 28 Nov 2012 21:31:59 +0000"  >&lt;p&gt;Kevin,&lt;br/&gt;
you write, you are using an own impl. of the JSON protocol. &lt;/p&gt;

&lt;p&gt;The ruby code in the repo does also do something in this function:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    def read_field_end
      read_json_object_end
    end
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Question: Does the JSON implementation in the repo work or not? &lt;br/&gt;
=&amp;gt; If yes, the issue is most probably within your code. &lt;br/&gt;
=&amp;gt; If not, there&apos;s a big chance that you are right.&lt;/p&gt;

&lt;p&gt;Without having done deep dive into the Ruby code, just taken a quick look at it. So I may overlook something important.&lt;/p&gt;

</comment>
                            <comment id="13505921" author="radsaq" created="Wed, 28 Nov 2012 21:39:21 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;	  &lt;span class=&quot;code-comment&quot;&gt;// read field end
&lt;/span&gt;	  default_read_field_end(protocol);
	
	  field_header = default_read_field_begin(protocol);
	  field_type_value = rb_ary_entry(field_header, 1);
	  field_type = FIX2INT(field_type_value);
	
	  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (field_type != TTYPE_STOP) {
	    rb_raise(rb_eRuntimeError, &lt;span class=&quot;code-quote&quot;&gt;&quot;too many fields in union!&quot;&lt;/span&gt;);
	  }
	
	  &lt;span class=&quot;code-comment&quot;&gt;// read field end
&lt;/span&gt;	  default_read_field_end(protocol);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The code is calling default_read_field_end to look for the end of the first (which should also be the only field) in the union. It then calls default_read_field_begin to verify that there is not the start of another field. It then errantly calls default_read_field_end despite the fact the prior default_read_field_begin should not have consumed any further characters (or done anything else besides returned TTYPE_STOP). If you are counting the instances of read_field_begin and read_field_end, then yes, they match up right now, but this is a union and not a standard struct, and the behavior is unique here.&lt;/p&gt;

&lt;p&gt;And unfortunately, I have not had much luck running the thrift ruby test suite. It appears as though this has gone undiscovered because there are no tests that use unions. And no users probably use unions, either. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13505997" author="nbeyer" created="Wed, 28 Nov 2012 22:40:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;Kevin Radloff added a comment - 28/Nov/12 15:39&lt;br/&gt;
If you are counting the instances of read_field_begin and read_field_end, then yes, they match up right now, but this is a union and not a standard struct, and the behavior is unique here.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I&apos;m intimately familiar with the uniqueness of unions, can you point me at some doc or another language&apos;s library that&apos;s doing it correctly?&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;Kevin Radloff added a comment - 28/Nov/12 15:39&lt;br/&gt;
And unfortunately, I have not had much luck running the thrift ruby test suite. It appears as though this has gone undiscovered because there are no tests that use unions. And no users probably use unions, either. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This was going to be my next comment. Assuming the code needs to change, the patch needs to include some test cases.&lt;/p&gt;</comment>
                            <comment id="13506009" author="jensg" created="Wed, 28 Nov 2012 22:48:17 +0000"  >&lt;p&gt;After reading &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-409&quot; title=&quot;Add &amp;quot;union&amp;quot; to Thrift&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-409&quot;&gt;&lt;del&gt;THRIFT-409&lt;/del&gt;&lt;/a&gt; and having a look at the Java reference implementation, I think you are right and the call is indeed wrong there,since the matching call to begin_read_field() is expected to return T_STOP (thus no read_end required), otherwise it raises an exception anyway. &lt;/p&gt;

&lt;p&gt;Could you please provide a patch? And could someone who actually has some kind of Ruby running somewhere please verify this?&lt;/p&gt;

&lt;p&gt;Thanks. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13506025" author="radsaq" created="Wed, 28 Nov 2012 22:58:41 +0000"  >&lt;p&gt;Thanks for looking. I&apos;ll try to work on specs for it, but like I said I haven&apos;t had a whole lot of luck getting them to run even using rspec 1.3 and an older ruby.&lt;/p&gt;</comment>
                            <comment id="13506027" author="radsaq" created="Wed, 28 Nov 2012 23:01:33 +0000"  >&lt;p&gt;Ohh wait, didn&apos;t realize someone had updated the test suite. Never mind. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13506039" author="radsaq" created="Wed, 28 Nov 2012 23:12:16 +0000"  >&lt;p&gt;Updated patch attached. Confirmed that the spec fails without my change.&lt;/p&gt;</comment>
                            <comment id="13506183" author="nbeyer" created="Thu, 29 Nov 2012 03:27:03 +0000"  >&lt;p&gt;I applied the patch and tested it on Mac OS X Lion with Ruby 1.9.3-p327. All of the Ruby tests passed fine.&lt;/p&gt;

&lt;p&gt;The original patch wasn&apos;t a unified patch and a bit painful to apply via &apos;patch&apos;, so I regenerated it via &apos;svn diff&apos; and uploaded the file as &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12555303/12555303_THRIFT-1699-remove-extra-read-field-end.patch&quot; title=&quot;THRIFT-1699-remove-extra-read-field-end.patch attached to THRIFT-1699&quot;&gt;THRIFT-1699-remove-extra-read-field-end.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;.&lt;/p&gt;</comment>
                            <comment id="13530430" author="jensg" created="Wed, 12 Dec 2012 22:21:58 +0000"  >&lt;p&gt;Committed. &lt;br/&gt;
Thanks Kevin and Nathan!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12555303" name="THRIFT-1699-remove-extra-read-field-end.patch" size="1555" author="nbeyer" created="Thu, 29 Nov 2012 03:27:03 +0000"/>
                            <attachment id="12555265" name="rb-struct.diff" size="1585" author="radsaq" created="Wed, 28 Nov 2012 23:11:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>292597</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 49 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0s9dr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>162996</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>