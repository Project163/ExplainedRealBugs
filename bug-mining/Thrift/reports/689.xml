<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:06:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-1264] TSocketClient is queried by run loop after deallocation in Cocoa</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-1264</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;When using TSocketClient in a Cocoa client and correctly managing the memory:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;Server.m&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;- (id)initWithServer:(NSString*)server port:(NSInteger)port
{
    self = [&lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt; init];
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (self) {
        TSocketClient *transport = [[TSocketClient alloc] initWithHostname:server 
                                                       port:port];
        TBinaryProtocol *protocol = [[TBinaryProtocolFactory sharedFactory] newProtocolOnTransport:transport];
        Client *client = [[Client alloc] initWithProtocol:protocol];

&lt;span class=&quot;code-comment&quot;&gt;// self.client is a retained property
&lt;/span&gt;        self.client = client;
        [client release];
        [protocol release];
        [transport release];
    }
    
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; self;
}


- (void)dealloc {
    self.client = nil;
    [&lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt; dealloc];
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;(maybe this should be fixed in the cocoa example, memory management is erroneous there)&lt;/p&gt;

&lt;p&gt;After successfully releasing the object with the code above. One gets a EXC_BAD_ACCESS signal because the runloop send a responseToSelector: message to our object. With the selector stream:handleEvent:&lt;/p&gt;

&lt;p&gt;This all leads to TSocketClient which opens two NSStream objects and delegates it self to both, afterwards both Streams are scheduled in the runloop, which should actually notify the delegate when something happens to the stream like data is available, this obviously results in the runloop asking TSocketClient for previously described selector. However this mechanism is not used, the TNSStreamTransport class is subclassed and responsible for read/write.&lt;/p&gt;

&lt;p&gt;So why are the Streams schedules in the run loop in the first place?&lt;br/&gt;
Why are the streams not closed and released when the object gets deallocated?&lt;/p&gt;

&lt;p&gt;I could fix this behavior by implementing a dealloc method in TSocketClient and making the Streams member variables&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;TSocketClient.h&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@&lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; TSocketClient : TNSStreamTransport {
    NSInputStream * inputStream;
	NSOutputStream * outputStream;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;TSocketClient.m&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;-(void)dealloc {
    [inputStream close];
    [outputStream close];
    [inputStream release];
    [outputStream release];
    [&lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt; dealloc];
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;However I still don&apos;t know if that is the right way.&lt;br/&gt;
Suggestions?&lt;/p&gt;


&lt;p&gt;Edit:&lt;/p&gt;

&lt;p&gt;The bug is still present in 0.9 I attached a TSocketClient.m that fixes this Problem, the TSocketClient also keeps track of the streams and upon deallocation it closes the stream, removes it from the runloop and releases it (if arc is not enabled). This also removes a bug in non-arc environment that where the streams have a retaincount of +1 after deallocation such that the bug described here won&apos;t occur and the streams leak memory&lt;/p&gt;</description>
                <environment>&lt;p&gt;iPad, iOS SDK 4.3, iOS SDK 5.1&lt;/p&gt;</environment>
        <key id="12519049">THRIFT-1264</key>
            <summary>TSocketClient is queried by run loop after deallocation in Cocoa</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="eichhoernchen">Jan R&#252;th</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 Aug 2011 21:47:33 +0000</created>
                <updated>Sat, 8 Jun 2013 03:15:46 +0000</updated>
                            <resolved>Sat, 8 Jun 2013 03:15:46 +0000</resolved>
                                    <version>0.7</version>
                    <version>0.9</version>
                                    <fixVersion>0.9.1</fixVersion>
                                    <component>Cocoa - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13086005" author="eichhoernchen" created="Tue, 16 Aug 2011 21:50:43 +0000"  >&lt;p&gt;svn diff transport/TSocketClient.m transport/TSocketClient.m&lt;/p&gt;</comment>
                            <comment id="13575678" author="eichhoernchen" created="Mon, 11 Feb 2013 08:45:38 +0000"  >&lt;p&gt;This solved the problem for non-arc and arc in version 0.9&lt;/p&gt;</comment>
                            <comment id="13591627" author="jfarrell" created="Sun, 3 Mar 2013 03:54:38 +0000"  >&lt;p&gt;Committed, Thanks for the patch&lt;/p&gt;</comment>
                            <comment id="13593911" author="hudson" created="Tue, 5 Mar 2013 21:05:49 +0000"  >&lt;p&gt;Integrated in Thrift #625 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/625/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/625/&lt;/a&gt;)&lt;br/&gt;
    Thrift-1264:TSocketClient is queried by run loop after deallocation in Cocoa (Revision 04f83112f6a84d5f572921990adf4b122e15d377)&lt;/p&gt;

&lt;p&gt;     Result = ABORTED&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12490580" name="THRIFT-1264.diff" size="1194" author="eichhoernchen" created="Tue, 16 Aug 2011 21:50:43 +0000"/>
                            <attachment id="12568801" name="TSocketClient.m" size="2731" author="eichhoernchen" created="Mon, 11 Feb 2013 08:45:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>64803</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 38 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i14iun:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>234517</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>