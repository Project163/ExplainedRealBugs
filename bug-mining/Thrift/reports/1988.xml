<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:30:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-4857] Java field hash code implementation inconsistent with equals.</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-4857</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;The &lt;tt&gt;TField&lt;/tt&gt; hash code implementation is inconsistent with equals, which is a breaking bug. If you know what hash codes are and are familiar with the Java &lt;tt&gt;Object&lt;/tt&gt; API, then you already know what I&apos;m talking about. Basically Java &lt;em&gt;requires&lt;/em&gt; that, if you overriden &lt;tt&gt;hashCode()&lt;/tt&gt; and &lt;tt&gt;equals()&lt;/tt&gt;, then for any two objects that are equal they &lt;em&gt;must&lt;/em&gt; return the same hash code.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;TField&lt;/tt&gt; class API contract isn&apos;t clear about what is considered equality, but according to the &lt;tt&gt;TField.equals()&lt;/tt&gt; implementation, fields are equal if and only if:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Both objects are a &lt;tt&gt;TField&lt;/tt&gt; (I&apos;m generalizing here; there&apos;s another subtle bug lurking with class checking, but that&apos;s another story).&lt;/li&gt;
	&lt;li&gt;The fields both have the same &lt;tt&gt;type&lt;/tt&gt; and &lt;tt&gt;id&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In other words, fields are equal &lt;em&gt;without regard to name&lt;/em&gt;. And this follows the overall Thrift architecture, in which field names are little more than window dressing, and the IDs carry the semantics.&lt;/p&gt;

&lt;p&gt;Unfortunately &lt;tt&gt;TField.hashCode()&lt;/tt&gt; includes the name in the hash code calculation! This completely breaks the &lt;tt&gt;Object&lt;/tt&gt; contract. It makes the hash code inconsistent with equality. To put it another way, two fields &lt;tt&gt;foo&lt;/tt&gt; and &lt;tt&gt;bar&lt;/tt&gt; could have the same type and ID, and &lt;tt&gt;foo.equals(bar)&lt;/tt&gt; would return &lt;tt&gt;true&lt;/tt&gt;, but they would be given different hash codes!!&lt;/p&gt;

&lt;p&gt;This is completely forbidden, and means that with this bug you cannot use a &lt;tt&gt;TField&lt;/tt&gt; as the key in a map, for example, or even reliably keep a &lt;tt&gt;Set&amp;lt;TField&amp;gt;&lt;/tt&gt; of fields! If you were to store &lt;tt&gt;foo&lt;/tt&gt; and &lt;tt&gt;bar&lt;/tt&gt; as keys in a map, for example, the different hash codes would put them in different buckets, even though they were considered equal, providing inconsistent and strange lookup results, depending on the name of the field you used to query with.&lt;/p&gt;

&lt;p&gt;This is simply broken as per the Java &lt;tt&gt;Object&lt;/tt&gt; API contract.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="13231481">THRIFT-4857</key>
            <summary>Java field hash code implementation inconsistent with equals.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jking3">James E. King III</assignee>
                                    <reporter username="garretwilson">Garret Wilson</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 May 2019 16:47:14 +0000</created>
                <updated>Wed, 16 Oct 2019 22:26:37 +0000</updated>
                            <resolved>Mon, 13 May 2019 20:54:17 +0000</resolved>
                                    <version>0.12.0</version>
                                    <fixVersion>0.13.0</fixVersion>
                                    <component>Java - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16832656" author="jking3" created="Fri, 3 May 2019 16:55:35 +0000"  >&lt;p&gt;Nice find.  Can you submit a pull request to fix it?&lt;/p&gt;</comment>
                            <comment id="16832660" author="garretwilson" created="Fri, 3 May 2019 16:58:45 +0000"  >&lt;p&gt;Maybe; let me see how soon I can get a few minutes free. With luck I could do it this weekend.&lt;/p&gt;

&lt;p&gt;Just to confirm, can I just file a pull request with the &lt;a href=&quot;https://github.com/apache/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;source code on GitHub&lt;/a&gt;?&lt;/p&gt;

&lt;p&gt;And can I open a pull request against the main repository, or do you prefer I fork the repository first?&lt;/p&gt;</comment>
                            <comment id="16832775" author="garretwilson" created="Fri, 3 May 2019 19:47:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;And can I open a pull request against the main repository, or do you prefer I fork the repository first?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ah, never mind, this is covered in your &lt;a href=&quot;https://github.com/apache/thrift/blob/master/CONTRIBUTING.md&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;contributing instructions&lt;/a&gt;, duh! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I&apos;ll get on that.&lt;/p&gt;</comment>
                            <comment id="16832807" author="garretwilson" created="Fri, 3 May 2019 20:31:35 +0000"  >&lt;p&gt;All right, I just created a &lt;a href=&quot;https://github.com/apache/thrift/pull/1792&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;pull request&lt;/a&gt;. Let me know if I missed anything.&lt;/p&gt;

&lt;p&gt;The contribution instructions weren&apos;t clear whether the language indication (e.g. &lt;tt&gt;java&lt;/tt&gt;) in the pull request should be uppercase or lowercase. I saw both in historical commits. As the official contribution instructions showed e.g. &lt;tt&gt;perl&lt;/tt&gt;, I guess that you want to follow the token form used in the &lt;tt&gt;thrift --gen&lt;/tt&gt; CLI, so I went with &lt;tt&gt;java&lt;/tt&gt; rather than &lt;tt&gt;Java&lt;/tt&gt; in the commit message.&lt;/p&gt;

&lt;p&gt;I have my own opinions about approaches to generating hash codes (doing it manually is tedious and error-prone), and I could quibble about the approach to checking for class equivalence. For example, the equality check compares exact classes, which the author apparently thought would be more efficient, but this will break if anyone ever subclasses &lt;tt&gt;TField&lt;/tt&gt;. Either someone should make &lt;tt&gt;TField&lt;/tt&gt; a &lt;tt&gt;final&lt;/tt&gt; class, or use a normal &lt;tt&gt;instanceof&lt;/tt&gt; in comparison. But these issues are ancillary to the core bug here, so I tried to make my change as surgical as possible, especially as this is my first contribution.&lt;/p&gt;

&lt;p&gt;Let me know what you think!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 28 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z02dgg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>