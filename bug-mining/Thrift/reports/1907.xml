<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:29:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-4592] JS: readI32 performance on large arrays is very poor in Chrome</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-4592</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;`readI32` ( &lt;a href=&quot;https://github.com/apache/thrift/blob/master/lib/js/src/thrift.js#L1311-L1341&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/blob/master/lib/js/src/thrift.js#L1311-L1341&lt;/a&gt;&#160;)&#160;performance is extremely poor in Chrome when reading values from large arrays. This is due to the use of Array.shift ( &lt;a href=&quot;https://github.com/apache/thrift/blob/master/lib/js/src/thrift.js#L1322&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/blob/master/lib/js/src/thrift.js#L1322&lt;/a&gt;&#160;) which seems to have performance issues in V8/Chrome.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;As Chrome is a high market share browser I propose either changing this to use reverse/pop or detect the appropriate strategy given array length. I think this is due to how V8 handles large arrays and the heuristics used to determine whether data should be stored in a C-backed array or hash map.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;STR:&lt;/p&gt;

&lt;p&gt;0) Download or copy the attached ThriftBenchmarker.js - this file has some helper functions to build large arrays, as well as a copy/paste of the current `readI32` as well as one that uses Array.reverse/Array.pop over Array.shift.&lt;/p&gt;

&lt;p&gt;1) Run this test in Chrome - you can simply copy/paste the code into the Console.&lt;/p&gt;

&lt;p&gt;2) Observe that the tests using Array.shift are quite slow in Chrome:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-- testing &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; arrays --
shift test: 1084.566162109375ms
pop test: 37.604248046875ms
-- testing &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; arrays of strings --
shift test: 5189.416015625ms
pop test: 17.9189453125ms
-- testing &lt;span class=&quot;code-object&quot;&gt;short&lt;/span&gt; arrays --
shift test: 0.06005859375ms
pop test: 0.016845703125ms
-- testing &lt;span class=&quot;code-object&quot;&gt;short&lt;/span&gt; arrays of strings --
shift test: 0.01611328125ms
pop test: 0.01318359375ms&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;3) Run this test in Safari (or a non-V8) browser.&lt;/p&gt;

&lt;p&gt;4) Observe that the tests using Array.shift are far faster:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-- testing &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; arrays --
shift test: 19.235ms
pop test: 11.774ms
- testing &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; arrays of strings --
shift test: 13.087ms
pop test: 12.805ms
- testing &lt;span class=&quot;code-object&quot;&gt;short&lt;/span&gt; arrays --
shift test: 0.049ms
pop test: 0.054ms
- testing &lt;span class=&quot;code-object&quot;&gt;short&lt;/span&gt; arrays of strings --
shift test: 0.039ms
pop test: 0.022ms&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12929119/12929119_ThriftBenchmarker.js&quot; title=&quot;ThriftBenchmarker.js attached to THRIFT-4592&quot;&gt;ThriftBenchmarker.js&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Tested in Chrome&#160;67.0.3396.87 and Safari&#160;11.1.1 (13605.2.8) on OSX.&lt;/p&gt;</environment>
        <key id="13168217">THRIFT-4592</key>
            <summary>JS: readI32 performance on large arrays is very poor in Chrome</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jking3">James E. King III</assignee>
                                    <reporter username="arittr">Drew Ritter</reporter>
                        <labels>
                    </labels>
                <created>Tue, 26 Jun 2018 00:54:41 +0000</created>
                <updated>Thu, 27 Dec 2018 15:25:00 +0000</updated>
                            <resolved>Tue, 3 Jul 2018 12:16:10 +0000</resolved>
                                    <version>0.11.0</version>
                                    <fixVersion>0.12.0</fixVersion>
                                    <component>JavaScript - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16525346" author="githubbot" created="Wed, 27 Jun 2018 17:39:34 +0000"  >&lt;p&gt;arittr opened a new pull request #1569: &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4592&quot; title=&quot;JS: readI32 performance on large arrays is very poor in Chrome&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4592&quot;&gt;&lt;del&gt;THRIFT-4592&lt;/del&gt;&lt;/a&gt;: &lt;span class=&quot;error&quot;&gt;&amp;#91;JS&amp;#93;&lt;/span&gt; change readI32 to use Array.reverse/Array.pop vs Array.shift&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/thrift/pull/1569&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1569&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4592&quot; title=&quot;JS: readI32 performance on large arrays is very poor in Chrome&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4592&quot;&gt;&lt;del&gt;THRIFT-4592&lt;/del&gt;&lt;/a&gt;: &lt;span class=&quot;error&quot;&gt;&amp;#91;JS&amp;#93;&lt;/span&gt; change readI32 to use Array.reverse/Array.pop vs Array.shift, which is expensive for big arrays in V8&lt;/p&gt;

&lt;p&gt;   `readI32` ( &lt;a href=&quot;https://github.com/apache/thrift/blob/master/lib/js/src/thrift.js#L1311-L1341&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/blob/master/lib/js/src/thrift.js#L1311-L1341&lt;/a&gt; ) performance is extremely poor in Chrome when reading values from large arrays. This is due to the use of Array.shift ( &lt;a href=&quot;https://github.com/apache/thrift/blob/master/lib/js/src/thrift.js#L1322&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/blob/master/lib/js/src/thrift.js#L1322&lt;/a&gt; ) which seems to have performance issues in V8/Chrome.&lt;/p&gt;

&lt;p&gt;   As Chrome is a high market share browser I propose either changing this to use reverse/pop or detect the appropriate strategy given array length. I think this is due to how V8 handles large arrays and the heuristics used to determine whether data should be stored in a C-backed array or hash map.&lt;/p&gt;

&lt;p&gt;   Some helpful tips for a successful Apache Thrift PR:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Did you test your changes locally or using CI in your fork?&lt;/li&gt;
	&lt;li&gt;Is the Apache Jira THRIFT ticket identifier in the PR title?&lt;/li&gt;
	&lt;li&gt;Is the Apache Jira THRIFT ticket identifier in the commit message?&lt;/li&gt;
	&lt;li&gt;Did you squash your changes to a single commit?&lt;/li&gt;
	&lt;li&gt;Are these changes backwards compatible? (please say so in PR description)&lt;/li&gt;
	&lt;li&gt;Do you need to update the language-specific README?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   Example ideal pull request title:&lt;/p&gt;

&lt;p&gt;           THRIFT-9999: an example pull request title&lt;/p&gt;

&lt;p&gt;   Example ideal commit message:&lt;/p&gt;

&lt;p&gt;           THRIFT-9999: &lt;span class=&quot;error&quot;&gt;&amp;#91;summary of fix, one line if possible&amp;#93;&lt;/span&gt;&lt;br/&gt;
           Client: &lt;span class=&quot;error&quot;&gt;&amp;#91;language(s) affected, comma separated, use lib/ directory names please&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;   For more information about committing, see CONTRIBUTING.md&lt;/p&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16531280" author="githubbot" created="Tue, 3 Jul 2018 12:15:53 +0000"  >&lt;p&gt;jeking3 closed pull request #1569: &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4592&quot; title=&quot;JS: readI32 performance on large arrays is very poor in Chrome&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4592&quot;&gt;&lt;del&gt;THRIFT-4592&lt;/del&gt;&lt;/a&gt;: &lt;span class=&quot;error&quot;&gt;&amp;#91;JS&amp;#93;&lt;/span&gt; change readI32 to use Array.reverse/Array.pop vs Array.shift&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/thrift/pull/1569&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1569&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/lib/js/src/thrift.js b/lib/js/src/thrift.js&lt;br/&gt;
index 2b385a3a71..39e6db19bc 100644&lt;br/&gt;
&amp;#8212; a/lib/js/src/thrift.js&lt;br/&gt;
+++ b/lib/js/src/thrift.js&lt;br/&gt;
@@ -1319,7 +1319,11 @@ Thrift.Protocol.prototype = {&lt;br/&gt;
             if (f.length === 0) &lt;/p&gt;
{
                 r.value = undefined;
             }
&lt;p&gt; else {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;r.value = f.shift();&lt;br/&gt;
+                if (!f.isReversed) 
{
+                    f.reverse();
+                    f.isReversed = true;
+                }
&lt;p&gt;+                r.value = f.pop();&lt;br/&gt;
             }&lt;br/&gt;
         } else if (f instanceof Object) {&lt;br/&gt;
            for (var i in f) {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16531283" author="jking3" created="Tue, 3 Jul 2018 12:16:10 +0000"  >&lt;p&gt;Committed - thanks.&lt;/p&gt;</comment>
                            <comment id="16531764" author="githubbot" created="Tue, 3 Jul 2018 18:20:46 +0000"  >&lt;p&gt;arittr commented on issue #1569: &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4592&quot; title=&quot;JS: readI32 performance on large arrays is very poor in Chrome&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4592&quot;&gt;&lt;del&gt;THRIFT-4592&lt;/del&gt;&lt;/a&gt;: &lt;span class=&quot;error&quot;&gt;&amp;#91;JS&amp;#93;&lt;/span&gt; change readI32 to use Array.reverse/Array.pop vs Array.shift&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/thrift/pull/1569#issuecomment-402249350&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1569#issuecomment-402249350&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @jeking3 thank you! appreciate it.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12929119" name="ThriftBenchmarker.js" size="4805" author="arittr" created="Tue, 26 Jun 2018 00:44:58 +0000"/>
                            <attachment id="12929118" name="readI32_pop.patch" size="601" author="arittr" created="Tue, 26 Jun 2018 00:54:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 20 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3v847:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>