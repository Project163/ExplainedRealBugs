<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:05:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-1023] Thrift encoding  (UTF-8) issue with Ruby 1.9.2</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-1023</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;I came up with an encoding issue coming from the Thrift library, and especially the BufferedTransport class.&lt;br/&gt;
I&apos;ve decided to write down few tests to give you a concrete example :&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;encoding: utf-8&lt;br/&gt;
require &apos;spec_helper&apos;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;describe &quot;encoding&quot; do&lt;/p&gt;

&lt;p&gt; before do&lt;br/&gt;
   transport = Thrift::BufferedTransport.new(Thrift::Socket.new(MR_CONFIG&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;#39;host&amp;#39;&amp;#93;&lt;/span&gt;, 9090))&lt;br/&gt;
   protocol  = Thrift::BinaryProtocol.new(transport)&lt;br/&gt;
   @client   = Apache::Hadoop::Hbase::Thrift::Hbase::Client.new(protocol)&lt;/p&gt;

&lt;p&gt;   transport.open()&lt;/p&gt;

&lt;p&gt;   @table_name = &quot;encoding_test&quot;&lt;br/&gt;
   @column_family = &quot;info:&quot;&lt;br/&gt;
 end&lt;/p&gt;

&lt;p&gt; it &quot;should create a new table&quot; do&lt;br/&gt;
   column = Apache::Hadoop::Hbase::Thrift::ColumnDescriptor.new&lt;/p&gt;
{|c| c.name= @column_family}
&lt;p&gt;   @client.createTable(@table_name, &lt;span class=&quot;error&quot;&gt;&amp;#91;column&amp;#93;&lt;/span&gt;).should be_nil&lt;br/&gt;
 end&lt;/p&gt;

&lt;p&gt; it &quot;should save standard caracteres&quot; do&lt;br/&gt;
   m        = Apache::Hadoop::Hbase::Thrift::Mutation.new&lt;br/&gt;
   m.column = &quot;info:first_name&quot;&lt;br/&gt;
   m.value  = &quot;Vincent&quot;&lt;/p&gt;

&lt;p&gt;   m.value.encoding.should == Encoding::UTF_8&lt;br/&gt;
   @client.mutateRow(@table_name, &quot;ID1&quot;, &lt;span class=&quot;error&quot;&gt;&amp;#91;m&amp;#93;&lt;/span&gt;).should be_nil&lt;br/&gt;
 end&lt;/p&gt;

&lt;p&gt; it &quot;should save UTF8 caracteres&quot; do&lt;br/&gt;
   m        = Apache::Hadoop::Hbase::Thrift::Mutation.new&lt;br/&gt;
   m.column = &quot;info:first_name&quot;&lt;br/&gt;
   m.value  = &quot;Thorbj&#248;rn&quot;&lt;/p&gt;

&lt;p&gt;   m.value.encoding.should == Encoding::UTF_8&lt;br/&gt;
   @client.mutateRow(@table_name, &quot;ID1&quot;, &lt;span class=&quot;error&quot;&gt;&amp;#91;m&amp;#93;&lt;/span&gt;).should be_nil&lt;br/&gt;
 end&lt;/p&gt;

&lt;p&gt; it &quot;should destroy the table&quot; do&lt;br/&gt;
   @client.disableTable(@table_name).should be_nil&lt;br/&gt;
   @client.deleteTable(@table_name).should be_nil&lt;br/&gt;
 end&lt;br/&gt;
end&lt;/p&gt;

&lt;p&gt;It fails when it tries to save the UTF8 string including the caractere &apos;&#248;&apos;.&lt;/p&gt;

&lt;p&gt;Here is the output :&lt;/p&gt;

&lt;p&gt; 1) encoding should save UTF8 caracteres&lt;br/&gt;
    Failure/Error: @client.mutateRow(@table_name, &quot;ID1&quot;, &lt;span class=&quot;error&quot;&gt;&amp;#91;m&amp;#93;&lt;/span&gt;).should be_nil&lt;br/&gt;
    incompatible character encodings: ASCII-8BIT and UTF-8&lt;br/&gt;
    #/Users/vincentp/.rvm/gems/ruby-1.9.2-p0/gems/thrift-0.5.0/lib/thrift/transport/buffered_transport.rb:59:in&lt;br/&gt;
`write&apos;&lt;br/&gt;
    #/Users/vincentp/.rvm/gems/ruby-1.9.2-p0/gems/thrift-0.5.0/lib/thrift/protocol/binary_protocol.rb:107:in&lt;br/&gt;
`write_string&apos;&lt;br/&gt;
    #/Users/vincentp/.rvm/gems/ruby-1.9.2-p0/gems/thrift-0.5.0/lib/thrift/client.rb:35:in&lt;br/&gt;
`write&apos;&lt;br/&gt;
    #/Users/vincentp/.rvm/gems/ruby-1.9.2-p0/gems/thrift-0.5.0/lib/thrift/client.rb:35:in&lt;br/&gt;
`send_message&apos;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;./lib/thrift/hbase.rb:289:in `send_mutateRow&apos;&lt;/li&gt;
	&lt;li&gt;./lib/thrift/hbase.rb:284:in `mutateRow&apos;&lt;/li&gt;
	&lt;li&gt;./spec/thrift/cases/encoding_spec.rb:37:in `block (2 levels) in &amp;lt;top&lt;br/&gt;
(required)&amp;gt;&apos;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Let me know if you need any other details, thank you !&lt;/p&gt;</description>
                <environment>&lt;p&gt;OSX, Ruby 1.9.2, Thrift Gem version 0.5.0&lt;/p&gt;</environment>
        <key id="12493427">THRIFT-1023</key>
            <summary>Thrift encoding  (UTF-8) issue with Ruby 1.9.2</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nbeyer">Nathan Beyer</assignee>
                                    <reporter username="vincentp">Vincent Peres</reporter>
                        <labels>
                    </labels>
                <created>Thu, 16 Dec 2010 10:46:43 +0000</created>
                <updated>Thu, 11 Oct 2012 00:37:14 +0000</updated>
                            <resolved>Thu, 11 Oct 2012 00:37:14 +0000</resolved>
                                    <version>0.5</version>
                                    <fixVersion>0.9</fixVersion>
                                    <component>Ruby - Library</component>
                        <due></due>
                            <votes>6</votes>
                                    <watches>14</watches>
                                                                                                                <comments>
                            <comment id="13175874" author="as181920" created="Mon, 26 Dec 2011 02:17:04 +0000"  >&lt;p&gt;have the same problem at ubuntu/thrift0.8/ruby1.9.3&lt;/p&gt;</comment>
                            <comment id="13234357" author="bss" created="Wed, 21 Mar 2012 13:52:39 +0000"  >&lt;p&gt;FYI.&lt;br/&gt;
Someone did a pull request on github with a fix for this issue: &lt;a href=&quot;https://github.com/apache/thrift/pull/9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/9&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If the apache process requires all patches to go through jira I could easily convert the commit in the pull request into a patch and attach them here.&lt;/p&gt;</comment>
                            <comment id="13234374" author="jfarrell" created="Wed, 21 Mar 2012 14:21:04 +0000"  >&lt;p&gt;We do not accept pull requests via github currently. Please see &lt;a href=&quot;http://wiki.apache.org/thrift/HowToContribute&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://wiki.apache.org/thrift/HowToContribute&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13273132" author="woodoo" created="Fri, 11 May 2012 09:22:17 +0000"  >&lt;p&gt;Hello, here is my fix, as on github.&lt;/p&gt;</comment>
                            <comment id="13273466" author="roger.meier" created="Fri, 11 May 2012 18:04:22 +0000"  >&lt;p&gt;I have the following issue with your patch on debian using ruby 1.8 :&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
Thrift::Client should increment the sequence id when sending messages (it seems   sequence ids are completely ignored right now)
./spec/client_spec.rb:56

1)
NoMethodError in &apos;Thrift::BufferedTransport should buffer writes and send them o  n flush&apos;
undefined method `force_encoding&apos; for &quot;one/&quot;:String
./spec/base_transport_spec.rb:95:

2)
NoMethodError in &apos;Thrift::BufferedTransport should only send buffered data once&apos;
undefined method `force_encoding&apos; for &quot;one/&quot;:String
./spec/base_transport_spec.rb:106:

3)
NoMethodError in &apos;Thrift::HTTPClientTransport should post via HTTP and return th  e results&apos;
undefined method `force_encoding&apos; for &quot;a test&quot;:String
./spec/http_client_spec.rb:37:

4)
NoMethodError in &apos;Thrift::HTTPClientTransport should send custom headers if defi  ned&apos;
undefined method `force_encoding&apos; for &quot;test&quot;:String
./spec/http_client_spec.rb:50:

Finished in 3.558732 seconds

349 examples, 4 failures, 1 pending
rake aborted!
Command /usr/bin/ruby1.8 -I&quot;lib&quot;  &quot;/usr/bin/spec&quot; &quot;spec/base_protocol_spec.rb&quot; &quot;  spec/base_transport_spec.rb&quot; &quot;spec/binary_protocol_accelerated_spec.rb&quot; &quot;spec/bi  nary_protocol_spec.rb&quot; &quot;spec/client_spec.rb&quot; &quot;spec/exception_spec.rb&quot; &quot;spec/mong  rel_http_server_spec.rb&quot; &quot;spec/processor_spec.rb&quot; &quot;spec/server_socket_spec.rb&quot; &quot;  spec/struct_spec.rb&quot; &quot;spec/union_spec.rb&quot; &quot;spec/socket_spec.rb&quot; &quot;spec/json_proto  col_spec.rb&quot; &quot;spec/struct_nested_containers_spec.rb&quot; &quot;spec/compact_protocol_spec  .rb&quot; &quot;spec/http_client_spec.rb&quot; &quot;spec/nonblocking_server_spec.rb&quot; &quot;spec/serializ  er_spec.rb&quot; &quot;spec/server_spec.rb&quot; &quot;spec/types_spec.rb&quot; &quot;spec/unix_socket_spec.rb  &quot; --color failed

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13279250" author="jack_foy" created="Fri, 18 May 2012 22:09:24 +0000"  >&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;We&apos;re a heavy Ruby shop running into the same problem under Ruby 1.9. We don&apos;t believe this is a correct patch; we&apos;ll provide more details and a fix shortly. Thanks. &lt;/p&gt;</comment>
                            <comment id="13279386" author="br" created="Sat, 19 May 2012 01:11:22 +0000"  >&lt;p&gt;Ruby 1.8.x doesn&apos;t have a #force_encoding method so some solution over $KCODE = &quot;UTF-8&quot; is probably necessary for that.&lt;/p&gt;</comment>
                            <comment id="13399103" author="jfarrell" created="Fri, 22 Jun 2012 04:04:19 +0000"  >&lt;p&gt;Any updates on this ticket? Getting ready to create 0.9 release candidate&lt;/p&gt;</comment>
                            <comment id="13403634" author="nbeyer" created="Fri, 29 Jun 2012 00:55:20 +0000"  >&lt;p&gt;Any opinions on the level of Ruby 1.8 support that&apos;s needed? If $KCODE is &apos;U&apos;, this means all Strings are UTF-8 and the character data could just be treated as-is. This will be common, as frameworks like Rails force the interpreter into this mode at bootstrap. If $KCODE is &apos;N&apos; (none/ASCII), &apos;E&apos; (EUC) or &apos;S&apos; (Shift JIS), then some form of transcoding would have to take place (via iconv?).&lt;/p&gt;

&lt;p&gt;It would be fairly easy to support the Unicode/UTF-8 mode for Ruby 1.8. The other values would not be as easy to support. Do they need to be supported? &lt;/p&gt;

&lt;p&gt;Note - I&apos;m guessing that none of the existing Thrift Ruby code actually works in anything other than $KCODE of &apos;U&apos;; at least not for code points that are outside of the ASCII range (0-127).&lt;/p&gt;</comment>
                            <comment id="13403679" author="nbeyer" created="Fri, 29 Jun 2012 03:25:39 +0000"  >&lt;p&gt;Is there any additional design doc or code doc for the Ruby classes? I&apos;m trying to discern what APIs are working with bytes and what APIs are working with characters.&lt;/p&gt;

&lt;p&gt;For example, &lt;a href=&quot;http://svn.apache.org/repos/asf/thrift/trunk/lib/rb/lib/thrift/transport/base_transport.rb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Thrift::Transport::BaseTransport&lt;/a&gt; - are the read methods returning bytes or characters, are the writes accepting bytes are characters? I&apos;m assuming it&apos;s bytes since the variables are named &apos;buf&apos;, as opposed to the &apos;str&apos; names used in the protocol APIs, but want to double-check.&lt;/p&gt;</comment>
                            <comment id="13408454" author="nbeyer" created="Fri, 6 Jul 2012 23:40:25 +0000"  >&lt;p&gt;I&apos;ve been doing some research and experimentation and here&apos;s what I think needs to be done for this issue and once I get a moment will try to create a patch for it.&lt;/p&gt;

&lt;p&gt;For Ruby 1.9+ support -&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Make sure all Transport related classes are working with byte buffers (i.e. String with BINARY/ASCII8BIT encoding). This means that any Strings passed to the Transport classes should be assumed to be byte buffers, which would mean all Strings are force encoded to BINARY (via String#force_encoding methods), if they aren&apos;t already when passed.&lt;/li&gt;
	&lt;li&gt;Make sure all Protocol related classes are working Strings in UTF-8 encoding. If a String of a different encoding is passed, then transcoding should be perfomed (via String#encode). When passing string-data to the Transport classes, the Strings which are in UTF-8 encoded should be converted to byte buffers (force encoding to BINARY) before being passed on.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Currently, the Transport classes used Strings for the byte buffers, which is fine, but I think it might be cleaner and easier to understand if a buffer class were introduced that encapsulated encoding manipulation code. There&apos;s already some code that&apos;s in a utility class that seems to already match this description, perhaps it just needs refactoring a bit.&lt;/p&gt;

&lt;p&gt;Please post if this doesn&apos;t make sense or there are other thoughts.&lt;/p&gt;</comment>
                            <comment id="13409715" author="jfarrell" created="Mon, 9 Jul 2012 18:43:16 +0000"  >&lt;p&gt;Nathan, when would you have a patch ready for this?&lt;/p&gt;</comment>
                            <comment id="13409867" author="nbeyer" created="Mon, 9 Jul 2012 21:27:46 +0000"  >&lt;p&gt;What&apos;s the minimum version of Ruby that must be supported? 1.8.6 or 1.8.7?&lt;/p&gt;

&lt;p&gt;While trying to work through some of this, I noticed that the mongrel dependency will cause an issue. The bits of the library that utilize mongrel won&apos;t work on 1.9, as mongrel went through a refactor to mongrel2 for 1.9 support. Any thought to doing one last Ruby 1.8.x release and targeting the next release to be Ruby 1.9.x minimum?&lt;/p&gt;</comment>
                            <comment id="13410394" author="jfarrell" created="Tue, 10 Jul 2012 14:49:20 +0000"  >&lt;p&gt;We should be able to support both Ruby 1.8.7 and 1.9. Mongrel will work with the --pre option with ruby 1.9&lt;/p&gt;</comment>
                            <comment id="13410479" author="nbeyer_cerner" created="Tue, 10 Jul 2012 16:18:30 +0000"  >&lt;p&gt;Attached is a mostly complete patch that refactors the Transport and Protocol classes to utilize binary and UTF-8 encodings appropriately.&lt;/p&gt;

&lt;p&gt;State of the patch -&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;There&apos;s no additional testing, which there probably should be.&lt;/li&gt;
	&lt;li&gt;All of the specs pass on Ruby 1.8.7 on OS X Lion via RVM using &apos;bundle exec rake gem&apos;.&lt;/li&gt;
	&lt;li&gt;Some of the specs are segfaulting on Ruby 1.9.3 on OS X Lion via RVM using &apos;bundle exec rake gem&apos;. I haven&apos;t identified the core issue of this; i suspect it could be RSpec-1, but I don&apos;t know yet.&lt;/li&gt;
	&lt;li&gt;There are no changes to the json_protocol.rb and there probably needs to be, but since JSON must be UTF-8 encoded as a whole, a larger analysis needs to be done on that.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;d appreciate any comments on the code and any ad hoc testing if others would like to help. Thanks.&lt;/p&gt;</comment>
                            <comment id="13410482" author="nbeyer_cerner" created="Tue, 10 Jul 2012 16:21:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;Jake Farrell added a comment - 10/Jul/12 14:49&lt;br/&gt;
We should be able to support both Ruby 1.8.7 and 1.9. Mongrel will work with the --pre option with ruby 1.9&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I wouldn&apos;t want to recommend that actually be used in practice though, as mongrel 1.2.0.pre2 was abandoned.&lt;/p&gt;</comment>
                            <comment id="13410522" author="jfarrell" created="Tue, 10 Jul 2012 16:49:24 +0000"  >&lt;p&gt;I am fine with switching away from mongrel if it is abandoned, I would just like to avoid adding a ton of dependencies in doing so. &lt;/p&gt;</comment>
                            <comment id="13410650" author="nbeyer_cerner" created="Tue, 10 Jul 2012 18:17:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;Jake Farrell added a comment - 10/Jul/12 16:49&lt;br/&gt;
I am fine with switching away from mongrel if it is abandoned, I would just like to avoid adding a ton of dependencies in doing so.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;My suggestion would be to just use WEBrick, which is part of the stdlib in both Ruby 1.8.x and Ruby 1.9.x. It&apos;s not as cool and I&apos;m sure it&apos;s not as high-performance, but it&apos;s stable and eliminates a dependency. Another variation might be to break up the gem and put some of these servers in separate gems with their own dependencies, such that user can pick and choose what they need.&lt;/p&gt;</comment>
                            <comment id="13410759" author="nbeyer_cerner" created="Tue, 10 Jul 2012 20:02:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;Nathan Beyer added a comment - 10/Jul/12 16:18&lt;br/&gt;
...&lt;br/&gt;
Some of the specs are segfaulting on Ruby 1.9.3 on OS X Lion via RVM using &apos;bundle exec rake gem&apos;. I haven&apos;t identified the core issue of this; i suspect it could be RSpec-1, but I don&apos;t know yet.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;While trying to debug the segfaults, I figured out there is much more Ruby C extension code than I expected and my patch doesn&apos;t cover any of the code in there. What I don&apos;t quite understand is that there is duplication between the C and Ruby code. For example, lib/thrift/memory_buffer_transport.rb defines a Thrift::MemoryBufferTransport#write method and ext/memory_buffer.c defines a Thrift::MemoryBufferTransport#write method. Is there a reason for this? Can the duplicated code be removed?&lt;/p&gt;</comment>
                            <comment id="13410821" author="nbeyer_cerner" created="Tue, 10 Jul 2012 20:24:24 +0000"  >&lt;p&gt;I tried removing all of the native code and with only one tweak to the patch to avoid a frozen String, the patch seems to pass all relevant tests on Ruby 1.8.7 and Ruby 1.9.3. &lt;/p&gt;

&lt;p&gt;There&apos;s an unrelated failure in the spec of the ThreadPoolServer not getting enough invocations of &apos;serve&apos;.&lt;/p&gt;</comment>
                            <comment id="13411289" author="nbeyer" created="Wed, 11 Jul 2012 07:13:20 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;THRIFT-1023-refactor-transport-protocol-&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;-ruby19-v2.patch&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is a second revision of my previous patch. This includes some tweaks in the Ruby code from my earlier patch as well as an attempt at addressing the Ruby C extension code.&lt;/p&gt;

&lt;p&gt;With this patch all specs are passing on Ruby 1.8.7-p370 and Ruby 1.9.3-p194.&lt;/p&gt;

&lt;p&gt;This is my first attempt at writing Ruby C extension code and it&apos;s been a long time since I&apos;ve written C, so I encourage everyone to review it and test it.&lt;/p&gt;</comment>
                            <comment id="13420080" author="arya" created="Sun, 22 Jul 2012 02:24:09 +0000"  >&lt;p&gt;Hi Nathan,&lt;/p&gt;

&lt;p&gt;We are also heavily affected by this bug and UTF-8 writes to Cassandra, and am looking to apply your patch and test it. I also tried the patch in Thrift-1224 but that has causes some &apos;end of file reached errors&apos; for us. &lt;/p&gt;

&lt;p&gt;Would you please tell me which version of Thrift you&apos;ve applied you patch on? Trunk or 0.8?&lt;/p&gt;

&lt;p&gt;Cheers,&lt;br/&gt;
-Arya&lt;/p&gt;</comment>
                            <comment id="13420234" author="nbeyer" created="Sun, 22 Jul 2012 16:34:56 +0000"  >&lt;p&gt;My patches are against trunk.&lt;/p&gt;</comment>
                            <comment id="13420315" author="arya" created="Sun, 22 Jul 2012 20:19:58 +0000"  >&lt;p&gt;I build Thrift with the patch on a new 12.04 Ubuntu machine with all the packages listed here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://thrift.apache.org/docs/install/ubuntu/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://thrift.apache.org/docs/install/ubuntu/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;plus the packages for ruby. I also bundle install inside lib/rb so that correct version of rspec gets install for building. Build went ok, but when I am running &quot;make check&quot; test after AllProtocolTest starts to have problems:&lt;/p&gt;

&lt;p&gt;TBinaryProtocol =&amp;gt; OK&lt;br/&gt;
TCompactProtocol =&amp;gt; OK&lt;br/&gt;
PASS: AllProtocolsTest&lt;br/&gt;
Timeout alarm expired; attempting to unblock transport&lt;br/&gt;
Timeout alarm expired; attempting to unblock transport&lt;br/&gt;
Timeout alarm expired; attempting to unblock transport&lt;br/&gt;
Timeout alarm expired; attempting to unblock transport&lt;br/&gt;
Timeout alarm expired; attempting to unblock transport&lt;/p&gt;

&lt;p&gt;And it keeps going. Is this concerning or I am doing something wrong? Please advice.&lt;/p&gt;</comment>
                            <comment id="13421983" author="nbeyer" created="Wed, 25 Jul 2012 03:55:15 +0000"  >&lt;p&gt;Arya, What results do you get when you build from trunk without the patch?&lt;/p&gt;

&lt;p&gt;I built from trunk on Ubuntu 12.04 without the patch and get this same result.&lt;/p&gt;

&lt;p&gt;Here&apos;s the setup I used -&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Ubuntu 12.04&lt;/li&gt;
	&lt;li&gt;Base packages from here: &lt;a href=&quot;http://thrift.apache.org/docs/install/ubuntu/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://thrift.apache.org/docs/install/ubuntu/&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;RVM stable
	&lt;ul&gt;
		&lt;li&gt;Ruby 1.8.7 install via RVM&lt;/li&gt;
		&lt;li&gt;bundle install from &apos;lib/rb&apos; folder&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="13421994" author="nbeyer" created="Wed, 25 Jul 2012 04:30:55 +0000"  >&lt;p&gt;Arya, I re-configured like this &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;./configure --without-cpp --without-python --with-ruby&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;, which on may setup meant that only the thrift compiler and the ruby library were configured. I then ran &apos;make&apos; and &apos;make check&apos;, which both passed fine.&lt;/p&gt;

&lt;p&gt;When I configured without any options, the C++ library, Python library and Ruby library were configured. For completeness I tried the following two configs: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;./configure --without-cpp --with-python --without-ruby&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;./configure --with-cpp --without-python --without-ruby&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The &apos;make&apos; and &apos;make check&apos; passed fine on the Python-only config, but &apos;make check&apos; paused with the same output (Timeout alarm ...) for the C&amp;#43;&amp;#43;-only config. This leads me to think there&apos;s something missing from the Ubuntu 12.04 setup for the C++ library.&lt;/p&gt;</comment>
                            <comment id="13422008" author="nbeyer" created="Wed, 25 Jul 2012 05:13:20 +0000"  >&lt;p&gt;Now that I have a running Ubuntu 12.04 setup, I did some further testing. With the latest patch, everything runs fine on Ruby 1.8.7. However, on Ruby 1.9.3, I&apos;m seeing some segfaults. When I remove the native code, everything seems to run fine. I suspect the issue is with how the String encoding is manipulated. Instead of using some of the more direct C methods, I&apos;m going to attempt to rewrite it by just using the Ruby methods invoked from C.&lt;/p&gt;

&lt;p&gt;For those interested, I removed the native code by commenting out the &apos;build_ext&apos; task in the Rakefile and then running &apos;bundle exec rake clean&apos; and &apos;bundle exec rake gem&apos; to test it. You should see an &apos;unable to load thrift_native&apos; message in the console.&lt;/p&gt;</comment>
                            <comment id="13423657" author="nbeyer" created="Fri, 27 Jul 2012 03:50:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1023&quot; title=&quot;Thrift encoding  (UTF-8) issue with Ruby 1.9.2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1023&quot;&gt;&lt;del&gt;THRIFT-1023&lt;/del&gt;&lt;/a&gt;-refactor-transport-protocol-for-ruby19-v3.patch is another attempt at my patch. The difference between this and the previous patch (v2), is that instead of using what I thought were the Ruby C analogs of the String encoding methods, the code just invokes the same Ruby methods that the pure Ruby code uses.&lt;/p&gt;

&lt;p&gt;This is working for me on OS X Lion for Ruby 1.8.7 and 1.9.3. I&apos;ll try to test this on Ubuntu soon.&lt;/p&gt;</comment>
                            <comment id="13428958" author="nbeyer" created="Mon, 6 Aug 2012 02:22:09 +0000"  >&lt;p&gt;I did some testing on Ubuntu 12.04 and everything seems to work fine with Ruby 1.8.7-p370 (via RVM), 1.9.3-p194 (via RVM), 1.9.3-p0 (via Ubuntu APT).&lt;/p&gt;

&lt;p&gt;To get the full build to work via Ruby 1.9.3 on Ubuntu requires additional tweaks. Ubuntu packages &apos;ruby1.9.1&apos; and &apos;ruby1.9.1-dev&apos; are required. Also, the changes in the patch file &apos;&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1023&quot; title=&quot;Thrift encoding  (UTF-8) issue with Ruby 1.9.2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1023&quot;&gt;&lt;del&gt;THRIFT-1023&lt;/del&gt;&lt;/a&gt;-build-ruby19.patch&apos;.&lt;/p&gt;

&lt;p&gt;The patch &apos;&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1023&quot; title=&quot;Thrift encoding  (UTF-8) issue with Ruby 1.9.2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1023&quot;&gt;&lt;del&gt;THRIFT-1023&lt;/del&gt;&lt;/a&gt;-build-ruby19.patch&apos; is a bit kludgy and needs some consideration. Here&apos;s what was changed -&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Makefile.am - There seems to be a slight behavior change in the interpreter&apos;s load mechanism, such that to get the integration tests to run a &apos;-I.&apos; was needed; this includes the local directory.&lt;/li&gt;
	&lt;li&gt;thrift.gemspec - the mongrel dependency must be removed and the easiest way to do that was add the RUBY_VERSION conditional. There&apos;s no mechanism in RubyGems to define a dependency as &quot;optional&quot;. My suggestion would be to just remove this dependency altogether from the gemspec.&lt;/li&gt;
	&lt;li&gt;lib/rb/spec/mongrel_http_server_spec.rb - this adds a similar RUBY_VERSION check, which essentially removes the contents of the file when Ruby 1.9 is used. If mongrel is removed from the gemspec, then this should be tweaked to capture a LoadError on the load of &apos;thrift/server/mongrel_http_server&apos;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m open to suggestions on the best approach to handle the mongrel portions of the code. My suggestion would be to remove it from the gemspec, make the specs only run when mongrel can be loaded. I think mongrel could be added to the Gemfile, such that it&apos;s optional, but I&apos;ll have to look into that.&lt;/p&gt;</comment>
                            <comment id="13431479" author="lin@groupon.com" created="Wed, 8 Aug 2012 22:49:22 +0000"  >&lt;p&gt;Guys do we have an eta when the fix will be released? We are hitting it too. &lt;/p&gt;</comment>
                            <comment id="13431910" author="jfarrell" created="Thu, 9 Aug 2012 15:40:21 +0000"  >&lt;p&gt;this will be in the upcoming 0.9 release once resolved &lt;/p&gt;</comment>
                            <comment id="13432102" author="jfarrell" created="Thu, 9 Aug 2012 20:06:20 +0000"  >&lt;p&gt;Nathan, would like to avoid the version checks for mongrel if possible (&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1629&quot; title=&quot;Ruby 1.9 Compatibility during Thrift configure, make, install&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1629&quot;&gt;&lt;del&gt;THRIFT-1629&lt;/del&gt;&lt;/a&gt; has a patch which removes mongrel in favor of thin). I&apos;m currently running through &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1023&quot; title=&quot;Thrift encoding  (UTF-8) issue with Ruby 1.9.2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1023&quot;&gt;&lt;del&gt;THRIFT-1023&lt;/del&gt;&lt;/a&gt;-refactor-transport-protocol-for-ruby19-v3.patch right now and testing&lt;/p&gt;</comment>
                            <comment id="13432358" author="nbeyer" created="Fri, 10 Aug 2012 00:57:01 +0000"  >&lt;p&gt;I&apos;m fine with dropping Mongrel for another server. I didn&apos;t see an attachment on &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1629&quot; title=&quot;Ruby 1.9 Compatibility during Thrift configure, make, install&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1629&quot;&gt;&lt;del&gt;THRIFT-1629&lt;/del&gt;&lt;/a&gt;; does that need some assistance?&lt;/p&gt;</comment>
                            <comment id="13432383" author="jfarrell" created="Fri, 10 Aug 2012 01:47:30 +0000"  >&lt;p&gt;1629 has a patch, it was submitted via pull request on github. We currently dont accept patches that way and I&apos;ve communicated that to the contributor, just waiting on him to submit the patch to the jira ticket. I would like to avoid adding multiple dependencies, like thin and rack, if possible and keep the clients as minimal as possible. &lt;/p&gt;</comment>
                            <comment id="13456654" author="nbeyer" created="Sun, 16 Sep 2012 20:29:10 +0000"  >&lt;p&gt;Attachement: &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12545339/12545339_THRIFT-1023-refactor-transport-protocol-for-ruby19-v4.patch&quot; title=&quot;THRIFT-1023-refactor-transport-protocol-for-ruby19-v4.patch attached to THRIFT-1023&quot;&gt;THRIFT-1023-refactor-transport-protocol-for-ruby19-v4.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ve made an additional change to my patch. This adds some checks for frozen objects. I recently learned that Ruby will copy and freeze Strings when used as keys in Hashes. This additional tweak to the patch will check for frozen Strings and &apos;dup&apos; them if they are frozen.&lt;/p&gt;

&lt;p&gt;This obviously demonstrates the need for more unit testing, but I&apos;m waiting for &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1644&quot; title=&quot;Upgrade RSpec to 2.10.x and refactor specs as needed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1644&quot;&gt;&lt;del&gt;THRIFT-1644&lt;/del&gt;&lt;/a&gt; to get resolved before building out any more unit tests.&lt;/p&gt;</comment>
                            <comment id="13464172" author="diwaker" created="Wed, 26 Sep 2012 21:16:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nbeyer&quot; class=&quot;user-hover&quot; rel=&quot;nbeyer&quot;&gt;nbeyer&lt;/a&gt; can you attach the patch with tests included &amp;#8211; those of us who have newer rspec locally can at least try it. FWIW, &apos;make check&apos; works fine for me using v4 on OS X Mountain Lion with Ruby 1.9.3&lt;/p&gt;</comment>
                            <comment id="13465284" author="jfarrell" created="Fri, 28 Sep 2012 02:02:43 +0000"  >&lt;p&gt;Thrift-1644 is committed, Nathan can you please provide the test cases for this patch&lt;/p&gt;</comment>
                            <comment id="13466296" author="nbeyer" created="Sat, 29 Sep 2012 19:09:57 +0000"  >&lt;p&gt;Attachement: &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12547125/12547125_THRIFT-1023-refactor-transport-protocol-for-ruby19-v5.patch&quot; title=&quot;THRIFT-1023-refactor-transport-protocol-for-ruby19-v5.patch attached to THRIFT-1023&quot;&gt;THRIFT-1023-refactor-transport-protocol-for-ruby19-v5.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Another adjustment to the patch. This changes the behavior of the Thrift::Bytes.convert functions to always create duplicates. I found this avoids the surprise that mutation of Strings from external classes passed into Thrift classes caused. I also added some documentation to Thrift::Bytes.&lt;/p&gt;

&lt;p&gt;I&apos;m working on getting tests for this patch right now, but having a few issues with Ruby 1.9.3 native code build on OS X, per the later comments on &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1673&quot; title=&quot;Ruby compile flags for extension for multi arch builds (os x)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1673&quot;&gt;&lt;del&gt;THRIFT-1673&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13466678" author="nbeyer" created="Mon, 1 Oct 2012 07:15:54 +0000"  >&lt;p&gt;Attachment: &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12547199/12547199_THRIFT-1023-refactor-transport-protocol-for-ruby19-v6.patch&quot; title=&quot;THRIFT-1023-refactor-transport-protocol-for-ruby19-v6.patch attached to THRIFT-1023&quot;&gt;THRIFT-1023-refactor-transport-protocol-for-ruby19-v6.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;This patch includes all changes to support UTF-8 encoding of Thrift strings in the binary protocols when running on Ruby 1.9+, including test cases.&lt;/p&gt;

&lt;p&gt;This patch also includes a few tweaks to the JSON protocol to fully support reading of unicode escapes sequences in the BMP (U+0000 to U+FFFF), as well as some test cases. I would appreciate any review of this code, as I wasn&apos;t clear why the original code asserted that all unicode escape sequences must be between U+0000 and U+00FF. I did not update the JSON protocol to fully handle unicode character above the BMP, as JSON uses a surrogate pair, double escape sequence to represent those code points and this would require a deeper refactoring that I don&apos;t have time for at the moment. Check out &lt;a href=&quot;http://www.ietf.org/rfc/rfc4627.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RFC 4627 Section 2.5 for details&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13472137" author="hudson" created="Tue, 9 Oct 2012 05:11:17 +0000"  >&lt;p&gt;Integrated in Thrift #557 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/557/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/557/&lt;/a&gt;)&lt;br/&gt;
    Thrift-1023:Thrift encoding (UTF-8) issue with Ruby 1.9.2&lt;br/&gt;
Client: rb&lt;br/&gt;
Patch: Nathan Beyer &lt;/p&gt;

&lt;p&gt;Fixes encoding issue for UTF-8 strings in ruby client. (Revision 1395832)&lt;/p&gt;

&lt;p&gt;     Result = ABORTED&lt;/p&gt;</comment>
                            <comment id="13472606" author="jfarrell" created="Tue, 9 Oct 2012 18:21:13 +0000"  >&lt;p&gt;Committed v6 patch&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12512013">THRIFT-1224</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12539234" name="THRIFT-1023-build-ruby19.patch" size="1191" author="nbeyer" created="Mon, 6 Aug 2012 02:09:32 +0000"/>
                            <attachment id="12535992" name="THRIFT-1023-refactor-transport-protocol-for-ruby19-v2.patch" size="24437" author="nbeyer" created="Wed, 11 Jul 2012 07:13:20 +0000"/>
                            <attachment id="12538123" name="THRIFT-1023-refactor-transport-protocol-for-ruby19-v3.patch" size="26201" author="nbeyer" created="Fri, 27 Jul 2012 03:50:38 +0000"/>
                            <attachment id="12545339" name="THRIFT-1023-refactor-transport-protocol-for-ruby19-v4.patch" size="26357" author="nbeyer" created="Sun, 16 Sep 2012 20:29:10 +0000"/>
                            <attachment id="12547125" name="THRIFT-1023-refactor-transport-protocol-for-ruby19-v5.patch" size="28060" author="nbeyer" created="Sat, 29 Sep 2012 19:09:57 +0000"/>
                            <attachment id="12547199" name="THRIFT-1023-refactor-transport-protocol-for-ruby19-v6.patch" size="41880" author="nbeyer" created="Mon, 1 Oct 2012 07:15:54 +0000"/>
                            <attachment id="12535864" name="THRIFT-1023-refactor-transport-protocol-for-ruby19.patch" size="17592" author="nbeyer_cerner" created="Tue, 10 Jul 2012 16:18:30 +0000"/>
                            <attachment id="12526499" name="thrift-1023-utf8-encoding-issue.path" size="1374" author="woodoo" created="Fri, 11 May 2012 09:22:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>187137</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 7 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i06d93:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>35081</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>