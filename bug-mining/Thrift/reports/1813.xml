<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:27:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-3821] TMemoryBuffer buffer may overflow when resizing</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-3821</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;In ensurecanwrite():&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  uint32_t new_size = bufferSize_;
  &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (len &amp;gt; avail) {
    new_size = new_size &amp;gt; 0 ? new_size * 2 : 1;
    avail = available_write() + (new_size - bufferSize_);
  }

  &lt;span class=&quot;code-comment&quot;&gt;// Allocate into a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; pointer so we don&apos;t bork ours &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it fails.
&lt;/span&gt;  uint8_t* new_buffer = static_cast&amp;lt;uint8_t*&amp;gt;(std::realloc(buffer_, new_size));
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (new_buffer == NULL) {
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; std::bad_alloc();
  }

  rBase_ = new_buffer + (rBase_ - buffer_);
  rBound_ = new_buffer + (rBound_ - buffer_);
  wBase_ = new_buffer + (wBase_ - buffer_);
  wBound_ = new_buffer + new_size;
  buffer_ = new_buffer;
  bufferSize_ = new_size;

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If old bufferSize_ is lager than 2gb, then calculating new size will overflow.&lt;br/&gt;
i.e. if bufferSize_ = 3355443200, then new buffer size will be 2415919104, which is less than old size.&lt;/p&gt;

&lt;p&gt;However, &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;avail = available_write() + (new_size - bufferSize_) 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;overflows again, so we will end up with an shrinked buffer.&lt;/p&gt;

&lt;p&gt;What is worse is that after&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  wBase_ = new_buffer + (wBase_ - buffer_);
  wBound_ = new_buffer + new_size;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;wBase_ stays the same, but wBound_ becomes lower than it. What happens next is that   uint32_t avail = available_write() may overflow every time subsequently. and thrift writes to unknown memory.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12966363">THRIFT-3821</key>
            <summary>TMemoryBuffer buffer may overflow when resizing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jking3">James E. King III</assignee>
                                    <reporter username="HuaisiXu">Huaisi Xu</reporter>
                        <labels>
                    </labels>
                <created>Mon, 9 May 2016 20:47:27 +0000</created>
                <updated>Sat, 17 Jun 2023 07:54:14 +0000</updated>
                            <resolved>Sun, 13 Aug 2017 03:05:11 +0000</resolved>
                                    <version>0.9.3</version>
                                    <fixVersion>0.11.0</fixVersion>
                                    <component>C++ - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15279305" author="huaisixu" created="Wed, 11 May 2016 00:40:46 +0000"  >&lt;p&gt;Thanks for reformatting this for me.&lt;/p&gt;

&lt;p&gt;May I ask how you plan to address this? check overflow before resizing?&lt;/p&gt;</comment>
                            <comment id="15330589" author="jking3" created="Tue, 14 Jun 2016 21:02:21 +0000"  >&lt;p&gt;How likely is this to occur in the field?  It requires allocating 2GB of memory with the class; if this is not a normal use case it may not be considered critical; I wouldn&apos;t want to block 0.10.0 for this if it is not likely to occur.&lt;/p&gt;</comment>
                            <comment id="15343218" author="jking3" created="Wed, 22 Jun 2016 02:31:55 +0000"  >&lt;p&gt;Transferring 2GB over thrift seems like an unlikely use case... I am going to lower the priority of this one down from critical.&lt;/p&gt;</comment>
                            <comment id="16113381" author="githubbot" created="Thu, 3 Aug 2017 19:55:06 +0000"  >&lt;p&gt;GitHub user asuhan opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1325&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1325&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3821&quot; title=&quot;TMemoryBuffer buffer may overflow when resizing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3821&quot;&gt;&lt;del&gt;THRIFT-3821&lt;/del&gt;&lt;/a&gt;: Check for overflow on buffer resize in TMemoryBuffer&lt;/p&gt;

&lt;p&gt;    Going over 2 GB is quite possible when using Thrift for serialization. We can detect the condition and throw an exception.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/asuhan/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/asuhan/thrift&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3821&quot; title=&quot;TMemoryBuffer buffer may overflow when resizing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3821&quot;&gt;&lt;del&gt;THRIFT-3821&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1325.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1325.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1325&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 457b7f5be06c57e8a0f0adf33c3c43d031e21991&lt;br/&gt;
Author: Alex &#350;uhan &amp;lt;alex.suhan@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-08-03T18:45:31Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3821&quot; title=&quot;TMemoryBuffer buffer may overflow when resizing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3821&quot;&gt;&lt;del&gt;THRIFT-3821&lt;/del&gt;&lt;/a&gt; Test for overflow on buffer resize in TMemoryBuffer&lt;/p&gt;

&lt;p&gt;commit af851cb570c70cef833d764dbfacfc5961031f86&lt;br/&gt;
Author: Alex &#350;uhan &amp;lt;alex.suhan@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-08-03T19:28:17Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3821&quot; title=&quot;TMemoryBuffer buffer may overflow when resizing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3821&quot;&gt;&lt;del&gt;THRIFT-3821&lt;/del&gt;&lt;/a&gt; Check for overflow on buffer resize in TMemoryBuffer&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16113824" author="githubbot" created="Fri, 4 Aug 2017 02:28:53 +0000"  >&lt;p&gt;Github user asuhan closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1325&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1325&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16113826" author="githubbot" created="Fri, 4 Aug 2017 02:29:56 +0000"  >&lt;p&gt;GitHub user asuhan opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1326&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1326&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3821&quot; title=&quot;TMemoryBuffer buffer may overflow when resizing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3821&quot;&gt;&lt;del&gt;THRIFT-3821&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Going over 2 GB is quite possible when using Thrift for serialization. We can detect the condition and throw an exception.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/asuhan/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/asuhan/thrift&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3821&quot; title=&quot;TMemoryBuffer buffer may overflow when resizing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3821&quot;&gt;&lt;del&gt;THRIFT-3821&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1326.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1326.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1326&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 314a0b30c59b0e8b314dc6c82061eecabeb10e14&lt;br/&gt;
Author: Alex &#350;uhan &amp;lt;alex.suhan@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-08-03T18:45:31Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3821&quot; title=&quot;TMemoryBuffer buffer may overflow when resizing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3821&quot;&gt;&lt;del&gt;THRIFT-3821&lt;/del&gt;&lt;/a&gt; Test for overflow on buffer resize in TMemoryBuffer&lt;/p&gt;

&lt;p&gt;commit 0fe1997d53020980abdb6f43843206a289a8e24d&lt;br/&gt;
Author: Alex &#350;uhan &amp;lt;alex.suhan@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-08-03T19:28:17Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3821&quot; title=&quot;TMemoryBuffer buffer may overflow when resizing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3821&quot;&gt;&lt;del&gt;THRIFT-3821&lt;/del&gt;&lt;/a&gt; Check for overflow on buffer resize in TMemoryBuffer&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16114252" author="anhldbk" created="Fri, 4 Aug 2017 11:12:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=HuaisiXu&quot; class=&quot;user-hover&quot; rel=&quot;HuaisiXu&quot;&gt;HuaisiXu&lt;/a&gt; Regarding this issue, I think we may have the same thing with the following &lt;span class=&quot;error&quot;&gt;&amp;#91;code&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/thrift/blob/master/lib/cpp/src/thrift/transport/TBufferTransports.cpp#L227):&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/blob/master/lib/cpp/src/thrift/transport/TBufferTransports.cpp#L227):&lt;/a&gt;&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;void TFramedTransport::writeSlow(&lt;span class=&quot;code-keyword&quot;&gt;const&lt;/span&gt; uint8_t* buf, uint32_t len) {
  &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt; buffer size until sufficient.
&lt;/span&gt;  uint32_t have = static_cast&amp;lt;uint32_t&amp;gt;(wBase_ - wBuf_.get());
  uint32_t new_size = wBufSize_;
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (len + have &amp;lt; have &lt;span class=&quot;code-comment&quot;&gt;/* overflow */&lt;/span&gt; || len + have &amp;gt; 0x7fffffff) {
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; TTransportException(TTransportException::BAD_ARGS,
                              &lt;span class=&quot;code-quote&quot;&gt;&quot;Attempted to write over 2 GB to TFramedTransport.&quot;&lt;/span&gt;);
  }
  &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (new_size &amp;lt; len + have) {
    new_size = new_size &amp;gt; 0 ? new_size * 2 : 1;
  }
  &lt;span class=&quot;code-comment&quot;&gt;// ...
&lt;/span&gt;}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16122168" author="githubbot" created="Thu, 10 Aug 2017 19:27:34 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1326#discussion_r132545680&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1326#discussion_r132545680&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/transport/TBufferTransports.cpp &amp;#8212;&lt;br/&gt;
    @@ -361,9 +361,12 @@ void TMemoryBuffer::ensureCanWrite(uint32_t len) {&lt;br/&gt;
       }&lt;/p&gt;

&lt;p&gt;       // Grow the buffer as necessary.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;uint32_t new_size = bufferSize_;&lt;br/&gt;
    +  uint64_t new_size = bufferSize_;&lt;br/&gt;
       while (len &amp;gt; avail) {&lt;br/&gt;
         new_size = new_size &amp;gt; 0 ? new_size * 2 : 1;&lt;br/&gt;
    +    if (new_size &amp;gt; std::numeric_limits&amp;lt;uint32_t&amp;gt;::max()) {&lt;br/&gt;
    +      throw TTransportException(&quot;Internal buffer size exceeded 2GB&quot;);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    I would prefer to see a TTransportException with an error type BAD_ARGS here, however it looks like error types are not being used elsewhere in this module.&lt;/p&gt;</comment>
                            <comment id="16122170" author="githubbot" created="Thu, 10 Aug 2017 19:28:07 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1326&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1326&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Please rebase (and squash to a single commit, if you can) and push here, so the build system can build the change and we can verify it before merging it.  Thanks.&lt;/p&gt;</comment>
                            <comment id="16122386" author="githubbot" created="Thu, 10 Aug 2017 21:41:27 +0000"  >&lt;p&gt;Github user asuhan commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1326&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1326&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Thanks for the review, I&apos;ll address both. It&apos;s my preference to squash the commits as well, sounds like I&apos;ve misinterpreted &lt;a href=&quot;https://thrift.apache.org/docs/HowToContribute&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://thrift.apache.org/docs/HowToContribute&lt;/a&gt; (it says &quot;When bugfixing: add test that will isolate bug before applying change that fixes it&quot;).&lt;/p&gt;</comment>
                            <comment id="16122696" author="githubbot" created="Fri, 11 Aug 2017 02:07:02 +0000"  >&lt;p&gt;Github user asuhan commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1326&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1326&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I&apos;ve disabled the test for Windows since allocating 1GB on 32-bit is likely to fail with `bad_alloc`.&lt;/p&gt;

&lt;p&gt;    Test failure looks unrelated, also got a clean run before: &lt;a href=&quot;https://travis-ci.org/apache/thrift/jobs/263298365&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/apache/thrift/jobs/263298365&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16122756" author="githubbot" created="Fri, 11 Aug 2017 03:08:50 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1326#discussion_r132611133&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1326#discussion_r132611133&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/test/TMemoryBufferTest.cpp &amp;#8212;&lt;br/&gt;
    @@ -117,4 +117,17 @@ BOOST_AUTO_TEST_CASE(test_exceptions) &lt;/p&gt;
{
       BOOST_CHECK_NO_THROW(buf2.write((const uint8_t*)&quot;bar&quot;, 3));
     }

&lt;p&gt;    +#ifndef _WIN32&lt;br/&gt;
    +// We can&apos;t allocate 1 GB of memory in 32-bit environments.&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    This makes me wonder if the TBufferTransport should have a size limit that is configurable, with a default of INT32_MAX, and then the test can make a smaller one like 4KB, and write 4KB and then one byte more, instead of using up 2GB of memory.&lt;/p&gt;</comment>
                            <comment id="16122757" author="githubbot" created="Fri, 11 Aug 2017 03:08:50 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1326#discussion_r132611000&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1326#discussion_r132611000&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/transport/TBufferTransports.cpp &amp;#8212;&lt;br/&gt;
    @@ -361,9 +361,13 @@ void TMemoryBuffer::ensureCanWrite(uint32_t len) {&lt;br/&gt;
       }&lt;/p&gt;

&lt;p&gt;       // Grow the buffer as necessary.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;uint32_t new_size = bufferSize_;&lt;br/&gt;
    +  uint64_t new_size = bufferSize_;&lt;br/&gt;
       while (len &amp;gt; avail) {&lt;br/&gt;
         new_size = new_size &amp;gt; 0 ? new_size * 2 : 1;&lt;br/&gt;
    +    if (new_size &amp;gt; std::numeric_limits&amp;lt;uint32_t&amp;gt;::max()) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Shouldn&apos;t this be int32_t instead of uint32_t, if we want to test against 2GB?  Sorry I didn&apos;t catch this before.&lt;/p&gt;</comment>
                            <comment id="16122776" author="githubbot" created="Fri, 11 Aug 2017 03:29:24 +0000"  >&lt;p&gt;Github user asuhan commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1326#discussion_r132612265&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1326#discussion_r132612265&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/transport/TBufferTransports.cpp &amp;#8212;&lt;br/&gt;
    @@ -361,9 +361,13 @@ void TMemoryBuffer::ensureCanWrite(uint32_t len) {&lt;br/&gt;
       }&lt;/p&gt;

&lt;p&gt;       // Grow the buffer as necessary.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;uint32_t new_size = bufferSize_;&lt;br/&gt;
    +  uint64_t new_size = bufferSize_;&lt;br/&gt;
       while (len &amp;gt; avail) {&lt;br/&gt;
         new_size = new_size &amp;gt; 0 ? new_size * 2 : 1;&lt;br/&gt;
    +    if (new_size &amp;gt; std::numeric_limits&amp;lt;uint32_t&amp;gt;::max()) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    We check it post-resize and it fails if we go past 4 GB, therefore pre-resize it must be at most 2GB. Checking against `int32_t` would be overly conservative; we mainly care about avoiding the arithmetic overflow. Maybe the error message could be improved? `&quot;Internal buffer size was already past 2GB when we attempted to resize&quot;` would be a more precise description, but I didn&apos;t want to make it overly verbose / obscure.&lt;/p&gt;</comment>
                            <comment id="16122784" author="githubbot" created="Fri, 11 Aug 2017 03:34:27 +0000"  >&lt;p&gt;Github user asuhan commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1326#discussion_r132612556&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1326#discussion_r132612556&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/test/TMemoryBufferTest.cpp &amp;#8212;&lt;br/&gt;
    @@ -117,4 +117,17 @@ BOOST_AUTO_TEST_CASE(test_exceptions) &lt;/p&gt;
{
       BOOST_CHECK_NO_THROW(buf2.write((const uint8_t*)&quot;bar&quot;, 3));
     }

&lt;p&gt;    +#ifndef _WIN32&lt;br/&gt;
    +// We can&apos;t allocate 1 GB of memory in 32-bit environments.&lt;br/&gt;
    &amp;#8212; End diff &amp;#8211;&lt;/p&gt;

&lt;p&gt;    We&apos;d have to write in a loop to trigger buffer resizing if I understand correctly. It&apos;d save the vector allocation in the test, but `TMemoryBuffer` would still grow. I agree a 50% reduction would be better than nothing, for sure.&lt;/p&gt;</comment>
                            <comment id="16122799" author="githubbot" created="Fri, 11 Aug 2017 03:56:13 +0000"  >&lt;p&gt;Github user asuhan commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1326#discussion_r132613779&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1326#discussion_r132613779&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/transport/TBufferTransports.cpp &amp;#8212;&lt;br/&gt;
    @@ -361,9 +361,13 @@ void TMemoryBuffer::ensureCanWrite(uint32_t len) {&lt;br/&gt;
       }&lt;/p&gt;

&lt;p&gt;       // Grow the buffer as necessary.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;uint32_t new_size = bufferSize_;&lt;br/&gt;
    +  uint64_t new_size = bufferSize_;&lt;br/&gt;
       while (len &amp;gt; avail) {&lt;br/&gt;
         new_size = new_size &amp;gt; 0 ? new_size * 2 : 1;&lt;br/&gt;
    +    if (new_size &amp;gt; std::numeric_limits&amp;lt;uint32_t&amp;gt;::max()) {
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Basically, if we only go through powers of 2 when resizing (which looks to be the case), the buffer can only grow to 2GB since the maximum value of `uint32_t` is one short of 4GB.  &lt;/p&gt;</comment>
                            <comment id="16124775" author="githubbot" created="Sun, 13 Aug 2017 02:54:29 +0000"  >&lt;p&gt;Github user asuhan commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1326&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1326&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Are there any additional changes I should make to this pull request? As I&apos;ve said in the inline comment, I believe comparing to `std::numeric_limits&amp;lt;uint32_t&amp;gt;::max()` is actually consistent with what the error message says.&lt;/p&gt;</comment>
                            <comment id="16124779" author="githubbot" created="Sun, 13 Aug 2017 03:02:03 +0000"  >&lt;p&gt;Github user jeking3 commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1326&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1326&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    I&apos;d prefer if we refactored it to make the limit configurable with a default matching what it is now; that way tests won&apos;t need multiple gigabytes of memory to function properly.  I&apos;ll approve and merge this for now as it is an improvement.&lt;/p&gt;</comment>
                            <comment id="16124780" author="githubbot" created="Sun, 13 Aug 2017 03:05:20 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1326&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1326&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16176872" author="githubbot" created="Fri, 22 Sep 2017 18:21:40 +0000"  >&lt;p&gt;GitHub user jeking3 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1369&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1369&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3821&quot; title=&quot;TMemoryBuffer buffer may overflow when resizing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3821&quot;&gt;&lt;del&gt;THRIFT-3821&lt;/del&gt;&lt;/a&gt;: make memory buffer size configurable&lt;/p&gt;

&lt;p&gt;     so unit test doesn&apos;t need 2GB to run; &lt;br/&gt;
    also added a unit test to prove &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3480&quot; title=&quot;offer a simple approach to compute byte size of the serialized object&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3480&quot;&gt;&lt;del&gt;THRIFT-3480&lt;/del&gt;&lt;/a&gt; alternative&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jeking3/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jeking3/thrift&lt;/a&gt; memorybuffer&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1369.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1369.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1369&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 22f7af0e75768680fea79b656d6c32df5a430d43&lt;br/&gt;
Author: James E. King, III &amp;lt;jking@apache.org&amp;gt;&lt;br/&gt;
Date:   2017-09-22T18:20:15Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3821&quot; title=&quot;TMemoryBuffer buffer may overflow when resizing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3821&quot;&gt;&lt;del&gt;THRIFT-3821&lt;/del&gt;&lt;/a&gt;: make memory buffer size configurable so unit test doesn&apos;t need 2GB to run; prove &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3480&quot; title=&quot;offer a simple approach to compute byte size of the serialized object&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3480&quot;&gt;&lt;del&gt;THRIFT-3480&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16177255" author="githubbot" created="Fri, 22 Sep 2017 22:18:33 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/1369&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1369&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16177257" author="jking3" created="Fri, 22 Sep 2017 22:19:06 +0000"  >&lt;p&gt;I checked in a small change to make the maximum buffer size configurable so that the unit test would not need 2GB of memory - it was getting killed in one of my build environments.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12831153">THRIFT-3166</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13540398">THRIFT-5716</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 8 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2xe6n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>