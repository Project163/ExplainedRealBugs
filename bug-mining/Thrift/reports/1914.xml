<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:29:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-4631] Codegen Creates Invalid Ruby for Recursive Structs</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-4631</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;Though thrift supports defining recursive structs, it appears that the Ruby codegen does not generate valid Ruby for for recursive structs.&lt;/p&gt;

&lt;p&gt;e.g. Here&apos;s an example of what I&apos;m seeing and how to recreate it using Recursive.thrift in the Thrift test suite.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;add&#160;&lt;tt&gt;$(THRIFT) --gen rb ../Recursive.thrift&lt;/tt&gt; to &lt;tt&gt;test/rb/Makefile.am&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;and add &lt;tt&gt;require &quot;recursive_types&quot;&lt;/tt&gt; to &lt;tt&gt;test/rb/generation/test_struct.rb&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;run &lt;tt&gt;make -k check&lt;/tt&gt; from &lt;tt&gt;test/rb&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;this ends up raising the following exception:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
thrift/test/rb/gen-rb/recursive_types.rb:50:in `&amp;lt;&lt;span class=&quot;code-keyword&quot;&gt;class:&lt;/span&gt;CoRec&amp;gt;&apos;: uninitialized constant CoRec2 (NameError)
Did you mean?  CoRec
	from thrift/test/rb/gen-rb/recursive_types.rb:45:in `&amp;lt;top (required)&amp;gt;&apos;
	from thrift/test/rb/generation/test_struct.rb:22:in `require&apos;
	from thrift/test/rb/generation/test_struct.rb:22:in `&amp;lt;top (required)&amp;gt;&apos;
	from test_suite.rb:20:in `require&apos;
	from test_suite.rb:20:in `block in &amp;lt;main&amp;gt;&apos;
	from test_suite.rb:20:in `each&apos;
	from test_suite.rb:20:in `&amp;lt;main&amp;gt;&apos;
make: *** [check] Error 1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ve copied the generated code below. But essentially the issue appears to be that recursive structs are referencing constants or classes that have not yet been declared. I have some ideas on how to&#160;address this and can post a&#160;proposed solution.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;generated code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
#
# Autogenerated by Thrift &lt;span class=&quot;code-object&quot;&gt;Compiler&lt;/span&gt; (0.11.0)
#
# DO NOT EDIT UNLESS YOU ARE SURE THAT YOU KNOW WHAT YOU ARE DOING
#

require &lt;span class=&quot;code-quote&quot;&gt;&apos;thrift&apos;&lt;/span&gt;

module RecursiveExample
  &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Node &amp;lt; ::Thrift::Union
    include ::Thrift::Struct_Union
    class &amp;lt;&amp;lt; self
      def inner_node(val)
        Node.&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;(:inner_node, val)
      end

      def leaf_node(val)
        Node.&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;(:leaf_node, val)
      end
    end

    INNER_NODE = 1
    LEAF_NODE = 2

    FIELDS = {
      INNER_NODE =&amp;gt; {:type =&amp;gt; ::Thrift::Types::STRUCT, :name =&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;inner_node&apos;&lt;/span&gt;, :class =&amp;gt; ::RecursiveExample::InnerNode, :optional =&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;},
      LEAF_NODE =&amp;gt; {:type =&amp;gt; ::Thrift::Types::STRUCT, :name =&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;leaf_node&apos;&lt;/span&gt;, :class =&amp;gt; ::RecursiveExample::LeafNode, :optional =&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;}
    }

    def struct_fields; FIELDS; end

    def validate
      raise(StandardError, &lt;span class=&quot;code-quote&quot;&gt;&apos;Union fields are not set.&apos;&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; get_set_field.nil? || get_value.nil?
    end

    ::Thrift::Union.generate_accessors self
  end

  &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;InnerNode
    include ::Thrift::Struct, ::Thrift::Struct_Union
    NODE = 1

    FIELDS = {
      NODE =&amp;gt; {:type =&amp;gt; ::Thrift::Types::STRUCT, :name =&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;node&apos;&lt;/span&gt;, :class =&amp;gt; ::RecursiveExample::Node}
    }

    def struct_fields; FIELDS; end

    def validate
      raise ::Thrift::ProtocolException.&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;(::Thrift::ProtocolException::UNKNOWN, &lt;span class=&quot;code-quote&quot;&gt;&apos;Required field node is unset!&apos;&lt;/span&gt;) unless @node    end

    ::Thrift::Struct.generate_accessors self
  end

  &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;LeafNode
    include ::Thrift::Struct, ::Thrift::Struct_Union

    FIELDS = {

    }

    def struct_fields; FIELDS; end

    def validate
    end

    ::Thrift::Struct.generate_accessors self
  end

end
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13184666">THRIFT-4631</key>
            <summary>Codegen Creates Invalid Ruby for Recursive Structs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jking3">James E. King III</assignee>
                                    <reporter username="cgardens">charles giardina</reporter>
                        <labels>
                    </labels>
                <created>Wed, 12 Sep 2018 16:34:15 +0000</created>
                <updated>Thu, 27 Dec 2018 15:25:13 +0000</updated>
                            <resolved>Sat, 15 Sep 2018 13:47:22 +0000</resolved>
                                    <version>0.11.0</version>
                                    <fixVersion>0.12.0</fixVersion>
                                    <component>Ruby - Compiler</component>
                    <component>Ruby - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16612460" author="githubbot" created="Wed, 12 Sep 2018 16:57:16 +0000"  >&lt;p&gt;cgardens opened a new pull request #1592: &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4631&quot; title=&quot;Codegen Creates Invalid Ruby for Recursive Structs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4631&quot;&gt;&lt;del&gt;THRIFT-4631&lt;/del&gt;&lt;/a&gt; Fix Ruby codegen to gen valid ruby for recursive structs&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/thrift/pull/1592&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1592&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Client: Ruby&lt;/p&gt;

&lt;p&gt;   re: &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4631&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/THRIFT-4631&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   The goal of this PR is to alter the thrift ruby code generator so that in cases where we define structs that rely on recursion, it generates valid ruby.&lt;/p&gt;

&lt;p&gt;   The codegen include a `generate_forward_declaration` method which gets called before `generate_struct`. It allows us to eagerly declare ruby classes so that all classes are declared before any of the recursion within the classes executes. Without implementing something like this you get an `uninitialized constant` exception.&lt;/p&gt;

&lt;p&gt;   I&apos;ve added tests to catch the original issue as well.&lt;/p&gt;

&lt;p&gt;   The delta caused by the this change is adding class declarations at the top of the generated files. Here&apos;s the delta alone. Full copies of the before / after below.&lt;br/&gt;
   ```&lt;br/&gt;
   class RecTree; end&lt;/p&gt;

&lt;p&gt;   class RecList; end&lt;/p&gt;

&lt;p&gt;   class CoRec; end&lt;/p&gt;

&lt;p&gt;   class CoRec2; end&lt;/p&gt;

&lt;p&gt;   class VectorTest; end&lt;br/&gt;
   ```&lt;/p&gt;


&lt;p&gt;   What gets generated now for Recursive.thrift&lt;br/&gt;
   ```&lt;br/&gt;
   #&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Autogenerated by Thrift Compiler (1.0.0-dev)&lt;br/&gt;
   #&lt;/li&gt;
	&lt;li&gt;DO NOT EDIT UNLESS YOU ARE SURE THAT YOU KNOW WHAT YOU ARE DOING&lt;br/&gt;
   #&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   require &apos;thrift&apos;&lt;/p&gt;

&lt;p&gt;   class RecTree&lt;br/&gt;
     include ::Thrift::Struct, ::Thrift::Struct_Union&lt;br/&gt;
     CHILDREN = 1&lt;br/&gt;
     ITEM = 2&lt;/p&gt;

&lt;p&gt;     FIELDS = {&lt;br/&gt;
       CHILDREN =&amp;gt; {:type =&amp;gt; ::Thrift::Types::LIST, :name =&amp;gt; &apos;children&apos;, :element =&amp;gt; {:type =&amp;gt; ::Thrift::Types::STRUCT, :class =&amp;gt; ::RecTree}},&lt;br/&gt;
       ITEM =&amp;gt; {:type =&amp;gt; ::Thrift::Types::I16, :name =&amp;gt; &apos;item&apos;}&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     def struct_fields; FIELDS; end&lt;/p&gt;

&lt;p&gt;     def validate&lt;br/&gt;
     end&lt;/p&gt;

&lt;p&gt;     ::Thrift::Struct.generate_accessors self&lt;br/&gt;
   end&lt;/p&gt;

&lt;p&gt;   class RecList&lt;br/&gt;
     include ::Thrift::Struct, ::Thrift::Struct_Union&lt;br/&gt;
     NEXTITEM = 1&lt;br/&gt;
     ITEM = 3&lt;/p&gt;

&lt;p&gt;     FIELDS = {&lt;br/&gt;
       NEXTITEM =&amp;gt; {:type =&amp;gt; ::Thrift::Types::STRUCT, :name =&amp;gt; &apos;nextitem&apos;, :class =&amp;gt; ::RecList},&lt;br/&gt;
       ITEM =&amp;gt; {:type =&amp;gt; ::Thrift::Types::I16, :name =&amp;gt; &apos;item&apos;}&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     def struct_fields; FIELDS; end&lt;/p&gt;

&lt;p&gt;     def validate&lt;br/&gt;
     end&lt;/p&gt;

&lt;p&gt;     ::Thrift::Struct.generate_accessors self&lt;br/&gt;
   end&lt;/p&gt;

&lt;p&gt;   class CoRec&lt;br/&gt;
     include ::Thrift::Struct, ::Thrift::Struct_Union&lt;br/&gt;
     OTHER = 1&lt;/p&gt;

&lt;p&gt;     FIELDS = {&lt;br/&gt;
       OTHER =&amp;gt; {:type =&amp;gt; ::Thrift::Types::STRUCT, :name =&amp;gt; &apos;other&apos;, :class =&amp;gt; ::CoRec2}&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     def struct_fields; FIELDS; end&lt;/p&gt;

&lt;p&gt;     def validate&lt;br/&gt;
     end&lt;/p&gt;

&lt;p&gt;     ::Thrift::Struct.generate_accessors self&lt;br/&gt;
   end&lt;/p&gt;

&lt;p&gt;   class CoRec2&lt;br/&gt;
     include ::Thrift::Struct, ::Thrift::Struct_Union&lt;br/&gt;
     OTHER = 1&lt;/p&gt;

&lt;p&gt;     FIELDS = {&lt;br/&gt;
       OTHER =&amp;gt; {:type =&amp;gt; ::Thrift::Types::STRUCT, :name =&amp;gt; &apos;other&apos;, :class =&amp;gt; ::CoRec}&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     def struct_fields; FIELDS; end&lt;/p&gt;

&lt;p&gt;     def validate&lt;br/&gt;
     end&lt;/p&gt;

&lt;p&gt;     ::Thrift::Struct.generate_accessors self&lt;br/&gt;
   end&lt;/p&gt;

&lt;p&gt;   class VectorTest&lt;br/&gt;
     include ::Thrift::Struct, ::Thrift::Struct_Union&lt;br/&gt;
     LISTER = 1&lt;/p&gt;

&lt;p&gt;     FIELDS = {&lt;br/&gt;
       LISTER =&amp;gt; {:type =&amp;gt; ::Thrift::Types::LIST, :name =&amp;gt; &apos;lister&apos;, :element =&amp;gt; {:type =&amp;gt; ::Thrift::Types::STRUCT, :class =&amp;gt; ::RecList}}&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     def struct_fields; FIELDS; end&lt;/p&gt;

&lt;p&gt;     def validate&lt;br/&gt;
     end&lt;/p&gt;

&lt;p&gt;     ::Thrift::Struct.generate_accessors self&lt;br/&gt;
   end&lt;br/&gt;
   ```&lt;/p&gt;

&lt;p&gt;   What is generated using this PR:&lt;br/&gt;
   ```&lt;br/&gt;
   #&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Autogenerated by Thrift Compiler (1.0.0-dev)&lt;br/&gt;
   #&lt;/li&gt;
	&lt;li&gt;DO NOT EDIT UNLESS YOU ARE SURE THAT YOU KNOW WHAT YOU ARE DOING&lt;br/&gt;
   #&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   require &apos;thrift&apos;&lt;/p&gt;

&lt;p&gt;   class RecTree; end&lt;/p&gt;

&lt;p&gt;   class RecList; end&lt;/p&gt;

&lt;p&gt;   class CoRec; end&lt;/p&gt;

&lt;p&gt;   class CoRec2; end&lt;/p&gt;

&lt;p&gt;   class VectorTest; end&lt;/p&gt;

&lt;p&gt;   class RecTree&lt;br/&gt;
     include ::Thrift::Struct, ::Thrift::Struct_Union&lt;br/&gt;
     CHILDREN = 1&lt;br/&gt;
     ITEM = 2&lt;/p&gt;

&lt;p&gt;     FIELDS = {&lt;br/&gt;
       CHILDREN =&amp;gt; {:type =&amp;gt; ::Thrift::Types::LIST, :name =&amp;gt; &apos;children&apos;, :element =&amp;gt; {:type =&amp;gt; ::Thrift::Types::STRUCT, :class =&amp;gt; ::RecTree}},&lt;br/&gt;
       ITEM =&amp;gt; {:type =&amp;gt; ::Thrift::Types::I16, :name =&amp;gt; &apos;item&apos;}&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     def struct_fields; FIELDS; end&lt;/p&gt;

&lt;p&gt;     def validate&lt;br/&gt;
     end&lt;/p&gt;

&lt;p&gt;     ::Thrift::Struct.generate_accessors self&lt;br/&gt;
   end&lt;/p&gt;

&lt;p&gt;   class RecList&lt;br/&gt;
     include ::Thrift::Struct, ::Thrift::Struct_Union&lt;br/&gt;
     NEXTITEM = 1&lt;br/&gt;
     ITEM = 3&lt;/p&gt;

&lt;p&gt;     FIELDS = {&lt;br/&gt;
       NEXTITEM =&amp;gt; {:type =&amp;gt; ::Thrift::Types::STRUCT, :name =&amp;gt; &apos;nextitem&apos;, :class =&amp;gt; ::RecList},&lt;br/&gt;
       ITEM =&amp;gt; {:type =&amp;gt; ::Thrift::Types::I16, :name =&amp;gt; &apos;item&apos;}&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     def struct_fields; FIELDS; end&lt;/p&gt;

&lt;p&gt;     def validate&lt;br/&gt;
     end&lt;/p&gt;

&lt;p&gt;     ::Thrift::Struct.generate_accessors self&lt;br/&gt;
   end&lt;/p&gt;

&lt;p&gt;   class CoRec&lt;br/&gt;
     include ::Thrift::Struct, ::Thrift::Struct_Union&lt;br/&gt;
     OTHER = 1&lt;/p&gt;

&lt;p&gt;     FIELDS = {&lt;br/&gt;
       OTHER =&amp;gt; {:type =&amp;gt; ::Thrift::Types::STRUCT, :name =&amp;gt; &apos;other&apos;, :class =&amp;gt; ::CoRec2}&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     def struct_fields; FIELDS; end&lt;/p&gt;

&lt;p&gt;     def validate&lt;br/&gt;
     end&lt;/p&gt;

&lt;p&gt;     ::Thrift::Struct.generate_accessors self&lt;br/&gt;
   end&lt;/p&gt;

&lt;p&gt;   class CoRec2&lt;br/&gt;
     include ::Thrift::Struct, ::Thrift::Struct_Union&lt;br/&gt;
     OTHER = 1&lt;/p&gt;

&lt;p&gt;     FIELDS = {&lt;br/&gt;
       OTHER =&amp;gt; {:type =&amp;gt; ::Thrift::Types::STRUCT, :name =&amp;gt; &apos;other&apos;, :class =&amp;gt; ::CoRec}&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     def struct_fields; FIELDS; end&lt;/p&gt;

&lt;p&gt;     def validate&lt;br/&gt;
     end&lt;/p&gt;

&lt;p&gt;     ::Thrift::Struct.generate_accessors self&lt;br/&gt;
   end&lt;/p&gt;

&lt;p&gt;   class VectorTest&lt;br/&gt;
     include ::Thrift::Struct, ::Thrift::Struct_Union&lt;br/&gt;
     LISTER = 1&lt;/p&gt;

&lt;p&gt;     FIELDS = {&lt;br/&gt;
       LISTER =&amp;gt; {:type =&amp;gt; ::Thrift::Types::LIST, :name =&amp;gt; &apos;lister&apos;, :element =&amp;gt; {:type =&amp;gt; ::Thrift::Types::STRUCT, :class =&amp;gt; ::RecList}}&lt;br/&gt;
     }&lt;/p&gt;

&lt;p&gt;     def struct_fields; FIELDS; end&lt;/p&gt;

&lt;p&gt;     def validate&lt;br/&gt;
     end&lt;/p&gt;

&lt;p&gt;     ::Thrift::Struct.generate_accessors self&lt;br/&gt;
   end&lt;br/&gt;
   ```&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16612882" author="jking3" created="Thu, 13 Sep 2018 00:07:48 +0000"  >&lt;p&gt;Is this related to &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3015&quot; title=&quot;Ruby structs are not recursively validated&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3015&quot;&gt;THRIFT-3015&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="16613838" author="cgardens" created="Thu, 13 Sep 2018 17:43:25 +0000"  >&lt;p&gt;I don&apos;t think so. Please correct me if I&apos;m wrong, because I&apos;m not super familiar with the feature&#160;described&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3015&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/THRIFT-3015&lt;/a&gt;, but I think what the reporter is trying to get at is that the &lt;tt&gt;validate&lt;/tt&gt;&#160;method isn&apos;t getting generated the way he expects it to and that causes problems in serialization / deserialization. I don&apos;t think he&apos;s actually referring to an issue for structs that have recursion in their definition.&lt;/p&gt;

&lt;p&gt;The recursion issue that I&apos;m trying to point to is&#160;the case where the struct definition is defined recursively. e.g. A field in Struct A is of type A. or e.g. in the thrift test suite: &lt;a href=&quot;https://github.com/apache/thrift/blob/master/test/Recursive.thrift#L20-L23&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/blob/master/test/Recursive.thrift#L20-L23&lt;/a&gt;. The codegen doesn&apos;t generated valid ruby for these sorts of structs.&lt;/p&gt;

&lt;p&gt;Does that make sense?&lt;/p&gt;</comment>
                            <comment id="16615138" author="githubbot" created="Fri, 14 Sep 2018 17:43:31 +0000"  >&lt;p&gt;cgardens commented on issue #1592: &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4631&quot; title=&quot;Codegen Creates Invalid Ruby for Recursive Structs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4631&quot;&gt;&lt;del&gt;THRIFT-4631&lt;/del&gt;&lt;/a&gt; Fix Ruby codegen to gen valid ruby for recursive structs&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/thrift/pull/1592#issuecomment-421433216&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1592#issuecomment-421433216&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @jeking3 - thanks for reviewing so quickly! &lt;/p&gt;

&lt;p&gt;   It looks like the travis build is failing. I&apos;ve gone through the logs and I&apos;m not finding anything in there that&apos;s specific to this change, but I know these are famous last words... &lt;/p&gt;

&lt;p&gt;   From what I&apos;m seeing it looks like the part of the build that&apos;s failing is also failing on master.&lt;br/&gt;
   build for this pr: &lt;a href=&quot;https://travis-ci.org/apache/thrift/builds/427781155?utm_source=github_status&amp;amp;utm_medium=notification&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/apache/thrift/builds/427781155?utm_source=github_status&amp;amp;utm_medium=notification&lt;/a&gt;&lt;br/&gt;
   build for master: &lt;a href=&quot;https://travis-ci.org/apache/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/apache/thrift&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16615139" author="githubbot" created="Fri, 14 Sep 2018 17:44:13 +0000"  >&lt;p&gt;cgardens edited a comment on issue #1592: &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4631&quot; title=&quot;Codegen Creates Invalid Ruby for Recursive Structs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4631&quot;&gt;&lt;del&gt;THRIFT-4631&lt;/del&gt;&lt;/a&gt; Fix Ruby codegen to gen valid ruby for recursive structs&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/thrift/pull/1592#issuecomment-421433216&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1592#issuecomment-421433216&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   @jeking3 - thanks for reviewing so quickly! &lt;/p&gt;

&lt;p&gt;   It looks like the travis build is failing. I&apos;ve gone through the logs and I&apos;m not finding anything in there that&apos;s specific to this change, but I know these are famous last words... &lt;/p&gt;

&lt;p&gt;   From what I&apos;m seeing it looks like the part of the build that&apos;s failing is also failing on master.&lt;br/&gt;
   build for this pr: &lt;a href=&quot;https://travis-ci.org/apache/thrift/builds/427781155?utm_source=github_status&amp;amp;utm_medium=notification&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/apache/thrift/builds/427781155?utm_source=github_status&amp;amp;utm_medium=notification&lt;/a&gt;&lt;br/&gt;
   build for master: &lt;a href=&quot;https://travis-ci.org/apache/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://travis-ci.org/apache/thrift&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   Am I missing something here? Let me know if there&apos;s something more I should be doing. Thanks!&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16616299" author="githubbot" created="Sat, 15 Sep 2018 13:47:07 +0000"  >&lt;p&gt;jeking3 commented on issue #1592: &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4631&quot; title=&quot;Codegen Creates Invalid Ruby for Recursive Structs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4631&quot;&gt;&lt;del&gt;THRIFT-4631&lt;/del&gt;&lt;/a&gt; Fix Ruby codegen to gen valid ruby for recursive structs&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/thrift/pull/1592#issuecomment-421573125&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1592#issuecomment-421573125&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Job 7 in the build for Ubuntu Xenial was failing due to &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4634&quot; title=&quot;Haskell builds with older cabal cannot reconcile complex version requirements&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4634&quot;&gt;&lt;del&gt;THRIFT-4634&lt;/del&gt;&lt;/a&gt;, fixed in #1594 which I just merged.  I will ignore that error and merge your change.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16616300" author="githubbot" created="Sat, 15 Sep 2018 13:47:18 +0000"  >&lt;p&gt;jeking3 closed pull request #1592: &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-4631&quot; title=&quot;Codegen Creates Invalid Ruby for Recursive Structs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-4631&quot;&gt;&lt;del&gt;THRIFT-4631&lt;/del&gt;&lt;/a&gt; Fix Ruby codegen to gen valid ruby for recursive structs&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/thrift/pull/1592&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/1592&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/compiler/cpp/src/thrift/generate/t_rb_generator.cc b/compiler/cpp/src/thrift/generate/t_rb_generator.cc&lt;br/&gt;
index 3f2b78e6ad..13ea2490eb 100644&lt;br/&gt;
&amp;#8212; a/compiler/cpp/src/thrift/generate/t_rb_generator.cc&lt;br/&gt;
+++ b/compiler/cpp/src/thrift/generate/t_rb_generator.cc&lt;br/&gt;
@@ -113,6 +113,7 @@ class t_rb_generator : public t_oop_generator {&lt;br/&gt;
   void generate_enum(t_enum* tenum);&lt;br/&gt;
   void generate_const(t_const* tconst);&lt;br/&gt;
   void generate_struct(t_struct* tstruct);&lt;br/&gt;
+  void generate_forward_declaration(t_struct* tstruct);&lt;br/&gt;
   void generate_union(t_struct* tunion);&lt;br/&gt;
   void generate_xception(t_struct* txception);&lt;br/&gt;
   void generate_service(t_service* tservice);&lt;br/&gt;
@@ -123,6 +124,7 @@ class t_rb_generator : public t_oop_generator {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Struct generation code&lt;br/&gt;
    */&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+  void generate_rb_struct_declaration(t_rb_ofstream&amp;amp; out, t_struct* tstruct, bool is_exception);&lt;br/&gt;
   void generate_rb_struct(t_rb_ofstream&amp;amp; out, t_struct* tstruct, bool is_exception);&lt;br/&gt;
   void generate_rb_struct_required_validator(t_rb_ofstream&amp;amp; out, t_struct* tstruct);&lt;br/&gt;
   void generate_rb_union(t_rb_ofstream&amp;amp; out, t_struct* tstruct, bool is_exception);&lt;br/&gt;
@@ -529,6 +531,29 @@ void t_rb_generator::generate_struct(t_struct* tstruct) {&lt;br/&gt;
   }&lt;br/&gt;
 }&lt;/p&gt;

&lt;p&gt;+&lt;br/&gt;
+/**&lt;br/&gt;
+ * Generates the &quot;forward declarations&quot; for ruby structs.&lt;br/&gt;
+ * These are simply a declaration of each class with proper inheritance.&lt;br/&gt;
+ * The rest of the struct is still generated in generate_struct as has&lt;br/&gt;
+ * always been the case. These declarations allow thrift to generate valid&lt;br/&gt;
+ * ruby in cases where thrift structs rely on recursive definitions.&lt;br/&gt;
+ */&lt;br/&gt;
+void t_rb_generator::generate_forward_declaration(t_struct* tstruct) &lt;/p&gt;
{
+  generate_rb_struct_declaration(f_types_, tstruct, tstruct-&amp;gt;is_xception());
+}
&lt;p&gt;+&lt;br/&gt;
+void t_rb_generator::generate_rb_struct_declaration(t_rb_ofstream&amp;amp; out, t_struct* tstruct, bool is_exception) {&lt;br/&gt;
+  out.indent() &amp;lt;&amp;lt; &quot;class &quot; &amp;lt;&amp;lt; type_name(tstruct);&lt;br/&gt;
+  if (tstruct-&amp;gt;is_union()) &lt;/p&gt;
{
+    out &amp;lt;&amp;lt; &quot; &amp;lt; ::Thrift::Union&quot;;
+  }
&lt;p&gt;+  if (is_exception) &lt;/p&gt;
{
+    out &amp;lt;&amp;lt; &quot; &amp;lt; ::Thrift::Exception&quot;;
+  }
&lt;p&gt;+  out &amp;lt;&amp;lt; &quot;; end&quot; &amp;lt;&amp;lt; endl &amp;lt;&amp;lt; endl;&lt;br/&gt;
+}&lt;br/&gt;
+&lt;br/&gt;
 /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Generates a struct definition for a thrift exception. Basically the same&lt;/li&gt;
	&lt;li&gt;as a struct but extends the Exception class.&lt;br/&gt;
diff --git a/test/rb/Makefile.am b/test/rb/Makefile.am&lt;br/&gt;
index 4bd4704817..cfdc1496ef 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/test/rb/Makefile.am&lt;br/&gt;
+++ b/test/rb/Makefile.am&lt;br/&gt;
@@ -20,6 +20,7 @@&lt;br/&gt;
 stubs: $(THRIFT) ../ThriftTest.thrift ../SmallTest.thrift&lt;br/&gt;
 	$(THRIFT) --gen rb ../ThriftTest.thrift&lt;br/&gt;
 	$(THRIFT) --gen rb ../SmallTest.thrift&lt;br/&gt;
+	$(THRIFT) --gen rb ../Recursive.thrift&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; precross: stubs&lt;/p&gt;

&lt;p&gt;diff --git a/test/rb/generation/test_recursive.rb b/test/rb/generation/test_recursive.rb&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 0000000000..e912f72f53&lt;br/&gt;
&amp;#8212; /dev/null&lt;br/&gt;
+++ b/test/rb/generation/test_recursive.rb&lt;br/&gt;
@@ -0,0 +1,41 @@&lt;br/&gt;
+#&lt;br/&gt;
+# Licensed to the Apache Software Foundation (ASF) under one&lt;br/&gt;
+# or more contributor license agreements. See the NOTICE file&lt;br/&gt;
+# distributed with this work for additional information&lt;br/&gt;
+# regarding copyright ownership. The ASF licenses this file&lt;br/&gt;
+# to you under the Apache License, Version 2.0 (the&lt;br/&gt;
+# &quot;License&quot;); you may not use this file except in compliance&lt;br/&gt;
+# with the License. You may obtain a copy of the License at&lt;br/&gt;
+#&lt;br/&gt;
+#   &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+#&lt;br/&gt;
+# Unless required by applicable law or agreed to in writing,&lt;br/&gt;
+# software distributed under the License is distributed on an&lt;br/&gt;
+# &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY&lt;br/&gt;
+# KIND, either express or implied. See the License for the&lt;br/&gt;
+# specific language governing permissions and limitations&lt;br/&gt;
+# under the License.&lt;br/&gt;
+#&lt;br/&gt;
+&lt;br/&gt;
+require File.join(File.dirname(_&lt;em&gt;FILE&lt;/em&gt;_), &apos;../test_helper&apos;)&lt;br/&gt;
+require &apos;recursive_types&apos;&lt;br/&gt;
+&lt;br/&gt;
+class TestRecursiveGeneration &amp;lt; Test::Unit::TestCase&lt;br/&gt;
+  CHILD_ITEM = &quot;child item&quot;&lt;br/&gt;
+  PARENT_ITEM = &quot;parent item&quot;&lt;br/&gt;
+&lt;br/&gt;
+  def test_can_create_recursive_tree&lt;br/&gt;
+&lt;br/&gt;
+    child_tree = RecTree.new&lt;br/&gt;
+    child_tree.item = CHILD_ITEM&lt;br/&gt;
+&lt;br/&gt;
+    parent_tree = RecTree.new&lt;br/&gt;
+    parent_tree.item = PARENT_ITEM&lt;br/&gt;
+    parent_tree.children = &lt;span class=&quot;error&quot;&gt;&amp;#91;child_tree&amp;#93;&lt;/span&gt;&lt;br/&gt;
+&lt;br/&gt;
+    assert_equal(PARENT_ITEM, parent_tree.item)&lt;br/&gt;
+    assert_equal(1, parent_tree.children.length)&lt;br/&gt;
+    assert_equal(CHILD_ITEM, parent_tree.children.first.item)&lt;br/&gt;
+    assert_nil(parent_tree.children.first.children)&lt;br/&gt;
+  end&lt;br/&gt;
+end&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16616301" author="jking3" created="Sat, 15 Sep 2018 13:47:22 +0000"  >&lt;p&gt;Committed - thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 9 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3y0nr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>