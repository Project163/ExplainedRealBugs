<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 07:58:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-885] Url encoded strings never get decoded? How do we fix this?</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-885</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;This is for the test java server that was written to test the client. &lt;br/&gt;
Suppose you have a method such as          testString(theTestString)&lt;br/&gt;
If you call it from the javascript like so:&lt;/p&gt;

&lt;p&gt;client.testString(&quot;hello man&quot;);&lt;br/&gt;
The string that your server implementation sees will be all crazy and url encoded.&lt;/p&gt;

&lt;p&gt;public static void testString(string theTestString) {&lt;br/&gt;
   // Inside here that string looks like &quot;hello%20man&quot;.&lt;br/&gt;
}&lt;br/&gt;
We need it to be urlencoded when coming across the wire because we&apos;re using JSON as the protocol, but once it gets to thrift server code, it needs to be normal.&lt;/p&gt;

&lt;p&gt;So what&apos;s going on here? Inside of strings (of javascript objects) things like quotes and spaces are escaped. This is fine, but I do not believe that is part of the TJSONProtocol. This is something that is specific to having a js thrift client am I right? So where do we fix this?&lt;br/&gt;
Edit: I had proposed a code fix which I do not believe to be the correct solution. Deleting- see future post for what I believe to be correct.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12472992">THRIFT-885</key>
            <summary>Url encoded strings never get decoded? How do we fix this?</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tjake">T Jake Luciani</assignee>
                                    <reporter username="jordo">Jordan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 1 Sep 2010 01:41:35 +0000</created>
                <updated>Tue, 1 Nov 2011 02:52:06 +0000</updated>
                            <resolved>Fri, 17 Sep 2010 23:38:47 +0000</resolved>
                                    <version>0.4</version>
                                    <fixVersion>0.5</fixVersion>
                                    <component>JavaScript - Compiler</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12904872" author="jordo" created="Wed, 1 Sep 2010 02:04:11 +0000"  >&lt;p&gt;Do we even need to call encodeURIComponent in thrift.js? &lt;br/&gt;
From what I understand, encodeURIComponent is primarily for ensuring one thing - That key value pairs encoded in urls don&apos;t get messed up by user supplied text.&lt;br/&gt;
Since this is sent over post, in json format, it shouldn&apos;t matter right? &lt;br/&gt;
Can&apos;t we just skip the uriEncoding step? &lt;/p&gt;</comment>
                            <comment id="12904905" author="jordo" created="Wed, 1 Sep 2010 05:02:06 +0000"  >&lt;p&gt;I just tried removing it and everything works GREAT so far (that I have tested) except for quotes inside of a string. &lt;/p&gt;

&lt;p&gt;In fact, the only reason why this was working at all was because you were using encodeUriComponent in javascript which escaped the quotes into %22. &lt;br/&gt;
The json spec says that Strings should be escaped with a backslash. So in the current codebase the json objects that are sent across the wire are really only loose adaptations of the objects they are intended to represent. &lt;/p&gt;

&lt;p&gt;To fix this we shouldn&apos;t use encodeURIComponent, and instead try to use properJSON (because that is actually what TJSONProtocol expects anyways)&lt;/p&gt;

&lt;p&gt;The two steps involve:&lt;br/&gt;
1. simply removing en/decodeUriComponent from thrift.js. &lt;br/&gt;
2. Escaping all of the fields that the json spec requires (as opposed to relying on encodeUriComponent to do it.)&lt;br/&gt;
3. Unescaping all of the escaped fields when deserializing.&lt;/p&gt;

&lt;p&gt;Number one is dirt simple, numbers two and three I don&apos;t really know where to begin.&lt;/p&gt;

&lt;p&gt;See the json documentation on Strings here &lt;a href=&quot;http://json.org/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://json.org/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12904964" author="jordo" created="Wed, 1 Sep 2010 07:59:12 +0000"  >&lt;p&gt;I&apos;ve attached what I think fixes it. (A simple diff) &lt;/p&gt;

&lt;p&gt;So basically, I&apos;ve concluded that when we don&apos;t call encodeURIComponent in the javascript, the TJSONProtocol does it&apos;s job (for the most part (see notes about forward slashes)) but our client does not. Our javascript clients don&apos;t speak proper json (except only by coincidence when we use encodeURIComponent). &lt;/p&gt;

&lt;p&gt;So the fix makes sure that when we write out strings it escapes important characters. &lt;br/&gt;
I didn&apos;t need to do anything on the reverse direction (reading back results) because, like I said, the server&apos;s TJSONProtocol speaks JSON properly, so when it returns strings, it properly escapes them. &lt;/p&gt;

&lt;p&gt;I didn&apos;t include the modified test case in the diff, but here is what I did to the test case (not much):&lt;br/&gt;
&lt;b&gt;Please&lt;/b&gt; note that the tab is actually a tab character, so when I post this it might just change it into a space.&lt;/p&gt;

&lt;p&gt;If someone would like to, you can also add this quickly into the test.html.&lt;/p&gt;

&lt;p&gt;  var stringTransferTestString = &apos;quote: &quot; backslash: &lt;br class=&quot;atl-forced-newline&quot; /&gt;  forwardslash-escaped: \/   &apos; +&lt;br/&gt;
	  &apos;  backspace: \b  formfeed: \f newline: \n  return: \r  tab:	 &apos; +&lt;br/&gt;
	  &apos; now-all-of-them-together: &quot;\\\/\b\n\r\t&apos; + &lt;br/&gt;
	  &apos; now-a-bunch-of-junk: !@#$%&lt;sup&gt;&amp;amp;&lt;b&gt;()(&lt;/b&gt;&amp;amp;&lt;/sup&gt;%$#{}{}&amp;lt;&amp;gt;&amp;lt;&amp;gt;&amp;lt;&apos;;&lt;br/&gt;
  document.write(&quot;client.testString() =&amp;gt; &quot;+(client.testString(stringTransferTestString) == stringTransferTestString) + &quot;&amp;lt;br&amp;gt;&quot;);&lt;/p&gt;

</comment>
                            <comment id="12904965" author="jordo" created="Wed, 1 Sep 2010 08:03:16 +0000"  >&lt;p&gt;deleting proposed fix, see later post.&lt;/p&gt;</comment>
                            <comment id="12904966" author="jordo" created="Wed, 1 Sep 2010 08:04:41 +0000"  >&lt;p&gt;I believe this to be the correct solution (except for forward slashes which I think are TJSONProtocol&apos;s problem.)&lt;/p&gt;</comment>
                            <comment id="12905195" author="roger.meier" created="Wed, 1 Sep 2010 20:13:01 +0000"  >&lt;p&gt;Hi Jordan!&lt;br/&gt;
Yes, this is a bug.&lt;br/&gt;
on wire Thrift is just UTF-8 not URL encoded&lt;/p&gt;

&lt;p&gt;I did some tests with FireFox on Debian Lenny and IE7 on Windows XP&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;THttpServer.cpp: Server side output is 
testString(&quot;Afrikaans%2C%20Alemannisch .....

instead of UTF-8
testString(&quot;Afrikaans, Alemannisch .....
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The attached patch fixes that issue.&lt;/p&gt;

&lt;p&gt;By the way...update your lib/js/ to the latest version! It contains a enhanced Unit Test based on QUnit, that&apos;s a good helper for finding bugs!&lt;/p&gt;</comment>
                            <comment id="12905215" author="jordo" created="Wed, 1 Sep 2010 20:49:40 +0000"  >&lt;p&gt;Roger, &lt;br/&gt;
I noted in one of my comments that I tried your fix and it didn&apos;t work. Please take a look at my patch. I already tried what you have posted as a patch and it doesn&apos;t work when you have nested quotes inside the text (or newlines etc.)&lt;br/&gt;
My patch deals with these by escaping them into standard json strings in accordance with www.json.org.&lt;/p&gt;

&lt;p&gt;I even made a test case to ensure that it works properly. Can you please take a look at it and integrate it into the source code?&lt;br/&gt;
Thanks.&lt;/p&gt;</comment>
                            <comment id="12905246" author="roger.meier" created="Wed, 1 Sep 2010 22:06:47 +0000"  >&lt;p&gt;yes, I see... have to integrate that with your testcode.&lt;/p&gt;</comment>
                            <comment id="12905302" author="tjake" created="Wed, 1 Sep 2010 23:14:22 +0000"  >&lt;p&gt;Hi Jordan, this looks good. I think this is the only reasonable way todo it.&lt;/p&gt;

&lt;p&gt;Let me run some tests and I&apos;ll commit.&lt;/p&gt;</comment>
                            <comment id="12906250" author="roger.meier" created="Sat, 4 Sep 2010 15:09:31 +0000"  >&lt;p&gt;It works fine for me, attached is Jordan&apos;s patch and the corresponding unittest within test.html.&lt;br/&gt;
see &lt;a href=&quot;http://www.bufferoverflow.ch:8088/test/test.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.bufferoverflow.ch:8088/test/test.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12910771" author="bryanduxbury" created="Fri, 17 Sep 2010 20:28:56 +0000"  >&lt;p&gt;Is this ready for commit?&lt;/p&gt;</comment>
                            <comment id="12910848" author="tjake" created="Fri, 17 Sep 2010 23:38:47 +0000"  >&lt;p&gt;Comitted with some minor edits.&lt;/p&gt;</comment>
                            <comment id="12910904" author="roger.meier" created="Sat, 18 Sep 2010 07:02:37 +0000"  >&lt;p&gt;thanks for committing this!&lt;/p&gt;

&lt;p&gt;could you please add the testcase provided above as well?&lt;/p&gt;

&lt;p&gt;I&apos;ve just added the Testcase as a seperate file now&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12454935/12454935_THRIFT-885_testcase_only.patch&quot; title=&quot;THRIFT-885_testcase_only.patch attached to THRIFT-885&quot;&gt;THRIFT-885_testcase_only.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;=&amp;gt; moved test case to &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-913&quot; title=&quot;Test Case for Url encoded strings + simple enhancement to lib/js/test/RunTestServer.sh&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-913&quot;&gt;&lt;del&gt;THRIFT-913&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                            <outwardlinks description="is a clone of">
                                        <issuelink>
            <issuekey id="12468510">THRIFT-813</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12453868" name="THRIFT-885_jordans_patch_and_testcase.patch" size="6142" author="roger" created="Sat, 4 Sep 2010 15:09:30 +0000"/>
                            <attachment id="12453617" name="THRIFT-885_remove_encodeURIComponent.patch" size="375" author="roger" created="Wed, 1 Sep 2010 20:13:01 +0000"/>
                            <attachment id="12454935" name="THRIFT-885_testcase_only.patch" size="2770" author="roger" created="Sat, 18 Sep 2010 07:02:37 +0000"/>
                            <attachment id="12453581" name="charEscapingFix.diff" size="2430" author="jordo" created="Wed, 1 Sep 2010 08:04:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>187025</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 10 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i16bhj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>244993</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>