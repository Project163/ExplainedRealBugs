<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 07:59:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-1094] bug in TCompactProto python readMessageEnd method and updated test cases</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-1094</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;The python implementation of TCompactProtocol has a bug in readMessageEnd, an assert on its internal state being READ_VALUE when it&apos;s actually CLEAR.  I am including a patch that is 2 lines of library code change to TCompactProtocol.py, and a few dozen lines of ./test/py/ code changes.&lt;/p&gt;

&lt;p&gt;Changes in this patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;fixed the readMessageEnd bug (2 lines)&lt;/li&gt;
	&lt;li&gt;added TCompactProto to the list of target protocols for the test suite&lt;/li&gt;
	&lt;li&gt;added a new --proto cmdline option to TestServer.py/TestClient.py to permit one of &lt;span class=&quot;error&quot;&gt;&amp;#91;accel, binary, compact&amp;#93;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;changed RunTests.py so it has a nested loop, trying each protocol with each server type&lt;/li&gt;
	&lt;li&gt;added more client/server test methods for the ThriftTest service&apos;s: testNest(), testMap(), testSet(), testList(), testEnum(), testTypedef(), testMapMap(), testMulti()&lt;/li&gt;
	&lt;li&gt;fixed a bug in testOneWay() that was being passed a float instead of an int&lt;/li&gt;
	&lt;li&gt;added new TProcessPool class to list of servers and imports
	&lt;ul&gt;
		&lt;li&gt;added extra code to shut down the individual process pool workers, to avoid leaving the server listen socket bound&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;added optional --port option to RunTests.py and TestServer.py so the port can be changed for both server &amp;amp; client from the RunTests.py cmdline&lt;/li&gt;
	&lt;li&gt;added optional argument to RunTests.py to run just a single server type, i.e. ./RunTests.py --port=9092 THttpServer&lt;/li&gt;
	&lt;li&gt;RunTests.py now prints out the exact cmdlines it executes for both server and client, to be more explicit&lt;/li&gt;
	&lt;li&gt;RunTests.py checks to make sure the server process didn&apos;t fail (via serverproc.poll() &amp;amp; serverproc.returncode test) which was a &apos;fixme&apos; note in the code&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;It takes a bit longer now for RunTests.py to execute, since it&apos;s testing 21 combinations of 3 protocols and 7 server type (with 3.5 extra seconds of shutdown time for the TProcessPool server type).  It&apos;s ~35 seconds now to run the whole suite, but gives more thorough code coverage for the tests.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12501570">THRIFT-1094</key>
            <summary>bug in TCompactProto python readMessageEnd method and updated test cases</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="willp">Will Pierce</assignee>
                                    <reporter username="willp">Will Pierce</reporter>
                        <labels>
                    </labels>
                <created>Wed, 16 Mar 2011 12:01:56 +0000</created>
                <updated>Mon, 21 Mar 2011 18:39:21 +0000</updated>
                            <resolved>Mon, 21 Mar 2011 17:38:52 +0000</resolved>
                                    <version>0.6</version>
                                    <fixVersion>0.7</fixVersion>
                                    <component>Python - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13007439" author="willp" created="Wed, 16 Mar 2011 12:04:07 +0000"  >&lt;p&gt;patch attached. touches 2 lines in the actual library code, and adds a lot to the test/py/ test suite to expand coverage&lt;/p&gt;</comment>
                            <comment id="13007443" author="willp" created="Wed, 16 Mar 2011 12:16:48 +0000"  >&lt;p&gt;looks like this readMessageEnd bug has been spotted before: &lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/thrift-user/201010.mbox/%3C1286890923.5086.2.camel@ubuntu.localdomain%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://mail-archives.apache.org/mod_mbox/thrift-user/201010.mbox/%3C1286890923.5086.2.camel@ubuntu.localdomain%3E&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13008675" author="bryanduxbury" created="Fri, 18 Mar 2011 23:25:13 +0000"  >&lt;p&gt;I applied this patch and tried to run the tests and got:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;FAILED (errors=18)
Traceback (most recent call last):
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;./RunClientServer.py&quot;&lt;/span&gt;, line 97, in &amp;lt;module&amp;gt;
    runTest(try_server, try_proto, options.port)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;./RunClientServer.py&quot;&lt;/span&gt;, line 79, in runTest
    raise Exception(&lt;span class=&quot;code-quote&quot;&gt;&quot;subprocess %s failed, args: %s&quot;&lt;/span&gt; % (server_class, &lt;span class=&quot;code-quote&quot;&gt;&apos; &apos;&lt;/span&gt;.join(argv)))
Exception: subprocess TSimpleServer failed, args: /usr/bin/python ./TestClient.py --proto=accel --port=9090
FAIL: RunClientServer.py
===================
1 of 4 tests failed
===================
make[1]: *** [check-TESTS] Error 1
make: *** [check-am] Error 2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13008759" author="willp" created="Sat, 19 Mar 2011 11:32:34 +0000"  >&lt;p&gt;I think I know what the problem is.   I only tested using python2.7... My bad.  I&apos;ll have to be more thorough in future patches.&lt;/p&gt;

&lt;p&gt;Using python2.4 for testing, and running just the TSimpleServer test, the import for the TProcessPool line chokes, since the multiprocessing module isn&apos;t available in python2.4.&lt;/p&gt;

&lt;p&gt;I get this output (the top of the output is more helpful, as the server process&apos;s error gets buried with a lot of junk from the client and test runner):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;% python2.4 ./RunClientServer.py 2&amp;gt;&amp;amp;1 | head -20
Traceback (most recent call last):
  File &quot;./TestServer.py&quot;, line 33, in ?
    from thrift.server import TServer, TNonblockingServer, THttpServer, TProcessPoolServer
  File &quot;../../lib/py/build/lib.linux-x86_64-2.7/thrift/server/TProcessPoolServer.py&quot;, line 22, in ?
    from multiprocessing import  Process, Value, Condition, reduction
ImportError: No module named multiprocessing
testByte (__main__.AcceleratedBinaryTest) ... ERROR
testDouble (__main__.AcceleratedBinaryTest) ... ERROR
testEnum (__main__.AcceleratedBinaryTest) ... ERROR
testException (__main__.AcceleratedBinaryTest) ... ERROR
testI32 (__main__.AcceleratedBinaryTest) ... ERROR
testI64 (__main__.AcceleratedBinaryTest) ... ERROR
testList (__main__.AcceleratedBinaryTest) ... ERROR
testMap (__main__.AcceleratedBinaryTest) ... ERROR
testMapMap (__main__.AcceleratedBinaryTest) ... ERROR
testMulti (__main__.AcceleratedBinaryTest) ... ERROR
testNest (__main__.AcceleratedBinaryTest) ... ERROR
testOneway (__main__.AcceleratedBinaryTest) ... ERROR
testOnewayThenNormal (__main__.AcceleratedBinaryTest) ... ERROR
testSet (__main__.AcceleratedBinaryTest) ... ERROR
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The root problem is that the TProcessPool server uses a module unavailable in python2.4.  But there&apos;s no reason that should break the tests.  It should generate a warning maybe, in the &apos;except&apos; clause, and skip testing that type of server.&lt;/p&gt;

&lt;p&gt;I&apos;ll update the patch so that the RunClientServer doesn&apos;t do the TProcessPoolServer testing if the multiprocessing module is unavailable, and update the &lt;tt&gt;import TProcessPoolServer&lt;/tt&gt; line in TestServer.py so it is done dynamically, not unconditionally.&lt;/p&gt;

&lt;p&gt;I&apos;ll upload a corrected patch shortly.&lt;/p&gt;</comment>
                            <comment id="13008762" author="willp" created="Sat, 19 Mar 2011 11:58:38 +0000"  >&lt;p&gt;v2 of the patch attached.&lt;/p&gt;

&lt;p&gt;This version of the patch skips testing of the TProcessPoolServer when the RunClientServer.py is run and the multiprocessing module fails to import.  So the rest of the tests will be done under python2.4, but the TProcessPoolServer tests will be skipped on python2.4.&lt;/p&gt;

&lt;p&gt;A warning message is printed to stdout if the user manually specifies the TProcessPoolServer type on the RunClientServer.py command line:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;% switchpython 2.4 # switches hardlink in /usr/bin for me
% ./RunClientServer.py TProcessPoolServer
Warning: the multiprocessing module is unavailable. Skipping tests for TProcessPoolServer
Unavailable server type &quot;TProcessPoolServer&quot;, please choose one of: [&apos;TSimpleServer&apos;, &apos;TThreadedServer&apos;, &apos;TThreadPoolServer&apos;, &apos;TForkingServer&apos;, &apos;TNonblockingServer&apos;, &apos;THttpServer&apos;]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="13009230" author="bryanduxbury" created="Mon, 21 Mar 2011 17:38:52 +0000"  >&lt;p&gt;The latest patch&apos;s tests all pass. I just committed this. Thanks for the patch, Will!&lt;/p&gt;</comment>
                            <comment id="13009271" author="willp" created="Mon, 21 Mar 2011 18:39:21 +0000"  >&lt;p&gt;Teerific! Thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12473779" name="THRIFT-1094.python_compactproto_fix_and_tests.patch" size="15421" author="willp" created="Wed, 16 Mar 2011 12:04:07 +0000"/>
                            <attachment id="12474070" name="THRIFT-1094.python_compactproto_fix_and_tests_v2.patch" size="15819" author="willp" created="Sat, 19 Mar 2011 11:58:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>187194</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 36 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i16d3j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>245254</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>