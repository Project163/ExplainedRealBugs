<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:14:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-2696] Unable to stop socket server while there are idle clients</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-2696</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;When TSimpleServer created using TServerSocketImpl and there are idle clients (connected, but not sending anything), it is impossible to stop server.&lt;br/&gt;
After executing TSimpleServer.stop server will not stop until client is disconnected or does not send anything.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12740225">THRIFT-2696</key>
            <summary>Unable to stop socket server while there are idle clients</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jensg">Jens Geyer</assignee>
                                    <reporter username="SeverD">Severian Duchenko</reporter>
                        <labels>
                    </labels>
                <created>Tue, 9 Sep 2014 20:14:02 +0000</created>
                <updated>Wed, 5 Nov 2014 04:49:19 +0000</updated>
                            <resolved>Wed, 17 Sep 2014 19:59:04 +0000</resolved>
                                    <version>0.9</version>
                                    <fixVersion>0.9.2</fixVersion>
                                    <component>Delphi - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14127491" author="severd" created="Tue, 9 Sep 2014 20:24:32 +0000"  >&lt;p&gt;Patch will fix problem.&lt;/p&gt;</comment>
                            <comment id="14130538" author="jensg" created="Thu, 11 Sep 2014 19:11:43 +0000"  >&lt;p&gt;Thanks for catching this problem, I could reproduce it easily. &lt;/p&gt;

&lt;p&gt;However, the patch cures the symptom, not the real problem. I&apos;m putting together a patch to honour the timeout values that can be set but actually are not used at all. Your input helped a great deal fixing this.&lt;/p&gt;</comment>
                            <comment id="14130548" author="jensg" created="Thu, 11 Sep 2014 19:17:16 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                            <comment id="14130832" author="hudson" created="Thu, 11 Sep 2014 22:51:24 +0000"  >&lt;p&gt;SUCCESS: Integrated in Thrift #1277 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/1277/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/1277/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2696&quot; title=&quot;Unable to stop socket server while there are idle clients&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2696&quot;&gt;&lt;del&gt;THRIFT-2696&lt;/del&gt;&lt;/a&gt; Unable to stop socket server while there are idle clients (jensg: rev 684ccab5e72cddacda7a1fc2c1a80f23e1bc3163)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;lib/delphi/test/TestServer.pas&lt;/li&gt;
	&lt;li&gt;lib/delphi/src/Thrift.Transport.pas&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14130848" author="hudson" created="Thu, 11 Sep 2014 23:15:09 +0000"  >&lt;p&gt;FAILURE: Integrated in Thrift-Test #24 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift-Test/24/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift-Test/24/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2696&quot; title=&quot;Unable to stop socket server while there are idle clients&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2696&quot;&gt;&lt;del&gt;THRIFT-2696&lt;/del&gt;&lt;/a&gt; Unable to stop socket server while there are idle clients (jensg: rev 684ccab5e72cddacda7a1fc2c1a80f23e1bc3163)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;lib/delphi/test/TestServer.pas&lt;/li&gt;
	&lt;li&gt;lib/delphi/src/Thrift.Transport.pas&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14133150" author="severd" created="Sun, 14 Sep 2014 10:16:06 +0000"  >&lt;p&gt;Jens, good day to you. Just found side effect of this fix.&lt;br/&gt;
If client do not send any data in specified timeout then connection terminates.&lt;br/&gt;
It is problem in &quot;exit(0)&quot;. Processing of TTcpSocketStreamImpl.Read method assumes that connection is closed on error codes &amp;lt;= 0.&lt;br/&gt;
I am tried to find work around to fix this problem:&lt;br/&gt;
1. change result check conditions to correctly check for 0&lt;br/&gt;
2. after WaitForData = false, additionally check for connection state. Is doesn&apos;t helped.&lt;br/&gt;
3. handle socket events (OnError, OnDisconnect) and reset connection if needed. It doesn&apos;t helped too.&lt;br/&gt;
4. use assumption: if WaitForData(5000) = false then time of its execution is &amp;gt;= 5000ms. So i surrounded WaitForData with simple elapsed time check using GetTicksCount. It helped, but it is ugly.&lt;/p&gt;

&lt;p&gt;My dev env: WinXP SP3 under VirtualBox, Delphi XE5.&lt;br/&gt;
I am using port forwarding to connect to application running in VirtualBox.&lt;/p&gt;</comment>
                            <comment id="14133153" author="jensg" created="Sun, 14 Sep 2014 10:38:17 +0000"  >&lt;p&gt;I&apos;m not sure if I understand the problem. Could you provide an &lt;a href=&quot;http://sscce.org&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;SSCCE&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="14133218" author="severd" created="Sun, 14 Sep 2014 13:45:21 +0000"  >&lt;p&gt;I have running server. Server configured with client timeout 5 seconds.&lt;br/&gt;
Client connects to server, sends message, gets response and goes to sleep.&lt;br/&gt;
After 5 seconds server terminates connection to client.&lt;/p&gt;</comment>
                            <comment id="14133318" author="jensg" created="Sun, 14 Sep 2014 18:11:55 +0000"  >&lt;p&gt;TTcpSocketStreamImpl.Read does not return an error code. it returms the bytes read. When 0, the calling code in &lt;tt&gt;TTransportImpl&lt;/tt&gt; assumes the client closed his end. &lt;tt&gt;TTransportImpl&lt;/tt&gt; itself is transport-agnostic, so changing anything here may easily lead to more side effects with other transports. &lt;/p&gt;

&lt;p&gt;With regard to the timeout, I would expect it to behave this way, otherwise I can do a simple DOS by opening the socket and never closing it. If I don&apos;t want this, leave the default timeout = wait forever. However, that leaves us with the same situation as above, so that&apos;s a problem indeed.&lt;/p&gt;

&lt;p&gt;Could you give &lt;span class=&quot;error&quot;&gt;&amp;#91;this patch|^THRIFT-2696-Unable-to-stop-socket-server-while-there_v2.patch&amp;#93;&lt;/span&gt; a try if that works for you? I tried to cover all possible scenarios now.&lt;/p&gt;</comment>
                            <comment id="14134661" author="severd" created="Mon, 15 Sep 2014 23:04:32 +0000"  >&lt;p&gt;Hi, Jens.&lt;br/&gt;
Your patch doesn&apos;t help.&lt;br/&gt;
I can solve it by debugging a lot of time and read MSDN documentation.&lt;br/&gt;
I found than Delphi&apos;s wrappers of WinSock do not follow api contract.&lt;br/&gt;
According to &lt;a href=&quot;http://msdn.microsoft.com/en-us/library/windows/desktop/ms740141(v=vs.85).aspx&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://msdn.microsoft.com/en-us/library/windows/desktop/ms740141(v=vs.85).aspx&lt;/a&gt; method &quot;select&quot; can return 0 when call is timed out, but Delphi&apos;s TCustomIpClient.Select process 0 (using method ErrorCheck) as socket error and returns False.&lt;br/&gt;
Also PeekBuf checks only for 1 byte available but not for &quot;count&quot;. &lt;br/&gt;
&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12668896/12668896_code_exmple.txt&quot; title=&quot;code_exmple.txt attached to THRIFT-2696&quot;&gt;code_exmple.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="14135832" author="jensg" created="Tue, 16 Sep 2014 17:57:05 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Your patch doesn&apos;t help.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Why? What problems do you run into and how can I reproduce them?&lt;/p&gt;

&lt;p&gt;PS: If count &amp;gt; 101, &lt;tt&gt;recv()&lt;/tt&gt; will produce a nive buffer overflow.&lt;/p&gt;</comment>
                            <comment id="14136027" author="severd" created="Tue, 16 Sep 2014 19:21:33 +0000"  >&lt;p&gt;I know about count&amp;gt;101. Code in attachment just example of correct check for Select(...) = 0.&lt;br/&gt;
To reproduce bug u should use small timeout values while invoking Select() method.&lt;br/&gt;
I catch it with timeout 200ms every time i run server. With default timeout (5000) i have cached this only few times.&lt;br/&gt;
Steps to reproduce:&lt;br/&gt;
1. Configure server with small client timeout (200ms). Start it.&lt;br/&gt;
2. Connect with client. Execute some command.&lt;br/&gt;
3. Connection terminates in few seconds by server.&lt;/p&gt;
</comment>
                            <comment id="14136065" author="jensg" created="Tue, 16 Sep 2014 19:44:21 +0000"  >&lt;p&gt;And who forces you to use such a short timeout? Note that if you set timeout = 0, the behaviour is as before: infinite timeout.&lt;/p&gt;

&lt;p&gt;Or do you mean, that in case you set a timeout, the server code should deliberately ignore your timeout setting? &lt;b&gt;confused&lt;/b&gt;&lt;/p&gt;</comment>
                            <comment id="14136138" author="severd" created="Tue, 16 Sep 2014 20:26:07 +0000"  >&lt;p&gt;I do not use short timeouts. I have save same problem with big timeouts too. But with large timeout values it is floating. Easiest way to reproduce it - use small timeout values.&lt;/p&gt;

&lt;p&gt;I do not force you to do anything about this problem. I have fixed it for myself using correct Select() and PeekBuf() calls. &lt;/p&gt;</comment>
                            <comment id="14136191" author="jensg" created="Tue, 16 Sep 2014 20:52:38 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I do not force you to do anything about this problem. I have fixed it for myself using correct Select() and PeekBuf() calls.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I will happily review any patch.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;but Delphi&apos;s TCustomIpClient.Select process 0 (using method ErrorCheck) as socket error and returns False.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;del&gt;ErrorCheck tests against SOCKET_ERROR, which is defined as -1. Could this be an version issue? I run XE here&lt;/del&gt; I now see what you mean. It is not the error check, but what happens afterwards. &lt;/p&gt;

&lt;p&gt;&lt;del&gt;Do you have a minute to talk on freenode IRC?&lt;/del&gt;&lt;/p&gt;
</comment>
                            <comment id="14136434" author="jensg" created="Tue, 16 Sep 2014 23:00:20 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;This patch|^THRIFT-2696-Unable-to-stop-socket-server-while-there_v3.patch&amp;#93;&lt;/span&gt; is an add-on to the previous one. &lt;/p&gt;

&lt;p&gt;There are two basic cases for the server:&lt;/p&gt;

&lt;p&gt; 1. the server is created using a timeout value &amp;gt; 0: in that case, the connection will be closed after the timeout elapses without sufficient data ready to be read.&lt;/p&gt;

&lt;p&gt; 2. the server  is created using a timeout value = 0: This is the compatibility and blocking case. The client has all the time in the world to send his data, the server will wait patiently - unless someone stops him, which is now possible.&lt;/p&gt;

&lt;p&gt;Note that timeout &amp;lt; 0 is illegal and is treatened as = 0 internally. &lt;/p&gt;
</comment>
                            <comment id="14136659" author="severd" created="Wed, 17 Sep 2014 01:57:05 +0000"  >&lt;p&gt;Thank you very much for your help Jens. I will apply this patch to latest stable version and will use it. &lt;br/&gt;
P.S. As little improvement it is possible to reuse buffer form Read() method in WaitForData().&lt;/p&gt;</comment>
                            <comment id="14137865" author="jensg" created="Wed, 17 Sep 2014 19:59:04 +0000"  >&lt;blockquote&gt;
&lt;p&gt;reuse buffer form Read() method in WaitForData().&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Bingo - modified accordingly &amp;amp; committed.&lt;/p&gt;</comment>
                            <comment id="14138227" author="hudson" created="Wed, 17 Sep 2014 23:52:49 +0000"  >&lt;p&gt;SUCCESS: Integrated in Thrift #1280 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/1280/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/1280/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2696&quot; title=&quot;Unable to stop socket server while there are idle clients&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2696&quot;&gt;&lt;del&gt;THRIFT-2696&lt;/del&gt;&lt;/a&gt; Unable to stop socket server while there are idle clients (jensg: rev 3e8d9272cecfb6dcfe7a03faafdba295c7d1838e)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;lib/delphi/test/TestServer.pas&lt;/li&gt;
	&lt;li&gt;lib/delphi/src/Thrift.Server.pas&lt;/li&gt;
	&lt;li&gt;lib/delphi/src/Thrift.Transport.pas&lt;/li&gt;
	&lt;li&gt;lib/delphi/src/Thrift.Transport.Pipes.pas&lt;/li&gt;
	&lt;li&gt;lib/delphi/test/TestClient.pas&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14138318" author="hudson" created="Thu, 18 Sep 2014 01:03:18 +0000"  >&lt;p&gt;FAILURE: Integrated in Thrift-Test #26 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift-Test/26/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift-Test/26/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2696&quot; title=&quot;Unable to stop socket server while there are idle clients&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2696&quot;&gt;&lt;del&gt;THRIFT-2696&lt;/del&gt;&lt;/a&gt; Unable to stop socket server while there are idle clients (jensg: rev 3e8d9272cecfb6dcfe7a03faafdba295c7d1838e)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;lib/delphi/test/TestServer.pas&lt;/li&gt;
	&lt;li&gt;lib/delphi/test/TestClient.pas&lt;/li&gt;
	&lt;li&gt;lib/delphi/src/Thrift.Server.pas&lt;/li&gt;
	&lt;li&gt;lib/delphi/src/Thrift.Transport.pas&lt;/li&gt;
	&lt;li&gt;lib/delphi/src/Thrift.Transport.Pipes.pas&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14197610" author="hudson" created="Wed, 5 Nov 2014 04:49:19 +0000"  >&lt;p&gt;SUCCESS: Integrated in Thrift #1331 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/1331/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/1331/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2696&quot; title=&quot;Unable to stop socket server while there are idle clients&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2696&quot;&gt;&lt;del&gt;THRIFT-2696&lt;/del&gt;&lt;/a&gt; Unable to stop socket server while there are idle clients (jensg: rev 684ccab5e72cddacda7a1fc2c1a80f23e1bc3163)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;lib/delphi/src/Thrift.Transport.pas&lt;/li&gt;
	&lt;li&gt;lib/delphi/test/TestServer.pas&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2696&quot; title=&quot;Unable to stop socket server while there are idle clients&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2696&quot;&gt;&lt;del&gt;THRIFT-2696&lt;/del&gt;&lt;/a&gt; Unable to stop socket server while there are idle clients (jensg: rev 3e8d9272cecfb6dcfe7a03faafdba295c7d1838e)&lt;/li&gt;
	&lt;li&gt;lib/delphi/test/TestServer.pas&lt;/li&gt;
	&lt;li&gt;lib/delphi/test/TestClient.pas&lt;/li&gt;
	&lt;li&gt;lib/delphi/src/Thrift.Transport.Pipes.pas&lt;/li&gt;
	&lt;li&gt;lib/delphi/src/Thrift.Server.pas&lt;/li&gt;
	&lt;li&gt;lib/delphi/src/Thrift.Transport.pas&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12669491" name="THRIFT-2696-Unable-to-stop-socket-server-while-there-FINAL.patch" size="15143" author="jensg" created="Wed, 17 Sep 2014 20:00:26 +0000"/>
                            <attachment id="12668137" name="THRIFT-2696-Unable-to-stop-socket-server-while-there.patch" size="9525" author="jensg" created="Thu, 11 Sep 2014 19:16:20 +0000"/>
                            <attachment id="12668896" name="code_exmple.txt" size="3465" author="SeverD" created="Mon, 15 Sep 2014 23:05:15 +0000"/>
                            <attachment id="12667473" name="patch.txt" size="348" author="SeverD" created="Tue, 9 Sep 2014 20:24:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 3 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1zum7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>