<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:24:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-3787] Node.js Connection object doesn&apos;t handle errors correctly</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-3787</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;There are a handful of operation-ordering problems in the Connection.prototype.connection_gone() method and its friends.&lt;/p&gt;

&lt;p&gt;See the pull request for more details.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12958661">THRIFT-3787</key>
            <summary>Node.js Connection object doesn&apos;t handle errors correctly</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="codesf">Randy Abernethy</assignee>
                                    <reporter username="jamesreggio">James Reggio</reporter>
                        <labels>
                    </labels>
                <created>Wed, 13 Apr 2016 23:32:39 +0000</created>
                <updated>Fri, 12 Aug 2016 01:29:49 +0000</updated>
                            <resolved>Sat, 14 May 2016 10:33:35 +0000</resolved>
                                                    <fixVersion>0.10.0</fixVersion>
                                    <component>Node.js - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15240260" author="githubbot" created="Wed, 13 Apr 2016 23:43:59 +0000"  >&lt;p&gt;GitHub user jamesreggio opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/986&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/986&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3787&quot; title=&quot;Node.js Connection object doesn&amp;#39;t handle errors correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3787&quot;&gt;&lt;del&gt;THRIFT-3787&lt;/del&gt;&lt;/a&gt; Fix Node.js Connection object error handling&lt;/p&gt;

&lt;p&gt;    The `connected` property on `Connection` instances was not accurately maintained if reconnection retries are not enabled. Line 194 was moved to Line 176 to fix this.&lt;/p&gt;

&lt;p&gt;    Furthermore, reconnection retries are not possible with secure sockets, so this commit returns early in that case, preventing long delays waiting for the `secureConnect` event which will never fire again. It&apos;s not explicitly stated in the Node.js documentation, but calling `connect()` on an instance of a `TLSSocket` will only reconnect the underlying TCP connection; it is not possible to cause the socket to re-handshake at the TLS layer.&lt;/p&gt;

&lt;p&gt;    (You can peruse the source for &lt;span class=&quot;error&quot;&gt;&amp;#91;`tls.connect`&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/nodejs/node/blob/a11d506decd2820221d6cd770990a585ca0261d5/lib/_tls_wrap.js#L964-1095&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/nodejs/node/blob/a11d506decd2820221d6cd770990a585ca0261d5/lib/_tls_wrap.js#L964-1095&lt;/a&gt;) to see that it performs many more operations than just instantiating a `TLSSocket` instance and calling `connect()` on it. This stands in contrast to an ordinary TCP `Socket` instance from the `net` module, where reconnection is possible via these means.)&lt;/p&gt;

&lt;p&gt;    Supporting reconnection for secure sockets would require a deep refactor to enable the Thrift `Connection` instance to replace its underlying socket, and I didn&apos;t feel up to the challenge today.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jamesreggio/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jamesreggio/thrift&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3787&quot; title=&quot;Node.js Connection object doesn&amp;#39;t handle errors correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3787&quot;&gt;&lt;del&gt;THRIFT-3787&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/986.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/986.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #986&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 449b1d711f91a9252b64351a71e44945e4432911&lt;br/&gt;
Author: James Reggio &amp;lt;james.reggio@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-04-13T23:33:40Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3787&quot; title=&quot;Node.js Connection object doesn&amp;#39;t handle errors correctly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3787&quot;&gt;&lt;del&gt;THRIFT-3787&lt;/del&gt;&lt;/a&gt; Fix Node.js Connection object error handling&lt;/p&gt;

&lt;p&gt;    The `connected` property on a Connection instances was not accurately&lt;br/&gt;
    maintained if reconnection retries are not enabled.&lt;/p&gt;

&lt;p&gt;    Furthermore, reconnection retries are not possible with secure sockets,&lt;br/&gt;
    so this commit returns early in that case, preventing long delays.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15240265" author="githubbot" created="Wed, 13 Apr 2016 23:45:43 +0000"  >&lt;p&gt;Github user jamesreggio commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/986#discussion_r59645180&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/986#discussion_r59645180&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/nodejs/lib/thrift/connection.js &amp;#8212;&lt;br/&gt;
    @@ -81,15 +81,7 @@ var Connection = exports.Connection = function(stream, options) {&lt;br/&gt;
       });&lt;/p&gt;

&lt;p&gt;       this.connection.addListener(&quot;error&quot;, function(err) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// Only emit the error if no-one else is listening on the connection&lt;/li&gt;
	&lt;li&gt;// or if someone is listening on us&lt;/li&gt;
	&lt;li&gt;if (self.connection.listeners(&apos;error&apos;).length === 1 ||&lt;/li&gt;
	&lt;li&gt;self.listeners(&apos;error&apos;).length &amp;gt; 0) 
{
    -      self.emit(&quot;error&quot;, err);
    -    }
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    This code doesn&apos;t make any sense; emitting `error` with no listeners is a no-op, so we might as well do it always.&lt;/p&gt;</comment>
                            <comment id="15240266" author="githubbot" created="Wed, 13 Apr 2016 23:46:26 +0000"  >&lt;p&gt;Github user jamesreggio commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/986#discussion_r59645250&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/986#discussion_r59645250&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/nodejs/lib/thrift/connection.js &amp;#8212;&lt;br/&gt;
    @@ -81,15 +81,7 @@ var Connection = exports.Connection = function(stream, options) {&lt;br/&gt;
       });&lt;/p&gt;

&lt;p&gt;       this.connection.addListener(&quot;error&quot;, function(err) {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;// Only emit the error if no-one else is listening on the connection&lt;/li&gt;
	&lt;li&gt;// or if someone is listening on us&lt;/li&gt;
	&lt;li&gt;if (self.connection.listeners(&apos;error&apos;).length === 1 ||&lt;/li&gt;
	&lt;li&gt;self.listeners(&apos;error&apos;).length &amp;gt; 0) 
{
    -      self.emit(&quot;error&quot;, err);
    -    }&lt;/li&gt;
	&lt;li&gt;// &quot;error&quot; events get turned into exceptions if they aren&apos;t listened for.  If the user handled this error&lt;/li&gt;
	&lt;li&gt;// then we should try to reconnect.&lt;/li&gt;
	&lt;li&gt;self.connection_gone();
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Per &lt;span class=&quot;error&quot;&gt;&amp;#91;Node.js documentation&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://nodejs.org/api/net.html#net_event_error_1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://nodejs.org/api/net.html#net_event_error_1&lt;/a&gt;), `error` is always followed by `close`, so there&apos;s no need to call `connection_gone()` twice.&lt;/p&gt;</comment>
                            <comment id="15240267" author="githubbot" created="Wed, 13 Apr 2016 23:46:37 +0000"  >&lt;p&gt;Github user jamesreggio commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/986#discussion_r59645268&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/986#discussion_r59645268&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/nodejs/lib/thrift/connection.js &amp;#8212;&lt;br/&gt;
    @@ -181,19 +173,18 @@ Connection.prototype.write = function(data) {&lt;/p&gt;

&lt;p&gt;     Connection.prototype.connection_gone = function () {&lt;br/&gt;
       var self = this;&lt;br/&gt;
    +  this.connected = false;&lt;/p&gt;

&lt;p&gt;       // If a retry is already in progress, just let that happen&lt;br/&gt;
       if (this.retry_timer) &lt;/p&gt;
{
         return;
       }
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (!this.max_attempts) {&lt;br/&gt;
    +  // We cannot reconnect a secure socket.&lt;br/&gt;
    +  if (!this.max_attempts || this.ssl) 
{
         self.emit(&quot;close&quot;);
         return;
       }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;this.connected = false;&lt;/li&gt;
	&lt;li&gt;this.ready = false;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    `ready` was unused.&lt;/p&gt;</comment>
                            <comment id="15240268" author="githubbot" created="Wed, 13 Apr 2016 23:47:06 +0000"  >&lt;p&gt;Github user jamesreggio commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/986#discussion_r59645316&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/986#discussion_r59645316&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/nodejs/lib/thrift/connection.js &amp;#8212;&lt;br/&gt;
    @@ -181,19 +173,18 @@ Connection.prototype.write = function(data) {&lt;/p&gt;

&lt;p&gt;     Connection.prototype.connection_gone = function () {&lt;br/&gt;
       var self = this;&lt;br/&gt;
    +  this.connected = false;&lt;/p&gt;

&lt;p&gt;       // If a retry is already in progress, just let that happen&lt;br/&gt;
       if (this.retry_timer) &lt;/p&gt;
{
         return;
       }
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if (!this.max_attempts) {&lt;br/&gt;
    +  // We cannot reconnect a secure socket.&lt;br/&gt;
    +  if (!this.max_attempts || this.ssl) 
{
         self.emit(&quot;close&quot;);
         return;
       }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;this.connected = false;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Prior to this change, this would not be run if `this.max_attempts` was unset.&lt;/p&gt;</comment>
                            <comment id="15240270" author="githubbot" created="Wed, 13 Apr 2016 23:48:06 +0000"  >&lt;p&gt;Github user jamesreggio commented on the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/986#issuecomment-209693707&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/986#issuecomment-209693707&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Somebody please kick Jenkins &#8212; it&apos;s repo instance is in a bad state.&lt;/p&gt;</comment>
                            <comment id="15268888" author="jamesreggio" created="Tue, 3 May 2016 15:29:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=codesf&quot; class=&quot;user-hover&quot; rel=&quot;codesf&quot;&gt;codesf&lt;/a&gt;, could you take a look?&lt;/p&gt;</comment>
                            <comment id="15273565" author="codesf" created="Fri, 6 May 2016 02:58:24 +0000"  >&lt;p&gt;Hey James,&lt;/p&gt;

&lt;p&gt;Regarding this particular hunk, from the Node docs:&lt;/p&gt;

&lt;p&gt;&quot;For all EventEmitter objects, if an &apos;error&apos; event handler is not provided, the error will be thrown, causing the Node.js process to report an unhandled exception and crash unless either: The domain module is used appropriately or a handler has been registered for the process.on(&apos;uncaughtException&apos;) event.&quot;&lt;/p&gt;

&lt;p&gt;So while this code predates me I think it was trying to protect user code from spurious exceptions. Unless you have a different view I&apos;d rather leave this hunk in place (until we get your deep refactor!). &lt;/p&gt;

&lt;p&gt;The other changes look good (particularly the ssl test below). Let me know if you want to commit the other hunks. &lt;/p&gt;

&lt;p&gt;-Randy &lt;/p&gt;</comment>
                            <comment id="15276534" author="jamesreggio" created="Mon, 9 May 2016 15:48:15 +0000"  >&lt;p&gt;Oh interesting! I was not aware of that behavior. Thanks for pointing it out.&lt;/p&gt;

&lt;p&gt;The code still seems a bit odd, particularly in the sense that the number of &apos;error&apos; event listeners on the underlying connection should always be one, since the connection is a private object, and we attach precisely one listener.&lt;/p&gt;

&lt;p&gt;That said, if this code generates exceptions/side-effects, I&apos;ll leave it alone. Definitely don&apos;t want to unintentionally change that behavior. I&apos;ll push an update to the branch and ping you.&lt;/p&gt;</comment>
                            <comment id="15276555" author="jamesreggio" created="Mon, 9 May 2016 16:07:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=codesf&quot; class=&quot;user-hover&quot; rel=&quot;codesf&quot;&gt;codesf&lt;/a&gt;, I reverted the hunk around the &apos;error&apos; event.&lt;/p&gt;

&lt;p&gt;Minor request: when you commit patches, could you include the &apos;--author &quot;james.reggio@gmail.com&quot;&apos; flag to maintain attribution to the original contributor? If you look at the project commit history, you&apos;ll see other maintainers adopting this practice (the little picture-in-picture avatar indicates this behavior): &lt;a href=&quot;https://github.com/apache/thrift/commits/master&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/commits/master&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15283520" author="codesf" created="Sat, 14 May 2016 10:33:36 +0000"  >&lt;p&gt;committed, thanks for the patch!&lt;/p&gt;

&lt;p&gt;missed the attrib on this one, apologies. You are in the patch field. Will get you in the author field next go.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 27 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2w3bj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>