<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:10:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-1964] &apos;Isset&apos; causes problems with C#/.NET serializers</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-1964</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;same class name &apos;Isset&apos; in user defined class will cause xmlserializer crashed. &lt;/p&gt;

&lt;p&gt;below is the sample thrift:  &lt;br/&gt;
struct A {&lt;br/&gt;
 1: string x;&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;struct B {&lt;br/&gt;
 1: string y;&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;struct C {&lt;br/&gt;
 1:A a&lt;br/&gt;
 2:B b&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;generate code and try xmlserialize instance of class C. it crashed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12646743">THRIFT-1964</key>
            <summary>&apos;Isset&apos; causes problems with C#/.NET serializers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jensg">Jens Geyer</assignee>
                                    <reporter username="xqgzh">xq.gzh</reporter>
                        <labels>
                            <label>Isset</label>
                            <label>serializers</label>
                    </labels>
                <created>Thu, 9 May 2013 02:13:25 +0000</created>
                <updated>Wed, 15 Jan 2014 02:59:52 +0000</updated>
                            <resolved>Sat, 11 Jan 2014 21:26:04 +0000</resolved>
                                    <version>0.9</version>
                    <version>0.9.1</version>
                                    <fixVersion>0.9.2</fixVersion>
                                    <component>C# - Compiler</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="28800">8h</timeoriginalestimate>
                            <timeestimate seconds="28800">8h</timeestimate>
                                        <comments>
                            <comment id="13653366" author="carlyeks" created="Thu, 9 May 2013 23:07:14 +0000"  >&lt;p&gt;Can you please provide the code that you used to reproduce this issue? These structures compile fine, so having some code that will help us debug the issue would be very beneficial.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Carl&lt;/p&gt;</comment>
                            <comment id="13654450" author="xqgzh" created="Fri, 10 May 2013 13:02:43 +0000"  >&lt;p&gt;this code will throw exception because of same name of &apos;Isset&apos;&lt;/p&gt;</comment>
                            <comment id="13654548" author="jensg" created="Fri, 10 May 2013 15:37:27 +0000"  >&lt;p&gt;I can confirm this. I get this error on the XmlSerializer instantiation: &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Types &apos;Thrift.Test.A.Isset&apos; and &apos;Thrift.Test.C.Isset&apos; both use the XML type name, &apos;Isset&apos;, from namespace &apos;&apos;. Use XML attributes to specify a unique XML name and/or namespace for the type.&lt;/p&gt;&lt;/blockquote&gt;
</comment>
                            <comment id="13654561" author="jensg" created="Fri, 10 May 2013 15:55:47 +0000"  >&lt;p&gt;I was able to solve the issue by modifying the generated code a Little:&lt;/p&gt;

&lt;p&gt;1. using System.Xml.Serialization;&lt;br/&gt;
2. remove the &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;#&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; !SILVERLIGHT  [Serializable]  #endif&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; from the &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Isset struct&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;3. added &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[XmlIgnore]&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; to &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Isset __isset;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The issets are set during deserialization, see my (modified) test case&lt;/p&gt;</comment>
                            <comment id="13654582" author="jensg" created="Fri, 10 May 2013 16:31:30 +0000"  >&lt;p&gt;&lt;del&gt;I&apos;m about to prepare a patch ...&lt;/del&gt; here it is. &lt;/p&gt;

&lt;p&gt;The issets are now ignored in all serialization scenarios, they are restored correctly during deserialization. Tested with C# 2010:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;on Win8 (the XmlSerializer testcase above) using -gen csharp with no flags&lt;/li&gt;
	&lt;li&gt;on WinPhone7 (SILVERLIGHT defined) using -gen csharp:serial,asyncctp&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="13654608" author="carlyeks" created="Fri, 10 May 2013 17:05:51 +0000"  >&lt;p&gt;Looks like the Serializable was added for WCF support; probably worth making sure that WCF generation still works.&lt;/p&gt;

&lt;p&gt;Also, where does it properly update the isset after deserialization? It seems like it will just give the default object rather than deserialize the object properly.&lt;/p&gt;</comment>
                            <comment id="13654636" author="jensg" created="Fri, 10 May 2013 17:32:02 +0000"  >&lt;blockquote&gt;&lt;p&gt;Also, where does it properly update the isset after deserialization&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Mmmh, the breakpoint was hit and the flag is set. I really appreciate any further modifications to the patch. I am not able to test all the combinations so I may indeed overlook something.&lt;/p&gt;</comment>
                            <comment id="13655267" author="xqgzh" created="Sat, 11 May 2013 13:25:25 +0000"  >&lt;p&gt;hi, Jens Geyer, your solution is very good, but i have a simple idea to solve this:  change the classname of the generated Isset,  such as Isset_&lt;/p&gt;
{structname}
&lt;p&gt;.  then we don&apos;t need change the attribute, is this ok? please see my patch &apos;fix_Isset_xmlserializer.patch&apos;&lt;/p&gt;</comment>
                            <comment id="13655270" author="xqgzh" created="Sat, 11 May 2013 13:31:04 +0000"  >&lt;p&gt;this is the test for Isset_&lt;/p&gt;
{structname}</comment>
                            <comment id="13655271" author="jensg" created="Sat, 11 May 2013 13:33:21 +0000"  >&lt;p&gt;The question is, if the issets really need to be serialized or if they basically only bloat the data? Carl, what do you think?&lt;/p&gt;</comment>
                            <comment id="13655273" author="xqgzh" created="Sat, 11 May 2013 13:46:58 +0000"  >&lt;p&gt;if we just change the name of Isset, then the _isset can be serialized, there is no name: &apos;Isset_A&apos; in the xml: &lt;br/&gt;
&quot;  &amp;lt;__isset&amp;gt;&lt;br/&gt;
    &amp;lt;a&amp;gt;true&amp;lt;/a&amp;gt;&lt;br/&gt;
    &amp;lt;b&amp;gt;true&amp;lt;/b&amp;gt;&lt;br/&gt;
  &amp;lt;/__isset&amp;gt;&lt;br/&gt;
&quot;&lt;/p&gt;</comment>
                            <comment id="13655276" author="jensg" created="Sat, 11 May 2013 13:59:29 +0000"  >&lt;p&gt;If &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;C&amp;gt;
  &amp;lt;A&amp;gt;
    &amp;lt;Message&amp;gt;test&amp;lt;/Message&amp;gt;
  &amp;lt;/A&amp;gt;
  &amp;lt;B&amp;gt;
    &amp;lt;IsBool&amp;gt;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;lt;/IsBool&amp;gt;
  &amp;lt;/B&amp;gt;
&amp;lt;/C&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;would be entirely sufficient, why would one want to write &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;lt;C&amp;gt;
  &amp;lt;A&amp;gt;
    &amp;lt;Message&amp;gt;test&amp;lt;/Message&amp;gt;
    &amp;lt;__isset&amp;gt;
      &amp;lt;a&amp;gt;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;lt;/a&amp;gt;
      &amp;lt;b&amp;gt;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;lt;/b&amp;gt;
     &amp;lt;/__isset&amp;gt;
  &amp;lt;/A&amp;gt;
  &amp;lt;B&amp;gt;
    &amp;lt;IsBool&amp;gt;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;lt;/IsBool&amp;gt;
    &amp;lt;__isset&amp;gt;
      &amp;lt;isbool&amp;gt;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&amp;lt;/isbool&amp;gt;
     &amp;lt;/__isset&amp;gt;
  &amp;lt;/B&amp;gt;
&amp;lt;/C&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13655376" author="carlyeks" created="Sat, 11 May 2013 21:55:31 +0000"  >&lt;p&gt;I&apos;ve resolved my concerns regarding the isset after deserialization. The reason this works is because the XmlSerializer calls the properties and sets them there, rather than rehydrating the values directly.&lt;/p&gt;

&lt;p&gt;I think that we want to keep the Isset being &lt;span class=&quot;error&quot;&gt;&amp;#91;Serializable&amp;#93;&lt;/span&gt; for the Binary serializer, since that actually does it by setting up the object the same way that it was before.&lt;/p&gt;

&lt;p&gt;I&apos;ve attached a new patch that includes that change.&lt;/p&gt;

&lt;p&gt;I haven&apos;t been able to test WCF yet because I&apos;m having some issues running WCF against Mono; I&apos;ll test when I have a Windows machine.&lt;/p&gt;</comment>
                            <comment id="13655596" author="jensg" created="Sun, 12 May 2013 17:49:59 +0000"  >&lt;p&gt;Great. I&apos;ll have a look at it tomorrow.&lt;/p&gt;</comment>
                            <comment id="13656392" author="jensg" created="Mon, 13 May 2013 21:18:18 +0000"  >&lt;p&gt;I have to admit that&apos;s more tricky than I thought. I extended the test case and added an optional field that is NOT set. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;namespace csharp Thrift.Test

struct A
{
  1: string message
  2: optional i32 value_not_set
}

struct B {
  1: bool isBool
  2: string message
  3: A a
}

struct C
{
  1:  A a
  2:  B b
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Next, I added a second case where the data are serialized using the DataContractJsonSerializer, which also seems to use direct access instead of prop setters. Now, using Carls patch, I get the following results:&lt;/p&gt;


&lt;p&gt;(1) Generated with &lt;b&gt;csharp&lt;/b&gt; only, JSON succeeds but the XML case fails, because the isset is true after deserializing - the value from the &quot;not set&quot; field gets of course serialized and deserialized exactly as any other valid value, since the XmlSerializer does not care about our isset flag and just takes whatever value is there.&lt;/p&gt;

&lt;p&gt;(2) Generated with &lt;b&gt;csharp:nullable&lt;/b&gt;, both JSON and XML succeed. The JSON uses the &quot;&amp;lt;type&amp;gt;k__BackingField&quot; names in that case, but that&apos;s ok here.&lt;/p&gt;

&lt;p&gt;(3) Generated with &lt;b&gt;csharp:serial&lt;/b&gt;, both JSON and XML fail, for the same reason as XML fails at (1).&lt;/p&gt;

&lt;p&gt;(4) Generated with &lt;b&gt;csharp:serial,nullable&lt;/b&gt;, both JSON and XML succeed and use the proper names.&lt;/p&gt;

&lt;p&gt;I have not tested WCF, but I add the modified test case.&lt;/p&gt;


</comment>
                            <comment id="13667969" author="jensg" created="Mon, 27 May 2013 21:36:54 +0000"  >&lt;p&gt;Carl, were you able to do the WCF test?&lt;/p&gt;</comment>
                            <comment id="13674201" author="carlyeks" created="Tue, 4 Jun 2013 09:11:33 +0000"  >&lt;p&gt;I haven&apos;t been able to get my WCF tests working; I&apos;m not really sure what the goal of the WCF support was, so it makes it more difficult to add that test now.&lt;/p&gt;

&lt;p&gt;Did we come to a conclusion on how to fix this issue?&lt;/p&gt;</comment>
                            <comment id="13675207" author="jensg" created="Tue, 4 Jun 2013 20:35:25 +0000"  >&lt;p&gt;Not quite, unfortunately, as none of the patches handles unset optionals correctly. I would expect at least the serial-cases (3) and (4) working properly for all environments including WCF. I think we indeed need to serialize the isset flags plus some &lt;a href=&quot;http://msdn.microsoft.com/en-us/library/86d80276(v=vs.85).aspx&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Custom Serialization&lt;/a&gt; magic. If you don&apos;t have a better idea, I will give it a try.&lt;/p&gt;</comment>
                            <comment id="13677079" author="xqgzh" created="Thu, 6 Jun 2013 15:02:11 +0000"  >&lt;p&gt;change the name of &apos;Isset&apos; to &apos;ClassNameIssert&apos;, it&apos;s just a little change, because there&apos;s only one reference to this typename inside the class. please check fix_Isset_xmlserializer.patch&lt;/p&gt;</comment>
                            <comment id="13677430" author="jensg" created="Thu, 6 Jun 2013 19:58:50 +0000"  >&lt;p&gt;Have you tested that?&lt;/p&gt;</comment>
                            <comment id="13678883" author="jensg" created="Sat, 8 Jun 2013 23:03:52 +0000"  >&lt;blockquote&gt;
&lt;p&gt;change the name of &apos;Isset&apos; to &apos;ClassNameIssert&apos;, it&apos;s just a little change, because there&apos;s only one reference to this typename inside the class. please check fix_Isset_xmlserializer.patch&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xqgzh&quot; class=&quot;user-hover&quot; rel=&quot;xqgzh&quot;&gt;xqgzh&lt;/a&gt;&lt;br/&gt;
Ok, so I tested it again, but it fails too in the &quot;unset optional&quot; case, similar to the other patches that we have - the isset flag is true after deserializing, but should be false. Mmmh.&lt;/p&gt;</comment>
                            <comment id="13679058" author="carlyeks" created="Sun, 9 Jun 2013 13:56:23 +0000"  >&lt;p&gt;Adding a new patch. This uses the custom serializer to control whether each of the values gets serialized.&lt;/p&gt;</comment>
                            <comment id="13690706" author="jensg" created="Fri, 21 Jun 2013 20:55:10 +0000"  >&lt;p&gt;I have not forgotten this one, but the unset optional case still fails. Did you try the &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12621419/12621419_modified-testcase.zip&quot; title=&quot;modified-testcase.zip attached to THRIFT-1964&quot;&gt;testcase&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; ?&lt;/p&gt;</comment>
                            <comment id="13862075" author="jensg" created="Sat, 4 Jan 2014 00:26:57 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xqgzh&quot; class=&quot;user-hover&quot; rel=&quot;xqgzh&quot;&gt;xqgzh&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=carlyeks&quot; class=&quot;user-hover&quot; rel=&quot;carlyeks&quot;&gt;carlyeks&lt;/a&gt;,&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;change the name of &apos;Isset&apos; to &apos;ClassNameIssert&apos;, it&apos;s just a little change, because there&apos;s only one reference to this typename inside the class. please check fix_Isset_xmlserializer.patch&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;A better (compatible) approach could be one of these&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[XmlType(Namespace = &lt;span class=&quot;code-quote&quot;&gt;&quot;http:&lt;span class=&quot;code-comment&quot;&gt;//tempuri.org/Thrift.Test.A&quot;&lt;/span&gt;)]  
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// or
&lt;/span&gt;[XmlType(&lt;span class=&quot;code-quote&quot;&gt;&quot;Thrift_Test_A_Isset&quot;&lt;/span&gt;)]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but neither would solve the unset optionals issue. I have tried some things and found, that the various serialization concepts used in C#/.NET are a really PITA to deal with, because they overlap in some details and differ completely in other. &lt;/p&gt;


&lt;h3&gt;&lt;a name=&quot;System.Xml.Serialization.XmlSerializer&quot;&gt;&lt;/a&gt;System.Xml.Serialization.XmlSerializer &lt;/h3&gt;

&lt;p&gt;The best way to deal with this flavour is to produce XML like the following (no nullables here):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;?xml version=&lt;span class=&quot;code-quote&quot;&gt;&quot;1.0&quot;&lt;/span&gt;?&amp;gt;&lt;/span&gt;
&amp;lt;C &lt;span class=&quot;code-keyword&quot;&gt;xmlns:xsi&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&lt;/span&gt; 
   &lt;span class=&quot;code-keyword&quot;&gt;xmlns:xsd&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&quot;http://www.w3.org/2001/XMLSchema&quot;&lt;/span&gt;&amp;gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;A&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;Message&amp;gt;&lt;/span&gt;test&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/Message&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;Zero&amp;gt;&lt;/span&gt;0&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/Zero&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/A&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;B&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;IsBool&amp;gt;&lt;/span&gt;true&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/IsBool&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;Message&amp;gt;&lt;/span&gt;test2&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/Message&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;A&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;Message&amp;gt;&lt;/span&gt;test3&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/Message&amp;gt;&lt;/span&gt;
      &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;Zero&amp;gt;&lt;/span&gt;0&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/Zero&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/A&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/B&amp;gt;&lt;/span&gt;
&lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/C&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The &amp;lt;Value_not_set&amp;gt; tag is omitted, because this value is not set. Thus, the property is not touched during deserialization and so is the &lt;tt&gt;isset&lt;/tt&gt; flag, which is exactly what we want. To achieve this, we need two things: (1) the &lt;tt&gt;XmlIgnore&lt;/tt&gt; flag at the &lt;tt&gt;isset&lt;/tt&gt; member variable, and (2) a bunch of &lt;a href=&quot;http://msdn.microsoft.com/en-us/library/53b8022e(vs.71).aspx&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ShouldSerialize*() methods&lt;/a&gt; telling the serializer whether or not an optional field is to be serialized:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; bool ShouldSerializeMessage()
{
  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; __isset.message;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;h3&gt;&lt;a name=&quot;DataContractJsonSerializerandrelatedserializerclasses&quot;&gt;&lt;/a&gt;DataContractJsonSerializer and related serializer classes&lt;/h3&gt;

&lt;p&gt;Unfortunately, the &lt;tt&gt;ShouldSerialize*()&lt;/tt&gt; approach does not work here, so we have to find another way. The single biggest issue with unset optionals is, that even if the &lt;tt&gt;isset&lt;/tt&gt; flags are serialized, they are read earlier, before all the data members. That problem can be solved by means of the &lt;tt&gt;DataMember(Order = &amp;lt;number&amp;gt;)&lt;/tt&gt; attribute as &lt;a href=&quot;http://msdn.microsoft.com/en-us/library/ms729813(v=vs.110).aspx&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;outlined over here&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;After these changes we get some JSON as follows:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;{
   &lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;:{
      &lt;span class=&quot;code-quote&quot;&gt;&quot;Message&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;Value_not_set&quot;&lt;/span&gt;:0,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;Zero&quot;&lt;/span&gt;:0,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;__isset&quot;&lt;/span&gt;:{ &lt;span class=&quot;code-quote&quot;&gt;&quot;message&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;value_not_set&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;zero&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; }
   },
   &lt;span class=&quot;code-quote&quot;&gt;&quot;B&quot;&lt;/span&gt;:{
      &lt;span class=&quot;code-quote&quot;&gt;&quot;A&quot;&lt;/span&gt;:{
         &lt;span class=&quot;code-quote&quot;&gt;&quot;Message&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;test3&quot;&lt;/span&gt;,
         &lt;span class=&quot;code-quote&quot;&gt;&quot;Value_not_set&quot;&lt;/span&gt;:0,
         &lt;span class=&quot;code-quote&quot;&gt;&quot;Zero&quot;&lt;/span&gt;:0,
         &lt;span class=&quot;code-quote&quot;&gt;&quot;__isset&quot;&lt;/span&gt;:{ &lt;span class=&quot;code-quote&quot;&gt;&quot;message&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;value_not_set&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;zero&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; }
      },
      &lt;span class=&quot;code-quote&quot;&gt;&quot;IsBool&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;Message&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;test2&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;__isset&quot;&lt;/span&gt;:{
         &lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;,
         &lt;span class=&quot;code-quote&quot;&gt;&quot;isBool&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;,
         &lt;span class=&quot;code-quote&quot;&gt;&quot;message&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
      }
   },
   &lt;span class=&quot;code-quote&quot;&gt;&quot;__isset&quot;&lt;/span&gt;:{ &lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which does not follow the same structure as the XML above, but does what we want.&lt;/p&gt;

&lt;h3&gt;&lt;a name=&quot;Tests&quot;&gt;&lt;/a&gt;Tests &lt;/h3&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;sucessfully tested with C# 2010 for Desktop and for Windows Phone 7.x&lt;/li&gt;
	&lt;li&gt;WCF and Mono not yet tested&lt;/li&gt;
&lt;/ul&gt;


&lt;h3&gt;&lt;a name=&quot;Files&quot;&gt;&lt;/a&gt;Files&lt;/h3&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12621419/12621419_modified-testcase.zip&quot; title=&quot;modified-testcase.zip attached to THRIFT-1964&quot;&gt;modified-testcase.zip&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12622512/12622512_THRIFT-1964-serializer-vs-isset-v2.patch&quot; title=&quot;THRIFT-1964-serializer-vs-isset-v2.patch attached to THRIFT-1964&quot;&gt;THRIFT-1964-serializer-vs-isset-v2.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; (was: &lt;del&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;^THRIFT-1964-serializer-vs-isset.patch&amp;#93;&lt;/span&gt;&lt;/del&gt;)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;What do you think?&lt;/p&gt;</comment>
                            <comment id="13868856" author="jensg" created="Sat, 11 Jan 2014 19:14:23 +0000"  >&lt;p&gt;Tested with Mono, found minor problem without the &quot;serialize&quot; switch, updated patch follows.&lt;/p&gt;

&lt;p&gt;Noteworthy is the fact, that &lt;a href=&quot;https://bugzilla.xamarin.com/show_bug.cgi?id=1852&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ShouldSerialize*()-Pattern&lt;/a&gt; seem not supported with older mono versions. In that case, the isset-problem will raise its ugly head again, but other than that there is no runtime error whatsoever - the ShouldSerialize*() methods simply aren&apos;t called then. &lt;/p&gt;</comment>
                            <comment id="13868880" author="jensg" created="Sat, 11 Jan 2014 21:26:04 +0000"  >&lt;p&gt;Tests successful, committed.&lt;/p&gt;</comment>
                            <comment id="13868892" author="hudson" created="Sat, 11 Jan 2014 22:21:34 +0000"  >&lt;p&gt;SUCCESS: Integrated in Thrift #994 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/994/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/994/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1964&quot; title=&quot;&amp;#39;Isset&amp;#39; causes problems with C#/.NET serializers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1964&quot;&gt;&lt;del&gt;THRIFT-1964&lt;/del&gt;&lt;/a&gt; &apos;Isset&apos; causes problems with C#/.NET serializers (jensg: rev c0c889b9dd460c8ca33a4d84eb2ac32c6a73bab7)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;compiler/cpp/src/generate/t_csharp_generator.cc&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12559665">THRIFT-1623</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12582801" name="1964-v2.patch" size="1616" author="carlyeks" created="Sat, 11 May 2013 21:55:35 +0000"/>
                            <attachment id="12586952" name="1964.patch" size="3813" author="carlyeks" created="Sun, 9 Jun 2013 13:56:25 +0000"/>
                            <attachment id="12582617" name="ReproduceTheIssue.zip" size="79979" author="xqgzh" created="Fri, 10 May 2013 13:02:43 +0000"/>
                            <attachment id="12622512" name="THRIFT-1964-serializer-vs-isset-v2.patch" size="4531" author="jensg" created="Sat, 11 Jan 2014 19:17:46 +0000"/>
                            <attachment id="12582615" name="a.thrift" size="144" author="xqgzh" created="Fri, 10 May 2013 13:00:38 +0000"/>
                            <attachment id="12582785" name="fix_Isset_xmlserializer.patch" size="1118" author="xqgzh" created="Sat, 11 May 2013 13:26:00 +0000"/>
                            <attachment id="12582786" name="fix_isset_problem_test.zip" size="30230" author="xqgzh" created="Sat, 11 May 2013 13:31:04 +0000"/>
                            <attachment id="12621419" name="modified-testcase.zip" size="1341" author="jensg" created="Sat, 4 Jan 2014 00:29:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>327101</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 45 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1kfs7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>327445</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>