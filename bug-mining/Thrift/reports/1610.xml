<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:24:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-3533] Can not send nil pointer as service method argument</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-3533</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;If you try to send a nil struct as an argument to a service method a panic occurs as it tries to write out all the fields in the struct, the python generated code has guarding &apos;if self.x != None:&apos; for every struct field, whereas Go only outputs the &apos;if p.IsSet()&apos; when the field is declared optional, which is not possible for argument lists.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12928854">THRIFT-3533</key>
            <summary>Can not send nil pointer as service method argument</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="zariel">Chris Bannister</assignee>
                                    <reporter username="zariel">Chris Bannister</reporter>
                        <labels>
                    </labels>
                <created>Sat, 9 Jan 2016 11:21:29 +0000</created>
                <updated>Fri, 12 Aug 2016 01:29:45 +0000</updated>
                            <resolved>Wed, 4 May 2016 20:59:58 +0000</resolved>
                                    <version>0.9.3</version>
                                    <fixVersion>0.10.0</fixVersion>
                                    <component>Go - Compiler</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15090620" author="jensg" created="Sat, 9 Jan 2016 13:37:41 +0000"  >&lt;p&gt;IIRC null pointers are not allowed by design in Thrift.&lt;/p&gt;</comment>
                            <comment id="15090984" author="zariel" created="Sun, 10 Jan 2016 11:07:58 +0000"  >&lt;p&gt;In python you can write this,&lt;/p&gt;

&lt;p&gt;service.method(None) which works fine, but in go if you do service.method(nil) it panics.&lt;/p&gt;

&lt;p&gt;Im not sure which is correct.&lt;/p&gt;

&lt;p&gt;This is the code from &lt;a href=&quot;https://github.com/apache/aurora/blob/6b768bd3dd053b776a5b713c4fd5ce95e31e666b/api/src/main/thrift/org/apache/aurora/gen/api.thrift#L1008&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/aurora/blob/6b768bd3dd053b776a5b713c4fd5ce95e31e666b/api/src/main/thrift/org/apache/aurora/gen/api.thrift#L1008&lt;/a&gt; for create_job args.Write in python,&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  def write(self, oprot):
    if oprot.__class__ == TBinaryProtocol.TBinaryProtocolAccelerated and self.thrift_spec is not None and fastbinary is not None:
      oprot.trans.write(fastbinary.encode_binary(self, (self.__class__, self.thrift_spec)))
      return
    oprot.writeStructBegin(&apos;createJob_args&apos;)
    if self.description is not None:
      oprot.writeFieldBegin(&apos;description&apos;, TType.STRUCT, 1)
      self.description.write(oprot)
      oprot.writeFieldEnd()
    if self.lock is not None:
      oprot.writeFieldBegin(&apos;lock&apos;, TType.STRUCT, 3)
      self.lock.write(oprot)
      oprot.writeFieldEnd()
    oprot.writeFieldStop()
    oprot.writeStructEnd()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and In Go it looks like this&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    func (p *AuroraSchedulerManagerCreateJobArgs) Write(oprot thrift.TProtocol) error {
	if err := oprot.WriteStructBegin(&quot;createJob_args&quot;); err != nil {
		return thrift.PrependError(fmt.Sprintf(&quot;%T write struct begin error: &quot;, p), err)
	}
	if err := p.writeField1(oprot); err != nil {
		return err
	}
	if err := p.writeField3(oprot); err != nil {
		return err
	}
	if err := oprot.WriteFieldStop(); err != nil {
		return thrift.PrependError(&quot;write field stop error: &quot;, err)
	}
	if err := oprot.WriteStructEnd(); err != nil {
		return thrift.PrependError(&quot;write struct stop error: &quot;, err)
	}
	return nil
    }

    func (p *AuroraSchedulerManagerCreateJobArgs) writeField1(oprot thrift.TProtocol) (err error) {
	if err := oprot.WriteFieldBegin(&quot;description&quot;, thrift.STRUCT, 1); err != nil {
		return thrift.PrependError(fmt.Sprintf(&quot;%T write field begin error 1:description: &quot;, p), err)
	}
	if err := p.Description.Write(oprot); err != nil {
		return thrift.PrependError(fmt.Sprintf(&quot;%T error writing struct: &quot;, p.Description), err)
	}
	if err := oprot.WriteFieldEnd(); err != nil {
		return thrift.PrependError(fmt.Sprintf(&quot;%T write field end error 1:description: &quot;, p), err)
	}
	return err
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Go will insert the &apos;x.IsSet&apos; for optional fields, but args can&apos;t be optional.&lt;/p&gt;</comment>
                            <comment id="15108954" author="zariel" created="Wed, 20 Jan 2016 17:11:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jensg&quot; class=&quot;user-hover&quot; rel=&quot;jensg&quot;&gt;jensg&lt;/a&gt; can you take a look at this patch, it causes the compiler to now generate IsSet* methods for all types to avoid nil pointer panics, and returns an error if the field is required but not set.&lt;/p&gt;</comment>
                            <comment id="15109453" author="jensg" created="Wed, 20 Jan 2016 21:23:06 +0000"  >&lt;p&gt;I don&apos;t know. I understand the idea (after staring at it way too long), but the implementation feels strange. As you said, the generator now generates &lt;tt&gt;IsSet()&lt;/tt&gt; for all fields, even the required ones. It suddenly becomes clear when you start to realize, that &lt;tt&gt;IsSet()&lt;/tt&gt; really should be named &lt;tt&gt;IsThisInstanceValidAndTheMemberSet()&lt;/tt&gt; because that&apos;s what it does. But even then it is strange, because the code is still like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;func (p *AuroraSchedulerManagerCreateJobArgs) Write(oprot thrift.TProtocol) error {

  &lt;span class=&quot;code-comment&quot;&gt;// NOTE that at &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; point we may have p == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, 
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// but let&apos;s see how far we can go ...
&lt;/span&gt;
  &lt;span class=&quot;code-comment&quot;&gt;// p not used here, so we&apos;re lucky
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; err := oprot.WriteStructBegin(&lt;span class=&quot;code-quote&quot;&gt;&quot;createJob_args&quot;&lt;/span&gt;); err != nil {   
     &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; thrift.PrependError(fmt.Sprintf(&lt;span class=&quot;code-quote&quot;&gt;&quot;%T write struct begin error: &quot;&lt;/span&gt;, p), err)
  }

  &lt;span class=&quot;code-comment&quot;&gt;// This is the first place where p != nil is actually tested. 
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// Can you see it?
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; err := p.writeField1(oprot); err != nil {     
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; err
  }

  &lt;span class=&quot;code-comment&quot;&gt;// second place where p != nil is tested
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; err := p.writeField3(oprot); err != nil {    
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; err
  }

  &lt;span class=&quot;code-comment&quot;&gt;// p not used here, so we&apos;re lucky
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; err := oprot.WriteFieldStop(); err != nil {    
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; thrift.PrependError(&lt;span class=&quot;code-quote&quot;&gt;&quot;write field stop error: &quot;&lt;/span&gt;, err)
  }

  &lt;span class=&quot;code-comment&quot;&gt;// p not used here, so we&apos;re lucky
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; err := oprot.WriteStructEnd(); err != nil {     
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; thrift.PrependError(&lt;span class=&quot;code-quote&quot;&gt;&quot;write struct stop error: &quot;&lt;/span&gt;, err)
  }

  &lt;span class=&quot;code-comment&quot;&gt;// yippie, we&apos;re through! 
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; nil
    }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That just looks strange to me.&lt;/p&gt;

&lt;p&gt;@all: Any opinions form other Go&apos;ers?&lt;/p&gt;</comment>
                            <comment id="15109649" author="zariel" created="Wed, 20 Jan 2016 22:50:21 +0000"  >&lt;p&gt;Yeah that is a bit of a pain, I think that comes down to the *Args structs being written out using the same code paths as user defined structs. The internal Args struct will obviously not be nil, so this could be optimised away. This change makes most sense when you look at user defined structs, for example the &lt;tt&gt;Lock&lt;/tt&gt;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;func (p *Lock) writeField1(oprot thrift.TProtocol) (err error) {
	if p.IsSetKey() {
		if err := oprot.WriteFieldBegin(&quot;key&quot;, thrift.STRUCT, 1); err != nil {
			return thrift.PrependError(fmt.Sprintf(&quot;%T write field begin error 1:key: &quot;, p), err)
		}
		if err := p.Key.Write(oprot); err != nil {
			return thrift.PrependError(fmt.Sprintf(&quot;%T error writing struct: &quot;, p.Key), err)
		}
		if err := oprot.WriteFieldEnd(); err != nil {
			return thrift.PrependError(fmt.Sprintf(&quot;%T write field end error 1:key: &quot;, p), err)
		}
	}
	return err
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looking at the Java code this looks quite similar, except the Java compiler does not generate it for the internal Arg structs.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void write(org.apache.thrift.protocol.TProtocol oprot, Lock struct) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; org.apache.thrift.TException {
      struct.validate();

      oprot.writeStructBegin(STRUCT_DESC);
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (struct.key != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
        oprot.writeFieldBegin(KEY_FIELD_DESC);
        struct.key.write(oprot);
        oprot.writeFieldEnd();
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15111270" author="jensg" created="Thu, 21 Jan 2016 20:49:57 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Looking at the Java code this looks quite similar, except the Java compiler does not generate it for the internal Arg structs.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;As you correctly recognized on your own, this is something different and not &quot;quite similar&quot;. Exactly that test already existed before in Go, and your patch added what &quot;the Java compiler does not generate&quot;: the test whether &lt;tt&gt;struct != nil&lt;/tt&gt;.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt; I think that comes down to the *Args structs being written out using the same code paths as user defined structs.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Could have been any struct, just happened to be that one. That&apos;s not really the point here. What about this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;func (p *FooBarStruct) Write(oprot thrift.TProtocol) error {

  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; err := oprot.WriteStructBegin(&lt;span class=&quot;code-quote&quot;&gt;&quot;foobar_args&quot;&lt;/span&gt;); err != nil {   
     &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; thrift.PrependError(fmt.Sprintf(&lt;span class=&quot;code-quote&quot;&gt;&quot;%T write struct begin error: &quot;&lt;/span&gt;, p), err)
  }

  &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; p is nil there is no content to write
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;( p !== nil) {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; err := p.writeField1(oprot); err != nil {     
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; err
    }
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; err := p.writeField3(oprot); err != nil {    
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; err
    }
  }

  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; err := oprot.WriteFieldStop(); err != nil {    
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; thrift.PrependError(&lt;span class=&quot;code-quote&quot;&gt;&quot;write field stop error: &quot;&lt;/span&gt;, err)
  }
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; err := oprot.WriteStructEnd(); err != nil {     
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; thrift.PrependError(&lt;span class=&quot;code-quote&quot;&gt;&quot;write struct stop error: &quot;&lt;/span&gt;, err)
  }

  &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; nil
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That is simple, clear and everybody understands it. On top we don&apos;t need the uglyfication of the &lt;tt&gt;IsSet()&lt;/tt&gt; members. &lt;/p&gt;

&lt;p&gt;What do you think? Do I overlook something?&lt;/p&gt;

&lt;p&gt;PS: Of course, with either solution the other side will get an empty struct for every &lt;tt&gt;nil&lt;/tt&gt; pointer that is considered &quot;valid data&quot;.&lt;/p&gt;</comment>
                            <comment id="15266835" author="zariel" created="Mon, 2 May 2016 15:41:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jensg&quot; class=&quot;user-hover&quot; rel=&quot;jensg&quot;&gt;jensg&lt;/a&gt; sorry for the delay, can you take a look at the latest patch, it does what you suggest which is simplest.&lt;/p&gt;</comment>
                            <comment id="15267574" author="jensg" created="Mon, 2 May 2016 21:51:06 +0000"  >&lt;p&gt;Thanks, no prob, looking at it.&lt;/p&gt;</comment>
                            <comment id="15271420" author="jensg" created="Wed, 4 May 2016 20:59:58 +0000"  >&lt;p&gt;Committed, thank you!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12801757" name="0001-THRIFT-3533-go-check-that-the-struct-is-nil-before-w.patch" size="1435" author="zariel" created="Mon, 2 May 2016 15:40:23 +0000"/>
                            <attachment id="12783376" name="0001-go-compiler-handle-nil-fields-correctly.patch" size="5840" author="zariel" created="Wed, 20 Jan 2016 17:10:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 28 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2r2qv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>