<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:16:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-3080] C++ TNonblockingServer connection leak while accept huge number connections.</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-3080</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;while huge number connections are accepted, the send() syscall on the unix socket for the IO Thread may fail and return EAGAIN, but no one care about the failed sent fd, neither retry nor clean.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12787995">THRIFT-3080</key>
            <summary>C++ TNonblockingServer connection leak while accept huge number connections.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roger">Roger Meier</assignee>
                                    <reporter username="abadcafe">Lei FW</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Apr 2015 14:11:10 +0000</created>
                <updated>Fri, 12 May 2017 06:38:07 +0000</updated>
                            <resolved>Tue, 7 Apr 2015 20:41:01 +0000</resolved>
                                    <version>0.9.2</version>
                                    <fixVersion>0.9.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14394476" author="githubbot" created="Fri, 3 Apr 2015 14:28:32 +0000"  >&lt;p&gt;GitHub user abadcafe opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/422&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/422&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3080&quot; title=&quot;C++ TNonblockingServer connection leak while accept huge number connections.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3080&quot;&gt;&lt;del&gt;THRIFT-3080&lt;/del&gt;&lt;/a&gt;: fix connection leak of C++ Nonblocking Server while huge nu...&lt;/p&gt;

&lt;p&gt;    ...mber connections are accepted and unix socket stream fd is busy.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/ops-baidu/thrift&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ops-baidu/thrift&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3080&quot; title=&quot;C++ TNonblockingServer connection leak while accept huge number connections.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3080&quot;&gt;&lt;del&gt;THRIFT-3080&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/422.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/422.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #422&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit c5d6b9e6fb3920433914140bc94e3158ec5eecfc&lt;br/&gt;
Author: abadcafe &amp;lt;fwlei@live.com&amp;gt;&lt;br/&gt;
Date:   2015-04-03T14:23:04Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3080&quot; title=&quot;C++ TNonblockingServer connection leak while accept huge number connections.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3080&quot;&gt;&lt;del&gt;THRIFT-3080&lt;/del&gt;&lt;/a&gt;: fix connection leak of C++ Nonblocking Server while huge number connections are accepted and unix socket stream fd is busy.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="14395447" author="githubbot" created="Sat, 4 Apr 2015 01:19:50 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/422#discussion_r27765152&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/422#discussion_r27765152&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/server/TNonblockingServer.cpp &amp;#8212;&lt;br/&gt;
    @@ -1393,9 +1394,39 @@ bool TNonblockingIOThread::notify(TNonblockingServer::TConnection* conn) &lt;/p&gt;
{
         return false;
       }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;const int kSize = sizeof(conn);&lt;/li&gt;
	&lt;li&gt;if (send(fd, const_cast_sockopt(&amp;amp;conn), kSize, 0) != kSize) {&lt;/li&gt;
	&lt;li&gt;return false;&lt;br/&gt;
    +  int ret = -1;&lt;br/&gt;
    +  struct pollfd pfd = 
{fd, POLLOUT, 0}
&lt;p&gt;;&lt;br/&gt;
    +  int kSize = sizeof(conn);&lt;br/&gt;
    +  const char * pos = (const char *)const_cast_sockopt(&amp;amp;conn);&lt;br/&gt;
    +&lt;br/&gt;
    +  while (kSize &amp;gt; 0) {&lt;br/&gt;
    +    pfd.revents = 0;&lt;br/&gt;
    +    ret = poll(&amp;amp;pfd, 1, -1);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Should this be using the THRIFT_POLL and other THRIFT_ macros for portability?&lt;/p&gt;</comment>
                            <comment id="14395561" author="githubbot" created="Sat, 4 Apr 2015 05:34:52 +0000"  >&lt;p&gt;Github user abadcafe commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/422#discussion_r27766767&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/422#discussion_r27766767&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/server/TNonblockingServer.cpp &amp;#8212;&lt;br/&gt;
    @@ -1393,9 +1394,39 @@ bool TNonblockingIOThread::notify(TNonblockingServer::TConnection* conn) &lt;/p&gt;
{
         return false;
       }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;const int kSize = sizeof(conn);&lt;/li&gt;
	&lt;li&gt;if (send(fd, const_cast_sockopt(&amp;amp;conn), kSize, 0) != kSize) {&lt;/li&gt;
	&lt;li&gt;return false;&lt;br/&gt;
    +  int ret = -1;&lt;br/&gt;
    +  struct pollfd pfd = 
{fd, POLLOUT, 0}
&lt;p&gt;;&lt;br/&gt;
    +  int kSize = sizeof(conn);&lt;br/&gt;
    +  const char * pos = (const char *)const_cast_sockopt(&amp;amp;conn);&lt;br/&gt;
    +&lt;br/&gt;
    +  while (kSize &amp;gt; 0) {&lt;br/&gt;
    +    pfd.revents = 0;&lt;br/&gt;
    +    ret = poll(&amp;amp;pfd, 1, -1);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Sure.&lt;/p&gt;</comment>
                            <comment id="14395717" author="githubbot" created="Sat, 4 Apr 2015 13:12:04 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/422#discussion_r27768849&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/422#discussion_r27768849&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/server/TNonblockingServer.cpp &amp;#8212;&lt;br/&gt;
    @@ -1393,9 +1394,39 @@ bool TNonblockingIOThread::notify(TNonblockingServer::TConnection* conn) &lt;/p&gt;
{
         return false;
       }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;const int kSize = sizeof(conn);&lt;/li&gt;
	&lt;li&gt;if (send(fd, const_cast_sockopt(&amp;amp;conn), kSize, 0) != kSize) {&lt;/li&gt;
	&lt;li&gt;return false;&lt;br/&gt;
    +  int ret = -1;&lt;br/&gt;
    +  struct pollfd pfd = 
{fd, POLLOUT, 0}
&lt;p&gt;;&lt;br/&gt;
    +  int kSize = sizeof(conn);&lt;br/&gt;
    +  const char * pos = (const char *)const_cast_sockopt(&amp;amp;conn);&lt;br/&gt;
    +&lt;br/&gt;
    +  while (kSize &amp;gt; 0) {&lt;br/&gt;
    +    pfd.revents = 0;&lt;br/&gt;
    +    ret = poll(&amp;amp;pfd, 1, -1);&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    TServerSocket has a macro based implementation that is portable for reference.&lt;/p&gt;</comment>
                            <comment id="14484007" author="roger.meier" created="Tue, 7 Apr 2015 20:41:01 +0000"  >&lt;p&gt;Thanks Lei!&lt;/p&gt;

&lt;p&gt;committed&lt;br/&gt;
;-r&lt;/p&gt;</comment>
                            <comment id="14484121" author="hudson" created="Tue, 7 Apr 2015 21:41:46 +0000"  >&lt;p&gt;FAILURE: Integrated in Thrift #1495 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/1495/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/1495/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3080&quot; title=&quot;C++ TNonblockingServer connection leak while accept huge number connections.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3080&quot;&gt;&lt;del&gt;THRIFT-3080&lt;/del&gt;&lt;/a&gt;: fix connection leak of C++ Nonblocking Server while huge number connections are accepted and unix socket stream fd is busy. (roger: rev 38772c9c8d2eeb43fcf11ff2bff7729b8d76f431)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;lib/cpp/src/thrift/server/TNonblockingServer.cpp&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3080&quot; title=&quot;C++ TNonblockingServer connection leak while accept huge number connections.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3080&quot;&gt;&lt;del&gt;THRIFT-3080&lt;/del&gt;&lt;/a&gt;: use select() instead poll() for early windows compatibility. (roger: rev b5ebcd199c1b603cea652847bfc9177c60fb8e28)&lt;/li&gt;
	&lt;li&gt;lib/cpp/src/thrift/server/TNonblockingServer.cpp&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14494988" author="githubbot" created="Tue, 14 Apr 2015 21:58:59 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/422#discussion_r28375162&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/422#discussion_r28375162&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/server/TNonblockingServer.cpp &amp;#8212;&lt;br/&gt;
    @@ -1393,9 +1397,42 @@ bool TNonblockingIOThread::notify(TNonblockingServer::TConnection* conn) &lt;/p&gt;
{
         return false;
       }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;const int kSize = sizeof(conn);&lt;/li&gt;
	&lt;li&gt;if (send(fd, const_cast_sockopt(&amp;amp;conn), kSize, 0) != kSize) {&lt;/li&gt;
	&lt;li&gt;return false;&lt;br/&gt;
    +  fd_set wfds, efds;&lt;br/&gt;
    +  int ret = -1;&lt;br/&gt;
    +  int kSize = sizeof(conn);&lt;br/&gt;
    +  const char * pos = (const char *)const_cast_sockopt(&amp;amp;conn);&lt;br/&gt;
    +&lt;br/&gt;
    +  while (kSize &amp;gt; 0) {&lt;br/&gt;
    +    FD_ZERO(&amp;amp;wfds);&lt;br/&gt;
    +    FD_ZERO(&amp;amp;efds);&lt;br/&gt;
    +    FD_SET(fd, &amp;amp;wfds);&lt;br/&gt;
    +    FD_SET(fd, &amp;amp;efds);&lt;br/&gt;
    +    ret = select(fd + 1, NULL, &amp;amp;wfds, &amp;amp;efds, NULL);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Seems like a dangerous assumption that the file descriptor you are interested is +1 from the obtained file descriptor.  Did you mean to use `getNotificationRecvFD()` instead of `fd + 1` here?&lt;/p&gt;</comment>
                            <comment id="14498053" author="githubbot" created="Thu, 16 Apr 2015 13:49:07 +0000"  >&lt;p&gt;Github user abadcafe commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/422#discussion_r28510532&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/422#discussion_r28510532&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/server/TNonblockingServer.cpp &amp;#8212;&lt;br/&gt;
    @@ -1393,9 +1397,42 @@ bool TNonblockingIOThread::notify(TNonblockingServer::TConnection* conn) &lt;/p&gt;
{
         return false;
       }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;const int kSize = sizeof(conn);&lt;/li&gt;
	&lt;li&gt;if (send(fd, const_cast_sockopt(&amp;amp;conn), kSize, 0) != kSize) {&lt;/li&gt;
	&lt;li&gt;return false;&lt;br/&gt;
    +  fd_set wfds, efds;&lt;br/&gt;
    +  int ret = -1;&lt;br/&gt;
    +  int kSize = sizeof(conn);&lt;br/&gt;
    +  const char * pos = (const char *)const_cast_sockopt(&amp;amp;conn);&lt;br/&gt;
    +&lt;br/&gt;
    +  while (kSize &amp;gt; 0) {&lt;br/&gt;
    +    FD_ZERO(&amp;amp;wfds);&lt;br/&gt;
    +    FD_ZERO(&amp;amp;efds);&lt;br/&gt;
    +    FD_SET(fd, &amp;amp;wfds);&lt;br/&gt;
    +    FD_SET(fd, &amp;amp;efds);&lt;br/&gt;
    +    ret = select(fd + 1, NULL, &amp;amp;wfds, &amp;amp;efds, NULL);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    fd + 1 is select()&apos;s convention which is the highest-numbered file descriptor in any of the three sets plus 1. There is only one fd here, so just plus 1 is safe.&lt;/p&gt;</comment>
                            <comment id="14498097" author="githubbot" created="Thu, 16 Apr 2015 14:44:42 +0000"  >&lt;p&gt;Github user jeking3 commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/422#discussion_r28515512&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/422#discussion_r28515512&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/server/TNonblockingServer.cpp &amp;#8212;&lt;br/&gt;
    @@ -1393,9 +1397,42 @@ bool TNonblockingIOThread::notify(TNonblockingServer::TConnection* conn) &lt;/p&gt;
{
         return false;
       }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;const int kSize = sizeof(conn);&lt;/li&gt;
	&lt;li&gt;if (send(fd, const_cast_sockopt(&amp;amp;conn), kSize, 0) != kSize) {&lt;/li&gt;
	&lt;li&gt;return false;&lt;br/&gt;
    +  fd_set wfds, efds;&lt;br/&gt;
    +  int ret = -1;&lt;br/&gt;
    +  int kSize = sizeof(conn);&lt;br/&gt;
    +  const char * pos = (const char *)const_cast_sockopt(&amp;amp;conn);&lt;br/&gt;
    +&lt;br/&gt;
    +  while (kSize &amp;gt; 0) {&lt;br/&gt;
    +    FD_ZERO(&amp;amp;wfds);&lt;br/&gt;
    +    FD_ZERO(&amp;amp;efds);&lt;br/&gt;
    +    FD_SET(fd, &amp;amp;wfds);&lt;br/&gt;
    +    FD_SET(fd, &amp;amp;efds);&lt;br/&gt;
    +    ret = select(fd + 1, NULL, &amp;amp;wfds, &amp;amp;efds, NULL);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Fair enough, I read the first page of the manual and saw nfds and made an assumption!&lt;/p&gt;

&lt;p&gt;    Should we be using THRIFT_POLL here similar to how TSocket does so that it is &lt;span class=&quot;error&quot;&gt;&amp;#91;more&amp;#93;&lt;/span&gt; compatible cross-platform?&lt;/p&gt;</comment>
                            <comment id="14498373" author="githubbot" created="Thu, 16 Apr 2015 17:50:13 +0000"  >&lt;p&gt;Github user abadcafe commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/422#discussion_r28532945&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/422#discussion_r28532945&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: lib/cpp/src/thrift/server/TNonblockingServer.cpp &amp;#8212;&lt;br/&gt;
    @@ -1393,9 +1397,42 @@ bool TNonblockingIOThread::notify(TNonblockingServer::TConnection* conn) &lt;/p&gt;
{
         return false;
       }

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;const int kSize = sizeof(conn);&lt;/li&gt;
	&lt;li&gt;if (send(fd, const_cast_sockopt(&amp;amp;conn), kSize, 0) != kSize) {&lt;/li&gt;
	&lt;li&gt;return false;&lt;br/&gt;
    +  fd_set wfds, efds;&lt;br/&gt;
    +  int ret = -1;&lt;br/&gt;
    +  int kSize = sizeof(conn);&lt;br/&gt;
    +  const char * pos = (const char *)const_cast_sockopt(&amp;amp;conn);&lt;br/&gt;
    +&lt;br/&gt;
    +  while (kSize &amp;gt; 0) {&lt;br/&gt;
    +    FD_ZERO(&amp;amp;wfds);&lt;br/&gt;
    +    FD_ZERO(&amp;amp;efds);&lt;br/&gt;
    +    FD_SET(fd, &amp;amp;wfds);&lt;br/&gt;
    +    FD_SET(fd, &amp;amp;efds);&lt;br/&gt;
    +    ret = select(fd + 1, NULL, &amp;amp;wfds, &amp;amp;efds, NULL);
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    In early windows(&amp;lt;= XP), there is no poll() function. The implement of THRIFT_POLL in windows XP was simulated by select(). The problem is the fake poll() lacks POLL_HUP/POLL_ERR state, I am afraid it was not function completed?&lt;/p&gt;

&lt;p&gt;    On the other side, select() is common enough on every platform supported by thrift.&lt;/p&gt;</comment>
                            <comment id="14513955" author="githubbot" created="Mon, 27 Apr 2015 11:44:19 +0000"  >&lt;p&gt;Github user abadcafe closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/422&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/422&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15882093" author="githubbot" created="Fri, 24 Feb 2017 06:56:41 +0000"  >&lt;p&gt;Github user xiaosuo commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/422&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/422&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This patch may introduce a more serious problem in theory.&lt;/p&gt;

&lt;p&gt;    No standard defines writing to a socket is an atomic operation, so if writing is interleaved by other threads, the reading end will end up with an invalid connection pointer, and the following operation on connection will cause segment fault.&lt;/p&gt;

&lt;p&gt;    In order to fix the above issue, we must turn to pipe(2), which guarantees that writing data less than PIPE_BUF is atomic . And pipes are more efficient than sockets, because no skb is required to save small pointers.&lt;/p&gt;

&lt;p&gt;    BTW, if we don&apos;t set the writing end to nonblocking mode, we don&apos;t need to use select to emulate it.&lt;/p&gt;</comment>
                            <comment id="16007697" author="githubbot" created="Fri, 12 May 2017 06:34:55 +0000"  >&lt;p&gt;Github user lyhuzi commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/422&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/422&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &#20026;&#20160;&#20040;&#19981;&#29992;ul_swriteo_ms_ex2&lt;/p&gt;</comment>
                            <comment id="16007699" author="githubbot" created="Fri, 12 May 2017 06:38:07 +0000"  >&lt;p&gt;Github user lyhuzi commented on the issue:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/thrift/pull/422&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/pull/422&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    why not use ul_swriteo_ms_ex2&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 27 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i27r8f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>