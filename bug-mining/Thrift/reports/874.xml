<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:10:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-2182] segfault in regression tests (GC bug in rb_thrift_memory_buffer_write)</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-2182</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;This bug causes the regression tests to segfault on my machine.  As this is a GC bug, it may or may not be easily reproducible.&lt;/p&gt;

&lt;p&gt;The rb_thrift_memory_buffer_write function looks like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;    VALUE rb_thrift_memory_buffer_write(VALUE self, VALUE str) {
      VALUE buf = GET_BUF(self);
      str = force_binary_encoding(str);
      rb_str_buf_cat(buf, RSTRING_PTR(str), RSTRING_LEN(str));
      return Qnil;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When gcc compiles this, it optimizes away the value of str (it is no longer used after RSTRING_PTR(str) and RSTRING_LEN(str) are computed).  Later, rb_str_buf_cat invokes the GC, and the string referenced by str is collected, because there are no references to it on the stack.&lt;/p&gt;

&lt;p&gt;Some possible solutions:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Use StringValuePtr instead of RSTRING_PTR (in general RSTRING_PTR should be avoided in favor of StringValuePtr or StringValueCStr); I believe this will also fix #&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1047&quot; title=&quot;rb_thrift_memory_buffer_write treats arg as string without check, segfaults if you pass non-string&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1047&quot;&gt;&lt;del&gt;THRIFT-1047&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Use rb_str_cat instead of rb_str_buf_cat&lt;/li&gt;
	&lt;li&gt;Use RB_GC_GUARD to prevent str from getting collected&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;It appears a similar bug may exist with buffer_value in rb_thrift_memory_buffer_read_into_buffer, and possibly in any of the other 30 places that RSTRING_PTR is used.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12668319">THRIFT-2182</key>
            <summary>segfault in regression tests (GC bug in rb_thrift_memory_buffer_write)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="roger">Roger Meier</assignee>
                                    <reporter username="cout">Paul Brannan</reporter>
                        <labels>
                            <label>easyfix</label>
                            <label>patch</label>
                    </labels>
                <created>Thu, 12 Sep 2013 18:02:33 +0000</created>
                <updated>Wed, 15 Jan 2014 02:59:53 +0000</updated>
                            <resolved>Sun, 12 Jan 2014 22:30:32 +0000</resolved>
                                    <version>0.9.1</version>
                    <version>0.9.2</version>
                                    <fixVersion>0.9.2</fixVersion>
                                    <component>Ruby - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13765786" author="cout" created="Thu, 12 Sep 2013 19:14:05 +0000"  >&lt;p&gt;Looks like a similar bug exists in rb_thrift_compact_proto_write_binary and rb_thrift_union_read.  The rb_thrift_memory_buffer_read_into_buffer function looks safe.&lt;/p&gt;</comment>
                            <comment id="13765813" author="cout" created="Thu, 12 Sep 2013 19:42:08 +0000"  >&lt;p&gt;Attaching a patch for this issue.  Changed RSTRING_PTR to StringValuePtr in three places.  The tests no longer segfault and they all pass.&lt;/p&gt;</comment>
                            <comment id="13869168" author="roger.meier" created="Sun, 12 Jan 2014 22:30:32 +0000"  >&lt;p&gt;thanks Paul!&lt;br/&gt;
committed&lt;br/&gt;
;-r&lt;/p&gt;</comment>
                            <comment id="13869176" author="hudson" created="Sun, 12 Jan 2014 22:46:12 +0000"  >&lt;p&gt;FAILURE: Integrated in Thrift #999 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift/999/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift/999/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-2182&quot; title=&quot;segfault in regression tests (GC bug in rb_thrift_memory_buffer_write)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-2182&quot;&gt;&lt;del&gt;THRIFT-2182&lt;/del&gt;&lt;/a&gt; rb: segfault in regression tests (GC bug in rb_thrift_memory_buffer_write) (roger: rev 0240572c44c64c3ab1d498d32a9a1530ab91b0da)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;lib/rb/ext/compact_protocol.c&lt;/li&gt;
	&lt;li&gt;lib/rb/ext/struct.c&lt;/li&gt;
	&lt;li&gt;lib/rb/ext/memory_buffer.c&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                            <outwardlinks description="incorporates">
                                        <issuelink>
            <issuekey id="12496725">THRIFT-1047</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12602859" name="thrift-0.9.1-stringvalueptr.patch" size="1706" author="cout" created="Thu, 12 Sep 2013 19:42:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>348253</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 45 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1o1t3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>348549</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>