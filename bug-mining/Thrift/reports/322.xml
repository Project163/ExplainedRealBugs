<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 07:58:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-882] deep copy of binary fields does not copy ByteBuffer characteristics (arrayOffset, position)</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-882</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;Generated objects have a constructor which does a deep copy of an existing instance.&lt;/p&gt;

&lt;p&gt;For binary fields, the deep copy is done like that:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (other.isSetBinary_field()) {
      &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.binary_field = ByteBuffer.wrap(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[other.binary_field.limit() - other.binary_field.arrayOffset()]);
      &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.arraycopy(other.binary_field.array(), other.binary_field.arrayOffset(), binary_field.array(), 0, other.binary_field.limit() - other.binary_field.arrayOffset());
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This copies the backing array of the ByteBuffer but does not set the position correctly.&lt;/p&gt;

&lt;p&gt;In various protocol implementations, ByteBuffer instances are serialized by considering data between position and limit, this means that an object created from another object might lead to different serialized data (and thus a different deserialized value) in case a ByteBuffer has a non default position (which can happen since ByteBuffers can be set).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12472940">THRIFT-882</key>
            <summary>deep copy of binary fields does not copy ByteBuffer characteristics (arrayOffset, position)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bryanduxbury">Bryan Duxbury</assignee>
                                    <reporter username="herberts">Mathias Herberts</reporter>
                        <labels>
                    </labels>
                <created>Tue, 31 Aug 2010 13:40:00 +0000</created>
                <updated>Tue, 18 Apr 2017 16:59:30 +0000</updated>
                            <resolved>Fri, 17 Sep 2010 19:27:50 +0000</resolved>
                                    <version>0.4</version>
                                    <fixVersion>0.5</fixVersion>
                                    <component>Java - Compiler</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="12904654" author="bryanduxbury" created="Tue, 31 Aug 2010 15:21:25 +0000"  >&lt;p&gt;It looks like the problem comes from not using the other.binary_field.position() attribute during the array copy, right? This should be a trivial fix.&lt;/p&gt;</comment>
                            <comment id="12904655" author="bryanduxbury" created="Tue, 31 Aug 2010 15:21:39 +0000"  >&lt;p&gt;I&apos;d love a test case, if you have one.&lt;/p&gt;</comment>
                            <comment id="12904702" author="bryanduxbury" created="Tue, 31 Aug 2010 18:13:59 +0000"  >&lt;p&gt;OK, I had a look at this and came up with this patch. I added a test that I think does a decent job of exercising the cases. I couldn&apos;t trivially create a ByteBuffer that had a non-zero arrayOffset(), so I&apos;m not sure when that ever comes into play, but I&apos;m including it for the same of completeness. Additionally, I added support for copying ByteBuffers that have come from other kinds of Channels.&lt;/p&gt;

&lt;p&gt;Let me know if this fixes your problem.&lt;/p&gt;</comment>
                            <comment id="12904944" author="herberts" created="Wed, 1 Sep 2010 06:19:29 +0000"  >&lt;p&gt;The handling of non array backed buffers will change any existing mark:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      orig.mark();
      orig.get(copy.array());
      orig.reset();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It can be avoided by doing&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-comment&quot;&gt;// Save current position
&lt;/span&gt;  &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; pos = orig.position();

  &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; mark = -1;

  &lt;span class=&quot;code-comment&quot;&gt;// Save current mark &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; set
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
    orig.reset();
    mark = orig.position();
    orig.position(pos);
  } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (InvalidMarkException ime) {
  }

  orig.mark();
  orig.get(copy.array());

  &lt;span class=&quot;code-comment&quot;&gt;// Get rid of mark and reset position to 0.
&lt;/span&gt;  orig.rewind();

  &lt;span class=&quot;code-comment&quot;&gt;// Reset mark to its original value &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it was set
&lt;/span&gt;  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (-1 != mark) {
    orig.position(mark);
    orig.mark();
  }

  &lt;span class=&quot;code-comment&quot;&gt;// Reset position to its original value.
&lt;/span&gt;  orig.position(pos);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12904946" author="herberts" created="Wed, 1 Sep 2010 06:25:12 +0000"  >&lt;p&gt;TBaseHelper could be modified to expose a clean way of retrieving a byte[] version of the ByteBuffer&apos;s content, this would ease migration to ByteBuffers.&lt;/p&gt;</comment>
                            <comment id="12905280" author="dengberg@evernote.com" created="Wed, 1 Sep 2010 22:37:38 +0000"  >
&lt;p&gt;Yes, but this level of confusion (by veteran programmers) may show that &lt;br/&gt;
the ByteBuffer low-level IO class may not be an ideal general-purpose &lt;br/&gt;
data field for user-level generated Java structs.  Getting data out of &lt;br/&gt;
the ByteBuffer seems a bit confusing and error prone.&lt;/p&gt;

&lt;p&gt;I.e. if it were totally up to me, I probably wouldn&apos;t expose this in the &lt;br/&gt;
default generated Java code for structs produced from an IDL.  I&apos;d &lt;br/&gt;
either make it an advanced compiler option, or only use it deep in the &lt;br/&gt;
hidden engine guts, masked behind getters and setters that return &lt;br/&gt;
simpler idempotent data types.&lt;/p&gt;

</comment>
                            <comment id="12907136" author="herberts" created="Wed, 8 Sep 2010 09:08:06 +0000"  >&lt;p&gt;I agree with Dave on not exposing ByteBuffer even if they are used internally.&lt;/p&gt;

&lt;p&gt;What&apos;s others&apos; take on this issue?&lt;/p&gt;</comment>
                            <comment id="12907231" author="bryanduxbury" created="Wed, 8 Sep 2010 14:50:49 +0000"  >&lt;p&gt;I&apos;m coming around to the idea of hiding the ByteBuffers a little. It wouldn&apos;t make sense for us to hide them completely, since that would take away basically all of the benefit.&lt;/p&gt;

&lt;p&gt;I&apos;m going to open another issue about this.&lt;/p&gt;</comment>
                            <comment id="12908845" author="bryanduxbury" created="Mon, 13 Sep 2010 16:16:29 +0000"  >&lt;p&gt;I found this snazzy slice() method that makes an independent copy of all the mark/position/etc state without copying the contents which saves me all the trouble of simulating mark().&lt;/p&gt;</comment>
                            <comment id="12908905" author="herberts" created="Mon, 13 Sep 2010 18:33:25 +0000"  >&lt;p&gt;Using ByteBuffer#asReadOnlyBuffer is even safer than #slice.&lt;/p&gt;

&lt;p&gt;Otherwise LGTM.&lt;/p&gt;</comment>
                            <comment id="12910744" author="bryanduxbury" created="Fri, 17 Sep 2010 19:27:50 +0000"  >&lt;p&gt;I just committed this.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12454455" name="thrift-882-v2.patch" size="4412" author="bryanduxbury" created="Mon, 13 Sep 2010 16:16:29 +0000"/>
                            <attachment id="12453526" name="thrift-882.patch" size="4193" author="bryanduxbury" created="Tue, 31 Aug 2010 18:13:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>187023</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 10 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i16dsn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>245367</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>