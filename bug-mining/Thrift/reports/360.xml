<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 07:59:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-970] Under heavy load, THttpClient may fail with &quot;too many open files&quot;</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-970</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;THttpClient uses URL.openConnection which returns a HttpUrlConnection instance for each message transmission.&lt;/p&gt;

&lt;p&gt;HttpUrlConnection supposedly pools connections to the server. While stress testing an application, we&apos;ve noticed that after several thousands requests, THttpClient would fail with a &quot;Too many open files&quot; error thrown in java.net.Socket.createImpl called from THttpClient.flush.&lt;/p&gt;

&lt;p&gt;As the underlying connection to the server is internally handled by HttpUrlConnection and the JVM, there is unfortunately not much that can be done to remedy this problem while still using HttpUrlConnection.&lt;/p&gt;

&lt;p&gt;I propose a new implementation of THttpClient which uses Apache HttpClient from Http Components instead of HttpUrlConnection.&lt;/p&gt;</description>
                <environment>&lt;p&gt;All&lt;/p&gt;</environment>
        <key id="12478219">THRIFT-970</key>
            <summary>Under heavy load, THttpClient may fail with &quot;too many open files&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="herberts">Mathias Herberts</assignee>
                                    <reporter username="herberts">Mathias Herberts</reporter>
                        <labels>
                    </labels>
                <created>Mon, 25 Oct 2010 09:43:32 +0000</created>
                <updated>Mon, 8 Nov 2010 17:22:45 +0000</updated>
                            <resolved>Fri, 5 Nov 2010 17:16:15 +0000</resolved>
                                    <version>0.2</version>
                    <version>0.3</version>
                    <version>0.4</version>
                    <version>0.5</version>
                                    <fixVersion>0.6</fixVersion>
                                    <component>Java - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="12924541" author="herberts" created="Mon, 25 Oct 2010 12:02:41 +0000"  >&lt;p&gt;This patch introduces the THttpTransport class which intends to be a drop in replacement for THttpClient (apart from the constructor which differs slightly).&lt;/p&gt;

&lt;p&gt;In order to quickly release resources associated with connections, response content is stored in a ByteArrayInputStream before being made available to the enclosing TProtocol.&lt;/p&gt;

&lt;p&gt;This means that the memory footprint might be double that of the response (the THttpTransport buffer and the TBase being filled).&lt;/p&gt;</comment>
                            <comment id="12925482" author="bryanduxbury" created="Wed, 27 Oct 2010 18:07:22 +0000"  >&lt;p&gt;I&apos;m a little concerned about having two different HTTP-client-related classes in Thrift. On the one hand, it seems like THttpClient isn&apos;t all that responsible. On the other hand, it seems like your new THttpTransport won&apos;t cache connections at all, which could have significant performance implications.&lt;/p&gt;

&lt;p&gt;Couldn&apos;t we instead find some way to make THttpClient do what we want it to and let he pooling/caching be configurable?&lt;/p&gt;

&lt;p&gt;Also, it appears that just closing the input stream you get from HttpUrlConnection &lt;b&gt;never&lt;/b&gt; closes the underlying socket, but there&apos;s another method called disconnect() that &lt;b&gt;will&lt;/b&gt; close the underlying socket if the connection is idle. Maybe we just need to change THttpClient to call that method.&lt;/p&gt;</comment>
                            <comment id="12925531" author="herberts" created="Wed, 27 Oct 2010 20:01:24 +0000"  >&lt;p&gt;My THttpTransport relies on HttpClient to do any caching/limiting, so connections will be cached if HttpClient is configured to do so.&lt;/p&gt;

&lt;p&gt;HttpClient has many other options, like limiting the number of connections per server, using a proxy, using various connection factories, etc.&lt;/p&gt;
</comment>
                            <comment id="12925735" author="herberts" created="Thu, 28 Oct 2010 07:28:19 +0000"  >&lt;p&gt;My tests show that if you use THttpTransport with a connection manager for which the following parameters were set&lt;/p&gt;

&lt;p&gt;http.protocol.version=HttpVersion.HTTP_1_1&lt;br/&gt;
http.protocol.content-charset=UTF-8&lt;br/&gt;
http.protocol.expect-continue=false&lt;br/&gt;
http.connection.stalecheck=false&lt;/p&gt;

&lt;p&gt;then performance is 5 to 15% better than those of THttpClient.&lt;/p&gt;</comment>
                            <comment id="12927600" author="herberts" created="Tue, 2 Nov 2010 21:13:36 +0000"  >&lt;p&gt;I could merge THttpClient and THttpTransport by having the current THttpClient behavior if a null HttpClient is passed to the constructor, how is that?&lt;/p&gt;</comment>
                            <comment id="12928004" author="bryanduxbury" created="Wed, 3 Nov 2010 21:05:22 +0000"  >&lt;p&gt;I think that sounds like a good solution. The javadoc for the class should contain at least an inkling (or better yet, a link) to information on how to use it performantly.&lt;/p&gt;</comment>
                            <comment id="12928200" author="herberts" created="Thu, 4 Nov 2010 13:00:48 +0000"  >&lt;p&gt;Patch which modifies THttpClient to offer both implementations.&lt;/p&gt;

&lt;p&gt;When using a HttpClient instance, the user agent is set to &apos;Java/THttpClient/HC&apos; instead of  &apos;Java/THttpClient&apos;.&lt;/p&gt;</comment>
                            <comment id="12928690" author="bryanduxbury" created="Fri, 5 Nov 2010 17:16:15 +0000"  >&lt;p&gt;I just committed this. Thanks for working through the features with me.&lt;/p&gt;</comment>
                            <comment id="12929248" author="dreiss" created="Sat, 6 Nov 2010 22:26:11 +0000"  >&lt;p&gt;I just noticed the change to ivy.xml.  Does this mean that You need httpcomponents installed even if you are only using the HttpURLConnection version?&lt;/p&gt;</comment>
                            <comment id="12929552" author="herberts" created="Mon, 8 Nov 2010 11:13:25 +0000"  >&lt;p&gt;Indeed, should this pose a problem I can rollback the merging and add a THttpTransport.java file with the HttpClient backed implementation.&lt;/p&gt;</comment>
                            <comment id="12929633" author="dreiss" created="Mon, 8 Nov 2010 17:06:47 +0000"  >&lt;p&gt;That&apos;s my preference, but Bryan is a better judge on Java issues than I am.&lt;/p&gt;</comment>
                            <comment id="12929634" author="bryanduxbury" created="Mon, 8 Nov 2010 17:22:44 +0000"  >&lt;p&gt;I&apos;m much more concerned with library coherence than reducing external dependencies. Having multiple HTTP clients seems like a great way to confuse our users and decrease our maintainability. Really, I don&apos;t think anyone should ever want to use the slower version anyway.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12457966" name="THRIFT-970-1" size="8566" author="herberts" created="Mon, 25 Oct 2010 12:02:41 +0000"/>
                            <attachment id="12458814" name="THRIFT-970-2" size="8475" author="herberts" created="Thu, 4 Nov 2010 13:00:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>187091</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 3 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i15udr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>242222</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>