<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 08:24:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[THRIFT-3791] Delphi pipe client may fail even in a non-error condition</title>
                <link>https://issues.apache.org/jira/browse/THRIFT-3791</link>
                <project id="12310800" key="THRIFT">Thrift</project>
                    <description>&lt;p&gt;In TPipeStreamBase.ReadDirect(), the code performs a peek on the pipe.  If no data is available (bytes = 0), GetLastError is still checked, even though Microsoft documentation clearly states that not all functions set the last error code to 0 on success (&lt;a href=&quot;https://msdn.microsoft.com/en-us/library/windows/desktop/ms679360(v=vs.85).aspx&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://msdn.microsoft.com/en-us/library/windows/desktop/ms679360(v=vs.85).aspx&lt;/a&gt;).  Furthermore, because PeekNamedPipe only mentions that GetLastError should be called on failure, the logic of the if test must be changed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12959834">THRIFT-3791</key>
            <summary>Delphi pipe client may fail even in a non-error condition</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="KyleJ61782">Kyle Johnson</assignee>
                                    <reporter username="KyleJ61782">Kyle Johnson</reporter>
                        <labels>
                    </labels>
                <created>Mon, 18 Apr 2016 23:55:18 +0000</created>
                <updated>Sat, 20 Feb 2021 15:27:41 +0000</updated>
                            <resolved>Tue, 19 Apr 2016 21:37:44 +0000</resolved>
                                                    <fixVersion>0.10.0</fixVersion>
                                    <component>Delphi - Library</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15246795" author="kylej61782" created="Mon, 18 Apr 2016 23:57:50 +0000"  >&lt;p&gt;This fixes the logic so that GetLastError is only used when PeekNamedPipe fails.&lt;/p&gt;</comment>
                            <comment id="15247729" author="jensg" created="Tue, 19 Apr 2016 13:14:27 +0000"  >&lt;p&gt;Why don&apos;t we test IsOpen anymore?&lt;/p&gt;</comment>
                            <comment id="15247804" author="kylej61782" created="Tue, 19 Apr 2016 14:13:06 +0000"  >&lt;p&gt;It&apos;s not necessary to test IsOpen because it is tested right at the beginning of ReadDirect().  Furthermore, it&apos;s not necessary during the PeekNamedPipe loop because the status of IsOpen cannot change while looking for data, assuming the code isn&apos;t meant to be used by multiple threads concurrently.  If it &lt;b&gt;is&lt;/b&gt; expected that the code is to be thread safe (which it is nowhere near thread safe currently), then it would be necessary to add some sort of exclusivity check around all pipe operations that utilize a handle, which isn&apos;t done currently.&lt;/p&gt;</comment>
                            <comment id="15248636" author="jensg" created="Tue, 19 Apr 2016 21:03:20 +0000"  >&lt;p&gt;It is thread safe w/regard to the close() method. That&apos;s the only method that will (should) ever be called from another thread.&lt;/p&gt;</comment>
                            <comment id="15248717" author="jensg" created="Tue, 19 Apr 2016 21:37:44 +0000"  >&lt;p&gt;Committed, thanks!&lt;/p&gt;</comment>
                            <comment id="15248720" author="kylej61782" created="Tue, 19 Apr 2016 21:38:06 +0000"  >&lt;p&gt;The problem is that it isn&apos;t, at least with regard to ReadDirect and IsOpen.  If the extra IsOpen call is in there to ensure thread safety, it does no such thing because Close could occur between the IsOpen check and the PeekNamedPipe check, and even between PeekNamedPipe and ReadFile.  It&apos;s just a race condition.  As such, it really doesn&apos;t matter whether or not IsOpen is called once or multiple times within the loop.  If thread safety is truly necessary, then the following would be required:&lt;/p&gt;

&lt;p&gt;1) Put the IsOpen check back into the loop.&lt;br/&gt;
2) Wrap all code between IsOpen and the API call using the handle with a critical section.  This means modifying ReadDirect and WriteDirect, both.&lt;br/&gt;
3) Wrap the Close() handler with a critical section.&lt;/p&gt;

&lt;p&gt;However, if we want to just rely on Windows to return ERROR_INVALID_HANDLE (which actually isn&apos;t guaranteed...Windows &lt;b&gt;could&lt;/b&gt; reassign the handle to another file), then fine.  But as it is, before the patch above, the code isn&apos;t thread safe with regard to the handle being modified by another thread via Close between the IsOpen and Peek or the Peek and ReadFile.&lt;/p&gt;</comment>
                            <comment id="15248722" author="jensg" created="Tue, 19 Apr 2016 21:38:48 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12799600/12799600_0001-THRIFT-3791-Delphi-pipe-client-may-fail-even-in-a-no.patch&quot; title=&quot;0001-THRIFT-3791-Delphi-pipe-client-may-fail-even-in-a-no.patch attached to THRIFT-3791&quot;&gt;Committed version&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="15248723" author="jensg" created="Tue, 19 Apr 2016 21:39:59 +0000"  >&lt;p&gt;No critsects, not necessary. Use interlocked if you need, it&apos;s only a handle. &lt;/p&gt;</comment>
                            <comment id="15248728" author="kylej61782" created="Tue, 19 Apr 2016 21:43:49 +0000"  >&lt;p&gt;True, only a handle.  Just if we wanted to ensure the handle wasn&apos;t changed between IsOpen and any peek or read.  But if we don&apos;t care, I totally agree that it&apos;s unnecessary.  And with that...I won&apos;t continue commenting on a closed issue.  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15248740" author="jensg" created="Tue, 19 Apr 2016 21:47:56 +0000"  >&lt;p&gt;Good catch, by the way.&lt;/p&gt;</comment>
                            <comment id="15253199" author="hudson" created="Fri, 22 Apr 2016 02:18:25 +0000"  >&lt;p&gt;SUCCESS: Integrated in Thrift-precommit #438 (See &lt;a href=&quot;https://builds.apache.org/job/Thrift-precommit/438/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Thrift-precommit/438/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-3791&quot; title=&quot;Delphi pipe client may fail even in a non-error condition&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-3791&quot;&gt;&lt;del&gt;THRIFT-3791&lt;/del&gt;&lt;/a&gt; Delphi pipe client may fail even in a non-error condition (jensg: &lt;a href=&quot;https://github.com/apache/thrift/commit/5988f4800694d81e547d47596f737c0db551ef50&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/thrift/commit/5988f4800694d81e547d47596f737c0db551ef50&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;lib/delphi/src/Thrift.Transport.Pipes.pas&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12799600" name="0001-THRIFT-3791-Delphi-pipe-client-may-fail-even-in-a-no.patch" size="1638" author="jensg" created="Tue, 19 Apr 2016 21:38:48 +0000"/>
                            <attachment id="12799388" name="THRIFT-3791-fix-for-calling-GetLastError-even-on-success.patch" size="1231" author="KyleJ61782" created="Mon, 18 Apr 2016 23:57:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 30 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12310041" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Patch Info</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10042"><![CDATA[Patch Available]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2wajz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>