diff --git a/lib/lua/TCompactProtocol.lua b/lib/lua/TCompactProtocol.lua
index 877595a5d..7b75967a9 100644
--- a/lib/lua/TCompactProtocol.lua
+++ b/lib/lua/TCompactProtocol.lua
@@ -124,8 +124,8 @@ function TCompactProtocol:writeStructBegin(name)
 end
 
 function TCompactProtocol:writeStructEnd()
-  self.lastFieldIndex = self.lastFieldIndex - 1
   self.lastFieldId = self.lastField[self.lastFieldIndex]
+  self.lastFieldIndex = self.lastFieldIndex - 1
 end
 
 function TCompactProtocol:writeFieldBegin(name, ttype, id)
