diff --git a/lib/lua/src/luabpack.c b/lib/lua/src/luabpack.c
index a86fc3ed1..077b6aa07 100644
--- a/lib/lua/src/luabpack.c
+++ b/lib/lua/src/luabpack.c
@@ -104,10 +104,10 @@ static int l_bunpack(lua_State *L) {
   const char *code = luaL_checkstring(L, 1);
   luaL_argcheck(L, code[1] == '\0', 0, "Format code must be one character.");
   const char *data = luaL_checkstring(L, 2);
-#ifdef _LUA51_
-  size_t len = lua_objlen(L, 2);
-#else
+#if LUA_VERSION_NUM >= 502
   size_t len = lua_rawlen(L, 2);
+#else
+  size_t len = lua_objlen(L, 2);
 #endif
 
   switch (code[0]) {
