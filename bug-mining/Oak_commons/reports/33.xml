<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:46:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-6164] IOUtils.nextPowerOf2() returns lower power of 2 for very high int values</title>
                <link>https://issues.apache.org/jira/browse/OAK-6164</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;In the IOUtils.nextPowerOf2() method, all int values are accepted as input.  However, there are valid signed integer values that this method accepts as input, but for which a lower power of 2 value is returned.&lt;/p&gt;

&lt;p&gt;This occurs for values that are valid signed integer values that are greater than the highest possible power of two value in the signed integer range.  Signed integer values have the maximum value of 0x7FFFFFFF, but the maximum possible power of two in the signed integer range is 0x40000000.  (The current implementation incorrectly identifies the maximum possible power of two as 0x3FFFFFFF, due to how it is computed by doing integer division of 0x7FFFFFFF / 2.)&lt;/p&gt;

&lt;p&gt;In the current implementation any input in the range of &lt;span class=&quot;error&quot;&gt;&amp;#91;0x40000000, 0x7FFFFFFF&amp;#93;&lt;/span&gt; is a valid signed integer input, but the method will return 0x3FFFFFFF as the next valid max power of 2.&lt;/p&gt;

&lt;p&gt;Two minor things need to be fixed:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;If the input is 0x40000000, the return value needs to be 0x40000000, instead of 0x3FFFFFFF which is not a valid power of 2.&lt;/li&gt;
	&lt;li&gt;If the input is in the range &lt;span class=&quot;error&quot;&gt;&amp;#91;0x40000001, 0x7FFFFFFF&amp;#93;&lt;/span&gt; I propose the method should instead throw an IllegalArgumentException and indicate that it is not possible to compute a next power of 2 for a number in that range.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13068931">OAK-6164</key>
            <summary>IOUtils.nextPowerOf2() returns lower power of 2 for very high int values</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mduerig">Michael D&#252;rig</assignee>
                                    <reporter username="mattvryan">Matt Ryan</reporter>
                        <labels>
                    </labels>
                <created>Wed, 3 May 2017 21:07:06 +0000</created>
                <updated>Tue, 30 May 2017 08:39:18 +0000</updated>
                            <resolved>Mon, 8 May 2017 10:33:02 +0000</resolved>
                                                    <fixVersion>1.7.0</fixVersion>
                    <fixVersion>1.8.0</fixVersion>
                                    <component>commons</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15995686" author="mattvryan" created="Wed, 3 May 2017 21:07:31 +0000"  >&lt;p&gt;I have a patch for this, with a unit test, that I will submit shortly.&lt;/p&gt;</comment>
                            <comment id="15995743" author="mattvryan" created="Wed, 3 May 2017 21:45:33 +0000"  >&lt;p&gt;Attached patch with a fix, and with unit test for IOUtils.nextPowerOf2().&lt;/p&gt;</comment>
                            <comment id="15995914" author="mattvryan" created="Wed, 3 May 2017 23:43:57 +0000"  >&lt;p&gt;As I thought a bit about patch 1, it occurred to me that adding a throws declaration for IllegalArgumentException is not really needed since it is a RuntimeException, but doing so changes the public API signature.  So I&apos;ve attached &lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-6164&quot; title=&quot;IOUtils.nextPowerOf2() returns lower power of 2 for very high int values&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-6164&quot;&gt;&lt;del&gt;OAK-6164&lt;/del&gt;&lt;/a&gt;.patch.2 which removes the throws declaration.&lt;/p&gt;</comment>
                            <comment id="15996316" author="mduerig" created="Thu, 4 May 2017 07:59:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mattvryan&quot; class=&quot;user-hover&quot; rel=&quot;mattvryan&quot;&gt;mattvryan&lt;/a&gt;, thanks for sending a patch. Looks good!&lt;/p&gt;

&lt;p&gt;I wonder though whether we could/should change the return type of &lt;tt&gt;nextPowerOf2&lt;/tt&gt; from &lt;tt&gt;int&lt;/tt&gt; to &lt;tt&gt;long&lt;/tt&gt;. This would allow us to handle the values in the range [0x40000000, 0x7FFFFFFF] uniformly. This is the approach I&apos;ve taken with &lt;tt&gt;PriorityCache.nextPowerOfTwo()&lt;/tt&gt; (where I probably wasn&apos;t aware of &lt;tt&gt;IOUtils&lt;/tt&gt;). &lt;/p&gt;

&lt;p&gt;WDYT?&lt;/p&gt;</comment>
                            <comment id="15996899" author="mattvryan" created="Thu, 4 May 2017 15:16:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mduerig&quot; class=&quot;user-hover&quot; rel=&quot;mduerig&quot;&gt;mduerig&lt;/a&gt; I wondered about doing that also.  The problem is that there will always be a range of values for which we can&apos;t compute the next highest power of two, for any integer type.  However, it may work to accept an &lt;tt&gt;int&lt;/tt&gt; as the input but return a &lt;tt&gt;long&lt;/tt&gt; as the output.&lt;/p&gt;

&lt;p&gt;For any value in the range &lt;span class=&quot;error&quot;&gt;&amp;#91;0x40000001, 0x7FFFFFFF&amp;#93;&lt;/span&gt;, the next highest power of 2 would be 0x80000000.  Interpreted as an &lt;tt&gt;int&lt;/tt&gt; value this is actually &lt;tt&gt;Integer.MIN_VALUE&lt;/tt&gt; because of the sign bit, but this of course works as a &lt;tt&gt;long&lt;/tt&gt;.  So this can work for all valid positive &lt;tt&gt;int&lt;/tt&gt; input values.  But if the caller were to cast the result back to an &lt;tt&gt;int&lt;/tt&gt; they would then end up with a negative number (--2147483648) even though the &lt;tt&gt;long&lt;/tt&gt; value is a positive value (2147483648).&lt;/p&gt;

&lt;p&gt;So that&apos;s a minor problem, but I think your point is that this would be better than not accepting all valid positive &lt;tt&gt;int&lt;/tt&gt; values and throwing an exception when the range is exceeded.  I tend to agree.&lt;/p&gt;

&lt;p&gt;However, this does have the effect of changing the function signature (return value from &lt;tt&gt;int&lt;/tt&gt; to &lt;tt&gt;long&lt;/tt&gt;).  I don&apos;t think the function is actually used anywhere else in Oak so I&apos;m not sure making that change matters too much, but it does technically constitute an API change.&lt;/p&gt;

&lt;p&gt;I&apos;ll make another patch anyway, and then we can decide which we like best.&lt;/p&gt;</comment>
                            <comment id="15996960" author="mattvryan" created="Thu, 4 May 2017 15:52:05 +0000"  >&lt;p&gt;Attached patch 3.  In this patch, the return type of nextPowerOf2 is changed from &lt;tt&gt;int&lt;/tt&gt; to &lt;tt&gt;long&lt;/tt&gt;, and it no longer throws &lt;tt&gt;IllegalArgumentException&lt;/tt&gt;.  Unit tests have been updated.&lt;/p&gt;</comment>
                            <comment id="16000577" author="mduerig" created="Mon, 8 May 2017 10:33:02 +0000"  >&lt;p&gt;Applied patch with minor modification at &lt;a href=&quot;http://svn.apache.org/viewvc?rev=1794319&amp;amp;view=rev&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc?rev=1794319&amp;amp;view=rev&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The removed overflow check turned out to be unnecessary as an integer can never exceed &lt;tt&gt;Integer.Max_VALUE&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16029112" author="edivad" created="Tue, 30 May 2017 08:39:18 +0000"  >&lt;p&gt;Bulk close for 1.7.0&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12866272" name="OAK-6164.patch.1" size="3863" author="mattvryan" created="Wed, 3 May 2017 21:45:33 +0000"/>
                            <attachment id="12866295" name="OAK-6164.patch.2" size="3786" author="mattvryan" created="Wed, 3 May 2017 23:43:57 +0000"/>
                            <attachment id="12866425" name="OAK-6164.patch.3" size="3288" author="mattvryan" created="Thu, 4 May 2017 15:52:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 24 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3egbj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>