<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:46:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[OAK-7929] Incorrect Facet Count With Large Dataset and ACLs</title>
                <link>https://issues.apache.org/jira/browse/OAK-7929</link>
                <project id="12313221" key="OAK">Jackrabbit Oak</project>
                    <description>&lt;p&gt;Currently ACL (secure) facet handling only deals with first batch of results from lucene index (50 documents). So, for large result sets, the facet count hence doesn&apos;t get decremented for large part of the result set.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13201886">OAK-7929</key>
            <summary>Incorrect Facet Count With Large Dataset and ACLs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="catholicon">Vikas Saurabh</assignee>
                                    <reporter username="catholicon">Vikas Saurabh</reporter>
                        <labels>
                    </labels>
                <created>Sun, 2 Dec 2018 20:23:15 +0000</created>
                <updated>Tue, 8 Oct 2019 15:21:49 +0000</updated>
                            <resolved>Wed, 5 Dec 2018 00:24:30 +0000</resolved>
                                                    <fixVersion>1.10.0</fixVersion>
                    <fixVersion>1.8.10</fixVersion>
                    <fixVersion>1.6.16</fixVersion>
                    <fixVersion>1.9.13</fixVersion>
                                    <component>lucene</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                                                            <comments>
                            <comment id="16706465" author="catholicon" created="Sun, 2 Dec 2018 20:56:49 +0000"  >&lt;p&gt;Since checking for ACL is fairly expensive and to get accurate count we&apos;d have to do ACL check over the whole result set. So, we&apos;d expand current boolean form of &lt;tt&gt;secure&lt;/tt&gt; to an enum - &lt;tt&gt;insecure&lt;/tt&gt;, &lt;tt&gt;statistical&lt;/tt&gt; and &lt;tt&gt;secure&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;insecure&lt;/tt&gt; mode won&apos;t do any ACL check and would return facets as were returned from index. The &lt;tt&gt;secure&lt;/tt&gt; mode would generalize the current form for checking 50 documents to the whole result set instead.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;statistical&lt;/tt&gt; mode would randomly sample some documents from the result set. It&apos;d see ratio of accessible samples and extrapolate the facet counts with returned ratio. A few implementation details below:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;default mode would be kept &lt;del&gt;&lt;tt&gt;statistical&lt;/tt&gt; with default &lt;tt&gt;sampleSize&lt;/tt&gt; as 1000&lt;/del&gt; &lt;tt&gt;secure&lt;/tt&gt; (for backward compatibility).&lt;/li&gt;
	&lt;li&gt;when &lt;tt&gt;statistical&lt;/tt&gt; mode is selected, the default value of &lt;tt&gt;sampleSize&lt;/tt&gt; is 1000&lt;/li&gt;
	&lt;li&gt;both the defaults (mode and sampleSize) can be over-ridden system wide using JVM param &lt;tt&gt;oak.facets.secure&lt;/tt&gt; and &lt;tt&gt;oak.facet.statistical.sampleSize&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;one can also set &lt;tt&gt;secure&lt;/tt&gt; (String) and &lt;tt&gt;sampleSize&lt;/tt&gt; (long casted to int) under &lt;tt&gt;&amp;lt;definition&amp;gt;/facets&lt;/tt&gt; to override these per index definition&lt;/li&gt;
	&lt;li&gt;the sampling is done using idea presented in &lt;a href=&quot;https://dl.acm.org/citation.cfm?id=368159&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://dl.acm.org/citation.cfm?id=368159&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;the reason to pick 1000 as default sample size as expected error rate in sampled data is given by &lt;tt&gt;sampleSize ^ -0.5&lt;/tt&gt; [0]. For 1000, this roughly comes out as 3% expected error rate.&lt;/li&gt;
	&lt;li&gt;for random number seed, we&apos;d insert a random long number &lt;tt&gt;seed&lt;/tt&gt; under index definition during an indexing cycle. This is kept to keep consistent result across refreshes without any other change in indexed data. From random-ness pov this should still be ok as actual generated random numbers depend on result size; which in turn would depend on search query and indexed data. From security pov, the seed should be ok as index defs are administrative data.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;[0]: &lt;a href=&quot;https://onlinecourses.science.psu.edu/stat100/node/16/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://onlinecourses.science.psu.edu/stat100/node/16/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16707965" author="catholicon" created="Mon, 3 Dec 2018 23:14:37 +0000"  >&lt;p&gt;Adding&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12950466/12950466_0001-OAK-7930-Add-tape-sampling.patch&quot; title=&quot;0001-OAK-7930-Add-tape-sampling.patch attached to OAK-7929&quot;&gt;0001-OAK-7930-Add-tape-sampling.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;  - which add tape sampling (&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-7930&quot; title=&quot;Add tape sampling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-7930&quot;&gt;&lt;del&gt;OAK-7930&lt;/del&gt;&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12950467/12950467_0002-OAK-7929-Incorrect-Facet-Count-With-Large-Dataset-an.patch&quot; title=&quot;0002-OAK-7929-Incorrect-Facet-Count-With-Large-Dataset-an.patch attached to OAK-7929&quot;&gt;0002-OAK-7929-Incorrect-Facet-Count-With-Large-Dataset-an.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;  - rest of implementation as described in the comment above&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;, I&apos;m still writing tests (basically an IT with facets across different configs). But, it&apos;d great if you can review the implementation in the patches. I don&apos;t want to commit to trunk before review. Btw, we also need to backport it to 1.8 and 1.6 - but those would need to wait until after I am done with the test (I&apos;d upload backport patches as soon as I get to them).&lt;/p&gt;</comment>
                            <comment id="16708557" author="tmueller" created="Tue, 4 Dec 2018 11:03:11 +0000"  >&lt;p&gt;I have one more test for the sampling that tests the result is unbiased:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    @Test
    public void sampleBias() {
        int size = 200;
        int k = 20;
        int[] counts = new int[size];
        Random r = new Random(42);
        int testCount = 100 * size;
        for (int i = 0; i &amp;lt; testCount; i++) {
            List&amp;lt;Integer&amp;gt; input = range(0, size - 1);
            TapeSampling&amp;lt;Integer&amp;gt; res = new TapeSampling&amp;lt;&amp;gt;(r, input.iterator(), input.size(), k);
            Iterator&amp;lt;Integer&amp;gt; it = res.getSamples();
            while (it.hasNext()) {
                counts[it.next()]++;
            }
        }
        int expectedCount = testCount / (size / k);
        for (int i = 0; i &amp;lt; size; i++) {
            assertTrue(counts[i] &amp;gt; expectedCount* 0.9 &amp;amp;&amp;amp; counts[i] &amp;lt; expectedCount * 1.1);
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It would detect for example the following incorrect change in the code:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;-                    int r = rGen.nextInt(N - seen) + 1;
+                    int r = rGen.nextInt(2) == 0 ? 1 : rGen.nextInt(N - seen) + 1;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16708559" author="catholicon" created="Tue, 4 Dec 2018 11:07:15 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thomasm&quot; class=&quot;user-hover&quot; rel=&quot;thomasm&quot;&gt;thomasm&lt;/a&gt;. Added this test in my local changes.&lt;/p&gt;</comment>
                            <comment id="16708684" author="tmueller" created="Tue, 4 Dec 2018 13:14:49 +0000"  >&lt;p&gt;The rest of the patch is a bit harder to analyze... Due to modularization, it looks like some of the test is in a different module than the implementation...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; 
+    if (propertyState != null) {
+      try {
+        ret = propertyState.getValue(Type.LONG);
+      } catch (Exception e) {
+        // ignored
+      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I would probably log the exception message at log level debug, and the stack trace at log level trace.&lt;/p&gt;</comment>
                            <comment id="16708688" author="tmueller" created="Tue, 4 Dec 2018 13:18:01 +0000"  >&lt;p&gt;But in general the patch looks good to me.&lt;/p&gt;</comment>
                            <comment id="16709439" author="catholicon" created="Wed, 5 Dec 2018 00:24:30 +0000"  >&lt;p&gt;Done on trunk at &lt;a href=&quot;https://svn.apache.org/r1848181&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1848181&lt;/a&gt; (&lt;a href=&quot;https://issues.apache.org/jira/browse/OAK-7930&quot; title=&quot;Add tape sampling&quot; class=&quot;issue-link&quot; data-issue-key=&quot;OAK-7930&quot;&gt;&lt;del&gt;OAK-7930&lt;/del&gt;&lt;/a&gt;) and &lt;a href=&quot;https://svn.apache.org/r1848182&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1848182&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16709813" author="catholicon" created="Wed, 5 Dec 2018 09:22:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mduerig&quot; class=&quot;user-hover&quot; rel=&quot;mduerig&quot;&gt;mduerig&lt;/a&gt; pointed out that animal sniffer is failing oak-lucene on jdk11. Fixed that on trunk at &lt;a href=&quot;https://svn.apache.org/r1848191&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1848191&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16709934" author="catholicon" created="Wed, 5 Dec 2018 11:18:40 +0000"  >&lt;p&gt; &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12950705/12950705_OAK-7929.1_8.patch&quot; title=&quot;OAK-7929.1_8.patch attached to OAK-7929&quot;&gt;OAK-7929.1_8.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; is backport to 1.8 patch for r1848181, r1848182, and r1848191. Next up is to prepare patch for 1.6.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reschke&quot; class=&quot;user-hover&quot; rel=&quot;reschke&quot;&gt;reschke&lt;/a&gt;, you might want to check these out too. I&apos;d first prepare the patch for 1.6 and commit both patches after that.&lt;/p&gt;</comment>
                            <comment id="16710045" author="reschke" created="Wed, 5 Dec 2018 13:10:31 +0000"  >&lt;p&gt;Patch works for me on 1.8 (on RDB, incl, integration tests)&lt;/p&gt;</comment>
                            <comment id="16710124" author="catholicon" created="Wed, 5 Dec 2018 14:27:14 +0000"  >&lt;p&gt;While preparing to backport to 1.6 it appeared that random seed injection code relied on code paths added due to hybridV2 implementation. Changed that implementation on trunk at &lt;a href=&quot;https://svn.apache.org/r1848217&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1848217&lt;/a&gt; such that it works fine in 1.6 as well.&lt;br/&gt;
Updated  &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12950705/12950705_OAK-7929.1_8.patch&quot; title=&quot;OAK-7929.1_8.patch attached to OAK-7929&quot;&gt;OAK-7929.1_8.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; accordingly.&lt;br/&gt;
&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12950704/12950704_OAK-7929.1_6.patch&quot; title=&quot;OAK-7929.1_6.patch attached to OAK-7929&quot;&gt;OAK-7929.1_6.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; is the patch that can be applied in 1.6 branch.&lt;/p&gt;

&lt;p&gt;Onto committing backports now.&lt;/p&gt;</comment>
                            <comment id="16710173" author="catholicon" created="Wed, 5 Dec 2018 15:04:27 +0000"  >&lt;p&gt;Backported &lt;a href=&quot;https://svn.apache.org/r1848181&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1848181&lt;/a&gt;, &lt;a href=&quot;https://svn.apache.org/r1848182&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1848182&lt;/a&gt;, &lt;a href=&quot;https://svn.apache.org/r1848191&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1848191&lt;/a&gt; and &lt;a href=&quot;https://svn.apache.org/r1848217&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1848217&lt;/a&gt; from trunk to 1.8 at &lt;a href=&quot;https://svn.apache.org/r1848218&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1848218&lt;/a&gt; and to 1.6 at &lt;a href=&quot;https://svn.apache.org/r1848220&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1848220&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16721269" author="edivad" created="Fri, 14 Dec 2018 11:30:08 +0000"  >&lt;p&gt;bulk close 1.9.13&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13223920">OAK-8167</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13202276">OAK-7939</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12950466" name="0001-OAK-7930-Add-tape-sampling.patch" size="8087" author="catholicon" created="Mon, 3 Dec 2018 23:11:01 +0000"/>
                            <attachment id="12950467" name="0002-OAK-7929-Incorrect-Facet-Count-With-Large-Dataset-an.patch" size="54673" author="catholicon" created="Mon, 3 Dec 2018 23:11:02 +0000"/>
                            <attachment id="12950704" name="OAK-7929.1_6.patch" size="94772" author="catholicon" created="Wed, 5 Dec 2018 14:23:26 +0000"/>
                            <attachment id="12950705" name="OAK-7929.1_8.patch" size="94625" author="catholicon" created="Wed, 5 Dec 2018 14:23:26 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="13201893">OAK-7930</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 48 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s0135s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>