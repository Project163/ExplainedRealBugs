{"url":"https://api.github.com/repos/microsoft/playwright/issues/33077","repository_url":"https://api.github.com/repos/microsoft/playwright","labels_url":"https://api.github.com/repos/microsoft/playwright/issues/33077/labels{/name}","comments_url":"https://api.github.com/repos/microsoft/playwright/issues/33077/comments","events_url":"https://api.github.com/repos/microsoft/playwright/issues/33077/events","html_url":"https://github.com/microsoft/playwright/issues/33077","id":2583265129,"node_id":"I_kwDODTssw86Z-X9p","number":33077,"title":"[Bug]: Playwright not sharding tests evenly","user":{"login":"rohitkrishna094","id":18495886,"node_id":"MDQ6VXNlcjE4NDk1ODg2","avatar_url":"https://avatars.githubusercontent.com/u/18495886?v=4","gravatar_id":"","url":"https://api.github.com/users/rohitkrishna094","html_url":"https://github.com/rohitkrishna094","followers_url":"https://api.github.com/users/rohitkrishna094/followers","following_url":"https://api.github.com/users/rohitkrishna094/following{/other_user}","gists_url":"https://api.github.com/users/rohitkrishna094/gists{/gist_id}","starred_url":"https://api.github.com/users/rohitkrishna094/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rohitkrishna094/subscriptions","organizations_url":"https://api.github.com/users/rohitkrishna094/orgs","repos_url":"https://api.github.com/users/rohitkrishna094/repos","events_url":"https://api.github.com/users/rohitkrishna094/events{/privacy}","received_events_url":"https://api.github.com/users/rohitkrishna094/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":7211040564,"node_id":"LA_kwDODTssw88AAAABrc-_NA","url":"https://api.github.com/repos/microsoft/playwright/labels/v1.49","name":"v1.49","color":"000000","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"dgozman","id":9881434,"node_id":"MDQ6VXNlcjk4ODE0MzQ=","avatar_url":"https://avatars.githubusercontent.com/u/9881434?v=4","gravatar_id":"","url":"https://api.github.com/users/dgozman","html_url":"https://github.com/dgozman","followers_url":"https://api.github.com/users/dgozman/followers","following_url":"https://api.github.com/users/dgozman/following{/other_user}","gists_url":"https://api.github.com/users/dgozman/gists{/gist_id}","starred_url":"https://api.github.com/users/dgozman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dgozman/subscriptions","organizations_url":"https://api.github.com/users/dgozman/orgs","repos_url":"https://api.github.com/users/dgozman/repos","events_url":"https://api.github.com/users/dgozman/events{/privacy}","received_events_url":"https://api.github.com/users/dgozman/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"dgozman","id":9881434,"node_id":"MDQ6VXNlcjk4ODE0MzQ=","avatar_url":"https://avatars.githubusercontent.com/u/9881434?v=4","gravatar_id":"","url":"https://api.github.com/users/dgozman","html_url":"https://github.com/dgozman","followers_url":"https://api.github.com/users/dgozman/followers","following_url":"https://api.github.com/users/dgozman/following{/other_user}","gists_url":"https://api.github.com/users/dgozman/gists{/gist_id}","starred_url":"https://api.github.com/users/dgozman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dgozman/subscriptions","organizations_url":"https://api.github.com/users/dgozman/orgs","repos_url":"https://api.github.com/users/dgozman/repos","events_url":"https://api.github.com/users/dgozman/events{/privacy}","received_events_url":"https://api.github.com/users/dgozman/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":1,"created_at":"2024-10-12T17:06:17Z","updated_at":"2024-10-14T20:46:07Z","closed_at":"2024-10-14T20:46:07Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Version\n\n^1.48.0(latest)\n\n### Steps to reproduce\n\nExample steps to reproduce.\n\n1. Copy this code into a file called `tests/shard-test.spec.js`\n```js\nconst { test, expect } = require('@playwright/test');\n\nconst arr = Array.from({ length: 2000 }, (_, i) => i + 1);\n\ntest.beforeAll(async () => {\n    console.log('Before tests');\n});\n\narr.forEach((num) => {\n    test(`@smoke should check Math.pow functionality for ${num}`, async ({ page }) => {\n        expect(num ** 2).toBe(Math.pow(num, 2));\n    });\n})\n```\n2. Also have fullyParallel set to true in your playwright config file\n3. Then run the test using this command `npx playwright test tests/shard-test.spec.js --shard=2/8`\n4. Look at the logs and you will notice that no tests run.\n5. However on shard 1 it gets 500 tests allocated to it(when in fact each shard should get 2000/8 = 250 tests)\n\n### Expected behavior\n\n- Each shard should get same amount of tests allocated to it.\n- So in this example each shard should get 2000/8 = 250 tests each.\n- And finally some shards should not exit immediately `doing no work`\n\n### Actual behavior\n\n- Bug in playwright where tests are not sharded evenly\n- Noticed that this happens if I added test.beforeAll in this file. If I comment that out, then it works fine.\n\n### Additional context\n\n_No response_\n\n### Environment\n\n## System:\n - OS: Windows 10 10.0.19045\n - CPU: (8) x64 Intel(R) Core(TM) i7-6700HQ CPU @ 2.60GHz\n - Memory: 6.76 GB / 15.88 GB\n## Binaries:\n - Node: 20.16.0 - C:\\Program Files\\nodejs\\node.EXE\n - npm: 10.8.2 - C:\\Program Files\\nodejs\\npm.CMD\n## IDEs:\n - VSCode: 1.94.0 - C:\\Users\\Owner\\AppData\\Local\\Programs\\Microsoft VS Code\\bin\\code.CMD\n## Languages:\n - Bash: 5.1.16 - C:\\WINDOWS\\system32\\bash.EXE\n## npmPackages:\n - @playwright/test: ^1.48.0 => 1.48.0","closed_by":{"login":"dgozman","id":9881434,"node_id":"MDQ6VXNlcjk4ODE0MzQ=","avatar_url":"https://avatars.githubusercontent.com/u/9881434?v=4","gravatar_id":"","url":"https://api.github.com/users/dgozman","html_url":"https://github.com/dgozman","followers_url":"https://api.github.com/users/dgozman/followers","following_url":"https://api.github.com/users/dgozman/following{/other_user}","gists_url":"https://api.github.com/users/dgozman/gists{/gist_id}","starred_url":"https://api.github.com/users/dgozman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dgozman/subscriptions","organizations_url":"https://api.github.com/users/dgozman/orgs","repos_url":"https://api.github.com/users/dgozman/repos","events_url":"https://api.github.com/users/dgozman/events{/privacy}","received_events_url":"https://api.github.com/users/dgozman/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/microsoft/playwright/issues/33077/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/microsoft/playwright/issues/33077/timeline","performed_via_github_app":null,"state_reason":"completed"}