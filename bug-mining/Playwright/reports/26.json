{"url":"https://api.github.com/repos/microsoft/playwright/issues/29402","repository_url":"https://api.github.com/repos/microsoft/playwright","labels_url":"https://api.github.com/repos/microsoft/playwright/issues/29402/labels{/name}","comments_url":"https://api.github.com/repos/microsoft/playwright/issues/29402/comments","events_url":"https://api.github.com/repos/microsoft/playwright/issues/29402/events","html_url":"https://github.com/microsoft/playwright/issues/29402","id":2123654905,"node_id":"I_kwDODTssw85-lGb5","number":29402,"title":"[Bug]: Frame is becoming detached when using browserContext.storageState()","user":{"login":"zakiRefai","id":94134112,"node_id":"U_kgDOBZxfYA","avatar_url":"https://avatars.githubusercontent.com/u/94134112?v=4","gravatar_id":"","url":"https://api.github.com/users/zakiRefai","html_url":"https://github.com/zakiRefai","followers_url":"https://api.github.com/users/zakiRefai/followers","following_url":"https://api.github.com/users/zakiRefai/following{/other_user}","gists_url":"https://api.github.com/users/zakiRefai/gists{/gist_id}","starred_url":"https://api.github.com/users/zakiRefai/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zakiRefai/subscriptions","organizations_url":"https://api.github.com/users/zakiRefai/orgs","repos_url":"https://api.github.com/users/zakiRefai/repos","events_url":"https://api.github.com/users/zakiRefai/events{/privacy}","received_events_url":"https://api.github.com/users/zakiRefai/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":6122462647,"node_id":"LA_kwDODTssw88AAAABbO1dtw","url":"https://api.github.com/repos/microsoft/playwright/labels/v1.43","name":"v1.43","color":"000000","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"dgozman","id":9881434,"node_id":"MDQ6VXNlcjk4ODE0MzQ=","avatar_url":"https://avatars.githubusercontent.com/u/9881434?v=4","gravatar_id":"","url":"https://api.github.com/users/dgozman","html_url":"https://github.com/dgozman","followers_url":"https://api.github.com/users/dgozman/followers","following_url":"https://api.github.com/users/dgozman/following{/other_user}","gists_url":"https://api.github.com/users/dgozman/gists{/gist_id}","starred_url":"https://api.github.com/users/dgozman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dgozman/subscriptions","organizations_url":"https://api.github.com/users/dgozman/orgs","repos_url":"https://api.github.com/users/dgozman/repos","events_url":"https://api.github.com/users/dgozman/events{/privacy}","received_events_url":"https://api.github.com/users/dgozman/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"dgozman","id":9881434,"node_id":"MDQ6VXNlcjk4ODE0MzQ=","avatar_url":"https://avatars.githubusercontent.com/u/9881434?v=4","gravatar_id":"","url":"https://api.github.com/users/dgozman","html_url":"https://github.com/dgozman","followers_url":"https://api.github.com/users/dgozman/followers","following_url":"https://api.github.com/users/dgozman/following{/other_user}","gists_url":"https://api.github.com/users/dgozman/gists{/gist_id}","starred_url":"https://api.github.com/users/dgozman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dgozman/subscriptions","organizations_url":"https://api.github.com/users/dgozman/orgs","repos_url":"https://api.github.com/users/dgozman/repos","events_url":"https://api.github.com/users/dgozman/events{/privacy}","received_events_url":"https://api.github.com/users/dgozman/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":6,"created_at":"2024-02-07T18:45:08Z","updated_at":"2024-03-13T02:20:37Z","closed_at":"2024-03-13T02:20:37Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Version\n\n1.38.1\n\n### Steps to reproduce\n\nUnfortunately, I am unable to give the entirety of the code to give a fully reproducible example, but I will supply everything I can and explain as much.\n\n### Expected behavior\n\nI can execute the statement below without any issues.\r\n\r\n```\r\nawait page.context().storageState({\r\n  path: <file_path>\r\n});\r\n``` \n\n### Actual behavior\n\nA frame is potentially becoming detached, not allowing me to create a storage state file to use in my other tests.\n\n### Additional context\n\nWe have an app that uses authentication. We sign into the app using Playwright and then create a storage state file from the context after the user has signed in. We can re-use the files generated to easily log in for our tests that require authentication. The authenticated tests use this sign-in process as a dependency in our project structure. All this was working just fine, but we have been recently experiencing the error below more often now. It used to occur only in our CI/CD pipeline intermittently, but now it's occurring locally.\r\n\r\n```\r\nError: browserContext.storageState: net::ERR_ABORTED; maybe frame was detached?\r\n```\r\n\r\nWe have an account pool with 7 accounts that are always used for the tests. Some of them succeed while at least two always fail (sometimes more). **BUT** it's not always the same accounts that fail to log in. Some will succeed during a run, but fail in a different run. They never fail to log into our app, they only fail during the storage state step.\r\n\r\nThis is the step where the error occurs\r\n```javascript\r\nawait test.step('Write storage state to json', async () => {\r\n  await page.context().storageState({\r\n    path: <file_path>\r\n  });\r\n});\r\n```\r\n\r\nThe step above exists in this fixture, where we first attempt to sign in then create the storage state file.\r\n```javascript\r\nexport const createStorageStateFromSignIn: TestFixture<\r\n  (account: Account) => Promise<void>,\r\n  PlaywrightFixtures\r\n> = async ({ signInWithVerificationCode, page }, use) => {\r\n  await use(async (account: Account) => {\r\n    await test.step('Authenticate user', async () => {\r\n      await signInWithVerificationCode(account);\r\n    });\r\n\r\n    await test.step('Write storage state to json', async () => {\r\n      await page.context().storageState({\r\n        path: <file_path\r\n      });\r\n    });\r\n  });\r\n};\r\n```\r\n\r\nBelow is the `signInWithVerificationCode` fixture. It handles signing the user in and waiting for the authenticated home URL to appear.\r\n```javascript\r\nexport const signInWithVerificationCode: TestFixture<\r\n  (account: Account) => Promise<void>,\r\n  PlaywrightFixtures\r\n> = async (\r\n  {\r\n    page,\r\n    unauthHomePage,\r\n    appHeader,\r\n    sideMenu,\r\n    signInPage,\r\n    useVerificationCode\r\n  },\r\n  use\r\n) => {\r\n  await use(async (account: Account) => {\r\n    await test.step('Go to Sign In page', async () => {\r\n      await unauthHomePage.goTo();\r\n      await appHeader.clickHamburger();\r\n      await sideMenu.clickSignIn();\r\n    });\r\n\r\n    await test.step('Sign in with account credentials', async () => {\r\n      await signInPage.signInWithCredentials(account);\r\n    });\r\n\r\n    await test.step('Step through one time password page', async () => {\r\n      await useVerificationCode(account);\r\n    });\r\n\r\n    await test.step('Expect to be on auth home page url', async () => {\r\n      await page.waitForURL('/home', { timeout: 30000 });\r\n    });\r\n  });\r\n};\r\n```\r\n\r\nLastly, this is where it starts. We run our account setup project and each account is ran with this statement\r\n```javascript\r\nsetup(\r\n  'Login user 1',\r\n  async ({ getAccountFromFileOrService, createStorageStateFromSignIn }) => {\r\n    const account1 = await getAccountFromFileOrService(TEST_SETTINGS.account1);\r\n    await createStorageStateFromSignIn(account1);\r\n  }\r\n);\r\n```\r\n\r\nI do not understand how the frame is becoming detached in between the steps of \"Authenticate user\" and \"Write storage state to JSON\" in the `createStorageStateFromSignIn` fixture. I attempted to modify the \"Write storage state to JSON\" step like so:\r\n\r\n```javascript\r\nawait test.step('Write storage state to json', async () => {\r\n  console.log(page.mainFrame().isDetached())\r\n  await page.context().storageState({\r\n    path: <file_path>\r\n  });\r\n  await page.close()\r\n});\r\n```\r\n\r\nFor all of the test runs, the `isDetached()` function **ALWAYS** returns `false`, but just when it runs `.storageState({...})` it throws the error at the top stating that the frame may be detached.\r\n\r\nI am unable to figure out why this occurs. Here is what I have tried:\r\n- Upgrading to 1.41.1\r\n- Downgrading\r\n- Checked all steps to verify that all promises have awaits and that they resolve properly\r\n\r\nThe problem persists under the things that I have tried. Any help would be much appreciated as I am stuck.\n\n### Environment\n\n```shell\nSystem:\r\n    OS: macOS 13.6.1\r\n    CPU: (12) x64 Intel(R) Core(TM) i7-9750H CPU @ 2.60GHz\r\n    Memory: 3.27 GB / 32.00 GB\r\n  Binaries:\r\n    Node: 16.19.1 - /usr/local/bin/node\r\n    Yarn: 1.22.19 - ~/.yarn/bin/yarn\r\n    npm: 8.19.3 - /usr/local/bin/npm\r\n    pnpm: 7.26.3 - ~/Library/pnpm/pnpm\r\n  Languages:\r\n    Bash: 3.2.57 - /bin/bash\r\n  npmPackages:\r\n    @playwright/test: ~1.38.1 => 1.38.1 \r\n    playwright: ~1.38.1 => 1.38.1\n```\n","closed_by":{"login":"dgozman","id":9881434,"node_id":"MDQ6VXNlcjk4ODE0MzQ=","avatar_url":"https://avatars.githubusercontent.com/u/9881434?v=4","gravatar_id":"","url":"https://api.github.com/users/dgozman","html_url":"https://github.com/dgozman","followers_url":"https://api.github.com/users/dgozman/followers","following_url":"https://api.github.com/users/dgozman/following{/other_user}","gists_url":"https://api.github.com/users/dgozman/gists{/gist_id}","starred_url":"https://api.github.com/users/dgozman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dgozman/subscriptions","organizations_url":"https://api.github.com/users/dgozman/orgs","repos_url":"https://api.github.com/users/dgozman/repos","events_url":"https://api.github.com/users/dgozman/events{/privacy}","received_events_url":"https://api.github.com/users/dgozman/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/microsoft/playwright/issues/29402/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/microsoft/playwright/issues/29402/timeline","performed_via_github_app":null,"state_reason":"completed"}