{"url":"https://api.github.com/repos/microsoft/playwright/issues/30693","repository_url":"https://api.github.com/repos/microsoft/playwright","labels_url":"https://api.github.com/repos/microsoft/playwright/issues/30693/labels{/name}","comments_url":"https://api.github.com/repos/microsoft/playwright/issues/30693/comments","events_url":"https://api.github.com/repos/microsoft/playwright/issues/30693/events","html_url":"https://github.com/microsoft/playwright/issues/30693","id":2283716335,"node_id":"I_kwDODTssw86IHr7v","number":30693,"title":"[Bug]: Missing expected reference snapshot file name (PW does not pass the info to a reporter).","user":{"login":"chekrd","id":25004106,"node_id":"MDQ6VXNlcjI1MDA0MTA2","avatar_url":"https://avatars.githubusercontent.com/u/25004106?v=4","gravatar_id":"","url":"https://api.github.com/users/chekrd","html_url":"https://github.com/chekrd","followers_url":"https://api.github.com/users/chekrd/followers","following_url":"https://api.github.com/users/chekrd/following{/other_user}","gists_url":"https://api.github.com/users/chekrd/gists{/gist_id}","starred_url":"https://api.github.com/users/chekrd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chekrd/subscriptions","organizations_url":"https://api.github.com/users/chekrd/orgs","repos_url":"https://api.github.com/users/chekrd/repos","events_url":"https://api.github.com/users/chekrd/events{/privacy}","received_events_url":"https://api.github.com/users/chekrd/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":2167339959,"node_id":"MDU6TGFiZWwyMTY3MzM5OTU5","url":"https://api.github.com/repos/microsoft/playwright/labels/P3-collecting-feedback","name":"P3-collecting-feedback","color":"0e8a16","default":false,"description":""},{"id":3606382663,"node_id":"LA_kwDODTssw87W9QhH","url":"https://api.github.com/repos/microsoft/playwright/labels/feature-visual-regression-testing","name":"feature-visual-regression-testing","color":"D4C5F9","default":false,"description":""},{"id":6980424585,"node_id":"LA_kwDODTssw88AAAABoBDTiQ","url":"https://api.github.com/repos/microsoft/playwright/labels/v1.46","name":"v1.46","color":"000000","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"dgozman","id":9881434,"node_id":"MDQ6VXNlcjk4ODE0MzQ=","avatar_url":"https://avatars.githubusercontent.com/u/9881434?v=4","gravatar_id":"","url":"https://api.github.com/users/dgozman","html_url":"https://github.com/dgozman","followers_url":"https://api.github.com/users/dgozman/followers","following_url":"https://api.github.com/users/dgozman/following{/other_user}","gists_url":"https://api.github.com/users/dgozman/gists{/gist_id}","starred_url":"https://api.github.com/users/dgozman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dgozman/subscriptions","organizations_url":"https://api.github.com/users/dgozman/orgs","repos_url":"https://api.github.com/users/dgozman/repos","events_url":"https://api.github.com/users/dgozman/events{/privacy}","received_events_url":"https://api.github.com/users/dgozman/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"dgozman","id":9881434,"node_id":"MDQ6VXNlcjk4ODE0MzQ=","avatar_url":"https://avatars.githubusercontent.com/u/9881434?v=4","gravatar_id":"","url":"https://api.github.com/users/dgozman","html_url":"https://github.com/dgozman","followers_url":"https://api.github.com/users/dgozman/followers","following_url":"https://api.github.com/users/dgozman/following{/other_user}","gists_url":"https://api.github.com/users/dgozman/gists{/gist_id}","starred_url":"https://api.github.com/users/dgozman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dgozman/subscriptions","organizations_url":"https://api.github.com/users/dgozman/orgs","repos_url":"https://api.github.com/users/dgozman/repos","events_url":"https://api.github.com/users/dgozman/events{/privacy}","received_events_url":"https://api.github.com/users/dgozman/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":4,"created_at":"2024-05-07T15:58:17Z","updated_at":"2024-07-18T09:42:45Z","closed_at":"2024-07-18T09:42:45Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Version\r\n\r\nStarted in 1.43.0\r\n\r\n### Steps to reproduce\r\n\r\n1. Clone a minimal repro repo https://github.com/chekrd/pw-snapshot-name\r\n2. Run `npm ci`.\r\n3. Be sure the `./snapshots` directory is empty or deleted.\r\n4. Run `npm run playwright` (runs the test and fails).\r\n\r\n### Expected behavior\r\n\r\nI have two versions of what to expect.\r\n\r\nA. (preferred)\r\nReference snapshots are generated with the same name as for test result attachments (without the `-reference` suffix, as it is now).\r\n\r\nB.\r\nReporters can access the expected reference snapshot file name through `testResult` or `testCase`. Right now, we can only parse the value from `testCase.errors` which is inconvenient and unstable as the error message can change and is not meant for further processing.\r\n\r\n### Actual behavior\r\n\r\nAfter the step 4:\r\n\r\n✅ The test failed because the reference snapshot is missing.\r\n\r\nSee the console output, it contains the `testResult` and `testCase` objects from a custom reporter `./reporters/screenComparisonReporter.ts`.\r\n\r\nWhat PW gives to our custom reporter through `testResult.attachments`:\r\n```\r\n[{\r\n  name: 'Agenda-view-displays-empty-dac89-t-when-inventory-is-empty-1-actual.png',\r\n  path: '/<your path>/pw-snapshot-name/test-results/src-AgendaView.uitest.tsx--2ce5e-ent-when-inventory-is-empty-chromium/Agenda-view-displays-empty-dac89-t-when-inventory-is-empty-1-actual.png',\r\n  contentType: 'image/png',\r\n  body: undefined\r\n}],\r\n```\r\n✅ Test result attachment name is shortened (\"dac89\" part), which is correct because it exceeded 60 characters name length limit (covered in https://github.com/microsoft/playwright/issues/29719, released in v1.43).\r\n\r\n❌ PW creates different snapshot reference name (Agenda-view-displays-empty-state-picture-instead-of-the-content-when-inventory-is-empty-1-chromium.png in this example, run `npm run playwright-update-snapshots` and see the `./snapshots` content - **the name is not shortened**). Because of this, we can't know what reference snapshot is missing.\r\n\r\nThe only mention of the expected reference image is in testCase.errors:\r\n```\r\nmessage: \"Error: A snapshot doesn't exist at /<your path>/pw-snapshot-name/snapshots/Agenda-view-displays-empty-state-picture-instead-of-the-content-when-inventory-is-empty-1-chromium.png, writing actual.\",\r\n      stack: \"Error: A snapshot doesn't exist at /<your path>/pw-snapshot-name/snapshots/Agenda-view-displays-empty-state-picture-instead-of-the-content-when-inventory-is-empty-1-chromium.png, writing actual.\\n\" +\r\n        '    at /<your path>/pw-snapshot-name/src/AgendaView.uitest.tsx:9:7',\r\n```\r\n\r\n### But in previous PW versions...\r\nFor this example, changing the PW version back to 1.42 results in a `testResult.attachment` names we can work with. We know, that we can take \"Agenda-view-displays-empty-state-picture-instead-of-the-content-when-inventory-is-empty-1\" part, add a platform name and we have recreated the reference snapshot name PW expects in `./snapshots` directory (Agenda-view-displays-empty-state-picture-instead-of-the-content-when-inventory-is-empty-1-chromium.png):\r\n```\r\n[{\r\n  name: 'Agenda-view-displays-empty-state-picture-instead-of-the-content-when-inventory-is-empty-1-actual.png',\r\n  path: '/<your path>/pw-snapshot-name/test-results/src-AgendaView.uitest.tsx-Agenda-view-displays-2ce5e--instead-of-the-content-when-inventory-is-empty-chromium/Agenda-view-displays-empty-state-picture-instead-of-the-content-when-inventory-is-empty-1-actual.png',\r\n  contentType: 'image/png',\r\n  body: undefined\r\n}]\r\n```\r\n\r\nThere is a chance that our approach is not right. But the test result attachments from PW@1.43+ are barely usable. Are there other ways to achieve it?\r\n\r\n### Additional context\r\n\r\nPW snapshots taken in macOS and Windows do not match. We have mixed developer environments, so we decided to have a central point for generating PW snapshots that run only on Windows.\r\nThen we have a custom PW reporter for processing snapshot errors. It maps the PW test result output to our screen comparison service, in which developers can see the difference in a browser and resolve all issues (apply the `-actual` snapshot as a new source of truth or fix it in the code). But because PW test result attachment names do not match the PW snapshot generator, we cannot apply the new snapshot version if the reference is not yet created because we don't know what name PW expects in the `./snapshot` directory. We need the information for renaming the `-actual` attachment to the snapshot reference and committing it to the `./snapshots` in the repository.\r\n\r\n### Environment\r\n\r\n```shell\r\nSystem:\r\n    OS: macOS 14.4.1\r\n    CPU: (10) arm64 Apple M1 Pro\r\n    Memory: 43.33 MB / 16.00 GB\r\n  Binaries:\r\n    Node: 22.1.0 - ~/.nvm/versions/node/v22.1.0/bin/node\r\n    npm: 10.7.0 - ~/.nvm/versions/node/v22.1.0/bin/npm\r\n  Languages:\r\n    Bash: 3.2.57 - /bin/bash\r\n  npmPackages:\r\n    @playwright/experimental-ct-react: 1.44.0 => 1.44.0\r\n    @playwright/test: 1.44.0 => 1.44.0\r\n```\r\n","closed_by":{"login":"dgozman","id":9881434,"node_id":"MDQ6VXNlcjk4ODE0MzQ=","avatar_url":"https://avatars.githubusercontent.com/u/9881434?v=4","gravatar_id":"","url":"https://api.github.com/users/dgozman","html_url":"https://github.com/dgozman","followers_url":"https://api.github.com/users/dgozman/followers","following_url":"https://api.github.com/users/dgozman/following{/other_user}","gists_url":"https://api.github.com/users/dgozman/gists{/gist_id}","starred_url":"https://api.github.com/users/dgozman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dgozman/subscriptions","organizations_url":"https://api.github.com/users/dgozman/orgs","repos_url":"https://api.github.com/users/dgozman/repos","events_url":"https://api.github.com/users/dgozman/events{/privacy}","received_events_url":"https://api.github.com/users/dgozman/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/microsoft/playwright/issues/30693/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/microsoft/playwright/issues/30693/timeline","performed_via_github_app":null,"state_reason":"completed"}