{"url":"https://api.github.com/repos/microsoft/playwright/issues/30229","repository_url":"https://api.github.com/repos/microsoft/playwright","labels_url":"https://api.github.com/repos/microsoft/playwright/issues/30229/labels{/name}","comments_url":"https://api.github.com/repos/microsoft/playwright/issues/30229/comments","events_url":"https://api.github.com/repos/microsoft/playwright/issues/30229/events","html_url":"https://github.com/microsoft/playwright/issues/30229","id":2223847166,"node_id":"I_kwDODTssw86EjTb-","number":30229,"title":"[Bug]: New page event handler doesn't catch first request in new tab","user":{"login":"marshmn","id":4307033,"node_id":"MDQ6VXNlcjQzMDcwMzM=","avatar_url":"https://avatars.githubusercontent.com/u/4307033?v=4","gravatar_id":"","url":"https://api.github.com/users/marshmn","html_url":"https://github.com/marshmn","followers_url":"https://api.github.com/users/marshmn/followers","following_url":"https://api.github.com/users/marshmn/following{/other_user}","gists_url":"https://api.github.com/users/marshmn/gists{/gist_id}","starred_url":"https://api.github.com/users/marshmn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marshmn/subscriptions","organizations_url":"https://api.github.com/users/marshmn/orgs","repos_url":"https://api.github.com/users/marshmn/repos","events_url":"https://api.github.com/users/marshmn/events{/privacy}","received_events_url":"https://api.github.com/users/marshmn/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2024-04-03T20:28:16Z","updated_at":"2024-04-04T16:23:22Z","closed_at":"2024-04-04T16:23:22Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### Version\n\n1.42.1\n\n### Steps to reproduce\n\nI've created an override for the default `context` fixture, which adds an event handler for the `page` event. The handler adds an additional header to any requests made via the new page.\r\n\r\nThis seems to work for most scenarios, such as:\r\n- Tests using the normal `page` fixture\r\n- New pages created explicitly from a call to `context.newPage()`\r\n\r\nHowever, in a scenario where a new page is created through clicking on a link with a `target=\"_blank\"` attribute, the event handler doesn't appear to fire fast enough to catch the first request to the new page. It does appear to have fired by the time subsequent requests to that same new page are made.\r\n\r\nHere are some example scenarios:\r\n```typescript\r\nimport { test as base } from \"@playwright/test\";\r\n\r\nexport const test = base.extend({\r\n    context: async ({ context }, use) => {\r\n        context.on(\"page\", async (page) => {\r\n            await page.route(\r\n                new RegExp(\".*\"),\r\n                (route, request) => {\r\n                    const headers = {\r\n                        ...request.headers(),\r\n                        \"X-Foo\": \"bar\",\r\n                    };\r\n                    void route.continue({ headers });\r\n                },\r\n            );\r\n        });\r\n        await use(context);\r\n    },\r\n});\r\n\r\ntest(\"scenario 1\", async ({ page }) => {\r\n    // Use page fixture\r\n    // SUCCESS: header appears in request as expected\r\n    await page.goto(\"/\");\r\n});\r\n\r\ntest(\"scenario 2\", async ({ context }) => {\r\n    // Create page object from context\r\n    // SUCCESS: header appears in request as expected\r\n    const page = await context.newPage();\r\n    await page.goto(\"/\");\r\n});\r\n\r\ntest(\"scenario 3\", async ({ page, context }) => {\r\n    await page.goto(\"/\");\r\n\r\n    // Click link with `target=\"_blank\"` attribute to open new tab\r\n    // FAIL: header does **not** appear in request on new page object (newPage)\r\n    const pagePromise = context.waitForEvent(\"page\");\r\n    await page.getByRole(\"link\", { name: \"Link\" }).click();\r\n    const newPage = await pagePromise;\r\n    await newPage.waitForLoadState();\r\n\r\n    // SUCCESS: header appears in subsequent requests using same page object\r\n    await newPage.goto(\"/\");\r\n});\r\n```\r\n\r\nI've also created an example repo with this code: https://github.com/marshmn/pw-new-page-event-test\r\n\n\n### Expected behavior\n\nI would expect the `X-Foo: bar` header to appear in all requests.\n\n### Actual behavior\n\nIn the 3rd scenario above, there are 3 requests - the header appears in the first and third request, but not in the second request (which is the one which actually initiates the new page via click on link with `target=\"_blank\"` attribute.\r\n\n\n### Additional context\n\nI've collected a trace file for scenario 3: \r\n[trace.zip](https://github.com/microsoft/playwright/files/14858166/trace.zip)\r\n\r\nIn that trace, the network tab shows the first and third requests with blue background - the second with white (I'm not sure what this signifies, but I'm guessing it has some relevance...).\r\n\r\n![Screenshot from 2024-04-03 21-11-54](https://github.com/microsoft/playwright/assets/4307033/8447c3d0-dc05-430c-b475-ba3cd227a100)\r\n\n\n### Environment\n\n```shell\nSystem:\r\n  OS: Linux 5.11 Debian GNU/Linux 12 (bookworm) 12 (bookworm)\r\n  CPU: (12) x64 Intel(R) Core(TM) i7-9750H CPU @ 2.60GHz\r\n  Memory: 11.63 GB / 31.00 GB\r\n  Container: Yes\r\nBinaries:\r\n  Node: 20.12.0 - /usr/local/bin/node\r\n  Yarn: 1.22.19 - /usr/local/bin/yarn\r\n  npm: 10.5.0 - /usr/local/bin/npm\r\nLanguages:\r\n  Bash: 5.2.15 - /usr/bin/bash\r\nnpmPackages:\r\n  @playwright/test: ^1.42.1 => 1.42.1\n```\n","closed_by":{"login":"dgozman","id":9881434,"node_id":"MDQ6VXNlcjk4ODE0MzQ=","avatar_url":"https://avatars.githubusercontent.com/u/9881434?v=4","gravatar_id":"","url":"https://api.github.com/users/dgozman","html_url":"https://github.com/dgozman","followers_url":"https://api.github.com/users/dgozman/followers","following_url":"https://api.github.com/users/dgozman/following{/other_user}","gists_url":"https://api.github.com/users/dgozman/gists{/gist_id}","starred_url":"https://api.github.com/users/dgozman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dgozman/subscriptions","organizations_url":"https://api.github.com/users/dgozman/orgs","repos_url":"https://api.github.com/users/dgozman/repos","events_url":"https://api.github.com/users/dgozman/events{/privacy}","received_events_url":"https://api.github.com/users/dgozman/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/microsoft/playwright/issues/30229/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/microsoft/playwright/issues/30229/timeline","performed_via_github_app":null,"state_reason":"completed"}