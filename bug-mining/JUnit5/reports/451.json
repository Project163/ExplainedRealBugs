{"url":"https://api.github.com/repos/junit-team/junit-framework/issues/2597","repository_url":"https://api.github.com/repos/junit-team/junit-framework","labels_url":"https://api.github.com/repos/junit-team/junit-framework/issues/2597/labels{/name}","comments_url":"https://api.github.com/repos/junit-team/junit-framework/issues/2597/comments","events_url":"https://api.github.com/repos/junit-team/junit-framework/issues/2597/events","html_url":"https://github.com/junit-team/junit-framework/issues/2597","id":859643015,"node_id":"MDU6SXNzdWU4NTk2NDMwMTU=","number":2597,"title":"Support AutoCloseable for arguments provided to a @ParameterizedTest","user":{"login":"sbrannen","id":104798,"node_id":"MDQ6VXNlcjEwNDc5OA==","avatar_url":"https://avatars.githubusercontent.com/u/104798?v=4","gravatar_id":"","url":"https://api.github.com/users/sbrannen","html_url":"https://github.com/sbrannen","followers_url":"https://api.github.com/users/sbrannen/followers","following_url":"https://api.github.com/users/sbrannen/following{/other_user}","gists_url":"https://api.github.com/users/sbrannen/gists{/gist_id}","starred_url":"https://api.github.com/users/sbrannen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sbrannen/subscriptions","organizations_url":"https://api.github.com/users/sbrannen/orgs","repos_url":"https://api.github.com/users/sbrannen/repos","events_url":"https://api.github.com/users/sbrannen/events{/privacy}","received_events_url":"https://api.github.com/users/sbrannen/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":165165180,"node_id":"MDU6TGFiZWwxNjUxNjUxODA=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/type:%20enhancement","name":"type: enhancement","color":"84b6eb","default":false,"description":null},{"id":420911923,"node_id":"MDU6TGFiZWw0MjA5MTE5MjM=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/component:%20Jupiter","name":"component: Jupiter","color":"11ee99","default":false,"description":null},{"id":747276013,"node_id":"MDU6TGFiZWw3NDcyNzYwMTM=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/theme:%20parameterized%20tests","name":"theme: parameterized tests","color":"9e9dea","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"juliette-derancourt","id":28359762,"node_id":"MDQ6VXNlcjI4MzU5NzYy","avatar_url":"https://avatars.githubusercontent.com/u/28359762?v=4","gravatar_id":"","url":"https://api.github.com/users/juliette-derancourt","html_url":"https://github.com/juliette-derancourt","followers_url":"https://api.github.com/users/juliette-derancourt/followers","following_url":"https://api.github.com/users/juliette-derancourt/following{/other_user}","gists_url":"https://api.github.com/users/juliette-derancourt/gists{/gist_id}","starred_url":"https://api.github.com/users/juliette-derancourt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/juliette-derancourt/subscriptions","organizations_url":"https://api.github.com/users/juliette-derancourt/orgs","repos_url":"https://api.github.com/users/juliette-derancourt/repos","events_url":"https://api.github.com/users/juliette-derancourt/events{/privacy}","received_events_url":"https://api.github.com/users/juliette-derancourt/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"juliette-derancourt","id":28359762,"node_id":"MDQ6VXNlcjI4MzU5NzYy","avatar_url":"https://avatars.githubusercontent.com/u/28359762?v=4","gravatar_id":"","url":"https://api.github.com/users/juliette-derancourt","html_url":"https://github.com/juliette-derancourt","followers_url":"https://api.github.com/users/juliette-derancourt/followers","following_url":"https://api.github.com/users/juliette-derancourt/following{/other_user}","gists_url":"https://api.github.com/users/juliette-derancourt/gists{/gist_id}","starred_url":"https://api.github.com/users/juliette-derancourt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/juliette-derancourt/subscriptions","organizations_url":"https://api.github.com/users/juliette-derancourt/orgs","repos_url":"https://api.github.com/users/juliette-derancourt/repos","events_url":"https://api.github.com/users/juliette-derancourt/events{/privacy}","received_events_url":"https://api.github.com/users/juliette-derancourt/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/junit-team/junit-framework/milestones/55","html_url":"https://github.com/junit-team/junit-framework/milestone/55","labels_url":"https://api.github.com/repos/junit-team/junit-framework/milestones/55/labels","id":6429412,"node_id":"MDk6TWlsZXN0b25lNjQyOTQxMg==","number":55,"title":"5.8 RC1","description":"","creator":{"login":"marcphilipp","id":214207,"node_id":"MDQ6VXNlcjIxNDIwNw==","avatar_url":"https://avatars.githubusercontent.com/u/214207?v=4","gravatar_id":"","url":"https://api.github.com/users/marcphilipp","html_url":"https://github.com/marcphilipp","followers_url":"https://api.github.com/users/marcphilipp/followers","following_url":"https://api.github.com/users/marcphilipp/following{/other_user}","gists_url":"https://api.github.com/users/marcphilipp/gists{/gist_id}","starred_url":"https://api.github.com/users/marcphilipp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcphilipp/subscriptions","organizations_url":"https://api.github.com/users/marcphilipp/orgs","repos_url":"https://api.github.com/users/marcphilipp/repos","events_url":"https://api.github.com/users/marcphilipp/events{/privacy}","received_events_url":"https://api.github.com/users/marcphilipp/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":40,"state":"closed","created_at":"2021-02-13T19:49:34Z","updated_at":"2021-08-17T17:47:37Z","due_on":"2021-08-17T07:00:00Z","closed_at":"2021-08-17T17:47:37Z"},"comments":1,"created_at":"2021-04-16T09:30:57Z","updated_at":"2021-07-16T08:24:43Z","closed_at":"2021-07-13T14:29:36Z","author_association":"MEMBER","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Overview\r\n\r\nSometimes the arguments provided to a `@ParameterizedTest` are resources that need to be cleaned up after each invocation of the parameterized test -- for example, when testing against various implementations of an API. However, it is currently not possible to clean up such resources without duplicated logic in each `@ParameterizedTest` method that makes use of the arguments source.\r\n\r\nOne _could_ store the argument injected into the `@ParameterizedTest` method in a field and then access that field within an `@AfterEach` method, but that is more work than simply invoking the cleanup method directly from within each `@ParameterizedTest` method. The following simplified example demonstrates the latter approach.\r\n\r\n```java\r\nclass ServerTests {\r\n\r\n\t@ServerTest\r\n\tvoid json(Server server) {\r\n\t\tserver.handleRequest(\"JSON\");\r\n\t\tserver.shutdown();\r\n\t}\r\n\r\n\t@ServerTest\r\n\tvoid xml(Server server) {\r\n\t\tserver.handleRequest(\"XML\");\r\n\t\tserver.shutdown();\r\n\t}\r\n\r\n\r\n\tprivate interface Server {\r\n\r\n\t\tdefault void handleRequest(String data) {\r\n\t\t\tSystem.out.println(\"Request: \" + data + \" for \" + getClass().getSimpleName());\r\n\t\t}\r\n\r\n\t\tdefault void shutdown() {\r\n\t\t\tSystem.out.println(\"Shutting down \" + getClass().getSimpleName());\r\n\t\t}\r\n\t}\r\n\r\n\tprivate static class MockServer implements Server {\r\n\t}\r\n\r\n\tprivate static class RealServer implements Server {\r\n\t}\r\n\r\n\r\n\t@Retention(RetentionPolicy.RUNTIME)\r\n\t@ParameterizedTest\r\n\t@MethodSource(\"servers\")\r\n\t@interface ServerTest {\r\n\t}\r\n\r\n\tstatic Stream<Server> servers() {\r\n\t\treturn Stream.of(new MockServer(), new RealServer());\r\n\t}\r\n\r\n}\r\n```\r\n\r\nThe following are the results of executing the above test class.\r\n\r\n```\r\nRequest: XML for MockServer\r\nShutting down MockServer\r\nRequest: XML for RealServer\r\nShutting down RealServer\r\nRequest: JSON for MockServer\r\nShutting down MockServer\r\nRequest: JSON for RealServer\r\nShutting down RealServer\r\n```\r\n\r\nIf we want to automate the shutdown of each server, we can implement a custom `ArgumentsProvider` that stores the arguments in the `ExtensionContext.Store` and modify the `Server` interface so that it extends `CloseableResource`. The following example demonstrates this approach.\r\n\r\n```java\r\nclass ServerTests {\r\n\r\n\t@ServerTest\r\n\tvoid json(Server server) {\r\n\t\tserver.handleRequest(\"JSON\");\r\n\t}\r\n\r\n\t@ServerTest\r\n\tvoid xml(Server server) {\r\n\t\tserver.handleRequest(\"XML\");\r\n\t}\r\n\r\n\r\n\tprivate interface Server extends CloseableResource {\r\n\r\n\t\tdefault void handleRequest(String data) {\r\n\t\t\tSystem.out.println(\"Request: \" + data + \" for \" + getClass().getSimpleName());\r\n\t\t}\r\n\r\n\t\tdefault void shutdown() {\r\n\t\t\tSystem.out.println(\"Shutting down \" + getClass().getSimpleName());\r\n\t\t}\r\n\r\n\t\t@Override\r\n\t\tdefault void close() {\r\n\t\t\tshutdown();\r\n\t\t}\r\n\t}\r\n\r\n\tprivate static class MockServer implements Server {\r\n\t}\r\n\r\n\tprivate static class RealServer implements Server {\r\n\t}\r\n\r\n\t@Target(ElementType.METHOD)\r\n\t@Retention(RetentionPolicy.RUNTIME)\r\n\t@ParameterizedTest\r\n\t@ArgumentsSource(ServerArgumentsProvider.class)\r\n\t@interface ServerTest {\r\n\t}\r\n\r\n\tstatic class ServerArgumentsProvider implements ArgumentsProvider {\r\n\r\n\t\tprivate static final Namespace namespace = Namespace.create(ServerArgumentsProvider.class);\r\n\r\n\t\t@Override\r\n\t\tpublic Stream<? extends Arguments> provideArguments(ExtensionContext context) {\r\n\t\t\tMockServer mockServer = new MockServer();\r\n\t\t\tRealServer realServer = new RealServer();\r\n\t\t\tcontext.getStore(namespace).put(\"mockServer\", mockServer);\r\n\t\t\tcontext.getStore(namespace).put(\"realServer\", realServer);\r\n\t\t\treturn Stream.of(arguments(mockServer), arguments(realServer));\r\n\t\t}\r\n\t}\r\n}\r\n```\r\n\r\nThe following are the results of executing the above test class.\r\n\r\n```\r\nRequest: XML for MockServer\r\nRequest: XML for RealServer\r\nShutting down RealServer\r\nShutting down MockServer\r\nRequest: JSON for MockServer\r\nRequest: JSON for RealServer\r\nShutting down RealServer\r\nShutting down MockServer\r\n```\r\n\r\nHere we see that the `Server` instances are in fact automatically shut down; however, there are two undesired side effects of this approach:\r\n\r\n1. Each `Server` instance is held onto until after _all_ invocations of a given `@ParameterizedTest` have completed.\r\n2. The `Server` instances are closed/shut down in reverse order.\r\n\r\nThe latter is due to a feature of the `ExtensionContext.Store` that supports \"wrapping\" of closable resources, so that behavior is to be expected in this scenario, but it may not be acceptable depending on the actual use case.\r\n\r\nAside from the above runtime side effects, the implementation requires a lot of boilerplate code to get working.\r\n\r\n## Proposal\r\n\r\nTo simplify such use cases, we should invoke the `close()` method on any `CloseableResource` (or `java.lang.AutoCloseable`) that is provided as an argument to a `@ParameterizedTest`, and that should occur after each invocation of the `@ParameterizedTest` method. Doing so would allow the original `ServerTest` example to be implemented using `@MethodSource` and having the `Server` extend `CloseableResource` without the need for a custom `ArgumentsProvider` and avoiding direct interaction with the `ExtensionContext.Store`.\r\n\r\n## Deliverables\r\n\r\n- [x] Support `java.lang.AutoCloseable` for `@ParameterizedTest` arguments, enabled by default but configurable via a new `autoCloseArguments` attribute in the `@ParameterizedTest` annotation.\r\n","closed_by":{"login":"juliette-derancourt","id":28359762,"node_id":"MDQ6VXNlcjI4MzU5NzYy","avatar_url":"https://avatars.githubusercontent.com/u/28359762?v=4","gravatar_id":"","url":"https://api.github.com/users/juliette-derancourt","html_url":"https://github.com/juliette-derancourt","followers_url":"https://api.github.com/users/juliette-derancourt/followers","following_url":"https://api.github.com/users/juliette-derancourt/following{/other_user}","gists_url":"https://api.github.com/users/juliette-derancourt/gists{/gist_id}","starred_url":"https://api.github.com/users/juliette-derancourt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/juliette-derancourt/subscriptions","organizations_url":"https://api.github.com/users/juliette-derancourt/orgs","repos_url":"https://api.github.com/users/juliette-derancourt/repos","events_url":"https://api.github.com/users/juliette-derancourt/events{/privacy}","received_events_url":"https://api.github.com/users/juliette-derancourt/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/junit-team/junit-framework/issues/2597/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/junit-team/junit-framework/issues/2597/timeline","performed_via_github_app":null,"state_reason":"completed"}