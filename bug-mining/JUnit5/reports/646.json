{"url":"https://api.github.com/repos/junit-team/junit-framework/issues/4020","repository_url":"https://api.github.com/repos/junit-team/junit-framework","labels_url":"https://api.github.com/repos/junit-team/junit-framework/issues/4020/labels{/name}","comments_url":"https://api.github.com/repos/junit-team/junit-framework/issues/4020/comments","events_url":"https://api.github.com/repos/junit-team/junit-framework/issues/4020/events","html_url":"https://github.com/junit-team/junit-framework/issues/4020","id":2545769268,"node_id":"I_kwDOAbwRH86XvVs0","number":4020,"title":"Reduce stack utilization by getting rid of outer Stream API call in TestTemplateTestDescriptor::execute","user":{"login":"amaembo","id":5114450,"node_id":"MDQ6VXNlcjUxMTQ0NTA=","avatar_url":"https://avatars.githubusercontent.com/u/5114450?v=4","gravatar_id":"","url":"https://api.github.com/users/amaembo","html_url":"https://github.com/amaembo","followers_url":"https://api.github.com/users/amaembo/followers","following_url":"https://api.github.com/users/amaembo/following{/other_user}","gists_url":"https://api.github.com/users/amaembo/gists{/gist_id}","starred_url":"https://api.github.com/users/amaembo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amaembo/subscriptions","organizations_url":"https://api.github.com/users/amaembo/orgs","repos_url":"https://api.github.com/users/amaembo/repos","events_url":"https://api.github.com/users/amaembo/events{/privacy}","received_events_url":"https://api.github.com/users/amaembo/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":165165180,"node_id":"MDU6TGFiZWwxNjUxNjUxODA=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/type:%20enhancement","name":"type: enhancement","color":"84b6eb","default":false,"description":null},{"id":293488747,"node_id":"MDU6TGFiZWwyOTM0ODg3NDc=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/theme:%20execution","name":"theme: execution","color":"fbca04","default":false,"description":null},{"id":420911923,"node_id":"MDU6TGFiZWw0MjA5MTE5MjM=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/component:%20Jupiter","name":"component: Jupiter","color":"11ee99","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"amaembo","id":5114450,"node_id":"MDQ6VXNlcjUxMTQ0NTA=","avatar_url":"https://avatars.githubusercontent.com/u/5114450?v=4","gravatar_id":"","url":"https://api.github.com/users/amaembo","html_url":"https://github.com/amaembo","followers_url":"https://api.github.com/users/amaembo/followers","following_url":"https://api.github.com/users/amaembo/following{/other_user}","gists_url":"https://api.github.com/users/amaembo/gists{/gist_id}","starred_url":"https://api.github.com/users/amaembo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amaembo/subscriptions","organizations_url":"https://api.github.com/users/amaembo/orgs","repos_url":"https://api.github.com/users/amaembo/repos","events_url":"https://api.github.com/users/amaembo/events{/privacy}","received_events_url":"https://api.github.com/users/amaembo/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"amaembo","id":5114450,"node_id":"MDQ6VXNlcjUxMTQ0NTA=","avatar_url":"https://avatars.githubusercontent.com/u/5114450?v=4","gravatar_id":"","url":"https://api.github.com/users/amaembo","html_url":"https://github.com/amaembo","followers_url":"https://api.github.com/users/amaembo/followers","following_url":"https://api.github.com/users/amaembo/following{/other_user}","gists_url":"https://api.github.com/users/amaembo/gists{/gist_id}","starred_url":"https://api.github.com/users/amaembo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amaembo/subscriptions","organizations_url":"https://api.github.com/users/amaembo/orgs","repos_url":"https://api.github.com/users/amaembo/repos","events_url":"https://api.github.com/users/amaembo/events{/privacy}","received_events_url":"https://api.github.com/users/amaembo/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/junit-team/junit-framework/milestones/75","html_url":"https://github.com/junit-team/junit-framework/milestone/75","labels_url":"https://api.github.com/repos/junit-team/junit-framework/milestones/75/labels","id":10506226,"node_id":"MI_kwDOAbwRH84AoE_y","number":75,"title":"5.12.0-M1","description":"","creator":{"login":"marcphilipp","id":214207,"node_id":"MDQ6VXNlcjIxNDIwNw==","avatar_url":"https://avatars.githubusercontent.com/u/214207?v=4","gravatar_id":"","url":"https://api.github.com/users/marcphilipp","html_url":"https://github.com/marcphilipp","followers_url":"https://api.github.com/users/marcphilipp/followers","following_url":"https://api.github.com/users/marcphilipp/following{/other_user}","gists_url":"https://api.github.com/users/marcphilipp/gists{/gist_id}","starred_url":"https://api.github.com/users/marcphilipp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcphilipp/subscriptions","organizations_url":"https://api.github.com/users/marcphilipp/orgs","repos_url":"https://api.github.com/users/marcphilipp/repos","events_url":"https://api.github.com/users/marcphilipp/events{/privacy}","received_events_url":"https://api.github.com/users/marcphilipp/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":49,"state":"closed","created_at":"2024-02-02T15:38:31Z","updated_at":"2025-01-31T16:18:49Z","due_on":"2025-01-31T08:00:00Z","closed_at":"2025-01-31T16:18:49Z"},"comments":10,"created_at":"2024-09-24T15:47:15Z","updated_at":"2024-10-16T12:45:20Z","closed_at":"2024-09-25T07:54:54Z","author_association":"CONTRIBUTOR","type":{"id":146631,"node_id":"IT_kwDOAA1WZs4AAjzH","name":"Feature","description":"A request, idea, or new functionality","color":"blue","created_at":"2024-01-25T09:15:40Z","updated_at":"2024-10-08T08:32:28Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Hello, dear JUnit team!\r\n\r\nToday I've noticed the following Twitter post which reports a very deep stack trace:\r\nhttps://x.com/gunnarmorling/status/1838556082005807554\r\n\r\nIt includes a lot of JUnit frames, notably coming from the nested Stream API call in `TestTemplateTestDescriptor#execute`. I've noticed that a short and local patch could reduce the stack consumption by probably a couple dozens of frames without changing the code behavior:\r\n\r\n```\r\ndiff --git a/junit-jupiter-engine/src/main/java/org/junit/jupiter/engine/descriptor/TestTemplateTestDescriptor.java b/junit-jupiter-engine/src/main/java/org/junit/jupiter/engine/descriptor/TestTemplateTestDescriptor.java\r\n--- a/junit-jupiter-engine/src/main/java/org/junit/jupiter/engine/descriptor/TestTemplateTestDescriptor.java\t(revision 926e31f87334ababc45bd31b0accdb54f909041b)\r\n+++ b/junit-jupiter-engine/src/main/java/org/junit/jupiter/engine/descriptor/TestTemplateTestDescriptor.java\t(date 1727192184035)\r\n@@ -101,12 +101,11 @@\r\n \t\t\tcontext.getExtensionRegistry());\r\n \t\tAtomicInteger invocationIndex = new AtomicInteger();\r\n \t\t// @formatter:off\r\n-\t\tproviders.stream()\r\n-\t\t\t\t.flatMap(provider -> provider.provideTestTemplateInvocationContexts(extensionContext))\r\n-\t\t\t\t.map(invocationContext -> createInvocationTestDescriptor(invocationContext, invocationIndex.incrementAndGet()))\r\n-\t\t\t\t.filter(Optional::isPresent)\r\n-\t\t\t\t.map(Optional::get)\r\n-\t\t\t\t.forEach(invocationTestDescriptor -> execute(dynamicTestExecutor, invocationTestDescriptor));\r\n+\t\tfor (TestTemplateInvocationContextProvider provider : providers) {\r\n+\t\t\tprovider.provideTestTemplateInvocationContexts(extensionContext)\r\n+\t\t\t\t.forEach(invocationContext -> createInvocationTestDescriptor(invocationContext, invocationIndex.incrementAndGet())\r\n+\t\t\t\t\t.ifPresent(invocationTestDescriptor -> execute(dynamicTestExecutor, invocationTestDescriptor)));\r\n+\t\t}\r\n \t\t// @formatter:on\r\n \t\tvalidateWasAtLeastInvokedOnce(invocationIndex.get(), providers);\r\n \t\treturn context;\r\n```\r\n\r\nReducing stack consumption makes the debugging experience more user-friendly, as users will be less likely confused by many frames. It may also reduce the output size if the exception is printed/logged, saving the precious screen or log file real estate and time necessary to scroll through the output. Finally, using less stack size by framework leaves more stack size to the user code, which is also user-friendly. While streams are used in other places, this one is particularly important because in the heart of it the user code is executed, so users can see this particular stack trace quite often.\r\n\r\nA further stack consumption reduction is possible, though it requires collecting streams from `provideTestTemplateInvocationContexts` to intermediate lists, so it could be more questionable, as performance and memory consumption are not definitely better in this case:\r\n\r\n```\r\ndiff --git a/junit-jupiter-engine/src/main/java/org/junit/jupiter/engine/descriptor/TestTemplateTestDescriptor.java b/junit-jupiter-engine/src/main/java/org/junit/jupiter/engine/descriptor/TestTemplateTestDescriptor.java\r\n--- a/junit-jupiter-engine/src/main/java/org/junit/jupiter/engine/descriptor/TestTemplateTestDescriptor.java\t(revision 926e31f87334ababc45bd31b0accdb54f909041b)\r\n+++ b/junit-jupiter-engine/src/main/java/org/junit/jupiter/engine/descriptor/TestTemplateTestDescriptor.java\t(date 1727192184035)\r\n@@ -101,12 +101,13 @@\r\n \t\t\tcontext.getExtensionRegistry());\r\n \t\tAtomicInteger invocationIndex = new AtomicInteger();\r\n \t\t// @formatter:off\r\n-\t\tproviders.stream()\r\n-\t\t\t\t.flatMap(provider -> provider.provideTestTemplateInvocationContexts(extensionContext))\r\n-\t\t\t\t.map(invocationContext -> createInvocationTestDescriptor(invocationContext, invocationIndex.incrementAndGet()))\r\n-\t\t\t\t.filter(Optional::isPresent)\r\n-\t\t\t\t.map(Optional::get)\r\n-\t\t\t\t.forEach(invocationTestDescriptor -> execute(dynamicTestExecutor, invocationTestDescriptor));\r\n+\t\tfor (TestTemplateInvocationContextProvider provider : providers) {\r\n+\t\t\tfor (TestTemplateInvocationContext invocationContext : provider.provideTestTemplateInvocationContexts(\r\n+\t\t\t\t\textensionContext).collect(toList())) {\r\n+\t\t\t\tcreateInvocationTestDescriptor(invocationContext, invocationIndex.incrementAndGet()).ifPresent(\r\n+\t\t\t\t\t\tinvocationTestDescriptor -> execute(dynamicTestExecutor, invocationTestDescriptor));\r\n+\t\t\t}\r\n+\t\t}\r\n \t\t// @formatter:on\r\n \t\tvalidateWasAtLeastInvokedOnce(invocationIndex.get(), providers);\r\n \t\treturn context;\r\n```\r\n\r\nIt's just a suggestion, feel free to ignore if it goes against the code standards in the JUnit project.","closed_by":{"login":"marcphilipp","id":214207,"node_id":"MDQ6VXNlcjIxNDIwNw==","avatar_url":"https://avatars.githubusercontent.com/u/214207?v=4","gravatar_id":"","url":"https://api.github.com/users/marcphilipp","html_url":"https://github.com/marcphilipp","followers_url":"https://api.github.com/users/marcphilipp/followers","following_url":"https://api.github.com/users/marcphilipp/following{/other_user}","gists_url":"https://api.github.com/users/marcphilipp/gists{/gist_id}","starred_url":"https://api.github.com/users/marcphilipp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcphilipp/subscriptions","organizations_url":"https://api.github.com/users/marcphilipp/orgs","repos_url":"https://api.github.com/users/marcphilipp/repos","events_url":"https://api.github.com/users/marcphilipp/events{/privacy}","received_events_url":"https://api.github.com/users/marcphilipp/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/junit-team/junit-framework/issues/4020/reactions","total_count":5,"+1":5,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/junit-team/junit-framework/issues/4020/timeline","performed_via_github_app":null,"state_reason":"completed"}