{"url":"https://api.github.com/repos/junit-team/junit-framework/issues/3923","repository_url":"https://api.github.com/repos/junit-team/junit-framework","labels_url":"https://api.github.com/repos/junit-team/junit-framework/issues/3923/labels{/name}","comments_url":"https://api.github.com/repos/junit-team/junit-framework/issues/3923/comments","events_url":"https://api.github.com/repos/junit-team/junit-framework/issues/3923/events","html_url":"https://github.com/junit-team/junit-framework/issues/3923","id":2462967245,"node_id":"I_kwDOAbwRH86SzeXN","number":3923,"title":"@CsvFileSource is unusable for datasets involving very long lines","user":{"login":"mdindoffer","id":12681399,"node_id":"MDQ6VXNlcjEyNjgxMzk5","avatar_url":"https://avatars.githubusercontent.com/u/12681399?v=4","gravatar_id":"","url":"https://api.github.com/users/mdindoffer","html_url":"https://github.com/mdindoffer","followers_url":"https://api.github.com/users/mdindoffer/followers","following_url":"https://api.github.com/users/mdindoffer/following{/other_user}","gists_url":"https://api.github.com/users/mdindoffer/gists{/gist_id}","starred_url":"https://api.github.com/users/mdindoffer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mdindoffer/subscriptions","organizations_url":"https://api.github.com/users/mdindoffer/orgs","repos_url":"https://api.github.com/users/mdindoffer/repos","events_url":"https://api.github.com/users/mdindoffer/events{/privacy}","received_events_url":"https://api.github.com/users/mdindoffer/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":165165180,"node_id":"MDU6TGFiZWwxNjUxNjUxODA=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/type:%20enhancement","name":"type: enhancement","color":"84b6eb","default":false,"description":null},{"id":420911923,"node_id":"MDU6TGFiZWw0MjA5MTE5MjM=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/component:%20Jupiter","name":"component: Jupiter","color":"11ee99","default":false,"description":null},{"id":747276013,"node_id":"MDU6TGFiZWw3NDcyNzYwMTM=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/theme:%20parameterized%20tests","name":"theme: parameterized tests","color":"9e9dea","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"marcphilipp","id":214207,"node_id":"MDQ6VXNlcjIxNDIwNw==","avatar_url":"https://avatars.githubusercontent.com/u/214207?v=4","gravatar_id":"","url":"https://api.github.com/users/marcphilipp","html_url":"https://github.com/marcphilipp","followers_url":"https://api.github.com/users/marcphilipp/followers","following_url":"https://api.github.com/users/marcphilipp/following{/other_user}","gists_url":"https://api.github.com/users/marcphilipp/gists{/gist_id}","starred_url":"https://api.github.com/users/marcphilipp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcphilipp/subscriptions","organizations_url":"https://api.github.com/users/marcphilipp/orgs","repos_url":"https://api.github.com/users/marcphilipp/repos","events_url":"https://api.github.com/users/marcphilipp/events{/privacy}","received_events_url":"https://api.github.com/users/marcphilipp/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"marcphilipp","id":214207,"node_id":"MDQ6VXNlcjIxNDIwNw==","avatar_url":"https://avatars.githubusercontent.com/u/214207?v=4","gravatar_id":"","url":"https://api.github.com/users/marcphilipp","html_url":"https://github.com/marcphilipp","followers_url":"https://api.github.com/users/marcphilipp/followers","following_url":"https://api.github.com/users/marcphilipp/following{/other_user}","gists_url":"https://api.github.com/users/marcphilipp/gists{/gist_id}","starred_url":"https://api.github.com/users/marcphilipp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcphilipp/subscriptions","organizations_url":"https://api.github.com/users/marcphilipp/orgs","repos_url":"https://api.github.com/users/marcphilipp/repos","events_url":"https://api.github.com/users/marcphilipp/events{/privacy}","received_events_url":"https://api.github.com/users/marcphilipp/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/junit-team/junit-framework/milestones/76","html_url":"https://github.com/junit-team/junit-framework/milestone/76","labels_url":"https://api.github.com/repos/junit-team/junit-framework/milestones/76/labels","id":11018368,"node_id":"MI_kwDOAbwRH84AqCCA","number":76,"title":"5.11 GA","description":"","creator":{"login":"marcphilipp","id":214207,"node_id":"MDQ6VXNlcjIxNDIwNw==","avatar_url":"https://avatars.githubusercontent.com/u/214207?v=4","gravatar_id":"","url":"https://api.github.com/users/marcphilipp","html_url":"https://github.com/marcphilipp","followers_url":"https://api.github.com/users/marcphilipp/followers","following_url":"https://api.github.com/users/marcphilipp/following{/other_user}","gists_url":"https://api.github.com/users/marcphilipp/gists{/gist_id}","starred_url":"https://api.github.com/users/marcphilipp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcphilipp/subscriptions","organizations_url":"https://api.github.com/users/marcphilipp/orgs","repos_url":"https://api.github.com/users/marcphilipp/repos","events_url":"https://api.github.com/users/marcphilipp/events{/privacy}","received_events_url":"https://api.github.com/users/marcphilipp/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":8,"state":"closed","created_at":"2024-05-06T09:41:24Z","updated_at":"2024-08-14T09:30:38Z","due_on":"2024-08-14T07:00:00Z","closed_at":"2024-08-14T09:30:38Z"},"comments":1,"created_at":"2024-08-13T10:15:34Z","updated_at":"2024-08-13T12:20:33Z","closed_at":"2024-08-13T12:19:48Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"# Description\r\n\r\nIf you want to use a CSV file-based dataset, that contains very long values in the columns, you have to increase the `maxCharsPerColumn` property from the default value of `4096`.  If, however, you don't know what is the length of the largest datapoint in your dataset, or cannot be sure to set a hard limit for future expansion, a logical thing to do would be to set the value to the largest possible one, i.e. `Integer.MAX_VALUE`.\r\n\r\nThis to my surprise crashes the test execution with :\r\n```\r\nException in thread \"main\" java.lang.OutOfMemoryError: Requested array size exceeds VM limit\r\n\tat org.junit.jupiter.params.shadow.com.univocity.parsers.common.input.DefaultCharAppender.<init>(DefaultCharAppender.java:40)\r\n\tat org.junit.jupiter.params.shadow.com.univocity.parsers.csv.CsvParserSettings.newCharAppender(CsvParserSettings.java:93)\r\n\tat org.junit.jupiter.params.shadow.com.univocity.parsers.common.ParserOutput.<init>(ParserOutput.java:111)\r\n\tat org.junit.jupiter.params.shadow.com.univocity.parsers.common.AbstractParser.<init>(AbstractParser.java:91)\r\n\tat org.junit.jupiter.params.shadow.com.univocity.parsers.csv.CsvParser.<init>(CsvParser.java:70)\r\n\tat org.junit.jupiter.params.provider.CsvParserFactory.createParser(CsvParserFactory.java:61)\r\n\tat org.junit.jupiter.params.provider.CsvParserFactory.createParserFor(CsvParserFactory.java:40)\r\n\tat org.junit.jupiter.params.provider.CsvFileArgumentsProvider.provideArguments(CsvFileArgumentsProvider.java:64)\r\n\tat org.junit.jupiter.params.provider.CsvFileArgumentsProvider.provideArguments(CsvFileArgumentsProvider.java:44)\r\n\tat org.junit.jupiter.params.provider.AnnotationBasedArgumentsProvider.provideArguments(AnnotationBasedArgumentsProvider.java:52)\r\n\tat org.junit.jupiter.params.ParameterizedTestExtension.arguments(ParameterizedTestExtension.java:145)\r\n\tat org.junit.jupiter.params.ParameterizedTestExtension.lambda$provideTestTemplateInvocationContexts$2(ParameterizedTestExtension.java:90)\r\n\tat org.junit.jupiter.params.ParameterizedTestExtension$$Lambda/0x00007427a8142bb0.apply(Unknown Source)\r\n\tat java.base/java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:273)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1708)\r\n\tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\r\n\tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:151)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:174)\r\n\tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n\tat java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)\r\n\tat java.base/java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:276)\r\n\tat java.base/java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1708)\r\n\tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\r\n\tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:151)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:174)\r\n\tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n\tat java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)\r\n```  \r\n\r\nI was absolutely shocked to see that the  `CSVParser` implementation used by JUnit is really **pre-allocating** a `char` array to store the CSV values in it. See [1](https://github.com/uniVocity/univocity-parsers/blob/7e7d1b3c0a3dceaed4a8413875eb1500f2a028ec/src/main/java/com/univocity/parsers/common/input/DefaultCharAppender.java#L40).\r\n\r\nThis is completely unusable for CSV strings of unknown length. One could of course provide a value that would fit within the JVM limits (i.e. `Integer.MAX_VALUE - 8`), at which point this doesn't crash, but that just means your unit test is now allocating absolutely ridiculous amounts of heap memory to run.\r\n\r\nDigging further, I found that the shaded univocity parsers library does actually have another implementation of `DefaultCharAppender` called `ExpandingCharAppender`, which seems to grow the `char` buffer at runtime, starting from a modest `8192` buffer length value.\r\n\r\nThe library is basing it's decision on which `Appender` to use in the `CsvParserSettings`, see [2](https://github.com/uniVocity/univocity-parsers/blob/7e7d1b3c0a3dceaed4a8413875eb1500f2a028ec/src/main/java/com/univocity/parsers/csv/CsvParserSettings.java#L92). Apparently, all that is required to switch to the `ExpandingCharAppender` is to pass a value of `-1` for the `maxCharsPerColumn`.\r\n\r\nUnfortunately, the `maxCharsPerColumn` property of the `@CsvFileSource` annotation **requires** the value to be a positive integer:\r\n\r\n```\r\norg.junit.platform.commons.PreconditionViolationException: maxCharsPerColumn must be a positive number: -1\r\n\tat java.base/java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:273)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\n\tat java.base/java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1708)\r\n\tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\r\n\tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:151)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:174)\r\n\tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n\tat java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)\r\n\tat java.base/java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:276)\r\n\tat java.base/java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1708)\r\n\tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\r\n\tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:151)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:174)\r\n\tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n\tat java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)\r\n\tat java.base/java.util.ArrayList.forEach(ArrayList.java:1596)\r\n\tat java.base/java.util.ArrayList.forEach(ArrayList.java:1596)\r\n\tSuppressed: org.junit.platform.commons.PreconditionViolationException: Configuration error: You must configure at least one set of arguments for this @ParameterizedTest\r\n\t\tat java.base/java.util.stream.AbstractPipeline.close(AbstractPipeline.java:323)\r\n\t\tat java.base/java.util.stream.ReferencePipeline$7$1.accept(ReferencePipeline.java:273)\r\n\t\t... 9 more\r\n```\r\n\r\n## Steps to reproduce\r\n\r\n1. OutOfMemoryError when using large column length limits\r\n```java\r\n@ParameterizedTest\r\n@CsvFileSource(resources = \"/file.csv\", numLinesToSkip = 1, maxCharsPerColumn = Integer.MAX_VALUE)\r\nvoid dummy(String columnA, String columnB) {\r\n}\r\n```\r\n\r\n2. PreconditionViolationException for trying to use an unbounded `ExpandingCharAppender` with `maxCharsPerColumn = -1`\r\n```java\r\n@ParameterizedTest\r\n@CsvFileSource(resources = \"/file.csv\", numLinesToSkip = 1, maxCharsPerColumn = -1)\r\nvoid dummy(String columnA, String columnB) {\r\n}\r\n```\r\n\r\n## Context\r\n\r\n - Used versions (Jupiter/Vintage/Platform): JUnit 5.10.3\r\n - Build Tool/IDE: JDK 21\r\n\r\n## TLDR\r\n\r\nPlease switch to the `ExpandingCharAppender` by default when using `@CsvFileSource`, or at least allow its usage by removing the positive integer validation of `maxCharsPerColumn` property, and document the valid range.\r\n\r\nAlternatively, you may consider switching to a better CSV parser implementation altogether. This obscure \"Univocity\" library has last seen a commit in 2021 and its website [univocity.com](https://univocity.com/) returns an HTTP 404 error page.","closed_by":{"login":"marcphilipp","id":214207,"node_id":"MDQ6VXNlcjIxNDIwNw==","avatar_url":"https://avatars.githubusercontent.com/u/214207?v=4","gravatar_id":"","url":"https://api.github.com/users/marcphilipp","html_url":"https://github.com/marcphilipp","followers_url":"https://api.github.com/users/marcphilipp/followers","following_url":"https://api.github.com/users/marcphilipp/following{/other_user}","gists_url":"https://api.github.com/users/marcphilipp/gists{/gist_id}","starred_url":"https://api.github.com/users/marcphilipp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcphilipp/subscriptions","organizations_url":"https://api.github.com/users/marcphilipp/orgs","repos_url":"https://api.github.com/users/marcphilipp/repos","events_url":"https://api.github.com/users/marcphilipp/events{/privacy}","received_events_url":"https://api.github.com/users/marcphilipp/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/junit-team/junit-framework/issues/3923/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/junit-team/junit-framework/issues/3923/timeline","performed_via_github_app":null,"state_reason":"completed"}