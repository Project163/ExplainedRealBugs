{"url":"https://api.github.com/repos/junit-team/junit-framework/issues/1511","repository_url":"https://api.github.com/repos/junit-team/junit-framework","labels_url":"https://api.github.com/repos/junit-team/junit-framework/issues/1511/labels{/name}","comments_url":"https://api.github.com/repos/junit-team/junit-framework/issues/1511/comments","events_url":"https://api.github.com/repos/junit-team/junit-framework/issues/1511/events","html_url":"https://github.com/junit-team/junit-framework/issues/1511","id":345326764,"node_id":"MDU6SXNzdWUzNDUzMjY3NjQ=","number":1511,"title":"Parallel execution and @TestInstance(PER_CLASS) result in concurrency issues for instance fields mutated in test and lifecycle methods","user":{"login":"dlanaghen","id":627949,"node_id":"MDQ6VXNlcjYyNzk0OQ==","avatar_url":"https://avatars.githubusercontent.com/u/627949?v=4","gravatar_id":"","url":"https://api.github.com/users/dlanaghen","html_url":"https://github.com/dlanaghen","followers_url":"https://api.github.com/users/dlanaghen/followers","following_url":"https://api.github.com/users/dlanaghen/following{/other_user}","gists_url":"https://api.github.com/users/dlanaghen/gists{/gist_id}","starred_url":"https://api.github.com/users/dlanaghen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dlanaghen/subscriptions","organizations_url":"https://api.github.com/users/dlanaghen/orgs","repos_url":"https://api.github.com/users/dlanaghen/repos","events_url":"https://api.github.com/users/dlanaghen/events{/privacy}","received_events_url":"https://api.github.com/users/dlanaghen/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":165165178,"node_id":"MDU6TGFiZWwxNjUxNjUxNzg=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/type:%20bug","name":"type: bug","color":"fc2929","default":false,"description":null},{"id":293473932,"node_id":"MDU6TGFiZWwyOTM0NzM5MzI=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/theme:%20programming%20model","name":"theme: programming model","color":"c7def8","default":false,"description":null},{"id":293488747,"node_id":"MDU6TGFiZWwyOTM0ODg3NDc=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/theme:%20execution","name":"theme: execution","color":"fbca04","default":false,"description":null},{"id":318079877,"node_id":"MDU6TGFiZWwzMTgwNzk4Nzc=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/theme:%20concurrency","name":"theme: concurrency","color":"eeccff","default":false,"description":null},{"id":420911923,"node_id":"MDU6TGFiZWw0MjA5MTE5MjM=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/component:%20Jupiter","name":"component: Jupiter","color":"11ee99","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"marcphilipp","id":214207,"node_id":"MDQ6VXNlcjIxNDIwNw==","avatar_url":"https://avatars.githubusercontent.com/u/214207?v=4","gravatar_id":"","url":"https://api.github.com/users/marcphilipp","html_url":"https://github.com/marcphilipp","followers_url":"https://api.github.com/users/marcphilipp/followers","following_url":"https://api.github.com/users/marcphilipp/following{/other_user}","gists_url":"https://api.github.com/users/marcphilipp/gists{/gist_id}","starred_url":"https://api.github.com/users/marcphilipp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcphilipp/subscriptions","organizations_url":"https://api.github.com/users/marcphilipp/orgs","repos_url":"https://api.github.com/users/marcphilipp/repos","events_url":"https://api.github.com/users/marcphilipp/events{/privacy}","received_events_url":"https://api.github.com/users/marcphilipp/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"marcphilipp","id":214207,"node_id":"MDQ6VXNlcjIxNDIwNw==","avatar_url":"https://avatars.githubusercontent.com/u/214207?v=4","gravatar_id":"","url":"https://api.github.com/users/marcphilipp","html_url":"https://github.com/marcphilipp","followers_url":"https://api.github.com/users/marcphilipp/followers","following_url":"https://api.github.com/users/marcphilipp/following{/other_user}","gists_url":"https://api.github.com/users/marcphilipp/gists{/gist_id}","starred_url":"https://api.github.com/users/marcphilipp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcphilipp/subscriptions","organizations_url":"https://api.github.com/users/marcphilipp/orgs","repos_url":"https://api.github.com/users/marcphilipp/repos","events_url":"https://api.github.com/users/marcphilipp/events{/privacy}","received_events_url":"https://api.github.com/users/marcphilipp/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/junit-team/junit-framework/milestones/27","html_url":"https://github.com/junit-team/junit-framework/milestone/27","labels_url":"https://api.github.com/repos/junit-team/junit-framework/milestones/27/labels","id":3427464,"node_id":"MDk6TWlsZXN0b25lMzQyNzQ2NA==","number":27,"title":"5.3 RC1","description":"*Scope:* Finishing touches on parallel test execution and output capturing, bug fixes and miscellaneous usability improvements.","creator":{"login":"sormuras","id":2319838,"node_id":"MDQ6VXNlcjIzMTk4Mzg=","avatar_url":"https://avatars.githubusercontent.com/u/2319838?v=4","gravatar_id":"","url":"https://api.github.com/users/sormuras","html_url":"https://github.com/sormuras","followers_url":"https://api.github.com/users/sormuras/followers","following_url":"https://api.github.com/users/sormuras/following{/other_user}","gists_url":"https://api.github.com/users/sormuras/gists{/gist_id}","starred_url":"https://api.github.com/users/sormuras/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sormuras/subscriptions","organizations_url":"https://api.github.com/users/sormuras/orgs","repos_url":"https://api.github.com/users/sormuras/repos","events_url":"https://api.github.com/users/sormuras/events{/privacy}","received_events_url":"https://api.github.com/users/sormuras/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":42,"state":"closed","created_at":"2018-06-15T10:22:15Z","updated_at":"2018-08-14T19:11:27Z","due_on":"2018-08-13T07:00:00Z","closed_at":"2018-08-13T19:14:17Z"},"comments":24,"created_at":"2018-07-27T18:38:58Z","updated_at":"2023-12-15T10:54:31Z","closed_at":"2018-08-13T18:51:07Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"`@TestInstance` annotation seems to cause threading problems with tests in Spring Boot.\r\n\r\n```xml\r\n<junit5.jupiter.version>5.3.0-M1</junit5.jupiter.version>\r\n<junit5.platform.version>1.2.0</junit5.platform.version>\r\n```\r\n\r\nI was able to replicate this problem by creating a small Spring Boot application using the Spring Initializer (https://start.spring.io/).\r\n\r\nThe application:\r\n\r\n```java\r\npackage com.example.demo;\r\n\r\nimport org.springframework.boot.SpringApplication;\r\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\r\n\r\n@SpringBootApplication\r\npublic class DemoApplication {\r\n\r\n\tpublic static void main(String[] args) {\r\n\t\tSpringApplication.run(DemoApplication.class, args);\r\n\t}\r\n}\r\n```\r\n\r\nA dummy class for testing:\r\n\r\n```java\r\npackage com.example.demo;\r\n\r\npublic class Klass {\r\n    public Klass(String field) {\r\n        this.field = field;\r\n    }\r\n\r\n    public String getField() {\r\n        return field;\r\n    }\r\n\r\n    public void setField(String field) {\r\n        this.field = field;\r\n    }\r\n\r\n    String field;\r\n}\r\n```\r\n\r\n\r\nMy test class:\r\n\r\n```java\r\npackage com.example.demo;\r\n\r\nimport org.junit.Test;\r\nimport org.junit.jupiter.api.AfterEach;\r\nimport org.junit.jupiter.api.BeforeEach;\r\nimport org.junit.jupiter.api.RepeatedTest;\r\nimport org.junit.jupiter.api.TestInstance;\r\nimport org.junit.jupiter.api.extension.ExtendWith;\r\nimport org.junit.runner.RunWith;\r\nimport org.springframework.boot.test.context.SpringBootTest;\r\nimport org.springframework.test.context.junit.jupiter.SpringExtension;\r\nimport org.springframework.test.context.junit4.SpringRunner;\r\n\r\n// @TestInstance(TestInstance.Lifecycle.PER_CLASS) // Needed for BeforeAll annotation but causes threading issues. \r\n@ExtendWith(SpringExtension.class)\r\n@SpringBootTest(classes = {DemoApplication.class})\r\npublic class DemoApplicationTests {\r\n\r\n\t@Test\r\n\tpublic void contextLoads() {\r\n\t}\r\n\r\n\tKlass klass = null;\r\n\r\n\t@BeforeEach\r\n\tpublic void beforeEach() {\r\n\t\tklass = new Klass(Thread.currentThread().getName());\r\n\t}\r\n\r\n\t@RepeatedTest(8)\r\n\tpublic void parallel() {\r\n\t\tklass.setField(\"Modified: \" + klass.getField());\r\n\t}\r\n\r\n\t@AfterEach\r\n\tpublic void afterEach() {\r\n\t\tSystem.out.println(String.format(\"%s - %s\", Thread.currentThread().getName(), klass.field ));\r\n\t}\r\n}\r\n```\r\n\r\n\r\nOutput when not using `@TestInstance`:\r\n\r\n```\r\nForkJoinPool-1-worker-3 - Modified: ForkJoinPool-1-worker-3\r\nForkJoinPool-1-worker-0 - Modified: ForkJoinPool-1-worker-0\r\nForkJoinPool-1-worker-2 - Modified: ForkJoinPool-1-worker-2\r\nForkJoinPool-1-worker-3 - Modified: ForkJoinPool-1-worker-3\r\nForkJoinPool-1-worker-4 - Modified: ForkJoinPool-1-worker-4\r\nForkJoinPool-1-worker-4 - Modified: ForkJoinPool-1-worker-4\r\nForkJoinPool-1-worker-6 - Modified: ForkJoinPool-1-worker-6\r\nForkJoinPool-1-worker-2 - Modified: ForkJoinPool-1-worker-2\r\n```\r\n\r\nOutput when using `@TestInstance`:\r\n\r\n```\r\nForkJoinPool-1-worker-0 - Modified: ForkJoinPool-1-worker-4 <<< oops\r\nForkJoinPool-1-worker-2 - Modified: ForkJoinPool-1-worker-4 <<<\r\nForkJoinPool-1-worker-3 - Modified: ForkJoinPool-1-worker-3\r\nForkJoinPool-1-worker-0 - Modified: ForkJoinPool-1-worker-0\r\nForkJoinPool-1-worker-4 - Modified: ForkJoinPool-1-worker-0 <<<\r\nForkJoinPool-1-worker-2 - Modified: ForkJoinPool-1-worker-2\r\nForkJoinPool-1-worker-3 - Modified: ForkJoinPool-1-worker-3\r\n```\r\n","closed_by":{"login":"marcphilipp","id":214207,"node_id":"MDQ6VXNlcjIxNDIwNw==","avatar_url":"https://avatars.githubusercontent.com/u/214207?v=4","gravatar_id":"","url":"https://api.github.com/users/marcphilipp","html_url":"https://github.com/marcphilipp","followers_url":"https://api.github.com/users/marcphilipp/followers","following_url":"https://api.github.com/users/marcphilipp/following{/other_user}","gists_url":"https://api.github.com/users/marcphilipp/gists{/gist_id}","starred_url":"https://api.github.com/users/marcphilipp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcphilipp/subscriptions","organizations_url":"https://api.github.com/users/marcphilipp/orgs","repos_url":"https://api.github.com/users/marcphilipp/repos","events_url":"https://api.github.com/users/marcphilipp/events{/privacy}","received_events_url":"https://api.github.com/users/marcphilipp/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/junit-team/junit-framework/issues/1511/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/junit-team/junit-framework/issues/1511/timeline","performed_via_github_app":null,"state_reason":"completed"}