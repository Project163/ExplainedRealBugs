{"url":"https://api.github.com/repos/junit-team/junit-framework/issues/4828","repository_url":"https://api.github.com/repos/junit-team/junit-framework","labels_url":"https://api.github.com/repos/junit-team/junit-framework/issues/4828/labels{/name}","comments_url":"https://api.github.com/repos/junit-team/junit-framework/issues/4828/comments","events_url":"https://api.github.com/repos/junit-team/junit-framework/issues/4828/events","html_url":"https://github.com/junit-team/junit-framework/issues/4828","id":3310144602,"node_id":"I_kwDOAbwRH87FTMxa","number":4828,"title":"Exceptions thrown by hooks are not completely pruned","user":{"login":"mpkorstanje","id":6946919,"node_id":"MDQ6VXNlcjY5NDY5MTk=","avatar_url":"https://avatars.githubusercontent.com/u/6946919?v=4","gravatar_id":"","url":"https://api.github.com/users/mpkorstanje","html_url":"https://github.com/mpkorstanje","followers_url":"https://api.github.com/users/mpkorstanje/followers","following_url":"https://api.github.com/users/mpkorstanje/following{/other_user}","gists_url":"https://api.github.com/users/mpkorstanje/gists{/gist_id}","starred_url":"https://api.github.com/users/mpkorstanje/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mpkorstanje/subscriptions","organizations_url":"https://api.github.com/users/mpkorstanje/orgs","repos_url":"https://api.github.com/users/mpkorstanje/repos","events_url":"https://api.github.com/users/mpkorstanje/events{/privacy}","received_events_url":"https://api.github.com/users/mpkorstanje/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":165165178,"node_id":"MDU6TGFiZWwxNjUxNjUxNzg=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/type:%20bug","name":"type: bug","color":"fc2929","default":false,"description":null},{"id":310903254,"node_id":"MDU6TGFiZWwzMTA5MDMyNTQ=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/theme:%20reporting","name":"theme: reporting","color":"bfdadc","default":false,"description":null},{"id":420912036,"node_id":"MDU6TGFiZWw0MjA5MTIwMzY=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/component:%20Platform","name":"component: Platform","color":"11dd99","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"mpkorstanje","id":6946919,"node_id":"MDQ6VXNlcjY5NDY5MTk=","avatar_url":"https://avatars.githubusercontent.com/u/6946919?v=4","gravatar_id":"","url":"https://api.github.com/users/mpkorstanje","html_url":"https://github.com/mpkorstanje","followers_url":"https://api.github.com/users/mpkorstanje/followers","following_url":"https://api.github.com/users/mpkorstanje/following{/other_user}","gists_url":"https://api.github.com/users/mpkorstanje/gists{/gist_id}","starred_url":"https://api.github.com/users/mpkorstanje/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mpkorstanje/subscriptions","organizations_url":"https://api.github.com/users/mpkorstanje/orgs","repos_url":"https://api.github.com/users/mpkorstanje/repos","events_url":"https://api.github.com/users/mpkorstanje/events{/privacy}","received_events_url":"https://api.github.com/users/mpkorstanje/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"mpkorstanje","id":6946919,"node_id":"MDQ6VXNlcjY5NDY5MTk=","avatar_url":"https://avatars.githubusercontent.com/u/6946919?v=4","gravatar_id":"","url":"https://api.github.com/users/mpkorstanje","html_url":"https://github.com/mpkorstanje","followers_url":"https://api.github.com/users/mpkorstanje/followers","following_url":"https://api.github.com/users/mpkorstanje/following{/other_user}","gists_url":"https://api.github.com/users/mpkorstanje/gists{/gist_id}","starred_url":"https://api.github.com/users/mpkorstanje/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mpkorstanje/subscriptions","organizations_url":"https://api.github.com/users/mpkorstanje/orgs","repos_url":"https://api.github.com/users/mpkorstanje/repos","events_url":"https://api.github.com/users/mpkorstanje/events{/privacy}","received_events_url":"https://api.github.com/users/mpkorstanje/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/junit-team/junit-framework/milestones/102","html_url":"https://github.com/junit-team/junit-framework/milestone/102","labels_url":"https://api.github.com/repos/junit-team/junit-framework/milestones/102/labels","id":13243037,"node_id":"MI_kwDOAbwRH84AyhKd","number":102,"title":"6.0.0-RC1","description":"","creator":{"login":"marcphilipp","id":214207,"node_id":"MDQ6VXNlcjIxNDIwNw==","avatar_url":"https://avatars.githubusercontent.com/u/214207?v=4","gravatar_id":"","url":"https://api.github.com/users/marcphilipp","html_url":"https://github.com/marcphilipp","followers_url":"https://api.github.com/users/marcphilipp/followers","following_url":"https://api.github.com/users/marcphilipp/following{/other_user}","gists_url":"https://api.github.com/users/marcphilipp/gists{/gist_id}","starred_url":"https://api.github.com/users/marcphilipp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcphilipp/subscriptions","organizations_url":"https://api.github.com/users/marcphilipp/orgs","repos_url":"https://api.github.com/users/marcphilipp/repos","events_url":"https://api.github.com/users/marcphilipp/events{/privacy}","received_events_url":"https://api.github.com/users/marcphilipp/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":13,"state":"closed","created_at":"2025-07-10T10:34:58Z","updated_at":"2025-10-30T17:00:47Z","due_on":"2025-08-20T07:00:00Z","closed_at":"2025-08-20T08:19:09Z"},"comments":1,"created_at":"2025-08-11T13:46:41Z","updated_at":"2025-08-14T12:09:57Z","closed_at":"2025-08-14T12:09:48Z","author_association":"CONTRIBUTOR","type":{"id":146627,"node_id":"IT_kwDOAA1WZs4AAjzD","name":"Bug","description":"An unexpected problem or behavior","color":"red","created_at":"2024-01-25T09:15:40Z","updated_at":"2024-07-26T10:05:45Z","is_enabled":true},"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Steps to reproduce\n\nGiven an arbitrary suite with a failing before suite hook.\n\n```java\n@Suite\n@SelectPackages(\"com.example\")\npublic class RunCucumberTest {\n\n    @BeforeSuite\n    static void before(){\n        throw new RuntimeException(\"Oops\");\n    }\n\n    @AfterSuite\n    static void after(){\n\n    }\n}\n```\n\nThe trimmed stacktrace is:\n\n```\njava.lang.RuntimeException: Oops\n        at io.cucumber.skeleton.RunCucumberTest.before(RunCucumberTest.java:21)\n        at java.base/java.lang.reflect.Method.invoke(Method.java:580)\n        at java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:184)\n        at java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\n        at java.base/java.util.Iterator.forEachRemaining(Iterator.java:133)\n        at java.base/java.util.Spliterators$IteratorSpliterator.forEachRemaining(Spliterators.java:1939)\n        at java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\n        at java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\n        at java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:151)\n        at java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:174)\n        at java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\n        at java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)\n```\n\nWhile I would expect only:\n\n```\njava.lang.RuntimeException: Oops\n        at io.cucumber.skeleton.RunCucumberTest.before(RunCucumberTest.java:21)\n```\n\nLikewise \n\n```java\npublic class ExampleTest {\n    \n    @BeforeAll\n    static void beforeAll(){\n        throw new RuntimeException(\"Oops\");\n    }\n    \n    @Test\n    void test(){\n        \n    }\n}\n```\n\nPrints a slightly too long stacktrace:\n\n```\njava.lang.RuntimeException: Oops\n\n\tat io.cucumber.prettyformatter.ExampleTest.beforeAll(ExampleTest.java:10)\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:580)\n\tat java.base/java.util.ArrayList.forEach(ArrayList.java:1596)\n```\n\n---\n\nTo support engines whos children are tests, it would also be good to include both self and ancestors when looking for prune limits in  `StackTracePruningEngineExecutionListener`. But I couldn't reproduce the issues mentioned in https://github.com/junit-team/junit-framework/discussions/4825, with any existing Engine implementation. They all have containers as children.\n\nSolution:\n\n```java\n\tprivate static List<String> getTestClassNames(TestDescriptor testDescriptor) {\n\t\tvar self = Stream.of(testDescriptor);\n\t\tvar ancestors = testDescriptor.getAncestors().stream();\n\t\treturn Stream.concat(self, ancestors) //\n\t\t\t\t.map(TestDescriptor::getSource) //\n\t\t\t\t.flatMap(Optional::stream) //\n\t\t\t\t.map(source -> {\n\t\t\t\t\tif (source instanceof ClassSource classSource) {\n\t\t\t\t\t\treturn classSource.getClassName();\n\t\t\t\t\t}\n\t\t\t\t\telse if (source instanceof MethodSource methodSource) {\n\t\t\t\t\t\treturn methodSource.getClassName();\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\treturn null;\n\t\t\t\t\t}\n\t\t\t\t}) //\n\t\t\t\t.filter(Objects::nonNull) //\n\t\t\t\t.toList();\n\t}\n```\n\n## Context\n\nDid a small investigation following the discussion in https://github.com/junit-team/junit-framework/discussions/4825 and found this instead. \n\n - Version: 5.13.4, 6.0.0-SNAPSHOT @ fc9477249c6288cdc295651daf18eb0102746ed9\n\n## Deliverables\n\n- [ ] Slightly more pruned stacktraces\n- [ ] Include both self and ancestors in `getTestClassNames` for test that don't use containers.","closed_by":{"login":"marcphilipp","id":214207,"node_id":"MDQ6VXNlcjIxNDIwNw==","avatar_url":"https://avatars.githubusercontent.com/u/214207?v=4","gravatar_id":"","url":"https://api.github.com/users/marcphilipp","html_url":"https://github.com/marcphilipp","followers_url":"https://api.github.com/users/marcphilipp/followers","following_url":"https://api.github.com/users/marcphilipp/following{/other_user}","gists_url":"https://api.github.com/users/marcphilipp/gists{/gist_id}","starred_url":"https://api.github.com/users/marcphilipp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcphilipp/subscriptions","organizations_url":"https://api.github.com/users/marcphilipp/orgs","repos_url":"https://api.github.com/users/marcphilipp/repos","events_url":"https://api.github.com/users/marcphilipp/events{/privacy}","received_events_url":"https://api.github.com/users/marcphilipp/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/junit-team/junit-framework/issues/4828/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/junit-team/junit-framework/issues/4828/timeline","performed_via_github_app":null,"state_reason":"completed"}