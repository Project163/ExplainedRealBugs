{"url":"https://api.github.com/repos/junit-team/junit-framework/issues/3108","repository_url":"https://api.github.com/repos/junit-team/junit-framework","labels_url":"https://api.github.com/repos/junit-team/junit-framework/issues/3108/labels{/name}","comments_url":"https://api.github.com/repos/junit-team/junit-framework/issues/3108/comments","events_url":"https://api.github.com/repos/junit-team/junit-framework/issues/3108/events","html_url":"https://github.com/junit-team/junit-framework/issues/3108","id":1498017321,"node_id":"I_kwDOAbwRH85ZSe4p","number":3108,"title":"JUnit parallel executor running too many tests with a fixed policy","user":{"login":"OPeyrusse","id":29573092,"node_id":"MDQ6VXNlcjI5NTczMDky","avatar_url":"https://avatars.githubusercontent.com/u/29573092?v=4","gravatar_id":"","url":"https://api.github.com/users/OPeyrusse","html_url":"https://github.com/OPeyrusse","followers_url":"https://api.github.com/users/OPeyrusse/followers","following_url":"https://api.github.com/users/OPeyrusse/following{/other_user}","gists_url":"https://api.github.com/users/OPeyrusse/gists{/gist_id}","starred_url":"https://api.github.com/users/OPeyrusse/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OPeyrusse/subscriptions","organizations_url":"https://api.github.com/users/OPeyrusse/orgs","repos_url":"https://api.github.com/users/OPeyrusse/repos","events_url":"https://api.github.com/users/OPeyrusse/events{/privacy}","received_events_url":"https://api.github.com/users/OPeyrusse/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":293488747,"node_id":"MDU6TGFiZWwyOTM0ODg3NDc=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/theme:%20execution","name":"theme: execution","color":"fbca04","default":false,"description":null},{"id":318079877,"node_id":"MDU6TGFiZWwzMTgwNzk4Nzc=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/theme:%20concurrency","name":"theme: concurrency","color":"eeccff","default":false,"description":null},{"id":420911923,"node_id":"MDU6TGFiZWw0MjA5MTE5MjM=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/component:%20Jupiter","name":"component: Jupiter","color":"11ee99","default":false,"description":null},{"id":420912036,"node_id":"MDU6TGFiZWw0MjA5MTIwMzY=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/component:%20Platform","name":"component: Platform","color":"11dd99","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"marcphilipp","id":214207,"node_id":"MDQ6VXNlcjIxNDIwNw==","avatar_url":"https://avatars.githubusercontent.com/u/214207?v=4","gravatar_id":"","url":"https://api.github.com/users/marcphilipp","html_url":"https://github.com/marcphilipp","followers_url":"https://api.github.com/users/marcphilipp/followers","following_url":"https://api.github.com/users/marcphilipp/following{/other_user}","gists_url":"https://api.github.com/users/marcphilipp/gists{/gist_id}","starred_url":"https://api.github.com/users/marcphilipp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcphilipp/subscriptions","organizations_url":"https://api.github.com/users/marcphilipp/orgs","repos_url":"https://api.github.com/users/marcphilipp/repos","events_url":"https://api.github.com/users/marcphilipp/events{/privacy}","received_events_url":"https://api.github.com/users/marcphilipp/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"marcphilipp","id":214207,"node_id":"MDQ6VXNlcjIxNDIwNw==","avatar_url":"https://avatars.githubusercontent.com/u/214207?v=4","gravatar_id":"","url":"https://api.github.com/users/marcphilipp","html_url":"https://github.com/marcphilipp","followers_url":"https://api.github.com/users/marcphilipp/followers","following_url":"https://api.github.com/users/marcphilipp/following{/other_user}","gists_url":"https://api.github.com/users/marcphilipp/gists{/gist_id}","starred_url":"https://api.github.com/users/marcphilipp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcphilipp/subscriptions","organizations_url":"https://api.github.com/users/marcphilipp/orgs","repos_url":"https://api.github.com/users/marcphilipp/repos","events_url":"https://api.github.com/users/marcphilipp/events{/privacy}","received_events_url":"https://api.github.com/users/marcphilipp/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/junit-team/junit-framework/milestones/104","html_url":"https://github.com/junit-team/junit-framework/milestone/104","labels_url":"https://api.github.com/repos/junit-team/junit-framework/milestones/104/labels","id":13496059,"node_id":"MI_kwDOAbwRH84Aze77","number":104,"title":"6.1.0-M1","description":null,"creator":{"login":"marcphilipp","id":214207,"node_id":"MDQ6VXNlcjIxNDIwNw==","avatar_url":"https://avatars.githubusercontent.com/u/214207?v=4","gravatar_id":"","url":"https://api.github.com/users/marcphilipp","html_url":"https://github.com/marcphilipp","followers_url":"https://api.github.com/users/marcphilipp/followers","following_url":"https://api.github.com/users/marcphilipp/following{/other_user}","gists_url":"https://api.github.com/users/marcphilipp/gists{/gist_id}","starred_url":"https://api.github.com/users/marcphilipp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcphilipp/subscriptions","organizations_url":"https://api.github.com/users/marcphilipp/orgs","repos_url":"https://api.github.com/users/marcphilipp/repos","events_url":"https://api.github.com/users/marcphilipp/events{/privacy}","received_events_url":"https://api.github.com/users/marcphilipp/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":5,"closed_issues":13,"state":"open","created_at":"2025-08-15T10:55:40Z","updated_at":"2025-11-07T16:58:56Z","due_on":null,"closed_at":null},"comments":71,"created_at":"2022-12-15T08:36:39Z","updated_at":"2025-11-06T15:37:15Z","closed_at":"2025-11-06T15:37:07Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!-- Please provide us the version of JUnit 5 you are using and, if possible, a failing unit test with your bug report. Don't forget to describe the rationale for this issue (e.g. expected vs. actual behavior). -->\r\n\r\nJUnit only parallel executor service relies on a ForkJoinPool. Unfortunately, this does not play well with code also using ForkJoinPools.\r\n\r\nThe observed issue is that, when activating parallel tests, JUnit uses `ForkJoinPoolHierarchicalTestExecutorService`. However, our tests are also using `ForkJoinPool`s and `ForkJoinTask`s. The orchestration of the test awaits for the completion of those tasks before moving on in the tests.\r\nBut the issue is that `ForkJoinTask` and `ForkJoinWorkerThread` are capable of detecting the use of the FJP framework ([here](https://github.com/openjdk/jdk/blob/98fa48c330941efe6588a907b383802a11ed0e6b/src/java.base/share/classes/java/util/concurrent/ForkJoinTask.java#L411-L415) for example) and react to it. As JUnit tasks and the project tasks are in different ForkJoinPools, they cannot help each other. This only results in more tests being started by already running and **incomplete** tests.\r\n\r\nThis can be an issue when tests are resource sensitive. For example, it may not be possible to open too many connections to a Database.\r\nTough not explicitly illustrated in this project, we also faced `StackOverflowError` because of recursive test executions in a single worker. In the following logs, produced by the reproducing project, we can see that two workers are recursively starting tests before finishing any:\r\n```console\r\nForkJoinPool-1-worker-1 starting a new test. Running: 2\r\nForkJoinPool-1-worker-2 starting a new test. Running: 1\r\nForkJoinPool-1-worker-1 starting a new test. Running: 3\r\nForkJoinPool-1-worker-1 starting a new test. Running: 4\r\nForkJoinPool-1-worker-1 starting a new test. Running: 5\r\nForkJoinPool-1-worker-2 starting a new test. Running: 6\r\nForkJoinPool-1-worker-1 starting a new test. Running: 7\r\nForkJoinPool-1-worker-1 starting a new test. Running: 8\r\nForkJoinPool-1-worker-1 starting a new test. Running: 9\r\nForkJoinPool-1-worker-2 starting a new test. Running: 10\r\nForkJoinPool-1-worker-1 starting a new test. Running: 11\r\nForkJoinPool-1-worker-1 starting a new test. Running: 12\r\nForkJoinPool-1-worker-1 starting a new test. Running: 14\r\nForkJoinPool-1-worker-2 starting a new test. Running: 13\r\nForkJoinPool-1-worker-1 starting a new test. Running: 15\r\nForkJoinPool-1-worker-1 starting a new test. Running: 16\r\nForkJoinPool-1-worker-1 starting a new test. Running: 17\r\nForkJoinPool-1-worker-1 starting a new test. Running: 18\r\nForkJoinPool-1-worker-2 starting a new test. Running: 19\r\nForkJoinPool-1-worker-1 starting a new test. Running: 20\r\n```\r\n> worker-1 started 15 tests, worker-2 started 5 tests\r\n\r\nIn actual code, given the location of the point of respawn, this can generate very large stacks.\r\n\r\nAn alternative implementation of the executor service, as shown in [this PR](https://github.com/junit-team/junit5/pull/2805), using a standard Thread Executor, would not show similar issues, at the expense of not ideally orchestrating multiple executions.\r\n\r\nLet's note that this is a very sneaky issue. Even in this project, we can see that the call to `ForkJoinTask#get` is not visible in the JUnit method. And it can be as deep as we want in the stack, even hidden to some users as it is happening in a used framework or tool. It may not be always possible for a user to detect that pattern.\r\n\r\n## Steps to reproduce\r\n\r\n<!-- Please insert a code snippet or a link to another repo along with instructions how to reproduce the issue here. The example should be minimal, complete and verifiable (see https://stackoverflow.com/help/mcve). -->\r\nSee this project https://github.com/OPeyrusse/junitforkjoinpool\r\nAfter building the project, run the test class `TestCalculator` (or look at the README if changed since opening this issue).\r\n\r\n## Context\r\n\r\n - Used versions (Jupiter/Vintage/Platform): 5.8.2, with the Jupiter runner\r\n - Build Tool/IDE: Build with Intellij, failing in Intellij and when running it with Maven\r\n - Maven Surefire version: 3.0.0-M5\r\n\r\n## Deliverables\r\n\r\n- [ ] At least one standard test executor not relying on the ForkJoinPool\r\n","closed_by":{"login":"marcphilipp","id":214207,"node_id":"MDQ6VXNlcjIxNDIwNw==","avatar_url":"https://avatars.githubusercontent.com/u/214207?v=4","gravatar_id":"","url":"https://api.github.com/users/marcphilipp","html_url":"https://github.com/marcphilipp","followers_url":"https://api.github.com/users/marcphilipp/followers","following_url":"https://api.github.com/users/marcphilipp/following{/other_user}","gists_url":"https://api.github.com/users/marcphilipp/gists{/gist_id}","starred_url":"https://api.github.com/users/marcphilipp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcphilipp/subscriptions","organizations_url":"https://api.github.com/users/marcphilipp/orgs","repos_url":"https://api.github.com/users/marcphilipp/repos","events_url":"https://api.github.com/users/marcphilipp/events{/privacy}","received_events_url":"https://api.github.com/users/marcphilipp/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/junit-team/junit-framework/issues/3108/reactions","total_count":8,"+1":8,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/junit-team/junit-framework/issues/3108/timeline","performed_via_github_app":null,"state_reason":"completed"}