{"url":"https://api.github.com/repos/junit-team/junit-framework/issues/2239","repository_url":"https://api.github.com/repos/junit-team/junit-framework","labels_url":"https://api.github.com/repos/junit-team/junit-framework/issues/2239/labels{/name}","comments_url":"https://api.github.com/repos/junit-team/junit-framework/issues/2239/comments","events_url":"https://api.github.com/repos/junit-team/junit-framework/issues/2239/events","html_url":"https://github.com/junit-team/junit-framework/issues/2239","id":593996802,"node_id":"MDU6SXNzdWU1OTM5OTY4MDI=","number":2239,"title":"assertTimeoutPreemptively should provide reference to future or executor service parameter","user":{"login":"doctorpangloss","id":2229300,"node_id":"MDQ6VXNlcjIyMjkzMDA=","avatar_url":"https://avatars.githubusercontent.com/u/2229300?v=4","gravatar_id":"","url":"https://api.github.com/users/doctorpangloss","html_url":"https://github.com/doctorpangloss","followers_url":"https://api.github.com/users/doctorpangloss/followers","following_url":"https://api.github.com/users/doctorpangloss/following{/other_user}","gists_url":"https://api.github.com/users/doctorpangloss/gists{/gist_id}","starred_url":"https://api.github.com/users/doctorpangloss/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/doctorpangloss/subscriptions","organizations_url":"https://api.github.com/users/doctorpangloss/orgs","repos_url":"https://api.github.com/users/doctorpangloss/repos","events_url":"https://api.github.com/users/doctorpangloss/events{/privacy}","received_events_url":"https://api.github.com/users/doctorpangloss/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":165165180,"node_id":"MDU6TGFiZWwxNjUxNjUxODA=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/type:%20enhancement","name":"type: enhancement","color":"84b6eb","default":false,"description":null},{"id":293473932,"node_id":"MDU6TGFiZWwyOTM0NzM5MzI=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/theme:%20programming%20model","name":"theme: programming model","color":"c7def8","default":false,"description":null},{"id":420911923,"node_id":"MDU6TGFiZWw0MjA5MTE5MjM=","url":"https://api.github.com/repos/junit-team/junit-framework/labels/component:%20Jupiter","name":"component: Jupiter","color":"11ee99","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"hisener","id":7688949,"node_id":"MDQ6VXNlcjc2ODg5NDk=","avatar_url":"https://avatars.githubusercontent.com/u/7688949?v=4","gravatar_id":"","url":"https://api.github.com/users/hisener","html_url":"https://github.com/hisener","followers_url":"https://api.github.com/users/hisener/followers","following_url":"https://api.github.com/users/hisener/following{/other_user}","gists_url":"https://api.github.com/users/hisener/gists{/gist_id}","starred_url":"https://api.github.com/users/hisener/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hisener/subscriptions","organizations_url":"https://api.github.com/users/hisener/orgs","repos_url":"https://api.github.com/users/hisener/repos","events_url":"https://api.github.com/users/hisener/events{/privacy}","received_events_url":"https://api.github.com/users/hisener/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"hisener","id":7688949,"node_id":"MDQ6VXNlcjc2ODg5NDk=","avatar_url":"https://avatars.githubusercontent.com/u/7688949?v=4","gravatar_id":"","url":"https://api.github.com/users/hisener","html_url":"https://github.com/hisener","followers_url":"https://api.github.com/users/hisener/followers","following_url":"https://api.github.com/users/hisener/following{/other_user}","gists_url":"https://api.github.com/users/hisener/gists{/gist_id}","starred_url":"https://api.github.com/users/hisener/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hisener/subscriptions","organizations_url":"https://api.github.com/users/hisener/orgs","repos_url":"https://api.github.com/users/hisener/repos","events_url":"https://api.github.com/users/hisener/events{/privacy}","received_events_url":"https://api.github.com/users/hisener/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/junit-team/junit-framework/milestones/49","html_url":"https://github.com/junit-team/junit-framework/milestone/49","labels_url":"https://api.github.com/repos/junit-team/junit-framework/milestones/49/labels","id":5319755,"node_id":"MDk6TWlsZXN0b25lNTMxOTc1NQ==","number":49,"title":"5.7 RC1","description":"","creator":{"login":"marcphilipp","id":214207,"node_id":"MDQ6VXNlcjIxNDIwNw==","avatar_url":"https://avatars.githubusercontent.com/u/214207?v=4","gravatar_id":"","url":"https://api.github.com/users/marcphilipp","html_url":"https://github.com/marcphilipp","followers_url":"https://api.github.com/users/marcphilipp/followers","following_url":"https://api.github.com/users/marcphilipp/following{/other_user}","gists_url":"https://api.github.com/users/marcphilipp/gists{/gist_id}","starred_url":"https://api.github.com/users/marcphilipp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcphilipp/subscriptions","organizations_url":"https://api.github.com/users/marcphilipp/orgs","repos_url":"https://api.github.com/users/marcphilipp/repos","events_url":"https://api.github.com/users/marcphilipp/events{/privacy}","received_events_url":"https://api.github.com/users/marcphilipp/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":64,"state":"closed","created_at":"2020-04-17T10:53:17Z","updated_at":"2020-08-16T16:54:15Z","due_on":"2020-08-16T07:00:00Z","closed_at":"2020-08-16T16:54:15Z"},"comments":3,"created_at":"2020-04-04T18:47:17Z","updated_at":"2020-08-02T12:50:19Z","closed_at":"2020-07-19T10:57:12Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"## Overview\r\n\r\nThe stack trace of the `future` used for `assertTimeoutPreemptively` provides valuable information for where a test thread gets \"stuck\" and is itself valuable for assertions.\r\n\r\n## Proposal\r\n\r\nProvide a reference to the `future` used to execute the code under test. This way, users can see, in their errors, where the code hung. Or, users can assert that, e.g., a blocking method correctly blocked.\r\n\r\nA robust way to do this, supporting whatever functionality users may want, would be to add a `assertTimeoutPreemptively` overload that accepts an `ExecutorService`. There, users can provide a `ThreadedPoolExecutor` with a `newTaskFor` overload.\r\n\r\nAlternatively, the `ExecutorService` can be provided by a `@Rule` (?) But I'm not too familiar with the big picture configuration for JUnit5.\r\n\r\nJUnit5 doesn't seem to use custom exceptions, not does it pass information about the assertion failure to callbacks. This seems to be the most flexible way to provide a look into the timeout that future library authors can use without changing conventions.\r\n\r\n## Deliverables\r\n\r\n - [ ] A new signature for `assertTimeoutPreemptively`:\r\n\r\n```java\r\npublic static <T> T assertTimeoutPreemptively(Duration timeout, ThrowingSupplier<T> supplier, Object messageOrSupplier, ExecutorService executorService)\r\n```\r\n\r\n## Workaround\r\n\r\nCopy and paste the implementation out of JUnit and modify it to print the failed thread's stack trace:\r\n\r\n```java\r\nstatic <T> T assertTimeoutPreemptively(Duration timeout, ThrowingSupplier<T> supplier,\r\n\t                                              Object messageOrSupplier) {\r\n\r\n\t\tvar thread = new AtomicReference<Thread>();\r\n\t\tvar factory = new ThreadFactory() {\r\n\t\t\t@Override\r\n\t\t\tpublic Thread newThread(@NotNull Runnable r) {\r\n\t\t\t\tthread.set(new Thread(r));\r\n\t\t\t\treturn thread.get();\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tExecutorService executorService = Executors.newSingleThreadExecutor(factory);\r\n\r\n\t\ttry {\r\n\t\t\tFuture<T> future = executorService.submit(() -> {\r\n\t\t\t\ttry {\r\n\t\t\t\t\treturn supplier.get();\r\n\t\t\t\t} catch (Throwable throwable) {\r\n\t\t\t\t\tthrow ExceptionUtils.throwAsUncheckedException(throwable);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t\tlong timeoutInMillis = timeout.toMillis();\r\n\t\t\ttry {\r\n\t\t\t\treturn future.get(timeoutInMillis, TimeUnit.MILLISECONDS);\r\n\t\t\t} catch (TimeoutException ex) {\r\n\t\t\t\tex.setStackTrace(thread.get().getStackTrace());\r\n\t\t\t\tthrow new AssertionFailedError(buildPrefix(nullSafeGet(messageOrSupplier))\r\n\t\t\t\t\t\t+ \"execution timed out after \" + timeoutInMillis + \" ms\\ntask stacktrace:\\n\" + Throwables.getStackTraceAsString(ex));\r\n\t\t\t} catch (ExecutionException ex) {\r\n\t\t\t\tthrow ExceptionUtils.throwAsUncheckedException(ex.getCause());\r\n\t\t\t} catch (Throwable ex) {\r\n\t\t\t\tthrow ExceptionUtils.throwAsUncheckedException(ex);\r\n\t\t\t}\r\n\t\t} finally {\r\n\t\t\texecutorService.shutdownNow();\r\n\t\t}\r\n\t}\r\n```","closed_by":{"login":"marcphilipp","id":214207,"node_id":"MDQ6VXNlcjIxNDIwNw==","avatar_url":"https://avatars.githubusercontent.com/u/214207?v=4","gravatar_id":"","url":"https://api.github.com/users/marcphilipp","html_url":"https://github.com/marcphilipp","followers_url":"https://api.github.com/users/marcphilipp/followers","following_url":"https://api.github.com/users/marcphilipp/following{/other_user}","gists_url":"https://api.github.com/users/marcphilipp/gists{/gist_id}","starred_url":"https://api.github.com/users/marcphilipp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcphilipp/subscriptions","organizations_url":"https://api.github.com/users/marcphilipp/orgs","repos_url":"https://api.github.com/users/marcphilipp/repos","events_url":"https://api.github.com/users/marcphilipp/events{/privacy}","received_events_url":"https://api.github.com/users/marcphilipp/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/junit-team/junit-framework/issues/2239/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/junit-team/junit-framework/issues/2239/timeline","performed_via_github_app":null,"state_reason":"completed"}