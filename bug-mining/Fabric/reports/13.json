{"url":"https://api.github.com/repos/fabric/fabric/issues/2204","repository_url":"https://api.github.com/repos/fabric/fabric","labels_url":"https://api.github.com/repos/fabric/fabric/issues/2204/labels{/name}","comments_url":"https://api.github.com/repos/fabric/fabric/issues/2204/comments","events_url":"https://api.github.com/repos/fabric/fabric/issues/2204/events","html_url":"https://github.com/fabric/fabric/issues/2204","id":1183452735,"node_id":"I_kwDOAALlkM5Gig4_","number":2204,"title":"Exception 'signal only works in main thread' when Connection.run command with pty=True","user":{"login":"francesco-giordano","id":8560837,"node_id":"MDQ6VXNlcjg1NjA4Mzc=","avatar_url":"https://avatars.githubusercontent.com/u/8560837?v=4","gravatar_id":"","url":"https://api.github.com/users/francesco-giordano","html_url":"https://github.com/francesco-giordano","followers_url":"https://api.github.com/users/francesco-giordano/followers","following_url":"https://api.github.com/users/francesco-giordano/following{/other_user}","gists_url":"https://api.github.com/users/francesco-giordano/gists{/gist_id}","starred_url":"https://api.github.com/users/francesco-giordano/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/francesco-giordano/subscriptions","organizations_url":"https://api.github.com/users/francesco-giordano/orgs","repos_url":"https://api.github.com/users/francesco-giordano/repos","events_url":"https://api.github.com/users/francesco-giordano/events{/privacy}","received_events_url":"https://api.github.com/users/francesco-giordano/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":135367304,"node_id":"MDU6TGFiZWwxMzUzNjczMDQ=","url":"https://api.github.com/repos/fabric/fabric/labels/Needs%20patch","name":"Needs patch","color":"fef2c0","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2022-03-28T13:34:29Z","updated_at":"2023-08-31T01:04:58Z","closed_at":"2023-08-31T01:04:58Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"**Describe the bug**\r\nWhen running a command with Connection.run and argument pty=True in a thread we get that error. fabric version 2.7.0\r\n\r\n**To Reproduce**\r\nSteps to reproduce the behaviour (please attach a minimal example):\r\nRunning the code below on fabric 2.6.0 everything work fine, while if it is run with 2.7.0 it fails due to this line https://github.com/fabric/fabric/blob/8a9336963581df8d84cc91c4191d16fe1873b4ea/fabric/runners.py#L46\r\n\r\n```python\r\nfrom fabric import Connection\r\nimport threading\r\ndef function(connection):\r\n    command=\"uptime\"\r\n    connection.run(command, warn=True, pty=True, hide=False, timeout=None)\r\n\r\nconnection_kwargs = {\r\n    \"host\":  <MY_IP>,\r\n    \"user\": <MY_USER>,\r\n    \"forward_agent\": False,\r\n    \"connect_kwargs\": {\"key_filename\": \"<PATH TO MY KEY>\"},\r\n}\r\nconnection = Connection(**connection_kwargs)\r\ncommand=\"uptime\"\r\n\r\nconnection.run(command, warn=True, pty=True, hide=False, timeout=None)\r\nt1=threading.Thread(target=function, args=(connection,))\r\nt1.start()\r\nt1.join()\r\n```\r\n\r\n**Expected behaviour**\r\nfabric works within a thread\r\n\r\n**Environment**\r\nBug seen in python 3.7.2 and 3.10.1\r\n\r\n- What version of the Python interpreter are you using? Are you using an\r\nalternative interpreter such as PyPy?\r\n- What operating system are you using both client & server-side? Ubuntu, centos and amazon linux as server and mac as client\r\n- Are you using OpenSSH server or something else? OpenSSH\r\n- Which version or versions of the software are you using?\r\n  - Have you already tried the latest release? yes\r\n  - Have you, or can you, try some older releases to pin down where the bug\r\n  appeared? 2.6.0 work fine\r\n- How can the developers recreate the bug on their end? If possible, include a\r\n  copy of your code, the command you used to invoke it, and the full output of\r\n  your run (if applicable.)\r\n```\r\n 13:28:46 up 3 days, 20:17,  1 user,  load average: 0.00, 0.00, 0.00\r\nException in thread Thread-5 (function):\r\nTraceback (most recent call last):\r\n  File \"/Users/giordafr/.pyenv/versions/3.10.1/lib/python3.10/threading.py\", line 1009, in _bootstrap_inner\r\n    self.run()\r\n  File \"/Users/giordafr/.pyenv/versions/3.10.1/lib/python3.10/threading.py\", line 946, in run\r\n    self._target(*self._args, **self._kwargs)\r\n  File \"/tmp/test.py\", line 5, in function\r\n    connection.run(command, warn=True, pty=True, hide=False, timeout=None)\r\n  File \"<decorator-gen-3>\", line 2, in run\r\n  File \"/Users/giordafr/.pyenv/versions/parallel-cluster-tests/lib/python3.10/site-packages/fabric/connection.py\", line 30, in opens\r\n    return method(self, *args, **kwargs)\r\n  File \"/Users/giordafr/.pyenv/versions/parallel-cluster-tests/lib/python3.10/site-packages/fabric/connection.py\", line 725, in run\r\n    return self._run(self._remote_runner(), command, **kwargs)\r\n  File \"/Users/giordafr/.pyenv/versions/parallel-cluster-tests/lib/python3.10/site-packages/invoke/context.py\", line 102, in _run\r\n    return runner.run(command, **kwargs)\r\n  File \"/Users/giordafr/.pyenv/versions/parallel-cluster-tests/lib/python3.10/site-packages/fabric/runners.py\", line 72, in run\r\n    return super(Remote, self).run(command, **kwargs)\r\n  File \"/Users/giordafr/.pyenv/versions/parallel-cluster-tests/lib/python3.10/site-packages/invoke/runners.py\", line 379, in run\r\n    return self._run_body(command, **kwargs)\r\n  File \"/Users/giordafr/.pyenv/versions/parallel-cluster-tests/lib/python3.10/site-packages/invoke/runners.py\", line 430, in _run_body\r\n    self.start(command, self.opts[\"shell\"], self.env)\r\n  File \"/Users/giordafr/.pyenv/versions/parallel-cluster-tests/lib/python3.10/site-packages/fabric/runners.py\", line 46, in start\r\n    signal.signal(signal.SIGWINCH, self.handle_window_change)\r\n  File \"/Users/giordafr/.pyenv/versions/3.10.1/lib/python3.10/signal.py\", line 47, in signal\r\n    handler = _signal.signal(_enum_to_int(signalnum), _enum_to_int(handler))\r\nValueError: signal only works in main thread of the main interpreter\r\n```\r\n","closed_by":{"login":"bitprophet","id":6088,"node_id":"MDQ6VXNlcjYwODg=","avatar_url":"https://avatars.githubusercontent.com/u/6088?v=4","gravatar_id":"","url":"https://api.github.com/users/bitprophet","html_url":"https://github.com/bitprophet","followers_url":"https://api.github.com/users/bitprophet/followers","following_url":"https://api.github.com/users/bitprophet/following{/other_user}","gists_url":"https://api.github.com/users/bitprophet/gists{/gist_id}","starred_url":"https://api.github.com/users/bitprophet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bitprophet/subscriptions","organizations_url":"https://api.github.com/users/bitprophet/orgs","repos_url":"https://api.github.com/users/bitprophet/repos","events_url":"https://api.github.com/users/bitprophet/events{/privacy}","received_events_url":"https://api.github.com/users/bitprophet/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/fabric/fabric/issues/2204/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/fabric/fabric/issues/2204/timeline","performed_via_github_app":null,"state_reason":"completed"}