<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Wed Nov 12 07:37:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF Jira</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SVN-4667] Merge uses large amount of memory</title>
                <link>https://issues.apache.org/jira/browse/SVN-4667</link>
                <project id="12318828" key="SVN">Subversion</project>
                    <description>&lt;p&gt;A WANdisco customer found that a merge will not complete with 4 GB RAM and will complete with 5 GB RAM available.&lt;/p&gt;

&lt;p&gt;The branches involved have subtree mergeinfo on over 3500 files, each referring to about 350 branches on average, and just over 1 revision range on average per mergeinfo line. Average path length is under 100 bytes. The total number of revisions in the repo is about 1 million.&lt;/p&gt;

&lt;p&gt;This seems already far too much memory usage for the size of the data set, and the size of the data set is growing.&lt;/p&gt;

&lt;p&gt;This issue is about reducing the amount of RAM Subversion uses given this data set. Another way to approach the problem is to reduce the amount of subtree mergeinfo by changing the work flow practices; that approach is also being investigated but is not in the scope of this issue, except to note that the tools &quot;svn-mergeinfo-normalizer&quot; and &quot;svn-clean-mergeinfo.pl&quot; both also fail to execute in the available RAM.&lt;/p&gt;

&lt;p&gt;(WANdisco&apos;s internal issue id: SVNB-1952.)&lt;/p&gt;

&lt;p&gt;(For reference, past issues about merge using too much memory include &lt;a href=&quot;https://issues.apache.org/jira/browse/SVN-3393&quot; title=&quot;Merge consuming too much memory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SVN-3393&quot;&gt;&lt;del&gt;SVN-3393&lt;/del&gt;&lt;/a&gt; &quot;Merge consuming too much memory&quot; and &lt;a href=&quot;https://issues.apache.org/jira/browse/SVN-3854&quot; title=&quot;Out of memory during merge with many Tree Conflicts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SVN-3854&quot;&gt;&lt;del&gt;SVN-3854&lt;/del&gt;&lt;/a&gt; &quot;Out of memory during merge with many Tree Conflicts&quot;.)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13031643">SVN-4667</key>
            <summary>Merge uses large amount of memory</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="julianfoad">Julian Foad</reporter>
                        <labels>
                    </labels>
                <created>Tue, 3 Jan 2017 12:09:20 +0000</created>
                <updated>Wed, 18 Jan 2017 15:38:37 +0000</updated>
                                            <version>1.9.4</version>
                                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="15794919" author="julianfoad" created="Tue, 3 Jan 2017 12:14:50 +0000"  >&lt;p&gt;I have made the following commits:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/r1776742&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1776742&lt;/a&gt; + &lt;a href=&quot;http://svn.apache.org/r1776783&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1776783&lt;/a&gt;: Reduce memory usage of merge by using a subpool for temporary mergeinfo.&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/r1776788&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1776788&lt;/a&gt;: Reduce memory usage of merge by using a subpool for temporary mergeinfo.&lt;/p&gt;</comment>
                            <comment id="15794920" author="julianfoad" created="Tue, 3 Jan 2017 12:15:39 +0000"  >&lt;p&gt;Stefan has made the following commit:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://svn.apache.org/r1776780&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;r1776780&lt;/a&gt;: Reduce the memory usage of the svn-mergeinfo-normalizer tool by tightening pool usage.&lt;/p&gt;</comment>
                            <comment id="15795158" author="julianfoad" created="Tue, 3 Jan 2017 14:17:58 +0000"  >&lt;p&gt;Attached &quot;repro-test-2.patch&quot;, a patch which adds the reproduction recipe I&apos;m using so far, in the form of a test case. It generates a repository with N=300 (for example) branches, each with a unique file changed, and merged to trunk such that trunk gets N files with subtree mergeinfo, each referring to up to N branches (half of N, on average).&lt;/p&gt;

&lt;p&gt;I can then run test merges, with debugging prints in them, to view the memory increase:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;# this runs a merge from trunk to branch,
# with WC directory &apos;A&apos; switched to a branch:
$ (cd obj-dir/subversion/tests/cmdline/svn-test-work/working_copies/mergeinfo_tests-14/ &amp;amp;&amp;amp; \
  svn revert -q -R A/ &amp;amp;&amp;amp; \
  svn merge -q ^/A A)
DBG: merge.c:12587: using 8+3 MB; increase +2 MB
DBG: merge.c:12418: using 8+25 MB; increase +21 MB
DBG: merge.c:12455: using 8+34 MB; increase +9 MB
DBG: merge.c:9378: using 8+37 MB; increase +3 MB
DBG: merge.c:9378: using 8+43 MB; increase +6 MB
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I don&apos;t know how representative this repro-test is of the customer&apos;s use case, but it provides a starting point.&lt;/p&gt;</comment>
                            <comment id="15795163" author="julianfoad" created="Tue, 3 Jan 2017 14:19:42 +0000"  >&lt;p&gt;The code I&apos;m using to print overall memory usage of the process (RSS in Linux) is:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;/* Return this process&apos;s memory usage (RSS) in MB. */
static int memory_rss_mb(void)
{
  struct rusage rusage;
  getrusage(RUSAGE_SELF, &amp;amp;rusage);
  return rusage.ru_maxrss / 1024;
}

static int _mem_base = -1, _mem_last = 0;

#define MEMORY_USAGE() \
  { int _mem_now = memory_rss_mb(), _mem_increase = _mem_now - _mem_last; \
  if (_mem_base &amp;lt; 0) _mem_base = _mem_now; \
  else if (_mem_increase &amp;gt; 1) \
  SVN_DBG((&quot;using %d+%d MB; increase %+d MB&quot;, \
           _mem_base, _mem_now - _mem_base, _mem_increase)); \
  _mem_last = _mem_now; \
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;followed by, in many places in interesting parts of subversion/libsvn_client/merge.c,&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;  MEMORY_USAGE();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15795165" author="julianfoad" created="Tue, 3 Jan 2017 14:20:35 +0000"  >&lt;p&gt;The two commits mentioned earlier introduce subpools to discard temporary mergeinfo after use. There are no doubt more possibilities to tighten the memory usage using subpools. This approach might be very useful, but seems unlikely to deliver an order-of-magnitude or an order-of-complexity reduction that probably will be needed.&lt;/p&gt;

&lt;p&gt;I would like to try a different approach. We read, parse and store all the mergeinfo present at once, whereas I believe our merge algorithm is only interested in the mergeinfo that refers to one of exactly two branches (&apos;source&apos; and &apos;target&apos;) in a typical merge. The algorithm never searches the &apos;graph&apos; of merge ancestry beyond those two branches. We should be able to read, parse and store only the mergeinfo we need.&lt;/p&gt;

&lt;p&gt;Another possible approach could be to store subtree mergeinfo in a &quot;delta&quot; form relative to a parent path&apos;s mergeinfo.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13035583">SVN-4669</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12845392" name="repro-test-1.patch" size="3725" author="julianfoad" created="Tue, 3 Jan 2017 14:18:11 +0000"/>
                            <attachment id="12845393" name="repro-test-2.patch" size="5165" author="julianfoad" created="Tue, 3 Jan 2017 14:18:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 46 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313020" key="com.atlassian.jira.toolkit:message">
                        <customfieldname>Mailing List</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3877b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>