<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 21:38:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[SLING-11662] Endless loop in QuartzSchedulerThread.run() with maxPoolSize == queueSize</title>
                <link>https://issues.apache.org/jira/browse/SLING-11662</link>
                <project id="12310710" key="SLING">Sling</project>
                    <description>&lt;p&gt;When configuring the ThreadPool with maxPoolSize == queueSize and endless loop (can) happen(s) in QuartzSchedulerThread.run() which manifests as follows:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;MyPool_QuartzSchedulerThread&quot; #123 prio=5 os_prio=0 cpu=5123456.78ms elapsed=5163.45s tid=0x000012345678ff00 nid=0x1234 runnable  [0x000087654321ff00]
   java.lang.Thread.State: RUNNABLE
        at org.quartz.core.QuartzSchedulerThread.run(QuartzSchedulerThread.java:413)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13494569">SLING-11662</key>
            <summary>Endless loop in QuartzSchedulerThread.run() with maxPoolSize == queueSize</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stefanegli">Stefan Egli</assignee>
                                    <reporter username="stefanegli">Stefan Egli</reporter>
                        <labels>
                    </labels>
                <created>Thu, 3 Nov 2022 11:59:56 +0000</created>
                <updated>Mon, 16 Dec 2024 11:00:33 +0000</updated>
                            <resolved>Thu, 5 Dec 2024 09:49:10 +0000</resolved>
                                    <version>Commons Scheduler 2.7.12</version>
                                    <fixVersion>Commons Scheduler 2.7.14</fixVersion>
                                    <component>Commons</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="17628292" author="egli" created="Thu, 3 Nov 2022 12:07:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/sling-org-apache-sling-commons-scheduler/pull/6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR created&lt;/a&gt; that reproduces the 100% cpu / endless loop in QuartzSchedulerThread.run()&lt;/p&gt;</comment>
                            <comment id="17628427" author="egli" created="Thu, 3 Nov 2022 17:18:01 +0000"  >&lt;p&gt;The problem with the endless loop seems to be due to a breach of contract by sling.commons.scheduler.QuartzThreadPool:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/quartz-scheduler/quartz/blob/v2.3.2/quartz-core/src/main/java/org/quartz/spi/ThreadPool.java#L69-L82&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;quartz&apos; ThreadPool javadoc&lt;/a&gt; says that
&lt;blockquote&gt;&lt;p&gt;The implementation of this method should block until there is at least one available thread.&lt;/p&gt;&lt;/blockquote&gt;&lt;/li&gt;
	&lt;li&gt;however &lt;a href=&quot;https://github.com/apache/sling-org-apache-sling-commons-scheduler/blob/a9ddf38ea9d9962c8938a381135827072fc9397f/src/main/java/org/apache/sling/commons/scheduler/impl/QuartzThreadPool.java#L80&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;sling.commons.scheduler.QuartzThreadPool#blockForAvailableThreads&lt;/a&gt; does not guarantee &lt;tt&gt;&amp;gt;0&lt;/tt&gt; - and in particular if &quot;maxPoolSize == queueSize&quot; then this method will return 0&lt;/li&gt;
	&lt;li&gt;that in turn leads quartz to hit the &lt;a href=&quot;https://github.com/quartz-scheduler/quartz/blob/v2.3.2/quartz-core/src/main/java/org/quartz/core/QuartzSchedulerThread.java#L411-L414&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ironically commented line&lt;/a&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; { &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(availThreadCount &amp;gt; 0)
&lt;/span&gt;                    &lt;span class=&quot;code-comment&quot;&gt;// should never happen, &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; threadPool.blockForAvailableThreads() follows contract
&lt;/span&gt;                    &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!halted)
&lt;/span&gt;                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;so it will just .. continue&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;now this game repeats for ever after until .. the CPU becomes too hot due to constant 100% spinning and it breaks down .. leading to damage in a datacenter and so on and so forth&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Presumably quartz did nothing wrong here - other than perhaps add a safety/paranoia &lt;tt&gt;Thread.sleep(1);&lt;/tt&gt; before that &lt;tt&gt;continue&lt;/tt&gt; to avoid this. The problem is rather on the sling side.&lt;/p&gt;

&lt;p&gt;Question is how to best fix this.. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cziegeler&quot; class=&quot;user-hover&quot; rel=&quot;cziegeler&quot;&gt;cziegeler&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=joerghoh&quot; class=&quot;user-hover&quot; rel=&quot;joerghoh&quot;&gt;joerghoh&lt;/a&gt;, any suggestions?&lt;/p&gt;</comment>
                            <comment id="17628434" author="cziegeler" created="Thu, 3 Nov 2022 17:25:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefanegli&quot; class=&quot;user-hover&quot; rel=&quot;stefanegli&quot;&gt;stefanegli&lt;/a&gt; I guess we need to change the implementation in Slings QuartzThreadPool to block if there is no available thread. The thread should wait until a thread is available again in the pool. Not sure if we have a trigger for this where we can put a notify. otherwise we would need to implement a sleep loop, probably with a larger sleep than 1 ms to avoid the same situation.&lt;br/&gt;
Update: we can probably use runInThread to call the notify.&lt;/p&gt;</comment>
                            <comment id="17628443" author="egli" created="Thu, 3 Nov 2022 17:36:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cziegeler&quot; class=&quot;user-hover&quot; rel=&quot;cziegeler&quot;&gt;cziegeler&lt;/a&gt;, what I was wondering what the idea of the original (current) implementation of blockForAvailableThreads was.. is there a reason it looks at (static) configuration rather than actual threads vs queued runnables?&lt;/p&gt;</comment>
                            <comment id="17628445" author="egli" created="Thu, 3 Nov 2022 17:39:31 +0000"  >&lt;p&gt;(and if there was a reason then we could prevent activation when &lt;tt&gt;maxPoolSize==queueSize&lt;/tt&gt; is configured)&lt;/p&gt;</comment>
                            <comment id="17628696" author="cziegeler" created="Fri, 4 Nov 2022 06:17:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefanegli&quot; class=&quot;user-hover&quot; rel=&quot;stefanegli&quot;&gt;stefanegli&lt;/a&gt; I think this is just due to a misunderstanding of the API contract (we can also call it a bug),&lt;/p&gt;</comment>
                            <comment id="17635165" author="cziegeler" created="Thu, 17 Nov 2022 06:37:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefanegli&quot; class=&quot;user-hover&quot; rel=&quot;stefanegli&quot;&gt;stefanegli&lt;/a&gt; I updated the branch with a potential fix by introducing a simple counter for the available threads. at least the tests pass now&lt;/p&gt;</comment>
                            <comment id="17635219" author="egli" created="Thu, 17 Nov 2022 08:59:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cziegeler&quot; class=&quot;user-hover&quot; rel=&quot;cziegeler&quot;&gt;cziegeler&lt;/a&gt;, great thx! I&apos;ll have a look as soon as possible, was also planning to add perhaps another test case or so (but have to first check how much coverage there is for these edge cases)..&lt;/p&gt;</comment>
                            <comment id="17771032" author="cziegeler" created="Mon, 2 Oct 2023 10:03:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefanegli&quot; class=&quot;user-hover&quot; rel=&quot;stefanegli&quot;&gt;stefanegli&lt;/a&gt; Any update here? Should we merge?&lt;/p&gt;</comment>
                            <comment id="17771066" author="egli" created="Mon, 2 Oct 2023 12:22:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cziegeler&quot; class=&quot;user-hover&quot; rel=&quot;cziegeler&quot;&gt;cziegeler&lt;/a&gt;, thx for reactivating this - got lost in the noise indeed. I&apos;ll have a look at the PR.&lt;/p&gt;</comment>
                            <comment id="17903280" author="egli" created="Thu, 5 Dec 2024 09:49:10 +0000"  >&lt;p&gt;PR &lt;a href=&quot;https://github.com/apache/sling-org-apache-sling-commons-scheduler/pull/6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/sling-org-apache-sling-commons-scheduler/pull/6&lt;/a&gt; merged, marking ticket resolved now&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            48 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1as5s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>