<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:28:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[MATH-937] NoBracketingException after event was found</title>
                <link>https://issues.apache.org/jira/browse/MATH-937</link>
                <project id="12310485" key="MATH">Commons Math</project>
                    <description>&lt;p&gt;The BracketingNthOrderBrentSolver used by the EmbeddedRungeKuttaIntegrator fails, if an event is detected twice with a NoBracketingException.&lt;/p&gt;

&lt;p&gt;The problem lies in line EventState.java line 262 (version 3.1.1). Here the event detection function f is applied to an arbitrary choosen value of time. If the event detector crosses zero before this time, the solver throws the mentioned exception.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12634597">MATH-937</key>
            <summary>NoBracketingException after event was found</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="choeger">Christoph H&#246;ger</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Feb 2013 11:48:28 +0000</created>
                <updated>Sun, 7 Apr 2013 09:19:50 +0000</updated>
                            <resolved>Wed, 13 Mar 2013 21:54:49 +0000</resolved>
                                    <version>3.1.1</version>
                                    <fixVersion>3.2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13589463" author="choeger" created="Thu, 28 Feb 2013 11:49:47 +0000"  >&lt;p&gt;A model and a Junit test case that demonstrate the problem.&lt;/p&gt;</comment>
                            <comment id="13589472" author="choeger" created="Thu, 28 Feb 2013 12:05:33 +0000"  >&lt;p&gt;Note that this does not happen with an euler integrator.&lt;/p&gt;</comment>
                            <comment id="13590463" author="choeger" created="Fri, 1 Mar 2013 12:31:01 +0000"  >&lt;p&gt;I had a look at TestProblem4. Here (in class Bounce) a sign variable is introduced. This quirk seems to fix my problem too. This might be a problem with the event detection funtion g. &lt;/p&gt;

&lt;p&gt;The documentation states that: &lt;/p&gt;

&lt;p&gt;&amp;gt; The switching function must be continuous in its roots neighborhood&lt;/p&gt;

&lt;p&gt;So it needs to be continuous &lt;em&gt;after&lt;/em&gt; an event as well? The documentation should clearly state that if it is the case IMO, since events are usually used to implement non-continuous behavior in a system.&lt;/p&gt;</comment>
                            <comment id="13590613" author="luc" created="Fri, 1 Mar 2013 15:11:09 +0000"  >&lt;p&gt;I have analyzed the problem.&lt;/p&gt;

&lt;p&gt;As you identified yourself, the function is not continuous near the zero. In fact, it is both discontinuous as you wrote in the comment above, and it reverts its slope. I&apos;m not sure we can identify this in all cases. This is exactly the reason why we have written in the javadoc that continuity is required in the &lt;b&gt;neighborhood&lt;/b&gt; of the root, i.e. both just before and just after the event. I will improve the documentation in this case.&lt;/p&gt;

&lt;p&gt;What happens under the hood is that we use a solver to locate the instant at which the function crosses 0. For this, we need continuity before the event is triggered. Then, if the event did not trigger a stop, the integrator continues after the event. In order to detect the next event properly, it needs to have a state corresponding to what happens just after the event. If computations were perfect, the value g0 = g(t0) should be exactly 0, but due to convergence criteria, it may be slightly non-zero. So we store t0, g0 and a boolean g0Positive that indicate that indicates the sign just after t0. This helps keeping everything consistent.&lt;/p&gt;

&lt;p&gt;In this issue, the event occurs as the g function decreases from positive to negative values. We find a very good estimate of the root at t0 = 1.4278431229270647, which corresponds to g0 = g(t0) = -2.7755575615628914E-16. It is very close to zero and the solver properly selected a value after the real root, i.e. a negative one. As additional protection the g0Positive was properly set to false, i.e. we are really sure after the event the function should (and in fact is) negative.&lt;/p&gt;

&lt;p&gt;However, the user code explicitly changes the slope at this time and the function starts to increase again. This is of course what the user wants because we want the function to represent something bouncing on the floor, i.e. when the altitude decreases down to zero, it should increase again. So the function does not really &lt;b&gt;crosses&lt;/b&gt; the zero line, it reaches it and then we change it. As numerical inaccuracies arise, we introduce a discontinuity near the zero and in fact create another which really occurs before the one we have already detected. Then the algorithm gets lost as it did not expect this discontinuity.&lt;/p&gt;

&lt;p&gt;We have already identified this problem when we developed TestProblem4 and we introduced the sign attribute in the Bounce event class exactly for this reason. This sign attribute helps preserving consistency of the g function on both sides of the event.&lt;/p&gt;

&lt;p&gt;So I would say we cannot improve the code here, but we should probably explain better the problem and show the sign trick to users. We could write something like:&lt;/p&gt;

&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;improved javadoc&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;The discrete events are generated when the sign of this&lt;br/&gt;
switching function changes. The integrator will take care to change&lt;br/&gt;
the stepsize in such a way these events occur exactly at step boundaries.&lt;/p&gt;

&lt;p&gt;The switching function must be continuous in its roots neighborhood&lt;br/&gt;
(but not necessarily smooth), as the integrator will need to find its&lt;br/&gt;
roots to locate precisely the events.&lt;/p&gt;

&lt;p&gt;Also note that the integrator expect that once an event has occurred, the&lt;br/&gt;
sign of the switching function at the start of the next step (i.e. just&lt;br/&gt;
after the event) is the opposite of the sign just before the event. This&lt;br/&gt;
consistency between the steps &lt;b&gt;must&lt;/b&gt; be preserved, otherwise exceptions&lt;br/&gt;
related to root not being bracketed will occur.&lt;/p&gt;

&lt;p&gt;This need for consistency is sometimes tricky to achieve. A typical example&lt;br/&gt;
is using an event to model a ball bouncing on the floor. The first idea to&lt;br/&gt;
represent this would be to have g(t) = h(t) where h is the height above the floor&lt;br/&gt;
at time t. When g(t) reaches 0, the ball is on the floor, so it should bounce&lt;br/&gt;
and the typical way to do this is to reverse its vertical velocity. However,&lt;br/&gt;
this would mean that before the event g(t) was decreasing from positive values&lt;br/&gt;
to 0, and after the event g(t) would be increasing from 0 to positive values&lt;br/&gt;
again. Consistency is broken here! The solution here is to have g(t) = sign * h(t),&lt;br/&gt;
where sign is a variable that starts at +1. Then, each time eventOccurred is called,&lt;br/&gt;
sign should be reset to -sign. This allows the g(t) function to remain continuous&lt;br/&gt;
(and even smooth) even across events, despite h(t) is not. &lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Would this be OK for you?&lt;/p&gt;</comment>
                            <comment id="13590632" author="choeger" created="Fri, 1 Mar 2013 15:28:56 +0000"  >&lt;p&gt;Hey, &lt;/p&gt;

&lt;p&gt;thanks for the response and the in-depth explanation. I think the changed javadoc is fine, except I would mention @&lt;/p&gt;
{link: NoBracketingException}
&lt;p&gt; explicitly, as people will probably google first before reading the docs (sad but true). &lt;/p&gt;

&lt;p&gt;I tried to workaround the issue by adding an explicit check in the solver code. Unfortunately it failed a test, but what speaks against testing the bracketing or even catching the exception and just go on without detecting an event? I would be willing to implement it if someone would be willing to review my implementation &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                            <comment id="13590726" author="luc" created="Fri, 1 Mar 2013 17:16:01 +0000"  >&lt;p&gt;OK, I&apos;ll do the javadoc change with the link you suggest.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure about ignoring the exception, so if you want to give it a try, I&apos;ll review your proposal.&lt;br/&gt;
If we go along this way, we should take care to ignore &lt;b&gt;only&lt;/b&gt; this specific exception, as there can be&lt;br/&gt;
many other reasons for which we fail to find the root of arbitrary functions provided by user, and such&lt;br/&gt;
failures should be reported.&lt;/p&gt;

&lt;p&gt;The call is already set up to force bracketing, and as you noticed, when it fails to do so there is a&lt;br/&gt;
reason for failure. In this case, it was because we found the same event again because the function was&lt;br/&gt;
&quot;almost&quot; continuous (the discontinuity was at computing precision level). Here, ignoring the error and&lt;br/&gt;
continuing would have been the way to go. I&apos;m not sure this would always be the case, and I&apos;m not sure&lt;br/&gt;
either that the algorithm can recover a sane state after this occurs. So we have to see what you propose&lt;br/&gt;
befre deciding to implement it or not. &lt;/p&gt;</comment>
                            <comment id="13590750" author="luc" created="Fri, 1 Mar 2013 17:37:31 +0000"  >&lt;p&gt;Javadoc updated as of r1451658.&lt;/p&gt;</comment>
                            <comment id="13601716" author="luc" created="Wed, 13 Mar 2013 21:54:49 +0000"  >&lt;p&gt;As there are no further comments, we set the issue as fixed.&lt;/p&gt;</comment>
                            <comment id="13624831" author="luc" created="Sun, 7 Apr 2013 09:19:50 +0000"  >&lt;p&gt;Closing issue as version 3.2 has been released on 2013-04-06.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12571404" name="ApacheCommonsBouncingBall.java" size="1391" author="choeger" created="Thu, 28 Feb 2013 11:49:47 +0000"/>
                            <attachment id="12571405" name="ApacheCommonsBouncingBallTest.java" size="751" author="choeger" created="Thu, 28 Feb 2013 11:49:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>315090</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 32 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1idfb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>315434</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>