<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:26:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[MATH-282] ChiSquaredDistributionImpl.cumulativeProbability &gt; 1</title>
                <link>https://issues.apache.org/jira/browse/MATH-282</link>
                <project id="12310485" key="MATH">Commons Math</project>
                    <description>&lt;p&gt;Calling &lt;br/&gt;
new ChiSquaredDistributionImpl(1.0).cumulativeProbability(66.41528551683048)&lt;/p&gt;

&lt;p&gt;returns 1.000000000000004, which is bogus (should never be &amp;gt; 1)&lt;/p&gt;</description>
                <environment>&lt;p&gt;called from Scala code&lt;/p&gt;</environment>
        <key id="12432549">MATH-282</key>
            <summary>ChiSquaredDistributionImpl.cumulativeProbability &gt; 1</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="psteitz">Phil Steitz</assignee>
                                    <reporter username="akiezun">Adam Kiezun</reporter>
                        <labels>
                    </labels>
                <created>Fri, 7 Aug 2009 18:24:07 +0000</created>
                <updated>Tue, 13 Apr 2010 10:26:15 +0000</updated>
                            <resolved>Mon, 8 Mar 2010 23:00:26 +0000</resolved>
                                    <version>1.0</version>
                    <version>1.1</version>
                    <version>1.2</version>
                    <version>2.0</version>
                                    <fixVersion>2.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12740905" author="luc" created="Sat, 8 Aug 2009 16:05:08 +0000"  >&lt;p&gt;The problem seems to be related to numerical accuracy.&lt;br/&gt;
The computation here involves lots of iterations in the Gamma.regularizedGammaP method (115 iterations on my computer) and the final expression involves several transcendant functions (exp, log and logGamma).&lt;/p&gt;

&lt;p&gt;The proposed patch simply filters out the values exceeding 1.0 in the gamma distribution implementation which is used by Chi squared distribution.&lt;/p&gt;

&lt;p&gt;I am not sure this is the best fix to this issue, so I won&apos;t commit it myself. I prefer someone else could verify it.&lt;/p&gt;</comment>
                            <comment id="12741113" author="psteitz" created="Sun, 9 Aug 2009 18:07:36 +0000"  >&lt;p&gt;I am working on getting a bound in terms of the arguments for the Gamma distribution similar to what we do for the Normal distribution, so we can return 1 when we know that the tail probability is going to be bounded above by a sufficiently small number - say, 10E-20.   &lt;/p&gt;</comment>
                            <comment id="12741161" author="psteitz" created="Mon, 10 Aug 2009 01:20:00 +0000"  >&lt;p&gt;Unfortunately, from R and &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, it looks like the value in the issue report should be ~ 1 - 10^-13, and I don&apos;t like the idea of top-coding with such a tight bound. Need to look at the regularized gamma approximation.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &quot;The Moment Bound Is Tighter Than Chernoff&apos;s Bound for Positive Tail Probabilities&quot;, Thomas K Philips, Randolph Nelson,  American Statistician 1995 vol. 49 (May, 1995) pp. 175-178&lt;/p&gt;</comment>
                            <comment id="12764514" author="psteitz" created="Sun, 11 Oct 2009 21:53:35 +0000"  >&lt;p&gt;The problem in Gamma.regularizedGammaP reported here is also causing incorrect results from PoissonDistributionImpl#cumulativeProbability.  The (currently disabled) test case, testCumulativeProbabilitySpecial() in PoissonDistributionTest illustrates the problem.  For some (not all) large lambda and some (not all) x in (0.9 * lambda, lambda), NaN or zero cumulative probabilities are returned.&lt;/p&gt;</comment>
                            <comment id="12836590" author="psteitz" created="Mon, 22 Feb 2010 12:04:27 +0000"  >&lt;p&gt;I have narrowed this down to two issues in Gamma&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;choice of when to use the series expansion vs continued fraction in computing the regularized gamma functions - changing from (a &amp;gt;= 1.0 &amp;amp;&amp;amp; x &amp;gt; a) to (x &amp;gt; a + 1) as criteria for when to use continued fraction reduces incidence of NaN values returned and improves accuracy for some arguments.&lt;/li&gt;
	&lt;li&gt;handling the case when the continued fraction diverges.  I am still working on convincing myself that divergence is expected in failing test cases, in which case, logic can be changed to catch the continued fraction divergence and fall back to the series approximation in that case.  This will require refactoring the regularizedGammaP and Q functions to encapsulate the series / fraction computation instead of calling one another based on argument test.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12839654" author="psteitz" created="Mon, 1 Mar 2010 11:50:49 +0000"  >&lt;p&gt;The attached patch resolves this issue as well as &lt;a href=&quot;https://issues.apache.org/jira/browse/MATH-301&quot; title=&quot;Erf(z) should return 1.0 for z &amp;#39;large&amp;#39; but  fails with a MaxIterationsExceededException for z &amp;gt; 26.0.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;MATH-301&quot;&gt;&lt;del&gt;MATH-301&lt;/del&gt;&lt;/a&gt; and the problems described above with the Poisson distribution.  The patch bundles quite a few changes, some of which are not strictly necessary to resolve these issues.  The following is a summary.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;BrentSolver has been changed to expose its configured absolute accuracy.   This solver is used by the default inverse cum implementation in AbstractContinuousDistribution and the hard-coded setting (1E-6) was limiting accuracy in inverse cumulative probability estimates.  AbstractContinuousDistribution was changed to allow distributions to set this value and NormalDistributionImpl was changed to set it to 1E-9 by default and allow users to configure it via a constructor argument.   If all are happy with this change, I will similarly change other distributions to override the new getSolverAbsoluteAccuracy method and add constructors to configure the value.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;AbstractContinuousDistribution and AbstractIntegerDistribution inverseCumulativeProbability methods have been modified to check for NaN values returned by cumulativeProbability and throw MathExceptions when this happens.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;The criteria for choosing between the Lanczos series and continued fraction expansion when computing regularized gamma functions has been changed to (x &amp;gt;= a + 1).  When using the series approximation (regularizedGammaP), divergence to infinity is checked and when this happens, 1 is returned.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;When scaling continued fractions to (try to) avoid divergence to infinity, the larger of a and b is used as a scale factor and the attempt to scale is repeated up to 5 times, using successive powers of the scale factor.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;The maximum number of iterations used in estimating cumulative probabilities for PoissonDistributionImpl has been decreased from Integer.MAX_VALUE to 10000000 and made configurable.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Review and comment much appreciated.  One thing that I would like improve is to get decent top-coding in place in terms of the arguments to the regularized gamma functions.  The Poisson inverse cum tests take a very long time now because for very large values of x, the continued fractions are taking a long time to converge.  This is needless computation, as the value returned is 1.  We should be able to analytically determine bounds here.&lt;/p&gt;</comment>
                            <comment id="12839809" author="luc" created="Mon, 1 Mar 2010 19:25:39 +0000"  >&lt;p&gt;This looks fine to me (congrats for the error messages translations).&lt;br/&gt;
I am a little puzzled by the MathException thrown in some methods to be caught in the same method and wrapped in a FunctionEvaluationException. Could the MathException be a FunctionEvaluationException from the start (even if other MathException can be thrown and need to be wrapped by themselves) ?&lt;/p&gt;</comment>
                            <comment id="12839839" author="psteitz" created="Mon, 1 Mar 2010 20:18:25 +0000"  >&lt;p&gt;Thanks, Luc! &lt;/p&gt;

&lt;p&gt;Here is the perhaps strange logic explaining the odd exception nesting that you pointed out.  When a cumulativeProbability function returns NaN in the context of estimating inverse cum, the immediate exception is really a bad-value-returned exception, not a FunctionEvaluationException - there is no exception encountered evaluating the function, it just returns a bad value - so I code it as MathException.  The exception that the caller gets is FunctionEvaluationException, because there is in fact an error evaluating the inverse cum.  Wrapped inside is the MathException with the message indicating that NaN was returned by a cum activation.   &lt;/p&gt;

&lt;p&gt;I guess it comes down to how we view FunctionEvaluationException and in particular is it appropriate to throw when NaN is returned by a method that logically should not return NaNs.  Thinking some more about this, I think so, so I will change the patch to throw FunctionEvaluationException in the first incidence.&lt;/p&gt;

&lt;p&gt;Thanks again for looking at this carefully.  I am glad I got the translations right - the one I was worried about was as much English as French - &quot;diverge to NaN&quot; makes me cringe a little &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12842838" author="psteitz" created="Mon, 8 Mar 2010 23:00:26 +0000"  >&lt;p&gt;Fixed in r920558&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12437655">MATH-301</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12437474" name="distributions.patch" size="25526" author="psteitz" created="Mon, 1 Mar 2010 11:50:49 +0000"/>
                            <attachment id="12415937" name="math-282.patch" size="1898" author="luc" created="Sat, 8 Aug 2009 16:05:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>34161</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 37 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0rvev:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>160733</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>