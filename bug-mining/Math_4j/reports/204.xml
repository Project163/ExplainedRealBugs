<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:27:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[MATH-434] SimplexSolver returns unfeasible solution</title>
                <link>https://issues.apache.org/jira/browse/MATH-434</link>
                <project id="12310485" key="MATH">Commons Math</project>
                    <description>&lt;p&gt;The SimplexSolver is returning an unfeasible solution:&lt;/p&gt;

&lt;p&gt;import java.util.ArrayList;&lt;br/&gt;
import java.text.DecimalFormat;&lt;br/&gt;
import org.apache.commons.math.linear.ArrayRealVector;&lt;br/&gt;
import org.apache.commons.math.optimization.GoalType;&lt;br/&gt;
import org.apache.commons.math.optimization.OptimizationException;&lt;br/&gt;
import org.apache.commons.math.optimization.linear.*;&lt;/p&gt;

&lt;p&gt;public class SimplexSolverBug {&lt;/p&gt;

&lt;p&gt;    public static void main(String[] args) throws OptimizationException {&lt;/p&gt;

&lt;p&gt;        LinearObjectiveFunction c = new LinearObjectiveFunction(new double[]&lt;/p&gt;
{0.0d, 1.0d, 1.0d, 0.0d, 0.0d, 0.0d, 0.0d}
&lt;p&gt;, 0.0d);&lt;/p&gt;

&lt;p&gt;        ArrayList&amp;lt;LinearConstraint&amp;gt; cnsts = new ArrayList&amp;lt;LinearConstraint&amp;gt;(5);&lt;br/&gt;
        LinearConstraint cnst;&lt;br/&gt;
        cnst = new LinearConstraint(new double[] &lt;/p&gt;
{1.0d, -0.1d, 0.0d, 0.0d, 0.0d, 0.0d, 0.0d}
&lt;p&gt;, Relationship.EQ, -0.1d);&lt;br/&gt;
        cnsts.add(cnst);&lt;br/&gt;
        cnst = new LinearConstraint(new double[] &lt;/p&gt;
{1.0d, 0.0d, 0.0d, 0.0d, 0.0d, 0.0d, 0.0d}
&lt;p&gt;, Relationship.GEQ, -1e-18d);&lt;br/&gt;
        cnsts.add(cnst);&lt;br/&gt;
        cnst = new LinearConstraint(new double[] &lt;/p&gt;
{0.0d, 1.0d, 0.0d, 0.0d, 0.0d, 0.0d, 0.0d}
&lt;p&gt;, Relationship.GEQ, 0.0d);&lt;br/&gt;
        cnsts.add(cnst);&lt;br/&gt;
        cnst = new LinearConstraint(new double[] &lt;/p&gt;
{0.0d, 0.0d, 0.0d, 1.0d, 0.0d, -0.0128588d, 1e-5d}
&lt;p&gt;, Relationship.EQ, 0.0d);&lt;br/&gt;
        cnsts.add(cnst);&lt;br/&gt;
        cnst = new LinearConstraint(new double[] &lt;/p&gt;
{0.0d, 0.0d, 0.0d, 0.0d, 1.0d, 1e-5d, -0.0128586d}
&lt;p&gt;, Relationship.EQ, 1e-10d);&lt;br/&gt;
        cnsts.add(cnst);&lt;br/&gt;
        cnst = new LinearConstraint(new double[] &lt;/p&gt;
{0.0d, 0.0d, 1.0d, -1.0d, 0.0d, 0.0d, 0.0d}
&lt;p&gt;, Relationship.GEQ, 0.0d);&lt;br/&gt;
        cnsts.add(cnst);&lt;br/&gt;
        cnst = new LinearConstraint(new double[] &lt;/p&gt;
{0.0d, 0.0d, 1.0d, 1.0d, 0.0d, 0.0d, 0.0d}
&lt;p&gt;, Relationship.GEQ, 0.0d);&lt;br/&gt;
        cnsts.add(cnst);&lt;br/&gt;
        cnst = new LinearConstraint(new double[] &lt;/p&gt;
{0.0d, 0.0d, 1.0d, 0.0d, -1.0d, 0.0d, 0.0d}
&lt;p&gt;, Relationship.GEQ, 0.0d);&lt;br/&gt;
        cnsts.add(cnst);&lt;br/&gt;
        cnst = new LinearConstraint(new double[] &lt;/p&gt;
{0.0d, 0.0d, 1.0d, 0.0d, 1.0d, 0.0d, 0.0d}
&lt;p&gt;, Relationship.GEQ, 0.0d);&lt;br/&gt;
        cnsts.add(cnst);&lt;/p&gt;

&lt;p&gt;        DecimalFormat df = new java.text.DecimalFormat(&quot;0.#####E0&quot;);&lt;/p&gt;

&lt;p&gt;        System.out.println(&quot;Constraints:&quot;);&lt;br/&gt;
        for(LinearConstraint con : cnsts) &lt;/p&gt;
{
            for (int i = 0; i &amp;lt; con.getCoefficients().getDimension(); ++i)
                System.out.print(df.format(con.getCoefficients().getData()[i]) + &quot; &quot;);
            System.out.println(con.getRelationship() + &quot; &quot; + con.getValue());
        }

&lt;p&gt;        SimplexSolver simplex = new SimplexSolver(1e-7);&lt;br/&gt;
        double[] sol = simplex.optimize(c, cnsts, GoalType.MINIMIZE, false).getPointRef();&lt;br/&gt;
        System.out.println(&quot;Solution:\n&quot; + new ArrayRealVector(sol));&lt;br/&gt;
        System.out.println(&quot;Second constraint is violated!&quot;);&lt;br/&gt;
    }&lt;br/&gt;
}&lt;/p&gt;


&lt;p&gt;It&apos;s an odd problem, but something I ran across.  I tracked the problem to the getPivotRow routine in SimplexSolver.  It was choosing a pivot that resulted in a negative right-hand-side.  I recommend a fix by replacing&lt;br/&gt;
                ...&lt;br/&gt;
                if (MathUtils.equals(ratio, minRatio, epsilon)) {&lt;br/&gt;
                ...&lt;br/&gt;
with&lt;br/&gt;
                ...&lt;br/&gt;
                if (MathUtils.equals(ratio, minRatio, Math.abs(epsilon/entry))) {&lt;br/&gt;
                ...&lt;/p&gt;

&lt;p&gt;I believe this would be more appropriate (and at least resolves this particular problem).&lt;/p&gt;

&lt;p&gt;Also, you may want to consider making a change in getPivotColumn to replace&lt;br/&gt;
            ...&lt;br/&gt;
            if (MathUtils.compareTo(tableau.getEntry(0, i), minValue, epsilon) &amp;lt; 0) {&lt;br/&gt;
            ...&lt;br/&gt;
with&lt;br/&gt;
            ...&lt;br/&gt;
            if (tableau.getEntry(0, i) &amp;lt; minValue) &lt;br/&gt;
            ...&lt;br/&gt;
because I don&apos;t see the point of biasing earlier columns when multiple entries are within epsilon of each other.  Why not pick the absolute smallest.  I don&apos;t know that any problem can result from doing it the other way, but the latter may be a safer bet.&lt;/p&gt;

&lt;p&gt;VERY IMPORTANT: I discovered another bug that occurs when not restricting to non-negatives.  In SimplexTableu::getSolution(), &lt;br/&gt;
          ...          &lt;br/&gt;
          if (basicRows.contains(basicRow)) &lt;br/&gt;
              // if multiple variables can take a given value&lt;br/&gt;
              // then we choose the first and set the rest equal to 0&lt;br/&gt;
              coefficients&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt; = 0;&lt;br/&gt;
          ...&lt;br/&gt;
should be&lt;br/&gt;
          ...          &lt;br/&gt;
          if (basicRows.contains(basicRow)) {&lt;br/&gt;
              // if multiple variables can take a given value&lt;br/&gt;
              // then we choose the first and set the rest equal to 0&lt;br/&gt;
              coefficients&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt; = (restrictToNonNegative ? 0 : -mostNegative);&lt;br/&gt;
          ...&lt;br/&gt;
If necessary, I can give an example of where this bug causes a problem, but it should be fairly obvious why this was wrong.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12479313">MATH-434</key>
            <summary>SimplexSolver returns unfeasible solution</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="wmwitzel">Wayne Witzel</reporter>
                        <labels>
                    </labels>
                <created>Sun, 7 Nov 2010 03:55:32 +0000</created>
                <updated>Sat, 24 Mar 2012 16:16:29 +0000</updated>
                            <resolved>Sat, 9 Apr 2011 19:21:59 +0000</resolved>
                                    <version>2.1</version>
                                    <fixVersion>3.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12929443" author="wmwitzel" created="Mon, 8 Nov 2010 03:30:34 +0000"  >&lt;p&gt;My original suggested fix had a potential for overflow errors (since minRatio is initialized to Double.MAX_VALUE).  Also, I added another suggestion and pointed out another bug which leads to invalid solutions.&lt;/p&gt;</comment>
                            <comment id="12929508" author="erans" created="Mon, 8 Nov 2010 08:52:39 +0000"  >&lt;p&gt;Could you attach unit tests that demonstrate each problem?  Thank you.&lt;/p&gt;</comment>
                            <comment id="12931688" author="wmwitzel" created="Sat, 13 Nov 2010 15:45:43 +0000"  >&lt;p&gt;I&apos;ll try to send some examples soon.  I&apos;m noticing more problems with the right-hand-side going negative and want to cover all bases (as much as possible).&lt;/p&gt;</comment>
                            <comment id="12931848" author="wmwitzel" created="Sun, 14 Nov 2010 18:03:46 +0000"  >&lt;p&gt;Code, and resulting output, that illustrates issues with the SimplexSolver.&lt;/p&gt;</comment>
                            <comment id="12975154" author="psteitz" created="Sun, 26 Dec 2010 20:02:06 +0000"  >&lt;p&gt;Pushing out to 3.0.&lt;/p&gt;</comment>
                            <comment id="12980570" author="bmccann" created="Wed, 12 Jan 2011 05:49:30 +0000"  >&lt;p&gt;Hey, sorry I took so long to look at this.  I&apos;ve had very little time and am not working on this stuff anymore.  I&apos;m honestly not going to be able to look at this stuff much moving forward, so hopefully there&apos;s a Commons Math contributor that can act as a reviewer.&lt;/p&gt;

&lt;p&gt;When you say it&apos;s choosing a pivot with a negative RHS, I&apos;m assuming that means it&apos;s not within the epsilon?&lt;br/&gt;
Why would it be more appropriate to divide by the entry?  I&apos;m not sure I see why you&apos;d want to use a bigger epsilon when the entry is 0.1 and a smaller epsilon when the entry is 10.  Maybe we should just make the default epsilon smaller?  I&apos;m no expert with floating point math so I&apos;m not real sure how to set the epsilon and just made up a value.&lt;br/&gt;
...&lt;br/&gt;
if (MathUtils.equals(ratio, minRatio, epsilon)) {&lt;br/&gt;
...&lt;br/&gt;
with&lt;br/&gt;
...&lt;br/&gt;
if (MathUtils.equals(ratio, minRatio, Math.abs(epsilon/entry))) {&lt;/p&gt;</comment>
                            <comment id="13015234" author="tn" created="Sun, 3 Apr 2011 22:24:36 +0000"  >&lt;p&gt;Attached a patch for the reported problems.&lt;br/&gt;
The problems can be split into two groups:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;wrong solution calculation with negative&lt;br/&gt;
   variables&lt;/li&gt;
	&lt;li&gt;failing to select an appropriate pivot&lt;br/&gt;
   row when values are below a given &lt;br/&gt;
   epsilon&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The patch addresses both problems:&lt;/p&gt;

&lt;p&gt; 1. fix in SimplexTableau.getSolution()&lt;br/&gt;
 2. use BigReal for arbitrary precision  &lt;br/&gt;
    support when selecting the pivot row&lt;/p&gt;

&lt;p&gt;Additionally, 4 test cases are included, as well as a minor typo fix for a method name.&lt;/p&gt;

&lt;p&gt;The fixed epsilon is also used in some other places of the code, this may also create problems under certain circumstances. So if this patch is accepted, the other places could also be adapted.&lt;/p&gt;</comment>
                            <comment id="13015549" author="luc" created="Mon, 4 Apr 2011 19:00:31 +0000"  >&lt;p&gt;Thanks Thomas.&lt;/p&gt;

&lt;p&gt;I had a look at the patch. I&apos;m not a big fan of using BigReal, mainly when we don&apos;t specify a scale and we don&apos;t link it to the choice for epsilon. Also reading back Ben comments, I wonder if we should not replace epsilon by an integer number of ulps with a default set to a very small value (say something like 10 ulps).&lt;/p&gt;

&lt;p&gt;What problem did you see in the accuracy of the variables to use BigReal ?&lt;/p&gt;</comment>
                            <comment id="13015626" author="tn" created="Mon, 4 Apr 2011 21:24:30 +0000"  >&lt;p&gt;Hi Luc,&lt;/p&gt;

&lt;p&gt;my initial idea was to use an epsilon that is adjusted to the magnitude of the respective value used for comparison. To be honest, I was not aware of &lt;span class=&quot;error&quot;&gt;&amp;#91;Math,FastMath&amp;#93;&lt;/span&gt;.ulp, therefore I went with BigReal/BigDecimal to circumvent the problem in another way (by using an arbitrary precision datatype). After reading your comment, I investigated more into the problem, e.g. using &lt;a href=&quot;http://www.cygnus-software.com/papers/comparingfloats/Comparing%20floating%20point%20numbers.htm&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.cygnus-software.com/papers/comparingfloats/Comparing%20floating%20point%20numbers.htm&lt;/a&gt;, and addressed it (hopefully correct) in the way you proposed.&lt;/p&gt;

&lt;p&gt;Though, I had to split up the epsilon test into two categories:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;general comparison of floating-point values: using ulp, as values can be arbitrarily small&lt;/li&gt;
	&lt;li&gt;algorithm convergence check: using a standard epsilon, as the algorithm may not converge due to limited precision of&lt;br/&gt;
    the double datatype otherwise&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Please find attached my updated patch, any comments are welcome (e.g. I was unsure whether to expose the maxUlps parameter in the constructor, or to use a generic comparison epsilon, e.g. using FastMath.ulp(1d) instead of one adjusted to the current value in question).&lt;/p&gt;</comment>
                            <comment id="13015628" author="tn" created="Mon, 4 Apr 2011 21:25:24 +0000"  >&lt;p&gt;updated patch, incorporating comments from luc&lt;/p&gt;</comment>
                            <comment id="13015853" author="erans" created="Tue, 5 Apr 2011 10:56:51 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Pardon the possibly na&#239;ve questions.&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;In &quot;SimplexTableau&quot;:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Why not use directly &quot;equals(double, double, int)&quot; from &quot;MathUtils&quot; instead of computing an epsilon with &quot;getEpsilon&quot;?&lt;/li&gt;
	&lt;li&gt;Why is the &quot;isOptimal&quot; method not using the adjusted &quot;epsilon&quot; (at line 385)?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13015875" author="tn" created="Tue, 5 Apr 2011 11:32:04 +0000"  >&lt;p&gt;hmm, I feel a bit stupid now, as I have re-implemented MathUtils.equals(double, double, int) but in a mediocre way. So all calls to getEpsilon should be replaced with the equivalent MathUtils.equals.&lt;/p&gt;

&lt;p&gt;for the isOptimal:&lt;/p&gt;

&lt;p&gt;the idea was to have a user-defined threshold for the convergence criteria, which defaults to the original value of 1e-6. Using the same adjusted epsilon would possibly lead to more iterations as before. As the feasibility check in SimplexSolver.solvePhase1 has to use a static epsilon for convergence reasons, I thought to use the same epsilon in isOptimal makes sense for symmetry reasons (use the same epsilon to check for convergence /feasibility).&lt;/p&gt;

&lt;p&gt;But it&apos;s good that you raise these points, because I was hesitating myself what is the best way to go forward, as I am also not considering myself a floating-point expert. I am mainly interested in the simplex algorithm, that&apos;s why I have chosen to provide a patch for this (very nice) implementation of it.&lt;/p&gt;</comment>
                            <comment id="13017940" author="luc" created="Sat, 9 Apr 2011 19:21:59 +0000"  >&lt;p&gt;Fixed in subversion repository as of r1090656.&lt;br/&gt;
Path applied with a very small change: adding the maxUlps parameter to the detailed constructor.&lt;/p&gt;

&lt;p&gt;Thanks for the report and thanks for the patch.&lt;/p&gt;</comment>
                            <comment id="13018415" author="tn" created="Mon, 11 Apr 2011 16:21:00 +0000"  >&lt;p&gt;Thanks for accepting the patch. The comparison using maxUlps has already been adapted according to &lt;a href=&quot;https://issues.apache.org/jira/browse/MATH-557&quot; title=&quot;add a compareTo method to MathUtils that use a number of ulps for equality tolerance&quot; class=&quot;issue-link&quot; data-issue-key=&quot;MATH-557&quot;&gt;&lt;del&gt;MATH-557&lt;/del&gt;&lt;/a&gt;, but it was missing for SimplexTableau. The cleanup patch fixes this and also renames the test names for similarity.&lt;/p&gt;</comment>
                            <comment id="13018464" author="luc" created="Mon, 11 Apr 2011 17:59:29 +0000"  >&lt;p&gt;Cleanup patch applied.&lt;/p&gt;

&lt;p&gt;thanks again&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12476012" name="MATH-434-cleanup.patch" size="3785" author="tn" created="Mon, 11 Apr 2011 16:21:00 +0000"/>
                            <attachment id="12475430" name="MATH-434-version2.patch" size="18314" author="tn" created="Mon, 4 Apr 2011 21:25:23 +0000"/>
                            <attachment id="12475332" name="MATH-434.patch" size="9498" author="tn" created="Sun, 3 Apr 2011 22:24:36 +0000"/>
                            <attachment id="12459563" name="SimplexSolverIssues.java" size="8863" author="wmwitzel" created="Sun, 14 Nov 2010 18:03:46 +0000"/>
                            <attachment id="12459565" name="SimplexSolverIssuesOutput.txt" size="1967" author="wmwitzel" created="Sun, 14 Nov 2010 18:04:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>34167</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 32 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0rui7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>160586</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>