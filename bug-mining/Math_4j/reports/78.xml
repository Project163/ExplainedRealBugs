<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 20:26:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[MATH-294] RandomDataImpl.nextPoisson fails for means in range 6.0 - 19.99</title>
                <link>https://issues.apache.org/jira/browse/MATH-294</link>
                <project id="12310485" key="MATH">Commons Math</project>
                    <description>&lt;p&gt;math.random.RandomDataImpl.nextPoisson(double mean) fails frequently (but not always) for values of mean between 6.0 and 19.99 inclusive. For values below 6.0 (where I see there is a branch in the logic) and above 20.0 it seems to be okay (though I&apos;ve only randomly sampled the space and run a million trials for the values I&apos;ve tried)&lt;/p&gt;

&lt;p&gt;When it fails, the exception is as follows (this for a mean of 6.0)&lt;/p&gt;

&lt;p&gt;org.apache.commons.math.MathRuntimeException$4: must have n &amp;gt;= 0 for n!, got n = -2&lt;br/&gt;
	at org.apache.commons.math.MathRuntimeException.createIllegalArgumentException(MathRuntimeException.java:282)&lt;br/&gt;
	at org.apache.commons.math.util.MathUtils.factorialLog(MathUtils.java:561)&lt;br/&gt;
	at org.apache.commons.math.random.RandomDataImpl.nextPoisson(RandomDataImpl.java:434) &lt;/p&gt;

&lt;p&gt;ie MathUtils.factorialLog is being called with a negative input&lt;/p&gt;

&lt;p&gt;To reproduce:&lt;/p&gt;

&lt;p&gt;    JDKRandomGenerator random = new JDKRandomGenerator();&lt;br/&gt;
    random.setSeed(123456);&lt;br/&gt;
    RandomData randomData = new RandomDataImpl(random);&lt;/p&gt;

&lt;p&gt;    for (int i=0; i&amp;lt; 1000000; i++)&lt;/p&gt;
{
        randomData.nextPoisson(6.0);
    }</description>
                <environment>&lt;p&gt;Java 1.6 on mac osX&lt;/p&gt;</environment>
        <key id="12435449">MATH-294</key>
            <summary>RandomDataImpl.nextPoisson fails for means in range 6.0 - 19.99</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="mcfall">Jason McFall</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Sep 2009 17:34:29 +0000</created>
                <updated>Wed, 14 Apr 2010 00:20:03 +0000</updated>
                            <resolved>Mon, 12 Oct 2009 02:08:12 +0000</resolved>
                                    <version>1.2</version>
                    <version>2.0</version>
                                    <fixVersion>2.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12754704" author="luc" created="Sun, 13 Sep 2009 14:45:08 +0000"  >&lt;p&gt;The failure seems to be related with a wrong detection of out of bound cases.&lt;br/&gt;
In the example given the failure occurs at iteration 125 on my computer (Open JDK 1.6, Linux, 64bits). At the beginning of the loop, the u = nextUniform(0.0, c) random drawing leads to a value u smaller than c1. So the first branch of the if is taken and another random drawing is done : z = nextGaussian(0.0, 1.0) which leads to a value for x far below mu (x = -8, mu = 2).&lt;/p&gt;

&lt;p&gt;This is detected as w is set to positive infinity, but in fact this is not sufficient. The &quot;accept&quot; boolean is still computed despite it will always be false.&lt;/p&gt;

&lt;p&gt;The attached patch is an attempt to compute &quot;accept&quot; only in some cases and to force it to &quot;false&quot; in other cases without computation.&lt;/p&gt;

&lt;p&gt;I did &lt;b&gt;not&lt;/b&gt; check this in subversion because I would like some other people to have a look at it. I am not sure it does work properly because when I compute for example the mean of 200, 100000, 1000000 or 10000000 calls to nextPoisson(6.0), I always get values between 14.7 and 15.2. I have seen the variance of a Poisson distribution is the same as its mean and so could expect a large value, but this still looked strange to me.&lt;/p&gt;</comment>
                            <comment id="12755314" author="psteitz" created="Tue, 15 Sep 2009 02:30:11 +0000"  >&lt;p&gt;Lets hold on the patch for now.  We need to understand why the rejection algorithm is failing.  Based on a quick review of the reference in the javadoc (p. 511, X.3), it looks like the following line in the u &amp;lt; c_1 case should not be subtracting 1.0 at the end.&lt;/p&gt;

&lt;p&gt;y = -Math.abs(z) * Math.sqrt(mu) - 1.0;&lt;/p&gt;

&lt;p&gt;I have not tested the effect dropping the -1 here as I am still working through the algorithm.&lt;/p&gt;</comment>
                            <comment id="12760210" author="psteitz" created="Mon, 28 Sep 2009 10:45:17 +0000"  >&lt;p&gt;In r819492, I committed a goodness of fit test (testNextPoissionConistency) for the values generated by nextPoisson.  Currently, it tests only values up to 5.  When this issue is resolved, the upper bound in the test needs to be increased.&lt;/p&gt;

&lt;p&gt;I have not been able to rectify the current code so that it succeeds for all values and passes the test.  The implementation does not match the reference in the javadoc and the reference appears to contain errors.  If someone does not beat me to it or supply a patch that passes the test, I will find and implement a different version of the rejection algorithm for means &amp;gt; 6.&lt;/p&gt;</comment>
                            <comment id="12764528" author="psteitz" created="Mon, 12 Oct 2009 02:08:12 +0000"  >&lt;p&gt;Fixed in r824214&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12419421" name="math-294.patch" size="2530" author="luc" created="Sun, 13 Sep 2009 14:45:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>34180</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 6 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0rvcf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>160722</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>