diff --git a/test/load.js b/test/load.js
index 07f71e61..ee37dc51 100644
--- a/test/load.js
+++ b/test/load.js
@@ -1,4 +1,5 @@
-var smash = require("smash");
+var smash = require("smash"),
+    jsdom = require("jsdom");
 
 module.exports = function() {
   var files = [].slice.call(arguments).map(function(d) { return "src/" + d; }),
@@ -22,5 +23,11 @@ module.exports = function() {
     return topic;
   };
 
+  topic.document = function(_) {
+    var document = jsdom.jsdom("<html><head></head><body></body></html>");
+    sandbox = {document: document, window: document.createWindow()};
+    return topic;
+  };
+
   return topic;
 };
diff --git a/test/selection/append-test.js b/test/selection/append-test.js
index 77fa6578..11296eaa 100644
--- a/test/selection/append-test.js
+++ b/test/selection/append-test.js
@@ -1,35 +1,29 @@
 var vows = require("vows"),
-    d3 = require("../../"),
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("selection.append");
 
 suite.addBatch({
   "select(body)": {
-    topic: load("selection/selection").sandbox({
-      document: document,
-      window: window
-    }).expression("d3.select"),
+    topic: load("selection/append").document(),
     "on a simple page": {
-      topic: function(select) {
-        return select("body").html("");
+      topic: function(d3) {
+        return d3.select("body");
       },
       "appends an HTML element": function(body) {
         var div = body.append("div");
         assert.equal(div[0][0].tagName, "DIV");
         assert.isNull(div[0][0].namespaceURI);
-        assert.isTrue(div[0][0].parentNode === document.body);
-        assert.isTrue(div[0][0] === document.body.lastChild);
+        assert.isTrue(div[0][0].parentNode === body.node());
+        assert.isTrue(div[0][0] === body.node().lastChild);
       },
       "appends an SVG element": function(body) {
         var svg = body.append("svg:svg");
         assert.equal(svg[0][0].tagName, "SVG");
         assert.equal(svg[0][0].namespaceURI, "http://www.w3.org/2000/svg");
-        assert.isTrue(svg[0][0].parentNode === document.body);
-        assert.isTrue(svg[0][0] === document.body.lastChild);
+        assert.isTrue(svg[0][0].parentNode === body.node());
+        assert.isTrue(svg[0][0] === body.node().lastChild);
       },
       "propagates data to new element": function(body) {
         var data = new Object(), div = body.data([data]).append("div");
@@ -48,13 +42,10 @@ suite.addBatch({
 
 suite.addBatch({
   "selectAll(div)": {
-    topic: load("selection/selection").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/selection").document(),
     "on a simple page": {
       topic: function(d3) {
-        return d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div");
+        return d3.select("body").selectAll("div").data([0, 1]).enter().append("div");
       },
       "appends an HTML element": function(div) {
         var span = div.append("span");
@@ -87,39 +78,35 @@ suite.addBatch({
       },
       "returns a new selection": function(div) {
         assert.isFalse(div.append("div") === div);
+      },
+      "ignores null nodes": function(div) {
+        var node = div.html("")[0][1];
+        div[0][1] = null;
+        var span = div.append("span");
+        assert.equal(span[0].length, 2);
+        assert.equal(span[0][0].tagName, "SPAN");
+        assert.isNull(span[0][1]);
+        assert.isTrue(span[0][0].parentNode === div[0][0]);
+        assert.isTrue(div[0][0].lastChild === span[0][0]);
+        assert.isNull(node.lastChild);
       }
-    },
-    "ignores null nodes": function(d3) {
-      var div = d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div"),
-          some = d3.selectAll("div");
-      some[0][1] = null;
-      var span = some.append("span");
-      assert.equal(span[0].length, 2);
-      assert.equal(span[0][0].tagName, "SPAN");
-      assert.isNull(span[0][1]);
-      assert.isTrue(span[0][0].parentNode === div[0][0]);
-      assert.isTrue(div[0][0].lastChild === span[0][0]);
-      assert.isNull(div[0][1].lastChild);
     }
   }
 });
 
 suite.addBatch({
   "selectAll(div).data(â€¦).enter()": {
-    topic: load("selection/selection").sandbox({
-      document: document,
-      window: window
-    }).expression("d3.select"),
+    topic: load("selection/selection").document(),
     "on a simple page": {
-      topic: function(select) {
-        return select("body");
+      topic: function(d3) {
+        return d3.select("body");
       },
       "appends to the parent node": function(body) {
-        var div = body.html("").selectAll("div").data(d3.range(2)).enter().append("div");
+        var div = body.selectAll("div").data([0, 1]).enter().append("div");
         assert.equal(div.length, 1);
         assert.equal(div[0].length, 2);
-        assert.domEqual(div[0][0].parentNode, document.body);
-        assert.domEqual(div[0][1].parentNode, document.body);
+        assert.domEqual(div[0][0].parentNode, body.node());
+        assert.domEqual(div[0][1].parentNode, body.node());
       },
       "propagates data to new elements": function(body) {
         var a = new Object(), b = new Object(), div = body.html("").selectAll("div").data([a, b]).enter().append("div");
@@ -128,12 +115,12 @@ suite.addBatch({
       },
       "ignores null nodes": function(body) {
         body.html("").append("div");
-        var div = body.selectAll("div").data(d3.range(3)).enter().append("div");
+        var div = body.selectAll("div").data([0, 1, 2]).enter().append("div");
         assert.equal(div.length, 1);
         assert.equal(div[0].length, 3);
         assert.domNull(div[0][0]);
-        assert.domEqual(div[0][1].parentNode, document.body);
-        assert.domEqual(div[0][2].parentNode, document.body);
+        assert.domEqual(div[0][1].parentNode, body.node());
+        assert.domEqual(div[0][2].parentNode, body.node());
       }
     }
   }
diff --git a/test/selection/attr-test.js b/test/selection/attr-test.js
index 2e39b48b..6fd57def 100644
--- a/test/selection/attr-test.js
+++ b/test/selection/attr-test.js
@@ -1,65 +1,60 @@
 var vows = require("vows"),
-    d3 = require("../../"),
+    interpolateRgb = require("../../").interpolateRgb,
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("selection.attr");
 
 suite.addBatch({
   "select(body)": {
-    topic: load("selection/attr").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/attr").document(),
     "on a simple page": {
       topic: function(d3) {
         return d3.select("body");
       },
       "sets an attribute as a string": function(body) {
         body.attr("bgcolor", "red");
-        assert.equal(document.body.getAttribute("bgcolor"), "red");
+        assert.equal(body.node().getAttribute("bgcolor"), "red");
       },
       "sets an attribute as a number": function(body) {
         body.attr("opacity", 1);
-        assert.equal(document.body.getAttribute("opacity"), "1");
+        assert.equal(body.node().getAttribute("opacity"), "1");
       },
       "sets an attribute as a function": function(body) {
         body.attr("bgcolor", function() { return "orange"; });
-        assert.equal(document.body.getAttribute("bgcolor"), "orange");
+        assert.equal(body.node().getAttribute("bgcolor"), "orange");
       },
       "sets an attribute as a function of data": function(body) {
         body.data(["cyan"]).attr("bgcolor", String);
-        assert.equal(document.body.getAttribute("bgcolor"), "cyan");
+        assert.equal(body.node().getAttribute("bgcolor"), "cyan");
       },
       "sets an attribute as a function of index": function(body) {
         body.attr("bgcolor", function(d, i) { return "orange-" + i; });
-        assert.equal(document.body.getAttribute("bgcolor"), "orange-0");
+        assert.equal(body.node().getAttribute("bgcolor"), "orange-0");
       },
       "sets a namespaced attribute as a string": function(body) {
         body.attr("xlink:href", "url");
-        assert.equal(document.body.getAttributeNS("http://www.w3.org/1999/xlink", "href"), "url");
+        assert.equal(body.node().getAttributeNS("http://www.w3.org/1999/xlink", "href"), "url");
       },
       "sets a namespaced attribute as a function": function(body) {
         body.data(["orange"]).attr("xlink:href", function(d, i) { return d + "-" + i; });
-        assert.equal(document.body.getAttributeNS("http://www.w3.org/1999/xlink", "href"), "orange-0");
+        assert.equal(body.node().getAttributeNS("http://www.w3.org/1999/xlink", "href"), "orange-0");
       },
       "sets attributes as a map of constants": function(body) {
         body.attr({bgcolor: "white", "xlink:href": "url.png"});
-        assert.equal(document.body.getAttribute("bgcolor"), "white");
-        assert.equal(document.body.getAttributeNS("http://www.w3.org/1999/xlink", "href"), "url.png");
+        assert.equal(body.node().getAttribute("bgcolor"), "white");
+        assert.equal(body.node().getAttributeNS("http://www.w3.org/1999/xlink", "href"), "url.png");
       },
       "sets attributes as a map of functions": function(body) {
         body.data(["orange"]).attr({"xlink:href": function(d, i) { return d + "-" + i + ".png"; }});
-        assert.equal(document.body.getAttributeNS("http://www.w3.org/1999/xlink", "href"), "orange-0.png");
+        assert.equal(body.node().getAttributeNS("http://www.w3.org/1999/xlink", "href"), "orange-0.png");
       },
       "gets an attribute value": function(body) {
-        document.body.setAttribute("bgcolor", "yellow");
+        body.node().setAttribute("bgcolor", "yellow");
         assert.equal(body.attr("bgcolor"), "yellow");
       },
       "gets a namespaced attribute value": function(body) {
-        document.body.setAttributeNS("http://www.w3.org/1999/xlink", "foo", "bar");
+        body.node().setAttributeNS("http://www.w3.org/1999/xlink", "foo", "bar");
         assert.equal(body.attr("xlink:foo"), "bar");
       },
       "removes an attribute as null": function(body) {
@@ -79,18 +74,18 @@ suite.addBatch({
         assert.isNull(body.attr("xlink:href"));
       },
       "removes attributes as a map of null": function(body) {
-        document.body.setAttribute("bgcolor", "white");
-        document.body.setAttributeNS("http://www.w3.org/1999/xlink", "href", "foo.png");
+        body.node().setAttribute("bgcolor", "white");
+        body.node().setAttributeNS("http://www.w3.org/1999/xlink", "href", "foo.png");
         body.attr({bgcolor: null, "xlink:href": null});
-        assert.isNull(document.body.getAttribute("bgcolor"));
-        assert.isNull(document.body.getAttributeNS("http://www.w3.org/1999/xlink", "href"));
+        assert.isNull(body.node().getAttribute("bgcolor"));
+        assert.isNull(body.node().getAttributeNS("http://www.w3.org/1999/xlink", "href"));
       },
       "removes attributes as a map of functions that return null": function(body) {
-        document.body.setAttribute("bgcolor", "white");
-        document.body.setAttributeNS("http://www.w3.org/1999/xlink", "href", "foo.png");
+        body.node().setAttribute("bgcolor", "white");
+        body.node().setAttributeNS("http://www.w3.org/1999/xlink", "href", "foo.png");
         body.attr({bgcolor: function() {}, "xlink:href": function() {}});
-        assert.isNull(document.body.getAttribute("bgcolor"));
-        assert.isNull(document.body.getAttributeNS("http://www.w3.org/1999/xlink", "href"));
+        assert.isNull(body.node().getAttribute("bgcolor"));
+        assert.isNull(body.node().getAttributeNS("http://www.w3.org/1999/xlink", "href"));
       },
       "returns the current selection": function(body) {
         assert.isTrue(body.attr("foo", "bar") === body);
@@ -101,13 +96,10 @@ suite.addBatch({
 
 suite.addBatch({
   "selectAll(div)": {
-    topic: load("selection/attr").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/attr").document(),
     "on a simple page": {
       topic: function(d3) {
-        return d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div");
+        return d3.select("body").selectAll("div").data([0, 1]).enter().append("div");
       },
       "sets an attribute as a string": function(div) {
         div.attr("bgcolor", "red");
@@ -125,7 +117,7 @@ suite.addBatch({
         assert.equal(div[0][1].getAttribute("bgcolor"), "coral");
       },
       "sets an attribute as a function of data": function(div) {
-        div.attr("bgcolor", d3.interpolateRgb("brown", "steelblue"));
+        div.attr("bgcolor", interpolateRgb("brown", "steelblue"));
         assert.equal(div[0][0].getAttribute("bgcolor"), "#a52a2a");
         assert.equal(div[0][1].getAttribute("bgcolor"), "#4682b4");
       },
@@ -174,15 +166,15 @@ suite.addBatch({
       },
       "returns the current selection": function(div) {
         assert.isTrue(div.attr("foo", "bar") === div);
+      },
+      "ignores null nodes": function(div) {
+        var node = div[0][1];
+        div.attr("href", null);
+        div[0][1] = null;
+        div.attr("href", "url");
+        assert.equal(div[0][0].getAttribute("href"), "url");
+        assert.isNull(node.getAttribute("href"));
       }
-    },
-    "ignores null nodes": function(d3) {
-      var div = d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div"),
-          some = d3.selectAll("div");
-      some[0][1] = null;
-      some.attr("href", null).attr("href", "url");
-      assert.equal(div[0][0].getAttribute("href"), "url");
-      assert.isNull(div[0][1].getAttribute("href"));
     }
   }
 });
diff --git a/test/selection/call-test.js b/test/selection/call-test.js
index bb36792f..fe28387a 100644
--- a/test/selection/call-test.js
+++ b/test/selection/call-test.js
@@ -1,21 +1,15 @@
 var vows = require("vows"),
-    d3 = require("../../"),
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("selection.call");
 
 suite.addBatch({
   "select(body)": {
-    topic: load("selection/call").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/call").document(),
     "on a simple page": {
       topic: function(d3) {
-        return d3.select("body").html("");
+        return d3.select("body");
       },
       "calls the function once": function(body) {
         var count = 0;
@@ -46,13 +40,10 @@ suite.addBatch({
 
 suite.addBatch({
   "selectAll(div)": {
-    topic: load("selection/call").sandbox({
-      document: document,
-      window: window
-    }).expression("d3.select"),
+    topic: load("selection/call").document(),
     "on a simple page": {
-      topic: function(select) {
-        return select("body").html("").selectAll("div").data(d3.range(2)).enter().append("div");
+      topic: function(d3) {
+        return d3.select("body").selectAll("div").data([0, 1]).enter().append("div");
       },
       "calls the function once": function(div) {
         var count = 0;
diff --git a/test/selection/classed-test.js b/test/selection/classed-test.js
index b3e91a02..402b4f6b 100644
--- a/test/selection/classed-test.js
+++ b/test/selection/classed-test.js
@@ -1,50 +1,44 @@
 var vows = require("vows"),
-    d3 = require("../../"),
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("selection.classed");
 
 suite.addBatch({
   "select(body)": {
-    topic: load("selection/classed").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/classed").document(),
     "on a simple page": {
       topic: function(d3) {
-        return d3.select("body").html("");
+        return d3.select("body");
       },
       "adds a missing class as true": function(body) {
         body.attr("class", null);
         body.classed("foo", true);
-        assert.equal(document.body.className, "foo");
+        assert.equal(body.node().className, "foo");
         body.classed("bar", true);
-        assert.equal(document.body.className, "foo bar");
+        assert.equal(body.node().className, "foo bar");
       },
       "removes an existing class as false": function(body) {
         body.attr("class", "bar foo");
         body.classed("foo", false);
-        assert.equal(document.body.className, "bar");
+        assert.equal(body.node().className, "bar");
         body.classed("bar", false);
-        assert.equal(document.body.className, "");
+        assert.equal(body.node().className, "");
       },
       "preserves an existing class as true": function(body) {
         body.attr("class", "bar foo");
         body.classed("foo", true);
-        assert.equal(document.body.className, "bar foo");
+        assert.equal(body.node().className, "bar foo");
         body.classed("bar", true);
-        assert.equal(document.body.className, "bar foo");
+        assert.equal(body.node().className, "bar foo");
       },
       "preserves a missing class as false": function(body) {
         body.attr("class", "baz");
         body.classed("foo", false);
-        assert.equal(document.body.className, "baz");
+        assert.equal(body.node().className, "baz");
         body.attr("class", null);
         body.classed("bar", false);
-        assert.equal(document.body.className, "");
+        assert.equal(body.node().className, "");
       },
       "gets an existing class": function(body) {
         body.attr("class", " foo\tbar  baz");
@@ -61,94 +55,94 @@ suite.addBatch({
       "accepts a name with whitespace, collapsing it": function(body) {
         body.attr("class", null);
         body.classed(" foo\t", true);
-        assert.equal(document.body.className, "foo");
+        assert.equal(body.node().className, "foo");
         body.classed("\tfoo  ", false);
-        assert.equal(document.body.className, "");
+        assert.equal(body.node().className, "");
       },
       "accepts a name with multiple classes separated by whitespace": function(body) {
         body.attr("class", null);
         body.classed("foo bar", true);
-        assert.equal(document.body.className, "foo bar");
+        assert.equal(body.node().className, "foo bar");
         assert.isTrue(body.classed("foo bar"));
         assert.isTrue(body.classed("bar foo"));
         assert.isFalse(body.classed("foo bar baz"));
         assert.isFalse(body.classed("foob bar"));
         body.classed("bar foo", false);
-        assert.equal(document.body.className, "");
+        assert.equal(body.node().className, "");
       },
       "accepts a silly class name with unsafe characters": function(body) {
         body.attr("class", null);
         body.classed("foo.bar", true);
-        assert.equal(document.body.className, "foo.bar");
+        assert.equal(body.node().className, "foo.bar");
         assert.isTrue(body.classed("foo.bar"));
         assert.isFalse(body.classed("foo"));
         assert.isFalse(body.classed("bar"));
         body.classed("bar.foo", false);
-        assert.equal(document.body.className, "foo.bar");
+        assert.equal(body.node().className, "foo.bar");
         body.classed("foo.bar", false);
-        assert.equal(document.body.className, "");
+        assert.equal(body.node().className, "");
       },
       "accepts a name with duplicate classes, ignoring them": function(body) {
         body.attr("class", null);
         body.classed(" foo\tfoo  ", true);
-        assert.equal(document.body.className, "foo");
+        assert.equal(body.node().className, "foo");
         body.classed("\tfoo  foo ", false);
-        assert.equal(document.body.className, "");
+        assert.equal(body.node().className, "");
       },
       "accepts a value function returning true or false": function(body) {
         body.attr("class", null);
         body.classed("foo", function() { return true; });
-        assert.equal(document.body.className, "foo");
+        assert.equal(body.node().className, "foo");
         body.classed("foo bar", function() { return true; });
-        assert.equal(document.body.className, "foo bar");
+        assert.equal(body.node().className, "foo bar");
         body.classed("foo", function() { return false; });
-        assert.equal(document.body.className, "bar");
+        assert.equal(body.node().className, "bar");
       },
       "accepts a name object containing true or false": function(body) {
         body.attr("class", null);
         body.classed({foo: true});
-        assert.equal(document.body.className, "foo");
+        assert.equal(body.node().className, "foo");
         body.classed({bar: true, foo: false});
-        assert.equal(document.body.className, "bar");
+        assert.equal(body.node().className, "bar");
       },
       "accepts a name object containing a function returning true or false": function(body) {
         body.attr("class", null);
         body.classed({foo: function() { return true; }});
-        assert.equal(document.body.className, "foo");
+        assert.equal(body.node().className, "foo");
       },
       "accepts a name object containing a mix of functions and non-functions": function(body) {
         body.attr("class", "foo");
         body.classed({foo: false, bar: function() { return true; }});
-        assert.equal(document.body.className, "bar");
+        assert.equal(body.node().className, "bar");
       },
       "the value may be truthy or falsey": function(body) {
         body.attr("class", "foo");
         body.classed({foo: null, bar: function() { return 1; }});
-        assert.equal(document.body.className, "bar");
+        assert.equal(body.node().className, "bar");
       },
       "keys in the name object may contain whitespace": function(body) {
         body.attr("class", null);
         body.classed({" foo\t": function() { return true; }});
-        assert.equal(document.body.className, "foo");
+        assert.equal(body.node().className, "foo");
         body.attr("class", null);
       },
       "keys in the name object may reference multiple classes": function(body) {
         body.attr("class", null);
         body.classed({"foo bar": function() { return true; }});
-        assert.equal(document.body.className, "foo bar");
+        assert.equal(body.node().className, "foo bar");
         body.attr("class", null);
       },
       "keys in the name object may contain duplicates": function(body) {
         body.attr("class", null);
         body.classed({"foo foo": function() { return true; }});
-        assert.equal(document.body.className, "foo");
+        assert.equal(body.node().className, "foo");
         body.attr("class", null);
       },
       "value functions are only evaluated once when used for multiple classes": function(body) {
         var count = 0;
         body.attr("class", null);
         body.classed({"foo bar": function() { return ++count; }});
-        assert.equal(document.body.className, "foo bar");
+        assert.equal(body.node().className, "foo bar");
         assert.equal(count, 1);
       },
       "returns the current selection": function(body) {
@@ -160,13 +154,10 @@ suite.addBatch({
 
 suite.addBatch({
   "selectAll(div)": {
-    topic: load("selection/classed").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/classed").document(),
     "on a simple page": {
       topic: function(d3) {
-        return d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div");
+        return d3.select("body").selectAll("div").data([0, 1]).enter().append("div");
       },
       "adds a missing class as true": function(div) {
         div.attr("class", null);
@@ -262,15 +253,15 @@ suite.addBatch({
       },
       "returns the current selection": function(div) {
         assert.isTrue(div.classed("foo", true) === div);
+      },
+      "ignores null nodes": function(div) {
+        var node = div[0][1];
+        div.attr("class", null);
+        div[0][1] = null;
+        div.classed("foo", true);
+        assert.equal(div[0][0].className, "foo");
+        assert.equal(node.className, "");
       }
-    },
-    "ignores null nodes": function(d3) {
-      var div = d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div"),
-          some = d3.selectAll("div");
-      some[0][1] = null;
-      some.attr("class", null).classed("foo", true);
-      assert.equal(div[0][0].className, "foo");
-      assert.equal(div[0][1].className, "");
     }
   }
 });
diff --git a/test/selection/data-test.js b/test/selection/data-test.js
index 8cb73c8d..f12c30d2 100644
--- a/test/selection/data-test.js
+++ b/test/selection/data-test.js
@@ -1,35 +1,29 @@
 var vows = require("vows"),
-    d3 = require("../../"),
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("selection.data");
 
 suite.addBatch({
   "select(body)": {
-    topic: load("selection/selection").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/selection").document(),
     "on a simple page": {
       topic: function(d3) {
-        return d3.select("body").html("");
+        return d3.select("body");
       },
       "assigns data as an array": function(body) {
         var data = new Object();
         body.data([data]);
-        assert.strictEqual(document.body.__data__, data);
+        assert.strictEqual(body.node().__data__, data);
       },
       "assigns data as a function": function(body) {
         var data = new Object();
         body.data(function() { return [data]; });
-        assert.strictEqual(document.body.__data__, data);
+        assert.strictEqual(body.node().__data__, data);
       },
       "stores data in the DOM": function(body) {
         var expected = new Object(), actual;
-        document.body.__data__ = expected;
+        body.node().__data__ = expected;
         body.each(function(d) { actual = d; });
         assert.strictEqual(actual, expected);
       },
@@ -58,13 +52,10 @@ suite.addBatch({
 
 suite.addBatch({
   "selectAll(div)": {
-    topic: load("selection/data").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/data").document(),
     "on a simple page": {
       topic: function(d3) {
-        return d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div");
+        return d3.select("body").selectAll("div").data([0, 1]).enter().append("div");
       },
       "assigns data as an array": function(div) {
         var a = new Object(), b = new Object();
@@ -113,54 +104,59 @@ suite.addBatch({
         assert.strictEqual(data[1], b);
         assert.equal(data.length, 2);
       }
-    },
-    "ignores duplicate keys in both data and selection": function(d3) {
-      var div = d3.select("body").html("").selectAll("div")
-          .data(["aa", "ab", "ac", "ba", "bb", "bc"])
-        .enter().append("div")
-          .text(function(d) { return d; });
+    }
+  }
+});
+
+suite.addBatch({
+  "selectAll(div)": {
+    topic: load("selection/data").document(),
+    "on a simple page": {
+      "ignores duplicate keys in both data and selection": function(d3) {
+        var div = d3.select("body").html("").selectAll("div")
+            .data(["aa", "ab", "ac", "ba", "bb", "bc"])
+          .enter().append("div")
+            .text(function(d) { return d; });
 
-      var update = div.data(["aa", "ab", "ba", "bb"], function(d) { return d.substring(0, 1); }),
-          enter = update.enter(),
-          exit = update.exit();
+        var update = div.data(["aa", "ab", "ba", "bb"], function(d) { return d.substring(0, 1); }),
+            enter = update.enter(),
+            exit = update.exit();
 
-      assert.equal(update.length, 1);
+        assert.equal(update.length, 1);
 
-      // enter     - [   null,   null,   null,   null]
-      assert.equal(enter[0].length, 4);
-      assert.equal(enter[0][0], null);
-      assert.equal(enter[0][1], null);
-      assert.equal(enter[0][2], null);
-      assert.equal(enter[0][3], null);
+        // enter     - [   null,   null,   null,   null]
+        assert.equal(enter[0].length, 4);
+        assert.equal(enter[0][0], null);
+        assert.equal(enter[0][1], null);
+        assert.equal(enter[0][2], null);
+        assert.equal(enter[0][3], null);
 
-      // update    - [ aa (a),   null, ba (b),   null]
-      assert.equal(update[0].length, 4);
-      assert.strictEqual(update[0][0], div[0][0]);
-      assert.equal(update[0][1], null);
-      assert.strictEqual(update[0][2], div[0][3]);
-      assert.equal(update[0][3], null);
+        // update    - [ aa (a),   null, ba (b),   null]
+        assert.equal(update[0].length, 4);
+        assert.strictEqual(update[0][0], div[0][0]);
+        assert.equal(update[0][1], null);
+        assert.strictEqual(update[0][2], div[0][3]);
+        assert.equal(update[0][3], null);
 
-      // exit      - [   null, ab (a), ac (a),   null, bb (b), bc (b)]
-      assert.equal(exit[0].length, 6);
-      assert.equal(exit[0][0], null);
-      assert.strictEqual(exit[0][1], div[0][1]);
-      assert.strictEqual(exit[0][2], div[0][2]);
-      assert.equal(exit[0][3], null);
-      assert.strictEqual(exit[0][4], div[0][4]);
-      assert.strictEqual(exit[0][5], div[0][5]);
+        // exit      - [   null, ab (a), ac (a),   null, bb (b), bc (b)]
+        assert.equal(exit[0].length, 6);
+        assert.equal(exit[0][0], null);
+        assert.strictEqual(exit[0][1], div[0][1]);
+        assert.strictEqual(exit[0][2], div[0][2]);
+        assert.equal(exit[0][3], null);
+        assert.strictEqual(exit[0][4], div[0][4]);
+        assert.strictEqual(exit[0][5], div[0][5]);
+      }
     }
   }
 });
 
 suite.addBatch({
   "selectAll(div).selectAll(span)": {
-    topic: load("selection/data").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/data").document(),
     "on a simple page": {
       topic: function(d3) {
-        return d3.select("body").html("").selectAll("div")
+        return d3.select("body").selectAll("div")
             .data([0, 1])
           .enter().append("div").selectAll("span")
             .data([0, 1])
@@ -188,7 +184,7 @@ suite.addBatch({
         assert.equal(count, 2);
       },
       "defines an update selection for updating data": function(span) {
-        var update = span.data(d3.range(4));
+        var update = span.data([0, 1, 2, 3]);
         assert.equal(update.length, 2);
         assert.equal(update[0].length, 4);
         assert.equal(update[1].length, 4);
@@ -202,7 +198,7 @@ suite.addBatch({
         assert.domNull(update[1][3]);
       },
       "defines an enter selection for entering data": function(span) {
-        var enter = span.data(d3.range(4)).enter();
+        var enter = span.data([0, 1, 2, 3]).enter();
         assert.isFalse(enter.empty());
         assert.equal(enter.length, 2);
         assert.equal(enter[0].length, 4);
@@ -217,7 +213,7 @@ suite.addBatch({
         assert.deepEqual(enter[1][3], {__data__: 3});
       },
       "defines an exit selection for exiting data": function(span) {
-        var exit = span.data(d3.range(1)).exit();
+        var exit = span.data([0]).exit();
         assert.isFalse(exit.empty());
         assert.equal(exit.length, 2);
         assert.equal(exit[0].length, 2);
diff --git a/test/selection/datum-test.js b/test/selection/datum-test.js
index ec782baa..20c32f85 100644
--- a/test/selection/datum-test.js
+++ b/test/selection/datum-test.js
@@ -1,37 +1,31 @@
 var vows = require("vows"),
-    d3 = require("../../"),
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("selection.datum");
 
 suite.addBatch({
   "select(body)": {
-    topic: load("selection/datum").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/datum").document(),
     "on a simple page": {
       topic: function(d3) {
-        return d3.select("body").html("");
+        return d3.select("body");
       },
       "updates the data according to the specified function": function(body) {
         body.data([42]).datum(function(d, i) { return d + i; });
-        assert.equal(document.body.__data__, 42);
+        assert.equal(body.node().__data__, 42);
       },
       "updates the data to the specified constant": function(body) {
         body.datum(43);
-        assert.equal(document.body.__data__, 43);
+        assert.equal(body.node().__data__, 43);
       },
       "deletes the data if the function returns null": function(body) {
         body.data([42]).datum(function() { return null; });
-        assert.isFalse("__data__" in document.body);
+        assert.isFalse("__data__" in body.node());
       },
       "deletes the data if the constant is null": function(body) {
         body.data([42]).datum(null);
-        assert.isFalse("__data__" in document.body);
+        assert.isFalse("__data__" in body.node());
       },
       "returns the current selection": function(body) {
         assert.isTrue(body.datum(function() { return 1; }) === body);
@@ -47,13 +41,10 @@ suite.addBatch({
 
 suite.addBatch({
   "selectAll(div)": {
-    topic: load("selection/datum").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/datum").document(),
     "on a simple page": {
       topic: function(d3) {
-        return d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div");
+        return d3.select("body").selectAll("div").data([0, 1]).enter().append("div");
       },
       "updates the data according to the specified function": function(div) {
         div.data([42, 43]).datum(function(d, i) { return d + i; });
@@ -78,18 +69,17 @@ suite.addBatch({
       "returns the current selection": function(div) {
         assert.isTrue(div.datum(function() { return 1; }) === div);
         assert.isTrue(div.datum(2) === div);
+      },
+      "ignores null nodes": function(div) {
+        var node = div[0][1];
+        div[0][1] = null;
+        div.datum(function() { return 1; });
+        assert.equal(div[0][0].__data__, 1);
+        assert.equal(node.__data__, 2);
+        div.datum(43);
+        assert.equal(div[0][0].__data__, 43);
+        assert.equal(node.__data__, 2);
       }
-    },
-    "ignores null nodes": function(d3) {
-      var div = d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div"),
-          some = d3.selectAll("div").data([42, 43]);
-      some[0][1] = null;
-      some.datum(function() { return 1; });
-      assert.equal(div[0][0].__data__, 1);
-      assert.equal(div[0][1].__data__, 43);
-      some.datum(2);
-      assert.equal(div[0][0].__data__, 2);
-      assert.equal(div[0][1].__data__, 43);
     }
   }
 });
diff --git a/test/selection/each-test.js b/test/selection/each-test.js
index 42b69cbb..8daaa100 100644
--- a/test/selection/each-test.js
+++ b/test/selection/each-test.js
@@ -1,21 +1,15 @@
 var vows = require("vows"),
-    d3 = require("../../"),
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("selection.each");
 
 suite.addBatch({
   "select(body)": {
-    topic: load("selection/each").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/each").document(),
     "on a simple page": {
       topic: function(d3) {
-        return d3.select("body").html("");
+        return d3.select("body");
       },
       "calls the function once per element": function(body) {
         var count = 0;
@@ -31,33 +25,30 @@ suite.addBatch({
       "uses the node as the context": function(body) {
         var node;
         body.each(function() { node = this; });
-        assert.isTrue(node === document.body);
+        assert.isTrue(node === body.node());
       },
       "returns the same selection": function(body) {
         assert.isTrue(body.each(function() {}) === body);
       },
       "returns the current selection": function(body) {
         assert.isTrue(body.each(function() {}) === body);
+      },
+      "ignores null nodes": function(body) {
+        var count = 0;
+        body[0][0] = null;
+        body.each(function() { ++count; });
+        assert.equal(count, 0);
       }
-    },
-    "ignores null nodes": function(d3) {
-      var count = 0, body = d3.select("body");
-      body[0][0] = null;
-      body.each(function() { ++count; });
-      assert.equal(count, 0);
     }
   }
 });
 
 suite.addBatch({
   "selectAll(div)": {
-    topic: load("selection/each").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/each").document(),
     "on a simple page": {
       topic: function(d3) {
-        return d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div");
+        return d3.select("body").selectAll("div").data([0, 1]).enter().append("div");
       },
       "calls the function once per element": function(div) {
         var count = 0;
@@ -82,14 +73,13 @@ suite.addBatch({
       },
       "returns the current selection": function(div) {
         assert.isTrue(div.each(function() {}) === div);
+      },
+      "ignores null nodes": function(div) {
+        var count = 0;
+        div[0][0] = null;
+        div.each(function() { ++count; });
+        assert.equal(count, 1);
       }
-    },
-    "ignores null nodes": function(d3) {
-      d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div");
-      var count = 0, some = d3.selectAll("div");
-      some[0][0] = null;
-      some.each(function() { ++count; });
-      assert.equal(count, 1);
     }
   }
 });
diff --git a/test/selection/empty-test.js b/test/selection/empty-test.js
index d674c96c..26a6ff97 100644
--- a/test/selection/empty-test.js
+++ b/test/selection/empty-test.js
@@ -1,21 +1,15 @@
 var vows = require("vows"),
-    d3 = require("../../"),
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("selection.empty");
 
 suite.addBatch({
   "select(body)": {
-    topic: load("selection/empty").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/empty").document(),
     "on a simple page": {
       topic: function(d3) {
-        return d3.select("body").html("");
+        return d3.select("body");
       },
       "returns true for empty selections": function(body) {
         assert.isTrue(body.select("foo").empty());
@@ -23,24 +17,20 @@ suite.addBatch({
       "returns false for non-empty selections": function(body) {
         assert.isFalse(body.empty());
       },
-    },
-    "ignores null nodes": function(d3) {
-      var some = d3.select("body");
-      some[0][0] = null;
-      assert.isTrue(some.empty());
+      "ignores null nodes": function(body) {
+        body[0][0] = null;
+        assert.isTrue(body.empty());
+      }
     }
   }
 });
 
 suite.addBatch({
   "selectAll(div)": {
-    topic: load("selection/empty").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/empty").document(),
     "on a simple page": {
       topic: function(d3) {
-        var body = d3.select("body").html("");
+        var body = d3.select("body");
         body.append("div").append("span");
         body.append("div");
         return body.selectAll("div");
@@ -51,15 +41,11 @@ suite.addBatch({
       "returns false for non-empty selections": function(div) {
         assert.isFalse(div.empty());
         assert.isFalse(div.select("span").empty());
+      },
+      "ignores null nodes": function(div) {
+        div[0][0] = null;
+        assert.isTrue(div.select("span").empty());
       }
-    },
-    "ignores null nodes": function(d3) {
-      var body = d3.select("body").html("");
-      body.append("div").append("span");
-      body.append("div");
-      var some = d3.selectAll("div");
-      some[0][0] = null;
-      assert.isTrue(some.select("span").empty());
     }
   }
 });
diff --git a/test/selection/enter-test.js b/test/selection/enter-test.js
index 91ad94ff..d4307f1b 100644
--- a/test/selection/enter-test.js
+++ b/test/selection/enter-test.js
@@ -1,27 +1,21 @@
 var vows = require("vows"),
-    d3 = require("../../"),
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("selection.enter");
 
 suite.addBatch({
   "selectAll(div)": {
-    topic: load("selection/call").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/enter").document(),
     "is an instanceof d3.selection.enter": function(d3) {
-      var enter = d3.select("body").html("").selectAll("div").data([0, 1]).enter();
+      var enter = d3.select("body").selectAll("div").data([0, 1]).enter();
       assert.instanceOf(enter, d3.selection.enter);
     },
     "selection prototype can be extended": function(d3) {
       var enter = d3.select("body").html("").selectAll("div").data([0, 1]).enter();
       d3.selection.enter.prototype.foo = function() { return this.append("foo"); };
       var selection = enter.foo();
-      assert.equal(document.body.innerHTML, "<foo></foo><foo></foo>");
+      assert.equal(d3.select("body").html(), "<foo></foo><foo></foo>");
       delete d3.selection.enter.prototype.foo;
     }
   }
diff --git a/test/selection/filter-test.js b/test/selection/filter-test.js
index 944ddb4b..4e4fecc3 100644
--- a/test/selection/filter-test.js
+++ b/test/selection/filter-test.js
@@ -1,21 +1,16 @@
 var vows = require("vows"),
-    d3 = require("../../"),
+    merge = require("../../").merge,
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("selection.filter");
 
 suite.addBatch({
   "selectAll(div)": {
-    topic: load("selection/filter").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/filter").document(),
     "on a simple page": {
       topic: function(d3) {
-        return d3.select("body").html("").selectAll("div")
+        return d3.select("body").selectAll("div")
             .data([0, 1])
           .enter().append("div")
           .selectAll("span")
@@ -28,7 +23,7 @@ suite.addBatch({
         assert.isTrue(some[1][0] === span[1][0]);
       },
       "removes non-matching elements": function(span) {
-        var some = d3.merge(span.filter(function(d, i) { return d & 1; }));
+        var some = merge(span.filter(function(d, i) { return d & 1; }));
         assert.equal(some.indexOf(span[0][0]), -1);
         assert.equal(some.indexOf(span[1][0]), -1);
       },
@@ -62,20 +57,14 @@ suite.addBatch({
       },
       "returns a new selection": function(span) {
         assert.isFalse(span.filter(function() { return 1; }) === span);
+      },
+      "ignores null nodes": function(span) {
+        var node = span[0][1];
+        span[0][1] = null;
+        var some = span.filter(function(d, i) { return d & 1; });
+        assert.isTrue(some[0][0] === span[0][3]);
+        assert.equal(some.length, 2);
       }
-    },
-    "ignores null nodes": function(d3) {
-      d3.select("body").html("").selectAll("div")
-          .data([0, 1])
-        .enter().append("div")
-        .selectAll("span")
-          .data(function(d) { d <<= 1; return [d, d + 1]; })
-        .enter().append("span");
-      var span = d3.selectAll("span");
-      span[0][1] = null;
-      var some = span.filter(function(d, i) { return d & 1; });
-      assert.isTrue(some[0][0] === span[0][3]);
-      assert.equal(some.length, 1);
     }
   }
 });
diff --git a/test/selection/html-test.js b/test/selection/html-test.js
index 29fe865a..985e6c06 100644
--- a/test/selection/html-test.js
+++ b/test/selection/html-test.js
@@ -1,92 +1,83 @@
 var vows = require("vows"),
-    d3 = require("../../"),
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("selection.html");
 
 suite.addBatch({
   "select(body)": {
-    topic: load("selection/selection").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/selection").document(),
     "on a simple page": {
       topic: function(d3) {
-        return d3.select("body").html("");
+        return d3.select("body");
       },
       "sets the inner HTML as a string": function(body) {
         body.html("<h1>Hello, world!</h1>");
-        assert.equal(document.body.firstChild.tagName, "H1");
-        assert.equal(document.body.firstChild.textContent, "Hello, world!");
+        assert.equal(body.node().firstChild.tagName, "H1");
+        assert.equal(body.node().firstChild.textContent, "Hello, world!");
       },
       "sets the inner HTML as a number": function(body) {
         body.html(42);
-        assert.equal(document.body.innerHTML, "42");
-        assert.equal(document.body.firstChild.nodeType, document.TEXT_NODE);
+        assert.equal(body.node().innerHTML, "42");
+        assert.equal(body.node().firstChild.nodeType, 3);
       },
       "sets the inner HTML as a function": function(body) {
         body.data(["Subject"]).html(function(d, i) { return "<b>" + d + "</b><i>" + i + "</i>"; });
-        assert.equal(document.body.firstChild.tagName, "B");
-        assert.equal(document.body.firstChild.textContent, "Subject");
-        assert.equal(document.body.lastChild.tagName, "I");
-        assert.equal(document.body.lastChild.textContent, "0");
+        assert.equal(body.node().firstChild.tagName, "B");
+        assert.equal(body.node().firstChild.textContent, "Subject");
+        assert.equal(body.node().lastChild.tagName, "I");
+        assert.equal(body.node().lastChild.textContent, "0");
       },
       "clears the inner HTML as null": function(body) {
         body.html(null);
-        assert.equal(document.body.innerHTML, "");
-        assert.isNull(document.body.firstChild);
+        assert.equal(body.node().innerHTML, "");
+        assert.isNull(body.node().firstChild);
       },
       "clears the inner HTML as undefined": function(body) {
         body.html(undefined);
-        assert.equal(document.body.innerHTML, "");
-        assert.isNull(document.body.firstChild);
+        assert.equal(body.node().innerHTML, "");
+        assert.isNull(body.node().firstChild);
       },
       "clears the inner HTML as the empty string": function(body) {
         body.html("");
-        assert.equal(document.body.innerHTML, "");
-        assert.isNull(document.body.firstChild);
+        assert.equal(body.node().innerHTML, "");
+        assert.isNull(body.node().firstChild);
       },
       "clears the inner HTML as a function returning the empty string": function(body) {
         body.text(function() { return ""; });
-        assert.equal(document.body.innerHTML, "");
-        assert.isNull(document.body.firstChild);
+        assert.equal(body.node().innerHTML, "");
+        assert.isNull(body.node().firstChild);
       },
       "clears the inner HTML as a function returning null": function(body) {
         body.text(function() { return null; });
-        assert.equal(document.body.innerHTML, "");
-        assert.isNull(document.body.firstChild);
+        assert.equal(body.node().innerHTML, "");
+        assert.isNull(body.node().firstChild);
       },
       "clears the inner HTML as a function returning undefined": function(body) {
         body.text(function() { return undefined; });
-        assert.equal(document.body.innerHTML, "");
-        assert.isNull(document.body.firstChild);
+        assert.equal(body.node().innerHTML, "");
+        assert.isNull(body.node().firstChild);
       },
       "returns the current selection": function(body) {
         assert.isTrue(body.html("foo") === body);
+      },
+      "ignores null nodes": function(body) {
+        var node = body.node();
+        body[0][0] = null;
+        node.innerHTML = "<h1>foo</h1>";
+        body.html("bar");
+        assert.equal(node.textContent, "foo");
       }
-    },
-    "ignores null nodes": function(d3) {
-      var body = d3.select("body");
-      body[0][0] = null;
-      document.body.innerHTML = "<h1>foo</h1>";
-      body.html("bar");
-      assert.equal(document.body.textContent, "foo");
     }
   }
 });
 
 suite.addBatch({
   "selectAll(div)": {
-    topic: load("selection/selection").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/selection").document(),
     "on a simple page": {
       topic: function(d3) {
-        return d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div");
+        return d3.select("body").selectAll("div").data([0, 1]).enter().append("div");
       },
       "sets the inner HTML as a string": function(div) {
         div.html("<h1>Hello, world!</h1>");
@@ -98,7 +89,7 @@ suite.addBatch({
       "sets the inner HTML as a number": function(div) {
         div.html(42);
         assert.equal(div[0][0].innerHTML, "42");
-        assert.equal(div[0][0].firstChild.nodeType, document.TEXT_NODE);
+        assert.equal(div[0][0].firstChild.nodeType, 3);
       },
       "sets the inner HTML as a function": function(div) {
         div.data(["foo", "bar"]).html(function(d, i) { return "<b>" + d + "</b><i>" + i + "</i>"; });
@@ -127,16 +118,15 @@ suite.addBatch({
       },
       "returns the current selection": function(div) {
         assert.isTrue(div.html("foo") === div);
+      },
+      "ignores null nodes": function(div) {
+        var node = div[0][0];
+        div[0][0] = null;
+        node.innerHTML = "<h1>foo</h1>";
+        div.html("bar");
+        assert.equal(node.textContent, "foo");
+        assert.equal(div[0][1].textContent, "bar");
       }
-    },
-    "ignores null nodes": function(d3) {
-      var div = d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div"),
-          some = d3.selectAll("div");
-      some[0][0] = null;
-      div[0][0].innerHTML = "<h1>foo</h1>";
-      some.html("bar");
-      assert.equal(div[0][0].textContent, "foo");
-      assert.equal(div[0][1].textContent, "bar");
     }
   }
 });
diff --git a/test/selection/insert-test.js b/test/selection/insert-test.js
index 81704936..f73de80c 100644
--- a/test/selection/insert-test.js
+++ b/test/selection/insert-test.js
@@ -1,28 +1,22 @@
 var vows = require("vows"),
-    d3 = require("../../"),
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("selection.insert");
 
 suite.addBatch({
   "select(body)": {
-    topic: load("selection/insert").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/insert").document(),
     "on a simple page": {
       topic: function(d3) {
-        return d3.select("body").html("");
+        return d3.select("body");
       },
       "inserts before the specified selector": function(body) {
         var span = body.html("").append("span");
         var div = body.insert("div", "span");
         assert.equal(div[0][0].tagName, "DIV");
         assert.isNull(div[0][0].namespaceURI);
-        assert.domEqual(div[0][0], document.body.firstChild);
+        assert.domEqual(div[0][0], body.node().firstChild);
         assert.domEqual(div[0][0].nextSibling, span[0][0]);
       },
       "inserts before the specified node": function(body) {
@@ -30,21 +24,21 @@ suite.addBatch({
         var div = body.insert("div", function() { return span.node(); });
         assert.equal(div[0][0].tagName, "DIV");
         assert.isNull(div[0][0].namespaceURI);
-        assert.domEqual(div[0][0], document.body.firstChild);
+        assert.domEqual(div[0][0], body.node().firstChild);
         assert.domEqual(div[0][0].nextSibling, span[0][0]);
       },
       "appends an HTML element": function(body) {
         var div = body.insert("div");
         assert.equal(div[0][0].tagName, "DIV");
         assert.isNull(div[0][0].namespaceURI);
-        assert.domEqual(div[0][0], document.body.lastChild);
+        assert.domEqual(div[0][0], body.node().lastChild);
       },
       "appends an SVG element": function(body) {
         var svg = body.insert("svg:svg");
         assert.equal(svg[0][0].tagName, "SVG");
         assert.equal(svg[0][0].namespaceURI, "http://www.w3.org/2000/svg");
-        assert.domEqual(svg[0][0].parentNode, document.body);
-        assert.domEqual(svg[0][0], document.body.lastChild);
+        assert.domEqual(svg[0][0].parentNode, body.node());
+        assert.domEqual(svg[0][0], body.node().lastChild);
       },
       "propagates data to new element": function(body) {
         var data = new Object(), div = body.data([data]).insert("div");
@@ -63,13 +57,10 @@ suite.addBatch({
 
 suite.addBatch({
   "selectAll(div)": {
-    topic: load("selection/selection").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/selection").document(),
     "on a simple page": {
       topic: function(d3) {
-        return d3.select("body").html("").selectAll("div").data([0, 1]).enter().insert("div");
+        return d3.select("body").selectAll("div").data([0, 1]).enter().insert("div");
       },
       "appends an HTML element": function(div) {
         var span = div.insert("span");
@@ -102,39 +93,36 @@ suite.addBatch({
       },
       "returns a new selection": function(div) {
         assert.isFalse(div.insert("div") === div);
+      },
+      "ignores null nodes": function(div) {
+        div.html("");
+        var node = div[0][1];
+        div[0][1] = null;
+        var span = div.insert("span");
+        assert.equal(span[0].length, 2);
+        assert.equal(span[0][0].tagName, "SPAN");
+        assert.domNull(span[0][1]);
+        assert.domEqual(span[0][0].parentNode, div[0][0]);
+        assert.domEqual(div[0][0].lastChild, span[0][0]);
+        assert.domNull(node.lastChild);
       }
-    },
-    "ignores null nodes": function(d3) {
-      var div = d3.select("body").html("").selectAll("div").data([0, 1]).enter().insert("div"),
-          some = d3.selectAll("div");
-      some[0][1] = null;
-      var span = some.insert("span");
-      assert.equal(span[0].length, 2);
-      assert.equal(span[0][0].tagName, "SPAN");
-      assert.domNull(span[0][1]);
-      assert.domEqual(span[0][0].parentNode, div[0][0]);
-      assert.domEqual(div[0][0].lastChild, span[0][0]);
-      assert.domNull(div[0][1].lastChild);
     }
   }
 });
 
 suite.addBatch({
   "selectAll(div).data(â€¦).enter()": {
-    topic: load("selection/selection").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/selection").document(),
     "on a simple page": {
       topic: function(d3) {
         return d3.select("body");
       },
       "inserts before the specified selector": function(body) {
-        var span = body.html("").append("span");
+        var span = body.append("span");
         var div = body.selectAll("div").data([0, 1]).enter().insert("div", "span");
         assert.equal(div.length, 1);
         assert.equal(div[0].length, 2);
-        assert.domEqual(div[0][0], document.body.firstChild);
+        assert.domEqual(div[0][0], body.node().firstChild);
         assert.domEqual(div[0][1].previousSibling, div[0][0]);
         assert.domEqual(div[0][1].nextSibling, span[0][0]);
       },
@@ -149,8 +137,8 @@ suite.addBatch({
         assert.equal(div.length, 1);
         assert.equal(div[0].length, 3);
         assert.domNull(div[0][0]);
-        assert.domEqual(div[0][1].parentNode, document.body);
-        assert.domEqual(div[0][2].parentNode, document.body);
+        assert.domEqual(div[0][1].parentNode, body.node());
+        assert.domEqual(div[0][2].parentNode, body.node());
       },
       "returns a new selection": function(body) {
         var enter = body.html("").selectAll("div").data([0, 1]).enter();
diff --git a/test/selection/node-test.js b/test/selection/node-test.js
index f5a87e74..950e73ef 100644
--- a/test/selection/node-test.js
+++ b/test/selection/node-test.js
@@ -1,46 +1,37 @@
 var vows = require("vows"),
-    d3 = require("../../"),
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("selection.node");
 
 suite.addBatch({
   "select(body)": {
-    topic: load("selection/node").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/node").document(),
     "on a simple page": {
       topic: function(d3) {
-        return d3.select("body").html("");
+        return d3.select("body");
       },
       "returns null for empty selections": function(body) {
         assert.isNull(body.select("foo").node());
       },
       "returns the first element for non-empty selections": function(body) {
-        assert.isTrue(body.node() === document.body);
+        assert.isTrue(body.node() === body[0][0]);
+        assert.equal(body.node().tagName, "BODY");
+      },
+      "ignores null nodes": function(body) {
+        body[0][0] = null;
+        assert.isNull(body.node());
       }
-    },
-    "ignores null nodes": function(d3) {
-      var some = d3.select("body");
-      some[0][0] = null;
-      assert.isNull(some.node());
     }
   }
 });
 
 suite.addBatch({
   "selectAll(div)": {
-    topic: load("selection/node").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/node").document(),
     "on a simple page": {
       topic: function(d3) {
-        var body = d3.select("body").html("");
+        var body = d3.select("body");
         body.append("div").append("span");
         body.append("div");
         return body.selectAll("div");
@@ -50,15 +41,13 @@ suite.addBatch({
       },
       "returns the first element for non-empty selections": function(div) {
         assert.isTrue(div.node() === div[0][0]);
+        assert.equal(div.node().tagName, "DIV");
       },
-    },
-    "ignores null nodes": function(d3) {
-      var body = d3.select("body").html("");
-      body.append("div").append("span");
-      body.append("div");
-      var some = body.selectAll("div");
-      some[0][0] = null;
-      assert.isTrue(some.node() === some[0][1]);
+      "ignores null nodes": function(div) {
+        div[0][0] = null;
+        assert.isTrue(div.node() === div[0][1]);
+        assert.equal(div.node().tagName, "DIV");
+      }
     }
   }
 });
diff --git a/test/selection/on-test.js b/test/selection/on-test.js
index 22280554..d60ab25d 100644
--- a/test/selection/on-test.js
+++ b/test/selection/on-test.js
@@ -1,21 +1,15 @@
 var vows = require("vows"),
-    d3 = require("../../"),
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("selection.on");
 
 suite.addBatch({
   "select(body)": {
-    topic: load("selection/on").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/on").document(),
     "on a simple page": {
       topic: function(d3) {
-        return d3.select("body").html("");
+        return d3.select("body");
       },
       "registers an event listener for the specified type": function(body) {
         var form = body.append("form"), count = 0;
diff --git a/test/selection/order-test.js b/test/selection/order-test.js
index 054c379d..ac9ccb30 100644
--- a/test/selection/order-test.js
+++ b/test/selection/order-test.js
@@ -1,21 +1,15 @@
 var vows = require("vows"),
-    d3 = require("../../"),
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("selection.order");
 
 suite.addBatch({
   "selectAll(div)": {
-    topic: load("selection/call").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/call").document(),
     "on a simple page": {
       topic: function(d3) {
-        return d3.select("body").html("").selectAll("div")
+        return d3.select("body").selectAll("div")
             .data([1, 2, 10, 20])
           .enter().append("div")
             .attr("id", String);
@@ -29,7 +23,6 @@ suite.addBatch({
         assert.domNull(div[0][3].nextSibling);
       },
       "returns the current selection": function(span) {
-        span = d3.select("body"); // https://github.com/tmpvar/jsdom/issues/277
         assert.isTrue(span.order() === span);
       }
     }
diff --git a/test/selection/property-test.js b/test/selection/property-test.js
index 986bc4d2..7c87fa4e 100644
--- a/test/selection/property-test.js
+++ b/test/selection/property-test.js
@@ -1,65 +1,60 @@
 var vows = require("vows"),
-    d3 = require("../../"),
+    interpolateRgb = require("../../").interpolateRgb,
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("selection.property");
 
 suite.addBatch({
   "select(body)": {
-    topic: load("selection/property").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/property").document(),
     "on a simple page": {
       topic: function(d3) {
-        return d3.select("body").html("");
+        return d3.select("body");
       },
       "sets a property as a string": function(body) {
         body.property("bgcolor", "red");
-        assert.equal(document.body.bgcolor, "red");
+        assert.equal(body.node().bgcolor, "red");
       },
       "sets a property as a number": function(body) {
         body.property("opacity", 1);
-        assert.equal(document.body.opacity, "1");
+        assert.equal(body.node().opacity, "1");
       },
       "sets a property as a function": function(body) {
         body.property("bgcolor", function() { return "orange"; });
-        assert.equal(document.body.bgcolor, "orange");
+        assert.equal(body.node().bgcolor, "orange");
       },
       "sets properties as a map of constants": function(body) {
         body.property({bgcolor: "purple", opacity: .41});
-        assert.equal(document.body.bgcolor, "purple");
-        assert.equal(document.body.opacity, .41);
+        assert.equal(body.node().bgcolor, "purple");
+        assert.equal(body.node().opacity, .41);
       },
       "sets properties as a map of functions": function(body) {
         body.data(["cyan"]).property({bgcolor: String, opacity: function(d, i) { return i; }});
-        assert.equal(document.body.bgcolor, "cyan");
-        assert.equal(document.body.opacity, 0);
+        assert.equal(body.node().bgcolor, "cyan");
+        assert.equal(body.node().opacity, 0);
       },
       "gets a property value": function(body) {
-        document.body.bgcolor = "yellow";
+        body.node().bgcolor = "yellow";
         assert.equal(body.property("bgcolor"), "yellow");
       },
       "removes a property as null": function(body) {
         body.property("bgcolor", "yellow").property("bgcolor", null);
-        assert.isFalse("bgcolor" in document.body);
+        assert.isFalse("bgcolor" in body.node());
       },
       "removes a property as a function": function(body) {
         body.property("bgcolor", "yellow").property("bgcolor", function() { return null });
-        assert.isFalse("bgcolor" in document.body);
+        assert.isFalse("bgcolor" in body.node());
       },
       "removes properties as a map of nulls": function(body) {
-        document.body.bgcolor = "red";
+        body.node().bgcolor = "red";
         body.property({bgcolor: null});
-        assert.isFalse("bgcolor" in document.body);
+        assert.isFalse("bgcolor" in body.node());
       },
       "removes properties as a map of functions that return null": function(body) {
-        document.body.bgcolor = "red";
+        body.node().bgcolor = "red";
         body.property({bgcolor: function() {}});
-        assert.isFalse("bgcolor" in document.body);
+        assert.isFalse("bgcolor" in body.node());
       },
       "returns the current selection": function(body) {
         assert.isTrue(body.property("bgcolor", "yellow") === body);
@@ -70,10 +65,7 @@ suite.addBatch({
 
 suite.addBatch({
   "selectAll(div)": {
-    topic: load("selection/property").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/property").document(),
     "on a simple page": {
       topic: function(d3) {
         return d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div");
@@ -89,7 +81,7 @@ suite.addBatch({
         assert.equal(div[0][1].opacity, "0.4");
       },
       "sets a property as a function": function(div) {
-        div.property("bgcolor", d3.interpolateRgb("brown", "steelblue"));
+        div.property("bgcolor", interpolateRgb("brown", "steelblue"));
         assert.equal(div[0][0].bgcolor, "#a52a2a");
         assert.equal(div[0][1].bgcolor, "#4682b4");
       },
@@ -109,15 +101,15 @@ suite.addBatch({
       },
       "returns the current selection": function(div) {
         assert.isTrue(div.property("bgcolor", "yellow") === div);
+      },
+      "ignores null nodes": function(div) {
+        var node = div[0][1];
+        div.property("bgcolor", null);
+        div[0][1] = null;
+        div.property("bgcolor", "red");
+        assert.equal(div[0][0].bgcolor, "red");
+        assert.isFalse("bgcolor" in node);
       }
-    },
-    "ignores null nodes": function(d3) {
-      var div = d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div"),
-          some = d3.selectAll("div");
-      some[0][1] = null;
-      some.property("bgcolor", null).property("bgcolor", "red");
-      assert.equal(div[0][0].bgcolor, "red");
-      assert.isFalse("bgcolor" in div[0][1]);
     }
   }
 });
diff --git a/test/selection/remove-test.js b/test/selection/remove-test.js
index e3b2ac4c..6234c529 100644
--- a/test/selection/remove-test.js
+++ b/test/selection/remove-test.js
@@ -1,36 +1,32 @@
 var vows = require("vows"),
-    d3 = require("../../"),
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("selection.remove");
 
 suite.addBatch({
   "select(body)": {
-    topic: load("selection/remove").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/remove").document(),
     "removes the matching elements": function(d3) {
       var div = d3.select("body").append("div");
       div.remove();
       assert.domNull(div[0][0].parentNode);
     },
     "does not remove non-matching elements": function(d3) {
-      var div1 = d3.select("body").append("div"),
-          div2 = d3.select("body").append("div");
+      var body = d3.select("body"),
+          div1 = body.append("div"),
+          div2 = body.append("div");
       div1.remove();
-      assert.domEqual(div2[0][0].parentNode, document.body);
+      assert.domEqual(div2[0][0].parentNode, body.node());
     },
     "ignores null nodes": function(d3) {
-      var div = d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div"),
-          some = d3.selectAll("div");
-      some[0][0] = null;
-      some.remove();
-      assert.domEqual(div[0][0].parentNode, document.body);
-      assert.domNull(div[0][1].parentNode);
+      var div1 = d3.select("body").append("div"),
+          div2 = div1.selectAll("div").data([0, 1]).enter().append("div"),
+          node = div2[0][0];
+      div2[0][0] = null;
+      div2.remove();
+      assert.domEqual(node.parentNode, div1.node());
+      assert.domNull(div2[0][1].parentNode);
     },
     "returns the current selection": function(d3) {
       var div = d3.select("body").append("div");
diff --git a/test/selection/select-test.js b/test/selection/select-test.js
index 4fedd202..04faa5e0 100644
--- a/test/selection/select-test.js
+++ b/test/selection/select-test.js
@@ -1,45 +1,39 @@
 var vows = require("vows"),
-    d3 = require("../../"),
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("d3.select");
 
 suite.addBatch({
   "select": {
-    topic: load("selection/select").sandbox({
-      document: document,
-      window: window
-    }).expression("d3.select"),
-
+    topic: load("selection/select").document(),
     "on a simple page": {
-      topic: function(select) {
-        var body = select("body").html("");
+      topic: function(d3) {
+        var body = d3.select("body");
         body.append("span").attr("class", "f00").attr("id", "b4r").attr("name", "b4z");
         body.append("div").attr("class", "foo").attr("id", "bar").attr("name", "baz");
-        return select;
+        return d3;
       },
-      "selects by element name": function(select) {
-        var div = select("div");
+      "selects by element name": function(d3) {
+        var div = d3.select("div");
         assert.equal(div[0][0].tagName, "DIV");
       },
-      "selects by class name": function(select) {
-        var div = select(".foo");
+      "selects by class name": function(d3) {
+        var div = d3.select(".foo");
         assert.equal(div[0][0].className, "foo");
       },
-      "selects by id": function(select) {
-        var div = select("div#bar");
+      "selects by id": function(d3) {
+        var div = d3.select("div#bar");
         assert.equal(div[0][0].id, "bar");
       },
-      "selects by attribute value": function(select) {
-        var div = select("[name=baz]");
+      "selects by attribute value": function(d3) {
+        var div = d3.select("[name=baz]");
         assert.equal(div[0][0].getAttribute("name"), "baz");
       },
-      "selects by node": function(select) {
-        var div = select(document.body.lastChild);
-        assert.isTrue(div[0][0] === document.body.lastChild);
+      "selects by node": function(d3) {
+        var body = d3.select("body").node(),
+            div = d3.select(body.lastChild);
+        assert.isTrue(div[0][0] === body.lastChild);
         assert.lengthOf(div, 1);
         assert.lengthOf(div[0], 1);
       }
diff --git a/test/selection/selectAll-test.js b/test/selection/selectAll-test.js
index 4a6c441a..4deac8ff 100644
--- a/test/selection/selectAll-test.js
+++ b/test/selection/selectAll-test.js
@@ -1,21 +1,15 @@
 var vows = require("vows"),
-    d3 = require("../../"),
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("d3.selectAll");
 
 suite.addBatch({
   "selectAll": {
-    topic: load("selection/selectAll").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/selectAll").document(),
     "on a simple page": {
       topic: function(d3) {
-        var body = d3.select("body").html("");
+        var body = d3.select("body");
         body.append("span").attr("class", "f00").attr("id", "b4r").attr("name", "b4z");
         body.append("div").attr("class", "foo").attr("id", "bar").attr("name", "baz");
         return d3;
@@ -37,14 +31,14 @@ suite.addBatch({
         assert.equal(div[0][0].getAttribute("name"), "baz");
       },
       "selects by array": function(d3) {
-        var div = d3.selectAll([document.body.lastChild]);
-        assert.isTrue(div[0][0] === document.body.lastChild);
+        var body = d3.select("body").node(), div = d3.selectAll([body.lastChild]);
+        assert.isTrue(div[0][0] === body.lastChild);
         assert.lengthOf(div, 1);
         assert.lengthOf(div[0], 1);
       },
-      "groups are not instances of NodeList": function(d3) {
+      "groups are arrays, not NodeLists": function(d3) {
         var div = d3.select("body").selectAll(function() { return this.getElementsByClassName("div"); });
-        assert.isFalse(div[0] instanceof window.NodeList);
+        assert.isTrue(Array.isArray(div[0]));
       }
     }
   }
diff --git a/test/selection/selection-select-test.js b/test/selection/selection-select-test.js
index 915cc068..fd1a34ef 100644
--- a/test/selection/selection-select-test.js
+++ b/test/selection/selection-select-test.js
@@ -1,28 +1,22 @@
 var vows = require("vows"),
-    d3 = require("../../"),
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("selection.select");
 
 suite.addBatch({
   "select(body)": {
-    topic: load("selection/selection").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/selection").document(),
     "on a simple page": {
       topic: function(d3) {
-        var body = d3.select("body").html("");
+        var body = d3.select("body");
         body.append("div").attr("class", "first");
         body.append("div").attr("class", "second");
         return body;
       },
       "selects the first matching element": function(body) {
         var div = body.select("div");
-        assert.isTrue(div[0][0] === document.body.firstChild);
+        assert.isTrue(div[0][0] === body.node().firstChild);
         assert.equal(div.length, 1);
         assert.equal(div[0].length, 1);
         assert.equal(div.attr("class"), "first");
@@ -30,7 +24,7 @@ suite.addBatch({
       "propagates parent node to the selected elements": function(body) {
         var div = body.select("div");
         assert.isNotNull(div[0].parentNode);
-        assert.isTrue(div[0].parentNode === document.documentElement);
+        assert.isTrue(div[0].parentNode === body.node().parentNode);
         assert.isTrue(div[0].parentNode === body[0].parentNode);
       },
       "propagates data to the selected elements": function(body) {
@@ -38,11 +32,11 @@ suite.addBatch({
         assert.strictEqual(div[0][0].__data__, data);
       },
       "does not propagate data if no data was specified": function(body) {
-        delete document.body.__data__;
+        delete body.node().__data__;
         var data = new Object(), div = body.select("div").data([data]);
         div = body.select("div");
         assert.strictEqual(div[0][0].__data__, data);
-        assert.isUndefined(document.body.__data__);
+        assert.isUndefined(body.node().__data__);
       },
       "returns null if no match is found": function(body) {
         var span = body.select("span");
@@ -56,9 +50,9 @@ suite.addBatch({
             s = body.data([d]).select(function(d, i) { dd.push(d); ii.push(i); tt.push(this); return this.firstChild; });
         assert.deepEqual(dd, [d], "expected data, got {actual}");
         assert.deepEqual(ii, [0], "expected index, got {actual}");
-        assert.domEqual(tt[0], document.body, "expected this, got {actual}");
-        assert.domEqual(s[0][0], document.body.firstChild);
-        delete document.body.__data__;
+        assert.domEqual(tt[0], body.node(), "expected this, got {actual}");
+        assert.domEqual(s[0][0], body.node().firstChild);
+        delete body.node().__data__;
       }
     }
   }
@@ -66,13 +60,10 @@ suite.addBatch({
 
 suite.addBatch({
   "selectAll(div)": {
-    topic: load("selection/selection").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/selection").document(),
     "on a simple page": {
       topic: function(d3) {
-        var div = d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div");
+        var div = d3.select("body").selectAll("div").data([0, 1]).enter().append("div");
         div.append("span").attr("class", "first");
         div.append("span").attr("class", "second");
         return div;
@@ -88,7 +79,7 @@ suite.addBatch({
       "propagates parent node to the selected elements": function(div) {
         var span = div.select("span");
         assert.isNotNull(span[0].parentNode);
-        assert.isTrue(span[0].parentNode === document.body);
+        assert.isTrue(span[0].parentNode === div.node().parentNode);
         assert.isTrue(span[0].parentNode === div[0].parentNode);
       },
       "propagates data to the selected elements": function(div) {
@@ -121,19 +112,15 @@ suite.addBatch({
         assert.domEqual(tt[1], div[0][1], "expected this, got {actual}");
         assert.domEqual(s[0][0], div[0][0].firstChild);
         assert.domEqual(s[0][1], div[0][1].firstChild);
+      },
+      "ignores null nodes": function(div) {
+        div[0][1] = null;
+        var span = div.select("span");
+        assert.equal(span.length, 1);
+        assert.equal(span[0].length, 2);
+        assert.isTrue(span[0][0].parentNode === div[0][0]);
+        assert.isNull(span[0][1]);
       }
-    },
-    "ignores null nodes": function(d3) {
-      var div = d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div");
-      div.append("span").attr("class", "first");
-      div.append("span").attr("class", "second");
-      var some = d3.selectAll("div");
-      some[0][1] = null;
-      var span = some.select("span");
-      assert.equal(span.length, 1);
-      assert.equal(span[0].length, 2);
-      assert.isTrue(span[0][0].parentNode === div[0][0]);
-      assert.isNull(span[0][1]);
     }
   }
 });
diff --git a/test/selection/selection-selectAll-test.js b/test/selection/selection-selectAll-test.js
index 6ac92303..ef4173d0 100644
--- a/test/selection/selection-selectAll-test.js
+++ b/test/selection/selection-selectAll-test.js
@@ -1,37 +1,30 @@
 var vows = require("vows"),
-    d3 = require("../../"),
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("selection.selectAll");
 
 suite.addBatch({
   "select(body)": {
-    topic: load("selection/selection").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/selection").document(),
     "on a simple page": {
       topic: function(d3) {
-        var body = d3.select("body").html("");
-        if ("__data__" in body[0][0]) delete body[0][0].__data__;
+        var body = d3.select("body");
         body.append("div").attr("class", "first");
         body.append("div").attr("class", "second");
         return body;
       },
       "selects all matching elements": function(body) {
         var div = body.selectAll("div");
-        assert.isTrue(div[0][0] === document.body.firstChild);
-        assert.isTrue(div[0][1] === document.body.lastChild);
+        assert.isTrue(div[0][0] === body.node().firstChild);
+        assert.isTrue(div[0][1] === body.node().lastChild);
         assert.equal(div.length, 1);
         assert.equal(div[0].length, 2);
       },
       "propagates parent node to the selected elements": function(body) {
         var div = body.selectAll("div");
         assert.isNotNull(div[0].parentNode);
-        assert.isTrue(div[0].parentNode === document.body);
+        assert.isTrue(div[0].parentNode === body.node());
       },
       "does not propagate data if data was specified": function(body) {
         var div = body.data([new Object()]).selectAll("div");
@@ -54,10 +47,10 @@ suite.addBatch({
             s = body.data([d]).selectAll(function(d, i) { dd.push(d); ii.push(i); tt.push(this); return this.childNodes; });
         assert.deepEqual(dd, [d], "expected data, got {actual}");
         assert.deepEqual(ii, [0], "expected index, got {actual}");
-        assert.domEqual(tt[0], document.body, "expected this, got {actual}");
-        assert.domEqual(s[0][0], document.body.firstChild);
-        assert.domEqual(s[0][1], document.body.lastChild);
-        delete document.body.__data__;
+        assert.domEqual(tt[0], body.node(), "expected this, got {actual}");
+        assert.domEqual(s[0][0], body.node().firstChild);
+        assert.domEqual(s[0][1], body.node().lastChild);
+        delete body.node().__data__;
       }
     }
   }
@@ -65,13 +58,10 @@ suite.addBatch({
 
 suite.addBatch({
   "selectAll(div)": {
-    topic: load("selection/selection").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/selection").document(),
     "on a simple page": {
       topic: function(d3) {
-        var div = d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div");
+        var div = d3.select("body").append("div").selectAll("div").data([0, 1]).enter().append("div");
         div.append("span").attr("class", "first");
         div.append("span").attr("class", "second");
         return div;
@@ -124,19 +114,16 @@ suite.addBatch({
         assert.domEqual(s[0][1], div[0][0].lastChild);
         assert.domEqual(s[1][0], div[0][1].firstChild);
         assert.domEqual(s[1][1], div[0][1].lastChild);
+      },
+      "ignores null nodes": function(div) {
+        var node = div[0][1];
+        div[0][1] = null;
+        var span = div.selectAll("span");
+        assert.equal(span.length, 1);
+        assert.equal(span[0].length, 2);
+        assert.isTrue(span[0][0].parentNode === div[0][0]);
+        assert.isTrue(span[0][1].parentNode === div[0][0]);
       }
-    },
-    "ignores null nodes": function(d3) {
-      var div = d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div");
-      div.append("span").attr("class", "first");
-      div.append("span").attr("class", "second");
-      var some = d3.selectAll("div");
-      some[0][1] = null;
-      var span = some.selectAll("span");
-      assert.equal(span.length, 1);
-      assert.equal(span[0].length, 2);
-      assert.isTrue(span[0][0].parentNode === div[0][0]);
-      assert.isTrue(span[0][1].parentNode === div[0][0]);
     }
   }
 });
diff --git a/test/selection/selection-test.js b/test/selection/selection-test.js
index c5cba00a..1a63a477 100644
--- a/test/selection/selection-test.js
+++ b/test/selection/selection-test.js
@@ -1,23 +1,17 @@
 var vows = require("vows"),
-    d3 = require("../../"),
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("d3.selection");
 
 suite.addBatch({
   "selection": {
-    topic: load("selection/selection").sandbox({
-      document: document,
-      window: window
-    }),
+    topic: load("selection/selection").document(),
     "selects the document": function(d3) {
       var selection = d3.selection();
       assert.equal(selection.length, 1);
       assert.equal(selection[0].length, 1);
-      assert.equal(selection[0][0], document);
+      assert.equal(selection[0][0].nodeType, 9);
     },
     "is an instanceof d3.selection": function(d3) {
       assert.instanceOf(d3.selection(), d3.selection);
@@ -28,8 +22,8 @@ suite.addBatch({
     },
     "selection prototype can be extended": function(d3) {
       d3.selection.prototype.foo = function(v) { return this.attr("foo", v); };
-      d3.selection().select("body").foo(42);
-      assert.equal(document.body.getAttribute("foo"), "42");
+      var body = d3.selection().select("body").foo(42);
+      assert.equal(body.attr("foo"), "42");
       delete d3.selection.prototype.foo;
     }
   }
diff --git a/test/selection/sort-test.js b/test/selection/sort-test.js
index d366b870..04c54299 100644
--- a/test/selection/sort-test.js
+++ b/test/selection/sort-test.js
@@ -1,23 +1,18 @@
 var vows = require("vows"),
-    d3 = require("../../"),
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("selection.sort");
 
 suite.addBatch({
   "selectAll(div).selectAll(span)": {
-    topic: load("selection/sort").sandbox({
-      document: document,
-      window: window
-    }),
-    "on a simple page": {
+    topic: load("selection/sort").document(),
+    "on a page with some spans": {
       topic: function(d3) {
-        return d3.select("body").html("").selectAll("div")
+        return d3.select("body").append("div").selectAll("div")
             .data([1, 2, 10, 20])
-          .enter().append("div").selectAll("span")
+          .enter().append("div")
+          .selectAll("span")
             .data(function(d) { return [20 + d, 2 + d, 10, 1]; })
           .enter().append("span");
       },
@@ -30,22 +25,25 @@ suite.addBatch({
         assert.domNull(span[0][3].nextSibling);
       },
       "sorts each group independently": function(span) {
-        span.sort(d3.descending);
+        span.sort(function(a, b) { return b - a; });
         assert.deepEqual(span[0].map(data), [21, 10, 3, 1]);
         assert.deepEqual(span[1].map(data), [22, 10, 4, 1]);
         assert.deepEqual(span[2].map(data), [30, 12, 10, 1]);
         assert.deepEqual(span[3].map(data), [40, 22, 10, 1]);
       },
       "sorts using the specified comparator": function(span) {
-        span.sort(function(a, b) { return d3.ascending(a+"", b+""); });
+        span.sort(function(a, b) { return (a + "").localeCompare(b + ""); });
         assert.deepEqual(span[0].map(data), [1, 10, 21, 3]);
         assert.deepEqual(span[1].map(data), [1, 10, 22, 4]);
         assert.deepEqual(span[2].map(data), [1, 10, 12, 30]);
         assert.deepEqual(span[3].map(data), [1, 10, 22, 40]);
       },
-      "sorts null nodes at the end of the selection": function() {
-        var span = d3.selectAll("div").selectAll("span"), nulls = 0;
-        d3.select(span[0][0]).remove();
+      "returns the current selection": function(span) {
+        assert.isTrue(span.sort() === span);
+      },
+      "sorts null nodes at the end of the selection": function(span) {
+        var nulls = 0;
+        span[0][0].parentNode.removeChild(span[0][0]);
         span[0][0] = null;
         span.sort(function(a, b) { if ((a === null) || (b === null)) ++nulls; return a - b; });
         assert.equal(nulls, 0);
@@ -69,12 +67,8 @@ suite.addBatch({
           assert.domEqual(span[i][3], span[i][2].nextSibling);
           assert.domEqual(span[i][2], span[i][3].previousSibling);
           assert.domNull(span[i][3].nextSibling);
-          assert.deepEqual(span[i].map(data), [1, 2 + d, 10, 20 + d].sort(d3.ascending));
+          assert.deepEqual(span[i].map(data), [1, 2 + d, 10, 20 + d].sort(function(a, b) { return a - b; }));
         }
-      },
-      "returns the current selection": function(span) {
-        span = d3.select("body"); // https://github.com/tmpvar/jsdom/issues/277
-        assert.isTrue(span.sort() === span);
       }
     }
   }
diff --git a/test/selection/style-test.js b/test/selection/style-test.js
index 9ff2bb01..212080e5 100644
--- a/test/selection/style-test.js
+++ b/test/selection/style-test.js
@@ -1,55 +1,50 @@
 var vows = require("vows"),
-    d3 = require("../../"),
+    interpolateRgb = require("../../").interpolateRgb,
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("selection.style");
 
 suite.addBatch({
-  "select(body)": {
-    topic: load("selection/style").sandbox({
-      document: document,
-      window: window
-    }),
-    "on a simple page": {
+  "on select(body)": {
+    topic: load("selection/style").document(),
+    "on an initially-empty page": {
       topic: function(d3) {
-        return d3.select("body").html("");
+        return d3.select("body");
       },
       "sets a property as a string": function(body) {
         body.style("background-color", "red");
-        assert.equal(document.body.style.getPropertyValue("background-color"), "red");
+        assert.equal(body.node().style.getPropertyValue("background-color"), "red");
       },
       "sets a property as a number": function(body) {
         body.style("opacity", .3);
-        assert.equal(document.body.style.getPropertyValue("opacity"), "0.3");
+        assert.equal(body.node().style.getPropertyValue("opacity"), "0.3");
       },
       "sets a property as a function": function(body) {
         body.style("background-color", function() { return "orange"; });
-        assert.equal(document.body.style.getPropertyValue("background-color"), "orange");
+        assert.equal(body.node().style.getPropertyValue("background-color"), "orange");
       },
       "sets properties as a map of constants": function(body) {
         body.style({"background-color": "white", opacity: .42});
-        assert.equal(document.body.style.getPropertyValue("background-color"), "white");
-        assert.equal(document.body.style.getPropertyValue("opacity"), "0.42");
+        assert.equal(body.node().style.getPropertyValue("background-color"), "white");
+        assert.equal(body.node().style.getPropertyValue("opacity"), "0.42");
       },
       "sets properties as a map of functions": function(body) {
         body.data(["orange"]).style({"background-color": String, opacity: function(d, i) { return i; }});
-        assert.equal(document.body.style.getPropertyValue("background-color"), "orange");
-        assert.equal(document.body.style.getPropertyValue("opacity"), "0");
+        assert.equal(body.node().style.getPropertyValue("background-color"), "orange");
+        assert.equal(body.node().style.getPropertyValue("opacity"), "0");
       },
       "gets a property value": function(body) {
-        document.body.style.setProperty("background-color", "yellow", "");
+        body.node().style.setProperty("background-color", "yellow", "");
         assert.equal(body.style("background-color"), "yellow");
       },
       "observes the specified priority": function(body) {
         body.style("background-color", "green", "important");
-        assert.equal(document.body.style.getPropertyPriority("background-color"), "important");
+        assert.equal(body.node().style.getPropertyPriority("background-color"), "important");
         body.style({opacity: .52}, "important");
-        assert.equal(document.body.style.getPropertyPriority("opacity"), "important");
+        assert.equal(body.node().style.getPropertyPriority("opacity"), "important");
         body.style({visibility: function() { return "visible"; }}, "important");
-        assert.equal(document.body.style.getPropertyPriority("visibility"), "important");
+        assert.equal(body.node().style.getPropertyPriority("visibility"), "important");
       },
       "removes a property as null": function(body) {
         body.style("background-color", "green").style("background-color", null);
@@ -60,12 +55,12 @@ suite.addBatch({
         assert.equal(body.style("background-color"), "");
       },
       "removes properties as a map of nulls": function(body) {
-        document.body.style.setProperty("background-color", "purple");
+        body.node().style.setProperty("background-color", "purple");
         body.style({"background-color": null});
         assert.equal(body.style("background-color"), "");
       },
       "removes properties as a map of functions that return null": function(body) {
-        document.body.style.setProperty("background-color", "purple");
+        body.node().style.setProperty("background-color", "purple");
         body.style({"background-color": function() {}});
         assert.equal(body.style("background-color"), "");
       },
@@ -77,14 +72,11 @@ suite.addBatch({
 });
 
 suite.addBatch({
-  "selectAll(div)": {
-    topic: load("selection/style").sandbox({
-      document: document,
-      window: window
-    }),
-    "on a simple page": {
+  "on selectAll(div)": {
+    topic: load("selection/style").document(),
+    "on a page with a few divs": {
       topic: function(d3) {
-        return d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div");
+        return d3.select("body").selectAll("div").data([0, 1]).enter().append("div");
       },
       "sets a property as a string": function(div) {
         div.style("background-color", "red");
@@ -97,7 +89,7 @@ suite.addBatch({
         assert.equal(div[0][1].style.getPropertyValue("opacity"), "0.5");
       },
       "sets a property as a function": function(div) {
-        div.style("background-color", d3.interpolateRgb("orange", "yellow"));
+        div.style("background-color", interpolateRgb("orange", "yellow"));
         assert.equal(div[0][0].style.getPropertyValue("background-color"), "#ffa500");
         assert.equal(div[0][1].style.getPropertyValue("background-color"), "#ffff00");
       },
@@ -122,15 +114,14 @@ suite.addBatch({
       },
       "returns the current selection": function(div) {
         assert.isTrue(div.style("background-color", "green") === div);
+      },
+      "ignores null nodes": function(div) {
+        var node = div[0][1];
+        div[0][1] = null;
+        div.style("background-color", null).style("background-color", "red");
+        assert.equal(div[0][0].style.getPropertyValue("background-color"), "red");
+        assert.equal(node.style.getPropertyValue("background-color"), "green");
       }
-    },
-    "ignores null nodes": function(d3) {
-      var div = d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div"),
-          some = d3.selectAll("div");
-      some[0][1] = null;
-      some.style("background-color", null).style("background-color", "red");
-      assert.equal(div[0][0].style.getPropertyValue("background-color"), "red");
-      assert.equal(div[0][1].style.getPropertyValue("background-color"), "");
     }
   }
 });
diff --git a/test/selection/text-test.js b/test/selection/text-test.js
index 73daff82..6df0e71e 100644
--- a/test/selection/text-test.js
+++ b/test/selection/text-test.js
@@ -1,78 +1,69 @@
 var vows = require("vows"),
-    d3 = require("../../"),
     load = require("../load"),
-    assert = require("../env-assert"),
-    document = d3.selection().node()._ownerDocument,
-    window = document.defaultView;
+    assert = require("../env-assert");
 
 var suite = vows.describe("selection.text");
 
 suite.addBatch({
-  "select(body)": {
-    topic: load("selection/text").sandbox({
-      document: document,
-      window: window
-    }),
-    "on a simple page": {
+  "on select(body)": {
+    topic: load("selection/text").document(),
+    "on an initially-empty page": {
       topic: function(d3) {
-        return d3.select("body").html("");
+        return d3.select("body");
       },
       "sets the text content as a string": function(body) {
         body.text("Hello, world!");
-        assert.equal(document.body.textContent, "Hello, world!");
+        assert.equal(body.node().textContent, "Hello, world!");
       },
       "sets the text content as a number": function(body) {
         body.text(42);
-        assert.equal(document.body.textContent, "42");
+        assert.equal(body.node().textContent, "42");
       },
       "sets the text content as a function": function(body) {
         body.data(["Subject"]).text(function(d, i) { return "Hello, " + d + " " + i + "!"; });
-        assert.equal(document.body.textContent, "Hello, Subject 0!");
+        assert.equal(body.node().textContent, "Hello, Subject 0!");
       },
       "escapes html content to text": function(body) {
         body.text("<h1>Hello, world!</h1>");
-        assert.equal(document.body.textContent, "<h1>Hello, world!</h1>");
-        assert.equal(document.body.firstChild.nodeType, document.TEXT_NODE);
+        assert.equal(body.node().textContent, "<h1>Hello, world!</h1>");
+        assert.equal(body.node().firstChild.nodeType, 3);
       },
       "clears the text content as null": function(body) {
         body.text(null);
-        assert.equal(document.body.textContent, "");
+        assert.equal(body.node().textContent, "");
       },
       "clears the text content as undefined": function(body) {
         body.text(undefined);
-        assert.equal(document.body.textContent, "");
+        assert.equal(body.node().textContent, "");
       },
       "clears the text content as a function returning null": function(body) {
         body.text(function() { return null; });
-        assert.equal(document.body.textContent, "");
+        assert.equal(body.node().textContent, "");
       },
       "clears the text content as a function returning undefined": function(body) {
         body.text(function() { return undefined; });
-        assert.equal(document.body.textContent, "");
+        assert.equal(body.node().textContent, "");
       },
       "returns the current selection": function(body) {
         assert.isTrue(body.text("hello") === body);
+      },
+      "ignores null nodes": function(body) {
+        var node = body.node();
+        node.textContent = "foo";
+        body[0][0] = null;
+        body.text("bar");
+        assert.equal(node.textContent, "foo");
       }
-    },
-    "ignores null nodes": function(d3) {
-      var body = d3.select("body");
-      body[0][0] = null;
-      document.body.textContent = "foo";
-      body.text("bar");
-      assert.equal(document.body.textContent, "foo");
     }
   }
 });
 
 suite.addBatch({
-  "selectAll(div)": {
-    topic: load("selection/text").sandbox({
-      document: document,
-      window: window
-    }),
-    "on a simple page": {
+  "on selectAll(div)": {
+    topic: load("selection/text").document(),
+    "on a page with a few divs": {
       topic: function(d3) {
-        return d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div");
+        return d3.select("body").selectAll("div").data([0, 1]).enter().append("div");
       },
       "sets the text content as a string": function(div) {
         div.text("Hello, world!");
@@ -93,11 +84,9 @@ suite.addBatch({
         div.text("<h1>Hello, world!</h1>");
         assert.equal(div[0][0].textContent, "<h1>Hello, world!</h1>");
         assert.equal(div[0][1].textContent, "<h1>Hello, world!</h1>");
-        assert.equal(div[0][0].firstChild.nodeType, document.TEXT_NODE);
-        assert.equal(div[0][1].firstChild.nodeType, document.TEXT_NODE);
+        assert.equal(div[0][0].firstChild.nodeType, 3);
+        assert.equal(div[0][1].firstChild.nodeType, 3);
       },
-      /*
-      https://github.com/tmpvar/jsdom/issues/276
       "clears the text content as null": function(div) {
         div.text(null);
         assert.equal(div[0][0].textContent, "");
@@ -105,22 +94,20 @@ suite.addBatch({
       },
       "clears the text content as a function": function(div) {
         div.text(function() { return null; });
-        assert.equal(dv[0][0].textContent, "");
-        assert.equal(dv[0][1].textContent, "");
+        assert.equal(div[0][0].textContent, "");
+        assert.equal(div[0][1].textContent, "");
       },
-      */
       "returns the current selection": function(div) {
         assert.isTrue(div.text("hello") === div);
+      },
+      "ignores null nodes": function(div) {
+        var node = div[0][0];
+        node.textContent = "foo";
+        div[0][0] = null;
+        div.text("bar");
+        assert.equal(node.textContent, "foo");
+        assert.equal(div[0][1].textContent, "bar");
       }
-    },
-    "ignores null nodes": function(d3) {
-      var div = d3.select("body").html("").selectAll("div").data([0, 1]).enter().append("div");
-      div[0][0].textContent = "foo";
-      var some = d3.selectAll("div");
-      some[0][0] = null;
-      some.text("bar");
-      assert.equal(div[0][0].textContent, "foo");
-      assert.equal(div[0][1].textContent, "bar");
     }
   }
 });
