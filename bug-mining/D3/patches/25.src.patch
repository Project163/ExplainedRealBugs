diff --git a/Makefile b/Makefile
index 0ef5aa0f..0b782400 100644
--- a/Makefile
+++ b/Makefile
@@ -107,6 +107,7 @@ d3.svg.js: \
 d3.behavior.js: \
 	src/start.js \
 	src/behavior/behavior.js \
+	src/behavior/drag.js \
 	src/behavior/zoom.js \
 	src/end.js
 
diff --git a/d3.behavior.js b/d3.behavior.js
index 8c67949a..588e394b 100644
--- a/d3.behavior.js
+++ b/d3.behavior.js
@@ -1,4 +1,119 @@
 (function(){d3.behavior = {};
+d3.behavior.drag = function() {
+  var event = d3.dispatch("drag", "dragstart", "dragend");
+
+  function drag() {
+    this
+      .on("mousedown.drag", mousedown)
+      .on("touchstart.drag", mousedown);
+
+    d3.select(window)
+      .on("mousemove.drag", d3_behavior_dragMove)
+      .on("touchmove.drag", d3_behavior_dragMove)
+      .on("mouseup.drag", d3_behavior_dragUp, true)
+      .on("touchend.drag", d3_behavior_dragUp, true)
+      .on("click.drag", d3_behavior_dragClick, true);
+  }
+
+  // snapshot the local context for subsequent dispatch
+  function start() {
+    d3_behavior_dragEvent = event;
+    d3_behavior_dragTarget = this;
+    d3_behavior_dragMoved = false;
+    d3_behavior_dragArguments = arguments;
+  }
+
+  function mousedown() {
+    start.apply(this, arguments);
+    var parent = d3_behavior_dragParent();
+    if (!parent) return;
+    d3_behavior_dragTo(d3_behavior_dragPoint(parent), "dragstart");
+  }
+
+  drag.on = function(type, listener) {
+    event[type].add(listener);
+    return drag;
+  };
+
+  return drag;
+};
+
+var d3_behavior_dragEvent,
+    d3_behavior_dragTarget,
+    d3_behavior_dragMoved,
+    d3_behavior_dragStopClick;
+
+function d3_behavior_dragParent() {
+  var parent = d3_behavior_dragTarget.parentNode;
+
+  // O NOES! The drag element was removed from the DOM.
+  if (!parent) d3_behavior_dragUp();
+
+  return parent;
+}
+
+function d3_behavior_dragTo(point, type) {
+  var o = d3.event;
+  d3.event = {position: point};
+
+  try {
+    d3_behavior_dragEvent[type].dispatch.apply(d3_behavior_dragTarget, d3_behavior_dragArguments);
+  } finally {
+    d3.event = o;
+  }
+
+  o.preventDefault();
+}
+
+function d3_behavior_dragPoint(container) {
+  return d3.event.touches
+    ? d3.svg.touches(container)[0]
+    : d3.svg.mouse(container);
+}
+
+function d3_behavior_dragMove() {
+  if (!d3_behavior_dragTarget) return;
+  var parent = d3_behavior_dragParent();
+  if (!parent) return;
+
+  d3_behavior_dragTo(d3_behavior_dragPoint(parent), "drag");
+  d3_behavior_dragMoved = true;
+  d3_behavior_dragCancel();
+}
+
+function d3_behavior_dragUp() {
+  if (!d3_behavior_dragTarget) return;
+  var parent = d3_behavior_dragParent();
+  if (!parent) return;
+
+  // If the node was moved, prevent the mouseup from propagating.
+  // Also prevent the subsequent click from propagating (e.g., for anchors).
+  if (d3_behavior_dragMoved) {
+    d3_behavior_dragStopClick = true;
+    d3_behavior_dragCancel();
+
+    // Don't trigger this for touchend.
+    if (d3.event.type === "mouseup") {
+      d3_behavior_dragMove();
+    }
+  }
+  d3_behavior_dragTo(d3_behavior_dragPoint(parent), "dragend");
+
+  d3_behavior_dragForce =
+  d3_behavior_dragTarget = null;
+}
+
+function d3_behavior_dragClick() {
+  if (d3_behavior_dragStopClick) {
+    d3_behavior_dragCancel();
+    d3_behavior_dragStopClick = false;
+  }
+}
+
+function d3_behavior_dragCancel() {
+  d3.event.stopPropagation();
+  d3.event.preventDefault();
+}
 // TODO unbind zoom behavior?
 // TODO unbind listener?
 d3.behavior.zoom = function() {
diff --git a/d3.behavior.min.js b/d3.behavior.min.js
index d0c039f8..e8684175 100644
--- a/d3.behavior.min.js
+++ b/d3.behavior.min.js
@@ -1 +1 @@
-(function(){function p(a,b,c){function m(a,b){var c=a.__domain||(a.__domain=a.domain()),d=a.range().map(function(a){return(a-b)/l});a.domain(c).domain(d.map(a.invert))}var d=Math.pow(2,(f[2]=a)-c[2]),e=f[0]=b[0]-d*c[0],j=f[1]=b[1]-d*c[1],k=d3.event,l=Math.pow(2,a);d3.event={scale:l,translate:[e,j],transform:function(a,b){a&&m(a,e),b&&m(b,j)}};try{g.apply(h,i)}finally{d3.event=k}k.preventDefault()}function o(){b&&(n(),b=null)}function n(){c=null,b&&p(f[2],d3.svg.mouse(h),b)}function m(){var a=d3.svg.touches(h);switch(a.length){case 1:var b=a[0];p(f[2],b,d[b.identifier]);break;case 2:var c=a[0],e=a[1],g=[(c[0]+e[0])/2,(c[1]+e[1])/2],i=d[c.identifier],j=d[e.identifier],k=[(i[0]+j[0])/2,(i[1]+j[1])/2,i[2]];p(Math.log(d3.event.scale)/Math.LN2+i[2],g,k)}}function l(){var a=d3.svg.touches(h),b=-1,c=a.length,e;while(++b<c)d[(e=a[b]).identifier]=j(e);return a}function k(){a||(a=d3.select("body").append("div").style("visibility","hidden").style("top",0).style("height",0).style("width",0).style("overflow-y","scroll").append("div").style("height","2000px").node().parentNode);var b=d3.event,c;try{a.scrollTop=1e3,a.dispatchEvent(b),c=1e3-a.scrollTop}catch(d){c=b.wheelDelta||-b.detail}return c*.005}function j(a){return[a[0]-f[0],a[1]-f[1],f[2]]}d3.behavior={},d3.behavior.zoom=function(){function w(){s.apply(this,arguments);var b=l(),c,f=Date.now();b.length===1&&f-e<300&&p(1+Math.floor(a[2]),c=b[0],d[c.identifier]),e=f}function v(){s.apply(this,arguments);var b=d3.svg.mouse(h);p(d3.event.shiftKey?Math.ceil(a[2]-1):Math.floor(a[2]+1),b,j(b))}function u(){s.apply(this,arguments),c||(c=j(d3.svg.mouse(h))),p(k()+a[2],d3.svg.mouse(h),c)}function t(){s.apply(this,arguments),b=j(d3.svg.mouse(h)),d3.event.preventDefault(),window.focus()}function s(){f=a,g=q.zoom.dispatch,h=this,i=arguments}function r(){this.on("mousedown.zoom",t).on("mousewheel.zoom",u).on("DOMMouseScroll.zoom",v).on("dblclick.zoom",v).on("touchstart.zoom",w),d3.select(window).on("mousemove.zoom",n).on("mouseup.zoom",o).on("touchmove.zoom",m).on("touchend.zoom",l)}var a=[0,0,0],q=d3.dispatch("zoom");r.on=function(a,b){q[a].add(b);return r};return r};var a,b,c,d={},e=0,f,g,h,i})()
\ No newline at end of file
+(function(){function A(a,b,c){function i(a,b){var c=a.__domain||(a.__domain=a.domain()),d=a.range().map(function(a){return(a-b)/h});a.domain(c).domain(d.map(a.invert))}var d=Math.pow(2,(q[2]=a)-c[2]),e=q[0]=b[0]-d*c[0],f=q[1]=b[1]-d*c[1],g=d3.event,h=Math.pow(2,a);d3.event={scale:h,translate:[e,f],transform:function(a,b){a&&i(a,e),b&&i(b,f)}};try{r.apply(s,t)}finally{d3.event=g}g.preventDefault()}function z(){m&&(y(),m=null)}function y(){n=null,m&&A(q[2],d3.svg.mouse(s),m)}function x(){var a=d3.svg.touches(s);switch(a.length){case 1:var b=a[0];A(q[2],b,o[b.identifier]);break;case 2:var c=a[0],d=a[1],e=[(c[0]+d[0])/2,(c[1]+d[1])/2],f=o[c.identifier],g=o[d.identifier],h=[(f[0]+g[0])/2,(f[1]+g[1])/2,f[2]];A(Math.log(d3.event.scale)/Math.LN2+f[2],e,h)}}function w(){var a=d3.svg.touches(s),b=-1,c=a.length,d;while(++b<c)o[(d=a[b]).identifier]=u(d);return a}function v(){l||(l=d3.select("body").append("div").style("visibility","hidden").style("top",0).style("height",0).style("width",0).style("overflow-y","scroll").append("div").style("height","2000px").node().parentNode);var a=d3.event,b;try{l.scrollTop=1e3,l.dispatchEvent(a),b=1e3-l.scrollTop}catch(c){b=a.wheelDelta||-a.detail}return b*.005}function u(a){return[a[0]-q[0],a[1]-q[1],q[2]]}function k(){d3.event.stopPropagation(),d3.event.preventDefault()}function j(){d&&(k(),d=!1)}function i(){if(!!b){var a=e();if(!a)return;c&&(d=!0,k(),d3.event.type==="mouseup"&&h()),f(g(a),"dragend"),d3_behavior_dragForce=b=null}}function h(){if(!!b){var a=e();if(!a)return;f(g(a),"drag"),c=!0,k()}}function g(a){return d3.event.touches?d3.svg.touches(a)[0]:d3.svg.mouse(a)}function f(c,d){var e=d3.event;d3.event={position:c};try{a[d].dispatch.apply(b,d3_behavior_dragArguments)}finally{d3.event=e}e.preventDefault()}function e(){var a=b.parentNode;a||i();return a}d3.behavior={},d3.behavior.drag=function(){function m(){l.apply(this,arguments);var a=e();!a||f(g(a),"dragstart")}function l(){a=d,b=this,c=!1,d3_behavior_dragArguments=arguments}function k(){this.on("mousedown.drag",m).on("touchstart.drag",m),d3.select(window).on("mousemove.drag",h).on("touchmove.drag",h).on("mouseup.drag",i,!0).on("touchend.drag",i,!0).on("click.drag",j,!0)}var d=d3.dispatch("drag","dragstart","dragend");k.on=function(a,b){d[a].add(b);return k};return k};var a,b,c,d;d3.behavior.zoom=function(){function h(){d.apply(this,arguments);var b=w(),c,e=Date.now();b.length===1&&e-p<300&&A(1+Math.floor(a[2]),c=b[0],o[c.identifier]),p=e}function g(){d.apply(this,arguments);var b=d3.svg.mouse(s);A(d3.event.shiftKey?Math.ceil(a[2]-1):Math.floor(a[2]+1),b,u(b))}function f(){d.apply(this,arguments),n||(n=u(d3.svg.mouse(s))),A(v()+a[2],d3.svg.mouse(s),n)}function e(){d.apply(this,arguments),m=u(d3.svg.mouse(s)),d3.event.preventDefault(),window.focus()}function d(){q=a,r=b.zoom.dispatch,s=this,t=arguments}function c(){this.on("mousedown.zoom",e).on("mousewheel.zoom",f).on("DOMMouseScroll.zoom",g).on("dblclick.zoom",g).on("touchstart.zoom",h),d3.select(window).on("mousemove.zoom",y).on("mouseup.zoom",z).on("touchmove.zoom",x).on("touchend.zoom",w)}var a=[0,0,0],b=d3.dispatch("zoom");c.on=function(a,d){b[a].add(d);return c};return c};var l,m,n,o={},p=0,q,r,s,t})()
\ No newline at end of file
diff --git a/d3.layout.js b/d3.layout.js
index 3d854ed6..7b4bbe45 100644
--- a/d3.layout.js
+++ b/d3.layout.js
@@ -449,110 +449,38 @@ d3.layout.force = function() {
 
   // use `node.call(force.drag)` to make nodes draggable
   force.drag = function() {
-
     this
-      .on("mouseover.force", d3_layout_forceDragOver)
-      .on("mouseout.force", d3_layout_forceDragOut)
-      .on("mousedown.force", dragdown)
-      .on("touchstart.force", dragdown);
-
-    d3.select(window)
-      .on("mousemove.force", d3_layout_forceDragMove)
-      .on("touchmove.force", d3_layout_forceDragMove)
-      .on("mouseup.force", d3_layout_forceDragUp, true)
-      .on("touchend.force", d3_layout_forceDragUp, true)
-      .on("click.force", d3_layout_forceDragClick, true);
+      .call(d3.behavior.drag()
+        .on("dragstart", dragstart)
+        .on("drag", d3_layout_forceDrag)
+        .on("dragend", d3_layout_forceDragEnd));
 
     return force;
   };
 
-  function dragdown(d, i) {
-    var m = d3_layout_forcePoint(this.parentNode);
+  function dragstart(d) {
     (d3_layout_forceDragNode = d).fixed = true;
-    d3_layout_forceDragMoved = false;
-    d3_layout_forceDragElement = this;
     d3_layout_forceDragForce = force;
-    d3_layout_forceDragOffset = [m[0] - d.x, m[1] - d.y];
-    d3_layout_forceCancel();
   }
 
   return force;
 };
 
 var d3_layout_forceDragForce,
-    d3_layout_forceDragNode,
-    d3_layout_forceDragMoved,
-    d3_layout_forceDragOffset,
-    d3_layout_forceStopClick,
-    d3_layout_forceDragElement;
-
-function d3_layout_forceDragOver(d) {
-  d.fixed = true;
-}
-
-function d3_layout_forceDragOut(d) {
-  if (d !== d3_layout_forceDragNode) {
-    d.fixed = false;
-  }
-}
-
-function d3_layout_forcePoint(container) {
-  return d3.event.touches
-      ? d3.svg.touches(container)[0]
-      : d3.svg.mouse(container);
-}
-
-function d3_layout_forceDragMove() {
-  if (!d3_layout_forceDragNode) return;
-  var parent = d3_layout_forceDragElement.parentNode;
-
-  // O NOES! The drag element was removed from the DOM.
-  if (!parent) {
-    d3_layout_forceDragNode.fixed = false;
-    d3_layout_forceDragOffset = d3_layout_forceDragNode = d3_layout_forceDragElement = null;
-    return;
-  }
-
-  var m = d3_layout_forcePoint(parent);
-  d3_layout_forceDragMoved = true;
-  d3_layout_forceDragNode.px = m[0] - d3_layout_forceDragOffset[0];
-  d3_layout_forceDragNode.py = m[1] - d3_layout_forceDragOffset[1];
-  d3_layout_forceCancel();
-  d3_layout_forceDragForce.resume(); // restart annealing
-}
-
-function d3_layout_forceDragUp() {
-  if (!d3_layout_forceDragNode) return;
-
-  // If the node was moved, prevent the mouseup from propagating.
-  // Also prevent the subsequent click from propagating (e.g., for anchors).
-  if (d3_layout_forceDragMoved) {
-    d3_layout_forceStopClick = true;
-    d3_layout_forceCancel();
-  }
-
-  // Don't trigger this for touchend.
-  if (d3.event.type === "mouseup") {
-    d3_layout_forceDragMove();
-  }
+    d3_layout_forceDragNode;
 
+function d3_layout_forceDragEnd(d) {
   d3_layout_forceDragNode.fixed = false;
   d3_layout_forceDragForce =
-  d3_layout_forceDragOffset =
-  d3_layout_forceDragNode =
-  d3_layout_forceDragElement = null;
+  d3_layout_forceDragNode = null;
 }
 
-function d3_layout_forceDragClick() {
-  if (d3_layout_forceStopClick) {
-    d3_layout_forceCancel();
-    d3_layout_forceStopClick = false;
-  }
-}
+function d3_layout_forceDrag() {
+  var m = d3.event.position;
 
-function d3_layout_forceCancel() {
-  d3.event.stopPropagation();
-  d3.event.preventDefault();
+  d3_layout_forceDragNode.px = m[0];
+  d3_layout_forceDragNode.py = m[1];
+  d3_layout_forceDragForce.resume(); // restart annealing
 }
 
 function d3_layout_forceAccumulate(quad) {
diff --git a/d3.layout.min.js b/d3.layout.min.js
index 3d0887f0..02de7c0b 100644
--- a/d3.layout.min.js
+++ b/d3.layout.min.js
@@ -1 +1 @@
-(function(){function bj(a,b){var c=a.x+b[3],d=a.y+b[0],e=a.dx-b[1]-b[3],f=a.dy-b[0]-b[2];e<0&&(c+=e/2,e=0),f<0&&(d+=f/2,f=0);return{x:c,y:d,dx:e,dy:f}}function bi(a){return{x:a.x,y:a.y,dx:a.dx,dy:a.dy}}function bh(a,b,c){return a._tree.ancestor.parent==b.parent?a._tree.ancestor:c}function bg(a,b,c){a=a._tree,b=b._tree;var d=c/(b.number-a.number);a.change+=d,b.change-=d,b.shift+=c,b.prelim+=c,b.mod+=c}function bf(a){var b=0,c=0,d=a.children,e=d.length,f;while(--e>=0)f=d[e]._tree,f.prelim+=b,f.mod+=b,b+=f.shift+(c+=f.change)}function be(a,b){function c(a,d){var e=a.children;if(e){var f,g=null,h=-1,i=e.length;while(++h<i)f=e[h],c(f,g),g=f}b(a,d)}c(a,null)}function bd(a,b){return a.depth-b.depth}function bc(a,b){return b.x-a.x}function bb(a,b){return a.x-b.x}function ba(a,b){var c=a.children;if(c){var d,e=c.length,f=-1;while(++f<e)b(d=ba(c[f],b),a)>0&&(a=d)}return a}function _(a){return a.children?a.children[a.children.length-1]:a._tree.thread}function $(a){return a.children?a.children[0]:a._tree.thread}function Z(a,b){return a.parent==b.parent?1:2}function Y(a){var b=a.children;return b?Y(b[b.length-1]):a}function X(a){var b=a.children;return b?X(b[0]):a}function W(a){return a.reduce(function(a,b){return a+b.x},0)/a.length}function V(a){return 1+d3.max(a,function(a){return a.y})}function U(a,b,c){var d=b.r+c.r,e=a.r+c.r,f=b.x-a.x,g=b.y-a.y,h=Math.sqrt(f*f+g*g),i=(e*e+h*h-d*d)/(2*e*h),j=Math.acos(i),k=i*e,l=Math.sin(j)*e;f/=h,g/=h,c.x=a.x+k*f+l*g,c.y=a.y+k*g-l*f}function T(a,b,c,d){var e=a.children;a.x=b+=d*a.x,a.y=c+=d*a.y,a.r*=d;if(e){var f=-1,g=e.length;while(++f<g)T(e[f],b,c,d)}}function S(a){var b=a.children;b?(b.forEach(S),a.r=P(b)):a.r=Math.sqrt(a.value)}function R(a){delete a._pack_next,delete a._pack_prev}function Q(a){a._pack_next=a._pack_prev=a}function P(a){function l(a){b=Math.min(a.x-a.r,b),c=Math.max(a.x+a.r,c),d=Math.min(a.y-a.r,d),e=Math.max(a.y+a.r,e)}var b=Infinity,c=-Infinity,d=Infinity,e=-Infinity,f=a.length,g,h,i,j,k;a.forEach(Q),g=a[0],g.x=-g.r,g.y=0,l(g);if(f>1){h=a[1],h.x=h.r,h.y=0,l(h);if(f>2){i=a[2],U(g,h,i),l(i),M(g,i),g._pack_prev=i,M(i,h),h=g._pack_next;for(var m=3;m<f;m++){U(g,h,i=a[m]);var n=0,o=1,p=1;for(j=h._pack_next;j!==h;j=j._pack_next,o++)if(O(j,i)){n=1;break}if(n==1)for(k=g._pack_prev;k!==j._pack_prev;k=k._pack_prev,p++)if(O(k,i)){p<o&&(n=-1,j=k);break}n==0?(M(g,i),h=i,l(i)):n>0?(N(g,j),h=j,m--):(N(j,h),g=j,m--)}}}var q=(b+c)/2,r=(d+e)/2,s=0;for(var m=0;m<f;m++){var t=a[m];t.x-=q,t.y-=r,s=Math.max(s,t.r+Math.sqrt(t.x*t.x+t.y*t.y))}a.forEach(R);return s}function O(a,b){var c=b.x-a.x,d=b.y-a.y,e=a.r+b.r;return e*e-c*c-d*d>.001}function N(a,b){a._pack_next=b,b._pack_prev=a}function M(a,b){var c=a._pack_next;a._pack_next=b,b._pack_prev=a,b._pack_next=c,c._pack_prev=b}function L(a,b){return a.value-b.value}function J(a){return d3.merge(a.map(function(a){return(a.children||[]).map(function(b){return{source:a,target:b}})}))}function I(a,b){return b.value-a.value}function H(a){return a.value}function G(a){return a.children}function F(a,b){a.sort=d3.rebind(a,b.sort),a.children=d3.rebind(a,b.children),a.links=J,a.value=d3.rebind(a,b.value),a.nodes=function(b){K=!0;return(a.nodes=a)(b)};return a}function E(a){return[d3.min(a),d3.max(a)]}function D(a,b){var c=-1,d=+a[0],e=(a[1]-d)/b,f=[];while(++c<=b)f[c]=e*c+d;return f}function C(a,b){return D(a,Math.ceil(Math.log(b.length)/Math.LN2+1))}function B(a,b){return a+b[1]}function A(a){return a.reduce(B,0)}function z(a){var b=1,c=0,d=a[0][1],e,f=a.length;for(;b<f;++b)(e=a[b][1])>d&&(c=b,d=e);return c}function w(a,b,c){a.y0=b,a.y=c}function v(a){return a.y}function u(a){return a.x}function t(a){return 1}function s(a){return 20}function r(a){var b=0,c=0;a.count=0;if(!a.leaf){var d=a.nodes,e=d.length,f=-1,g;while(++f<e){g=d[f];if(g==null)continue;r(g),a.count+=g.count,b+=g.count*g.cx,c+=g.count*g.cy}}a.point&&(a.leaf||(a.point.x+=Math.random()-.5,a.point.y+=Math.random()-.5),a.count++,b+=a.point.x,c+=a.point.y),a.cx=b/a.count,a.cy=c/a.count}function q(){d3.event.stopPropagation(),d3.event.preventDefault()}function p(){i&&(q(),i=!1)}function o(){!f||(g&&(i=!0,q()),d3.event.type==="mouseup"&&n(),f.fixed=!1,e=h=f=j=null)}function n(){if(!!f){var a=j.parentNode;if(!a){f.fixed=!1,h=f=j=null;return}var b=m(a);g=!0,f.px=b[0]-h[0],f.py=b[1]-h[1],q(),e.resume()}}function m(a){return d3.event.touches?d3.svg.touches(a)[0]:d3.svg.mouse(a)}function l(a){a!==f&&(a.fixed=!1)}function k(a){a.fixed=!0}function c(a,c){if(a===c)return a;var d=b(a),e=b(c),f=d.pop(),g=e.pop(),h=null;while(f===g)h=f,f=d.pop(),g=e.pop();return h}function b(a){var b=[],c=a.parent;while(c!=null)b.push(a),a=c,c=c.parent;b.push(a);return b}function a(a){var b=a.source,d=a.target,e=c(b,d),f=[b];while(b!==e)b=b.parent,f.push(b);var g=f.length;while(d!==e)f.splice(g,0,d),d=d.parent;return f}d3.layout={},d3.layout.bundle=function(){return function(b){var c=[],d=-1,e=b.length;while(++d<e)c.push(a(b[d]));return c}},d3.layout.chord=function(){function k(){b.sort(function(a,b){return i(a.target.value,b.target.value)})}function j(){var a={},j=[],l=d3.range(e),m=[],n,o,p,q,r;b=[],c=[],n=0,q=-1;while(++q<e){o=0,r=-1;while(++r<e)o+=d[q][r];j.push(o),m.push(d3.range(e)),n+=o}g&&l.sort(function(a,b){return g(j[a],j[b])}),h&&m.forEach(function(a,b){a.sort(function(a,c){return h(d[b][a],d[b][c])})}),n=(2*Math.PI-f*e)/n,o=0,q=-1;while(++q<e){p=o,r=-1;while(++r<e){var s=l[q],t=m[q][r],u=d[s][t];a[s+"-"+t]={index:s,subindex:t,startAngle:o,endAngle:o+=u*n,value:u}}c.push({index:s,startAngle:p,endAngle:o,value:(o-p)/n}),o+=f}q=-1;while(++q<e){r=q-1;while(++r<e){var v=a[q+"-"+r],w=a[r+"-"+q];(v.value||w.value)&&b.push(v.value<w.value?{source:w,target:v}:{source:v,target:w})}}i&&k()}var a={},b,c,d,e,f=0,g,h,i;a.matrix=function(f){if(!arguments.length)return d;e=(d=f)&&d.length,b=c=null;return a},a.padding=function(d){if(!arguments.length)return f;f=d,b=c=null;return a},a.sortGroups=function(d){if(!arguments.length)return g;g=d,b=c=null;return a},a.sortSubgroups=function(c){if(!arguments.length)return h;h=c,b=null;return a},a.sortChords=function(c){if(!arguments.length)return i;i=c,b&&k();return a},a.chords=function(){b||j();return b},a.groups=function(){c||j();return c};return a},d3.layout.force=function(){function G(b,c){var d=m(this.parentNode);(f=b).fixed=!0,g=!1,j=this,e=a,h=[d[0]-b.x,d[1]-b.y],q()}function F(){var a=A.length,e=B.length,f=d3.geom.quadtree(A),g,h,j,k,l,m,n;for(g=0;g<e;++g){h=B[g],j=h.source,k=h.target,m=k.x-j.x,n=k.y-j.y;if(l=m*m+n*n)l=d*D[g]*((l=Math.sqrt(l))-C[g])/l,m*=l,n*=l,k.x-=m,k.y-=n,j.x+=m,j.y+=n}var o=d*x;m=c[0]/2,n=c[1]/2,g=-1;while(++g<a)h=A[g],h.x+=(m-h.x)*o,h.y+=(n-h.y)*o;r(f);var p=d*w;g=-1;while(++g<a)f.visit(E(A[g],p));g=-1;while(++g<a)h=A[g],h.fixed?(h.x=h.px,h.y=h.py):(h.x-=(h.px-(h.px=h.x))*i,h.y-=(h.py-(h.py=h.y))*i);b.tick.dispatch({type:"tick",alpha:d});return(d*=.99)<.005}function E(a,b){return function(c,d,e,f,g){if(c.point!==a){var h=c.cx-a.x,i=c.cy-a.y,j=1/Math.sqrt(h*h+i*i);if((f-d)*j<y){var k=b*c.count*j*j;a.x+=h*k,a.y+=i*k;return!0}if(c.point&&isFinite(j)){var k=b*j*j;a.x+=h*k,a.y+=i*k}}}}var a={},b=d3.dispatch("tick"),c=[1,1],d,i=.9,u=s,v=t,w=-30,x=.1,y=.8,z,A=[],B=[],C,D;a.on=function(c,d){b[c].add(d);return a},a.nodes=function(b){if(!arguments.length)return A;A=b;return a},a.links=function(b){if(!arguments.length)return B;B=b;return a},a.size=function(b){if(!arguments.length)return c;c=b;return a},a.linkDistance=function(b){if(!arguments.length)return u;u=d3.functor(b);return a},a.distance=a.linkDistance,a.linkStrength=function(b){if(!arguments.length)return v;v=d3.functor(b);return a},a.friction=function(b){if(!arguments.length)return i;i=b;return a},a.charge=function(b){if(!arguments.length)return w;w=b;return a},a.gravity=function(b){if(!arguments.length)return x;x=b;return a},a.theta=function(b){if(!arguments.length)return y;y=b;return a},a.start=function(){function l(){if(!i){i=[];for(d=0;d<e;++d)i[d]=[];for(d=0;d<f;++d){var a=B[d];i[a.source.index].push(a.target),i[a.target.index].push(a.source)}}return i[b]}function k(a,c){var d=l(b),e=-1,f=d.length,g;while(++e<f)if(!isNaN(g=d[e][a]))return g;return Math.random()*c}var b,d,e=A.length,f=B.length,g=c[0],h=c[1],i,j;for(b=0;b<e;++b)(j=A[b]).index=b;C=[],D=[];for(b=0;b<f;++b)j=B[b],typeof j.source=="number"&&(j.source=A[j.source]),typeof j.target=="number"&&(j.target=A[j.target]),C[b]=u.call(this,j,b),D[b]=v.call(this,j,b);for(b=0;b<e;++b)j=A[b],isNaN(j.x)&&(j.x=k("x",g)),isNaN(j.y)&&(j.y=k("y",h)),isNaN(j.px)&&(j.px=j.x),isNaN(j.py)&&(j.py=j.y);return a.resume()},a.resume=function(){d=.1,d3.timer(F);return a},a.stop=function(){d=0;return a},a.drag=function(){this.on("mouseover.force",k).on("mouseout.force",l).on("mousedown.force",G).on("touchstart.force",G),d3.select(window).on("mousemove.force",n).on("touchmove.force",n).on("mouseup.force",o,!0).on("touchend.force",o,!0).on("click.force",p,!0);return a};return a};var e,f,g,h,i,j;d3.layout.partition=function(){function e(e,f){var g=a.call(this,e,f);c(g[0],0,b[0],b[1]/d(g[0]));return g}function d(a){var b=a.children,c=0;if(b){var e=-1,f=b.length;while(++e<f)c=Math.max(c,d(b[e]))}return 1+c}function c(a,b,d,e){var f=a.children;a.x=b,a.y=a.depth*e,a.dx=d,a.dy=e;if(f){var g=-1,h=f.length,i,j;d=a.value?d/a.value:0;while(++g<h)c(i=f[g],b,j=i.value*d,e),b+=j}}var a=d3.layout.hierarchy(),b=[1,1];e.size=function(a){if(!arguments.length)return b;b=a;return e};return F(e,a)},d3.layout.pie=function(){function f(f,g){var h=+(typeof c=="function"?c.apply(this,arguments):c),i=(typeof e=="function"?e.apply(this,arguments):e)-c,j=d3.range(f.length);b!=null&&j.sort(function(a,c){return b(f[a],f[c])});var k=f.map(a);i/=k.reduce(function(a,b){return a+b},0);var l=j.map(function(a){return{data:f[a],value:d=k[a],startAngle:h,endAngle:h+=d*i}});return f.map(function(a,b){return l[j[b]]})}var a=Number,b=null,c=0,e=2*Math.PI;f.value=function(b){if(!arguments.length)return a;a=b;return f},f.sort=function(a){if(!arguments.length)return b;b=a;return f},f.startAngle=function(a){if(!arguments.length)return c;c=a;return f},f.endAngle=function(a){if(!arguments.length)return e;e=a;return f};return f},d3.layout.stack=function(){function g(h,i){var j=h.map(function(b,c){return a.call(g,b,c)}),k=j.map(function(a,b){return a.map(function(a,b){return[e.call(g,a,b),f.call(g,a,b)]})}),l=b.call(g,k,i);j=d3.permute(j,l),k=d3.permute(k,l);var m=c.call(g,k,i),n=j.length,o=j[0].length,p,q,r;for(q=0;q<o;++q){d.call(g,j[0][q],r=m[q],k[0][q][1]);for(p=1;p<n;++p)d.call(g,j[p][q],r+=k[p-1][q][1],k[p][q][1])}return h}var a=Object,b=x["default"],c=y.zero,d=w,e=u,f=v;g.values=function(b){if(!arguments.length)return a;a=b;return g},g.order=function(a){if(!arguments.length)return b;b=typeof a=="function"?a:x[a];return g},g.offset=function(a){if(!arguments.length)return c;c=typeof a=="function"?a:y[a];return g},g.x=function(a){if(!arguments.length)return e;e=a;return g},g.y=function(a){if(!arguments.length)return f;f=a;return g},g.out=function(a){if(!arguments.length)return d;d=a;return g};return g};var x={"inside-out":function(a){var b=a.length,c,d,e=a.map(z),f=a.map(A),g=d3.range(b).sort(function(a,b){return e[a]-e[b]}),h=0,i=0,j=[],k=[];for(c=0;c<b;++c)d=g[c],h<i?(h+=f[d],j.push(d)):(i+=f[d],k.push(d));return k.reverse().concat(j)},reverse:function(a){return d3.range(a.length).reverse()},"default":function(a){return d3.range(a.length)}},y={silhouette:function(a){var b=a.length,c=a[0].length,d=[],e=0,f,g,h,i=[];for(g=0;g<c;++g){for(f=0,h=0;f<b;f++)h+=a[f][g][1];h>e&&(e=h),d.push(h)}for(g=0;g<c;++g)i[g]=(e-d[g])/2;return i},wiggle:function(a){var b=a.length,c=a[0],d=c.length,e=0,f,g,h,i,j,k,l,m,n,o=[];o[0]=m=n=0;for(g=1;g<d;++g){for(f=0,i=0;f<b;++f)i+=a[f][g][1];for(f=0,j=0,l=c[g][0]-c[g-1][0];f<b;++f){for(h=0,k=(a[f][g][1]-a[f][g-1][1])/(2*l);h<f;++h)k+=(a[h][g][1]-a[h][g-1][1])/l;j+=k*a[f][g][1]}o[g]=m-=i?j/i*l:0,m<n&&(n=m)}for(g=0;g<d;++g)o[g]-=n;return o},expand:function(a){var b=a.length,c=a[0].length,d=1/b,e,f,g,h=[];for(f=0;f<c;++f){for(e=0,g=0;e<b;e++)g+=a[e][f][1];if(g)for(e=0;e<b;e++)a[e][f][1]/=g;else for(e=0;e<b;e++)a[e][f][1]=d}for(f=0;f<c;++f)h[f]=0;return h},zero:function(a){var b=-1,c=a[0].length,d=[];while(++b<c)d[b]=0;return d}};d3.layout.histogram=function(){function e(e,f){var g=[],h=e.map(b,this),i=c.call(this,h,f),j=d.call(this,i,h,f),k,f=-1,l=h.length,m=j.length-1,n=a?1:1/l,o;while(++f<m)k=g[f]=[],k.dx=j[f+1]-(k.x=j[f]),k.y=0;f=-1;while(++f<l)o=h[f],o>=i[0]&&o<=i[1]&&(k=g[d3.bisect(j,o,1,m)-1],k.y+=n,k.push(e[f]));return g}var a=!0,b=Number,c=E,d=C;e.value=function(a){if(!arguments.length)return b;b=a;return e},e.range=function(a){if(!arguments.length)return c;c=d3.functor(a);return e},e.bins=function(a){if(!arguments.length)return d;d=typeof a=="number"?function(b){return D(b,a)}:d3.functor(a);return e},e.frequency=function(b){if(!arguments.length)return a;a=!!b;return e};return e},d3.layout.hierarchy=function(){function g(a){var b=[];e(a,0,b);return b}function f(a,b){var d=a.children,e=0;if(d){var h=-1,i=d.length,j=b+1;while(++h<i)e+=f(d[h],j)}else c&&(e=+c.call(g,K?a:a.data,b)||0);c&&(a.value=e);return e}function e(f,h,i){var j=b.call(g,f,h),k=K?f:{data:f};k.depth=h,i.push(k);if(j){var l=-1,m=j.length,n=k.children=[],o=0,p=h+1;while(++l<m)d=e(j[l],p,i),d.parent=k,n.push(d),o+=d.value;a&&n.sort(a),c&&(k.value=o)}else c&&(k.value=+c.call(g,f,h)||0);return k}var a=I,b=G,c=H;g.sort=function(b){if(!arguments.length)return a;a=b;return g},g.children=function(a){if(!arguments.length)return b;b=a;return g},g.value=function(a){if(!arguments.length)return c;c=a;return g},g.revalue=function(a){f(a,0);return a};return g};var K=!1;d3.layout.pack=function(){function c(c,d){var e=a.call(this,c,d),f=e[0];f.x=0,f.y=0,S(f);var g=b[0],h=b[1],i=1/Math.max(2*f.r/g,2*f.r/h);T(f,g/2,h/2,i);return e}var a=d3.layout.hierarchy().sort(L),b=[1,1];c.size=function(a){if(!arguments.length)return b;b=a;return c};return F(c,a)},d3.layout.cluster=function(){function d(d,e){var f=a.call(this,d,e),g=f[0],h,i=0,j,k;be(g,function(a){a.children?(a.x=W(a.children),a.y=V(a.children)):(a.x=h?i+=b(a,h):0,a.y=0,h=a)});var l=X(g),m=Y(g),n=l.x-b(l,m)/2,o=m.x+b(m,l)/2;be(g,function(a){a.x=(a.x-n)/(o-n)*c[0],a.y=(1-a.y/g.y)*c[1]});return f}var a=d3.layout.hierarchy().sort(null).value(null),b=Z,c=[1,1];d.separation=function(a){if(!arguments.length)return b;b=a;return d},d.size=function(a){if(!arguments.length)return c;c=a;return d};return F(d,a)},d3.layout.tree=function(){function d(d,e){function j(a,c,d){if(c){var e=a,f=a,g=c,h=a.parent.children[0],i=e._tree.mod,j=f._tree.mod,k=g._tree.mod,l=h._tree.mod,m;while(g=_(g),e=$(e),g&&e)h=$(h),f=_(f),f._tree.ancestor=a,m=g._tree.prelim+k-e._tree.prelim-i+b(g,e),m>0&&(bg(bh(g,a,d),a,m),i+=m,j+=m),k+=g._tree.mod,i+=e._tree.mod,l+=h._tree.mod,j+=f._tree.mod;g&&!_(f)&&(f._tree.thread=g,f._tree.mod+=k-j),e&&!$(h)&&(h._tree.thread=e,h._tree.mod+=i-l,d=a)}return d}function i(a,b){a.x=a._tree.prelim+b;var c=a.children;if(c){var d=-1,e=c.length;b+=a._tree.mod;while(++d<e)i(c[d],b)}}function h(a,c){var d=a.children,e=a._tree;if(d){var f=d.length,g=d[0],i,k=g,l,m=-1;while(++m<f)l=d[m],h(l,i),k=j(l,i,k),i=l;bf(a);var n=.5*(g._tree.prelim+l._tree.prelim);c?(e.prelim=c._tree.prelim+b(a,c),e.mod=e.prelim-n):e.prelim=n}else c&&(e.prelim=c._tree.prelim+b(a,c))}var f=a.call(this,d,e),g=f[0];be(g,function(a,b){a._tree={ancestor:a,prelim:0,mod:0,change:0,shift:0,number:b?b._tree.number+1:0}}),h(g),i(g,-g._tree.prelim);var k=ba(g,bc),l=ba(g,bb),m=ba(g,bd),n=k.x-b(k,l)/2,o=l.x+b(l,k)/2,p=m.depth||1;be(g,function(a){a.x=(a.x-n)/(o-n)*c[0],a.y=a.depth/p*c[1],delete a._tree});return f}var a=d3.layout.hierarchy().sort(null).value(null),b=Z,c=[1,1];d.separation=function(a){if(!arguments.length)return b;b=a;return d},d.size=function(a){if(!arguments.length)return c;c=a;return d};return F(d,a)},d3.layout.treemap=function(){function n(b){var d=g||a(b),e=d[0];e.x=0,e.y=0,e.dx=c[0],e.dy=c[1],g&&a.revalue(e),i([e],e.dx*e.dy/e.value),(g?k:j)(e),f&&(g=d);return d}function m(a,c,d,e){var f=-1,g=a.length,h=d.x,i=d.y,j=c?b(a.area/c):0,k;if(c==d.dx){if(e||j>d.dy)j=d.dy;while(++f<g)k=a[f],k.x=h,k.y=i,k.dy=j,h+=k.dx=j?b(k.area/j):0;k.z=!0,k.dx+=d.x+d.dx-h,d.y+=j,d.dy-=j}else{if(e||j>d.dx)j=d.dx;while(++f<g)k=a[f],k.x=h,k.y=i,k.dx=j,i+=k.dy=j?b(k.area/j):0;k.z=!1,k.dy+=d.y+d.dy-i,d.x+=j,d.dx-=j}}function l(a,b){var c=a.area,d,e=0,f=Infinity,g=-1,i=a.length;while(++g<i){if(!(d=a[g].area))continue;d<f&&(f=d),d>e&&(e=d)}c*=c,b*=b;return c?Math.max(b*e*h/c,c/(b*f*h)):Infinity}function k(a){if(!!a.children){var b=e(a),c=a.children.slice(),d,f=[];i(c,b.dx*b.dy/a.value),f.area=0;while(d=c.pop())f.push(d),f.area+=d.area,d.z!=null&&(m(f,d.z?b.dx:b.dy,b,!c.length),f.length=f.area=0);a.children.forEach(k)}}function j(a){if(!!a.children){var b=e(a),c=[],d=a.children.slice(),f,g=Infinity,h,k=Math.min(b.dx,b.dy),n;i(d,b.dx*b.dy/a.value),c.area=0;while((n=d.length)>0)c.push(f=d[n-1]),c.area+=f.area,(h=l(c,k))<=g?(d.pop(),g=h):(c.area-=c.pop().area,m(c,k,b,!1),k=Math.min(b.dx,b.dy),c.length=c.area=0,g=Infinity);c.length&&(m(c,k,b,!0),c.length=c.area=0),a.children.forEach(j)}}function i(a,b){var c=-1,d=a.length,e,f;while(++c<d)f=(e=a[c]).value*(b<0?0:b),e.area=isNaN(f)||f<=0?0:f}var a=d3.layout.hierarchy(),b=Math.round,c=[1,1],d=null,e=bi,f=!1,g,h=.5*(1+Math.sqrt(5));n.size=function(a){if(!arguments.length)return c;c=a;return n},n.padding=function(a){function c(b){return bj(b,a)}function b(b){var c=a.call(n,b,b.depth);return c==null?bi(b):bj(b,typeof c=="number"?[c,c,c,c]:c)}if(!arguments.length)return d;var f;e=(d=a)==null?bi:(f=typeof a)==="function"?b:f==="number"?(a=[a,a,a,a],c):c;return n},n.round=function(a){if(!arguments.length)return b!=Number;b=a?Math.round:Number;return n},n.sticky=function(a){if(!arguments.length)return f;f=a,g=null;return n},n.ratio=function(a){if(!arguments.length)return h;h=a;return n};return F(n,a)}})()
\ No newline at end of file
+(function(){function ba(a,b){var c=a.x+b[3],d=a.y+b[0],e=a.dx-b[1]-b[3],f=a.dy-b[0]-b[2];e<0&&(c+=e/2,e=0),f<0&&(d+=f/2,f=0);return{x:c,y:d,dx:e,dy:f}}function _(a){return{x:a.x,y:a.y,dx:a.dx,dy:a.dy}}function $(a,b,c){return a._tree.ancestor.parent==b.parent?a._tree.ancestor:c}function Z(a,b,c){a=a._tree,b=b._tree;var d=c/(b.number-a.number);a.change+=d,b.change-=d,b.shift+=c,b.prelim+=c,b.mod+=c}function Y(a){var b=0,c=0,d=a.children,e=d.length,f;while(--e>=0)f=d[e]._tree,f.prelim+=b,f.mod+=b,b+=f.shift+(c+=f.change)}function X(a,b){function c(a,d){var e=a.children;if(e){var f,g=null,h=-1,i=e.length;while(++h<i)f=e[h],c(f,g),g=f}b(a,d)}c(a,null)}function W(a,b){return a.depth-b.depth}function V(a,b){return b.x-a.x}function U(a,b){return a.x-b.x}function T(a,b){var c=a.children;if(c){var d,e=c.length,f=-1;while(++f<e)b(d=T(c[f],b),a)>0&&(a=d)}return a}function S(a){return a.children?a.children[a.children.length-1]:a._tree.thread}function R(a){return a.children?a.children[0]:a._tree.thread}function Q(a,b){return a.parent==b.parent?1:2}function P(a){var b=a.children;return b?P(b[b.length-1]):a}function O(a){var b=a.children;return b?O(b[0]):a}function N(a){return a.reduce(function(a,b){return a+b.x},0)/a.length}function M(a){return 1+d3.max(a,function(a){return a.y})}function L(a,b,c){var d=b.r+c.r,e=a.r+c.r,f=b.x-a.x,g=b.y-a.y,h=Math.sqrt(f*f+g*g),i=(e*e+h*h-d*d)/(2*e*h),j=Math.acos(i),k=i*e,l=Math.sin(j)*e;f/=h,g/=h,c.x=a.x+k*f+l*g,c.y=a.y+k*g-l*f}function K(a,b,c,d){var e=a.children;a.x=b+=d*a.x,a.y=c+=d*a.y,a.r*=d;if(e){var f=-1,g=e.length;while(++f<g)K(e[f],b,c,d)}}function J(a){var b=a.children;b?(b.forEach(J),a.r=G(b)):a.r=Math.sqrt(a.value)}function I(a){delete a._pack_next,delete a._pack_prev}function H(a){a._pack_next=a._pack_prev=a}function G(a){function l(a){b=Math.min(a.x-a.r,b),c=Math.max(a.x+a.r,c),d=Math.min(a.y-a.r,d),e=Math.max(a.y+a.r,e)}var b=Infinity,c=-Infinity,d=Infinity,e=-Infinity,f=a.length,g,h,i,j,k;a.forEach(H),g=a[0],g.x=-g.r,g.y=0,l(g);if(f>1){h=a[1],h.x=h.r,h.y=0,l(h);if(f>2){i=a[2],L(g,h,i),l(i),D(g,i),g._pack_prev=i,D(i,h),h=g._pack_next;for(var m=3;m<f;m++){L(g,h,i=a[m]);var n=0,o=1,p=1;for(j=h._pack_next;j!==h;j=j._pack_next,o++)if(F(j,i)){n=1;break}if(n==1)for(k=g._pack_prev;k!==j._pack_prev;k=k._pack_prev,p++)if(F(k,i)){p<o&&(n=-1,j=k);break}n==0?(D(g,i),h=i,l(i)):n>0?(E(g,j),h=j,m--):(E(j,h),g=j,m--)}}}var q=(b+c)/2,r=(d+e)/2,s=0;for(var m=0;m<f;m++){var t=a[m];t.x-=q,t.y-=r,s=Math.max(s,t.r+Math.sqrt(t.x*t.x+t.y*t.y))}a.forEach(I);return s}function F(a,b){var c=b.x-a.x,d=b.y-a.y,e=a.r+b.r;return e*e-c*c-d*d>.001}function E(a,b){a._pack_next=b,b._pack_prev=a}function D(a,b){var c=a._pack_next;a._pack_next=b,b._pack_prev=a,b._pack_next=c,c._pack_prev=b}function C(a,b){return a.value-b.value}function A(a){return d3.merge(a.map(function(a){return(a.children||[]).map(function(b){return{source:a,target:b}})}))}function z(a,b){return b.value-a.value}function y(a){return a.value}function x(a){return a.children}function w(a,b){a.sort=d3.rebind(a,b.sort),a.children=d3.rebind(a,b.children),a.links=A,a.value=d3.rebind(a,b.value),a.nodes=function(b){B=!0;return(a.nodes=a)(b)};return a}function v(a){return[d3.min(a),d3.max(a)]}function u(a,b){var c=-1,d=+a[0],e=(a[1]-d)/b,f=[];while(++c<=b)f[c]=e*c+d;return f}function t(a,b){return u(a,Math.ceil(Math.log(b.length)/Math.LN2+1))}function s(a,b){return a+b[1]}function r(a){return a.reduce(s,0)}function q(a){var b=1,c=0,d=a[0][1],e,f=a.length;for(;b<f;++b)(e=a[b][1])>d&&(c=b,d=e);return c}function n(a,b,c){a.y0=b,a.y=c}function m(a){return a.y}function l(a){return a.x}function k(a){return 1}function j(a){return 20}function i(a){var b=0,c=0;a.count=0;if(!a.leaf){var d=a.nodes,e=d.length,f=-1,g;while(++f<e){g=d[f];if(g==null)continue;i(g),a.count+=g.count,b+=g.count*g.cx,c+=g.count*g.cy}}a.point&&(a.leaf||(a.point.x+=Math.random()-.5,a.point.y+=Math.random()-.5),a.count++,b+=a.point.x,c+=a.point.y),a.cx=b/a.count,a.cy=c/a.count}function h(){var a=d3.event.position;f.px=a[0],f.py=a[1],e.resume()}function g(a){f.fixed=!1,e=f=null}function c(a,c){if(a===c)return a;var d=b(a),e=b(c),f=d.pop(),g=e.pop(),h=null;while(f===g)h=f,f=d.pop(),g=e.pop();return h}function b(a){var b=[],c=a.parent;while(c!=null)b.push(a),a=c,c=c.parent;b.push(a);return b}function a(a){var b=a.source,d=a.target,e=c(b,d),f=[b];while(b!==e)b=b.parent,f.push(b);var g=f.length;while(d!==e)f.splice(g,0,d),d=d.parent;return f}d3.layout={},d3.layout.bundle=function(){return function(b){var c=[],d=-1,e=b.length;while(++d<e)c.push(a(b[d]));return c}},d3.layout.chord=function(){function k(){b.sort(function(a,b){return i(a.target.value,b.target.value)})}function j(){var a={},j=[],l=d3.range(e),m=[],n,o,p,q,r;b=[],c=[],n=0,q=-1;while(++q<e){o=0,r=-1;while(++r<e)o+=d[q][r];j.push(o),m.push(d3.range(e)),n+=o}g&&l.sort(function(a,b){return g(j[a],j[b])}),h&&m.forEach(function(a,b){a.sort(function(a,c){return h(d[b][a],d[b][c])})}),n=(2*Math.PI-f*e)/n,o=0,q=-1;while(++q<e){p=o,r=-1;while(++r<e){var s=l[q],t=m[q][r],u=d[s][t];a[s+"-"+t]={index:s,subindex:t,startAngle:o,endAngle:o+=u*n,value:u}}c.push({index:s,startAngle:p,endAngle:o,value:(o-p)/n}),o+=f}q=-1;while(++q<e){r=q-1;while(++r<e){var v=a[q+"-"+r],w=a[r+"-"+q];(v.value||w.value)&&b.push(v.value<w.value?{source:w,target:v}:{source:v,target:w})}}i&&k()}var a={},b,c,d,e,f=0,g,h,i;a.matrix=function(f){if(!arguments.length)return d;e=(d=f)&&d.length,b=c=null;return a},a.padding=function(d){if(!arguments.length)return f;f=d,b=c=null;return a},a.sortGroups=function(d){if(!arguments.length)return g;g=d,b=c=null;return a},a.sortSubgroups=function(c){if(!arguments.length)return h;h=c,b=null;return a},a.sortChords=function(c){if(!arguments.length)return i;i=c,b&&k();return a},a.chords=function(){b||j();return b},a.groups=function(){c||j();return c};return a},d3.layout.force=function(){function y(b){(f=b).fixed=!0,e=a}function x(){var a=s.length,e=t.length,f=d3.geom.quadtree(s),g,h,j,k,m,n,q;for(g=0;g<e;++g){h=t[g],j=h.source,k=h.target,n=k.x-j.x,q=k.y-j.y;if(m=n*n+q*q)m=d*v[g]*((m=Math.sqrt(m))-u[g])/m,n*=m,q*=m,k.x-=n,k.y-=q,j.x+=n,j.y+=q}var r=d*p;n=c[0]/2,q=c[1]/2,g=-1;while(++g<a)h=s[g],h.x+=(n-h.x)*r,h.y+=(q-h.y)*r;i(f);var x=d*o;g=-1;while(++g<a)f.visit(w(s[g],x));g=-1;while(++g<a)h=s[g],h.fixed?(h.x=h.px,h.y=h.py):(h.x-=(h.px-(h.px=h.x))*l,h.y-=(h.py-(h.py=h.y))*l);b.tick.dispatch({type:"tick",alpha:d});return(d*=.99)<.005}function w(a,b){return function(c,d,e,f,g){if(c.point!==a){var h=c.cx-a.x,i=c.cy-a.y,j=1/Math.sqrt(h*h+i*i);if((f-d)*j<q){var k=b*c.count*j*j;a.x+=h*k,a.y+=i*k;return!0}if(c.point&&isFinite(j)){var k=b*j*j;a.x+=h*k,a.y+=i*k}}}}var a={},b=d3.dispatch("tick"),c=[1,1],d,l=.9,m=j,n=k,o=-30,p=.1,q=.8,r,s=[],t=[],u,v;a.on=function(c,d){b[c].add(d);return a},a.nodes=function(b){if(!arguments.length)return s;s=b;return a},a.links=function(b){if(!arguments.length)return t;t=b;return a},a.size=function(b){if(!arguments.length)return c;c=b;return a},a.linkDistance=function(b){if(!arguments.length)return m;m=d3.functor(b);return a},a.distance=a.linkDistance,a.linkStrength=function(b){if(!arguments.length)return n;n=d3.functor(b);return a},a.friction=function(b){if(!arguments.length)return l;l=b;return a},a.charge=function(b){if(!arguments.length)return o;o=b;return a},a.gravity=function(b){if(!arguments.length)return p;p=b;return a},a.theta=function(b){if(!arguments.length)return q;q=b;return a},a.start=function(){function l(){if(!i){i=[];for(d=0;d<e;++d)i[d]=[];for(d=0;d<f;++d){var a=t[d];i[a.source.index].push(a.target),i[a.target.index].push(a.source)}}return i[b]}function k(a,c){var d=l(b),e=-1,f=d.length,g;while(++e<f)if(!isNaN(g=d[e][a]))return g;return Math.random()*c}var b,d,e=s.length,f=t.length,g=c[0],h=c[1],i,j;for(b=0;b<e;++b)(j=s[b]).index=b;u=[],v=[];for(b=0;b<f;++b)j=t[b],typeof j.source=="number"&&(j.source=s[j.source]),typeof j.target=="number"&&(j.target=s[j.target]),u[b]=m.call(this,j,b),v[b]=n.call(this,j,b);for(b=0;b<e;++b)j=s[b],isNaN(j.x)&&(j.x=k("x",g)),isNaN(j.y)&&(j.y=k("y",h)),isNaN(j.px)&&(j.px=j.x),isNaN(j.py)&&(j.py=j.y);return a.resume()},a.resume=function(){d=.1,d3.timer(x);return a},a.stop=function(){d=0;return a},a.drag=function(){this.call(d3.behavior.drag().on("dragstart",y).on("drag",h).on("dragend",g));return a};return a};var e,f;d3.layout.partition=function(){function e(e,f){var g=a.call(this,e,f);c(g[0],0,b[0],b[1]/d(g[0]));return g}function d(a){var b=a.children,c=0;if(b){var e=-1,f=b.length;while(++e<f)c=Math.max(c,d(b[e]))}return 1+c}function c(a,b,d,e){var f=a.children;a.x=b,a.y=a.depth*e,a.dx=d,a.dy=e;if(f){var g=-1,h=f.length,i,j;d=a.value?d/a.value:0;while(++g<h)c(i=f[g],b,j=i.value*d,e),b+=j}}var a=d3.layout.hierarchy(),b=[1,1];e.size=function(a){if(!arguments.length)return b;b=a;return e};return w(e,a)},d3.layout.pie=function(){function f(f,g){var h=+(typeof c=="function"?c.apply(this,arguments):c),i=(typeof e=="function"?e.apply(this,arguments):e)-c,j=d3.range(f.length);b!=null&&j.sort(function(a,c){return b(f[a],f[c])});var k=f.map(a);i/=k.reduce(function(a,b){return a+b},0);var l=j.map(function(a){return{data:f[a],value:d=k[a],startAngle:h,endAngle:h+=d*i}});return f.map(function(a,b){return l[j[b]]})}var a=Number,b=null,c=0,e=2*Math.PI;f.value=function(b){if(!arguments.length)return a;a=b;return f},f.sort=function(a){if(!arguments.length)return b;b=a;return f},f.startAngle=function(a){if(!arguments.length)return c;c=a;return f},f.endAngle=function(a){if(!arguments.length)return e;e=a;return f};return f},d3.layout.stack=function(){function g(h,i){var j=h.map(function(b,c){return a.call(g,b,c)}),k=j.map(function(a,b){return a.map(function(a,b){return[e.call(g,a,b),f.call(g,a,b)]})}),l=b.call(g,k,i);j=d3.permute(j,l),k=d3.permute(k,l);var m=c.call(g,k,i),n=j.length,o=j[0].length,p,q,r;for(q=0;q<o;++q){d.call(g,j[0][q],r=m[q],k[0][q][1]);for(p=1;p<n;++p)d.call(g,j[p][q],r+=k[p-1][q][1],k[p][q][1])}return h}var a=Object,b=o["default"],c=p.zero,d=n,e=l,f=m;g.values=function(b){if(!arguments.length)return a;a=b;return g},g.order=function(a){if(!arguments.length)return b;b=typeof a=="function"?a:o[a];return g},g.offset=function(a){if(!arguments.length)return c;c=typeof a=="function"?a:p[a];return g},g.x=function(a){if(!arguments.length)return e;e=a;return g},g.y=function(a){if(!arguments.length)return f;f=a;return g},g.out=function(a){if(!arguments.length)return d;d=a;return g};return g};var o={"inside-out":function(a){var b=a.length,c,d,e=a.map(q),f=a.map(r),g=d3.range(b).sort(function(a,b){return e[a]-e[b]}),h=0,i=0,j=[],k=[];for(c=0;c<b;++c)d=g[c],h<i?(h+=f[d],j.push(d)):(i+=f[d],k.push(d));return k.reverse().concat(j)},reverse:function(a){return d3.range(a.length).reverse()},"default":function(a){return d3.range(a.length)}},p={silhouette:function(a){var b=a.length,c=a[0].length,d=[],e=0,f,g,h,i=[];for(g=0;g<c;++g){for(f=0,h=0;f<b;f++)h+=a[f][g][1];h>e&&(e=h),d.push(h)}for(g=0;g<c;++g)i[g]=(e-d[g])/2;return i},wiggle:function(a){var b=a.length,c=a[0],d=c.length,e=0,f,g,h,i,j,k,l,m,n,o=[];o[0]=m=n=0;for(g=1;g<d;++g){for(f=0,i=0;f<b;++f)i+=a[f][g][1];for(f=0,j=0,l=c[g][0]-c[g-1][0];f<b;++f){for(h=0,k=(a[f][g][1]-a[f][g-1][1])/(2*l);h<f;++h)k+=(a[h][g][1]-a[h][g-1][1])/l;j+=k*a[f][g][1]}o[g]=m-=i?j/i*l:0,m<n&&(n=m)}for(g=0;g<d;++g)o[g]-=n;return o},expand:function(a){var b=a.length,c=a[0].length,d=1/b,e,f,g,h=[];for(f=0;f<c;++f){for(e=0,g=0;e<b;e++)g+=a[e][f][1];if(g)for(e=0;e<b;e++)a[e][f][1]/=g;else for(e=0;e<b;e++)a[e][f][1]=d}for(f=0;f<c;++f)h[f]=0;return h},zero:function(a){var b=-1,c=a[0].length,d=[];while(++b<c)d[b]=0;return d}};d3.layout.histogram=function(){function e(e,f){var g=[],h=e.map(b,this),i=c.call(this,h,f),j=d.call(this,i,h,f),k,f=-1,l=h.length,m=j.length-1,n=a?1:1/l,o;while(++f<m)k=g[f]=[],k.dx=j[f+1]-(k.x=j[f]),k.y=0;f=-1;while(++f<l)o=h[f],o>=i[0]&&o<=i[1]&&(k=g[d3.bisect(j,o,1,m)-1],k.y+=n,k.push(e[f]));return g}var a=!0,b=Number,c=v,d=t;e.value=function(a){if(!arguments.length)return b;b=a;return e},e.range=function(a){if(!arguments.length)return c;c=d3.functor(a);return e},e.bins=function(a){if(!arguments.length)return d;d=typeof a=="number"?function(b){return u(b,a)}:d3.functor(a);return e},e.frequency=function(b){if(!arguments.length)return a;a=!!b;return e};return e},d3.layout.hierarchy=function(){function g(a){var b=[];e(a,0,b);return b}function f(a,b){var d=a.children,e=0;if(d){var h=-1,i=d.length,j=b+1;while(++h<i)e+=f(d[h],j)}else c&&(e=+c.call(g,B?a:a.data,b)||0);c&&(a.value=e);return e}function e(f,h,i){var j=b.call(g,f,h),k=B?f:{data:f};k.depth=h,i.push(k);if(j){var l=-1,m=j.length,n=k.children=[],o=0,p=h+1;while(++l<m)d=e(j[l],p,i),d.parent=k,n.push(d),o+=d.value;a&&n.sort(a),c&&(k.value=o)}else c&&(k.value=+c.call(g,f,h)||0);return k}var a=z,b=x,c=y;g.sort=function(b){if(!arguments.length)return a;a=b;return g},g.children=function(a){if(!arguments.length)return b;b=a;return g},g.value=function(a){if(!arguments.length)return c;c=a;return g},g.revalue=function(a){f(a,0);return a};return g};var B=!1;d3.layout.pack=function(){function c(c,d){var e=a.call(this,c,d),f=e[0];f.x=0,f.y=0,J(f);var g=b[0],h=b[1],i=1/Math.max(2*f.r/g,2*f.r/h);K(f,g/2,h/2,i);return e}var a=d3.layout.hierarchy().sort(C),b=[1,1];c.size=function(a){if(!arguments.length)return b;b=a;return c};return w(c,a)},d3.layout.cluster=function(){function d(d,e){var f=a.call(this,d,e),g=f[0],h,i=0,j,k;X(g,function(a){a.children?(a.x=N(a.children),a.y=M(a.children)):(a.x=h?i+=b(a,h):0,a.y=0,h=a)});var l=O(g),m=P(g),n=l.x-b(l,m)/2,o=m.x+b(m,l)/2;X(g,function(a){a.x=(a.x-n)/(o-n)*c[0],a.y=(1-a.y/g.y)*c[1]});return f}var a=d3.layout.hierarchy().sort(null).value(null),b=Q,c=[1,1];d.separation=function(a){if(!arguments.length)return b;b=a;return d},d.size=function(a){if(!arguments.length)return c;c=a;return d};return w(d,a)},d3.layout.tree=function(){function d(d,e){function j(a,c,d){if(c){var e=a,f=a,g=c,h=a.parent.children[0],i=e._tree.mod,j=f._tree.mod,k=g._tree.mod,l=h._tree.mod,m;while(g=S(g),e=R(e),g&&e)h=R(h),f=S(f),f._tree.ancestor=a,m=g._tree.prelim+k-e._tree.prelim-i+b(g,e),m>0&&(Z($(g,a,d),a,m),i+=m,j+=m),k+=g._tree.mod,i+=e._tree.mod,l+=h._tree.mod,j+=f._tree.mod;g&&!S(f)&&(f._tree.thread=g,f._tree.mod+=k-j),e&&!R(h)&&(h._tree.thread=e,h._tree.mod+=i-l,d=a)}return d}function i(a,b){a.x=a._tree.prelim+b;var c=a.children;if(c){var d=-1,e=c.length;b+=a._tree.mod;while(++d<e)i(c[d],b)}}function h(a,c){var d=a.children,e=a._tree;if(d){var f=d.length,g=d[0],i,k=g,l,m=-1;while(++m<f)l=d[m],h(l,i),k=j(l,i,k),i=l;Y(a);var n=.5*(g._tree.prelim+l._tree.prelim);c?(e.prelim=c._tree.prelim+b(a,c),e.mod=e.prelim-n):e.prelim=n}else c&&(e.prelim=c._tree.prelim+b(a,c))}var f=a.call(this,d,e),g=f[0];X(g,function(a,b){a._tree={ancestor:a,prelim:0,mod:0,change:0,shift:0,number:b?b._tree.number+1:0}}),h(g),i(g,-g._tree.prelim);var k=T(g,V),l=T(g,U),m=T(g,W),n=k.x-b(k,l)/2,o=l.x+b(l,k)/2,p=m.depth||1;X(g,function(a){a.x=(a.x-n)/(o-n)*c[0],a.y=a.depth/p*c[1],delete a._tree});return f}var a=d3.layout.hierarchy().sort(null).value(null),b=Q,c=[1,1];d.separation=function(a){if(!arguments.length)return b;b=a;return d},d.size=function(a){if(!arguments.length)return c;c=a;return d};return w(d,a)},d3.layout.treemap=function(){function n(b){var d=g||a(b),e=d[0];e.x=0,e.y=0,e.dx=c[0],e.dy=c[1],g&&a.revalue(e),i([e],e.dx*e.dy/e.value),(g?k:j)(e),f&&(g=d);return d}function m(a,c,d,e){var f=-1,g=a.length,h=d.x,i=d.y,j=c?b(a.area/c):0,k;if(c==d.dx){if(e||j>d.dy)j=d.dy;while(++f<g)k=a[f],k.x=h,k.y=i,k.dy=j,h+=k.dx=j?b(k.area/j):0;k.z=!0,k.dx+=d.x+d.dx-h,d.y+=j,d.dy-=j}else{if(e||j>d.dx)j=d.dx;while(++f<g)k=a[f],k.x=h,k.y=i,k.dx=j,i+=k.dy=j?b(k.area/j):0;k.z=!1,k.dy+=d.y+d.dy-i,d.x+=j,d.dx-=j}}function l(a,b){var c=a.area,d,e=0,f=Infinity,g=-1,i=a.length;while(++g<i){if(!(d=a[g].area))continue;d<f&&(f=d),d>e&&(e=d)}c*=c,b*=b;return c?Math.max(b*e*h/c,c/(b*f*h)):Infinity}function k(a){if(!!a.children){var b=e(a),c=a.children.slice(),d,f=[];i(c,b.dx*b.dy/a.value),f.area=0;while(d=c.pop())f.push(d),f.area+=d.area,d.z!=null&&(m(f,d.z?b.dx:b.dy,b,!c.length),f.length=f.area=0);a.children.forEach(k)}}function j(a){if(!!a.children){var b=e(a),c=[],d=a.children.slice(),f,g=Infinity,h,k=Math.min(b.dx,b.dy),n;i(d,b.dx*b.dy/a.value),c.area=0;while((n=d.length)>0)c.push(f=d[n-1]),c.area+=f.area,(h=l(c,k))<=g?(d.pop(),g=h):(c.area-=c.pop().area,m(c,k,b,!1),k=Math.min(b.dx,b.dy),c.length=c.area=0,g=Infinity);c.length&&(m(c,k,b,!0),c.length=c.area=0),a.children.forEach(j)}}function i(a,b){var c=-1,d=a.length,e,f;while(++c<d)f=(e=a[c]).value*(b<0?0:b),e.area=isNaN(f)||f<=0?0:f}var a=d3.layout.hierarchy(),b=Math.round,c=[1,1],d=null,e=_,f=!1,g,h=.5*(1+Math.sqrt(5));n.size=function(a){if(!arguments.length)return c;c=a;return n},n.padding=function(a){function c(b){return ba(b,a)}function b(b){var c=a.call(n,b,b.depth);return c==null?_(b):ba(b,typeof c=="number"?[c,c,c,c]:c)}if(!arguments.length)return d;var f;e=(d=a)==null?_:(f=typeof a)==="function"?b:f==="number"?(a=[a,a,a,a],c):c;return n},n.round=function(a){if(!arguments.length)return b!=Number;b=a?Math.round:Number;return n},n.sticky=function(a){if(!arguments.length)return f;f=a,g=null;return n},n.ratio=function(a){if(!arguments.length)return h;h=a;return n};return w(n,a)}})()
\ No newline at end of file
diff --git a/examples/force/force-bounds.html b/examples/force/force-bounds.html
index 711d3047..8e8a9a70 100644
--- a/examples/force/force-bounds.html
+++ b/examples/force/force-bounds.html
@@ -2,9 +2,10 @@
 <html>
   <head>
     <title>Force-Directed Layout</title>
-    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.js?1.29.1"></script>
-    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.geom.js?1.29.1"></script>
-    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.layout.js?1.29.1"></script>
+    <script type="text/javascript" src="../../d3.js"></script>
+    <script type="text/javascript" src="../../d3.behavior.js"></script>
+    <script type="text/javascript" src="../../d3.geom.js"></script>
+    <script type="text/javascript" src="../../d3.layout.js"></script>
     <style type="text/css">
 
 circle {
diff --git a/examples/force/force-cluster.html b/examples/force/force-cluster.html
index c27464c5..043fd5d6 100644
--- a/examples/force/force-cluster.html
+++ b/examples/force/force-cluster.html
@@ -3,6 +3,7 @@
   <head>
     <title>Clustered Network</title>
     <script type="text/javascript" src="../../d3.js"></script>
+    <script type="text/javascript" src="../../d3.behavior.js"></script>
     <script type="text/javascript" src="../../d3.geom.js"></script>
     <script type="text/javascript" src="../../d3.layout.js"></script>
     <style type="text/css">
diff --git a/examples/force/force-dynamic.html b/examples/force/force-dynamic.html
index 9cbcba9d..373e2db3 100644
--- a/examples/force/force-dynamic.html
+++ b/examples/force/force-dynamic.html
@@ -3,6 +3,7 @@
   <head>
     <title>Force-Directed Layout (Dynamic)</title>
     <script type="text/javascript" src="../../d3.js"></script>
+    <script type="text/javascript" src="../../d3.behavior.js"></script>
     <script type="text/javascript" src="../../d3.geom.js"></script>
     <script type="text/javascript" src="../../d3.layout.js"></script>
     <style type="text/css">
diff --git a/examples/force/force-interactive.html b/examples/force/force-interactive.html
index 9bd072ee..25b04986 100644
--- a/examples/force/force-interactive.html
+++ b/examples/force/force-interactive.html
@@ -4,6 +4,7 @@
     <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
     <title>Force-Directed Graph</title>
     <script type="text/javascript" src="../../d3.js"></script>
+    <script type="text/javascript" src="../../d3.behavior.js"></script>
     <script type="text/javascript" src="../../d3.geom.js"></script>
     <script type="text/javascript" src="../../d3.layout.js"></script>
     <style type="text/css">
diff --git a/examples/force/force-map.html b/examples/force/force-map.html
index 8b1f8a66..808d173a 100644
--- a/examples/force/force-map.html
+++ b/examples/force/force-map.html
@@ -3,6 +3,7 @@
   <head>
     <title>Force-Directed Map</title>
     <script type="text/javascript" src="../../d3.js"></script>
+    <script type="text/javascript" src="../../d3.behavior.js"></script>
     <script type="text/javascript" src="../../d3.geo.js"></script>
     <script type="text/javascript" src="../../d3.geom.js"></script>
     <script type="text/javascript" src="../../d3.layout.js"></script>
diff --git a/examples/force/force-multi-foci.html b/examples/force/force-multi-foci.html
index e1b9a3b9..14cf3e0b 100644
--- a/examples/force/force-multi-foci.html
+++ b/examples/force/force-multi-foci.html
@@ -3,6 +3,7 @@
   <head>
     <title>Force-Directed Layout (Multiple Foci)</title>
     <script type="text/javascript" src="../../d3.js"></script>
+    <script type="text/javascript" src="../../d3.behavior.js"></script>
     <script type="text/javascript" src="../../d3.geom.js"></script>
     <script type="text/javascript" src="../../d3.layout.js"></script>
   </head>
diff --git a/examples/force/force.html b/examples/force/force.html
index 4f6267a5..9369f51d 100644
--- a/examples/force/force.html
+++ b/examples/force/force.html
@@ -3,6 +3,7 @@
   <head>
     <title>Force-Directed Layout</title>
     <script type="text/javascript" src="../../d3.js"></script>
+    <script type="text/javascript" src="../../d3.behavior.js"></script>
     <script type="text/javascript" src="../../d3.geom.js"></script>
     <script type="text/javascript" src="../../d3.layout.js"></script>
     <link type="text/css" rel="stylesheet" href="force.css"/>
diff --git a/src/behavior/drag.js b/src/behavior/drag.js
new file mode 100644
index 00000000..e3a3846f
--- /dev/null
+++ b/src/behavior/drag.js
@@ -0,0 +1,115 @@
+d3.behavior.drag = function() {
+  var event = d3.dispatch("drag", "dragstart", "dragend");
+
+  function drag() {
+    this
+      .on("mousedown.drag", mousedown)
+      .on("touchstart.drag", mousedown);
+
+    d3.select(window)
+      .on("mousemove.drag", d3_behavior_dragMove)
+      .on("touchmove.drag", d3_behavior_dragMove)
+      .on("mouseup.drag", d3_behavior_dragUp, true)
+      .on("touchend.drag", d3_behavior_dragUp, true)
+      .on("click.drag", d3_behavior_dragClick, true);
+  }
+
+  // snapshot the local context for subsequent dispatch
+  function start() {
+    d3_behavior_dragEvent = event;
+    d3_behavior_dragTarget = this;
+    d3_behavior_dragMoved = false;
+    d3_behavior_dragArguments = arguments;
+  }
+
+  function mousedown() {
+    start.apply(this, arguments);
+    var parent = d3_behavior_dragParent();
+    if (!parent) return;
+    d3_behavior_dragTo(d3_behavior_dragPoint(parent), "dragstart");
+  }
+
+  drag.on = function(type, listener) {
+    event[type].add(listener);
+    return drag;
+  };
+
+  return drag;
+};
+
+var d3_behavior_dragEvent,
+    d3_behavior_dragTarget,
+    d3_behavior_dragMoved,
+    d3_behavior_dragStopClick;
+
+function d3_behavior_dragParent() {
+  var parent = d3_behavior_dragTarget.parentNode;
+
+  // O NOES! The drag element was removed from the DOM.
+  if (!parent) d3_behavior_dragUp();
+
+  return parent;
+}
+
+function d3_behavior_dragTo(point, type) {
+  var o = d3.event;
+  d3.event = {position: point};
+
+  try {
+    d3_behavior_dragEvent[type].dispatch.apply(d3_behavior_dragTarget, d3_behavior_dragArguments);
+  } finally {
+    d3.event = o;
+  }
+
+  o.preventDefault();
+}
+
+function d3_behavior_dragPoint(container) {
+  return d3.event.touches
+    ? d3.svg.touches(container)[0]
+    : d3.svg.mouse(container);
+}
+
+function d3_behavior_dragMove() {
+  if (!d3_behavior_dragTarget) return;
+  var parent = d3_behavior_dragParent();
+  if (!parent) return;
+
+  d3_behavior_dragTo(d3_behavior_dragPoint(parent), "drag");
+  d3_behavior_dragMoved = true;
+  d3_behavior_dragCancel();
+}
+
+function d3_behavior_dragUp() {
+  if (!d3_behavior_dragTarget) return;
+  var parent = d3_behavior_dragParent();
+  if (!parent) return;
+
+  // If the node was moved, prevent the mouseup from propagating.
+  // Also prevent the subsequent click from propagating (e.g., for anchors).
+  if (d3_behavior_dragMoved) {
+    d3_behavior_dragStopClick = true;
+    d3_behavior_dragCancel();
+
+    // Don't trigger this for touchend.
+    if (d3.event.type === "mouseup") {
+      d3_behavior_dragMove();
+    }
+  }
+  d3_behavior_dragTo(d3_behavior_dragPoint(parent), "dragend");
+
+  d3_behavior_dragForce =
+  d3_behavior_dragTarget = null;
+}
+
+function d3_behavior_dragClick() {
+  if (d3_behavior_dragStopClick) {
+    d3_behavior_dragCancel();
+    d3_behavior_dragStopClick = false;
+  }
+}
+
+function d3_behavior_dragCancel() {
+  d3.event.stopPropagation();
+  d3.event.preventDefault();
+}
diff --git a/src/layout/force.js b/src/layout/force.js
index 8b4d5913..11bd122c 100644
--- a/src/layout/force.js
+++ b/src/layout/force.js
@@ -243,110 +243,38 @@ d3.layout.force = function() {
 
   // use `node.call(force.drag)` to make nodes draggable
   force.drag = function() {
-
     this
-      .on("mouseover.force", d3_layout_forceDragOver)
-      .on("mouseout.force", d3_layout_forceDragOut)
-      .on("mousedown.force", dragdown)
-      .on("touchstart.force", dragdown);
-
-    d3.select(window)
-      .on("mousemove.force", d3_layout_forceDragMove)
-      .on("touchmove.force", d3_layout_forceDragMove)
-      .on("mouseup.force", d3_layout_forceDragUp, true)
-      .on("touchend.force", d3_layout_forceDragUp, true)
-      .on("click.force", d3_layout_forceDragClick, true);
+      .call(d3.behavior.drag()
+        .on("dragstart", dragstart)
+        .on("drag", d3_layout_forceDrag)
+        .on("dragend", d3_layout_forceDragEnd));
 
     return force;
   };
 
-  function dragdown(d, i) {
-    var m = d3_layout_forcePoint(this.parentNode);
+  function dragstart(d) {
     (d3_layout_forceDragNode = d).fixed = true;
-    d3_layout_forceDragMoved = false;
-    d3_layout_forceDragElement = this;
     d3_layout_forceDragForce = force;
-    d3_layout_forceDragOffset = [m[0] - d.x, m[1] - d.y];
-    d3_layout_forceCancel();
   }
 
   return force;
 };
 
 var d3_layout_forceDragForce,
-    d3_layout_forceDragNode,
-    d3_layout_forceDragMoved,
-    d3_layout_forceDragOffset,
-    d3_layout_forceStopClick,
-    d3_layout_forceDragElement;
-
-function d3_layout_forceDragOver(d) {
-  d.fixed = true;
-}
-
-function d3_layout_forceDragOut(d) {
-  if (d !== d3_layout_forceDragNode) {
-    d.fixed = false;
-  }
-}
-
-function d3_layout_forcePoint(container) {
-  return d3.event.touches
-      ? d3.svg.touches(container)[0]
-      : d3.svg.mouse(container);
-}
-
-function d3_layout_forceDragMove() {
-  if (!d3_layout_forceDragNode) return;
-  var parent = d3_layout_forceDragElement.parentNode;
-
-  // O NOES! The drag element was removed from the DOM.
-  if (!parent) {
-    d3_layout_forceDragNode.fixed = false;
-    d3_layout_forceDragOffset = d3_layout_forceDragNode = d3_layout_forceDragElement = null;
-    return;
-  }
-
-  var m = d3_layout_forcePoint(parent);
-  d3_layout_forceDragMoved = true;
-  d3_layout_forceDragNode.px = m[0] - d3_layout_forceDragOffset[0];
-  d3_layout_forceDragNode.py = m[1] - d3_layout_forceDragOffset[1];
-  d3_layout_forceCancel();
-  d3_layout_forceDragForce.resume(); // restart annealing
-}
-
-function d3_layout_forceDragUp() {
-  if (!d3_layout_forceDragNode) return;
-
-  // If the node was moved, prevent the mouseup from propagating.
-  // Also prevent the subsequent click from propagating (e.g., for anchors).
-  if (d3_layout_forceDragMoved) {
-    d3_layout_forceStopClick = true;
-    d3_layout_forceCancel();
-  }
-
-  // Don't trigger this for touchend.
-  if (d3.event.type === "mouseup") {
-    d3_layout_forceDragMove();
-  }
+    d3_layout_forceDragNode;
 
+function d3_layout_forceDragEnd(d) {
   d3_layout_forceDragNode.fixed = false;
   d3_layout_forceDragForce =
-  d3_layout_forceDragOffset =
-  d3_layout_forceDragNode =
-  d3_layout_forceDragElement = null;
+  d3_layout_forceDragNode = null;
 }
 
-function d3_layout_forceDragClick() {
-  if (d3_layout_forceStopClick) {
-    d3_layout_forceCancel();
-    d3_layout_forceStopClick = false;
-  }
-}
+function d3_layout_forceDrag() {
+  var m = d3.event.position;
 
-function d3_layout_forceCancel() {
-  d3.event.stopPropagation();
-  d3.event.preventDefault();
+  d3_layout_forceDragNode.px = m[0];
+  d3_layout_forceDragNode.py = m[1];
+  d3_layout_forceDragForce.resume(); // restart annealing
 }
 
 function d3_layout_forceAccumulate(quad) {
