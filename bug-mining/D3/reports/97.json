{"url":"https://api.github.com/repos/d3/d3/issues/997","repository_url":"https://api.github.com/repos/d3/d3","labels_url":"https://api.github.com/repos/d3/d3/issues/997/labels{/name}","comments_url":"https://api.github.com/repos/d3/d3/issues/997/comments","events_url":"https://api.github.com/repos/d3/d3/issues/997/events","html_url":"https://github.com/d3/d3/issues/997","id":9784678,"node_id":"MDU6SXNzdWU5Nzg0Njc4","number":997,"title":"Clarify behavior for selection.data in re. to duplicate keys.","user":{"login":"alexbbrown","id":2532344,"node_id":"MDQ6VXNlcjI1MzIzNDQ=","avatar_url":"https://avatars.githubusercontent.com/u/2532344?v=4","gravatar_id":"","url":"https://api.github.com/users/alexbbrown","html_url":"https://github.com/alexbbrown","followers_url":"https://api.github.com/users/alexbbrown/followers","following_url":"https://api.github.com/users/alexbbrown/following{/other_user}","gists_url":"https://api.github.com/users/alexbbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/alexbbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alexbbrown/subscriptions","organizations_url":"https://api.github.com/users/alexbbrown/orgs","repos_url":"https://api.github.com/users/alexbbrown/repos","events_url":"https://api.github.com/users/alexbbrown/events{/privacy}","received_events_url":"https://api.github.com/users/alexbbrown/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":50044,"node_id":"MDU6TGFiZWw1MDA0NA==","url":"https://api.github.com/repos/d3/d3/labels/bug","name":"bug","color":"d73a4a","default":true,"description":"Something isnâ€™t working"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":{"url":"https://api.github.com/repos/d3/d3/milestones/21","html_url":"https://github.com/d3/d3/milestone/21","labels_url":"https://api.github.com/repos/d3/d3/milestones/21/labels","id":238929,"node_id":"MDk6TWlsZXN0b25lMjM4OTI5","number":21,"title":"3.0.x","description":"","creator":{"login":"mbostock","id":230541,"node_id":"MDQ6VXNlcjIzMDU0MQ==","avatar_url":"https://avatars.githubusercontent.com/u/230541?v=4","gravatar_id":"","url":"https://api.github.com/users/mbostock","html_url":"https://github.com/mbostock","followers_url":"https://api.github.com/users/mbostock/followers","following_url":"https://api.github.com/users/mbostock/following{/other_user}","gists_url":"https://api.github.com/users/mbostock/gists{/gist_id}","starred_url":"https://api.github.com/users/mbostock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mbostock/subscriptions","organizations_url":"https://api.github.com/users/mbostock/orgs","repos_url":"https://api.github.com/users/mbostock/repos","events_url":"https://api.github.com/users/mbostock/events{/privacy}","received_events_url":"https://api.github.com/users/mbostock/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":26,"state":"closed","created_at":"2013-01-05T02:56:42Z","updated_at":"2013-03-21T04:40:26Z","due_on":null,"closed_at":"2013-03-21T04:40:26Z"},"comments":3,"created_at":"2013-01-08T21:53:21Z","updated_at":"2013-01-08T23:34:24Z","closed_at":"2013-01-08T23:22:30Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"In the function d3_selectionPrototype_data, in the bind function\n\nIn data with a key argument, exitNodes are added at two stages:\n\n1) culling duplicates\nfor (i = -1; ++i < n; ) {\n          keyValue = key.call(node = group[i], node.**data**, i);\n          if (nodeByKeyValue.has(keyValue)) {\n            exitNodes[j++] = node;\n          } else {\n            nodeByKeyValue.set(keyValue, node);\n          }\n          keyValues.push(keyValue);\n        }\n\n2) Cleaning up remaining values in nodeByKeyValue\n        for (i = -1; ++i < n; ) {\n          if (nodeByKeyValue.has(keyValues[i])) {\n            exitNodes[i] = group[i];\n          }\n        }\n\nNote that exitNodes in the second pass is indexed by i, but in the first pass by j.\n\nJ starts at groupData.length, in other words the first pass exits are shuffled into slots after the maximum number of nodes that can validly be in the list.\n\nI starts at zero and extends all the way up to group.length, in other words the number of nodes we started with.\n\nThis leave the possibility of a node with an unwanted key being in the range groupData.length to group.length.  In this case a node stored in pass 2 will overwrite a node stored in pass 1 in the exitNodes list, which means the pass 1 node escapes the exit list and is neither removed nor updated - and remains in the DOM.\n\nFix: in pass 2, use j++ to index the exitNodes array (not tested, i will do that next).\n","closed_by":{"login":"mbostock","id":230541,"node_id":"MDQ6VXNlcjIzMDU0MQ==","avatar_url":"https://avatars.githubusercontent.com/u/230541?v=4","gravatar_id":"","url":"https://api.github.com/users/mbostock","html_url":"https://github.com/mbostock","followers_url":"https://api.github.com/users/mbostock/followers","following_url":"https://api.github.com/users/mbostock/following{/other_user}","gists_url":"https://api.github.com/users/mbostock/gists{/gist_id}","starred_url":"https://api.github.com/users/mbostock/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mbostock/subscriptions","organizations_url":"https://api.github.com/users/mbostock/orgs","repos_url":"https://api.github.com/users/mbostock/repos","events_url":"https://api.github.com/users/mbostock/events{/privacy}","received_events_url":"https://api.github.com/users/mbostock/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/d3/d3/issues/997/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/d3/d3/issues/997/timeline","performed_via_github_app":null,"state_reason":"completed"}