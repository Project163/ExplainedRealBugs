{"url":"https://api.github.com/repos/grpc/grpc/issues/39520","repository_url":"https://api.github.com/repos/grpc/grpc","labels_url":"https://api.github.com/repos/grpc/grpc/issues/39520/labels{/name}","comments_url":"https://api.github.com/repos/grpc/grpc/issues/39520/comments","events_url":"https://api.github.com/repos/grpc/grpc/issues/39520/events","html_url":"https://github.com/grpc/grpc/issues/39520","id":3049255080,"node_id":"I_kwDOAacf2M61v_Co","number":39520,"title":"[Python] `PythonFinalizationError: cannot join thread at interpreter shutdown` when using Python 3.14 with workaround","user":{"login":"parthea","id":5184014,"node_id":"MDQ6VXNlcjUxODQwMTQ=","avatar_url":"https://avatars.githubusercontent.com/u/5184014?v=4","gravatar_id":"","url":"https://api.github.com/users/parthea","html_url":"https://github.com/parthea","followers_url":"https://api.github.com/users/parthea/followers","following_url":"https://api.github.com/users/parthea/following{/other_user}","gists_url":"https://api.github.com/users/parthea/gists{/gist_id}","starred_url":"https://api.github.com/users/parthea/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/parthea/subscriptions","organizations_url":"https://api.github.com/users/parthea/orgs","repos_url":"https://api.github.com/users/parthea/repos","events_url":"https://api.github.com/users/parthea/events{/privacy}","received_events_url":"https://api.github.com/users/parthea/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":155504842,"node_id":"MDU6TGFiZWwxNTU1MDQ4NDI=","url":"https://api.github.com/repos/grpc/grpc/labels/kind/bug","name":"kind/bug","color":"93732c","default":false,"description":null},{"id":168238186,"node_id":"MDU6TGFiZWwxNjgyMzgxODY=","url":"https://api.github.com/repos/grpc/grpc/labels/lang/Python","name":"lang/Python","color":"fad8c7","default":false,"description":null},{"id":360790193,"node_id":"MDU6TGFiZWwzNjA3OTAxOTM=","url":"https://api.github.com/repos/grpc/grpc/labels/priority/P2","name":"priority/P2","color":"dd7172","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"sergiitk","id":672669,"node_id":"MDQ6VXNlcjY3MjY2OQ==","avatar_url":"https://avatars.githubusercontent.com/u/672669?v=4","gravatar_id":"","url":"https://api.github.com/users/sergiitk","html_url":"https://github.com/sergiitk","followers_url":"https://api.github.com/users/sergiitk/followers","following_url":"https://api.github.com/users/sergiitk/following{/other_user}","gists_url":"https://api.github.com/users/sergiitk/gists{/gist_id}","starred_url":"https://api.github.com/users/sergiitk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sergiitk/subscriptions","organizations_url":"https://api.github.com/users/sergiitk/orgs","repos_url":"https://api.github.com/users/sergiitk/repos","events_url":"https://api.github.com/users/sergiitk/events{/privacy}","received_events_url":"https://api.github.com/users/sergiitk/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"sergiitk","id":672669,"node_id":"MDQ6VXNlcjY3MjY2OQ==","avatar_url":"https://avatars.githubusercontent.com/u/672669?v=4","gravatar_id":"","url":"https://api.github.com/users/sergiitk","html_url":"https://github.com/sergiitk","followers_url":"https://api.github.com/users/sergiitk/followers","following_url":"https://api.github.com/users/sergiitk/following{/other_user}","gists_url":"https://api.github.com/users/sergiitk/gists{/gist_id}","starred_url":"https://api.github.com/users/sergiitk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sergiitk/subscriptions","organizations_url":"https://api.github.com/users/sergiitk/orgs","repos_url":"https://api.github.com/users/sergiitk/repos","events_url":"https://api.github.com/users/sergiitk/events{/privacy}","received_events_url":"https://api.github.com/users/sergiitk/received_events","type":"User","user_view_type":"public","site_admin":false},{"login":"sreenithi","id":22791051,"node_id":"MDQ6VXNlcjIyNzkxMDUx","avatar_url":"https://avatars.githubusercontent.com/u/22791051?v=4","gravatar_id":"","url":"https://api.github.com/users/sreenithi","html_url":"https://github.com/sreenithi","followers_url":"https://api.github.com/users/sreenithi/followers","following_url":"https://api.github.com/users/sreenithi/following{/other_user}","gists_url":"https://api.github.com/users/sreenithi/gists{/gist_id}","starred_url":"https://api.github.com/users/sreenithi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sreenithi/subscriptions","organizations_url":"https://api.github.com/users/sreenithi/orgs","repos_url":"https://api.github.com/users/sreenithi/repos","events_url":"https://api.github.com/users/sreenithi/events{/privacy}","received_events_url":"https://api.github.com/users/sreenithi/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":{"url":"https://api.github.com/repos/grpc/grpc/milestones/57","html_url":"https://github.com/grpc/grpc/milestone/57","labels_url":"https://api.github.com/repos/grpc/grpc/milestones/57/labels","id":13439196,"node_id":"MI_kwDOAacf2M4AzRDc","number":57,"title":"Python 3.14 support","description":"","creator":{"login":"sergiitk","id":672669,"node_id":"MDQ6VXNlcjY3MjY2OQ==","avatar_url":"https://avatars.githubusercontent.com/u/672669?v=4","gravatar_id":"","url":"https://api.github.com/users/sergiitk","html_url":"https://github.com/sergiitk","followers_url":"https://api.github.com/users/sergiitk/followers","following_url":"https://api.github.com/users/sergiitk/following{/other_user}","gists_url":"https://api.github.com/users/sergiitk/gists{/gist_id}","starred_url":"https://api.github.com/users/sergiitk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sergiitk/subscriptions","organizations_url":"https://api.github.com/users/sergiitk/orgs","repos_url":"https://api.github.com/users/sergiitk/repos","events_url":"https://api.github.com/users/sergiitk/events{/privacy}","received_events_url":"https://api.github.com/users/sergiitk/received_events","type":"User","user_view_type":"public","site_admin":false},"open_issues":0,"closed_issues":18,"state":"closed","created_at":"2025-08-06T17:17:08Z","updated_at":"2025-10-15T17:24:51Z","due_on":"2025-09-30T07:00:00Z","closed_at":"2025-10-15T17:24:51Z"},"comments":0,"created_at":"2025-05-08T14:53:21Z","updated_at":"2025-09-23T18:50:25Z","closed_at":"2025-09-09T17:40:17Z","author_association":"CONTRIBUTOR","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"<!--\nPLEASE DO NOT POST A QUESTION HERE.\nThis form is for bug reports and feature requests ONLY!\n\nFor general questions and troubleshooting, please ask/look for answers at StackOverflow, with \"grpc\" tag: https://stackoverflow.com/questions/tagged/grpc\n\nFor questions that specifically need to be answered by gRPC team members, please ask/look for answers at grpc.io mailing list: https://groups.google.com/forum/#!forum/grpc-io\n\nIssues specific to *grpc-java*, *grpc-go*, *grpc-node*, *grpc-dart*, *grpc-web* should be created in the repository they belong to (e.g. https://github.com/grpc/grpc-LANGUAGE/issues/new)\n-->\n\n### What version of gRPC and what language are you using?\ngRPC at HEAD\nPython\n\n### What operating system (Linux, Windows,...) and version?\nLinux (ubuntu, rodete)\n\n### What runtime / compiler are you using (e.g. python version or version of gcc)\nPython 3.14.0b1\ngcc version 14.2.0 (Debian 14.2.0-19+build4)\n\n### What did you do?\nPlease provide either 1) A unit test for reproducing the bug or 2) Specific steps for us to follow to reproduce the bug. If there’s not enough information to debug the problem, gRPC team may close the issue at their discretion. You’re welcome to re-open the issue once you have a reproduction.\n\nI made the following change to gRPC code to attempt to resolve https://github.com/grpc/grpc/issues/39507\n\n```diff\npartheniou@partheniou-vm-3:~/git/grpc$ git diff src/python/grpcio/grpc/_cython/_cygrpc/aio/common.pyx.pxi\ndiff --git a/src/python/grpcio/grpc/_cython/_cygrpc/aio/common.pyx.pxi b/src/python/grpcio/grpc/_cython/_cygrpc/aio/common.pyx.pxi\nindex 0e3e8de00b..674539bdac 100644\n--- a/src/python/grpcio/grpc/_cython/_cygrpc/aio/common.pyx.pxi\n+++ b/src/python/grpcio/grpc/_cython/_cygrpc/aio/common.pyx.pxi\n@@ -183,14 +183,25 @@ if PY_MAJOR_VERSION >= 3 and PY_MINOR_VERSION >= 7:\n         try:\n             return asyncio.get_running_loop()\n         except RuntimeError:\n-            with warnings.catch_warnings():\n-                # Convert DeprecationWarning to errors so we can capture them with except\n-                warnings.simplefilter(\"error\", DeprecationWarning)\n                 try:\n-                    return asyncio.get_event_loop_policy().get_event_loop()\n-                # Since version 3.12, DeprecationWarning is emitted if there is no\n+                    with warnings.catch_warnings():\n+                        # For `asyncio.get_event_loop_policy().get_event_loop()`:\n+                        #\n+                        # - Since Python 3.12, `DeprecationWarning` is emitted if there\n+                        #   is no current event loop.\n+                        # - Since Python 3.14, `DeprecationWarning` for\n+                        #   `asyncio.get_event_loop_policy()` also appears.\n+                        #\n+                        # In the interim, silence all `DeprecationWarning` for\n+                        # `asyncio.get_event_loop_policy().get_event_loop()`\n+                        warnings.simplefilter(\"ignore\", category=DeprecationWarning)\n+                        return asyncio.get_event_loop_policy().get_event_loop()\n+                # Since version 3.14, `RuntimeError` is emitted if there is no\n                 # current event loop.\n-                except DeprecationWarning:\n+                except RuntimeError:\n+                    # TODO(https://github.com/grpc/grpc/issues/39518):\n+                    # Migrate off of `asyncio.get_event_loop_policy()`\n+                    # prior to official launch of Python 3.14.\n                     return asyncio.get_event_loop_policy().new_event_loop()\n```\n\n\nThe workaround allow me to use Python 3.14. Previously Python 3.14  was blocked without this workaround. When I exited the interpreter, I encountered error `PythonFinalizationError: cannot join thread at interpreter shutdown`. \n\n```\npartheniou@partheniou-vm-3:~/git/grpc$ python3.14\nPython 3.14.0b1 (main, May  7 2025, 19:23:10) [GCC 14.2.0] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import grpc\n>>> from grpc import aio\n>>> print(grpc.__version__)\n1.73.0.dev100 # this is my own debug version\n>>> aio.secure_channel(\"http://localhost/\", grpc.local_channel_credentials())\n<grpc.aio._channel.Channel object at 0x7f102cd7b770>\n>>> exit()\nTraceback (most recent call last):\n  File \"src/python/grpcio/grpc/_cython/_cygrpc/aio/grpc_aio.pyx.pxi\", line 110, in grpc._cython.cygrpc.shutdown_grpc_aio\n    with _global_aio_state.lock:\n  File \"src/python/grpcio/grpc/_cython/_cygrpc/aio/grpc_aio.pyx.pxi\", line 114, in grpc._cython.cygrpc.shutdown_grpc_aio\n    _actual_aio_shutdown()\n  File \"src/python/grpcio/grpc/_cython/_cygrpc/aio/grpc_aio.pyx.pxi\", line 79, in grpc._cython.cygrpc._actual_aio_shutdown\n    (<PollerCompletionQueue>_global_aio_state.cq).shutdown()\n  File \"src/python/grpcio/grpc/_cython/_cygrpc/aio/completion_queue.pyx.pxi\", line 136, in grpc._cython.cygrpc.PollerCompletionQueue.shutdown\n    self._poller_thread.join(timeout=_POLL_AWAKE_INTERVAL_S)\n  File \"/usr/local/lib/python3.14/threading.py\", line 1130, in join\n    self._os_thread_handle.join(timeout)\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^\nPythonFinalizationError: cannot join thread at interpreter shutdown\nException ignored in: 'grpc._cython.cygrpc.AioChannel.__dealloc__'\nTraceback (most recent call last):\n  File \"src/python/grpcio/grpc/_cython/_cygrpc/aio/grpc_aio.pyx.pxi\", line 110, in grpc._cython.cygrpc.shutdown_grpc_aio\n    with _global_aio_state.lock:\n  File \"src/python/grpcio/grpc/_cython/_cygrpc/aio/grpc_aio.pyx.pxi\", line 114, in grpc._cython.cygrpc.shutdown_grpc_aio\n    _actual_aio_shutdown()\n  File \"src/python/grpcio/grpc/_cython/_cygrpc/aio/grpc_aio.pyx.pxi\", line 79, in grpc._cython.cygrpc._actual_aio_shutdown\n    (<PollerCompletionQueue>_global_aio_state.cq).shutdown()\n  File \"src/python/grpcio/grpc/_cython/_cygrpc/aio/completion_queue.pyx.pxi\", line 136, in grpc._cython.cygrpc.PollerCompletionQueue.shutdown\n    self._poller_thread.join(timeout=_POLL_AWAKE_INTERVAL_S)\n  File \"/usr/local/lib/python3.14/threading.py\", line 1130, in join\n    self._os_thread_handle.join(timeout)\nPythonFinalizationError: cannot join thread at interpreter shutdown\n```\n\n### What did you expect to see?\n\nI didn't expect to see any error when exiting the python interpreter.\n\n### What did you see instead?\n\nI saw error `PythonFinalizationError: cannot join thread at interpreter shutdown`\n\nMake sure you include information that can help us debug (full error message, exception listing, stack trace, logs).\n\nSee [TROUBLESHOOTING.md](https://github.com/grpc/grpc/blob/master/TROUBLESHOOTING.md) for how to diagnose problems better.\n\n### Anything else we should know about your project / environment?\n\nI was able to resolve this issue using another workaround\n\n```diff\npartheniou@partheniou-vm-3:~/git/grpc$ git diff src/python/grpcio/grpc/_cython/_cygrpc/aio/completion_queue.pyx.pxi\ndiff --git a/src/python/grpcio/grpc/_cython/_cygrpc/aio/completion_queue.pyx.pxi b/src/python/grpcio/grpc/_cython/_cygrpc/aio/completion_queue.pyx.pxi\nindex 56c67dcdea..69230e46dd 100644\n--- a/src/python/grpcio/grpc/_cython/_cygrpc/aio/completion_queue.pyx.pxi\n+++ b/src/python/grpcio/grpc/_cython/_cygrpc/aio/completion_queue.pyx.pxi\n@@ -133,7 +133,13 @@ cdef class PollerCompletionQueue(BaseCompletionQueue):\n         # TODO(https://github.com/grpc/grpc/issues/22365) perform graceful shutdown\n         grpc_completion_queue_shutdown(self._cq)\n         while not self._shutdown:\n-            self._poller_thread.join(timeout=_POLL_AWAKE_INTERVAL_S)\n+            try:\n+                self._poller_thread.join(timeout=_POLL_AWAKE_INTERVAL_S)\n+            except RuntimeError:\n+                # At this point we can no longer join a thread because the interpreter\n+                # is already shutting down.\n+                # See https://github.com/grpc/grpc/issues/39520\n+                pass\n         grpc_completion_queue_destroy(self._cq)\n```\n\n```\npartheniou@partheniou-vm-3:~/git/grpc$ python3.14\nPython 3.14.0b1 (main, May  7 2025, 19:23:10) [GCC 14.2.0] on linux\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import grpc\n>>> from grpc import aio\n>>> print(grpc.__version__)\n1.73.0.dev100 # this is my own debug version\n>>> aio.secure_channel(\"http://localhost/\", grpc.local_channel_credentials())\n<grpc.aio._channel.Channel object at 0x7f31dfdcf770>\n>>> exit\n```","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grpc/grpc/issues/39520/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grpc/grpc/issues/39520/timeline","performed_via_github_app":null,"state_reason":"completed"}