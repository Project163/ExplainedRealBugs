{"url":"https://api.github.com/repos/grpc/grpc/issues/39038","repository_url":"https://api.github.com/repos/grpc/grpc","labels_url":"https://api.github.com/repos/grpc/grpc/issues/39038/labels{/name}","comments_url":"https://api.github.com/repos/grpc/grpc/issues/39038/comments","events_url":"https://api.github.com/repos/grpc/grpc/issues/39038/events","html_url":"https://github.com/grpc/grpc/issues/39038","id":2938855698,"node_id":"I_kwDOAacf2M6vK2ES","number":39038,"title":"Unused artifacts are not removed from Ruby gem during source compile","user":{"login":"obrie","id":6991,"node_id":"MDQ6VXNlcjY5OTE=","avatar_url":"https://avatars.githubusercontent.com/u/6991?v=4","gravatar_id":"","url":"https://api.github.com/users/obrie","html_url":"https://github.com/obrie","followers_url":"https://api.github.com/users/obrie/followers","following_url":"https://api.github.com/users/obrie/following{/other_user}","gists_url":"https://api.github.com/users/obrie/gists{/gist_id}","starred_url":"https://api.github.com/users/obrie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/obrie/subscriptions","organizations_url":"https://api.github.com/users/obrie/orgs","repos_url":"https://api.github.com/users/obrie/repos","events_url":"https://api.github.com/users/obrie/events{/privacy}","received_events_url":"https://api.github.com/users/obrie/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":155504842,"node_id":"MDU6TGFiZWwxNTU1MDQ4NDI=","url":"https://api.github.com/repos/grpc/grpc/labels/kind/bug","name":"kind/bug","color":"93732c","default":false,"description":null},{"id":166332946,"node_id":"MDU6TGFiZWwxNjYzMzI5NDY=","url":"https://api.github.com/repos/grpc/grpc/labels/lang/ruby","name":"lang/ruby","color":"fad8c7","default":false,"description":null},{"id":360790193,"node_id":"MDU6TGFiZWwzNjA3OTAxOTM=","url":"https://api.github.com/repos/grpc/grpc/labels/priority/P2","name":"priority/P2","color":"dd7172","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"apolcyn","id":9566254,"node_id":"MDQ6VXNlcjk1NjYyNTQ=","avatar_url":"https://avatars.githubusercontent.com/u/9566254?v=4","gravatar_id":"","url":"https://api.github.com/users/apolcyn","html_url":"https://github.com/apolcyn","followers_url":"https://api.github.com/users/apolcyn/followers","following_url":"https://api.github.com/users/apolcyn/following{/other_user}","gists_url":"https://api.github.com/users/apolcyn/gists{/gist_id}","starred_url":"https://api.github.com/users/apolcyn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/apolcyn/subscriptions","organizations_url":"https://api.github.com/users/apolcyn/orgs","repos_url":"https://api.github.com/users/apolcyn/repos","events_url":"https://api.github.com/users/apolcyn/events{/privacy}","received_events_url":"https://api.github.com/users/apolcyn/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"apolcyn","id":9566254,"node_id":"MDQ6VXNlcjk1NjYyNTQ=","avatar_url":"https://avatars.githubusercontent.com/u/9566254?v=4","gravatar_id":"","url":"https://api.github.com/users/apolcyn","html_url":"https://github.com/apolcyn","followers_url":"https://api.github.com/users/apolcyn/followers","following_url":"https://api.github.com/users/apolcyn/following{/other_user}","gists_url":"https://api.github.com/users/apolcyn/gists{/gist_id}","starred_url":"https://api.github.com/users/apolcyn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/apolcyn/subscriptions","organizations_url":"https://api.github.com/users/apolcyn/orgs","repos_url":"https://api.github.com/users/apolcyn/repos","events_url":"https://api.github.com/users/apolcyn/events{/privacy}","received_events_url":"https://api.github.com/users/apolcyn/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":0,"created_at":"2025-03-21T16:05:33Z","updated_at":"2025-05-20T19:26:20Z","closed_at":"2025-05-20T19:26:20Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"As reported [here](https://github.com/grpc/grpc/issues/35396#issuecomment-1888419174), a regression was introduced for the fix for #33596: in the following commit: https://github.com/grpc/grpc/commit/36af3236732c46429a0ce01a5b30961ed7c66b6b\n\nAs noted in that comment:\n\n> `hijack: all strip` gets prepended to the Makefile above `hijack_remove_unused_artifacts: all remove_unused_artifacts`, and neither `hijack_remove_unused_artifacts` nor `remove_unused_artifacts`  are referenced anywhere else, so `objs/` and `libs/` never get emptied.\n\nThe comment author also provides an [example](https://github.com/grpc/grpc/issues/35396#issuecomment-1888413021) of the bloat reported by the gem:\n\n> ```\n> % du -ksh grpc-1.60.0/src/ruby/ext/grpc/objs\n> 829M\tgrpc-1.60.0/src/ruby/ext/grpc/objs\n> % du -ksh grpc-1.60.0/src/ruby/ext/grpc/libs\n> 944M\tgrpc-1.60.0/src/ruby/ext/grpc/libs\n> ```\n\n### What version of gRPC and what language are you using?\n\nWhile the original comment author reported this on grpc 1.60.0, I can confirm that it is still an issue on grpc 1.71.0.  This is for Ruby.\n\n### What operating system (Linux, Windows,...) and version?\n\nLinux, both `Ubuntu 20.04.6 LTS` and `Ubuntu 22.04.5 LTS`\n\n### What runtime / compiler are you using (e.g. python version or version of gcc)\n\nTested on both gcc `9.4.0` and `11.4.0`\n\n### What did you do?\n\nCreate `Gemfile`:\n\n```ruby\ngem 'grpc', '1.71.0'\n```\n\nInstall gem, forcing it to be compiled from source:\n\n```sh\nbundle config set --local force_ruby_platform 'true'\nbundle install\n```\n\nOnce installed, check the disk usage:\n\n```sh\ndu -h -d 1 $(bundle show grpc)\n```\n\n### What did you expect to see?\n\nSomething similar to grpc 1.58.0:\n\n```sh\n> du -h -d 1 /usr/local/rvm/gems/ruby-3.4.1/gems/grpc-1.58.0/\n68M\t/usr/local/rvm/gems/ruby-3.4.1/gems/grpc-1.58.0/src\n264K\t/usr/local/rvm/gems/ruby-3.4.1/gems/grpc-1.58.0/etc\n540K\t/usr/local/rvm/gems/ruby-3.4.1/gems/grpc-1.58.0/include\n19M\t/usr/local/rvm/gems/ruby-3.4.1/gems/grpc-1.58.0/third_party\n88M\t/usr/local/rvm/gems/ruby-3.4.1/gems/grpc-1.58.0/\n```\n\n### What did you see instead?\n\nSignificantly more disk usage:\n\n```sh\ndu -h -d 1 $(bundle show grpc)\n2.6G\t/project/vendor/bundle/ruby/3.4.0/gems/grpc-1.71.0/src\n264K\t/project/vendor/bundle/ruby/3.4.0/gems/grpc-1.71.0/etc\n568K\t/project/vendor/bundle/ruby/3.4.0/gems/grpc-1.71.0/include\n20M\t/project/vendor/bundle/ruby/3.4.0/gems/grpc-1.71.0/third_party\n2.6G\t/project/vendor/bundle/ruby/3.4.0/gems/grpc-1.71.0\n```\n\n### Anything else we should know about your project / environment?\n\nNone","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grpc/grpc/issues/39038/reactions","total_count":2,"+1":2,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grpc/grpc/issues/39038/timeline","performed_via_github_app":null,"state_reason":"completed"}