{"url":"https://api.github.com/repos/grpc/grpc/issues/38758","repository_url":"https://api.github.com/repos/grpc/grpc","labels_url":"https://api.github.com/repos/grpc/grpc/issues/38758/labels{/name}","comments_url":"https://api.github.com/repos/grpc/grpc/issues/38758/comments","events_url":"https://api.github.com/repos/grpc/grpc/issues/38758/events","html_url":"https://github.com/grpc/grpc/issues/38758","id":2857411289,"node_id":"I_kwDOAacf2M6qUKLZ","number":38758,"title":"Immediate cancellation of RPC calls leads to HTTP/2 RST packets for uninitialized streams (grpc-core)","user":{"login":"segoon","id":160934,"node_id":"MDQ6VXNlcjE2MDkzNA==","avatar_url":"https://avatars.githubusercontent.com/u/160934?v=4","gravatar_id":"","url":"https://api.github.com/users/segoon","html_url":"https://github.com/segoon","followers_url":"https://api.github.com/users/segoon/followers","following_url":"https://api.github.com/users/segoon/following{/other_user}","gists_url":"https://api.github.com/users/segoon/gists{/gist_id}","starred_url":"https://api.github.com/users/segoon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/segoon/subscriptions","organizations_url":"https://api.github.com/users/segoon/orgs","repos_url":"https://api.github.com/users/segoon/repos","events_url":"https://api.github.com/users/segoon/events{/privacy}","received_events_url":"https://api.github.com/users/segoon/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":155504842,"node_id":"MDU6TGFiZWwxNTU1MDQ4NDI=","url":"https://api.github.com/repos/grpc/grpc/labels/kind/bug","name":"kind/bug","color":"93732c","default":false,"description":null},{"id":218696181,"node_id":"MDU6TGFiZWwyMTg2OTYxODE=","url":"https://api.github.com/repos/grpc/grpc/labels/lang/core","name":"lang/core","color":"fad8c7","default":false,"description":""},{"id":360790193,"node_id":"MDU6TGFiZWwzNjA3OTAxOTM=","url":"https://api.github.com/repos/grpc/grpc/labels/priority/P2","name":"priority/P2","color":"dd7172","default":false,"description":""},{"id":3940839694,"node_id":"LA_kwDOAacf2M7q5HEO","url":"https://api.github.com/repos/grpc/grpc/labels/untriaged","name":"untriaged","color":"c2e0c6","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"yashykt","id":4181124,"node_id":"MDQ6VXNlcjQxODExMjQ=","avatar_url":"https://avatars.githubusercontent.com/u/4181124?v=4","gravatar_id":"","url":"https://api.github.com/users/yashykt","html_url":"https://github.com/yashykt","followers_url":"https://api.github.com/users/yashykt/followers","following_url":"https://api.github.com/users/yashykt/following{/other_user}","gists_url":"https://api.github.com/users/yashykt/gists{/gist_id}","starred_url":"https://api.github.com/users/yashykt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yashykt/subscriptions","organizations_url":"https://api.github.com/users/yashykt/orgs","repos_url":"https://api.github.com/users/yashykt/repos","events_url":"https://api.github.com/users/yashykt/events{/privacy}","received_events_url":"https://api.github.com/users/yashykt/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"yashykt","id":4181124,"node_id":"MDQ6VXNlcjQxODExMjQ=","avatar_url":"https://avatars.githubusercontent.com/u/4181124?v=4","gravatar_id":"","url":"https://api.github.com/users/yashykt","html_url":"https://github.com/yashykt","followers_url":"https://api.github.com/users/yashykt/followers","following_url":"https://api.github.com/users/yashykt/following{/other_user}","gists_url":"https://api.github.com/users/yashykt/gists{/gist_id}","starred_url":"https://api.github.com/users/yashykt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yashykt/subscriptions","organizations_url":"https://api.github.com/users/yashykt/orgs","repos_url":"https://api.github.com/users/yashykt/repos","events_url":"https://api.github.com/users/yashykt/events{/privacy}","received_events_url":"https://api.github.com/users/yashykt/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":1,"created_at":"2025-02-17T10:23:59Z","updated_at":"2025-02-28T16:37:00Z","closed_at":"2025-02-28T16:37:00Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### What version of gRPC and what language are you using?\n1.54.3\n\n### What operating system (Linux, Windows,...) and version?\nLinux, Ubuntu 22.04\n\n### What runtime / compiler are you using (e.g. python version or version of gcc)\nclang version 18.1.8\n\n### What did you do?\nSend a request and immediately cancel it.\n\n### What did you expect to see?\nHTTP2 Stream reset.\n\n### What did you see instead?\nThe whole HTTP2 connection RST sometimes.\n\n### Anything else we should know about your project / environment?\nThis is a recreated ticket https://github.com/grpc/grpc/issues/19655#issuecomment-2652290969, but with C++ grpc-core.\n\nWe're able to (hopefully) fix the bug with the following patch:\n```\n--- contrib/libs/grpc/src/core/ext/transport/chttp2/transport/chttp2_transport.cc       (8f4736fcb2c85a5a7647b2ed61a82fb96e3f9363)\n+++ contrib/libs/grpc/src/core/ext/transport/chttp2/transport/chttp2_transport.cc       (3200105e7c9942e90b9bd87cf492ea345cb9a7b7)\n@@ -2073,12 +2073,19 @@ void grpc_chttp2_cancel_stream(grpc_chttp2_transport* t, grpc_chttp2_stream* s,\n \n   if (!s->read_closed || !s->write_closed) {\n     if (s->id != 0) {\n-      grpc_http2_error_code http_error;\n-      grpc_error_get_status(due_to_error, s->deadline, nullptr, nullptr,\n-                            &http_error, nullptr);\n-      grpc_chttp2_add_rst_stream_to_next_write(\n-          t, s->id, static_cast<uint32_t>(http_error), &s->stats.outgoing);\n-      grpc_chttp2_initiate_write(t, GRPC_CHTTP2_INITIATE_WRITE_RST_STREAM);\n+      if (s->sent_initial_metadata) {\n+        grpc_http2_error_code http_error;\n+        grpc_error_get_status(due_to_error, s->deadline, nullptr, nullptr,\n+                              &http_error, nullptr);\n+        grpc_chttp2_add_rst_stream_to_next_write(\n+            t, s->id, static_cast<uint32_t>(http_error), &s->stats.outgoing);\n+        grpc_chttp2_initiate_write(t, GRPC_CHTTP2_INITIATE_WRITE_RST_STREAM);\n+      } else {\n+        // HEADERS is not sent to the peer yet, we may not send RST_STREAM.\n+        // Wait for headers to be sent.\n+        s->has_pending_cancel = true;\n+        return;\n+      }\n     }\n   }\n   if (!due_to_error.ok() && !s->seen_error) {\n--- contrib/libs/grpc/src/core/ext/transport/chttp2/transport/internal.h        (8f4736fcb2c85a5a7647b2ed61a82fb96e3f9363)\n+++ contrib/libs/grpc/src/core/ext/transport/chttp2/transport/internal.h        (3200105e7c9942e90b9bd87cf492ea345cb9a7b7)\n@@ -568,6 +568,8 @@ struct grpc_chttp2_stream {\n   bool eos_received = false;\n   bool eos_sent = false;\n \n+  bool has_pending_cancel = false;\n+\n   /// the error that resulted in this stream being read-closed\n   grpc_error_handle read_closed_error;\n   /// the error that resulted in this stream being write-closed\n--- contrib/libs/grpc/src/core/ext/transport/chttp2/transport/writing.cc        (8f4736fcb2c85a5a7647b2ed61a82fb96e3f9363)\n+++ contrib/libs/grpc/src/core/ext/transport/chttp2/transport/writing.cc        (3200105e7c9942e90b9bd87cf492ea345cb9a7b7)\n@@ -484,6 +484,11 @@ class StreamWriteContext {\n \n     s_->send_initial_metadata = nullptr;\n     s_->sent_initial_metadata = true;\n+    if (s_->has_pending_cancel) {\n+      grpc_slice_buffer_add(\n+          &t_->outbuf, grpc_chttp2_rst_stream_create(s_->id, GRPC_HTTP2_NO_ERROR, &s_->stats.outgoing));\n+      grpc_chttp2_mark_stream_closed(t_, s_, 1, 1, {});\n+    }\n     write_context_->NoteScheduledResults();\n     grpc_chttp2_complete_closure_step(\n         t_, s_, &s_->send_initial_metadata_finished, y_absl::OkStatus(),\n```","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grpc/grpc/issues/38758/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grpc/grpc/issues/38758/timeline","performed_via_github_app":null,"state_reason":"completed"}