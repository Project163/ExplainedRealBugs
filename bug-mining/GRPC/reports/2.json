{"url":"https://api.github.com/repos/grpc/grpc/issues/32967","repository_url":"https://api.github.com/repos/grpc/grpc","labels_url":"https://api.github.com/repos/grpc/grpc/issues/32967/labels{/name}","comments_url":"https://api.github.com/repos/grpc/grpc/issues/32967/comments","events_url":"https://api.github.com/repos/grpc/grpc/issues/32967/events","html_url":"https://github.com/grpc/grpc/issues/32967","id":1688702631,"node_id":"I_kwDOAacf2M5kp46n","number":32967,"title":"Segfault when using outlier detection LB with pick_first","user":{"login":"s-matyukevich","id":7030896,"node_id":"MDQ6VXNlcjcwMzA4OTY=","avatar_url":"https://avatars.githubusercontent.com/u/7030896?v=4","gravatar_id":"","url":"https://api.github.com/users/s-matyukevich","html_url":"https://github.com/s-matyukevich","followers_url":"https://api.github.com/users/s-matyukevich/followers","following_url":"https://api.github.com/users/s-matyukevich/following{/other_user}","gists_url":"https://api.github.com/users/s-matyukevich/gists{/gist_id}","starred_url":"https://api.github.com/users/s-matyukevich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s-matyukevich/subscriptions","organizations_url":"https://api.github.com/users/s-matyukevich/orgs","repos_url":"https://api.github.com/users/s-matyukevich/repos","events_url":"https://api.github.com/users/s-matyukevich/events{/privacy}","received_events_url":"https://api.github.com/users/s-matyukevich/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":155504842,"node_id":"MDU6TGFiZWwxNTU1MDQ4NDI=","url":"https://api.github.com/repos/grpc/grpc/labels/kind/bug","name":"kind/bug","color":"93732c","default":false,"description":null},{"id":218696181,"node_id":"MDU6TGFiZWwyMTg2OTYxODE=","url":"https://api.github.com/repos/grpc/grpc/labels/lang/core","name":"lang/core","color":"fad8c7","default":false,"description":""},{"id":360790193,"node_id":"MDU6TGFiZWwzNjA3OTAxOTM=","url":"https://api.github.com/repos/grpc/grpc/labels/priority/P2","name":"priority/P2","color":"dd7172","default":false,"description":""},{"id":3940839694,"node_id":"LA_kwDOAacf2M7q5HEO","url":"https://api.github.com/repos/grpc/grpc/labels/untriaged","name":"untriaged","color":"c2e0c6","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"markdroth","id":18664614,"node_id":"MDQ6VXNlcjE4NjY0NjE0","avatar_url":"https://avatars.githubusercontent.com/u/18664614?v=4","gravatar_id":"","url":"https://api.github.com/users/markdroth","html_url":"https://github.com/markdroth","followers_url":"https://api.github.com/users/markdroth/followers","following_url":"https://api.github.com/users/markdroth/following{/other_user}","gists_url":"https://api.github.com/users/markdroth/gists{/gist_id}","starred_url":"https://api.github.com/users/markdroth/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markdroth/subscriptions","organizations_url":"https://api.github.com/users/markdroth/orgs","repos_url":"https://api.github.com/users/markdroth/repos","events_url":"https://api.github.com/users/markdroth/events{/privacy}","received_events_url":"https://api.github.com/users/markdroth/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"markdroth","id":18664614,"node_id":"MDQ6VXNlcjE4NjY0NjE0","avatar_url":"https://avatars.githubusercontent.com/u/18664614?v=4","gravatar_id":"","url":"https://api.github.com/users/markdroth","html_url":"https://github.com/markdroth","followers_url":"https://api.github.com/users/markdroth/followers","following_url":"https://api.github.com/users/markdroth/following{/other_user}","gists_url":"https://api.github.com/users/markdroth/gists{/gist_id}","starred_url":"https://api.github.com/users/markdroth/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markdroth/subscriptions","organizations_url":"https://api.github.com/users/markdroth/orgs","repos_url":"https://api.github.com/users/markdroth/repos","events_url":"https://api.github.com/users/markdroth/events{/privacy}","received_events_url":"https://api.github.com/users/markdroth/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":3,"created_at":"2023-04-28T14:55:50Z","updated_at":"2023-06-02T23:18:26Z","closed_at":"2023-05-10T20:33:06Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### What version of gRPC and what language are you using?\r\n\r\n`v1.50.0`\r\n\r\n### What operating system (Linux, Windows,...) and version?\r\n\r\n`Linux`\r\n\r\n### What runtime / compiler are you using (e.g. python version or version of gcc)\r\n\r\npython 3\r\n\r\n### What did you do?\r\n1. Use the following service config:\r\n```\r\n    {\r\n        \"loadBalancingConfig\": [\r\n            {\r\n                \"outlier_detection_experimental\": {\r\n                    \"interval\": \"1s\",\r\n                    \"baseEjectionTime\": \"30s\",\r\n                    \"maxEjectionTime\": \"300s\",\r\n                    \"maxEjectionPercent\": 100,\r\n                    \"failurePercentageEjection\": {\r\n                        \"enforcementPercentage\": 100,\r\n                        \"requestVolume\": 1,\r\n                        \"minimumHosts\": 1\r\n                    },\r\n                    \"childPolicy\": [{\r\n                        \"pick_first\": {}\r\n                    }]\r\n                }\r\n            }\r\n        ]\r\n    }\r\n```\r\n2. Create 2 upstream services one of which always returns errors and the second one always succeeds. \r\n3. Run the test several times until pick_first picker decides to pick the bad upstream (we need this step because our DNS server randomizes the response, I guess you can also just make sure that bad server is always returned first in the DNS response)\r\n\r\n### What did you expect to see?\r\nOutlier detection LB should eject the failing host (this part actually happens) and pick_first picker should pick the second healthy host and keep using it.\r\n\r\n### What did you see instead?\r\n\r\nSegfault.\r\n\r\nHere are the most verbose trace logs at the time of failure:\r\n```\r\nI0427 19:14:08.574305009      15 outlier_detection.cc:827]   [outlier_detection_lb 0x55d01ab087b0] ejection timer running\r\nI0427 19:14:08.574316433      15 outlier_detection.cc:868]   [outlier_detection_lb 0x55d01ab087b0] found 0 success rate candidates and 1 failure percentage candidates; ejected_host_count=0; success_rate_sum=0.000\r\nI0427 19:14:08.574324699      15 outlier_detection.cc:944]   [outlier_detection_lb 0x55d01ab087b0] running failure percentage algorithm\r\nI0427 19:14:08.574328305      15 outlier_detection.cc:950]   [outlier_detection_lb 0x55d01ab087b0] checking candidate 0x55d01b018860: success_rate=0.000\r\nI0427 19:14:08.574334408      15 outlier_detection.cc:964]   [outlier_detection_lb 0x55d01ab087b0] random_key=95 ejected_host_count=0 current_percent=0.000\r\nI0427 19:14:08.574339370      15 outlier_detection.cc:977]   [outlier_detection_lb 0x55d01ab087b0] ejecting candidate\r\nI0427 19:14:08.574351486      15 subchannel_list.h:247]      [PickFirstSubchannelList 0x55d01ac97a70] subchannel list 0x55d01af8a670 index 0 of 2 (subchannel 0x55d01ad32d10): connectivity changed: old_state=READY, new_state=TRANSIENT_FAILURE, status=UNAVAILABLE: subchannel ejected by outlier detection, shutting_down=0, pending_watcher=0x55d01af8a7a0\r\nI0427 19:14:08.574357970      15 pick_first.cc:315]          Pick First 0x55d01ac97a70 selected subchannel connectivity changed to TRANSIENT_FAILURE\r\nI0427 19:14:08.574361493      15 child_policy_handler.cc:100] [child_policy_handler 0x55d01af8a6e0] started name re-resolving\r\nI0427 19:14:08.574365196      15 child_policy_handler.cc:100] [child_policy_handler 0x55d01ae65b70] started name re-resolving\r\nI0427 19:14:08.574368366      15 client_channel.cc:912]      chand=0x55d01ad83a70: started name re-resolving\r\nI0427 19:14:08.574373779      15 polling_resolver.cc:231]    [polling resolver 0x55d01af89f70] in cooldown from last resolution (from 1003 ms ago); will resolve again in 28997 ms\r\nI0427 19:14:08.574379794      15 timer_generic.cc:344]       TIMER 0x55d01af89fe0: SET 31006 now 2009 call 0x55d01af8a018[0x7f04362e25c0]\r\nI0427 19:14:08.574382950      15 timer_generic.cc:381]         .. add to shard 19 with queue_deadline_cap=3007 => is_first_timer=false\r\nI0427 19:14:08.574385976      15 subchannel_list.h:419]      [PickFirstSubchannelList 0x55d01ac97a70] Shutting down subchannel_list 0x55d01af8a670\r\nI0427 19:14:08.574390582      15 subchannel_list.h:336]      [PickFirstSubchannelList 0x55d01ac97a70] subchannel list 0x55d01af8a670 index 0 of 2 (subchannel 0x55d01ad32d10): canceling connectivity watch (shutdown)\r\nI0427 19:14:08.574401550      15 subchannel_list.h:293]      [PickFirstSubchannelList 0x55d01ac97a70] subchannel list 0x55d01af8a670 index 0 of 2 (subchannel 0x55d01ad32d10): unreffing subchannel (shutdown)\r\nI0427 19:14:08.574407747      15 subchannel_list.h:400]      [PickFirstSubchannelList 0x55d01ac97a70] Destroying subchannel_list 0x55d01af8a670\r\nI0427 19:14:08.574411896      15 outlier_detection.cc:760]   [outlier_detection_lb 0x55d01ab087b0] child connectivity state update: state=IDLE (OK) picker=0x7f042c002f20\r\nI0427 19:14:08.574415391      15 outlier_detection.cc:508]   [outlier_detection_lb 0x55d01ab087b0] constructed new picker 0x7f042c000eb0 and counting is enabled\r\nI0427 19:14:08.574418304      15 outlier_detection.cc:698]   [outlier_detection_lb 0x55d01ab087b0] updating connectivity: state=IDLE status=(OK) picker=0x7f042c000eb0\r\nI0427 19:14:08.574422343      15 client_channel.cc:897]      chand=0x55d01ad83a70: update: state=IDLE status=(OK) picker=0x7f042c000eb0\r\nI0427 19:14:08.574426787      15 connectivity_state.cc:160]  ConnectivityStateTracker client_channel[0x55d01ad83b28]: READY -> IDLE (helper, OK)\r\n/app/domains/ephemera/apps/ephemera-probe-python/ephemera-probe-python: line 27:    11 Segmentation fault      $PYTHON_INTERPRETER_RUNFILE_PATH $PYTHON_BIN_RUNFILE_PATH \"$@\"\r\n```\r\n\r\n### Anything else we should know about your project / environment?\r\n","closed_by":{"login":"markdroth","id":18664614,"node_id":"MDQ6VXNlcjE4NjY0NjE0","avatar_url":"https://avatars.githubusercontent.com/u/18664614?v=4","gravatar_id":"","url":"https://api.github.com/users/markdroth","html_url":"https://github.com/markdroth","followers_url":"https://api.github.com/users/markdroth/followers","following_url":"https://api.github.com/users/markdroth/following{/other_user}","gists_url":"https://api.github.com/users/markdroth/gists{/gist_id}","starred_url":"https://api.github.com/users/markdroth/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markdroth/subscriptions","organizations_url":"https://api.github.com/users/markdroth/orgs","repos_url":"https://api.github.com/users/markdroth/repos","events_url":"https://api.github.com/users/markdroth/events{/privacy}","received_events_url":"https://api.github.com/users/markdroth/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grpc/grpc/issues/32967/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grpc/grpc/issues/32967/timeline","performed_via_github_app":null,"state_reason":"completed"}