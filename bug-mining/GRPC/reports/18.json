{"url":"https://api.github.com/repos/grpc/grpc/issues/35076","repository_url":"https://api.github.com/repos/grpc/grpc","labels_url":"https://api.github.com/repos/grpc/grpc/issues/35076/labels{/name}","comments_url":"https://api.github.com/repos/grpc/grpc/issues/35076/comments","events_url":"https://api.github.com/repos/grpc/grpc/issues/35076/events","html_url":"https://github.com/grpc/grpc/issues/35076","id":2005735818,"node_id":"I_kwDOAacf2M53jRmK","number":35076,"title":"After \"Failed getpeername: Bad file descriptor\" the unix domain grpc server does not recover unless restarted","user":{"login":"ssachinbharadwaj","id":10479840,"node_id":"MDQ6VXNlcjEwNDc5ODQw","avatar_url":"https://avatars.githubusercontent.com/u/10479840?v=4","gravatar_id":"","url":"https://api.github.com/users/ssachinbharadwaj","html_url":"https://github.com/ssachinbharadwaj","followers_url":"https://api.github.com/users/ssachinbharadwaj/followers","following_url":"https://api.github.com/users/ssachinbharadwaj/following{/other_user}","gists_url":"https://api.github.com/users/ssachinbharadwaj/gists{/gist_id}","starred_url":"https://api.github.com/users/ssachinbharadwaj/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ssachinbharadwaj/subscriptions","organizations_url":"https://api.github.com/users/ssachinbharadwaj/orgs","repos_url":"https://api.github.com/users/ssachinbharadwaj/repos","events_url":"https://api.github.com/users/ssachinbharadwaj/events{/privacy}","received_events_url":"https://api.github.com/users/ssachinbharadwaj/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":155504842,"node_id":"MDU6TGFiZWwxNTU1MDQ4NDI=","url":"https://api.github.com/repos/grpc/grpc/labels/kind/bug","name":"kind/bug","color":"93732c","default":false,"description":null},{"id":218696181,"node_id":"MDU6TGFiZWwyMTg2OTYxODE=","url":"https://api.github.com/repos/grpc/grpc/labels/lang/core","name":"lang/core","color":"fad8c7","default":false,"description":""},{"id":360790193,"node_id":"MDU6TGFiZWwzNjA3OTAxOTM=","url":"https://api.github.com/repos/grpc/grpc/labels/priority/P2","name":"priority/P2","color":"dd7172","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"drfloob","id":295906,"node_id":"MDQ6VXNlcjI5NTkwNg==","avatar_url":"https://avatars.githubusercontent.com/u/295906?v=4","gravatar_id":"","url":"https://api.github.com/users/drfloob","html_url":"https://github.com/drfloob","followers_url":"https://api.github.com/users/drfloob/followers","following_url":"https://api.github.com/users/drfloob/following{/other_user}","gists_url":"https://api.github.com/users/drfloob/gists{/gist_id}","starred_url":"https://api.github.com/users/drfloob/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/drfloob/subscriptions","organizations_url":"https://api.github.com/users/drfloob/orgs","repos_url":"https://api.github.com/users/drfloob/repos","events_url":"https://api.github.com/users/drfloob/events{/privacy}","received_events_url":"https://api.github.com/users/drfloob/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"drfloob","id":295906,"node_id":"MDQ6VXNlcjI5NTkwNg==","avatar_url":"https://avatars.githubusercontent.com/u/295906?v=4","gravatar_id":"","url":"https://api.github.com/users/drfloob","html_url":"https://github.com/drfloob","followers_url":"https://api.github.com/users/drfloob/followers","following_url":"https://api.github.com/users/drfloob/following{/other_user}","gists_url":"https://api.github.com/users/drfloob/gists{/gist_id}","starred_url":"https://api.github.com/users/drfloob/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/drfloob/subscriptions","organizations_url":"https://api.github.com/users/drfloob/orgs","repos_url":"https://api.github.com/users/drfloob/repos","events_url":"https://api.github.com/users/drfloob/events{/privacy}","received_events_url":"https://api.github.com/users/drfloob/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":10,"created_at":"2023-11-22T07:29:53Z","updated_at":"2024-04-02T18:29:21Z","closed_at":"2024-02-06T18:40:28Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"### What version of gRPC and what language are you using?\r\n1.52.1\r\n\r\n### What operating system (Linux, Windows,...) and version?\r\nLinux\r\n\r\n### What runtime / compiler are you using (e.g. python version or version of gcc)\r\ng++\r\n\r\n### What did you do?\r\nI have two c++ applications (grpc server and client) running on the same device. They both communicate over the Unix domain socket. Both are using same grpc library version 1.52.1.\r\nServer listens on \"unix:/var/run/server_uds\"\r\nThe client keeps creating new channels, fires a unary RPC and closes the channel.\r\nOccasionally the client is restarted\r\n\r\n**In some extremely rare cases, I see the following error on server side:**\r\nE1011 19:45:02.624072018    1864 tcp_server_posix.cc:245]              Failed getpeername: Bad file descriptor\r\n\r\nOnce the above error is seen, the server no longer accepts any new connections.\r\n\r\nThe issue was seen 3 times in the production environment and I was not able to reproduce the \"Failed getpeername: Bad file descriptor\" error myself. However, one correlating factor from the logs was the restart of the client.\r\nJust after the restart of client, this error is seen on the server and the server goes to a bad state.\r\nI tried restarting the client multiple times around the time of channel creation but getpeername always succeeded.\r\n\r\n**However, I was able to enter the path of an \"irrecoverable state\" by making the below change to forcefully enter the failure path:**\r\nhttps://github.com/grpc/grpc/blob/v1.52.1/src/core/lib/iomgr/tcp_server_posix.cc#L225\r\n\r\n```\r\n    if (sp->server->memory_quota->IsMemoryPressureHigh()) {\r\n      int64_t dropped_connections_count =\r\n          num_dropped_connections.fetch_add(1, std::memory_order_relaxed) + 1;\r\n      if (dropped_connections_count % 1000 == 1) {\r\n        gpr_log(GPR_INFO,\r\n                \"Dropped >= %\" PRId64\r\n                \" new connection attempts due to high memory pressure\",\r\n                dropped_connections_count);\r\n      }\r\n      close(fd);\r\n      continue;\r\n    }\r\n\r\n+ close(fd);   // <<<<<<<<< Faking the failure\r\n+ goto error; // <<<<<<<<< Faking the failure\r\n\r\n    // For UNIX sockets, the accept call might not fill up the member sun_path\r\n    // of sockaddr_un, so explicitly call getpeername to get it.\r\n    if (grpc_is_unix_socket(&addr)) {\r\n      memset(&addr, 0, sizeof(addr));\r\n      addr.len = static_cast<socklen_t>(sizeof(struct sockaddr_storage));\r\n      if (getpeername(fd, reinterpret_cast<struct sockaddr*>(addr.addr),\r\n                      &(addr.len)) < 0) {\r\n        gpr_log(GPR_ERROR, \"Failed getpeername: %s\",\r\n                grpc_core::StrError(errno).c_str());\r\n        close(fd); // <<<<<<<<< Real failure place\r\n        goto error; // <<<<<<<<< Real failure place\r\n      }\r\n    }\r\n```\r\n\r\n**Hacky fix (not well tested): If I change the same code to below, it keeps accepting new connections:**\r\n```\r\n    if (sp->server->memory_quota->IsMemoryPressureHigh()) {\r\n      int64_t dropped_connections_count =\r\n          num_dropped_connections.fetch_add(1, std::memory_order_relaxed) + 1;\r\n      if (dropped_connections_count % 1000 == 1) {\r\n        gpr_log(GPR_INFO,\r\n                \"Dropped >= %\" PRId64\r\n                \" new connection attempts due to high memory pressure\",\r\n                dropped_connections_count);\r\n      }\r\n      close(fd);\r\n      continue;\r\n    }\r\n\r\n+ close(fd);   // <<<<<<<<< Faking the failure\r\n+ continue; // <<<<<<<<< Continuing\r\n\r\n    // For UNIX sockets, the accept call might not fill up the member sun_path\r\n    // of sockaddr_un, so explicitly call getpeername to get it.\r\n    if (grpc_is_unix_socket(&addr)) {\r\n      memset(&addr, 0, sizeof(addr));\r\n      addr.len = static_cast<socklen_t>(sizeof(struct sockaddr_storage));\r\n      if (getpeername(fd, reinterpret_cast<struct sockaddr*>(addr.addr),\r\n                      &(addr.len)) < 0) {\r\n        gpr_log(GPR_ERROR, \"Failed getpeername: %s\",\r\n                grpc_core::StrError(errno).c_str());\r\n        close(fd); // <<<<<<<<< Real failure place\r\n        goto error; // <<<<<<<<< Real failure place\r\n      }\r\n    }\r\n```\r\n\r\nSo, should the \"goto error;\" be replaced with \"continue;\"?\r\n\r\n### What did you expect to see?\r\n1. I expect to not see \"Bad file descriptor\" in the first place\r\n2. Even if \"Bad file descriptor\" is seen, it should recover\r\n\r\n### What did you see instead?\r\nI see that after hitting the \"Failed getpeername: Bad file descriptor\", the server stops accepting any new connections.\r\nIn the netstat, the UDS socket is still in the LISTENING state and all the attempts made to connect will keep increasing as CONNECTING. The entries keep growing and even if the client is restarted, the entries won't go away.\r\n\r\n$netstat -an | grep \"server_uds\"\r\n26901:unix  2      [ ACC ]     STREAM     LISTENING     121121   11115/server         /var/run/server_uds\r\n27009:unix  2      [ ]         STREAM     CONNECTING    0        -                   /var/run/server_uds\r\n27023:unix  2      [ ]         STREAM     CONNECTING    0        -                   /var/run/server_uds\r\n27024:unix  2      [ ]         STREAM     CONNECTING    0        -                   /var/run/server_uds\r\n27034:unix  2      [ ]         STREAM     CONNECTING    0        -                   /var/run/server_uds\r\n27035:unix  2      [ ]         STREAM     CONNECTING    0        -                   /var/run/server_uds\r\n\r\nThe only way to recover from the above state is to restart the server.\r\n\r\n### What am I expecting from this github issue?\r\n1. A fix which can recover the server even if \"Failed getpeername: Bad file descriptor\" is seen once\r\n2. Any inputs on how to really reproduce \"Failed getpeername: Bad file descriptor\" naturally. What else can I try other than restarting the client?\r\n\r\n### Anything else we should know about your project / environment?\r\n","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grpc/grpc/issues/35076/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grpc/grpc/issues/35076/timeline","performed_via_github_app":null,"state_reason":"completed"}