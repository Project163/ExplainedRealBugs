{"url":"https://api.github.com/repos/grpc/grpc/issues/35954","repository_url":"https://api.github.com/repos/grpc/grpc","labels_url":"https://api.github.com/repos/grpc/grpc/issues/35954/labels{/name}","comments_url":"https://api.github.com/repos/grpc/grpc/issues/35954/comments","events_url":"https://api.github.com/repos/grpc/grpc/issues/35954/events","html_url":"https://github.com/grpc/grpc/issues/35954","id":2145386561,"node_id":"I_kwDOAacf2M5_4ABB","number":35954,"title":"dscp value set through GRPC_ARG_DSCP channel argument does not cause the socket options to be updated on the GRPC server side.","user":{"login":"prakashbadri-arista","id":127355794,"node_id":"U_kgDOB5dLkg","avatar_url":"https://avatars.githubusercontent.com/u/127355794?v=4","gravatar_id":"","url":"https://api.github.com/users/prakashbadri-arista","html_url":"https://github.com/prakashbadri-arista","followers_url":"https://api.github.com/users/prakashbadri-arista/followers","following_url":"https://api.github.com/users/prakashbadri-arista/following{/other_user}","gists_url":"https://api.github.com/users/prakashbadri-arista/gists{/gist_id}","starred_url":"https://api.github.com/users/prakashbadri-arista/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prakashbadri-arista/subscriptions","organizations_url":"https://api.github.com/users/prakashbadri-arista/orgs","repos_url":"https://api.github.com/users/prakashbadri-arista/repos","events_url":"https://api.github.com/users/prakashbadri-arista/events{/privacy}","received_events_url":"https://api.github.com/users/prakashbadri-arista/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[{"id":155504842,"node_id":"MDU6TGFiZWwxNTU1MDQ4NDI=","url":"https://api.github.com/repos/grpc/grpc/labels/kind/bug","name":"kind/bug","color":"93732c","default":false,"description":null},{"id":166332908,"node_id":"MDU6TGFiZWwxNjYzMzI5MDg=","url":"https://api.github.com/repos/grpc/grpc/labels/lang/c++","name":"lang/c++","color":"fad8c7","default":false,"description":null},{"id":360790193,"node_id":"MDU6TGFiZWwzNjA3OTAxOTM=","url":"https://api.github.com/repos/grpc/grpc/labels/priority/P2","name":"priority/P2","color":"dd7172","default":false,"description":""},{"id":3940839694,"node_id":"LA_kwDOAacf2M7q5HEO","url":"https://api.github.com/repos/grpc/grpc/labels/untriaged","name":"untriaged","color":"c2e0c6","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"eugeneo","id":287917,"node_id":"MDQ6VXNlcjI4NzkxNw==","avatar_url":"https://avatars.githubusercontent.com/u/287917?v=4","gravatar_id":"","url":"https://api.github.com/users/eugeneo","html_url":"https://github.com/eugeneo","followers_url":"https://api.github.com/users/eugeneo/followers","following_url":"https://api.github.com/users/eugeneo/following{/other_user}","gists_url":"https://api.github.com/users/eugeneo/gists{/gist_id}","starred_url":"https://api.github.com/users/eugeneo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eugeneo/subscriptions","organizations_url":"https://api.github.com/users/eugeneo/orgs","repos_url":"https://api.github.com/users/eugeneo/repos","events_url":"https://api.github.com/users/eugeneo/events{/privacy}","received_events_url":"https://api.github.com/users/eugeneo/received_events","type":"User","user_view_type":"public","site_admin":false},"assignees":[{"login":"eugeneo","id":287917,"node_id":"MDQ6VXNlcjI4NzkxNw==","avatar_url":"https://avatars.githubusercontent.com/u/287917?v=4","gravatar_id":"","url":"https://api.github.com/users/eugeneo","html_url":"https://github.com/eugeneo","followers_url":"https://api.github.com/users/eugeneo/followers","following_url":"https://api.github.com/users/eugeneo/following{/other_user}","gists_url":"https://api.github.com/users/eugeneo/gists{/gist_id}","starred_url":"https://api.github.com/users/eugeneo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eugeneo/subscriptions","organizations_url":"https://api.github.com/users/eugeneo/orgs","repos_url":"https://api.github.com/users/eugeneo/repos","events_url":"https://api.github.com/users/eugeneo/events{/privacy}","received_events_url":"https://api.github.com/users/eugeneo/received_events","type":"User","user_view_type":"public","site_admin":false}],"milestone":null,"comments":2,"created_at":"2024-02-20T22:18:19Z","updated_at":"2024-02-23T18:38:37Z","closed_at":"2024-02-23T18:38:37Z","author_association":"NONE","type":null,"active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"What version of gRPC and what language are you using?\r\ngrpc C++ V1.60.0\r\n\r\nWhat operating system (Linux, Windows,...) and version?\r\nAlmaLinux 9\r\n\r\nI recently upgraded to v1.60.0 to use the GRPC_ARG_DSCP channel argument that was added as part of https://github.com/grpc/grpc/pull/28322. But I noticed that after adding the following change to server side code when initializing and starting the grpc service,\r\n\"\"\"\r\nbuilder.AddChannelArgument(GRPC_ARG_DSCP, dscp); \r\n\"\"\"\r\nThe tos value was not getting set in the stream channel packets sent from the server to the client.\r\n\r\nAfter looking at the grpc c++ core library code, I noticed that the \"PosixTcpOptions\" arg passed to PrepareSocket ( core/lib/event_engine/posix_engine/posix_engine_listener_utils.cc ) has the custom dscp value set. But there is no call to set dscp socket options inside the function. \r\n\r\n\"\"\"\r\nabsl::Status PrepareSocket(const PosixTcpOptions& options,\r\n                           ListenerSocket& socket) {\r\n  ....\r\n  GRPC_RETURN_IF_ERROR(socket.sock.SetSocketNonBlocking(1));\r\n  GRPC_RETURN_IF_ERROR(socket.sock.SetSocketCloexec(1));\r\n\r\n  if (socket.addr.address()->sa_family != AF_UNIX &&\r\n      !ResolvedAddressIsVSock(socket.addr)) {\r\n    GRPC_RETURN_IF_ERROR(socket.sock.SetSocketLowLatency(1));\r\n    GRPC_RETURN_IF_ERROR(socket.sock.SetSocketReuseAddr(1));\r\n    GRPC_RETURN_IF_ERROR(socket.sock.SetSocketDscp(options.dscp));\r\n    socket.sock.TrySetSocketTcpUserTimeout(options, false);\r\n  }\r\n  GRPC_RETURN_IF_ERROR(socket.sock.SetSocketNoSigpipeIfPossible());\r\n  GRPC_RETURN_IF_ERROR(socket.sock.ApplySocketMutatorInOptions(\r\n      GRPC_FD_SERVER_LISTENER_USAGE, options));\r\n\"\"\"  \r\n\r\nAdding \"GRPC_RETURN_IF_ERROR(socket.sock.SetSocketDscp(options.dscp));\" fixed the issue and I do see the tos value being set correctly in the outgoing packets from the server side. But I would like to get some confirmation if the fix is the right one and how this got missed in PR# 28322","closed_by":{"login":"copybara-service[bot]","id":56741989,"node_id":"MDM6Qm90NTY3NDE5ODk=","avatar_url":"https://avatars.githubusercontent.com/in/44061?v=4","gravatar_id":"","url":"https://api.github.com/users/copybara-service%5Bbot%5D","html_url":"https://github.com/apps/copybara-service","followers_url":"https://api.github.com/users/copybara-service%5Bbot%5D/followers","following_url":"https://api.github.com/users/copybara-service%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/copybara-service%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/copybara-service%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/copybara-service%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/copybara-service%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/copybara-service%5Bbot%5D/repos","events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/copybara-service%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/grpc/grpc/issues/35954/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/grpc/grpc/issues/35954/timeline","performed_via_github_app":null,"state_reason":"completed"}