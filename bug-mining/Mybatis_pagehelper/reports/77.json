{"url":"https://api.github.com/repos/pagehelper/Mybatis-PageHelper/issues/742","repository_url":"https://api.github.com/repos/pagehelper/Mybatis-PageHelper","labels_url":"https://api.github.com/repos/pagehelper/Mybatis-PageHelper/issues/742/labels{/name}","comments_url":"https://api.github.com/repos/pagehelper/Mybatis-PageHelper/issues/742/comments","events_url":"https://api.github.com/repos/pagehelper/Mybatis-PageHelper/issues/742/events","html_url":"https://github.com/pagehelper/Mybatis-PageHelper/issues/742","id":1695145015,"node_id":"I_kwDOATsemM5lCdw3","number":742,"title":"服务首次启动，并发场景下，偶发NPE异常","user":{"login":"homawu","id":13309284,"node_id":"MDQ6VXNlcjEzMzA5Mjg0","avatar_url":"https://avatars.githubusercontent.com/u/13309284?v=4","gravatar_id":"","url":"https://api.github.com/users/homawu","html_url":"https://github.com/homawu","followers_url":"https://api.github.com/users/homawu/followers","following_url":"https://api.github.com/users/homawu/following{/other_user}","gists_url":"https://api.github.com/users/homawu/gists{/gist_id}","starred_url":"https://api.github.com/users/homawu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/homawu/subscriptions","organizations_url":"https://api.github.com/users/homawu/orgs","repos_url":"https://api.github.com/users/homawu/repos","events_url":"https://api.github.com/users/homawu/events{/privacy}","received_events_url":"https://api.github.com/users/homawu/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2023-05-04T02:44:25Z","updated_at":"2023-11-02T12:44:54Z","closed_at":"2023-11-02T12:44:54Z","author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"- [x] 我已在 [issues](https://github.com/pagehelper/Mybatis-PageHelper/issues) 搜索类似问题，并且不存在相同的问题.\r\n\r\n## 异常模板\r\n\r\n### 使用环境\r\n\r\n* PageHelper 版本: 5.1.10\r\n* 数据库类型和版本: 5.7.26-30102-log\r\n* JDBC_URL: jdbc:mysql://xx.xx.xx:3306/xxdb?characterEncoding=UTF8&socketTimeout=60000&allowMultiQueries=true\r\n\r\n\r\n### 完整异常信息\r\n\r\n```\r\n[Encrypt]【查询员工信息】param:{\"type\":\"id\",\"ids\":[2481818508],\"entId\":5472009}\r\norg.mybatis.spring.MyBatisSystemException: nested exception is org.apache.ibatis.exceptions.PersistenceException: \r\n### Error querying database.  Cause: java.lang.NullPointerException\r\n### Cause: java.lang.NullPointerException\r\nat org.mybatis.spring.MyBatisExceptionTranslator.translateExceptionIfPossible(MyBatisExceptionTranslator.java:77)\r\nat org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:446)\r\nat com.sun.proxy.$Proxy185.selectList(Unknown Source)\r\nat org.mybatis.spring.SqlSessionTemplate.selectList(SqlSessionTemplate.java:230)\r\nat org.apache.ibatis.binding.MapperMethod.executeForMany(MapperMethod.java:139)\r\nat org.apache.ibatis.binding.MapperMethod.execute(MapperMethod.java:76)\r\nat org.apache.ibatis.binding.MapperProxy.invoke(MapperProxy.java:59)\r\nat com.sun.proxy.$Proxy191.queryByCondition(Unknown Source)\r\nat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\nat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\nat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\nat java.lang.reflect.Method.invoke(Method.java:497)\r\nat com.xxx.dao.AsyncMapperProxy.invoke(AsyncMapperProxy.java:67)\r\nat com.sun.proxy.$Proxy191.queryByCondition(Unknown Source)\r\nat com.xxx.yyy.service.inner.impl.EmployInfoServiceImpl.queryByCondition(EmployInfoServiceImpl.java:346)\r\nat com.xxx.yyy.service.inner.impl.EmployInfoServiceImpl$$FastClassBySpringCGLIB$$3f507d61.invoke(<generated>)\r\nat org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:204)\r\nat org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.invokeJoinpoint(CglibAopProxy.java:736)\r\nat org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:157)\r\nat org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke(ExposeInvocationInterceptor.java:92)\r\nat org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:179)\r\nat org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:671)\r\nat com.xxx.yyy.service.inner.impl.EmployInfoServiceImpl$$EnhancerBySpringCGLIB$$50a1d81a.queryByCondition(<generated>)\r\nat com.xxx.yyy.server.thrift.EmployInfoThriftServiceImpl.queryByCondition(EmployInfoThriftServiceImpl.java:444)\r\nat com.xxx.yyy.server.thrift.EmployInfoThriftServiceImpl$$FastClassBySpringCGLIB$$87624c37.invoke(<generated>)\r\nat org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:204)\r\nat org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.invokeJoinpoint(CglibAopProxy.java:736)\r\nat org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:157)\r\nat org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke(ExposeInvocationInterceptor.java:92)\r\nat org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:179)\r\nat org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:671)\r\nat com.xxx.yyy.server.thrift.EmployInfoThriftServiceImpl$$EnhancerBySpringCGLIB$$587ebeef.queryByCondition(<generated>)\r\nat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\nat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\nat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\nat java.lang.reflect.Method.invoke(Method.java:497)\r\nat com.xxx.service.mobile.thrift.proxy.ThriftServerInvoker.doInvoke(ThriftServerInvoker.java:363)\r\nat com.xxx.service.mobile.thrift.proxy.ThriftServerInvoker$1.handle(ThriftServerInvoker.java:389)\r\nat com.xxx.service.mobile.thrift.server.filter.AccessLogFilter.filter(AccessLogFilter.java:39)\r\nat com.xxx.dorado.rpc.handler.filter.InvokeChainBuilder$2.handle(InvokeChainBuilder.java:106)\r\nat com.xxx.service.mobile.thrift.server.filter.ServerRhinoLimiterFilter.filter(ServerRhinoLimiterFilter.java:73)\r\nat com.xxx.dorado.rpc.handler.filter.InvokeChainBuilder$2.handle(InvokeChainBuilder.java:106)\r\nat com.xxx.service.mobile.thrift.proxy.ThriftServerInvoker.invoke(ThriftServerInvoker.java:304)\r\nat com.sun.proxy.$Proxy285.queryByCondition(Unknown Source)\r\nat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\nat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\nat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\nat java.lang.reflect.Method.invoke(Method.java:497)\r\nat com.xxx.service.mobile.thrift.annotation.ThriftMethodProcessor.invokeMethod(ThriftMethodProcessor.java:174)\r\nat com.xxx.service.mobile.thrift.annotation.ThriftMethodProcessor.process(ThriftMethodProcessor.java:138)\r\nat com.xxx.service.mobile.thrift.proxy.ThriftServerPublisher$ThriftServiceProcessor.process(ThriftServerPublisher.java:642)\r\nat com.xxx.service.mobile.thrift.server.netty.DefaultServerHandler.handleRequest(DefaultServerHandler.java:273)\r\nat com.xxx.service.mobile.thrift.server.netty.DefaultServerHandler$1.run(DefaultServerHandler.java:164)\r\nat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\nat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\nat java.lang.Thread.run(Thread.java:745)\r\nCaused by: org.apache.ibatis.exceptions.PersistenceException: \r\n### Error querying database.  Cause: java.lang.NullPointerException\r\n### Cause: java.lang.NullPointerException\r\nat org.apache.ibatis.exceptions.ExceptionFactory.wrapException(ExceptionFactory.java:30)\r\nat org.apache.ibatis.session.defaults.DefaultSqlSession.selectList(DefaultSqlSession.java:150)\r\nat org.apache.ibatis.session.defaults.DefaultSqlSession.selectList(DefaultSqlSession.java:141)\r\nat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\nat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\nat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\nat java.lang.reflect.Method.invoke(Method.java:497)\r\nat org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:433)\r\n... 54 more\r\nCaused by: java.lang.NullPointerException\r\nat com.github.pagehelper.PageHelper.afterAll(PageHelper.java:118)\r\nat com.github.pagehelper.PageInterceptor.intercept(PageInterceptor.java:113)\r\nat org.apache.ibatis.plugin.Plugin.invoke(Plugin.java:61)\r\nat com.sun.proxy.$Proxy337.query(Unknown Source)\r\nat org.apache.ibatis.session.defaults.DefaultSqlSession.selectList(DefaultSqlSession.java:148)\r\n... 60 more\r\n```\r\n\r\n### 原因\r\nPageInterceptor类对象里面会初始化PageHelper(对应变量dialect)；\r\nPageHelper类对象里面会初始化PageAutoDialect(对应变量autoDialect)；\r\n\r\n1.由于采用的都是单例模式，服务启动时，假定有2个线程进入分页查询场景，分别是线程A和B；\r\n2.当线程A执行至初始化完PageHelper（dialect变量不为null），而PageHelper类尚未初始化完成（对应autoDialect变量）；\r\n3.线程B执行至以下代码时，由于dialect不为null，所以跳过，执行后续业务逻辑；\r\n```\r\nprivate void checkDialectExists() {\r\n        if (dialect == null) {\r\n            synchronized (default_dialect_class) {\r\n                if (dialect == null) {\r\n                    setProperties(new Properties());\r\n                }\r\n            }\r\n        }\r\n    }\r\n```\r\n4.当线程B执行至dialect.afterAll();这里，但线程A尚未初始化完PageHelper类时，就会出现NPE异常\r\n\r\n## 功能建议\r\n确保pageHelper.autoDialect变量初始化成功\r\n```\r\nprivate void checkDialectExists() {\r\n        if (dialect == null || pageHelper.autoDialect == null) {\r\n            synchronized (default_dialect_class) {\r\n                if (dialect == null || pageHelper.autoDialect == null {\r\n                    setProperties(new Properties());\r\n                }\r\n            }\r\n        }\r\n    }\r\n```\r\n","closed_by":{"login":"pagehelper","id":7838124,"node_id":"MDQ6VXNlcjc4MzgxMjQ=","avatar_url":"https://avatars.githubusercontent.com/u/7838124?v=4","gravatar_id":"","url":"https://api.github.com/users/pagehelper","html_url":"https://github.com/pagehelper","followers_url":"https://api.github.com/users/pagehelper/followers","following_url":"https://api.github.com/users/pagehelper/following{/other_user}","gists_url":"https://api.github.com/users/pagehelper/gists{/gist_id}","starred_url":"https://api.github.com/users/pagehelper/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pagehelper/subscriptions","organizations_url":"https://api.github.com/users/pagehelper/orgs","repos_url":"https://api.github.com/users/pagehelper/repos","events_url":"https://api.github.com/users/pagehelper/events{/privacy}","received_events_url":"https://api.github.com/users/pagehelper/received_events","type":"User","user_view_type":"public","site_admin":false},"reactions":{"url":"https://api.github.com/repos/pagehelper/Mybatis-PageHelper/issues/742/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pagehelper/Mybatis-PageHelper/issues/742/timeline","performed_via_github_app":null,"state_reason":"completed"}