{"url":"https://api.github.com/repos/pagehelper/Mybatis-PageHelper/issues/772","repository_url":"https://api.github.com/repos/pagehelper/Mybatis-PageHelper","labels_url":"https://api.github.com/repos/pagehelper/Mybatis-PageHelper/issues/772/labels{/name}","comments_url":"https://api.github.com/repos/pagehelper/Mybatis-PageHelper/issues/772/comments","events_url":"https://api.github.com/repos/pagehelper/Mybatis-PageHelper/issues/772/events","html_url":"https://github.com/pagehelper/Mybatis-PageHelper/issues/772","id":1928717599,"node_id":"I_kwDOATsemM5y9eUf","number":772,"title":"Could add smart count logic like Mybatis Plus in PageHelper Plugin?","user":{"login":"nikbobo","id":932343,"node_id":"MDQ6VXNlcjkzMjM0Mw==","avatar_url":"https://avatars.githubusercontent.com/u/932343?v=4","gravatar_id":"","url":"https://api.github.com/users/nikbobo","html_url":"https://github.com/nikbobo","followers_url":"https://api.github.com/users/nikbobo/followers","following_url":"https://api.github.com/users/nikbobo/following{/other_user}","gists_url":"https://api.github.com/users/nikbobo/gists{/gist_id}","starred_url":"https://api.github.com/users/nikbobo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nikbobo/subscriptions","organizations_url":"https://api.github.com/users/nikbobo/orgs","repos_url":"https://api.github.com/users/nikbobo/repos","events_url":"https://api.github.com/users/nikbobo/events{/privacy}","received_events_url":"https://api.github.com/users/nikbobo/received_events","type":"User","user_view_type":"public","site_admin":false},"labels":[],"state":"open","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2023-10-05T17:03:16Z","updated_at":"2023-10-31T15:40:40Z","closed_at":null,"author_association":"NONE","active_lock_reason":null,"sub_issues_summary":{"total":0,"completed":0,"percent_completed":0},"issue_dependencies_summary":{"blocked_by":0,"total_blocked_by":0,"blocking":0,"total_blocking":0},"body":"Could add smart count logic like Mybatis Plus in Page Helper Plugin?\r\nMybatis Plus has a logic which will get smarting but may not accurate sql by auto optimize left join, but Mybatis PageHelper Plugin not has that.\r\nWould you add it in plugin by optional option to enable or how to add it in plugin?\r\n\r\n可以添加智能 count sql 优化逻辑吗？\r\nMybatis Plus 有个智能的 count 优化逻辑，会优化 left join，虽然在一些情况下可能会导致不准确的分页，但大多数场景还是很好用的，可以在 Mybatis PageHelper Plugin 里面添加它吗？作为一个可选开启的选项。或者如何扩展/修改插件使它支持这个功能？\r\n\r\n参考代码\r\n```\r\n    /**\r\n     * 获取自动优化的 countSql\r\n     *\r\n     * @param page 参数\r\n     * @param sql  sql\r\n     * @return countSql\r\n     */\r\n    protected String autoCountSql(IPage<?> page, String sql) {\r\n        if (!page.optimizeCountSql()) {\r\n            return lowLevelCountSql(sql);\r\n        }\r\n        try {\r\n            Select select = (Select) JsqlParserGlobal.parse(sql);\r\n            SelectBody selectBody = select.getSelectBody();\r\n            // https://github.com/baomidou/mybatis-plus/issues/3920  分页增加union语法支持\r\n            if (selectBody instanceof SetOperationList) {\r\n                return lowLevelCountSql(sql);\r\n            }\r\n            PlainSelect plainSelect = (PlainSelect) select.getSelectBody();\r\n            Distinct distinct = plainSelect.getDistinct();\r\n            GroupByElement groupBy = plainSelect.getGroupBy();\r\n            List<OrderByElement> orderBy = plainSelect.getOrderByElements();\r\n\r\n            if (CollectionUtils.isNotEmpty(orderBy)) {\r\n                boolean canClean = true;\r\n                if (groupBy != null) {\r\n                    // 包含groupBy 不去除orderBy\r\n                    canClean = false;\r\n                }\r\n                if (canClean) {\r\n                    for (OrderByElement order : orderBy) {\r\n                        // order by 里带参数,不去除order by\r\n                        Expression expression = order.getExpression();\r\n                        if (!(expression instanceof Column) && expression.toString().contains(StringPool.QUESTION_MARK)) {\r\n                            canClean = false;\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n                if (canClean) {\r\n                    plainSelect.setOrderByElements(null);\r\n                }\r\n            }\r\n            //#95 Github, selectItems contains #{} ${}, which will be translated to ?, and it may be in a function: power(#{myInt},2)\r\n            for (SelectItem item : plainSelect.getSelectItems()) {\r\n                if (item.toString().contains(StringPool.QUESTION_MARK)) {\r\n                    return lowLevelCountSql(select.toString());\r\n                }\r\n            }\r\n            // 包含 distinct、groupBy不优化\r\n            if (distinct != null || null != groupBy) {\r\n                return lowLevelCountSql(select.toString());\r\n            }\r\n            // 包含 join 连表,进行判断是否移除 join 连表\r\n            if (optimizeJoin && page.optimizeJoinOfCountSql()) {\r\n                List<Join> joins = plainSelect.getJoins();\r\n                if (CollectionUtils.isNotEmpty(joins)) {\r\n                    boolean canRemoveJoin = true;\r\n                    String whereS = Optional.ofNullable(plainSelect.getWhere()).map(Expression::toString).orElse(StringPool.EMPTY);\r\n                    // 不区分大小写\r\n                    whereS = whereS.toLowerCase();\r\n                    for (Join join : joins) {\r\n                        if (!join.isLeft()) {\r\n                            canRemoveJoin = false;\r\n                            break;\r\n                        }\r\n                        FromItem rightItem = join.getRightItem();\r\n                        String str = \"\";\r\n                        if (rightItem instanceof Table) {\r\n                            Table table = (Table) rightItem;\r\n                            str = Optional.ofNullable(table.getAlias()).map(Alias::getName).orElse(table.getName()) + StringPool.DOT;\r\n                        } else if (rightItem instanceof SubSelect) {\r\n                            SubSelect subSelect = (SubSelect) rightItem;\r\n                            /* 如果 left join 是子查询，并且子查询里包含 ?(代表有入参) 或者 where 条件里包含使用 join 的表的字段作条件,就不移除 join */\r\n                            if (subSelect.toString().contains(StringPool.QUESTION_MARK)) {\r\n                                canRemoveJoin = false;\r\n                                break;\r\n                            }\r\n                            str = subSelect.getAlias().getName() + StringPool.DOT;\r\n                        }\r\n                        // 不区分大小写\r\n                        str = str.toLowerCase();\r\n\r\n                        if (whereS.contains(str)) {\r\n                            /* 如果 where 条件里包含使用 join 的表的字段作条件,就不移除 join */\r\n                            canRemoveJoin = false;\r\n                            break;\r\n                        }\r\n\r\n                        for (Expression expression : join.getOnExpressions()) {\r\n                            if (expression.toString().contains(StringPool.QUESTION_MARK)) {\r\n                                /* 如果 join 里包含 ?(代表有入参) 就不移除 join */\r\n                                canRemoveJoin = false;\r\n                                break;\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    if (canRemoveJoin) {\r\n                        plainSelect.setJoins(null);\r\n                    }\r\n                }\r\n            }\r\n            // 优化 SQL\r\n            plainSelect.setSelectItems(COUNT_SELECT_ITEM);\r\n            return select.toString();\r\n        } catch (JSQLParserException e) {\r\n            // 无法优化使用原 SQL\r\n            logger.warn(\"optimize this sql to a count sql has exception, sql:\\\"\" + sql + \"\\\", exception:\\n\" + e.getCause());\r\n        } catch (Exception e) {\r\n            logger.warn(\"optimize this sql to a count sql has error, sql:\\\"\" + sql + \"\\\", exception:\\n\" + e);\r\n        }\r\n        return lowLevelCountSql(sql);\r\n    }\r\n```\r\n\r\n相关文档描述\r\n```\r\n生成 countSql 会在 left join 的表不参与 where 条件的情况下,把 left join 优化掉\r\n所以建议任何带有 left join 的sql,都写标准sql,即给于表一个别名,字段也要 别名.字段\r\n```","closed_by":null,"reactions":{"url":"https://api.github.com/repos/pagehelper/Mybatis-PageHelper/issues/772/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"timeline_url":"https://api.github.com/repos/pagehelper/Mybatis-PageHelper/issues/772/timeline","performed_via_github_app":null,"state_reason":null}