<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:08:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[TIKA-3556] DefaultZipContainerDetector returns application/zip for .odt files when OPCPackageDetector is on the classpath</title>
                <link>https://issues.apache.org/jira/browse/TIKA-3556</link>
                <project id="12310631" key="TIKA">Tika</project>
                    <description>&lt;p&gt;This is happening because the&#160;OPCPackageDetector.detect method will &lt;a href=&quot;https://github.com/apache/tika/blob/2.1.0-rc2/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/detect/microsoft/ooxml/OPCPackageDetector.java#L257&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;fail and close the underlying zip stream&lt;/a&gt;. When the next detector runs (e.g. OpenDocumentDetector), the stream it receives has been closed and it won&apos;t be able to detect anything.&lt;/p&gt;

&lt;p&gt;After all detectors have effectively no-oped, &lt;a href=&quot;https://github.com/apache/tika/blob/2.1.0-rc2/tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-zip-commons/src/main/java/org/apache/tika/detect/zip/DefaultZipContainerDetector.java#L209&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the DefaultZipContainerDetector falls back to application/zip&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Now, when running with the default CompositeDetector, the next detector is usually the MimeTypes detector. This returns the proper&#160;application/vnd.oasis.opendocument.text, but the &lt;a href=&quot;https://github.com/apache/tika/blob/main/tika-core/src/main/java/org/apache/tika/detect/CompositeDetector.java#L86&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CompositeDetector will ignore&lt;/a&gt;&#160;it as that mime type isn&apos;t marked up as a subclass of application/zip in &lt;a href=&quot;https://github.com/apache/tika/blob/2.1.0-rc2/tika-core/src/main/resources/org/apache/tika/mime/tika-mimetypes.xml#L2327&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the registry&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In short, I think there are two bugs here potentially:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The OPCPacakageDetector either shouldn&apos;t close the zip while detecting or the DefaultZipContainerDetector should re-open if necessary?&lt;/li&gt;
	&lt;li&gt;The registry should be updated to mark up&#160;application/vnd.oasis.opendocument.text as a subclass of application/zip ?&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13401341">TIKA-3556</key>
            <summary>DefaultZipContainerDetector returns application/zip for .odt files when OPCPackageDetector is on the classpath</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="gaeremyncks">Simon Gaeremynck</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 Sep 2021 09:54:00 +0000</created>
                <updated>Mon, 4 Oct 2021 22:02:51 +0000</updated>
                                            <version>2.1.0</version>
                                                    <component>detector</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17415521" author="tallison@mitre.org" created="Wed, 15 Sep 2021 13:42:26 +0000"  >&lt;p&gt;Able to reproduce this. I&apos;m surprised our unit tests didn&apos;t catch this.  Adding new ones and fixing.  Thank you for opening this issue and diagnosing the bugs!&lt;/p&gt;</comment>
                            <comment id="17415531" author="tallison@mitre.org" created="Wed, 15 Sep 2021 14:04:10 +0000"  >&lt;p&gt;Wait, no, I was testing a bad odt file.  &lt;/p&gt;

&lt;p&gt;I agree with your point about the bugs.  I&apos;m trying to write a unit test to test for this, and I&apos;m seeing the zip detectors (in a unit test in tika-parsers-standard-package) in this order:&lt;/p&gt;

&lt;p&gt;IWorkDetector&lt;br/&gt;
IPADetector&lt;br/&gt;
JarDetector&lt;br/&gt;
KMZDetector&lt;br/&gt;
OpenDocumentDetector&lt;br/&gt;
StarOfficeDetector&lt;br/&gt;
OPCPackageDetector&lt;/p&gt;

&lt;p&gt;When run in this order the OpenDocumentDetector correctly identifies the file type,  and the ones after it are not called.&lt;/p&gt;

&lt;p&gt;To confirm, your detectors are in a different order (with OPCPackageDetector coming before OpenDocumentDetector)?&lt;/p&gt;

&lt;p&gt;I&apos;m wondering if we should sort them in the above order if they&apos;re available in addition to fixing the other bugs?&lt;/p&gt;

&lt;p&gt;I can write a unit test that uses a custom config to specify the order of the zip detectors, but can you share more info about what&apos;s on your classpath/which packages you&apos;re using/how you&apos;re building your detector?&lt;/p&gt;

&lt;p&gt;Thank you, again.&lt;/p&gt;</comment>
                            <comment id="17415533" author="tallison@mitre.org" created="Wed, 15 Sep 2021 14:05:44 +0000"  >&lt;p&gt;And then I see a TODO: &lt;tt&gt;//TODO: OPCBased needs to be last!!!&lt;/tt&gt;...  Ugh.&lt;/p&gt;</comment>
                            <comment id="17415541" author="tallison@mitre.org" created="Wed, 15 Sep 2021 14:14:52 +0000"  >&lt;p&gt;Other point I notice is that this only affects file-backed TikaInputStreams, apparently?&lt;/p&gt;

&lt;p&gt;Still, I prefer your suggested fixes, and it would be better if we didn&apos;t have to sort the detectors.&lt;/p&gt;</comment>
                            <comment id="17415549" author="gaeremyncks" created="Wed, 15 Sep 2021 14:26:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;To confirm, your detectors are in a different order (with OPCPackageDetector coming before OpenDocumentDetector)?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;That&apos;s right. The OPCPackageDetector was the very first detector that got loaded for me, preventing the other ones to do their thing. FWIW, I was running with the following minimal dependency configuration (sbt project):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
libraryDependencies ++= Seq(
	&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.tika&quot;&lt;/span&gt; % &lt;span class=&quot;code-quote&quot;&gt;&quot;tika-core&quot;&lt;/span&gt; % tikaVersion,
	&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.tika&quot;&lt;/span&gt; % &lt;span class=&quot;code-quote&quot;&gt;&quot;tika-parser-microsoft-module&quot;&lt;/span&gt; % tikaVersion
)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I also saw it in our main project which pulls in a couple more modules, but I guess it all depends on the order that the ServiceLoader returns. I&apos;d say that the order should be irrelevant really, should trying to detect a mimetype really destroy the underlying zip stream?&lt;/p&gt;

&lt;p&gt;When I was testing this locally, building a custom DefaultZipDetector with only the OPCPacakageDetecthr and OpenDocumentDetector (in that order) reproduces the bug too.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Other point I notice is that this only affects file-backed TikaInputStreams, apparently?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I wouldn&apos;t be able to comment. I&apos;ve only tested with files loaded through the class its classloader from the src/main/resources and passing that through Tika.detect.&lt;/p&gt;</comment>
                            <comment id="17415566" author="tallison@mitre.org" created="Wed, 15 Sep 2021 14:48:05 +0000"  >&lt;p&gt;Y, I agree on the above.  One unfortunate bit is that POI deep, deep down closes the ZipFile if there&apos;s an exception loading the OPCPackage.  So we&apos;ll have to figure out how to deal with that.&lt;/p&gt;</comment>
                            <comment id="17415626" author="tallison@mitre.org" created="Wed, 15 Sep 2021 16:23:37 +0000"  >&lt;p&gt;In addition to that (which is easily fixable), things get complicated with the open container added to the TikaInputStream and when to overwrite that.  If the OPCPackage arrives second, then it should overwrite the zipfile, but if zipFile arrives second, it shouldn&apos;t overwrite the open container.&lt;/p&gt;

&lt;p&gt;It would be simpler to add a sort to the DefaultZipContainer that guarantees that OPCPackage is always last.&lt;/p&gt;

&lt;p&gt;Separate topic, if we change all the odt to be subtypes of &lt;tt&gt;application/zip&lt;/tt&gt;, which we should do, we&apos;ll likely have to come up with a more elegant way of turning off OpenOffice parsing.  &lt;/p&gt;

&lt;p&gt;If someone wants to parse zip files, but doesn&apos;t want to parse a specialization of Zip, they can turn off that specialized parser, but then we allow backoff, and the file is parsed by the Zip parser, which means they have to exclude the parser and then also exclude every mime that is a subtype of zip, which is messy...  I&apos;m not sure what the best solution for that is, but it is not a small change.&lt;/p&gt;</comment>
                            <comment id="17424210" author="hudson" created="Mon, 4 Oct 2021 22:02:51 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Tika &#187; tika-main-jdk8 #331 (See &lt;a href=&quot;https://ci-builds.apache.org/job/Tika/job/tika-main-jdk8/331/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-builds.apache.org/job/Tika/job/tika-main-jdk8/331/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-3556&quot; title=&quot;DefaultZipContainerDetector returns application/zip for .odt files when OPCPackageDetector is on the classpath&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-3556&quot;&gt;TIKA-3556&lt;/a&gt; Fix Open Office mime types to be subclasses of application/zip (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/7b792811502bde32774c7562a60273455e5be575&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/7b792811502bde32774c7562a60273455e5be575&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(add) tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-miscoffice-module/src/test/resources/org/apache/tika/parser/odf/tika-config-detectors.xml&lt;/li&gt;
	&lt;li&gt;(edit) tika-core/src/main/resources/org/apache/tika/mime/tika-mimetypes.xml&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-zip-commons/src/main/java/org/apache/tika/detect/zip/DefaultZipContainerDetector.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-zip-commons/src/main/java/org/apache/tika/detect/zip/ZipContainerDetector.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-core/src/main/java/org/apache/tika/io/TikaInputStream.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/tika-parsers-standard/tika-parsers-standard-package/src/test/java/org/apache/tika/detect/TestContainerAwareDetector.java&lt;/li&gt;
	&lt;li&gt;(edit) CHANGES.txt&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-microsoft-module/src/main/java/org/apache/tika/detect/microsoft/ooxml/OPCPackageDetector.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-3556&quot; title=&quot;DefaultZipContainerDetector returns application/zip for .odt files when OPCPackageDetector is on the classpath&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-3556&quot;&gt;TIKA-3556&lt;/a&gt; add new subtype of zip to PackageParser and fix unit test (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/c03d6bebc3c6a7a1554021c5da8ce9014b2fda7c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/c03d6bebc3c6a7a1554021c5da8ce9014b2fda7c&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/tika-parsers-standard/tika-parsers-standard-package/src/test/java/org/apache/tika/detect/TestContainerAwareDetector.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-pkg-module/src/main/java/org/apache/tika/parser/pkg/PackageParser.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 5 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0uy9k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>