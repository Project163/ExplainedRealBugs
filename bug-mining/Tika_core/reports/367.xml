<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:08:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[TIKA-3919] Out of Memory during file parsing in AutoDetectParser</title>
                <link>https://issues.apache.org/jira/browse/TIKA-3919</link>
                <project id="12310631" key="TIKA">Tika</project>
                    <description>&lt;p&gt;Out of Memory during file parsing in AutoDetectParser. Issue is occurring in almost all newly created Microsoft Documents while parsing documents in parallel in different threads, seems there is an issue in parsing new documents &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;java.lang.OutOfMemoryError: Java heap space&lt;br/&gt;
&#160; &#160; at org.apache.tika.io.LookaheadInputStream.&amp;lt;init&amp;gt;(LookaheadInputStream.java:66)&lt;br/&gt;
&#160; &#160; at org.apache.tika.io.TikaInputStream.getPath(TikaInputStream.java:683)&lt;br/&gt;
&#160; &#160; at org.apache.tika.detect.microsoft.POIFSContainerDetector.getTopLevelNames(POIFSContainerDetector.java:467)&lt;br/&gt;
&#160; &#160; at org.apache.tika.detect.microsoft.POIFSContainerDetector.detect(POIFSContainerDetector.java:530)&lt;br/&gt;
&#160; &#160; at org.apache.tika.detect.CompositeDetector.detect(CompositeDetector.java:85)&lt;br/&gt;
&#160; &#160; at org.apache.tika.parser.AutoDetectParser.parse(AutoDetectParser.java:142)&lt;/p&gt;

&lt;p&gt;While testing load in our existing environment, which has been upgraded from tika version 1.28.1 to 2.4.1.&#160;&lt;/p&gt;

&lt;p&gt;The following file which is almost empty &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13051901/13051901_Model.xlsx&quot; title=&quot;Model.xlsx attached to TIKA-3919&quot;&gt;Model.xlsx&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&#160;had been parsed via client program multiple times via JMeter. Seems, we are getting Out of Memory due to a limit set &quot;markLimit = 134217728&quot;, but not sure.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13051900/13051900_Thread+dump.PNG&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13051898/13051898_Large+Object-1.PNG&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;OS : Windows 10,&lt;br/&gt;
Software Platform : Java&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</environment>
        <key id="13498040">TIKA-3919</key>
            <summary>Out of Memory during file parsing in AutoDetectParser</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="10005">Workaround</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="narendranss">Narendran Solai Sridharan</reporter>
                        <labels>
                    </labels>
                <created>Mon, 7 Nov 2022 06:41:08 +0000</created>
                <updated>Thu, 10 Nov 2022 07:52:05 +0000</updated>
                            <resolved>Thu, 10 Nov 2022 07:52:05 +0000</resolved>
                                    <version>2.4.1</version>
                                                    <component>detector</component>
                    <component>parser</component>
                    <component>tika-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17629792" author="tallison@mitre.org" created="Mon, 7 Nov 2022 12:31:51 +0000"  >&lt;p&gt;The LookaheadInputStream buffers the marklimit to memory.  So, if you don&apos;t give it as much memory as you request via the marklimit * the number of threads + overhead for Java, Tika and whatnot, you can blow out your memory.&lt;/p&gt;

&lt;p&gt;If you&apos;re calling Tika programmatically on local files, it is best to call TikaInputStream.get(File/Path) for the inputstream.&lt;/p&gt;</comment>
                            <comment id="17629793" author="tallison@mitre.org" created="Mon, 7 Nov 2022 12:33:39 +0000"  >&lt;p&gt;I can update the documentation on how to decrease the marklimit if you are not working from local files, but are processing streams, for example.&lt;/p&gt;</comment>
                            <comment id="17629810" author="tallison@mitre.org" created="Mon, 7 Nov 2022 13:14:37 +0000"  >&lt;p&gt;We could also modify the LookaheadInputStream to not allocate the marklimit by default.&lt;/p&gt;</comment>
                            <comment id="17629914" author="narendranss" created="Mon, 7 Nov 2022 16:56:59 +0000"  >&lt;p&gt;Thanks for the quick reply, AutoDetectParser is being used to &lt;b&gt;detect&lt;/b&gt; the content type to &lt;b&gt;parse&lt;/b&gt; and &lt;b&gt;index&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt;POIFSContainerDetector type is setting a hard limit for &quot;markLimit&quot; to be&#160;134217728, is there a way to set the limit from AutoDetectParser?&#160;&lt;/p&gt;

&lt;p&gt;Found that the issue is not occurring if the files are not Protected for DRM. if the files are protected by DRM, out of memory is occurring. For single document parsing for the same there is no issue.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17629993" author="tallison@mitre.org" created="Mon, 7 Nov 2022 19:37:16 +0000"  >&lt;p&gt;You can set the markLimit with this in your tika-config.xml:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  
&amp;lt;properties&amp;gt;
  &amp;lt;detectors&amp;gt;
    &amp;lt;detector class=&quot;org.gagravarr.tika.OggDetector&quot;/&amp;gt;
    &amp;lt;detector class=&quot;org.apache.tika.detect.apple.BPListDetector&quot;/&amp;gt;
    &amp;lt;detector class=&quot;org.apache.tika.detect.microsoft.POIFSContainerDetector&quot;&amp;gt;
      &amp;lt;params&amp;gt;
        &amp;lt;param name=&quot;markLimit&quot; type=&quot;int&quot;&amp;gt;10000&amp;lt;/param&amp;gt;
      &amp;lt;/params&amp;gt;
    &amp;lt;/detector&amp;gt;
    &amp;lt;detector class=&quot;org.apache.tika.detect.ole.MiscOLEDetector&quot;&amp;gt;
      &amp;lt;params&amp;gt;
        &amp;lt;param name=&quot;markLimit&quot; type=&quot;int&quot;&amp;gt;10000&amp;lt;/param&amp;gt;
      &amp;lt;/params&amp;gt;
    &amp;lt;/detector&amp;gt;
    &amp;lt;detector class=&quot;org.apache.tika.detect.zip.DefaultZipContainerDetector&quot;/&amp;gt;
    &amp;lt;detector class=&quot;org.apache.tika.mime.MimeTypes&quot;/&amp;gt;
  &amp;lt;/detectors&amp;gt;
&amp;lt;/properties&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17629999" author="tallison@mitre.org" created="Mon, 7 Nov 2022 20:00:52 +0000"  >&lt;p&gt;As I look at the code, I think we should use the BoundedInputStream instead of the LookaheadInputStream.  We should still allow users to set a &lt;tt&gt;markLimit&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Again, if you are parsing a local file, I strongly encourage opening the InputStream with TikaInputStream.get(path).  &lt;/p&gt;

&lt;p&gt;In our current code, if a user submits a TikaInputStream initialized with an InputStream (e.g. not a file), our POIFSContainerDetector tries to copy the stream to disk (up to markLimit) and MiscOLEDetector tries to copy it to disk (up to markLimit), and then the file is finally parsed.&lt;/p&gt;

&lt;p&gt;If a user submits a TikaInputStream from a file/path, the POIFSContainerDetector loads the POIFSFileSystem object into the TikaInputStream, and then it is reused by the MiscOLEDetector and the parser.&lt;/p&gt;</comment>
                            <comment id="17630002" author="tallison@mitre.org" created="Mon, 7 Nov 2022 20:02:06 +0000"  >&lt;p&gt;Further, if you are parsing enough files, you&apos;ll hit OOM eventually on some files.  You need to architect your system to handle this.  See: &lt;a href=&quot;https://cwiki.apache.org/confluence/display/TIKA/The+Robustness+of+Apache+Tika&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/TIKA/The+Robustness+of+Apache+Tika&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17630004" author="tallison@mitre.org" created="Mon, 7 Nov 2022 20:03:21 +0000"  >&lt;p&gt;All that said, we can do better in our codebase.  Let me swap the LookAheadInputStream with the BoundedInputStream and see if there are other ways we can make this more efficient.&lt;/p&gt;</comment>
                            <comment id="17630067" author="hudson" created="Mon, 7 Nov 2022 22:27:04 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Tika &#187; tika-main-jdk8 #903 (See &lt;a href=&quot;https://ci-builds.apache.org/job/Tika/job/tika-main-jdk8/903/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-builds.apache.org/job/Tika/job/tika-main-jdk8/903/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-3919&quot; title=&quot;Out of Memory during file parsing in AutoDetectParser&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-3919&quot;&gt;&lt;del&gt;TIKA-3919&lt;/del&gt;&lt;/a&gt; &amp;#8211; Use BoundedInputStream instead of LookaheadInputStream in TikaInputStream and in StreamingZipContainerDetector to improve memory usage. (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/b2e5df17cbf02e73733c0985ae47c6fc63af0a68&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/b2e5df17cbf02e73733c0985ae47c6fc63af0a68&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) tika-core/src/main/java/org/apache/tika/io/TikaInputStream.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-zip-commons/src/main/java/org/apache/tika/detect/zip/StreamingZipContainerDetector.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17630775" author="narendranss" created="Wed, 9 Nov 2022 06:27:12 +0000"  >&lt;p&gt;Unfortunately, local files are not parsed, streaming files are being parsed.&#160;&lt;/p&gt;

&lt;p&gt;The issue is only occurring in DRM protected DOC, XLS and PPT files. If the same document is unrestricted by DRM then load testing works fine, in such a case even the file size did not matter, large file also could be parsed and indexed properly. DRM protected files alone are creating OOM issue even a small sized one around 80 to 90 KB.&lt;/p&gt;

&lt;p&gt;Trying to set &quot;markLimit&quot; via configuration programmatically, will update my findings.&lt;/p&gt;</comment>
                            <comment id="17631499" author="narendranss" created="Thu, 10 Nov 2022 07:51:32 +0000"  >&lt;p&gt;Changing the configuration helped to avoid Out of Memory, please feel free close the issue, Thanks&lt;/p&gt;</comment>
                            <comment id="17631500" author="narendranss" created="Thu, 10 Nov 2022 07:52:05 +0000"  >&lt;p&gt;Changed the configuration&#160; as suggested helped&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13051898" name="Large Object-1.PNG" size="17317" author="narendranss" created="Mon, 7 Nov 2022 14:32:19 +0000"/>
                            <attachment id="13051901" name="Model.xlsx" size="79360" author="narendranss" created="Mon, 7 Nov 2022 14:35:19 +0000"/>
                            <attachment id="13051900" name="Thread dump.PNG" size="40652" author="narendranss" created="Mon, 7 Nov 2022 14:33:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1bdkw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>