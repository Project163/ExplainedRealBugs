<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 22:08:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[TIKA-3441] tika server stuck in loop trying to bind</title>
                <link>https://issues.apache.org/jira/browse/TIKA-3441</link>
                <project id="12310631" key="TIKA">Tika</project>
                    <description>&lt;p&gt;Tika seems to be stuck in a loop trying to bind. Please see the attached logs.&lt;br/&gt;
 It is also using a lot of CPU while doing that, so in an environment with horizontal scaling it causes other containers to spin up.&lt;/p&gt;

&lt;p&gt;This seems to happen from time to time to one of the multiple containers running, normally everything runs smoothly. &#160;&lt;/p&gt;

&lt;p&gt;Not sure why it fails to bind in the first place (it&apos;s running in docker).&lt;/p&gt;

&lt;p&gt;I suspect that it may be related to the fact that it is trying to bind very quickly.&lt;/p&gt;

&lt;p&gt;Ideas on how to debug this issue further are welcome.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;&lt;tt&gt;PID TTY STAT TIME COMMAND&lt;/tt&gt;&lt;br/&gt;
{{ 1 ? Ssl 2:54 java -jar /tika-server-1.25.jar -h 0.0.0.0 -spawnChild TIKA_CHILD_JVM_OPTS=-JXmx3g -JXX:+ExitOnOutOfMemoryError -status}}&lt;br/&gt;
{{ 127 ? Z 1:15 &lt;span class=&quot;error&quot;&gt;&amp;#91;tesseract&amp;#93;&lt;/span&gt; &amp;lt;defunct&amp;gt;}}&lt;br/&gt;
{{ 131 ? Z 1:31 &lt;span class=&quot;error&quot;&gt;&amp;#91;tesseract&amp;#93;&lt;/span&gt; &amp;lt;defunct&amp;gt;}}&lt;br/&gt;
{{ 139 ? Z 0:16 &lt;span class=&quot;error&quot;&gt;&amp;#91;tesseract&amp;#93;&lt;/span&gt; &amp;lt;defunct&amp;gt;}}&lt;br/&gt;
{{ 219 ? Z 40:20 &lt;span class=&quot;error&quot;&gt;&amp;#91;tesseract&amp;#93;&lt;/span&gt; &amp;lt;defunct&amp;gt;}}&lt;br/&gt;
{{ 324 ? Z 2:32 &lt;span class=&quot;error&quot;&gt;&amp;#91;tesseract&amp;#93;&lt;/span&gt; &amp;lt;defunct&amp;gt;}}&lt;br/&gt;
{{ 342 ? Z 0:09 &lt;span class=&quot;error&quot;&gt;&amp;#91;tesseract&amp;#93;&lt;/span&gt; &amp;lt;defunct&amp;gt;}}&lt;br/&gt;
{{ 343 ? Z 0:09 &lt;span class=&quot;error&quot;&gt;&amp;#91;tesseract&amp;#93;&lt;/span&gt; &amp;lt;defunct&amp;gt;}}&lt;br/&gt;
{{ 380 ? Z 0:00 &lt;span class=&quot;error&quot;&gt;&amp;#91;tesseract&amp;#93;&lt;/span&gt; &amp;lt;defunct&amp;gt;}}&lt;br/&gt;
{{ 430 ? Z 9:18 &lt;span class=&quot;error&quot;&gt;&amp;#91;tesseract&amp;#93;&lt;/span&gt; &amp;lt;defunct&amp;gt;}}&lt;br/&gt;
{{ 435 ? Z 4:52 &lt;span class=&quot;error&quot;&gt;&amp;#91;tesseract&amp;#93;&lt;/span&gt; &amp;lt;defunct&amp;gt;}}&lt;br/&gt;
{{ 446 ? Z 18:34 &lt;span class=&quot;error&quot;&gt;&amp;#91;tesseract&amp;#93;&lt;/span&gt; &amp;lt;defunct&amp;gt;}}&lt;br/&gt;
{{ 453 ? Z 22:33 &lt;span class=&quot;error&quot;&gt;&amp;#91;tesseract&amp;#93;&lt;/span&gt; &amp;lt;defunct&amp;gt;}}&lt;br/&gt;
{{ 461 ? Z 0:25 &lt;span class=&quot;error&quot;&gt;&amp;#91;tesseract&amp;#93;&lt;/span&gt; &amp;lt;defunct&amp;gt;}}&lt;br/&gt;
{{ 517 ? Z 4:35 &lt;span class=&quot;error&quot;&gt;&amp;#91;tesseract&amp;#93;&lt;/span&gt; &amp;lt;defunct&amp;gt;}}&lt;br/&gt;
{{ 526 ? Z 0:04 &lt;span class=&quot;error&quot;&gt;&amp;#91;tesseract&amp;#93;&lt;/span&gt; &amp;lt;defunct&amp;gt;}}&lt;br/&gt;
{{ 536 ? S 0:00 36:39}}&lt;br/&gt;
{{ 881708 pts/0 Ss 0:00 bash}}&lt;br/&gt;
{{ 883782 ? Sl 0:00 java -XX:+ExitOnOutOfMemoryError -Djava.awt.headless=true -cp /tika-server-1.25.jar org.apache.tika.server.TikaServerCli -h 0.0.0.0 TIKA_CHILD_JVM_OPTS=-JXmx3g -status --id ab854166-0a4b-4ecc-93a5-e4504d11e4e8}}&lt;br/&gt;
{{ 883801 pts/0 R+ 0:00 ps ax}}&lt;/p&gt;</environment>
        <key id="13382919">TIKA-3441</key>
            <summary>tika server stuck in loop trying to bind</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="zamf">Cristian Zamfir</reporter>
                        <labels>
                    </labels>
                <created>Wed, 9 Jun 2021 10:04:25 +0000</created>
                <updated>Thu, 17 Jun 2021 11:32:24 +0000</updated>
                            <resolved>Thu, 17 Jun 2021 11:32:24 +0000</resolved>
                                    <version>1.25</version>
                                    <fixVersion>2.0.0</fixVersion>
                    <fixVersion>1.27</fixVersion>
                                    <component>docker</component>
                    <component>server</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17359913" author="tallison@mitre.org" created="Wed, 9 Jun 2021 10:30:31 +0000"  >&lt;p&gt;Are you using 1.25 or 1.26? Is this fairly rare or easily reproducible?&lt;/p&gt;</comment>
                            <comment id="17359915" author="zamf" created="Wed, 9 Jun 2021 10:38:44 +0000"  >&lt;p&gt;Sorry, it is 1.25, I selected the wrong version above.&lt;/p&gt;

&lt;p&gt;It is not easy to reproduce, but on the other hand it is not super rare. I have seen it twice already in about a 7 days period where I have 1-6 containers running (depending on load).&#160;&lt;/p&gt;</comment>
                            <comment id="17359919" author="tallison@mitre.org" created="Wed, 9 Jun 2021 10:43:44 +0000"  >&lt;p&gt;Is there any logging before the infinite loops so we can see what might have brought it down initially?&lt;/p&gt;</comment>
                            <comment id="17359920" author="tallison@mitre.org" created="Wed, 9 Jun 2021 10:44:37 +0000"  >&lt;p&gt;&lt;del&gt;initially&lt;/del&gt; most recently&lt;/p&gt;</comment>
                            <comment id="17359927" author="tallison@mitre.org" created="Wed, 9 Jun 2021 10:52:46 +0000"  >&lt;p&gt;Is there any chance something like this is happening in your environment: &lt;a href=&quot;https://github.com/docker/for-linux/issues/1180&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/docker/for-linux/issues/1180&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17359936" author="tallison@mitre.org" created="Wed, 9 Jun 2021 10:56:33 +0000"  >&lt;p&gt;Or, I&#8217;m wondering if the OS is not cleaning up the port quickly enough, as it sounds like you suggested? At the least, we should put a pause after a failed restart if the port is bound. Ideally, we&#8217;d log the process that was binding to the port.&lt;/p&gt;</comment>
                            <comment id="17359955" author="zamf" created="Wed, 9 Jun 2021 11:16:28 +0000"  >&lt;p&gt;I attached the logs just before.&#160;Not sure if it is a coincidence, but it does happen after a parse timeout hits.&lt;/p&gt;</comment>
                            <comment id="17359989" author="zamf" created="Wed, 9 Jun 2021 11:20:53 +0000"  >&lt;p&gt;I would say that it is not an issue like the one you mentioned with docker. The container is not restarted, instead the Tika spawned child is restarted due to the timeout.&#160;&lt;/p&gt;

&lt;p&gt;Actually it is not clear why after a parse timeout it&apos;s not just the child that restarts, so the 9998 port should still be in use by the parent, is that right?&lt;/p&gt;</comment>
                            <comment id="17360009" author="tallison@mitre.org" created="Wed, 9 Jun 2021 11:53:17 +0000"  >&lt;p&gt;The port is used only by the child. The parent just monitors the sub process.&lt;/p&gt;

&lt;p&gt;To confirm, the event that triggered this chain was a child timeout?&lt;/p&gt;</comment>
                            <comment id="17360010" author="tallison@mitre.org" created="Wed, 9 Jun 2021 11:53:59 +0000"  >&lt;p&gt;Oops&#8230; sorry on phone and missed your earlier comment. That&#8217;ll help when I&#8217;m back to keyboard. Thank you!&lt;/p&gt;</comment>
                            <comment id="17360016" author="zamf" created="Wed, 9 Jun 2021 12:12:30 +0000"  >&lt;p&gt;A side question - if the parent process only monitors the child, I presume it&apos;s safe to assume that it does not need a lot of memory. Can I assume I only need 200MB for the parent?&lt;/p&gt;

&lt;p&gt;A pause after restart on bind issues looks like a good thing to have in any case. But the child restarts successfully e.g., on OOM without hitting this issues.&lt;/p&gt;

&lt;p&gt;For a docker setup I can solve it with a liveness check on the /status api endpoint, but it would be nice to also know more about the underlying issue causing this.&lt;/p&gt;</comment>
                            <comment id="17360072" author="tallison@mitre.org" created="Wed, 9 Jun 2021 13:33:39 +0000"  >&lt;p&gt;Sorry, I see the original logs you attached, but that&apos;s where the problem starts, right? &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2021-06-09T11:43:22.472293991+02:00 ERROR Could not start Jetty server on port 9,998: Failed to bind to /0.0.0.0:9998
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Was there a timeout before: 2021-06-09T11:43:21.647771746+02:00?&lt;/p&gt;</comment>
                            <comment id="17360075" author="zamf" created="Wed, 9 Jun 2021 13:37:38 +0000"  >&lt;p&gt;I attached now another file that somehow did not get attached before. The new logs show the first time the bind error happened.&lt;/p&gt;</comment>
                            <comment id="17360081" author="tallison@mitre.org" created="Wed, 9 Jun 2021 13:38:32 +0000"  >&lt;p&gt;Very helpful. Thank you!&lt;/p&gt;</comment>
                            <comment id="17360149" author="tallison@mitre.org" created="Wed, 9 Jun 2021 15:20:44 +0000"  >&lt;p&gt;I can&apos;t explain why the port was still in use.  My &lt;em&gt;guess&lt;/em&gt; is that the operating system hadn&apos;t yet released it.&lt;/p&gt;

&lt;p&gt;I did find a race condition in that the forked process writes &quot;success&quot; to the forking process before the server is successfully launched.  I&apos;ve fixed this in 1.x.&lt;/p&gt;

&lt;p&gt;I&apos;ve added a check for a bind exception, and the forking process will now retry on a bind exception 5 times (waiting 1 second between tries). &lt;/p&gt;

&lt;p&gt;This part of the code is quite different in 2.x, but I&apos;ll review that to see if we need to change anything there.&lt;/p&gt;

&lt;p&gt;I don&apos;t know if you&apos;re able to pull a snapshot version of 1.27 and try it out.  If you could, that&apos;d be great.&lt;/p&gt;</comment>
                            <comment id="17360150" author="tallison@mitre.org" created="Wed, 9 Jun 2021 15:21:54 +0000"  >&lt;p&gt;&amp;gt;Can I assume I only need 200MB for the parent?&lt;/p&gt;

&lt;p&gt;yes.&lt;/p&gt;</comment>
                            <comment id="17360151" author="tallison@mitre.org" created="Wed, 9 Jun 2021 15:22:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ndipiazza_gmail&quot; class=&quot;user-hover&quot; rel=&quot;ndipiazza_gmail&quot;&gt;ndipiazza_gmail&lt;/a&gt;, have you seen this?  You&apos;re working with the 2.x branch, right?&lt;/p&gt;</comment>
                            <comment id="17360155" author="tallison@mitre.org" created="Wed, 9 Jun 2021 15:26:29 +0000"  >&lt;p&gt;I&apos;m wondering if the spawned/abandoned tesseract processes are keeping the port open?&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;What may be happening is that your process had a TCP port open when it crashed or otherwise exited without explicitly closing it. Normally the OS cleans up these sorts of things, but only when the process record goes away. While the process may not appear to be running any more, there is at least one thing that can keep a record of it around, in order to prevent reuse of its PID. This is the existence of a child process that is not detached from the parent.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://serverfault.com/questions/181015/how-do-you-free-up-a-port-being-held-open-by-dead-process&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://serverfault.com/questions/181015/how-do-you-free-up-a-port-being-held-open-by-dead-process&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17360174" author="ndipiazza" created="Wed, 9 Jun 2021 16:02:57 +0000"  >&lt;p&gt;No we have not seen this. We do not have a huge amount of people using the Tesseract though.&#160;&lt;/p&gt;

&lt;p&gt;I have still been primarily working on Tika 1.x.&#160;&lt;/p&gt;

&lt;p&gt;I could try to reproduce.&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zamf&quot; class=&quot;user-hover&quot; rel=&quot;zamf&quot;&gt;zamf&lt;/a&gt;&#160;can you clarify some more what are the exact steps to reproduce? From the existing details in the ticket I&apos;m having a hard time understand what your exact steps are to reproduce.&lt;/p&gt;</comment>
                            <comment id="17360188" author="hudson" created="Wed, 9 Jun 2021 16:33:20 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Tika &#187; tika-branch1x-jdk8 #134 (See &lt;a href=&quot;https://ci-builds.apache.org/job/Tika/job/tika-branch1x-jdk8/134/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-builds.apache.org/job/Tika/job/tika-branch1x-jdk8/134/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-3441&quot; title=&quot;tika server stuck in loop trying to bind&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-3441&quot;&gt;&lt;del&gt;TIKA-3441&lt;/del&gt;&lt;/a&gt; &amp;#8211; prevent infinite loop on failure to bind to a port (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/fd98eeefc968b7e564d5446ae774f7f1f21aed93&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/fd98eeefc968b7e564d5446ae774f7f1f21aed93&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) tika-server/src/main/java/org/apache/tika/server/TikaServerCli.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-server/src/main/java/org/apache/tika/server/TikaServerWatchDog.java&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-3441&quot; title=&quot;tika server stuck in loop trying to bind&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-3441&quot;&gt;&lt;del&gt;TIKA-3441&lt;/del&gt;&lt;/a&gt; &amp;#8211; improve likelihood that tesseract processes will be shutdown on crash. (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/d7fa2cd284a0d400a1ef29f7111018bb16b1cc5d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/d7fa2cd284a0d400a1ef29f7111018bb16b1cc5d&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/ocr/TesseractOCRParser.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17360201" author="zamf" created="Wed, 9 Jun 2021 16:56:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tallison&quot; class=&quot;user-hover&quot; rel=&quot;tallison&quot;&gt;tallison&lt;/a&gt;&#160;- unfortunately there is no container built for 1.27 available un hub.docker.com so it makes it harder to reproduce. I will upgrade to 1.26 though.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tallison&quot; class=&quot;user-hover&quot; rel=&quot;tallison&quot;&gt;tallison&lt;/a&gt;&#160;- I think the defunct tesseract processes could explain it. Since they were lingering there for a while, looks like the solution is to explicitly kill them.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ndipiazza&quot; class=&quot;user-hover&quot; rel=&quot;ndipiazza&quot;&gt;ndipiazza&lt;/a&gt;&#160;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I am using the docker image&#160;apache/tika:latest-full&#160;(side note: this appears to be 1.25 instead of 1.26, but most likely the intention is to use 1.26 in latest).&lt;/li&gt;
	&lt;li&gt;The custom parameters (can also be seen in the environment field in Jira) are:&#160;-spawnChild TIKA_CHILD_JVM_OPTS=-JXmx3g -JXX:+ExitOnOutOfMemoryError -status&quot;&lt;/li&gt;
	&lt;li&gt;To reproduce, &#160;just feed it a lot of files. In this particular case the issue appeared after a few hours and after a parse timeout error. That timeout caused a restart of the tika child which then got the bind error.&lt;/li&gt;
	&lt;li&gt;Tesseract is enabled using the default settings in the apache docker image.&lt;/li&gt;
	&lt;li&gt;I mentioned some other environment factors like k8s horizontal scaling, you can scrape that, I am pretty sure that this is an issue with the OS keeping the port open so the issue can manifest with a single tika docker container.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17360226" author="tallison@mitre.org" created="Wed, 9 Jun 2021 17:14:40 +0000"  >&lt;p&gt;Let me see if I can reproduce locally.  The changes I made should help some, and we can add a shutdown hook, but I don&#8217;t think there&#8217;s a way around an os&#8217;s oom killer, for example. Still, we should do what we can.&lt;/p&gt;</comment>
                            <comment id="17360338" author="zamf" created="Wed, 9 Jun 2021 20:22:48 +0000"  >&lt;p&gt;I caught another instance of this issue happening and&#160;killed this defunct process in the container:&lt;br/&gt;
 &lt;tt&gt;&#160; &#160;2498 ? &#160; &#160; &#160; &#160;Z &#160; &#160; &#160;0:00 &lt;span class=&quot;error&quot;&gt;&amp;#91;jspawnhelper&amp;#93;&lt;/span&gt; &amp;lt;defunct&amp;gt;&lt;/tt&gt;&lt;br/&gt;
 &#160;and after that, the child process was able to get past the bind error.&lt;br/&gt;
 &#160;&lt;/p&gt;</comment>
                            <comment id="17360806" author="tallison@mitre.org" created="Thu, 10 Jun 2021 11:40:08 +0000"  >&lt;p&gt;On Ubuntu 20.04.2 LTS, with openjdk version &quot;1.8.0_292&quot; and &quot;openjdk version &apos;14.0.2&apos; 2020-07-14&quot;, and the 1.25 server, the tesseract processes are orphaned, but the restart is able to reclaim the port.  Obv, we want to 1) prevent orphaning tesseract to the best of our ability and 2) we absolutely need to prevent infinite loops when the port can&apos;t be bound, but I&apos;m wondering if we should experiment with different OS images for our docker container so that orphaned processes don&apos;t prevent port binding?&lt;/p&gt;</comment>
                            <comment id="17360815" author="tallison@mitre.org" created="Thu, 10 Jun 2021 11:49:50 +0000"  >&lt;p&gt;Nope...that&apos;s what we&apos;re already using in our image... &amp;lt;face_palm/&amp;gt;&lt;/p&gt;</comment>
                            <comment id="17360854" author="zamf" created="Thu, 10 Jun 2021 12:36:32 +0000"  >&lt;p&gt;It does not reproduce that easily. Among 6 containers each having several tens of restarts per day, I only saw this issue 3 times.&#160;&lt;/p&gt;</comment>
                            <comment id="17360994" author="tallison@mitre.org" created="Thu, 10 Jun 2021 14:58:25 +0000"  >&lt;p&gt;I&apos;ve added shutdown hooks to TesseractOCRParser so that if the jvm shuts itself down, that should prevent orphaned tesseract processes. &lt;/p&gt;

&lt;p&gt;I was still able to orphan tesseract processes if I &lt;tt&gt;kill -9&lt;/tt&gt;&apos;d the forked process.  I&apos;m not sure how to handle that.&lt;/p&gt;

&lt;p&gt;I was not able to reproduce the infinite loop, but, as you said that should be rare.&lt;/p&gt;

&lt;p&gt;As mentioned above, I added code to prevent infinite loops on failed restart.  So, if there is a failure to bind within 10 seconds (we should make that configurable?).  The tika-server won&apos;t restart.&lt;/p&gt;

&lt;p&gt;I added a waitFor(10 seconds) in the forking process before forcibly destroying child process.  This should increase the chances that the child process will terminate itself and thereby clean up orphanable tesseract processes.&lt;/p&gt;

&lt;p&gt;I noticed there was resource leakage in the child process&apos;s shutdown hooks.  With each restart, another shutdown hook was added.  The code intended to remove the previous and then add a new.  That was not working, which means that there were 20464 thread objects in the shutdown hook map in the attached logs.  This is working now.&lt;/p&gt;</comment>
                            <comment id="17361012" author="tallison@mitre.org" created="Thu, 10 Jun 2021 15:13:41 +0000"  >&lt;p&gt;After the addition of the shutdownhooks in TesseractOCRParser (e.g. when you migrate to 1.27), you should NOT use &lt;tt&gt;-JXX:+ExitOnOutOfMemoryError&lt;/tt&gt; because this shutsdown the jvm without calling the shutdownhooks and tesseract will be orphaned.&lt;/p&gt;</comment>
                            <comment id="17361045" author="hudson" created="Thu, 10 Jun 2021 15:57:46 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Tika &#187; tika-branch1x-jdk8 #135 (See &lt;a href=&quot;https://ci-builds.apache.org/job/Tika/job/tika-branch1x-jdk8/135/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-builds.apache.org/job/Tika/job/tika-branch1x-jdk8/135/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-3441&quot; title=&quot;tika server stuck in loop trying to bind&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-3441&quot;&gt;&lt;del&gt;TIKA-3441&lt;/del&gt;&lt;/a&gt; &amp;#8211; improve likelihood that tesseract processes will be shutdown on jvm restart. (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/1224f881a1dc54282281cdf2fc9ecf3f3e429393&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/1224f881a1dc54282281cdf2fc9ecf3f3e429393&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) CHANGES.txt&lt;/li&gt;
	&lt;li&gt;(edit) tika-parsers/src/main/java/org/apache/tika/parser/ocr/TesseractOCRParser.java&lt;/li&gt;
	&lt;li&gt;(add) tika-core/src/main/java/org/apache/tika/parser/AbstractExternalProcessParser.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-server/src/test/java/org/apache/tika/server/TikaServerIntegrationTest.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-server/src/main/java/org/apache/tika/server/TikaServerWatchDog.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17361066" author="tallison@mitre.org" created="Thu, 10 Jun 2021 16:26:27 +0000"  >&lt;p&gt;I made the changes in &lt;tt&gt;main&lt;/tt&gt;, and the results look decent.&lt;/p&gt;</comment>
                            <comment id="17361069" author="tallison@mitre.org" created="Thu, 10 Jun 2021 16:29:03 +0000"  >&lt;p&gt;With the exception of this gem with Java 14:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;WARN  [qtp1256893889-32] 12:27:19,572 org.eclipse.jetty.server.HttpChannel /rmeta
java.lang.NoClassDefFoundError: Could not initialize class java.io.DeleteOnExitHook
	at java.io.File.deleteOnExit(File.java:1094) ~[?:?]
	at org.apache.cxf.helpers.FileUtils.createTmpDir(FileUtils.java:161) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.helpers.FileUtils.getDefaultTempDir(FileUtils.java:88) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.helpers.FileUtils.createTempFile(FileUtils.java:269) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.helpers.FileUtils.createTempFile(FileUtils.java:263) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.io.CachedOutputStream.createFileOutputStream(CachedOutputStream.java:475) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.io.CachedOutputStream.enforceLimits(CachedOutputStream.java:437) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.io.CachedOutputStream.write(CachedOutputStream.java:445) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.helpers.IOUtils.copy(IOUtils.java:193) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.helpers.IOUtils.copy(IOUtils.java:146) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.io.DelegatingInputStream.cacheInput(DelegatingInputStream.java:54) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.transport.http.AbstractHTTPDestination$1.cacheInput(AbstractHTTPDestination.java:321) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.transport.http.AbstractHTTPDestination.cacheInput(AbstractHTTPDestination.java:600) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.transport.http.AbstractHTTPDestination.flushHeaders(AbstractHTTPDestination.java:622) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.transport.http_jetty.JettyHTTPDestination.flushHeaders(JettyHTTPDestination.java:272) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.transport.http.AbstractHTTPDestination$WrappedOutputStream.close(AbstractHTTPDestination.java:784) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.transport.AbstractConduit.close(AbstractConduit.java:56) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.transport.http.AbstractHTTPDestination$BackChannelConduit.close(AbstractHTTPDestination.java:722) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.interceptor.MessageSenderInterceptor$MessageSenderEndingInterceptor.handleMessage(MessageSenderInterceptor.java:63) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.phase.PhaseInterceptorChain.doIntercept(PhaseInterceptorChain.java:308) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.interceptor.OutgoingChainInterceptor.handleMessage(OutgoingChainInterceptor.java:90) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.phase.PhaseInterceptorChain.doIntercept(PhaseInterceptorChain.java:308) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.transport.ChainInitiationObserver.onMessage(ChainInitiationObserver.java:121) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.transport.http.AbstractHTTPDestination.invoke(AbstractHTTPDestination.java:265) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.transport.http_jetty.JettyHTTPDestination.doService(JettyHTTPDestination.java:247) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.apache.cxf.transport.http_jetty.JettyHTTPHandler.handle(JettyHTTPHandler.java:79) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:127) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.eclipse.jetty.server.handler.ScopedHandler.nextHandle(ScopedHandler.java:235) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.eclipse.jetty.server.handler.ContextHandler.doHandle(ContextHandler.java:1435) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.eclipse.jetty.server.handler.ScopedHandler.nextScope(ScopedHandler.java:190) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.eclipse.jetty.server.handler.ContextHandler.doScope(ContextHandler.java:1350) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.eclipse.jetty.server.handler.ScopedHandler.handle(ScopedHandler.java:141) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.eclipse.jetty.server.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:191) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.eclipse.jetty.server.handler.HandlerWrapper.handle(HandlerWrapper.java:127) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.eclipse.jetty.server.Server.handle(Server.java:516) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.eclipse.jetty.server.HttpChannel.lambda$handle$1(HttpChannel.java:388) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.eclipse.jetty.server.HttpChannel.dispatch(HttpChannel.java:633) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.eclipse.jetty.server.HttpChannel.handle(HttpChannel.java:380) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.eclipse.jetty.server.HttpConnection.onFillable(HttpConnection.java:277) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.eclipse.jetty.io.AbstractConnection$ReadCallback.succeeded(AbstractConnection.java:311) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:105) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.eclipse.jetty.io.ChannelEndPoint$1.run(ChannelEndPoint.java:104) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.runTask(EatWhatYouKill.java:336) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.doProduce(EatWhatYouKill.java:313) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.tryProduce(EatWhatYouKill.java:171) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.eclipse.jetty.util.thread.strategy.EatWhatYouKill.produce(EatWhatYouKill.java:135) ~[tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:882) [tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at org.eclipse.jetty.util.thread.QueuedThreadPool$Runner.run(QueuedThreadPool.java:1036) [tika-server-standard-2.0.0-SNAPSHOT.jar:2.0.0-SNAPSHOT]
	at java.lang.Thread.run(Thread.java:832) [?:?]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17361133" author="hudson" created="Thu, 10 Jun 2021 18:03:46 +0000"  >&lt;p&gt;SUCCESS: Integrated in Jenkins build Tika &#187; tika-main-jdk8 #258 (See &lt;a href=&quot;https://ci-builds.apache.org/job/Tika/job/tika-main-jdk8/258/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-builds.apache.org/job/Tika/job/tika-main-jdk8/258/&lt;/a&gt;)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/TIKA-3441&quot; title=&quot;tika server stuck in loop trying to bind&quot; class=&quot;issue-link&quot; data-issue-key=&quot;TIKA-3441&quot;&gt;&lt;del&gt;TIKA-3441&lt;/del&gt;&lt;/a&gt; &amp;#8211; increase chances that TesseractOCRParser will not orphan tesseract process and ensure that tika-server never enters an infinite loop on a bind exception. (tallison: &lt;a href=&quot;https://github.com/apache/tika/commit/51fb33f3067bda551905056110bcf251d4bb3d23&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/tika/commit/51fb33f3067bda551905056110bcf251d4bb3d23&lt;/a&gt;)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;(edit) tika-parsers/tika-parsers-standard/tika-parsers-standard-modules/tika-parser-ocr-module/src/main/java/org/apache/tika/parser/ocr/TesseractOCRParser.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-server/tika-server-core/src/main/java/org/apache/tika/server/core/TikaServerWatchDog.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-core/src/main/java/org/apache/tika/pipes/PipesClient.java&lt;/li&gt;
	&lt;li&gt;(add) tika-core/src/main/java/org/apache/tika/parser/AbstractExternalProcessParser.java&lt;/li&gt;
	&lt;li&gt;(edit) tika-server/tika-server-core/src/main/java/org/apache/tika/server/core/TikaServerProcess.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="13026587" name="bind_issue.txt" size="635725" author="zamf" created="Wed, 9 Jun 2021 09:50:23 +0000"/>
                            <attachment id="13026605" name="logs_before.txt" size="12194" author="zamf" created="Wed, 9 Jun 2021 13:36:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 22 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0rsow:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>