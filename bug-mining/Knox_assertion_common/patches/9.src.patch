diff --git a/gateway-provider-identity-assertion-common/src/main/java/org/apache/hadoop/gateway/identityasserter/common/filter/IdentityAsserterHttpServletRequestWrapper.java b/gateway-provider-identity-assertion-common/src/main/java/org/apache/hadoop/gateway/identityasserter/common/filter/IdentityAsserterHttpServletRequestWrapper.java
index 2a2d9d94c..961fef791 100644
--- a/gateway-provider-identity-assertion-common/src/main/java/org/apache/hadoop/gateway/identityasserter/common/filter/IdentityAsserterHttpServletRequestWrapper.java
+++ b/gateway-provider-identity-assertion-common/src/main/java/org/apache/hadoop/gateway/identityasserter/common/filter/IdentityAsserterHttpServletRequestWrapper.java
@@ -74,36 +74,56 @@ private static SpiGatewayMessages log = MessagesFactory.get( SpiGatewayMessages.
   @SuppressWarnings("rawtypes")
   @Override
   public Map getParameterMap() {
-    return getParams();
+    Map map = null;
+    try {
+      map = getParams();
+    } catch (UnsupportedEncodingException e) {
+      log.unableToGetParamsFromQueryString(e);
+    }
+    return map;
   }
 
   @SuppressWarnings({ "unchecked", "rawtypes" })
   @Override
   public Enumeration getParameterNames() {
-    Map<String, String[]> params = getParams();
-    if (params == null) {
-      params = new HashMap<>();
+    Enumeration<String> e = null;
+    Map<String, List<String>> params;
+    try {
+      params = getParams();
+      if (params == null) {
+        params = new HashMap<>();
+      }
+      e = Collections.enumeration((Collection<String>) params.keySet());
+    } catch (UnsupportedEncodingException e1) {
+      log.unableToGetParamsFromQueryString(e1);
     }
-    Enumeration<String> e = Collections.enumeration((Collection<String>) params.keySet());
 
     return e;
   }
 
   @Override
   public String[] getParameterValues(String name) {
-    Map<String, String[]> params = getParams();
-    if (params == null) {
-      params = new HashMap<>();
+    String[] p = null;
+    Map<String, List<String>> params;
+    try {
+      params = getParams();
+      if (params == null) {
+        params = new HashMap<>();
+      }
+      p = (String[]) params.get(name).toArray();
+    } catch (UnsupportedEncodingException e) {
+      log.unableToGetParamsFromQueryString(e);
     }
 
-    return params.get(name);
+    return p;
   }
 
-  private Map<String, String[]> getParams( String qString ) {
-    Map<String, String[]> params = null;
+  private Map<String, List<String>> getParams( String qString )
+      throws UnsupportedEncodingException {
+    Map<String, List<String>> params = null;
     if (getMethod().equals("GET")) {
       if (qString != null && qString.length() > 0) {
-        params = HttpUtils.parseQueryString( qString );
+        params = HttpUtils.splitQuery( qString );
       }
       else {
         params = new HashMap<>();
@@ -114,43 +134,47 @@ private static SpiGatewayMessages log = MessagesFactory.get( SpiGatewayMessages.
         return null;
       }
       else {
-        params = HttpUtils.parseQueryString( qString );
+        params = HttpUtils.splitQuery( qString );
       }
     }  
     return params;
   }
 
-  private Map<String, String[]> getParams() {
+  private Map<String, List<String>> getParams()
+      throws UnsupportedEncodingException {
     return getParams( super.getQueryString() );
   }
 
   @Override
   public String getQueryString() {
     String q = null;
-    Map<String, String[]> params = getParams();
+    Map<String, List<String>> params;
+    try {
+      params = getParams();
+      if (params == null) {
+        params = new HashMap<>();
+      }
+      ArrayList<String> al = new ArrayList<String>();
+      al.add(username);
 
-    if (params == null) {
-      params = new HashMap<>();
-    }
-    
-    ArrayList<String> al = new ArrayList<String>();
-    al.add(username);
-    String[] a = { "" };
+      List<String> principalParamNames = getImpersonationParamNames();
+      params = scrubOfExistingPrincipalParams(params, principalParamNames);
 
-    List<String> principalParamNames = getImpersonationParamNames();
-    params = scrubOfExistingPrincipalParams(params, principalParamNames);
+      if ("true".equals(System.getProperty(GatewayConfig.HADOOP_KERBEROS_SECURED))) {
+        params.put(DOAS_PRINCIPAL_PARAM, al);
+      } else {
+        params.put(PRINCIPAL_PARAM, al);
+      }
 
-    if ("true".equals(System.getProperty(GatewayConfig.HADOOP_KERBEROS_SECURED))) {
-      params.put(DOAS_PRINCIPAL_PARAM, al.toArray(a));
-    } else {
-      params.put(PRINCIPAL_PARAM, al.toArray(a));
+      String encoding = getCharacterEncoding();
+      if (encoding == null) {
+        encoding = Charset.defaultCharset().name();
+      }
+      q = urlEncode(params, encoding);
+    } catch (UnsupportedEncodingException e) {
+      log.unableToGetParamsFromQueryString(e);
     }
 
-    String encoding = getCharacterEncoding();
-    if (encoding == null) {
-      encoding = Charset.defaultCharset().name();
-    }
-    q = urlEncode(params, encoding);
     return q;
   }
 
@@ -165,8 +189,8 @@ private static SpiGatewayMessages log = MessagesFactory.get( SpiGatewayMessages.
     return principalParamNames;
   }
 
-  private Map<String, String[]> scrubOfExistingPrincipalParams(
-      Map<String, String[]> params, List<String> principalParamNames) {
+  private Map<String, List<String>> scrubOfExistingPrincipalParams(
+      Map<String, List<String>> params, List<String> principalParamNames) {
     HashSet<String> remove = new HashSet<>();
     for (String paramKey : params.keySet()) {
       for (String p : principalParamNames) {
@@ -202,7 +226,7 @@ private static SpiGatewayMessages log = MessagesFactory.get( SpiGatewayMessages.
         encoding = Charset.defaultCharset().name();
       }
       String body = IOUtils.toString( super.getInputStream(), encoding );
-      Map<String, String[]> params = getParams( body );
+      Map<String, List<String>> params = getParams( body );
       if (params == null) {
         params = new HashMap<>();
       }
@@ -222,17 +246,17 @@ private static SpiGatewayMessages log = MessagesFactory.get( SpiGatewayMessages.
     }
   }
 
-  public static String urlEncode( Map<String, String[]> map, String encoding ) {
+  public static String urlEncode( Map<String, List<String>> map, String encoding ) {
     StringBuilder sb = new StringBuilder();
-    for( Map.Entry<String,String[]> entry : map.entrySet() ) {
+    for( Map.Entry<String,List<String>> entry : map.entrySet() ) {
       String name = entry.getKey();
       if( name != null && name.length() > 0 ) {
-        String[] values = entry.getValue();
-        if( values == null || values.length == 0 ) {
+        List<String> values = entry.getValue();
+        if( values == null || values.size() == 0 ) {
           sb.append( entry.getKey() );
         } else {
-          for( int i = 0; i < values.length; i++ ) {
-            String value = values[ i ];
+          for( int i = 0; i < values.size(); i++ ) {
+            String value = values.get(i);
               if( sb.length() > 0 ) {
                 sb.append( "&" );
               }
diff --git a/gateway-provider-identity-assertion-common/src/test/java/org/apache/hadoop/gateway/identityasserter/filter/IdentityAssertionHttpServletRequestWrapperTest.java b/gateway-provider-identity-assertion-common/src/test/java/org/apache/hadoop/gateway/identityasserter/filter/IdentityAssertionHttpServletRequestWrapperTest.java
index b026fc0e1..709c6e413 100644
--- a/gateway-provider-identity-assertion-common/src/test/java/org/apache/hadoop/gateway/identityasserter/filter/IdentityAssertionHttpServletRequestWrapperTest.java
+++ b/gateway-provider-identity-assertion-common/src/test/java/org/apache/hadoop/gateway/identityasserter/filter/IdentityAssertionHttpServletRequestWrapperTest.java
@@ -30,7 +30,10 @@ import org.junit.experimental.categories.Category;
 
 import java.io.ByteArrayInputStream;
 import java.io.IOException;
+import java.util.ArrayList;
+import java.util.Arrays;
 import java.util.HashMap;
+import java.util.List;
 
 import static org.hamcrest.MatcherAssert.assertThat;
 import static org.hamcrest.Matchers.containsString;
@@ -245,7 +248,7 @@ public class IdentityAssertionHttpServletRequestWrapperTest {
   @Test
   public void testUrlEncode() {
     String s;
-    HashMap<String,String[]> m;
+    HashMap<String,List<String>> m;
 
     m = new HashMap<>();
     m.put( "null-values", null );
@@ -253,17 +256,22 @@ public class IdentityAssertionHttpServletRequestWrapperTest {
     assertThat( s, is( "null-values" ) );
 
     m = new HashMap<>();
-    m.put( "no-values", new String[0] );
+    m.put( "no-values", new ArrayList<String>(0) );
     s = IdentityAsserterHttpServletRequestWrapper.urlEncode( m, "UTF-8" );
     assertThat( s, is( "no-values" ) );
 
     m = new HashMap<>();
-    m.put( "one-value", new String[]{ "value1" } );
+    List<String> lst = new ArrayList<String>();
+    lst.add("value1");
+    m.put( "one-value", lst);
     s = IdentityAsserterHttpServletRequestWrapper.urlEncode( m, "UTF-8" );
     assertThat( s, is( "one-value=value1" ) );
 
     m = new HashMap<>();
-    m.put( "two-values", new String[]{ "value1", "value2" } );
+    lst = new ArrayList<String>();
+    String[] a = {"value1", "value2"};
+    lst.addAll(Arrays.asList(a));
+    m.put( "two-values", lst);
     s = IdentityAsserterHttpServletRequestWrapper.urlEncode( m, "UTF-8" );
     assertThat( s, is( "two-values=value1&two-values=value2" ) );
   }
