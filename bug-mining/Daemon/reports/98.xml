<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:45:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DAEMON-401] Environment variables set on service not available in JNI dll</title>
                <link>https://issues.apache.org/jira/browse/DAEMON-401</link>
                <project id="12310468" key="DAEMON">Commons Daemon</project>
                    <description>&lt;p&gt;I have a JNI dll loaded by a Java process running as a Windows service on Windows 2019 using prunsrv. The JNI library is built with VC14, and makes calls to getenv(), which is imported from&#160;ucrtbase.dll.&lt;/p&gt;

&lt;p&gt;This call to getenv does not pick up environment variables that are set on the service via&#160;//US//Service&#160;++Environment &quot;key=value&quot;. Commons Daemon is setting these environment variables using _wputenv(), which is imported from msvcrt.dll.&lt;/p&gt;

&lt;p&gt;I started a discussion on the mailing list regarding this. I have patch which dynamically loads ucrtbase.dll and calls its _wputenv method as well, if it is available.&lt;/p&gt;

&lt;p&gt;I&apos;m happy to provide changes or further patches, and work on this issue, but feedback would be useful and very much appreciated.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13228864">DAEMON-401</key>
            <summary>Environment variables set on service not available in JNI dll</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jgallimore">Jonathan Gallimore</reporter>
                        <labels>
                    </labels>
                <created>Thu, 18 Apr 2019 13:41:14 +0000</created>
                <updated>Tue, 3 Sep 2019 21:32:41 +0000</updated>
                            <resolved>Tue, 3 Sep 2019 21:32:40 +0000</resolved>
                                                    <fixVersion>1.1.1</fixVersion>
                    <fixVersion>1.2.1</fixVersion>
                                        <due></due>
                            <votes>2</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16825565" author="markt" created="Wed, 24 Apr 2019 23:15:01 +0000"  >&lt;p&gt;Do you see the same issue if you use the Windows binaries provided by Apache Commons?&lt;/p&gt;

&lt;p&gt;We deliberately do no build directly from Visual Studio since that creates dependencies on runtime libraries that may not be present on the target system and we&apos;d like to avoid the added complexity of shipping those runtime dependencies.&lt;/p&gt;

&lt;p&gt;We haven&apos;t done a great job documenting the build process. That is something we can look to improve in the next release. The build environment is essentially the same as Apache Tomcat:&lt;br/&gt;
 &lt;a href=&quot;https://cwiki.apache.org/confluence/display/TOMCAT/Building+the+native+Tomcat+components+for+Windows&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/TOMCAT/Building+the+native+Tomcat+components+for+Windows&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Once that is set up, building is:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
C:\cmsc\setenv.bat /x64
nmake -f Makefile&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16831654" author="markt" created="Thu, 2 May 2019 14:07:41 +0000"  >&lt;p&gt;This issue does not&#160;occur when the Windows binaries are&#160;built with the&#160;intended build tools. (See my previous comment for details.)&lt;/p&gt;</comment>
                            <comment id="16831657" author="jgallimore" created="Thu, 2 May 2019 14:19:36 +0000"  >&lt;p&gt;Hi Mark&lt;/p&gt;

&lt;p&gt;Thanks for the followup and apologies for my delayed reply. Thanks for the build environment information; I should be able to replicate that setup on my hardware, and I&apos;m happy to expand on any documentation.&lt;/p&gt;

&lt;p&gt;Did you manage to test the issue? Reproducing it is tricky - I did try the binaries from the project. I&apos;m able to set the environment variables, and they are picked up in Java code in the JVM - everything is good there.&lt;/p&gt;

&lt;p&gt;If the JVM then calls out to a JNI&#160;library that is built with a later version of Visual Studio (MSVC 14 in my case), and that JNI dll uses getenv(), the issue is visible.&#160;Using a JNI library compiled with earlier versions of Visual Studio, or MinGW doesn&apos;t show the issue.&lt;/p&gt;

&lt;p&gt;In an ideal world, I&apos;d recompile the JNI library, but I don&apos;t have control over that or its dependencies.&lt;/p&gt;

&lt;p&gt;If I produce a test case, could I get some pointers with regard to my patch, or discuss some potential work-arounds?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;

&lt;p&gt;Jon&lt;/p&gt;</comment>
                            <comment id="16831902" author="markt" created="Thu, 2 May 2019 19:35:01 +0000"  >&lt;p&gt;Re-opening&#160;in light of new&#160;information.&lt;/p&gt;

&lt;p&gt;The patch looks reasonable. The only change I&apos;d request is that you use LoadLibraryExA and limit the search path to the system32 directory.&lt;/p&gt;</comment>
                            <comment id="16832019" author="jgallimore" created="Thu, 2 May 2019 21:53:10 +0000"  >&lt;p&gt;Thank you Mark! I&apos;ll update the patch and attach a test case. I really appreciate the feedback.&lt;/p&gt;</comment>
                            <comment id="16839279" author="jgallimore" created="Tue, 14 May 2019 10:01:26 +0000"  >&lt;p&gt;I&apos;ve attached an updated patch for this - this checks that the function &quot;SetDefaultDllDirectories&quot; is available in kernel32.dll before attempting to use&#160;LOAD_LIBRARY_SEARCH_SYSTEM32 in LoadLibraryExA.&lt;/p&gt;

&lt;p&gt;If this isn&apos;t available, it still checks for ucrtbase.dll by using the full path name to the System32 directory - I guess its possible that ucrtbase.dll could be present while&#160;KB2533623 might not be installed. Happy to remove this though.&lt;/p&gt;

&lt;p&gt;I included the constant for&#160;LOAD_LIBRARY_SEARCH_SYSTEM32 in apxwin.h, as it didn&apos;t appear to be in the standard build setup (or I&apos;ve missed it!).&lt;/p&gt;

&lt;p&gt;Also attached is my test case - a simple webapp with a JSP that accesses a class with a native method that calls getenv(). The nativeenv.dll is X64, built with VC14 and shows the issue. The JNI source code is in there too. I&apos;ve tried the exes I&apos;ve built with Windows XP x64 and Windows Server 2019. Happy to test with other flavours as well, particularly if there is a standard set of tests that we run.&lt;/p&gt;

&lt;p&gt;PS - the build setup instructions were great - they worked an absolute treat. I believe I&apos;m reproducing the executable in the same way as the common build - the headers from dumpbin seem to confirm that.&lt;/p&gt;</comment>
                            <comment id="16846177" author="markt" created="Wed, 22 May 2019 19:28:20 +0000"  >&lt;p&gt;Many thanks for the research on this issue and the patch.&lt;/p&gt;

&lt;p&gt;I applied a slightly simplified variation&#160;after testing it on Windows 7,&#160;Server 2016 and Server 2019.&lt;/p&gt;</comment>
                            <comment id="16846608" author="jgallimore" created="Thu, 23 May 2019 10:18:01 +0000"  >&lt;p&gt;Thank you very much for the reviews, feedback and applying the patch!&lt;/p&gt;</comment>
                            <comment id="16918340" author="markt" created="Thu, 29 Aug 2019 07:03:45 +0000"  >&lt;p&gt;I&apos;m re-opening this because this fix is triggering crashes on 32-bit platforms.&lt;/p&gt;

&lt;p&gt;See&#160;&lt;a href=&quot;https://bz.apache.org/bugzilla/show_bug.cgi?id=63625&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bz.apache.org/bugzilla/show_bug.cgi?id=63625&lt;/a&gt;&#160;for more info.&lt;/p&gt;

&lt;p&gt;Need to dig into exactly what memory is corrupted and how it is corrupted for some clues as to what is going on.&lt;/p&gt;</comment>
                            <comment id="16918468" author="jgallimore" created="Thu, 29 Aug 2019 10:06:59 +0000"  >&lt;p&gt;Thanks for re-opening. I&apos;ll take a look here as well.&lt;/p&gt;</comment>
                            <comment id="16919467" author="jgallimore" created="Fri, 30 Aug 2019 11:46:49 +0000"  >&lt;p&gt;In a debugger here, the `dllJvmPath` pointer appears to get corrupted during the call to `wputenv_ucrt`. The knock from that is that the call to `LoadLibraryExW` then fails. I can&apos;t see anything obviously wrong in `apxAddToPathW` at the moment, but I&apos;ll keep digging.&lt;/p&gt;</comment>
                            <comment id="16921736" author="markt" created="Tue, 3 Sep 2019 21:32:41 +0000"  >&lt;p&gt;Fixed. See&#160;&lt;a href=&quot;https://bz.apache.org/bugzilla/show_bug.cgi?id=63625&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bz.apache.org/bugzilla/show_bug.cgi?id=63625&lt;/a&gt;&#160;for analysis of root cause.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12968662" name="daemon-1.diff" size="3154" author="jgallimore" created="Tue, 14 May 2019 09:49:56 +0000"/>
                            <attachment id="12966370" name="daemon-env.diff" size="1308" author="jgallimore" created="Thu, 18 Apr 2019 13:44:49 +0000"/>
                            <attachment id="12968663" name="simple-jni.zip" size="24997" author="jgallimore" created="Tue, 14 May 2019 09:50:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 10 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z01xd4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>