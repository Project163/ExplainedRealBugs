<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:46:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DAEMON-437] prunsrv: Better not to redirect stdout/stderr during service installation?</title>
                <link>https://issues.apache.org/jira/browse/DAEMON-437</link>
                <project id="12310468" key="DAEMON">Commons Daemon</project>
                    <description>&lt;p&gt;I observed the following behavior when using prunsrv:&lt;/p&gt;

&lt;p&gt;I call it with //IS//MyService and more arguments to install a Tomcat service. Especially I use the default LocalSystem user as the user who will run the installed service and the arguments:&lt;/p&gt;

&lt;p&gt;&#160;&#160;&#160; --StdOutput auto ^&lt;br/&gt;
&#160;&#160;&#160; --StdError auto ^&lt;/p&gt;

&lt;p&gt;to redirect stdout and stderr to the default files.&lt;/p&gt;

&lt;p&gt;To install the service I use a user with Administrator privileges. Running prunsrv to install the service now already creates the redirected stdout and stderr files, but only writable by Administrator.&lt;/p&gt;

&lt;p&gt;When I start the service after this service installation, it can not write to the redirected stdout and stderr files, because it runs as a lower privileged LocalSystem account.&lt;/p&gt;

&lt;p&gt;Before calling redirectStdStreams() in apps/prunsrv/prunsrv.c, there is already a special case if prunsrv was called with //TS (Run Service as console application):&lt;/p&gt;

&lt;p&gt;1692&#160;&#160;&#160;&#160; /* In debug mode allways use console */&lt;br/&gt;
1693&#160;&#160;&#160;&#160; if (lpCmdline-&amp;gt;dwCmdIndex != 1)&lt;br/&gt;
1694&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; gStdwrap.szStdOutFilename = SO_STDOUTPUT;&lt;br/&gt;
1695&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; gStdwrap.szStdErrFilename = SO_STDERROR;&lt;br/&gt;
1696&#160;&#160;&#160;&#160; }&lt;/p&gt;

&lt;p&gt;I wonder, whether it wouldn&apos;t be better to not set the redirection file names for other dwCmdIndex values as well. Here&apos;s the list of indexes from the source code:&lt;/p&gt;

&lt;p&gt;&#160; 76&#160;&#160;&#160;&#160; L&quot;RS&quot;,&#160;&#160;&#160;&#160;&#160; /* 2 Run Service */&lt;br/&gt;
&#160; 77&#160;&#160;&#160;&#160; L&quot;ES&quot;,&#160;&#160;&#160;&#160;&#160; /* 3 Execute start */&lt;br/&gt;
&#160; 78&#160;&#160;&#160;&#160; L&quot;SS&quot;,&#160;&#160;&#160;&#160;&#160; /* 4 Stop Service */&lt;br/&gt;
&#160; 79&#160;&#160;&#160;&#160; L&quot;US&quot;,&#160;&#160;&#160;&#160;&#160; /* 5 Update Service parameters */&lt;br/&gt;
&#160; 80&#160;&#160;&#160;&#160; L&quot;IS&quot;,&#160;&#160;&#160;&#160;&#160; /* 6 Install Service */&lt;br/&gt;
&#160; 81&#160;&#160;&#160;&#160; L&quot;DS&quot;,&#160;&#160;&#160;&#160;&#160; /* 7 Delete Service */&lt;br/&gt;
&#160; 82&#160;&#160;&#160;&#160; L&quot;?&quot;,&#160;&#160;&#160;&#160;&#160;&#160; /* 8 Help */&lt;br/&gt;
&#160; 83&#160;&#160;&#160;&#160; L&quot;VS&quot;,&#160;&#160;&#160;&#160;&#160; /* 9 Version */&lt;/p&gt;

&lt;p&gt;IMHO 5-9 are candidates, maybe 4 and 3 as well. At least for those I would expect that they were executed on the console and stdout/stderr would also be expected there. But I might not be aware of use cases with other needs.&lt;/p&gt;

&lt;p&gt;The normal prunsrv log file does have the same permission problem. But since it contains log info about what action had been done, I am not so sure, whether one can simply write that to stdout instead. But maybe one could use a different default file name line MyService.manage.2021-12-07.log instead of MyService.2021-12-07.log for the above indexes. Not nice, but I don&apos;t have a better idea yet.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13424635">DAEMON-437</key>
            <summary>prunsrv: Better not to redirect stdout/stderr during service installation?</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rainer.jung@kippdata.de">Rainer Jung</reporter>
                        <labels>
                    </labels>
                <created>Tue, 25 Jan 2022 09:17:01 +0000</created>
                <updated>Thu, 10 Mar 2022 17:30:04 +0000</updated>
                            <resolved>Thu, 10 Mar 2022 17:30:04 +0000</resolved>
                                    <version>1.2.4</version>
                                    <fixVersion>1.3.0</fixVersion>
                                    <component>prunsrv</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17482569" author="markt" created="Wed, 26 Jan 2022 15:30:40 +0000"  >&lt;p&gt;I&apos;m currently thinking the same as you. Anything other than RS shouldn&apos;t redirect. Assuming we make this change, we can clarify the behaviour in the documentation as well.&lt;/p&gt;</comment>
                            <comment id="17483278" author="markt" created="Thu, 27 Jan 2022 17:14:06 +0000"  >&lt;p&gt;Another reason to limit this to RS occurred to me. It we keep the redirection enabled for any other commands and the service is running we&apos;ll have two processes trying to write to the same file which is never a good idea.&lt;/p&gt;

&lt;p&gt;I am going to proceed with limiting this to just RS along with documentation updates as appropriate.&lt;/p&gt;</comment>
                            <comment id="17483384" author="markt" created="Thu, 27 Jan 2022 18:58:38 +0000"  >&lt;p&gt;FYI - a review of the docs didn&apos;t identify any updates required.&lt;/p&gt;</comment>
                            <comment id="17484641" author="markt" created="Mon, 31 Jan 2022 12:30:47 +0000"  >&lt;p&gt;Re-open to discuss what to do with the prunsrv log file&lt;/p&gt;</comment>
                            <comment id="17484647" author="markt" created="Mon, 31 Jan 2022 12:42:17 +0000"  >&lt;p&gt;Looking at the source code, the issue of multiple processes writing to the prunsrv log file shouldn&apos;t be an issue unless multiple users are trying to run commands at the same time. The changes to handle that use case would be significant and I&apos;m not proposing we support that.&lt;/p&gt;

&lt;p&gt;So, think we have two choices. Drop the prunsrv log entirely and just use stdout/stderr. That would mean losing the log of actions taken which I think would be a step backwards. The other option is to configure the log file to allow the service user to write to it. I think that is the way to go.&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                            <comment id="17484656" author="rainer.jung@kippdata.de" created="Mon, 31 Jan 2022 13:07:03 +0000"  >&lt;p&gt;I do like the log as an action protocol. And I do not think it would be important to make it safe for concurrent use.&lt;br/&gt;
But: there is a conceptional problem when using configuration flags in combination with the //IS action to install a service. Those flags IMHO are getting used for the service AND also for the execution of the //IS action itself. That doesn&apos;t matter for most switches, unfortunately for the --Log* flags it dies matter. I see no way of setting the log for the //IS action different from what the service used - except for editing the service manually after the //IS execution. That&apos;s why I thought about using a different default log file name for service execution versus the interactive actions. But that still doesn&apos;t solve the conflicting uses of the --Log* flags for interactive commands versus the installed service &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17501259" author="markt" created="Fri, 4 Mar 2022 10:53:55 +0000"  >&lt;p&gt;I am currently working on the permissions issue. It turned out to be a little more complex that I first thought. I am currently implementing a solution that grants the specified user read, write &amp;amp; execute permissions to the logs directory (with inheritance enabled) any time the service user is specified/changed. That should address the permissions issues as best we can.&lt;/p&gt;

&lt;p&gt;Separating logs for configuration changes and starting/stopping the service is a separate issue and probably needs to be discussed as such. I&apos;m not sure it makes sense to separate these. The service will log using whatever mechanism the daemonized Java app is configured to use. I&apos;m beginning to think having all the Commons Daemon specific logging (installation, configuration, start,&#160; stop) in a single log makes more sense. I&apos;m thinking of the following sequence:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;install&lt;/li&gt;
	&lt;li&gt;configure&lt;/li&gt;
	&lt;li&gt;fail to start due to config error&lt;/li&gt;
	&lt;li&gt;fix config&lt;/li&gt;
	&lt;li&gt;start&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think having the daemon logs for all of that in one log file would be easier to follow.&lt;/p&gt;

&lt;p&gt;I intend to resolve this issue once the permissions issue is addressed. The separating logs issue should move to a new issue.&lt;/p&gt;</comment>
                            <comment id="17501368" author="garydgregory" created="Fri, 4 Mar 2022 14:56:08 +0000"  >&lt;p&gt;I do like the idea of one log file. &lt;/p&gt;</comment>
                            <comment id="17504466" author="markt" created="Thu, 10 Mar 2022 17:30:04 +0000"  >&lt;p&gt;I&apos;ve fixed the permissions issues. Setting / changing the service user will grant that user access to the logging directory.&lt;/p&gt;

&lt;p&gt;The issue of separate log files should be raised as an enhancement in a new issue.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13426790">DAEMON-438</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 35 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0yx7k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>