<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:46:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DAEMON-398] Java 11 jvm.dll startup messages not available on stdout/stderr using Windows 10/2016</title>
                <link>https://issues.apache.org/jira/browse/DAEMON-398</link>
                <project id="12310468" key="DAEMON">Commons Daemon</project>
                    <description>&lt;p&gt;&lt;b&gt;Steps to reproduce&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Install Java 11&lt;/li&gt;
	&lt;li&gt;Install prunsrv.exe using jvm.dll and specify stdout and stderr file.&lt;/li&gt;
	&lt;li&gt;Using prunmgr, add a Java Option &apos;-invalid&apos;&lt;/li&gt;
	&lt;li&gt;Start the service&lt;/li&gt;
	&lt;li&gt;stdout and stderr files are empty!&lt;/li&gt;
	&lt;li&gt;Install Java 10&lt;/li&gt;
	&lt;li&gt;Using prunmgr, switch the Java Virtual Machine to Java 10&lt;/li&gt;
	&lt;li&gt;Start the service&lt;/li&gt;
	&lt;li&gt;&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;stderr&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;
Java HotSpot(TM) 64-Bit Server VM warning: Ignoring option MaxPermSize; support was removed in 8.0
Unrecognized option: -invalid
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;b&gt;Analysis&lt;/b&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;It works for Java 8, 9 and 10, fails for 11, 12 and 13-ea.&lt;/li&gt;
	&lt;li&gt;I followed this guide: &lt;a href=&quot;https://jdebp.eu/FGA/redirecting-standard-io.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Redirecting standard I/O from within a program&lt;/a&gt; (see &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12964570/12964570_set-stdout.patch&quot; title=&quot;set-stdout.patch attached to DAEMON-398&quot;&gt;set-stdout.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;), but it didn&apos;t help.&lt;/li&gt;
	&lt;li&gt;Even when I compile prunsrv with Visual Studio 2017 15.9 (linker 14.16) and test with Java 13-ea, which is also compiled with the same version (hence using the same C-runtime library) it does not work.&lt;/li&gt;
	&lt;li&gt;The guide ends with what the probably causing the issue:
&lt;blockquote&gt;&lt;p&gt;... the one problem that remains with redirecting Win32 file handles:&lt;br/&gt;
 It doesn&apos;t affect anything in the program using a different C runtime library (such as a third-party DLL, for example).&lt;/p&gt;&lt;/blockquote&gt;&lt;/li&gt;
	&lt;li&gt;Setting registry value Log/LogJniMessages=1, which is using the &lt;tt&gt;vfprintf&lt;/tt&gt; option of the &lt;a href=&quot;https://docs.oracle.com/en/java/javase/11/docs/specs/jni/invocation.html#jni_createjavavm&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JNI_CreateJavaVM&lt;/a&gt; does not help. Maybe because is is added after the user-specified Java Options?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;Ideas&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Make &lt;tt&gt;vfprintf&lt;/tt&gt; the first parameter&lt;br/&gt;
 Downside of &lt;tt&gt;vfprintf&lt;/tt&gt; is that it is hard to distinct between stdout and stderr. Maybe make a JNI call to &lt;tt&gt;System.out&lt;/tt&gt; and &lt;tt&gt;System.err&lt;/tt&gt; to be able to recognize the &lt;tt&gt;*File&lt;/tt&gt; pointer and map to stdout and stderr accordingly.&lt;br/&gt;
 And I think that &lt;tt&gt;javajni.c/apxJavaSetOut()&lt;/tt&gt; should not be required.&lt;/li&gt;
	&lt;li&gt;Log a bug for OpenJDK and try to get it fixed.&lt;/li&gt;
&lt;/ol&gt;


&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;OS&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Daemon version (built with)&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Java vendor and version (built with)&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Result&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Windows 7&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.1.x HEAD (9.00)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;AdoptOpenJDK 11.0.3+7 (14.15)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;OK&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Windows 2008R2&#160;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.1.x HEAD (9.00)&#160;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;AdoptOpenJDK 11.0.3+7 (14.15)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;OK&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Windows 2012R2&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.1.x HEAD (9.00)&#160;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;AdoptOpenJDK 11.0.3+7 (14.15)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;OK&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Windows 2016&#160;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.1.x HEAD (9.00)&#160;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;AdoptOpenJDK 11.0.2+9 (12.00)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;OK&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Windows 2016&#160;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;1.1.x HEAD (9.00)&#160;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;AdoptOpenJDK 11.0.3+7 (14.15)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Fail&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Note: It is assumed the OS is fully patched unless otherwise stated.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows&lt;/p&gt;</environment>
        <key id="13225510">DAEMON-398</key>
            <summary>Java 11 jvm.dll startup messages not available on stdout/stderr using Windows 10/2016</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="3" iconUrl="https://issues.apache.org/jira/images/icons/statuses/inprogress.png" description="This issue is being actively worked on at the moment by the assignee.">In Progress</status>
                    <statusCategory id="4" key="indeterminate" colorName="yellow"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="jfclere">Jean-Frederic Clere</assignee>
                                    <reporter username="gerwin84">Gerwin</reporter>
                        <labels>
                    </labels>
                <created>Tue, 2 Apr 2019 13:49:51 +0000</created>
                <updated>Fri, 23 May 2025 16:25:13 +0000</updated>
                                            <version>1.1.1</version>
                                                    <component>Procrun</component>
                    <component>prunsrv</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16831650" author="markt" created="Thu, 2 May 2019 13:59:17 +0000"  >&lt;p&gt;I don&apos;t see this with the AdoptOpenJDK binaries and the latest Commons daemon&#160;code from master built using the release build environment (whcih is essentially the same as the one used for the Tomcat native components:&#160;&lt;a href=&quot;https://cwiki.apache.org/confluence/display/TOMCAT/Common+Native+Build+Environment&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cwiki.apache.org/confluence/display/TOMCAT/Common+Native+Build+Environment&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="16834782" author="gerwin84" created="Tue, 7 May 2019 13:49:55 +0000"  >&lt;p&gt;I tried with &lt;a href=&quot;https://adoptopenjdk.net/archive.html?variant=openjdk11&amp;amp;jvmVariant=hotspot&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;AdoptOpenJDK 11.0.2+9&lt;/a&gt; and there it works fine.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;
C:\&amp;gt;dumpbin /headers &quot;c:\Program Files\Java\adoptopenjdk11.0.2_9\bin\server\jvm.dll&quot;
Microsoft (R) COFF/PE Dumper Version 14.16.27027.1
Copyright (C) Microsoft Corporation.  All rights reserved.

OPTIONAL HEADER VALUES
           12.00 linker version
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It is compiled with Visual Studio 2013 (&lt;a href=&quot;http://mariusbancila.ro/blog/2015/08/12/version-history-of-vc-mfc-and-atl/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ref&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;I tried with &lt;a href=&quot;https://adoptopenjdk.net/archive.html?variant=openjdk11&amp;amp;jvmVariant=hotspot&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;AdoptOpenJDK 11.0.3+7&lt;/a&gt; and there it is broken again.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;
C:\&amp;gt;dumpbin /headers &quot;C:\Program Files\Java\adoptopenjdk11.0.3_7\bin\server\jvm.dll&quot;
OPTIONAL HEADER VALUES
           14.15 linker version
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;They seem to have upgraded their build environment, because this is compiled with Visual Studio 2017 15.8.&lt;/p&gt;

&lt;p&gt;Apart from that, Oracle JDK 11 (both openjdk.java.net and commercial) is compiled with Visual Studio 2017 15.5.&lt;br/&gt;
I assume the Oracle binaries are also supported by commons-daemon.&lt;/p&gt;</comment>
                            <comment id="16834792" author="markt" created="Tue, 7 May 2019 14:08:17 +0000"  >&lt;p&gt;My testing was with AdoptOpenJDK 11.0.3+7 where this issue is not reproducible.&lt;/p&gt;

&lt;p&gt;It looks like the issue is that the Commons Daemon being testing is being built with a later version of Visual Studio than intended. The build tools we use for Commons Daemon&#160;might be rather on the old side but they are deliberately chosen to avoid issues like this.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;A patch that enables this to work when compiling with a later version of Visual Studio&#160;would certainly be accepted. That would fall under an enhancement rather than a bug so I&apos;ll adjust this issue accordingly.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16834830" author="gerwin84" created="Tue, 7 May 2019 14:54:03 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;
C:\&amp;gt;dumpbin /headers &quot;c:\Program Files\TomEE\bin\TomEE.amd64.exe&quot;
OPTIONAL HEADER VALUES
            9.00 linker version
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Mine is compiled with VS2008.&lt;/p&gt;

&lt;p&gt;To be complete, I downloaded &lt;a href=&quot;http://apache.40b.nl//commons/daemon/binaries/windows/commons-daemon-1.1.0-bin-windows.zip&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;commons-daemon-1.1.0-bin-windows.zip&lt;/a&gt; and extracted amd64/prunsrv.exe to TomEE.amd64.exe and tried again: still fails, no error message in std files.&lt;br/&gt;
And it is compiled with same VS2008.&lt;/p&gt;

&lt;p&gt;But I have some more information: I can only reproduce this on Windows 2016 / Windows 10. Not on Windows 2008R2 or Windows 2012R2.&lt;br/&gt;
Which version are you using?&lt;/p&gt;</comment>
                            <comment id="16834893" author="markt" created="Tue, 7 May 2019 15:43:48 +0000"  >&lt;p&gt;I was using Windows 7.&lt;/p&gt;

&lt;p&gt;I think it&#160;would be useful to add a table to the&#160;issue description to track which&#160;combinations work and which do not. That should help us track down exactly where the problem lies. I&apos;ll get something set-up. Help populating it would be much appreciated. I&apos;m not looking to populate all&#160;possible combinations - just enough to figure out where we should be looking for a root cause.&#160;&lt;/p&gt;</comment>
                            <comment id="16834934" author="markt" created="Tue, 7 May 2019 16:23:40 +0000"  >&lt;p&gt;Looking at the table, I think we have enough info already in terms of&#160;combinations. There appears to be both an OS and compiler component to this.&lt;/p&gt;

&lt;p&gt;There error message for the combination that fails in the main&#160;daemon log is: &quot;CreateJavaVM Failed&quot;, &quot;The system cannot find the file specified.&quot;. I&apos;d like to dig into that second message a little more to see&#160;exactly which file cannot be found.&lt;/p&gt;</comment>
                            <comment id="16835119" author="markt" created="Tue, 7 May 2019 21:09:59 +0000"  >&lt;p&gt;Assuming I am reading the Mercurial logs correctly, there were no native code changes&#160;for either&#160;the shared or Windows code between Java 11.0.2 and 11.0.3. It looks like I&apos;m going to&#160;need to set up a Windows built environment for Java 11.&lt;/p&gt;</comment>
                            <comment id="16835463" author="gerwin84" created="Wed, 8 May 2019 09:30:30 +0000"  >&lt;p&gt;This is similar characteristics as &lt;a href=&quot;https://issues.apache.org/jira/browse/DAEMON-396&quot; title=&quot;LibraryPath is broken for Java 11 using Windows 10/2016&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DAEMON-396&quot;&gt;&lt;del&gt;DAEMON-396 LibraryPath is broken for Java 11 using Windows 10/2016&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The only difference I see is that the LibraryPath problem is solved after compiling prunsrv.exe with VS2017, but that does not solve the stdout/stderr problem.&lt;/p&gt;</comment>
                            <comment id="16835963" author="markt" created="Wed, 8 May 2019 23:32:26 +0000"  >&lt;p&gt;Compilation with VS2017 isn&apos;t an option I am keen on at this point.&lt;/p&gt;

&lt;p&gt;My investigations have made progress but not reached any conclusion. It appears that all writes to stderr from jvm.dll are lost until Daemon calls System.setErr().&#160;As too are writes to stdout. I don&apos;t think I am much closer to finding the root cause.&#160;&lt;/p&gt;</comment>
                            <comment id="16844264" author="markt" created="Mon, 20 May 2019 20:22:05 +0000"  >&lt;p&gt;I spent a little time trying to re-create this in a simple test case but failed. I&apos;ve reached out to&#160;the developer who put together the build system (to avoid issues like this) for advice.&lt;/p&gt;

&lt;p&gt;If all else fails, making&#160;vfprintf the first&#160;parameter looks like the best available workaround.&lt;/p&gt;</comment>
                            <comment id="16862078" author="markt" created="Wed, 12 Jun 2019 13:04:38 +0000"  >&lt;p&gt;I&apos;ve made vfprintf the first parameter as a workaround but I&apos;m leaving this issue open while the search for a complete fix continues.&lt;/p&gt;</comment>
                            <comment id="17952599" author="jfclere" created="Mon, 19 May 2025 13:21:49 +0000"  >&lt;p&gt;Proposed fix: &lt;a href=&quot;https://github.com/apache/commons-daemon/pull/264&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-daemon/pull/264&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13225523">TOMEE-2505</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13279119">DAEMON-415</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13206000">DAEMON-396</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13279119">DAEMON-415</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12964570" name="set-stdout.patch" size="2709" author="gerwin84" created="Tue, 2 Apr 2019 13:10:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            24 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z01d1c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>