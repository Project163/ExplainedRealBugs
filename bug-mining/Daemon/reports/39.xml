<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:45:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DAEMON-100] Thread.currentThread().getContextClassLoader() == null when the program is runned by Prunsrv</title>
                <link>https://issues.apache.org/jira/browse/DAEMON-100</link>
                <project id="12310468" key="DAEMON">Commons Daemon</project>
                    <description>&lt;p&gt;Thread.currentThread().getContextClassLoader() == null when the program is runned by Prunsrv, but when we run the same system using java.exe, Thread.currentThread().getContextClassLoader() is not null.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Win XP, jre1.5.0_11, -Djava.security.policy=&amp;lt;path to a file with following content&amp;gt;:&lt;/p&gt;

&lt;p&gt;grant  {&lt;br/&gt;
    permission java.security.AllPermission &quot;&quot;, &quot;&quot;;&lt;br/&gt;
    permission com.sun.rmi.rmid.ExecPermission &quot;&amp;lt;&amp;lt;ALL FILES&amp;gt;&amp;gt;&quot;;&lt;br/&gt;
    permission com.sun.rmi.rmid.ExecOptionPermission &quot;*&quot;;&lt;br/&gt;
};&lt;/p&gt;</environment>
        <key id="12373171">DAEMON-100</key>
            <summary>Thread.currentThread().getContextClassLoader() == null when the program is runned by Prunsrv</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mturk@apache.org">Mladen Turk</assignee>
                                    <reporter username="avodonosov">Anton Vodonosov</reporter>
                        <labels>
                    </labels>
                <created>Fri, 6 Jul 2007 12:19:51 +0000</created>
                <updated>Fri, 24 Sep 2010 13:23:48 +0000</updated>
                            <resolved>Fri, 24 Sep 2010 13:23:48 +0000</resolved>
                                                    <fixVersion>1.0.4</fixVersion>
                                    <component>Procrun</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12850575" author="drzewo" created="Sat, 27 Mar 2010 20:35:32 +0000"  >&lt;p&gt;I confirm.&lt;br/&gt;
This one is particularly annoying when one is trying to launch Jboss AS as a service&lt;br/&gt;
It is installed roughly by the following script:&lt;/p&gt;

&lt;p&gt;SET JBOSS_SERVICE_NATIVE=tomcat6&lt;br/&gt;
SET JBOSS_HOME=c:\java\jboss-5.1.0.GA&lt;br/&gt;
SET JBOSS_NATIVE=%JBOSS_HOME%\bin\native&lt;br/&gt;
SET CONFIG=minimal&lt;br/&gt;
SET SVC_NAME=jbossas&lt;br/&gt;
SET SVC_DISP=JBoss Application Server 5.1&lt;br/&gt;
SET SVC_DESC=JBoss Application Server 5.1.0 GA/Platform: Windows x86&lt;br/&gt;
SET CP=%JBOSS_HOME%\bin\run.jar&lt;br/&gt;
SET JVM=%JAVA_HOME%\jre\bin\server\jvm.dll&lt;br/&gt;
SET JBOSS_OPTS=-c;%CONFIG%&lt;br/&gt;
SET JVM_OPTS=-Xrs;-XX:MaxPermSize=256M;-Dsun.rmi.dgc.client.gcInterval=3600000;-Dsun.rmi.dgc.server.gcInterval=3600000;-Dorg.jboss.resolver.warning=true;-Djava.library.path=%JBOSS_NATIVE%;-Dprogram.name=run.bat&lt;br/&gt;
SET JVM_MS=256&lt;br/&gt;
SET JVM_MX=512&lt;/p&gt;

&lt;p&gt;%JBOSS_SERVICE_NATIVE% //IS//%SVC_NAME%%CONFIG% --DisplayName=&quot;%SVC_DISP% - %CONFIG%&quot; --Description=&quot;%SVC_DESC% - %CONFIG%&quot; --Install=&quot;%JBOSS_HOME%\bin&amp;#37;JBOSS_SERVICE_NATIVE%.exe&quot; --Startup=manual --Classpath=&quot;%CP%&quot; --StartClass=org.jboss.Main --StopClass=org.jboss.Shutdown --StartParams=&quot;%JBOSS_OPTS%&quot; --StopParams=&quot;%JBOSS_OPTS%&quot; --StartPath=&quot;%JBOSS_HOME%\bin&quot; --StopPath=&quot;%JBOSS_HOME%\bin&quot; --Jvm=&quot;%JVM%&quot; --JvmOptions=&quot;%JVM_OPTS%&quot; --JvmMs=%JVM_MS% --JvmMx=%JVM_Mx% --StartMode=jvm --StopMode=jvm --LogPath=%JBOSS_HOME%\server&amp;#37;CONFIG%\log --LogPrefix=jboss_service_ --LogLevel=DEBUG&lt;/p&gt;

&lt;p&gt;I had to change portions of org.jboss.Main in order to launch.&lt;/p&gt;

&lt;p&gt;      ClassLoader parentCL = Thread.currentThread().getContextClassLoader();&lt;br/&gt;
      if ( parentCL == null ) &lt;/p&gt;
{
    	  parentCL = Main.class.getClassLoader();
      }
</comment>
                            <comment id="12851755" author="fbascheper" created="Wed, 31 Mar 2010 07:25:39 +0000"  >&lt;p&gt;This can easily be fixed by adding the following code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;ClassLoader&lt;/span&gt; defaultClassLoader = &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.getClass().getClassLoader();
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().setContextClassLoader(defaultClassLoader );
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12851760" author="fbascheper" created="Wed, 31 Mar 2010 07:36:18 +0000"  >&lt;p&gt;Note that the DaemonLoader class (used by jsvc) also suffers from this issue, so ideally the code above should be added to the DaemonLoader. (and WinNT style should be started using the DaemonLoader).&lt;/p&gt;</comment>
                            <comment id="12851795" author="fbascheper" created="Wed, 31 Mar 2010 09:52:26 +0000"  >&lt;p&gt;Attached patch for DaemonLoader&lt;/p&gt;</comment>
                            <comment id="12851867" author="mturk@apache.org" created="Wed, 31 Mar 2010 13:55:58 +0000"  >&lt;p&gt;You patch will not solve this issue. Procrun doesn&apos;t use Daemon java code.&lt;br/&gt;
The problem is that procrun unlike java.exe uses different thread for launching jvm.&lt;/p&gt;</comment>
                            <comment id="12882691" author="antonyscerri" created="Fri, 25 Jun 2010 19:55:03 +0000"  >&lt;p&gt;Sorry to do this a little messily but i have a number of different contribution so a single patch isnt possible. I believe the solution to this problem which I encountered whilst handling an application hosting an RMI registry which was generating class not found exception when registering objects because of this lack of fully supporting class loader is the modification of the __apxJavaWorkerThread method in javajni.c. I have attached an updated version of this method with just the parts relating to this problem.&lt;/p&gt;

&lt;p&gt;Essentialy all it does is after the native thread is attached to the VM (which is different from the one which creates the main class. It checks to see if a thread context class loader can be found, this is incase the same thread that created the main class is now being used in which case it should already have one. I know this isnt the case at the moment but incase the design changes i thought it worth putting it inside a check. If not it then gets the class loader from the main class and assigns it to the current threads context class loader, therefore providing a fully functional class loader for the thread itself.&lt;/p&gt;

&lt;p&gt;There could be some more exception checking between all the calls added with appropriate failure paths, but this should be enough to demonstrate the core fix. I have succesffuly used this to get a java application loaded on windows through the prunsrv.exe that creates an RMI registry and registers objects appropriately.&lt;/p&gt;</comment>
                            <comment id="12914463" author="mturk@apache.org" created="Fri, 24 Sep 2010 13:23:48 +0000"  >&lt;p&gt;Fixed in the SVN and will be part of 1.0.4&lt;br/&gt;
There reason was because the jvm.dll requires to be loaded in the&lt;br/&gt;
same thread as main class is started.&lt;br/&gt;
Of course this is no where documented in the JNI specs&lt;br/&gt;
(at least I wasn&apos;t able to find it)&lt;/p&gt;

</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12460784">DAEMON-157</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12440325" name="DaemonLoader.patch" size="743" author="fbascheper" created="Wed, 31 Mar 2010 09:52:26 +0000"/>
                            <attachment id="12448089" name="__apxJavaWorkerThread.txt" size="3281" author="antonyscerri" created="Fri, 25 Jun 2010 19:56:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37705</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 9 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0tjx3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>170536</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>