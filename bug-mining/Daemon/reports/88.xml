<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:45:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DAEMON-377] Race in PID file handing in jsvc resulting in Tomcat running without a pidfile</title>
                <link>https://issues.apache.org/jira/browse/DAEMON-377</link>
                <project id="12310468" key="DAEMON">Commons Daemon</project>
                    <description>&lt;p&gt;This issue is reproducible in FreeBSD under moderate load during a restart of Tomcat 8 running via jsvc.&lt;/p&gt;

&lt;p&gt;The old jsvc controller process exits &lt;em&gt;after&lt;/em&gt; the new process is started, deleting the new pid file with it. As a result, the jsvc starter process fails with a timeout since it is waiting on the pid file to be created, which never happens. The Tomcat process itself is &lt;b&gt;started without a pid file&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt;Example: (35659/35660 is the old jsvc process, 56362/56363 is the new jsvc process):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2017-11-08 09:36:59 35660 jsvc debug: Daemon destroyed successfully
2017-11-08 09:36:59 35660 jsvc debug: Calling System.exit(0)
2017-11-08 09:36:59 56362 jsvc debug: Switching umask back to 022 from 077
(((/var/run/tomcat8.pid is written by 56362 here)))
2017-11-08 09:36:59 56363 jsvc debug: Using specific JVM in /usr/local/openjdk8/jre/lib/amd64/server/libjvm.so
2017-11-08 09:36:59 56363 jsvc debug: Attemtping to load library /usr/local/openjdk8/jre/lib/amd64/server/libjvm.so
(((/var/run/tomcat8.pid is deleted by 35659 here)))
2017-11-08 09:36:59 35659 jsvc debug: Service shut down
2017-11-08 09:36:59 56363 jsvc debug: JVM library /usr/local/openjdk8/jre/lib/amd64/server/libjvm.so loaded
2017-11-08 09:36:59 56363 jsvc debug: JVM library entry point found (0x019DE640)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Restart script eventually times out:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;gt;/usr/local/etc/rc.d/tomcat8 restart
Stopping tomcat8.
Waiting for PIDS: 35660.
Starting tomcat8.
/usr/local/etc/rc.d/tomcat8: WARNING: failed to start tomcat8
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;No PID file:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;gt;ls -l /var/run/tomcat8.pid
ls: /var/run/tomcat8.pid: No such file or directory
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Yet Tomcat is running:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&amp;gt;ps ax|grep java|grep -v grep
56362  -  Is      0:00.00 /usr/local/bin/jsvc -java-home /usr/local/openjdk8 -server -user www -pidfile /var/run/tomcat8.pid -wait 300 -outfile /u
56363  -  I       0:57.25 /usr/local/bin/jsvc -java-home /usr/local/openjdk8 -server -user www -pidfile /var/run/tomcat8.pid -wait 300 -outfile /u
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The issue is that the pidfile contains the PID of the &lt;em&gt;child&lt;/em&gt;, but is being deleted by the &lt;em&gt;parent&lt;/em&gt; process (the controller), in the &lt;tt&gt;run_controller&lt;/tt&gt; function which looks like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; run_controller(arg_data *args, home_data *data, uid_t uid,
                          gid_t gid)
  . . .
  waitpid(pid, &amp;amp;status, 0);
  unlink(args-&amp;gt;pidf);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If the controller process is paged out (which happens often because it is dormant while inside &lt;tt&gt;waitpid&lt;/tt&gt;), then considerable amount of time can pass between the time the child terminates and the call to &lt;tt&gt;unlink(args-&amp;gt;pidf)&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The issue can be reproduced reliably by adding &lt;tt&gt;sleep(1);&lt;/tt&gt; before &lt;tt&gt;unlink(args-&amp;gt;pidf)&lt;/tt&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13116911">DAEMON-377</key>
            <summary>Race in PID file handing in jsvc resulting in Tomcat running without a pidfile</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="rustamabd">Rustam Abdullaev</reporter>
                        <labels>
                    </labels>
                <created>Wed, 8 Nov 2017 08:57:04 +0000</created>
                <updated>Wed, 15 Nov 2017 11:51:42 +0000</updated>
                            <resolved>Wed, 15 Nov 2017 11:51:42 +0000</resolved>
                                                    <fixVersion>1.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="16248980" author="rustamabd" created="Sun, 12 Nov 2017 20:13:43 +0000"  >&lt;p&gt;Attaching a patch that fixes a couple of races with pid file handling (including this issue).&lt;/p&gt;

&lt;p&gt;Now the controller will lock and check that the pid file hasn&apos;t changed before deleting it.&lt;/p&gt;

&lt;p&gt;Also fixed an issue with the version check that creates a pid file unnecessarily and never removes one.&lt;/p&gt;</comment>
                            <comment id="16253335" author="markt" created="Wed, 15 Nov 2017 11:51:42 +0000"  >&lt;p&gt;Thanks for the analysis and the patch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12897258" name="daemon-377.patch" size="2574" author="rustamabd" created="Sun, 12 Nov 2017 20:10:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3mj5r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>