<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:46:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DAEMON-402] frequent crash in prunsrv when stopping service in &apos;java&apos; mode</title>
                <link>https://issues.apache.org/jira/browse/DAEMON-402</link>
                <project id="12310468" key="DAEMON">Commons Daemon</project>
                    <description>&lt;p&gt;I see frequent crashes in prunsrv.exe on Windows 10.&lt;/p&gt;

&lt;p&gt;I have the impression that the WM_CLOSE windows message is sent multiple times - and the code does not expect that, resulting in an attempt to free memory that was already freed.&lt;/p&gt;


&lt;p&gt;Here is a stack trace from a minidump:&lt;/p&gt;

&lt;p&gt;&#160;&#160;&#160;&#160; ntdll.dll!00007ff903af6e1e()&#160;&#160;&#160; Unknown&lt;br/&gt;
&#160;&#160;&#160;&#160; AcLayers.dll!00007ff87cd77a56()&#160;&#160;&#160; Unknown&lt;br/&gt;
&#160;&#160;&#160;&#160; prunsrv.exe!HeapFREE(void * hHeap, unsigned long dwFlags, void * lpMem) Line 71&#160;&#160;&#160; C&lt;br/&gt;
&#160;&#160;&#160;&#160; prunsrv.exe!__apxPoolFreeCore(void * lpMem) Line 133&#160;&#160;&#160; C&lt;br/&gt;
&#160;&#160;&#160;&#160; prunsrv.exe!apxFree(void * lpMem) Line 402&#160;&#160;&#160; C&lt;br/&gt;
&#160;&#160;&#160;&#160; prunsrv.exe!__apxProcessCallback(stAPXHANDLE * hObject, unsigned int uMsg, unsigned __int64 wParam, __int64 lParam) Line 396&#160;&#160;&#160; C&lt;br/&gt;
&#160;&#160;&#160;&#160; prunsrv.exe!apxCloseHandle(stAPXHANDLE * hObject) Line 498&#160;&#160;&#160; C&lt;br/&gt;
&#160;&#160;&#160;&#160; prunsrv.exe!__apxPoolCallback(stAPXHANDLE * hObject, unsigned int uMsg, unsigned __int64 wParam, __int64 lParam) Line 190&#160;&#160;&#160; C&lt;br/&gt;
&#160;&#160;&#160;&#160; prunsrv.exe!__apxPoolCallback(stAPXHANDLE * hObject, unsigned int uMsg, unsigned __int64 wParam, __int64 lParam) Line 184&#160;&#160;&#160; C&lt;br/&gt;
&#160;&#160;&#160;&#160; prunsrv.exe!apxCloseHandle(stAPXHANDLE * hObject) Line 498&#160;&#160;&#160; C&lt;br/&gt;
&#160;&#160;&#160;&#160; prunsrv.exe!apxHandleManagerDestroy(...) Line 291&#160;&#160;&#160; C&lt;br/&gt;
&#160;&#160;&#160;&#160; prunsrv.exe!main(int argc, char * * argv) Line 1830&#160;&#160;&#160; C&lt;/p&gt;</description>
                <environment>&lt;p&gt;windows 10&lt;/p&gt;</environment>
        <key id="13235748">DAEMON-402</key>
            <summary>frequent crash in prunsrv when stopping service in &apos;java&apos; mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="lleroy">lode leroy</reporter>
                        <labels>
                            <label>easyfix</label>
                            <label>patch</label>
                            <label>windows</label>
                    </labels>
                <created>Mon, 27 May 2019 08:35:38 +0000</created>
                <updated>Tue, 11 Jun 2019 09:33:49 +0000</updated>
                            <resolved>Tue, 11 Jun 2019 09:33:49 +0000</resolved>
                                    <version>1.1.0</version>
                                    <fixVersion>1.1.1</fixVersion>
                                    <component>Procrun</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="16849857" author="markt" created="Tue, 28 May 2019 15:41:24 +0000"  >&lt;p&gt;Can you provide some more details about the circumstances under which you observe these crashes?&#160;&lt;/p&gt;

&lt;p&gt;To what extent has this patch been tested?&lt;/p&gt;

&lt;p&gt;I am concerned that the patch is addressing a symptom rather than the root cause.&lt;/p&gt;</comment>
                            <comment id="16850597" author="lleroy" created="Wed, 29 May 2019 07:56:31 +0000"  >&lt;p&gt;I have a service running in java mode (with openjdk8) and when the java code is updated it is stopped (net stop ...; update ; net start ...), then we see that the process prunsrv frequently crashes. (The java process has a jni dll in use, so it needs to be stopped before it&apos;s possible to update the dependencies of that dll after the nightly build)&lt;/p&gt;

&lt;p&gt;There are actually multiple services using the same prunsrv.exe binary and the underlying java process is somewhat slow to shut down. This runs on multiple test servers, and we see the crashes on several. I also have the problem if I run &quot;net start ...; net stop ...&quot; in a loop - with minidumps enabled, I see about 1 crash in 5)&lt;/p&gt;

&lt;p&gt;On my machine I see no more crashes at all (hundreds of stop/start cycles), nor on the test machines that have this fix included.&lt;/p&gt;

&lt;p&gt;I think the root cause is that the WM_CLOSE message is sent multiple times. (I thought the WM_CLOSE was sent by Windows - so yeah, maybe the code should not call the same callback twice. Unfortunately, I do not know the code enough to understand how it works)&lt;/p&gt;

&lt;p&gt;I would like to see this fix included in 1.1.1 so we can run the official prunsrv binary instead of a patched-and-self-compiled one.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16860740" author="markt" created="Tue, 11 Jun 2019 09:33:49 +0000"  >&lt;p&gt;Thanks for the additional information. I have applied your patch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12969868" name="fix-crash-on-repeated_wmclose.diff" size="575" author="lleroy" created="Mon, 27 May 2019 08:49:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 22 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z033rk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>