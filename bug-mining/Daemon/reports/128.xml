<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:46:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DAEMON-459] Restart only works once (regression)</title>
                <link>https://issues.apache.org/jira/browse/DAEMON-459</link>
                <project id="12310468" key="DAEMON">Commons Daemon</project>
                    <description>&lt;p&gt;For certain functions, especially code updates, we rely on the ability to restart the child process. This seems to work only once. On the subsequent attempt, the child process hangs.&lt;/p&gt;

&lt;p&gt;I tracked down the problem and found out that the problem is within the &lt;tt&gt;jsvc-unix.c&lt;/tt&gt; file. The &lt;tt&gt;main_reload&lt;/tt&gt; function is called to send the signal to itself, but this does not happen. In the first restart, the &lt;tt&gt;controlled&lt;/tt&gt; variable holds the value of 0. This works by chance, as the signal is sent to the parent, which sends it back to the child. In the second attempt, the variable holds the PID of the previous child, thus the signal is sent to a no longer existing process.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;controlled&lt;/tt&gt; variable is used both by the parent and the child process. In earlier versions of the file, the child process determines its own PID by using the &lt;tt&gt;getpid&lt;/tt&gt; system function. This call has been &#8211; likely accidentally &#8211; removed in version 1.3.3 or earlier. Thus, the variable contains the parent&apos;s value before the fork which has created the child.&lt;/p&gt;

&lt;p&gt;The solution is simple: in the function &lt;tt&gt;child&lt;/tt&gt;, add&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160;&#160;&#160; controlled = getpid ();&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;between the &lt;tt&gt;sigaction&lt;/tt&gt; calls and the &lt;tt&gt;log_debug (&quot;Waiting for a signal to be delivered&quot;)&lt;/tt&gt; call (line 913 in my copy of the file), i.e.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&#160;&#160;&#160; ...&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; memset(&amp;amp;act, &apos;\0&apos;, sizeof(act));&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; act.sa_handler = handler;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; sigemptyset(&amp;amp;act.sa_mask);&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; act.sa_flags = SA_RESTART | SA_NOCLDSTOP;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; sigaction(SIGHUP, &amp;amp;act, NULL);&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; sigaction(SIGUSR1, &amp;amp;act, NULL);&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; sigaction(SIGUSR2, &amp;amp;act, NULL);&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; sigaction(SIGTERM, &amp;amp;act, NULL);&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; sigaction(SIGINT, &amp;amp;act, NULL);&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160;&#160;&#160; &lt;b&gt;controlled = getpid ();&lt;/b&gt;&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; log_debug(&quot;Waiting for a signal to be delivered&quot;);&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; create_tmp_file(args);&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160; &#160; while (!stopping) {&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;&#160;&#160;&#160; ...&lt;/tt&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13533260">DAEMON-459</key>
            <summary>Restart only works once (regression)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="demonti">Klaus Malorny</reporter>
                        <labels>
                    </labels>
                <created>Wed, 19 Apr 2023 15:43:00 +0000</created>
                <updated>Thu, 4 May 2023 19:10:32 +0000</updated>
                            <resolved>Thu, 4 May 2023 19:10:32 +0000</resolved>
                                    <version>1.3.3</version>
                                    <fixVersion>1.3.4</fixVersion>
                                    <component>Jsvc</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17715512" author="garydgregory" created="Sun, 23 Apr 2023 19:43:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=demonti&quot; class=&quot;user-hover&quot; rel=&quot;demonti&quot;&gt;demonti&lt;/a&gt; Feel free to provide a PR on GitHub unless someone else gets to it first. @markt?&lt;/p&gt;</comment>
                            <comment id="17716140" author="JIRAUSER299952" created="Tue, 25 Apr 2023 07:33:08 +0000"  >&lt;p&gt;Come on, this is a single line to add! I&apos;ve done a few PRs in the past for other projects, but for me as a GIT novice (and hater, to say &#8211; SVN rules!), it is really a hassle.&lt;/p&gt;</comment>
                            <comment id="17716861" author="markt" created="Wed, 26 Apr 2023 18:40:01 +0000"  >&lt;p&gt;The regression appears to have been introduced in the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/DAEMON-339&quot; title=&quot;Patch for commons-daemon 1.0.15 to avoid shutdown failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DAEMON-339&quot;&gt;&lt;del&gt;DAEMON-339&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/commons-daemon/commit/718787b4068f1419bf24e6851ff8138e92ddb7cb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-daemon/commit/718787b4068f1419bf24e6851ff8138e92ddb7cb&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17717125" author="markt" created="Thu, 27 Apr 2023 11:12:48 +0000"  >&lt;p&gt;I&apos;m testing this with Tomcat and I am unable to repeat the problem described. `kill -HUP &amp;lt;child-pid&amp;gt;` works as expected for repeated invocations. Note that if you request a restart within 60s of the last start, there will be a delay of 60s between the service stopping and it restarting (to prevent looping).&lt;/p&gt;

&lt;p&gt;Please provide the steps to recreate this issue using the current source code.&lt;/p&gt;

&lt;p&gt;Running with -debug is useful to see exactly what is going on during a restart.&lt;/p&gt;</comment>
                            <comment id="17717230" author="JIRAUSER299952" created="Thu, 27 Apr 2023 13:30:23 +0000"  >&lt;p&gt;Hi Mark,&lt;/p&gt;

&lt;p&gt;you cannot trigger the problem by sending signals from outside to the process. The problem is that the code tries to send a signal to itself, but fails to do so as the variable allegedly holding the own process ID simply does not. The first time it works as the variable contains 0, which sends the signal to all processes of the process group (in which the child process is contained). In the second attempt, it contains the process ID of the previous child, which no longer exists. I guess that the kill function returns an error, but it is not checked.&lt;/p&gt;

&lt;p&gt;You can alter the &lt;tt&gt;main_reload&lt;/tt&gt; function in line 1408 (et seqq.) and print out the &lt;tt&gt;controlled&lt;/tt&gt; variable, and, if you like, print the result of the kill to see what&apos;s happening. You need to trigger the call of this function from within the application, i.e.{{ DaemonController.reload () }}method in Java. I don&apos;t know whether Tomcat can be somehow prompted to do so.&lt;/p&gt;</comment>
                            <comment id="17717239" author="JIRAUSER299952" created="Thu, 27 Apr 2023 14:08:01 +0000"  >&lt;p&gt;As an attachment to this issue, I have added a small test program to reproduce the effect. It contains both the source code and the compiled classes. Go the the &quot;app&quot; directory and start it as follows:&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#000000&quot;&gt;jsvc -debug -cp &quot;build/install/app/lib/*&quot; -cwd `pwd` -pidfile /tmp/jsvc.pid Main&lt;/font&gt;&lt;/p&gt;

&lt;p&gt;After 5 seconds, the app tries to restart itself. It only succeeds once. If anything is still unclear, please let me know.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17719501" author="markt" created="Thu, 4 May 2023 19:10:32 +0000"  >&lt;p&gt;Thanks for the test case.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13057661" name="ApacheDaemonBug.zip" size="119988" author="demonti" created="Thu, 27 Apr 2023 14:04:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 27 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1he8g:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>