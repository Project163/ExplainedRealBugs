<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:45:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DAEMON-195] &quot;net stop serviceName&quot; prints &quot;Error 109: The pipe has been ended.&quot; Stopping via Windows Control Panel hangs.</title>
                <link>https://issues.apache.org/jira/browse/DAEMON-195</link>
                <project id="12310468" key="DAEMON">Commons Daemon</project>
                    <description>&lt;p&gt;This issue was reported for Tomcat 7.0.6: &lt;a href=&quot;https://issues.apache.org/bugzilla/show_bug.cgi?id=50673&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://issues.apache.org/bugzilla/show_bug.cgi?id=50673&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To reproduce:&lt;br/&gt;
1. Install apache-tomcat-7.0.6.exe   I am installing with default options. I am not starting Tomcat after installation.&lt;br/&gt;
2. Launch the command prompt window.&lt;br/&gt;
3. The following command succeeds:&lt;br/&gt;
net stop Tomcat7&lt;br/&gt;
It prints two localized messages that can be translated as&lt;br/&gt;
The &quot;Apache Tomcat 7&quot; service is being started.&lt;br/&gt;
The &quot;Apache Tomcat 7&quot; service started successfully.p&lt;br/&gt;
4. The following command apparently fails, but actually it succeeds:&lt;br/&gt;
net stop Tomcat7&lt;br/&gt;
It prints two localized messages that are, citing from BZ 50673:&lt;br/&gt;
System error 109.&lt;br/&gt;
The pipe has been ended.&lt;br/&gt;
Note that &quot;The service being stopped&quot; message is not printed.&lt;br/&gt;
5. Repeating the command shows that the service has been stopped:&lt;br/&gt;
net stop Tomcat7&lt;br/&gt;
The &quot;Apache Tomcat 7&quot; service has not been started.&lt;/p&gt;

&lt;p&gt;The commons-daemon.&amp;lt;date&amp;gt;.log contains only the following four lines when stopping the service with Debug logging enabled:&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2011-01-27 20:18:59&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;info&amp;#93;&lt;/span&gt;  (          :0   ) Stopping service...&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2011-01-27 20:18:59&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;debug&amp;#93;&lt;/span&gt; ( javajni.c:844 ) argv&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; = stop&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2011-01-27 20:18:59&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;debug&amp;#93;&lt;/span&gt; ( javajni.c:891 ) Java Worker thread started org/apache/catalina/startup/Bootstrap:main&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2011-01-27 20:19:00&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;debug&amp;#93;&lt;/span&gt; ( prunsrv.c:871 ) Waiting for java jni stop worker to finish...&lt;/p&gt;

&lt;p&gt;Stopping the service with Stop button in prunmgr app succeeds without any messages.&lt;br/&gt;
Stopping the service from the Services list in the Control Panel quickly goes to 50% of progress but then continues to wait forever, without any changes on the screen.&lt;/p&gt;</description>
                <environment>&lt;p&gt;WinXP SP3 32-bit&lt;/p&gt;</environment>
        <key id="12496962">DAEMON-195</key>
            <summary>&quot;net stop serviceName&quot; prints &quot;Error 109: The pipe has been ended.&quot; Stopping via Windows Control Panel hangs.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="kkolinko">Konstantin Kolinko</reporter>
                        <labels>
                    </labels>
                <created>Thu, 27 Jan 2011 17:46:54 +0000</created>
                <updated>Sat, 5 Nov 2011 18:46:39 +0000</updated>
                            <resolved>Sat, 5 Nov 2011 18:46:39 +0000</resolved>
                                    <version>1.0.5</version>
                                    <fixVersion>1.0.8</fixVersion>
                                    <component>Procrun</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12989234" author="kkolinko" created="Tue, 1 Feb 2011 15:05:57 +0000"  >&lt;p&gt;This issue was also observed on Windows 2003 R2 (with Tomcat 7.0.6):&lt;br/&gt;
&lt;a href=&quot;http://markmail.org/thread/xzvdk6d3ycoc5v7d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://markmail.org/thread/xzvdk6d3ycoc5v7d&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12989289" author="kkolinko" created="Tue, 1 Feb 2011 17:42:17 +0000"  >&lt;p&gt;Looking at the logs (see Description above) and at the source code, it looks that&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;  apxJavaWait(hWorker, INFINITE, FALSE);&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;call in prunsrv.c line 873 (in serviceStop(LPVOID)) never returns and the prunsrv process just disappears.&lt;/p&gt;

&lt;p&gt;1. There is no &quot;Java Worker thread finished %s:%s with status=%d&quot; message from the worker thread (&lt;tt&gt;javajni.c method __apxJavaWorkerThread(LPVOID)&lt;/tt&gt;)&lt;br/&gt;
2. There is no &quot;Java jni stop worker finished.&quot; message from thread executing serviceStop() call (&lt;tt&gt;prunsrv.c method serviceStop(LPVOID))&lt;/tt&gt;&lt;/p&gt;


&lt;p&gt;Tomcat 7.0.6 and recent versions of Tomcat 6.0 (6.0.30+) when being run as a service terminate themselves by calling System.exit(0).&lt;/p&gt;

&lt;p&gt;The lines are, in &lt;tt&gt;org.apache.catalina.startup.Catalina#stopServer(String[])&lt;/tt&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;            // Server object already present. Must be running as a service&lt;br/&gt;
            // Shutdown hook will take care of clean-up&lt;br/&gt;
            System.exit(0);&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I see that prunsrv has special support for calling System.exit as the stop method. Thus here is a &lt;b&gt;workaround&lt;/b&gt;:&lt;/p&gt;

&lt;p&gt;1. Open the &lt;em&gt;Configure Tomcat&lt;/em&gt; dialog (the prunmgr application, aka tomcat7w.exe, aka tomcat6w.exe) and &lt;br/&gt;
2. Configure the following settings on the &lt;b&gt;Shutdown&lt;/b&gt; tab:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&lt;b&gt;Class&lt;/b&gt;: &lt;tt&gt;java.lang.System&lt;/tt&gt;&lt;br/&gt;
&lt;b&gt;Method&lt;/b&gt;: &lt;tt&gt;exit&lt;/tt&gt;&lt;br/&gt;
&lt;b&gt;Arguments&lt;/b&gt;: &lt;em&gt;remove any text from this field&lt;/em&gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;With the above configuration the service stops successfully.&lt;/p&gt;


&lt;p&gt;--------&lt;br/&gt;
&lt;em&gt;PS&lt;/em&gt;: some thoughts when investigating this (may be not so useful):&lt;br/&gt;
1. In prunsrv.c in method serviceStop(LPVOID) there is the following call: &lt;tt&gt;_onexit(onExitHook);&lt;/tt&gt;  This is executed only if the class name is &quot;java/lang/System&quot;. I wonder whether it were better if the hook was installed unconditionally. Its job is to report &lt;tt&gt;reportServiceStatus(SERVICE_STOPPED, NO_ERROR, 0);&lt;/tt&gt; back to the service management. Maybe that is not enough, because there are also other places where &quot;java/lang/System&quot; processing differs from executing any other Java class.&lt;/p&gt;

&lt;p&gt;2. If java.lang.System.exit() resulted in a call to ExitProcess (I do not actually know. Just speculating), I would expect from &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; that the thread calling this method was continuing to run. In our case the call was done by the worker thread (&lt;tt&gt;__apxJavaWorkerThread(LPVOID)&lt;/tt&gt; method). But, as there was no &quot;Java Worker thread finished %s:%s with status=%d&quot; message, it means that the thread was abruptly terminated, just like any other.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;http://msdn.microsoft.com/en-us/library/ms682658%28v=vs.85%29.aspx&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://msdn.microsoft.com/en-us/library/ms682658%28v=vs.85%29.aspx&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12989577" author="mturk@apache.org" created="Wed, 2 Feb 2011 09:59:30 +0000"  >&lt;p&gt;If running trough standard Daemon classes it is expected that embedding client&lt;br/&gt;
doesn&apos;t call System.exit. I&apos;ll see if that can be unconditionally set.&lt;br/&gt;
However calling System.exit is a hack for clients that doesn&apos;t use Daemon&lt;br/&gt;
classes and have shutdown hook installed.&lt;br/&gt;
Of course this prevents clean procrun shutdown cause it will never&lt;br/&gt;
execute code after apxHandleWait (serviceMain)&lt;/p&gt;

&lt;p&gt;rv = apxHandleWait(gWorker, INFINITE, FALSE);&lt;br/&gt;
apxLogWrite(APXLOG_MARK_DEBUG &quot;Worker finished.&quot;);&lt;/p&gt;


&lt;p&gt;System.exit will cause the procrun to exit uncleanly from apxHandleWait&lt;br/&gt;
However I did best to ensure this doesn&apos;t leave anything hanging around,&lt;br/&gt;
so basically it just misses few &quot;finished&quot; log messages.&lt;/p&gt;



</comment>
                            <comment id="13104733" author="licao" created="Wed, 14 Sep 2011 18:07:00 +0000"  >&lt;p&gt;I am trying to wrap a Java application using &quot;JVM&quot; option and when stopping the service from Services list in Control Panel it eventually stops after a long wait with the following message in a popup dialog box:&lt;/p&gt;

&lt;p&gt;Cound not stop the myService service on local Computer.&lt;br/&gt;
Error 1053: The service did not respond to the start or control request in a timely fashion.&lt;/p&gt;

&lt;p&gt;The OS is Microsoft Windows Server 2003 Standard x64 Edition Service Pack 2 and I am using the AMD64 binary. &quot;net stop serviceName&quot; command exhibits the same behavior as reported in the first comment.&lt;/p&gt;</comment>
                            <comment id="13143511" author="mturk@apache.org" created="Thu, 3 Nov 2011 20:34:09 +0000"  >&lt;p&gt;This will always happen if the stop method calls System.exit()&lt;br/&gt;
There is no way to bypass that.&lt;br/&gt;
On Tomcat you can use --StopMode java and it&apos;ll shutdown cleanly.&lt;br/&gt;
Think we will need to make that as default (at least on Tomcat)&lt;/p&gt;</comment>
                            <comment id="13144783" author="mturk@apache.org" created="Sat, 5 Nov 2011 18:46:39 +0000"  >&lt;p&gt;Seems the fix was really trivial.&lt;br/&gt;
Instead waiting on stop thread to finish, return control immediately to the service control manager.&lt;br/&gt;
This prevents broken pipe messages if start or stop method calls System.exit&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37610</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 2 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0tk5z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>170576</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>