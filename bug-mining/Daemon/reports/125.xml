<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:46:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DAEMON-451] Prunsrv does not use configured stack size for the main thread in jvm mode</title>
                <link>https://issues.apache.org/jira/browse/DAEMON-451</link>
                <project id="12310468" key="DAEMON">Commons Daemon</project>
                    <description>&lt;p&gt;This issue was originally reported for Apache Tomcat, see&lt;br/&gt;
&lt;a href=&quot;https://bz.apache.org/bugzilla/show_bug.cgi?id=66327&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bz.apache.org/bugzilla/show_bug.cgi?id=66327&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;A user provided a sample web application (see BZ 66327 attachment 38426). This web application was deployed on Apache Tomcat 9.0.70 (uses Commons Daemon 1.3.3), configured as a Windows Service.&lt;/p&gt;

&lt;p&gt;The sample application performs a deep recursion at startup, that prints numbers from 1 up to 25000. In the default configuration it fails with a StackOverflowError.&lt;/p&gt;

&lt;p&gt;To reproduce:&lt;br/&gt;
1. Build the sample web application:&lt;br/&gt;
1.1. Download it from BZ 66327 (attachment 38426).&lt;br/&gt;
1.2. Change its pom.xml file, removing &quot;jersey-container-servlet&quot; from dependencies. I do not know why it is there, it is not needed.&lt;br/&gt;
1.3. Build it with Apache Maven (`mvn package`). The result is target/TestStack-1.0-SNAPSHOT.war&lt;/p&gt;

&lt;p&gt;2. Install Apache Tomcat 9 on Windows as a service:&lt;br/&gt;
2.1. Download and run the &quot;32-bit/64-bit Windows Service Installer&quot; (*.exe) from&lt;br/&gt;
&lt;a href=&quot;https://tomcat.apache.org/download-90.cgi&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://tomcat.apache.org/download-90.cgi&lt;/a&gt;&lt;br/&gt;
2.2. Run it. Use default options, but once installation finishes choose to do not start the service.&lt;/p&gt;

&lt;p&gt;3. Deploy the web appplication on Tomcat:&lt;br/&gt;
3.1. Copy the war file into webapps directory of Tomcat.&lt;/p&gt;

&lt;p&gt;4. Go into the bin directory of Tomcat and run prunmgr (tomcat9w.exe).&lt;/p&gt;

&lt;p&gt;5. Start Tomcat service, from the first page of prunmgr dialog.&lt;/p&gt;

&lt;p&gt;6. See the files in the logs directory of Tomcat.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;See the localhost.2022-&lt;b&gt;{&lt;/b&gt;}-{&lt;b&gt;}&lt;/b&gt;.log file for a StackOverflowError&lt;/li&gt;
	&lt;li&gt;See the tomcat9-stdout.2022-&lt;b&gt;-&lt;/b&gt;*.log file for recursion counter.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If the web application starts successfully, there will be no StackOverflowError, and the counter will go up to 25000.&lt;/p&gt;

&lt;p&gt;If the web application fails to start, there will be a StackOverflowError, and the recursion counter will stop at some value, usually somewhere around 15000.&lt;/p&gt;

&lt;p&gt;7. Try to increase the stack size:&lt;br/&gt;
7.1. Stop the service. Clear the files in the logs directory.&lt;br/&gt;
7.2. In prunmgr dialog (page &quot;Java&quot;) change &quot;Thread stack size&quot; to a higher value, e.g. 3072.&lt;br/&gt;
7.3. Do not forget to press the &quot;Apply&quot; button.&lt;br/&gt;
7.4. Start the service.&lt;/p&gt;

&lt;p&gt;Expected behaviour:&lt;br/&gt;
It is expected that changing the &quot;Thread stack size&quot; value to a higher value would eventually allow the web application to start successfully.&lt;/p&gt;

&lt;p&gt;Actual behaviour:&lt;br/&gt;
It makes no difference.&lt;/p&gt;

&lt;p&gt;If I reconfigure Tomcat to use a thread pool when starting web applications, instead of using the main thread, the behaviour changes to the expected one.  E.g. if you add startStopThreads=&quot;3&quot; to a Host element in its conf/server.xml file. See Configuration Reference here:&lt;br/&gt;
&lt;a href=&quot;https://tomcat.apache.org/tomcat-9.0-doc/config/host.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://tomcat.apache.org/tomcat-9.0-doc/config/host.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Note: procrun here runs in jvm mode. The configuration for Tomcat is as follows (see bin/service.bat file):&lt;/p&gt;

&lt;p&gt;--StartMode jvm&lt;br/&gt;
--StopMode jvm&lt;br/&gt;
--StartClass org.apache.catalina.startup.Bootstrap&lt;br/&gt;
--StopClass org.apache.catalina.startup.Bootstrap&lt;br/&gt;
--StartParams start&lt;br/&gt;
--StopParams stop&lt;/p&gt;</description>
                <environment></environment>
        <key id="13510687">DAEMON-451</key>
            <summary>Prunsrv does not use configured stack size for the main thread in jvm mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="4" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Minor</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="kkolinko">Konstantin Kolinko</reporter>
                        <labels>
                    </labels>
                <created>Thu, 8 Dec 2022 02:33:59 +0000</created>
                <updated>Wed, 19 Apr 2023 09:48:49 +0000</updated>
                            <resolved>Wed, 19 Apr 2023 09:48:49 +0000</resolved>
                                    <version>1.3.3</version>
                                    <fixVersion>1.3.4</fixVersion>
                                    <component>Procrun</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17644580" author="kkolinko" created="Thu, 8 Dec 2022 02:51:06 +0000"  >&lt;p&gt;Attached a patch (0001-Fix-&lt;a href=&quot;https://issues.apache.org/jira/browse/DAEMON-451&quot; title=&quot;Prunsrv does not use configured stack size for the main thread in jvm mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;DAEMON-451&quot;&gt;&lt;del&gt;DAEMON-451&lt;/del&gt;&lt;/a&gt;.-Honor-the-stack-size-option-when-cre.patch). Not tested.&lt;/p&gt;</comment>
                            <comment id="17644587" author="garydgregory" created="Thu, 8 Dec 2022 03:26:49 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kkolinko&quot; class=&quot;user-hover&quot; rel=&quot;kkolinko&quot;&gt;kkolinko&lt;/a&gt; and all,&lt;/p&gt;

&lt;p&gt;Thank you for your report and patch.&lt;/p&gt;

&lt;p&gt;I wonder if the patch should guard against ridiculously large stack size requests.&lt;/p&gt;</comment>
                            <comment id="17644804" author="kkolinko" created="Thu, 8 Dec 2022 13:17:33 +0000"  >&lt;p&gt;&amp;gt; I wonder if the patch should guard against ridiculously large stack size requests.&lt;/p&gt;

&lt;p&gt;1. Documentation for CreateThread &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; does not mention any limit.&lt;/p&gt;

&lt;p&gt;2. It looks that it makes sense to add &quot;STACK_SIZE_PARAM_IS_A_RESERVATION&quot; flag to the CreateThread call at few lines below the patch, in addition to the CREATE_SUSPENDED flag that is already used there.&lt;/p&gt;

&lt;p&gt;The &quot;STACK_SIZE_PARAM_IS_A_RESERVATION&quot; flag, as documented in &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, allows to reserve the memory instead of allocating (&quot;committing&quot;) it immediately, and thus will allow to run with larger values. See also &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;I think that adding this flag may help with statring the &quot;stop&quot; thread, as it may to run in limited memory conditions.&lt;/p&gt;

&lt;p&gt;I wonder whether JRE uses this flag when creating its own threads.&lt;/p&gt;

&lt;p&gt;Other mentions of this flag:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt; A discussion of how this flag was added to Mozilla&apos;s NSPR (Netscape Portable Runtime) 8 years ago, and mentions that it exists since Windows NT.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;4&amp;#93;&lt;/span&gt; An example of using this flag in Apache Http Server.&lt;/p&gt;

&lt;p&gt;3. The default for szStackSize was capped at 2Mb with r997298 &lt;span class=&quot;error&quot;&gt;&amp;#91;5&amp;#93;&lt;/span&gt;. I wonder whether it was seen as the limit of being &quot;ridiculously large&quot; 10 years ago. And now we have a user who likes to use 3Mb.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://learn.microsoft.com/en-us/windows/win32/procthread/thread-stack-size&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://learn.microsoft.com/en-us/windows/win32/procthread/thread-stack-size&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://bugzilla.mozilla.org/show_bug.cgi?id=958796&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bugzilla.mozilla.org/show_bug.cgi?id=958796&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;4&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://svn.apache.org/viewvc/httpd/httpd/trunk/server/mpm/winnt/mpm_winnt.c?view=markup&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/viewvc/httpd/httpd/trunk/server/mpm/winnt/mpm_winnt.c?view=markup&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;5&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/commons-daemon/commit/42a805aa&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-daemon/commit/42a805aa&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://svn.apache.org/viewvc?view=revision&amp;amp;revision=997298&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/viewvc?view=revision&amp;amp;revision=997298&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17714025" author="markt" created="Wed, 19 Apr 2023 09:48:49 +0000"  >&lt;p&gt;Thanks for the research and the patch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13053648" name="0001-Fix-DAEMON-451.-Honor-the-stack-size-option-when-cre.patch" size="1239" author="kkolinko" created="Thu, 8 Dec 2022 02:50:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 29 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1djjk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>