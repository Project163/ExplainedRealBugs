<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat Nov 08 17:46:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[DAEMON-424] stderr logfile is corrupted when running Tomcat 8.5 as Windows service</title>
                <link>https://issues.apache.org/jira/browse/DAEMON-424</link>
                <project id="12310468" key="DAEMON">Commons Daemon</project>
                    <description>&lt;p&gt;&lt;em&gt;Note: This issue has originally been reported under &lt;a href=&quot;https://bz.apache.org/bugzilla/show_bug.cgi?id=64863&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bz.apache.org/bugzilla/show_bug.cgi?id=64863&lt;/a&gt; for the Tomcat 8 project.&lt;/em&gt;&lt;/p&gt;

&lt;h3&gt;&lt;a name=&quot;Description&quot;&gt;&lt;/a&gt;Description&lt;/h3&gt;
&lt;p&gt;When Tomcat is running as a Windows Service, output written to System.err may be overwritten again in the tomcat8-stderr*.log file.&lt;/p&gt;

&lt;p&gt;This includes messages about uncaught exceptions. As a consequence, the occurrence of an uncaught exception may remain undetected since it appears in no log file.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;Stepstoreproduce&quot;&gt;&lt;/a&gt;Steps to reproduce&lt;/h3&gt;
&lt;ol&gt;
	&lt;li&gt;Install Tomcat as a Windows Service with default settings&lt;/li&gt;
	&lt;li&gt;Build attached Maven project &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13014485/13014485_uncaught-exception-sample.zip&quot; title=&quot;uncaught-exception-sample.zip attached to DAEMON-424&quot;&gt;uncaught-exception-sample.zip&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; and deploy WAR file into Tomcat&lt;/li&gt;
	&lt;li&gt;Restart Tomcat&lt;/li&gt;
	&lt;li&gt;Inspect file logs/tomcat8-stderr-&amp;lt;date&amp;gt;.log every few seconds&lt;/li&gt;
&lt;/ol&gt;


&lt;h3&gt;&lt;a name=&quot;Expectedbehavior&quot;&gt;&lt;/a&gt;Expected behavior&lt;/h3&gt;
&lt;p&gt;When startup is finished, the file should contain:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;30-Oct-2020 14:46:12.669 INFORMATION [main] org.apache.catalina.core.StandardEngine.startInternal Starting Servlet Engine: Apache Tomcat/8.5.59
30-Oct-2020 14:46:12.810 INFORMATION [localhost-startStop-1] org.apache.catalina.startup.HostConfig.deployWAR Deploying web application archive [C:\Program Files\Apache Software Foundation\Tomcat
8.5\webapps\uncaught-exception-sample-1.0-SNAPSHOT.war]
Message 0 from localhost-start-stop thread
Message 1 from localhost-start-stop thread
Message 2 from localhost-start-stop thread
Message 3 from localhost-start-stop thread
Message 4 from localhost-start-stop thread
Message 5 from localhost-start-stop thread
Message 6 from localhost-start-stop thread
Message 7 from localhost-start-stop thread
Message 8 from localhost-start-stop thread
Message 9 from localhost-start-stop thread
Exception in thread &quot;Thread-4&quot; java.lang.RuntimeException: exception thrown from temporary thread
	at org.example.ContextLoaderListener.lambda$contextInitialized$0(ContextLoaderListener.java:17)
	at java.lang.Thread.run(Thread.java:748)
Message 10 from localhost-start-stop thread
Message 11 from localhost-start-stop thread
Message 12 from localhost-start-stop thread
Message 13 from localhost-start-stop thread
Message 14 from localhost-start-stop thread
Message 15 from localhost-start-stop thread
Message 16 from localhost-start-stop thread
Message 17 from localhost-start-stop thread
Message 18 from localhost-start-stop thread
Message 19 from localhost-start-stop thread
30-Oct-2020 14:47:01.449 INFORMATION [localhost-startStop-1] org.apache.catalina.startup.HostConfig.deployWAR Deployment of web application archive [C:\Program Files\Apache Software Foundation\Tomcat 8.5\webapps\uncaught-exception-sample-1.0-SNAPSHOT.war] has finished in [48.637] ms
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;h3&gt;&lt;a name=&quot;Actualbehavior&quot;&gt;&lt;/a&gt;Actual behavior&lt;/h3&gt;
&lt;p&gt;The custom messages and the uncaught exception message are written to the file and remain there for five seconds, then they are overwritten by subsequent log messages. When startup is finished, the file contains:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;30-Oct-2020 14:46:12.669 INFORMATION [main] org.apache.catalina.core.StandardEngine.startInternal Starting Servlet Engine: Apache Tomcat/8.5.59
30-Oct-2020 14:46:12.810 INFORMATION [localhost-startStop-1] org.apache.catalina.startup.HostConfig.deployWAR Deploying web application archive [C:\Program Files\Apache Software Foundation\Tomcat
8.5\webapps\uncaught-exception-sample-1.0-SNAPSHOT.war]
30-Oct-2020 14:47:01.449 INFORMATION [localhost-startStop-1] org.apache.catalina.startup.HostConfig.deployWAR Deployment of web application archive [C:\Program Files\Apache Software Foundation\Tomcat 8.5\webapps\uncaught-exception-sample-1.0-SNAPSHOT.war] has finished in [48.637] ms
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The message about the uncaught exception is gone.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;RootCause&quot;&gt;&lt;/a&gt;Root Cause&lt;/h3&gt;
&lt;p&gt;&lt;em&gt;(as far as I can tell)&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;The file is opened twice during startup (by the prunsrv), and both file descriptors are being used in the Java application.&lt;/p&gt;

&lt;p&gt;Startup sequence:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;In prunsrv.c, redirectStdStreams():
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;Log file is opened using _wfsopen() with sharing mode _SH_DENYNO (Permits read and write access)&lt;/li&gt;
		&lt;li&gt;then _dup2() to reassign the existing stderr file descriptor&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;In javajni.c, __apxJavaWorkerThread():
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;the main class org.apache.catalina.startup.Bootstrap is loaded&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;In javajni.c, apxJavaSetOut():
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;Log file is opened again and System.err is adjusted, via reflection (Java code):
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;System.setErr(new PrintStream(new FileOutputStream(filename, true)));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Problem: When the main class is loaded in step 2, it initializes the java.util.logging.ConsoleHandler. This class remembers the current System.err (from step 1) in a private field.&lt;/p&gt;

&lt;p&gt;Result:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ConsoleHandler uses file descriptor from step 1 (via FileOutputStream with append == false)&lt;/li&gt;
	&lt;li&gt;System.err uses file descriptor from step 3 (via FileOutputStream with append == true)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Therefore messages written to System.err appear at the end of the log file, but are overwritten by subsequent messages written by ConsoleHandler.&lt;/p&gt;</description>
                <environment>&lt;ul&gt;
	&lt;li&gt;Windows 10 Version 1909&lt;/li&gt;
	&lt;li&gt;Apache Tomcat 8.5.59&lt;/li&gt;
	&lt;li&gt;Adopt OpenJDK 1.8.0_222&lt;/li&gt;
&lt;/ul&gt;
</environment>
        <key id="13338214">DAEMON-424</key>
            <summary>stderr logfile is corrupted when running Tomcat 8.5 as Windows service</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="scholzb-hb">Bernhard Scholz</reporter>
                        <labels>
                    </labels>
                <created>Sat, 31 Oct 2020 14:18:15 +0000</created>
                <updated>Wed, 30 Dec 2020 16:48:32 +0000</updated>
                            <resolved>Fri, 13 Nov 2020 11:57:33 +0000</resolved>
                                    <version>1.2.3</version>
                                    <fixVersion>1.2.4</fixVersion>
                                    <component>prunsrv</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17224114" author="garydgregory" created="Sat, 31 Oct 2020 16:38:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=scholzb-hb&quot; class=&quot;user-hover&quot; rel=&quot;scholzb-hb&quot;&gt;scholzb-hb&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thank you for the report.&#160;&lt;/p&gt;

&lt;p&gt;May you provide PR?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17225209" author="scholzb-hb" created="Tue, 3 Nov 2020 07:54:13 +0000"  >&lt;p&gt;Actually I would like to clarify if there is reason to do the stream redirection twice. As far as I can see, it has been like that since &lt;a href=&quot;https://github.com/apache/commons-daemon/commit/8acfd2ecdc07199325000ac45e9cc65cb6da2330&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-daemon/commit/8acfd2ecdc07199325000ac45e9cc65cb6da2330&lt;/a&gt; (more than 16 years ago).&lt;/p&gt;

&lt;p&gt;My naive approach would be just changing the order of step 2 and 3 of the startup sequence, so that the Java application will only &quot;see&quot; the stderr file descriptor &lt;b&gt;after&lt;/b&gt; the second redirection.&lt;/p&gt;

&lt;p&gt;Patch: &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13014616/13014616_DAEMON-424_scholzb-hb.patch&quot; title=&quot;DAEMON-424_scholzb-hb.patch attached to DAEMON-424&quot;&gt;DAEMON-424_scholzb-hb.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Tested with the above steps to reproduce&lt;br/&gt;
-&amp;gt; The output is now as expected &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17227021" author="scholzb-hb" created="Thu, 5 Nov 2020 21:50:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ggregory&quot; class=&quot;user-hover&quot; rel=&quot;ggregory&quot;&gt;ggregory&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/commons-daemon/pull/21&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/commons-daemon/pull/21&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17231410" author="markt" created="Fri, 13 Nov 2020 11:57:34 +0000"  >&lt;p&gt;Thanks for the analysis and for the patch. The fix will be in the next release.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13014616" name="DAEMON-424_scholzb-hb.patch" size="1208" author="scholzb-hb" created="Tue, 3 Nov 2020 07:54:17 +0000"/>
                            <attachment id="13014485" name="uncaught-exception-sample.zip" size="2651" author="scholzb-hb" created="Sat, 31 Oct 2020 14:11:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0k6eg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>