diff --git a/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/PipelineResources.java b/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/PipelineResources.java
index 6c5e91e672f..2cbe6b6ca55 100644
--- a/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/PipelineResources.java
+++ b/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/PipelineResources.java
@@ -23,72 +23,32 @@ import java.io.File;
 import java.io.FileOutputStream;
 import java.io.IOException;
 import java.io.OutputStream;
-import java.net.URISyntaxException;
-import java.net.URL;
-import java.net.URLClassLoader;
-import java.util.ArrayList;
 import java.util.List;
 import java.util.stream.Collectors;
-import java.util.stream.StreamSupport;
+import org.apache.beam.runners.core.construction.resources.PipelineResourcesOptions;
+import org.apache.beam.sdk.options.PipelineOptions;
 import org.apache.beam.sdk.util.ZipFiles;
 import org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions;
-import org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Splitter;
 import org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Strings;
 import org.apache.beam.vendor.guava.v26_0_jre.com.google.common.hash.Funnels;
 import org.apache.beam.vendor.guava.v26_0_jre.com.google.common.hash.Hasher;
 import org.apache.beam.vendor.guava.v26_0_jre.com.google.common.hash.Hashing;
-import org.slf4j.Logger;
-import org.slf4j.LoggerFactory;
 
 /** Utilities for working with classpath resources for pipelines. */
 public class PipelineResources {
 
-  private static final Logger LOG = LoggerFactory.getLogger(PipelineResources.class);
-
   /**
-   * Attempts to detect all the resources using either URLClassLoader (if it is available) or via
-   * the "java.class.path" system property. URLClassLoader is not available for Java 9 and above,
-   * hence the alternative approach was introduced.
+   * Uses algorithm provided via {@link PipelineResourcesOptions} to detect classpath resources.
    *
    * @param classLoader The URLClassLoader to use to detect resources to stage (optional).
-   * @throws IllegalArgumentException If one of the resources the class loader exposes is not a file
-   *     resource.
+   * @param options pipeline options
    * @return A list of absolute paths to the resources the class loader uses.
    */
-  public static List<String> detectClassPathResourcesToStage(ClassLoader classLoader) {
-    if (!(classLoader instanceof URLClassLoader)) {
-      return scanClasspathForResourcesToStage();
-    } else {
-      LOG.info("Using URLClassLoader to detect classpath resources.");
-      return scanClasspathForResourcesToStage((URLClassLoader) classLoader);
-    }
-  }
+  public static List<String> detectClassPathResourcesToStage(
+      ClassLoader classLoader, PipelineOptions options) {
 
-  private static List<String> scanClasspathForResourcesToStage() {
-    LOG.info("Scanning classpath for resources to stage via the java.class.path system property.");
-
-    Iterable<String> classpathEntries =
-        Splitter.on(File.pathSeparator).split(System.getProperty("java.class.path"));
-
-    return StreamSupport.stream(classpathEntries.spliterator(), false)
-        .map(File::new)
-        .map(File::getAbsolutePath)
-        .collect(Collectors.toList());
-  }
-
-  private static List<String> scanClasspathForResourcesToStage(URLClassLoader classLoader) {
-    LOG.info("Scanning classpath for resources to stage via the URLClassLoader.");
-
-    List<String> files = new ArrayList<>();
-    for (URL url : classLoader.getURLs()) {
-      try {
-        files.add(new File(url.toURI()).getAbsolutePath());
-      } catch (IllegalArgumentException | URISyntaxException e) {
-        String message = String.format("Unable to convert url (%s) to file.", url);
-        throw new IllegalArgumentException(message, e);
-      }
-    }
-    return files;
+    PipelineResourcesOptions artifactsRelatedOptions = options.as(PipelineResourcesOptions.class);
+    return artifactsRelatedOptions.getPipelineResourcesDetector().detect(classLoader);
   }
 
   /**
diff --git a/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/resources/ClasspathScanningResourcesDetector.java b/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/resources/ClasspathScanningResourcesDetector.java
new file mode 100644
index 00000000000..19657179742
--- /dev/null
+++ b/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/resources/ClasspathScanningResourcesDetector.java
@@ -0,0 +1,85 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.beam.runners.core.construction.resources;
+
+import java.io.File;
+import java.net.URISyntaxException;
+import java.net.URL;
+import java.net.URLClassLoader;
+import java.util.ArrayList;
+import java.util.List;
+import java.util.stream.Collectors;
+import java.util.stream.StreamSupport;
+import org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Splitter;
+import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
+
+/**
+ * Attempts to detect all the resources to be staged using either URLClassLoader (if it is
+ * available) or via the "java.class.path" system property. URLClassLoader is not available for Java
+ * 9 and above, hence the alternative approach was introduced.
+ */
+public class ClasspathScanningResourcesDetector implements PipelineResourcesDetector {
+
+  private static final Logger LOG =
+      LoggerFactory.getLogger(ClasspathScanningResourcesDetector.class);
+
+  /**
+   * Detects classpath resources by either using URLClassLoader or java.class.path env variable.
+   *
+   * @param classLoader The classloader to use to detect resources to stage (optional).
+   * @throws IllegalArgumentException If one of the resources the class loader exposes is not a file
+   *     resource.
+   * @return A list of absolute paths to the resources the class loader uses.
+   */
+  @Override
+  public List<String> detect(ClassLoader classLoader) {
+    if (classLoader instanceof URLClassLoader) {
+      return scanClasspathForResourcesToStage((URLClassLoader) classLoader);
+    } else {
+      return scanClasspathForResourcesToStage();
+    }
+  }
+
+  private static List<String> scanClasspathForResourcesToStage() {
+    LOG.info("Scanning classpath for resources to stage via the java.class.path system property.");
+
+    Iterable<String> classpathEntries =
+        Splitter.on(File.pathSeparator).split(System.getProperty("java.class.path"));
+
+    return StreamSupport.stream(classpathEntries.spliterator(), false)
+        .map(File::new)
+        .map(File::getAbsolutePath)
+        .collect(Collectors.toList());
+  }
+
+  private static List<String> scanClasspathForResourcesToStage(URLClassLoader classLoader) {
+    LOG.info("Scanning classpath for resources to stage via the URLClassLoader.");
+
+    List<String> files = new ArrayList<>();
+    for (URL url : classLoader.getURLs()) {
+      try {
+        files.add(new File(url.toURI()).getAbsolutePath());
+      } catch (IllegalArgumentException | URISyntaxException e) {
+        String message = String.format("Unable to convert url (%s) to file.", url);
+        throw new IllegalArgumentException(message, e);
+      }
+    }
+    return files;
+  }
+}
diff --git a/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/resources/PipelineResourcesDetector.java b/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/resources/PipelineResourcesDetector.java
new file mode 100644
index 00000000000..ba1b9ea6c43
--- /dev/null
+++ b/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/resources/PipelineResourcesDetector.java
@@ -0,0 +1,27 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.beam.runners.core.construction.resources;
+
+import java.io.Serializable;
+import java.util.List;
+
+/** Interface for an algorithm detecting classpath resources for pipelines. */
+public interface PipelineResourcesDetector extends Serializable {
+
+  List<String> detect(ClassLoader classLoader);
+}
diff --git a/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/resources/PipelineResourcesDetectorAbstractFactory.java b/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/resources/PipelineResourcesDetectorAbstractFactory.java
new file mode 100644
index 00000000000..200695548ea
--- /dev/null
+++ b/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/resources/PipelineResourcesDetectorAbstractFactory.java
@@ -0,0 +1,23 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.beam.runners.core.construction.resources;
+
+/** Provides pipeline resources detection algorithm. */
+public interface PipelineResourcesDetectorAbstractFactory {
+  PipelineResourcesDetector getPipelineResourcesDetector();
+}
diff --git a/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/resources/PipelineResourcesOptions.java b/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/resources/PipelineResourcesOptions.java
new file mode 100644
index 00000000000..cc27cb1a262
--- /dev/null
+++ b/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/resources/PipelineResourcesOptions.java
@@ -0,0 +1,76 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.beam.runners.core.construction.resources;
+
+import com.fasterxml.jackson.annotation.JsonIgnore;
+import org.apache.beam.sdk.options.Default;
+import org.apache.beam.sdk.options.DefaultValueFactory;
+import org.apache.beam.sdk.options.Description;
+import org.apache.beam.sdk.options.PipelineOptions;
+import org.apache.beam.sdk.util.InstanceBuilder;
+
+/** Pipeline options dedicated to detecting classpath resources. */
+public interface PipelineResourcesOptions extends PipelineOptions {
+
+  @Description(
+      "The class of the pipeline resources detector factory that should be created and used to create "
+          + "the detector. If not set explicitly, a default class will be used to instantiate the factory.")
+  @Default.Class(ClasspathScanningResourcesDetectorFactory.class)
+  Class<? extends PipelineResourcesDetectorAbstractFactory>
+      getPipelineResourcesDetectorFactoryClass();
+
+  void setPipelineResourcesDetectorFactoryClass(
+      Class<? extends PipelineResourcesDetectorAbstractFactory> factoryClass);
+
+  @JsonIgnore
+  @Description(
+      "Instance of a pipeline resources detection algorithm. If not set explicitly, a default implementation will be used")
+  @Default.InstanceFactory(PipelineResourcesDetectorFactory.class)
+  PipelineResourcesDetector getPipelineResourcesDetector();
+
+  void setPipelineResourcesDetector(PipelineResourcesDetector pipelineResourcesDetector);
+
+  class PipelineResourcesDetectorFactory implements DefaultValueFactory<PipelineResourcesDetector> {
+
+    @Override
+    public PipelineResourcesDetector create(PipelineOptions options) {
+      PipelineResourcesOptions resourcesOptions = options.as(PipelineResourcesOptions.class);
+
+      PipelineResourcesDetectorAbstractFactory resourcesToStage =
+          InstanceBuilder.ofType(PipelineResourcesDetectorAbstractFactory.class)
+              .fromClass(resourcesOptions.getPipelineResourcesDetectorFactoryClass())
+              .fromFactoryMethod("create")
+              .build();
+
+      return resourcesToStage.getPipelineResourcesDetector();
+    }
+  }
+
+  class ClasspathScanningResourcesDetectorFactory
+      implements PipelineResourcesDetectorAbstractFactory {
+
+    public static ClasspathScanningResourcesDetectorFactory create() {
+      return new ClasspathScanningResourcesDetectorFactory();
+    }
+
+    @Override
+    public PipelineResourcesDetector getPipelineResourcesDetector() {
+      return new ClasspathScanningResourcesDetector();
+    }
+  }
+}
diff --git a/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/resources/package-info.java b/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/resources/package-info.java
new file mode 100644
index 00000000000..6e64dad43b2
--- /dev/null
+++ b/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/resources/package-info.java
@@ -0,0 +1,20 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+/** Classes used to render Pipelines. */
+package org.apache.beam.runners.core.construction.resources;
diff --git a/runners/core-construction-java/src/test/java/org/apache/beam/runners/core/construction/PipelineResourcesTest.java b/runners/core-construction-java/src/test/java/org/apache/beam/runners/core/construction/PipelineResourcesTest.java
index bb7794d8e43..83582ede648 100644
--- a/runners/core-construction-java/src/test/java/org/apache/beam/runners/core/construction/PipelineResourcesTest.java
+++ b/runners/core-construction-java/src/test/java/org/apache/beam/runners/core/construction/PipelineResourcesTest.java
@@ -18,10 +18,8 @@
 package org.apache.beam.runners.core.construction;
 
 import static junit.framework.TestCase.assertTrue;
-import static org.hamcrest.CoreMatchers.hasItems;
 import static org.hamcrest.MatcherAssert.assertThat;
-import static org.hamcrest.collection.IsCollectionWithSize.hasSize;
-import static org.junit.Assert.assertEquals;
+import static org.hamcrest.Matchers.hasSize;
 import static org.junit.Assert.assertThrows;
 
 import java.io.File;
@@ -31,8 +29,9 @@ import java.net.URLClassLoader;
 import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.List;
+import org.apache.beam.runners.core.construction.resources.PipelineResourcesOptions;
+import org.apache.beam.sdk.options.PipelineOptionsFactory;
 import org.apache.beam.sdk.testing.RestoreSystemProperties;
-import org.apache.beam.vendor.guava.v26_0_jre.com.google.common.collect.ImmutableList;
 import org.junit.Rule;
 import org.junit.Test;
 import org.junit.rules.ExpectedException;
@@ -49,38 +48,16 @@ public class PipelineResourcesTest {
   @Rule public transient RestoreSystemProperties systemProperties = new RestoreSystemProperties();
 
   @Test
-  public void detectClassPathResourceWithFileResources() throws Exception {
+  public void testDetectsResourcesToStage() throws IOException {
     File file = tmpFolder.newFile("file");
-    File file2 = tmpFolder.newFile("file2");
-    URLClassLoader classLoader =
-        new URLClassLoader(new URL[] {file.toURI().toURL(), file2.toURI().toURL()});
+    URLClassLoader classLoader = new URLClassLoader(new URL[] {file.toURI().toURL()});
+    PipelineResourcesOptions options =
+        PipelineOptionsFactory.create().as(PipelineResourcesOptions.class);
 
-    assertEquals(
-        ImmutableList.of(file.getAbsolutePath(), file2.getAbsolutePath()),
-        PipelineResources.detectClassPathResourcesToStage(classLoader));
-  }
-
-  @Test
-  public void detectClassPathResourceWithNonFileResources() throws Exception {
-    String url = "http://www.google.com/all-the-secrets.jar";
-    URLClassLoader classLoader = new URLClassLoader(new URL[] {new URL(url)});
-    thrown.expect(IllegalArgumentException.class);
-    thrown.expectMessage("Unable to convert url (" + url + ") to file.");
-
-    PipelineResources.detectClassPathResourcesToStage(classLoader);
-  }
-
-  @Test
-  public void detectClassPathResourceWithoutURLClassLoader() throws IOException {
-    String path = tmpFolder.newFile("file").getAbsolutePath();
-    String path2 = tmpFolder.newFile("file2").getAbsolutePath();
-    String classpath = String.join(File.pathSeparator, path, path2);
-    System.setProperty("java.class.path", classpath);
-
-    List<String> resources = PipelineResources.detectClassPathResourcesToStage(null);
+    List<String> detectedResources =
+        PipelineResources.detectClassPathResourcesToStage(classLoader, options);
 
-    assertThat(resources, hasItems(path, path2));
-    assertThat(resources, hasSize(2));
+    assertThat(detectedResources, hasSize(1));
   }
 
   @Test
diff --git a/runners/core-construction-java/src/test/java/org/apache/beam/runners/core/construction/resources/ClasspathScanningResourcesDetectorTest.java b/runners/core-construction-java/src/test/java/org/apache/beam/runners/core/construction/resources/ClasspathScanningResourcesDetectorTest.java
new file mode 100644
index 00000000000..e159be431cf
--- /dev/null
+++ b/runners/core-construction-java/src/test/java/org/apache/beam/runners/core/construction/resources/ClasspathScanningResourcesDetectorTest.java
@@ -0,0 +1,88 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.beam.runners.core.construction.resources;
+
+import static org.hamcrest.CoreMatchers.hasItems;
+import static org.hamcrest.MatcherAssert.assertThat;
+import static org.hamcrest.collection.IsCollectionWithSize.hasSize;
+import static org.junit.Assert.assertEquals;
+
+import java.io.File;
+import java.io.IOException;
+import java.net.URL;
+import java.net.URLClassLoader;
+import java.util.List;
+import org.apache.beam.sdk.testing.RestoreSystemProperties;
+import org.apache.beam.vendor.guava.v26_0_jre.com.google.common.collect.ImmutableList;
+import org.junit.Before;
+import org.junit.Rule;
+import org.junit.Test;
+import org.junit.rules.ExpectedException;
+import org.junit.rules.TemporaryFolder;
+
+public class ClasspathScanningResourcesDetectorTest {
+
+  @Rule public transient TemporaryFolder tmpFolder = new TemporaryFolder();
+
+  @Rule public transient ExpectedException thrown = ExpectedException.none();
+
+  @Rule public transient RestoreSystemProperties systemProperties = new RestoreSystemProperties();
+
+  private ClasspathScanningResourcesDetector detector;
+
+  @Before
+  public void setUp() throws Exception {
+    detector = new ClasspathScanningResourcesDetector();
+  }
+
+  @Test
+  public void detectClassPathResourceWithFileResources() throws Exception {
+    File file = tmpFolder.newFile("file");
+    File file2 = tmpFolder.newFile("file2");
+    URLClassLoader classLoader =
+        new URLClassLoader(new URL[] {file.toURI().toURL(), file2.toURI().toURL()});
+
+    assertEquals(
+        ImmutableList.of(file.getAbsolutePath(), file2.getAbsolutePath()),
+        detector.detect(classLoader));
+  }
+
+  @Test
+  public void detectClassPathResourceFromJavaClassPathWhenTheresNoClassLoader() throws IOException {
+    String path = tmpFolder.newFile("file").getAbsolutePath();
+    String path2 = tmpFolder.newFile("file2").getAbsolutePath();
+    String classpath = String.join(File.pathSeparator, path, path2);
+    System.setProperty("java.class.path", classpath);
+
+    List<String> resources = detector.detect(null);
+
+    assertThat(resources, hasItems(path, path2));
+    assertThat(resources, hasSize(2));
+  }
+
+  @Test
+  public void throwWhenDetectingClassPathResourceWithNonFileResources() throws Exception {
+    String url = "http://www.google.com/all-the-secrets.jar";
+    URLClassLoader classLoader = new URLClassLoader(new URL[] {new URL(url)});
+
+    thrown.expect(IllegalArgumentException.class);
+    thrown.expectMessage("Unable to convert url (" + url + ") to file.");
+
+    detector.detect(classLoader);
+  }
+}
diff --git a/runners/flink/src/main/java/org/apache/beam/runners/flink/FlinkJobInvoker.java b/runners/flink/src/main/java/org/apache/beam/runners/flink/FlinkJobInvoker.java
index 14436ea21bb..09fa4c90fcf 100644
--- a/runners/flink/src/main/java/org/apache/beam/runners/flink/FlinkJobInvoker.java
+++ b/runners/flink/src/main/java/org/apache/beam/runners/flink/FlinkJobInvoker.java
@@ -78,7 +78,8 @@ public class FlinkJobInvoker extends JobInvoker {
           new FlinkPipelineRunner(
               flinkOptions,
               serverConfig.getFlinkConfDir(),
-              detectClassPathResourcesToStage(FlinkJobInvoker.class.getClassLoader()));
+              detectClassPathResourcesToStage(
+                  FlinkJobInvoker.class.getClassLoader(), flinkOptions));
     } else {
       pipelineRunner = new PortablePipelineJarCreator(FlinkPipelineRunner.class);
     }
diff --git a/runners/flink/src/main/java/org/apache/beam/runners/flink/FlinkPipelineRunner.java b/runners/flink/src/main/java/org/apache/beam/runners/flink/FlinkPipelineRunner.java
index 33d2c76bba9..915a180bfb7 100644
--- a/runners/flink/src/main/java/org/apache/beam/runners/flink/FlinkPipelineRunner.java
+++ b/runners/flink/src/main/java/org/apache/beam/runners/flink/FlinkPipelineRunner.java
@@ -178,7 +178,8 @@ public class FlinkPipelineRunner implements PortablePipelineRunner {
         new FlinkPipelineRunner(
             flinkOptions,
             configuration.flinkConfDir,
-            detectClassPathResourcesToStage(FlinkPipelineRunner.class.getClassLoader()));
+            detectClassPathResourcesToStage(
+                FlinkPipelineRunner.class.getClassLoader(), flinkOptions));
     JobInfo jobInfo =
         JobInfo.create(
             invocationId,
diff --git a/runners/flink/src/main/java/org/apache/beam/runners/flink/FlinkRunner.java b/runners/flink/src/main/java/org/apache/beam/runners/flink/FlinkRunner.java
index 649b5ec61d5..e5b40543a23 100644
--- a/runners/flink/src/main/java/org/apache/beam/runners/flink/FlinkRunner.java
+++ b/runners/flink/src/main/java/org/apache/beam/runners/flink/FlinkRunner.java
@@ -77,7 +77,7 @@ public class FlinkRunner extends PipelineRunner<PipelineResult> {
 
     if (flinkOptions.getFilesToStage() == null) {
       flinkOptions.setFilesToStage(
-          detectClassPathResourcesToStage(FlinkRunner.class.getClassLoader()));
+          detectClassPathResourcesToStage(FlinkRunner.class.getClassLoader(), options));
       LOG.info(
           "PipelineOptions.filesToStage was not specified. "
               + "Defaulting to files from the classpath: will stage {} files. "
diff --git a/runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/DataflowRunner.java b/runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/DataflowRunner.java
index 1da964dd778..f8ebfb45e44 100644
--- a/runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/DataflowRunner.java
+++ b/runners/google-cloud-dataflow-java/src/main/java/org/apache/beam/runners/dataflow/DataflowRunner.java
@@ -121,8 +121,6 @@ import org.apache.beam.sdk.transforms.Combine.CombineFn;
 import org.apache.beam.sdk.transforms.Combine.GroupedValues;
 import org.apache.beam.sdk.transforms.Create;
 import org.apache.beam.sdk.transforms.DoFn;
-import org.apache.beam.sdk.transforms.DoFn.ProcessContext;
-import org.apache.beam.sdk.transforms.DoFn.ProcessElement;
 import org.apache.beam.sdk.transforms.GroupByKey;
 import org.apache.beam.sdk.transforms.GroupIntoBatches;
 import org.apache.beam.sdk.transforms.Impulse;
@@ -278,7 +276,7 @@ public class DataflowRunner extends PipelineRunner<DataflowPipelineJob> {
 
     if (dataflowOptions.getFilesToStage() == null) {
       dataflowOptions.setFilesToStage(
-          detectClassPathResourcesToStage(DataflowRunner.class.getClassLoader()));
+          detectClassPathResourcesToStage(DataflowRunner.class.getClassLoader(), options));
       if (dataflowOptions.getFilesToStage().isEmpty()) {
         throw new IllegalArgumentException("No files to stage has been found.");
       } else {
diff --git a/runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/jobsubmission/PortablePipelineJarCreator.java b/runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/jobsubmission/PortablePipelineJarCreator.java
index 951a8cb293b..f3fd2c4542d 100644
--- a/runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/jobsubmission/PortablePipelineJarCreator.java
+++ b/runners/java-fn-execution/src/main/java/org/apache/beam/runners/fnexecution/jobsubmission/PortablePipelineJarCreator.java
@@ -56,6 +56,7 @@ import org.apache.beam.runners.fnexecution.artifact.BeamFileSystemArtifactRetrie
 import org.apache.beam.runners.fnexecution.provisioning.JobInfo;
 import org.apache.beam.sdk.fn.test.InProcessManagedChannelFactory;
 import org.apache.beam.sdk.metrics.MetricResults;
+import org.apache.beam.sdk.options.PipelineOptions;
 import org.apache.beam.sdk.options.PortablePipelineOptions;
 import org.apache.beam.vendor.grpc.v1p21p0.com.google.protobuf.MessageOrBuilder;
 import org.apache.beam.vendor.grpc.v1p21p0.com.google.protobuf.util.JsonFormat;
@@ -106,7 +107,7 @@ public class PortablePipelineJarCreator implements PortablePipelineRunner {
         new JarOutputStream(new FileOutputStream(outputFile), createManifest(mainClass, jobName));
     outputChannel = Channels.newChannel(outputStream);
     PortablePipelineJarUtils.writeDefaultJobName(outputStream, jobName);
-    writeClassPathResources(mainClass.getClassLoader());
+    writeClassPathResources(mainClass.getClassLoader(), pipelineOptions);
     writeAsJson(pipeline, PortablePipelineJarUtils.getPipelineUri(jobName));
     writeAsJson(
         PipelineOptionsTranslation.toProto(pipelineOptions),
@@ -144,9 +145,10 @@ public class PortablePipelineJarCreator implements PortablePipelineRunner {
   }
 
   /** Copy resources from {@code classLoader} to {@link #outputStream}. */
-  private void writeClassPathResources(ClassLoader classLoader) throws IOException {
+  private void writeClassPathResources(ClassLoader classLoader, PipelineOptions options)
+      throws IOException {
     List<String> classPathResources =
-        PipelineResources.detectClassPathResourcesToStage(classLoader);
+        PipelineResources.detectClassPathResourcesToStage(classLoader, options);
     Preconditions.checkArgument(
         classPathResources.size() == 1, "Expected exactly one jar on " + classLoader.toString());
     copyResourcesFromJar(new JarFile(classPathResources.get(0)));
diff --git a/runners/portability/java/src/main/java/org/apache/beam/runners/portability/PortableRunner.java b/runners/portability/java/src/main/java/org/apache/beam/runners/portability/PortableRunner.java
index d03e56e0daa..a355bb69035 100644
--- a/runners/portability/java/src/main/java/org/apache/beam/runners/portability/PortableRunner.java
+++ b/runners/portability/java/src/main/java/org/apache/beam/runners/portability/PortableRunner.java
@@ -104,7 +104,8 @@ public class PortableRunner extends PipelineRunner<PipelineResult> {
           s -> pathsToStage.addAll(Arrays.asList(s.replaceFirst("jar_packages=", "").split(","))));
     }
     if (portableOptions.getFilesToStage() == null) {
-      pathsToStage.addAll(detectClassPathResourcesToStage(PortableRunner.class.getClassLoader()));
+      pathsToStage.addAll(
+          detectClassPathResourcesToStage(PortableRunner.class.getClassLoader(), options));
       if (pathsToStage.isEmpty()) {
         throw new IllegalArgumentException("No classpath elements found.");
       }
diff --git a/runners/spark/src/main/java/org/apache/beam/runners/spark/SparkPipelineRunner.java b/runners/spark/src/main/java/org/apache/beam/runners/spark/SparkPipelineRunner.java
index 291e76018c5..237aaf78d74 100644
--- a/runners/spark/src/main/java/org/apache/beam/runners/spark/SparkPipelineRunner.java
+++ b/runners/spark/src/main/java/org/apache/beam/runners/spark/SparkPipelineRunner.java
@@ -94,7 +94,8 @@ public class SparkPipelineRunner implements PortablePipelineRunner {
 
     if (pipelineOptions.getFilesToStage() == null) {
       pipelineOptions.setFilesToStage(
-          detectClassPathResourcesToStage(SparkPipelineRunner.class.getClassLoader()));
+          detectClassPathResourcesToStage(
+              SparkPipelineRunner.class.getClassLoader(), pipelineOptions));
       LOG.info(
           "PipelineOptions.filesToStage was not specified. Defaulting to files from the classpath");
     }
diff --git a/runners/spark/src/main/java/org/apache/beam/runners/spark/SparkRunner.java b/runners/spark/src/main/java/org/apache/beam/runners/spark/SparkRunner.java
index c4f17f8f140..58567b8191c 100644
--- a/runners/spark/src/main/java/org/apache/beam/runners/spark/SparkRunner.java
+++ b/runners/spark/src/main/java/org/apache/beam/runners/spark/SparkRunner.java
@@ -128,7 +128,7 @@ public final class SparkRunner extends PipelineRunner<SparkPipelineResult> {
 
     if (sparkOptions.getFilesToStage() == null) {
       sparkOptions.setFilesToStage(
-          detectClassPathResourcesToStage(SparkRunner.class.getClassLoader()));
+          detectClassPathResourcesToStage(SparkRunner.class.getClassLoader(), options));
       LOG.info(
           "PipelineOptions.filesToStage was not specified. "
               + "Defaulting to files from the classpath: will stage {} files. "
diff --git a/runners/spark/src/main/java/org/apache/beam/runners/spark/structuredstreaming/SparkStructuredStreamingRunner.java b/runners/spark/src/main/java/org/apache/beam/runners/spark/structuredstreaming/SparkStructuredStreamingRunner.java
index 10b95d13663..b6c759c03ae 100644
--- a/runners/spark/src/main/java/org/apache/beam/runners/spark/structuredstreaming/SparkStructuredStreamingRunner.java
+++ b/runners/spark/src/main/java/org/apache/beam/runners/spark/structuredstreaming/SparkStructuredStreamingRunner.java
@@ -111,7 +111,8 @@ public final class SparkStructuredStreamingRunner
 
     if (sparkOptions.getFilesToStage() == null) {
       sparkOptions.setFilesToStage(
-          detectClassPathResourcesToStage(SparkStructuredStreamingRunner.class.getClassLoader()));
+          detectClassPathResourcesToStage(
+              SparkStructuredStreamingRunner.class.getClassLoader(), options));
       LOG.info(
           "PipelineOptions.filesToStage was not specified. "
               + "Defaulting to files from the classpath: will stage {} files. "
