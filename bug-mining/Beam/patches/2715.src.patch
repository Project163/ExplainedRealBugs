diff --git a/sdks/java/io/amazon-web-services2/src/main/java/org/apache/beam/sdk/io/aws2/s3/DefaultS3ClientBuilderFactory.java b/sdks/java/io/amazon-web-services2/src/main/java/org/apache/beam/sdk/io/aws2/s3/DefaultS3ClientBuilderFactory.java
index 8aad7fed92c..afc5a4be850 100644
--- a/sdks/java/io/amazon-web-services2/src/main/java/org/apache/beam/sdk/io/aws2/s3/DefaultS3ClientBuilderFactory.java
+++ b/sdks/java/io/amazon-web-services2/src/main/java/org/apache/beam/sdk/io/aws2/s3/DefaultS3ClientBuilderFactory.java
@@ -20,10 +20,10 @@ package org.apache.beam.sdk.io.aws2.s3;
 import java.net.URI;
 import org.apache.beam.sdk.io.aws2.options.S3ClientBuilderFactory;
 import org.apache.beam.sdk.io.aws2.options.S3Options;
+import org.apache.beam.vendor.guava.v26_0_jre.com.google.common.annotations.VisibleForTesting;
 import org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Strings;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
-import software.amazon.awssdk.http.SdkHttpClient;
 import software.amazon.awssdk.http.apache.ApacheHttpClient;
 import software.amazon.awssdk.regions.Region;
 import software.amazon.awssdk.services.s3.S3Client;
@@ -39,21 +39,26 @@ public class DefaultS3ClientBuilderFactory implements S3ClientBuilderFactory {
 
   @Override
   public S3ClientBuilder createBuilder(S3Options s3Options) {
-    S3ClientBuilder builder =
-        S3Client.builder().credentialsProvider(s3Options.getAwsCredentialsProvider());
+    return createBuilder(S3Client.builder(), s3Options);
+  }
+
+  @VisibleForTesting
+  static S3ClientBuilder createBuilder(S3ClientBuilder builder, S3Options s3Options) {
+    if (s3Options.getAwsCredentialsProvider() != null) {
+      builder.credentialsProvider(s3Options.getAwsCredentialsProvider());
+    }
 
     if (s3Options.getProxyConfiguration() != null) {
-      SdkHttpClient httpClient =
-          ApacheHttpClient.builder().proxyConfiguration(s3Options.getProxyConfiguration()).build();
-      builder = builder.httpClient(httpClient);
+      builder.httpClient(
+          ApacheHttpClient.builder().proxyConfiguration(s3Options.getProxyConfiguration()).build());
     }
 
     if (!Strings.isNullOrEmpty(s3Options.getEndpoint())) {
-      URI endpoint = URI.create(s3Options.getEndpoint());
-      Region region = Region.of(s3Options.getAwsRegion());
-      builder.endpointOverride(endpoint).region(region);
-    } else if (!Strings.isNullOrEmpty(s3Options.getAwsRegion())) {
-      builder = builder.region(Region.of(s3Options.getAwsRegion()));
+      builder.endpointOverride(URI.create(s3Options.getEndpoint()));
+    }
+
+    if (!Strings.isNullOrEmpty(s3Options.getAwsRegion())) {
+      builder.region(Region.of(s3Options.getAwsRegion()));
     } else {
       LOG.info(
           "The AWS S3 Beam extension was included in this build, but the awsRegion flag "
diff --git a/sdks/java/io/amazon-web-services2/src/test/java/org/apache/beam/sdk/io/aws2/s3/DefaultS3ClientBuilderFactoryTest.java b/sdks/java/io/amazon-web-services2/src/test/java/org/apache/beam/sdk/io/aws2/s3/DefaultS3ClientBuilderFactoryTest.java
new file mode 100644
index 00000000000..b704067ba6a
--- /dev/null
+++ b/sdks/java/io/amazon-web-services2/src/test/java/org/apache/beam/sdk/io/aws2/s3/DefaultS3ClientBuilderFactoryTest.java
@@ -0,0 +1,92 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.beam.sdk.io.aws2.s3;
+
+import static org.mockito.ArgumentMatchers.any;
+import static org.mockito.Mockito.mock;
+import static org.mockito.Mockito.verify;
+import static org.mockito.Mockito.verifyNoInteractions;
+import static org.mockito.Mockito.verifyNoMoreInteractions;
+import static org.mockito.Mockito.when;
+
+import java.net.URI;
+import org.apache.beam.sdk.io.aws2.options.S3Options;
+import org.junit.Test;
+import org.junit.runner.RunWith;
+import org.mockito.Mock;
+import org.mockito.junit.MockitoJUnitRunner;
+import software.amazon.awssdk.auth.credentials.AwsCredentialsProvider;
+import software.amazon.awssdk.http.apache.ApacheHttpClient;
+import software.amazon.awssdk.http.apache.ProxyConfiguration;
+import software.amazon.awssdk.regions.Region;
+import software.amazon.awssdk.services.s3.S3ClientBuilder;
+
+@RunWith(MockitoJUnitRunner.class)
+public class DefaultS3ClientBuilderFactoryTest {
+  @Mock S3Options s3Options;
+  @Mock S3ClientBuilder builder;
+
+  @Test
+  public void testEmptyOptions() {
+    DefaultS3ClientBuilderFactory.createBuilder(builder, s3Options);
+    verifyNoInteractions(builder);
+  }
+
+  @Test
+  public void testSetCredentialsProvider() {
+    AwsCredentialsProvider credentialsProvider = mock(AwsCredentialsProvider.class);
+    when(s3Options.getAwsCredentialsProvider()).thenReturn(credentialsProvider);
+
+    DefaultS3ClientBuilderFactory.createBuilder(builder, s3Options);
+    verify(builder).credentialsProvider(credentialsProvider);
+    verifyNoMoreInteractions(builder);
+  }
+
+  @Test
+  public void testSetProxyConfiguration() {
+    when(s3Options.getProxyConfiguration()).thenReturn(ProxyConfiguration.builder().build());
+
+    DefaultS3ClientBuilderFactory.createBuilder(builder, s3Options);
+    verify(builder).httpClient(any(ApacheHttpClient.class));
+    verifyNoMoreInteractions(builder);
+  }
+
+  @Test
+  public void testSetEndpoint() {
+    when(s3Options.getEndpoint()).thenReturn("");
+    DefaultS3ClientBuilderFactory.createBuilder(builder, s3Options);
+    verifyNoInteractions(builder); // ignore empty endpoint
+
+    when(s3Options.getEndpoint()).thenReturn("https://localhost");
+    DefaultS3ClientBuilderFactory.createBuilder(builder, s3Options);
+    verify(builder).endpointOverride(URI.create("https://localhost"));
+    verifyNoMoreInteractions(builder);
+  }
+
+  @Test
+  public void testSetRegion() {
+    when(s3Options.getAwsRegion()).thenReturn("");
+    DefaultS3ClientBuilderFactory.createBuilder(builder, s3Options);
+    verifyNoInteractions(builder); // ignore empty region
+
+    when(s3Options.getAwsRegion()).thenReturn(Region.US_WEST_1.id());
+    DefaultS3ClientBuilderFactory.createBuilder(builder, s3Options);
+    verify(builder).region(Region.US_WEST_1);
+    verifyNoMoreInteractions(builder);
+  }
+}
