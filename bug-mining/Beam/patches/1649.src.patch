diff --git a/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/External.java b/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/External.java
index 810a6e95138..06b118242ec 100644
--- a/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/External.java
+++ b/runners/core-construction-java/src/main/java/org/apache/beam/runners/core/construction/External.java
@@ -232,8 +232,11 @@ public class External {
           .forEach(
               (pcolId, pCol) -> {
                 try {
-                  Coder coder = rehydratedComponents.getCoder(pCol.getCoderId());
-                  externalCoderIdMapBuilder.putIfAbsent(coder, pCol.getCoderId());
+                  String coderId = pCol.getCoderId();
+                  if (isJavaSDKCompatible(expandedComponents, coderId)) {
+                    Coder coder = rehydratedComponents.getCoder(coderId);
+                    externalCoderIdMapBuilder.putIfAbsent(coder, coderId);
+                  }
                 } catch (IOException e) {
                   throw new RuntimeException("cannot rehydrate Coder.");
                 }
@@ -243,6 +246,20 @@ public class External {
       return toOutputCollection(outputMapBuilder.build());
     }
 
+    boolean isJavaSDKCompatible(RunnerApi.Components components, String coderId) {
+      RunnerApi.Coder coder = components.getCodersOrThrow(coderId);
+      if (!CoderTranslation.JAVA_SERIALIZED_CODER_URN.equals(coder.getSpec().getUrn())
+          && !CoderTranslation.KNOWN_CODER_URNS.containsValue(coder.getSpec().getUrn())) {
+        return false;
+      }
+      for (String componentId : coder.getComponentCoderIdsList()) {
+        if (!isJavaSDKCompatible(components, componentId)) {
+          return false;
+        }
+      }
+      return true;
+    }
+
     abstract OutputT toOutputCollection(Map<TupleTag<?>, PCollection> output);
 
     String getNamespace() {
diff --git a/sdks/java/testing/expansion-service/build.gradle b/sdks/java/testing/expansion-service/build.gradle
index 71a685e3c2f..6efe7754aae 100644
--- a/sdks/java/testing/expansion-service/build.gradle
+++ b/sdks/java/testing/expansion-service/build.gradle
@@ -28,7 +28,7 @@ dependencies {
   compile project(path: ":runners:core-construction-java")
   compile project(path: ":sdks:java:io:parquet")
   compile project(path: ":sdks:java:core", configuration: "shadow")
-  provided library.java.hadoop_client
+  testRuntime library.java.hadoop_client
 }
 
 task runTestExpansionService (type: JavaExec) {
diff --git a/sdks/python/apache_beam/runners/portability/expansion_service_test.py b/sdks/python/apache_beam/runners/portability/expansion_service_test.py
index 34acac1f2b5..2825fc6bf7f 100644
--- a/sdks/python/apache_beam/runners/portability/expansion_service_test.py
+++ b/sdks/python/apache_beam/runners/portability/expansion_service_test.py
@@ -122,7 +122,8 @@ class MutltiTransform(ptransform.PTransform):
     return TEST_MULTI_URN, None
 
   @staticmethod
-  def from_runner_api_parameter(unused_parameter, unused_context):
+  def from_runner_api_parameter(
+      unused_ptransform, unused_parameter, unused_context):
     return MutltiTransform()
 
 
