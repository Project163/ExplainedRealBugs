<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:52:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-5500] Portable python sdk worker leaks memory in streaming mode</title>
                <link>https://issues.apache.org/jira/browse/BEAM-5500</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;When using the portable python sdk with flink in streaming mode, we see that the python worker processes steadily increase memory usage until they are OOM killed. This behavior is consistent across various kinds of streaming pipelines, including those with fixed windows and global windows.&lt;/p&gt;

&lt;p&gt;A simple wordcount-like pipeline demonstrates the issue for us (note this is run on the &lt;a href=&quot;https://github.com/lyft/beam/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Lyft beam fork&lt;/a&gt;, which provides access to kinesis as a portable streaming source):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
counts = (p
| &lt;span class=&quot;code-quote&quot;&gt;&apos;Kinesis&apos;&lt;/span&gt; &amp;gt;&amp;gt; FlinkKinesisInput().with_stream(&lt;span class=&quot;code-quote&quot;&gt;&apos;test-stream&apos;&lt;/span&gt;)
| &lt;span class=&quot;code-quote&quot;&gt;&apos;decode&apos;&lt;/span&gt; &amp;gt;&amp;gt; beam.FlatMap(decode) # parses from json into python objs
| &lt;span class=&quot;code-quote&quot;&gt;&apos;pair_with_one&apos;&lt;/span&gt; &amp;gt;&amp;gt; beam.Map(lambda x: (x[&lt;span class=&quot;code-quote&quot;&gt;&quot;event_name&quot;&lt;/span&gt;], 1))
| &lt;span class=&quot;code-quote&quot;&gt;&apos;window&apos;&lt;/span&gt; &amp;gt;&amp;gt; beam.WindowInto(window.GlobalWindows(),
                              trigger=AfterProcessingTime(15 * 1000),
                              accumulation_mode=AccumulationMode.DISCARDING)
| &lt;span class=&quot;code-quote&quot;&gt;&apos;group&apos;&lt;/span&gt; &amp;gt;&amp;gt; beam.GroupByKey()
| &lt;span class=&quot;code-quote&quot;&gt;&apos;count&apos;&lt;/span&gt; &amp;gt;&amp;gt; beam.Map(count_ones)
| beam.Map(lambda x: logging.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;count: %s&quot;&lt;/span&gt;, str(x)) or x))

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;When run, we see a steady increase in memory usage in the sdk_worker process. Using&#160;&lt;a href=&quot;http://guppy-pe.sourceforge.net/#Heapy&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;heapy&lt;/a&gt;&#160;I&apos;ve analyzed the memory usage over time and found that it&apos;s largely dicts and strings&#160;(see attached chart).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13187394">BEAM-5500</key>
            <summary>Portable python sdk worker leaks memory in streaming mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="robertwb">Robert Bradshaw</assignee>
                                    <reporter username="mwylde">Micah Wylde</reporter>
                        <labels>
                            <label>portability-flink</label>
                    </labels>
                <created>Tue, 25 Sep 2018 18:15:29 +0000</created>
                <updated>Sat, 16 May 2020 13:59:57 +0000</updated>
                            <resolved>Wed, 3 Oct 2018 18:40:58 +0000</resolved>
                                                    <fixVersion>2.8.0</fixVersion>
                                    <component>sdk-py-harness</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="16630296" author="robertwb" created="Thu, 27 Sep 2018 12:24:10 +0000"  >&lt;p&gt;I&apos;ve tried running this repeatedly in the direct runner, and am only finding the aforementioned leak of ~300 bytes per stage per bundle (which, yes, needs to be resolved). How many bundles/second are you processing?&#160;&lt;/p&gt;</comment>
                            <comment id="16630515" author="thw" created="Thu, 27 Sep 2018 14:24:45 +0000"  >&lt;p&gt;The pipeline runs in streaming mode. With the Flink runner, currently&#160;every record is processed as a separate bundle. The pipeline above has multiple executable stages. The leak will be: number_of_records * number_of_stages * 300.&lt;/p&gt;

&lt;p&gt;So if we process 1 million records and have 2 stages, we have leaked 600MB of memory.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16636638" author="robertwb" created="Wed, 3 Oct 2018 09:03:00 +0000"  >&lt;p&gt;In light of &lt;a href=&quot;https://github.com/apache/beam/pull/6517&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/6517&lt;/a&gt;&#160;can we call this closed?&lt;/p&gt;</comment>
                            <comment id="16637361" author="thw" created="Wed, 3 Oct 2018 18:40:45 +0000"  >&lt;p&gt;I verified that this fixes the memory leak observed running: &lt;a href=&quot;https://github.com/lyft/beam/blob/micah_process_streaming_leak/sdks/python/apache_beam/examples/streaming_leak.py&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/lyft/beam/blob/micah_process_streaming_leak/sdks/python/apache_beam/examples/streaming_leak.py&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This branch has a synthetic source for testing in streaming mode. You should be able to cherry pick just the last 2 commits to transplant it to master.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12941257" name="chart.png" size="21881" author="mwylde" created="Tue, 25 Sep 2018 18:16:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 6 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3yhf3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>