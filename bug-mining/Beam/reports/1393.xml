<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:02:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-6923] OOM errors in jobServer when using GCS artifactDir</title>
                <link>https://issues.apache.org/jira/browse/BEAM-6923</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;When starting jobServer with artifactDir pointing to a GCS bucket:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
./gradlew :beam-runners-flink_2.11-job-server:runShadow -PflinkMasterUrl=localhost:8081 -PartifactsDir=gs:&lt;span class=&quot;code-comment&quot;&gt;//the-bucket&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and running a Java portable pipeline with the following, portability related pipeline options:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
--runner=PortableRunner --jobEndpoint=localhost:8099 --defaultEnvironmentType=DOCKER --defaultEnvironmentConfig=gcr.io/&amp;lt;my-freshly-built-sdk-harness-image&amp;gt;/java:latest&apos;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;m facing a series of OOM errors, like this:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;grpc-&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;-executor-3&quot;&lt;/span&gt; java.lang.OutOfMemoryError: Java heap space
at com.google.api.client.googleapis.media.MediaHttpUploader.buildContentChunk(MediaHttpUploader.java:606)
at com.google.api.client.googleapis.media.MediaHttpUploader.resumableUpload(MediaHttpUploader.java:408)
at com.google.api.client.googleapis.media.MediaHttpUploader.upload(MediaHttpUploader.java:336)
at com.google.api.client.googleapis.services.AbstractGoogleClientRequest.executeUnparsed(AbstractGoogleClientRequest.java:508)
at com.google.api.client.googleapis.services.AbstractGoogleClientRequest.executeUnparsed(AbstractGoogleClientRequest.java:432)
at com.google.api.client.googleapis.services.AbstractGoogleClientRequest.execute(AbstractGoogleClientRequest.java:549)
at com.google.cloud.hadoop.util.AbstractGoogleAsyncWriteChannel$UploadOperation.call(AbstractGoogleAsyncWriteChannel.java:301)
at java.util.concurrent.FutureTask.run(FutureTask.java:266)
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This does not happen when I&apos;m using a local filesystem for the artifact staging location.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13224365">BEAM-6923</key>
            <summary>OOM errors in jobServer when using GCS artifactDir</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="angoenka">Ankur Goenka</assignee>
                                    <reporter username="&#321;ukaszG">Lukasz Gajowy</reporter>
                        <labels>
                            <label>Done</label>
                    </labels>
                <created>Wed, 27 Mar 2019 16:42:50 +0000</created>
                <updated>Tue, 6 Oct 2020 21:56:42 +0000</updated>
                            <resolved>Fri, 4 Oct 2019 18:18:08 +0000</resolved>
                                                    <fixVersion>2.17.0</fixVersion>
                                    <component>sdk-java-harness</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="10800">3h</timespent>
                                <comments>
                            <comment id="16803056" author="&#322;ukaszg" created="Wed, 27 Mar 2019 16:56:11 +0000"  >&lt;p&gt;I added some screenshots from a profiler. It looks like there&apos;s lot&apos;s of netty&apos;s MpscArrayQueue and SubPageMemoryRegionCache objects created (I saw 10x less in the profiler when I run this on local filesystem). Looks like the issue is GRPC related. Let me know if more screens are needed*&lt;/p&gt;

&lt;p&gt;*I feel reluctant to include whole heap dump because&#160;I think it contains sensitive information (GCP credentials, other?).&#160;&lt;/p&gt;</comment>
                            <comment id="16803058" author="&#322;ukaszg" created="Wed, 27 Mar 2019 16:56:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/grpc/grpc-java/issues/2232&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/grpc/grpc-java/issues/2232&lt;/a&gt;&#160;- is this related/helpful?&#160;&lt;/p&gt;</comment>
                            <comment id="16803771" author="&#322;ukaszg" created="Thu, 28 Mar 2019 09:57:37 +0000"  >&lt;p&gt;CCing: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ag112&quot; class=&quot;user-hover&quot; rel=&quot;ag112&quot;&gt;ag112&lt;/a&gt; , &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pabloem&quot; class=&quot;user-hover&quot; rel=&quot;pabloem&quot;&gt;pabloem&lt;/a&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16805614" author="pabloem" created="Sat, 30 Mar 2019 04:51:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=angoenka&quot; class=&quot;user-hover&quot; rel=&quot;angoenka&quot;&gt;angoenka&lt;/a&gt; do you know about this issue? &lt;/p&gt;</comment>
                            <comment id="16805616" author="pabloem" created="Sat, 30 Mar 2019 04:52:31 +0000"  >&lt;p&gt;Oops. Sorry about retagging you. I didn&apos;t see you were tagged already&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16836833" author="marcelo.castro" created="Fri, 10 May 2019 02:34:28 +0000"  >&lt;p&gt;Hi! I am having the exact same issue but with the SparkRunner. Using a file instead of a gs location solves the issue. My pipeline consists of just a JdbcIO and a JdbcAvroIO from DBeam project (&lt;a href=&quot;https://github.com/spotify/dbeam&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/spotify/dbeam&lt;/a&gt;). I am reading large tables with more the 100,000,000 records, but the error is thrown way bellow that mark, with just 10,000,000 records read.&lt;/p&gt;</comment>
                            <comment id="16837105" author="mxm" created="Fri, 10 May 2019 09:42:58 +0000"  >&lt;p&gt;It&apos;s not surprising you see this with the Spark Runner as well because the artifact staging code is shared between the portable Flink and Spark Runners.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=%C5%81ukaszG&quot; class=&quot;user-hover&quot; rel=&quot;&#321;ukaszG&quot;&gt;&#321;ukaszG&lt;/a&gt; Is this consistently happening with just a single pipeline execution after a fresh start of the job server?&lt;/p&gt;</comment>
                            <comment id="16837135" author="&#322;ukaszg" created="Fri, 10 May 2019 10:06:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mxm&quot; class=&quot;user-hover&quot; rel=&quot;mxm&quot;&gt;mxm&lt;/a&gt;&#160;yes. As far as I remember there was one or two times the job actually succeeded (luck? more free memory at that&#160;moment?) but definitely most of the time it failed regardless of that I just started the job Server or used an already running one. I only executed a single pipeline at once.&lt;/p&gt;</comment>
                            <comment id="16837294" author="marcelo.castro" created="Fri, 10 May 2019 13:35:56 +0000"  >&lt;p&gt;I saw that the release notes for google-java-api-client mentioned the resume upload (&lt;a href=&quot;https://github.com/googleapis/google-api-java-client/releases/tag/v1.27.0),&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/googleapis/google-api-java-client/releases/tag/v1.27.0),&lt;/a&gt;&#160;so I tryed to downgrade apache beam version to 2.8.0, this is the first one that don&apos;t use google-api-java-client 1.27.0.&lt;/p&gt;

&lt;p&gt;Then the job fails almost instantly with a OOM, just in a different part:&lt;/p&gt;

&lt;p&gt;Edit: I need to shade the google apis due to different version of spark and apache beam versions&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.lang.OutOfMemoryError: Java heap space
at shaded.google.api.client.googleapis.media.MediaHttpUploader.setContentAndHeadersOnCurrentRequest(MediaHttpUploader.java:603)
at shaded.google.api.client.googleapis.media.MediaHttpUploader.resumableUpload(MediaHttpUploader.java:409)
at shaded.google.api.client.googleapis.media.MediaHttpUploader.upload(MediaHttpUploader.java:336)
at shaded.google.api.client.googleapis.services.AbstractGoogleClientRequest.executeUnparsed(AbstractGoogleClientRequest.java:427)
at shaded.google.api.client.googleapis.services.AbstractGoogleClientRequest.executeUnparsed(AbstractGoogleClientRequest.java:352)
at shaded.google.api.client.googleapis.services.AbstractGoogleClientRequest.execute(AbstractGoogleClientRequest.java:469)
at shaded.google.cloud.hadoop.util.AbstractGoogleAsyncWriteChannel$UploadOperation.call(AbstractGoogleAsyncWriteChannel.java:358)
at java.util.concurrent.FutureTask.run(Unknown Source)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16871120" author="iemejia" created="Mon, 24 Jun 2019 12:26:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcelo.castro&quot; class=&quot;user-hover&quot; rel=&quot;marcelo.castro&quot;&gt;marcelo.castro&lt;/a&gt; what was the library causing the conflict with spark?, I am curious if we shall maybe do this repackaging at the runner level to make this work without issues for final users.&lt;/p&gt;</comment>
                            <comment id="16897718" author="angoenka" created="Thu, 1 Aug 2019 02:53:51 +0000"  >&lt;p&gt;Instance count screenshot does not show any issue as the total size was relatively insignificant compared to the heap size.&lt;/p&gt;

&lt;p&gt;Will it be possible to sort by size and see the top the one with the largest size.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Also, does this happen with a specific pipeline or is it the same for all the pipelines?&lt;/p&gt;</comment>
                            <comment id="16901955" author="&#322;ukaszg" created="Wed, 7 Aug 2019 10:21:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=angoenka&quot; class=&quot;user-hover&quot; rel=&quot;angoenka&quot;&gt;angoenka&lt;/a&gt;&#160;I added a new screenshot with size sorted heap dump. However, for future investigation, I think screenshots are not the best way here.&#160;The issue can be easily&#160;reproduced + you can add:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;-XX:+HeapDumpOnOutOfMemoryError&quot;&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to the jvm options in &lt;a href=&quot;https://github.com/apache/beam/blob/ff0f308fb83056bd2ba990de2edec33a0c6c7720/runners/flink/job-server/flink_job_server.gradle#L112&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;flink_job_server.gradle&lt;/a&gt;&#160;file. It will generate the whole heap dump once the error appears. Once you have that you can use jvisualvm tool from JDK to investigate (I just learned that! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; ). See more &lt;a href=&quot;https://docs.oracle.com/javase/7/docs/webnotes/tsg/TSG-VM/html/clopts.html#gbzrr&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;As for the pipelines - I encountered the error while running performance tests of core beam operations. I tried &lt;a href=&quot;https://github.com/apache/beam/blob/e0cbd2aa7e371c75511544ab78075d54f3f086ca/sdks/java/testing/load-tests/src/main/java/org/apache/beam/sdk/loadtests/GroupByKeyLoadTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;GroupByKeyLoadTest&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/beam/blob/e0cbd2aa7e371c75511544ab78075d54f3f086ca/sdks/java/testing/load-tests/src/main/java/org/apache/beam/sdk/loadtests/ParDoLoadTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ParDoLoadTest&lt;/a&gt;. Example command:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
./gradlew --&lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt; --max-workers=12 -Dorg.gradle.jvmargs=-Xms2g -Dorg.gradle.jvmargs=-Xmx4g -PloadTest.mainClass=org.apache.beam.sdk.loadtests.ParDoLoadTest &lt;span class=&quot;code-quote&quot;&gt;&apos;-PloadTest.args=--sourceOptions={&lt;span class=&quot;code-quote&quot;&gt;&quot;numRecords&quot;&lt;/span&gt;:100,&lt;span class=&quot;code-quote&quot;&gt;&quot;keySizeBytes&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;valueSizeBytes&quot;&lt;/span&gt;:9} --iterations=1 --runner=PortableRunner --jobEndpoint=localhost:8099 --defaultEnvironmentType=DOCKER --defaultEnvironmentConfig=gcr.io/apache-beam-testing/beam/java:latest&apos;&lt;/span&gt; :beam-sdks-java-load-tests:run -Prunner=&quot;:runners:reference:java&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;As far as I understand,&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcelo.castro&quot; class=&quot;user-hover&quot; rel=&quot;marcelo.castro&quot;&gt;marcelo.castro&lt;/a&gt;&#160;is running something completely different on Spark and still gets the error.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16902012" author="marcelo.castro" created="Wed, 7 Aug 2019 11:57:12 +0000"  >&lt;p&gt;Sorry for the late response.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iemejia&quot; class=&quot;user-hover&quot; rel=&quot;iemejia&quot;&gt;iemejia&lt;/a&gt;, the library was guava-20, but at the time I was using a mismatched version of beam and spark (spark was in a earlier version than the dependency of Apache beam). I&apos;ll retest this with the newer version of beam and get back to you.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;As for the thread issue. I was uploading files that could have 300+ GB file size using the AvroIO sink. At the time I had a very limited cluster of spark workers, with about 4GB of RAM. The problem is at the async http upload that the gcs lib uses.&lt;/p&gt;

&lt;p&gt;I think that an option should exist to choose to use a sync method instead on limited cluster memory scenarios. (If such option exist, I couldn&apos;t find it)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I solved my problem doing the upload by myself in a ParDo instead of using the AvroIO sink, by uploading in a sync way. Even an async method can be done with a more limited ram, but that is a problem with the Google library.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16905159" author="&#322;ukaszg" created="Mon, 12 Aug 2019 13:02:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=angoenka&quot; class=&quot;user-hover&quot; rel=&quot;angoenka&quot;&gt;angoenka&lt;/a&gt; are you currently working on this issue (can I assign you)? Do you need some more help from my side?&lt;/p&gt;</comment>
                            <comment id="16906557" author="angoenka" created="Tue, 13 Aug 2019 19:31:42 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=%C5%81ukaszG&quot; class=&quot;user-hover&quot; rel=&quot;&#321;ukaszG&quot;&gt;&#321;ukaszG&lt;/a&gt;, I have not looked into this yet.&#160;I will try to take a look at it this week.&lt;/p&gt;

&lt;p&gt;I am mostly likely going to run the pipeline.&lt;/p&gt;

&lt;p&gt;Just to check,&#160;do you use local machine or&#160;do you use a cluster to run the test?&lt;/p&gt;</comment>
                            <comment id="16906565" author="&#322;ukaszg" created="Tue, 13 Aug 2019 19:48:51 +0000"  >&lt;p&gt;It was a local setup - I&apos;ve only run&#160;./start-cluster.sh from a freshly downloaded Flink (no custom setup). FWIW, I&apos;ve reproduced the error on flink 1.5.2 and 1.7.0.&lt;/p&gt;</comment>
                            <comment id="16921759" author="pabloem" created="Tue, 3 Sep 2019 22:44:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=angoenka&quot; class=&quot;user-hover&quot; rel=&quot;angoenka&quot;&gt;angoenka&lt;/a&gt; any updates? I think Lukasz and others are blocked on this : /&lt;/p&gt;</comment>
                            <comment id="16930585" author="&#322;ukaszg" created="Mon, 16 Sep 2019 13:57:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=angoenka&quot; class=&quot;user-hover&quot; rel=&quot;angoenka&quot;&gt;angoenka&lt;/a&gt; let me know if I can help you in any other way.&lt;/p&gt;</comment>
                            <comment id="16933761" author="angoenka" created="Thu, 19 Sep 2019 21:04:04 +0000"  >&lt;p&gt;Sorry, for getting it to it so late.&#160;&lt;/p&gt;

&lt;p&gt;I am trying to reproduce the problem and getting stuck with some other issue with environment when running command in &lt;a href=&quot;https://jira.apache.org/jira/browse/BEAM-6923?focusedCommentId=16901955&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16901955&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jira.apache.org/jira/browse/BEAM-6923?focusedCommentId=16901955&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16901955&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
SLF4J: Failed to load class &lt;span class=&quot;code-quote&quot;&gt;&quot;org.slf4j.impl.StaticLoggerBinder&quot;&lt;/span&gt;. SLF4J: Defaulting to no-operation (NOP) logger implementation SLF4J: See http:&lt;span class=&quot;code-comment&quot;&gt;//www.slf4j.org/codes.html#StaticLoggerBinder &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; further details. Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.lang.UnsupportedOperationException: Not yet implemented. at org.apache.beam.runners.reference.JobServicePipelineResult.metrics(JobServicePipelineResult.java:124) at org.apache.beam.sdk.testutils.metrics.MetricsReader.getDistributions(MetricsReader.java:139) at org.apache.beam.sdk.testutils.metrics.MetricsReader.getEndTimeMetric(MetricsReader.java:122) at org.apache.beam.sdk.loadtests.LoadTest.readMetrics(LoadTest.java:124) at org.apache.beam.sdk.loadtests.LoadTest.run(LoadTest.java:102) at org.apache.beam.sdk.loadtests.ParDoLoadTest.run(ParDoLoadTest.java:53) at org.apache.beam.sdk.loadtests.ParDoLoadTest.main(ParDoLoadTest.java:103)&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16933789" author="angoenka" created="Thu, 19 Sep 2019 21:35:52 +0000"  >&lt;p&gt;The metrics error is still their but I suppose thats not a problem as the pipeline succeed on flink.&lt;/p&gt;

&lt;p&gt;I am using flink 1.5.6&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Command for test&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
./gradlew --&lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt; --max-workers=12 -Dorg.gradle.jvmargs=-Xms2g -Dorg.gradle.jvmargs=-Xmx4g -PloadTest.mainClass=org.apache.beam.sdk.loadtests.ParDoLoadTest &lt;span class=&quot;code-quote&quot;&gt;&apos;-PloadTest.args=--sourceOptions={&lt;span class=&quot;code-quote&quot;&gt;&quot;numRecords&quot;&lt;/span&gt;:100,&lt;span class=&quot;code-quote&quot;&gt;&quot;keySizeBytes&quot;&lt;/span&gt;:1,&lt;span class=&quot;code-quote&quot;&gt;&quot;valueSizeBytes&quot;&lt;/span&gt;:9} --iterations=1 --runner=PortableRunner --jobEndpoint=localhost:8099 --defaultEnvironmentType=DOCKER --defaultEnvironmentConfig=goenka-docker-apache.bintray.io/beam/java&apos;&lt;/span&gt; :sdks:java:testing:load-tests:run -Prunner=&lt;span class=&quot;code-quote&quot;&gt;&quot;:runners:reference:java&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Job server command&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
./gradlew -Dorg.gradle.jvmargs=-XX:+HeapDumpOnOutOfMemoryError runners:flink:1.5:job-server:runShadow -PflinkMasterUrl=localhost:8081
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16933826" author="angoenka" created="Thu, 19 Sep 2019 22:36:16 +0000"  >&lt;p&gt;Also tried using GCS for artifact staging but it seems to be working fine.&lt;/p&gt;

&lt;p&gt;Job server command&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
./gradlew -Dorg.gradle.jvmargs=-XX:+HeapDumpOnOutOfMemoryError runners:flink:1.5:job-server:runShadow -PflinkMasterUrl=localhost:8081 -PartifactsDir=&lt;span class=&quot;code-quote&quot;&gt;&quot;gs:&lt;span class=&quot;code-comment&quot;&gt;//&amp;lt;bucket&amp;gt;/tmp&quot;&lt;/span&gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16933846" author="angoenka" created="Thu, 19 Sep 2019 23:09:46 +0000"  >&lt;p&gt;Also tried staging a 330MB additional file to stage but could&apos;t reproduce it.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=%C5%81ukaszG&quot; class=&quot;user-hover&quot; rel=&quot;&#321;ukaszG&quot;&gt;&#321;ukaszG&lt;/a&gt;&#160;Can you provide brief instruction to reproduce it on master so that I can better debug it.&lt;/p&gt;</comment>
                            <comment id="16936050" author="&#322;ukaszg" created="Mon, 23 Sep 2019 17:17:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=angoenka&quot; class=&quot;user-hover&quot; rel=&quot;angoenka&quot;&gt;angoenka&lt;/a&gt; This is odd - maybe it is happening only on my machine? Let me know if this is the case.&lt;br/&gt;
 I&apos;ve attached 2 videos that show step by step instructions on how to reproduce the issue on 1.5 and 1.8 Flink versions.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12981086/12981086_beam6923-flink156.m4v&quot; title=&quot;beam6923-flink156.m4v attached to BEAM-6923&quot;&gt;beam6923-flink156.m4v&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12981088/12981088_beam6923flink182.m4v&quot; title=&quot;beam6923flink182.m4v attached to BEAM-6923&quot;&gt;beam6923flink182.m4v&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think it&apos;s best to download them - I don&apos;t know why JIRA doesn&apos;t let you play them with sound...&lt;/p&gt;</comment>
                            <comment id="16936132" author="angoenka" created="Mon, 23 Sep 2019 19:16:56 +0000"  >&lt;p&gt;Thats strange.&lt;/p&gt;

&lt;p&gt;I am using linux for testing this.&lt;/p&gt;

&lt;p&gt;Will try it on mac as well.&lt;/p&gt;</comment>
                            <comment id="16936197" author="angoenka" created="Mon, 23 Sep 2019 21:21:18 +0000"  >&lt;p&gt;ACK:&lt;/p&gt;

&lt;p&gt;I am able to reproduce it on MAC&lt;/p&gt;

&lt;p&gt;Environment:&lt;/p&gt;

&lt;p&gt;Java 1.8&lt;/p&gt;

&lt;p&gt;Flink 1.5.6&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;goenka@goenka-macbookpro:~/d/work/beam/beam$ ./gradlew runners:flink:1.5:job-server:runShadow -PflinkMasterUrl=localhost:8081 -PartifactsDir=&quot;gs://clouddfe-goenka/tmp/t0&quot;&lt;br/&gt;
Configuration on demand is an incubating feature.&lt;/p&gt;

&lt;p&gt;&amp;gt; Task :runners:flink:1.5:job-server:runShadow&lt;br/&gt;
Listening for transport dt_socket at address: 5005&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; INFO org.apache.beam.runners.fnexecution.jobsubmission.JobServerDriver - ArtifactStagingService started on localhost:8098&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; INFO org.apache.beam.runners.fnexecution.jobsubmission.JobServerDriver - Java ExpansionService started on localhost:8097&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; INFO org.apache.beam.runners.fnexecution.jobsubmission.JobServerDriver - JobService started on localhost:8099&lt;br/&gt;
Exception in thread &quot;grpc-default-executor-70&quot; java.lang.OutOfMemoryError: Java heap space&lt;br/&gt;
 at com.google.api.client.googleapis.media.MediaHttpUploader.buildContentChunk(MediaHttpUploader.java:606)&lt;br/&gt;
 at com.google.api.client.googleapis.media.MediaHttpUploader.resumableUpload(MediaHttpUploader.java:408)&lt;br/&gt;
 at com.google.api.client.googleapis.media.MediaHttpUploader.upload(MediaHttpUploader.java:336)&lt;br/&gt;
 at com.google.api.client.googleapis.services.AbstractGoogleClientRequest.executeUnparsed(AbstractGoogleClientRequest.java:508)&lt;br/&gt;
 at com.google.api.client.googleapis.services.AbstractGoogleClientRequest.executeUnparsed(AbstractGoogleClientRequest.java:432)&lt;br/&gt;
 at com.google.api.client.googleapis.services.AbstractGoogleClientRequest.execute(AbstractGoogleClientRequest.java:549)&lt;br/&gt;
 at com.google.cloud.hadoop.util.AbstractGoogleAsyncWriteChannel$UploadOperation.call(AbstractGoogleAsyncWriteChannel.java:301)&lt;br/&gt;
 at java.util.concurrent.FutureTask.run(FutureTask.java:266)&lt;br/&gt;
 at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)&lt;br/&gt;
 at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)&lt;br/&gt;
 at java.lang.Thread.run(Thread.java:748)&lt;br/&gt;
Exception in thread &quot;grpc-default-executor-146&quot; java.lang.OutOfMemoryError: Java heap space&lt;br/&gt;
 at com.google.api.client.googleapis.media.MediaHttpUploader.buildContentChunk(MediaHttpUploader.java:606)&lt;br/&gt;
 at com.google.api.client.googleapis.media.MediaHttpUploader.resumableUpload(MediaHttpUploader.java:408)&lt;br/&gt;
 at com.google.api.client.googleapis.media.MediaHttpUploader.upload(MediaHttpUploader.java:336)&lt;br/&gt;
 at com.google.api.client.googleapis.services.AbstractGoogleClientRequest.executeUnparsed(AbstractGoogleClientRequest.java:508)&lt;br/&gt;
 at com.google.api.client.googleapis.services.AbstractGoogleClientRequest.executeUnparsed(AbstractGoogleClientRequest.java:432)&lt;br/&gt;
 at com.google.api.client.googleapis.services.AbstractGoogleClientRequest.execute(AbstractGoogleClientRequest.java:549)&lt;br/&gt;
 at com.google.cloud.hadoop.util.AbstractGoogleAsyncWriteChannel$UploadOperation.call(AbstractGoogleAsyncWriteChannel.java:301)&lt;br/&gt;
 at java.util.concurrent.FutureTask.run(FutureTask.java:266)&lt;br/&gt;
 at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)&lt;br/&gt;
 at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)&lt;br/&gt;
 at java.lang.Thread.run(Thread.java:748)&lt;br/&gt;
Exception in thread &quot;grpc-default-executor-50&quot; java.lang.OutOfMemoryError: Java heap space&lt;br/&gt;
Exception in thread &quot;grpc-default-executor-23&quot; java.lang.OutOfMemoryError: Java heap space&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16936210" author="angoenka" created="Mon, 23 Sep 2019 21:38:28 +0000"  >&lt;p&gt;Also able to reproduce on linux my setting XMX for job server process to be 1GB&lt;/p&gt;</comment>
                            <comment id="16936291" author="angoenka" created="Tue, 24 Sep 2019 01:37:39 +0000"  >&lt;p&gt;Gcsutil.java use sets the default buffer size for individual file write to be 64MB when the VM memory is more than 1GB.&lt;/p&gt;

&lt;p&gt;Artifact staging tend to upload multiple files in parallel and each upload reserves 64MB causing this issue.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Couple of potential fixes are,&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Limiting concurrent upload of files to a lower number.&lt;/li&gt;
	&lt;li&gt;Limit the gcs util buffer size per file.&lt;/li&gt;
	&lt;li&gt;Limit concurrent gcs connections so that it applies to all the file uploads.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;1 applies only to artifact staging but theoretically this problem can impact a pipeline which writes to a bunch of files.&lt;/p&gt;

&lt;p&gt;2 has a performance penalty when writing to a single file.&lt;/p&gt;

&lt;p&gt;&#160;3 applies to all the files but can lead to cases where we keep a file open for long time in pipeline processing&lt;/p&gt;

&lt;p&gt;I am in favor of 1 as the impact will be limited to artifact staging.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=robertwb&quot; class=&quot;user-hover&quot; rel=&quot;robertwb&quot;&gt;robertwb&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16944739" author="pabloem" created="Fri, 4 Oct 2019 18:18:08 +0000"  >&lt;p&gt;I think this has been fixed huh ? : )&lt;/p&gt;</comment>
                            <comment id="16945700" author="&#322;ukaszg" created="Mon, 7 Oct 2019 09:10:27 +0000"  >&lt;p&gt;Yes, thanks! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12963914" name="Instance counts.png" size="161707" author="&#321;ukaszG" created="Wed, 27 Mar 2019 16:47:53 +0000"/>
                            <attachment id="12963913" name="Paths to GC root.png" size="93859" author="&#321;ukaszG" created="Wed, 27 Mar 2019 16:47:53 +0000"/>
                            <attachment id="12963912" name="Telemetries.png" size="94839" author="&#321;ukaszG" created="Wed, 27 Mar 2019 16:47:53 +0000"/>
                            <attachment id="12981086" name="beam6923-flink156.m4v" size="42602391" author="&#321;ukaszG" created="Mon, 23 Sep 2019 17:02:20 +0000"/>
                            <attachment id="12981088" name="beam6923flink182.m4v" size="39326571" author="&#321;ukaszG" created="Mon, 23 Sep 2019 17:11:23 +0000"/>
                            <attachment id="12976919" name="heapdump size-sorted.png" size="300410" author="&#321;ukaszG" created="Wed, 7 Aug 2019 10:02:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 6 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z01614:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>