<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:56:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-4520] No messages delivered after a while with PubsubIO</title>
                <link>https://issues.apache.org/jira/browse/BEAM-4520</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;I am running the following Beam pipeline code locally, with the FlinkRunner. PubsubIO is used to read messages from a topic. I have a separate thread that publishes messages to the topic at regular intervals (every 30 seconds) and also sets the &quot;ts&quot; attribute which is used later to derive the event time.&lt;/p&gt;

&lt;p&gt;Custom transform to convert to KV pair -&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;PubSubMessageGrouper &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; DoFn&amp;lt;PubsubMessage, KV&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, PubsubMessage&amp;gt;&amp;gt; {

    @ProcessElement
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void processElement(ProcessContext c) {
        PubsubMessage element = c.element();
        KV&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, PubsubMessage&amp;gt; kv = KV.of(element.getAttribute(&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;), element);
        c.output(kv);
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Note that &quot;key&quot; is a key set in the message attributes earlier in the publisher thread. The intent is to group the messages downstream by this key.&lt;/p&gt;

&lt;p&gt;Pipeline code -&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
PCollection&amp;lt;PubsubMessage&amp;gt; pubsubColl = p
        .apply(PubsubIO.readMessagesWithAttributes()
            .withTimestampAttribute(&lt;span class=&quot;code-quote&quot;&gt;&quot;ts&quot;&lt;/span&gt;)
            .fromTopic(&lt;span class=&quot;code-quote&quot;&gt;&quot;projects/&quot;&lt;/span&gt; + projectName + &lt;span class=&quot;code-quote&quot;&gt;&quot;/topics/beamtest&quot;&lt;/span&gt;)
        );


PCollection&amp;lt;KV&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, PubsubMessage&amp;gt;&amp;gt; idfied =
        pubsubColl.apply(ParDo.of(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; PubSubMessageGrouper()));

PCollection&amp;lt;KV&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, PubsubMessage&amp;gt;&amp;gt; windowed = idfied
        .apply(Window.&amp;lt;KV&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, PubsubMessage&amp;gt;&amp;gt;into(FixedWindows.of(Duration.standardSeconds(15)))
            .triggering(
                Repeatedly.forever(
                    AfterWatermark.pastEndOfWindow()
                )
            )
            .withAllowedLateness(Duration.standardSeconds(15))
            .discardingFiredPanes());

PCollection&amp;lt;KV&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, Iterable&amp;lt;PubsubMessage&amp;gt;&amp;gt;&amp;gt; grouped = windowed.apply(GroupByKey.create());

grouped.apply(ParDo.of(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; KVPrinter()));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The transforms are not chained for ease of reading. The KVPrinter transform in the end is just to print out the messages received from the group by, which will be subsequently replaced by actual code once I get this running. When I run this, I don&apos;t find the trigger executing for quite some time (a couple of minutes or longer). When it finally triggers, I see that some of the messages are not received (in the final step), not matter how long I keep it running. The Pubsub statistics in my GCP/Stackdriver dashboard show that there is a backlog of undelivered messages.&lt;/p&gt;

&lt;p&gt;Is this due to the internal watermark that PubsubIO uses? My intention here is to make sure that all messages are processed in the groupby, including late ones within the allowed lateness window.&lt;/p&gt;

&lt;p&gt;Note that if I remove the GroupByKey, and just print the messages after the windowing, I can see all the messages.&lt;/p&gt;

&lt;p&gt;--------&lt;/p&gt;

&lt;p&gt;An update:&#160; I switched the .fromTopic to a .fromSubscription, with a pre-created subscription, and things have started working, as in, I can see messages being delivered now. The only difference I can see is that the automatically created subscription from within PubsubIO has an ack deadline of 60 seconds, whereas I created mine with 600 seconds (the max allowed by pubsub).&lt;/p&gt;

&lt;p&gt;However, there is another issue now - messages don&apos;t seem to be getting acked. I keep getting redeliveries of old messages, and the Stackdriver metrics show that the num_undelivered_messages (unacked messages count) keeps on increasing. The documentation says that messages will be acked as soon as a GroupByKey or another ParDo happens, and that&apos;s happening since I am seeing the windowed groupby-s, but acks don&apos;t seem to be happening.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13164850">BEAM-4520</key>
            <summary>No messages delivered after a while with PubsubIO</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mxm">Maximilian Michels</assignee>
                                    <reporter username="talonx">Hrish</reporter>
                        <labels>
                    </labels>
                <created>Fri, 8 Jun 2018 04:38:31 +0000</created>
                <updated>Sat, 16 May 2020 13:31:38 +0000</updated>
                            <resolved>Thu, 31 Jan 2019 10:48:41 +0000</resolved>
                                    <version>2.4.0</version>
                                    <fixVersion>2.11.0</fixVersion>
                                    <component>io-java-gcp</component>
                    <component>runner-flink</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3000">50m</timespent>
                                <comments>
                            <comment id="16505853" author="talonx" created="Fri, 8 Jun 2018 09:22:19 +0000"  >&lt;p&gt;Looks like setting an option on the Flink Runner makes this work. Thanks to &lt;a href=&quot;https://stackoverflow.com/questions/44003584/acknowledge-google-pub-sub-message-on-apache-beam#comment75086787_44003584&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/44003584/acknowledge-google-pub-sub-message-on-apache-beam#comment75086787_44003584&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;However, this is missing in the documentation, so please treat this ticket as one to update the docs. The &lt;a href=&quot;https://beam.apache.org/documentation/runners/flink/#pipeline-options-for-the-flink-runner&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Flink Runner docs&lt;/a&gt; talk about it but there is no mention of how this impacts PubSub acks.&lt;/p&gt;</comment>
                            <comment id="16717596" author="mxm" created="Tue, 11 Dec 2018 17:20:50 +0000"  >&lt;p&gt;It is correct that the acking only works when checkpointing is enabled. This might come as a surprise. The problem is that acking messages without checkpointing doesn&apos;t give exactly-once guarantees upon failure of the job.&lt;/p&gt;</comment>
                            <comment id="16717597" author="mxm" created="Tue, 11 Dec 2018 17:21:31 +0000"  >&lt;p&gt;We should at least WARN or throw an exception if the source needs checkpointing and we are not configured to run with checkpointing.&lt;/p&gt;</comment>
                            <comment id="16739570" author="chamikara" created="Thu, 10 Jan 2019 16:16:15 +0000"  >&lt;p&gt;cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reuvenlax&quot; class=&quot;user-hover&quot; rel=&quot;reuvenlax&quot;&gt;reuvenlax&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=millsd%40google.com&quot; class=&quot;user-hover&quot; rel=&quot;millsd@google.com&quot;&gt;millsd@google.com&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16739581" author="mxm" created="Thu, 10 Jan 2019 16:26:07 +0000"  >&lt;p&gt;I suppose this is more of a Runner problem. We could check upon pipeline translation whether sources require checkpointing and fail/warn accordingly. If the source itself does not indicate whether it needs to be checkpointed to function properly, we have to go with a list of sources.&lt;/p&gt;

&lt;p&gt;Another approach would be to always WARN about checkpointing being disabled if UnboundedSources are present, or to require an explicit override by the user.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                                                <inwardlinks description="is cloned by">
                                        <issuelink>
            <issuekey id="13225857">BEAM-6997</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 44 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3unbj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>