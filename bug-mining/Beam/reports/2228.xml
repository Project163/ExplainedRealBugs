<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:15:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-11805] SpannerReadIT broken in PostCommit_Java</title>
                <link>https://issues.apache.org/jira/browse/BEAM-11805</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;SpannerReadIT started failing after &lt;a href=&quot;https://github.com/apache/beam/pull/13765&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/13765&lt;/a&gt; went in: &lt;br/&gt;
&lt;a href=&quot;https://ci-beam.apache.org/job/beam_PostCommit_Java/7195/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-beam.apache.org/job/beam_PostCommit_Java/7195/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Example log:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.RuntimeException: java.lang.RuntimeException: org.apache.beam.sdk.util.UserCodeException: java.lang.IllegalArgumentException: Multiple entries with same key: user-agent=Apache_Beam_Java/2.29.0-SNAPSHOT and user-agent=spanner-java/3.2.1
	at org.apache.beam.runners.dataflow.worker.IntrinsicMapTaskExecutorFactory$1.typedApply(IntrinsicMapTaskExecutorFactory.java:197)
	at org.apache.beam.runners.dataflow.worker.IntrinsicMapTaskExecutorFactory$1.typedApply(IntrinsicMapTaskExecutorFactory.java:168)
	at org.apache.beam.runners.dataflow.worker.graph.Networks$TypeSafeNodeFunction.apply(Networks.java:66)
	at org.apache.beam.runners.dataflow.worker.graph.Networks$TypeSafeNodeFunction.apply(Networks.java:53)
	at org.apache.beam.runners.dataflow.worker.graph.Networks.replaceDirectedNetworkNodes(Networks.java:90)
	at org.apache.beam.runners.dataflow.worker.IntrinsicMapTaskExecutorFactory.create(IntrinsicMapTaskExecutorFactory.java:128)
	at org.apache.beam.runners.dataflow.worker.BatchDataflowWorker.doWork(BatchDataflowWorker.java:361)
	at org.apache.beam.runners.dataflow.worker.BatchDataflowWorker.getAndPerformWork(BatchDataflowWorker.java:314)
	at org.apache.beam.runners.dataflow.worker.DataflowBatchWorkerHarness$WorkerThread.doWork(DataflowBatchWorkerHarness.java:140)
	at org.apache.beam.runners.dataflow.worker.DataflowBatchWorkerHarness$WorkerThread.call(DataflowBatchWorkerHarness.java:120)
	at org.apache.beam.runners.dataflow.worker.DataflowBatchWorkerHarness$WorkerThread.call(DataflowBatchWorkerHarness.java:107)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: org.apache.beam.sdk.util.UserCodeException: java.lang.IllegalArgumentException: Multiple entries with same key: user-agent=Apache_Beam_Java/2.29.0-SNAPSHOT and user-agent=spanner-java/3.2.1
	at org.apache.beam.sdk.util.UserCodeException.wrap(UserCodeException.java:39)
	at org.apache.beam.sdk.io.gcp.spanner.CreateTransactionFn$DoFnInvoker.invokeSetup(Unknown Source)
	at org.apache.beam.runners.dataflow.worker.DoFnInstanceManagers$ConcurrentQueueInstanceManager.deserializeCopy(DoFnInstanceManagers.java:83)
	at org.apache.beam.runners.dataflow.worker.DoFnInstanceManagers$ConcurrentQueueInstanceManager.peek(DoFnInstanceManagers.java:65)
	at org.apache.beam.runners.dataflow.worker.UserParDoFnFactory.create(UserParDoFnFactory.java:99)
	at org.apache.beam.runners.dataflow.worker.DefaultParDoFnFactory.create(DefaultParDoFnFactory.java:75)
	at org.apache.beam.runners.dataflow.worker.IntrinsicMapTaskExecutorFactory.createParDoOperation(IntrinsicMapTaskExecutorFactory.java:267)
	at org.apache.beam.runners.dataflow.worker.IntrinsicMapTaskExecutorFactory.access$000(IntrinsicMapTaskExecutorFactory.java:89)
	at org.apache.beam.runners.dataflow.worker.IntrinsicMapTaskExecutorFactory$1.typedApply(IntrinsicMapTaskExecutorFactory.java:186)
	... 14 more
Caused by: java.lang.IllegalArgumentException: Multiple entries with same key: user-agent=Apache_Beam_Java/2.29.0-SNAPSHOT and user-agent=spanner-java/3.2.1
	at com.google.common.collect.ImmutableMap.conflictException(ImmutableMap.java:215)
	at com.google.common.collect.ImmutableMap.checkNoConflict(ImmutableMap.java:209)
	at com.google.common.collect.RegularImmutableMap.checkNoConflictInKeyBucket(RegularImmutableMap.java:147)
	at com.google.common.collect.RegularImmutableMap.fromEntryArray(RegularImmutableMap.java:110)
	at com.google.common.collect.ImmutableMap$Builder.build(ImmutableMap.java:393)
	at com.google.cloud.spanner.spi.v1.GapicSpannerRpc.&amp;lt;init&amp;gt;(GapicSpannerRpc.java:320)
	at com.google.cloud.spanner.SpannerOptions$DefaultSpannerRpcFactory.create(SpannerOptions.java:467)
	at com.google.cloud.spanner.SpannerOptions$DefaultSpannerRpcFactory.create(SpannerOptions.java:462)
	at com.google.cloud.ServiceOptions.getRpc(ServiceOptions.java:561)
	at com.google.cloud.spanner.SpannerOptions.getSpannerRpcV1(SpannerOptions.java:1169)
	at com.google.cloud.spanner.SpannerImpl.&amp;lt;init&amp;gt;(SpannerImpl.java:134)
	at com.google.cloud.spanner.SpannerOptions$DefaultSpannerFactory.create(SpannerOptions.java:457)
	at com.google.cloud.spanner.SpannerOptions$DefaultSpannerFactory.create(SpannerOptions.java:452)
	at com.google.cloud.ServiceOptions.getService(ServiceOptions.java:541)
	at org.apache.beam.sdk.io.gcp.spanner.SpannerAccessor.createAndConnect(SpannerAccessor.java:163)
	at org.apache.beam.sdk.io.gcp.spanner.SpannerAccessor.getOrCreate(SpannerAccessor.java:98)
	at org.apache.beam.sdk.io.gcp.spanner.CreateTransactionFn.setup(CreateTransactionFn.java:39)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13358255">BEAM-11805</key>
            <summary>SpannerReadIT broken in PostCommit_Java</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10101" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">P1</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="alxavier">Allen Pradeep Xavier</assignee>
                                    <reporter username="bhulette">Brian Hulette</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Feb 2021 01:11:52 +0000</created>
                <updated>Thu, 13 Jan 2022 21:49:04 +0000</updated>
                            <resolved>Wed, 17 Feb 2021 22:42:51 +0000</resolved>
                                                    <fixVersion>Missing</fixVersion>
                                    <component>io-java-gcp</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="42000">11h 40m</timespent>
                                <comments>
                            <comment id="17283451" author="bhulette" created="Fri, 12 Feb 2021 01:16:55 +0000"  >&lt;p&gt;I confirmed that pr/13765 is the culprit with some local tests. Running SpannerReadIT.testQuery at commit &lt;a href=&quot;https://github.com/apache/beam/commit/e0ba4dc62e6af341cd4448e14ab5839a92516474&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;e0ba4dc6&lt;/a&gt; fails, running it at the preceding commit, &lt;a href=&quot;https://github.com/apache/beam/commit/6e03cfd1dec2ba6356061da99ea3b59caba5b0a0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;6e03cfd1&lt;/a&gt;, passes.&lt;/p&gt;

&lt;p&gt;I guess the BOM update pulled in a new version of the spanner client that has a bug, or is otherwise incompatible with Beam. &lt;/p&gt;</comment>
                            <comment id="17283453" author="bhulette" created="Fri, 12 Feb 2021 01:27:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alxavier&quot; class=&quot;user-hover&quot; rel=&quot;alxavier&quot;&gt;alxavier&lt;/a&gt; could you help diagnose this?&lt;/p&gt;</comment>
                            <comment id="17283455" author="alxavier" created="Fri, 12 Feb 2021 01:34:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nielm&quot; class=&quot;user-hover&quot; rel=&quot;nielm&quot;&gt;nielm&lt;/a&gt;&#160;- Looks like the following line causes issues with latest Cloud Spanner java library upgrade where it could be set automatically??&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/beam/blob/master/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/spanner/SpannerAccessor.java#L160&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/blob/master/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/spanner/SpannerAccessor.java#L160&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I think may be removing this will fix the issue?&lt;/p&gt;

&lt;p&gt;Do you see any issues removing the user-agent?&lt;/p&gt;</comment>
                            <comment id="17283467" author="bhulette" created="Fri, 12 Feb 2021 01:58:12 +0000"  >&lt;p&gt;I&apos;ll see if removing that line fixes the test.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure if it&apos;s safe to remove or not.. it&apos;s been around for a while, added in &lt;a href=&quot;https://github.com/apache/beam/commit/c9c2e81672676e3ec705269a94f11fb1a2596c48&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/commit/c9c2e81672676e3ec705269a94f11fb1a2596c48&lt;/a&gt;. I can&apos;t tell what the motivation was &lt;/p&gt;</comment>
                            <comment id="17283469" author="bhulette" created="Fri, 12 Feb 2021 02:06:32 +0000"  >&lt;p&gt;Confirmed that fixes the test. I guess the issue is that the spanner client started setting the user agent itself.&lt;/p&gt;
</comment>
                            <comment id="17283471" author="alxavier" created="Fri, 12 Feb 2021 02:11:10 +0000"  >&lt;p&gt;Oh cool. I just sent out a PR.&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/beam/pull/13974&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/13974&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17283480" author="alxavier" created="Fri, 12 Feb 2021 02:31:03 +0000"  >&lt;p&gt;Let me do an internal check if we use the user-agent value anywhere.&lt;/p&gt;</comment>
                            <comment id="17283481" author="alxavier" created="Fri, 12 Feb 2021 02:33:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bhulette&quot; class=&quot;user-hover&quot; rel=&quot;bhulette&quot;&gt;bhulette&lt;/a&gt;&#160;can you hold on the merge process?&lt;/p&gt;

&lt;p&gt;I think this is being used internally for identifying that the request originated from Apache beam and setting the priority accordingly.&lt;/p&gt;</comment>
                            <comment id="17283892" author="kenn" created="Fri, 12 Feb 2021 18:04:36 +0000"  >&lt;p&gt;Seems that adding another user-agent key is wrong. They should be appended into a list. I was browsing the gax APIs and I don&apos;t think &lt;tt&gt;HeaderProvider&lt;/tt&gt; has a rich enough API for this.&lt;/p&gt;</comment>
                            <comment id="17284059" author="bhulette" created="Sat, 13 Feb 2021 02:01:00 +0000"  >&lt;p&gt;Rollback is merged, we&apos;ll have to roll it back with the forward fix.&lt;/p&gt;</comment>
                            <comment id="17284074" author="alxavier" created="Sat, 13 Feb 2021 03:16:59 +0000"  >&lt;p&gt;Sent out a new PR &lt;a href=&quot;https://github.com/apache/beam/pull/13990&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/13990&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;1) Can you help with the checkstyle violation - &quot;You are using raw guava, please use vendored guava classes.&quot;&lt;br/&gt;
 import com.google.common.util.concurrent.ThreadFactoryBuilder;&lt;/p&gt;

&lt;p&gt;What would be alternate vendored guava class for this?&lt;/p&gt;

&lt;p&gt;2) Can the test be run against this PR(and the BOM upgrade pr) to check if it passes?&lt;/p&gt;</comment>
                            <comment id="17285364" author="bhulette" created="Tue, 16 Feb 2021 17:17:53 +0000"  >&lt;p&gt;Looks like you figured out (1). For (2) you can comment on the PR with &quot;Run Java PostCommit&quot;, that runs a suite of integration tests including SpannerReadIT &lt;/p&gt;</comment>
                            <comment id="17285583" author="alxavier" created="Wed, 17 Feb 2021 01:44:33 +0000"  >&lt;p&gt;There were some Spanner test issues with the earlier commit. I&apos;m waiting for them to get resolved.&lt;/p&gt;

&lt;p&gt;Once thats green, I will do cherrypick &lt;a href=&quot;https://github.com/apache/beam/pull/13765&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/13765&lt;/a&gt;&#160;and run integration tests again.&lt;/p&gt;</comment>
                            <comment id="17286072" author="alxavier" created="Wed, 17 Feb 2021 18:31:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bhulette&quot; class=&quot;user-hover&quot; rel=&quot;bhulette&quot;&gt;bhulette&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;1) I can only trigger the PreCommit tests(which are successful), I cant seem to trigger the PostCommit tests&lt;/p&gt;

&lt;p&gt;2) There seems to be some merge conflicts after doing the cherry pick. Prior to doing the cherry pick, i had rebased off yesterday&apos;s master branch.&lt;/p&gt;

&lt;p&gt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt; &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-11805&quot; title=&quot;SpannerReadIT broken in PostCommit_Java&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-11805&quot;&gt;&lt;del&gt;BEAM-11805&lt;/del&gt;&lt;/a&gt;-Append-user-agent-header&lt;br/&gt;
 def grpc_version = &quot;1.35.0&quot;&lt;br/&gt;
 def guava_version = &quot;25.1-jre&quot;&lt;br/&gt;
 =======&lt;br/&gt;
 def grpc_version = &quot;1.32.2&quot;&lt;br/&gt;
 def guava_version = &quot;30.1-jre&quot;&lt;br/&gt;
 &amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt; master&lt;/p&gt;</comment>
                            <comment id="17286184" author="alxavier" created="Wed, 17 Feb 2021 22:42:30 +0000"  >&lt;p&gt;Resolving this as the patch is merged.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 38 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0nm54:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>