<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:56:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-6771] Spark Runner Fails on Certain Versions of Spark 2.X</title>
                <link>https://issues.apache.org/jira/browse/BEAM-6771</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;When updating to Beam 2.11.0, I ran into the exception at the bottom of this issue while running a pipeline on the Spark Runner (which worked in 2.9.0). My cluster uses Spark 2.2.1.&lt;/p&gt;

&lt;p&gt;Related Issues:&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-23697&quot; title=&quot;Accumulators of Spark 1.x no longer work with Spark 2.x&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-23697&quot;&gt;&lt;del&gt;SPARK-23697&lt;/del&gt;&lt;/a&gt; (Proof that equals must be implemented for items being accumulated.)&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-1920&quot; title=&quot;Add Spark 2.x support in Spark runner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-1920&quot;&gt;&lt;del&gt;BEAM-1920&lt;/del&gt;&lt;/a&gt; (In PR#3808, equals was implemented on MetricsContainerStepMap to get Spark to run on 2.X.)&lt;/p&gt;

&lt;p&gt;My analysis has lead me to believe that &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-6138&quot; title=&quot;Add User Metric Support to Java SDK&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-6138&quot;&gt;&lt;del&gt;BEAM-6138&lt;/del&gt;&lt;/a&gt; is the reason for this issue.&lt;/p&gt;

&lt;p&gt;Before this change, versions of Spark that are affected by &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-23697&quot; title=&quot;Accumulators of Spark 1.x no longer work with Spark 2.x&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-23697&quot;&gt;&lt;del&gt;SPARK-23697&lt;/del&gt;&lt;/a&gt; would create a new MetricsContainerStepMap and make sure that the copied and reset instance (the one serialized for distribution) is equal to the initial empty MetricsContainerStepMap that is passed in. This would effectively check if two empty ConcurrentHashMaps were equal. This results in true.&lt;/p&gt;

&lt;p&gt;After this change, versions of Spark that are affected by &lt;a href=&quot;https://issues.apache.org/jira/browse/SPARK-23697&quot; title=&quot;Accumulators of Spark 1.x no longer work with Spark 2.x&quot; class=&quot;issue-link&quot; data-issue-key=&quot;SPARK-23697&quot;&gt;&lt;del&gt;SPARK-23697&lt;/del&gt;&lt;/a&gt; would effectively be checking if two empty ConcurrentHashMaps were equal &lt;em&gt;&lt;b&gt;AND&lt;/b&gt;&lt;/em&gt; if two different instances of the MetricsContainerImpl are equal. Because MetricsContainerImpl doesn&apos;t implement equals, this results in false.&lt;/p&gt;

&lt;p&gt;I believe &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-6546&quot; title=&quot;MetricsContainerStepMap equals() method not implemented properly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-6546&quot;&gt;&lt;del&gt;BEAM-6546&lt;/del&gt;&lt;/a&gt; will fix this issue, but I wanted to raise a red flag. I am also hoping someone can verify my analysis.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR ApplicationMaster: User class threw exception: java.lang.RuntimeException: java.lang.AssertionError: assertion failed: copyAndReset must return a zero value copy
java.lang.RuntimeException: java.lang.AssertionError: assertion failed: copyAndReset must return a zero value copy
	at org.apache.beam.runners.spark.SparkPipelineResult.runtimeExceptionFrom(SparkPipelineResult.java:54)
	at org.apache.beam.runners.spark.SparkPipelineResult.beamExceptionFrom(SparkPipelineResult.java:71)
	at org.apache.beam.runners.spark.SparkPipelineResult.waitUntilFinish(SparkPipelineResult.java:98)
	at com.optum.analyticstore.execution.Exec.run(Exec.java:276)
	at com.optum.analyticstore.execution.Exec.main(Exec.java:364)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.apache.spark.deploy.yarn.ApplicationMaster$$anon$2.run(ApplicationMaster.scala:637)
Caused by: java.lang.AssertionError: assertion failed: copyAndReset must return a zero value copy
	at scala.Predef$.assert(Predef.scala:170)
	at org.apache.spark.util.AccumulatorV2.writeReplace(AccumulatorV2.scala:163)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at java.io.ObjectStreamClass.invokeWriteReplace(ObjectStreamClass.java:1218)
	at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1136)
	at java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1548)
	at java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1509)
	at java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1432)
	at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1178)
	at java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1548)
	at java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1509)
	at java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1432)
	at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1178)
	at java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1548)
	at java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1509)
	at java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1432)
	at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1178)
	at java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:348)
	at org.apache.spark.serializer.JavaSerializationStream.writeObject(JavaSerializer.scala:43)
	at org.apache.spark.serializer.JavaSerializerInstance.serialize(JavaSerializer.scala:100)
	at org.apache.spark.util.ClosureCleaner$.ensureSerializable(ClosureCleaner.scala:295)
	at org.apache.spark.util.ClosureCleaner$.org$apache$spark$util$ClosureCleaner$$clean(ClosureCleaner.scala:288)
	at org.apache.spark.util.ClosureCleaner$.clean(ClosureCleaner.scala:108)
	at org.apache.spark.SparkContext.clean(SparkContext.scala:2094)
	at org.apache.spark.rdd.RDD$$anonfun$mapPartitions$1.apply(RDD.scala:794)
	at org.apache.spark.rdd.RDD$$anonfun$mapPartitions$1.apply(RDD.scala:793)
	at org.apache.spark.rdd.RDDOperationScope$.withScope(RDDOperationScope.scala:151)
	at org.apache.spark.rdd.RDDOperationScope$.withScope(RDDOperationScope.scala:112)
	at org.apache.spark.rdd.RDD.withScope(RDD.scala:362)
	at org.apache.spark.rdd.RDD.mapPartitions(RDD.scala:793)
	at org.apache.spark.api.java.JavaRDDLike$class.mapPartitionsToPair(JavaRDDLike.scala:188)
	at org.apache.spark.api.java.AbstractJavaRDDLike.mapPartitionsToPair(JavaRDDLike.scala:45)
	at org.apache.beam.runners.spark.translation.TransformTranslator$6.evaluate(TransformTranslator.java:388)
	at org.apache.beam.runners.spark.translation.TransformTranslator$6.evaluate(TransformTranslator.java:339)
	at org.apache.beam.runners.spark.SparkRunner$Evaluator.doVisitTransform(SparkRunner.java:440)
	at org.apache.beam.runners.spark.SparkRunner$Evaluator.visitPrimitiveTransform(SparkRunner.java:428)
	at org.apache.beam.sdk.runners.TransformHierarchy$Node.visit(TransformHierarchy.java:665)
	at org.apache.beam.sdk.runners.TransformHierarchy$Node.visit(TransformHierarchy.java:657)
	at org.apache.beam.sdk.runners.TransformHierarchy$Node.visit(TransformHierarchy.java:657)
	at org.apache.beam.sdk.runners.TransformHierarchy$Node.access$600(TransformHierarchy.java:317)
	at org.apache.beam.sdk.runners.TransformHierarchy.visit(TransformHierarchy.java:251)
	at org.apache.beam.sdk.Pipeline.traverseTopologically(Pipeline.java:458)
	at org.apache.beam.runners.spark.SparkRunner.lambda$run$1(SparkRunner.java:224)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.Thread.run(Thread.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13220002">BEAM-6771</key>
            <summary>Spark Runner Fails on Certain Versions of Spark 2.X</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10100" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">P0</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="winkelman.kyle">Kyle Winkelman</assignee>
                                    <reporter username="winkelman.kyle">Kyle Winkelman</reporter>
                        <labels>
                    </labels>
                <created>Wed, 6 Mar 2019 18:29:28 +0000</created>
                <updated>Sat, 16 May 2020 14:21:13 +0000</updated>
                            <resolved>Fri, 15 Mar 2019 09:14:32 +0000</resolved>
                                    <version>2.11.0</version>
                                    <fixVersion>2.12.0</fixVersion>
                                    <component>runner-spark</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="5400">1.5h</timespent>
                                <comments>
                            <comment id="16786162" author="ajamato@google.com" created="Wed, 6 Mar 2019 21:51:17 +0000"  >&lt;p&gt;I noticed as well that equals was not implemented properly. MetricsContainerImpl does not implement it. It will also be an expensive operation to call it. Is it necessary to compare MetricContainerStepMaps for equality? Perhaps for unit tests, but is it necessary for production code?&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-6546?filter=-2&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BEAM-6546?filter=-2&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16786167" author="winkelman.kyle" created="Wed, 6 Mar 2019 22:02:07 +0000"  >&lt;p&gt;Correct I tried to run a production workflow that runs on 2.9.0 and it fails on 2.11.0. It appears to be a silly check that Spark makes (in only a handful of versions). The equality is only called once during setup and only on two empty instances of MetricsContainerStepMaps so I am not worried about how expensive it will be (for Spark Runner).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13212021">BEAM-6517</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13212689">BEAM-6546</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 36 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z00f68:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>