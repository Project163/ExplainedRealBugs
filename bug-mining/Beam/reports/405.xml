<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:45:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-2948] Unable to find registrar when restoring flink job from savepoint</title>
                <link>https://issues.apache.org/jira/browse/BEAM-2948</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;Reported: &lt;a href=&quot;https://lists.apache.org/thread.html/d113707e84d7562e6d0d891830a8d85d76a497435105fe3ed1e06e13@%3Cdev.beam.apache.org%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lists.apache.org/thread.html/d113707e84d7562e6d0d891830a8d85d76a497435105fe3ed1e06e13@%3Cdev.beam.apache.org%3E&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;When I try to restore job from savepoint on one task manager I get the&lt;br/&gt;
exception &lt;b&gt;Unable to find registrar for s3n&lt;/b&gt;.&lt;br/&gt;
The job can write files to s3 acting as a sink. So S3 access works except&lt;br/&gt;
when restoring from savepoint.&lt;/p&gt;

&lt;p&gt;I am passing the following configuration as the  pipeline&lt;br/&gt;
HadoopFileSystemOptions&lt;br/&gt;
options:&lt;/p&gt;

&lt;p&gt;Configuration configuration = new Configuration();&lt;br/&gt;
            configuration.set(&quot;fs.defaultFS&quot;, String.format(&quot;s3n://%s&quot;,&lt;br/&gt;
jobOptions.getOutputFileSystemRoot()));&lt;br/&gt;
            configuration.set(&quot;fs.default.name&quot;, String.format(&quot;s3n://%s&quot;,&lt;br/&gt;
jobOptions.getOutputFileSystemRoot()));&lt;br/&gt;
            configuration.set(&quot;fs.s3.impl&quot;,&lt;br/&gt;
&quot;org.apache.hadoop.fs.s3native.NativeS3FileSystem&quot;);&lt;br/&gt;
            configuration.set(&quot;fs.s3n.awsAccessKeyId&quot;,&lt;br/&gt;
jobOptions.getAwsAccessKey());&lt;br/&gt;
            configuration.set(&quot;fs.s3n.awsSecretAccessKey&quot;,&lt;br/&gt;
jobOptions.getAwsSecretKey());&lt;/p&gt;



&lt;p&gt;From my investigation it looks like Beam FileSystems.&lt;br/&gt;
setDefaultPipelineOptions method is not called before&lt;br/&gt;
org.apache.beam.sdk.io.FileBasedSink$FileResultCoder relay on initialised&lt;br/&gt;
FileSystems.SCHEME_TO_FILESYSTEM map&lt;/p&gt;



&lt;p&gt;java.lang.IllegalStateException: Could not initialize keyed state backend.&lt;br/&gt;
at&lt;br/&gt;
org.apache.flink.streaming.api.operators.AbstractStreamOperator.initKeyedState(AbstractStreamOperator.java:293)&lt;br/&gt;
at&lt;br/&gt;
org.apache.flink.streaming.api.operators.AbstractStreamOperator.initializeState(AbstractStreamOperator.java:204)&lt;br/&gt;
at&lt;br/&gt;
org.apache.flink.streaming.runtime.tasks.StreamTask.initializeOperators(StreamTask.java:653)&lt;br/&gt;
at&lt;br/&gt;
org.apache.flink.streaming.runtime.tasks.StreamTask.initializeState(StreamTask.java:640)&lt;br/&gt;
at&lt;br/&gt;
org.apache.flink.streaming.runtime.tasks.StreamTask.invoke(StreamTask.java:246)&lt;br/&gt;
at org.apache.flink.runtime.taskmanager.Task.run(Task.java:665)&lt;br/&gt;
at java.lang.Thread.run(Thread.java:748)&lt;br/&gt;
Caused by: java.lang.IllegalStateException: Unable to find registrar for s3n&lt;br/&gt;
at&lt;br/&gt;
org.apache.beam.sdk.io.FileSystems.getFileSystemInternal(FileSystems.java:447)&lt;br/&gt;
at org.apache.beam.sdk.io.FileSystems.matchNewResource(FileSystems.java:523)&lt;br/&gt;
at&lt;br/&gt;
org.apache.beam.sdk.io.FileBasedSink$FileResultCoder.decode(FileBasedSink.java:1059)&lt;br/&gt;
at&lt;br/&gt;
org.apache.beam.sdk.io.FileBasedSink$FileResultCoder.decode(FileBasedSink.java:1020)&lt;br/&gt;
at&lt;br/&gt;
org.apache.beam.runners.flink.translation.types.CoderTypeSerializer.deserialize(CoderTypeSerializer.java:87)&lt;br/&gt;
at&lt;br/&gt;
org.apache.flink.runtime.state.ArrayListSerializer.deserialize(ArrayListSerializer.java:87)&lt;br/&gt;
at&lt;br/&gt;
org.apache.flink.runtime.state.ArrayListSerializer.deserialize(ArrayListSerializer.java:27)&lt;br/&gt;
at&lt;br/&gt;
org.apache.flink.runtime.state.heap.HeapKeyedStateBackend.readStateTableForKeyGroup(HeapKeyedStateBackend.java:370)&lt;br/&gt;
at&lt;br/&gt;
org.apache.flink.runtime.state.heap.HeapKeyedStateBackend.restorePartitionedState(HeapKeyedStateBackend.java:340)&lt;br/&gt;
at&lt;br/&gt;
org.apache.flink.runtime.state.heap.HeapKeyedStateBackend.restore(HeapKeyedStateBackend.java:243)&lt;br/&gt;
at&lt;br/&gt;
org.apache.flink.streaming.runtime.tasks.StreamTask.createKeyedStateBackend(StreamTask.java:788)&lt;br/&gt;
at&lt;br/&gt;
org.apache.flink.streaming.api.operators.AbstractStreamOperator.initKeyedState(AbstractStreamOperator.java:284)&lt;br/&gt;
... 6 more&lt;/p&gt;</description>
                <environment>Flink v1.2.1 job on a EMR cluster using Beam v2.0.0</environment>
        <key id="13101766">BEAM-2948</key>
            <summary>Unable to find registrar when restoring flink job from savepoint</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10103" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">P3</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aljoscha">Aljoscha Krettek</assignee>
                                    <reporter username="lcwik">Luke Cwik</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Sep 2017 20:25:26 +0000</created>
                <updated>Fri, 24 Jul 2020 20:18:09 +0000</updated>
                            <resolved>Tue, 19 Sep 2017 09:48:02 +0000</resolved>
                                                    <fixVersion>2.2.0</fixVersion>
                                    <component>runner-flink</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16166124" author="aljoscha" created="Thu, 14 Sep 2017 11:48:37 +0000"  >&lt;p&gt;I think the problem is that Beam will only &quot;instantiate&quot; the Hadoop options that are passed via pipeline options at a point when it is too late (This is done in &lt;tt&gt;FileSystem.setDefaultPipelineOptions()&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;FileBasedSink&lt;/tt&gt; uses a &lt;tt&gt;GroupByKey&lt;/tt&gt; internally, which requires storing a &lt;tt&gt;FileResult&lt;/tt&gt; in state. Decoding this (using &lt;tt&gt;FileResultCoder&lt;/tt&gt;) will try and resolve the Hadoop FileSystem. When using the Heap state backend (or &lt;tt&gt;FsStateBackend&lt;/tt&gt;) in Flink, state is eagerly deserialised when the pipeline/operator is started. &lt;/p&gt;

&lt;p&gt;I see some possible solutions:&lt;br/&gt;
 1. Use the &lt;tt&gt;RocksDBStateBackend&lt;/tt&gt; which deserialises state lazily so decoding should happen after the Hadoop options have been instantiated&lt;br/&gt;
 2. We have to change &lt;tt&gt;FileResultCoder&lt;/tt&gt; to not try and eagerly get a Hadoop Filesystem but instead do this lazily when required.&lt;/p&gt;</comment>
                            <comment id="16166666" author="lcwik" created="Thu, 14 Sep 2017 17:39:15 +0000"  >&lt;p&gt;FileSystems assumes that it has been initialized early on within each &quot;worker&quot;. If this isn&apos;t honored then we may find other areas where this is also an issue.&lt;/p&gt;

&lt;p&gt;Also, once this is executing over the portability framework, this will be a non-issue since it will all happen in the SDK harness.&lt;/p&gt;</comment>
                            <comment id="16167532" author="aljoscha" created="Fri, 15 Sep 2017 08:32:38 +0000"  >&lt;p&gt;Yes, that&apos;s true but we probably have to wait a few more versions until that lands. In the mean time, I think we can solve this issue by initialising the &lt;tt&gt;FileSystems&lt;/tt&gt; earlier, in &lt;tt&gt;DoFnOperator.setup()&lt;/tt&gt; which is called before state is eagerly deserialised.&lt;/p&gt;</comment>
                            <comment id="16167603" author="githubbot" created="Fri, 15 Sep 2017 09:24:32 +0000"  >&lt;p&gt;GitHub user aljoscha opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/beam/pull/3855&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/3855&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-2948&quot; title=&quot;Unable to find registrar when restoring flink job from savepoint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-2948&quot;&gt;&lt;del&gt;BEAM-2948&lt;/del&gt;&lt;/a&gt; Register default FileSystems in StreamOperator.setup()&lt;/p&gt;

&lt;p&gt;    Unfortunately, we currently can&apos;t test this fix because there are so many places where `FileSystems.setDefaultPipelineOptions()` is called so in a unit test/IT case environments we already always had the right registrars registered.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/aljoscha/beam&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/aljoscha/beam&lt;/a&gt; jira-2948-fix-filesystems-registrar-flink&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/beam/pull/3855.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/3855.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3855&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit d3ac95e995f517e398436ef6efc92d765b182b1a&lt;br/&gt;
Author: Aljoscha Krettek &amp;lt;aljoscha.krettek@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-09-15T09:20:43Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-2948&quot; title=&quot;Unable to find registrar when restoring flink job from savepoint&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-2948&quot;&gt;&lt;del&gt;BEAM-2948&lt;/del&gt;&lt;/a&gt; Register default FileSystems in StreamOperator.setup()&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16167625" author="pawelbartoszek" created="Fri, 15 Sep 2017 09:37:59 +0000"  >&lt;p&gt;For anybody running into similar issue before the PR is merged - we used &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;RocksDBStateBackend&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; as a state backed and it fixed the problem.&lt;/p&gt;</comment>
                            <comment id="16171426" author="githubbot" created="Tue, 19 Sep 2017 09:47:34 +0000"  >&lt;p&gt;Github user aljoscha closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/beam/pull/3855&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/3855&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16171427" author="aljoscha" created="Tue, 19 Sep 2017 09:48:02 +0000"  >&lt;p&gt;Fixed in 14ea5abe3c3900e5cb423a8580fbdcc6e28fe376&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 9 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3jzjb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>