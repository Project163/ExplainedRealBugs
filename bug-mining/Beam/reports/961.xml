<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:55:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-6407] regression: FileIO.writeDynamic() with side inputs fails in DirectRunner</title>
                <link>https://issues.apache.org/jira/browse/BEAM-6407</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;When FileIO.writeDynamic is used with&#160;automatic sharding and&#160; a Contextful.Fn that uses side inputs for the file naming, DirectRunner (and TestPipeline) fail with:&#160;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;java.lang.IllegalStateException: All PCollectionViews that are consumed must be written by some WriteView PTransform: Missing [&amp;lt;unnamed&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;RunnerPCollectionView&amp;#93;&lt;/span&gt;]&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Example code:&#160;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
PCollectionView&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; outputFileName =
&#160; &#160;pipeline.apply(
&#160; &#160; &#160; &lt;span class=&quot;code-quote&quot;&gt;&quot;outputDir&quot;&lt;/span&gt;,
&#160; &#160; &#160; &#160;Create.of(&lt;span class=&quot;code-quote&quot;&gt;&quot;/tmp/testout&quot;&lt;/span&gt;)).apply(View.asSingleton());

Contextful.Fn&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, FileIO.Write.FileNaming&amp;gt; manifestNaming =
&#160; &#160;(element, c) -&amp;gt;
&#160; &#160; &#160; (window, pane, numShards, shardIndex, compression) -&amp;gt; 
&#160; &#160; &#160; &#160; &#160;c.sideInput(outputFileName)+shardIndex;

pipeline.apply(FileIO.&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;writeDynamic()
&#160; &#160;.by(SerializableFunctions.constant(&quot;&quot;))
&#160; &#160;.withDestinationCoder(StringUtf8Coder.of())
&#160; &#160;.via(TextIO.sink())
&#160; &#160;.withTempDirectory(&lt;span class=&quot;code-quote&quot;&gt;&quot;/tmp&quot;&lt;/span&gt;)
&#160; &#160;.withNaming(Contextful.of(
&#160; &#160; &#160; manifestNaming,
&#160; &#160; &#160; Requirements.requiresSideInputs(outputFileName))));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This does not occur in Dataflow-runner&lt;/p&gt;

&lt;p&gt;It does not occur if the ContextFul.Fn&#160;is not given side inputs.&lt;/p&gt;

&lt;p&gt;It does not occur if withNumShards(1) is set.&lt;/p&gt;

&lt;p&gt;It did not occur in 2.8.0, and does in 2.9.0 and 2.10.0-SNAPSHOT (as of today)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The cause appears to be&#160;due to the DirectRunner using TransformOverrides re-writing FileIO sinks to use runner-determined-sharding&lt;/p&gt;

&lt;p&gt;( see &lt;a href=&quot;https://github.com/apache/beam/blob/master/runners/direct-java/src/main/java/org/apache/beam/runners/direct/DirectRunner.java#L226&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;DirectRunner.java line 226&lt;/a&gt;&#160;)&lt;/p&gt;

&lt;p&gt;&#160;but I do not know why this started occuring in 2.9.0...&lt;/p&gt;</description>
                <environment></environment>
        <key id="13209022">BEAM-6407</key>
            <summary>regression: FileIO.writeDynamic() with side inputs fails in DirectRunner</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="5">Cannot Reproduce</resolution>
                                        <assignee username="nielm">Niel Markwick</assignee>
                                    <reporter username="nielm">Niel Markwick</reporter>
                        <labels>
                            <label>regression</label>
                            <label>stale-assigned</label>
                    </labels>
                <created>Fri, 11 Jan 2019 14:57:41 +0000</created>
                <updated>Tue, 2 Jun 2020 09:06:33 +0000</updated>
                            <resolved>Tue, 2 Jun 2020 09:06:33 +0000</resolved>
                                    <version>2.9.0</version>
                                    <fixVersion>2.10.0</fixVersion>
                                    <component>runner-direct</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="9000">2.5h</timespent>
                                <comments>
                            <comment id="16740480" author="nielm" created="Fri, 11 Jan 2019 15:22:34 +0000"  >&lt;p&gt;Attached reproduction code:&#160;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12954600/12954600_beam-filewriter-demo.tgz&quot; title=&quot;beam-filewriter-demo.tgz attached to BEAM-6407&quot;&gt;beam-filewriter-demo.tgz&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;br/&gt;
 pom has profiles for beam 2.9.0 and 2.8.0.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
mvn compile exec:java \ 
 &#160;&#160;&#160;&#160;-Dexec.mainClass=com.google.nielm.FileWriterTest \&#160;
 &#160;&#160;&#160;&#160;-Dexec.args=&lt;span class=&quot;code-quote&quot;&gt;&quot;--runner=DirectRunner&quot;&lt;/span&gt; -Pbeam-2-9-0

---- testFileContextfulNaming --- 
---- SUCCESS
---- testFileWriterContextfulSideInputNaming --- 
java.lang.IllegalStateException: All PCollectionViews that are consumed must be written by some WriteView PTransform: Missing [&amp;lt;unnamed&amp;gt; [RunnerPCollectionView]]
# snip #
---- FAIL
---- testFileWriterContextfulSideInputNamingSingleShard --- 
---- SUCCESS

mvn compile exec:java \
     -Dexec.mainClass=com.google.nielm.FileWriterTest \
     -Dexec.args=&lt;span class=&quot;code-quote&quot;&gt;&quot;--runner=DirectRunner&quot;&lt;/span&gt; -Pbeam-2-8-0

---- testFileContextfulNaming --- 
---- SUCCESS
---- testFileWriterContextfulSideInputNaming --- 
---- SUCCESS
---- testFileWriterContextfulSideInputNamingSingleShard --- 
---- SUCCESS
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16740609" author="nielm" created="Fri, 11 Jan 2019 18:10:12 +0000"  >&lt;p&gt;Workaround Specify command line parameter: --runnerDeterminedSharding=false&lt;/p&gt;

&lt;p&gt;For TestPipeline, add the following to the surefire plugin configuration section to the pom.xml:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;configuration&amp;gt;&lt;/span&gt;
          &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;systemPropertyVariables&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;beamTestPipelineOptions&amp;gt;&lt;/span&gt;
              [ &lt;span class=&quot;code-quote&quot;&gt;&quot;--runnerDeterminedSharding=false&quot;&lt;/span&gt; ]
            &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/beamTestPipelineOptions&amp;gt;&lt;/span&gt;
          &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/systemPropertyVariables&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;code-tag&quot;&gt;&amp;lt;/configuration&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16740752" author="kenn" created="Fri, 11 Jan 2019 20:24:00 +0000"  >&lt;p&gt;Seems like a good candidate for bisection, if the offending PR is not obvious.&lt;/p&gt;</comment>
                            <comment id="16744312" author="nielm" created="Wed, 16 Jan 2019 18:09:20 +0000"  >&lt;p&gt;After bisection, the offending commit is:&#160;&lt;a href=&quot;https://github.com/apache/beam/commit/1ca760591cdf007b76d4c8ccf69bafcb10e8b144&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;1ca760591cdf007b76d4c8ccf69bafcb10e8b144&lt;/a&gt;&lt;br/&gt;
(from PR &lt;a href=&quot;https://github.com/apache/beam/pull/6909&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;#6909&lt;/a&gt; / bug&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-5933&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;BEAM-5933&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;This change is changing the hashCode implementation for&#160;SimplePCollectionView &#8211; looking at the it, the change of implementation &lt;em&gt;will&lt;/em&gt; change the actual hashcode returned.&lt;/p&gt;

&lt;p&gt;I cannot explain &lt;em&gt;why&lt;/em&gt; this triggers the issue, but as the issue &lt;em&gt;is&lt;/em&gt; related to re-writing transforms that use PCollectionViews, it kind of makes sense.&#160;&lt;/p&gt;

&lt;p&gt;Whats the next step?&lt;/p&gt;

&lt;p&gt;I can submit a PR to rollback this commit for 2.10.0, but should we also add a test?&lt;/p&gt;</comment>
                            <comment id="16744436" author="kenn" created="Wed, 16 Jan 2019 20:29:45 +0000"  >&lt;p&gt;We have a &quot;rollback first&quot; policy but we do need evidence that the rollback solves it. Your comment here that you did a git bisect is pretty good, but it would be even better to put your repro into a test suite. Commented on the PR to that effect.&lt;/p&gt;</comment>
                            <comment id="16844199" author="jack9" created="Mon, 20 May 2019 18:30:43 +0000"  >&lt;p&gt;@Niel Markwick&lt;/p&gt;

&lt;p&gt;I have run this test case against 2.12.0 and it is failing, as before.&lt;/p&gt;

&lt;p&gt;This specific ticket was closed. Is there a followup regression ticket?&lt;/p&gt;</comment>
                            <comment id="16855053" author="iemejia" created="Mon, 3 Jun 2019 21:09:15 +0000"  >&lt;p&gt;Mmm this looks important, should we reopen it maybe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kenn&quot; class=&quot;user-hover&quot; rel=&quot;kenn&quot;&gt;kenn&lt;/a&gt;? Maybe check also if we are covering this in some ValidatesRunner test too.&lt;/p&gt;</comment>
                            <comment id="16856033" author="kenn" created="Tue, 4 Jun 2019 19:08:25 +0000"  >&lt;p&gt;Yea, makes sense. Did the rolled back thing get rolled forwards again? Unfortunately the commit messages in the revert do not specify the hash of the commit(s) nor PR number. I don&apos;t currently have the time/appetite for search PR by subject line.&lt;/p&gt;</comment>
                            <comment id="16856034" author="kenn" created="Tue, 4 Jun 2019 19:08:37 +0000"  >&lt;p&gt;Did it roll forward?&lt;/p&gt;</comment>
                            <comment id="17122160" author="kenn" created="Tue, 2 Jun 2020 04:00:46 +0000"  >&lt;p&gt;This issue is assigned but has not received an update in 30 days so it has been labeled &quot;stale-assigned&quot;. If you are still working on the issue, please give an update and remove the label. If you are no longer working on the issue, please unassign so someone else may work on it. In 7 days the issue will be automatically unassigned.&lt;/p&gt;</comment>
                            <comment id="17123538" author="nielm" created="Tue, 2 Jun 2020 09:06:33 +0000"  >&lt;p&gt;I cannot reproduce the issue in beam versions 2.10 -&amp;gt; 2.21.&lt;/p&gt;



&lt;p&gt;I assume it was fixed by &amp;lt;something&amp;gt; in 2.10&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13195665">BEAM-5933</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12954600" name="beam-filewriter-demo.tgz" size="1986" author="nielm" created="Fri, 11 Jan 2019 15:32:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10431"><![CDATA[Important]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 24 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|u00qyo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>