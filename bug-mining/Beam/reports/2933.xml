<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:25:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-14146] Python Streaming job failing to drain with BigQueryIO write errors</title>
                <link>https://issues.apache.org/jira/browse/BEAM-14146</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;We have a Python Streaming Dataflow job that writes to BigQuery using the &lt;tt&gt;FILE_LOADS&lt;/tt&gt; method and &lt;tt&gt;auto_sharding&lt;/tt&gt; enabled. When we try to drain the job it fails with the following error,&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-python&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/local/lib/python3.7/site-packages/apache_beam/io/gcp/bigquery_tools.py&quot;&lt;/span&gt;, line 1000, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; perform_load_job &lt;span class=&quot;code-object&quot;&gt;ValueError&lt;/span&gt;: Either a non-empty &lt;span class=&quot;code-object&quot;&gt;list&lt;/span&gt; of fully-qualified source URIs must be provided via the source_uris parameter &lt;span class=&quot;code-keyword&quot;&gt;or&lt;/span&gt; an &lt;span class=&quot;code-object&quot;&gt;open&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;file&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;object&lt;/span&gt; must be provided via the source_stream parameter.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Our &lt;tt&gt;WriteToBigQuery&lt;/tt&gt;&#160;configuration,&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-python&quot;&gt;
beam.io.WriteToBigQuery(
  table=options.output_table,
  schema=bq_schema,
  create_disposition=beam.io.BigQueryDisposition.CREATE_IF_NEEDED,
  write_disposition=beam.io.BigQueryDisposition.WRITE_APPEND,
  insert_retry_strategy=RetryStrategy.RETRY_ON_TRANSIENT_ERROR,
  method=beam.io.WriteToBigQuery.Method.FILE_LOADS,
  additional_bq_parameters={
    &lt;span class=&quot;code-quote&quot;&gt;&quot;timePartitioning&quot;&lt;/span&gt;: {
      &lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;type&lt;/span&gt;&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;HOUR&quot;&lt;/span&gt;,
      &lt;span class=&quot;code-quote&quot;&gt;&quot;field&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;bq_insert_timestamp&quot;&lt;/span&gt;,
    },
    &lt;span class=&quot;code-quote&quot;&gt;&quot;schemaUpdateOptions&quot;&lt;/span&gt;: [&lt;span class=&quot;code-quote&quot;&gt;&quot;ALLOW_FIELD_ADDITION&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;ALLOW_FIELD_RELAXATION&quot;&lt;/span&gt;],
  },
  triggering_frequency=120,
  with_auto_sharding=&lt;span class=&quot;code-keyword&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;True&lt;/span&gt;&lt;/span&gt;,
)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We are also noticing that the job only fails to drain when there are actual schema updates. If there are no schema updates the job drains without the above error.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13435170">BEAM-14146</key>
            <summary>Python Streaming job failing to drain with BigQueryIO write errors</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10101" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">P1</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="heejong">Heejong Lee</assignee>
                                    <reporter username="rahuli">Rahul Iyer</reporter>
                        <labels>
                    </labels>
                <created>Tue, 22 Mar 2022 17:29:35 +0000</created>
                <updated>Sun, 5 Jun 2022 01:22:13 +0000</updated>
                                            <version>2.37.0</version>
                                    <fixVersion>2.40.0</fixVersion>
                                    <component>io-py-gcp</component>
                    <component>sdk-py-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="6000">1h 40m</timespent>
                                <comments>
                            <comment id="17512002" author="chamikara" created="Thu, 24 Mar 2022 18:00:31 +0000"  >&lt;p&gt;Thanks for reporting. Are you able to unblock by using STEAMING_INSERTS method ?&lt;/p&gt;

&lt;p&gt;Also, does this occur consistently ? &lt;/p&gt;

&lt;p&gt;cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pabloem&quot; class=&quot;user-hover&quot; rel=&quot;pabloem&quot;&gt;pabloem&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17512006" author="JIRAUSER285712" created="Thu, 24 Mar 2022 18:05:38 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Are you able to unblock by using STEAMING_INSERTS method ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No, we want to use&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;schemaUpdateOptions&quot;&lt;/span&gt;: [&lt;span class=&quot;code-quote&quot;&gt;&quot;ALLOW_FIELD_ADDITION&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;ALLOW_FIELD_RELAXATION&quot;&lt;/span&gt;],
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and I believe this is not supported while using &lt;tt&gt;STEAMING_INSERTS&lt;/tt&gt;.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Also, does this occur consistently ?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I believe so yeah.&lt;/p&gt;</comment>
                            <comment id="17524645" author="chamikara" created="Wed, 20 Apr 2022 00:46:21 +0000"  >&lt;p&gt;I&apos;m not sure of &quot;schemaUpdateOptions&quot; can be correctly supported for streaming pipelines where we have to repeatedly trigger multiple load jobs.&lt;/p&gt;

&lt;p&gt;Assigning to Pablo to look into this and either.&lt;br/&gt;
(1) Make sure it&apos;s supported correctly and add appropriate tests&lt;br/&gt;
(2) Document that this is not supported for streaming and fail pipelines early&lt;/p&gt;</comment>
                            <comment id="17530248" author="chamikara" created="Fri, 29 Apr 2022 21:09:32 +0000"  >&lt;p&gt;Forwarding to Heejong.&lt;/p&gt;</comment>
                            <comment id="17530996" author="heejong" created="Tue, 3 May 2022 00:43:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chamikara&quot; class=&quot;user-hover&quot; rel=&quot;chamikara&quot;&gt;chamikara&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pabloem&quot; class=&quot;user-hover&quot; rel=&quot;pabloem&quot;&gt;pabloem&lt;/a&gt; Do we really need &lt;a href=&quot;https://github.com/apache/beam/blob/master/sdks/python/apache_beam/io/gcp/bigquery_tools.py#L1005&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt; check? Looks like it&apos;s possible that &lt;tt&gt;perform_load_job&lt;/tt&gt; can be called with empty list of files during pipeline draining. Could we just do no-op with warning messages when it&apos;s called with empty list of files?&lt;/p&gt;</comment>
                            <comment id="17531992" author="chamikara" created="Thu, 5 May 2022 01:43:41 +0000"  >&lt;p&gt;Looks like the check was added &lt;a href=&quot;https://github.com/apache/beam/pull/14113/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I&apos;m OK with relaxing that if that can be safely do so. Also, seems like we support providing an upload stream with the request. Is that only used for testing ? &lt;/p&gt;</comment>
                            <comment id="17531993" author="chamikara" created="Thu, 5 May 2022 01:44:30 +0000"  >&lt;p&gt;cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cccyang&quot; class=&quot;user-hover&quot; rel=&quot;cccyang&quot;&gt;cccyang&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17533011" author="yichi" created="Fri, 6 May 2022 17:56:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=heejong&quot; class=&quot;user-hover&quot; rel=&quot;heejong&quot;&gt;heejong&lt;/a&gt; the PR is merged, is the issue fixed?&lt;/p&gt;</comment>
                            <comment id="17533071" author="heejong" created="Fri, 6 May 2022 20:02:17 +0000"  >&lt;p&gt;I assume that the issue is fixed. We can close this now and reopen later if the issue still persists.&lt;/p&gt;</comment>
                            <comment id="17533645" author="JIRAUSER289187" created="Mon, 9 May 2022 06:58:20 +0000"  >&lt;p&gt;Hi! I am seeing similar issues for the java SDK when draining a job using the new BigQuery insert method, anyone else seeing the same thing? Could it have been introduced at the same time? That exception were thrown during drain time rather than logging like here?&lt;/p&gt;</comment>
                            <comment id="17545105" author="JIRAUSER286259" created="Wed, 1 Jun 2022 19:09:00 +0000"  >&lt;p&gt;Reopen as the issue is still around. Draining the job an error repeatedly appears from the job logs:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
...
content &amp;lt;{ &lt;span class=&quot;code-quote&quot;&gt;&quot;error&quot;&lt;/span&gt;: { &lt;span class=&quot;code-quote&quot;&gt;&quot;code&quot;&lt;/span&gt;: 400, &lt;span class=&quot;code-quote&quot;&gt;&quot;message&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;Load configuration must specify at least one source URI&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;errors&quot;&lt;/span&gt;: [ { &lt;span class=&quot;code-quote&quot;&gt;&quot;message&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;Load configuration must specify at least one source URI&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;domain&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;global&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;reason&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;invalid&quot;&lt;/span&gt; } ], &lt;span class=&quot;code-quote&quot;&gt;&quot;status&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;INVALID_ARGUMENT&quot;&lt;/span&gt; } } &amp;gt; [&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; running &lt;span class=&quot;code-quote&quot;&gt;&apos;Write to BigQuery with file_loads/BigQueryBatchFileLoads/TriggerLoadJobsWithTempTables/ParDo(TriggerLoadJobs)-ptransform-71&apos;&lt;/span&gt;]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are lines in the worker logs:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Warning
2022-05-31T17:28:17.354806423ZBoth source URIs and source stream are not provided. BigQuery load job will not load any data.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Are related to the change of &lt;a href=&quot;https://github.com/apache/beam/pull/17566&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/17566&lt;/a&gt; . Now the job no longer fail but the drain never completes.&lt;/p&gt;</comment>
                            <comment id="17550150" author="JIRAUSER282469" created="Sun, 5 Jun 2022 01:22:13 +0000"  >&lt;p&gt;This issue has been migrated to &lt;a href=&quot;https://github.com/apache/beam/issues/21711&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/issues/21711&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 23 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z10pv4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>