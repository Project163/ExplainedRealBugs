<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:01:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-7866] Python MongoDB IO performance and correctness issues</title>
                <link>https://issues.apache.org/jira/browse/BEAM-7866</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/beam/blob/master/sdks/python/apache_beam/io/mongodbio.py&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/blob/master/sdks/python/apache_beam/io/mongodbio.py&lt;/a&gt; splits the query result by computing number of results in constructor, and then in each reader re-executing the whole query and getting an index sub-range of those results.&lt;/p&gt;

&lt;p&gt;This is broken in several critical ways:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The order of query results returned by find() is not necessarily deterministic, so the idea of index ranges on it is meaningless: each shard may basically get random, possibly overlapping subsets of the total results&lt;/li&gt;
	&lt;li&gt;Even if you add order by `_id`, the database may be changing concurrently to reading and splitting. E.g. if the database contained documents with ids 10 20 30 40 50, and this was split into shards 0..2 and 3..5 (under the assumption that these shards would contain respectively 10 20 30, and 40 50), and then suppose shard 10 20 30 is read and then document 25 is inserted - then the 3..5 shard will read 30 40 50, i.e. document 30 is duplicated and document 25 is lost.&lt;/li&gt;
	&lt;li&gt;Every shard re-executes the query and skips the first start_offset items, which in total is quadratic complexity&lt;/li&gt;
	&lt;li&gt;The query is first executed in the constructor in order to count results, which 1) means the constructor can be super slow and 2) it won&apos;t work at all if the database is unavailable at the time the pipeline is constructed (e.g. if this is a template).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Unfortunately, none of these issues are caught by SourceTestUtils: this class has extensive coverage with it, and the tests pass. This is because the tests return the same results in the same order. I don&apos;t know how to catch this automatically, and I don&apos;t know how to catch the performance issue automatically, but these would all be important follow-up items after the actual fix.&lt;/p&gt;

&lt;p&gt;CC: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chamikara&quot; class=&quot;user-hover&quot; rel=&quot;chamikara&quot;&gt;chamikara&lt;/a&gt; as reviewer.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13248213">BEAM-7866</key>
            <summary>Python MongoDB IO performance and correctness issues</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="10722" iconUrl="https://issues.apache.org/jira/images/icons/statuses/generic.png" description="">Triage Needed</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yichi">Yichi Zhang</assignee>
                                    <reporter username="jkff">Eugene Kirpichov</reporter>
                        <labels>
                    </labels>
                <created>Wed, 31 Jul 2019 20:58:35 +0000</created>
                <updated>Thu, 13 Apr 2023 10:56:09 +0000</updated>
                            <resolved>Wed, 14 Aug 2019 21:41:01 +0000</resolved>
                                                    <fixVersion>2.15.0</fixVersion>
                                    <component>sdk-py-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="43200">12h</timespent>
                                <comments>
                            <comment id="16897522" author="yichi" created="Wed, 31 Jul 2019 21:00:34 +0000"  >&lt;p&gt;Thanks for looking into this, I&apos;ll try to address them asap.&lt;/p&gt;</comment>
                            <comment id="16897555" author="chamikara" created="Wed, 31 Jul 2019 21:39:34 +0000"  >&lt;p&gt;Thanks Eugene for pointing out these issues.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Seems like, in the Java implementation, we build splits with specific IDs. Probably we can do something similar for Python ?&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/beam/blob/master/sdks/java/io/mongodb/src/main/java/org/apache/beam/sdk/io/mongodb/MongoDbIO.java#L519&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/blob/master/sdks/java/io/mongodb/src/main/java/org/apache/beam/sdk/io/mongodb/MongoDbIO.java#L519&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;BTW is it correct to assume that the source will be correct if that MongoDB instance stays static (without any data insertion/deletion/update) for the duration of the execution of the read step ? (I understand that this might be improbable for many applications of the Database).&lt;/p&gt;

&lt;p&gt;Seems like elements will have the same order for different find() calls if the database is static since MongoDB defaults to natural sort order.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://docs.mongodb.com/manual/reference/glossary/#term-natural-order&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.mongodb.com/manual/reference/glossary/#term-natural-order&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16897562" author="jkff" created="Wed, 31 Jul 2019 21:45:08 +0000"  >&lt;p&gt;Yes, splitting by range of id is the right thing to do. And the range of ids has to be captured during split() rather than during constructor - constructor can not do any IO.&lt;/p&gt;

&lt;p&gt;I don&apos;t see anything in MongoDB documentation saying that the natural order is deterministic; &lt;a href=&quot;https://stackoverflow.com/questions/15467099/mongodb-store-and-select-order&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/15467099/mongodb-store-and-select-order&lt;/a&gt; says that it is not.&lt;/p&gt;</comment>
                            <comment id="16898231" author="yichi" created="Thu, 1 Aug 2019 17:49:38 +0000"  >&lt;p&gt;I looked into the split key methods using splitVector in java previously, and found no documentation of how to use python client to do the same thing.&lt;/p&gt;

&lt;p&gt;After many trial and errors I figure out how to call the same api, and will change the split to using splitVector.&#160;&lt;/p&gt;</comment>
                            <comment id="16901243" author="yifanzou" created="Tue, 6 Aug 2019 16:32:27 +0000"  >&lt;p&gt;Any&#160;ETA on this? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yichi&quot; class=&quot;user-hover&quot; rel=&quot;yichi&quot;&gt;yichi&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16901247" author="yichi" created="Tue, 6 Aug 2019 16:35:26 +0000"  >&lt;p&gt;PR is under review, hopefully I can get this done this week.&lt;/p&gt;</comment>
                            <comment id="16907646" author="yifanzou" created="Wed, 14 Aug 2019 21:40:51 +0000"  >&lt;p&gt;The PR got merged. I mark this ticket as resolved.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 13 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z057ww:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>