<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:41:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-891] Flake in Spark metrics library?</title>
                <link>https://issues.apache.org/jira/browse/BEAM-891</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=staslev&quot; class=&quot;user-hover&quot; rel=&quot;staslev&quot;&gt;staslev&lt;/a&gt; I think you implemented this functionality originally? Want to take a look? CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amitsela&quot; class=&quot;user-hover&quot; rel=&quot;amitsela&quot;&gt;amitsela&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Run: &lt;a href=&quot;https://builds.apache.org/job/beam_PostCommit_RunnableOnService_SparkLocal/org.apache.beam$beam-runners-spark/43/testReport/junit/org.apache.beam.sdk.transforms/FilterTest/testFilterGreaterThan/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/beam_PostCommit_RunnableOnService_SparkLocal/org.apache.beam$beam-runners-spark/43/testReport/junit/org.apache.beam.sdk.transforms/FilterTest/testFilterGreaterThan/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Error:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.RuntimeException: java.lang.IndexOutOfBoundsException: 5
	at org.apache.beam.runners.spark.SparkRunner.run(SparkRunner.java:169)
	at org.apache.beam.runners.spark.TestSparkRunner.run(TestSparkRunner.java:77)
	at org.apache.beam.runners.spark.TestSparkRunner.run(TestSparkRunner.java:53)
	at org.apache.beam.sdk.Pipeline.run(Pipeline.java:182)
	at org.apache.beam.sdk.testing.TestPipeline.run(TestPipeline.java:112)
	at org.apache.beam.sdk.transforms.FilterTest.testFilterGreaterThan(FilterTest.java:122)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)
	at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:271)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:70)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:50)
	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:238)
	at org.apache.maven.surefire.junitcore.pc.Scheduler$1.run(Scheduler.java:393)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: java.lang.IndexOutOfBoundsException: 5
	at scala.collection.mutable.ResizableArray$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;apply(ResizableArray.scala:43)
	at scala.collection.mutable.ArrayBuffer.apply(ArrayBuffer.scala:47)
	at scala.collection.IndexedSeqOptimized$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;segmentLength(IndexedSeqOptimized.scala:189)
	at scala.collection.mutable.ArrayBuffer.segmentLength(ArrayBuffer.scala:47)
	at scala.collection.IndexedSeqOptimized$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;indexWhere(IndexedSeqOptimized.scala:198)
	at scala.collection.mutable.ArrayBuffer.indexWhere(ArrayBuffer.scala:47)
	at scala.collection.GenSeqLike$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;indexOf(GenSeqLike.scala:144)
	at scala.collection.AbstractSeq.indexOf(Seq.scala:40)
	at scala.collection.GenSeqLike$&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;indexOf(GenSeqLike.scala:128)
	at scala.collection.AbstractSeq.indexOf(Seq.scala:40)
	at scala.collection.mutable.BufferLike$class.$minus$eq(BufferLike.scala:126)
	at scala.collection.mutable.AbstractBuffer.$minus$eq(Buffer.scala:48)
	at org.apache.spark.metrics.MetricsSystem.removeSource(MetricsSystem.scala:159)
	at org.apache.beam.runners.spark.translation.SparkRuntimeContext.registerMetrics(SparkRuntimeContext.java:94)
	at org.apache.beam.runners.spark.translation.SparkRuntimeContext.&amp;lt;init&amp;gt;(SparkRuntimeContext.java:66)
	at org.apache.beam.runners.spark.translation.EvaluationContext.&amp;lt;init&amp;gt;(EvaluationContext.java:73)
	at org.apache.beam.runners.spark.SparkRunner.run(SparkRunner.java:146)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13017723">BEAM-891</key>
            <summary>Flake in Spark metrics library?</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="staslev">Stas Levin</assignee>
                                    <reporter username="dhalperi">Dan Halperin</reporter>
                        <labels>
                            <label>flake</label>
                    </labels>
                <created>Thu, 3 Nov 2016 16:25:51 +0000</created>
                <updated>Tue, 19 May 2020 15:52:05 +0000</updated>
                            <resolved>Tue, 15 Nov 2016 18:10:14 +0000</resolved>
                                                    <fixVersion>0.4.0</fixVersion>
                                    <component>runner-spark</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15633343" author="amitsela" created="Thu, 3 Nov 2016 16:29:33 +0000"  >&lt;p&gt;We started looking at this, and it looks like a weird race although driver code is not multi-threaded (and tests are forced to execute sequentially).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=staslev&quot; class=&quot;user-hover&quot; rel=&quot;staslev&quot;&gt;staslev&lt;/a&gt; please update once you have something, thanks.  &lt;/p&gt;</comment>
                            <comment id="15633346" author="staslev" created="Thu, 3 Nov 2016 16:30:23 +0000"  >&lt;p&gt;Sure. &lt;br/&gt;
I looked at it a bit this morning, my first impression would be a concurrency issue.&lt;/p&gt;

&lt;p&gt;I was wondering if you have more details on how this suite is run in terms of parallelism?&lt;/p&gt;</comment>
                            <comment id="15633366" author="amitsela" created="Thu, 3 Nov 2016 16:34:49 +0000"  >&lt;p&gt;Well, it &quot;can&apos;t&quot; run in parallel because surefire is configured with &lt;tt&gt;&amp;lt;forkCount&amp;gt;1&amp;lt;/forkCount&amp;gt;&lt;/tt&gt; and &lt;tt&gt;&amp;lt;reuseForks&amp;gt;false&amp;lt;/reuseForks&amp;gt;&lt;/tt&gt;.&lt;br/&gt;
But, we&apos;re using &lt;tt&gt;&amp;lt;beam.spark.test.reuseSparkContext&amp;gt;true&amp;lt;/beam.spark.test.reuseSparkContext&amp;gt;&lt;/tt&gt; so maybe something does get mixed-up there...&lt;/p&gt;</comment>
                            <comment id="15633378" author="amitsela" created="Thu, 3 Nov 2016 16:37:43 +0000"  >&lt;p&gt;We can consider synchronizing &lt;tt&gt;SparkRuntimeContext#registerMetrics(SparkPipelineOptions, JavaSparkContext)&lt;/tt&gt;, or even better, the code that handles the driver&apos;s &lt;tt&gt;MetricsSystem&lt;/tt&gt; (it&apos;s a singleton, so could be accessed from multiple threads).&lt;/p&gt;</comment>
                            <comment id="15644539" author="amitsela" created="Mon, 7 Nov 2016 15:50:51 +0000"  >&lt;p&gt;Just to update: the mentioned failure occurred in build #43 and now we&apos;ve successfully passed build #78.&lt;br/&gt;
Only (1) flake that did occur is related to streaming, which could be (truly) resolved only once triggers are implemented.&lt;/p&gt;

&lt;p&gt;I suggest we leave this open while &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=staslev&quot; class=&quot;user-hover&quot; rel=&quot;staslev&quot;&gt;staslev&lt;/a&gt; keeps investigating but if nothing comes up we should eventually close this.&lt;/p&gt;</comment>
                            <comment id="15648828" author="amitsela" created="Tue, 8 Nov 2016 21:22:09 +0000"  >&lt;p&gt;OK, happened again here: &lt;a href=&quot;https://builds.apache.org/view/Beam/job/beam_PostCommit_RunnableOnService_SparkLocal/96/org.apache.beam$beam-runners-spark/testReport/junit/org.apache.beam.sdk.transforms/CreateTest/testCreate/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/view/Beam/job/beam_PostCommit_RunnableOnService_SparkLocal/96/org.apache.beam$beam-runners-spark/testReport/junit/org.apache.beam.sdk.transforms/CreateTest/testCreate/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=staslev&quot; class=&quot;user-hover&quot; rel=&quot;staslev&quot;&gt;staslev&lt;/a&gt; any ideas so far ?&lt;/p&gt;</comment>
                            <comment id="15650533" author="staslev" created="Wed, 9 Nov 2016 10:10:53 +0000"  >&lt;p&gt;We can indeed try syncing the following block in &lt;tt&gt;SparkRuntimeContext&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;metricsSystem.removeSource(aggregatorMetricSource);
metricsSystem.registerSource(aggregatorMetricSource);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But since other calls to &lt;tt&gt;MetricsSystem#removeSource&lt;/tt&gt; and &lt;tt&gt;MetricsSystem#registerSource&lt;/tt&gt; are not synced (e.g., from Spark itself), this kind of synchronisation will only help if the so called &quot;race&quot; lies in our Beam code. If the race is with Spark&apos;s internal calls, us syncing the above block will not be very helpful.&lt;/p&gt;

&lt;p&gt;Another option would be to replace the above block with this one (which requires some minor changes to &lt;tt&gt;AggregatorMetricSource&lt;/tt&gt;):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(metricsSystem.getSourcesByName(AggregatorMetricSource.NAME).empty()) {
  metricsSystem.registerSource(aggregatorMetricSource);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Which eliminates &lt;tt&gt;SparkRuntimeContext&lt;/tt&gt;&apos;s call to &lt;tt&gt;MetricsSystem#removeSource&lt;/tt&gt; altogether.&lt;/p&gt;</comment>
                            <comment id="15650573" author="amitsela" created="Wed, 9 Nov 2016 10:29:21 +0000"  >&lt;p&gt;Do we want to &quot;remove source&quot; only in case of context reuse ? if so, why not bound it to this condition ?&lt;/p&gt;</comment>
                            <comment id="15650807" author="staslev" created="Wed, 9 Nov 2016 12:30:52 +0000"  >&lt;p&gt;Perhaps it would be safe to go the other way around, i.e., &quot;only add this source if it&apos;s missing&quot;. This way we won&apos;t have to deal with when it should be removed whatsoever.&lt;/p&gt;</comment>
                            <comment id="15653827" author="githubbot" created="Thu, 10 Nov 2016 11:33:41 +0000"  >&lt;p&gt;GitHub user staslev opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/incubator-beam/pull/1332&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/incubator-beam/pull/1332&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Trying to fix &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-891&quot; title=&quot;Flake in Spark metrics library?&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-891&quot;&gt;&lt;del&gt;BEAM-891&lt;/del&gt;&lt;/a&gt;, which makes the build occasionally fail on In&#8230;&lt;/p&gt;

&lt;p&gt;    Be sure to do all of the following to help us incorporate your contribution&lt;br/&gt;
    quickly and easily:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Make sure the PR title is formatted like:&lt;br/&gt;
       `&lt;a href=&quot;#&amp;gt;&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;BEAM-&amp;lt;Jira issue #&amp;gt;&lt;/a&gt; Description of pull request`&lt;/li&gt;
	&lt;li&gt;[ ] Make sure tests pass via `mvn clean verify`. (Even better, enable&lt;br/&gt;
           Travis-CI on your fork and ensure the whole test matrix passes).&lt;/li&gt;
	&lt;li&gt;[ ] Replace `&amp;lt;Jira issue #&amp;gt;` in the title with the actual Jira issue&lt;br/&gt;
           number, if there is one.&lt;/li&gt;
	&lt;li&gt;[ ] If this contribution is large, please file an Apache&lt;br/&gt;
           &lt;span class=&quot;error&quot;&gt;&amp;#91;Individual Contributor License Agreement&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://www.apache.org/licenses/icla.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.apache.org/licenses/icla.txt&lt;/a&gt;).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    &amp;#8212;&lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/staslev/incubator-beam&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/staslev/incubator-beam&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-891&quot; title=&quot;Flake in Spark metrics library?&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-891&quot;&gt;&lt;del&gt;BEAM-891&lt;/del&gt;&lt;/a&gt;-flaky-build&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/incubator-beam/pull/1332.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/incubator-beam/pull/1332.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #1332&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 74a78b7faa4eeb9434935a9d21053ac4cf0fb652&lt;br/&gt;
Author: Stas Levin &amp;lt;staslevin@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-11-10T11:32:51Z&lt;/p&gt;

&lt;p&gt;    Trying to fix &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-891&quot; title=&quot;Flake in Spark metrics library?&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-891&quot;&gt;&lt;del&gt;BEAM-891&lt;/del&gt;&lt;/a&gt;, which makes the build occasionally fail on IndexOutOfBoundsException.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15654002" author="amitsela" created="Thu, 10 Nov 2016 13:10:43 +0000"  >&lt;p&gt;This seems to be the race: &lt;a href=&quot;https://github.com/apache/spark/blob/branch-1.6/streaming/src/main/scala/org/apache/spark/streaming/StreamingContext.scala#L711&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/spark/blob/branch-1.6/streaming/src/main/scala/org/apache/spark/streaming/StreamingContext.scala#L711&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;As the &lt;tt&gt;StreamingContext&lt;/tt&gt; get&apos;s the &lt;tt&gt;env&lt;/tt&gt;&apos;s metricsSystem, which uses the same &lt;tt&gt;MetricsSystem&lt;/tt&gt; as we use in &lt;tt&gt;SparkRuntimeContext&lt;/tt&gt;.&lt;br/&gt;
In general, Spark&apos;s &lt;tt&gt;ENV&lt;/tt&gt; modules are singletons.&lt;/p&gt;

&lt;p&gt;The natural thing to do is to synchronize &lt;tt&gt;MetricsSystem#removeSource(Source)&lt;/tt&gt; but that&apos;s a Spark code we don&apos;t have access to.&lt;/p&gt;</comment>
                            <comment id="15659356" author="amitsela" created="Sat, 12 Nov 2016 09:19:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=staslev&quot; class=&quot;user-hover&quot; rel=&quot;staslev&quot;&gt;staslev&lt;/a&gt; I don&apos;t think &lt;tt&gt;enableSparkSinks&lt;/tt&gt; property in &lt;tt&gt;SparkPipelineOptions&lt;/tt&gt; needs to be &lt;tt&gt;true&lt;/tt&gt; by default (and we should probably change the name as it implies Sinks as pipeline output).&lt;br/&gt;
We have the &lt;tt&gt;NamedAggregatorsTest&lt;/tt&gt; test where it should explicitly set &lt;tt&gt;enableSparkSinks&lt;/tt&gt; and this would provide a test for the metrics Sink.&lt;br/&gt;
This way, you don&apos;t have to register/remove sources constantly, the code should take into account that a context is not (mostly) reused.&lt;br/&gt;
As for provided context that may be reused, we need to address this but we can assume that that&apos;s for advanced users.&lt;br/&gt;
This should also make this proposed fix more reliable, no ? &lt;br/&gt;
WDYT ?&lt;/p&gt;</comment>
                            <comment id="15661096" author="staslev" created="Sun, 13 Nov 2016 08:22:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amitsela&quot; class=&quot;user-hover&quot; rel=&quot;amitsela&quot;&gt;amitsela&lt;/a&gt;, as far as the name goes, we can try to make it clearer, say by renaming to &lt;tt&gt;enableSparkMetricSinks&lt;/tt&gt; (or something).&lt;/p&gt;

&lt;p&gt;I do believe &lt;tt&gt;enableSparkSinks&lt;/tt&gt; should be &lt;tt&gt;true&lt;/tt&gt; by default, since metrics sound useful enough for users to have on by default, unless otherwise specified. Moreover, if your &lt;tt&gt;metrics.properties&lt;/tt&gt; is empty or missing, the behaviour should be as if you had &lt;tt&gt;enableSparkSinks&lt;/tt&gt; set to &lt;tt&gt;false&lt;/tt&gt; anyway, so ideally you would never have to actually set &lt;tt&gt;enableSparkSinks&lt;/tt&gt; to &lt;tt&gt;false&lt;/tt&gt;. I would be reluctant to remove a piece of useful functionality just as a workaround, unless we absolutely must.&lt;/p&gt;

&lt;p&gt;Btw, is disabling context reuse something you have considered? It has a somewhat problematic history in terms of tests.&lt;/p&gt;</comment>
                            <comment id="15661197" author="amitsela" created="Sun, 13 Nov 2016 09:37:06 +0000"  >&lt;p&gt;I see your point.&lt;/p&gt;

&lt;p&gt;How about setting in all tests (that don&apos;t test metrics) to false ?&lt;br/&gt;
It&apos;s better then not reusing context, because context reuse speeds-up tests duration, and so speeds up builds.&lt;/p&gt;

&lt;p&gt;The only test that does test metrics should also not reuse context (to avoid races). &lt;tt&gt;ResumeFromCheckpointStreamingTest&lt;/tt&gt; does not reuse context, check it out.&lt;/p&gt;

&lt;p&gt;If we only use metrics sink in one test (that actually tests this functionality) and in this specific test we don&apos;t reuse context, we should avoid the race problems, correct ?&lt;br/&gt;
In addition, we&apos;ll end-up with 210 (out of 212) tests that reuse context.&lt;/p&gt;

&lt;p&gt;WDYT ?&lt;/p&gt;</comment>
                            <comment id="15661227" author="staslev" created="Sun, 13 Nov 2016 10:02:49 +0000"  >&lt;p&gt;Cool, turning it off in relevant tests sounds reasonable.&lt;/p&gt;

&lt;p&gt;we&apos;ll need to see if there&apos;s a common way for tests to obtain &lt;tt&gt;PipelineOptions&lt;/tt&gt;, and if so, make the change there I guess?&lt;br/&gt;
Then, it can be overridden in &lt;tt&gt;ResumeFromCheckpointStreamingTest&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;What say you?&lt;/p&gt;</comment>
                            <comment id="15661544" author="amitsela" created="Sun, 13 Nov 2016 14:09:47 +0000"  >&lt;p&gt;It can be overriden by specifying &lt;tt&gt;System.setProperty(&quot;beam.spark.test.reuseSparkContext&quot;, &quot;false&quot;)&lt;/tt&gt; - as in &lt;tt&gt;ResumeFromCheckpointStreamingTest&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Streaming tests have a common rule most of them use: &lt;tt&gt;TestOptionsForStreaming&lt;/tt&gt;, we could have a higher-level abstraction that sets metrics to false as default. &lt;/p&gt;</comment>
                            <comment id="15663281" author="staslev" created="Mon, 14 Nov 2016 09:29:07 +0000"  >&lt;p&gt;Sounds good. &lt;br/&gt;
Btw, why can&apos;t we just set &lt;tt&gt;options.setEnableSparkSinks(false)&lt;/tt&gt; directly in &lt;tt&gt;TestOptionsForStreaming&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="15663349" author="amitsela" created="Mon, 14 Nov 2016 10:03:56 +0000"  >&lt;p&gt;Because most tests are batch..&lt;/p&gt;</comment>
                            <comment id="15667833" author="githubbot" created="Tue, 15 Nov 2016 18:09:36 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/incubator-beam/pull/1332&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/incubator-beam/pull/1332&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i35tb3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>