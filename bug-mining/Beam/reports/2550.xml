<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:19:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-12628] AvroCoder changed underlying String class for SpecificRecords</title>
                <link>https://issues.apache.org/jira/browse/BEAM-12628</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;The AvroCoder changes for &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-2303&quot; title=&quot;Add SpecificData to AvroCoder&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-2303&quot;&gt;&lt;del&gt;BEAM-2303&lt;/del&gt;&lt;/a&gt; changes the reader/writer from the Avro &lt;tt&gt;ReflectDatum*&lt;/tt&gt; classes to the &lt;tt&gt;SpecificDatum*&lt;/tt&gt; classes.&lt;/p&gt;

&lt;p&gt;Because of the way Avro handles Strings, however, the underlying instances for String data are deserialised as &lt;tt&gt;org.apache.avro.util.Utf8&lt;/tt&gt; instances instead of &lt;tt&gt;java.lang.String&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;This causes:&lt;br/&gt;
1. an unexpected behaviour change when migrating to Beam 2.30.0&lt;br/&gt;
2. potential serialization issues when using these String instances (Utf8 instances don&apos;t implement Serializable)&lt;br/&gt;
3. an inconsistent API between &lt;tt&gt;AvroCoder&lt;/tt&gt; and &lt;tt&gt;AvroSink&lt;/tt&gt;/&lt;tt&gt;AvroSource&lt;/tt&gt; (the latter still use &lt;tt&gt;ReflectDatum*&lt;/tt&gt;)&lt;/p&gt;

&lt;p&gt;(Original report on the &lt;a href=&quot;https://lists.apache.org/x/thread.html/r5d0b975926cc4761f025ecd8df58a31e3f99e522296cc47d82ed5943@%3Cdev.beam.apache.org%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;mailing list&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/beam/pull/14410#issuecomment-880838488&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR&lt;/a&gt;)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13390061">BEAM-12628</key>
            <summary>AvroCoder changed underlying String class for SpecificRecords</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10101" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">P1</priority>
                        <status id="10722" iconUrl="https://issues.apache.org/jira/images/icons/statuses/generic.png" description="">Triage Needed</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="clairemcginty">Claire McGinty</assignee>
                                    <reporter username="rskraba">Ryan Skraba</reporter>
                        <labels>
                    </labels>
                <created>Fri, 16 Jul 2021 14:04:31 +0000</created>
                <updated>Thu, 13 Apr 2023 11:06:50 +0000</updated>
                            <resolved>Wed, 6 Oct 2021 21:59:30 +0000</resolved>
                                    <version>2.30.0</version>
                                    <fixVersion>2.33.0</fixVersion>
                                    <component>io-java-avro</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="22800">6h 20m</timespent>
                                <comments>
                            <comment id="17401812" author="angoenka" created="Thu, 19 Aug 2021 18:33:56 +0000"  >&lt;p&gt;Moving it to next release as 2.32.0 was already cut and this issue has been existing from 2.30.0&lt;/p&gt;</comment>
                            <comment id="17401872" author="clairemcginty" created="Thu, 19 Aug 2021 21:26:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=angoenka&quot; class=&quot;user-hover&quot; rel=&quot;angoenka&quot;&gt;angoenka&lt;/a&gt; that&apos;s disappointing, I hoped it would be in 2.32.0 as it&apos;s a bug fix. Looking forward to 2.33 release.&lt;/p&gt;</comment>
                            <comment id="17413407" author="udim" created="Fri, 10 Sep 2021 22:16:21 +0000"  >&lt;p&gt;What&apos;s the status of this?&lt;br/&gt;
Looks like &lt;a href=&quot;https://github.com/apache/beam/pull/15292&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/15292&lt;/a&gt; was merged manually to master in &lt;a href=&quot;https://github.com/apache/beam/commit/e5c25a052b598f0888b919015c527f90c0c028d0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/commit/e5c25a052b598f0888b919015c527f90c0c028d0&lt;/a&gt;,&lt;br/&gt;
which is in the 2.33.0 release branch.&lt;/p&gt;

&lt;p&gt;Is there any more work required here?&lt;/p&gt;</comment>
                            <comment id="17415152" author="clairemcginty" created="Tue, 14 Sep 2021 20:29:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=udim&quot; class=&quot;user-hover&quot; rel=&quot;udim&quot;&gt;udim&lt;/a&gt; there shouldn&apos;t be. I&apos;ve been thinking it over wondering if the default value of the `useReflectApi` flag should be updated to `true` (&lt;a href=&quot;https://github.com/apache/beam/commit/e5c25a052b598f0888b919015c527f90c0c028d0#diff-e875a9933286d97dd3d3d21a61e6f11c0e35624e97411c1b98f1ac672c21045dR131&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/commit/e5c25a052b598f0888b919015c527f90c0c028d0#diff-e875a9933286d97dd3d3d21a61e6f11c0e35624e97411c1b98f1ac672c21045dR131&lt;/a&gt;) &amp;#8211; i.e., whether the default behavior should be the pre-2.30 behavior, or not. Not sure who the right people are for this discussion though! (&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rskraba&quot; class=&quot;user-hover&quot; rel=&quot;rskraba&quot;&gt;rskraba&lt;/a&gt; maybe?)&lt;/p&gt;</comment>
                            <comment id="17415471" author="ryanskraba" created="Wed, 15 Sep 2021 12:03:01 +0000"  >&lt;p&gt;&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=clairemcginty&quot; class=&quot;user-hover&quot; rel=&quot;clairemcginty&quot;&gt;clairemcginty&lt;/a&gt; Now that your fix is in place, can you let us know if it&apos;s tricky?&#160; Since you&apos;re actually in production, I&apos;d defer to your judgement!&#160; I think we&apos;re OK because the fix makes this configurable &#8211; I&apos;m tempted to say that it&apos;s a breaking change and we should have caught it sooner, and definitely released it ASAP... but using SpecificData over ReflectData is really the right and expected thing to do for future users.&lt;/p&gt;

&lt;p&gt;In the mailing list, I think this was a mistake on my part:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;As a side note, the Apache Avro project should probably reconsider whether the Utf8 class still adds any value with modern JVMs! If I understand correctly, it was originally in place because Hadoop had a performance boost when it could reuse mutable data containers.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;As it turns out, it is still relevant because the conversion bytes -&amp;gt; char is still expensive enough that it&apos;s worthwhile short-circuiting when we can.&lt;/p&gt;

&lt;p&gt;For point (2) in the description, there&apos;s &lt;a href=&quot;https://issues.apache.org/jira/browse/AVRO-200&quot; title=&quot;Let Utf8 implement java.io.Serializable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;AVRO-200&quot;&gt;&lt;del&gt;AVRO-200&lt;/del&gt;&lt;/a&gt; &#8211; I think we should re-raise this issue for a future release of Avro, because extracting a single primitive key from an Avro record is a very common use case!&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17416267" author="clairemcginty" created="Thu, 16 Sep 2021 17:38:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rskraba&quot; class=&quot;user-hover&quot; rel=&quot;rskraba&quot;&gt;rskraba&lt;/a&gt;&#160;It&apos;s a bit of a &quot;gotcha&quot; for us having to remember to add the `true` flag to all usages&#8211;not too bad, but it&apos;s easy to miss, and we have to be diligent about socializing this change to users. So our preference would be to have `useReflectApi` default to true, but I can&apos;t speak for other Beam users!&lt;/p&gt;</comment>
                            <comment id="17416831" author="udim" created="Fri, 17 Sep 2021 17:38:33 +0000"  >&lt;p&gt;I&apos;m leaning towards the minimal amount of backwards compatibility breaking changes&lt;/p&gt;

&lt;p&gt;1 .From what I can tell, the release notes (CHANGES.md) for Beam 2.30.0 did not mention the change to SpecificRecords. I think we should at least correct that.&lt;br/&gt;
2. We could switch the default back, but that would break compatibility a second time. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=clairemcginty&quot; class=&quot;user-hover&quot; rel=&quot;clairemcginty&quot;&gt;clairemcginty&lt;/a&gt; does the fix to add serialization in &lt;a href=&quot;https://issues.apache.org/jira/browse/AVRO-3208&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/AVRO-3208&lt;/a&gt; solve your issues, or will you still need to set useReflectApi? &lt;/p&gt;</comment>
                            <comment id="17420021" author="udim" created="Fri, 24 Sep 2021 23:23:47 +0000"  >&lt;p&gt;I mentioned this in &lt;a href=&quot;https://github.com/apache/beam/pull/15543/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/15543/files&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I will mark this issue as resolved (it&apos;s not a 2.33.0 release blocker). Feel free to reopen.&lt;/p&gt;</comment>
                            <comment id="17420794" author="clairemcginty" created="Mon, 27 Sep 2021 14:45:27 +0000"  >&lt;p&gt;I realized that the `useReflectApi` flag isn&apos;t supported in the `CoderProvider` implementation - &lt;a href=&quot;https://github.com/apache/beam/blob/3537f7ed430de9a85dd76b7a7db51fc67024db12/sdks/java/core/src/main/java/org/apache/beam/sdk/coders/AvroCoder.java#L183-L205&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/blob/3537f7ed430de9a85dd76b7a7db51fc67024db12/sdks/java/core/src/main/java/org/apache/beam/sdk/coders/AvroCoder.java#L183-L205&lt;/a&gt;&#160;- so it defaults to false. I can&apos;t think of a way to mitigate that though as it&apos;s a static method... my preference is definitely to default to `true`, so not sure how to continue here.&lt;/p&gt;</comment>
                            <comment id="17420987" author="udim" created="Mon, 27 Sep 2021 19:21:03 +0000"  >&lt;p&gt;I&apos;m not a Java SDK expert, but could users override the coder used by passing their own instance of AvroCoder&amp;lt;T&amp;gt;.of(..., true) to a transform?&lt;br/&gt;
Another option might be to set the default value of useReflectApi to via a static class variable.&lt;/p&gt;</comment>
                            <comment id="17421010" author="udim" created="Mon, 27 Sep 2021 20:26:56 +0000"  >&lt;p&gt;I have pushed the &quot;fix version&quot; to 2.34.0, as this is an existing issue since 2.30.0.&lt;/p&gt;</comment>
                            <comment id="17421350" author="ryanskraba" created="Tue, 28 Sep 2021 12:00:05 +0000"  >&lt;p&gt;Hello &#8211; if you want to switch the default to true, it &lt;em&gt;might&lt;/em&gt; break again for a developer that quietly made a fix to the breaking change in 2.30.0, but I have confidence in &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=clairemcginty&quot; class=&quot;user-hover&quot; rel=&quot;clairemcginty&quot;&gt;clairemcginty&lt;/a&gt; &apos;s decision, since they are the most impacted users of this functionality.&lt;/p&gt;

&lt;p&gt;To be honest, I usually set the coder explicitly on every transform, just to avoid dealing with &lt;tt&gt;CoderProvider&lt;/tt&gt; problems!&lt;/p&gt;

&lt;p&gt;Unfortunately, the AVRO fix above is just one of the symptoms in the broader problem.&lt;/p&gt;</comment>
                            <comment id="17421475" author="clairemcginty" created="Tue, 28 Sep 2021 15:48:37 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=udim&quot; class=&quot;user-hover&quot; rel=&quot;udim&quot;&gt;udim&lt;/a&gt;&#160;and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rskraba&quot; class=&quot;user-hover&quot; rel=&quot;rskraba&quot;&gt;rskraba&lt;/a&gt;. I think the right thing to do is to make the default `true`. I can put up a PR; not sure if it&apos;s too late to make it into the 2.33 release, however.&lt;/p&gt;</comment>
                            <comment id="17425239" author="ibzib" created="Wed, 6 Oct 2021 21:59:11 +0000"  >&lt;p&gt;I saw that &lt;a href=&quot;https://github.com/apache/beam/pull/15622&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/15622&lt;/a&gt;&#160;is merged, so I am marking this as fixed as of 2.33.0. Please edit if this is not the case.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13401379">AVRO-3208</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 5 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0t0og:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>