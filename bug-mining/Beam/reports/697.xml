<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:51:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-5110] Reconile Flink JVM singleton management with deployment</title>
                <link>https://issues.apache.org/jira/browse/BEAM-5110</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=angoenka&quot; class=&quot;user-hover&quot; rel=&quot;angoenka&quot;&gt;angoenka&lt;/a&gt; noticed through debugging that multiple instances of&#160;BatchFlinkExecutableStageContext.BatchFactory are loaded for a given job when executing in standalone cluster mode. This context factory is responsible for maintaining singleton state across a TaskManager (JVM) in order to share SDK Environments across workers in a given job. The multiple-loading breaks singleton semantics and results in an indeterminate number of Environments being created.&lt;/p&gt;

&lt;p&gt;It turns out that the &lt;a href=&quot;https://ci.apache.org/projects/flink/flink-docs-release-1.5/monitoring/debugging_classloading.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Flink classloading mechanism&lt;/a&gt; is determined by deployment mode. Note that &quot;user code&quot; as referenced by this link is actually the Flink job server jar. Actual end-user code lives inside of the SDK Environment and uploaded artifacts.&lt;/p&gt;

&lt;p&gt;In order to maintain singletons without resorting to IPC (for example, using file locks and/or additional gRPC servers), we need to force non-dynamic classloading.&#160;For example, this happens&#160;when jobs are submitted to YARN for one-off deployments via `flink run`. However, connecting to an existing (Flink standalone) deployment results in dynamic classloading.&lt;/p&gt;

&lt;p&gt;We should investigate this behavior and either document (and attempt to enforce) deployment modes that are consistent with our requirements, or (if possible) create a custom classloader that enforces singleton loading.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13177755">BEAM-5110</key>
            <summary>Reconile Flink JVM singleton management with deployment</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bsidhom">Ben Sidhom</assignee>
                                    <reporter username="bsidhom">Ben Sidhom</reporter>
                        <labels>
                    </labels>
                <created>Wed, 8 Aug 2018 18:08:48 +0000</created>
                <updated>Fri, 24 Jul 2020 20:19:36 +0000</updated>
                            <resolved>Thu, 20 Sep 2018 16:19:30 +0000</resolved>
                                                    <fixVersion>Not applicable</fixVersion>
                                    <component>runner-flink</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="10800">3h</timespent>
                                <comments>
                            <comment id="16573681" author="bsidhom" created="Wed, 8 Aug 2018 18:34:58 +0000"  >&lt;p&gt;Note that we&#160;can partially fix the issue by requiring that users who deploy in standalone &quot;sessions&quot; drop the Flink job server jar into the lib/ directory of all workers. That ensures that the necessary classes are available in the static top-level classloader.&lt;/p&gt;

&lt;p&gt;However, classloading in Flink is inverted from the usual behavior: &quot;By default, Flink inverts classloading order, meaning it looks into the user code classloader first, and only looks into the parent (application classloader) if the class is not part of the dynamically loaded user code.&quot;&lt;/p&gt;

&lt;p&gt;Making sure this works in practice also requires a change in the Flink runner code where we create a connection to remote environments. We have to ensure that&#160;&lt;em&gt;no&lt;/em&gt; user jars are staged here because any classes defined here will be loaded dynamically and take precedence over the root classloader.&lt;/p&gt;</comment>
                            <comment id="16573688" author="angoenka" created="Wed, 8 Aug 2018 18:41:48 +0000"  >&lt;p&gt;We can invert the class loading order using&#160;&lt;a href=&quot;https://ci.apache.org/projects/flink/flink-docs-stable/ops/config.html#classloader-resolve-order&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci.apache.org/projects/flink/flink-docs-stable/ops/config.html#classloader-resolve-order&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;There are additional configs as well which can&#160;be used to&#160;load cerain classes from the parent class loader first and then the dynamic class loader&lt;/p&gt;</comment>
                            <comment id="16576238" author="thw" created="Fri, 10 Aug 2018 13:04:07 +0000"  >&lt;p&gt;When running wordcount with embedded Flink, I see that on the first run 3 docker containers are created and on subsequent runs one. That is also the reason why in the first run of the example fails: &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-5026&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BEAM-5026&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It is important that we provide control over how the SDK harness containers/instances are created. Having a single instance per Flink TM isn&apos;t sufficient for a production deployment where the TM will have many task slots with executable stage operators that cannot all be served by a single harness process.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16578840" author="angoenka" created="Mon, 13 Aug 2018 19:53:53 +0000"  >&lt;p&gt;I agree. We should provide control over SDKHarness&#160;container instances especially when python container can only utilize a single core at a time.&lt;/p&gt;

&lt;p&gt;We can break down the whole container management in 2 parts based on the discussion.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;How&#160;to start and manage SDKHarness. (using kubernetes, process based, singleton factory etc)&lt;/li&gt;
	&lt;li&gt;Configuration for managing SDKHarenss. (&#160;Number of containers. type of containers etc)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;This bug tries to address the 1st part using a singleton factory which apparently is not behaving as expected in the current code base. We want to explore a more robust way of managing containers like kubernetes but that will take some time to add&#160;and also&#160;impose more infrastructure requirements so singleton container&#160;seems useful.&lt;/p&gt;

&lt;p&gt;Shall we track the 2nd part as &quot;Multiple&#160;SDKHarness with singleton container manager&quot; separately?&lt;/p&gt;</comment>
                            <comment id="16580536" author="bsidhom" created="Tue, 14 Aug 2018 23:21:27 +0000"  >&lt;p&gt;Sadly, after investigating this for a while, I think that the best option (for now) is to document (and possibly enforce in code where possible) the situations where dynamic code loading will not happen in the workers. Flink attempts to isolate user code with separate classloaders and Java does not expose a way to force shared classloaders (or even list unconnected classloaders) without special instrumentation.&lt;/p&gt;

&lt;p&gt;The following deployment modes use regular system class loading for the Beam Job server and workers:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Direct YARN deployments (using bin/flink run -m yarn-cluster)&lt;/li&gt;
	&lt;li&gt;Standalone/Docker/Kubernetes/Mesos sessions where the job server jar has been dropped into the lib/ directory of distributions. In this case, Flink&apos;s default classloading strategy will not work because child (Operator-scoped) classloaders override system classloaders; any user code (e.g., Beam environment manager code where the job server is submitted to a RemoteEnvironment) will override Flink/system classes. In order to get around this, Flink&apos;s &lt;a href=&quot;https://ci.apache.org/projects/flink/flink-docs-release-1.5/ops/config.html#classloader-resolve-order&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;classloader.resolve-order&lt;/a&gt;&#160;must be set to&#160;parent-first&#160;&lt;em&gt;or&lt;/em&gt;&#160;classloader.parent-first-patterns-additional must be populated with the set of packages that require JVM singletons.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In general, modes where the job server jar is sent to a new RemoteEnvironment will break singleton semantics. We should at the very least log a warning when this is detected in the job server, if disable this altogether.&lt;/p&gt;</comment>
                            <comment id="16580540" author="thw" created="Tue, 14 Aug 2018 23:31:36 +0000"  >&lt;p&gt;Since the latter may be the desired behavior (no singleton) and unless it is not working for other reasons, I think this is more a matter of documentation than trying to enforce a particular assumption?&lt;/p&gt;</comment>
                            <comment id="16580545" author="bsidhom" created="Tue, 14 Aug 2018 23:36:46 +0000"  >&lt;p&gt;I meant to mention in the previous comment: as of now, this is not&#160;a correctness issue&#160;but rather a performance/resources issue. We generally want to allow SDK environment reuse to amortize startup costs (and save memory).&lt;/p&gt;

&lt;p&gt;The fact that the Python SDK does&#160;&lt;em&gt;not&lt;/em&gt; handle multiple control clients over a single channel is arguably an SDK harness bug or a configuration issue (e.g., we may need&#160;to allow the environment factory/manager to spawn new environments if requested). This is something that should be fleshed out in the fn-api contract and is orthogonal to JVM instance management in the portable Flink runner.&lt;/p&gt;</comment>
                            <comment id="16580554" author="angoenka" created="Tue, 14 Aug 2018 23:40:40 +0000"  >&lt;p&gt;With the worker_id introduction, fn_api is capable of&#160;supporting and managing multiple SDKHarness on a single machine.&#160;&lt;/p&gt;

&lt;p&gt;The challenge with python is that a single python process&#160;can only use 1 cpu core.&lt;/p&gt;

&lt;p&gt;Going forward there&#160;can be other cases where we might want to have more than 1 instance of the same SDKHarness environment.&lt;/p&gt;

&lt;p&gt;But this seems to be a separate problem and should be handled separately from the current issue.&lt;/p&gt;</comment>
                            <comment id="16580556" author="thw" created="Tue, 14 Aug 2018 23:45:21 +0000"  >&lt;p&gt;If the discussion is around enforcing singleton JVM management without having an option to allow for multiple, then these two issues become connected. I would like to ensure that we can run multiple SDK environments in the same TM for the reason &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=angoenka&quot; class=&quot;user-hover&quot; rel=&quot;angoenka&quot;&gt;angoenka&lt;/a&gt;&#160;states.&#160;&lt;/p&gt;</comment>
                            <comment id="16622282" author="thw" created="Thu, 20 Sep 2018 16:19:13 +0000"  >&lt;p&gt;Closing, current implementation is sufficient to run portable pipelines on Flink.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13174731">BEAM-5026</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="13101359">BEAM-2889</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 8 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3wucf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>