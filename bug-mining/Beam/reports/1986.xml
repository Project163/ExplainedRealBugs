<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:10:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-6064] Python BigQuery performance much worse than Java</title>
                <link>https://issues.apache.org/jira/browse/BEAM-6064</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;The performance of reading from BigQuery in Python seems to be much worse than the performance of it in Java.&lt;/p&gt;

&lt;p&gt;To reproduce this, I&apos;ve run the following two programs on the Google Cloud, which basically read the weights from the public data set &quot;natality&quot; and outputs the top 100 largest weights.&lt;/p&gt;

&lt;p&gt;Python:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
# &amp;lt;cut imports&amp;gt;

options = PipelineOptions()
options.view_as(StandardOptions).runner = &lt;span class=&quot;code-quote&quot;&gt;&apos;DataflowRunner&apos;&lt;/span&gt;
# &amp;lt;cut more options&amp;gt;

pipeline = Pipeline(options=options)
(pipeline
    | &lt;span class=&quot;code-quote&quot;&gt;&apos;Read&apos;&lt;/span&gt; &amp;gt;&amp;gt; beam.io.Read(beam.io.BigQuerySource(query=&lt;span class=&quot;code-quote&quot;&gt;&apos;SELECT weight_pounds FROM [bigquery-&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt;-data:samples.natality]&apos;&lt;/span&gt;))
    | &lt;span class=&quot;code-quote&quot;&gt;&apos;MapToFloat&apos;&lt;/span&gt; &amp;gt;&amp;gt; beam.Map(lambda elem: elem[&lt;span class=&quot;code-quote&quot;&gt;&apos;weight_pounds&apos;&lt;/span&gt;])
    | &lt;span class=&quot;code-quote&quot;&gt;&apos;Top&apos;&lt;/span&gt; &amp;gt;&amp;gt; beam.combiners.Top.Largest(100)
    | &lt;span class=&quot;code-quote&quot;&gt;&apos;MapToString&apos;&lt;/span&gt; &amp;gt;&amp;gt; beam.Map(lambda elem: str(elem))
    | &lt;span class=&quot;code-quote&quot;&gt;&apos;Write&apos;&lt;/span&gt; &amp;gt;&amp;gt; beam.io.WriteToText(&lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;lt;output-file&amp;gt;&quot;&lt;/span&gt;))

pipeline.run()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;Java:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;cut imports&amp;gt;
&lt;/span&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Natality {
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
        DataflowPipelineOptions options = PipelineOptionsFactory.create().as(DataflowPipelineOptions.class);
        options.setRunner(DataflowRunner.class);
        &lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;cut more options&amp;gt;
&lt;/span&gt;        
        Pipeline pipeline = Pipeline.create(options);

        pipeline.apply(&lt;span class=&quot;code-quote&quot;&gt;&quot;Read&quot;&lt;/span&gt;, BigQueryIO.readTableRows()
            .fromQuery(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT weight_pounds FROM [bigquery-&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt;-data:samples.natality]&quot;&lt;/span&gt;))
            .apply(&lt;span class=&quot;code-quote&quot;&gt;&quot;MapToDouble&quot;&lt;/span&gt;, MapElements
                .into(TypeDescriptors.doubles())
                .via(row -&amp;gt; {
                     &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; obj = row.get(&lt;span class=&quot;code-quote&quot;&gt;&quot;weight_pounds&quot;&lt;/span&gt;);
                     &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (obj == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ? 0.0 : (&lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;) obj);
                }))
            .apply(&lt;span class=&quot;code-quote&quot;&gt;&quot;Top&quot;&lt;/span&gt;, Top.largest(100))
            .apply(&lt;span class=&quot;code-quote&quot;&gt;&quot;MapToString&quot;&lt;/span&gt;, MapElements
                .into(TypeDescriptors.strings())
                .via(weight -&amp;gt; weight.toString()))
            .apply(&lt;span class=&quot;code-quote&quot;&gt;&quot;Write&quot;&lt;/span&gt;, TextIO.write().to(&lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;lt;output-file&amp;gt;&quot;&lt;/span&gt;));

        pipeline.run().waitUntilFinish();
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The &quot;&amp;lt;cut more options&amp;gt;&quot; are basic options like project, job name, temp location, etc. Both programs produce identical outputs.&lt;/p&gt;

&lt;p&gt;Running these programs launches a DataFlow job on the Google Cloud with the following results (data from the Google Cloud Platform web interface; screenshots attached).&lt;/p&gt;

&lt;p&gt;Python:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Read Succeeded 1 hr 40 min 40 sec
MapToFloat Succeeded 2 min 43 sec
Top Succeeded 5 min 25 sec
MapToString Succeeded 0 sec
Write Succeeded 3 sec&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Java:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Read Succeeded 4 min 45 sec
MapToDouble Succeeded 45 sec
Top Succeeded 52 sec
MapToString Succeeded 0 sec
Write Succeeded 1 sec
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;As you can see, there is an enormous performance hit in Python w.r.t. the reading from BigQuery: 1h40m vs less than 5 minutes.&lt;/p&gt;

&lt;p&gt;Furthermore the other standard operations (like Top) are also much slower in Python than in Java.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13198342">BEAM-6064</key>
            <summary>Python BigQuery performance much worse than Java</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10103" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">P3</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="jankuipers">Jan Kuipers</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Nov 2018 14:07:42 +0000</created>
                <updated>Fri, 3 Jun 2022 23:03:03 +0000</updated>
                                            <version>2.8.0</version>
                                                    <component>sdk-py-core</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="21600">6h</timespent>
                                <comments>
                            <comment id="16686904" author="chamikara" created="Wed, 14 Nov 2018 17:42:58 +0000"  >&lt;p&gt;A big part of performance difference is the slowness of the Avro library that we use for reading files exported from BigQuery. We are in the process of adding support for fastavro which should make reading from BQ significantly faster. I&apos;ll update this&#160;JIRA when this is available.&lt;/p&gt;</comment>
                            <comment id="16739582" author="chamikara" created="Thu, 10 Jan 2019 16:27:39 +0000"  >&lt;p&gt;Fastavro support for BigQuery for DataflowRunner&#160;is already available in the form of an experiment and will be made default in the future.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;You can try running Dataflow pipelines with option &quot;--experiment=use_fastavro&quot; to enable this experiment. Please let me know if you run into any issues.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Closing this issue.&lt;/p&gt;</comment>
                            <comment id="16758175" author="txomon" created="Fri, 1 Feb 2019 10:18:58 +0000"  >&lt;p&gt;I have been unable to activate the experiment successfully. As you can see on the bottom right side it appears as if the experiment were activated, but there is no performance improvement. The java version runs the same read in 2min44s cpu time. &lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12957239/12957239_Screenshot+from+2019-02-01+10-10-45.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;Is there any extra step besides being in version 2.9.0 and adding use_fastavro to experiments?&lt;/p&gt;</comment>
                            <comment id="16760242" author="jankuipers" created="Mon, 4 Feb 2019 21:32:33 +0000"  >&lt;p&gt;I also haven&apos;t been able to successfully apply the proposed solution.&lt;/p&gt;

&lt;p&gt;I&apos;ve upgraded to Beam 2.9.0 and tried adding the following to the Python code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
options = PipelineOptions([&lt;span class=&quot;code-quote&quot;&gt;&apos;--experiment=use_fastavro&apos;&lt;/span&gt;])&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;or&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
options.view_as(DebugOptions).experiments = [&lt;span class=&quot;code-quote&quot;&gt;&apos;use_fastavro&apos;&lt;/span&gt;]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;but neither resulted in a performance gain. Am I missing something?&lt;/p&gt;</comment>
                            <comment id="16760247" author="chamikara" created="Mon, 4 Feb 2019 21:37:28 +0000"  >&lt;p&gt;Do you have a Dataflow Job ID for a run with fastavro enabled ?&lt;/p&gt;</comment>
                            <comment id="16761126" author="jankuipers" created="Tue, 5 Feb 2019 19:19:38 +0000"  >&lt;p&gt;Job ID: 2019-02-04_13_05_05-4670803990553687495&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="16761854" author="txomon" created="Wed, 6 Feb 2019 15:26:54 +0000"  >&lt;p&gt;I tried with a few different variations to see if there was any change (using b&apos;&apos;, u&apos;&apos;, and lists):&lt;/p&gt;

&lt;p&gt;2019-01-31_08_56_32-15897455035140598995&lt;br/&gt;
2019-01-31_08_55_46-13991837610890019370&lt;br/&gt;
2019-01-31_08_42_33-16971467357649361217&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16811035" author="kenn" created="Fri, 5 Apr 2019 16:46:53 +0000"  >&lt;p&gt;The Fix Version was 2.9.0 which is long release. Is it meant that this &lt;b&gt;affects&lt;/b&gt; version 2.9.0?&lt;/p&gt;</comment>
                            <comment id="16862177" author="almer-t" created="Wed, 12 Jun 2019 14:42:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chamikara&quot; class=&quot;user-hover&quot; rel=&quot;chamikara&quot;&gt;chamikara&lt;/a&gt; Curious: is there any update on this issue or something we can do to help resolve this?&lt;/p&gt;</comment>
                            <comment id="17122205" author="kenn" created="Tue, 2 Jun 2020 04:00:56 +0000"  >&lt;p&gt;This issue is assigned but has not received an update in 30 days so it has been labeled &quot;stale-assigned&quot;. If you are still working on the issue, please give an update and remove the label. If you are no longer working on the issue, please unassign so someone else may work on it. In 7 days the issue will be automatically unassigned.&lt;/p&gt;</comment>
                            <comment id="17131509" author="beamjirabot" created="Wed, 10 Jun 2020 17:24:32 +0000"  >&lt;p&gt;This issue was marked &quot;stale-assigned&quot; and has not received a public comment in 7 days. It is now automatically unassigned. If you are still working on it, you can assign it to yourself again. Please also give an update about the status of the work.&lt;/p&gt;</comment>
                            <comment id="17168138" author="pabloem" created="Thu, 30 Jul 2020 18:40:53 +0000"  >&lt;p&gt;I plan to work on this soon.,&lt;/p&gt;</comment>
                            <comment id="17180724" author="pabloem" created="Wed, 19 Aug 2020 17:42:24 +0000"  >&lt;p&gt;Some performance improvements for Python BQ inserts should come in Beam 2.24.0.&lt;/p&gt;</comment>
                            <comment id="17198791" author="beamjirabot" created="Sat, 19 Sep 2020 17:07:18 +0000"  >&lt;p&gt;This issue is assigned but has not received an update in 30 days so it has been labeled &quot;stale-assigned&quot;. If you are still working on the issue, please give an update and remove the label. If you are no longer working on the issue, please unassign so someone else may work on it. In 7 days the issue will be automatically unassigned.&lt;/p&gt;</comment>
                            <comment id="17202646" author="beamjirabot" created="Sat, 26 Sep 2020 17:07:29 +0000"  >&lt;p&gt;This issue was marked &quot;stale-assigned&quot; and has not received a public comment in 7 days. It is now automatically unassigned. If you are still working on it, you can assign it to yourself again. Please also give an update about the status of the work.&lt;/p&gt;</comment>
                            <comment id="17238825" author="beamjirabot" created="Wed, 25 Nov 2020 17:11:41 +0000"  >&lt;p&gt;This issue is P2 but has been unassigned without any comment for 60 days so it has been labeled &quot;stale-P2&quot;. If this issue is still affecting you, we care! Please comment and remove the label. Otherwise, in 14 days the issue will be moved to P3.&lt;/p&gt;

&lt;p&gt;Please see &lt;a href=&quot;https://beam.apache.org/contribute/jira-priorities/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://beam.apache.org/contribute/jira-priorities/&lt;/a&gt; for a detailed explanation of what these priorities mean.&lt;/p&gt;</comment>
                            <comment id="17246690" author="beamjirabot" created="Wed, 9 Dec 2020 17:11:45 +0000"  >&lt;p&gt;This issue was marked &quot;stale-P2&quot; and has not received a public comment in 14 days. It is now automatically moved to P3. If you are still affected by it, you can comment and move it back to P2.&lt;/p&gt;</comment>
                            <comment id="17473421" author="kenn" created="Wed, 12 Jan 2022 03:49:26 +0000"  >&lt;p&gt;This Jira ticket has a pull request attached to it, but is still open. Did the pull request resolve the issue? If so, could you please mark it resolved? This will help the project have a clear view of its open issues.&lt;/p&gt;</comment>
                            <comment id="17480425" author="almer-t" created="Sat, 22 Jan 2022 13:18:14 +0000"  >&lt;p&gt;It seem both pull requests have been merged. The bug description contains a fairly good recipe to check if this resolved the issue. Perhaps the last remaining step here is verifying the fix?&lt;/p&gt;</comment>
                            <comment id="17547478" author="kenn" created="Fri, 3 Jun 2022 23:03:03 +0000"  >&lt;p&gt;This issue has been migrated to &lt;a href=&quot;https://github.com/apache/beam/issues/19239&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/issues/19239&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12957239" name="Screenshot from 2019-02-01 10-10-45.png" size="88158" author="txomon" created="Fri, 1 Feb 2019 10:14:14 +0000"/>
                            <attachment id="12948140" name="results-java.png" size="100454" author="jankuipers" created="Wed, 14 Nov 2018 14:09:12 +0000"/>
                            <attachment id="12948141" name="results-python.png" size="104649" author="jankuipers" created="Wed, 14 Nov 2018 14:09:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 23 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s00hfs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>