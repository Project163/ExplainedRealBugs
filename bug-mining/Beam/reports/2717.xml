<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:22:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-12879] Downloading GCS objects suddenly require storage.buckets.get permission</title>
                <link>https://issues.apache.org/jira/browse/BEAM-12879</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;With PR &lt;a href=&quot;https://github.com/apache/beam/pull/14770&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/14770&lt;/a&gt;&#160;downloading GCS objects requires an additional IAM role `storage.objects.get` to get the project_number based on the bucket name.&#160;&lt;/p&gt;

&lt;p&gt;If the service account or user does not have said role the following error will show:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-python&quot;&gt;
Traceback (most recent call last):
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/local/lib/python3.7/site-packages/dataflow_worker/batchworker.py&quot;&lt;/span&gt;, line 651, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; do_work
    work_executor.execute()
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/local/lib/python3.7/site-packages/dataflow_worker/executor.py&quot;&lt;/span&gt;, line 179, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; execute
    op.start()
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;dataflow_worker/native_operations.py&quot;&lt;/span&gt;, line 38, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; dataflow_worker.native_operations.NativeReadOperation.start
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;dataflow_worker/native_operations.py&quot;&lt;/span&gt;, line 39, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; dataflow_worker.native_operations.NativeReadOperation.start
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;dataflow_worker/native_operations.py&quot;&lt;/span&gt;, line 44, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; dataflow_worker.native_operations.NativeReadOperation.start
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;dataflow_worker/native_operations.py&quot;&lt;/span&gt;, line 54, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; dataflow_worker.native_operations.NativeReadOperation.start
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;apache_beam/runners/worker/operations.py&quot;&lt;/span&gt;, line 353, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; apache_beam.runners.worker.operations.Operation.output
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;apache_beam/runners/worker/operations.py&quot;&lt;/span&gt;, line 215, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; apache_beam.runners.worker.operations.SingletonConsumerSet.receive
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;apache_beam/runners/worker/operations.py&quot;&lt;/span&gt;, line 712, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; apache_beam.runners.worker.operations.DoOperation.process
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;apache_beam/runners/worker/operations.py&quot;&lt;/span&gt;, line 713, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; apache_beam.runners.worker.operations.DoOperation.process
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;apache_beam/runners/common.py&quot;&lt;/span&gt;, line 1234, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; apache_beam.runners.common.DoFnRunner.process
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;apache_beam/runners/common.py&quot;&lt;/span&gt;, line 1315, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; apache_beam.runners.common.DoFnRunner._reraise_augmented
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;apache_beam/runners/common.py&quot;&lt;/span&gt;, line 1232, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; apache_beam.runners.common.DoFnRunner.process
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;apache_beam/runners/common.py&quot;&lt;/span&gt;, line 571, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; apache_beam.runners.common.SimpleInvoker.invoke_process
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;apache_beam/runners/common.py&quot;&lt;/span&gt;, line 1368, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; apache_beam.runners.common._OutputProcessor.process_outputs
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/local/lib/python3.7/site-packages/xyz/package/&lt;span class=&quot;code-object&quot;&gt;file&lt;/span&gt;.py&quot;&lt;/span&gt;, line 112, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; process
    &lt;span class=&quot;code-keyword&quot;&gt;with&lt;/span&gt; FileSystems.&lt;span class=&quot;code-object&quot;&gt;open&lt;/span&gt;(element[&lt;span class=&quot;code-quote&quot;&gt;&quot;gcs_uri&quot;&lt;/span&gt;]) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;file&lt;/span&gt;:
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/local/lib/python3.7/site-packages/apache_beam/io/filesystems.py&quot;&lt;/span&gt;, line 244, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;open&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; filesystem.&lt;span class=&quot;code-object&quot;&gt;open&lt;/span&gt;(path, mime_type, compression_type)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/local/lib/python3.7/site-packages/apache_beam/io/gcp/gcsfilesystem.py&quot;&lt;/span&gt;, line 177, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;open&lt;/span&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;self&lt;/span&gt;._path_open(path, &lt;span class=&quot;code-quote&quot;&gt;&apos;rb&apos;&lt;/span&gt;, mime_type, compression_type)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/local/lib/python3.7/site-packages/apache_beam/io/gcp/gcsfilesystem.py&quot;&lt;/span&gt;, line 138, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; _path_open
    raw_file = gcsio.GcsIO().&lt;span class=&quot;code-object&quot;&gt;open&lt;/span&gt;(path, mode, mime_type=mime_type)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/local/lib/python3.7/site-packages/apache_beam/io/gcp/gcsio.py&quot;&lt;/span&gt;, line 227, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;open&lt;/span&gt;
    get_project_number=&lt;span class=&quot;code-keyword&quot;&gt;self&lt;/span&gt;.get_project_number)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/local/lib/python3.7/site-packages/apache_beam/io/gcp/gcsio.py&quot;&lt;/span&gt;, line 585, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; __init__
    project_number = &lt;span class=&quot;code-keyword&quot;&gt;self&lt;/span&gt;._get_project_number(&lt;span class=&quot;code-keyword&quot;&gt;self&lt;/span&gt;._bucket)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/local/lib/python3.7/site-packages/apache_beam/io/gcp/gcsio.py&quot;&lt;/span&gt;, line 166, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; get_project_number
    &lt;span class=&quot;code-keyword&quot;&gt;self&lt;/span&gt;.bucket_to_project_number[bucket] = bucket_metadata.projectNumber
&lt;span class=&quot;code-object&quot;&gt;AttributeError&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;NoneType&apos;&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;object&lt;/span&gt; has no attribute &lt;span class=&quot;code-quote&quot;&gt;&apos;projectNumber&apos;&lt;/span&gt; [&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; running &lt;span class=&quot;code-quote&quot;&gt;&apos;read &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; GCS&apos;&lt;/span&gt;]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The error message does not hint what goes wrong exactly but after some digging my assumption is that when trying to get the `bucket_metadata ` in &lt;a href=&quot;https://github.com/roger-mike/beam/blob/f0d0dd561a0955afb73cf595a3015a7ca839d5b7/sdks/python/apache_beam/io/gcp/gcsio.py#L161&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;get_project_number&lt;/a&gt; we get a a HTTP Error and thus a None (since when catching this error a None is returned) due to the lack of permissions leading to `bucket_metadata` being None.&lt;/p&gt;

&lt;p&gt;The problem is, that the required permission (`storage.buckets.get`) is only covered in the predefined role `Storage Admin (roles/storage.admin)` which I believe shouldn&apos;t be necessary in order to access objects from GCS.&lt;/p&gt;

&lt;p&gt;Not sure what the solution would look like: We want the metadata incl. the project number but on the other hand it seems excessive to have to give storage admin (or having to create custom roles) in order to work with GCS objects. In any case this situation needs a more elaborate error message. &lt;a href=&quot;https://github.com/roger-mike/beam/blob/f0d0dd561a0955afb73cf595a3015a7ca839d5b7/sdks/python/apache_beam/io/gcp/gcsio.py#L161&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;get_project_number&lt;/a&gt; should handle the situation of getting a None from &lt;a href=&quot;https://github.com/roger-mike/beam/blob/f0d0dd561a0955afb73cf595a3015a7ca839d5b7/sdks/python/apache_beam/io/gcp/gcsio.py#L176&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;get_bucket&lt;/a&gt; gracefully than failing on an Attribute error as seen above.&lt;/p&gt;

&lt;p&gt;Note: This issue will probably not only occur in the Python SDK, but I believe to have checked the Java implementation for this and at least there we should be getting a more precise error.&lt;/p&gt;

&lt;p&gt;First issue, don&apos;t eat me alive &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13400735">BEAM-12879</key>
            <summary>Downloading GCS objects suddenly require storage.buckets.get permission</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ningk">Ning</assignee>
                                    <reporter username="rjany">Robert Jany</reporter>
                        <labels>
                            <label>starter</label>
                            <label>usability</label>
                    </labels>
                <created>Mon, 13 Sep 2021 08:02:42 +0000</created>
                <updated>Tue, 10 May 2022 21:03:38 +0000</updated>
                            <resolved>Thu, 6 Jan 2022 00:27:09 +0000</resolved>
                                    <version>2.32.0</version>
                                    <fixVersion>2.37.0</fixVersion>
                                    <component>io-py-gcp</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="12000">3h 20m</timespent>
                                <comments>
                            <comment id="17419851" author="nroberts1" created="Fri, 24 Sep 2021 15:24:08 +0000"  >&lt;p&gt;I&apos;ve had exactly the same issue although even after appearing to add the suggested role to my GCP account I still got the same issue. I&apos;ve pinned apache-beam==2.31.0 to resolve for now&lt;/p&gt;</comment>
                            <comment id="17451054" author="JIRAUSER280985" created="Tue, 30 Nov 2021 10:53:31 +0000"  >&lt;p&gt;I hit this error running one of the geobeam pipelines from here: &lt;a href=&quot;https://github.com/GoogleCloudPlatform/dataflow-geobeam&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/GoogleCloudPlatform/dataflow-geobeam&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I turned out that the error came from&#160; the fact that the source data lives in a 3rd party bucket: &lt;tt&gt;&#160;gs://geobeam/examples/dem-clipped-test.tif&lt;/tt&gt;. Once I copied this file to a bucket in my own project, the problem went away. Apologies if this is a red herring, just trying to help.&lt;/p&gt;</comment>
                            <comment id="17451678" author="rjany" created="Wed, 1 Dec 2021 09:56:59 +0000"  >&lt;p&gt;Also pinned the version to apache-beam==2.31.0 for now.&lt;/p&gt;</comment>
                            <comment id="17460815" author="rjany" created="Thu, 16 Dec 2021 15:30:48 +0000"  >&lt;p&gt;To not be stuck on 2.31 with the log4shell vulnerability, I&apos;ve added the additional role of &lt;tt&gt;storage.legacyBucketReader&lt;/tt&gt; in addition to the &lt;tt&gt;storage.objectViewer&lt;/tt&gt; role. Solves the issue but not ideal to having to add a legacy role.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17464084" author="JIRAUSER282486" created="Wed, 22 Dec 2021 21:29:01 +0000"  >&lt;p&gt;This prevents Beam Python SDK (e.g., 2.34.0) from reading public GCS bucket, stacktrace:&lt;/p&gt;

&lt;p&gt;&#160;FileSystems.open(filename, mime_type=&apos;application/octet-stream&apos;),\n&quot;,&lt;br/&gt;
&#160; &#160; &#160; &#160; &quot; &#160;File \&quot;/usr/local/lib/python3.7/site-packages/apache_beam/io/filesystems.py\&quot;, line 244, in open\n &#160; &#160;return filesystem.open(path, mime_type, compression_type)\n&quot;,&lt;br/&gt;
&#160; &#160; &#160; &#160; &quot; &#160;File \&quot;/usr/local/lib/python3.7/site-packages/apache_beam/io/gcp/gcsfilesystem.py\&quot;, line 177, in open\n &#160; &#160;return self._path_open(path, &apos;rb&apos;, mime_type, compression_type)\n&quot;,&lt;br/&gt;
&#160; &#160; &#160; &#160; &quot; &#160;File \&quot;/usr/local/lib/python3.7/site-packages/apache_beam/io/gcp/gcsfilesystem.py\&quot;, line 138, in _path_open\n &#160; &#160;raw_file = gcsio.GcsIO().open(path, mode, mime_type=mime_type)\n&quot;,&lt;br/&gt;
&#160; &#160; &#160; &#160; &quot; &#160;File \&quot;/usr/local/lib/python3.7/site-packages/apache_beam/io/gcp/gcsio.py\&quot;, line 227, in open\n &#160; &#160;get_project_number=self.get_project_number)\n&quot;,&lt;br/&gt;
&#160; &#160; &#160; &#160; &quot; &#160;File \&quot;/usr/local/lib/python3.7/site-packages/apache_beam/io/gcp/gcsio.py\&quot;, line 585, in _&lt;em&gt;init&lt;/em&gt;_\n &#160; &#160;project_number = self._get_project_number(self._bucket)\n&quot;,&lt;br/&gt;
&#160; &#160; &#160; &#160; &quot; &#160;File \&quot;/usr/local/lib/python3.7/site-packages/apache_beam/io/gcp/gcsio.py\&quot;, line 166, in get_project_number\n &#160; &#160;self.bucket_to_project_number&lt;span class=&quot;error&quot;&gt;&amp;#91;bucket&amp;#93;&lt;/span&gt; = bucket_metadata.projectNumber\n&quot;,&lt;br/&gt;
&#160; &#160; &#160; &#160; &quot;AttributeError: &apos;NoneType&apos; object has no attribute &apos;projectNumber&apos;\n&quot;&lt;/p&gt;

&lt;p&gt;IMO this is pretty serious problem. Could we raise the priority and potentially revert &lt;a href=&quot;https://github.com/apache/beam/pull/14770&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/14770&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17466200" author="altay" created="Tue, 28 Dec 2021 20:25:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tvalentyn&quot; class=&quot;user-hover&quot; rel=&quot;tvalentyn&quot;&gt;tvalentyn&lt;/a&gt; - Assigned this to find an owner. I do not think it is very urgent, but is definitely a getting started and ease of use issue. It is also possible a simple fix by ignoring the errors for unauthenticated users.&lt;/p&gt;</comment>
                            <comment id="17469602" author="ningk" created="Thu, 6 Jan 2022 00:27:09 +0000"  >&lt;p&gt;Fix merged, to be released in v2.37.0 and is expected to be available in Mar. 16, 2022.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 44 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0uuj4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>