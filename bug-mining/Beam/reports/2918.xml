<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:25:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-9245] Unable to pull datatore Entity which contains dict properties</title>
                <link>https://issues.apache.org/jira/browse/BEAM-9245</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;Hello, we are facing a small bug while reading Datastore entities using ReadFromDatastore transform (python SDK, 2.17 &amp;amp; 2.18)&lt;/p&gt;

&lt;p&gt;We are unable to retrieve entities that contain a dictionary. We think there is implicit casting from these properties into Datastore entity, but when the client is trying to retrieve the entity using the key, it breaks (because this entity has no key).&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;%C2%A0Stacktrace&quot;&gt;&lt;/a&gt;&#160;Stacktrace&lt;/h2&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-python&quot;&gt;
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;.../venv/lib/python3.7/site-packages/apache_beam/io/gcp/datastore/v1new/datastoreio.py&quot;&lt;/span&gt;, line 269, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; process
    &lt;span class=&quot;code-keyword&quot;&gt;yield&lt;/span&gt; types.Entity.from_client_entity(client_entity)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;.../venv/lib/python3.7/site-packages/apache_beam/io/gcp/datastore/v1new/types.py&quot;&lt;/span&gt;, line 225, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; from_client_entity
    value = Entity.from_client_entity(value)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;.../venv/lib/python3.7/site-packages/apache_beam/io/gcp/datastore/v1new/types.py&quot;&lt;/span&gt;, line 219, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; from_client_entity
    Key.from_client_key(client_entity.key),
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;.../venv/lib/python3.7/site-packages/apache_beam/io/gcp/datastore/v1new/types.py&quot;&lt;/span&gt;, line 156, &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; from_client_key
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Key(client_key.flat_path, project=client_key.project,
&lt;span class=&quot;code-object&quot;&gt;AttributeError&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;NoneType&apos;&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;object&lt;/span&gt; has no attribute &lt;span class=&quot;code-quote&quot;&gt;&apos;flat_path&apos;&lt;/span&gt; [&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; running &lt;span class=&quot;code-quote&quot;&gt;&apos;Read &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; datastore/Read&apos;&lt;/span&gt;]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;%C2%A0Hereissomecodetoreproduce%3A&quot;&gt;&lt;/a&gt;&#160;Here is some code to reproduce:&lt;/h2&gt;
&lt;ol&gt;
	&lt;li&gt;Insert a datastore entity using the given function&lt;/li&gt;
	&lt;li&gt;Run the dataflow pipeline using DirectRunner&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-python&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; apache_beam &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; beam
&lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; google.cloud &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; datastore
&lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; apache_beam.io.gcp.datastore.v1new.types &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; Query
&lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; apache_beam.io.gcp.datastore.v1new.datastoreio &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; ReadFromDatastore
&lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; apache_beam.options.pipeline_options &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; StandardOptions, PipelineOptions

DATASTORE_KIND = &lt;span class=&quot;code-quote&quot;&gt;&quot;my_entity_kind&quot;&lt;/span&gt;
PROJECT_ID = &lt;span class=&quot;code-quote&quot;&gt;&quot;my_project_id&quot;&lt;/span&gt;


&lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; create_datastore_entity():
    client = datastore.Client(PROJECT_ID)

    key = client.key(DATASTORE_KIND, &lt;span class=&quot;code-quote&quot;&gt;&quot;my_task&quot;&lt;/span&gt;)

    entity = client.get(key=key)
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; entity &lt;span class=&quot;code-keyword&quot;&gt;is&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;None&lt;/span&gt;&lt;/span&gt;:
        &lt;span class=&quot;code-keyword&quot;&gt;raise&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Exception&lt;/span&gt;(&lt;span class=&quot;code-quote&quot;&gt;&quot;Existing entity&quot;&lt;/span&gt;)
    &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;:
        entity_dict = {&lt;span class=&quot;code-quote&quot;&gt;&quot;regular_field&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;nested_field&quot;&lt;/span&gt;: {&lt;span class=&quot;code-quote&quot;&gt;&quot;field1&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;my_field1&quot;&lt;/span&gt;}}
        entity = datastore.Entity(key=key)
    entity_dict = {k: v &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; k, v &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; entity_dict.items()}
    entity.update(entity_dict)
    client.put(entity)


&lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; my_func(element):
    &lt;span class=&quot;code-object&quot;&gt;print&lt;/span&gt;(element)
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; element


&lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; run():
    pipeline_options = PipelineOptions()

    pipeline_options.view_as(StandardOptions).runner = &lt;span class=&quot;code-quote&quot;&gt;&quot;DirectRunner&quot;&lt;/span&gt;
    p = beam.Pipeline(options=pipeline_options)
    my_ds_query = Query(kind=DATASTORE_KIND, project=PROJECT_ID,)
    p | &lt;span class=&quot;code-quote&quot;&gt;&quot;Read &lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; datastore&quot;&lt;/span&gt; &amp;gt;&amp;gt; ReadFromDatastore(
        query=my_ds_query
    ) | &lt;span class=&quot;code-quote&quot;&gt;&quot;Print entity&quot;&lt;/span&gt; &amp;gt;&amp;gt; beam.Map(my_func)
    p.run().wait_until_finish()


&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;__name__&lt;/span&gt; == &lt;span class=&quot;code-quote&quot;&gt;&quot;__main__&quot;&lt;/span&gt;:
    create_datastore_entity()
    run()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;h2&gt;&lt;a name=&quot;%C2%A0&quot;&gt;&lt;/a&gt;&#160;&lt;/h2&gt;
&lt;p&gt; Workaround&lt;/p&gt;

&lt;p&gt;Currently, we mocked the library using this code (modifying the Entity class, in `sdks/python/apache_beam/io/gcp/datastore/v1new/types.py`, aka this&#160;&lt;a href=&quot;https://github.com/apache/beam/blob/master/sdks/python/apache_beam/io/gcp/datastore/v1new/types.py#L231&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;line&lt;/a&gt; ).&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-python&quot;&gt;
  @&lt;span class=&quot;code-object&quot;&gt;staticmethod&lt;/span&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; from_client_entity(client_entity):
    res = Entity(
        Key.from_client_key(client_entity.key),
        exclude_from_indexes=&lt;span class=&quot;code-object&quot;&gt;set&lt;/span&gt;(client_entity.exclude_from_indexes))
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; name, value &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; client_entity.items():
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;isinstance&lt;/span&gt;(value, key.Key):
        value = Key.from_client_key(value)
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;isinstance&lt;/span&gt;(value, entity.Entity):
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; value.key:
          value = Entity.from_client_entity(value)
        &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;:
          value = {k:v &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; k,v &lt;span class=&quot;code-keyword&quot;&gt;in&lt;/span&gt; value.items()}
      res.properties[name] = value
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; res
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;If the workaround works for you, I can do the PR.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks, Colin&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13283002">BEAM-9245</key>
            <summary>Unable to pull datatore Entity which contains dict properties</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10103" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">P3</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="clenost">Colin Le Nost</reporter>
                        <labels>
                    </labels>
                <created>Mon, 3 Feb 2020 15:35:37 +0000</created>
                <updated>Wed, 4 May 2022 21:25:05 +0000</updated>
                            <resolved>Wed, 4 May 2022 21:25:05 +0000</resolved>
                                    <version>2.18.0</version>
                                    <fixVersion>2.39.0</fixVersion>
                                    <component>sdk-py-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4800">1h 20m</timespent>
                                        <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 41 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0b3yo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>