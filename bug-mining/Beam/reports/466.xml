<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:47:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-2732] State tracking in Python is inefficient and has duplicated code</title>
                <link>https://issues.apache.org/jira/browse/BEAM-2732</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;e.g logging and metrics keep state separately. State tracking should be unified.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13092558">BEAM-2732</key>
            <summary>State tracking in Python is inefficient and has duplicated code</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pabloem">Pablo Estrada</assignee>
                                    <reporter username="pabloem">Pablo Estrada</reporter>
                        <labels>
                    </labels>
                <created>Fri, 4 Aug 2017 18:24:16 +0000</created>
                <updated>Sat, 16 May 2020 13:37:44 +0000</updated>
                            <resolved>Wed, 1 Aug 2018 17:39:59 +0000</resolved>
                                                    <fixVersion>2.6.0</fixVersion>
                                    <component>sdk-py-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="70800">19h 40m</timespent>
                                                        <aggregatetimeremainingestimate seconds="0">0h</aggregatetimeremainingestimate>
                                        <aggregatetimespent seconds="75600">21h</aggregatetimespent>
                                    <comments>
                            <comment id="16319265" author="githubbot" created="Tue, 9 Jan 2018 22:05:25 +0000"  >&lt;p&gt;pabloem opened a new pull request #4375: &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-2732&quot; title=&quot;State tracking in Python is inefficient and has duplicated code&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-2732&quot;&gt;&lt;del&gt;BEAM-2732&lt;/del&gt;&lt;/a&gt; Starting refactor of state tracking in Python&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/beam/pull/4375&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/4375&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   The goal for &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-2732&quot; title=&quot;State tracking in Python is inefficient and has duplicated code&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-2732&quot;&gt;&lt;del&gt;BEAM-2732&lt;/del&gt;&lt;/a&gt; is to refactor the context trackers in the Python SDK so that they will all use the same mechanism.&lt;br/&gt;
   Currently, Metrics, Logging and StateSampler keep their own contexts. &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-2732&quot; title=&quot;State tracking in Python is inefficient and has duplicated code&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-2732&quot;&gt;&lt;del&gt;BEAM-2732&lt;/del&gt;&lt;/a&gt; aims to have all of them rely on the logic in StateSampler to keep their context (this is already the case in Java).&lt;/p&gt;

&lt;p&gt;   This PR does the following:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Clean up legacy code in the StateSampler.&lt;/li&gt;
	&lt;li&gt;Adds a global per-thread variable for state sampler, so each execution thread will be able to access the current state sampler from this global variable (this will then be used for LoggingContext, and MetricsEnvironment.current_container).&lt;/li&gt;
	&lt;li&gt;Gives the Python-only state sampler functionality to track context, so that non-Cythonized runners can rely on the StateSampler to track context.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16321322" author="githubbot" created="Wed, 10 Jan 2018 23:14:44 +0000"  >&lt;p&gt;pabloem opened a new pull request #4387: &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-2732&quot; title=&quot;State tracking in Python is inefficient and has duplicated code&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-2732&quot;&gt;&lt;del&gt;BEAM-2732&lt;/del&gt;&lt;/a&gt; Metrics rely on statesampler state&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/beam/pull/4387&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/4387&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   This PR depends on PR #4375.&lt;/p&gt;

&lt;p&gt;   This PR is a backward-compatible change that allows metrics to rely on statesampler state to provide the current container.&lt;/p&gt;

&lt;p&gt;   This change should enable all clients to stop tracking metrics with its own context, and start using statesampler for that.&lt;/p&gt;

&lt;p&gt;   Benchmarks showed no impact on performance. Benchmark done using an ML Criteo pipeline that processes 10gb.&lt;/p&gt;

&lt;p&gt;   Results Before Change (5 runs):&lt;br/&gt;
   Mean: 1809.2s, Stdev: 227.1622768&lt;/p&gt;

&lt;p&gt;   Results With Change (5 runs):&lt;br/&gt;
   Mean: 1758.4s, Stdev: 93.46282684&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16322819" author="githubbot" created="Thu, 11 Jan 2018 19:32:28 +0000"  >&lt;p&gt;pabloem opened a new pull request #4395: &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-2732&quot; title=&quot;State tracking in Python is inefficient and has duplicated code&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-2732&quot;&gt;&lt;del&gt;BEAM-2732&lt;/del&gt;&lt;/a&gt; Logging relies on statesampler state&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/beam/pull/4395&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/4395&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   This PR depends on PR #4375, and PR #4387.&lt;/p&gt;

&lt;p&gt;   This PR is a backward-compatible change that allows logging to rely on statesampler state to provide the current step name.&lt;/p&gt;

&lt;p&gt;   This change should enable all clients to stop using the legacy logging to switch state across every operation, and start using statesampler for that.&lt;/p&gt;

&lt;p&gt;   This change should not have a significant performance impact, as JsonLogFormatter was already relying on a Thread local to retrieve the logging information.&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16331275" author="githubbot" created="Thu, 18 Jan 2018 21:39:51 +0000"  >&lt;p&gt;robertwb closed pull request #4375: &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-2732&quot; title=&quot;State tracking in Python is inefficient and has duplicated code&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-2732&quot;&gt;&lt;del&gt;BEAM-2732&lt;/del&gt;&lt;/a&gt; Starting refactor of state tracking in Python&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/beam/pull/4375&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/4375&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/sdks/python/apache_beam/runners/portability/fn_api_runner_test.py b/sdks/python/apache_beam/runners/portability/fn_api_runner_test.py&lt;br/&gt;
index 6304f71df5e..83bb83a83ff 100644&lt;br/&gt;
&amp;#8212; a/sdks/python/apache_beam/runners/portability/fn_api_runner_test.py&lt;br/&gt;
+++ b/sdks/python/apache_beam/runners/portability/fn_api_runner_test.py&lt;br/&gt;
@@ -23,13 +23,14 @@&lt;br/&gt;
 from apache_beam.runners.portability import fn_api_runner&lt;br/&gt;
 from apache_beam.runners.portability import maptask_executor_runner_test&lt;br/&gt;
 from apache_beam.runners.worker import sdk_worker&lt;br/&gt;
+from apache_beam.runners.worker import statesampler&lt;br/&gt;
 from apache_beam.testing.util import assert_that&lt;br/&gt;
 from apache_beam.testing.util import equal_to&lt;br/&gt;
 from apache_beam.transforms import window&lt;/p&gt;

&lt;p&gt;-try:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;from apache_beam.runners.worker.statesampler import DEFAULT_SAMPLING_PERIOD_MS&lt;br/&gt;
-except ImportError:&lt;br/&gt;
+if statesampler.FAST_SAMPLER:&lt;br/&gt;
+  DEFAULT_SAMPLING_PERIOD_MS = statesampler.DEFAULT_SAMPLING_PERIOD_MS&lt;br/&gt;
+else:&lt;br/&gt;
   DEFAULT_SAMPLING_PERIOD_MS = 0&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;diff --git a/sdks/python/apache_beam/runners/portability/maptask_executor_runner.py b/sdks/python/apache_beam/runners/portability/maptask_executor_runner.py&lt;br/&gt;
index 913ccd59585..74c6b03f5a6 100644&lt;br/&gt;
&amp;#8212; a/sdks/python/apache_beam/runners/portability/maptask_executor_runner.py&lt;br/&gt;
+++ b/sdks/python/apache_beam/runners/portability/maptask_executor_runner.py&lt;br/&gt;
@@ -36,15 +36,11 @@&lt;br/&gt;
 from apache_beam.runners.runner import PipelineState&lt;br/&gt;
 from apache_beam.runners.worker import operation_specs&lt;br/&gt;
 from apache_beam.runners.worker import operations&lt;br/&gt;
+from apache_beam.runners.worker import statesampler&lt;br/&gt;
 from apache_beam.typehints import typehints&lt;br/&gt;
 from apache_beam.utils import profiler&lt;br/&gt;
 from apache_beam.utils.counters import CounterFactory&lt;/p&gt;

&lt;p&gt;-try:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;from apache_beam.runners.worker import statesampler&lt;br/&gt;
-except ImportError:&lt;/li&gt;
	&lt;li&gt;from apache_beam.runners.worker import statesampler_fake as statesampler&lt;br/&gt;
-&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
	&lt;li&gt;This module is experimental. No backwards-compatibility guarantees.&lt;/li&gt;
&lt;/ol&gt;



&lt;p&gt;diff --git a/sdks/python/apache_beam/runners/worker/bundle_processor.py b/sdks/python/apache_beam/runners/worker/bundle_processor.py&lt;br/&gt;
index 1b270b90372..fa303e88891 100644&lt;br/&gt;
&amp;#8212; a/sdks/python/apache_beam/runners/worker/bundle_processor.py&lt;br/&gt;
+++ b/sdks/python/apache_beam/runners/worker/bundle_processor.py&lt;br/&gt;
@@ -38,6 +38,7 @@&lt;br/&gt;
 from apache_beam.runners import pipeline_context&lt;br/&gt;
 from apache_beam.runners.worker import operation_specs&lt;br/&gt;
 from apache_beam.runners.worker import operations&lt;br/&gt;
+from apache_beam.runners.worker import statesampler&lt;br/&gt;
 from apache_beam.transforms import sideinputs&lt;br/&gt;
 from apache_beam.utils import counters&lt;br/&gt;
 from apache_beam.utils import proto_utils&lt;br/&gt;
@@ -46,12 +47,6 @@&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;This module is experimental. No backwards-compatibility guarantees.&lt;/li&gt;
&lt;/ol&gt;



&lt;p&gt;-try:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;from apache_beam.runners.worker import statesampler&lt;br/&gt;
-except ImportError:&lt;/li&gt;
	&lt;li&gt;from apache_beam.runners.worker import statesampler_fake as statesampler&lt;br/&gt;
-&lt;br/&gt;
-&lt;br/&gt;
 DATA_INPUT_URN = &apos;urn:org.apache.beam:source:runner:0.1&apos;&lt;br/&gt;
 DATA_OUTPUT_URN = &apos;urn:org.apache.beam:sink:runner:0.1&apos;&lt;br/&gt;
 IDENTITY_DOFN_URN = &apos;urn:org.apache.beam:dofn:identity:0.1&apos;&lt;br/&gt;
diff --git a/sdks/python/apache_beam/runners/worker/statesampler.py b/sdks/python/apache_beam/runners/worker/statesampler.py&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..03af644846d
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;/dev/null&lt;br/&gt;
+++ b/sdks/python/apache_beam/runners/worker/statesampler.py&lt;br/&gt;
@@ -0,0 +1,81 @@&lt;br/&gt;
+#&lt;br/&gt;
+# Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
+# contributor license agreements.  See the NOTICE file distributed with&lt;br/&gt;
+# this work for additional information regarding copyright ownership.&lt;br/&gt;
+# The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
+# (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
+# the License.  You may obtain a copy of the License at&lt;br/&gt;
+#&lt;br/&gt;
+#    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+#&lt;br/&gt;
+# Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+# distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+# See the License for the specific language governing permissions and&lt;br/&gt;
+# limitations under the License.&lt;br/&gt;
+#&lt;br/&gt;
+&lt;br/&gt;
+# This module is experimental. No backwards-compatibility guarantees.&lt;br/&gt;
+from collections import namedtuple&lt;br/&gt;
+&lt;br/&gt;
+from apache_beam.utils.counters import Counter&lt;br/&gt;
+from apache_beam.utils.counters import CounterName&lt;br/&gt;
+&lt;br/&gt;
+try:&lt;br/&gt;
+  from apache_beam.runners.worker import statesampler_fast as statesampler_impl&lt;br/&gt;
+  FAST_SAMPLER = True&lt;br/&gt;
+except ImportError:&lt;br/&gt;
+  from apache_beam.runners.worker import statesampler_slow as statesampler_impl&lt;br/&gt;
+  FAST_SAMPLER = False&lt;br/&gt;
+&lt;br/&gt;
+&lt;br/&gt;
+StateSamplerInfo = namedtuple(&lt;br/&gt;
+    &apos;StateSamplerInfo&apos;,&lt;br/&gt;
+    &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;#39;state_name&amp;#39;, &amp;#39;transition_count&amp;#39;, &amp;#39;time_since_transition&amp;#39;&amp;#93;&lt;/span&gt;)&lt;br/&gt;
+&lt;br/&gt;
+&lt;br/&gt;
+# Default period for sampling current state of pipeline execution.&lt;br/&gt;
+DEFAULT_SAMPLING_PERIOD_MS = 200&lt;br/&gt;
+&lt;br/&gt;
+&lt;br/&gt;
+class StateSampler(statesampler_impl.StateSampler):&lt;br/&gt;
+&lt;br/&gt;
+  def _&lt;em&gt;init&lt;/em&gt;_(self, prefix, counter_factory,&lt;br/&gt;
+               sampling_period_ms=DEFAULT_SAMPLING_PERIOD_MS):&lt;br/&gt;
+    self.states_by_name = {}&lt;br/&gt;
+    self._prefix = prefix&lt;br/&gt;
+    self._counter_factory = counter_factory&lt;br/&gt;
+    self._states_by_name = {}&lt;br/&gt;
+    self.sampling_period_ms = sampling_period_ms&lt;br/&gt;
+    super(StateSampler, self)._&lt;em&gt;init&lt;/em&gt;_(sampling_period_ms)&lt;br/&gt;
+&lt;br/&gt;
+  def stop_if_still_running(self):&lt;br/&gt;
+    if self.started and not self.finished:&lt;br/&gt;
+      self.stop()&lt;br/&gt;
+&lt;br/&gt;
+  def get_info(self):&lt;br/&gt;
+    &quot;&quot;&quot;Returns StateSamplerInfo with transition statistics.&quot;&quot;&quot;&lt;br/&gt;
+    return StateSamplerInfo(&lt;br/&gt;
+        self.current_state().name,&lt;br/&gt;
+        self.state_transition_count,&lt;br/&gt;
+        self.time_since_transition)&lt;br/&gt;
+&lt;br/&gt;
+  def scoped_state(self, step_name, state_name, io_target=None):&lt;br/&gt;
+    counter_name = CounterName(state_name + &apos;-msecs&apos;,&lt;br/&gt;
+                               stage_name=self._prefix,&lt;br/&gt;
+                               step_name=step_name,&lt;br/&gt;
+                               io_target=io_target)&lt;br/&gt;
+    if counter_name in self._states_by_name:&lt;br/&gt;
+      return self._states_by_name&lt;span class=&quot;error&quot;&gt;&amp;#91;counter_name&amp;#93;&lt;/span&gt;&lt;br/&gt;
+    else:&lt;br/&gt;
+      output_counter = self._counter_factory.get_counter(counter_name,&lt;br/&gt;
+                                                         Counter.SUM)&lt;br/&gt;
+      self._states_by_name&lt;span class=&quot;error&quot;&gt;&amp;#91;counter_name&amp;#93;&lt;/span&gt; = super(&lt;br/&gt;
+          StateSampler, self)._scoped_state(counter_name, output_counter)&lt;br/&gt;
+      return self._states_by_name&lt;span class=&quot;error&quot;&gt;&amp;#91;counter_name&amp;#93;&lt;/span&gt;&lt;br/&gt;
+&lt;br/&gt;
+  def commit_counters(self):&lt;br/&gt;
+    &quot;&quot;&quot;Updates output counters with latest state statistics.&quot;&quot;&quot;&lt;br/&gt;
+    for state in self._states_by_name.values():&lt;br/&gt;
+      state_msecs = int(1e-6 * state.nsecs)&lt;br/&gt;
+      state.counter.update(state_msecs - state.counter.value())&lt;br/&gt;
diff --git a/sdks/python/apache_beam/runners/worker/statesampler_fake.py b/sdks/python/apache_beam/runners/worker/statesampler_fake.py&lt;br/&gt;
deleted file mode 100644&lt;br/&gt;
index bc56021520a..00000000000&lt;/li&gt;
			&lt;li&gt;a/sdks/python/apache_beam/runners/worker/statesampler_fake.py&lt;br/&gt;
+++ /dev/null&lt;br/&gt;
@@ -1,51 +0,0 @@&lt;br/&gt;
-#&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;ol&gt;
		&lt;li&gt;Licensed to the Apache Software Foundation (ASF) under one or more&lt;/li&gt;
		&lt;li&gt;contributor license agreements.  See the NOTICE file distributed with&lt;/li&gt;
		&lt;li&gt;this work for additional information regarding copyright ownership.&lt;/li&gt;
		&lt;li&gt;The ASF licenses this file to You under the Apache License, Version 2.0&lt;/li&gt;
		&lt;li&gt;(the &quot;License&quot;); you may not use this file except in compliance with&lt;/li&gt;
		&lt;li&gt;the License.  You may obtain a copy of the License at&lt;br/&gt;
-#&lt;/li&gt;
		&lt;li&gt;&lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
-#&lt;/li&gt;
		&lt;li&gt;Unless required by applicable law or agreed to in writing, software&lt;/li&gt;
		&lt;li&gt;distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;/li&gt;
		&lt;li&gt;WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;/li&gt;
		&lt;li&gt;See the License for the specific language governing permissions and&lt;/li&gt;
		&lt;li&gt;limitations under the License.&lt;br/&gt;
-#&lt;br/&gt;
-&lt;/li&gt;
		&lt;li&gt;This module is experimental. No backwards-compatibility guarantees.&lt;br/&gt;
-&lt;br/&gt;
-&lt;br/&gt;
-class StateSampler(object):&lt;br/&gt;
-&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;def _&lt;em&gt;init&lt;/em&gt;_(self, *args, **kwargs):&lt;/li&gt;
	&lt;li&gt;pass&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;def scoped_state(self, step_name, state_name=None, io_target=None):&lt;/li&gt;
	&lt;li&gt;return _FakeScopedState()&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;def start(self):&lt;/li&gt;
	&lt;li&gt;pass&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;def stop(self):&lt;/li&gt;
	&lt;li&gt;pass&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;def stop_if_still_running(self):&lt;/li&gt;
	&lt;li&gt;self.stop()&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;def commit_counters(self):&lt;/li&gt;
	&lt;li&gt;pass&lt;br/&gt;
-&lt;br/&gt;
-&lt;br/&gt;
-class _FakeScopedState(object):&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;def _&lt;em&gt;enter&lt;/em&gt;_(self):&lt;/li&gt;
	&lt;li&gt;pass&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;def _&lt;em&gt;exit&lt;/em&gt;_(self, *unused_args):&lt;/li&gt;
	&lt;li&gt;pass&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;def sampled_seconds(self):&lt;/li&gt;
	&lt;li&gt;return 0&lt;br/&gt;
diff --git a/sdks/python/apache_beam/runners/worker/statesampler.pyx b/sdks/python/apache_beam/runners/worker/statesampler_fast.pyx&lt;br/&gt;
similarity index 64%&lt;br/&gt;
rename from sdks/python/apache_beam/runners/worker/statesampler.pyx&lt;br/&gt;
rename to sdks/python/apache_beam/runners/worker/statesampler_fast.pyx&lt;br/&gt;
index 1e371968a4f..d0b187818c1 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/sdks/python/apache_beam/runners/worker/statesampler.pyx&lt;br/&gt;
+++ b/sdks/python/apache_beam/runners/worker/statesampler_fast.pyx&lt;br/&gt;
@@ -34,13 +34,7 @@ thread queries the current state, the time spent since the previous sample is&lt;br/&gt;
 attributed to that state and accumulated.  Over time, this allows a granular&lt;br/&gt;
 runtime profile to be produced.&lt;br/&gt;
 &quot;&quot;&quot;&lt;br/&gt;
-&lt;br/&gt;
 import threading&lt;br/&gt;
-import time&lt;br/&gt;
-&lt;br/&gt;
-&lt;br/&gt;
-from apache_beam.utils.counters import Counter&lt;br/&gt;
-from apache_beam.utils.counters import CounterName&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; cimport cython&lt;br/&gt;
 from cpython cimport pythread&lt;br/&gt;
@@ -71,37 +65,14 @@ cdef inline int64_t get_nsec_time() nogil:&lt;br/&gt;
       current_time.tv_nsec)&lt;/p&gt;


&lt;p&gt;-class StateSamplerInfo(object):&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&quot;&quot;&quot;Info for current state and transition statistics of StateSampler.&quot;&quot;&quot;&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;def _&lt;em&gt;init&lt;/em&gt;_(self, state_name, transition_count, time_since_transition):&lt;/li&gt;
	&lt;li&gt;self.state_name = state_name&lt;/li&gt;
	&lt;li&gt;self.transition_count = transition_count&lt;/li&gt;
	&lt;li&gt;self.time_since_transition = time_since_transition&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;def _&lt;em&gt;repr&lt;/em&gt;_(self):&lt;/li&gt;
	&lt;li&gt;return (&apos;&amp;lt;StateSamplerInfo state: %s time: %dns transitions: %d&amp;gt;&apos;&lt;/li&gt;
	&lt;li&gt;% (self.state_name,&lt;/li&gt;
	&lt;li&gt;self.time_since_transition,&lt;/li&gt;
	&lt;li&gt;self.transition_count))&lt;br/&gt;
-&lt;br/&gt;
-
	&lt;ol&gt;
		&lt;li&gt;Default period for sampling current state of pipeline execution.&lt;br/&gt;
-DEFAULT_SAMPLING_PERIOD_MS = 200&lt;br/&gt;
-&lt;br/&gt;
-&lt;br/&gt;
 cdef class StateSampler(object):&lt;br/&gt;
   &quot;&quot;&quot;Tracks time spent in states during pipeline execution.&quot;&quot;&quot;&lt;br/&gt;
+  cdef int _sampling_period_ms&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;cdef object prefix&lt;/li&gt;
	&lt;li&gt;cdef object counter_factory&lt;/li&gt;
	&lt;li&gt;cdef int sampling_period_ms&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;cdef dict scoped_states_by_name&lt;br/&gt;
   cdef list scoped_states_by_index&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;cdef bint started&lt;/li&gt;
	&lt;li&gt;cdef bint finished&lt;br/&gt;
+  cdef public bint started&lt;br/&gt;
+  cdef public bint finished&lt;br/&gt;
   cdef object sampling_thread&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;This lock guards members that are shared between threads, specificaly&lt;br/&gt;
@@ -109,22 +80,16 @@ cdef class StateSampler(object):&lt;br/&gt;
   cdef pythread.PyThread_type_lock lock&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;   cdef public int64_t state_transition_count&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;cdef int64_t time_since_transition&lt;br/&gt;
+  cdef public int64_t time_since_transition&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   cdef int32_t current_state_index&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;def _&lt;em&gt;init&lt;/em&gt;_(self, prefix, counter_factory,&lt;/li&gt;
	&lt;li&gt;sampling_period_ms=DEFAULT_SAMPLING_PERIOD_MS):&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;# TODO(pabloem): Remove this once all dashed prefixes are removed from&lt;/li&gt;
	&lt;li&gt;# the worker.&lt;/li&gt;
	&lt;li&gt;# We stop using prefixes with included dash.&lt;/li&gt;
	&lt;li&gt;self.prefix = prefix&lt;span class=&quot;error&quot;&gt;&amp;#91;:-1&amp;#93;&lt;/span&gt; if prefix&lt;span class=&quot;error&quot;&gt;&amp;#91;-1&amp;#93;&lt;/span&gt; == &apos;-&apos; else prefix&lt;/li&gt;
	&lt;li&gt;self.counter_factory = counter_factory&lt;/li&gt;
	&lt;li&gt;self.sampling_period_ms = sampling_period_ms&lt;br/&gt;
+  def _&lt;em&gt;init&lt;/em&gt;_(self, sampling_period_ms, *args):&lt;br/&gt;
+    self._sampling_period_ms = sampling_period_ms&lt;br/&gt;
+    self.started = False&lt;br/&gt;
+    self.finished = False&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     self.lock = pythread.PyThread_allocate_lock()&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;self.scoped_states_by_name = {}&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     self.current_state_index = 0&lt;br/&gt;
     self.time_since_transition = 0&lt;br/&gt;
@@ -132,7 +97,6 @@ cdef class StateSampler(object):&lt;br/&gt;
     unknown_state = ScopedState(self, &apos;unknown&apos;, self.current_state_index)&lt;br/&gt;
     pythread.PyThread_acquire_lock(self.lock, pythread.WAIT_LOCK)&lt;br/&gt;
     self.scoped_states_by_index = &lt;span class=&quot;error&quot;&gt;&amp;#91;unknown_state&amp;#93;&lt;/span&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;self.finished = False&lt;br/&gt;
     pythread.PyThread_release_lock(self.lock)&lt;/li&gt;
&lt;/ul&gt;


&lt;ol&gt;
	&lt;li&gt;Assert that the compiler correctly aligned the current_state field.  This&lt;br/&gt;
@@ -152,7 +116,7 @@ cdef class StateSampler(object):&lt;br/&gt;
     cdef int64_t latest_transition_count = self.state_transition_count&lt;br/&gt;
     with nogil:&lt;br/&gt;
       while True:&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;usleep(self.sampling_period_ms * 1000)&lt;br/&gt;
+        usleep(self._sampling_period_ms * 1000)&lt;br/&gt;
         pythread.PyThread_acquire_lock(self.lock, pythread.WAIT_LOCK)&lt;br/&gt;
         try:&lt;br/&gt;
           if self.finished:&lt;br/&gt;
@@ -161,7 +125,7 @@ cdef class StateSampler(object):&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
	&lt;li&gt;Take an address as we can&apos;t create a reference to the scope&lt;/li&gt;
	&lt;li&gt;without the GIL.&lt;br/&gt;
           nsecs_ptr = &amp;amp;(&amp;lt;ScopedState&amp;gt;PyList_GET_ITEM(&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;self.scoped_states_by_index, self.current_state_index)).nsecs&lt;br/&gt;
+              self.scoped_states_by_index, self.current_state_index))._nsecs&lt;br/&gt;
           nsecs_ptr&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; += elapsed_nsecs&lt;br/&gt;
           if latest_transition_count != self.state_transition_count:&lt;br/&gt;
             self.time_since_transition = 0&lt;br/&gt;
@@ -186,64 +150,28 @@ cdef class StateSampler(object):&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
	&lt;li&gt;pythread doesn&apos;t support conditions.&lt;br/&gt;
     self.sampling_thread.join()&lt;/li&gt;
&lt;/ol&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;def stop_if_still_running(self):&lt;/li&gt;
	&lt;li&gt;if self.started and not self.finished:&lt;/li&gt;
	&lt;li&gt;self.stop()&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;def get_info(self):&lt;/li&gt;
	&lt;li&gt;&quot;&quot;&quot;Returns StateSamplerInfo with transition statistics.&quot;&quot;&quot;&lt;/li&gt;
	&lt;li&gt;return StateSamplerInfo(&lt;/li&gt;
	&lt;li&gt;self.scoped_states_by_index&lt;span class=&quot;error&quot;&gt;&amp;#91;self.current_state_index&amp;#93;&lt;/span&gt;.name,&lt;/li&gt;
	&lt;li&gt;self.state_transition_count,&lt;/li&gt;
	&lt;li&gt;self.time_since_transition)&lt;br/&gt;
+  def current_state(self):&lt;br/&gt;
+    return self.scoped_states_by_index&lt;span class=&quot;error&quot;&gt;&amp;#91;self.current_state_index&amp;#93;&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;# TODO(pabloem): Make state_name required once all callers migrate,&lt;/li&gt;
	&lt;li&gt;#   and the legacy path is removed.&lt;/li&gt;
	&lt;li&gt;def scoped_state(self, step_name, state_name=None, io_target=None):&lt;br/&gt;
+  cpdef _scoped_state(self, counter_name, output_counter):&lt;br/&gt;
     &quot;&quot;&quot;Returns a context manager managing transitions for a given state.&lt;br/&gt;
     Args:&lt;/li&gt;
	&lt;li&gt;step_name: A string with the name of the running step.&lt;/li&gt;
	&lt;li&gt;state_name: A string with the name of the state (e.g. &apos;process&apos;, &apos;start&apos;)&lt;/li&gt;
	&lt;li&gt;io_target: An IOTargetName object describing the io_target (e.g. writing&lt;/li&gt;
	&lt;li&gt;or reading to side inputs, shuffle or state). Will often be None.&lt;br/&gt;
+     TODO(pabloem)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     Returns:&lt;br/&gt;
       A ScopedState for the set of step-state-io_target.&lt;br/&gt;
     &quot;&quot;&quot;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;cdef ScopedState scoped_state&lt;/li&gt;
	&lt;li&gt;if state_name is None:&lt;/li&gt;
	&lt;li&gt;# If state_name is None, the worker is still using old style&lt;/li&gt;
	&lt;li&gt;# msec counters.&lt;/li&gt;
	&lt;li&gt;counter_name = &apos;%s-%s-msecs&apos; % (self.prefix, step_name)&lt;/li&gt;
	&lt;li&gt;scoped_state = self.scoped_states_by_name.get(counter_name, None)&lt;/li&gt;
	&lt;li&gt;else:&lt;/li&gt;
	&lt;li&gt;counter_name = CounterName(state_name + &apos;-msecs&apos;,&lt;/li&gt;
	&lt;li&gt;stage_name=self.prefix,&lt;/li&gt;
	&lt;li&gt;step_name=step_name,&lt;/li&gt;
	&lt;li&gt;io_target=io_target)&lt;/li&gt;
	&lt;li&gt;scoped_state = self.scoped_states_by_name.get(counter_name, None)&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;if scoped_state is None:&lt;/li&gt;
	&lt;li&gt;output_counter = self.counter_factory.get_counter(counter_name,&lt;/li&gt;
	&lt;li&gt;Counter.SUM)&lt;/li&gt;
	&lt;li&gt;new_state_index = len(self.scoped_states_by_index)&lt;/li&gt;
	&lt;li&gt;scoped_state = ScopedState(self, counter_name,&lt;/li&gt;
	&lt;li&gt;new_state_index, output_counter)&lt;/li&gt;
	&lt;li&gt;# Both scoped_states_by_index and scoped_state.nsecs are accessed&lt;/li&gt;
	&lt;li&gt;# by the sampling thread; initialize them under the lock.&lt;/li&gt;
	&lt;li&gt;pythread.PyThread_acquire_lock(self.lock, pythread.WAIT_LOCK)&lt;/li&gt;
	&lt;li&gt;self.scoped_states_by_index.append(scoped_state)&lt;/li&gt;
	&lt;li&gt;scoped_state.nsecs = 0&lt;/li&gt;
	&lt;li&gt;pythread.PyThread_release_lock(self.lock)&lt;/li&gt;
	&lt;li&gt;self.scoped_states_by_name&lt;span class=&quot;error&quot;&gt;&amp;#91;counter_name&amp;#93;&lt;/span&gt; = scoped_state&lt;br/&gt;
+    new_state_index = len(self.scoped_states_by_index)&lt;br/&gt;
+    scoped_state = ScopedState(self, counter_name,&lt;br/&gt;
+                               new_state_index, output_counter)&lt;br/&gt;
+    # Both scoped_states_by_index and scoped_state.nsecs are accessed&lt;br/&gt;
+    # by the sampling thread; initialize them under the lock.&lt;br/&gt;
+    pythread.PyThread_acquire_lock(self.lock, pythread.WAIT_LOCK)&lt;br/&gt;
+    self.scoped_states_by_index.append(scoped_state)&lt;br/&gt;
+    scoped_state._nsecs = 0&lt;br/&gt;
+    pythread.PyThread_release_lock(self.lock)&lt;br/&gt;
     return scoped_state&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;def commit_counters(self):&lt;/li&gt;
	&lt;li&gt;&quot;&quot;&quot;Updates output counters with latest state statistics.&quot;&quot;&quot;&lt;/li&gt;
	&lt;li&gt;for state in self.scoped_states_by_name.values():&lt;/li&gt;
	&lt;li&gt;state_msecs = int(1e-6 * state.nsecs)&lt;/li&gt;
	&lt;li&gt;state.counter.update(state_msecs - state.counter.value())&lt;br/&gt;
-&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt; cdef class ScopedState(object):&lt;br/&gt;
   &quot;&quot;&quot;Context manager class managing transitions for a given sampler state.&quot;&quot;&quot;&lt;br/&gt;
@@ -252,7 +180,7 @@ cdef class ScopedState(object):&lt;br/&gt;
   cdef readonly int32_t state_index&lt;br/&gt;
   cdef readonly object counter&lt;br/&gt;
   cdef readonly object name&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;cdef readonly int64_t nsecs&lt;br/&gt;
+  cdef readonly int64_t _nsecs&lt;br/&gt;
   cdef int32_t old_state_index&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   def _&lt;em&gt;init&lt;/em&gt;_(self, sampler, name, state_index, counter=None):&lt;br/&gt;
@@ -261,6 +189,16 @@ cdef class ScopedState(object):&lt;br/&gt;
     self.state_index = state_index&lt;br/&gt;
     self.counter = counter&lt;/p&gt;

&lt;p&gt;+  @property&lt;br/&gt;
+  def nsecs(self):&lt;br/&gt;
+    return self._nsecs&lt;br/&gt;
+&lt;br/&gt;
+  def sampled_seconds(self):&lt;br/&gt;
+    return 1e-9 * self.nsecs&lt;br/&gt;
+&lt;br/&gt;
+  def _&lt;em&gt;repr&lt;/em&gt;_(self):&lt;br/&gt;
+    return &quot;ScopedState&lt;span class=&quot;error&quot;&gt;&amp;#91;%s, %s&amp;#93;&lt;/span&gt;&quot; % (self.name, self.nsecs)&lt;br/&gt;
+&lt;br/&gt;
   cpdef _&lt;em&gt;enter&lt;/em&gt;_(self):&lt;br/&gt;
     self.old_state_index = self.sampler.current_state_index&lt;br/&gt;
     pythread.PyThread_acquire_lock(self.sampler.lock, pythread.WAIT_LOCK)&lt;br/&gt;
@@ -273,9 +211,3 @@ cdef class ScopedState(object):&lt;br/&gt;
     self.sampler.current_state_index = self.old_state_index&lt;br/&gt;
     pythread.PyThread_release_lock(self.sampler.lock)&lt;br/&gt;
     self.sampler.state_transition_count += 1&lt;br/&gt;
-&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;def _&lt;em&gt;repr&lt;/em&gt;_(self):&lt;/li&gt;
	&lt;li&gt;return &quot;ScopedState&lt;span class=&quot;error&quot;&gt;&amp;#91;%s, %s, %s&amp;#93;&lt;/span&gt;&quot; % (self.name, self.state_index, self.nsecs)&lt;br/&gt;
-&lt;/li&gt;
	&lt;li&gt;def sampled_seconds(self):&lt;/li&gt;
	&lt;li&gt;return 1e-9 * self.nsecs&lt;br/&gt;
diff --git a/sdks/python/apache_beam/runners/worker/statesampler_slow.py b/sdks/python/apache_beam/runners/worker/statesampler_slow.py&lt;br/&gt;
new file mode 100644&lt;br/&gt;
index 00000000000..dafe3b46887
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;/dev/null&lt;br/&gt;
+++ b/sdks/python/apache_beam/runners/worker/statesampler_slow.py&lt;br/&gt;
@@ -0,0 +1,76 @@&lt;br/&gt;
+#&lt;br/&gt;
+# Licensed to the Apache Software Foundation (ASF) under one or more&lt;br/&gt;
+# contributor license agreements.  See the NOTICE file distributed with&lt;br/&gt;
+# this work for additional information regarding copyright ownership.&lt;br/&gt;
+# The ASF licenses this file to You under the Apache License, Version 2.0&lt;br/&gt;
+# (the &quot;License&quot;); you may not use this file except in compliance with&lt;br/&gt;
+# the License.  You may obtain a copy of the License at&lt;br/&gt;
+#&lt;br/&gt;
+#    &lt;a href=&quot;http://www.apache.org/licenses/LICENSE-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.apache.org/licenses/LICENSE-2.0&lt;/a&gt;&lt;br/&gt;
+#&lt;br/&gt;
+# Unless required by applicable law or agreed to in writing, software&lt;br/&gt;
+# distributed under the License is distributed on an &quot;AS IS&quot; BASIS,&lt;br/&gt;
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.&lt;br/&gt;
+# See the License for the specific language governing permissions and&lt;br/&gt;
+# limitations under the License.&lt;br/&gt;
+#&lt;br/&gt;
+&lt;br/&gt;
+# This module is experimental. No backwards-compatibility guarantees.&lt;br/&gt;
+&lt;br/&gt;
+&lt;br/&gt;
+class StateSampler(object):&lt;br/&gt;
+&lt;br/&gt;
+  def _&lt;em&gt;init&lt;/em&gt;_(self, sampling_period_ms):&lt;br/&gt;
+    self._state_stack = &lt;span class=&quot;error&quot;&gt;&amp;#91;ScopedState(None, self, None)&amp;#93;&lt;/span&gt;&lt;br/&gt;
+    self.state_transition_count = 0&lt;br/&gt;
+    self.time_since_transition = 0&lt;br/&gt;
+    self.started = False&lt;br/&gt;
+    self.finished = False&lt;br/&gt;
+&lt;br/&gt;
+  def current_state(self):&lt;br/&gt;
+    &quot;&quot;&quot;Returns the current execution state.&quot;&quot;&quot;&lt;br/&gt;
+    return self._state_stack&lt;span class=&quot;error&quot;&gt;&amp;#91;-1&amp;#93;&lt;/span&gt;&lt;br/&gt;
+&lt;br/&gt;
+  def _scoped_state(self, counter_name, output_counter):&lt;br/&gt;
+    return ScopedState(self, counter_name, output_counter)&lt;br/&gt;
+&lt;br/&gt;
+  def _enter_state(self, state):&lt;br/&gt;
+    self.state_transition_count += 1&lt;br/&gt;
+    self._state_stack.append(state)&lt;br/&gt;
+&lt;br/&gt;
+  def _exit_state(self):&lt;br/&gt;
+    self.state_transition_count += 1&lt;br/&gt;
+    self._state_stack.pop()&lt;br/&gt;
+&lt;br/&gt;
+  def start(self):&lt;br/&gt;
+    # Sampling not yet supported. Only state tracking at the moment.&lt;br/&gt;
+    self.started = True&lt;br/&gt;
+&lt;br/&gt;
+  def stop(self):&lt;br/&gt;
+    self.finished = True&lt;br/&gt;
+&lt;br/&gt;
+  def get_info(self):&lt;br/&gt;
+    &quot;&quot;&quot;Returns StateSamplerInfo with transition statistics.&quot;&quot;&quot;&lt;br/&gt;
+    return StateSamplerInfo(&lt;br/&gt;
+        self.current_state().name, self.transition_count, 0)&lt;br/&gt;
+&lt;br/&gt;
+&lt;br/&gt;
+class ScopedState(object):&lt;br/&gt;
+&lt;br/&gt;
+  def _&lt;em&gt;init&lt;/em&gt;_(self, sampler, name, counter=None):&lt;br/&gt;
+    self.state_sampler = sampler&lt;br/&gt;
+    self.name = name&lt;br/&gt;
+    self.counter = counter&lt;br/&gt;
+    self.nsecs = 0&lt;br/&gt;
+&lt;br/&gt;
+  def sampled_seconds(self):&lt;br/&gt;
+    return 1e-9 * self.nsecs&lt;br/&gt;
+&lt;br/&gt;
+  def _&lt;em&gt;repr&lt;/em&gt;_(self):&lt;br/&gt;
+    return &quot;ScopedState&lt;span class=&quot;error&quot;&gt;&amp;#91;%s, %s&amp;#93;&lt;/span&gt;&quot; % (self.name, self.nsecs)&lt;br/&gt;
+&lt;br/&gt;
+  def _&lt;em&gt;enter&lt;/em&gt;_(self):&lt;br/&gt;
+    self.state_sampler._enter_state(self)&lt;br/&gt;
+&lt;br/&gt;
+  def _&lt;em&gt;exit&lt;/em&gt;_(self, exc_type, exc_value, traceback):&lt;br/&gt;
+    self.state_sampler._exit_state()&lt;br/&gt;
diff --git a/sdks/python/apache_beam/runners/worker/statesampler_test.py b/sdks/python/apache_beam/runners/worker/statesampler_test.py&lt;br/&gt;
index 2f2c8bea4f7..63dc6f899bf 100644&lt;/li&gt;
			&lt;li&gt;a/sdks/python/apache_beam/runners/worker/statesampler_test.py&lt;br/&gt;
+++ b/sdks/python/apache_beam/runners/worker/statesampler_test.py&lt;br/&gt;
@@ -22,22 +22,13 @@&lt;br/&gt;
 import time&lt;br/&gt;
 import unittest&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;-from nose.plugins.skip import SkipTest&lt;br/&gt;
-&lt;br/&gt;
+from apache_beam.runners.worker import statesampler&lt;br/&gt;
 from apache_beam.utils.counters import CounterFactory&lt;br/&gt;
+from apache_beam.utils.counters import CounterName&lt;/p&gt;


&lt;p&gt; class StateSamplerTest(unittest.TestCase):&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;def setUp(self):&lt;/li&gt;
	&lt;li&gt;try:&lt;/li&gt;
	&lt;li&gt;# pylint: disable=global-variable-not-assigned&lt;/li&gt;
	&lt;li&gt;global statesampler&lt;/li&gt;
	&lt;li&gt;from apache_beam.runners.worker import statesampler&lt;/li&gt;
	&lt;li&gt;except ImportError:&lt;/li&gt;
	&lt;li&gt;raise SkipTest(&apos;State sampler not compiled.&apos;)&lt;/li&gt;
	&lt;li&gt;super(StateSamplerTest, self).setUp()&lt;br/&gt;
-&lt;br/&gt;
   def test_basic_sampler(self):&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
	&lt;li&gt;Set up state sampler.&lt;br/&gt;
     counter_factory = CounterFactory()&lt;br/&gt;
@@ -46,21 +37,38 @@ def test_basic_sampler(self):&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;Run basic workload transitioning between 3 states.&lt;br/&gt;
     sampler.start()&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;with sampler.scoped_state(&apos;statea&apos;):&lt;br/&gt;
+    with sampler.scoped_state(&apos;step1&apos;, &apos;statea&apos;):&lt;br/&gt;
       time.sleep(0.1)&lt;/li&gt;
	&lt;li&gt;with sampler.scoped_state(&apos;stateb&apos;):&lt;br/&gt;
+      self.assertEqual(&lt;br/&gt;
+          sampler.current_state().name,&lt;br/&gt;
+          CounterName(&lt;br/&gt;
+              &apos;statea-msecs&apos;, step_name=&apos;step1&apos;, stage_name=&apos;basic&apos;))&lt;br/&gt;
+      with sampler.scoped_state(&apos;step1&apos;, &apos;stateb&apos;):&lt;br/&gt;
         time.sleep(0.2 / 2)&lt;/li&gt;
	&lt;li&gt;with sampler.scoped_state(&apos;statec&apos;):&lt;br/&gt;
+        self.assertEqual(&lt;br/&gt;
+            sampler.current_state().name,&lt;br/&gt;
+            CounterName(&lt;br/&gt;
+                &apos;stateb-msecs&apos;, step_name=&apos;step1&apos;, stage_name=&apos;basic&apos;))&lt;br/&gt;
+        with sampler.scoped_state(&apos;step1&apos;, &apos;statec&apos;):&lt;br/&gt;
           time.sleep(0.3)&lt;br/&gt;
+          self.assertEqual(&lt;br/&gt;
+              sampler.current_state().name,&lt;br/&gt;
+              CounterName(&lt;br/&gt;
+                  &apos;statec-msecs&apos;, step_name=&apos;step1&apos;, stage_name=&apos;basic&apos;))&lt;br/&gt;
         time.sleep(0.2 / 2)&lt;br/&gt;
+&lt;br/&gt;
     sampler.stop()&lt;br/&gt;
     sampler.commit_counters()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+    if not statesampler.FAST_SAMPLER:&lt;br/&gt;
+      # The slow sampler does not implement sampling, so we won&apos;t test it.&lt;br/&gt;
+      return&lt;br/&gt;
+&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Test that sampled state timings are close to their expected values.&lt;br/&gt;
     expected_counter_values = 
{
-        &apos;basic-statea-msecs&apos;: 100,
-        &apos;basic-stateb-msecs&apos;: 200,
-        &apos;basic-statec-msecs&apos;: 300,
+        CounterName(&apos;statea-msecs&apos;, step_name=&apos;step1&apos;, stage_name=&apos;basic&apos;): 100,
+        CounterName(&apos;stateb-msecs&apos;, step_name=&apos;step1&apos;, stage_name=&apos;basic&apos;): 200,
+        CounterName(&apos;statec-msecs&apos;, step_name=&apos;step1&apos;, stage_name=&apos;basic&apos;): 300,
     }
&lt;p&gt;     for counter in counter_factory.get_counters():&lt;br/&gt;
       self.assertIn(counter.name, expected_counter_values)&lt;br/&gt;
@@ -76,9 +84,9 @@ def test_sampler_transition_overhead(self):&lt;br/&gt;
                                         sampling_period_ms=10)&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;Run basic workload transitioning between 3 states.&lt;/li&gt;
&lt;/ol&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;state_a = sampler.scoped_state(&apos;statea&apos;)&lt;/li&gt;
	&lt;li&gt;state_b = sampler.scoped_state(&apos;stateb&apos;)&lt;/li&gt;
	&lt;li&gt;state_c = sampler.scoped_state(&apos;statec&apos;)&lt;br/&gt;
+    state_a = sampler.scoped_state(&apos;step1&apos;, &apos;statea&apos;)&lt;br/&gt;
+    state_b = sampler.scoped_state(&apos;step1&apos;, &apos;stateb&apos;)&lt;br/&gt;
+    state_c = sampler.scoped_state(&apos;step1&apos;, &apos;statec&apos;)&lt;br/&gt;
     start_time = time.time()&lt;br/&gt;
     sampler.start()&lt;br/&gt;
     for _ in range(100000):&lt;br/&gt;
diff --git a/sdks/python/apache_beam/utils/counters.py b/sdks/python/apache_beam/utils/counters.py&lt;br/&gt;
index e2e0a1a730b..95b2117cf38 100644
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/sdks/python/apache_beam/utils/counters.py&lt;br/&gt;
+++ b/sdks/python/apache_beam/utils/counters.py&lt;br/&gt;
@@ -66,9 +66,6 @@ def _&lt;em&gt;new&lt;/em&gt;_(cls, name, stage_name=None, step_name=None,&lt;br/&gt;
                                            system_name, namespace,&lt;br/&gt;
                                            origin, output_index, io_target)&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;def _&lt;em&gt;str&lt;/em&gt;_(self):&lt;/li&gt;
	&lt;li&gt;return &apos;%s&apos; % self._str_internal()&lt;br/&gt;
-&lt;br/&gt;
   def _&lt;em&gt;repr&lt;/em&gt;_(self):&lt;br/&gt;
     return &apos;&amp;lt;CounterName&amp;lt;%s&amp;gt; at %s&amp;gt;&apos; % (self._str_internal(), hex(id(self)))&lt;/li&gt;
&lt;/ul&gt;






&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16565694" author="pabloem" created="Wed, 1 Aug 2018 17:39:59 +0000"  >&lt;p&gt;This has been fixed. Only thing that&apos;s left is some cleanup in Dataflow and in Beam.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                            <subtask id="13152852">BEAM-4094</subtask>
                            <subtask id="13169938">BEAM-4728</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 15 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ifr3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>