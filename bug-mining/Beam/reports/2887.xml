<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:24:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-14187] NullPointerException or IllegalStateException at IsmReaderImpl in Dataflow</title>
                <link>https://issues.apache.org/jira/browse/BEAM-14187</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;h6&gt;&lt;a name=&quot;Problem&quot;&gt;&lt;/a&gt;Problem&lt;/h6&gt;

&lt;p&gt;Dataflow Java batch jobs with large side input intermittently throws &lt;tt&gt;NullPointerException&lt;/tt&gt; or &lt;tt&gt;IllegalStateException&lt;/tt&gt;.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://gist.githubusercontent.com/baeminbo/459e283eadbc7752c9f23616b52d958a/raw/f0480b8eaff590fb3f3ae2ab98ddce7dd3b4a237/npe.png&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;NullPointerException&lt;/a&gt; happens at &lt;a href=&quot;https://github.com/apache/beam/blob/v2.37.0/runners/google-cloud-dataflow-java/worker/src/main/java/org/apache/beam/runners/dataflow/worker/IsmReaderImpl.java#L217&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;IsmReaderImpl.overKeyComponents&lt;/a&gt;:&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://gist.githubusercontent.com/baeminbo/459e283eadbc7752c9f23616b52d958a/raw/f0480b8eaff590fb3f3ae2ab98ddce7dd3b4a237/IllegalStateException.png&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;IllegalStateException&lt;/a&gt; happens at &lt;a href=&quot;https://github.com/apache/beam/blob/v2.37.0/runners/google-cloud-dataflow-java/worker/src/main/java/org/apache/beam/runners/dataflow/worker/IsmReaderImpl.java#L500&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;IsmReaderImpl. initializeForKeyedRead &lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;(all error logs in the Dataflow job is &lt;a href=&quot;https://gist.githubusercontent.com/baeminbo/459e283eadbc7752c9f23616b52d958a/raw/f0480b8eaff590fb3f3ae2ab98ddce7dd3b4a237/downloaded-logs-20220327-171955.json&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.)&lt;/p&gt;

&lt;h6&gt;&lt;a name=&quot;Hypothesis&quot;&gt;&lt;/a&gt;Hypothesis&lt;/h6&gt;

&lt;p&gt;The &lt;tt&gt;initializeForKeyedRead&lt;/tt&gt; is not synchronized. Multiple threads can enter the method so that initialize the index for the same shard and update &lt;tt&gt;indexPerShard&lt;/tt&gt; without synchronization. And, the &lt;tt&gt;overKeyComponents&lt;/tt&gt; also accesses &lt;tt&gt;indexPerShard&lt;/tt&gt; without synchronization. As &lt;tt&gt;indexPerShard&lt;/tt&gt; is just a &lt;tt&gt;HashMap&lt;/tt&gt; which is not thread-safe, it can cause &lt;tt&gt;NullPointerException&lt;/tt&gt; and &lt;tt&gt;IllegalStateException&lt;/tt&gt; above.&lt;/p&gt;

&lt;h6&gt;&lt;a name=&quot;Suggestion&quot;&gt;&lt;/a&gt;Suggestion&lt;/h6&gt;

&lt;p&gt;I think it can fix this issue if we change the type of &lt;tt&gt;indexPerShard&lt;/tt&gt; to a thread-safe map (e.g. &lt;tt&gt;ConcurrentHashMap&lt;/tt&gt;).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13436167">BEAM-14187</key>
            <summary>NullPointerException or IllegalStateException at IsmReaderImpl in Dataflow</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="baeminbo">Minbo Bae</assignee>
                                    <reporter username="baeminbo">Minbo Bae</reporter>
                        <labels>
                    </labels>
                <created>Mon, 28 Mar 2022 13:06:34 +0000</created>
                <updated>Wed, 27 Apr 2022 02:35:14 +0000</updated>
                            <resolved>Wed, 27 Apr 2022 02:35:14 +0000</resolved>
                                                    <fixVersion>2.39.0</fixVersion>
                                    <component>runner-dataflow</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="11400">3h 10m</timespent>
                                <comments>
                            <comment id="17519078" author="lcwik" created="Thu, 7 Apr 2022 18:18:03 +0000"  >&lt;p&gt;Note that initializeBloomFilterAndIndexPerShard is synchronized which is the only method that mutates the indexPerShard variable. Since initializeBloomFilterAndIndexPerShard is invoked within overKeyComponents that means there is a memory barrier between the thread that created the indexPerShard and other threads ensuring that the object is safely published across threads.&lt;/p&gt;

&lt;p&gt;Also, the &lt;a href=&quot;https://docs.oracle.com/javase/8/docs/api/java/util/HashMap.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Javadoc for HashMap&lt;/a&gt; says that concurrent reads are ok, its concurrent modifications that require synchronization:&lt;br/&gt;
&quot;If multiple threads access a hash map concurrently, and at least one of the threads modifies the map structurally, it must be synchronized externally.&quot;&lt;/p&gt;</comment>
                            <comment id="17519886" author="baeminbo" created="Sat, 9 Apr 2022 06:58:17 +0000"  >&lt;p&gt;I replied to the Github PR comment at &lt;a href=&quot;https://github.com/apache/beam/pull/17201#discussion_r845915573.&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/17201#discussion_r845915573.&lt;/a&gt;&#160; The &lt;tt&gt;indexPerShard&lt;/tt&gt; is also modified at &lt;tt&gt;initializeForKeyedRead&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17528414" author="lcwik" created="Tue, 26 Apr 2022 21:12:09 +0000"  >&lt;p&gt;There is a consistent NullPointerException now occurring at &lt;a href=&quot;https://github.com/apache/beam/blob/8ecd51397550bff26f1a245dc4afd4ae6ea4c046/runners/google-cloud-dataflow-java/worker/src/main/java/org/apache/beam/runners/dataflow/worker/IsmReaderImpl.java#L554&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/blob/8ecd51397550bff26f1a245dc4afd4ae6ea4c046/runners/google-cloud-dataflow-java/worker/src/main/java/org/apache/beam/runners/dataflow/worker/IsmReaderImpl.java#L554&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Optional.of has to be changed to Optional.fromNullable&lt;/p&gt;</comment>
                            <comment id="17528415" author="lcwik" created="Tue, 26 Apr 2022 21:12:41 +0000"  >&lt;p&gt;This needs to be fixed for 2.39 release otherwise Dataflow bounded pipelines with side inputs will likely fail.&lt;/p&gt;</comment>
                            <comment id="17528490" author="lcwik" created="Wed, 27 Apr 2022 02:35:14 +0000"  >&lt;p&gt;Follow-up NPE was fixed by &lt;a href=&quot;https://github.com/apache/beam/pull/17454&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/17454&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 28 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z10vz4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>