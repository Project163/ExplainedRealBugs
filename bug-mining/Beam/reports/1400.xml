<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:02:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-6995] SQL aggregation with where clause fails to plan</title>
                <link>https://issues.apache.org/jira/browse/BEAM-6995</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;I&apos;m finding that this code fails with a CannotPlanException listed below.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Schema schema = Schema.builder()
    .addInt32Field(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;)
&#160; &#160; .addInt32Field(&lt;span class=&quot;code-quote&quot;&gt;&quot;val&quot;&lt;/span&gt;)
&#160; &#160; .build();

Row row = Row.withSchema(schema).addValues(1, 2).build();

PCollection&amp;lt;Row&amp;gt; inputData = p.apply(&lt;span class=&quot;code-quote&quot;&gt;&quot;row input&quot;&lt;/span&gt;, Create.of(row).withRowSchema(schema));

inputData.apply(&lt;span class=&quot;code-quote&quot;&gt;&quot;sql&quot;&lt;/span&gt;,
    SqlTransform.query(
        &lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT id, SUM(val) &quot;&lt;/span&gt;
        + &lt;span class=&quot;code-quote&quot;&gt;&quot;FROM PCOLLECTION &quot;&lt;/span&gt;
        + &lt;span class=&quot;code-quote&quot;&gt;&quot;WHERE val &amp;gt; 0 &quot;&lt;/span&gt;
        + &lt;span class=&quot;code-quote&quot;&gt;&quot;GROUP BY id&quot;&lt;/span&gt;));&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If the WHERE clause is removed the code runs successfully.&lt;/p&gt;

&lt;p&gt;This may be similar to&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-5384&quot; title=&quot;[SQL] Calcite optimizes away LogicalProject&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-5384&quot;&gt;&lt;del&gt;BEAM-5384&lt;/del&gt;&lt;/a&gt;&#160;since I was able to work around this by adding an extra column to the input that isn&apos;t reference in the sql.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Schema schema = Schema.builder()
    .addInt32Field(&lt;span class=&quot;code-quote&quot;&gt;&quot;id&quot;&lt;/span&gt;)
&#160; &#160; .addInt32Field(&lt;span class=&quot;code-quote&quot;&gt;&quot;val&quot;&lt;/span&gt;)
&#160; &#160; .addInt32Field(&lt;span class=&quot;code-quote&quot;&gt;&quot;extra&quot;&lt;/span&gt;)
&#160; &#160; .build();&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.beam.repackaged.beam_sdks_java_extensions_sql.org.apache.calcite.plan.RelOptPlanner$CannotPlanException: Node [rel#100:Subset#2.BEAM_LOGICAL] could not be implemented; planner state:

Root: rel#100:Subset#2.BEAM_LOGICAL
Original rel:
LogicalAggregate(subset=[rel#100:Subset#2.BEAM_LOGICAL], group=[{0}], EXPR$1=[SUM($1)]): rowcount = 5.0, cumulative cost = {5.687500238418579 rows, 0.0 cpu, 0.0 io}, id = 98
  LogicalFilter(subset=[rel#97:Subset#1.NONE], condition=[&amp;gt;($1, 0)]): rowcount = 50.0, cumulative cost = {50.0 rows, 100.0 cpu, 0.0 io}, id = 96
    BeamIOSourceRel(subset=[rel#95:Subset#0.BEAM_LOGICAL], table=[[beam, PCOLLECTION]]): rowcount = 100.0, cumulative cost = {100.0 rows, 101.0 cpu, 0.0 io}, id = 92

Sets:
Set#0, type: RecordType(INTEGER id, INTEGER val)
        rel#95:Subset#0.BEAM_LOGICAL, best=rel#92, importance=0.7290000000000001
                rel#92:BeamIOSourceRel.BEAM_LOGICAL(table=[beam, PCOLLECTION]), rowcount=100.0, cumulative cost={100.0 rows, 101.0 cpu, 0.0 io}
        rel#110:Subset#0.ENUMERABLE, best=rel#109, importance=0.36450000000000005
                rel#109:BeamEnumerableConverter.ENUMERABLE(input=rel#95:Subset#0.BEAM_LOGICAL), rowcount=100.0, cumulative cost={1.7976931348623157E308 rows, 1.7976931348623157E308 cpu, 1.7976931348623157E308 io}
Set#1, type: RecordType(INTEGER id, INTEGER val)
        rel#97:Subset#1.NONE, best=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, importance=0.81
                rel#96:LogicalFilter.NONE(input=rel#95:Subset#0.BEAM_LOGICAL,condition=&amp;gt;($1, 0)), rowcount=50.0, cumulative cost={inf}
                rel#102:LogicalCalc.NONE(input=rel#95:Subset#0.BEAM_LOGICAL,expr#0..1={inputs},expr#2=0,expr#3=&amp;gt;($t1, $t2),id=$t0,val=$t1,$condition=$t3), rowcount=50.0, cumulative cost={inf}
        rel#104:Subset#1.BEAM_LOGICAL, best=rel#103, importance=0.405
                rel#103:BeamCalcRel.BEAM_LOGICAL(input=rel#95:Subset#0.BEAM_LOGICAL,expr#0..1={inputs},expr#2=0,expr#3=&amp;gt;($t1, $t2),id=$t0,val=$t1,$condition=$t3), rowcount=50.0, cumulative cost={150.0 rows, 801.0 cpu, 0.0 io}
        rel#106:Subset#1.ENUMERABLE, best=rel#105, importance=0.405
                rel#105:BeamEnumerableConverter.ENUMERABLE(input=rel#104:Subset#1.BEAM_LOGICAL), rowcount=50.0, cumulative cost={1.7976931348623157E308 rows, 1.7976931348623157E308 cpu, 1.7976931348623157E308 io}
Set#2, type: RecordType(INTEGER id, INTEGER EXPR$1)
        rel#99:Subset#2.NONE, best=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, importance=0.9
                rel#98:LogicalAggregate.NONE(input=rel#97:Subset#1.NONE,group={0},EXPR$1=SUM($1)), rowcount=5.0, cumulative cost={inf}
        rel#100:Subset#2.BEAM_LOGICAL, best=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, importance=1.0
                rel#101:AbstractConverter.BEAM_LOGICAL(input=rel#99:Subset#2.NONE,convention=BEAM_LOGICAL), rowcount=5.0, cumulative cost={inf}


        at org.apache.beam.repackaged.beam_sdks_java_extensions_sql.org.apache.calcite.plan.volcano.RelSubset$CheapestPlanReplacer.visit(RelSubset.java:437)
        at org.apache.beam.repackaged.beam_sdks_java_extensions_sql.org.apache.calcite.plan.volcano.RelSubset.buildCheapestPlan(RelSubset.java:296)
        at org.apache.beam.repackaged.beam_sdks_java_extensions_sql.org.apache.calcite.plan.volcano.VolcanoPlanner.findBestExp(VolcanoPlanner.java:657)
        at org.apache.beam.repackaged.beam_sdks_java_extensions_sql.org.apache.calcite.tools.Programs$RuleSetProgram.run(Programs.java:339)
        at org.apache.beam.repackaged.beam_sdks_java_extensions_sql.org.apache.calcite.prepare.PlannerImpl.transform(PlannerImpl.java:349)
        at org.apache.beam.sdk.extensions.sql.impl.BeamQueryPlanner.convertToBeamRel(BeamQueryPlanner.java:138)
        at org.apache.beam.sdk.extensions.sql.impl.BeamSqlEnv.parseQuery(BeamSqlEnv.java:143)
        at org.apache.beam.sdk.extensions.sql.SqlTransform.expand(SqlTransform.java:111)
        at org.apache.beam.sdk.extensions.sql.SqlTransform.expand(SqlTransform.java:79)
        at org.apache.beam.sdk.Pipeline.applyInternal(Pipeline.java:537)
        at org.apache.beam.sdk.Pipeline.applyTransform(Pipeline.java:488)
        at org.apache.beam.sdk.values.PCollection.apply(PCollection.java:370)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13225855">BEAM-6995</key>
            <summary>SQL aggregation with where clause fails to plan</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10103" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">P3</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kirillkozlov">Kirill Kozlov</assignee>
                                    <reporter username="dmcintosh">David McIntosh</reporter>
                        <labels>
                    </labels>
                <created>Wed, 3 Apr 2019 16:47:37 +0000</created>
                <updated>Sat, 16 May 2020 13:25:29 +0000</updated>
                            <resolved>Tue, 8 Oct 2019 16:15:13 +0000</resolved>
                                    <version>2.11.0</version>
                                    <fixVersion>2.17.0</fixVersion>
                                    <component>dsl-sql</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="17400">4h 50m</timespent>
                                <comments>
                            <comment id="16947028" author="kirillkozlov" created="Tue, 8 Oct 2019 16:15:13 +0000"  >&lt;p&gt;Fixed in&#160;&lt;a href=&quot;https://github.com/apache/beam/pull/9703&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/9703&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13259135">BEAM-8317</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 5 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z01f5k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>