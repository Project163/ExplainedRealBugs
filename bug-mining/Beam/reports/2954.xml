<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:25:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-14481] ScopedState can not be re-entered (regression caused by Batched DoFn worker changes)</title>
                <link>https://issues.apache.org/jira/browse/BEAM-14481</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;We&apos;ve observed some regressions in internal pipelines. We&apos;ve narrowed the root cause down to &lt;a href=&quot;https://github.com/apache/beam/pull/17384&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/17384&lt;/a&gt; - the worker changes for Batched DoFns.&lt;/p&gt;

&lt;p&gt;I still don&apos;t understand the root cause, but given this change can lead to a regression in pipelines that don&apos;t use the feature I think we should roll it back.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13445498">BEAM-14481</key>
            <summary>ScopedState can not be re-entered (regression caused by Batched DoFn worker changes)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="1" iconUrl="https://issues.apache.org/jira/images/icons/statuses/open.png" description="The issue is open and ready for the assignee to start work on it.">Open</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="-1">Unresolved</resolution>
                                        <assignee username="bhulette">Brian Hulette</assignee>
                                    <reporter username="bhulette">Brian Hulette</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 May 2022 19:49:56 +0000</created>
                <updated>Sun, 5 Jun 2022 01:10:55 +0000</updated>
                                                                            <component>sdk-py-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="14400">4h</timespent>
                                <comments>
                            <comment id="17541229" author="bhulette" created="Tue, 24 May 2022 01:29:09 +0000"  >&lt;p&gt;It turns out the issue in internal pipelines was not an OOM, there was already memory pressure in this pipeline. The issue appears to be a bug in a minor changed to the worker code that affected metric reporting.&lt;/p&gt;</comment>
                            <comment id="17542273" author="bhulette" created="Wed, 25 May 2022 23:17:42 +0000"  >&lt;p&gt;I managed to identify the root cause here. Re-entering the &quot;fast&quot; implementation of a ScopedState (this is what I did by nesting &lt;tt&gt;with self.scoped_start_state:&lt;/tt&gt; blocks) puts it into a bad state.&lt;/p&gt;

&lt;p&gt;The &quot;slow&quot; ScopedState maintains a stack of previous states, so it actually shouldn&apos;t repro this issue. But the &quot;fast&quot; ScopedState only tracks a single previous state index, so when you re-enter the previous state is overwritten. My proposed fix: add an assertion to prevent re-entering the same ScopedState instance (for both fast and slow), if we had this before we would have caught the issue in unit tests.&lt;/p&gt;

&lt;p&gt;I was able to repro the issue by adding a test like this to statesampler_test:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-python&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; test_reenter_scoped_state(&lt;span class=&quot;code-keyword&quot;&gt;self&lt;/span&gt;):                                         
    &lt;span class=&quot;code-comment&quot;&gt;# Set up state sampler.                                                     
&lt;/span&gt;    counter_factory = CounterFactory()                                          
    sampler = statesampler.StateSampler(                                        
       &lt;span class=&quot;code-quote&quot;&gt;&apos;basic&apos;&lt;/span&gt;, counter_factory, sampling_period_ms=1)                         
                                                                                
    statea = sampler.scoped_state(&lt;span class=&quot;code-quote&quot;&gt;&apos;step1&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;statea&apos;&lt;/span&gt;):                           
    stateb = sampler.scoped_state(&lt;span class=&quot;code-quote&quot;&gt;&apos;step1&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;stateb&apos;&lt;/span&gt;):                           
                                                                                                  
    sampler.start()                                                             
    &lt;span class=&quot;code-keyword&quot;&gt;with&lt;/span&gt; statea:                                                                
      &lt;span class=&quot;code-keyword&quot;&gt;self&lt;/span&gt;.assertEqual(                                                         
         sampler.current_state().name,                                         
         CounterName(&lt;span class=&quot;code-quote&quot;&gt;&apos;statea-msecs&apos;&lt;/span&gt;, step_name=&lt;span class=&quot;code-quote&quot;&gt;&apos;step1&apos;&lt;/span&gt;, stage_name=&lt;span class=&quot;code-quote&quot;&gt;&apos;basic&apos;&lt;/span&gt;))   
      &lt;span class=&quot;code-keyword&quot;&gt;with&lt;/span&gt; stateb:                                                              
        &lt;span class=&quot;code-keyword&quot;&gt;self&lt;/span&gt;.assertEqual(                                                       
            sampler.current_state().name,                                       
            CounterName(&lt;span class=&quot;code-quote&quot;&gt;&apos;stateb-msecs&apos;&lt;/span&gt;, step_name=&lt;span class=&quot;code-quote&quot;&gt;&apos;step1&apos;&lt;/span&gt;, stage_name=&lt;span class=&quot;code-quote&quot;&gt;&apos;basic&apos;&lt;/span&gt;)) 
        &lt;span class=&quot;code-keyword&quot;&gt;with&lt;/span&gt; stateb:                                                            
          &lt;span class=&quot;code-keyword&quot;&gt;self&lt;/span&gt;.assertEqual(                                                     
              sampler.current_state().name,                                     
              CounterName(&lt;span class=&quot;code-quote&quot;&gt;&apos;stateb-msecs&apos;&lt;/span&gt;, step_name=&lt;span class=&quot;code-quote&quot;&gt;&apos;step1&apos;&lt;/span&gt;, stage_name=&lt;span class=&quot;code-quote&quot;&gt;&apos;basic&apos;&lt;/span&gt;))
        &lt;span class=&quot;code-keyword&quot;&gt;self&lt;/span&gt;.assertEqual(                                                       
            sampler.current_state().name,                                       
            CounterName(&lt;span class=&quot;code-quote&quot;&gt;&apos;stateb-msecs&apos;&lt;/span&gt;, step_name=&lt;span class=&quot;code-quote&quot;&gt;&apos;step1&apos;&lt;/span&gt;, stage_name=&lt;span class=&quot;code-quote&quot;&gt;&apos;basic&apos;&lt;/span&gt;))
      &lt;span class=&quot;code-comment&quot;&gt;# !!!! This assertion fails !!!                                                                                                                                                   
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;self&lt;/span&gt;.assertEqual(                                                         
          sampler.current_state().name,                                         
          CounterName(&lt;span class=&quot;code-quote&quot;&gt;&apos;statea-msecs&apos;&lt;/span&gt;, step_name=&lt;span class=&quot;code-quote&quot;&gt;&apos;step1&apos;&lt;/span&gt;, stage_name=&lt;span class=&quot;code-quote&quot;&gt;&apos;basic&apos;&lt;/span&gt;))   
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It turns out there are actually several other places where we&apos;re re-entering a ScopedState instance. I suspect the one I added just caused a breakage because it was happening in &lt;tt&gt;DataInputOperation&lt;/tt&gt;, but it seems likely that the other places are leading to corrupted metrics.&lt;/p&gt;</comment>
                            <comment id="17550101" author="JIRAUSER282469" created="Sun, 5 Jun 2022 01:10:55 +0000"  >&lt;p&gt;This issue has been migrated to &lt;a href=&quot;https://github.com/apache/beam/issues/21663&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/issues/21663&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 23 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z12geg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>