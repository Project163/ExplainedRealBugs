<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:07:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-9439] KinesisReader does not report correct backlog statistics </title>
                <link>https://issues.apache.org/jira/browse/BEAM-9439</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;The KinesisReader implementing KinesisIO reports backlog by implementing the&lt;br/&gt;
UnboundedSource.getTotalBacklogBytes()&lt;br/&gt;
method as opposed to the&lt;br/&gt;
UnboundedSource.getSplitBacklogBytes()&lt;/p&gt;

&lt;p&gt;This value is supposed to represent the total backlog across all shards.  This function is implemented by calling SimplifiedKinesisClient.getBacklogBytes with the watermark of the kinesis shards managed within the UnboundedReader instance.  As this watermark may be further ahead than the watermark across all shards, this may miss backlog bytes.&lt;/p&gt;

&lt;p&gt;An additional concern is that the watermark is calculated using a WatermarkPolicy, which means that the watermark may be inconsistent to the kinesis timestamp for querying backlog.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13289595">BEAM-9439</key>
            <summary>KinesisReader does not report correct backlog statistics </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="titmus">Sebastian Graca</assignee>
                                    <reporter username="scwhittle">Sam Whittle</reporter>
                        <labels>
                    </labels>
                <created>Wed, 4 Mar 2020 18:11:06 +0000</created>
                <updated>Sat, 16 May 2020 14:09:20 +0000</updated>
                            <resolved>Mon, 11 May 2020 11:48:59 +0000</resolved>
                                                    <fixVersion>2.22.0</fixVersion>
                                    <component>io-java-kinesis</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="6000">1h 40m</timespent>
                                <comments>
                            <comment id="17063349" author="m.juraszek" created="Fri, 20 Mar 2020 13:12:34 +0000"  >&lt;p&gt;The symptoms we currently face in our dataflow pipeline proves the bug is causing major problem - the pipeline can&apos;t be correctly scaled due to incorrect backlog returned by the kinesis reader. This leads to delay in data processing.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Scenario: when reading from stream having multiple shards (24), we have faced the issue when the kinesis reader reported 0 bytes, whereas the watermark on the source suggested that there is increasing delay in data processing. After checking the data, it occurred that data from 16 shards was up to date, but 8 shards were delayed. This lead in increasing delay in processing of data from these 8 shard - pipeline wasn&apos;t scaled to enable handle it.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Shouldn&apos;t the current implementation of getTotalBacklogBytes() be implementation of&#160;getSplitBacklogBytes()?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aromanenko&quot; class=&quot;user-hover&quot; rel=&quot;aromanenko&quot;&gt;aromanenko&lt;/a&gt; - could you please look into it?&lt;/p&gt;</comment>
                            <comment id="17068938" author="aromanenko" created="Fri, 27 Mar 2020 17:44:59 +0000"  >&lt;p&gt;Thank you for reporting this.&#160; Do you have any fix for that or an idea how &lt;tt&gt;getSplitBacklogBytes()&lt;/tt&gt; could be implemented?&lt;/p&gt;

&lt;p&gt;Also, I&apos;d ask &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pawel.kaczmarczyk&quot; class=&quot;user-hover&quot; rel=&quot;pawel.kaczmarczyk&quot;&gt;pawel.kaczmarczyk&lt;/a&gt;, who initially worked on &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-2455&quot; title=&quot;Backlog size retrieval for Kinesis source&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-2455&quot;&gt;&lt;del&gt;BEAM-2455&lt;/del&gt;&lt;/a&gt;, why &lt;tt&gt;getTotalBacklogBytes()&lt;/tt&gt; was used in this case?&lt;/p&gt;</comment>
                            <comment id="17070826" author="pawel.kaczmarczyk" created="Mon, 30 Mar 2020 09:20:17 +0000"  >&lt;p&gt;I don&apos;t remember why it was implemented this way. As I understand, to fix &lt;tt&gt;getTotalBacklogBytes&lt;/tt&gt;() we would need the watermark of the whole stream, not just current split, right?&lt;/p&gt;

&lt;p&gt;On the other hand, &lt;tt&gt;getSplitBacklogBytes&lt;/tt&gt;() can be implemented using the&#160;&lt;a href=&quot;#kinesis-metrics-shard]&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Enhanced Shard-level Metrics&lt;/a&gt; but these are not enabled by default and charged additionally. So even with this implementation, we would still need a proper&#160;&lt;tt&gt;getTotalBacklogBytes&lt;/tt&gt;().&lt;/p&gt;

&lt;p&gt;What do you think?&lt;/p&gt;</comment>
                            <comment id="17070983" author="titmus" created="Mon, 30 Mar 2020 13:51:15 +0000"  >&lt;p&gt;We&apos;re currently testing a fix for the issue and we&apos;ll submit a patch when we&apos;re confident that it works well in our production systems. It&apos;s just removing &lt;tt&gt;getTotalBacklogBytes&lt;/tt&gt; and using current implementation as &lt;tt&gt;getSplitBacklogBytes&lt;/tt&gt; as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=m.juraszek&quot; class=&quot;user-hover&quot; rel=&quot;m.juraszek&quot;&gt;m.juraszek&lt;/a&gt; suggested.&lt;br/&gt;
This might lead to reporting the backlog for the split that is larger than the real one but will never report smaller backlog that would otherwise not trigger autoscaling of Dataflow job.&lt;/p&gt;</comment>
                            <comment id="17071120" author="aromanenko" created="Mon, 30 Mar 2020 16:34:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=titmus&quot; class=&quot;user-hover&quot; rel=&quot;titmus&quot;&gt;titmus&lt;/a&gt; Thank for testing this.&lt;br/&gt;
I&apos;m not a Dataflow expert but its &lt;a href=&quot;https://cloud.google.com/dataflow/docs/guides/deploying-a-pipeline#autoscaling&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;autoscaling documentation&lt;/a&gt; recommends to use total backlog bytes only in case of implementing &lt;tt&gt;getTotalBacklogBytes()&lt;/tt&gt; and I&apos;m not sure that it will work properly if every shard reader will return the total bytes (if I got it right your current fix).&lt;/p&gt;

&lt;p&gt;For example, KafkaIO implements &lt;tt&gt;getSplitBacklogBytes()&lt;/tt&gt; by summing up all backlog byte sizes for every shard assigned to the reader.  It does it approximately by taking average number of records read between two offsets and multiplied by average record size.&lt;/p&gt;</comment>
                            <comment id="17071128" author="aromanenko" created="Mon, 30 Mar 2020 16:40:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pawel.kaczmarczyk&quot; class=&quot;user-hover&quot; rel=&quot;pawel.kaczmarczyk&quot;&gt;pawel.kaczmarczyk&lt;/a&gt; I think now I see why &lt;tt&gt;getTotalBacklogBytes()&lt;/tt&gt; was implemented, thanks.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;As I understand, to fix getTotalBacklogBytes() we would need the watermark of the whole stream, not just current split, right?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think so if we can&apos;t get the number of bytes per shard and implement &lt;tt&gt;getSplitBacklogBytes(&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;In the same time, I doubt that implementation based on Enhanced Shard-level Metrics should be default since, as you mentioned, it will charge additionally. Perhaps, it could be an alternative solution for those who wants to use it.&lt;/p&gt;</comment>
                            <comment id="17071204" author="titmus" created="Mon, 30 Mar 2020 18:47:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aromanenko&quot; class=&quot;user-hover&quot; rel=&quot;aromanenko&quot;&gt;aromanenko&lt;/a&gt;The problem with current implementation is that it does not return total backlog bytes because each reader tracks only its own shards and does not know the progress of other readers&apos; shards. Therefore it can happen that it can report much smaller backlog (even 0) while the actual backlog can be hundreds of MB (that&apos;s what happened in our case). So it&apos;s actually more like &lt;tt&gt;getSplitBacklogBytes()&lt;/tt&gt; instead of &lt;tt&gt;getTotalBacklogBytes()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The only correct solution would be to use shard-level metrics as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pawel.kaczmarczyk&quot; class=&quot;user-hover&quot; rel=&quot;pawel.kaczmarczyk&quot;&gt;pawel.kaczmarczyk&lt;/a&gt; suggested but it adds extra cost and also needs to be enabled for each stream, which requires extra action to be performed in order to use that feature. For that reason such feature should be an opt-in and there should be a way to use KinesisIO without enabling it.&lt;/p&gt;

&lt;p&gt;I can see two ways of improving backlog handling without resorting to use of shard-level metrics:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;correctly implementing &lt;tt&gt;getTotalBacklogBytes()&lt;/tt&gt; - this is hard as it needs a way to know the stream watermark across all shards - the readers would need a way to share that information&lt;/li&gt;
	&lt;li&gt;implementing &lt;tt&gt;getSplitBacklogBytes()&lt;/tt&gt; instead of &lt;tt&gt;getTotalBacklogBytes()&lt;/tt&gt; - our implementation reuses the current implementation of &lt;tt&gt;getTotalBacklogBytes()&lt;/tt&gt;. Yes, it can happen that if a reader have shards that are progressing slowly and are behind other shards the reported backlog will be bigger than it should but on the other hand if some shards are progressing quickly, only that reader will report small backlog. This can potentially be improved but so far we see that in case of Dataflow autoscaling algorithm the exact value of backlog is not that important. Much more important is how it changes over time and if it goes up or down or stays at the same level.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If you can think of anything else, please let me know.&lt;/p&gt;

&lt;p&gt;So far we have had no issues with our fix and the pipelines have been running smoothly and scaling, both, up and down.&lt;/p&gt;</comment>
                            <comment id="17071688" author="aromanenko" created="Tue, 31 Mar 2020 11:13:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=titmus&quot; class=&quot;user-hover&quot; rel=&quot;titmus&quot;&gt;titmus&lt;/a&gt;&#160;Thanks, sounds good to me as a trade-off solution. Perhaps we can have an &lt;ins&gt;optional&lt;/ins&gt; &lt;tt&gt;getSplitBacklogBytes()&lt;/tt&gt; implementation based on Enhanced Shard-level Metrics, as Pawel suggested, but I think it will a different Jira for that.&lt;br/&gt;
I&apos;ll assign this Jira to you if you mind, feel free to reassign it to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=m.juraszek&quot; class=&quot;user-hover&quot; rel=&quot;m.juraszek&quot;&gt;m.juraszek&lt;/a&gt;. And I&apos;ll be happy to review a PR once it will be ready.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 32 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0c614:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>