<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:52:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-4858] Clean up _BatchSizeEstimator in element-batching transform.</title>
                <link>https://issues.apache.org/jira/browse/BEAM-4858</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;Beam Python 3 conversion &lt;a href=&quot;https://github.com/apache/beam/pull/5729&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;exposed&lt;/a&gt; non-trivial performance-sensitive logic in element-batching transform. Let&apos;s take a look at &lt;a href=&quot;https://github.com/apache/beam/blob/e98ff7c96afa2f72b3a98426dc1e9a47224da5c8/sdks/python/apache_beam/transforms/util.py#L271&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;util.py#L271&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;Due to Python 2 language semantics, the result of &lt;tt&gt;x2 / x1&lt;/tt&gt; will depend on the type of the keys - whether they are integers or floats. &lt;/p&gt;

&lt;p&gt;The keys of key-value pairs contained in &lt;tt&gt;self._data&lt;/tt&gt; are added as integers &lt;a href=&quot;https://github.com/apache/beam/blob/d2ac08da2dccce8930432fae1ec7c30953880b69/sdks/python/apache_beam/transforms/util.py#L260&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, however, when we &apos;thin&apos; the collected entries &lt;a href=&quot;https://github.com/apache/beam/blob/d2ac08da2dccce8930432fae1ec7c30953880b69/sdks/python/apache_beam/transforms/util.py#L279&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, the keys will become floats. Surprisingly, using either integer or float division consistently &lt;a href=&quot;https://github.com/apache/beam/blob/e98ff7c96afa2f72b3a98426dc1e9a47224da5c8/sdks/python/apache_beam/transforms/util.py#L271&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;in the comparator&lt;/a&gt;  negatively affects the performance of a custom pipeline I was using to benchmark these changes. The performance impact likely comes from changes in the logic that depends on  how division is evaluated, not from the performance of division operation itself.&lt;/p&gt;

&lt;p&gt;In terms of Python 3 conversion the best course of action that avoids regression seems to be to preserve the existing Python 2 behavior using &lt;tt&gt;old_div&lt;/tt&gt; from &lt;tt&gt;past.utils.division&lt;/tt&gt;, in the medium term we should clean up the logic. We may want to add a targeted microbenchmark to evaluate performance of this code, and maybe cythonize the code, since it seems to be performance-sensitive.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13174230">BEAM-4858</key>
            <summary>Clean up _BatchSizeEstimator in element-batching transform.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10103" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">P3</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="robertwb">Robert Bradshaw</assignee>
                                    <reporter username="tvalentyn">Valentyn Tymofieiev</reporter>
                        <labels>
                    </labels>
                <created>Tue, 24 Jul 2018 22:53:43 +0000</created>
                <updated>Sat, 16 May 2020 13:24:27 +0000</updated>
                            <resolved>Wed, 10 Oct 2018 13:52:16 +0000</resolved>
                                                    <fixVersion>2.8.0</fixVersion>
                                    <component>sdk-py-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="22800">6h 20m</timespent>
                                <comments>
                            <comment id="16611858" author="robertwb" created="Wed, 12 Sep 2018 09:55:04 +0000"  >&lt;p&gt;I created&#160;&lt;a href=&quot;https://github.com/apache/beam/pull/6375&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/6375&lt;/a&gt;&#160;which cleans this up. Floating point division is always the correct thing to do here; I&apos;d like to understand under what circumstances this would be made worse. (Note that for a real pipeline, the actual timings can be noisy.)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Note that the code in question should not be (that) performance sensitive (with the exception of adding to the batch and checking the batch size), as&#160;the complicated logic is called once per batch (which should be reasonably expensive, and is taken into account).&lt;/p&gt;</comment>
                            <comment id="16644983" author="robertwb" created="Wed, 10 Oct 2018 13:52:05 +0000"  >&lt;p&gt;Submitted pr/6375.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Simplifies the aging out of old data. Not only was the old formula hard to&lt;br/&gt;
understand, but it meant that bad data could stick around and poison the&lt;br/&gt;
estimates forever.&lt;/li&gt;
	&lt;li&gt;Adds a variance parameter allowing the batch size to vary over a fixed&lt;br/&gt;
range giving a broader base for the linear regression.&lt;/li&gt;
	&lt;li&gt;Uses numpy when available to do the regression. This is both much more&lt;br/&gt;
efficient and allows for less error-prone expression of more complicated&lt;br/&gt;
analysis.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The algorithm was also changed to:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Eliminates outliers, both using Cook&apos;s distance and just throwing out the&lt;br/&gt;
top (often high-variance and high-influence) 20% when there is sufficient&lt;br/&gt;
data.&lt;/li&gt;
	&lt;li&gt;Weight by the inverse of batch size, to provide a more stable fixed size&lt;br/&gt;
estimate (which the default &quot;overhead&quot; target is sensitive to).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;These changes were tested against a large TFT pipeline and found to produce&lt;br/&gt;
more uniform batch sizes and similar, possibly slightly improved, total&lt;br/&gt;
runtimes and total costs.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 5 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3w8w7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>