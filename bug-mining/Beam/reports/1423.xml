<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:03:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-7520] DirectRunner timers are not strictly time ordered</title>
                <link>https://issues.apache.org/jira/browse/BEAM-7520</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;Let&apos;s suppose we have the following situation:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;statful ParDo with two timers - timerA and timerB&lt;/li&gt;
	&lt;li&gt;timerA is set for window.maxTimestamp() + 1&lt;/li&gt;
	&lt;li&gt;timerB is set anywhere between &amp;lt;windowStart, windowEnd), let&apos;s denote that timerB.timestamp&lt;/li&gt;
	&lt;li&gt;input watermark moves to BoundedWindow.TIMESTAMP_MAX_VALUE&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Then the order of timers is as follows (correct):&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;timerB&lt;/li&gt;
	&lt;li&gt;timerA&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;But, if timerB sets another timer (say for timerB.timestamp + 1), then the order of timers will be:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;timerB (timerB.timestamp)&lt;/li&gt;
	&lt;li&gt;timerA (BoundedWindow.TIMESTAMP_MAX_VALUE)&lt;/li&gt;
	&lt;li&gt;timerB (timerB.timestamp + 1)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Which is not ordered by timestamp. The reason for this is that when the input watermark update is evaluated, the WatermarkManager,extractFiredTimers() will produce both timerA and timerB. That would be correct, but when timerB sets another timer, that breaks this.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13238512">BEAM-7520</key>
            <summary>DirectRunner timers are not strictly time ordered</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="janl">Jan Lukavsk&#253;</assignee>
                                    <reporter username="janl">Jan Lukavsk&#253;</reporter>
                        <labels>
                    </labels>
                <created>Mon, 10 Jun 2019 12:02:52 +0000</created>
                <updated>Wed, 27 May 2020 04:10:52 +0000</updated>
                            <resolved>Wed, 23 Oct 2019 09:49:05 +0000</resolved>
                                    <version>2.13.0</version>
                                    <fixVersion>2.17.0</fixVersion>
                                    <component>runner-direct</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="76200">21h 10m</timespent>
                                <comments>
                            <comment id="16859960" author="je-ik" created="Mon, 10 Jun 2019 12:09:11 +0000"  >&lt;p&gt;I have experimented with this a little and have not yet figured out what the correct solution should be. What I tried:&lt;br/&gt;
 1) hold input watermark for min(setup timers)&lt;br/&gt;
 2) fire timers based not on input watermark, but on output watermark (output watermark is held by min timer stamp)&lt;br/&gt;
The code seems to be a little complicated there, so I was not able to get that working for 100%, more over maybe neither option (1, 2) seems to be completely correct.&lt;br/&gt;
What would seem to be correct to me is introduce another watermark (operator watermark), with the following properties:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;at all times input watermark &amp;gt;= operator watermark &amp;gt;= output watermark holds,&lt;/li&gt;
	&lt;li&gt;when input watermark advances from T1 to T2, operator watermark moves from T1 to T2 in order of timers that are set for this time interval&lt;/li&gt;
	&lt;li&gt;timers are fired based on operator watermark&lt;br/&gt;
This solution seems to be working, but looks a little complicated. Is there a simpler solution?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16860942" author="je-ik" created="Tue, 11 Jun 2019 11:20:25 +0000"  >&lt;p&gt;PR: &lt;a href=&quot;https://github.com/apache/beam/pull/8815&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/8815&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16860945" author="je-ik" created="Tue, 11 Jun 2019 11:22:19 +0000"  >&lt;p&gt;The fix is in that timers are fired for single Instant at a time. That way we can ensure monotonicity.&lt;/p&gt;</comment>
                            <comment id="16865594" author="je-ik" created="Mon, 17 Jun 2019 13:28:46 +0000"  >&lt;p&gt;PR rebased, fixed tests for validatesRunner, all tests pass locally.&lt;/p&gt;</comment>
                            <comment id="16873347" author="je-ik" created="Wed, 26 Jun 2019 13:52:35 +0000"  >&lt;p&gt;Alternative solution discussed in: &lt;a href=&quot;https://lists.apache.org/thread.html/6d843efbc18b226570660b83e96c36c4d38a2c63940a87d1abfaf2f7@%3Cdev.beam.apache.org%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lists.apache.org/thread.html/6d843efbc18b226570660b83e96c36c4d38a2c63940a87d1abfaf2f7@%3Cdev.beam.apache.org%3E&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16907424" author="kenn" created="Wed, 14 Aug 2019 16:40:53 +0000"  >&lt;p&gt;Nice catch. A priority queue of timers should already work, but the bug is probably that timers are not added to the queue until a bundle is committed, right?&lt;/p&gt;</comment>
                            <comment id="16907497" author="je-ik" created="Wed, 14 Aug 2019 17:56:17 +0000"  >&lt;p&gt;Actually, the issue is that DirectRunner does the following (asynchronously):&lt;br/&gt;
&#160;* update input watermark&lt;br/&gt;
&#160;* extract timers that should be fired and create an (immutable) bundle from them&lt;br/&gt;
&#160;* pass this bundle for processing, the processing can result in more timers being set&lt;br/&gt;
With this model, when watermark moves, a timer can be fired, although some other timer (extracted to the same bundle) might setup timer for lower timestamp.&lt;/p&gt;</comment>
                            <comment id="16907502" author="kenn" created="Wed, 14 Aug 2019 18:00:38 +0000"  >&lt;p&gt;... and that new timer will be committed as part of the result first, but will be fired right away in the next bundle. This is incorrect because of the example you showed.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                                                <inwardlinks description="is cloned by">
                                        <issuelink>
            <issuekey id="13265803">BEAM-8543</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13263969">BEAM-8460</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 13 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z03kqg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>