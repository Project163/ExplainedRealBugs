<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:05:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-9085] Performance regression in np.random.RandomState() skews performance test results across Python 2/3 on Dataflow</title>
                <link>https://issues.apache.org/jira/browse/BEAM-9085</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;Tests show that the performance of core Beam operations in Python 3.x on Dataflow can be a few time slower than in Python 2.7. We should investigate what&apos;s the cause of the problem.&lt;/p&gt;

&lt;p&gt;Currently, we have one ParDo test that is run both in Py3 and Py2 &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;. A dashboard with runtime results can be found here &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; sdks/python/apache_beam/testing/load_tests/pardo_test.py&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://apache-beam-testing.appspot.com/explore?dashboard=5678187241537536&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://apache-beam-testing.appspot.com/explore?dashboard=5678187241537536&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13278704">BEAM-9085</key>
            <summary>Performance regression in np.random.RandomState() skews performance test results across Python 2/3 on Dataflow</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kamilwu">Kamil Wasilewski</assignee>
                                    <reporter username="kamilwu">Kamil Wasilewski</reporter>
                        <labels>
                    </labels>
                <created>Fri, 10 Jan 2020 12:15:55 +0000</created>
                <updated>Fri, 24 Jul 2020 19:52:56 +0000</updated>
                            <resolved>Wed, 15 Apr 2020 21:16:50 +0000</resolved>
                                                    <fixVersion>Not applicable</fixVersion>
                                    <component>testing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="33600">9h 20m</timespent>
                                <comments>
                            <comment id="17027900" author="tvalentyn" created="Sat, 1 Feb 2020 00:09:35 +0000"  >&lt;p&gt;It appears that the increase in time is likely caused by either generating the synthetic input, or reading the synthetic input.&lt;/p&gt;

&lt;p&gt;The problem can be reproduced on Direct runner as well, I don&apos;t think it&apos;s Dataflow-specific.&lt;/p&gt;

&lt;p&gt;Following command shows 14 (Py2) vs 40 (Py3) seconds difference on my machine.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;python setup.py nosetests \
    --test-pipeline-options=&quot;
    --iterations=10
    --number_of_counters=1
    --number_of_counter_operations=1
    --project=big-query-project
    --publish_to_big_query=false
    --metrics_dataset=python_load_tests
    --metrics_table=pardo
    --input_options=&apos;{
    \&quot;num_records\&quot;: 200000,
    \&quot;key_size\&quot;: 10,
    \&quot;value_size\&quot;:90,
    \&quot;bundle_size_distribution_type\&quot;: \&quot;const\&quot;,
    \&quot;bundle_size_distribution_param\&quot;: 1,
    \&quot;force_initial_num_bundles\&quot;: 0
    }&apos;&quot; \
    --tests apache_beam.testing.load_tests.pardo_test
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17028916" author="kamilwu" created="Mon, 3 Feb 2020 13:03:27 +0000"  >&lt;p&gt;Thanks. I guess now we should do some profiling on `SyntheticSource` and find bottlenecks.&lt;/p&gt;</comment>
                            <comment id="17029183" author="tvalentyn" created="Mon, 3 Feb 2020 18:49:06 +0000"  >&lt;p&gt;I did some profiling on direct runner using cprofile. The direct runner slowdown might be caused by some inefficiency in threading model, or other concurrency issue.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
   ncalls  tottime  percall  cumtime  percall filename:lineno(function) 
...
       16    5.278    0.330    5.278    0.330 {method &apos;acquire&apos; of &apos;_thread.lock&apos; objects}
        2    0.000    0.000    5.279    2.640 fn_api_runner.py:2128(process_bundle)
        2    0.000    0.000    5.281    2.640 fn_api_runner.py:803(_run_stage)
        1    0.000    0.000    5.317    5.317 fn_api_runner.py:575(run_stages)
        1    0.000    0.000    5.319    5.319 fn_api_runner.py:506(run_via_runner_api)
        1    0.000    0.000    5.337    5.337 fn_api_runner.py:462(run_pipeline)
        1    0.000    0.000    5.346    5.346 direct_runner.py:125(run_pipeline)
        1    0.000    0.000    5.392    5.392 &amp;lt;string&amp;gt;:1(&amp;lt;module&amp;gt;)
        1    0.000    0.000    5.392    5.392 test_pipeline.py:109(run)
      2/1    0.000    0.000    5.392    5.392 pipeline.py:453(run)
     42/1    0.000    0.000    5.392    5.392 {built-in method builtins.exec}

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It is possible that Dataflow runner the slowdown manfiests via a different way, since it does not use fn_api_runner.py.&lt;/p&gt;</comment>
                            <comment id="17029201" author="tvalentyn" created="Mon, 3 Feb 2020 18:59:21 +0000"  >&lt;p&gt;My repro was running&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;python setup.py nosetests --nocapture --test-pipeline-options=&quot; --iterations=10 --number_of_counters=1 --number_of_counter_operations=1 --project=big-query-project --publish_to_big_query=false --metrics_dataset=python_load_tests --metrics_table=pardo --input_options=&apos;{ \&quot;num_records\&quot;: 100000, \&quot;key_size\&quot;: 10, \&quot;value_size\&quot;:90, \&quot;bundle_size_distribution_type\&quot;: \&quot;const\&quot;, \&quot;bundle_size_distribution_param\&quot;: 1, \&quot;force_initial_num_bundles\&quot;: 0 }&apos;&quot; --tests apache_beam.testing.load_tests.pardo_test 2&amp;gt;/dev/null | sort -n -k4
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Wtih these changes &lt;a href=&quot;https://github.com/apache/beam/commit/5e4bc432ee89f0d517b353c638fbc4a4f0eadb95&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/commit/5e4bc432ee89f0d517b353c638fbc4a4f0eadb95&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17029222" author="tvalentyn" created="Mon, 3 Feb 2020 19:52:45 +0000"  >&lt;p&gt;Somewhat faster way to obtain the same information is to pass: --profile_cpu --profile_sample_rate=1 --profile_location=/tmp&lt;/p&gt;

&lt;p&gt;if gprof2dot is installed, it creates an SVG diagram.&lt;/p&gt;

&lt;p&gt;Full command: &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;python setup.py nosetests --nocapture --test-pipeline-options=&quot; --iterations=10 --number_of_counters=1 --number_of_counter_operations=1 --profile_cpu --profile_sample_rate=1 --profile_location=/tmp --project=big-query-project --publish_to_big_query=false --metrics_dataset=python_load_tests --metrics_table=pardo --input_options=&apos;{ \&quot;num_records\&quot;: 100000, \&quot;key_size\&quot;: 10, \&quot;value_size\&quot;:90, \&quot;bundle_size_distribution_type\&quot;: \&quot;const\&quot;, \&quot;bundle_size_distribution_param\&quot;: 1, \&quot;force_initial_num_bundles\&quot;: 0 }&apos;&quot; --tests apache_beam.testing.load_tests.pardo_test 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17035914" author="tvalentyn" created="Thu, 13 Feb 2020 04:44:22 +0000"  >&lt;p&gt;This is a regression in numpy. Downgrading numpy to 1.16.5 produces the same results for me on Py 2 / Py 3.&lt;/p&gt;

&lt;p&gt;pip install numpy==1.18.1&lt;br/&gt;
python -m timeit &apos;import numpy as np; &lt;span class=&quot;error&quot;&gt;&amp;#91;np.random.RandomState(i) for i in range(10000)&amp;#93;&lt;/span&gt;&apos;&lt;br/&gt;
&amp;gt; [1 loop, best of 5: 1.22 sec per loop&lt;/p&gt;

&lt;p&gt;1.16.5 is much faster:&lt;/p&gt;

&lt;p&gt;pip install numpy==1.16.5&lt;br/&gt;
python -m timeit &apos;import numpy as np; &lt;span class=&quot;error&quot;&gt;&amp;#91;np.random.RandomState(i) for i in range(10000)&amp;#93;&lt;/span&gt;&apos;&lt;br/&gt;
&amp;gt; 1 loop, best of 5: 17.8 msec per loop&lt;/p&gt;

&lt;p&gt;Beam uses np.random.RandomState() during generation of Synthetic input&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, which causes the slowdown.&lt;/p&gt;

&lt;p&gt;Note that 1.16.5 is the latest numpy version with Python 2 support, but on Python 3 newer versions are available.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/beam/blob/b3e06126405105836f9ae15a15d5e1c7189b7f6e/sdks/python/apache_beam/testing/synthetic_pipeline.py#L419&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/blob/b3e06126405105836f9ae15a15d5e1c7189b7f6e/sdks/python/apache_beam/testing/synthetic_pipeline.py#L419&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17035924" author="tvalentyn" created="Thu, 13 Feb 2020 05:10:20 +0000"  >&lt;p&gt;Per &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; The RandomState provides access to legacy generators. This generator is considered frozen and will have no further improvements. It is guaranteed to produce the same values as the final point release of NumPy v1.16. &lt;span class=&quot;error&quot;&gt;&amp;#91;...&amp;#93;&lt;/span&gt; . This class should only be used if it is essential to have randoms that are identical to what would have been produced by previous versions of NumPy.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kamilwu&quot; class=&quot;user-hover&quot; rel=&quot;kamilwu&quot;&gt;kamilwu&lt;/a&gt;, would you have time to investigate which replacement generator we can use for consistent performance on 1.16.5 and 1.18.1? If such generator is not available, we can downgrade numpy via supplying a requirements.txt file to a Dataflow job in performance tests you are running, but there may be a better option. Thank you.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;  &lt;a href=&quot;https://numpy.org/doc/1.18/reference/random/legacy.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://numpy.org/doc/1.18/reference/random/legacy.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17036145" author="kamilwu" created="Thu, 13 Feb 2020 11:35:11 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tvalentyn&quot; class=&quot;user-hover&quot; rel=&quot;tvalentyn&quot;&gt;tvalentyn&lt;/a&gt;, great work!&lt;/p&gt;

&lt;p&gt;I&apos;ll take a look at this in the next couple of days. I&apos;ll keep you posted on any progress.&lt;/p&gt;</comment>
                            <comment id="17036377" author="tvalentyn" created="Thu, 13 Feb 2020 17:46:24 +0000"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kamilwu&quot; class=&quot;user-hover&quot; rel=&quot;kamilwu&quot;&gt;kamilwu&lt;/a&gt;. I&apos;ll reassign the issue to you for now, for the follow-up changes in the test infra. &lt;/p&gt;</comment>
                            <comment id="17036457" author="tvalentyn" created="Thu, 13 Feb 2020 19:32:47 +0000"  >&lt;p&gt;note that passing numpy==1.16.5 in requirements.txt increases the installation time on Dataflow workers in Python 3 tests. Looking at worker startup logs, it takes about ~8 min to install numpy form sources that are staged, which makes Py3 tests appear  slower than Py2 if judged by walltime (537s (py2) vs 977s (py3+requirements file to downgrade numpy)). &lt;/p&gt;</comment>
                            <comment id="17037199" author="tvalentyn" created="Fri, 14 Feb 2020 18:50:12 +0000"  >&lt;p&gt;I also tried running the experiment on Dataflow runner with increased number of records, it appears that Py3 may still be somewhat slower, so we may have to come back to investigating this issue, after we address the slowdown in the synthetic input generator. &lt;/p&gt;</comment>
                            <comment id="17084101" author="kamilwu" created="Wed, 15 Apr 2020 13:45:35 +0000"  >&lt;p&gt;I think we can close this ticket. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tvalentyn&quot; class=&quot;user-hover&quot; rel=&quot;tvalentyn&quot;&gt;tvalentyn&lt;/a&gt; Do you have any comments?&lt;/p&gt;</comment>
                            <comment id="17084385" author="tvalentyn" created="Wed, 15 Apr 2020 21:16:27 +0000"  >&lt;p&gt;No comments - the graphs in first message show an improvement in metrics, and Py3 Dataflow benchmarks are on par or better than Py2.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310460">
                    <name>Child-Issue</name>
                                                                <inwardlinks description="is a child of">
                                        <issuelink>
            <issuekey id="13268576">BEAM-8671</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 30 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0adu8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>