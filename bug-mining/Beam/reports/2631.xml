<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:21:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-13073] Unexpected GC when using Java 11</title>
                <link>https://issues.apache.org/jira/browse/BEAM-13073</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;Beam SDK has been supporting Java 11 for a while (I guess the support was introduced here &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-2530&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BEAM-2530&lt;/a&gt;).&#160;Unfortunately, in Spotify we are still experiencing performance issues when using Beam SDK 2.32, Google Dataflow and Java 11.&lt;/p&gt;

&lt;p&gt;Thanks to&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=emilyye&quot; class=&quot;user-hover&quot; rel=&quot;emilyye&quot;&gt;emilyye&lt;/a&gt;&#160;and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iht&quot; class=&quot;user-hover&quot; rel=&quot;iht&quot;&gt;iht&lt;/a&gt;, they confirmed JVM 11 is using SerialGC, while Java 8 uses ParallelGC. It sounds like ParallelGC is a good option for high throughput / low latency jobs. For Java11 we&apos;d expect to use G1GC or ParallelGC.&lt;/p&gt;

&lt;p&gt;This SO question&#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; clarifies that JVM chooses SerialGC when it treats the machine as a &quot;client&quot;. It looks like the Java SDK container could benefit from using `-XX:+AlwaysActAsServerClassMachine`. Is that correct?&lt;/p&gt;

&lt;p&gt;Let me know if the ticket needs further context or adjustment. (It is my first time creating a ticket here).&lt;/p&gt;

&lt;p&gt;&#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;&#160;&lt;a href=&quot;https://stackoverflow.com/questions/52474162/why-is-serialgc-chosen-over-g1gc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/52474162/why-is-serialgc-chosen-over-g1gc&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13407067">BEAM-13073</key>
            <summary>Unexpected GC when using Java 11</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10101" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">P1</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kenn">Kenneth Knowles</assignee>
                                    <reporter username="labianchin">Luis</reporter>
                        <labels>
                            <label>java11</label>
                            <label>java9</label>
                            <label>performance</label>
                    </labels>
                <created>Mon, 18 Oct 2021 12:28:30 +0000</created>
                <updated>Tue, 23 Nov 2021 20:34:22 +0000</updated>
                            <resolved>Tue, 23 Nov 2021 20:34:22 +0000</resolved>
                                                    <fixVersion>2.35.0</fixVersion>
                                    <component>sdk-java-harness</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4800">1h 20m</timespent>
                                <comments>
                            <comment id="17431396" author="kenn" created="Wed, 20 Oct 2021 17:59:17 +0000"  >&lt;p&gt;Yea this looks like another consequence of &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-10222&quot; title=&quot;Dataflow sets CPU limits on docker containers near zero so Java 11 only detects 1 CPU&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-10222&quot;&gt;&lt;del&gt;BEAM-10222&lt;/del&gt;&lt;/a&gt;. The JDK getAvailableProcessors is wrong (I read the code a while ago and it doesn&apos;t really make sense) so it probably thinks there is just one CPU so parallel GC won&apos;t be efficient.&lt;/p&gt;</comment>
                            <comment id="17433728" author="labianchin" created="Mon, 25 Oct 2021 12:37:56 +0000"  >&lt;p&gt;I just verified the changes from &lt;a href=&quot;https://github.com/apache/beam/pull/15739&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/15739&lt;/a&gt;&#160;and now Java 11 container uses G1C instead of SerialGC (I used this job to test &lt;a href=&quot;https://github.com/spotify/dbeam/compare/bench1).&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/spotify/dbeam/compare/bench1).&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I think this can be closed, or? I look forward to see this change in upcoming Beam SDK releases.&lt;/p&gt;</comment>
                            <comment id="17447527" author="tvalentyn" created="Mon, 22 Nov 2021 16:42:42 +0000"  >&lt;p&gt;It appears that this change caused a performance regression for Java 11: see &lt;a href=&quot;http://metrics.beam.apache.org/d/MOi-kf3Zk/pardo-load-tests?orgId=1&amp;amp;var-processingType=batch&amp;amp;var-sdk=java&amp;amp;from=now-80d&amp;amp;to=now&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;graphs &lt;/a&gt; or attachment.&lt;/p&gt;

&lt;p&gt;Would someone be able to A/B test the benchmark with and without this change to confirm? &lt;/p&gt;

&lt;p&gt;It looks like the change was intentional, so perhaps we are making a tradeoff - in which case it would be good to confirm that the tradeoff  is  justified and we can proceed with the change.&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13036456/13036456_perf_regression_java_11.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17447596" author="tvalentyn" created="Mon, 22 Nov 2021 19:56:12 +0000"  >&lt;p&gt;Marking this issue as a release blocker for now.&lt;/p&gt;</comment>
                            <comment id="17447601" author="tvalentyn" created="Mon, 22 Nov 2021 20:01:33 +0000"  >&lt;p&gt;I wonder if we should consider  Parallel GC  instead of G1GC  and how such change will affect the performance. &lt;/p&gt;</comment>
                            <comment id="17447830" author="labianchin" created="Tue, 23 Nov 2021 08:27:43 +0000"  >&lt;p&gt;Ow. That is unfortunate. As described, the context of this change is that Beam SDK (and Dataflow) with Java11 was using SerialGC, which caused performance issues when migrating from Java 8 (that uses ParallelGC).&lt;/p&gt;

&lt;p&gt;I am not (yet) familiar with these benchmark jobs. I validated the changes in some ad-hoc benchmark jobs, but the results were not very reproducible.&lt;/p&gt;

&lt;p&gt;I agree that ParallelGC sounds more appropriate here. I can looking into opening a PR for that.&lt;/p&gt;</comment>
                            <comment id="17448193" author="tvalentyn" created="Tue, 23 Nov 2021 18:32:02 +0000"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=labianchin&quot; class=&quot;user-hover&quot; rel=&quot;labianchin&quot;&gt;labianchin&lt;/a&gt; for making a PR. I am trying to setup A/B test.&lt;/p&gt;

&lt;p&gt;Looking at the Job logs in &lt;a href=&quot;https://ci-beam.apache.org/job/beam_LoadTests_Java_ParDo_Dataflow_V2_Batch_Java11/159/consoleFull&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-beam.apache.org/job/beam_LoadTests_Java_ParDo_Dataflow_V2_Batch_Java11/159/consoleFull&lt;/a&gt; to fish out a gradle command, and will try to run the command from the same image that we use to run tests on Jenkins, to minimize environment issues:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;gcloud compute instances create valentyn-jenkins-image --project=apache-beam-testing --zone us-central1-b --image-family=jenkins-worker-boot-image --machine-type=n1-highmem-4
gcloud compute ssh valentyn-jenkins-image --project=apache-beam-testing --zone us-central1-b         
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Need to see if the tests rebuild the container from HEAD or I also need to rebuild the container.&lt;/p&gt;
</comment>
                            <comment id="17448214" author="tvalentyn" created="Tue, 23 Nov 2021 18:44:07 +0000"  >&lt;p&gt;Looks like the command for the benchmark in question looks like so: &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;04:48:50 Build step &apos;Invoke Gradle script&apos; changed build result to SUCCESS
04:48:50 [beam_LoadTests_Java_ParDo_Dataflow_V2_Batch_Java11] $ /bin/bash -xe /tmp/jenkins8325135391935297727.sh
04:48:50 + echo &apos;*** Load test: ParDo 2GB 100 byte records 200  times ***&apos;
04:48:50 *** Load test: ParDo 2GB 100 byte records 200  times ***
04:48:50 [Gradle] - Launching build.
04:48:50 [src] $ /home/jenkins/jenkins-slave/workspace/beam_LoadTests_Java_ParDo_Dataflow_V2_Batch_Java11/src/gradlew -PloadTest.mainClass=org.apache.beam.sdk.loadtests.ParDoLoadTest -Prunner=:runners:google-cloud-dataflow-java &apos;-PloadTest.args=--project=apache-beam-testing --region=us-central1 --appName=load_tests_Java11_Dataflow_V2_batch_ParDo_2 --tempLocation=gs://temp-storage-for-perf-tests/loadtests --influxMeasurement=java_batch_pardo_2 --influxTags={&quot;runnerVersion&quot;:&quot;v2&quot;,&quot;jdk&quot;:&quot;java11&quot;} --publishToInfluxDB=true --sourceOptions={&quot;numRecords&quot;:20000000,&quot;keySizeBytes&quot;:10,&quot;valueSizeBytes&quot;:90} --iterations=200 --numberOfCounters=1 --numberOfCounterOperations=0 --numWorkers=5 --autoscalingAlgorithm=NONE --streaming=false --influxDatabase=beam_test_metrics --influxHost=http://10.128.0.96:8086 --runner=DataflowRunner&apos; -Prunner.version=V2 -PcompileAndRunTestsWithJava11 -Pjava11Home=/usr/lib/jvm/java-11-openjdk-amd64 --continue --max-****s=12 -Dorg.gradle.jvmargs=-Xms2g -Dorg.gradle.jvmargs=-Xmx4g -Dorg.gradle.vfs.watch=false -Pdocker-pull-licenses :sdks:java:testing:load-tests:run
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looking further in the logs, it seems that container is being rebuilt, which is good.&lt;/p&gt;

&lt;p&gt;Technically, we should be able to trigger this suite on a PR with trigger commands, but the feedback loop would be longer and we might write the updated result into metrics database.&lt;/p&gt;

&lt;p&gt;I&apos;ll try a targeted execution.&lt;/p&gt;</comment>
                            <comment id="17448217" author="tvalentyn" created="Tue, 23 Nov 2021 18:53:16 +0000"  >&lt;p&gt;The &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;--max-****s=12&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;  is probably --max-workers=12, not sure what causes this bizzare flag shortening.&lt;/p&gt;</comment>
                            <comment id="17448252" author="tvalentyn" created="Tue, 23 Nov 2021 20:24:26 +0000"  >&lt;p&gt;Actually running from my linux laptop was easier (less credential issues), and just worked.&lt;/p&gt;

&lt;p&gt;This is the job running against current master (no changes): &lt;br/&gt;
&lt;a href=&quot;https://console.cloud.google.com/dataflow/jobs/us-central1/2021-11-23_11_20_07&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://console.cloud.google.com/dataflow/jobs/us-central1/2021-11-23_11_20_07&lt;/a&gt;&lt;br/&gt;
-11082418496147790215?project=apache-beam-testing  &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;                 Metric:                    Value:
dataflow_v2_java11_runtime_sec                   112.861
dataflow_v2_java11_total_bytes_count                     2.0E9
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Job with #15739 reverted:  &lt;a href=&quot;https://console.cloud.google.com/dataflow/jobs/us-central1/2021-11-23_12_06_48-5893170135615925417?project=apache-beam-testing&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://console.cloud.google.com/dataflow/jobs/us-central1/2021-11-23_12_06_48-5893170135615925417?project=apache-beam-testing&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;diff --git a/sdks/java/container/boot.go b/sdks/java/container/boot.go
index 429a88a4bb..70335d328a 100644
--- a/sdks/java/container/boot.go
+++ b/sdks/java/container/boot.go
@@ -154,7 +154,6 @@ func main() {
 
        args := []string{
                &quot;-Xmx&quot; + strconv.FormatUint(heapSizeLimit(info), 10),
-               &quot;-XX:+AlwaysActAsServerClassMachine&quot;,
                &quot;-XX:-OmitStackTraceInFastThrow&quot;,
                &quot;-cp&quot;, strings.Join(cp, &quot;:&quot;),
        }

                 Metric:                    Value:
dataflow_v2_java11_runtime_sec                    84.425
dataflow_v2_java11_total_bytes_count                     2.0E9

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Job with #16045 (fix forward): &lt;a href=&quot;https://console.cloud.google.com/dataflow/jobs/us-central1/2021-11-23_11_36_08-1288932146243405653?project=apache-beam-testing&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://console.cloud.google.com/dataflow/jobs/us-central1/2021-11-23_11_36_08-1288932146243405653?project=apache-beam-testing&lt;/a&gt;       &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;:beam$ git diff HEAD^
diff --git a/sdks/java/container/boot.go b/sdks/java/container/boot.go
index 429a88a4bb..5d120fc777 100644
--- a/sdks/java/container/boot.go
+++ b/sdks/java/container/boot.go
@@ -154,6 +154,9 @@ func main() {
 
        args := []string{
                &quot;-Xmx&quot; + strconv.FormatUint(heapSizeLimit(info), 10),
+               // ParallelGC the most adequate for high throughput and lower CPU utilization
+               // It is the default GC in Java 8, but not on newer versions
+               &quot;-XX:+UseParallelGC&quot;,
                &quot;-XX:+AlwaysActAsServerClassMachine&quot;,
                &quot;-XX:-OmitStackTraceInFastThrow&quot;,
                &quot;-cp&quot;, strings.Join(cp, &quot;:&quot;),

                 Metric:                    Value:
dataflow_v2_java11_runtime_sec                     85.06
dataflow_v2_java11_total_bytes_count                     2.0E9

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13036456" name="perf_regression_java_11.png" size="153711" author="tvalentyn" created="Mon, 22 Nov 2021 16:42:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 50 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0vxk8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>