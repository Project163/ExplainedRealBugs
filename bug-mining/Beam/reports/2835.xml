<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:23:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-13981] Job event log empty on Spark History Server</title>
                <link>https://issues.apache.org/jira/browse/BEAM-13981</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;After upgrade from Beam 2.24.0 -&amp;gt; 2.33.0 Spark jobs run on YARN after complete shows empty data on History server.&lt;/p&gt;

&lt;p&gt;The problem seems to be a race condition and 2&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;22/02/22 10:51:11 INFO EventLoggingListener: Logging events to hdfs:/user/spark/jobhistory/application_1553109013416_12079975_1
...
22/02/22 10:51:41 INFO EventLoggingListener: Logging events to hdfs:/user/spark/jobhistory/application_1553109013416_12079975_1&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;At the end failure:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;22/02/22 11:17:57 INFO SchedulerExtensionServices: Stopping SchedulerExtensionServices
(serviceOption=None,
 services=List(),
 started=false)
22/02/22 11:17:57 ERROR Utils: Uncaught exception in thread Driver
java.io.IOException: Target log file already exists (hdfs:/user/spark/jobhistory/application_1553109013416_12079975_1)
	at org.apache.spark.scheduler.EventLoggingListener.stop(EventLoggingListener.scala:255)
	at org.apache.spark.SparkContext.$anonfun$stop$13(SparkContext.scala:1960)
	at org.apache.spark.SparkContext.$anonfun$stop$13$adapted(SparkContext.scala:1960)
	at scala.Option.foreach(Option.scala:274)
	at org.apache.spark.SparkContext.$anonfun$stop$12(SparkContext.scala:1960)
	at org.apache.spark.util.Utils$.tryLogNonFatalError(Utils.scala:1340)
	at org.apache.spark.SparkContext.stop(SparkContext.scala:1960)
	at org.apache.spark.api.java.JavaSparkContext.stop(JavaSparkContext.scala:654)
	at org.apache.beam.runners.spark.translation.SparkContextFactory.stopSparkContext(SparkContextFactory.java:73)
	at org.apache.beam.runners.spark.SparkPipelineResult$BatchMode.stop(SparkPipelineResult.java:133)
	at org.apache.beam.runners.spark.SparkPipelineResult.offerNewState(SparkPipelineResult.java:234)
	at org.apache.beam.runners.spark.SparkPipelineResult.waitUntilFinish(SparkPipelineResult.java:99)
	at org.apache.beam.runners.spark.SparkPipelineResult.waitUntilFinish(SparkPipelineResult.java:92)
	at com.sizmek.dp.dsp.pipeline.driver.PipelineDriver.$anonfun$main$1(PipelineDriver.scala:41)
	at scala.util.Try$.apply(Try.scala:213)
	at com.sizmek.dp.dsp.pipeline.driver.PipelineDriver.main(PipelineDriver.scala:34)
	at com.sizmek.dp.dsp.pipeline.driver.PipelineDriver.main$(PipelineDriver.scala:17)
	at com.zetaglobal.dp.dsp.jobs.dealstats.DealStatsDriver$.main(DealStatsDriver.scala:18)
	at com.zetaglobal.dp.dsp.jobs.dealstats.DealStatsDriver.main(DealStatsDriver.scala)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:497)
	at org.apache.spark.deploy.yarn.ApplicationMaster$$anon$2.run(ApplicationMaster.scala:684)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This ends up with very empty file in HDFS and empty job details in history server.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Problem seems to by introduced by this change:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/beam/pull/14409&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/14409&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Why Beam runs concurrent event listener to what spark is doing internally? When I roll back change for SparkRunner, problem disappear for me.&lt;/p&gt;

&lt;p&gt;I am running native SparkRunner with Spark 2.4.4&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13429981">BEAM-13981</key>
            <summary>Job event log empty on Spark History Server</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="iemejia">Isma&#235;l Mej&#237;a</assignee>
                                    <reporter username="jvilcek">Jozef Vilcek</reporter>
                        <labels>
                    </labels>
                <created>Tue, 22 Feb 2022 16:52:04 +0000</created>
                <updated>Fri, 11 Mar 2022 16:05:19 +0000</updated>
                            <resolved>Fri, 11 Mar 2022 15:59:49 +0000</resolved>
                                    <version>2.33.0</version>
                                    <fixVersion>2.38.0</fixVersion>
                                    <component>runner-spark</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3000">50m</timespent>
                                <comments>
                            <comment id="17496223" author="jvilcek" created="Tue, 22 Feb 2022 16:56:02 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iemejia&quot; class=&quot;user-hover&quot; rel=&quot;iemejia&quot;&gt;iemejia&lt;/a&gt; , since you are the author of the MR mentioned above, could you give me insight into why does SparkRunner needs to run EventLoggingListener? As I understand it, this should be under responsibility and configuration of Spark itself.&#160;&lt;/p&gt;</comment>
                            <comment id="17497800" author="iemejia" created="Thu, 24 Feb 2022 23:25:02 +0000"  >&lt;p&gt;Hi Jozef, Thanks for reporting this. The referred PR is mostly a refactor and a simplification on how to activate or not of the eventLog via the Spark default configuration. The real issue was introduced on &lt;a href=&quot;https://github.com/apache/beam/pull/13743/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/13743/&lt;/a&gt; that is the PR that introduced the extra EventLoggingListener.&lt;/p&gt;

&lt;p&gt;I suppose we did not hit the race condition before because the metrics tests on Spark are not currently covering the event logging path (eventLog enabled option) and also because maybe Spark+Hadoop initiates things differently.&lt;/p&gt;

&lt;p&gt;I agree with you we should not be overriding this on the runner side. This is absolutely error-prone. I removed all the extra EventLoggingListener code and validated that the metrics are reported correctly. I can create a PR that rollback the behavior of &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-11213&quot; title=&quot;Beam metrics should be displayed in Spark UI&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-11213&quot;&gt;&lt;del&gt;BEAM-11213&lt;/del&gt;&lt;/a&gt; because it is better to have metrics even if not clear than no metrics (aka the previous behavior), but I might be missing maybe the reason for this code, so let&apos;s double check with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ibzib&quot; class=&quot;user-hover&quot; rel=&quot;ibzib&quot;&gt;ibzib&lt;/a&gt; who reviewed the original PR to see if he may remember the reasons for this change and what he thinks we should do.&lt;/p&gt;</comment>
                            <comment id="17497804" author="iemejia" created="Thu, 24 Feb 2022 23:34:05 +0000"  >&lt;p&gt;For ref this is my proposed change &lt;a href=&quot;https://github.com/iemejia/beam/commit/d281f94a41809657a374566983fa354f4f785ca4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/iemejia/beam/commit/d281f94a41809657a374566983fa354f4f785ca4&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17497927" author="jvilcek" created="Fri, 25 Feb 2022 06:25:36 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iemejia&quot; class=&quot;user-hover&quot; rel=&quot;iemejia&quot;&gt;iemejia&lt;/a&gt; , unless some new information comes into the light, I agree with your reasoning and proposed change.&lt;/p&gt;</comment>
                            <comment id="17501225" author="jvilcek" created="Fri, 4 Mar 2022 08:55:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ibzib&quot; class=&quot;user-hover&quot; rel=&quot;ibzib&quot;&gt;ibzib&lt;/a&gt; , do you have any feedback on this one about the original intent of adding event logging to the spark runners.&lt;/p&gt;</comment>
                            <comment id="17504775" author="iemejia" created="Fri, 11 Mar 2022 08:02:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jvilcek&quot; class=&quot;user-hover&quot; rel=&quot;jvilcek&quot;&gt;jvilcek&lt;/a&gt; I opened the PR and asked &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aromanenko&quot; class=&quot;user-hover&quot; rel=&quot;aromanenko&quot;&gt;aromanenko&lt;/a&gt; to take a lot int he absence of Kyle so we hopefully get this in the 2.38.0 release.&lt;/p&gt;</comment>
                            <comment id="17504987" author="iemejia" created="Fri, 11 Mar 2022 16:05:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ibzib&quot; class=&quot;user-hover&quot; rel=&quot;ibzib&quot;&gt;ibzib&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tomasz.szerszen&quot; class=&quot;user-hover&quot; rel=&quot;tomasz.szerszen&quot;&gt;tomasz.szerszen&lt;/a&gt; this PR essentially reverts &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-11213&quot; title=&quot;Beam metrics should be displayed in Spark UI&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-11213&quot;&gt;&lt;del&gt;BEAM-11213&lt;/del&gt;&lt;/a&gt; because it broke the event log on Spark History Server (and Hadoop). If you want to bring the functionality back we have to pay attention to not start Event listeners on our own to avoid the possible race conditions.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13339603">BEAM-11213</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 35 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ztzs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>