<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:03:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-8347] UnboundedRabbitMqReader can fail to advance watermark if no new data comes in</title>
                <link>https://issues.apache.org/jira/browse/BEAM-8347</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;I stumbled upon this and then saw a similar StackOverflow post: &lt;a href=&quot;https://stackoverflow.com/questions/55736593/apache-beam-rabbitmqio-watermark-doesnt-advance&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/55736593/apache-beam-rabbitmqio-watermark-doesnt-advance&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;When calling `advance()` if there are no messages, no state changes, including no changes to the CheckpointMark or Watermark.&#160; If there is a relatively constant rate of new messages coming in, this is not a problem. If data is bursty, and there are periods of no new messages coming in, the watermark will never advance.&lt;/p&gt;

&lt;p&gt;Contrast this with some of the logic in PubsubIO which will make provisions for periods of inactivity to advance the watermark (although it, too, is imperfect: &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-7322&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BEAM-7322&lt;/a&gt; )&lt;/p&gt;

&lt;p&gt;The example given in the StackOverflow post is something like this:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
pipeline
  .apply(RabbitMqIO.read()
  .withUri(&lt;span class=&quot;code-quote&quot;&gt;&quot;amqp:&lt;span class=&quot;code-comment&quot;&gt;//guest:guest@localhost:5672&quot;&lt;/span&gt;)
&lt;/span&gt;  .withQueue(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;)
  .apply(&lt;span class=&quot;code-quote&quot;&gt;&quot;Windowing&quot;&lt;/span&gt;, 
    Window.&amp;lt;RabbitMqMessage&amp;gt;into(
      FixedWindows.of(Duration.standardSeconds(10)))
    .triggering(AfterWatermark.pastEndOfWindow())
    .withAllowedLateness(Duration.ZERO)
    .accumulatingFiredPanes())&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If I push 2 messages into my rabbit queue, I see 2 unack&apos;d messages and a window that never performs an on time trigger.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>testing has been done using the DirectRunner. I also have DataflowRunner available</environment>
        <key id="13260439">BEAM-8347</key>
            <summary>UnboundedRabbitMqReader can fail to advance watermark if no new data comes in</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="10722" iconUrl="https://issues.apache.org/jira/images/icons/statuses/generic.png" description="">Triage Needed</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbonofre">Jean-Baptiste Onofr&#233;</assignee>
                                    <reporter username="drobert">Daniel Robert</reporter>
                        <labels>
                    </labels>
                <created>Thu, 3 Oct 2019 20:50:29 +0000</created>
                <updated>Thu, 13 Apr 2023 10:58:27 +0000</updated>
                            <resolved>Thu, 7 Nov 2019 16:38:53 +0000</resolved>
                                    <version>2.15.0</version>
                                    <fixVersion>2.18.0</fixVersion>
                                    <component>io-java-rabbitmq</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="13800">3h 50m</timespent>
                                <comments>
                            <comment id="16953004" author="drobert" created="Wed, 16 Oct 2019 16:58:13 +0000"  >&lt;p&gt;Alright, I&apos;ve been playing around with this a lot locally (even rewriting the rabbitio unbounded source/reader) and I either don&apos;t understand the expected use case or the design seems incorrect.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Notable concerns:&lt;/p&gt;

&lt;p&gt;Splits:&lt;/p&gt;

&lt;p&gt;In `Source.split()`, the design of the reader binds to a single queue. As such, there&apos;s no concurrency or other advantage in parallelizing reads; it might as well return `Collections.singletonList(this)` regardless of inputs. Additionally, using a single reader decreases the likelihood of processing or acking messages out of queue order.&lt;/p&gt;

&lt;p&gt;Watermarks:&lt;/p&gt;

&lt;p&gt;Most of the issues are here. Looking at the documentation of &lt;tt&gt;UnboundedSource.getWatermark&lt;/tt&gt;:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;watermark&amp;#93;&lt;/span&gt; can be approximate. If records are read that violate this guarantee, they will be considered late, which will affect how they will be processed. ...&lt;/p&gt;

&lt;p&gt;However, this value should be &lt;em&gt;as late as possible&lt;/em&gt;. Downstream windows may not be able to close until this watermark passes their end.&lt;/p&gt;

&lt;p&gt;For example, a source may know that the records it reads will be in timestamp order. In this case, the watermark can be the timestamp of the last record read. For a source that does not have natural timestamps, timestamps can be set to the time of reading, in which case the watermark is the current clock time.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The current implementation retains the &lt;b&gt;oldest&lt;/b&gt; timestamp. Further, the timestamp comes from delivery properties, which, if we run single threaded consuming above, should be monotonically increasing. A switch to purely using the most recent timestamp rather than the oldest would go a long way to ensuring windows advance.&lt;/p&gt;

&lt;p&gt;There is precedent for this in some of the other unbounded sources, such as the Kafka ProcessingTimePolicy (&lt;a href=&quot;https://github.com/apache/beam/blob/master/sdks/java/io/kafka/src/main/java/org/apache/beam/sdk/io/kafka/TimestampPolicyFactory.java#L112)&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/blob/master/sdks/java/io/kafka/src/main/java/org/apache/beam/sdk/io/kafka/TimestampPolicyFactory.java#L112)&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Watermarks with no new input:&lt;/p&gt;

&lt;p&gt;In the event where there are no new messages, it would be ok to advance the watermark as well. The approach taken in the kafka io when the stream is &apos;caught up&apos;: &lt;a href=&quot;https://github.com/apache/beam/blob/master/sdks/java/io/kafka/src/main/java/org/apache/beam/sdk/io/kafka/TimestampPolicyFactory.java#L169&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/blob/master/sdks/java/io/kafka/src/main/java/org/apache/beam/sdk/io/kafka/TimestampPolicyFactory.java#L169&lt;/a&gt; .&lt;/p&gt;

&lt;p&gt;It might be useful to set the watermark to &lt;tt&gt;NOW - 2 seconds&lt;/tt&gt; in the event there are no messages available (i.e. here: &lt;a href=&quot;https://github.com/apache/beam/blob/master/sdks/java/io/rabbitmq/src/main/java/org/apache/beam/sdk/io/rabbitmq/RabbitMqIO.java#L467&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/blob/master/sdks/java/io/rabbitmq/src/main/java/org/apache/beam/sdk/io/rabbitmq/RabbitMqIO.java#L467&lt;/a&gt; ) in the event &apos;two seconds ago&apos; is more recent than the current watermark.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;(There&apos;s an unrelated bug I&apos;ve discovered as well where start() &lt;a href=&quot;https://github.com/apache/beam/blob/master/sdks/java/io/rabbitmq/src/main/java/org/apache/beam/sdk/io/rabbitmq/RabbitMqIO.java#L432&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/blob/master/sdks/java/io/rabbitmq/src/main/java/org/apache/beam/sdk/io/rabbitmq/RabbitMqIO.java#L432&lt;/a&gt; creates and uses a new ConnectionHandler even though one is already created at construction time, and thus the one constructed in start() is never properly stopped)&lt;/p&gt;

&lt;p&gt;&#8212;&lt;/p&gt;

&lt;p&gt;Curious if I&apos;m way off here, or if it&apos;d be worth refactoring the rabbitio reader to support these changes. Alternatively, if it would make sense to produce a separate rabbit reader for &apos;single queue, processing time watermarking&apos; use cases.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 4 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z079xk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>