<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:05:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-9228] _SDFBoundedSourceWrapper doesn&apos;t distribute data to multiple workers</title>
                <link>https://issues.apache.org/jira/browse/BEAM-9228</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;A user reported following issue.&lt;/p&gt;

&lt;p&gt;-------------------------------------------------&lt;br/&gt;
I have a set of tfrecord files, obtained by converting parquet files with Spark. Each file is roughly 1GB and I have 11 of those.&lt;/p&gt;

&lt;p&gt;I would expect simple statistics gathering (ie counting number of items of all files) to scale linearly with respect to the number of cores on my system.&lt;/p&gt;

&lt;p&gt;I am able to reproduce the issue with the minimal snippet below&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; apache_beam as beam
from apache_beam.options.pipeline_options &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; PipelineOptions
from apache_beam.runners.portability &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; fn_api_runner
from apache_beam.portability.api &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; beam_runner_api_pb2
from apache_beam.portability &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; python_urns
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; sys

pipeline_options = PipelineOptions([&lt;span class=&quot;code-quote&quot;&gt;&apos;--direct_num_workers&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;4&apos;&lt;/span&gt;])

file_pattern = &apos;part-r-00*
runner=fn_api_runner.FnApiRunner(
          default_environment=beam_runner_api_pb2.Environment(
              urn=python_urns.SUBPROCESS_SDK,
              payload=b&lt;span class=&quot;code-quote&quot;&gt;&apos;%s -m apache_beam.runners.worker.sdk_worker_main&apos;&lt;/span&gt;
                        % sys.executable.encode(&lt;span class=&quot;code-quote&quot;&gt;&apos;ascii&apos;&lt;/span&gt;)))

p = beam.Pipeline(runner=runner, options=pipeline_options)

lines = (p | &lt;span class=&quot;code-quote&quot;&gt;&apos;read&apos;&lt;/span&gt; &amp;gt;&amp;gt; beam.io.tfrecordio.ReadFromTFRecord(file_pattern)
                 | beam.combiners.Count.Globally()
                 | beam.io.WriteToText(&lt;span class=&quot;code-quote&quot;&gt;&apos;/tmp/output&apos;&lt;/span&gt;))

p.run()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Only one combination of apache_beam revision / worker type seems to work (I refer to &lt;a href=&quot;https://beam.apache.org/documentation/runners/direct/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://beam.apache.org/documentation/runners/direct/&lt;/a&gt; for the worker types)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;beam 2.16; neither multithread nor multiprocess achieve high cpu usage on multiple cores&lt;/li&gt;
	&lt;li&gt;beam 2.17: able to achieve high cpu usage on all 4 cores&lt;/li&gt;
	&lt;li&gt;beam 2.18: not tested the mulithreaded mode but the multiprocess mode fails when trying to serialize the Environment instance most likely because of a change from 2.17 to 2.18.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I also tried briefly SparkRunner with version 2.16 but was no able to achieve any throughput.&lt;/p&gt;

&lt;p&gt;What is the recommnended way to achieve what I am trying to ? How can I troubleshoot ?&lt;br/&gt;
----------------------------------------------------------------------------------------------------------------------------------------------&lt;/p&gt;

&lt;p&gt;This is caused by &lt;a href=&quot;https://github.com/apache/beam/commit/02f8ad4eee3ec0ea8cbdc0f99c1dad29f00a9f60&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this PR&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;A &lt;a href=&quot;https://github.com/apache/beam/pull/10729&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;workaround&lt;/a&gt; is tried, which is rolling back iobase.py not to use _SDFBoundedSourceWrapper. This confirmed that data is distributed to multiple workers, however, there are some regressions with SDF wrapper tests.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13282491">BEAM-9228</key>
            <summary>_SDFBoundedSourceWrapper doesn&apos;t distribute data to multiple workers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="10722" iconUrl="https://issues.apache.org/jira/images/icons/statuses/generic.png" description="">Triage Needed</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="hannahjiang">Hannah Jiang</assignee>
                                    <reporter username="hannahjiang">Hannah Jiang</reporter>
                        <labels>
                    </labels>
                <created>Thu, 30 Jan 2020 23:18:56 +0000</created>
                <updated>Thu, 13 Apr 2023 10:59:40 +0000</updated>
                            <resolved>Wed, 26 Feb 2020 08:16:51 +0000</resolved>
                                    <version>2.16.0</version>
                    <version>2.18.0</version>
                    <version>2.19.0</version>
                                    <fixVersion>2.20.0</fixVersion>
                                    <component>sdk-py-core</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="12000">3h 20m</timespent>
                                <comments>
                            <comment id="17044716" author="amaliujia" created="Tue, 25 Feb 2020 18:09:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hannahjiang&quot; class=&quot;user-hover&quot; rel=&quot;hannahjiang&quot;&gt;hannahjiang&lt;/a&gt; Is this Jira already done since the PR has merged?&lt;/p&gt;</comment>
                            <comment id="17045235" author="hannahjiang" created="Wed, 26 Feb 2020 08:16:09 +0000"  >&lt;p&gt;Yes, it was done. Will close it. &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 37 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0b0t4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>