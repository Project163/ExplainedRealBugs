<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:16:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-12229] WindmillStateCache has a 0% hit rate in 2.29</title>
                <link>https://issues.apache.org/jira/browse/BEAM-12229</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;After upgrading to 2.29, I noticed that our jobs have a 0% state cache hit rate.&#160; I see a very high eviction rate from the cache as well (it used to be ~0, now its ~100,000+ evictions / second).&lt;/p&gt;

&lt;p&gt;We never were on 2.28, so I can&apos;t say if it worked there, but it did work on 2.27.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13375162">BEAM-12229</key>
            <summary>WindmillStateCache has a 0% hit rate in 2.29</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10101" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">P1</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="scwhittle">Sam Whittle</assignee>
                                    <reporter username="SteveNiemitz">Steve Niemitz</reporter>
                        <labels>
                    </labels>
                <created>Mon, 26 Apr 2021 21:00:41 +0000</created>
                <updated>Wed, 5 May 2021 23:15:37 +0000</updated>
                            <resolved>Wed, 5 May 2021 23:13:20 +0000</resolved>
                                                    <fixVersion>2.30.0</fixVersion>
                                    <component>runner-dataflow</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3600">1h</timespent>
                                <comments>
                            <comment id="17332789" author="kenn" created="Mon, 26 Apr 2021 22:29:28 +0000"  >&lt;p&gt;Is there a way to test for this? Can we bisect?&lt;/p&gt;</comment>
                            <comment id="17332791" author="steveniemitz" created="Mon, 26 Apr 2021 22:31:34 +0000"  >&lt;p&gt;I was working on bisecting now actually, there&apos;s two commits that look like they could be the cause I&apos;m going to try reverting.&lt;/p&gt;</comment>
                            <comment id="17332792" author="rlax@alumni.rice.edu" created="Mon, 26 Apr 2021 22:34:00 +0000"  >&lt;p&gt;There were a couple of changes that were supposed to improve caching&lt;br/&gt;
performance, but possibly were buggy.&lt;/p&gt;

&lt;p&gt;On Mon, Apr 26, 2021 at 3:32 PM Steve Niemitz (Jira) &amp;lt;jira@apache.org&amp;gt;&lt;/p&gt;
</comment>
                            <comment id="17332832" author="steveniemitz" created="Tue, 27 Apr 2021 01:47:02 +0000"  >&lt;p&gt;Can confirm that &lt;a href=&quot;https://github.com/apache/beam/pull/13862&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/13862&lt;/a&gt;&#160;was the culprit here.&#160; Reverting it brought me back to ~100% hit rate.&lt;/p&gt;</comment>
                            <comment id="17332835" author="steveniemitz" created="Tue, 27 Apr 2021 01:52:59 +0000"  >&lt;p&gt;So perhaps even more concerning, looking at my application level metrics for the time period I had beam deployed with 2.29, I see some very suspicious looking numbers.&#160; Particularly, our persisted accumulator (ie, combiner state) size was much smaller in beam 2.29 than previously, and went back to normal when I reverted that commit.&#160; This should be unaffected by anything internal to beam (or cache for that matter), so I&apos;m kind of concerned we were actually seeing some form of data loss here.&#160; I&apos;m going to try to compare data between the two to see if there actually are discrepancies.&#160;&lt;/p&gt;</comment>
                            <comment id="17332836" author="kenn" created="Tue, 27 Apr 2021 01:55:14 +0000"  >&lt;p&gt;I guess meta-question is how to we make sure this is caught in future releases.&lt;/p&gt;</comment>
                            <comment id="17333208" author="scwhittle" created="Tue, 27 Apr 2021 12:50:50 +0000"  >&lt;p&gt;Ugh, I see the issue. I modified how tokens were validated after testing the change and broke it for any fused stages with more than 1 step.&lt;br/&gt;
The unit test is at a lower level than that misuse so it didn&apos;t catch it.&lt;/p&gt;

&lt;p&gt;I put together PR &lt;a href=&quot;https://github.com/apache/beam/pull/14649&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/14649&lt;/a&gt; but was unable to modify StreamingDataflowWorkerTest to reproduce the issue yet due to it&apos;s complexity.  I&apos;d like to do that before submitting.&lt;/p&gt;

&lt;p&gt;Maybe it is best to rollback the original PR in the interim though.&lt;/p&gt;

&lt;p&gt;The bug should only affect the cache effectiveness not corrupt data AFAICT.  Your combiner state could be different because the combiner does local combining differently before applying if it is cached.&lt;/p&gt;</comment>
                            <comment id="17333216" author="steveniemitz" created="Tue, 27 Apr 2021 13:03:31 +0000"  >&lt;p&gt;Oh interesting, I&apos;ll apply that patch and try it out.  I did confirm last night that the data was still correct too so that&apos;s good!&lt;/p&gt;</comment>
                            <comment id="17333285" author="steveniemitz" created="Tue, 27 Apr 2021 14:16:26 +0000"  >&lt;p&gt;I can confirm that PR fixed it also, thank you for the quick turnaround here!&lt;/p&gt;</comment>
                            <comment id="17335817" author="heejong" created="Thu, 29 Apr 2021 21:09:31 +0000"  >&lt;p&gt;Looks like the linked PR was merged. Can we close this issue?&lt;/p&gt;</comment>
                            <comment id="17335819" author="rlax@alumni.rice.edu" created="Thu, 29 Apr 2021 21:14:00 +0000"  >&lt;p&gt;Have the Dataflow worker images been updated yet?&lt;/p&gt;

</comment>
                            <comment id="17339758" author="bhulette" created="Wed, 5 May 2021 16:30:58 +0000"  >&lt;p&gt;I don&apos;t think this change is in a released image yet. Is that just necessary so we can verify the fix?&lt;/p&gt;</comment>
                            <comment id="17339764" author="kenn" created="Wed, 5 May 2021 16:39:02 +0000"  >&lt;p&gt;I have not updated the worker container but the remaining steps are for Dataflow internals, not Beam.&lt;/p&gt;</comment>
                            <comment id="17339922" author="kenn" created="Wed, 5 May 2021 22:53:27 +0000"  >&lt;p&gt;Since this problem is addressed on the Dataflow side, moving fix version to 2.29.0.&lt;/p&gt;</comment>
                            <comment id="17339923" author="bhulette" created="Wed, 5 May 2021 22:55:34 +0000"  >&lt;p&gt;I thought it was addressed by &lt;a href=&quot;https://github.com/apache/beam/pull/14649&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/14649&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17339927" author="kenn" created="Wed, 5 May 2021 23:13:07 +0000"  >&lt;p&gt;Yes, it was addressed by that. It is fixed on master. I have also backported the fix to apply to the internal Dataflow container image. We should also cherrypick to the 2.29.0 release branch actually, so that if anyone cuts 2.29.1 it is still included. That can be its own Jira. Actually let me put this one back to 2.30.0 and open the cherrypick Jira.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10020">
                    <name>Cloners</name>
                                                                <inwardlinks description="is cloned by">
                                        <issuelink>
            <issuekey id="13376887">BEAM-12292</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 27 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0qgxs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>