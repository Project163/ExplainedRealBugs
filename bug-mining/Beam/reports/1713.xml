<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:06:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-9557] Error setting processing time timers near end-of-window</title>
                <link>https://issues.apache.org/jira/browse/BEAM-9557</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;Previously, it was possible to set a processing time timer past the end of a window, and it would simply not fire.&lt;/p&gt;

&lt;p&gt;However, now, this results in an error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.IllegalArgumentException: Attempted to set event time timer that outputs &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 2020-03-19T18:01:35.000Z but that is after the expiration of window 2020-03-19T17:59:59.999Z
        org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkArgument(Preconditions.java:440)
        org.apache.beam.runners.dataflow.worker.repackaged.org.apache.beam.runners.core.SimpleDoFnRunner$TimerInternalsTimer.setAndVerifyOutputTimestamp(SimpleDoFnRunner.java:1011)
        org.apache.beam.runners.dataflow.worker.repackaged.org.apache.beam.runners.core.SimpleDoFnRunner$TimerInternalsTimer.setRelative(SimpleDoFnRunner.java:934)
&amp;lt;snip&amp;gt;.processElement(???.scala:187)
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think the regression was introduced in commit&#160;a005fd765a762183ca88df90f261f6d4a20cf3e0.&#160; Also notice that the error message is wrong, it says that &quot;event time timer&quot; but the timer is in the processing time domain.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13292769">BEAM-9557</key>
            <summary>Error setting processing time timers near end-of-window</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10101" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">P1</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="reuvenlax">Reuven Lax</assignee>
                                    <reporter username="SteveNiemitz">Steve Niemitz</reporter>
                        <labels>
                    </labels>
                <created>Thu, 19 Mar 2020 19:14:32 +0000</created>
                <updated>Tue, 4 May 2021 16:19:15 +0000</updated>
                            <resolved>Mon, 30 Mar 2020 18:32:08 +0000</resolved>
                                                    <fixVersion>2.20.0</fixVersion>
                                    <component>runner-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="26400">7h 20m</timespent>
                                <comments>
                            <comment id="17064984" author="altay" created="Mon, 23 Mar 2020 17:55:12 +0000"  >&lt;p&gt;For reference commit from description (a005fd765a762183ca88df90f261f6d4a20cf3e0) was added in (&lt;a href=&quot;https://github.com/apache/beam/pull/10627&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/10627&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reuvenlax&quot; class=&quot;user-hover&quot; rel=&quot;reuvenlax&quot;&gt;reuvenlax&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17065036" author="kenn" created="Mon, 23 Mar 2020 19:25:27 +0000"  >&lt;p&gt;Is this caused by the default output timestamp of processing time timer?&lt;/p&gt;</comment>
                            <comment id="17065070" author="kenn" created="Mon, 23 Mar 2020 20:31:23 +0000"  >&lt;p&gt;Processing time is independent of event time, so the &quot;end of window&quot; should not be relevant. This is definitely a bug. Previously the output timestamp for processing time timers would always be the watermark time when fired. Now it should have that same behavior if unspecified, but otherwise the provided event time timestamp takes effect.&lt;/p&gt;</comment>
                            <comment id="17065071" author="amaliujia" created="Mon, 23 Mar 2020 20:32:11 +0000"  >&lt;p&gt;If you still want to make this Jira release into 2.20.0, could you answer the following question to help me make a decision if I should adopt it:&lt;/p&gt;

&lt;p&gt;Is this a regression from a previous release?&lt;br/&gt;
Is this a new feature or related to a new feature?&lt;br/&gt;
What percentage of users would be impacted by this issue if it is not fixed?&lt;br/&gt;
Would it be possible for the impacted users to skip this version?&lt;/p&gt;</comment>
                            <comment id="17065090" author="steveniemitz" created="Mon, 23 Mar 2020 20:59:59 +0000"  >&lt;p&gt;imo this should be a blocker for 2.20.&#160; It breaks most use of processing time timers, including built-in transforms like Deduplicate.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Is this a regression from a previous release?&#160; &lt;b&gt;Yes&lt;/b&gt;&lt;br/&gt;
Is this a new feature or related to a new feature?&#160; Kind of?&#160; &lt;b&gt;It&apos;s an enhancement to an existing feature.&lt;/b&gt;&lt;br/&gt;
What percentage of users would be impacted by this issue if it is not fixed?&#160; &lt;b&gt;Unknown&lt;/b&gt;&lt;br/&gt;
Would it be possible for the impacted users to skip this version? &lt;b&gt;Unknown&lt;/b&gt;.&#160; Personally I know I won&apos;t skip the version, but just revert the commit above in our own fork.&#160; Many other users likely won&apos;t be so happy to do so.&lt;/p&gt;</comment>
                            <comment id="17065112" author="reuvenlax" created="Mon, 23 Mar 2020 21:23:25 +0000"  >&lt;p&gt;This looks like it might be a type bug? I think that&#160;&lt;/p&gt;

&lt;p&gt;checkArgument(!target.isAfter(windowExpiry))&#160;&lt;/p&gt;

&lt;p&gt;should actually have been&lt;/p&gt;

&lt;p&gt;checkArgument(!outputTimestamp.isAfter(windowExpiry),&lt;/p&gt;</comment>
                            <comment id="17065220" author="steveniemitz" created="Tue, 24 Mar 2020 01:03:03 +0000"  >&lt;p&gt;I had actually tried that (for other reasons) in the past.&#160; The problem is that the state cleanup timers fire based on the input watermark, so unless you&apos;re careful you can set an (event time) timer that fires after state is cleaned up.&lt;/p&gt;

&lt;p&gt;I guess you could do this anyways with processing time timers, so maybe it&apos;d be ok to allow?&#160; It&apos;s just a little more unexpected w/ event time.&lt;/p&gt;

&lt;p&gt;I think the best solution is to respect the watermark hold only if it is set (for processing time timers), otherwise to default back to the existing behavior.&lt;/p&gt;</comment>
                            <comment id="17066010" author="amaliujia" created="Tue, 24 Mar 2020 17:31:15 +0000"  >&lt;p&gt;I understand people have their schedules. But this Jira is marked as blocker for 2.20.0 release. Could relevant people have a conclusion soon for wether this Jira should be a blocker or propose a fix?&lt;/p&gt;</comment>
                            <comment id="17066023" author="reuvenlax" created="Tue, 24 Mar 2020 17:40:48 +0000"  >&lt;p&gt;I&apos;m not sure why the simple solution I proposed does not work. For event-time timer, the default hold will stay exactly where it was. For processing-time timers, I think the commit referenced contained a typo, and that typo caused the bug; the default hold should always be inside the current window.&lt;/p&gt;</comment>
                            <comment id="17066280" author="steveniemitz" created="Wed, 25 Mar 2020 00:14:00 +0000"  >&lt;p&gt;The default case will work as you mentioned, but if the validation is on output time, I could set an event time timer for eg:&lt;/p&gt;

&lt;p&gt;given a window end = 03:00:00&lt;/p&gt;

&lt;p&gt;outputTimestamp = 02:59:59&lt;/p&gt;

&lt;p&gt;target = 03:05:00&lt;/p&gt;

&lt;p&gt;The timer will hold the watermark correctly, but the state cleanup timer will fire at 03:00:00 (since it fires off the input watermark) and clean up the state in that window, then my timer will fire 5 minutes later and observe up an empty state.&#160; The current validation catches this and will reject the timer.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17066364" author="reuvenlax" created="Wed, 25 Mar 2020 03:56:01 +0000"  >&lt;p&gt;Ah yes, I was referring to processing-time timers. For event-time timers, I believe that we need to maintain the invariant that outputTimestamp &amp;lt;= timerTimestamp &amp;lt; window_end + allowed_lateness&lt;/p&gt;</comment>
                            <comment id="17066643" author="steveniemitz" created="Wed, 25 Mar 2020 12:36:50 +0000"  >&lt;p&gt;ah ok, yeah I agree!&#160;&#160;&lt;/p&gt;</comment>
                            <comment id="17066892" author="reuvenlax" created="Wed, 25 Mar 2020 17:27:09 +0000"  >&lt;p&gt;ok, this seems simple. I&apos;ll send out a PR.&lt;/p&gt;</comment>
                            <comment id="17067014" author="reuvenlax" created="Wed, 25 Mar 2020 19:22:51 +0000"  >&lt;p&gt;pr/11226 sent for review&lt;/p&gt;</comment>
                            <comment id="17071198" author="amaliujia" created="Mon, 30 Mar 2020 18:32:09 +0000"  >&lt;p&gt;Have cherry-picked the change to release branch.&lt;/p&gt;</comment>
                            <comment id="17339112" author="kenn" created="Tue, 4 May 2021 16:19:15 +0000"  >&lt;p&gt;Just dropping in here that I have had this discussion a million times.&lt;/p&gt;

&lt;p&gt;Cleanup timers need to fire according to the &lt;em&gt;combined&lt;/em&gt; watermark of the main input and pending timers. Timers create something like a &quot;self-loop&quot; where the output timestamps hold that self-loop back. It is fundamentally incorrect to fire a cleanup timer based on the main element-only watermark.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 27 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0cpmg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>