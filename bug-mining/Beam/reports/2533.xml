<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:19:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-12803] SqlTransform doesn&apos;t work on python 3.9</title>
                <link>https://issues.apache.org/jira/browse/BEAM-12803</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;Working example below &lt;del&gt;(Is there no way to paste pre-formatted code into jira?!)&lt;/del&gt; (EDIT: I added the appropriate &quot;code&quot; block)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-python&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; itertools
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; csv
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; io

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; apache_beam &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; beam
&lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; apache_beam.dataframe.io &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; read_csv
&lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; apache_beam.transforms.sql &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; SqlTransform


&lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; parse_csv(val):
deflower_headers(iterator):
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; itertools.chain([&lt;span class=&quot;code-object&quot;&gt;next&lt;/span&gt;(iterator).lower()], iterator)
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; csv.DictReader(lower_headers(io.TextIOWrapper(val.&lt;span class=&quot;code-object&quot;&gt;open&lt;/span&gt;())))


&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;BeamTransformBuilder():
  &lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; build(&lt;span class=&quot;code-keyword&quot;&gt;self&lt;/span&gt;, pipeline):
    practices = (
        pipeline
          | beam.io.fileio.MatchFiles(&lt;span class=&quot;code-quote&quot;&gt;&quot;data.csv&quot;&lt;/span&gt;)
          | beam.io.fileio.ReadMatches()
          | beam.Reshuffle()
          | beam.FlatMap(parse_csv)
          | beam.Map(&lt;span class=&quot;code-keyword&quot;&gt;lambda&lt;/span&gt; x: beam.Row(&lt;span class=&quot;code-object&quot;&gt;id&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&quot;test-&lt;span class=&quot;code-object&quot;&gt;id&lt;/span&gt;&quot;&lt;/span&gt;))
          | SqlTransform(&quot;&quot;&quot;
                SELECT
                &lt;span class=&quot;code-object&quot;&gt;id&lt;/span&gt;
                FROM PCOLLECTION&quot;&quot;&quot;)
        )
    practices | beam.Map(&lt;span class=&quot;code-object&quot;&gt;print&lt;/span&gt;)


&lt;span class=&quot;code-keyword&quot;&gt;def&lt;/span&gt; main():
  builder = BeamTransformBuilder()
  &lt;span class=&quot;code-keyword&quot;&gt;with&lt;/span&gt; beam.Pipeline(&lt;span class=&quot;code-quote&quot;&gt;&apos;DirectRunner&apos;&lt;/span&gt;) &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; p:
  builder.build(p)


&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;__name__&lt;/span&gt; == &lt;span class=&quot;code-quote&quot;&gt;&apos;__main__&apos;&lt;/span&gt;:
  main()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
 Results in the error:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; File &lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/local/lib/python3.9/site-packages/apache_beam/typehints/schemas.py&quot;&lt;/span&gt;, line 185, in typing_to_runner_api

&#160; &#160; element_type = typing_to_runner_api(_get_args(type_)[0])

IndexError: tuple index out of range
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Tested on Python 3.9.6.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Annoyingly, it is difficult to test this out on other python versions. There&apos;s no documentation for how to setup a docker container using DirectRunner and running it locally. There&apos;s barely any documentation on what python versions are supported. And using pyenv, and pip install apache-beam requires a lot of other downloads that have conflicts when other versions are already installed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13397364">BEAM-12803</key>
            <summary>SqlTransform doesn&apos;t work on python 3.9</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Jonathan Hourany">Jonathan Hourany</assignee>
                                    <reporter username="steeling">sean teeling</reporter>
                        <labels>
                    </labels>
                <created>Wed, 25 Aug 2021 22:50:34 +0000</created>
                <updated>Tue, 21 Sep 2021 15:11:07 +0000</updated>
                            <resolved>Tue, 21 Sep 2021 15:11:02 +0000</resolved>
                                    <version>2.33.0</version>
                                    <fixVersion>2.34.0</fixVersion>
                                    <component>sdk-py-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="10200">2h 50m</timespent>
                                <comments>
                            <comment id="17411501" author="bhulette" created="Tue, 7 Sep 2021 21:13:41 +0000"  >&lt;p&gt;Thanks for the bug report!&lt;/p&gt;

&lt;p&gt;Note we don&apos;t yet support Python 3.9 in Beam (&lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-12000&quot; title=&quot;Support Python 3.9 in Apache Beam&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-12000&quot;&gt;&lt;del&gt;BEAM-12000&lt;/del&gt;&lt;/a&gt;), I&apos;m marking this as a blocker for that jira.&lt;/p&gt;</comment>
                            <comment id="17415818" author="jonathan hourany" created="Thu, 16 Sep 2021 00:54:53 +0000"  >&lt;p&gt;I just got bit by this too. I dove in to see if I could figure out what the problem was and I think I figured it out. The problematic line might be here &lt;a href=&quot;https://github.com/apache/beam/blob/3a3933caa1cdb11e6584bce87f8494979ab95cb1/sdks/python/apache_beam/typehints/schemas.py#L160&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;on line #160 in typehints.schemas&lt;/a&gt;&#160;. The line calls&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-python&quot;&gt;
&#160;        name=name, &lt;span class=&quot;code-object&quot;&gt;type&lt;/span&gt;=typing_to_runner_api(type_._field_types[name]))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And it might be the call to &lt;tt&gt;_field_types&lt;/tt&gt;&#160;that&apos;s the culprit. According to &lt;a href=&quot;https://docs.python.org/3/whatsnew/3.9.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;What&#8217;s New In Python 3.9&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;The &lt;em&gt;field_types _attribute of the typing.NamedTuple class has been removed. It was deprecated since Python 3.8. Use the __annotations&lt;/em&gt;_ attribute instead. (Contributed by Serhiy Storchaka in bpo-40182.)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The fix may be as easy as swapping&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;_field_types&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;out with&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;__annotation__&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I&apos;ll see if I can test this out when I get some down time.&lt;/p&gt;</comment>
                            <comment id="17416242" author="bhulette" created="Thu, 16 Sep 2021 16:55:21 +0000"  >&lt;p&gt;Thanks for the analysis &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Jonathan+Hourany&quot; class=&quot;user-hover&quot; rel=&quot;Jonathan Hourany&quot;&gt;Jonathan Hourany&lt;/a&gt;! That certainly looks like the culprit to me. &lt;/p&gt;

&lt;p&gt;Note there are a few other places where we reference &lt;tt&gt;&lt;em&gt;field_types&lt;/tt&gt;, if swapping in &lt;tt&gt;&lt;/em&gt;&lt;em&gt;annotation&lt;/em&gt;_&lt;/tt&gt; does prove to fix this we should probably find-replace all of those.&lt;/p&gt;</comment>
                            <comment id="17416322" author="jonathan hourany" created="Thu, 16 Sep 2021 20:39:06 +0000"  >&lt;p&gt;A quick update &#8211; my tired eyes missed that the `IndexError` was being generated by from accessing the return of `get_args`. I found out why `get_args` was returning an empty tuple and fixed the problem there, then swapped out any other mentions of `field_types` to `&lt;em&gt;annotations&lt;/em&gt;`. Almost all tests are passing. The failing tests I&apos;ve looked at so far don&apos;t seem to be related to this change, or at least it&apos;s not quite obvious but I&apos;ll keep diving into them.&lt;/p&gt;</comment>
                            <comment id="17416333" author="bhulette" created="Thu, 16 Sep 2021 21:34:52 +0000"  >&lt;p&gt;great, thank you! If you need help with the test failures feel free to put up a PR and we can take a look&lt;/p&gt;</comment>
                            <comment id="17416936" author="jonathan hourany" created="Fri, 17 Sep 2021 21:43:22 +0000"  >&lt;p&gt;Good news! I was able to build and test my changes locally, and, it seems to be&#160; working.&lt;/p&gt;

&lt;p&gt;This is working and correctly counts the 3 lines:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-python&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; json
&lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; typing &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; NamedTuple, Optional

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; apache_beam &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; beam
&lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; apache_beam &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; coders
&lt;span class=&quot;code-keyword&quot;&gt;from&lt;/span&gt; apache_beam.transforms.sql &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; SqlTransform


&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TestTuple(NamedTuple):
    foo: &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
    bar: Optional[&lt;span class=&quot;code-object&quot;&gt;str&lt;/span&gt;]


coders.registry.register_coder(TestTuple, coders.RowCoder)


&lt;span class=&quot;code-keyword&quot;&gt;with&lt;/span&gt; beam.Pipeline() &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; pipeline:
    _ = (
        pipeline
        | beam.Create(
                [
                    &lt;span class=&quot;code-quote&quot;&gt;&apos;{&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;: 1, &lt;span class=&quot;code-quote&quot;&gt;&quot;bar&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;}&apos;&lt;/span&gt;,
                    &lt;span class=&quot;code-quote&quot;&gt;&apos;{&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;: 3, &lt;span class=&quot;code-quote&quot;&gt;&quot;bar&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;}&apos;&lt;/span&gt;,
                    &lt;span class=&quot;code-quote&quot;&gt;&apos;{&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;: 5, &lt;span class=&quot;code-quote&quot;&gt;&quot;bar&quot;&lt;/span&gt;: null}&apos;&lt;/span&gt;,
                ]
            )
        | beam.Map(json.loads)
        | beam.Map(&lt;span class=&quot;code-keyword&quot;&gt;lambda&lt;/span&gt; x: TestTuple(**x)).with_output_types(TestTuple)
        | SqlTransform(&quot;&quot;&quot;
            SELECT COUNT(*) AS num_lines
            FROM PCOLLECTION
            &quot;&quot;&quot;)
        | beam.Map(&lt;span class=&quot;code-keyword&quot;&gt;lambda&lt;/span&gt; row: f&lt;span class=&quot;code-quote&quot;&gt;&quot;Num Rows: {row.num_lines}&quot;&lt;/span&gt;)
        | beam.Map(&lt;span class=&quot;code-object&quot;&gt;print&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;hr /&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;As does passing a PCollection to SqlTransformer&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-python&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;with&lt;/span&gt; beam.Pipeline() &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; pipeline:
    test_tbl = (
        pipeline
        | beam.Create(
                [
                    &lt;span class=&quot;code-quote&quot;&gt;&apos;{&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;: 1, &lt;span class=&quot;code-quote&quot;&gt;&quot;bar&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;}&apos;&lt;/span&gt;,
                    &lt;span class=&quot;code-quote&quot;&gt;&apos;{&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;: 3, &lt;span class=&quot;code-quote&quot;&gt;&quot;bar&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;}&apos;&lt;/span&gt;,
                    &lt;span class=&quot;code-quote&quot;&gt;&apos;{&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;: 5, &lt;span class=&quot;code-quote&quot;&gt;&quot;bar&quot;&lt;/span&gt;: null}&apos;&lt;/span&gt;,
                ]
            )
        | beam.Map(json.loads)
        | beam.Map(&lt;span class=&quot;code-keyword&quot;&gt;lambda&lt;/span&gt; x: TestTuple(**x)).with_output_types(TestTuple)
    )
    ( test_tbl
        | SqlTransform(&quot;&quot;&quot;
            SELECT COUNT(*) AS num_lines
            FROM PCOLLECTION
            &quot;&quot;&quot;)
        | beam.Map(&lt;span class=&quot;code-keyword&quot;&gt;lambda&lt;/span&gt; row: f&lt;span class=&quot;code-quote&quot;&gt;&quot;Num Rows: {row.num_lines}&quot;&lt;/span&gt;)
        | beam.Map(&lt;span class=&quot;code-object&quot;&gt;print&lt;/span&gt;)
    )
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;hr /&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;However, what I can&apos;t seem to get to work is passing a name-Pcollection dict and using the name of the Pcollection in SqlTransformer&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-python&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;with&lt;/span&gt; beam.Pipeline() &lt;span class=&quot;code-keyword&quot;&gt;as&lt;/span&gt; pipeline:
    test_tbl = (
        pipeline
        | beam.Create(
                [
                    &lt;span class=&quot;code-quote&quot;&gt;&apos;{&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;: 1, &lt;span class=&quot;code-quote&quot;&gt;&quot;bar&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;}&apos;&lt;/span&gt;,
                    &lt;span class=&quot;code-quote&quot;&gt;&apos;{&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;: 3, &lt;span class=&quot;code-quote&quot;&gt;&quot;bar&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;}&apos;&lt;/span&gt;,
                    &lt;span class=&quot;code-quote&quot;&gt;&apos;{&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;: 5, &lt;span class=&quot;code-quote&quot;&gt;&quot;bar&quot;&lt;/span&gt;: null}&apos;&lt;/span&gt;,
                ]
            )
        | beam.Map(json.loads)
        | beam.Map(&lt;span class=&quot;code-keyword&quot;&gt;lambda&lt;/span&gt; x: TestTuple(**x)).with_output_types(TestTuple)
    )
    
    ({&lt;span class=&quot;code-quote&quot;&gt;&quot;test_tbl&quot;&lt;/span&gt;: test_tbl}
        | SqlTransform(&quot;&quot;&quot;
            SELECT COUNT(*) AS num_lines
            FROM test_tbl
            &quot;&quot;&quot;)
        | beam.Map(&lt;span class=&quot;code-keyword&quot;&gt;lambda&lt;/span&gt; row: f&lt;span class=&quot;code-quote&quot;&gt;&quot;Num Rows: {row.num_lines}&quot;&lt;/span&gt;)
        | beam.Map(&lt;span class=&quot;code-object&quot;&gt;print&lt;/span&gt;)
    )
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This leads to &quot;RuntimeError: Unable to parse query&quot; exception where Calcite reports &quot;Object &apos;test_tbl&apos; not found&quot;. I can&apos;t tell if I&apos;m passing the KV pair in wrong somehow/accessing table incorrectly inside the query, &lt;del&gt;or if this is a Py39 issue.&lt;/del&gt; Edit: I rebuilt everything in Python 3.7 and got the same error, so it&apos;s looking like I&apos;m just doing something wrong here.&lt;/p&gt;

&lt;p&gt;If it is just user error then I&apos;ll get a PR up soon with details I found on why some tests are failing only on Python 3.9&lt;/p&gt;</comment>
                            <comment id="17417711" author="bhulette" created="Mon, 20 Sep 2021 16:10:45 +0000"  >&lt;p&gt;Is it possible there&apos;s a typo somewhere? It looks like your code correctly references &lt;tt&gt;test_tbl&lt;/tt&gt; everywhere, but the Calcite error says &apos;test_tabl&apos;.&lt;/p&gt;

&lt;p&gt;We do have some continuous tests that verify the tagged PCollection input case: &lt;a href=&quot;https://github.com/apache/beam/blob/8072cc0bcfd4eee08a95902e13b9bf1dc2338693/sdks/python/apache_beam/transforms/sql_test.py#L131&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/blob/8072cc0bcfd4eee08a95902e13b9bf1dc2338693/sdks/python/apache_beam/transforms/sql_test.py#L131&lt;/a&gt; so I&apos;d be surprised if there&apos;s an issue there.&lt;/p&gt;</comment>
                            <comment id="17417804" author="jonathan hourany" created="Mon, 20 Sep 2021 20:27:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;Is it possible there&apos;s a typo somewhere? It looks like your code correctly references test_tbl everywhere, but the Calcite error says &apos;test_tabl&apos;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;My bad: the typo is in my comment. In code, the exception correctly states &lt;tt&gt;test_tbl&lt;/tt&gt;. The test case you mentioned passes so I&apos;m still not sure why my example isn&apos;t. I&apos;m running the example in a notebook, maybe that has something to do with it?&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;PR is up! &lt;a href=&quot;https://github.com/apache/beam/pull/15539&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/15539&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;For the test cases that were failing: they all seem to be separate issues with Python 3.9 and aren&apos;t directly tied to this fix so I&apos;ve started creating new tickets for them specifically (e.g.&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-12914&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BEAM-12914&lt;/a&gt;)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13365661">BEAM-12000</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 8 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0u9qg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>