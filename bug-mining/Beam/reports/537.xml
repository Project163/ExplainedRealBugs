<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:49:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-2831] Pipeline crashes due to Beam encoder breaking Flink memory management</title>
                <link>https://issues.apache.org/jira/browse/BEAM-2831</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;I&#8217;ve been running a Beam pipeline on Flink. Depending on the dataset size and the heap memory configuration of the jobmanager and taskmanager, I may run into an EOFException, which causes the job to fail.&lt;/p&gt;

&lt;p&gt;As &lt;a href=&quot;http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/EOFException-related-to-memory-segments-during-run-of-Beam-pipeline-on-Flink-td15255.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;discussed on Flink&apos;s mailinglist&lt;/a&gt; (stacktrace enclosed), Flink catches these EOFExceptions and activates disk spillover. Because Beam wraps these exceptions, this mechanism fails, the exception travels up the stack, and the job aborts.&lt;/p&gt;

&lt;p&gt;Hopefully this is enough information and this is something that can be adjusted for in Beam. I&apos;d be glad to provide more information where needed.&lt;/p&gt;</description>
                <environment>Flink 1.2.1 and 1.3.0, Java HotSpot and OpenJDK 8, macOS 10.12.6 and unknown Linux</environment>
        <key id="13098850">BEAM-2831</key>
            <summary>Pipeline crashes due to Beam encoder breaking Flink memory management</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dwysakowicz">Dawid Wysakowicz</assignee>
                                    <reporter username="rjkip">Reinier Kip</reporter>
                        <labels>
                    </labels>
                <created>Thu, 31 Aug 2017 11:53:34 +0000</created>
                <updated>Sat, 16 May 2020 13:42:01 +0000</updated>
                            <resolved>Tue, 27 Mar 2018 17:57:47 +0000</resolved>
                                    <version>2.0.0</version>
                    <version>2.1.0</version>
                                    <fixVersion>2.5.0</fixVersion>
                                    <component>runner-flink</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4800">1h 20m</timespent>
                                <comments>
                            <comment id="16148985" author="aljoscha" created="Thu, 31 Aug 2017 13:40:50 +0000"  >&lt;p&gt;Could you try running it with this modified &lt;tt&gt;SerializableCoder&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SerializableCoder&amp;lt;T &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Serializable&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; CustomCoder&amp;lt;T&amp;gt; {

  /**
   * Returns a {@link SerializableCoder} instance &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the provided element type.
   * @param &amp;lt;T&amp;gt; the element type
   */
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &amp;lt;T &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Serializable&amp;gt; SerializableCoder&amp;lt;T&amp;gt; of(TypeDescriptor&amp;lt;T&amp;gt; type) {
    @SuppressWarnings(&lt;span class=&quot;code-quote&quot;&gt;&quot;unchecked&quot;&lt;/span&gt;)
    &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;T&amp;gt; clazz = (&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;T&amp;gt;) type.getRawType();
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SerializableCoder&amp;lt;&amp;gt;(clazz, type);
  }

  /**
   * Returns a {@link SerializableCoder} instance &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the provided element class.
   * @param &amp;lt;T&amp;gt; the element type
   */
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &amp;lt;T &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Serializable&amp;gt; SerializableCoder&amp;lt;T&amp;gt; of(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;T&amp;gt; clazz) {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SerializableCoder&amp;lt;&amp;gt;(clazz, TypeDescriptor.of(clazz));
  }

  /**
   * Returns a {@link CoderProvider} which uses the {@link SerializableCoder} &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; possible &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;
   * all types.
   *
   * &amp;lt;p&amp;gt;This method is invoked reflectively from {@link DefaultCoder}.
   */
  @SuppressWarnings(&lt;span class=&quot;code-quote&quot;&gt;&quot;unused&quot;&lt;/span&gt;)
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; CoderProvider getCoderProvider() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SerializableCoderProvider();
  }

  /**
   * A {@link CoderProviderRegistrar} which registers a {@link CoderProvider} which can handle
   * serializable types.
   */
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SerializableCoderProviderRegistrar &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; CoderProviderRegistrar {

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; List&amp;lt;CoderProvider&amp;gt; getCoderProviders() {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ImmutableList.of(getCoderProvider());
    }
  }

  /**
   * A {@link CoderProvider} that constructs a {@link SerializableCoder} &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; any &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;that
   * &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; serializable.
   */
  &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SerializableCoderProvider &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; CoderProvider {
    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &amp;lt;T&amp;gt; Coder&amp;lt;T&amp;gt; coderFor(TypeDescriptor&amp;lt;T&amp;gt; typeDescriptor,
        List&amp;lt;? &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; Coder&amp;lt;?&amp;gt;&amp;gt; componentCoders) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; CannotProvideCoderException {
      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (Serializable.&lt;span class=&quot;code-keyword&quot;&gt;class.&lt;/span&gt;isAssignableFrom(typeDescriptor.getRawType())) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; SerializableCoder.of((TypeDescriptor) typeDescriptor);
      }
      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CannotProvideCoderException(
          &lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot provide SerializableCoder because &quot;&lt;/span&gt; + typeDescriptor
              + &lt;span class=&quot;code-quote&quot;&gt;&quot; does not implement Serializable&quot;&lt;/span&gt;);
    }
  }

  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;T&amp;gt; type;
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;transient&lt;/span&gt; TypeDescriptor&amp;lt;T&amp;gt; typeDescriptor;

  &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; SerializableCoder(&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;T&amp;gt; type, TypeDescriptor&amp;lt;T&amp;gt; typeDescriptor) {
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.type = type;
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.typeDescriptor = typeDescriptor;
  }

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt;&amp;lt;T&amp;gt; getRecordType() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; type;
  }

  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void encode(T value, OutputStream outStream)
      &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    ObjectOutputStream oos = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ObjectOutputStream(outStream);
    oos.writeObject(value);
    oos.flush();
  }

  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; T decode(InputStream inStream)
      &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException, CoderException {
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      ObjectInputStream ois = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ObjectInputStream(inStream);
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; type.&lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt;(ois.readObject());
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (ClassNotFoundException e) {
      &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CoderException(&lt;span class=&quot;code-quote&quot;&gt;&quot;unable to deserialize record&quot;&lt;/span&gt;, e);
    }
  }

  /**
   * {@inheritDoc}
   *
   * @&lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; NonDeterministicException always. Java serialization is not
   *         deterministic with respect to {@link &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;#equals} &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; all types.
   */
  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void verifyDeterministic() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; NonDeterministicException {
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; NonDeterministicException(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;,
        &lt;span class=&quot;code-quote&quot;&gt;&quot;Java Serialization may be non-deterministic.&quot;&lt;/span&gt;);
  }

  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; equals(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; other) {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; !(other == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || getClass() != other.getClass())
            &amp;amp;&amp;amp; type == ((SerializableCoder&amp;lt;?&amp;gt;) other).type;
  }

  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; hashCode() {
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; type.hashCode();
  }

  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; TypeDescriptor&amp;lt;T&amp;gt; getEncodedTypeDescriptor() {
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (typeDescriptor == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
      typeDescriptor = TypeDescriptor.of(type);
    }
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; typeDescriptor;
  }

  &lt;span class=&quot;code-comment&quot;&gt;// This coder inherits isRegisterByteSizeObserverCheap,
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// getEncodedElementByteSize and registerByteSizeObserver
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// from StructuredCoder. Looks like we cannot &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; much better
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// in &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;.
&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The only change is in &lt;tt&gt;encode()&lt;/tt&gt; where we don&apos;t wrap the &lt;tt&gt;EOFException&lt;/tt&gt; anymore. I think this should fix the problem and if it indeed does we should include this change in Beam.&lt;/p&gt;</comment>
                            <comment id="16149496" author="rjkip" created="Thu, 31 Aug 2017 19:48:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt; Yes! The pipeline consistently succeeds with this change. Thanks for your effort. I suspect we will intregrate this replacement coder while we wait for the fix to come out.&lt;/p&gt;</comment>
                            <comment id="16150656" author="aljoscha" created="Fri, 1 Sep 2017 14:45:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kenn&quot; class=&quot;user-hover&quot; rel=&quot;kenn&quot;&gt;kenn&lt;/a&gt; Do you think we can change &lt;tt&gt;SerializableCoder&lt;/tt&gt; to pass through the exception instead of wrapping it in a &lt;tt&gt;CoderException&lt;/tt&gt;? Not sure what implications this could have for other runners.&lt;/p&gt;</comment>
                            <comment id="16151162" author="kenn" created="Fri, 1 Sep 2017 21:20:01 +0000"  >&lt;p&gt;I think for the most part there&apos;s no implications. I have no immediate objection based on any principles. The choice between wrapping an IOException into a CoderException versus not doing so is not clear in many cases. In particular, EOF and parse error are not really distinct errors, since malformed data causes the EOF.&lt;/p&gt;

&lt;p&gt;This may violate our rigid backwards compatibility requirements, though it probably affects zero actual users. Especially since they have to handle all IOExceptions anyhow, and because of the semantic ambiguity above, basically have to take the same action too.&lt;/p&gt;

&lt;p&gt;We have 100% rigidity on type errors and leaving working code working, but for bugs and places where the behavior is not well-defined (like what kind of exception a particular coder throws in particular situations) maybe there&apos;s flexibility...&lt;/p&gt;</comment>
                            <comment id="16287734" author="rjkip" created="Tue, 12 Dec 2017 15:17:12 +0000"  >&lt;p&gt;Hey guys and gals, is there intent to address this issue in Beam? I encounter someone about every month that struggles with this issue; it is not very straightforward to solve. If type rigidity is an issue, a hint added to the exception message to use another encoder would already be of great help.&lt;/p&gt;

&lt;p&gt;Whatever the solution, I can put in the time to submit the actual change.&lt;/p&gt;</comment>
                            <comment id="16389772" author="igosuki" created="Wed, 7 Mar 2018 16:43:46 +0000"  >&lt;p&gt;The implication here, is that from 2.1 onwards it is impossible to run any reasonably sized batch with the FlinkRunner with binary formats like Avro and Protobuf&#160;with the default block size of FileIO...&lt;/p&gt;</comment>
                            <comment id="16391419" author="igosuki" created="Thu, 8 Mar 2018 15:46:39 +0000"  >&lt;p&gt;I fixed that in every Coder, including the KryoAtomicCoder (I am using Scio) and it now works properly on Flink, thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12311020" key="com.atlassian.jira.plugin.system.customfieldtypes:url">
                        <customfieldname>External issue URL</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[http://apache-flink-user-mailing-list-archive.2336050.n4.nabble.com/EOFException-related-to-memory-segments-during-run-of-Beam-pipeline-on-Flink-td15255.html]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 36 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ji2f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>