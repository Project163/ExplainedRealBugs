<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:45:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-2359] SparkTimerInternals inputWatermarkTime does not get updated in cluster mode</title>
                <link>https://issues.apache.org/jira/browse/BEAM-2359</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;&lt;tt&gt;SparkTimerInternals#inputWatermarkTime&lt;/tt&gt; does not get updated in cluster mode.&lt;/p&gt;

&lt;p&gt;This causes windows to not get closed and state to increase forever in memory and processing time to increase leading to eventual application crash (also, triggers based on the watermark do not fire).&lt;/p&gt;

&lt;p&gt;The root cause is &lt;br/&gt;
a call from within the &lt;tt&gt;updateStateByKey&lt;/tt&gt; operation in &lt;a href=&quot;https://github.com/apache/beam/blob/master/runners/spark/src/main/java/org/apache/beam/runners/spark/stateful/SparkGroupAlsoByWindowViaWindowSet.java#L241-L242&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;SparkGroupAlsoByWindowViaWindowSet&lt;/a&gt; which tries to access a static reference to a &lt;tt&gt;GlobalWatermarkHolder&lt;/tt&gt; broadcast variable, however, in cluster mode this static reference would be a different one in the executor&apos;s JVM and is null (this works in local mode since the executor and driver are on the same JVM).&lt;/p&gt;

&lt;p&gt;Alternative Solutions (And viability of solution):&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;del&gt;Broadcast variable passed to the &lt;tt&gt;updateStateByKey&lt;/tt&gt; operator&lt;/del&gt; - Not viable since even if we use the broadcast correctly, broadcast variables can&apos;t be used in this case (from within &lt;tt&gt;updateStateByKey&lt;/tt&gt;) since  &lt;tt&gt;updateStateByKey&lt;/tt&gt; is a &lt;tt&gt;DStream&lt;/tt&gt; operator and not an &lt;tt&gt;RDD&lt;/tt&gt; operator so it will not be updated every micro-batch but rather will retain the same initial value.&lt;/li&gt;
	&lt;li&gt;&lt;del&gt;Broadcast variable to update the data in an additional transform&lt;/del&gt; - Create an additional transform on the &lt;tt&gt;DStream&lt;/tt&gt;&apos;s RDDs prior to the &lt;tt&gt;DStream&lt;/tt&gt; operator &lt;tt&gt;updateStateByKey&lt;/tt&gt; and use a broadcast which will be updated (since this is an &lt;tt&gt;RDD&lt;/tt&gt; operator), and add this value to the keyed datum itself so it will be available in the &lt;tt&gt;DStream&lt;/tt&gt; operator &lt;tt&gt;updateStateByKey&lt;/tt&gt;. Not viable since this will only update keys which have had new data appear in the microbatch, however we also want to update the watermark value for keys which did not have new data appear in the microbatch.&lt;/li&gt;
	&lt;li&gt;&lt;del&gt;Broadcast variable to update a static reference&lt;/del&gt; - Create an additional transform on the &lt;tt&gt;DStream&lt;/tt&gt;&apos;s RDDs prior to the &lt;tt&gt;DStream&lt;/tt&gt; operator &lt;tt&gt;updateStateByKey&lt;/tt&gt; and use a broadcast which will be updated (since this is an &lt;tt&gt;RDD&lt;/tt&gt; operator), and set this value in a static reference within the executor. Not viable since we cannot ensure that all executors will receive partitions to process in each microbatch.&lt;/li&gt;
	&lt;li&gt;Server to be polled lazily every microbatch from within the &lt;tt&gt;updateStateByKey&lt;/tt&gt; operator - Spin a server on some configured port on the driver which will serve the current watermarks upon request. Lazily poll this value every microbatch from within the &lt;tt&gt;updateStateByKey&lt;/tt&gt; operator and update a static reference within the executor. Viable, however does not use Spark native operations and incurs code maintenance for this and operational cost for the user (open ports in firewalls, etc.).&lt;/li&gt;
	&lt;li&gt;Drop/register watermarks as a block in BlockManager and request remote version from within the &lt;tt&gt;updateStateByKey&lt;/tt&gt; operator - Update watermarks as a block in the BlockManager on the driver by dropping and reregistering the block every microbatch. Lazily poll this value every microbatch from within the &lt;tt&gt;updateStateByKey&lt;/tt&gt; operator and update a static reference within the executor. Viable, less &quot;ugly&quot; than the server version and requires less operational cost.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13074592">BEAM-2359</key>
            <summary>SparkTimerInternals inputWatermarkTime does not get updated in cluster mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aviemzur">Aviem Zur</assignee>
                                    <reporter username="aviemzur">Aviem Zur</reporter>
                        <labels>
                    </labels>
                <created>Wed, 24 May 2017 17:54:26 +0000</created>
                <updated>Sat, 16 May 2020 13:58:13 +0000</updated>
                            <resolved>Tue, 4 Jul 2017 07:47:56 +0000</resolved>
                                                    <fixVersion>2.1.0</fixVersion>
                                    <component>runner-spark</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16046594" author="githubbot" created="Mon, 12 Jun 2017 14:06:10 +0000"  >&lt;p&gt;GitHub user aviemzur opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/beam/pull/3343&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/3343&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-2359&quot; title=&quot;SparkTimerInternals inputWatermarkTime does not get updated in cluster mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-2359&quot;&gt;&lt;del&gt;BEAM-2359&lt;/del&gt;&lt;/a&gt; Fix watermark broadcasting to executors in Spark runner&lt;/p&gt;

&lt;p&gt;    Be sure to do all of the following to help us incorporate your contribution&lt;br/&gt;
    quickly and easily:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Make sure the PR title is formatted like:&lt;br/&gt;
       `&lt;a href=&quot;#&amp;gt;&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;BEAM-&amp;lt;Jira issue #&amp;gt;&lt;/a&gt; Description of pull request`&lt;/li&gt;
	&lt;li&gt;[ ] Make sure tests pass via `mvn clean verify`.&lt;/li&gt;
	&lt;li&gt;[ ] Replace `&amp;lt;Jira issue #&amp;gt;` in the title with the actual Jira issue&lt;br/&gt;
           number, if there is one.&lt;/li&gt;
	&lt;li&gt;[ ] If this contribution is large, please file an Apache&lt;br/&gt;
           &lt;span class=&quot;error&quot;&gt;&amp;#91;Individual Contributor License Agreement&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://www.apache.org/licenses/icla.pdf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.apache.org/licenses/icla.pdf&lt;/a&gt;).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    &amp;#8212;&lt;br/&gt;
    R: @amitsela &lt;br/&gt;
    CC: @staslev @kobisalant &lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/aviemzur/beam&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/aviemzur/beam&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-2359&quot; title=&quot;SparkTimerInternals inputWatermarkTime does not get updated in cluster mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-2359&quot;&gt;&lt;del&gt;BEAM-2359&lt;/del&gt;&lt;/a&gt;-watermark-bug-spark&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/beam/pull/3343.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/3343.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3343&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit f1b679e402734f20dcd9645babaec0a3f291e259&lt;br/&gt;
Author: Aviem Zur &amp;lt;aviemzur@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-06-12T14:04:00Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-2359&quot; title=&quot;SparkTimerInternals inputWatermarkTime does not get updated in cluster mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-2359&quot;&gt;&lt;del&gt;BEAM-2359&lt;/del&gt;&lt;/a&gt; Fix watermark broadcasting to executors in Spark runner&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16059276" author="githubbot" created="Thu, 22 Jun 2017 12:34:00 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/beam/pull/3343&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/3343&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16072557" author="jbonofre" created="Mon, 3 Jul 2017 14:51:47 +0000"  >&lt;p&gt;Any update on this Jira for 2.1.0 release ?&lt;/p&gt;</comment>
                            <comment id="16073258" author="aviemzur" created="Tue, 4 Jul 2017 07:47:48 +0000"  >&lt;p&gt;Yeah, the PR was merged, marking as resolved.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 20 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ff6v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>