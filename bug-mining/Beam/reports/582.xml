<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:50:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-3516] SpannerWriteGroupFn does not respect mutation limits</title>
                <link>https://issues.apache.org/jira/browse/BEAM-3516</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;When using SpannerIO.write(), if it happens to be a large batch or a table with indexes its very possible it can hit the Spanner Mutations Limitation and fail with the following error:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Jan 02, 2018 2:42:59 PM org.apache.beam.runners.dataflow.util.MonitoringUtil$LoggingHandler process&lt;br/&gt;
SEVERE: 2018-01-02T22:42:57.873Z: (3e7c871d215e890b): com.google.cloud.spanner.SpannerException: INVALID_ARGUMENT: io.grpc.StatusRuntimeException: INVALID_ARGUMENT: The transaction contains too many mutations. Insert and update operations count with the multiplicity of the number of columns they affect. For example, inserting values into one key column and four non-key columns count as five mutations total for the insert. Delete and delete range operations count as one mutation regardless of the number of columns affected. The total mutation count includes any changes to indexes that the transaction generates. Please reduce the number of writes, or use fewer indexes. (Maximum number: 20000)&lt;br/&gt;
links &lt;/p&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {
 description}&lt;/span&gt; &lt;/div&gt;

&lt;p&gt;at com.google.cloud.spanner.SpannerExceptionFactory.newSpannerExceptionPreformatted(SpannerExceptionFactory.java:119)&lt;br/&gt;
 at com.google.cloud.spanner.SpannerExceptionFactory.newSpannerException(SpannerExceptionFactory.java:43)&lt;br/&gt;
 at com.google.cloud.spanner.SpannerExceptionFactory.newSpannerException(SpannerExceptionFactory.java:80)&lt;br/&gt;
 at com.google.cloud.spanner.spi.v1.GrpcSpannerRpc.get(GrpcSpannerRpc.java:404)&lt;br/&gt;
 at com.google.cloud.spanner.spi.v1.GrpcSpannerRpc.commit(GrpcSpannerRpc.java:376)&lt;br/&gt;
 at com.google.cloud.spanner.SpannerImpl$SessionImpl$2.call(SpannerImpl.java:729)&lt;br/&gt;
 at com.google.cloud.spanner.SpannerImpl$SessionImpl$2.call(SpannerImpl.java:726)&lt;br/&gt;
 at com.google.cloud.spanner.SpannerImpl.runWithRetries(SpannerImpl.java:200)&lt;br/&gt;
 at com.google.cloud.spanner.SpannerImpl$SessionImpl.writeAtLeastOnce(SpannerImpl.java:725)&lt;br/&gt;
 at com.google.cloud.spanner.SessionPool$PooledSession.writeAtLeastOnce(SessionPool.java:248)&lt;br/&gt;
 at com.google.cloud.spanner.DatabaseClientImpl.writeAtLeastOnce(DatabaseClientImpl.java:37)&lt;br/&gt;
 at org.apache.beam.sdk.io.gcp.spanner.SpannerWriteGroupFn.flushBatch(SpannerWriteGroupFn.java:108)&lt;br/&gt;
 at org.apache.beam.sdk.io.gcp.spanner.SpannerWriteGroupFn.processElement(SpannerWriteGroupFn.java:79)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;As a workaround we can override the &quot;withBatchSizeBytes&quot; to something much smaller:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;mutations.apply(&quot;Write&quot;, SpannerIO&lt;br/&gt;
&#160; &#160;.write()&lt;br/&gt;
&#160; &#160;// Artificially reduce the max batch size&#160;b/c the batcher currently doesn&apos;t&lt;br/&gt;
&#160; &#160;// take into account the 20000 mutation multiplicity limit&lt;br/&gt;
&#160; &#160;.withBatchSizeBytes(1024) // 1KB&lt;br/&gt;
&#160; &#160;.withProjectId(&quot;#PROJECTID#&quot;)&lt;br/&gt;
&#160; &#160;.withInstanceId(&quot;#INSTANCE#&quot;)&lt;br/&gt;
&#160; &#160;.withDatabaseId(&quot;#DATABASE#&quot;)&lt;br/&gt;
 );&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;While this is not as efficient, it at least allows it to work consistently&lt;/p&gt;</description>
                <environment></environment>
        <key id="13132904">BEAM-3516</key>
            <summary>SpannerWriteGroupFn does not respect mutation limits</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="nielm">Niel Markwick</assignee>
                                    <reporter username="ryangordon">Ryan Gordon</reporter>
                        <labels>
                    </labels>
                <created>Tue, 23 Jan 2018 01:07:42 +0000</created>
                <updated>Sat, 16 May 2020 13:51:10 +0000</updated>
                            <resolved>Fri, 26 Oct 2018 08:52:15 +0000</resolved>
                                    <version>2.2.0</version>
                                    <fixVersion>2.9.0</fixVersion>
                                    <component>runner-dataflow</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="19200">5h 20m</timespent>
                                <comments>
                            <comment id="16638869" author="nielm" created="Thu, 4 Oct 2018 20:56:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/beam/pull/6478&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR #6478&lt;/a&gt; improves the javadoc to specifically mention this issue, and a recommendation to&#160; use a lower value for&#160; .withMaxNumMutations() (the default is 5000.&lt;/p&gt;</comment>
                            <comment id="16664913" author="nielm" created="Fri, 26 Oct 2018 08:52:15 +0000"  >&lt;p&gt;It is&#160;practically impossible for the spanner writer to calculate exactly how many&#160;cells would be modified&#160;by a single Mutation &amp;#8211; any indexes on the mutated rows will contribute to the number of modified cells, and the&#160;quantity of bytes stored.&lt;/p&gt;

&lt;p&gt;Spanners limits are 20K mutated cells and 100Mb mutated bytes.&lt;/p&gt;

&lt;p&gt;The SpannerIO writer&apos;s defaults are to estimate the size and batch up to 5K mutated cells and 1Mb of mutated data, which would not trigger this issue for most users.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/beam/pull/4860&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR #4860&lt;/a&gt;&#160; and&#160; &lt;a href=&quot;https://github.com/apache/beam/pull/5297&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR #5297&lt;/a&gt; add functionality to estimate the number of cells and mutation size.&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/beam/pull/6478&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR #6478&lt;/a&gt; improves the documentation to mention the batching mechanism, when this error occurs and how to work around it.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 3 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3p81r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>