<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:49:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-591] Better handling of watermark in KafkaIO</title>
                <link>https://issues.apache.org/jira/browse/BEAM-591</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;Right now default watermark in KafkaIO is same as timestamp of the record. The main problem with this is that watermark does not change if there n&apos;t any new records on the topic. This can hold up many open windows. &lt;/p&gt;

&lt;p&gt;The record timestamp by default is set to processing time (i.e. when the runner reads a record from Kafka reader).&lt;/p&gt;

&lt;p&gt;A user can provide functions to calculate watermark and record timestamps. There are a few concerns with current design:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;What should happen when a kafka topic is idle:
	&lt;ul&gt;
		&lt;li&gt;in default case, I think watermark should advance to current time.&lt;/li&gt;
		&lt;li&gt;What should happen when user has provided a function to calculate record timestamp?
		&lt;ul&gt;
			&lt;li&gt;Should the watermark stay same as record timestamp?&lt;/li&gt;
			&lt;li&gt;same when user has provided own watermark function?&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Are the current semantics of user provided watermark function correct?
	&lt;ul&gt;
		&lt;li&gt;&lt;del&gt;it is run once for each record read&lt;/del&gt;.&lt;/li&gt;
		&lt;li&gt;&lt;del&gt;Should it instead be run inside &lt;tt&gt;getWatermark()&lt;/tt&gt; called by the runner (we could still provide the last user record, and its timestamp)&lt;/del&gt;.&lt;/li&gt;
		&lt;li&gt;It does run inside &lt;tt&gt;getWatermark()&lt;/tt&gt;. should we pass current record timestamp in addition to the record?&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;

</description>
                <environment></environment>
        <key id="13000183">BEAM-591</key>
            <summary>Better handling of watermark in KafkaIO</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rangadi">Raghu Angadi</assignee>
                                    <reporter username="rangadi">Raghu Angadi</reporter>
                        <labels>
                    </labels>
                <created>Thu, 25 Aug 2016 21:34:05 +0000</created>
                <updated>Sat, 16 May 2020 13:58:22 +0000</updated>
                            <resolved>Mon, 30 Apr 2018 04:48:53 +0000</resolved>
                                                    <fixVersion>2.4.0</fixVersion>
                                    <component>io-java-kafka</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="13200">3h 40m</timespent>
                                <comments>
                            <comment id="15438443" author="dhalperi@google.com" created="Fri, 26 Aug 2016 04:11:29 +0000"  >&lt;p&gt;May be worth checking out PubSubIO. It has two modes &amp;#8211; processing-time timestamps, and message-time timestamps. But it keeps watermark tracking to itself.&lt;/p&gt;</comment>
                            <comment id="15572540" author="rangadi" created="Thu, 13 Oct 2016 17:04:27 +0000"  >
&lt;p&gt;PubSubIO does advance the watermark to current time if there haven&apos;t been any records recently (&lt;a href=&quot;https://github.com/apache/incubator-beam/blob/master/sdks/java/core/src/main/java/org/apache/beam/sdk/io/PubsubUnboundedSource.java#L996&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;line 996&lt;/a&gt;). &lt;/p&gt;

&lt;p&gt;PubSub tracks last one minute of timestamps since pubsub might deliver out of order. Kafka does not have that issue. In addition KafkaIO knows if it has caught up with the latest records. &lt;/p&gt;

&lt;p&gt;For the default watermark case (i.e. KafkaIO processing time), I propose KafkaIO should advance to current time when the backlog is zero (back log is updated every 5 seconds). This will cover most of the use cases.&lt;/p&gt;

&lt;p&gt;This policy would be fine for custom timestamps too (as in PubSubIO). If the users want more control, we could invoke watermark function with out the the kafka record so that user can return current timestamp. &lt;/p&gt;</comment>
                            <comment id="15998946" author="rangadi" created="Fri, 5 May 2017 20:59:47 +0000"  >&lt;p&gt;KafkaIO now supports Kafka timestamps. These timestamps are not utilized yet. A topic with &apos;log append timestamps&apos; can easily support watermarks based on this timestamp. Since it monotonically increases for a partition, KafkaIO just needs to keep the latest log append timestamp.&lt;/p&gt;

&lt;p&gt;Create-time timestamps are trickier, the discussion above is relevant.&lt;/p&gt;</comment>
                            <comment id="16458307" author="rangadi" created="Mon, 30 Apr 2018 04:48:33 +0000"  >&lt;p&gt;See following methods added to `KafkaIO.Read` in 3 pull requests attached this jira:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;withLogAppendTime()&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;withCreateTime()&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;withProcessingTime()&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;withTimestampPolicyFactory()&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 29 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i32tbr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>