<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:21:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-13009] DynamoDBIO misses writing items if `withDeduplicateKeys` is not set</title>
                <link>https://issues.apache.org/jira/browse/BEAM-13009</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;A new method `withDeduplicateKeys` was added in DynamoDBIO from 2.27.0. It feels like it is optional according to the &lt;a href=&quot;https://beam.apache.org/releases/javadoc/2.27.0/index.html?org/apache/beam/sdk/io/aws/dynamodb/DynamoDBIO.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;doc&lt;/a&gt;, and&#160;it was not shown in the examples either. But if a key name not set by it, &lt;a href=&quot;https://github.com/apache/beam/pull/12583/files#diff-0b5f7a7c1ee0ec890eef82e05e08ef1152421d2c8dcef11fca107f6af0d22e87R479-R492&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the deduplication logic&lt;/a&gt; still takes effect but uses an empty map as the `Map&amp;lt;String, AttributeValue&amp;gt;` part of the deduplication key, which results in all items having the same key and being deduplicated, writing only the last item to DynamoDB.&lt;/p&gt;

&lt;p&gt;I think we need to add an check on DeduplicateKeys in `extractDeduplicateKeyValues`, and skip the deduplication logic if it&apos;s empty.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13405114">BEAM-13009</key>
            <summary>DynamoDBIO misses writing items if `withDeduplicateKeys` is not set</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10101" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">P1</priority>
                        <status id="10722" iconUrl="https://issues.apache.org/jira/images/icons/statuses/generic.png" description="">Triage Needed</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mosche">Moritz Mack</assignee>
                                    <reporter username="leeeei">Lei Li</reporter>
                        <labels>
                            <label>aws</label>
                            <label>data-loss</label>
                            <label>dynamodb</label>
                    </labels>
                <created>Wed, 6 Oct 2021 04:05:21 +0000</created>
                <updated>Thu, 13 Apr 2023 11:07:43 +0000</updated>
                            <resolved>Thu, 30 Dec 2021 15:03:41 +0000</resolved>
                                    <version>2.27.0</version>
                                    <fixVersion>2.36.0</fixVersion>
                                    <component>io-java-aws</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="15600">4h 20m</timespent>
                                <comments>
                            <comment id="17441200" author="aromanenko" created="Tue, 9 Nov 2021 14:39:46 +0000"  >&lt;p&gt;I raised this to P1 since it may cause a data loss.&lt;/p&gt;</comment>
                            <comment id="17442179" author="mosche" created="Thu, 11 Nov 2021 09:09:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aromanenko&quot; class=&quot;user-hover&quot; rel=&quot;aromanenko&quot;&gt;aromanenko&lt;/a&gt; This bug is becoming a bit of a blocker to fix &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-13209&quot; title=&quot;DynamoDBIO silently drops unprocessed items&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-13209&quot;&gt;&lt;del&gt;BEAM-13209&lt;/del&gt;&lt;/a&gt;, but also for &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-7559&quot; title=&quot;Add an Integration Test for DynamoDBIO&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-7559&quot;&gt;&lt;del&gt;BEAM-7559&lt;/del&gt;&lt;/a&gt; as I&apos;d like to extend the unit tests I&apos;ve added there. I have the code ready in a branch for both these tickets.&lt;/p&gt;

&lt;p&gt;Can you review or suggest someone else to review? The bugfix itself / change to DynamoDBIO is rather simple. Most of the code is adding sane test coverage.&lt;/p&gt;

&lt;p&gt;Otherwise I have to extract the part adding unit tests into a separate PR.&lt;/p&gt;</comment>
                            <comment id="17442892" author="aromanenko" created="Fri, 12 Nov 2021 18:11:12 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mosche&quot; class=&quot;user-hover&quot; rel=&quot;mosche&quot;&gt;mosche&lt;/a&gt; , merged&lt;/p&gt;</comment>
                            <comment id="17464147" author="tvalentyn" created="Wed, 22 Dec 2021 22:50:50 +0000"  >&lt;p&gt;I am seeing that some DynamoDBIO unit tests consistently fail for me when I run the :sdks:java:io:amazon-web-services:test suite on a VM that I created from apache-beam Ubuntu-16-based Jenkins image. Yet, these tests don&apos;t fail when I run this suite on my other machine (Debian based), and they also don&apos;t fail in regular jenkins cron runs (&lt;a href=&quot;https://scans.gradle.com/s/osiae2n3k2tv6/tests/:sdks:java:io:amazon-web-services:test/org.apache.beam.sdk.io.aws.dynamodb.DynamoDBIOWriteTest/testWritePutItemsWithDuplicates?top-execution=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;example&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;repro:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;gcloud compute instances create valentyn-test-image --project=apache-beam-testing --zone us-central1-b --image-family=jenkins-worker-boot-image --machine-type=n1-highmem-4
gcloud compute ssh valentyn-test-image --zone us-central1-b &#160;--project=apache-beam-testing 

# lsb_release -a
# No LSB modules are available.
# Distributor ID: Ubuntu
# Description: &#160; &#160;Ubuntu 16.04.6 LTS

git clone https://github.com/apache/beam.git
cd beam
sudo su  # two more tests fail without this
./gradlew  :sdks:java:io:amazon-web-services:test   --scan
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Gradle scan: &lt;a href=&quot;https://gradle.com/s/othuni7yzvgcs&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gradle.com/s/othuni7yzvgcs&lt;/a&gt;&lt;br/&gt;
Sample error:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;testWriteDeleteItemsWithDuplicates
FAILED
:sdks:java:io:amazon-web-services:test  org.apache.beam.sdk.io.aws.dynamodb.DynamoDBIOWriteTest
105 tests executed in build, 4 failed
Execution 1 of 1FAILED0.273stoday at 2:38:59 PM PST
Exception
java.lang.AssertionError: 	
Expected size:&amp;lt;100&amp;gt; but was:&amp;lt;103&amp;gt; in:	
&amp;lt;[Item{id=97},	
    Item{id=85},	
    Item{id=88},	
    Item{id=90},	
    Item{id=94},	
    Item{id=87},	
    Item{id=93},	
    Item{id=84},	
    Item{id=91},	
    Item{id=96},	
    Item{id=99},	
    Item{id=92},	
    Item{id=98},	
    Item{id=95},	
    Item{id=86},	
    Item{id=89},	
    Item{id=72},	
    Item{id=66},	
    Item{id=57},	
    Item{id=61},	
    Item{id=75},	
    Item{id=78},	
    Item{id=77},	
    Item{id=60},	
    Item{id=63},	
    Item{id=69},	
    Item{id=56},	
    Item{id=80},	
    Item{id=79},	
    Item{id=62},	
    Item{id=58},	
    Item{id=65},	
    Item{id=71},	
    Item{id=74},	
    Item{id=68},	
    Item{id=59},	
    Item{id=67},	
    Item{id=73},	
    Item{id=70},	
    Item{id=64},	
    Item{id=76},	
    Item{id=81},	
    Item{id=83},	
    Item{id=80},	
    Item{id=82},	
    Item{id=11},	
    Item{id=20},	
    Item{id=19},	
    Item{id=13},	
    Item{id=23},	
    Item{id=9},	
    Item{id=16},	
    Item{id=17},	
    Item{id=3},	
    Item{id=14},	
    Item{id=10},	
    Item{id=22},	
    Item{id=0},	
    Item{id=8},	
    Item{id=21},	
    Item{id=5},	
    Item{id=6},	
    Item{id=2},	
    Item{id=1},	
    Item{id=12},	
    Item{id=4},	
    Item{id=24},	
    Item{id=7},	
    Item{id=15},	
    Item{id=18},	
    Item{id=25},	
    Item{id=26},	
    Item{id=27},	
    Item{id=24},	
    Item{id=28},	
    Item{id=40},	
    Item{id=43},	
    Item{id=34},	
    Item{id=52},	
    Item{id=48},	
    Item{id=39},	
    Item{id=49},	
    Item{id=31},	
    Item{id=46},	
    Item{id=45},	
    Item{id=51},	
    Item{id=37},	
    Item{id=38},	
    Item{id=30},	
    Item{id=42},	
    Item{id=29},	
    Item{id=35},	
    Item{id=33},	
    Item{id=32},	
    Item{id=36},	
    Item{id=41},	
    Item{id=44},	
    Item{id=47},	
    Item{id=50},	
    Item{id=55},	
    Item{id=52},	
    Item{id=54},	
    Item{id=53}]&amp;gt;	
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17464148" author="tvalentyn" created="Wed, 22 Dec 2021 22:52:02 +0000"  >&lt;p&gt;Reopening in case you&apos;d like to take a closer look at what&apos;s happening, removing 2.35.0 as blocker list since tests pass in other environment and these are new tests.&#160;&lt;/p&gt;</comment>
                            <comment id="17464298" author="mosche" created="Thu, 23 Dec 2021 05:35:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tvalentyn&quot; class=&quot;user-hover&quot; rel=&quot;tvalentyn&quot;&gt;tvalentyn&lt;/a&gt; Interesting, I&apos;ll have a look! The error absolutely suggests there&apos;s some duplicates published. I can only imagine this to happen due to retries, though I can&apos;t imagine how that happens consistently.&#160; What about similar tests in SDK v2 when running :sdks:java:io:amazon-web-services2:test?&#160;&lt;/p&gt;</comment>
                            <comment id="17464301" author="tvalentyn" created="Thu, 23 Dec 2021 05:40:57 +0000"  >&lt;p&gt;Same behavior, this one VM i created from the image consistently has those tests failed, but on my other machine they pass. It&apos;s very bizzare.&lt;/p&gt;</comment>
                            <comment id="17464312" author="mosche" created="Thu, 23 Dec 2021 06:14:49 +0000"  >&lt;p&gt;Wondering, another possible cause could be the way duplicates are generated using the code below.&#160;&lt;/p&gt;

&lt;p&gt;Deduplication is per bundle only, is there a wrong assumption here?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;AddDuplicatesDoFn &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; DoFn&amp;lt;Item, Item&amp;gt; {
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; duplicates;

  AddDuplicatesDoFn(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; duplicates) {
    &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.duplicates = duplicates;
  }

  @ProcessElement
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void processElement(ProcessContext ctx) {
    Item original = ctx.element();
    range(0, duplicates).forEach(i -&amp;gt; ctx.output(original));
  }
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17464472" author="aromanenko" created="Thu, 23 Dec 2021 11:17:42 +0000"  >&lt;p&gt;I think that it&apos;s quite likely that the generated duplicates will go into the different bundles on the next PTransform&apos;s step (&lt;tt&gt;DynamoDBIO.write()&lt;/tt&gt;), so they won&apos;t be filtered by &lt;tt&gt;WriteFn&lt;/tt&gt; since there is no any GBK transform before (if I&apos;m not mistaken). &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
pipeline
        .apply(Create.of(items))
        &lt;span class=&quot;code-comment&quot;&gt;// generate identical duplicates
&lt;/span&gt;        .apply(ParDo.of(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AddDuplicatesDoFn(3, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;)))
        .apply(
            DynamoDBIO.&amp;lt;Item&amp;gt;write()
                .withWriteRequestMapperFn(deleteRequestMapper)
                .withAwsClientsProvider(StaticAwsClientsProvider.of(client)));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17464691" author="mosche" created="Thu, 23 Dec 2021 16:40:03 +0000"  >&lt;p&gt;Actually, I found the reason after a bit of digging... the difference between the environments is the number of CPUs. That generates a different initial split of the test data, leading to a situation where duplicates within a bundle are written to DynamoDB, but in separate Batch API requests. However, that is fine, only duplicates on the same request are forbidden.&lt;/p&gt;

&lt;p&gt;I&apos;m going to change tests to not fail if there&apos;s duplicates globally, but only within a single request.&lt;/p&gt;</comment>
                            <comment id="17466909" author="aromanenko" created="Thu, 30 Dec 2021 15:02:00 +0000"  >&lt;p&gt;Thanks for fixing the tests, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mosche&quot; class=&quot;user-hover&quot; rel=&quot;mosche&quot;&gt;mosche&lt;/a&gt;! Can we close this Jira now then?&lt;/p&gt;</comment>
                            <comment id="17466910" author="mosche" created="Thu, 30 Dec 2021 15:03:52 +0000"  >&lt;p&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/thumbs_up.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13410827">BEAM-13209</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13322656">BEAM-10706</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 45 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0vlj4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>