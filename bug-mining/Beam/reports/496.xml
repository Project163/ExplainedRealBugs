<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:48:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-3581] [SQL] Support for Non-ASCII chars is flaky</title>
                <link>https://issues.apache.org/jira/browse/BEAM-3581</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;Beam SQL&#160;overrides default charset that Calcite uses and sets it to UTF16. It is done via system properties.&lt;/p&gt;

&lt;p&gt;Problem is that we do this only when it hasn&apos;t been set yet. So if system property has been set to&#160;ISO-8859-1 (Calcite&apos;s default), then test runs will fail when trying to encode characters not supported in that encoding.&lt;/p&gt;

&lt;p&gt;Solution:&lt;/p&gt;

&lt;p&gt;&#160;-&#160;because it&apos;s a system property, we don&apos;t want to force override it;&lt;/p&gt;

&lt;p&gt;&#160;- for the same reason we cannot set it for a specific query execution;&lt;/p&gt;

&lt;p&gt;&#160;- we can expose a static method on BeamSql to override these properties if explicitly requested;&lt;/p&gt;

&lt;p&gt;&#160;- affected tests will explicitly override it;&lt;/p&gt;

&lt;p&gt;&#160;- otherwise behavior will stay unchanged and we will respect defaults and user settings;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13135176">BEAM-3581</key>
            <summary>[SQL] Support for Non-ASCII chars is flaky</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kedin">Anton Kedin</assignee>
                                    <reporter username="kedin">Anton Kedin</reporter>
                        <labels>
                    </labels>
                <created>Wed, 31 Jan 2018 19:09:59 +0000</created>
                <updated>Fri, 24 Jul 2020 20:19:43 +0000</updated>
                            <resolved>Thu, 8 Mar 2018 04:06:08 +0000</resolved>
                                                    <fixVersion>Not applicable</fixVersion>
                                    <component>dsl-sql</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4800">1h 20m</timespent>
                                <comments>
                            <comment id="16347419" author="kedin" created="Wed, 31 Jan 2018 19:12:20 +0000"  >
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Example Stack Trace&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;


[ERROR] testDefaultCharsetLiteral(org.apache.beam.sdk.extensions.sql.BeamSqlNonAsciiTest) Time elapsed: 0.009 s &amp;lt;&amp;lt;&amp;lt; ERROR!
java.lang.RuntimeException: &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; converting `TABLE_A`.`f_string` = &lt;span class=&quot;code-quote&quot;&gt;&apos;&#31532;&#22235;&#34892;&apos;&lt;/span&gt;
 at org.apache.calcite.sql2rel.ReflectiveConvertletTable$1.convertCall(ReflectiveConvertletTable.java:90)
 at org.apache.calcite.sql2rel.SqlNodeToRexConverterImpl.convertCall(SqlNodeToRexConverterImpl.java:63)
 at org.apache.calcite.sql2rel.SqlToRelConverter$Blackboard.visit(SqlToRelConverter.java:4536)
 at org.apache.calcite.sql2rel.SqlToRelConverter$Blackboard.visit(SqlToRelConverter.java:3904)
 at org.apache.calcite.sql.SqlCall.accept(SqlCall.java:137)
 at org.apache.calcite.sql2rel.SqlToRelConverter$Blackboard.convertExpression(SqlToRelConverter.java:4438)
 at org.apache.calcite.sql2rel.SqlToRelConverter.convertWhere(SqlToRelConverter.java:963)
 at org.apache.calcite.sql2rel.SqlToRelConverter.convertSelectImpl(SqlToRelConverter.java:641)
 at org.apache.calcite.sql2rel.SqlToRelConverter.convertSelect(SqlToRelConverter.java:619)
 at org.apache.calcite.sql2rel.SqlToRelConverter.convertQueryRecursive(SqlToRelConverter.java:3054)
 at org.apache.calcite.sql2rel.SqlToRelConverter.convertQuery(SqlToRelConverter.java:555)
 at org.apache.calcite.prepare.PlannerImpl.rel(PlannerImpl.java:232)
 at org.apache.beam.sdk.extensions.sql.impl.planner.BeamQueryPlanner.convertToRelNode(BeamQueryPlanner.java:154)
 at org.apache.beam.sdk.extensions.sql.impl.planner.BeamQueryPlanner.validateAndConvert(BeamQueryPlanner.java:140)
 at org.apache.beam.sdk.extensions.sql.impl.planner.BeamQueryPlanner.convertToBeamRel(BeamQueryPlanner.java:129)
 at org.apache.beam.sdk.extensions.sql.BeamSql$QueryTransform.expand(BeamSql.java:157)
 at org.apache.beam.sdk.extensions.sql.BeamSql$QueryTransform.expand(BeamSql.java:116)
 at org.apache.beam.sdk.Pipeline.applyInternal(Pipeline.java:537)
 at org.apache.beam.sdk.Pipeline.applyTransform(Pipeline.java:491)
 at org.apache.beam.sdk.values.PCollectionTuple.apply(PCollectionTuple.java:173)
 at org.apache.beam.sdk.extensions.sql.BeamSqlNonAsciiTest.testDefaultCharsetLiteral(BeamSqlNonAsciiTest.java:38)
 at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
 at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
 at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
 at java.lang.reflect.Method.invoke(Method.java:498)
 at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)
 at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
 at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)
 at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)
 at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)
 at org.junit.rules.ExpectedException$ExpectedExceptionStatement.evaluate(ExpectedException.java:239)
 at org.apache.beam.sdk.testing.TestPipeline$1.evaluate(TestPipeline.java:324)
 at org.junit.rules.RunRules.evaluate(RunRules.java:20)
 at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)
 at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:78)
 at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:57)
 at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)
 at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)
 at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)
 at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)
 at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)
 at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)
 at org.junit.runners.ParentRunner.run(ParentRunner.java:363)
 at org.junit.runners.Suite.runChild(Suite.java:128)
 at org.junit.runners.Suite.runChild(Suite.java:27)
 at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)
 at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)
 at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)
 at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)
 at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)
 at org.junit.runners.ParentRunner.run(ParentRunner.java:363)
 at org.apache.maven.surefire.junitcore.JUnitCore.run(JUnitCore.java:55)
 at org.apache.maven.surefire.junitcore.JUnitCoreWrapper.createRequestAndRun(JUnitCoreWrapper.java:137)
 at org.apache.maven.surefire.junitcore.JUnitCoreWrapper.executeEager(JUnitCoreWrapper.java:107)
 at org.apache.maven.surefire.junitcore.JUnitCoreWrapper.execute(JUnitCoreWrapper.java:83)
 at org.apache.maven.surefire.junitcore.JUnitCoreWrapper.execute(JUnitCoreWrapper.java:75)
 at org.apache.maven.surefire.junitcore.JUnitCoreProvider.invoke(JUnitCoreProvider.java:159)
 at org.apache.maven.surefire.booter.ForkedBooter.invokeProviderInSameClassLoader(ForkedBooter.java:373)
 at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:334)
 at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:119)
 at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:407)
Caused by: java.lang.reflect.InvocationTargetException
 at sun.reflect.GeneratedMethodAccessor54.invoke(Unknown Source)
 at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
 at java.lang.reflect.Method.invoke(Method.java:498)
 at org.apache.calcite.sql2rel.ReflectiveConvertletTable$1.convertCall(ReflectiveConvertletTable.java:87)
 ... 60 more
Caused by: org.apache.calcite.runtime.CalciteException: Failed to encode &lt;span class=&quot;code-quote&quot;&gt;&apos;&#31532;&#22235;&#34892;&apos;&lt;/span&gt; in character set &lt;span class=&quot;code-quote&quot;&gt;&apos;ISO-8859-1&apos;&lt;/span&gt;
 at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
 at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)
 at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
 at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
 at org.apache.calcite.runtime.Resources$ExInstWithCause.ex(Resources.java:463)
 at org.apache.calcite.runtime.Resources$ExInst.ex(Resources.java:572)
 at org.apache.calcite.util.NlsString.&amp;lt;init&amp;gt;(NlsString.java:81)
 at org.apache.calcite.rex.RexBuilder.makeLiteral(RexBuilder.java:855)
 at org.apache.calcite.rex.RexBuilder.makeCharLiteral(RexBuilder.java:1055)
 at org.apache.calcite.sql2rel.SqlNodeToRexConverterImpl.convertLiteral(SqlNodeToRexConverterImpl.java:118)
 at org.apache.calcite.sql2rel.SqlToRelConverter$Blackboard.visit(SqlToRelConverter.java:4525)
 at org.apache.calcite.sql2rel.SqlToRelConverter$Blackboard.visit(SqlToRelConverter.java:3904)
 at org.apache.calcite.sql.SqlLiteral.accept(SqlLiteral.java:487)
 at org.apache.calcite.sql2rel.SqlToRelConverter$Blackboard.convertExpression(SqlToRelConverter.java:4438)
 at org.apache.calcite.sql2rel.StandardConvertletTable.convertExpressionList(StandardConvertletTable.java:962)
 at org.apache.calcite.sql2rel.StandardConvertletTable.convertCall(StandardConvertletTable.java:938)
 at org.apache.calcite.sql2rel.StandardConvertletTable.convertCall(StandardConvertletTable.java:922)
 ... 64 more



&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16347485" author="iemejia" created="Wed, 31 Jan 2018 19:43:14 +0000"  >&lt;p&gt;Notice that this test or other is leaking something, because if executed in isolation it does not break. Easy way to reproduce is to do:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;mvn -Dtest=BeamSqlNonAsciiTest,BeamTextCSVTableTest -Dsurefire.runOrder=reversealphabetical verify -Prelease -pl &apos;sdks/java/extensions/sql&apos;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Thanks for the hint via slack &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dkulp&quot; class=&quot;user-hover&quot; rel=&quot;dkulp&quot;&gt;dkulp&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16347499" author="dkulp" created="Wed, 31 Jan 2018 19:49:45 +0000"  >&lt;p&gt;Note that it&apos;s not really the system properties causing an isssue in this case.  If I comment out/remove the setting of those system properties, the test still fails.  &lt;/p&gt;</comment>
                            <comment id="16347562" author="kedin" created="Wed, 31 Jan 2018 20:30:41 +0000"  >&lt;p&gt;Yes, you&apos;re right,&#160;changing the system properties doesn&apos;t fix the issue&lt;/p&gt;</comment>
                            <comment id="16347570" author="iemejia" created="Wed, 31 Jan 2018 20:34:35 +0000"  >&lt;p&gt;I didn&apos;t say the system properties caused the issue, I said that this command allows to reproduce it at least in my linux machine. If i run just the test BeamSqlNonAsciiTest it passes normally.&lt;/p&gt;</comment>
                            <comment id="16347833" author="dkulp" created="Thu, 1 Feb 2018 00:46:00 +0000"  >&lt;p&gt;Still digging into it a bit, but if you just add:&lt;/p&gt;

&lt;p&gt;```&lt;br/&gt;
import org.apache.calcite.sql.type.SqlTypeName;&lt;br/&gt;
...&lt;br/&gt;
 SqlTypeName sqlTypeName = SqlTypeName.VARCHAR;&lt;br/&gt;
```&lt;br/&gt;
to BeamSqlNonAsciiTest, then the test fails standalone.   &lt;/p&gt;</comment>
                            <comment id="16347860" author="kedin" created="Thu, 1 Feb 2018 01:27:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dkulp&quot; class=&quot;user-hover&quot; rel=&quot;dkulp&quot;&gt;dkulp&lt;/a&gt;&lt;br/&gt;
It looks like during initialization of SqlTypeName it &lt;a href=&quot;https://github.com/apache/calcite/blob/cb8376b13ad50003134e398a87161bec68908606/core/src/main/java/org/apache/calcite/sql/type/SqlTypeName.java#L138&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;calls a Util. enumConstants ()&lt;/a&gt;. But Util has a static member DEFAULT_CHARSET &lt;a href=&quot;https://github.com/apache/calcite/blob/cb8376b13ad50003134e398a87161bec68908606/core/src/main/java/org/apache/calcite/util/Util.java#L142&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; which creates the instance of SaffronProperties. So if I understand it right, if we didn&apos;t initialize the system properties before that then default charset will be used?&lt;/p&gt;

</comment>
                            <comment id="16347894" author="kedin" created="Thu, 1 Feb 2018 02:05:06 +0000"  >&lt;p&gt;Before reading from system properties Calcite reads from saffron.properties file. Calcite version that we have seems to look for the properties file in the current working dir, but newer versions seem to load it from resources: &lt;a href=&quot;https://github.com/apache/calcite/commit/534b09ffdf4972cb9efb978ef7fae46b9deb8e32&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/calcite/commit/534b09ffdf4972cb9efb978ef7fae46b9deb8e32&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Tests pass if I intercept this call in the debugger and load saffron.properties with UTF16 set as default encoding.&lt;/p&gt;</comment>
                            <comment id="16349074" author="kedin" created="Thu, 1 Feb 2018 18:37:21 +0000"  >&lt;p&gt;Next step after &lt;a href=&quot;https://github.com/apache/beam/pull/4564&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;fixing the tests&lt;/a&gt; we should document the current behavior:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Beam SQL parser tries to use UTF16;&lt;/li&gt;
	&lt;li&gt;unless system properties were overriden;&lt;/li&gt;
	&lt;li&gt;or unless you used some Calcite classes before using Beam which loaded the default charset;&lt;/li&gt;
	&lt;li&gt;except for Beam tests, which set the system properties to UTF16;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Then we need to upgrade to Calcite version that reads saffron.properties from resources, and use that instead of system properties.&lt;/p&gt;

&lt;p&gt;And keep this jira open, or create another one for the follow up.&lt;/p&gt;</comment>
                            <comment id="16373091" author="kedin" created="Thu, 22 Feb 2018 17:12:52 +0000"  >&lt;p&gt;We&apos;re on Calcite 1.15 now, created the Jira to put the settings into the properties file instead of build.gradle:&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3733&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BEAM-3733&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 38 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3pm0v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>