<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:50:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-3485] CassandraIO.read() splitting produces invalid queries</title>
                <link>https://issues.apache.org/jira/browse/BEAM-3485</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;See &lt;a href=&quot;https://stackoverflow.com/questions/48090668/how-to-increase-dataflow-read-parallelism-from-cassandra/48131264?noredirect=1#comment83548442_48131264&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/48090668/how-to-increase-dataflow-read-parallelism-from-cassandra/48131264?noredirect=1#comment83548442_48131264&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;As the question author points out, the error is likely that&#160;token($pk) should be token(pk). This was likely masked by &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3424&quot; title=&quot;CassandraIO uses 1 split if can&amp;#39;t estimate size&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-3424&quot;&gt;&lt;del&gt;BEAM-3424&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3425&quot; title=&quot;CassandraIO fails to estimate size: Codec not found for requested operation: [varchar &amp;lt;-&amp;gt; java.lang.Long]&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-3425&quot;&gt;&lt;del&gt;BEAM-3425&lt;/del&gt;&lt;/a&gt;, and the splitting code path effectively was never invoked, and was broken from the first PR - so there are likely other bugs.&lt;/p&gt;

&lt;p&gt;When testing this issue, we must ensure&#160;good code coverage in an IT against a real Cassandra instance.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13131332">BEAM-3485</key>
            <summary>CassandraIO.read() splitting produces invalid queries</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="adejanovski">Alexander Dejanovski</assignee>
                                    <reporter username="jkff">Eugene Kirpichov</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 Jan 2018 19:56:55 +0000</created>
                <updated>Sat, 16 May 2020 13:47:21 +0000</updated>
                            <resolved>Fri, 27 Apr 2018 13:24:18 +0000</resolved>
                                                    <fixVersion>2.5.0</fixVersion>
                                    <component>io-java-cassandra</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="20400">5h 40m</timespent>
                                <comments>
                            <comment id="16328252" author="sosenko.a" created="Wed, 17 Jan 2018 04:24:12 +0000"  >&lt;p&gt;Should it really be token(pk)? I&apos;ve made it work when I hardcoded real primary key column name instead of $pk (question on Stackoverflow is mine). Is there some magic, which substitutes real primary key column name instead of pk?&lt;/p&gt;

&lt;p&gt;I can&apos;t create pull request since I don&apos;t know how to&#160;elegantly retrieve primary key column name in context of the split function. I could make an additional request to Cassandra for table description, but it seams overcomplicated to me. Is there other way to get primary key column name in context of the function?&lt;/p&gt;</comment>
                            <comment id="16328291" author="jbonofre" created="Wed, 17 Jan 2018 05:40:36 +0000"  >&lt;p&gt;I will fix that.&#160; Thanks. I&apos;m surprised as we provided IT (but probably not used).&lt;/p&gt;</comment>
                            <comment id="16437089" author="adejanovski" created="Fri, 13 Apr 2018 09:52:27 +0000"  >&lt;p&gt;I&apos;ve created a PR to fix the split generation : &lt;a href=&quot;https://github.com/apache/beam/pull/5124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/5124&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;There are other issues with&#160;how connection are established, and more precisely how many since there should be a single Cluster object generated per physical cluster and JVM, while currently we&apos;re creating Cluster objects each time one is needed.&lt;/p&gt;

&lt;p&gt;I&apos;ll create follow up tickets to handle this and expand the capabilities of both the reader (ability to add a custom where clause) and the writer (allow to use PreparedStatements instead of relying on the mapper).&lt;/p&gt;</comment>
                            <comment id="16437245" author="aromanenko" created="Fri, 13 Apr 2018 12:23:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adejanovski&quot; class=&quot;user-hover&quot; rel=&quot;adejanovski&quot;&gt;adejanovski&lt;/a&gt; Thank you for working on this. I assume that your PR fixes other two related issues as well - &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3424&quot; title=&quot;CassandraIO uses 1 split if can&amp;#39;t estimate size&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-3424&quot;&gt;&lt;del&gt;BEAM-3424&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3425&quot; title=&quot;CassandraIO fails to estimate size: Codec not found for requested operation: [varchar &amp;lt;-&amp;gt; java.lang.Long]&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-3425&quot;&gt;&lt;del&gt;BEAM-3425&lt;/del&gt;&lt;/a&gt;. Is it correct?&lt;/p&gt;</comment>
                            <comment id="16437309" author="adejanovski" created="Fri, 13 Apr 2018 13:38:17 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aromanenko&quot; class=&quot;user-hover&quot; rel=&quot;aromanenko&quot;&gt;aromanenko&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;yes both &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3424&quot; title=&quot;CassandraIO uses 1 split if can&amp;#39;t estimate size&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-3424&quot;&gt;&lt;del&gt;BEAM-3424&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3425&quot; title=&quot;CassandraIO fails to estimate size: Codec not found for requested operation: [varchar &amp;lt;-&amp;gt; java.lang.Long]&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-3425&quot;&gt;&lt;del&gt;BEAM-3425&lt;/del&gt;&lt;/a&gt; will be fixed by this PR.&lt;/p&gt;

&lt;p&gt;For &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3424&quot; title=&quot;CassandraIO uses 1 split if can&amp;#39;t estimate size&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-3424&quot;&gt;&lt;del&gt;BEAM-3424&lt;/del&gt;&lt;/a&gt;, we will have one split per token range at least, which in most &quot;modern&quot; installs will be 256 splits per node in the cluster.&#160;For clusters that do not use vnodes, we&apos;ll have one split&#160;per node in the cluster in case the size can&apos;t be estimated.&lt;/p&gt;

&lt;p&gt;We could refine this and add :&#160;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;a heuristical default of... 10 to 20 splits per node at least (for what it&apos;s worth)&lt;/li&gt;
	&lt;li&gt;and a way of enforcing a number of splits in the reader .withSplits(...)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;What do you think ?&lt;/p&gt;

&lt;p&gt;For &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3425&quot; title=&quot;CassandraIO fails to estimate size: Codec not found for requested operation: [varchar &amp;lt;-&amp;gt; java.lang.Long]&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-3425&quot;&gt;&lt;del&gt;BEAM-3425&lt;/del&gt;&lt;/a&gt;, it&apos;s fixed here as the size_estimates table was storing start_token and end_token as strings, not longs, and then those strings needed to be converted to BigInteger.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16437322" author="adejanovski" created="Fri, 13 Apr 2018 13:47:49 +0000"  >&lt;p&gt;Apparently I have test failures triggered by findbugs here : &lt;a href=&quot;https://builds.apache.org/job/beam_PreCommit_Java_GradleBuild/4104/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/beam_PreCommit_Java_GradleBuild/4104/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Any pointer on how to run the same tests locally ? Or how to check the findbugs report from Jenkins ?&lt;/p&gt;</comment>
                            <comment id="16437332" author="aromanenko" created="Fri, 13 Apr 2018 14:00:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adejanovski&quot; class=&quot;user-hover&quot; rel=&quot;adejanovski&quot;&gt;adejanovski&lt;/a&gt; Could you run this command locally? &lt;br/&gt;
&lt;tt&gt;./gradlew -p sdks/java/io/cassandra build&lt;/tt&gt;&lt;br/&gt;
I think it was caused by unused filed CassandraServiceImpl$CassandraReaderImpl.partitioner&lt;/p&gt;</comment>
                            <comment id="16437344" author="adejanovski" created="Fri, 13 Apr 2018 14:10:45 +0000"  >&lt;p&gt;Neat !&lt;/p&gt;

&lt;p&gt;It&apos;s fixed.&lt;/p&gt;</comment>
                            <comment id="16437513" author="aromanenko" created="Fri, 13 Apr 2018 16:16:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adejanovski&quot; class=&quot;user-hover&quot; rel=&quot;adejanovski&quot;&gt;adejanovski&lt;/a&gt; &lt;br/&gt;
 1. &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3424&quot; title=&quot;CassandraIO uses 1 split if can&amp;#39;t estimate size&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-3424&quot;&gt;&lt;del&gt;BEAM-3424&lt;/del&gt;&lt;/a&gt; I agree with what you suggested as a split strategy. The only concern for me is, as it was original&#160;cause from StackOverflow question, that if user runs a pipeline from local machine and Cassandra instance is located in different network, then we can&apos;t estimate number of splits reliably. So, for this case, we perhaps&#160;could to provide an option to set number of splits manually, though, Beam doesn&apos;t greet additional tuning knobs that are not very necessary. Do you think it can be another solution for this? Default options?&lt;br/&gt;
 2. &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3425&quot; title=&quot;CassandraIO fails to estimate size: Codec not found for requested operation: [varchar &amp;lt;-&amp;gt; java.lang.Long]&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-3425&quot;&gt;&lt;del&gt;BEAM-3425&lt;/del&gt;&lt;/a&gt; I&apos;m just curious if &lt;em&gt;Long&lt;/em&gt; was not enough for that?&lt;/p&gt;</comment>
                            <comment id="16437588" author="adejanovski" created="Fri, 13 Apr 2018 17:06:33 +0000"  >&lt;ol&gt;
	&lt;li&gt;So, out of experience I know that most clusters out there are running with 16 to 256 vnodes per node, times the number of nodes we&apos;re going to generate a lot of splits. Still, it would be good to be able to enforce a minimum number of splits if needed, so I&apos;d be in favor of adding it as optional input. If the computed number of splits is lower (or if Beam fails to compute it) then we should fallback to the user input.&lt;br/&gt;
Tell me if you agree and I&apos;ll add it.&lt;/li&gt;
	&lt;li&gt;It is for Murmur3 but it could be good to support the RandomPartitioner which uses tokens between 0 and 2^127-1, which should be out of the Long span.&#160;&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="16438364" author="adejanovski" created="Sat, 14 Apr 2018 14:23:41 +0000"  >&lt;p&gt;I&apos;ve just pushed a new version that allows the user to specify the minimum number of desired splits.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 31 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3oyy7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>