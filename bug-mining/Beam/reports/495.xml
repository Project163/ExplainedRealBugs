<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:48:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-3605] Kinesis ShardReadersPoolTest shouldForgetClosedShardIterator failure</title>
                <link>https://issues.apache.org/jira/browse/BEAM-3605</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;Here&apos;s one:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://builds.apache.org/job/beam_PreCommit_Java_GradleBuild/1758/testReport/junit/org.apache.beam.sdk.io.kinesis/ShardReadersPoolTest/shouldForgetClosedShardIterator/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/beam_PreCommit_Java_GradleBuild/1758/testReport/junit/org.apache.beam.sdk.io.kinesis/ShardReadersPoolTest/shouldForgetClosedShardIterator/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Filing all test failures as &quot;Critical&quot; so we can sickbay or fix.&lt;/p&gt;

&lt;p&gt;The Jenkins build will get GC&apos;d so here is the error:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.AssertionError: 
Expecting:
  &amp;lt;[&lt;span class=&quot;code-quote&quot;&gt;&quot;shard1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;shard2&quot;&lt;/span&gt;]&amp;gt;
to contain only:
  &amp;lt;[&lt;span class=&quot;code-quote&quot;&gt;&quot;shard2&quot;&lt;/span&gt;]&amp;gt;
but the following elements were unexpected:
  &amp;lt;[&lt;span class=&quot;code-quote&quot;&gt;&quot;shard1&quot;&lt;/span&gt;]&amp;gt;

	at org.apache.beam.sdk.io.kinesis.ShardReadersPoolTest.shouldForgetClosedShardIterator(ShardReadersPoolTest.java:270)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and stderr&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Feb 01, 2018 11:24:16 PM org.apache.beam.sdk.io.kinesis.ShardReadersPool readLoop
INFO: Shard iterator &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; shard1 shard is closed, finishing the read loop
org.apache.beam.sdk.io.kinesis.KinesisShardClosedException

Feb 01, 2018 11:24:16 PM org.apache.beam.sdk.io.kinesis.ShardReadersPool readLoop
INFO: Kinesis Shard read loop has finished
Feb 01, 2018 11:24:16 PM org.apache.beam.sdk.io.kinesis.ShardReadersPool readLoop
INFO: Shard iterator &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; shard1 shard is closed, finishing the read loop
org.apache.beam.sdk.io.kinesis.KinesisShardClosedException

Feb 01, 2018 11:24:16 PM org.apache.beam.sdk.io.kinesis.ShardReadersPool readLoop
INFO: Kinesis Shard read loop has finished
Feb 01, 2018 11:24:19 PM org.apache.beam.sdk.io.kinesis.ShardReadersPool readLoop
INFO: Shard iterator &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; shard1 shard is closed, finishing the read loop
org.apache.beam.sdk.io.kinesis.KinesisShardClosedException

Feb 01, 2018 11:24:19 PM org.apache.beam.sdk.io.kinesis.ShardReadersPool readLoop
INFO: Kinesis Shard read loop has finished
Feb 01, 2018 11:24:23 PM org.apache.beam.sdk.io.kinesis.ShardReadersPool readLoop
INFO: Shard iterator &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; shard1 shard is closed, finishing the read loop
org.apache.beam.sdk.io.kinesis.KinesisShardClosedException: Shard iterator reached end of the shard: streamName=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, shardId=shard1
	at org.apache.beam.sdk.io.kinesis.ShardRecordsIterator.readNextBatch(ShardRecordsIterator.java:70)
	at org.apache.beam.sdk.io.kinesis.ShardReadersPool.readLoop(ShardReadersPool.java:121)
	at org.apache.beam.sdk.io.kinesis.ShardReadersPool.lambda$startReadingShards$0(ShardReadersPool.java:112)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)

Feb 01, 2018 11:24:23 PM org.apache.beam.sdk.io.kinesis.ShardReadersPool readLoop
INFO: Kinesis Shard read loop has finished
Feb 01, 2018 11:24:23 PM org.apache.beam.sdk.io.kinesis.ShardReadersPool readLoop
INFO: Shard iterator &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; shard2 shard is closed, finishing the read loop
org.apache.beam.sdk.io.kinesis.KinesisShardClosedException: Shard iterator reached end of the shard: streamName=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, shardId=shard2
	at org.apache.beam.sdk.io.kinesis.ShardRecordsIterator.readNextBatch(ShardRecordsIterator.java:70)
	at org.apache.beam.sdk.io.kinesis.ShardReadersPool.readLoop(ShardReadersPool.java:121)
	at org.apache.beam.sdk.io.kinesis.ShardReadersPool.lambda$startReadingShards$0(ShardReadersPool.java:112)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)

Feb 01, 2018 11:24:23 PM org.apache.beam.sdk.io.kinesis.ShardReadersPool stop
INFO: Closing shard iterators pool
Feb 01, 2018 11:24:24 PM org.apache.beam.sdk.io.kinesis.ShardReadersPool readLoop
INFO: Kinesis Shard read loop has finished
Feb 01, 2018 11:24:24 PM org.apache.beam.sdk.io.kinesis.ShardReadersPool readLoop
INFO: Shard iterator &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; shard1 shard is closed, finishing the read loop
org.apache.beam.sdk.io.kinesis.KinesisShardClosedException

Feb 01, 2018 11:24:24 PM org.apache.beam.sdk.io.kinesis.ShardReadersPool readLoop
WARNING: Transient exception occurred.
org.apache.beam.sdk.io.kinesis.TransientKinesisException

Feb 01, 2018 11:24:24 PM org.apache.beam.sdk.io.kinesis.ShardReadersPool readLoop
INFO: Shard iterator &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; shard1 shard is closed, finishing the read loop
org.apache.beam.sdk.io.kinesis.KinesisShardClosedException

Feb 01, 2018 11:24:24 PM org.apache.beam.sdk.io.kinesis.ShardReadersPool readLoop
INFO: Kinesis Shard read loop has finished
Feb 01, 2018 11:24:24 PM org.apache.beam.sdk.io.kinesis.ShardReadersPool readLoop
INFO: Shard iterator &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; shard1 shard is closed, finishing the read loop
org.apache.beam.sdk.io.kinesis.KinesisShardClosedException

Feb 01, 2018 11:24:24 PM org.apache.beam.sdk.io.kinesis.ShardReadersPool readLoop
INFO: Kinesis Shard read loop has finished
Feb 01, 2018 11:24:26 PM org.apache.beam.sdk.io.kinesis.ShardReadersPool stop
INFO: Closing shard iterators pool
Feb 01, 2018 11:24:26 PM org.apache.beam.sdk.io.kinesis.ShardReadersPool readLoop
WARNING: &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; was interrupted, finishing the read loop
java.lang.InterruptedException: sleep interrupted
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(Native Method)
	at org.apache.beam.sdk.io.kinesis.ShardReadersPoolTest.lambda$shouldInterruptKinesisReadingAndStopShortly$0(ShardReadersPoolTest.java:150)
	at org.mockito.internal.stubbing.StubbedInvocationMatcher.answer(StubbedInvocationMatcher.java:34)
	at org.mockito.internal.handler.MockHandlerImpl.handle(MockHandlerImpl.java:91)
	at org.mockito.internal.handler.NullResultGuardian.handle(NullResultGuardian.java:29)
	at org.mockito.internal.handler.InvocationNotifierHandler.handle(InvocationNotifierHandler.java:38)
	at org.mockito.internal.creation.MethodInterceptorFilter.intercept(MethodInterceptorFilter.java:51)
	at org.apache.beam.sdk.io.kinesis.ShardRecordsIterator$$EnhancerByMockitoWithCGLIB$$791f33eb.readNextBatch(&amp;lt;generated&amp;gt;)
	at org.apache.beam.sdk.io.kinesis.ShardReadersPool.readLoop(ShardReadersPool.java:121)
	at org.apache.beam.sdk.io.kinesis.ShardReadersPool.lambda$startReadingShards$0(ShardReadersPool.java:112)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)

Feb 01, 2018 11:24:26 PM org.apache.beam.sdk.io.kinesis.ShardReadersPool readLoop
INFO: Kinesis Shard read loop has finished
Feb 01, 2018 11:24:26 PM org.apache.beam.sdk.io.kinesis.ShardReadersPool readLoop
INFO: Kinesis Shard read loop has finished
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13135677">BEAM-3605</key>
            <summary>Kinesis ShardReadersPoolTest shouldForgetClosedShardIterator failure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10101" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">P1</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pawel.kaczmarczyk">Pawe&#322; Kaczmarczyk</assignee>
                                    <reporter username="kenn">Kenneth Knowles</reporter>
                        <labels>
                            <label>flake</label>
                            <label>sickbay</label>
                    </labels>
                <created>Fri, 2 Feb 2018 04:03:50 +0000</created>
                <updated>Sat, 16 May 2020 13:29:27 +0000</updated>
                            <resolved>Wed, 14 Feb 2018 13:43:42 +0000</resolved>
                                                    <fixVersion>2.4.0</fixVersion>
                                    <component>io-java-kinesis</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="10200">2h 50m</timespent>
                                <comments>
                            <comment id="16354264" author="aromanenko" created="Tue, 6 Feb 2018 18:07:02 +0000"  >&lt;p&gt;The first observation. This particular test&#160;call ShardReadersPool, which handles the Kinesis shard readers, and, in its order, it&#160;spawns two threads (through ExecutorService) for two shards (one thread per shard). Then it checks that one shard was closed. So, here, seems, we have a race condition between shard thread&#160; and main thread and&#160; 200 ms of Thread.sleep() is not enough sometimes to wait until all spawn threads will be finished.&lt;/p&gt;

&lt;p&gt;Since &lt;em&gt;sleep()&lt;/em&gt; never won&apos;t be enough, I think that before calling &lt;em&gt;assert()&lt;/em&gt; we need to make sure that all spawn threads have finished their job. Perhaps, one of the way to do this is to call &lt;em&gt;shardReadersPool.stop()&lt;/em&gt;&#160;before &lt;em&gt;assert()&lt;/em&gt; because it shutdowns all spawn threads.&lt;/p&gt;

&lt;p&gt;Any thoughts?&lt;/p&gt;</comment>
                            <comment id="16354727" author="pawel.kaczmarczyk" created="Tue, 6 Feb 2018 23:36:15 +0000"  >&lt;p&gt;Hi, sorry for late reply.&lt;/p&gt;

&lt;p&gt;Is this the only test case that is flaky? I&apos;m asking because other cases in&#160;ShardReadersPoolTest also rely on sleeping some amount of time.&lt;/p&gt;

&lt;p&gt;I think calling&#160;&lt;em&gt;shardReadersPool.stop()&lt;/em&gt; should work in this case. Not sure about other test cases yet, I would have to take a second look at them. Would you like to fix it? I not, I&#160;can do it tomorrow.&lt;/p&gt;</comment>
                            <comment id="16355726" author="aromanenko" created="Wed, 7 Feb 2018 17:07:55 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pawel.kaczmarczyk&quot; class=&quot;user-hover&quot; rel=&quot;pawel.kaczmarczyk&quot;&gt;pawel.kaczmarczyk&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thank you for joining this thread.&lt;/p&gt;

&lt;p&gt;There are several opened jiras related to these flaky tests:&#160;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;ShardReadersPoolTest&lt;/em&gt;:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3598&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BEAM-3598&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3599&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BEAM-3599&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3605&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BEAM-3605&lt;/a&gt;&#160;(this one)&lt;/p&gt;

&lt;p&gt;&lt;em&gt;KinesisReaderTest&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3317&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BEAM-3317&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;But potentially, there can be more since some other tests also rely on &lt;em&gt;Thread.sleep()&lt;/em&gt;. So, perhaps, it&apos;s just a question of probability how rare they would fail.&lt;/p&gt;

&lt;p&gt;Do you think that we can avoid using &lt;em&gt;sleep()&lt;/em&gt; in these tests&#160;because,&#160;seems, it&apos;s not&#160;always reliable way for testing multithreading code?&#160;&lt;br/&gt;
 I&apos;m ok if you already have a fix for other tests and can fix them.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16357226" author="aromanenko" created="Thu, 8 Feb 2018 17:07:35 +0000"  >&lt;p&gt;I think I found a way how to fix some of these flaky tests using&#160;&lt;em&gt;CountDownLatch.&lt;/em&gt;&#160;I&apos;m going to submit PR tomorrow.&lt;/p&gt;</comment>
                            <comment id="16357623" author="pawel.kaczmarczyk" created="Thu, 8 Feb 2018 21:49:32 +0000"  >&lt;p&gt;Ok, great &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aromanenko&quot; class=&quot;user-hover&quot; rel=&quot;aromanenko&quot;&gt;aromanenko&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16360783" author="aromanenko" created="Mon, 12 Feb 2018 14:10:21 +0000"  >&lt;p&gt;Just submitted a PR&#160;(4661) which fixes&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3605&quot; title=&quot;Kinesis ShardReadersPoolTest shouldForgetClosedShardIterator failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-3605&quot;&gt;&lt;del&gt;BEAM-3605&lt;/del&gt;&lt;/a&gt;&#160;(this one) and&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3598&quot; title=&quot;kinesis.ShardReadersPoolTest.shouldStopReadersPoolAlsoWhenExceptionsOccurDuringStopping is flaky&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-3598&quot;&gt;&lt;del&gt;BEAM-3598&lt;/del&gt;&lt;/a&gt;. Also, I&#160;fixed some other tests of&#160;ShardReadersPoolTest that used&#160;&lt;em&gt;Thread.sleep()&lt;/em&gt;&#160;to use&#160;&lt;em&gt;CountDownLatch&lt;/em&gt; approach instead.&lt;/p&gt;</comment>
                            <comment id="16370144" author="aromanenko" created="Tue, 20 Feb 2018 15:32:20 +0000"  >&lt;p&gt;Finally, it was fixed by using &lt;em&gt;Mockito.timeout&lt;/em&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 38 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3pp3z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>