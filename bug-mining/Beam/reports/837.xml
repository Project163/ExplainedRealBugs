<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:53:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-4124] Support elements larger than 4 MB</title>
                <link>https://issues.apache.org/jira/browse/BEAM-4124</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;The Go SDK harness is limited by a gRPC message size limit of 4 MB.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/beam/blob/4a32353/sdks/go/pkg/beam/core/runtime/harness/datamgr.go#L31&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/blob/4a32353/sdks/go/pkg/beam/core/runtime/harness/datamgr.go#L31&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13153490">BEAM-4124</key>
            <summary>Support elements larger than 4 MB</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lostluck">Robert Burke</assignee>
                                    <reporter username="schroederc">Cody Schroeder</reporter>
                        <labels>
                    </labels>
                <created>Wed, 18 Apr 2018 21:24:19 +0000</created>
                <updated>Sat, 16 May 2020 13:48:52 +0000</updated>
                            <resolved>Mon, 5 Nov 2018 23:48:49 +0000</resolved>
                                                    <fixVersion>Not applicable</fixVersion>
                                    <component>sdk-go</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="16448454" author="herohde" created="Mon, 23 Apr 2018 17:04:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wcn3&quot; class=&quot;user-hover&quot; rel=&quot;wcn3&quot;&gt;wcn3&lt;/a&gt; Wasn&apos;t the gRPC limit raised a while ago, which would allow this limit to be much higher? &lt;/p&gt;</comment>
                            <comment id="16448498" author="schroederc" created="Mon, 23 Apr 2018 17:23:25 +0000"  >&lt;p&gt;Looks like the default is still 4MB but can be configured:&#160;&lt;a href=&quot;https://godoc.org/google.golang.org/grpc#MaxRecvMsgSize&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://godoc.org/google.golang.org/grpc#MaxRecvMsgSize&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16448517" author="wcn3" created="Mon, 23 Apr 2018 17:34:34 +0000"  >&lt;p&gt;The protocol implementation is missing the ability to segment user messages into sizes that fit into the physical channel. Java worked around this by setting the limit to ~4G. We&apos;ve preferred to keep the limit low since it hasn&apos;t caused problems in practice yet. Are you noting this as a theoretical concern, or is it getting in your way?&lt;/p&gt;

&lt;p&gt;I don&apos;t mind bumping the max message size to 20M as a stopgap, but I&apos;d like to see more emphasis on developing segmentation since this is just not going to be sustainable in the long run.&lt;/p&gt;</comment>
                            <comment id="16448560" author="schroederc" created="Mon, 23 Apr 2018 17:42:59 +0000"  >&lt;p&gt;Not theoretical; I&apos;ve actually hit the limit during experimentation.&#160; I too would prefer a more general solution, but increasing the limit in the short-term would be helpful.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Maybe the limit could be an &quot;experimental&quot; flag under user control?&lt;/p&gt;</comment>
                            <comment id="16665695" author="dfbrowne" created="Fri, 26 Oct 2018 21:46:21 +0000"  >&lt;p&gt;My team is also running into this 4MB limit under practical conditions, are there any updates on when this might be resolved?&lt;/p&gt;</comment>
                            <comment id="16669181" author="lostluck" created="Tue, 30 Oct 2018 18:42:04 +0000"  >&lt;p&gt;This needs to be better documented somewhere (likely in the grpcx package at least), but for now this Jira is the appropriate&#160;place to&#160;put the handling for it.&lt;/p&gt;

&lt;p&gt;The default cap comes from &lt;a href=&quot;https://github.com/grpc/grpc-go/blob/master/clientconn.go#L96,&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/grpc/grpc-go/blob/master/clientconn.go#L96,&lt;/a&gt;&#160;which is the 4 MB previously stated.&lt;/p&gt;

&lt;p&gt;The Beam Go SDK has a a GRPCx hook package to customize the interprocess dialer, which can use any arbitrary GRPC configuration (assuming the runner can handle things.)&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/beam/blob/master/sdks/go/pkg/beam/util/grpcx/hook.go#L45&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/blob/master/sdks/go/pkg/beam/util/grpcx/hook.go#L45&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In some package init somewhere:&lt;/p&gt;

&lt;p&gt;{{grpcx.RegisterHook(&quot;myCustomGRPCDialer&quot;, func([]string) grpcx.Hook { return grpcx.Hook&lt;/p&gt;
{Dialer: DialContext}
&lt;p&gt;)}}&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;// DialContext is an override for grpc.Dial that&#160;increases received message size.&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;func DialContext(ctx context.Context, endpoint string, timeout time.Duration) (*grpc.ClientConn, error) {&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; ctx, cancel := context.WithTimeout(ctx, timeout)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; defer cancel()&lt;/tt&gt;&lt;tt&gt;&#160; config := grpc.DefaultDialConfig()&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; cc, err := grpc.DialContext(ctx, endpoint,&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; grpc.WithDefaultCallOptions(&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; &#160; grpc.MaxCallRecvMsgSize(1000&amp;lt;&amp;lt;20))) // Cap received messages to 1 GB (1000 * 2^20)&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; if err != nil {&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;&#160; &#160; return nil, fmt.Errorf(&quot;failed to dial server at %v: %v&quot;, endpoint, err)&lt;/tt&gt;&lt;br/&gt;
 {&lt;/p&gt;

{&#160; }

&lt;p&gt;}}&lt;br/&gt;
 &lt;tt&gt;&#160; return cc, nil&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;}&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;Somewhere after beam.Init:&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;grpcx.EnableHook(&quot;myCustomGRPCDialer&quot;)&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;Given there are performance implications around this, we&apos;re likely to simply keep the default GRPC connections generally, and require the runners to handle these choices&#160;as appropriate for the runner. This does mean that at some point the Dataflow runner might override the dialer context, but in that instance, it would probably make it a bit more configurable. Similar for the in progress flink runner, and others. We&apos;ll know more once Portability has settled.&lt;/p&gt;</comment>
                            <comment id="16669201" author="dfbrowne" created="Tue, 30 Oct 2018 18:57:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lostluck&quot; class=&quot;user-hover&quot; rel=&quot;lostluck&quot;&gt;lostluck&lt;/a&gt; the issue we&apos;re running into right now is the error thrown by the harness here: &lt;a href=&quot;https://github.com/apache/beam/blob/4a32353/sdks/go/pkg/beam/core/runtime/harness/datamgr.go#L291&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/blob/4a32353/sdks/go/pkg/beam/core/runtime/harness/datamgr.go#L291&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This limit does not appear to be configurable with gRPC hooks.&lt;/p&gt;</comment>
                            <comment id="16669379" author="lostluck" created="Tue, 30 Oct 2018 21:56:19 +0000"  >&lt;p&gt;You are correct, and this is on the Sending direction, rather than the Receiving direction. The comment on that line is wrong about being on the &quot;incoming&quot; message, but instead is about an outgoing one.&lt;/p&gt;

&lt;p&gt;I&apos;ll need to see how it fails without it, but I&apos;d be inclined to avoid beam making assumptions about the transport at this point, and rely on the more easily overridable GRPC mechanism. I forgot about that limitation.&lt;/p&gt;

&lt;p&gt;Beam Go is&#160;doing its own buffering ahead of the GRPC stream to batch small elements, rather than trying to send a single element each time.&lt;/p&gt;

&lt;p&gt;Ultimately there&apos;s a 2GB limit, due to various protocol buffer restrictions, but setting it that high means that entire bundles might get batched instead of sending&lt;/p&gt;

&lt;p&gt;Thanks to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lcwik&quot; class=&quot;user-hover&quot; rel=&quot;lcwik&quot;&gt;lcwik&lt;/a&gt; I found the Portability document about properly handling large elements:&lt;br/&gt;
&lt;a href=&quot;https://docs.google.com/document/d/1IGduUqmhWDi_69l9nG8kw73HZ5WI5wOps9Tshl5wpQA/edit#heading=h.akxviyj4m0f0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.google.com/document/d/1IGduUqmhWDi_69l9nG8kw73HZ5WI5wOps9Tshl5wpQA/edit#heading=h.akxviyj4m0f0&lt;/a&gt;&#160;&lt;br/&gt;
But no runner implements this yet.&lt;/p&gt;

&lt;p&gt;So, in principle we want the ~4MB limit so that elements beyond that aren&apos;t cached until the bundle is completed (which keeps progress moving forward, and not wasting network), but from the 4MB (some lower bound) -&amp;gt; ~2GB (upper bound) range, we could do the &quot;simple&quot; thing, and flush immediately, instead of failing. Obviously this would be a problem for elements &amp;gt; 2GB in size, but then I&apos;d argue one shouldn&apos;t be processing them quite like that with beam. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;&lt;br/&gt;
This wouldn&apos;t avoid the need for a tuning parameter for some users (eg. Who may prefer larger than 4MB batches for perf reasons), but it certainly punts needing it for all users, where any element &amp;gt; 4MB being sent alone is fine.&lt;/p&gt;

&lt;p&gt;That would be also independent of the GRPC Send Size, which defaults to MaxInt, so it should be workable. The Receive cap would need to be adjusted accordingly by users who run into this issue though, since returning back through GBK would cause that limit to be hit for the stream of elements.&lt;/p&gt;</comment>
                            <comment id="16669402" author="dfbrowne" created="Tue, 30 Oct 2018 22:35:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lostluck&quot; class=&quot;user-hover&quot; rel=&quot;lostluck&quot;&gt;lostluck&lt;/a&gt; I share the sentiment that we should probably be relying on gRPC to impose these transport limitations. My team is currently trying to get a Beam Go pipeline operational which regularly works with protos on the order of 20MB, nothing too crazy, but certainly larger than 4MB.&#160;Are you willing to take ownership of this issue and help lift the non-configurable limits? If not, how do you recommend we proceed given that we have a strong need to use Beam Go for our application in the near future?&lt;/p&gt;</comment>
                            <comment id="16670326" author="lostluck" created="Wed, 31 Oct 2018 16:15:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dfbrowne&quot; class=&quot;user-hover&quot; rel=&quot;dfbrowne&quot;&gt;dfbrowne&lt;/a&gt; I was chatting with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wcn3&quot; class=&quot;user-hover&quot; rel=&quot;wcn3&quot;&gt;wcn3&lt;/a&gt; and he expressed interest in tackling this. Otherwise I&apos;ll get this done next week.&lt;/p&gt;</comment>
                            <comment id="16675454" author="wcn3" created="Mon, 5 Nov 2018 17:24:45 +0000"  >&lt;p&gt;I agree with the consensus that the Beam code shouldn&apos;t be enforcing the transport limits, but it needs to have some awareness of them, and that mechanism doesn&apos;t currently exist.&lt;/p&gt;

&lt;p&gt;Given what&apos;s been done to support larger messages in the Java code, the only current restriction is the code in datamgr.go that was previously identified. The intent of that code was to provide a friendlier error message than what occurred if the gRPC max was hit.&lt;/p&gt;

&lt;p&gt;I think it&apos;s totally reasonable to remove the check in datamgr.go since it&apos;s providing zero value at this juncture.&lt;/p&gt;

&lt;p&gt;More work does need to be done on a segmentation protocol for larger messages, and that protocol needs to be able to discover the limitations of the underlying transport (for example, could be TWIRP instead of gRPC). It should also have some affordances for intelligently buffering data to avoid thrashing the underlying transport, but also not buffer data so much that latency-critical messages get delayed and cause problems in workflow execution. The RFCs for TCP provide all sorts of guidance for these scenarios, and any design doc for a flexible Beam transport layer should compare and contrast its proposals to TCP.&lt;/p&gt;

&lt;p&gt;Speaking to a point Robert made earlier, the hard limit on messaging is provided by the use of protocol buffers, so there can&apos;t be an element &amp;gt; 2 GB in size without the user&apos;s code doing something to manage the spillover in size.&lt;/p&gt;

&lt;p&gt;The constraint that Beam must satisfy is to ensure that any valid protocol buffer can be transmitted. Removing the artificial restriction in datamgr.go is sufficient to achieve that constraint. The remaining work I describe is just performance improvements on top of the basic correctness guarantee. Therefore, it&apos;s reasonable to just remove the code now and plan for the better future and address it as we can.&lt;/p&gt;</comment>
                            <comment id="16675895" author="lostluck" created="Mon, 5 Nov 2018 23:48:21 +0000"  >&lt;p&gt;With&#160;&lt;a href=&quot;https://github.com/apache/beam/pull/6948&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;GitHub Pull Request #6948&lt;/a&gt;&#160;in, this should no longer be an issue up to the Proto + GRPC configuration (on both the Go SDK and Runner Harness sides) limits, until the FnAPI codification of extremely large elements is handled.&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ve filed&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-5977&quot; title=&quot;Benchmark buffer use in the Go SDK Harness&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-5977&quot;&gt;&lt;del&gt;BEAM-5977&lt;/del&gt;&lt;/a&gt; for subsequent benchmarking and performance work in this part of the hot path.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 2 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3sqb3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>