<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:51:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-4861] Hadoop Filesystem silently fails</title>
                <link>https://issues.apache.org/jira/browse/BEAM-4861</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;beam Filesystem operations copy, rename and delete are void in SDK. Hadoop native filesystem operations are not and returns void. Current implementation in Beam ignores the result and pass as long as exception is not thrown.&lt;/p&gt;

&lt;p&gt;I got burned by this when using &apos;rename&apos; to do a &apos;move&apos; operation on HDFS. If target directory does not exists, operations returns false and do not touch the file.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/beam/blob/master/sdks/java/io/hadoop-file-system/src/main/java/org/apache/beam/sdk/io/hdfs/HadoopFileSystem.java#L148&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/blob/master/sdks/java/io/hadoop-file-system/src/main/java/org/apache/beam/sdk/io/hdfs/HadoopFileSystem.java#L148&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13174369">BEAM-4861</key>
            <summary>Hadoop Filesystem silently fails</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="timrobertson100">Tim Robertson</assignee>
                                    <reporter username="JozoVilcek">Jozef Vilcek</reporter>
                        <labels>
                    </labels>
                <created>Wed, 25 Jul 2018 14:07:31 +0000</created>
                <updated>Sat, 16 May 2020 13:51:12 +0000</updated>
                            <resolved>Wed, 19 Sep 2018 15:07:18 +0000</resolved>
                                                    <fixVersion>2.8.0</fixVersion>
                                    <component>io-java-hadoop-file-system</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4800">1h 20m</timespent>
                                <comments>
                            <comment id="16590032" author="timrobertson100" created="Thu, 23 Aug 2018 10:19:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chamikara&quot; class=&quot;user-hover&quot; rel=&quot;chamikara&quot;&gt;chamikara&lt;/a&gt; &#160;-&#160;may I take this issue please as I am looking at&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-5036&quot; title=&quot;Optimize FileBasedSink&amp;#39;s WriteOperation.moveToOutput()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-5036&quot;&gt;&lt;del&gt;BEAM-5036&lt;/del&gt;&lt;/a&gt;&#160;which is related?&lt;/p&gt;</comment>
                            <comment id="16593406" author="timrobertson100" created="Mon, 27 Aug 2018 09:44:26 +0000"  >&lt;p&gt;The &lt;tt&gt;HadoopFileSystem&lt;/tt&gt; has&#160;the following methods:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void copy(List&amp;lt;HadoopResourceId&amp;gt; srcResourceIds, List&amp;lt;HadoopResourceId&amp;gt; destResourceIds)
      &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; srcResourceIds.size(); ++i) {
      &lt;span class=&quot;code-comment&quot;&gt;// Unfortunately HDFS FileSystems don&apos;t support a &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; copy operation so we are forced
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// to use the inefficient implementation found in FileUtil which copies all the bytes through
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// the local machine.
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;//
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// HDFS FileSystem does define a concat method but could only find the DFSFileSystem
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// implementing it. The DFSFileSystem implemented concat by deleting the srcs after which
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// is not what we want. Also, all the other FileSystem implementations I saw threw
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// UnsupportedOperationException within concat.
&lt;/span&gt;      FileUtil.copy(
          fileSystem,
          srcResourceIds.get(i).toPath(),
          fileSystem,
          destResourceIds.get(i).toPath(),
          &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;,
          &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;,
          fileSystem.getConf());
    }
  }

  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void rename(
      List&amp;lt;HadoopResourceId&amp;gt; srcResourceIds, List&amp;lt;HadoopResourceId&amp;gt; destResourceIds)
      &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; srcResourceIds.size(); ++i) {
      fileSystem.rename(srcResourceIds.get(i).toPath(), destResourceIds.get(i).toPath());
    }
  }

  @Override
  &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; void delete(Collection&amp;lt;HadoopResourceId&amp;gt; resourceIds) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (HadoopResourceId resourceId : resourceIds) {
      fileSystem.delete(resourceId.toPath(), &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
    }
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;tt&gt;FileUtil.copy&lt;/tt&gt;, &lt;tt&gt;fileSystem.rename&lt;/tt&gt;&#160;and &lt;tt&gt;fileSystem.delete&lt;/tt&gt; can all return false indicating that the operation was not performed.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;1. Informing the user of the&#160;unsuccessful&#160;operation&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;We could either:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Change the Beam &lt;tt&gt;FileSystem&lt;/tt&gt;&#160;API to propagate this, although the &lt;a href=&quot;https://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-common/filesystem/filesystem.html#boolean_renamePath_src_Path_d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;rules for HDFS rename()&lt;/a&gt; are not trivial to document and this might prove to be invasive in many places.&lt;/li&gt;
	&lt;li&gt;Throw an &lt;tt&gt;IOException&lt;/tt&gt; to signal that the operation was not successful if the response is false?&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I tend towards suggesting leaving the API to return void but throw an exception on the first case of error within the loops - thoughts?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;2. rename() in HDFS&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;What do we believe are the expectations for &lt;tt&gt;rename()&lt;/tt&gt; on HDFS?&lt;/p&gt;

&lt;p&gt;Currently the user is not informed that nothing happens if an attempt to rename a file into a non existent directory is made. This is obviously bad.&lt;/p&gt;

&lt;p&gt;We could change behaviour to one of:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Throw exception if the directory does not exist&lt;/li&gt;
	&lt;li&gt;Create the directory where necessary, letting existing files be overridden (equivalent of e.g. &lt;tt&gt;S3Filesystem&lt;/tt&gt;)&lt;/li&gt;
	&lt;li&gt;Verify that the directory does not exist, and only then create it and proceed, otherwise alerting with Exception (the usual behaviour of a &lt;tt&gt;MapReduce / Spark FileOutputFormat&lt;/tt&gt; at job startup where it quickly fails with &quot;directory already exists&quot;).&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Note that &lt;tt&gt;S3FileSystem&lt;/tt&gt; and &lt;tt&gt;GcsFileSystem&lt;/tt&gt;&#160;treat a rename as a &lt;tt&gt;copy()&lt;/tt&gt; and &lt;tt&gt;delete()&lt;/tt&gt; operation internally.&lt;/p&gt;

&lt;p&gt;I tend towards creating the directory where necessary allowing for overwriting - thoughts?&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reuvenlax&quot; class=&quot;user-hover&quot; rel=&quot;reuvenlax&quot;&gt;reuvenlax&lt;/a&gt; as relates to &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-5036&quot; title=&quot;Optimize FileBasedSink&amp;#39;s WriteOperation.moveToOutput()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-5036&quot;&gt;&lt;del&gt;BEAM-5036&lt;/del&gt;&lt;/a&gt; as well.&lt;/p&gt;</comment>
                            <comment id="16593447" author="jozovilcek" created="Mon, 27 Aug 2018 10:19:55 +0000"  >&lt;p&gt;For unsuccessful operation, I would throw exception as well. In practice, this is what is mostly done around the native HDFS boolean&#160;methods by helpers. Fail and investigate later what was wrong.&lt;/p&gt;

&lt;p&gt;For rename, create directories where necessary sounds good. Plus with allowing overwrites, behaviour would be consistent with&#160;what I observe on &quot;normal file create&quot; operations. Allow overwrite is&#160;maybe allowed for cases or restarting jobs form snapshots which can lead to reprocessing and recreating same outputs again? Not sure.&lt;/p&gt;</comment>
                            <comment id="16594794" author="timrobertson100" created="Tue, 28 Aug 2018 10:24:43 +0000"  >&lt;p&gt;On further inspection I think &lt;tt&gt;delete&lt;/tt&gt; is&#160;correct to swallow a &lt;tt&gt;false&lt;/tt&gt;&#160;response &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=JozoVilcek&quot; class=&quot;user-hover&quot; rel=&quot;JozoVilcek&quot;&gt;JozoVilcek&lt;/a&gt;&#160;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A &lt;tt&gt;delete&lt;/tt&gt;&#160;for example will return &lt;tt&gt;false&lt;/tt&gt; when you try and delete a non existing file which seems reasonable to swallow. It will throw exception for the scenarios that mater.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The &lt;tt&gt;copy&lt;/tt&gt; seems indifferent, so we might as well throw exception to be cautious:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The &lt;tt&gt;copy&lt;/tt&gt; returns&#160;false&#160;only if there is issue with &lt;tt&gt;mkdirs&lt;/tt&gt; and the HDFS docs &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;&#160;state that it always returns true.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;For &lt;tt&gt;rename()&lt;/tt&gt; we can create the directory if not existing&#160;and then should throw exception on any response that is false.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-common/filesystem/filesystem.html#boolean_renamePath_src_Path_d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hadoop.apache.org/docs/current/hadoop-project-dist/hadoop-common/filesystem/filesystem.html#boolean_renamePath_src_Path_d&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16594868" author="jozovilcek" created="Tue, 28 Aug 2018 11:49:27 +0000"  >&lt;p&gt;Yes, make sense to me&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 11 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3w9r3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>