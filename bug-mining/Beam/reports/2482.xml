<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:18:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-6516] Failed to advance source: org.apache.beam.sdk.io.rabbitmq.RabbitMqIO</title>
                <link>https://issues.apache.org/jira/browse/BEAM-6516</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;I&apos;m using the RabbitMqIO connector to get messages from RabbitMQ to BigQuery in my current pipeline. When I submit my pipeline to Dataflow, the messages are propagated correctly to BigQuery, however I&apos;m getting the following log error entry in Dataflow which is repeating itself:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;

java.io.IOException: Failed to advance source: org.apache.beam.sdk.io.rabbitmq.RabbitMqIO$RabbitMQSource@1cdd077d
        org.apache.beam.runners.dataflow.worker.WorkerCustomSources$UnboundedReaderIterator.advance(WorkerCustomSources.java:806)
        org.apache.beam.runners.dataflow.worker.WorkerCustomSources$UnboundedReaderIterator.start(WorkerCustomSources.java:776)
        org.apache.beam.runners.dataflow.worker.util.common.worker.ReadOperation$SynchronizedReaderIterator.start(ReadOperation.java:361)
        org.apache.beam.runners.dataflow.worker.util.common.worker.ReadOperation.runReadLoop(ReadOperation.java:194)
        org.apache.beam.runners.dataflow.worker.util.common.worker.ReadOperation.start(ReadOperation.java:159)
        org.apache.beam.runners.dataflow.worker.util.common.worker.MapTaskExecutor.execute(MapTaskExecutor.java:76)
        org.apache.beam.runners.dataflow.worker.StreamingDataflowWorker.process(StreamingDataflowWorker.java:1228)
        org.apache.beam.runners.dataflow.worker.StreamingDataflowWorker.access$1000(StreamingDataflowWorker.java:143)
        org.apache.beam.runners.dataflow.worker.StreamingDataflowWorker$6.run(StreamingDataflowWorker.java:967)
        java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
        java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
        java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: java.io.IOException: com.rabbitmq.client.ShutdownSignalException: channel error; protocol method: #method&amp;lt;channel.close&amp;gt;(reply-code=406, reply-text=PRECONDITION_FAILED - unknown delivery tag 1, &lt;span class=&quot;code-keyword&quot;&gt;class-&lt;/span&gt;id=60, method-id=80)
        org.apache.beam.sdk.io.rabbitmq.RabbitMqIO$UnboundedRabbitMqReader.advance(RabbitMqIO.java:474)
        org.apache.beam.runners.dataflow.worker.WorkerCustomSources$UnboundedReaderIterator.advance(WorkerCustomSources.java:801)
        org.apache.beam.runners.dataflow.worker.WorkerCustomSources$UnboundedReaderIterator.start(WorkerCustomSources.java:776)
        org.apache.beam.runners.dataflow.worker.util.common.worker.ReadOperation$SynchronizedReaderIterator.start(ReadOperation.java:361)
        org.apache.beam.runners.dataflow.worker.util.common.worker.ReadOperation.runReadLoop(ReadOperation.java:194)
        org.apache.beam.runners.dataflow.worker.util.common.worker.ReadOperation.start(ReadOperation.java:159)
        org.apache.beam.runners.dataflow.worker.util.common.worker.MapTaskExecutor.execute(MapTaskExecutor.java:76)
        org.apache.beam.runners.dataflow.worker.StreamingDataflowWorker.process(StreamingDataflowWorker.java:1228)
        org.apache.beam.runners.dataflow.worker.StreamingDataflowWorker.access$1000(StreamingDataflowWorker.java:143)
        org.apache.beam.runners.dataflow.worker.StreamingDataflowWorker$6.run(StreamingDataflowWorker.java:967)
        java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
        java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
        java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: com.rabbitmq.client.ShutdownSignalException: channel error; protocol method: #method&amp;lt;channel.close&amp;gt;(reply-code=406, reply-text=PRECONDITION_FAILED - unknown delivery tag 1, &lt;span class=&quot;code-keyword&quot;&gt;class-&lt;/span&gt;id=60, method-id=80)
        com.rabbitmq.client.QueueingConsumer.handle(QueueingConsumer.java:206)
        com.rabbitmq.client.QueueingConsumer.nextDelivery(QueueingConsumer.java:237)
        org.apache.beam.sdk.io.rabbitmq.RabbitMqIO$UnboundedRabbitMqReader.advance(RabbitMqIO.java:451)
        org.apache.beam.runners.dataflow.worker.WorkerCustomSources$UnboundedReaderIterator.advance(WorkerCustomSources.java:801)
        org.apache.beam.runners.dataflow.worker.WorkerCustomSources$UnboundedReaderIterator.start(WorkerCustomSources.java:776)
        org.apache.beam.runners.dataflow.worker.util.common.worker.ReadOperation$SynchronizedReaderIterator.start(ReadOperation.java:361)
        org.apache.beam.runners.dataflow.worker.util.common.worker.ReadOperation.runReadLoop(ReadOperation.java:194)
        org.apache.beam.runners.dataflow.worker.util.common.worker.ReadOperation.start(ReadOperation.java:159)
        org.apache.beam.runners.dataflow.worker.util.common.worker.MapTaskExecutor.execute(MapTaskExecutor.java:76)
        org.apache.beam.runners.dataflow.worker.StreamingDataflowWorker.process(StreamingDataflowWorker.java:1228)
        org.apache.beam.runners.dataflow.worker.StreamingDataflowWorker.access$1000(StreamingDataflowWorker.java:143)
        org.apache.beam.runners.dataflow.worker.StreamingDataflowWorker$6.run(StreamingDataflowWorker.java:967)
        java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
        java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
        java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: com.rabbitmq.client.ShutdownSignalException: channel error; protocol method: #method&amp;lt;channel.close&amp;gt;(reply-code=406, reply-text=PRECONDITION_FAILED - unknown delivery tag 1, &lt;span class=&quot;code-keyword&quot;&gt;class-&lt;/span&gt;id=60, method-id=80)
        com.rabbitmq.client.impl.ChannelN.asyncShutdown(ChannelN.java:515)
        com.rabbitmq.client.impl.ChannelN.processAsync(ChannelN.java:340)
        com.rabbitmq.client.impl.AMQChannel.handleCompleteInboundCommand(AMQChannel.java:162)
        com.rabbitmq.client.impl.AMQChannel.handleFrame(AMQChannel.java:109)
        com.rabbitmq.client.impl.AMQConnection.readFrame(AMQConnection.java:676)
        com.rabbitmq.client.impl.AMQConnection.access$300(AMQConnection.java:48)
        com.rabbitmq.client.impl.AMQConnection$MainLoop.run(AMQConnection.java:603)
        java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It seems to me the issue is ACKing messages:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
reply-code=406, reply-text=PRECONDITION_FAILED - unknown delivery tag 1, &lt;span class=&quot;code-keyword&quot;&gt;class-&lt;/span&gt;id=60, method-id=80
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I also see a lot of open channels (~90) in the RabbitMQ management interface (see attached screenshot).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13212017">BEAM-6516</key>
            <summary>Failed to advance source: org.apache.beam.sdk.io.rabbitmq.RabbitMqIO</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10103" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">P3</priority>
                        <status id="10722" iconUrl="https://issues.apache.org/jira/images/icons/statuses/generic.png" description="">Triage Needed</status>
                    <statusCategory id="2" key="new" colorName="blue-gray"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="edin">Edin</reporter>
                        <labels>
                    </labels>
                <created>Sat, 26 Jan 2019 13:46:59 +0000</created>
                <updated>Thu, 13 Apr 2023 11:06:16 +0000</updated>
                            <resolved>Thu, 5 Aug 2021 11:01:38 +0000</resolved>
                                                    <fixVersion>2.33.0</fixVersion>
                                    <component>io-java-rabbitmq</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7200">2h</timespent>
                                <comments>
                            <comment id="16793562" author="alafanechere" created="Fri, 15 Mar 2019 11:40:44 +0000"  >&lt;p&gt;I encounter the exact same problem. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=edin&quot; class=&quot;user-hover&quot; rel=&quot;edin&quot;&gt;edin&lt;/a&gt;&#160;have you found a way to solve this ?&lt;/p&gt;</comment>
                            <comment id="16793569" author="edin" created="Fri, 15 Mar 2019 11:54:20 +0000"  >&lt;p&gt;I didn&apos;t look into it, so unfortunately no solution yet AFAIK.&lt;/p&gt;</comment>
                            <comment id="16843935" author="riduidel" created="Mon, 20 May 2019 12:51:11 +0000"  >&lt;p&gt;is it possible for you to provide some help/guidance for people wanting o fix that bug ?&lt;/p&gt;</comment>
                            <comment id="16844004" author="riduidel" created="Mon, 20 May 2019 14:21:07 +0000"  >&lt;p&gt;If I understand correctly, when i create a RabbitMqIO.Read object, the start method is invoked. This start method creates a channel object, which is a communication channel between the dataflow executor and my RabbitMQ messaging system.&lt;/p&gt;

&lt;p&gt;When the RabbitMQIO.Read.advance() method is invoked, we wait for the next available message on RabbitMQ and the message delivery tag (well, if one message was read) is added to Beam checkpointMark.&lt;/p&gt;

&lt;p&gt;When the checkpointMark is finalized, all the devlivery tag are acknowledged, which mark the messages as consumed. This is, i guess, the normal process (at least, what i describe is compatible with both source code &lt;b&gt;and&lt;/b&gt; stack trace exposed here).&lt;/p&gt;

&lt;p&gt;The problem we have here is the last part of exception&lt;/p&gt;


&lt;p&gt;{{ Caused by: com.rabbitmq.client.ShutdownSignalException: channel error; protocol method: #method&amp;lt;channel.close&amp;gt;(reply-code=406, reply-text=PRECONDITION_FAILED - unknown delivery tag 1, class-id=60, method-id=80)}}&lt;br/&gt;
{{ com.rabbitmq.client.impl.ChannelN.asyncShutdown(ChannelN.java:515)}}&lt;br/&gt;
{{ com.rabbitmq.client.impl.ChannelN.processAsync(ChannelN.java:340)}}&lt;br/&gt;
{{ com.rabbitmq.client.impl.AMQChannel.handleCompleteInboundCommand(AMQChannel.java:162)}}&lt;br/&gt;
{{ com.rabbitmq.client.impl.AMQChannel.handleFrame(AMQChannel.java:109)}}&lt;br/&gt;
{{ com.rabbitmq.client.impl.AMQConnection.readFrame(AMQConnection.java:676)}}&lt;br/&gt;
{{ com.rabbitmq.client.impl.AMQConnection.access$300(AMQConnection.java:48)}}&lt;br/&gt;
{{ com.rabbitmq.client.impl.AMQConnection$MainLoop.run(AMQConnection.java:603)}}&lt;br/&gt;
{{ java.lang.Thread.run(Thread.java:745)}}&lt;/p&gt;


&lt;p&gt; Which is the reale xception cause.&lt;/p&gt;

&lt;p&gt;According to RabbitMQ mailing-list (see this message, typically,&#160;&lt;a href=&quot;http://rabbitmq.1065348.n5.nabble.com/reply-code-406-reply-text-PRECONDITION-FAILED-unknown-delivery-tag-td21310.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://rabbitmq.1065348.n5.nabble.com/reply-code-406-reply-text-PRECONDITION-FAILED-unknown-delivery-tag-td21310.html)&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Apart from the unlikely scenario of the client application randomly &lt;br/&gt;
 inventing delivery tags and submitting acks, the probable causes are:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ack&apos;ing the same message twice&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ack&apos;ing on a channel other than the one the messages was received on &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ack&apos;ing a message when it was consumed in no-ack mode&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;all the above but using basic.reject, basic.nack instead of basic.ack,&lt;br/&gt;
 or a combination of the three (e.g. rejecting a message and then ack&apos;ing it)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; this is a common occurrence in applications with naive error &lt;br/&gt;
 recovery logic that re-establishes connections&amp;amp;channels transparently &lt;br/&gt;
 behind the scenes.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I do not have here sufficient knowledge of Apache Beam threading model, but I suspect there is something weird (and linked to multithread) in RabbitMQCheckpointMark#finalizeCheckpoint()&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17122950" author="beamjirabot" created="Tue, 2 Jun 2020 04:15:21 +0000"  >&lt;p&gt;This issue is P2 but has been unassigned without any comment for 60 days so it has been labeled &quot;stale-P2&quot;. If this issue is still affecting you, we care! Please comment and remove the label. Otherwise, in 14 days the issue will be moved to P3.&lt;/p&gt;

&lt;p&gt;Please see &lt;a href=&quot;https://beam.apache.org/contribute/jira-priorities/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://beam.apache.org/contribute/jira-priorities/&lt;/a&gt; for a detailed explanation of what these priorities mean.&lt;/p&gt;</comment>
                            <comment id="17137400" author="beamjirabot" created="Tue, 16 Jun 2020 17:26:44 +0000"  >&lt;p&gt;This issue was marked &quot;stale-P2&quot; and has not received a public comment in 14 days. It is now automatically moved to P3. If you are still affected by it, you can comment and move it back to P2.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12956460" name="Screenshot 2019-01-26 at 20.11.41.png" size="375408" author="edin" created="Sat, 26 Jan 2019 19:12:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 21 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|yi0ci8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>