<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:53:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-5725] ElasticsearchIO RetryConfiguration response parse failure</title>
                <link>https://issues.apache.org/jira/browse/BEAM-5725</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;When using .withRetryConfiguration() for ElasticsearchIO, I get the following stacktrace:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: com.fasterxml.jackson.databind.exc.MismatchedInputException: No content to map due to end-of-input
at [Source: (org.apache.http.nio.entity.ContentInputStream); line: 1, column: 0]
at com.fasterxml.jackson.databind.exc.MismatchedInputException.from(MismatchedInputException.java:59)
at com.fasterxml.jackson.databind.ObjectMapper._initForReading(ObjectMapper.java:4133)
at com.fasterxml.jackson.databind.ObjectMapper._readMapAndClose(ObjectMapper.java:3988)
at com.fasterxml.jackson.databind.ObjectMapper.readValue(ObjectMapper.java:3058)
at org.apache.beam.sdk.io.elasticsearch.ElasticsearchIO.parseResponse(ElasticsearchIO.java:173)
at org.apache.beam.sdk.io.elasticsearch.ElasticsearchIO.checkForErrors(ElasticsearchIO.java:177)
at org.apache.beam.sdk.io.elasticsearch.ElasticsearchIO$Write$WriteFn.flushBatch(ElasticsearchIO.java:1204)
at org.apache.beam.sdk.io.elasticsearch.ElasticsearchIO$Write$WriteFn.finishBundle(ElasticsearchIO.java:1175)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Probably&#160;the elastic response object&apos;s content stream is consumed twice, resulting in a MismatchedInputException.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13191126">BEAM-5725</key>
            <summary>ElasticsearchIO RetryConfiguration response parse failure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="wouts">Wout Scheepers</assignee>
                                    <reporter username="wouts">Wout Scheepers</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Oct 2018 06:27:11 +0000</created>
                <updated>Sat, 16 May 2020 13:54:20 +0000</updated>
                            <resolved>Wed, 7 Nov 2018 08:46:05 +0000</resolved>
                                                    <fixVersion>2.9.0</fixVersion>
                                    <component>io-java-elasticsearch</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3600">1h</timespent>
                                <comments>
                            <comment id="16668334" author="timrobertson100" created="Tue, 30 Oct 2018 08:31:25 +0000"  >&lt;p&gt;Copying from the user@ mailing list:&lt;/p&gt;

&lt;p&gt;I took a super quick look at the code:.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;On a&#160;retry&#160;scenario it calls handleRetry()&lt;/li&gt;
	&lt;li&gt;Within handleRetry() it gets the DefaultRetryPredicate and calls test(response) - this reads the response stream to JSON&lt;/li&gt;
	&lt;li&gt;When the&#160;retry&#160;is successful (no 429 code) the response is returned&lt;/li&gt;
	&lt;li&gt;The response is then passed in to checkForErrors(...)&lt;/li&gt;
	&lt;li&gt;This then tried to parse the response by reading the response stream. It was already read in step 2 hence the stream cannot be read again&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wouts&quot; class=&quot;user-hover&quot; rel=&quot;wouts&quot;&gt;wouts&lt;/a&gt; - this is something we also would like to see addressed. 2.9.0 will be cut in 3 weeks - shall we aim for that?&#160;&lt;br/&gt;
Are you still keen to fix it, or would you like us to&#160;look? (CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aalbatross&quot; class=&quot;user-hover&quot; rel=&quot;aalbatross&quot;&gt;aalbatross&lt;/a&gt; for info too).&lt;/p&gt;</comment>
                            <comment id="16668356" author="wouts" created="Tue, 30 Oct 2018 08:39:35 +0000"  >&lt;p&gt;I&apos;m still keen to fix it, will allocate some time for it this week.&lt;/p&gt;</comment>
                            <comment id="16670108" author="wouts" created="Wed, 31 Oct 2018 13:30:24 +0000"  >&lt;p&gt;I&apos;ve been digging into it and came up with the following so far:&lt;/p&gt;

&lt;p&gt;As Tim already pointed out, the problem here is that parseResponse(response) is indeed not repeatable, the content can only be consumed once as the Elastic Response object encapsulates a HttpEntity object.&lt;br/&gt;
 I added a reproducible unit test&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;, which tries to insert a valid document with the retryConfiguration set. &lt;br/&gt;
 It becomes clear that handleRetry() does not have to be called for the bug to appear.&lt;/p&gt;

&lt;p&gt;My first thought on a solution was to use the reset() method on the InputStream of the Entity content, however, this is not supported for the InputStream used in HttpEntity.&lt;/p&gt;

&lt;p&gt;A possible solution would be the following:&lt;br/&gt;
 Encapsulate the Response object in a wrapper object, making sure the content of the HttpEntity object can be parsed repeatable.&lt;br/&gt;
 I think the best way to do this is by implementing a BufferedHttpEntity&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; in the wrapper.&lt;/p&gt;

&lt;p&gt;This can be done either only in the case a retryConfiguration is set, but I guess it&apos;s probably better to create a wrapper for the response objects everywhere in the ElasticSearchIO class?&lt;/p&gt;

&lt;p&gt;Is there a better or more elegant solution for this?&lt;/p&gt;

&lt;p&gt;I&apos;ve also found a way of getting control on how to read bytes from the buffer in elastic docs&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt; but I&apos;m not sure it can be of any help (it&apos;s for async calls, not sure they are used in ElasticSearchIO):&lt;br/&gt;
 &quot;... As for reading the response body, the HttpEntity#getContent method comes handy which returns an InputStream reading from the previously buffered response body. As an alternative, it is possible to provide a custom org.apache.http.nio.protocol.HttpAsyncResponseConsumer that controls how bytes are read and buffered. ...&quot;&lt;/p&gt;

&lt;p&gt;I&apos;m happy to get some thoughts on a good solution.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
 Wout&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/wscheep/beam/commit/8f2093066a2908f0472983cfc640bc7644b728d9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/wscheep/beam/commit/8f2093066a2908f0472983cfc640bc7644b728d9&lt;/a&gt;&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://hc.apache.org/httpcomponents-core-ga/httpcore/apidocs/org/apache/http/entity/BufferedHttpEntity.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hc.apache.org/httpcomponents-core-ga/httpcore/apidocs/org/apache/http/entity/BufferedHttpEntity.html&lt;/a&gt;&lt;br/&gt;
 &lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/client/java-rest/master/java-rest-low-usage-responses.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.elastic.co/guide/en/elasticsearch/client/java-rest/master/java-rest-low-usage-responses.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16677852" author="timrobertson100" created="Wed, 7 Nov 2018 08:46:05 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wouts&quot; class=&quot;user-hover&quot; rel=&quot;wouts&quot;&gt;wouts&lt;/a&gt; - I believe this was your first contribution?&#160;It&apos;s&#160;great to see people motivated to fix the issues they find.&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 1 week, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3z4bb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>