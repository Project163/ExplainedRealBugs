<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:14:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-11715] Combiner packing creates an incorrect proto</title>
                <link>https://issues.apache.org/jira/browse/BEAM-11715</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;Seems like optimization creates a CombinePerKey transform that does not have any sub-transforms. We should fix this by preserving the old structure for CombinePerKey (GBK+CombineValues composite).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13355531">BEAM-11715</key>
            <summary>Combiner packing creates an incorrect proto</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10101" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">P1</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="myffical@gmail.com">Yifan Mai</assignee>
                                    <reporter username="chamikara">Chamikara Madhusanka Jayalath</reporter>
                        <labels>
                    </labels>
                <created>Fri, 29 Jan 2021 21:07:42 +0000</created>
                <updated>Mon, 14 Feb 2022 02:39:23 +0000</updated>
                            <resolved>Sat, 6 Feb 2021 05:04:57 +0000</resolved>
                                                    <fixVersion>2.28.0</fixVersion>
                                    <component>sdk-py-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="48600">13.5h</timespent>
                                <comments>
                            <comment id="17275442" author="myffical@gmail.com" created="Sat, 30 Jan 2021 00:51:57 +0000"  >&lt;p&gt;Work items:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Add a ValidatesRunner that triggers translations.pack_combiners for runners that have it enabled. This will be done in &lt;a href=&quot;https://github.com/apache/beam/pull/13851&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/13851&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Ensure that this does not break DataflowRunner (with --use_runner_v2) in 2.28. This should already be fixed by &lt;a href=&quot;https://github.com/apache/beam/pull/13829&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/13829&lt;/a&gt; which uses a PTransformOverride hack to re-expand the CombinePerKey into GroupByKey and CombineValues. We can check that the fix works using the ValidatesRunner in the previous step.&lt;/li&gt;
	&lt;li&gt;Disable translations.pack_combiners for FlinkRunner and SparkRunner (i.e. runners in which CombinePerKey is not a primitive). This should already be fixed by &lt;a href=&quot;https://github.com/apache/beam/pull/13816&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/13816&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;In the long term, rewrite tranlations.pack_combiners so that the packed combine is expanded to GroupByKey and CombineValues.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;There are two ways we could do the long term fix:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Re-write the CombinePerKey back into GroupByKey and CombineValues in the proto if known_runner_urns does not contain CombinePerKey&apos;s URN. This is straightforward, but violates DRY because this is a copy of the CombinePerKey&apos;s expand method.&lt;/li&gt;
	&lt;li&gt;Instead of packing at the CombinePerKey level, pack at the CombineValues level. This means we need to eliminate common GroupByKey stages, similarly to how translations.eliminate_common_key_with_void works.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=robertwb&quot; class=&quot;user-hover&quot; rel=&quot;robertwb&quot;&gt;robertwb&lt;/a&gt; would you have an opinion about this?&lt;/p&gt;</comment>
                            <comment id="17275446" author="chamikara" created="Sat, 30 Jan 2021 00:57:29 +0000"  >&lt;p&gt;rewrite tranlations.pack_combiners so that the packed combine is expanded to GroupByKey and CombineValues&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think this has to be a part of the short term fix. Otherwise Dataflow will be broken for portable job submission which is required for x-lang and Runner v2.&lt;/p&gt;</comment>
                            <comment id="17275447" author="chamikara" created="Sat, 30 Jan 2021 00:58:26 +0000"  >&lt;p&gt;Or we have to somehow fix the proto to not perform the incorrect encoding (by including sub-transforms).&lt;/p&gt;</comment>
                            <comment id="17275448" author="chamikara" created="Sat, 30 Jan 2021 00:59:56 +0000"  >&lt;p&gt;(Validates runner test will verify this. We run all validates runner tests against portable job submission when code is imported to Google).&lt;/p&gt;</comment>
                            <comment id="17275449" author="myffical@gmail.com" created="Sat, 30 Jan 2021 01:03:05 +0000"  >&lt;p&gt;Dataflow with portable job submission &lt;em&gt;should&lt;/em&gt; work because &lt;a href=&quot;https://github.com/apache/beam/pull/13829&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/13829&lt;/a&gt; uses a hacky workaround. We convert the pipeline to proto, do the optimizations, convert it back into pipeline, use CombinePerKeyPTransformOverride to perform the expansion, and then convert back into proto. Note that we convert the pipeline to the proto &lt;em&gt;twice&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;I can try running the 2.28 branch with --use_runner_v2 (is that all that is needed to trigger portable job submission?) and report back.&lt;/p&gt;</comment>
                            <comment id="17275451" author="myffical@gmail.com" created="Sat, 30 Jan 2021 01:06:43 +0000"  >&lt;p&gt;I&apos;m not too familiar with how to test x-lang stuff, but we currently check that the environment has the python_urns.PACKED_COMBINE_FN capability and that the CombineFn URN is python_urns.PICKLED_COMBINE_FN &lt;a href=&quot;https://github.com/apache/beam/blob/a44768f074ad0c55d5ca19c8ec6a47887b7e8538/sdks/python/apache_beam/runners/portability/fn_api_runner/translations.py#L878-L886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. I believe that should prevent combiner packing from triggering in the x-lang case.&lt;/p&gt;</comment>
                            <comment id="17275454" author="chamikara" created="Sat, 30 Jan 2021 01:14:05 +0000"  >&lt;p&gt;Note that&#160;CombinePerKeyPTransformOverride will not work for x-lang since seems like&#160; it requires a &quot;proto -&amp;gt; from runner API -&amp;gt; pipeline -&amp;gt; to runner API -&amp;gt; proto&quot; conversion (which doesn&apos;t work for protos with embedded external transforms). Also seems like CombinePerKeyPTransformOverride is guarded by an experiment hence original proto will continue to be incorrect when that experiment is not set IIUC.&lt;/p&gt;</comment>
                            <comment id="17275460" author="myffical@gmail.com" created="Sat, 30 Jan 2021 01:38:26 +0000"  >&lt;p&gt;From offline sync:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I will implement &quot;rewrite translations.pack_combiners so that the packed combine is expanded to GroupByKey and CombineValues&quot; as a short term fix. This will remove the need for PTransformOverride and thus the from_runner_api() call. This should also fix portable Dataflow. This will be a blocker for 2.28.&lt;/li&gt;
	&lt;li&gt;I will remove the from_runner_api() call. This means that the original non-proto pipeline will be unmodified, so non-portable Dataflow will &lt;em&gt;not&lt;/em&gt; get pipeline optimizations. This is OK since portable Dataflow will be the preferred way of doing things going forward.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17276795" author="myffical@gmail.com" created="Tue, 2 Feb 2021 02:09:42 +0000"  >&lt;p&gt;The changes from my previous comment are in draft #13877. Aiming to run integration tests and send out for review tomorrow.&lt;/p&gt;</comment>
                            <comment id="17278236" author="myffical@gmail.com" created="Wed, 3 Feb 2021 17:28:08 +0000"  >&lt;p&gt;Fixing translations.pack_combiners turns out to be more complicated than I thought. More details in #13877. TLDR the subtransforms for Dataflow are different than the subtransforms for FnApiRunner.&lt;/p&gt;

&lt;p&gt;Instead of fixing translations.pack_combiners, I will instead partially revert #13763 (which is the PR that added translations.pack_combiners to Dataflow). This should get Dataflow back into a working state and unblock the release. The revert PR is #13884.&lt;/p&gt;</comment>
                            <comment id="17279322" author="myffical@gmail.com" created="Fri, 5 Feb 2021 04:24:58 +0000"  >&lt;p&gt;PR #13884 is ready for review again. I have tested it against Dataflow.&lt;/p&gt;</comment>
                            <comment id="17279324" author="chamikara" created="Fri, 5 Feb 2021 04:30:49 +0000"  >&lt;p&gt;Done. Please send a cherry-pick as well.&lt;/p&gt;</comment>
                            <comment id="17279797" author="myffical@gmail.com" created="Fri, 5 Feb 2021 16:50:24 +0000"  >&lt;p&gt;Sent cherry-pick in &lt;a href=&quot;https://github.com/apache/beam/pull/13901&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;#13901&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13355540">BEAM-11716</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 40 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0n5co:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>