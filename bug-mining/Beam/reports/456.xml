<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:47:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-3282] MqttIO reader should use receive with timeout</title>
                <link>https://issues.apache.org/jira/browse/BEAM-3282</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;Now, &lt;tt&gt;MqttIO&lt;/tt&gt; reader uses &lt;tt&gt;connection.receive()&lt;/tt&gt; which is a blocking method, waiting for messages. This prevents the reader to return &lt;tt&gt;false&lt;/tt&gt; when there&apos;s no message and so to advance the processing.&lt;br/&gt;
Instead, the reader should use &lt;tt&gt;connection.receive(timeout, timeunit)&lt;/tt&gt; and return &lt;tt&gt;false&lt;/tt&gt; in &lt;tt&gt;advance()&lt;/tt&gt; when message is null.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13122490">BEAM-3282</key>
            <summary>MqttIO reader should use receive with timeout</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbonofre">Jean-Baptiste Onofr&#233;</assignee>
                                    <reporter username="jbonofre">Jean-Baptiste Onofr&#233;</reporter>
                        <labels>
                    </labels>
                <created>Mon, 4 Dec 2017 05:17:02 +0000</created>
                <updated>Sat, 16 May 2020 13:33:51 +0000</updated>
                            <resolved>Tue, 9 Jan 2018 10:20:38 +0000</resolved>
                                                    <fixVersion>2.3.0</fixVersion>
                                    <component>io-java-mqtt</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="16276760" author="githubbot" created="Mon, 4 Dec 2017 13:17:20 +0000"  >&lt;p&gt;jbonofre opened a new pull request #4206: &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3282&quot; title=&quot;MqttIO reader should use receive with timeout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-3282&quot;&gt;&lt;del&gt;BEAM-3282&lt;/del&gt;&lt;/a&gt; MqttIO reader now use receive for timeout in order to ret&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/beam/pull/4206&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/4206&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   &#8230;urn false when there&apos;s no message to read&lt;/p&gt;

&lt;p&gt;   Follow this checklist to help us incorporate your contribution quickly and easily:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;X&amp;#93;&lt;/span&gt; Make sure there is a &lt;span class=&quot;error&quot;&gt;&amp;#91;JIRA issue&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://issues.apache.org/jira/projects/BEAM/issues/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/projects/BEAM/issues/&lt;/a&gt;) filed for the change (usually before you start working on it).  Trivial changes like typos do not require a JIRA issue.  Your pull request should address just this issue, without pulling in other changes.&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;X&amp;#93;&lt;/span&gt; Each commit in the pull request should have a meaningful subject line and body.&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;X&amp;#93;&lt;/span&gt; Format the pull request title like `&lt;span class=&quot;error&quot;&gt;&amp;#91;BEAM-XXX&amp;#93;&lt;/span&gt; Fixes bug in ApproximateQuantiles`, where you replace `BEAM-XXX` with the appropriate JIRA issue.&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;X&amp;#93;&lt;/span&gt; Write a pull request description that is detailed enough to understand what the pull request does, how, and why.&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;X&amp;#93;&lt;/span&gt; Run `mvn clean verify` to make sure basic checks pass. A more thorough check will be performed on your pull request automatically.&lt;/li&gt;
	&lt;li&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;X&amp;#93;&lt;/span&gt; If this contribution is large, please file an Apache &lt;span class=&quot;error&quot;&gt;&amp;#91;Individual Contributor License Agreement&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://www.apache.org/licenses/icla.pdf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.apache.org/licenses/icla.pdf&lt;/a&gt;).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   &amp;#8212;&lt;/p&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16318206" author="githubbot" created="Tue, 9 Jan 2018 10:20:19 +0000"  >&lt;p&gt;jbonofre closed pull request #4206: &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3282&quot; title=&quot;MqttIO reader should use receive with timeout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-3282&quot;&gt;&lt;del&gt;BEAM-3282&lt;/del&gt;&lt;/a&gt; MqttIO reader now use receive for timeout in order to ret&#8230;&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/beam/pull/4206&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/4206&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/sdks/java/io/mqtt/src/main/java/org/apache/beam/sdk/io/mqtt/MqttIO.java b/sdks/java/io/mqtt/src/main/java/org/apache/beam/sdk/io/mqtt/MqttIO.java&lt;br/&gt;
index f9083bb5e7e..ef9c9d293d9 100644&lt;br/&gt;
&amp;#8212; a/sdks/java/io/mqtt/src/main/java/org/apache/beam/sdk/io/mqtt/MqttIO.java&lt;br/&gt;
+++ b/sdks/java/io/mqtt/src/main/java/org/apache/beam/sdk/io/mqtt/MqttIO.java&lt;br/&gt;
@@ -20,6 +20,7 @@&lt;br/&gt;
 import static com.google.common.base.Preconditions.checkArgument;&lt;/p&gt;

&lt;p&gt; import com.google.auto.value.AutoValue;&lt;br/&gt;
+import com.google.common.annotations.VisibleForTesting;&lt;br/&gt;
 import java.io.IOException;&lt;br/&gt;
 import java.io.Serializable;&lt;br/&gt;
 import java.util.ArrayList;&lt;br/&gt;
@@ -27,7 +28,9 @@&lt;br/&gt;
 import java.util.List;&lt;br/&gt;
 import java.util.NoSuchElementException;&lt;br/&gt;
 import java.util.UUID;&lt;br/&gt;
+import java.util.concurrent.TimeUnit;&lt;br/&gt;
 import javax.annotation.Nullable;&lt;br/&gt;
+&lt;br/&gt;
 import org.apache.beam.sdk.annotations.Experimental;&lt;br/&gt;
 import org.apache.beam.sdk.coders.ByteArrayCoder;&lt;br/&gt;
 import org.apache.beam.sdk.coders.Coder;&lt;br/&gt;
@@ -291,7 +294,8 @@ public void populateDisplayData(DisplayData.Builder builder) {&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Checkpoint for an unbounded MQTT source. Consists of the MQTT messages waiting to be&lt;/li&gt;
	&lt;li&gt;acknowledged and oldest pending message timestamp.&lt;br/&gt;
    */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static class MqttCheckpointMark implements UnboundedSource.CheckpointMark, Serializable {&lt;br/&gt;
+  @VisibleForTesting&lt;br/&gt;
+  static class MqttCheckpointMark implements UnboundedSource.CheckpointMark, Serializable 
{
 
     private String clientId;
     private Instant oldestMessageTimestamp = Instant.now();
@@ -329,8 +333,8 @@ private void readObject(java.io.ObjectInputStream stream)
 
   }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static class UnboundedMqttSource&lt;/li&gt;
	&lt;li&gt;extends UnboundedSource&amp;lt;byte[], MqttCheckpointMark&amp;gt; {&lt;br/&gt;
+  @VisibleForTesting&lt;br/&gt;
+  static class UnboundedMqttSource extends UnboundedSource&amp;lt;byte[], MqttCheckpointMark&amp;gt; {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     private final Read spec;&lt;/p&gt;

&lt;p&gt;@@ -370,7 +374,8 @@ public void populateDisplayData(DisplayData.Builder builder) {&lt;br/&gt;
     }&lt;br/&gt;
   }&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static class UnboundedMqttReader extends UnboundedSource.UnboundedReader&amp;lt;byte[]&amp;gt; {&lt;br/&gt;
+  @VisibleForTesting&lt;br/&gt;
+  static class UnboundedMqttReader extends UnboundedSource.UnboundedReader&amp;lt;byte[]&amp;gt; {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     private final UnboundedMqttSource source;&lt;/p&gt;

&lt;p&gt;@@ -411,8 +416,11 @@ public boolean start() throws IOException {&lt;br/&gt;
     @Override&lt;br/&gt;
     public boolean advance() throws IOException {&lt;br/&gt;
       try {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;LOG.debug(&quot;MQTT reader (client ID {}) waiting message ...&quot;, client.getClientId());&lt;/li&gt;
	&lt;li&gt;Message message = connection.receive();&lt;br/&gt;
+        LOG.trace(&quot;MQTT reader (client ID {}) waiting message ...&quot;, client.getClientId());&lt;br/&gt;
+        Message message = connection.receive(1, TimeUnit.SECONDS);&lt;br/&gt;
+        if (message == null) 
{
+          return false;
+        }
&lt;p&gt;         current = message.getPayload();&lt;br/&gt;
         currentTimestamp = Instant.now();&lt;br/&gt;
         checkpointMark.add(message, currentTimestamp);&lt;br/&gt;
diff --git a/sdks/java/io/mqtt/src/test/java/org/apache/beam/sdk/io/mqtt/MqttIOTest.java b/sdks/java/io/mqtt/src/test/java/org/apache/beam/sdk/io/mqtt/MqttIOTest.java&lt;br/&gt;
index 1b3d2da3542..d7baf3bf989 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/sdks/java/io/mqtt/src/test/java/org/apache/beam/sdk/io/mqtt/MqttIOTest.java&lt;br/&gt;
+++ b/sdks/java/io/mqtt/src/test/java/org/apache/beam/sdk/io/mqtt/MqttIOTest.java&lt;br/&gt;
@@ -24,6 +24,7 @@&lt;br/&gt;
 import java.util.ArrayList;&lt;br/&gt;
 import java.util.HashSet;&lt;br/&gt;
 import java.util.Set;&lt;br/&gt;
+&lt;br/&gt;
 import org.apache.activemq.broker.BrokerService;&lt;br/&gt;
 import org.apache.activemq.broker.Connection;&lt;br/&gt;
 import org.apache.beam.sdk.io.mqtt.MqttIO.Read;&lt;br/&gt;
@@ -37,6 +38,7 @@&lt;br/&gt;
 import org.fusesource.mqtt.client.Message;&lt;br/&gt;
 import org.fusesource.mqtt.client.QoS;&lt;br/&gt;
 import org.fusesource.mqtt.client.Topic;&lt;br/&gt;
+import org.joda.time.Duration;&lt;br/&gt;
 import org.junit.After;&lt;br/&gt;
 import org.junit.Before;&lt;br/&gt;
 import org.junit.Rule;&lt;br/&gt;
@@ -134,7 +136,7 @@ public void run() 
{
     publisherThread.join();
   }&lt;br/&gt;
 &lt;br/&gt;
-  @Test(timeout = 60 * 1000)&lt;br/&gt;
+  @Test(timeout = 5 * 1000)&lt;br/&gt;
   public void testRead() throws Exception {&lt;br/&gt;
     PCollection&amp;lt;byte[]&amp;gt; output = pipeline.apply(&lt;br/&gt;
         MqttIO.read()&lt;br/&gt;
@@ -143,7 +145,7 @@ public void testRead() throws Exception {&lt;br/&gt;
                     &quot;tcp://localhost:&quot; + port,&lt;br/&gt;
                     &quot;READ_TOPIC&quot;,&lt;br/&gt;
                     &quot;READ_PIPELINE&quot;))&lt;br/&gt;
-          .withMaxNumRecords(10));&lt;br/&gt;
+            .withMaxReadTime(Duration.standardSeconds(3)));&lt;br/&gt;
     PAssert.that(output).containsInAnyOrder(&lt;br/&gt;
         &quot;This is test 0&quot;.getBytes(),&lt;br/&gt;
         &quot;This is test 1&quot;.getBytes(),&lt;br/&gt;
@@ -193,6 +195,22 @@ public void run() {     publisherThread.join();   }&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+  /**&lt;br/&gt;
+   * Test for &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3282&quot; title=&quot;MqttIO reader should use receive with timeout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-3282&quot;&gt;&lt;del&gt;BEAM-3282&lt;/del&gt;&lt;/a&gt;: this test should not timeout.&lt;br/&gt;
+   */&lt;br/&gt;
+  @Test(timeout = 5 * 1000)&lt;br/&gt;
+  public void testReceiveWithTimeoutAndNoData() throws Exception &lt;/p&gt;
{
+    pipeline.apply(MqttIO.read()
+        .withConnectionConfiguration(
+            MqttIO.ConnectionConfiguration.create(
+                &quot;tcp://localhost:&quot; + port,
+                &quot;READ_TOPIC&quot;,
+                &quot;READ_PIPELINE&quot;)).withMaxReadTime(Duration.standardSeconds(2)));
+
+    // should stop before the test timeout
+    pipeline.run();
+  }
&lt;p&gt;+&lt;br/&gt;
   @Test&lt;br/&gt;
   public void testWrite() throws Exception {&lt;br/&gt;
     MQTT client = new MQTT();&lt;/p&gt;




&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 45 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3nhh3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>