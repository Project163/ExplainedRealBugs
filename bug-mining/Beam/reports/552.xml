<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:49:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-3409] Unexpected behavior of DoFn teardown method running in unit tests </title>
                <link>https://issues.apache.org/jira/browse/BEAM-3409</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;Writing a unit test, I found out a strange behaviour of Teardown method of DoFn implementation when I run this method in unit tests using TestPipeline.&lt;/p&gt;

&lt;p&gt;To be more precise, it doesn&#8217;t wait until teardown() method will be finished, it just exits from this method after about 1 sec (on my machine) even if it should take longer (very simple example - running infinite loop inside this method or put thread in sleep). In the same time, when I run the same code from main() with ordinary Pipeline and direct runner, then it&#8217;s ok and it works as expected - teardown() method will be performed completely despite how much time it will take.&lt;/p&gt;

&lt;p&gt;I created two test cases to reproduce this issue - the first one to run with main() and the second one to run with junit. They use the same implementation of DoFn (class LongTearDownFn) and expects that teardown method will be running at least for SLEEP_TIME ms. In case of running as junit test it&apos;s not a case (see output log).&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;run with main()&lt;br/&gt;
&lt;a href=&quot;https://github.com/aromanenko-dev/beam-samples/blob/master/runners-tests/src/main/java/TearDown.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/aromanenko-dev/beam-samples/blob/master/runners-tests/src/main/java/TearDown.java&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;run with junit&lt;br/&gt;
&lt;a href=&quot;https://github.com/aromanenko-dev/beam-samples/blob/master/runners-tests/src/test/java/TearDownTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/aromanenko-dev/beam-samples/blob/master/runners-tests/src/test/java/TearDownTest.java&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13128541">BEAM-3409</key>
            <summary>Unexpected behavior of DoFn teardown method running in unit tests </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10100" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">P0</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="romain.manni-bucau">Romain Manni-Bucau</assignee>
                                    <reporter username="aromanenko">Alexey Romanenko</reporter>
                        <labels>
                            <label>test</label>
                    </labels>
                <created>Thu, 4 Jan 2018 17:02:16 +0000</created>
                <updated>Sat, 16 May 2020 14:21:11 +0000</updated>
                            <resolved>Thu, 1 Mar 2018 23:36:11 +0000</resolved>
                                    <version>2.3.0</version>
                                    <fixVersion>2.5.0</fixVersion>
                                    <component>runner-direct</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="25800">7h 10m</timespent>
                                <comments>
                            <comment id="16311767" author="iemejia" created="Thu, 4 Jan 2018 18:07:22 +0000"  >&lt;p&gt;For some extra context Alexey found this one with a test that was failing because the teardown part of the DoFn took a long time but the thread execution on TestPipeline was finishing before completion. I tested this with other TestPipelines e.g.TestSparkPipeline and TestFlinkPipeline and it worked ok, so I suppose this is probably closer to the direct runner and junit thread creation/finalization.&lt;br/&gt;
We are a bit surprised of this behavior but it could be easily a source for other flaky tests.&lt;/p&gt;</comment>
                            <comment id="16316634" author="romain.manni-bucau" created="Mon, 8 Jan 2018 17:29:58 +0000"  >&lt;p&gt;Hi&lt;/p&gt;

&lt;p&gt;started to hack on that in &lt;a href=&quot;https://github.com/rmannibucau/incubator-beam/tree/fix/BEAM-3409_wait-for-teardown-execution-in-direct-runner&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rmannibucau/incubator-beam/tree/fix/BEAM-3409_wait-for-teardown-execution-in-direct-runner&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;still need some enhancements to have all tests passing but guess the issue is at least identified&lt;/p&gt;</comment>
                            <comment id="16318222" author="githubbot" created="Tue, 9 Jan 2018 10:31:55 +0000"  >&lt;p&gt;rmannibucau opened a new pull request #4372: &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3409&quot; title=&quot;Unexpected behavior of DoFn teardown method running in unit tests &quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-3409&quot;&gt;&lt;del&gt;BEAM-3409&lt;/del&gt;&lt;/a&gt; starting to fix the wait of direct runner&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/beam/pull/4372&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/4372&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Using the direct runner, p.run().waitUntilFinish() doesn&apos;t wait for the teardown execution&lt;/p&gt;

&lt;p&gt;   This PR contains these fixes:&lt;/p&gt;

&lt;p&gt;   1. for each dofn registered it will create a latch the execution will wait on for waitUntilFinish and guarantee&lt;br/&gt;
   the teardown methods are included into this &quot;wait&quot;&lt;br/&gt;
   2. For SDF it ensure the dofnmanager are released and therefore than teardown is called (propagating previous logic as well)&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16379317" author="reuvenlax" created="Tue, 27 Feb 2018 21:36:37 +0000"  >&lt;p&gt;So teardown isn&apos;t being called, it&apos;s just that waitUntilFinish isn&apos;t properly waiting for tearDown in direct runner. Is that correct?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13151341">BEAM-4040</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 37 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3oimn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>