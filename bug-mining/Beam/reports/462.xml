<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:47:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-3336] MqttIO read tests are flaky</title>
                <link>https://issues.apache.org/jira/browse/BEAM-3336</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;example failure: &lt;a href=&quot;https://builds.apache.org/job/beam_PreCommit_Java_GradleBuild/449/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/beam_PreCommit_Java_GradleBuild/449/&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13124479">BEAM-3336</key>
            <summary>MqttIO read tests are flaky</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lcwik">Luke Cwik</assignee>
                                    <reporter username="tgroh">Thomas Groh</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Dec 2017 20:45:10 +0000</created>
                <updated>Sat, 16 May 2020 13:44:00 +0000</updated>
                            <resolved>Sat, 13 Jan 2018 06:38:34 +0000</resolved>
                                                    <fixVersion>2.3.0</fixVersion>
                                    <component>io-java-mqtt</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16323119" author="kenn" created="Thu, 11 Jan 2018 22:34:21 +0000"  >&lt;p&gt;In my recent experience, these are no longer flaky, but simply red. I suggest disabling them and re-enabling as this issue is addressed.&lt;/p&gt;</comment>
                            <comment id="16323946" author="jbonofre" created="Fri, 12 Jan 2018 13:23:13 +0000"  >&lt;p&gt;Actually, I merged a fix last week on MqttIO that should fix the tests. Let me close this Jira,  I will  eventually reopen it if required.&lt;/p&gt;</comment>
                            <comment id="16324597" author="lcwik" created="Fri, 12 Jan 2018 21:52:34 +0000"  >&lt;p&gt;Another example failure: &lt;a href=&quot;https://builds.apache.org/job/beam_PreCommit_Java_GradleBuild/1032/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/beam_PreCommit_Java_GradleBuild/1032/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Failed:&lt;br/&gt;
org.apache.beam.sdk.io.mqtt.MqttIOTest.testRead&lt;br/&gt;
org.apache.beam.sdk.io.mqtt.MqttIOTest.testReadNoClientId&lt;/p&gt;

&lt;p&gt;Logs:&lt;br/&gt;
org.junit.runners.model.TestTimedOutException: test timed out after 60000 milliseconds&lt;br/&gt;
Stacktrace&lt;/p&gt;

&lt;p&gt;org.junit.runners.model.TestTimedOutException: test timed out after 60000 milliseconds&lt;br/&gt;
	at sun.misc.Unsafe.park(Native Method)&lt;br/&gt;
	at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)&lt;br/&gt;
	at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2078)&lt;br/&gt;
	at java.util.concurrent.LinkedBlockingQueue.poll(LinkedBlockingQueue.java:467)&lt;br/&gt;
	at org.apache.beam.runners.direct.ExecutorServiceParallelExecutor$QueueMessageReceiver.tryNext(ExecutorServiceParallelExecutor.java:357)&lt;br/&gt;
	at org.apache.beam.runners.direct.ExecutorServiceParallelExecutor$QueueMessageReceiver.access$300(ExecutorServiceParallelExecutor.java:328)&lt;br/&gt;
	at org.apache.beam.runners.direct.ExecutorServiceParallelExecutor.waitUntilFinish(ExecutorServiceParallelExecutor.java:241)&lt;br/&gt;
	at org.apache.beam.runners.direct.DirectRunner$DirectPipelineResult.waitUntilFinish(DirectRunner.java:334)&lt;br/&gt;
	at org.apache.beam.runners.direct.DirectRunner$DirectPipelineResult.waitUntilFinish(DirectRunner.java:309)&lt;br/&gt;
	at org.apache.beam.runners.direct.DirectRunner.run(DirectRunner.java:203)&lt;br/&gt;
	at org.apache.beam.runners.direct.DirectRunner.run(DirectRunner.java:63)&lt;br/&gt;
	at org.apache.beam.sdk.Pipeline.run(Pipeline.java:304)&lt;br/&gt;
	at org.apache.beam.sdk.testing.TestPipeline.run(TestPipeline.java:358)&lt;br/&gt;
	at org.apache.beam.sdk.testing.TestPipeline.run(TestPipeline.java:340)&lt;br/&gt;
	at org.apache.beam.sdk.io.mqtt.MqttIOTest.testReadNoClientId(MqttIOTest.java:133)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)&lt;br/&gt;
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(Method.java:498)&lt;br/&gt;
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)&lt;br/&gt;
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)&lt;br/&gt;
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)&lt;br/&gt;
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)&lt;br/&gt;
	at org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:298)&lt;br/&gt;
	at org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:292)&lt;br/&gt;
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:748)&lt;br/&gt;
Standard Error&lt;/p&gt;

&lt;p&gt;Jan 12, 2018 8:54:27 PM org.apache.beam.sdk.io.mqtt.MqttIOTest startBroker&lt;br/&gt;
INFO: Finding free network port&lt;br/&gt;
Jan 12, 2018 8:54:27 PM org.apache.beam.sdk.io.mqtt.MqttIOTest startBroker&lt;br/&gt;
INFO: Starting ActiveMQ brokerService on 33991&lt;br/&gt;
Jan 12, 2018 8:54:30 PM org.apache.activemq.broker.BrokerService doStartPersistenceAdapter&lt;br/&gt;
INFO: Using Persistence Adapter: MemoryPersistenceAdapter&lt;br/&gt;
Jan 12, 2018 8:54:31 PM org.apache.activemq.broker.BrokerService doStartBroker&lt;br/&gt;
INFO: Apache ActiveMQ 5.13.1 (localhost, ID:52.16.184.35.bc.googleusercontent.com-36581-1515790470484-0:1) is starting&lt;br/&gt;
Jan 12, 2018 8:54:31 PM org.apache.activemq.transport.TransportServerThreadSupport doStart&lt;br/&gt;
INFO: Listening for connections at: mqtt://localhost:33991&lt;br/&gt;
Jan 12, 2018 8:54:31 PM org.apache.activemq.broker.TransportConnector start&lt;br/&gt;
INFO: Connector mqtt://localhost:33991 started&lt;br/&gt;
Jan 12, 2018 8:54:31 PM org.apache.activemq.broker.BrokerService doStartBroker&lt;br/&gt;
INFO: Apache ActiveMQ 5.13.1 (localhost, ID:52.16.184.35.bc.googleusercontent.com-36581-1515790470484-0:1) started&lt;br/&gt;
Jan 12, 2018 8:54:31 PM org.apache.activemq.broker.BrokerService doStartBroker&lt;br/&gt;
INFO: For help or more information please see: &lt;a href=&quot;http://activemq.apache.org&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org&lt;/a&gt;&lt;br/&gt;
Jan 12, 2018 8:54:54 PM org.apache.activemq.broker.BrokerService stop&lt;br/&gt;
INFO: Apache ActiveMQ 5.13.1 (localhost, ID:52.16.184.35.bc.googleusercontent.com-36581-1515790470484-0:1) is shutting down&lt;br/&gt;
Jan 12, 2018 8:54:54 PM org.apache.activemq.broker.TransportConnection serviceTransportException&lt;br/&gt;
WARNING: Transport Connection to: tcp://127.0.0.1:50644 failed: java.io.IOException: Unexpected error occurred: org.apache.activemq.broker.BrokerStoppedException: Broker BrokerService&lt;span class=&quot;error&quot;&gt;&amp;#91;localhost&amp;#93;&lt;/span&gt; is being stopped&lt;br/&gt;
Jan 12, 2018 8:54:55 PM org.apache.activemq.broker.TransportConnector stop&lt;br/&gt;
INFO: Connector mqtt://localhost:33991 stopped&lt;br/&gt;
Jan 12, 2018 8:54:55 PM org.apache.activemq.broker.BrokerService stop&lt;br/&gt;
INFO: Apache ActiveMQ 5.13.1 (localhost, ID:52.16.184.35.bc.googleusercontent.com-36581-1515790470484-0:1) uptime 26.546 seconds&lt;br/&gt;
Jan 12, 2018 8:54:55 PM org.apache.activemq.broker.BrokerService stop&lt;br/&gt;
INFO: Apache ActiveMQ 5.13.1 (localhost, ID:52.16.184.35.bc.googleusercontent.com-36581-1515790470484-0:1) is shutdown&lt;br/&gt;
Jan 12, 2018 8:54:55 PM org.apache.beam.sdk.io.mqtt.MqttIOTest startBroker&lt;br/&gt;
INFO: Finding free network port&lt;br/&gt;
Jan 12, 2018 8:54:55 PM org.apache.beam.sdk.io.mqtt.MqttIOTest startBroker&lt;br/&gt;
INFO: Starting ActiveMQ brokerService on 38105&lt;br/&gt;
Jan 12, 2018 8:54:55 PM org.apache.activemq.broker.BrokerService doStartPersistenceAdapter&lt;br/&gt;
INFO: Using Persistence Adapter: MemoryPersistenceAdapter&lt;br/&gt;
Jan 12, 2018 8:54:55 PM org.apache.activemq.broker.BrokerService doStartBroker&lt;br/&gt;
INFO: Apache ActiveMQ 5.13.1 (localhost, ID:52.16.184.35.bc.googleusercontent.com-36581-1515790470484-0:2) is starting&lt;br/&gt;
Jan 12, 2018 8:54:55 PM org.apache.activemq.transport.TransportServerThreadSupport doStart&lt;br/&gt;
INFO: Listening for connections at: mqtt://localhost:38105&lt;br/&gt;
Jan 12, 2018 8:54:55 PM org.apache.activemq.broker.TransportConnector start&lt;br/&gt;
INFO: Connector mqtt://localhost:38105 started&lt;br/&gt;
Jan 12, 2018 8:54:55 PM org.apache.activemq.broker.BrokerService doStartBroker&lt;br/&gt;
INFO: Apache ActiveMQ 5.13.1 (localhost, ID:52.16.184.35.bc.googleusercontent.com-36581-1515790470484-0:2) started&lt;br/&gt;
Jan 12, 2018 8:54:55 PM org.apache.activemq.broker.BrokerService doStartBroker&lt;br/&gt;
INFO: For help or more information please see: &lt;a href=&quot;http://activemq.apache.org&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org&lt;/a&gt;&lt;br/&gt;
Jan 12, 2018 8:54:57 PM org.apache.beam.sdk.io.mqtt.MqttIOTest$2 run&lt;br/&gt;
INFO: Waiting pipeline connected to the MQTT broker before sending messages ...&lt;br/&gt;
Jan 12, 2018 8:55:00 PM org.apache.activemq.broker.BrokerService stop&lt;br/&gt;
INFO: Apache ActiveMQ 5.13.1 (localhost, ID:52.16.184.35.bc.googleusercontent.com-36581-1515790470484-0:2) is shutting down&lt;br/&gt;
Jan 12, 2018 8:55:00 PM org.apache.activemq.broker.TransportConnector stop&lt;br/&gt;
INFO: Connector mqtt://localhost:38105 stopped&lt;br/&gt;
Jan 12, 2018 8:55:00 PM org.apache.activemq.broker.BrokerService stop&lt;br/&gt;
INFO: Apache ActiveMQ 5.13.1 (localhost, ID:52.16.184.35.bc.googleusercontent.com-36581-1515790470484-0:2) uptime 5.353 seconds&lt;br/&gt;
Jan 12, 2018 8:55:00 PM org.apache.activemq.broker.BrokerService stop&lt;br/&gt;
INFO: Apache ActiveMQ 5.13.1 (localhost, ID:52.16.184.35.bc.googleusercontent.com-36581-1515790470484-0:2) is shutdown&lt;br/&gt;
Jan 12, 2018 8:55:00 PM org.apache.beam.sdk.io.mqtt.MqttIOTest startBroker&lt;br/&gt;
INFO: Finding free network port&lt;br/&gt;
Jan 12, 2018 8:55:00 PM org.apache.beam.sdk.io.mqtt.MqttIOTest startBroker&lt;br/&gt;
INFO: Starting ActiveMQ brokerService on 44050&lt;br/&gt;
Jan 12, 2018 8:55:00 PM org.apache.activemq.broker.BrokerService doStartPersistenceAdapter&lt;br/&gt;
INFO: Using Persistence Adapter: MemoryPersistenceAdapter&lt;br/&gt;
Jan 12, 2018 8:55:00 PM org.apache.activemq.broker.BrokerService doStartBroker&lt;br/&gt;
INFO: Apache ActiveMQ 5.13.1 (localhost, ID:52.16.184.35.bc.googleusercontent.com-36581-1515790470484-0:3) is starting&lt;br/&gt;
Jan 12, 2018 8:55:00 PM org.apache.activemq.transport.TransportServerThreadSupport doStart&lt;br/&gt;
INFO: Listening for connections at: mqtt://localhost:44050&lt;br/&gt;
Jan 12, 2018 8:55:00 PM org.apache.activemq.broker.TransportConnector start&lt;br/&gt;
INFO: Connector mqtt://localhost:44050 started&lt;br/&gt;
Jan 12, 2018 8:55:00 PM org.apache.activemq.broker.BrokerService doStartBroker&lt;br/&gt;
INFO: Apache ActiveMQ 5.13.1 (localhost, ID:52.16.184.35.bc.googleusercontent.com-36581-1515790470484-0:3) started&lt;br/&gt;
Jan 12, 2018 8:55:00 PM org.apache.activemq.broker.BrokerService doStartBroker&lt;br/&gt;
INFO: For help or more information please see: &lt;a href=&quot;http://activemq.apache.org&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org&lt;/a&gt;&lt;br/&gt;
Jan 12, 2018 8:55:03 PM org.apache.activemq.broker.BrokerService stop&lt;br/&gt;
INFO: Apache ActiveMQ 5.13.1 (localhost, ID:52.16.184.35.bc.googleusercontent.com-36581-1515790470484-0:3) is shutting down&lt;br/&gt;
Jan 12, 2018 8:55:03 PM org.apache.activemq.broker.TransportConnector stop&lt;br/&gt;
INFO: Connector mqtt://localhost:44050 stopped&lt;br/&gt;
Jan 12, 2018 8:55:03 PM org.apache.activemq.broker.BrokerService stop&lt;br/&gt;
INFO: Apache ActiveMQ 5.13.1 (localhost, ID:52.16.184.35.bc.googleusercontent.com-36581-1515790470484-0:3) uptime 2.885 seconds&lt;br/&gt;
Jan 12, 2018 8:55:03 PM org.apache.activemq.broker.BrokerService stop&lt;br/&gt;
INFO: Apache ActiveMQ 5.13.1 (localhost, ID:52.16.184.35.bc.googleusercontent.com-36581-1515790470484-0:3) is shutdown&lt;br/&gt;
Jan 12, 2018 8:55:03 PM org.apache.beam.sdk.io.mqtt.MqttIOTest startBroker&lt;br/&gt;
INFO: Finding free network port&lt;br/&gt;
Jan 12, 2018 8:55:03 PM org.apache.beam.sdk.io.mqtt.MqttIOTest startBroker&lt;br/&gt;
INFO: Starting ActiveMQ brokerService on 38757&lt;br/&gt;
Jan 12, 2018 8:55:03 PM org.apache.activemq.broker.BrokerService doStartPersistenceAdapter&lt;br/&gt;
INFO: Using Persistence Adapter: MemoryPersistenceAdapter&lt;br/&gt;
Jan 12, 2018 8:55:03 PM org.apache.activemq.broker.BrokerService doStartBroker&lt;br/&gt;
INFO: Apache ActiveMQ 5.13.1 (localhost, ID:52.16.184.35.bc.googleusercontent.com-36581-1515790470484-0:4) is starting&lt;br/&gt;
Jan 12, 2018 8:55:03 PM org.apache.activemq.transport.TransportServerThreadSupport doStart&lt;br/&gt;
INFO: Listening for connections at: mqtt://localhost:38757&lt;br/&gt;
Jan 12, 2018 8:55:03 PM org.apache.activemq.broker.TransportConnector start&lt;br/&gt;
INFO: Connector mqtt://localhost:38757 started&lt;br/&gt;
Jan 12, 2018 8:55:03 PM org.apache.activemq.broker.BrokerService doStartBroker&lt;br/&gt;
INFO: Apache ActiveMQ 5.13.1 (localhost, ID:52.16.184.35.bc.googleusercontent.com-36581-1515790470484-0:4) started&lt;br/&gt;
Jan 12, 2018 8:55:03 PM org.apache.activemq.broker.BrokerService doStartBroker&lt;br/&gt;
INFO: For help or more information please see: &lt;a href=&quot;http://activemq.apache.org&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://activemq.apache.org&lt;/a&gt;&lt;br/&gt;
Jan 12, 2018 8:55:04 PM org.apache.beam.sdk.io.mqtt.MqttIOTest$1 run&lt;br/&gt;
INFO: Waiting pipeline connected to the MQTT broker before sending messages ...&lt;br/&gt;
Jan 12, 2018 8:56:03 PM org.apache.activemq.broker.BrokerService stop&lt;br/&gt;
INFO: Apache ActiveMQ 5.13.1 (localhost, ID:52.16.184.35.bc.googleusercontent.com-36581-1515790470484-0:4) is shutting down&lt;br/&gt;
Jan 12, 2018 8:56:04 PM org.apache.activemq.broker.TransportConnector stop&lt;br/&gt;
INFO: Connector mqtt://localhost:38757 stopped&lt;br/&gt;
Jan 12, 2018 8:56:04 PM org.apache.activemq.broker.BrokerService stop&lt;br/&gt;
INFO: Apache ActiveMQ 5.13.1 (localhost, ID:52.16.184.35.bc.googleusercontent.com-36581-1515790470484-0:4) uptime 1 minute&lt;br/&gt;
Jan 12, 2018 8:56:04 PM org.apache.activemq.broker.BrokerService stop&lt;br/&gt;
INFO: Apache ActiveMQ 5.13.1 (localhost, ID:52.16.184.35.bc.googleusercontent.com-36581-1515790470484-0:4) is shutdown&lt;/p&gt;</comment>
                            <comment id="16324726" author="githubbot" created="Fri, 12 Jan 2018 23:26:21 +0000"  >&lt;p&gt;lukecwik opened a new pull request #4406: &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3336&quot; title=&quot;MqttIO read tests are flaky&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-3336&quot;&gt;&lt;del&gt;BEAM-3336&lt;/del&gt;&lt;/a&gt; Fix thread safety issues of MqttIOTest&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/beam/pull/4406&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/4406&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Ran the tests on my desktop 50 times with zero flakes.&lt;/p&gt;

&lt;p&gt;   Follow this checklist to help us incorporate your contribution quickly and easily:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Make sure there is a &lt;span class=&quot;error&quot;&gt;&amp;#91;JIRA issue&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://issues.apache.org/jira/projects/BEAM/issues/&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/projects/BEAM/issues/&lt;/a&gt;) filed for the change (usually before you start working on it).  Trivial changes like typos do not require a JIRA issue.  Your pull request should address just this issue, without pulling in other changes.&lt;/li&gt;
	&lt;li&gt;[ ] Each commit in the pull request should have a meaningful subject line and body.&lt;/li&gt;
	&lt;li&gt;[ ] Format the pull request title like `&lt;span class=&quot;error&quot;&gt;&amp;#91;BEAM-XXX&amp;#93;&lt;/span&gt; Fixes bug in ApproximateQuantiles`, where you replace `BEAM-XXX` with the appropriate JIRA issue.&lt;/li&gt;
	&lt;li&gt;[ ] Write a pull request description that is detailed enough to understand what the pull request does, how, and why.&lt;/li&gt;
	&lt;li&gt;[ ] Run `mvn clean verify` to make sure basic checks pass. A more thorough check will be performed on your pull request automatically.&lt;/li&gt;
	&lt;li&gt;[ ] If this contribution is large, please file an Apache &lt;span class=&quot;error&quot;&gt;&amp;#91;Individual Contributor License Agreement&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://www.apache.org/licenses/icla.pdf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.apache.org/licenses/icla.pdf&lt;/a&gt;).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   &amp;#8212;&lt;/p&gt;


&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16324990" author="githubbot" created="Sat, 13 Jan 2018 06:14:04 +0000"  >&lt;p&gt;lukecwik closed pull request #4406: &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3336&quot; title=&quot;MqttIO read tests are flaky&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-3336&quot;&gt;&lt;del&gt;BEAM-3336&lt;/del&gt;&lt;/a&gt; Fix thread safety issues of MqttIOTest&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/beam/pull/4406&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/4406&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/sdks/java/io/mqtt/src/test/java/org/apache/beam/sdk/io/mqtt/MqttIOTest.java b/sdks/java/io/mqtt/src/test/java/org/apache/beam/sdk/io/mqtt/MqttIOTest.java&lt;br/&gt;
index d7baf3bf989..94ab0abc91f 100644&lt;br/&gt;
&amp;#8212; a/sdks/java/io/mqtt/src/test/java/org/apache/beam/sdk/io/mqtt/MqttIOTest.java&lt;br/&gt;
+++ b/sdks/java/io/mqtt/src/test/java/org/apache/beam/sdk/io/mqtt/MqttIOTest.java&lt;br/&gt;
@@ -22,9 +22,8 @@&lt;/p&gt;

&lt;p&gt; import java.net.ServerSocket;&lt;br/&gt;
 import java.util.ArrayList;&lt;br/&gt;
-import java.util.HashSet;&lt;br/&gt;
 import java.util.Set;&lt;br/&gt;
-&lt;br/&gt;
+import java.util.concurrent.ConcurrentSkipListSet;&lt;br/&gt;
 import org.apache.activemq.broker.BrokerService;&lt;br/&gt;
 import org.apache.activemq.broker.Connection;&lt;br/&gt;
 import org.apache.beam.sdk.io.mqtt.MqttIO.Read;&lt;br/&gt;
@@ -53,9 +52,9 @@&lt;/p&gt;

&lt;p&gt;   private static final Logger LOG = LoggerFactory.getLogger(MqttIOTest.class);&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static transient BrokerService brokerService;&lt;br/&gt;
+  private BrokerService brokerService;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static int port;&lt;br/&gt;
+  private int port;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   @Rule&lt;br/&gt;
   public final transient TestPipeline pipeline = TestPipeline.create();&lt;br/&gt;
@@ -63,9 +62,9 @@&lt;br/&gt;
   @Before&lt;br/&gt;
   public void startBroker() throws Exception {&lt;br/&gt;
     LOG.info(&quot;Finding free network port&quot;);&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ServerSocket socket = new ServerSocket(0);&lt;/li&gt;
	&lt;li&gt;port = socket.getLocalPort();&lt;/li&gt;
	&lt;li&gt;socket.close();&lt;br/&gt;
+    try (ServerSocket socket = new ServerSocket(0)) 
{
+      port = socket.getLocalPort();
+    }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     LOG.info(&quot;Starting ActiveMQ brokerService on {}&quot;, port);&lt;br/&gt;
     brokerService = new BrokerService();&lt;br/&gt;
@@ -81,11 +80,9 @@ public void startBroker() throws Exception {&lt;br/&gt;
   public void testReadNoClientId() throws Exception {&lt;br/&gt;
     final String topicName = &quot;READ_TOPIC_NO_CLIENT_ID&quot;;&lt;br/&gt;
     Read mqttReader = MqttIO.read()&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;.withConnectionConfiguration(&lt;/li&gt;
	&lt;li&gt;MqttIO.ConnectionConfiguration.create(&lt;/li&gt;
	&lt;li&gt;&quot;tcp://localhost:&quot; + port,&lt;/li&gt;
	&lt;li&gt;topicName))&lt;/li&gt;
	&lt;li&gt;.withMaxNumRecords(10);&lt;br/&gt;
+        .withConnectionConfiguration(&lt;br/&gt;
+            MqttIO.ConnectionConfiguration.create(&quot;tcp://localhost:&quot; + port, topicName))&lt;br/&gt;
+        .withMaxNumRecords(10);&lt;br/&gt;
     PCollection&amp;lt;byte[]&amp;gt; output = pipeline.apply(mqttReader);&lt;br/&gt;
     PAssert.that(output).containsInAnyOrder(&lt;br/&gt;
         &quot;This is test 0&quot;.getBytes(),&lt;br/&gt;
@@ -122,7 +119,7 @@ public void run() {&lt;br/&gt;
           }&lt;br/&gt;
           for (int i = 0; i &amp;lt; 10; i++) 
{
             publishConnection.publish(topicName, (&quot;This is test &quot; + i).getBytes(),
-                QoS.AT_LEAST_ONCE, false);
+                QoS.EXACTLY_ONCE, false);
           }
&lt;p&gt;         } catch (Exception e) {&lt;br/&gt;
           // nothing to do&lt;br/&gt;
@@ -136,7 +133,7 @@ public void run() &lt;/p&gt;
{
     publisherThread.join();
   }&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Test(timeout = 5 * 1000)&lt;br/&gt;
+  @Test(timeout = 30 * 1000)&lt;br/&gt;
   public void testRead() throws Exception {&lt;br/&gt;
     PCollection&amp;lt;byte[]&amp;gt; output = pipeline.apply(&lt;br/&gt;
         MqttIO.read()&lt;br/&gt;
@@ -181,7 +178,7 @@ public void run() {&lt;br/&gt;
           }&lt;br/&gt;
           for (int i = 0; i &amp;lt; 10; i++) 
{
             publishConnection.publish(&quot;READ_TOPIC&quot;, (&quot;This is test &quot; + i).getBytes(),
-                QoS.AT_LEAST_ONCE, false);
+                QoS.EXACTLY_ONCE, false);
           }
&lt;p&gt;         } catch (Exception e) {&lt;br/&gt;
           // nothing to do&lt;br/&gt;
@@ -191,14 +188,14 @@ public void run() &lt;/p&gt;
{
     publisherThread.start();
     pipeline.run();
 
-    publishConnection.disconnect();
     publisherThread.join();
+    publishConnection.disconnect();
   }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Test for &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3282&quot; title=&quot;MqttIO reader should use receive with timeout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-3282&quot;&gt;&lt;del&gt;BEAM-3282&lt;/del&gt;&lt;/a&gt;: this test should not timeout.&lt;br/&gt;
    */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Test(timeout = 5 * 1000)&lt;br/&gt;
+  @Test(timeout = 30 * 1000)&lt;br/&gt;
   public void testReceiveWithTimeoutAndNoData() throws Exception {&lt;br/&gt;
     pipeline.apply(MqttIO.read()&lt;br/&gt;
         .withConnectionConfiguration(&lt;br/&gt;
@@ -213,18 +210,19 @@ public void testReceiveWithTimeoutAndNoData() throws Exception {&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   @Test&lt;br/&gt;
   public void testWrite() throws Exception {&lt;br/&gt;
+    final int numberOfTestMessages = 200;&lt;br/&gt;
     MQTT client = new MQTT();&lt;br/&gt;
     client.setHost(&quot;tcp://localhost:&quot; + port);&lt;br/&gt;
     final BlockingConnection connection = client.blockingConnection();&lt;br/&gt;
     connection.connect();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;connection.subscribe(new Topic[]
{new Topic(Buffer.utf8(&quot;WRITE_TOPIC&quot;), QoS.AT_LEAST_ONCE)}
&lt;p&gt;);&lt;br/&gt;
+    connection.subscribe(new Topic[]&lt;/p&gt;
{new Topic(Buffer.utf8(&quot;WRITE_TOPIC&quot;), QoS.EXACTLY_ONCE)}
&lt;p&gt;);&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;final Set&amp;lt;String&amp;gt; messages = new HashSet&amp;lt;&amp;gt;();&lt;br/&gt;
+    final Set&amp;lt;String&amp;gt; messages = new ConcurrentSkipListSet&amp;lt;&amp;gt;();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     Thread subscriber = new Thread() {&lt;br/&gt;
       public void run() {&lt;br/&gt;
         try {&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (int i = 0; i &amp;lt; 200; i++) {&lt;br/&gt;
+          for (int i = 0; i &amp;lt; numberOfTestMessages; i++) {&lt;br/&gt;
             Message message = connection.receive();&lt;br/&gt;
             messages.add(new String(message.getPayload()));&lt;br/&gt;
             message.ack();&lt;br/&gt;
@@ -237,7 +235,7 @@ public void run() {&lt;br/&gt;
     subscriber.start();&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     ArrayList&amp;lt;byte[]&amp;gt; data = new ArrayList&amp;lt;&amp;gt;();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;for (int i = 0; i &amp;lt; 200; i++) {&lt;br/&gt;
+    for (int i = 0; i &amp;lt; numberOfTestMessages; i++) 
{
       data.add((&quot;Test &quot; + i).getBytes());
     }
&lt;p&gt;     pipeline.apply(Create.of(data))&lt;br/&gt;
@@ -251,8 +249,8 @@ public void run() {&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;     connection.disconnect();&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;assertEquals(200, messages.size());&lt;/li&gt;
	&lt;li&gt;for (int i = 0; i &amp;lt; 200; i++) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {+    assertEquals(numberOfTestMessages, messages.size());+    for (int i = 0; i &amp;lt; numberOfTestMessages; i++) {
       assertTrue(messages.contains(&quot;Test &quot; + i));
     }   }&lt;/span&gt; &lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16325005" author="jbonofre" created="Sat, 13 Jan 2018 06:38:34 +0000"  >&lt;p&gt;The PR has been merged.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 44 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3nto7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>