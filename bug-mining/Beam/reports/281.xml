<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:44:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-539] Error when writing to the root of a GCS location</title>
                <link>https://issues.apache.org/jira/browse/BEAM-539</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;User issue: &lt;a href=&quot;http://stackoverflow.com/questions/38811152/google-dataflow-python-pipeline-write-failure&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/questions/38811152/google-dataflow-python-pipeline-write-failure&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Reproduction: use a TextFileSink and set output locations as gs://mybucket and it fails. Change it to gs://mybucket/ and it works.&lt;/p&gt;

&lt;p&gt;The final output path is generated here:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/incubator-beam/blob/python-sdk/sdks/python/apache_beam/io/fileio.py#L495&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/incubator-beam/blob/python-sdk/sdks/python/apache_beam/io/fileio.py#L495&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;And this seemingly works in the Java SDK.&lt;/p&gt;

&lt;p&gt;Stack:&lt;/p&gt;

&lt;p&gt;  File &quot;/usr/local/lib/python2.7/dist-packages/apache_beam/io/iobase.py&quot;, line 1058, in finish_bundle&lt;br/&gt;
    yield window.TimestampedValue(self.writer.close(), window.MAX_TIMESTAMP)&lt;br/&gt;
  File &quot;/usr/local/lib/python2.7/dist-packages/apache_beam/io/fileio.py&quot;, line 601, in close&lt;br/&gt;
    self.sink.close(self.temp_handle)&lt;br/&gt;
  File &quot;/usr/local/lib/python2.7/dist-packages/apache_beam/io/fileio.py&quot;, line 687, in close&lt;br/&gt;
    file_handle.close()&lt;br/&gt;
  File &quot;/usr/local/lib/python2.7/dist-packages/apache_beam/io/gcsio.py&quot;, line 617, in close&lt;br/&gt;
    self._flush_write_buffer()&lt;br/&gt;
  File &quot;/usr/local/lib/python2.7/dist-packages/apache_beam/io/gcsio.py&quot;, line 647, in _flush_write_buffer&lt;br/&gt;
    raise self.upload_thread.last_error  # pylint: disable=raising-bad-type&lt;br/&gt;
HttpError: HttpError accessing &amp;lt;&lt;a href=&quot;https://www.googleapis.com/resumable/upload/storage/v1/b/mybucket-temp-2016-08-08_21-29-39/o?uploadType=resumable&amp;amp;alt=json&amp;amp;name=f1cd7fe2-cf96-4d1d-bb5b-a6252cbcd342&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.googleapis.com/resumable/upload/storage/v1/b/mybucket-temp-2016-08-08_21-29-39/o?uploadType=resumable&amp;amp;alt=json&amp;amp;name=f1cd7fe2-cf96-4d1d-bb5b-a6252cbcd342&lt;/a&gt;&amp;gt;: response: &amp;lt;&lt;/p&gt;
{&apos;status&apos;: &apos;404&apos;, &apos;alternate-protocol&apos;: &apos;443:quic&apos;, &apos;content-length&apos;: &apos;165&apos;, &apos;vary&apos;: &apos;Origin, X-Origin&apos;, &apos;server&apos;: &apos;UploadServer&apos;, &apos;x-guploader-uploadid&apos;: &apos;AEnB2Uq6ZGb_CsrMVxozv6aL48k4OMMiRgYVeVGmJrM-sMQWRGeGMkesOQg5F0W7HZuaqTBog_d4ml-DlIars_ZvJTejdfcbAUr4gswZWVieq82ufc3WR2g&apos;, &apos;date&apos;: &apos;Mon, 08 Aug 2016 21:29:46 GMT&apos;, &apos;alt-svc&apos;: &apos;quic=&quot;:443&quot;; ma=2592000; v=&quot;36,35,34,33,32,31,30&quot;&apos;, &apos;content-type&apos;: &apos;application/json; charset=UTF-8&apos;}
&lt;p&gt;&amp;gt;, content &amp;lt;{&lt;br/&gt;
 &quot;error&quot;: {&lt;br/&gt;
  &quot;errors&quot;: [&lt;/p&gt;
   {
    &quot;domain&quot;: &quot;global&quot;,
    &quot;reason&quot;: &quot;notFound&quot;,
    &quot;message&quot;: &quot;Not Found&quot;
   }
&lt;p&gt;  ],&lt;br/&gt;
  &quot;code&quot;: 404,&lt;br/&gt;
  &quot;message&quot;: &quot;Not Found&quot;&lt;br/&gt;
 }&lt;br/&gt;
}&lt;/p&gt;</description>
                <environment></environment>
        <key id="12995770">BEAM-539</key>
            <summary>Error when writing to the root of a GCS location</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10103" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">P3</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chamikara">Chamikara Madhusanka Jayalath</assignee>
                                    <reporter username="altay">Ahmet Altay</reporter>
                        <labels>
                            <label>newbie</label>
                            <label>starter</label>
                    </labels>
                <created>Mon, 8 Aug 2016 22:06:48 +0000</created>
                <updated>Sat, 16 May 2020 13:19:32 +0000</updated>
                            <resolved>Tue, 2 May 2017 21:04:38 +0000</resolved>
                                                    <fixVersion>2.0.0</fixVersion>
                                    <component>sdk-py-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15959260" author="altay" created="Thu, 6 Apr 2017 16:47:08 +0000"  >&lt;p&gt;Any updates here? Should we unassign and make it a starter issue?&lt;/p&gt;</comment>
                            <comment id="15983679" author="altay" created="Tue, 25 Apr 2017 21:49:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chamikara&quot; class=&quot;user-hover&quot; rel=&quot;chamikara&quot;&gt;chamikara&lt;/a&gt;, is this fixed with &lt;tt&gt;join&lt;/tt&gt; in BFS?&lt;/p&gt;</comment>
                            <comment id="15983788" author="chamikara" created="Tue, 25 Apr 2017 23:01:16 +0000"  >&lt;p&gt;That PR will not automatically fix this but we can use that. I&apos;ll send out a PR for this after PR-2665 is in.&lt;/p&gt;</comment>
                            <comment id="15985701" author="chamikara" created="Wed, 26 Apr 2017 22:55:40 +0000"  >&lt;p&gt;We currently write temp files to a sibling of output &apos;file_path_prefix&apos; given by the user. So, if file_path_prefix is gs://foo/bar, we write temp files to to gs://foo/bar-temp. We cannot write to gs://foo because GCS doesn&apos;t allow creating a directory of the form gs://foo-temp (which will end up being a bucket) using the file creation API.&lt;/p&gt;

&lt;p&gt;We currently support gs://foo/ by mistake. In this case we create temporary files in a directory gs://foo/-temp.&lt;/p&gt;

&lt;p&gt;Java SDK correctly fails for both gs://foo and gs://foo/.&lt;/p&gt;

&lt;p&gt;So I think instead of fixing this issue we should fix the inconsistency by not allowing gs://foo/ as well.&lt;/p&gt;

&lt;p&gt;While researching for this I found two additional issues with Python FileSink implementation that I&apos;ll try to fix in the same PR.&lt;/p&gt;

&lt;p&gt;(1) temporary files should be written to  gs://foo/beam-temp-uid1/... instead of gs://foo/bar-temp to make sure that users who try to match output files with the pattern gs://foo/* do not capture temp files. (see &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; for a thread related to this)&lt;/p&gt;

&lt;p&gt;(2) we currently do not delete temporary files from failed bundles we are only renaming output from successful bundles (this is a significant issue since it could result in duplicate data).&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://lists.apache.org/thread.html/6cefa5034cff4c421abd9a8db2aa98f6083fcd7a6b497dad86f72bf5@%3Cdev.beam.apache.org%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lists.apache.org/thread.html/6cefa5034cff4c421abd9a8db2aa98f6083fcd7a6b497dad86f72bf5@%3Cdev.beam.apache.org%3E&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jkff&quot; class=&quot;user-hover&quot; rel=&quot;jkff&quot;&gt;jkff&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=robertwb&quot; class=&quot;user-hover&quot; rel=&quot;robertwb&quot;&gt;robertwb&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dhalperi%40google.com&quot; class=&quot;user-hover&quot; rel=&quot;dhalperi@google.com&quot;&gt;dhalperi@google.com&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sb2nov&quot; class=&quot;user-hover&quot; rel=&quot;sb2nov&quot;&gt;sb2nov&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15989495" author="githubbot" created="Fri, 28 Apr 2017 21:46:19 +0000"  >&lt;p&gt;GitHub user chamikaramj opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/beam/pull/2770&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/2770&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-539&quot; title=&quot;Error when writing to the root of a GCS location&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-539&quot;&gt;&lt;del&gt;BEAM-539&lt;/del&gt;&lt;/a&gt; Fixes several issues of FileSink&lt;/p&gt;

&lt;p&gt;    (1) Updates FileSink to fail for file name prefixes that only contain a single component (for example GCS buckets).&lt;/p&gt;

&lt;p&gt;    For example, currently FileSink fails for  gs://aaa while passing for gs://aaa/. This change makes FileSink fail for both cases (and makes the behavior consistent with Java).&lt;/p&gt;

&lt;p&gt;    (2) Updates the name of the temporary directory created by FileSink&lt;/p&gt;

&lt;p&gt;    Currently , for a filename prefix &apos;gs://aaa/bbb&apos;, the temp path would be of the form gs://aaa/bbb-temp-... .&lt;br/&gt;
    This is error prone since a user pattern &apos;gs://aaa/bbb*&apos; would match temp files. This changes makes the temp path format &apos;gs://aaa/beam-temp-bbb-...&apos; instead.&lt;/p&gt;

&lt;p&gt;    To achieve above this PR adds a method &apos;split()&apos; to FileSystem interface that is analogous to Python &apos;os.path.split()&apos; (and which has the opposite effect of current method FileSystem.join())&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/chamikaramj/beam&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/chamikaramj/beam&lt;/a&gt; gcs_root_location_file_sink&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/beam/pull/2770.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/2770.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2770&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit b66ae881a5adcdc5be8ee67a6d4ad842a2ea0147&lt;br/&gt;
Author: Chamikara Jayalath &amp;lt;chamikara@google.com&amp;gt;&lt;br/&gt;
Date:   2017-04-28T21:38:35Z&lt;/p&gt;

&lt;p&gt;    Fixes several issues of FileSink.&lt;/p&gt;

&lt;p&gt;    (1) Updates FileSink to fail for file name prefixes that only contain a single component (for example GCS buckets).&lt;/p&gt;

&lt;p&gt;    For example, currently FileSink fails for  gs://aaa while passing for gs://aaa/. This change makes FileSink fail for both cases (and makes the behaviour consistent with Java).&lt;/p&gt;

&lt;p&gt;    (2) Updates the name of the temporary directory created by FileSink&lt;/p&gt;

&lt;p&gt;    Currently , for a filename prefix &apos;gs://aaa/bbb&apos;, the temp path would be of the form gs://aaa/bbb-temp-... .&lt;br/&gt;
    This is error prone since a user pattern &apos;gs://aaa/bbb*&apos; would match temp files. This changes makes the temp path format &apos;gs://aaa/beam-temp-bbb-...&apos; instead.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15991709" author="chamikara" created="Mon, 1 May 2017 22:58:13 +0000"  >&lt;p&gt;Turns out, we already delete all temp files &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;. I was observing undeleted temp files due to GCS eventual consistency.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/beam/pull/2770&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/2770&lt;/a&gt; fixes other issues mentioned above.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/beam/blob/master/sdks/python/apache_beam/io/fileio.py#L242&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/blob/master/sdks/python/apache_beam/io/fileio.py#L242&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15993730" author="githubbot" created="Tue, 2 May 2017 20:57:37 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/beam/pull/2770&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/2770&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 28 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3223r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>