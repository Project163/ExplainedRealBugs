<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:01:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-7978] ArithmeticExceptions on getting backlog bytes </title>
                <link>https://issues.apache.org/jira/browse/BEAM-7978</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;Beam&#160;2.14.0&lt;br/&gt;
 (and to be more precise &lt;a href=&quot;https://github.com/apache/beam/commit/9fe0a0387ad1f894ef02acf32edbc9623a3b13ad#diff-b4964a457006b1555c7042c739b405ec&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;commit&lt;/a&gt;)&#160;introduced a change in watermark calculation in Kinesis IO causing below error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
exception:  &quot;java.lang.RuntimeException: Unknown kinesis failure, when trying to reach kinesis
	at org.apache.beam.sdk.io.kinesis.SimplifiedKinesisClient.wrapExceptions(SimplifiedKinesisClient.java:227)
	at org.apache.beam.sdk.io.kinesis.SimplifiedKinesisClient.getBacklogBytes(SimplifiedKinesisClient.java:167)
	at org.apache.beam.sdk.io.kinesis.SimplifiedKinesisClient.getBacklogBytes(SimplifiedKinesisClient.java:155)
	at org.apache.beam.sdk.io.kinesis.KinesisReader.getTotalBacklogBytes(KinesisReader.java:158)
	at org.apache.beam.runners.dataflow.worker.StreamingModeExecutionContext.flushState(StreamingModeExecutionContext.java:433)
	at org.apache.beam.runners.dataflow.worker.StreamingDataflowWorker.process(StreamingDataflowWorker.java:1289)
	at org.apache.beam.runners.dataflow.worker.StreamingDataflowWorker.access$1000(StreamingDataflowWorker.java:149)
	at org.apache.beam.runners.dataflow.worker.StreamingDataflowWorker$6.run(StreamingDataflowWorker.java:1024)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: java.lang.ArithmeticException: Value cannot fit in an &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;: 153748963401
	at org.joda.time.field.FieldUtils.safeToInt(FieldUtils.java:229)
	at org.joda.time.field.BaseDurationField.getDifference(BaseDurationField.java:141)
	at org.joda.time.base.BaseSingleFieldPeriod.between(BaseSingleFieldPeriod.java:72)
	at org.joda.time.Minutes.minutesBetween(Minutes.java:101)
	at org.apache.beam.sdk.io.kinesis.SimplifiedKinesisClient.lambda$getBacklogBytes$3(SimplifiedKinesisClient.java:169)
	at org.apache.beam.sdk.io.kinesis.SimplifiedKinesisClient.wrapExceptions(SimplifiedKinesisClient.java:210)
	... 10 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We spotted this issue on Dataflow runner. It&apos;s problematic as inability to get backlog bytes seems to result in constant recreation of KinesisReader.&lt;/p&gt;

&lt;p&gt;The issue happens if the backlog bytes are&#160;retrieved before watermark value is updated from initial default value. Easy way to reproduce it is to create a pipeline with Kinesis source for a stream where no&#160;records&#160;are being put. While debugging it locally, you can observe that the watermark is set to the value on the past (like: &quot;-290308-12-21T19:59:05.225Z&quot;). After two minutes (default watermark idle duration threshold is set to 2 minutes)&#160;, the watermark is set to value of &lt;a href=&quot;https://github.com/apache/beam/blob/9fe0a0387ad1f894ef02acf32edbc9623a3b13ad/sdks/java/io/kinesis/src/main/java/org/apache/beam/sdk/io/kinesis/WatermarkPolicyFactory.java#L110&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;watermarkIdleThreshold&lt;/a&gt;), so the next backlog bytes retrieval should be correct. However, as described before, running the pipeline on Dataflow runner results in KinesisReader being closed just after creation, so the watermark won&apos;t be fixed.&lt;/p&gt;

&lt;p&gt;The reason of the issue is following: The introduced watermark policies are relying on &lt;a href=&quot;https://github.com/apache/beam/blob/9fe0a0387ad1f894ef02acf32edbc9623a3b13ad/sdks/java/io/kinesis/src/main/java/org/apache/beam/sdk/io/kinesis/WatermarkParameters.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;WatermarkParameters&lt;/a&gt; which initialises currentWatermark and eventTime to &lt;a href=&quot;https://github.com/apache/beam/commit/9fe0a0387ad1f894ef02acf32edbc9623a3b13ad#diff-b4964a457006b1555c7042c739b405ecR52&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;BoundedWindow.TIMESTAMP_MIN_VALUE&lt;/a&gt;. This result in watermark being set to new Instant(-9223372036854775L) at the KinesisReader creation. Calculated &lt;a href=&quot;https://github.com/apache/beam/blob/9fe0a0387ad1f894ef02acf32edbc9623a3b13ad/sdks/java/io/kinesis/src/main/java/org/apache/beam/sdk/io/kinesis/SimplifiedKinesisClient.java#L169&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;period between the watermark and the current timestamp&lt;/a&gt; is bigger than expected causing the ArithmeticException to be thrown.&lt;/p&gt;

&lt;p&gt;The maximum retention on Kinesis streams is&#160; &lt;a href=&quot;https://aws.amazon.com/kinesis/data-streams/faqs/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;7 days&lt;/a&gt; so it should be safe to initialise the affected watermark parameters with new Instant().minus(MAX_KINESIS_STREAM_RETENTION_PERIOD) where MAX_KINESIS_STREAM_RETENTION_PERIOD is the duration of 7 days.&lt;/p&gt;

&lt;p&gt;Remark: seems that in the past there was&#160;similar&#160;issue present (fixed in 2.4). Please look into the&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3881&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;ticket&lt;/a&gt;.&#160;&lt;/p&gt;

&lt;p&gt;Best regards,&lt;br/&gt;
 Mateusz&lt;/p&gt;</description>
                <environment></environment>
        <key id="13250781">BEAM-7978</key>
            <summary>ArithmeticExceptions on getting backlog bytes </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aromanenko">Alexey Romanenko</assignee>
                                    <reporter username="Juraszek">Mateusz</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Aug 2019 12:00:45 +0000</created>
                <updated>Sat, 16 May 2020 14:08:17 +0000</updated>
                            <resolved>Fri, 30 Aug 2019 09:09:22 +0000</resolved>
                                    <version>2.14.0</version>
                                    <fixVersion>2.16.0</fixVersion>
                                    <component>io-java-kinesis</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="16907539" author="chamikara" created="Wed, 14 Aug 2019 18:50:51 +0000"  >&lt;p&gt;I guess this can occur for other runners as well ?&lt;/p&gt;

&lt;p&gt;CCing some folks who recently updated Kinesis:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aromanenko&quot; class=&quot;user-hover&quot; rel=&quot;aromanenko&quot;&gt;aromanenko&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iemejia&quot; class=&quot;user-hover&quot; rel=&quot;iemejia&quot;&gt;iemejia&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rtshadow&quot; class=&quot;user-hover&quot; rel=&quot;rtshadow&quot;&gt;rtshadow&lt;/a&gt; @&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16908730" author="juraszek" created="Fri, 16 Aug 2019 05:39:57 +0000"  >&lt;p&gt;Hello &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chamikara&quot; class=&quot;user-hover&quot; rel=&quot;chamikara&quot;&gt;chamikara&lt;/a&gt;, I&#160;guess all the runners that are executing method getTotalBacklogBytes() on reader are affected. In case of Dataflow Reader,&#160;it results in constant recreation of reader, so the pipeline can&apos;t progress correctly.&lt;/p&gt;

&lt;p&gt;Adding also &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ajo.thomas24&quot; class=&quot;user-hover&quot; rel=&quot;ajo.thomas24&quot;&gt;ajo.thomas24&lt;/a&gt; who contributed changes to watermark calculations.&lt;/p&gt;</comment>
                            <comment id="16911492" author="aromanenko" created="Tue, 20 Aug 2019 15:57:34 +0000"  >&lt;p&gt;Thanks for reporting this, I&apos;ll take a look&lt;/p&gt;</comment>
                            <comment id="16911880" author="chamikara" created="Wed, 21 Aug 2019 02:04:42 +0000"  >&lt;p&gt;Thanks Alexey. Assigned the Jira to you.&lt;/p&gt;</comment>
                            <comment id="16914387" author="aromanenko" created="Fri, 23 Aug 2019 15:56:18 +0000"  >&lt;p&gt;As far as I can tell, &lt;tt&gt;getTotalBacklogBytes()&lt;/tt&gt; is used only in Dataflow runner, so seems like no other runners are affected. I tested with direct and spark runners and didn&apos;t notice any major issues (well, except the fact, that initial watermark is set to &lt;tt&gt;BoundedWindow.TIMESTAMP_MIN_VALUE&lt;/tt&gt; and then updated). So, the fix looks simple on the first sight.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Juraszek&quot; class=&quot;user-hover&quot; rel=&quot;Juraszek&quot;&gt;Juraszek&lt;/a&gt; Thank you for detailed issue description. Would you be able to test it on your side?&lt;/p&gt;</comment>
                            <comment id="16915521" author="juraszek" created="Mon, 26 Aug 2019 06:48:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aromanenko&quot; class=&quot;user-hover&quot; rel=&quot;aromanenko&quot;&gt;aromanenko&lt;/a&gt;, you might be right that currently only Dataflow runner is affected (I&apos;ve searched in repository and getTotalBacklogBytes() is executed only from dataflow runner&apos;s code).&lt;/p&gt;

&lt;p&gt;As mentioned in the ticket&apos;s description, I&apos;ve tested it locally and with Dataflow runner - execution with direct runner looks fine.&lt;/p&gt;

&lt;p&gt;If the watermark is initialised with BoundedWindow.TIMESTAMP_MIN_VALUE then the getTotalBacklogBytes() should be prepared for such scenario. I wonder if in case of uninitialised watermark, UnboundedReader.BACKLOG_UNKNOWN should be returned to indicate decision shouldn&apos;t be made based on the data? Because, if initial value of watermark/event time would be changed to previous value (Instant().minus(MAX_KINESIS_STREAM_RETENTION_PERIOD)) then the method won&apos;t throw exception on execution, but would provide false information about remaining bytes to process.&lt;/p&gt;</comment>
                            <comment id="16915743" author="aromanenko" created="Mon, 26 Aug 2019 12:09:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Juraszek&quot; class=&quot;user-hover&quot; rel=&quot;Juraszek&quot;&gt;Juraszek&lt;/a&gt; I agree with your last sentence and it would make sense to return &lt;tt&gt;UnboundedReader.BACKLOG_UNKNOWN&lt;/tt&gt; if watermark was not initialised, this is very logical. In &lt;tt&gt;KafkaIO&lt;/tt&gt; we do similar thing for &lt;tt&gt;getSplitBacklogBytes()&lt;/tt&gt; when partition offsets were not initialised we return &lt;tt&gt;UnboundedReader.BACKLOG_UNKNOWN&lt;/tt&gt;.&lt;br/&gt;
Do you want me to provide a fix or you wish to do it by your own? I&apos;d be happy to review in this case. &lt;/p&gt;</comment>
                            <comment id="16915747" author="juraszek" created="Mon, 26 Aug 2019 12:13:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aromanenko&quot; class=&quot;user-hover&quot; rel=&quot;aromanenko&quot;&gt;aromanenko&lt;/a&gt; I&apos;m not sure when I could start working on this, so it would be great if you could provide a fix&lt;/p&gt;</comment>
                            <comment id="16915893" author="aromanenko" created="Mon, 26 Aug 2019 15:37:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Juraszek&quot; class=&quot;user-hover&quot; rel=&quot;Juraszek&quot;&gt;Juraszek&lt;/a&gt; Sure, I created a PR for that&lt;/p&gt;</comment>
                            <comment id="16918516" author="aromanenko" created="Thu, 29 Aug 2019 11:25:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Juraszek&quot; class=&quot;user-hover&quot; rel=&quot;Juraszek&quot;&gt;Juraszek&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chamikara&quot; class=&quot;user-hover&quot; rel=&quot;chamikara&quot;&gt;chamikara&lt;/a&gt; Could you take a look on this PR: &lt;a href=&quot;https://github.com/apache/beam/pull/9432?&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/9432?&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16919201" author="juraszek" created="Fri, 30 Aug 2019 05:24:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aromanenko&quot; class=&quot;user-hover&quot; rel=&quot;aromanenko&quot;&gt;aromanenko&lt;/a&gt;, looks good from my perspective&lt;/p&gt;</comment>
                            <comment id="16923775" author="kenn" created="Thu, 5 Sep 2019 22:17:49 +0000"  >&lt;p&gt;I just happened to dig in to this, and really Minutes.between(instant, instant) is not safe unless you handle the overflow and convert to UNKNOWN behavior. Localizing to this is, in the simplified kinesis client, seems best. That keeps the troublesome behavior to a minimum. It is better than forcing a complex spec outside this local function.&lt;/p&gt;</comment>
                            <comment id="16933340" author="aromanenko" created="Thu, 19 Sep 2019 12:39:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kenn&quot; class=&quot;user-hover&quot; rel=&quot;kenn&quot;&gt;kenn&lt;/a&gt; Do you mean that something should be changed there or it&apos;s ok for now since it&apos;s localised in &lt;tt&gt;SimplifiedKinesisClient&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="16933652" author="kenn" created="Thu, 19 Sep 2019 18:23:27 +0000"  >&lt;p&gt;Well, I think the &lt;tt&gt;SimplifiedKinesisClient&lt;/tt&gt; should not crash. The crash just means that the number of minutes between the two instants is too long for some internal Joda reasons. I have now forgotten the details... at first I thought Joda was wrong because there is clearly no overflow. But the issue is that the minutes duration could &lt;em&gt;later&lt;/em&gt; be used to cause an overflow, so I think they are being extra cautious.&lt;/p&gt;

&lt;p&gt;The shortest answer is that I think this exception could be caught and return 0 or whatever is allowed as a default/unknown value. Or a longer answer is to not use Minutes.between but get that value by direct math or other functions that doesn&apos;t overflow (because actually it won&apos;t overflow). If you look at Minutes.between code you can see how to do this using Joda&apos;s utility libraries.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 8 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z05nqw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>