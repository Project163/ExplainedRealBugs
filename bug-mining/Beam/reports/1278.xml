<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:00:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-7785] DirectRunner: watermarks are updated asynchronously from bundle processing</title>
                <link>https://issues.apache.org/jira/browse/BEAM-7785</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;Watermarks are updated in QuiescenceDriver (by calling fireTimers, which calls forceRefresh()) on WatermarkManager. This results in creating timer bundles, that are then processed asynchronously as DirectTransformExecutor. Because of that, watermarks (input watermarks mostly) might be updated while bundle is being processed. That violates assumption, that bundle processing should be atomical (with identical external conditions during processing of whole bundle).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13245967">BEAM-7785</key>
            <summary>DirectRunner: watermarks are updated asynchronously from bundle processing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="3">Duplicate</resolution>
                                        <assignee username="janl">Jan Lukavsk&#253;</assignee>
                                    <reporter username="janl">Jan Lukavsk&#253;</reporter>
                        <labels>
                    </labels>
                <created>Fri, 19 Jul 2019 10:48:17 +0000</created>
                <updated>Fri, 24 Jul 2020 20:01:47 +0000</updated>
                            <resolved>Tue, 30 Jul 2019 13:49:47 +0000</resolved>
                                    <version>2.13.0</version>
                                    <fixVersion>Not applicable</fixVersion>
                                    <component>runner-direct</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="21000">5h 50m</timespent>
                                <comments>
                            <comment id="16893640" author="je-ik" created="Fri, 26 Jul 2019 09:07:40 +0000"  >&lt;p&gt;The fix was rollbacked due to bug it introduced. Reopening to resolve it differently.&lt;/p&gt;</comment>
                            <comment id="16894007" author="kenn" created="Fri, 26 Jul 2019 17:27:53 +0000"  >&lt;p&gt;You mentioned maybe more clever locking. It might work, but the problem is that you can only update the watermark when there is no currently executing bundle that is going to observe it. That seems like it will be a bottleneck no matter what. Without making a clever data structure, you could always just do a whole copy of the watermark state when you start processing a bundle. It is not efficient, but the DirectRunner is already pretty slow.&lt;/p&gt;

&lt;p&gt;As one similar reference point, the state became somewhat complicated copy-on-write solution for basically the same reason.&lt;/p&gt;</comment>
                            <comment id="16894096" author="je-ik" created="Fri, 26 Jul 2019 20:17:27 +0000"  >&lt;p&gt;Thanks for the state example and copy-on-write approach, I understand your point. I think the analogy is quite good, but there might be subtle differences, which might actually mean that both problems might use a different approach. Let me explain the differences I see between state and watermarks in this context:&lt;/p&gt;

&lt;p&gt; 1) state has strong requirements in terms of consistency - after state is updated, every subsequent read has to see this update (read-after-write consistency)&lt;br/&gt;
 2) watermark update on the other hand is not required to happen instantly, it can happen eventually&lt;/p&gt;

&lt;p&gt;That way, the &quot;more clever&quot; locking I was referring to, would be to actually lock the processing &lt;em&gt;only if there is currently no bundle being processed&lt;/em&gt; (inside given AppliedPTransform). That might not happen instantly, but should happen, eventually. I think, that this should be pretty much enough to ensure both consistency and performance, while keeping the code complexity low. I have a nearly working code for that, still need to verify, that it would not break anything (again &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;).&lt;/p&gt;

&lt;p&gt;If this approach would fail, I think it would be necessary to implement it as you suggest, but it (currently) seems to me, that it would bring a lot of complexity, because the copied watermark state would have to be correctly referenced from each bundle (or KeyedWorkItem).&lt;/p&gt;</comment>
                            <comment id="16894108" author="kenn" created="Fri, 26 Jul 2019 20:26:13 +0000"  >&lt;p&gt;Ah, nice. Since there is no consistency requirement between watermarks for different PCollections, if the bundle processing always caches a watermark whenever it reads, would that be enough? And then the cache would GC when the bundle finishes.&lt;/p&gt;</comment>
                            <comment id="16894114" author="je-ik" created="Fri, 26 Jul 2019 20:31:45 +0000"  >&lt;p&gt;Yes, sure. If we can cache watermarks before bundle starts processing and GC it after, that would be perfectly fine. The issue I&apos;m having is that input watermark might move while timers of a bundle are being processed. Given that - there is actually no reliable way to tell, what the current &quot;timer watermark&quot; is, and fired timer cannot be sure, if another timer is already being processed or not (speaking mostly about state GC timer, which can then randomly clear state, while another timer might still need it).&lt;/p&gt;</comment>
                            <comment id="16894116" author="je-ik" created="Fri, 26 Jul 2019 20:40:11 +0000"  >&lt;p&gt;Hmmm ... looking into that - maybe the approach you suggest would not be that complex as I suspected. Because QuiescenceDriver has reference to EvaluationContext, &lt;em&gt;maybe&lt;/em&gt; it would be possible to copy WatermarkManager inside the EvaluationContext before bundle and free it in bundle finish callback. Would you find that possible?&lt;/p&gt;</comment>
                            <comment id="16894124" author="kenn" created="Fri, 26 Jul 2019 20:50:57 +0000"  >&lt;p&gt;I&apos;m just looking at the code a little bit - it has been a while. If we could have AppliedPTransformInputWatermark read and cache would that work?&lt;/p&gt;</comment>
                            <comment id="16894136" author="je-ik" created="Fri, 26 Jul 2019 21:23:28 +0000"  >&lt;p&gt;Yes, essentially, my concern is about input watermark (and maybe synchronized processing time).&lt;/p&gt;</comment>
                            <comment id="16894143" author="je-ik" created="Fri, 26 Jul 2019 21:35:38 +0000"  >&lt;p&gt;Although, I might have understood it wrong from the beginning. My observation was that input watermark can change within single &lt;tt&gt;onTimer&lt;/tt&gt; call. That made me think, that it is the synchronization of the watermark and the bundle processing that needs to be fixed, but - thinking about it more deeply - the root cause is probably a race between bundle processing on one side, and timer extraction (&lt;tt&gt;extractFiredTimers&lt;/tt&gt;) on the other side. That is to say - if timer is extracted, then &lt;b&gt;all&lt;/b&gt; timers being processed after that must be aware of that, otherwise they might setup different timer for time that is less than the one being extracted. Does that make any sense? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16895972" author="je-ik" created="Tue, 30 Jul 2019 09:50:41 +0000"  >&lt;p&gt;Related to &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-7520&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BEAM-7520&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16896145" author="je-ik" created="Tue, 30 Jul 2019 13:49:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-7520&quot; title=&quot;DirectRunner timers are not strictly time ordered&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-7520&quot;&gt;&lt;del&gt;BEAM-7520&lt;/del&gt;&lt;/a&gt; supersedes this&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 15 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z04u2o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>