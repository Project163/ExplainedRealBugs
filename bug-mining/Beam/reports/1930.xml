<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:10:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-10419] Flaky FhirIOWriteIT integraion test in java postcommit</title>
                <link>https://issues.apache.org/jira/browse/BEAM-10419</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;See history &lt;a href=&quot;https://ci-beam.apache.org/job/beam_PostCommit_Java/6320/testReport/junit/org.apache.beam.sdk.io.gcp.healthcare/FhirIOWriteIT/history/?start=25&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-beam.apache.org/job/beam_PostCommit_Java/6320/testReport/junit/org.apache.beam.sdk.io.gcp.healthcare/FhirIOWriteIT/history/?start=25&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13315499">BEAM-10419</key>
            <summary>Flaky FhirIOWriteIT integraion test in java postcommit</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10101" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">P1</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lastomato">Jie Fan</assignee>
                                    <reporter username="yichi">Yichi Zhang</reporter>
                        <labels>
                            <label>flake</label>
                    </labels>
                <created>Tue, 7 Jul 2020 22:05:08 +0000</created>
                <updated>Mon, 20 Jul 2020 19:05:13 +0000</updated>
                            <resolved>Fri, 17 Jul 2020 14:32:05 +0000</resolved>
                                                    <fixVersion>Not applicable</fixVersion>
                                    <component>io-java-gcp</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="10800">3h</timespent>
                                <comments>
                            <comment id="17153116" author="yichi" created="Tue, 7 Jul 2020 22:07:13 +0000"  >&lt;p&gt;cc: +&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=data-runner0&quot; class=&quot;user-hover&quot; rel=&quot;data-runner0&quot;&gt;data-runner0&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17153125" author="bhulette" created="Tue, 7 Jul 2020 23:11:27 +0000"  >&lt;p&gt;Raised to P1 based on &lt;a href=&quot;https://beam.apache.org/contribute/jira-priorities/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://beam.apache.org/contribute/jira-priorities/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17153159" author="data-runner0" created="Wed, 8 Jul 2020 01:07:04 +0000"  >&lt;p&gt;Seems that the logic that moves files to &quot;claim&quot; them for a batch import in FhirIO.Import sometimes is trying to copy a file that has already been deleted.&lt;/p&gt;

&lt;p&gt;For sake of explanation (and refreshing my own memory) the FhirIO.Import works as follows:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Buffer elements in a bundle to a new line delimited JSON file in the tempDir&lt;/li&gt;
	&lt;li&gt;Group these files into batches (of 10,000 files) this is to avoid many load jobs if batches were small&lt;/li&gt;
	&lt;li&gt;Copy each batch of files to a unique sub temp dir lets call it a batchDir (this is used to specify a prefix + wildcard for each load job) in &lt;a href=&quot;https://github.com/apache/beam/blob/master/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java#L1033-L1040&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ImportFn&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Start load job and block til completion (deletes the files in the batchDir &lt;a href=&quot;https://github.com/apache/beam/blob/master/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java#L1051&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and the corresponding files in the orignal dir &lt;a href=&quot;https://github.com/apache/beam/blob/master/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java#L1065&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;Delete all the (original) files in the tempDir once the window is closed (based on this &lt;a href=&quot;https://github.com/apache/beam/blob/master/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/healthcare/FhirIO.java#L840-L870&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;usage of Wait.on&lt;/a&gt;)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Background on why this logic was so complicated in this review &lt;a href=&quot;https://github.com/apache/beam/pull/11339#discussion_r423357007&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;thread&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The flakiness seems to occur when attempting the copy in step 3 on a file that does not exists. My hunch is that the deleting in step 5 may not be properly waiting on the ImportFn to be complete.&lt;/p&gt;

&lt;p&gt;Could this happen if the ImportFn task is rescheduled for a particular batch?&lt;/p&gt;

&lt;p&gt;FYI I do not have bandwidth to dig deeper into this / fix this right now and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lastomato&quot; class=&quot;user-hover&quot; rel=&quot;lastomato&quot;&gt;lastomato&lt;/a&gt; has taken over maintenance of these IO connectors as I am not currently engaged w/ Healthcare customers.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: java.io.IOException: Error executing batch GCS request
	at org.apache.beam.sdk.extensions.gcp.util.GcsUtil.executeBatches(GcsUtil.java:617)
	at org.apache.beam.sdk.extensions.gcp.util.GcsUtil.copy(GcsUtil.java:718)
	at org.apache.beam.sdk.extensions.gcp.storage.GcsFileSystem.copy(GcsFileSystem.java:168)
	at org.apache.beam.sdk.io.FileSystems.copy(FileSystems.java:289)
	at org.apache.beam.sdk.io.gcp.healthcare.FhirIO$Import$ImportFn.importBatch(FhirIO.java:1040)
Caused by: java.util.concurrent.ExecutionException: java.io.IOException: Error trying to rewrite gs://temp-storage-for-healthcare-io-tests/fhirImportBatch-60962352-ef3c-4d42-8079-c17ac430ebd6.ndjson to gs://temp-storage-for-healthcare-io-tests/tmp-22b3fd94-1455-42b0-b24a-55439eff5647/fhirImportBatch-60962352-ef3c-4d42-8079-c17ac430ebd6.ndjson: {&quot;code&quot;:404,&quot;errors&quot;:[{&quot;domain&quot;:&quot;global&quot;,&quot;message&quot;:&quot;No such object: temp-storage-for-healthcare-io-tests/fhirImportBatch-60962352-ef3c-4d42-8079-c17ac430ebd6.ndjson&quot;,&quot;reason&quot;:&quot;notFound&quot;}],&quot;message&quot;:&quot;No such object: temp-storage-for-healthcare-io-tests/fhirImportBatch-60962352-ef3c-4d42-8079-c17ac430ebd6.ndjson&quot;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17153606" author="lastomato" created="Wed, 8 Jul 2020 13:27:26 +0000"  >&lt;p&gt;Unfortunately I don&apos;t have free cycles to work on it this week, is it possible to disable the test temporarily?&lt;/p&gt;</comment>
                            <comment id="17159966" author="lastomato" created="Fri, 17 Jul 2020 14:31:39 +0000"  >&lt;p&gt;The tests have been running smoothly for ~3 days now, marking this as fixed. Please reopen if further failures are observed.&lt;/p&gt;</comment>
                            <comment id="17161475" author="bhulette" created="Mon, 20 Jul 2020 19:05:13 +0000"  >&lt;p&gt;Thank you!&lt;/p&gt;</comment>
                            <comment id="17161476" author="bhulette" created="Mon, 20 Jul 2020 19:05:13 +0000"  >&lt;p&gt;Thank you!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 17 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0gjhc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>