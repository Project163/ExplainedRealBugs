<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:46:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-3169] WriteFiles data loss with some triggers</title>
                <link>https://issues.apache.org/jira/browse/BEAM-3169</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://stackoverflow.com/questions/47113773/dataflow-2-1-0-streaming-application-is-not-cleaning-temp-folders/47142671?noredirect=1#comment81401472_47142671&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/47113773/dataflow-2-1-0-streaming-application-is-not-cleaning-temp-folders/47142671?noredirect=1#comment81401472_47142671&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Details in comments&lt;/p&gt;</description>
                <environment></environment>
        <key id="13117634">BEAM-3169</key>
            <summary>WriteFiles data loss with some triggers</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10101" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">P1</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jkff">Eugene Kirpichov</assignee>
                                    <reporter username="jkff">Eugene Kirpichov</reporter>
                        <labels>
                            <label>Done</label>
                    </labels>
                <created>Fri, 10 Nov 2017 18:14:57 +0000</created>
                <updated>Tue, 6 Oct 2020 21:55:00 +0000</updated>
                            <resolved>Thu, 16 Nov 2017 08:46:39 +0000</resolved>
                                    <version>2.0.0</version>
                    <version>2.1.0</version>
                    <version>2.2.0</version>
                                    <fixVersion>2.2.0</fixVersion>
                                    <component>sdk-java-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16247876" author="jkff" created="Fri, 10 Nov 2017 18:20:50 +0000"  >&lt;p&gt;User reads data from pubsub and windows it into 1-minute windows with trigger AfterProcessingTime.pastFirstElementInPane().plusDelayOf(1 minute), and writes it to TextIO.write().withWindowedWrites(). They observe that some files in the temp directory are never moved to final location, i.e. final output doesn&apos;t contain all the data it should.&lt;/p&gt;

&lt;p&gt;My reconstruction of events that happens, exemplified by 1 window that experienced data loss:&lt;br/&gt;
Window [2017-11-10T13:38:00.000Z..2017-11-10T13:39:00.000Z):&lt;br/&gt;
Two temp files were written:&lt;br/&gt;
3e3fdee3-d928-485a-b3a5-1faa3c2a58d6 (opened at 2017-11-10 06:39:51.585 PDT, closed at 2017-11-10 06:39:52.090 PDT)&lt;br/&gt;
d12e91d2-39b3-43d4-b27f-3a340c25f888 (opened at 2017-11-10 06:40:00.624 PDT, closed at 2017-11-10 06:40:00.909 PDT)&lt;/p&gt;

&lt;p&gt;The finalize operation for that window triggered at 2017-11-10 06:40:00.979 PDT (on a different worker) and moved only the first file. The second file was never mentioned in the logs again.&lt;/p&gt;

&lt;p&gt;Explanation of why this happened - in the next comment.&lt;/p&gt;</comment>
                            <comment id="16247890" author="jkff" created="Fri, 10 Nov 2017 18:33:43 +0000"  >&lt;p&gt;With the user&apos;s configuration (windowed writes, fixed number of shards, no dynamic destinations), WriteFiles follows the following codepath:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;ApplyShardLabel to assign each element with a destination (all null in this case) and shard (random number)&lt;/li&gt;
	&lt;li&gt;Group by destination/shard &lt;span class=&quot;error&quot;&gt;&amp;#91;more precisely, by hash of destination and shard&amp;#93;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;Write each group to its own temp file using WriteShardedBundles: this triggers according to the input&apos;s windowing strategy, i.e. for each window/shard it will write 1 processing-time-minute of data accumulated since the first element in this window/shard.&lt;/li&gt;
	&lt;li&gt;WriteShardedBundles returns a PCollection of FileResult, one per temp file written. The windowing strategy of this PCollection is the same as the input collection but the trigger is the &lt;span class=&quot;error&quot;&gt;&amp;#91;continuation trigger&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://github.com/apache/beam/blob/a0eb00e73419f93107a67608d29610e7f1f604bb/sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/GroupByKey.java#L199&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/blob/a0eb00e73419f93107a67608d29610e7f1f604bb/sdks/java/core/src/main/java/org/apache/beam/sdk/transforms/GroupByKey.java#L199&lt;/a&gt;) of the input trigger; in this case, this means the collection of FileResult has trigger AfterSynchronizedProcessingTime.pastFirstElementInPane().&lt;/li&gt;
	&lt;li&gt;The PCollection returned by WriteShardedBundles is grouped onto a single Void key, followed by a ParDo FinalizeWindowed that, does a bulk copy of respective temp files to final locations and then bulk deletes them. I suppose the GBK onto void key is done in order to concentrate the move activity on one worker so that it can be better batched?... I&apos;m not sure, perhaps &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reuvenlax&quot; class=&quot;user-hover&quot; rel=&quot;reuvenlax&quot;&gt;reuvenlax&lt;/a&gt; remembers.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Unfortunately, that last GBK, as we recall from above, uses a triggering strategy that is the continuation trigger of the original input, which means, depending on how the input triggering was configured, it may discard data. In this particular case, the continuation trigger is a fire-once trigger AfterSynchronizedProcessingTime.pastFirstElementInPane() - so, after it fires for the first time for FileResult 3e3fdee3-d928-485a-b3a5-1faa3c2a58d6, it never fires again for this window and doesn&apos;t move the other temp file.&lt;/p&gt;</comment>
                            <comment id="16247891" author="jkff" created="Fri, 10 Nov 2017 18:35:36 +0000"  >&lt;p&gt;I think the proper fix to this is to either make that &quot;GBK onto void key&quot; use a pass-through triggering strategy, or make finalization a simple ParDo, to guarantee that every FileResult will be processed.&lt;/p&gt;

&lt;p&gt;Pipelines potentially prone to this are those using WriteFiles where the continuation trigger of the input trigger may potentially drop data. I need to understand continuation triggers better to identify what those are.&lt;/p&gt;

&lt;p&gt;For an affected user, a workaround can be to use a trigger that doesn&apos;t drop data, e.g. a Repeatedly.forever(something) and a high allowed lateness.&lt;/p&gt;</comment>
                            <comment id="16247982" author="jkff" created="Fri, 10 Nov 2017 19:53:44 +0000"  >&lt;p&gt;I was able to reproduce this in a few seconds in direct runner with some manual testing. Not yet in a unit test.&lt;/p&gt;</comment>
                            <comment id="16250524" author="githubbot" created="Tue, 14 Nov 2017 00:07:19 +0000"  >&lt;p&gt;GitHub user jkff opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/beam/pull/4124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/4124&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3169&quot; title=&quot;WriteFiles data loss with some triggers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-3169&quot;&gt;&lt;del&gt;BEAM-3169&lt;/del&gt;&lt;/a&gt; Fixes a data loss bug in WriteFiles when used with fire-once triggers&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-3169&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/BEAM-3169&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    This required a bit of twiddling with shard assignment logic too. The gist of the change is changing the pre-finalize GBK to Reshuffle. I audited all other usages of GBK in the SDK and it appears that only this one is buggy: others either explicitly set a repeated trigger before applying the GBK, or are directly applied to the user&apos;s input and the user&apos;s trigger firing behavior is WAI.&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jkff/incubator-beam&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jkff/incubator-beam&lt;/a&gt; write-files-data-loss&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/beam/pull/4124.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/4124.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #4124&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 17c4af7c5a3a9475a284afd4fe413cb57016e7e5&lt;br/&gt;
Author: Eugene Kirpichov &amp;lt;kirpichov@google.com&amp;gt;&lt;br/&gt;
Date:   2017-11-13T19:09:01Z&lt;/p&gt;

&lt;p&gt;    Slightly simplifies fixed sharding&lt;/p&gt;

&lt;p&gt;commit 3926abf84c681f3b6918a3d691ca2cb00a2e40e6&lt;br/&gt;
Author: Eugene Kirpichov &amp;lt;kirpichov@google.com&amp;gt;&lt;br/&gt;
Date:   2017-11-13T19:58:11Z&lt;/p&gt;

&lt;p&gt;    More clear and consistent shard number assignment logic&lt;/p&gt;

&lt;p&gt;commit e52d3d8d49d6ff2b2b767f8069e1f71f8c42c9ae&lt;br/&gt;
Author: Eugene Kirpichov &amp;lt;kirpichov@google.com&amp;gt;&lt;br/&gt;
Date:   2017-11-13T20:28:34Z&lt;/p&gt;

&lt;p&gt;    Materializes file results via Reshuffle rather than GBK&lt;/p&gt;

&lt;p&gt;commit 1a625ecf313b6ff03311464d40a5515736cbbdd7&lt;br/&gt;
Author: Eugene Kirpichov &amp;lt;kirpichov@google.com&amp;gt;&lt;br/&gt;
Date:   2017-11-13T23:55:44Z&lt;/p&gt;

&lt;p&gt;    Adds test for WriteFiles with a fire-once trigger&lt;/p&gt;

&lt;p&gt;commit cba9ca163c621c1b187965226748596e2f5f8600&lt;br/&gt;
Author: Eugene Kirpichov &amp;lt;kirpichov@google.com&amp;gt;&lt;br/&gt;
Date:   2017-11-14T00:04:03Z&lt;/p&gt;

&lt;p&gt;    makes checkstyle happy&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16252899" author="githubbot" created="Wed, 15 Nov 2017 03:43:27 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/beam/pull/4124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/4124&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16253960" author="jkff" created="Wed, 15 Nov 2017 19:03:25 +0000"  >&lt;p&gt;Reopening, since it makes more sense to close this when it has been cherrypicked into 2.2.0 , which it hasn&apos;t yet.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3mnlb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>