<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:42:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-1517] Garbage collect user state in Flink Runner</title>
                <link>https://issues.apache.org/jira/browse/BEAM-1517</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;User facing state/timers in Beam are bound to the key/window of the data. Right now, the Flink Runner does not clean up user state when the watermark passes the GC horizon for the state associated with a given window.&lt;/p&gt;

&lt;p&gt;Neither &lt;tt&gt;StateInternals&lt;/tt&gt; nor the Flink state API support discarding state for a whole namespace (which is the window in this case) so we might have to manually set a GC timer for each window/key combination, as is done in the &lt;tt&gt;ReduceFnRunner&lt;/tt&gt;. For this we have to know all states a user can possibly use, which we can get from the &lt;tt&gt;DoFn&lt;/tt&gt; signature.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13044761">BEAM-1517</key>
            <summary>Garbage collect user state in Flink Runner</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10100" iconUrl="https://issues.apache.org/jira/images/icons/priorities/blocker.svg">P0</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lzljs3620320">Jingsong Lee</assignee>
                                    <reporter username="aljoscha">Aljoscha Krettek</reporter>
                        <labels>
                    </labels>
                <created>Tue, 21 Feb 2017 09:02:10 +0000</created>
                <updated>Fri, 24 Jul 2020 20:18:37 +0000</updated>
                            <resolved>Wed, 1 Mar 2017 17:02:29 +0000</resolved>
                                    <version>0.6.0</version>
                                    <fixVersion>0.6.0</fixVersion>
                                    <component>runner-flink</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15875634" author="aljoscha" created="Tue, 21 Feb 2017 09:03:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tgroh&quot; class=&quot;user-hover&quot; rel=&quot;tgroh&quot;&gt;tgroh&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kenn&quot; class=&quot;user-hover&quot; rel=&quot;kenn&quot;&gt;kenn&lt;/a&gt;, do you have any ideas about this? Should we make a generic version of this, similar to how &lt;tt&gt;ReduceFnRunner&lt;/tt&gt; is used for &lt;tt&gt;GroupByKey&lt;/tt&gt;?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt; I thought you might also find this interesting.&lt;/p&gt;</comment>
                            <comment id="15876005" author="lzljs3620320" created="Tue, 21 Feb 2017 13:51:24 +0000"  >&lt;p&gt;Is it appropriate for the user to do the work of GC?&lt;br/&gt;
Just like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  @ProcessElement
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void process(
      ProcessContext c,
      BoundedWindow window,
      @StateId(stateId) ValueState&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt; state,
      @TimerId(&lt;span class=&quot;code-quote&quot;&gt;&quot;GcTimer&quot;&lt;/span&gt;) Timer timer) {
    Instant maxTimestamp = window.maxTimestamp();
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; allowedLateness = 10 * 1000;
    Instant gcTime = maxTimestamp.plus(allowedLateness);
    &lt;span class=&quot;code-comment&quot;&gt;//Can Timer have a getCurrentTime &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt;?
&lt;/span&gt;    Instant currentTime = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Instant();
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (gcTime.isBefore(currentTime)) {
      c.sideOutput(lateDataTag, c.element());
    } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
      timer.set(gcTime);
      &lt;span class=&quot;code-comment&quot;&gt;// user logical
&lt;/span&gt;      &lt;span class=&quot;code-comment&quot;&gt;// ....
&lt;/span&gt;    }
  }
  @OnTimer(&lt;span class=&quot;code-quote&quot;&gt;&quot;GcTimer&quot;&lt;/span&gt;)
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void gc(
      OnTimerContext context,
      @StateId(stateId) ValueState&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;&amp;gt; state) {
    state.clear();
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15876490" author="kenn" created="Tue, 21 Feb 2017 19:02:59 +0000"  >&lt;p&gt;In the runners I&apos;ve added this GC to (direct and Dataflow) I was faced with the same choice that you are faced with in Flink:&lt;/p&gt;

&lt;p&gt;1. Add the ability to clear a whole &lt;tt&gt;StateNamespace&lt;/tt&gt; OR&lt;br/&gt;
2. Scrape the necessary tags off the &lt;tt&gt;DoFnSignature&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;I ended up going with 2 both times, because it was a bit easier to get done quickly. If your underlying storage already supports 1, then you would use the same sort of timer set up but just have code to write for cleanup. Since it seems pretty common that namespace clearing is not &quot;for free&quot; in different runners, I would not make it required as part of &lt;tt&gt;StateInternals&lt;/tt&gt;. But I do think it seems nice to add to runner/core-java the logic for &quot;clear all state in this &lt;tt&gt;DoFnSignature&lt;/tt&gt;&quot;.&lt;/p&gt;</comment>
                            <comment id="15877903" author="aljoscha" created="Wed, 22 Feb 2017 10:07:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lzljs3620320&quot; class=&quot;user-hover&quot; rel=&quot;lzljs3620320&quot;&gt;lzljs3620320&lt;/a&gt; We cannot depend on users always cleaning up the state. That&apos;s why we need the GC failsafe to ensure that we don&apos;t grow state indefinitely.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kenn&quot; class=&quot;user-hover&quot; rel=&quot;kenn&quot;&gt;kenn&lt;/a&gt; I was afraid you might say that and anticipated as much in the description of the issue. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; We&apos;ll probably add something like a &lt;tt&gt;StatefulDoFnRunner&lt;/tt&gt; that registers a GC timer in &lt;tt&gt;processElement()&lt;/tt&gt; and does cleanup in &lt;tt&gt;onTimer()&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15879359" author="kenn" created="Wed, 22 Feb 2017 22:15:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aljoscha&quot; class=&quot;user-hover&quot; rel=&quot;aljoscha&quot;&gt;aljoscha&lt;/a&gt; that makes sense to me. In both the direct runner and Dataflow runner it was easy to implement &quot;under the hood&quot; and kept the system timers totally separate from the user timers, which is why I didn&apos;t produce a shared utility like I usually try to do. It shouldn&apos;t be much work to make such a `StatefulDoFnRunner` and will be useful in general.&lt;/p&gt;</comment>
                            <comment id="15887550" author="lzljs3620320" created="Tue, 28 Feb 2017 08:32:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kenn&quot; class=&quot;user-hover&quot; rel=&quot;kenn&quot;&gt;kenn&lt;/a&gt; Is it like &lt;tt&gt;LateDataDroppingDoFnRunner&lt;/tt&gt; droping late data in &lt;tt&gt;processElement()&lt;/tt&gt;? But how to deal with late timer?(not EVENT_TIME) Just throw it in &lt;tt&gt;onTimer()&lt;/tt&gt; like element?&lt;/p&gt;</comment>
                            <comment id="15887857" author="githubbot" created="Tue, 28 Feb 2017 11:51:26 +0000"  >&lt;p&gt;GitHub user JingsongLi opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/beam/pull/2127&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/2127&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-1517&quot; title=&quot;Garbage collect user state in Flink Runner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-1517&quot;&gt;&lt;del&gt;BEAM-1517&lt;/del&gt;&lt;/a&gt; Garbage collect user state in Flink Runner&lt;/p&gt;

&lt;p&gt;    Be sure to do all of the following to help us incorporate your contribution&lt;br/&gt;
    quickly and easily:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;[ ] Make sure the PR title is formatted like:&lt;br/&gt;
       `&lt;a href=&quot;#&amp;gt;&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;BEAM-&amp;lt;Jira issue #&amp;gt;&lt;/a&gt; Description of pull request`&lt;/li&gt;
	&lt;li&gt;[ ] Make sure tests pass via `mvn clean verify`. (Even better, enable&lt;br/&gt;
           Travis-CI on your fork and ensure the whole test matrix passes).&lt;/li&gt;
	&lt;li&gt;[ ] Replace `&amp;lt;Jira issue #&amp;gt;` in the title with the actual Jira issue&lt;br/&gt;
           number, if there is one.&lt;/li&gt;
	&lt;li&gt;[ ] If this contribution is large, please file an Apache&lt;br/&gt;
           &lt;span class=&quot;error&quot;&gt;&amp;#91;Individual Contributor License Agreement&amp;#93;&lt;/span&gt;(&lt;a href=&quot;https://www.apache.org/licenses/icla.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.apache.org/licenses/icla.txt&lt;/a&gt;).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    &amp;#8212;&lt;/p&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/JingsongLi/beam&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/JingsongLi/beam&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-1517&quot; title=&quot;Garbage collect user state in Flink Runner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-1517&quot;&gt;&lt;del&gt;BEAM-1517&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/beam/pull/2127.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/2127.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #2127&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 54fa85722b4c6e572eeba9dcd07539f731c0154b&lt;br/&gt;
Author: JingsongLi &amp;lt;lzljs3620320@aliyun.com&amp;gt;&lt;br/&gt;
Date:   2017-02-28T08:08:38Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-1517&quot; title=&quot;Garbage collect user state in Flink Runner&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-1517&quot;&gt;&lt;del&gt;BEAM-1517&lt;/del&gt;&lt;/a&gt; Garbage collect user state in Flink Runner&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15888732" author="kenn" created="Tue, 28 Feb 2017 19:35:46 +0000"  >&lt;p&gt;Event time timers never need to be dropped, since they hold the watermark, but late processing time timers should just be dropped as they could arrive way after the window expires.&lt;/p&gt;

&lt;p&gt;Incidentally, it has been suggested that we accelerate the addition of &lt;tt&gt;@OnWindowExpiration&lt;/tt&gt; and make it mandatory whenever any state is used. It seems kind of annoying, but on the other hand forgetting to set a final timer to flush state is probably data loss most of the time.&lt;/p&gt;</comment>
                            <comment id="15890550" author="githubbot" created="Wed, 1 Mar 2017 17:01:48 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/beam/pull/2127&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/2127&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 37 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ad5j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>