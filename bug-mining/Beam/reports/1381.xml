<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 11:02:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-8157] Key encoding for state requests is not consistent across SDKs</title>
                <link>https://issues.apache.org/jira/browse/BEAM-8157</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;The Flink runner requires the internal key to be encoded without a length prefix (OUTER context). The user state request handler exposes a serialized version of the key to the Runner. This key is encoded with the NESTED context which may add a length prefix. We need to convert it to OUTER context to match the Flink runner&apos;s key encoding.&lt;/p&gt;

&lt;p&gt;So far this has not caused the Flink Runner to behave incorrectly. However, with the upcoming support for Flink 1.9, the state backend will not accept requests for keys not part of any key group/partition of the operator. This is very likely to happen with the encoding not being consistent.&lt;/p&gt;

&lt;p&gt;*&lt;b&gt;NOTE&lt;/b&gt;* This is only applicable to the Java SDK, as the Python SDK uses OUTER encoding for the key in state requests.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13255038">BEAM-8157</key>
            <summary>Key encoding for state requests is not consistent across SDKs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10101" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">P1</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mxm">Maximilian Michels</assignee>
                                    <reporter username="mxm">Maximilian Michels</reporter>
                        <labels>
                            <label>Done</label>
                    </labels>
                <created>Thu, 5 Sep 2019 16:15:54 +0000</created>
                <updated>Tue, 6 Oct 2020 21:51:44 +0000</updated>
                            <resolved>Wed, 13 Nov 2019 16:17:30 +0000</resolved>
                                    <version>2.13.0</version>
                                    <fixVersion>2.17.0</fixVersion>
                                    <component>runner-flink</component>
                    <component>sdk-java-core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="60600">16h 50m</timespent>
                                <comments>
                            <comment id="16923615" author="mxm" created="Thu, 5 Sep 2019 17:02:09 +0000"  >&lt;p&gt;I should add, the bug only manifests together with timers which access state, because there the key encoding will not match between the two.&lt;/p&gt;</comment>
                            <comment id="16925153" author="mxm" created="Sun, 8 Sep 2019 11:35:07 +0000"  >&lt;p&gt;Further addition, this is only an issue on Flink &amp;gt;= 1.9 which has not been merged yet.&lt;/p&gt;</comment>
                            <comment id="16926024" author="markflyhigh" created="Mon, 9 Sep 2019 19:17:30 +0000"  >&lt;p&gt;Is this issue on track for 2.16 release? (branch will be cut in 3 days) Shall we move it to 2.17?&lt;/p&gt;</comment>
                            <comment id="16928062" author="markflyhigh" created="Wed, 11 Sep 2019 22:35:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mxm&quot; class=&quot;user-hover&quot; rel=&quot;mxm&quot;&gt;mxm&lt;/a&gt; 2.16 release branch is cut. I&apos;ll move it to 2.17. If you really want to have this in 2.16, please let me know and we can cherrypick your change if it fits the release time frame.&lt;/p&gt;</comment>
                            <comment id="16933836" author="mxm" created="Thu, 19 Sep 2019 22:54:46 +0000"  >&lt;p&gt;To conclude the investigation here, this only was a problem with the portable Java SDK. The Python SDK uses &lt;tt&gt;OUTER&lt;/tt&gt; context by default.&lt;/p&gt;

&lt;p&gt;We should make the key encoding consistent. There is a good argument for using the &lt;tt&gt;NESTED&lt;/tt&gt; context, as this also gets rid of workaround for removing the length prefix from key coders. So this requires&lt;/p&gt;

&lt;p&gt;1. Updating the Python SDK to use &lt;tt&gt;NESTED&lt;/tt&gt; context for state requests&lt;br/&gt;
2. Updating the Flink Runner to use &lt;tt&gt;NESTED&lt;/tt&gt; context for the key encoding&lt;/p&gt;</comment>
                            <comment id="16936646" author="mxm" created="Tue, 24 Sep 2019 10:10:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thw&quot; class=&quot;user-hover&quot; rel=&quot;thw&quot;&gt;thw&lt;/a&gt; Should we backport this to 2.16.0? Not sure how far we are with the 2.16.0 release.&lt;/p&gt;</comment>
                            <comment id="16936835" author="thw" created="Tue, 24 Sep 2019 14:06:36 +0000"  >&lt;p&gt;I would probably not backport since 2.16 doesn&apos;t have this issue (it will only become relevant with Flink 1.9).&lt;/p&gt;</comment>
                            <comment id="16936899" author="mxm" created="Tue, 24 Sep 2019 15:10:00 +0000"  >&lt;p&gt;It does have a potential issues for portable Java pipelines. The potential number of effected users should be small though.&lt;/p&gt;</comment>
                            <comment id="16967623" author="mxm" created="Tue, 5 Nov 2019 15:56:24 +0000"  >&lt;p&gt;Reopening. Unfortunately, this is still an issue and setting the encoding scheme to be NESTED by default, did not cure it. I&apos;m getting the following when Python&apos;s &lt;tt&gt;FastPrimitivesCoder&lt;/tt&gt; has been used for encoding a key for a state request:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Caused by: java.util.concurrent.ExecutionException: java.lang.RuntimeException: Error received from SDK harness for instruction 4: Traceback (most recent call last):
  File &quot;/srv/venvs/service/trusty/service_venv/local/lib/python2.7/site-packages/apache_beam/runners/worker/sdk_worker.py&quot;, line 168, in _execute
    response = task()
  File &quot;/srv/venvs/service/trusty/service_venv/local/lib/python2.7/site-packages/apache_beam/runners/worker/sdk_worker.py&quot;, line 201, in &amp;lt;lambda&amp;gt;
    self._execute(lambda: worker.do_instruction(work), work)
  File &quot;/srv/venvs/service/trusty/service_venv/local/lib/python2.7/site-packages/apache_beam/runners/worker/sdk_worker.py&quot;, line 356, in do_instruction
    request.instruction_id)
  File &quot;/srv/venvs/service/trusty/service_venv/local/lib/python2.7/site-packages/apache_beam/runners/worker/sdk_worker.py&quot;, line 382, in process_bundle
    bundle_processor.process_bundle(instruction_id))
  File &quot;/srv/venvs/service/trusty/service_venv/local/lib/python2.7/site-packages/apache_beam/runners/worker/bundle_processor.py&quot;, line 667, in process_bundle
    data.ptransform_id].process_encoded(data.data)
  File &quot;/srv/venvs/service/trusty/service_venv/local/lib/python2.7/site-packages/apache_beam/runners/worker/bundle_processor.py&quot;, line 143, in process_encoded
    self.output(decoded_value)
  File &quot;apache_beam/runners/worker/operations.py&quot;, line 255, in apache_beam.runners.worker.operations.Operation.output
    def output(self, windowed_value, output_index=0):
  File &quot;apache_beam/runners/worker/operations.py&quot;, line 256, in apache_beam.runners.worker.operations.Operation.output
    cython.cast(Receiver, self.receivers[output_index]).receive(windowed_value)
  File &quot;apache_beam/runners/worker/operations.py&quot;, line 143, in apache_beam.runners.worker.operations.SingletonConsumerSet.receive
    self.consumer.process(windowed_value)
  File &quot;apache_beam/runners/worker/operations.py&quot;, line 593, in apache_beam.runners.worker.operations.DoOperation.process
    with self.scoped_process_state:
  File &quot;apache_beam/runners/worker/operations.py&quot;, line 594, in apache_beam.runners.worker.operations.DoOperation.process
    delayed_application = self.dofn_receiver.receive(o)
  File &quot;apache_beam/runners/common.py&quot;, line 776, in apache_beam.runners.common.DoFnRunner.receive
    self.process(windowed_value)
  File &quot;apache_beam/runners/common.py&quot;, line 782, in apache_beam.runners.common.DoFnRunner.process
    self._reraise_augmented(exn)
  File &quot;apache_beam/runners/common.py&quot;, line 849, in apache_beam.runners.common.DoFnRunner._reraise_augmented
    raise_with_traceback(new_exn)
  File &quot;apache_beam/runners/common.py&quot;, line 780, in apache_beam.runners.common.DoFnRunner.process
    return self.do_fn_invoker.invoke_process(windowed_value)
  File &quot;apache_beam/runners/common.py&quot;, line 587, in apache_beam.runners.common.PerWindowInvoker.invoke_process
    self._invoke_process_per_window(
  File &quot;apache_beam/runners/common.py&quot;, line 659, in apache_beam.runners.common.PerWindowInvoker._invoke_process_per_window
    output_processor.process_outputs(
  File &quot;apache_beam/runners/common.py&quot;, line 880, in apache_beam.runners.common._OutputProcessor.process_outputs
    def process_outputs(self, windowed_input_element, results):
  File &quot;apache_beam/runners/common.py&quot;, line 895, in apache_beam.runners.common._OutputProcessor.process_outputs
    for result in results:
  File &quot;pricingrealtime/event_processing/stateful_event_processing.py&quot;, line 55, in process
    recent_events_map = StatefulEventDoFn._load_recent_events_map(recent_events_state)
  File &quot;pricingrealtime/event_processing/stateful_event_processing.py&quot;, line 127, in _load_recent_events_map
    items_in_recent_events_bag = [e for e in recent_events_state.read()]
  File &quot;/srv/venvs/service/trusty/service_venv/local/lib/python2.7/site-packages/apache_beam/runners/worker/bundle_processor.py&quot;, line 335, in __iter__
    for elem in self.first:
  File &quot;/srv/venvs/service/trusty/service_venv/local/lib/python2.7/site-packages/apache_beam/runners/worker/sdk_worker.py&quot;, line 723, in _materialize_iter
    self._underlying.get_raw(state_key, continuation_token)
  File &quot;/srv/venvs/service/trusty/service_venv/local/lib/python2.7/site-packages/apache_beam/runners/worker/sdk_worker.py&quot;, line 603, in get_raw
    continuation_token=continuation_token)))
  File &quot;/srv/venvs/service/trusty/service_venv/local/lib/python2.7/site-packages/apache_beam/runners/worker/sdk_worker.py&quot;, line 637, in _blocking_request
    raise RuntimeError(response.error)
RuntimeError: java.lang.IllegalStateException: The current key &apos;[1, -104, -97, -93, -34, -73, -128, -42, 36]&apos; with key group index &apos;274&apos; does not belong to the key group range &apos;KeyGroupRange{startKeyGroup=153, endKeyGroup=154}&apos;. Runner KeyCoder: LengthPrefixCoder(ByteArrayCoder). Ptransformid: ref_AppliedPTransform_process_events_with_stateful_dofn_23 Userstateid: recent_events
	at org.apache.beam.vendor.guava.v26_0_jre.com.google.common.base.Preconditions.checkState(Preconditions.java:531)
	at org.apache.beam.runners.flink.translation.wrappers.streaming.ExecutableStageDoFnOperator$BagUserStateFactory$1.prepareStateBackend(ExecutableStageDoFnOperator.java:387)
	at org.apache.beam.runners.flink.translation.wrappers.streaming.ExecutableStageDoFnOperator$BagUserStateFactory$1.get(ExecutableStageDoFnOperator.java:309)
	at org.apache.beam.runners.flink.translation.wrappers.streaming.ExecutableStageDoFnOperator$BagUserStateFactory$1.get(ExecutableStageDoFnOperator.java:303)
	at org.apache.beam.runners.fnexecution.state.StateRequestHandlers$ByteStringStateRequestHandlerToBagUserStateHandlerFactoryAdapter.handleGetRequest(StateRequestHandlers.java:468)
	at org.apache.beam.runners.fnexecution.state.StateRequestHandlers$ByteStringStateRequestHandlerToBagUserStateHandlerFactoryAdapter.handle(StateRequestHandlers.java:415)
	at org.apache.beam.runners.fnexecution.state.StateRequestHandlers$StateKeyTypeDelegatingStateRequestHandler.handle(StateRequestHandlers.java:206)
	at org.apache.beam.runners.fnexecution.state.GrpcStateService$Inbound.onNext(GrpcStateService.java:130)
	at org.apache.beam.runners.fnexecution.state.GrpcStateService$Inbound.onNext(GrpcStateService.java:118)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.stub.ServerCalls$StreamingServerCallHandler$StreamingServerCallListener.onMessage(ServerCalls.java:249)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.ForwardingServerCallListener.onMessage(ForwardingServerCallListener.java:33)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.Contexts$ContextualizedServerCallListener.onMessage(Contexts.java:76)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.internal.ServerCallImpl$ServerStreamListenerImpl.messagesAvailable(ServerCallImpl.java:297)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.internal.ServerImpl$JumpToApplicationThreadServerStreamListener$1MessagesAvailable.runInContext(ServerImpl.java:738)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.internal.ContextRunnable.run(ContextRunnable.java:37)
	at org.apache.beam.vendor.grpc.v1p21p0.io.grpc.internal.SerializingExecutor.run(SerializingExecutor.java:123)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
	at java.lang.Thread.run(Thread.java:748)
 [while running &apos;process_events_with_stateful_dofn&apos;]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As long as we use standard coders, these errors do not occur. When an SDK-specific coder is used, then the nested encoding does not work properly in Python, i.e. Python does not add a length prefix but the Runner side has a &lt;tt&gt;LengthPrefixCoder(ByteArrayCoder)&lt;/tt&gt;. The only way to fix this, is to remove the length prefix coder on the Runner side and use OUTER encoding for the key in state requests. This gives correct results for known and unknown coders.&lt;/p&gt;</comment>
                            <comment id="16973491" author="mxm" created="Wed, 13 Nov 2019 16:17:30 +0000"  >&lt;p&gt;Fixed via &lt;a href=&quot;https://github.com/apache/beam/pull/9997&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/9997&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13244492">BEAM-7730</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13255215">BEAM-8162</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z06d0o:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>