<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 10:46:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[BEAM-2870] BQ Partitioned Table Write Fails When Destination has Partition Decorator</title>
                <link>https://issues.apache.org/jira/browse/BEAM-2870</link>
                <project id="12319527" key="BEAM">Beam</project>
                    <description>&lt;p&gt;Dataflow Job ID: &lt;a href=&quot;https://console.cloud.google.com/dataflow/job/2017-09-08_23_03_14-14637186041605198816&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://console.cloud.google.com/dataflow/job/2017-09-08_23_03_14-14637186041605198816&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Tagging &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reuvenlax&quot; class=&quot;user-hover&quot; rel=&quot;reuvenlax&quot;&gt;reuvenlax&lt;/a&gt; as I believe he built the time partitioning integration that was merged into master.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Background&lt;/b&gt;&lt;br/&gt;
Our production pipeline ingests millions of events per day and routes events into our clients&apos; numerous tables. To keep costs down, all of our tables are partitioned. However, this requires that we create the tables before we allow events to process as creating partitioned tables isn&apos;t supported in 2.1.0. We&apos;ve been looking forward to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=reuvenlax&quot; class=&quot;user-hover&quot; rel=&quot;reuvenlax&quot;&gt;reuvenlax&lt;/a&gt;&apos;s partition table write feature (&lt;a href=&quot;https://github.com/apache/beam/pull/3663&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;#3663&lt;/a&gt;) to get merged into master for some time now as it&apos;ll allow us to launch our client platforms much, much faster. Today we got around to testing the 2.2.0 nightly and discovered this bug.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Issue&lt;/b&gt;&lt;br/&gt;
Our pipeline writes to a table with a decorator. When attempting to write to an existing partitioned table with a decorator, the write succeeds. When using a partitioned table destination that doesn&apos;t exist without a decorator, the write succeeds. &lt;b&gt;However, when writing to a partitioned table that doesn&apos;t exist with a decorator, the write fails&lt;/b&gt;. &lt;/p&gt;

&lt;p&gt;&lt;b&gt;Example Implementation&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;BigQueryIO.writeTableRows()
  .withCreateDisposition(BigQueryIO.Write.CreateDisposition.CREATE_IF_NEEDED)
  .withWriteDisposition(BigQueryIO.Write.WriteDisposition.WRITE_APPEND)
  .withFailedInsertRetryPolicy(InsertRetryPolicy.alwaysRetry())
  .to(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DynamicDestinations&amp;lt;TableRow, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt;() {

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; getDestination(ValueInSingleWindow&amp;lt;TableRow&amp;gt; element) {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;PROJECT_ID:DATASET_ID.TABLE_ID$20170902&quot;&lt;/span&gt;;
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; TableDestination getTable(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; destination) {
      TimePartitioning DAY_PARTITION = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TimePartitioning().setType(&lt;span class=&quot;code-quote&quot;&gt;&quot;DAY&quot;&lt;/span&gt;);
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TableDestination(destination, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, DAY_PARTITION);
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; TableSchema getSchema(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; destination) {
      &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; TABLE_SCHEMA;
    }
  })
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;Relevant Logs &amp;amp; Errors in StackDriver&lt;/b&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;23:06:26.790 
Trying to create BigQuery table: PROJECT_ID:DATASET_ID.TABLE_ID$20170902

23:06:26.873 
Invalid table ID \&quot;TABLE_ID$20170902\&quot;. Table IDs must be alphanumeric (plus underscores) and must be at most 1024 characters long. Also, Table decorators cannot be used.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>Dataflow Runner, Streaming, 10 x (n1-highmem-8 &amp;amp; 500gb SDD)</environment>
        <key id="13100998">BEAM-2870</key>
            <summary>BQ Partitioned Table Write Fails When Destination has Partition Decorator</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10102" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">P2</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jkff">Eugene Kirpichov</assignee>
                                    <reporter username="SJAnderson">Steven Jon Anderson</reporter>
                        <labels>
                            <label>bigquery</label>
                            <label>dataflow</label>
                            <label>google</label>
                            <label>google-cloud-bigquery</label>
                            <label>google-dataflow</label>
                    </labels>
                <created>Sat, 9 Sep 2017 06:56:40 +0000</created>
                <updated>Fri, 24 Jul 2020 20:20:34 +0000</updated>
                            <resolved>Fri, 5 Jan 2018 19:32:26 +0000</resolved>
                                    <version>2.3.0</version>
                                    <fixVersion>2.3.0</fixVersion>
                                    <component>runner-dataflow</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16172081" author="reuvenlax" created="Tue, 19 Sep 2017 17:48:35 +0000"  >&lt;p&gt;I think the problem is that we need to strip the partition decorator off the table name before attempting to create the table. I believe that this bug affects the streaming-insert path only.&lt;/p&gt;</comment>
                            <comment id="16172150" author="githubbot" created="Tue, 19 Sep 2017 18:39:02 +0000"  >&lt;p&gt;GitHub user reuvenlax opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/beam/pull/3866&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/3866&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-2870&quot; title=&quot;BQ Partitioned Table Write Fails When Destination has Partition Decorator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-2870&quot;&gt;&lt;del&gt;BEAM-2870&lt;/del&gt;&lt;/a&gt; Strip table decorators before creating tables.&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/reuvenlax/incubator-beam&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/reuvenlax/incubator-beam&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-2870&quot; title=&quot;BQ Partitioned Table Write Fails When Destination has Partition Decorator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-2870&quot;&gt;&lt;del&gt;BEAM-2870&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/beam/pull/3866.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/3866.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #3866&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 287488914f63e63303dbc3ce9f5371078a8be00c&lt;br/&gt;
Author: Reuven Lax &amp;lt;relax@relax-macbookpro2.roam.corp.google.com&amp;gt;&lt;br/&gt;
Date:   2017-09-19T18:38:13Z&lt;/p&gt;

&lt;p&gt;    Strip table decorators before creating tables.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16172151" author="reuvenlax" created="Tue, 19 Sep 2017 18:39:27 +0000"  >&lt;p&gt;Can you try out this PR and let us know if it fixes the issue you are seeing?&lt;/p&gt;</comment>
                            <comment id="16175838" author="githubbot" created="Fri, 22 Sep 2017 03:23:42 +0000"  >&lt;p&gt;Github user asfgit closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/beam/pull/3866&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/3866&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16267156" author="jkff" created="Mon, 27 Nov 2017 18:06:33 +0000"  >&lt;p&gt;The issue is also present in the batch codepath:&lt;br/&gt;
&lt;a href=&quot;https://stackoverflow.com/questions/47351578/create-dynamic-side-outputs-in-apache-beam-dataflow?noredirect=1#comment81973314_47351578&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/47351578/create-dynamic-side-outputs-in-apache-beam-dataflow?noredirect=1#comment81973314_47351578&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.io.IOException: Unable to patch table description: {datasetId=myDATASET, projectId=myPROJECT, tableId=myTABLE$20171105}, aborting after 9 retries.
    at org.apache.beam.sdk.io.gcp.bigquery.BigQueryServicesImpl.executeWithRetries(BigQueryServicesImpl.java:879)
    at org.apache.beam.sdk.io.gcp.bigquery.BigQueryServicesImpl$DatasetServiceImpl.patchTableDescription(BigQueryServicesImpl.java:826)
    at org.apache.beam.sdk.io.gcp.bigquery.WriteTables.load(WriteTables.java:250)
    at org.apache.beam.sdk.io.gcp.bigquery.WriteTables.access$600(WriteTables.java:77)
    at org.apache.beam.sdk.io.gcp.bigquery.WriteTables$WriteTablesDoFn.processElement(WriteTables.java:141)
Caused by: com.google.api.client.googleapis.json.GoogleJsonResponseException: 400 Bad Request
{
  &lt;span class=&quot;code-quote&quot;&gt;&quot;code&quot;&lt;/span&gt; : 400,
  &lt;span class=&quot;code-quote&quot;&gt;&quot;errors&quot;&lt;/span&gt; : [ {
    &lt;span class=&quot;code-quote&quot;&gt;&quot;domain&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;global&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;message&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;Invalid table ID \&quot;&lt;/span&gt;myTABLE$20171105\&lt;span class=&quot;code-quote&quot;&gt;&quot;. Table IDs must be alphanumeric (plus underscores) and must be at most 1024 characters &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;. Also, Table decorators cannot be used.&quot;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;reason&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;invalid&quot;&lt;/span&gt;
  } ],
  &lt;span class=&quot;code-quote&quot;&gt;&quot;message&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;Invalid table ID \&quot;&lt;/span&gt;myTABLE$20171105\&lt;span class=&quot;code-quote&quot;&gt;&quot;. Table IDs must be alphanumeric (plus underscores) and must be at most 1024 characters &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;. Also, Table decorators cannot be used.&quot;&lt;/span&gt;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16267213" author="githubbot" created="Mon, 27 Nov 2017 18:35:33 +0000"  >&lt;p&gt;jkff opened a new pull request #4177: &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-2870&quot; title=&quot;BQ Partitioned Table Write Fails When Destination has Partition Decorator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-2870&quot;&gt;&lt;del&gt;BEAM-2870&lt;/del&gt;&lt;/a&gt; Strips partition decorators when creating/patching tables in batch&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/beam/pull/4177&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/4177&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;   Addresses &lt;a href=&quot;https://stackoverflow.com/questions/47351578/create-dynamic-side-outputs-in-apache-beam-dataflow?noredirect=1#comment81973314_47351578&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/questions/47351578/create-dynamic-side-outputs-in-apache-beam-dataflow?noredirect=1#comment81973314_47351578&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;   R: @chamikaramj &lt;br/&gt;
   CC: @reuvenlax &lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16271632" author="githubbot" created="Wed, 29 Nov 2017 22:13:46 +0000"  >&lt;p&gt;chamikaramj commented on a change in pull request #4177: &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-2870&quot; title=&quot;BQ Partitioned Table Write Fails When Destination has Partition Decorator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-2870&quot;&gt;&lt;del&gt;BEAM-2870&lt;/del&gt;&lt;/a&gt; Strips partition decorators when creating/patching tables in batch&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/beam/pull/4177#discussion_r153931082&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/4177#discussion_r153931082&lt;/a&gt;&lt;/p&gt;



&lt;p&gt; ##########&lt;br/&gt;
 File path: sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/FakeDatasetService.java&lt;br/&gt;
 ##########&lt;br/&gt;
 @@ -96,6 +96,7 @@ private TableContainer getTableContainer(String projectId, String datasetId, Str&lt;/p&gt;

&lt;p&gt;   @Override&lt;br/&gt;
   public void deleteTable(TableReference tableRef) throws IOException, InterruptedException {&lt;br/&gt;
+    validateTableReference(tableRef);&lt;/p&gt;

&lt;p&gt; Review comment:&lt;br/&gt;
   &amp;lt;!-&lt;del&gt;new_thread; commit:8ecf03913381fbbefb90be1677d9a59188821ce6; resolved:0&lt;/del&gt;-&amp;gt;&lt;br/&gt;
   Nit: also validate getTable() ?&lt;/p&gt;

&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16271657" author="githubbot" created="Wed, 29 Nov 2017 22:27:07 +0000"  >&lt;p&gt;asfgit closed pull request #4177: &lt;a href=&quot;https://issues.apache.org/jira/browse/BEAM-2870&quot; title=&quot;BQ Partitioned Table Write Fails When Destination has Partition Decorator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;BEAM-2870&quot;&gt;&lt;del&gt;BEAM-2870&lt;/del&gt;&lt;/a&gt; Strips partition decorators when creating/patching tables in batch&lt;br/&gt;
URL: &lt;a href=&quot;https://github.com/apache/beam/pull/4177&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/4177&lt;/a&gt;&lt;/p&gt;




&lt;p&gt;This is a PR merged from a forked repository.&lt;br/&gt;
As GitHub hides the original diff on merge, it is displayed below for&lt;br/&gt;
the sake of provenance:&lt;/p&gt;

&lt;p&gt;As this is a foreign pull request (from a fork), the diff is supplied&lt;br/&gt;
below (as it won&apos;t show otherwise due to GitHub magic):&lt;/p&gt;

&lt;p&gt;diff --git a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/WriteTables.java b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/WriteTables.java&lt;br/&gt;
index 9ca253ca8df..7077651ced2 100644&lt;br/&gt;
&amp;#8212; a/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/WriteTables.java&lt;br/&gt;
+++ b/sdks/java/io/google-cloud-platform/src/main/java/org/apache/beam/sdk/io/gcp/bigquery/WriteTables.java&lt;br/&gt;
@@ -264,7 +264,9 @@ private void load(&lt;br/&gt;
       switch (jobStatus) {&lt;br/&gt;
         case SUCCEEDED:&lt;br/&gt;
           if (tableDescription != null) &lt;/p&gt;
{
-            datasetService.patchTableDescription(ref, tableDescription);
+            datasetService.patchTableDescription(
+                ref.clone().setTableId(BigQueryHelpers.stripPartitionDecorator(ref.getTableId())),
+                tableDescription);
           }
&lt;p&gt;           return;&lt;br/&gt;
         case UNKNOWN:&lt;br/&gt;
diff --git a/sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryIOTest.java b/sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryIOTest.java&lt;br/&gt;
index 08f74649859..31c1781f610 100644&lt;br/&gt;
&amp;#8212; a/sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryIOTest.java&lt;br/&gt;
+++ b/sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/BigQueryIOTest.java&lt;br/&gt;
@@ -589,7 +589,12 @@ public String apply(String arg) {&lt;/p&gt;

&lt;p&gt;     if (streaming) &lt;/p&gt;
{
       users = users.setIsBoundedInternal(PCollection.IsBounded.UNBOUNDED);
+
     }
&lt;p&gt;+&lt;br/&gt;
+    // Use a partition decorator to verify that partition decorators are supported.&lt;br/&gt;
+    final String partitionDecorator = &quot;20171127&quot;;&lt;br/&gt;
+&lt;br/&gt;
     users.apply(&lt;br/&gt;
         &quot;WriteBigQuery&quot;,&lt;br/&gt;
         BigQueryIO.&amp;lt;String&amp;gt;write()&lt;br/&gt;
@@ -630,7 +635,8 @@ public TableDestination getTable(Integer userId) &lt;/p&gt;
{
                     verifySideInputs();
                     // Each user in it&apos;s own table.
                     return new TableDestination(
-                        &quot;dataset-id.userid-&quot; + userId, &quot;table for userid &quot; + userId);
+                        &quot;dataset-id.userid-&quot; + userId + &quot;$&quot; + partitionDecorator,
+                        &quot;table for userid &quot; + userId);
                   }

&lt;p&gt;                   @Override&lt;br/&gt;
@@ -2528,7 +2534,7 @@ public void testWriteToTableDecorator() throws Exception {&lt;br/&gt;
     p.apply(Create.of(row1, row2))&lt;br/&gt;
         .apply(&lt;br/&gt;
             BigQueryIO.writeTableRows()&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;.to(&quot;project-id:dataset-id.table-id$decorator&quot;)&lt;br/&gt;
+                .to(&quot;project-id:dataset-id.table-id$20171127&quot;)&lt;br/&gt;
                 .withTestServices(fakeBqServices)&lt;br/&gt;
                 .withMethod(Method.STREAMING_INSERTS)&lt;br/&gt;
                 .withSchema(schema)&lt;br/&gt;
@@ -2539,7 +2545,7 @@ public void testWriteToTableDecorator() throws Exception {&lt;br/&gt;
   @Test&lt;br/&gt;
   public void testTableDecoratorStripping() 
{
     assertEquals(&quot;project:dataset.table&quot;,
-        BigQueryHelpers.stripPartitionDecorator(&quot;project:dataset.table$decorator&quot;));
+        BigQueryHelpers.stripPartitionDecorator(&quot;project:dataset.table$20171127&quot;));
     assertEquals(&quot;project:dataset.table&quot;,
         BigQueryHelpers.stripPartitionDecorator(&quot;project:dataset.table&quot;));
   }
&lt;p&gt;diff --git a/sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/FakeDatasetService.java b/sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/FakeDatasetService.java&lt;br/&gt;
index ffab1239217..79e03e84a58 100644&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;a/sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/FakeDatasetService.java&lt;br/&gt;
+++ b/sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/FakeDatasetService.java&lt;br/&gt;
@@ -96,6 +96,7 @@ private TableContainer getTableContainer(String projectId, String datasetId, Str&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;   @Override&lt;br/&gt;
   public void deleteTable(TableReference tableRef) throws IOException, InterruptedException {&lt;br/&gt;
+    validateTableReference(tableRef);&lt;br/&gt;
     synchronized (BigQueryIOTest.tables) &lt;/p&gt;
{
       Map&amp;lt;String, TableContainer&amp;gt; dataset =
           BigQueryIOTest.tables.get(tableRef.getProjectId(), tableRef.getDatasetId());
@@ -109,12 +110,8 @@ public void deleteTable(TableReference tableRef) throws IOException, Interrupted
     }
&lt;p&gt;   }&lt;/p&gt;

&lt;p&gt;-&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Override&lt;/li&gt;
	&lt;li&gt;public void createTable(Table table) throws IOException {&lt;br/&gt;
+  private static void validateTableReference(TableReference tableReference) throws IOException {&lt;br/&gt;
     final Pattern tableRegexp = Pattern.compile(&quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;-\\w&amp;#93;&lt;/span&gt;
{1,1024}
&lt;p&gt;&quot;);&lt;br/&gt;
-&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;TableReference tableReference = table.getTableReference();&lt;br/&gt;
     if (!tableRegexp.matcher(tableReference.getTableId()).matches()) 
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {       throw new IOException(           String.format(@@ -123,6 +120,12 @@ public void createTable(Table table) throws IOException {
                   + &quot; decorators cannot be used.&quot;,
               tableReference.getTableId()));
     }+  }&lt;/span&gt; &lt;/div&gt;
&lt;p&gt;+&lt;br/&gt;
+  @Override&lt;br/&gt;
+  public void createTable(Table table) throws IOException {&lt;br/&gt;
+    TableReference tableReference = table.getTableReference();&lt;br/&gt;
+    validateTableReference(tableReference);&lt;br/&gt;
     synchronized (BigQueryIOTest.tables) {&lt;br/&gt;
       Map&amp;lt;String, TableContainer&amp;gt; dataset =&lt;br/&gt;
           BigQueryIOTest.tables.get(tableReference.getProjectId(), tableReference.getDatasetId());&lt;br/&gt;
@@ -245,6 +248,7 @@ public long insertAll(&lt;br/&gt;
   public Table patchTableDescription(TableReference tableReference,&lt;br/&gt;
                                      @Nullable String tableDescription)&lt;br/&gt;
       throws IOException, InterruptedException {&lt;br/&gt;
+    validateTableReference(tableReference);&lt;br/&gt;
     synchronized (BigQueryIOTest.tables) &lt;/p&gt;
{
       TableContainer tableContainer = getTableContainer(tableReference.getProjectId(),
           tableReference.getDatasetId(), tableReference.getTableId());
diff --git a/sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/FakeJobService.java b/sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/FakeJobService.java
index edf2a55142a..fcf464fbdfb 100644
--- a/sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/FakeJobService.java
+++ b/sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/bigquery/FakeJobService.java
@@ -312,7 +312,14 @@ private JobStatus runLoadJob(JobReference jobRef, JobConfigurationLoad load)
       return new JobStatus().setState(&quot;FAILED&quot;).setErrorResult(new ErrorProto());
     }
&lt;p&gt;     if (existingTable == null) {&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;existingTable = new Table().setTableReference(destination).setSchema(schema);&lt;br/&gt;
+      TableReference strippedDestination =&lt;br/&gt;
+          destination&lt;br/&gt;
+              .clone()&lt;br/&gt;
+              .setTableId(BigQueryHelpers.stripPartitionDecorator(destination.getTableId()));&lt;br/&gt;
+      existingTable =&lt;br/&gt;
+          new Table()&lt;br/&gt;
+              .setTableReference(strippedDestination)&lt;br/&gt;
+              .setSchema(schema);&lt;br/&gt;
       if (load.getTimePartitioning() != null) 
{
         existingTable = existingTable.setTimePartitioning(load.getTimePartitioning());
       }&lt;/li&gt;
&lt;/ul&gt;





&lt;p&gt;----------------------------------------------------------------&lt;br/&gt;
This is an automated message from the Apache Git Service.&lt;br/&gt;
To respond to the message, please log on GitHub and use the&lt;br/&gt;
URL above to go to the specific comment.&lt;/p&gt;

&lt;p&gt;For queries about this service, please contact Infrastructure at:&lt;br/&gt;
users@infra.apache.org&lt;/p&gt;</comment>
                            <comment id="16313725" author="jkff" created="Fri, 5 Jan 2018 19:32:26 +0000"  >&lt;p&gt;This was fixed for batch by &lt;a href=&quot;https://github.com/apache/beam/pull/4177&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/beam/pull/4177&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[no_permission]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 45 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3jutz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>