diff --git a/test/unit/org/apache/cassandra/io/util/SafeMemoryWriterTest.java b/test/unit/org/apache/cassandra/io/util/SafeMemoryWriterTest.java
index 12c8c985ca..8b37c2def2 100644
--- a/test/unit/org/apache/cassandra/io/util/SafeMemoryWriterTest.java
+++ b/test/unit/org/apache/cassandra/io/util/SafeMemoryWriterTest.java
@@ -24,8 +24,6 @@ import java.util.Random;
 import org.junit.Assert;
 import org.junit.Test;
 
-import sun.misc.VM;
-
 import static org.junit.Assert.assertEquals;
 
 public class SafeMemoryWriterTest
@@ -33,6 +31,28 @@ public class SafeMemoryWriterTest
     Random rand = new Random();
     static final int CHUNK = 54321;
 
+    static final long maxDirectMemory;
+    static
+    {
+        try
+        {
+            Class<?> cVM;
+            try
+            {
+                cVM = Class.forName("jdk.internal.misc.VM");
+            }
+            catch (ClassNotFoundException e)
+            {
+                cVM = Class.forName("sun.misc.VM");
+            }
+            maxDirectMemory = (Long) cVM.getDeclaredMethod("maxDirectMemory").invoke(null);
+        }
+        catch (Exception e)
+        {
+            throw new RuntimeException(e);
+        }
+    }
+
     @Test
     public void testTrim() throws IOException
     {
@@ -51,9 +71,9 @@ public class SafeMemoryWriterTest
         while (initialSize * 2 / 3 > 1024L * 1024L * DataOutputBuffer.DOUBLING_THRESHOLD)
             initialSize = initialSize * 2 / 3;
 
-        if (VM.maxDirectMemory() * 2 / 3 < testSize)
+        if (maxDirectMemory * 2 / 3 < testSize)
         {
-            testSize = VM.maxDirectMemory() * 2 / 3;
+            testSize = maxDirectMemory * 2 / 3;
             System.err.format("Insufficient direct memory for full test, reducing to: %,d %x\n", testSize, testSize);
         }
 
