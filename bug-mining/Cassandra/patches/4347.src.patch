diff --git a/CHANGES.txt b/CHANGES.txt
index 3aa5ea934b..33014d53e4 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -1,5 +1,6 @@
 2.1.16
  * Reduce contention getting instances of CompositeType (CASSANDRA-10433)
+ * Improve digest calculation in the presence of overlapping tombstones (CASSANDRA-11349)
 
 2.1.15
  * Account for partition deletions in tombstone histogram (CASSANDRA-12112)
diff --git a/src/java/org/apache/cassandra/db/ColumnIndex.java b/src/java/org/apache/cassandra/db/ColumnIndex.java
index f63dfe1e51..8f147ccca1 100644
--- a/src/java/org/apache/cassandra/db/ColumnIndex.java
+++ b/src/java/org/apache/cassandra/db/ColumnIndex.java
@@ -68,11 +68,19 @@ public class ColumnIndex
         private final ByteBuffer key;
         private final DeletionInfo deletionInfo; // only used for serializing and calculating row header size
 
-        private final OnDiskAtom.Serializer atomSerializer;
+        private final OnDiskAtom.SerializerForWriting atomSerializer;
 
         public Builder(ColumnFamily cf,
                        ByteBuffer key,
                        DataOutputPlus output)
+        {
+            this(cf, key, output, cf.getComparator().onDiskAtomSerializer());
+        }
+
+        public Builder(ColumnFamily cf,
+                ByteBuffer key,
+                DataOutputPlus output,
+                OnDiskAtom.SerializerForWriting serializer)
         {
             assert cf != null;
             assert key != null;
@@ -84,7 +92,7 @@ public class ColumnIndex
             this.result = new ColumnIndex(new ArrayList<IndexHelper.IndexInfo>());
             this.output = output;
             this.tombstoneTracker = new RangeTombstone.Tracker(cf.getComparator());
-            this.atomSerializer = cf.getComparator().onDiskAtomSerializer();
+            this.atomSerializer = serializer;
         }
 
         /**
diff --git a/src/java/org/apache/cassandra/db/OnDiskAtom.java b/src/java/org/apache/cassandra/db/OnDiskAtom.java
index b53e43b3d6..3e768eaf45 100644
--- a/src/java/org/apache/cassandra/db/OnDiskAtom.java
+++ b/src/java/org/apache/cassandra/db/OnDiskAtom.java
@@ -43,7 +43,13 @@ public interface OnDiskAtom
     public void validateFields(CFMetaData metadata) throws MarshalException;
     public void updateDigest(MessageDigest digest);
 
-    public static class Serializer implements ISSTableSerializer<OnDiskAtom>
+    public interface SerializerForWriting
+    {
+        public void serializeForSSTable(OnDiskAtom atom, DataOutputPlus out) throws IOException;
+        public long serializedSizeForSSTable(OnDiskAtom atom);
+    }
+
+    public static class Serializer implements ISSTableSerializer<OnDiskAtom>, SerializerForWriting
     {
         private final CellNameType type;
 
diff --git a/src/java/org/apache/cassandra/db/RangeTombstone.java b/src/java/org/apache/cassandra/db/RangeTombstone.java
index 5e41792105..9dc2723915 100644
--- a/src/java/org/apache/cassandra/db/RangeTombstone.java
+++ b/src/java/org/apache/cassandra/db/RangeTombstone.java
@@ -152,7 +152,7 @@ public class RangeTombstone extends Interval<Composite, DeletionTime> implements
          * @return the total serialized size of said tombstones and write them to
          * {@code out} it if isn't null.
          */
-        public long writeOpenedMarkers(Composite startPos, DataOutputPlus out, OnDiskAtom.Serializer atomSerializer) throws IOException
+        public long writeOpenedMarkers(Composite startPos, DataOutputPlus out, OnDiskAtom.SerializerForWriting atomSerializer) throws IOException
         {
             long size = 0;
 
@@ -172,7 +172,7 @@ public class RangeTombstone extends Interval<Composite, DeletionTime> implements
          *
          * @return the serialized size of written tombstones
          */
-        public long writeUnwrittenTombstones(DataOutputPlus out, OnDiskAtom.Serializer atomSerializer) throws IOException
+        public long writeUnwrittenTombstones(DataOutputPlus out, OnDiskAtom.SerializerForWriting atomSerializer) throws IOException
         {
             long size = 0;
             for (RangeTombstone rt : unwrittenTombstones)
@@ -183,7 +183,7 @@ public class RangeTombstone extends Interval<Composite, DeletionTime> implements
             return size;
         }
 
-        private long writeTombstone(RangeTombstone rt, DataOutputPlus out, OnDiskAtom.Serializer atomSerializer)
+        private long writeTombstone(RangeTombstone rt, DataOutputPlus out, OnDiskAtom.SerializerForWriting atomSerializer)
                 throws IOException
         {
             long size = atomSerializer.serializedSizeForSSTable(rt);
diff --git a/src/java/org/apache/cassandra/db/compaction/LazilyCompactedRow.java b/src/java/org/apache/cassandra/db/compaction/LazilyCompactedRow.java
index e9aecb2c73..f912da236e 100644
--- a/src/java/org/apache/cassandra/db/compaction/LazilyCompactedRow.java
+++ b/src/java/org/apache/cassandra/db/compaction/LazilyCompactedRow.java
@@ -148,16 +148,30 @@ public class LazilyCompactedRow extends AbstractCompactedRow
         return RowIndexEntry.create(currentPosition, emptyColumnFamily.deletionInfo().getTopLevelDeletion(), columnsIndex);
     }
 
-    public void update(MessageDigest digest)
+    public void update(final MessageDigest digest)
     {
         assert !closed;
 
         // no special-case for rows.size == 1, we're actually skipping some bytes here so just
         // blindly updating everything wouldn't be correct
         DataOutputBuffer out = new DataOutputBuffer();
+        OnDiskAtom.SerializerForWriting serializer = new OnDiskAtom.SerializerForWriting()
+        {
+            @Override
+            public void serializeForSSTable(OnDiskAtom atom, DataOutputPlus out) throws IOException
+            {
+                atom.updateDigest(digest);
+            }
+
+            @Override
+            public long serializedSizeForSSTable(OnDiskAtom atom)
+            {
+                return 0;
+            }
+        };
 
         // initialize indexBuilder for the benefit of its tombstoneTracker, used by our reducing iterator
-        indexBuilder = new ColumnIndex.Builder(emptyColumnFamily, key.getKey(), out);
+        indexBuilder = new ColumnIndex.Builder(emptyColumnFamily, key.getKey(), out, serializer);
 
         try
         {
@@ -171,14 +185,13 @@ public class LazilyCompactedRow extends AbstractCompactedRow
             {
                 digest.update(out.getData(), 0, out.getLength());
             }
+            indexBuilder.buildForCompaction(merger);
         }
         catch (IOException e)
         {
             throw new AssertionError(e);
         }
 
-        while (merger.hasNext())
-            merger.next().updateDigest(digest);
         close();
     }
 
