diff --git a/CHANGES.txt b/CHANGES.txt
index c73399e6fd..d9d4a7745e 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -1,4 +1,5 @@
 4.0.4
+ * Fix race condition bug during local session repair (CASSANDRA-17335)
  * Fix ignored streaming encryption settings in sstableloader (CASSANDRA-17367)
  * Streaming tasks handle empty SSTables correctly (CASSANDRA-16349)
  * Prevent SSTableLoader from doing unnecessary work (CASSANDRA-16349)
diff --git a/src/java/org/apache/cassandra/repair/consistent/LocalSessions.java b/src/java/org/apache/cassandra/repair/consistent/LocalSessions.java
index 9ee0bb02c5..6f7b93e930 100644
--- a/src/java/org/apache/cassandra/repair/consistent/LocalSessions.java
+++ b/src/java/org/apache/cassandra/repair/consistent/LocalSessions.java
@@ -828,9 +828,7 @@ public class LocalSessions
                 try
                 {
                     logger.info("Prepare phase for incremental repair session {} completed", sessionID);
-                    if (session.getState() != FAILED)
-                        setStateAndSave(session, PREPARED);
-                    else
+                    if (!prepareSessionExceptFailed(session))
                         logger.info("Session {} failed before anticompaction completed", sessionID);
 
                     Message<PrepareConsistentResponse> message =
@@ -862,6 +860,25 @@ public class LocalSessions
         }, MoreExecutors.directExecutor());
     }
 
+    /**
+     * Checks for the session state, and sets it to prepared unless it is on a failed state.
+     * Making the checks inside a synchronized block to prevent the session state from
+     * being changed between the read and the update.
+     *
+     * @param session The local session to be set to prepared.
+     * @return true if the session is prepared, false if not, i.e. session failed
+     */
+    private boolean prepareSessionExceptFailed(LocalSession session) {
+        synchronized (session)
+        {
+            if (session.getState() == FAILED)
+                return false;
+
+            setStateAndSave(session, PREPARED);
+            return true;
+        }
+    }
+
     public void maybeSetRepairing(UUID sessionID)
     {
         LocalSession session = getSession(sessionID);
