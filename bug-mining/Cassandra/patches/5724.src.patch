diff --git a/CHANGES.txt b/CHANGES.txt
index 4cba62d206..aaf8fe1488 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -1,4 +1,5 @@
 3.0.25:
+ * Prevent loss of commit log data when moving sstables between nodes (CASSANDRA-16619)
  * Fix materialized view builders inserting truncated data (CASSANDRA-16567)
  * Don't wait for schema migrations from removed nodes (CASSANDRA-16577)
  * Scheduled (delayed) schema pull tasks should not run after MIGRATION stage shutdown during decommission (CASSANDRA-16495)
diff --git a/src/java/org/apache/cassandra/db/SystemKeyspace.java b/src/java/org/apache/cassandra/db/SystemKeyspace.java
index 7c222dd807..7fd9268f91 100644
--- a/src/java/org/apache/cassandra/db/SystemKeyspace.java
+++ b/src/java/org/apache/cassandra/db/SystemKeyspace.java
@@ -1072,8 +1072,7 @@ public final class SystemKeyspace
     }
 
     /**
-     * Read the host ID from the system keyspace, creating (and storing) one if
-     * none exists.
+     * Read the host ID from the system keyspace.
      */
     public static UUID getLocalHostId()
     {
@@ -1081,11 +1080,24 @@ public final class SystemKeyspace
         UntypedResultSet result = executeInternal(String.format(req, LOCAL, LOCAL));
 
         // Look up the Host UUID (return it if found)
-        if (!result.isEmpty() && result.one().has("host_id"))
+        if (result != null && !result.isEmpty() && result.one().has("host_id"))
             return result.one().getUUID("host_id");
 
+        return null;
+    }
+
+    /**
+     * Read the host ID from the system keyspace, creating (and storing) one if
+     * none exists.
+     */
+    public static synchronized UUID getOrInitializeLocalHostId()
+    {
+        UUID hostId = getLocalHostId();
+        if (hostId != null)
+            return hostId;
+
         // ID not found, generate a new one, persist, and then return it.
-        UUID hostId = UUID.randomUUID();
+        hostId = UUID.randomUUID();
         logger.warn("No host ID found, created {} (Note: This should happen exactly once per node).", hostId);
         return setLocalHostId(hostId);
     }
@@ -1093,7 +1105,7 @@ public final class SystemKeyspace
     /**
      * Sets the local host ID explicitly.  Should only be called outside of SystemTable when replacing a node.
      */
-    public static UUID setLocalHostId(UUID hostId)
+    public static synchronized UUID setLocalHostId(UUID hostId)
     {
         String req = "INSERT INTO system.%s (key, host_id) VALUES ('%s', ?)";
         executeInternal(String.format(req, LOCAL, LOCAL), hostId);
diff --git a/src/java/org/apache/cassandra/db/commitlog/CommitLog.java b/src/java/org/apache/cassandra/db/commitlog/CommitLog.java
index 18511e49f6..df539cbf47 100644
--- a/src/java/org/apache/cassandra/db/commitlog/CommitLog.java
+++ b/src/java/org/apache/cassandra/db/commitlog/CommitLog.java
@@ -166,17 +166,22 @@ public class CommitLog implements CommitLogMBean
      */
     public int recover(File... clogs) throws IOException
     {
-        CommitLogReplayer recovery = CommitLogReplayer.construct(this);
+        CommitLogReplayer recovery = CommitLogReplayer.construct(this, getLocalHostId());
         recovery.recover(clogs);
         return recovery.blockForWrites();
     }
 
+    private static UUID getLocalHostId()
+    {
+        return Optional.ofNullable(StorageService.instance.getLocalHostUUID()).orElseGet(SystemKeyspace::getLocalHostId);
+    }
+
     /**
      * Perform recovery on a single commit log.
      */
     public void recover(String path) throws IOException
     {
-        CommitLogReplayer recovery = CommitLogReplayer.construct(this);
+        CommitLogReplayer recovery = CommitLogReplayer.construct(this, getLocalHostId());
         recovery.recover(new File(path), false);
         recovery.blockForWrites();
     }
diff --git a/src/java/org/apache/cassandra/db/commitlog/CommitLogReplayer.java b/src/java/org/apache/cassandra/db/commitlog/CommitLogReplayer.java
index 3ec4f15777..0f07dae016 100644
--- a/src/java/org/apache/cassandra/db/commitlog/CommitLogReplayer.java
+++ b/src/java/org/apache/cassandra/db/commitlog/CommitLogReplayer.java
@@ -55,6 +55,7 @@ import org.apache.cassandra.io.util.ChannelProxy;
 import org.apache.cassandra.io.util.DataInputBuffer;
 import org.apache.cassandra.io.util.FileDataInput;
 import org.apache.cassandra.io.util.RandomAccessReader;
+import org.apache.cassandra.service.StorageService;
 import org.apache.cassandra.utils.FBUtilities;
 import org.apache.cassandra.utils.JVMStabilityInspector;
 import org.apache.cassandra.utils.WrappedRunnable;
@@ -98,7 +99,7 @@ public class CommitLogReplayer
         this.archiver = commitLog.archiver;
     }
 
-    public static CommitLogReplayer construct(CommitLog commitLog)
+    public static CommitLogReplayer construct(CommitLog commitLog, UUID localHostId)
     {
         // compute per-CF and global replay intervals
         Map<UUID, IntervalSet<ReplayPosition>> cfPersisted = new HashMap<>();
@@ -127,7 +128,7 @@ public class CommitLogReplayer
                 }
             }
 
-            IntervalSet<ReplayPosition> filter = persistedIntervals(cfs.getLiveSSTables(), truncatedAt);
+            IntervalSet<ReplayPosition> filter = persistedIntervals(cfs.getLiveSSTables(), truncatedAt, localHostId);
             cfPersisted.put(cfs.metadata.cfId, filter);
         }
         ReplayPosition globalPosition = firstNotCovered(cfPersisted.values());
@@ -194,11 +195,25 @@ public class CommitLogReplayer
      * A set of known safe-to-discard commit log replay positions, based on
      * the range covered by on disk sstables and those prior to the most recent truncation record
      */
-    public static IntervalSet<ReplayPosition> persistedIntervals(Iterable<SSTableReader> onDisk, ReplayPosition truncatedAt)
+    public static IntervalSet<ReplayPosition> persistedIntervals(Iterable<SSTableReader> onDisk,
+                                                                    ReplayPosition truncatedAt,
+                                                                    UUID localhostId)
     {
         IntervalSet.Builder<ReplayPosition> builder = new IntervalSet.Builder<>();
+        List<String> skippedSSTables = new ArrayList<>();
         for (SSTableReader reader : onDisk)
-            builder.addAll(reader.getSSTableMetadata().commitLogIntervals);
+        {
+            UUID originatingHostId = reader.getSSTableMetadata().originatingHostId;
+            if (originatingHostId != null && originatingHostId.equals(localhostId))
+                builder.addAll(reader.getSSTableMetadata().commitLogIntervals);
+            else
+                skippedSSTables.add(reader.getFilename());
+        }
+
+        if (!skippedSSTables.isEmpty()) {
+            logger.warn("Origin of {} sstables is unknown or doesn't match the local node; commitLogIntervals for them were ignored", skippedSSTables.size());
+            logger.debug("Ignored commitLogIntervals from the following sstables: {}", skippedSSTables);
+        }
 
         if (truncatedAt != null)
             builder.add(ReplayPosition.NONE, truncatedAt);
@@ -220,9 +235,9 @@ public class CommitLogReplayer
     public static ReplayPosition firstNotCovered(Collection<IntervalSet<ReplayPosition>> ranges)
     {
         return ranges.stream()
-                .map(intervals -> Iterables.getFirst(intervals.ends(), ReplayPosition.NONE)) 
+                .map(intervals -> Iterables.getFirst(intervals.ends(), ReplayPosition.NONE))
                 .min(Ordering.natural())
-                .get(); // iteration is per known-CF, there must be at least one. 
+                .get(); // iteration is per known-CF, there must be at least one.
     }
 
     public int blockForWrites()
@@ -533,8 +548,8 @@ public class CommitLogReplayer
             {
                 // We rely on reading serialized size == 0 (LEGACY_END_OF_SEGMENT_MARKER) to identify the end
                 // of a segment, which happens naturally due to the 0 padding of the empty segment on creation.
-                // However, it's possible with 2.1 era commitlogs that the last mutation ended less than 4 bytes 
-                // from the end of the file, which means that we'll be unable to read an a full int and instead 
+                // However, it's possible with 2.1 era commitlogs that the last mutation ended less than 4 bytes
+                // from the end of the file, which means that we'll be unable to read an a full int and instead
                 // read an EOF here
                 if(end - reader.getFilePointer() < 4)
                 {
diff --git a/src/java/org/apache/cassandra/io/sstable/format/Version.java b/src/java/org/apache/cassandra/io/sstable/format/Version.java
index 2b9dcbd4a4..c330b816ff 100644
--- a/src/java/org/apache/cassandra/io/sstable/format/Version.java
+++ b/src/java/org/apache/cassandra/io/sstable/format/Version.java
@@ -124,4 +124,6 @@ public abstract class Version
     {
         return version != null ? version.hashCode() : 0;
     }
+
+    public abstract boolean hasOriginatingHostId();
 }
diff --git a/src/java/org/apache/cassandra/io/sstable/format/big/BigFormat.java b/src/java/org/apache/cassandra/io/sstable/format/big/BigFormat.java
index 360ef8a8d2..c26e468c10 100644
--- a/src/java/org/apache/cassandra/io/sstable/format/big/BigFormat.java
+++ b/src/java/org/apache/cassandra/io/sstable/format/big/BigFormat.java
@@ -111,7 +111,7 @@ public class BigFormat implements SSTableFormat
     // we always incremented the major version.
     static class BigVersion extends Version
     {
-        public static final String current_version = "md";
+        public static final String current_version = "me";
         public static final String earliest_supported_version = "jb";
 
         // jb (2.0.1): switch from crc32 to adler32 for compression checksums
@@ -127,6 +127,7 @@ public class BigFormat implements SSTableFormat
         // mb (3.0.7, 3.7): commit log lower bound included
         // mc (3.0.8, 3.9): commit log intervals included
         // md (3.0.18, 3.11.4): corrected sstable min/max clustering
+        // me (3.0.25, 3.11.11): added hostId of the node from which the sstable originated
         //
         // NOTE: when adding a new version, please add that to LegacySSTableTest, too.
 
@@ -149,6 +150,7 @@ public class BigFormat implements SSTableFormat
         private final boolean hasCommitLogLowerBound;
         private final boolean hasCommitLogIntervals;
         private final boolean hasAccurateMinMax;
+        private final boolean hasOriginatingHostId;
 
         /**
          * CASSANDRA-7066: compaction ancerstors are no longer used and have been removed.
@@ -192,6 +194,7 @@ public class BigFormat implements SSTableFormat
                                      || version.compareTo("mb") >= 0;
             hasCommitLogIntervals = version.compareTo("mc") >= 0;
             hasAccurateMinMax = version.compareTo("md") >= 0;
+            hasOriginatingHostId = version.matches("m[e-z]");
         }
 
         @Override
@@ -301,5 +304,10 @@ public class BigFormat implements SSTableFormat
         {
             return isCompatible() && version.charAt(0) == current_version.charAt(0);
         }
+
+        public boolean hasOriginatingHostId()
+        {
+            return hasOriginatingHostId;
+        }
     }
 }
diff --git a/src/java/org/apache/cassandra/io/sstable/metadata/LegacyMetadataSerializer.java b/src/java/org/apache/cassandra/io/sstable/metadata/LegacyMetadataSerializer.java
index a683513356..ac10762945 100644
--- a/src/java/org/apache/cassandra/io/sstable/metadata/LegacyMetadataSerializer.java
+++ b/src/java/org/apache/cassandra/io/sstable/metadata/LegacyMetadataSerializer.java
@@ -35,6 +35,7 @@ import org.apache.cassandra.service.ActiveRepairService;
 import org.apache.cassandra.utils.ByteBufferUtil;
 import org.apache.cassandra.utils.EstimatedHistogram;
 import org.apache.cassandra.utils.StreamingHistogram;
+import org.apache.cassandra.utils.UUIDSerializer;
 
 import static org.apache.cassandra.io.sstable.metadata.StatsMetadata.replayPositionSetSerializer;
 
@@ -78,6 +79,18 @@ public class LegacyMetadataSerializer extends MetadataSerializer
             ReplayPosition.serializer.serialize(stats.commitLogIntervals.lowerBound().orElse(ReplayPosition.NONE), out);
         if (version.hasCommitLogIntervals())
             replayPositionSetSerializer.serialize(stats.commitLogIntervals, out);
+        if (version.hasOriginatingHostId())
+        {
+            if (stats.originatingHostId != null)
+            {
+                out.writeByte(1);
+                UUIDSerializer.serializer.serialize(stats.originatingHostId, out, 0);
+            }
+            else
+            {
+                out.writeByte(0);
+            }
+        }
     }
 
     /**
@@ -132,6 +145,10 @@ public class LegacyMetadataSerializer extends MetadataSerializer
                 else
                     commitLogIntervals = new IntervalSet<>(commitLogLowerBound, commitLogUpperBound);
 
+                UUID hostId = null;
+                if (descriptor.version.hasOriginatingHostId() && in.readByte() != 0)
+                    hostId = UUIDSerializer.serializer.deserialize(in, descriptor.version.correspondingMessagingVersion());
+
                 if (types.contains(MetadataType.VALIDATION))
                     components.put(MetadataType.VALIDATION,
                                    new ValidationMetadata(partitioner, bloomFilterFPChance));
@@ -154,7 +171,8 @@ public class LegacyMetadataSerializer extends MetadataSerializer
                                                      true,
                                                      ActiveRepairService.UNREPAIRED_SSTABLE,
                                                      -1,
-                                                     -1));
+                                                     -1,
+                                                     hostId));
                 if (types.contains(MetadataType.COMPACTION))
                     components.put(MetadataType.COMPACTION,
                                    new CompactionMetadata(null));
diff --git a/src/java/org/apache/cassandra/io/sstable/metadata/MetadataCollector.java b/src/java/org/apache/cassandra/io/sstable/metadata/MetadataCollector.java
index ff4b06ff77..533c5113ea 100644
--- a/src/java/org/apache/cassandra/io/sstable/metadata/MetadataCollector.java
+++ b/src/java/org/apache/cassandra/io/sstable/metadata/MetadataCollector.java
@@ -19,10 +19,10 @@ package org.apache.cassandra.io.sstable.metadata;
 
 import java.nio.ByteBuffer;
 import java.util.ArrayList;
-import java.util.Arrays;
 import java.util.Collections;
 import java.util.List;
 import java.util.Map;
+import java.util.UUID;
 
 import com.google.common.base.Preconditions;
 import com.google.common.collect.Maps;
@@ -31,13 +31,13 @@ import com.clearspring.analytics.stream.cardinality.HyperLogLogPlus;
 import com.clearspring.analytics.stream.cardinality.ICardinality;
 import org.apache.cassandra.db.*;
 import org.apache.cassandra.db.commitlog.IntervalSet;
-import org.apache.cassandra.db.marshal.AbstractType;
+import org.apache.cassandra.db.commitlog.ReplayPosition;
 import org.apache.cassandra.db.partitions.PartitionStatisticsCollector;
 import org.apache.cassandra.db.rows.Cell;
 import org.apache.cassandra.io.sstable.SSTable;
 import org.apache.cassandra.io.sstable.format.SSTableReader;
 import org.apache.cassandra.service.ActiveRepairService;
-import org.apache.cassandra.utils.ByteBufferUtil;
+import org.apache.cassandra.service.StorageService;
 import org.apache.cassandra.utils.EstimatedHistogram;
 import org.apache.cassandra.utils.MurmurHash;
 import org.apache.cassandra.utils.StreamingHistogram;
@@ -83,7 +83,8 @@ public class MetadataCollector implements PartitionStatisticsCollector
                                  true,
                                  ActiveRepairService.UNREPAIRED_SSTABLE,
                                  -1,
-                                 -1);
+                                 -1,
+                                 null);
     }
 
     protected EstimatedHistogram estimatedPartitionSize = defaultPartitionSizeHistogram();
@@ -111,22 +112,32 @@ public class MetadataCollector implements PartitionStatisticsCollector
     protected ICardinality cardinality = new HyperLogLogPlus(13, 25);
     private final ClusteringComparator comparator;
 
+    private final UUID originatingHostId;
+
     public MetadataCollector(ClusteringComparator comparator)
     {
-        this.comparator = comparator;
+        this(comparator, StorageService.instance.getLocalHostUUID());
+    }
 
+    public MetadataCollector(ClusteringComparator comparator, UUID originatingHostId)
+    {
+        this.comparator = comparator;
+        this.originatingHostId = originatingHostId;
     }
 
     public MetadataCollector(Iterable<SSTableReader> sstables, ClusteringComparator comparator, int level)
     {
         this(comparator);
 
-        IntervalSet.Builder intervals = new IntervalSet.Builder();
-        for (SSTableReader sstable : sstables)
+        IntervalSet.Builder<ReplayPosition> intervals = new IntervalSet.Builder<>();
+        if (originatingHostId != null)
         {
-            intervals.addAll(sstable.getSSTableMetadata().commitLogIntervals);
+            for (SSTableReader sstable : sstables)
+            {
+                if (originatingHostId.equals(sstable.getSSTableMetadata().originatingHostId))
+                    intervals.addAll(sstable.getSSTableMetadata().commitLogIntervals);
+            }
         }
-
         commitLogIntervals(intervals.build());
         sstableLevel(level);
     }
@@ -264,7 +275,8 @@ public class MetadataCollector implements PartitionStatisticsCollector
                                                              hasLegacyCounterShards,
                                                              repairedAt,
                                                              totalColumnsSet,
-                                                             totalRows));
+                                                             totalRows,
+                                                             originatingHostId));
         components.put(MetadataType.COMPACTION, new CompactionMetadata(cardinality));
         components.put(MetadataType.HEADER, header.toComponent());
         return components;
diff --git a/src/java/org/apache/cassandra/io/sstable/metadata/StatsMetadata.java b/src/java/org/apache/cassandra/io/sstable/metadata/StatsMetadata.java
index be6b4307af..50df500111 100644
--- a/src/java/org/apache/cassandra/io/sstable/metadata/StatsMetadata.java
+++ b/src/java/org/apache/cassandra/io/sstable/metadata/StatsMetadata.java
@@ -21,6 +21,7 @@ import java.io.IOException;
 import java.nio.ByteBuffer;
 import java.util.ArrayList;
 import java.util.List;
+import java.util.UUID;
 
 import org.apache.cassandra.io.ISerializer;
 import org.apache.cassandra.io.sstable.format.Version;
@@ -34,9 +35,11 @@ import org.apache.cassandra.db.commitlog.IntervalSet;
 import org.apache.cassandra.db.commitlog.ReplayPosition;
 import org.apache.cassandra.io.util.DataInputPlus;
 import org.apache.cassandra.io.util.DataOutputPlus;
+import org.apache.cassandra.net.MessagingService;
 import org.apache.cassandra.utils.ByteBufferUtil;
 import org.apache.cassandra.utils.EstimatedHistogram;
 import org.apache.cassandra.utils.StreamingHistogram;
+import org.apache.cassandra.utils.UUIDSerializer;
 
 /**
  * SSTable metadata that always stay on heap.
@@ -64,6 +67,7 @@ public class StatsMetadata extends MetadataComponent
     public final long repairedAt;
     public final long totalColumnsSet;
     public final long totalRows;
+    public final UUID originatingHostId;
 
     public StatsMetadata(EstimatedHistogram estimatedPartitionSize,
                          EstimatedHistogram estimatedColumnCount,
@@ -82,7 +86,8 @@ public class StatsMetadata extends MetadataComponent
                          boolean hasLegacyCounterShards,
                          long repairedAt,
                          long totalColumnsSet,
-                         long totalRows)
+                         long totalRows,
+                         UUID originatingHostId)
     {
         this.estimatedPartitionSize = estimatedPartitionSize;
         this.estimatedColumnCount = estimatedColumnCount;
@@ -102,6 +107,7 @@ public class StatsMetadata extends MetadataComponent
         this.repairedAt = repairedAt;
         this.totalColumnsSet = totalColumnsSet;
         this.totalRows = totalRows;
+        this.originatingHostId = originatingHostId;
     }
 
     public MetadataType getType()
@@ -152,7 +158,8 @@ public class StatsMetadata extends MetadataComponent
                                  hasLegacyCounterShards,
                                  repairedAt,
                                  totalColumnsSet,
-                                 totalRows);
+                                 totalRows,
+                                 originatingHostId);
     }
 
     public StatsMetadata mutateRepairedAt(long newRepairedAt)
@@ -174,7 +181,8 @@ public class StatsMetadata extends MetadataComponent
                                  hasLegacyCounterShards,
                                  newRepairedAt,
                                  totalColumnsSet,
-                                 totalRows);
+                                 totalRows,
+                                 originatingHostId);
     }
 
     @Override
@@ -203,6 +211,7 @@ public class StatsMetadata extends MetadataComponent
                        .append(hasLegacyCounterShards, that.hasLegacyCounterShards)
                        .append(totalColumnsSet, that.totalColumnsSet)
                        .append(totalRows, that.totalRows)
+                       .append(originatingHostId, that.originatingHostId)
                        .build();
     }
 
@@ -228,6 +237,7 @@ public class StatsMetadata extends MetadataComponent
                        .append(hasLegacyCounterShards)
                        .append(totalColumnsSet)
                        .append(totalRows)
+                       .append(originatingHostId)
                        .build();
     }
 
@@ -262,6 +272,12 @@ public class StatsMetadata extends MetadataComponent
                 size += ReplayPosition.serializer.serializedSize(component.commitLogIntervals.lowerBound().orElse(ReplayPosition.NONE));
             if (version.hasCommitLogIntervals())
                 size += replayPositionSetSerializer.serializedSize(component.commitLogIntervals);
+            if (version.hasOriginatingHostId())
+            {
+                size += 1; // boolean: is originatingHostId present
+                if (component.originatingHostId != null)
+                    size += UUIDSerializer.serializer.serializedSize(component.originatingHostId, version.correspondingMessagingVersion());
+            }
             return size;
         }
 
@@ -302,6 +318,18 @@ public class StatsMetadata extends MetadataComponent
                 ReplayPosition.serializer.serialize(component.commitLogIntervals.lowerBound().orElse(ReplayPosition.NONE), out);
             if (version.hasCommitLogIntervals())
                 replayPositionSetSerializer.serialize(component.commitLogIntervals, out);
+            if (version.hasOriginatingHostId())
+            {
+                if (component.originatingHostId != null)
+                {
+                    out.writeByte(1);
+                    UUIDSerializer.serializer.serialize(component.originatingHostId, out, 0);
+                }
+                else
+                {
+                    out.writeByte(0);
+                }
+            }
         }
 
         public StatsMetadata deserialize(Version version, DataInputPlus in) throws IOException
@@ -379,6 +407,10 @@ public class StatsMetadata extends MetadataComponent
             else
                 commitLogIntervals = new IntervalSet<ReplayPosition>(commitLogLowerBound, commitLogUpperBound);
 
+            UUID originatingHostId = null;
+            if (version.hasOriginatingHostId() && in.readByte() != 0)
+                originatingHostId = UUIDSerializer.serializer.deserialize(in, 0);
+
             return new StatsMetadata(partitionSizes,
                                      columnCounts,
                                      commitLogIntervals,
@@ -396,7 +428,8 @@ public class StatsMetadata extends MetadataComponent
                                      hasLegacyCounterShards,
                                      repairedAt,
                                      totalColumnsSet,
-                                     totalRows);
+                                     totalRows,
+                                     originatingHostId);
         }
     }
 }
diff --git a/src/java/org/apache/cassandra/service/StorageService.java b/src/java/org/apache/cassandra/service/StorageService.java
index 3f54a3a652..334f872f7c 100644
--- a/src/java/org/apache/cassandra/service/StorageService.java
+++ b/src/java/org/apache/cassandra/service/StorageService.java
@@ -841,7 +841,7 @@ public class StorageService extends NotificationBroadcasterSupport implements IE
             // for bootstrap to get the load info it needs.
             // (we won't be part of the storage ring though until we add a counterId to our state, below.)
             // Seed the host ID-to-endpoint map with our own ID.
-            UUID localHostId = SystemKeyspace.getLocalHostId();
+            UUID localHostId = SystemKeyspace.getOrInitializeLocalHostId();
             getTokenMetadata().updateHostId(localHostId, FBUtilities.getBroadcastAddress());
             appStates.put(ApplicationState.NET_VERSION, valueFactory.networkVersion());
             appStates.put(ApplicationState.HOST_ID, valueFactory.hostId(localHostId));
diff --git a/src/java/org/apache/cassandra/utils/CounterId.java b/src/java/org/apache/cassandra/utils/CounterId.java
index 690d4aab4a..b138aac71b 100644
--- a/src/java/org/apache/cassandra/utils/CounterId.java
+++ b/src/java/org/apache/cassandra/utils/CounterId.java
@@ -136,7 +136,7 @@ public class CounterId implements Comparable<CounterId>
 
         LocalCounterIdHolder()
         {
-            current = new AtomicReference<>(wrap(ByteBufferUtil.bytes(SystemKeyspace.getLocalHostId())));
+            current = new AtomicReference<>(wrap(ByteBufferUtil.bytes(SystemKeyspace.getOrInitializeLocalHostId())));
         }
 
         CounterId get()
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-CompressionInfo.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-CompressionInfo.db
new file mode 100644
index 0000000000..48323aad1d
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-CompressionInfo.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-Data.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-Data.db
new file mode 100644
index 0000000000..64d6d821a6
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-Data.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-Digest.crc32 b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-Digest.crc32
new file mode 100644
index 0000000000..c2e6e7c256
--- /dev/null
+++ b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-Digest.crc32
@@ -0,0 +1 @@
+3931972325
\ No newline at end of file
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-Filter.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-Filter.db
new file mode 100644
index 0000000000..2e1d5d29ca
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-Filter.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-Index.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-Index.db
new file mode 100644
index 0000000000..d50fdeb4e2
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-Index.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-Statistics.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-Statistics.db
new file mode 100644
index 0000000000..0ae8679952
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-Statistics.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-Summary.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-Summary.db
new file mode 100644
index 0000000000..9b24e0450c
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-Summary.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-TOC.txt b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-TOC.txt
new file mode 100644
index 0000000000..0b0e005f3d
--- /dev/null
+++ b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust/md-1-big-TOC.txt
@@ -0,0 +1,8 @@
+Summary.db
+Statistics.db
+CompressionInfo.db
+TOC.txt
+Index.db
+Filter.db
+Data.db
+Digest.crc32
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-CompressionInfo.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-CompressionInfo.db
new file mode 100644
index 0000000000..559bd3fc1c
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-CompressionInfo.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-Data.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-Data.db
new file mode 100644
index 0000000000..34f4233f8d
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-Data.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-Digest.crc32 b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-Digest.crc32
new file mode 100644
index 0000000000..7a8fdd4a60
--- /dev/null
+++ b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-Digest.crc32
@@ -0,0 +1 @@
+1855259300
\ No newline at end of file
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-Filter.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-Filter.db
new file mode 100644
index 0000000000..2e1d5d29ca
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-Filter.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-Index.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-Index.db
new file mode 100644
index 0000000000..e04d3dbda9
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-Index.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-Statistics.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-Statistics.db
new file mode 100644
index 0000000000..db71cffaeb
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-Statistics.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-Summary.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-Summary.db
new file mode 100644
index 0000000000..9b24e0450c
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-Summary.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-TOC.txt b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-TOC.txt
new file mode 100644
index 0000000000..0b0e005f3d
--- /dev/null
+++ b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_compact/md-1-big-TOC.txt
@@ -0,0 +1,8 @@
+Summary.db
+Statistics.db
+CompressionInfo.db
+TOC.txt
+Index.db
+Filter.db
+Data.db
+Digest.crc32
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-CompressionInfo.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-CompressionInfo.db
new file mode 100644
index 0000000000..c835380319
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-CompressionInfo.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-Data.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-Data.db
new file mode 100644
index 0000000000..e41815148c
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-Data.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-Digest.crc32 b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-Digest.crc32
new file mode 100644
index 0000000000..013e4a58e2
--- /dev/null
+++ b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-Digest.crc32
@@ -0,0 +1 @@
+2111053471
\ No newline at end of file
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-Filter.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-Filter.db
new file mode 100644
index 0000000000..2e1d5d29ca
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-Filter.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-Index.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-Index.db
new file mode 100644
index 0000000000..c981a22603
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-Index.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-Statistics.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-Statistics.db
new file mode 100644
index 0000000000..2c00cdc60c
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-Statistics.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-Summary.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-Summary.db
new file mode 100644
index 0000000000..9b24e0450c
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-Summary.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-TOC.txt b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-TOC.txt
new file mode 100644
index 0000000000..0b0e005f3d
--- /dev/null
+++ b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter/md-1-big-TOC.txt
@@ -0,0 +1,8 @@
+Summary.db
+Statistics.db
+CompressionInfo.db
+TOC.txt
+Index.db
+Filter.db
+Data.db
+Digest.crc32
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-CompressionInfo.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-CompressionInfo.db
new file mode 100644
index 0000000000..de19644352
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-CompressionInfo.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-Data.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-Data.db
new file mode 100644
index 0000000000..b83c17e2a1
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-Data.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-Digest.crc32 b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-Digest.crc32
new file mode 100644
index 0000000000..8890fcdaeb
--- /dev/null
+++ b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-Digest.crc32
@@ -0,0 +1 @@
+3412778007
\ No newline at end of file
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-Filter.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-Filter.db
new file mode 100644
index 0000000000..2e1d5d29ca
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-Filter.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-Index.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-Index.db
new file mode 100644
index 0000000000..041117e33b
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-Index.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-Statistics.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-Statistics.db
new file mode 100644
index 0000000000..17e6569b40
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-Statistics.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-Summary.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-Summary.db
new file mode 100644
index 0000000000..9b24e0450c
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-Summary.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-TOC.txt b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-TOC.txt
new file mode 100644
index 0000000000..0b0e005f3d
--- /dev/null
+++ b/test/data/legacy-sstables/md/legacy_tables/legacy_md_clust_counter_compact/md-1-big-TOC.txt
@@ -0,0 +1,8 @@
+Summary.db
+Statistics.db
+CompressionInfo.db
+TOC.txt
+Index.db
+Filter.db
+Data.db
+Digest.crc32
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-CompressionInfo.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-CompressionInfo.db
new file mode 100644
index 0000000000..0b7faea4a8
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-CompressionInfo.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-Data.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-Data.db
new file mode 100644
index 0000000000..b15f54051f
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-Data.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-Digest.crc32 b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-Digest.crc32
new file mode 100644
index 0000000000..4ce1b077ba
--- /dev/null
+++ b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-Digest.crc32
@@ -0,0 +1 @@
+1466506395
\ No newline at end of file
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-Filter.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-Filter.db
new file mode 100644
index 0000000000..2e1d5d29ca
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-Filter.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-Index.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-Index.db
new file mode 100644
index 0000000000..b3094bffba
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-Index.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-Statistics.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-Statistics.db
new file mode 100644
index 0000000000..96ca948264
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-Statistics.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-Summary.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-Summary.db
new file mode 100644
index 0000000000..9b24e0450c
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-Summary.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-TOC.txt b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-TOC.txt
new file mode 100644
index 0000000000..0b0e005f3d
--- /dev/null
+++ b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple/md-1-big-TOC.txt
@@ -0,0 +1,8 @@
+Summary.db
+Statistics.db
+CompressionInfo.db
+TOC.txt
+Index.db
+Filter.db
+Data.db
+Digest.crc32
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-CompressionInfo.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-CompressionInfo.db
new file mode 100644
index 0000000000..adb7fc4579
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-CompressionInfo.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-Data.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-Data.db
new file mode 100644
index 0000000000..4b575a1fde
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-Data.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-Digest.crc32 b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-Digest.crc32
new file mode 100644
index 0000000000..7dbd2b233e
--- /dev/null
+++ b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-Digest.crc32
@@ -0,0 +1 @@
+1071552074
\ No newline at end of file
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-Filter.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-Filter.db
new file mode 100644
index 0000000000..2e1d5d29ca
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-Filter.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-Index.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-Index.db
new file mode 100644
index 0000000000..56f29df1cb
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-Index.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-Statistics.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-Statistics.db
new file mode 100644
index 0000000000..a91c3e7690
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-Statistics.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-Summary.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-Summary.db
new file mode 100644
index 0000000000..9b24e0450c
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-Summary.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-TOC.txt b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-TOC.txt
new file mode 100644
index 0000000000..0b0e005f3d
--- /dev/null
+++ b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_compact/md-1-big-TOC.txt
@@ -0,0 +1,8 @@
+Summary.db
+Statistics.db
+CompressionInfo.db
+TOC.txt
+Index.db
+Filter.db
+Data.db
+Digest.crc32
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-CompressionInfo.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-CompressionInfo.db
new file mode 100644
index 0000000000..0d9c077a99
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-CompressionInfo.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-Data.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-Data.db
new file mode 100644
index 0000000000..9911d70b0f
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-Data.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-Digest.crc32 b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-Digest.crc32
new file mode 100644
index 0000000000..b53f686c57
--- /dev/null
+++ b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-Digest.crc32
@@ -0,0 +1 @@
+662242669
\ No newline at end of file
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-Filter.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-Filter.db
new file mode 100644
index 0000000000..2e1d5d29ca
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-Filter.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-Index.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-Index.db
new file mode 100644
index 0000000000..59e65cab85
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-Index.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-Statistics.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-Statistics.db
new file mode 100644
index 0000000000..ea7335daa1
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-Statistics.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-Summary.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-Summary.db
new file mode 100644
index 0000000000..9b24e0450c
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-Summary.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-TOC.txt b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-TOC.txt
new file mode 100644
index 0000000000..0b0e005f3d
--- /dev/null
+++ b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter/md-1-big-TOC.txt
@@ -0,0 +1,8 @@
+Summary.db
+Statistics.db
+CompressionInfo.db
+TOC.txt
+Index.db
+Filter.db
+Data.db
+Digest.crc32
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-CompressionInfo.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-CompressionInfo.db
new file mode 100644
index 0000000000..56c95a8a36
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-CompressionInfo.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-Data.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-Data.db
new file mode 100644
index 0000000000..8e8af2486e
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-Data.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-Digest.crc32 b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-Digest.crc32
new file mode 100644
index 0000000000..b47ee6aa19
--- /dev/null
+++ b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-Digest.crc32
@@ -0,0 +1 @@
+1788587171
\ No newline at end of file
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-Filter.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-Filter.db
new file mode 100644
index 0000000000..2e1d5d29ca
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-Filter.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-Index.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-Index.db
new file mode 100644
index 0000000000..d094f73e21
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-Index.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-Statistics.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-Statistics.db
new file mode 100644
index 0000000000..07fd92273b
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-Statistics.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-Summary.db b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-Summary.db
new file mode 100644
index 0000000000..9b24e0450c
Binary files /dev/null and b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-Summary.db differ
diff --git a/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-TOC.txt b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-TOC.txt
new file mode 100644
index 0000000000..0b0e005f3d
--- /dev/null
+++ b/test/data/legacy-sstables/md/legacy_tables/legacy_md_simple_counter_compact/md-1-big-TOC.txt
@@ -0,0 +1,8 @@
+Summary.db
+Statistics.db
+CompressionInfo.db
+TOC.txt
+Index.db
+Filter.db
+Data.db
+Digest.crc32
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-CompressionInfo.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-CompressionInfo.db
new file mode 100644
index 0000000000..ca0c7ced71
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-CompressionInfo.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-Data.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-Data.db
new file mode 100644
index 0000000000..45a270963d
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-Data.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-Digest.crc32 b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-Digest.crc32
new file mode 100644
index 0000000000..909bcc7ab6
--- /dev/null
+++ b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-Digest.crc32
@@ -0,0 +1 @@
+838423079
\ No newline at end of file
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-Filter.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-Filter.db
new file mode 100644
index 0000000000..2e1d5d29ca
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-Filter.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-Index.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-Index.db
new file mode 100644
index 0000000000..8b23beed90
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-Index.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-Statistics.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-Statistics.db
new file mode 100644
index 0000000000..fc5e02c5c4
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-Statistics.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-Summary.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-Summary.db
new file mode 100644
index 0000000000..9b24e0450c
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-Summary.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-TOC.txt b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-TOC.txt
new file mode 100644
index 0000000000..1f59f45ec2
--- /dev/null
+++ b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust/me-1-big-TOC.txt
@@ -0,0 +1,8 @@
+Data.db
+Statistics.db
+CompressionInfo.db
+Index.db
+Digest.crc32
+Filter.db
+Summary.db
+TOC.txt
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-CompressionInfo.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-CompressionInfo.db
new file mode 100644
index 0000000000..7ade66bdef
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-CompressionInfo.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-Data.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-Data.db
new file mode 100644
index 0000000000..32bfc39722
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-Data.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-Digest.crc32 b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-Digest.crc32
new file mode 100644
index 0000000000..368bee2ce4
--- /dev/null
+++ b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-Digest.crc32
@@ -0,0 +1 @@
+1309320020
\ No newline at end of file
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-Filter.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-Filter.db
new file mode 100644
index 0000000000..2e1d5d29ca
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-Filter.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-Index.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-Index.db
new file mode 100644
index 0000000000..0652ab24be
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-Index.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-Statistics.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-Statistics.db
new file mode 100644
index 0000000000..778011f14d
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-Statistics.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-Summary.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-Summary.db
new file mode 100644
index 0000000000..9b24e0450c
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-Summary.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-TOC.txt b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-TOC.txt
new file mode 100644
index 0000000000..1f59f45ec2
--- /dev/null
+++ b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_compact/me-1-big-TOC.txt
@@ -0,0 +1,8 @@
+Data.db
+Statistics.db
+CompressionInfo.db
+Index.db
+Digest.crc32
+Filter.db
+Summary.db
+TOC.txt
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-CompressionInfo.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-CompressionInfo.db
new file mode 100644
index 0000000000..1af4db702e
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-CompressionInfo.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-Data.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-Data.db
new file mode 100644
index 0000000000..7971ad3665
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-Data.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-Digest.crc32 b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-Digest.crc32
new file mode 100644
index 0000000000..15b0625da6
--- /dev/null
+++ b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-Digest.crc32
@@ -0,0 +1 @@
+703648555
\ No newline at end of file
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-Filter.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-Filter.db
new file mode 100644
index 0000000000..2e1d5d29ca
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-Filter.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-Index.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-Index.db
new file mode 100644
index 0000000000..a8fdb3cb11
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-Index.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-Statistics.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-Statistics.db
new file mode 100644
index 0000000000..79d9233925
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-Statistics.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-Summary.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-Summary.db
new file mode 100644
index 0000000000..9b24e0450c
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-Summary.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-TOC.txt b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-TOC.txt
new file mode 100644
index 0000000000..1f59f45ec2
--- /dev/null
+++ b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter/me-1-big-TOC.txt
@@ -0,0 +1,8 @@
+Data.db
+Statistics.db
+CompressionInfo.db
+Index.db
+Digest.crc32
+Filter.db
+Summary.db
+TOC.txt
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-CompressionInfo.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-CompressionInfo.db
new file mode 100644
index 0000000000..cb850a4f26
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-CompressionInfo.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-Data.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-Data.db
new file mode 100644
index 0000000000..2c78db6233
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-Data.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-Digest.crc32 b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-Digest.crc32
new file mode 100644
index 0000000000..d4fe87ef49
--- /dev/null
+++ b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-Digest.crc32
@@ -0,0 +1 @@
+2583954533
\ No newline at end of file
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-Filter.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-Filter.db
new file mode 100644
index 0000000000..2e1d5d29ca
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-Filter.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-Index.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-Index.db
new file mode 100644
index 0000000000..4abc15484b
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-Index.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-Statistics.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-Statistics.db
new file mode 100644
index 0000000000..952db1ed93
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-Statistics.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-Summary.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-Summary.db
new file mode 100644
index 0000000000..9b24e0450c
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-Summary.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-TOC.txt b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-TOC.txt
new file mode 100644
index 0000000000..1f59f45ec2
--- /dev/null
+++ b/test/data/legacy-sstables/me/legacy_tables/legacy_me_clust_counter_compact/me-1-big-TOC.txt
@@ -0,0 +1,8 @@
+Data.db
+Statistics.db
+CompressionInfo.db
+Index.db
+Digest.crc32
+Filter.db
+Summary.db
+TOC.txt
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-CompressionInfo.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-CompressionInfo.db
new file mode 100644
index 0000000000..0b7faea4a8
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-CompressionInfo.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-Data.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-Data.db
new file mode 100644
index 0000000000..0a215a41d2
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-Data.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-Digest.crc32 b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-Digest.crc32
new file mode 100644
index 0000000000..a5c6dd47f1
--- /dev/null
+++ b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-Digest.crc32
@@ -0,0 +1 @@
+1286741344
\ No newline at end of file
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-Filter.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-Filter.db
new file mode 100644
index 0000000000..2e1d5d29ca
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-Filter.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-Index.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-Index.db
new file mode 100644
index 0000000000..b3094bffba
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-Index.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-Statistics.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-Statistics.db
new file mode 100644
index 0000000000..8363ea37e9
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-Statistics.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-Summary.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-Summary.db
new file mode 100644
index 0000000000..9b24e0450c
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-Summary.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-TOC.txt b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-TOC.txt
new file mode 100644
index 0000000000..1f59f45ec2
--- /dev/null
+++ b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple/me-1-big-TOC.txt
@@ -0,0 +1,8 @@
+Data.db
+Statistics.db
+CompressionInfo.db
+Index.db
+Digest.crc32
+Filter.db
+Summary.db
+TOC.txt
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-CompressionInfo.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-CompressionInfo.db
new file mode 100644
index 0000000000..adb7fc4579
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-CompressionInfo.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-Data.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-Data.db
new file mode 100644
index 0000000000..fb4d64d79a
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-Data.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-Digest.crc32 b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-Digest.crc32
new file mode 100644
index 0000000000..0f802034f3
--- /dev/null
+++ b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-Digest.crc32
@@ -0,0 +1 @@
+2684888693
\ No newline at end of file
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-Filter.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-Filter.db
new file mode 100644
index 0000000000..2e1d5d29ca
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-Filter.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-Index.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-Index.db
new file mode 100644
index 0000000000..56f29df1cb
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-Index.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-Statistics.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-Statistics.db
new file mode 100644
index 0000000000..ea8dab517d
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-Statistics.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-Summary.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-Summary.db
new file mode 100644
index 0000000000..9b24e0450c
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-Summary.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-TOC.txt b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-TOC.txt
new file mode 100644
index 0000000000..1f59f45ec2
--- /dev/null
+++ b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_compact/me-1-big-TOC.txt
@@ -0,0 +1,8 @@
+Data.db
+Statistics.db
+CompressionInfo.db
+Index.db
+Digest.crc32
+Filter.db
+Summary.db
+TOC.txt
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-CompressionInfo.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-CompressionInfo.db
new file mode 100644
index 0000000000..0d9c077a99
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-CompressionInfo.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-Data.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-Data.db
new file mode 100644
index 0000000000..dccb83f1eb
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-Data.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-Digest.crc32 b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-Digest.crc32
new file mode 100644
index 0000000000..f7b61bf995
--- /dev/null
+++ b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-Digest.crc32
@@ -0,0 +1 @@
+3429587850
\ No newline at end of file
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-Filter.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-Filter.db
new file mode 100644
index 0000000000..2e1d5d29ca
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-Filter.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-Index.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-Index.db
new file mode 100644
index 0000000000..59e65cab85
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-Index.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-Statistics.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-Statistics.db
new file mode 100644
index 0000000000..849116bf0b
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-Statistics.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-Summary.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-Summary.db
new file mode 100644
index 0000000000..9b24e0450c
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-Summary.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-TOC.txt b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-TOC.txt
new file mode 100644
index 0000000000..1f59f45ec2
--- /dev/null
+++ b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter/me-1-big-TOC.txt
@@ -0,0 +1,8 @@
+Data.db
+Statistics.db
+CompressionInfo.db
+Index.db
+Digest.crc32
+Filter.db
+Summary.db
+TOC.txt
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-CompressionInfo.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-CompressionInfo.db
new file mode 100644
index 0000000000..56c95a8a36
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-CompressionInfo.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-Data.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-Data.db
new file mode 100644
index 0000000000..6f178741fe
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-Data.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-Digest.crc32 b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-Digest.crc32
new file mode 100644
index 0000000000..c298142400
--- /dev/null
+++ b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-Digest.crc32
@@ -0,0 +1 @@
+2519481430
\ No newline at end of file
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-Filter.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-Filter.db
new file mode 100644
index 0000000000..2e1d5d29ca
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-Filter.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-Index.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-Index.db
new file mode 100644
index 0000000000..d094f73e21
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-Index.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-Statistics.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-Statistics.db
new file mode 100644
index 0000000000..e41408e315
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-Statistics.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-Summary.db b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-Summary.db
new file mode 100644
index 0000000000..9b24e0450c
Binary files /dev/null and b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-Summary.db differ
diff --git a/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-TOC.txt b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-TOC.txt
new file mode 100644
index 0000000000..1f59f45ec2
--- /dev/null
+++ b/test/data/legacy-sstables/me/legacy_tables/legacy_me_simple_counter_compact/me-1-big-TOC.txt
@@ -0,0 +1,8 @@
+Data.db
+Statistics.db
+CompressionInfo.db
+Index.db
+Digest.crc32
+Filter.db
+Summary.db
+TOC.txt
diff --git a/test/unit/org/apache/cassandra/db/RecoveryManagerFlushedTest.java b/test/unit/org/apache/cassandra/db/RecoveryManagerFlushedTest.java
index d06c1126cd..989f1e27cf 100644
--- a/test/unit/org/apache/cassandra/db/RecoveryManagerFlushedTest.java
+++ b/test/unit/org/apache/cassandra/db/RecoveryManagerFlushedTest.java
@@ -22,6 +22,7 @@ import java.io.IOException;
 import java.util.Arrays;
 import java.util.Collection;
 import java.util.Collections;
+import java.util.UUID;
 
 import org.junit.Before;
 import org.junit.BeforeClass;
@@ -44,6 +45,7 @@ import org.apache.cassandra.io.compress.LZ4Compressor;
 import org.apache.cassandra.io.compress.SnappyCompressor;
 import org.apache.cassandra.schema.KeyspaceParams;
 import org.apache.cassandra.schema.SchemaKeyspace;
+import org.apache.cassandra.service.StorageService;
 import org.apache.cassandra.utils.FBUtilities;
 
 @RunWith(Parameterized.class)
@@ -59,6 +61,8 @@ public class RecoveryManagerFlushedTest
     public static void defineSchema() throws ConfigurationException
     {
         SchemaLoader.prepareServer();
+        StorageService.instance.getTokenMetadata().updateHostId(UUID.randomUUID(), FBUtilities.getBroadcastAddress());
+
         SchemaLoader.createKeyspace(KEYSPACE1,
                                     KeyspaceParams.simple(1),
                                     SchemaLoader.standardCFMD(KEYSPACE1, CF_STANDARD1),
diff --git a/test/unit/org/apache/cassandra/db/SystemKeyspaceTest.java b/test/unit/org/apache/cassandra/db/SystemKeyspaceTest.java
index d151f590c2..223fda2ecf 100644
--- a/test/unit/org/apache/cassandra/db/SystemKeyspaceTest.java
+++ b/test/unit/org/apache/cassandra/db/SystemKeyspaceTest.java
@@ -97,8 +97,8 @@ public class SystemKeyspaceTest
     @Test
     public void testLocalHostID()
     {
-        UUID firstId = SystemKeyspace.getLocalHostId();
-        UUID secondId = SystemKeyspace.getLocalHostId();
+        UUID firstId = SystemKeyspace.getOrInitializeLocalHostId();
+        UUID secondId = SystemKeyspace.getOrInitializeLocalHostId();
         assert firstId.equals(secondId) : String.format("%s != %s%n", firstId.toString(), secondId.toString());
     }
 
diff --git a/test/unit/org/apache/cassandra/db/commitlog/CommitLogTest.java b/test/unit/org/apache/cassandra/db/commitlog/CommitLogTest.java
index 479a090237..3a0e892923 100644
--- a/test/unit/org/apache/cassandra/db/commitlog/CommitLogTest.java
+++ b/test/unit/org/apache/cassandra/db/commitlog/CommitLogTest.java
@@ -58,7 +58,9 @@ import org.apache.cassandra.io.compress.SnappyCompressor;
 import org.apache.cassandra.io.sstable.format.SSTableReader;
 import org.apache.cassandra.net.MessagingService;
 import org.apache.cassandra.schema.KeyspaceParams;
+import org.apache.cassandra.service.StorageService;
 import org.apache.cassandra.utils.ByteBufferUtil;
+import org.apache.cassandra.utils.FBUtilities;
 import org.apache.cassandra.utils.JVMStabilityInspector;
 import org.apache.cassandra.utils.KillerForTests;
 import org.apache.cassandra.utils.vint.VIntCoding;
@@ -106,6 +108,7 @@ public class CommitLogTest
         KeyspaceParams.DEFAULT_LOCAL_DURABLE_WRITES = false;
 
         SchemaLoader.prepareServer();
+        StorageService.instance.getTokenMetadata().updateHostId(UUID.randomUUID(), FBUtilities.getBroadcastAddress());
 
         CFMetaData custom = CFMetaData.compile(String.format("CREATE TABLE \"%s\" (" +
                                                              "k int," +
diff --git a/test/unit/org/apache/cassandra/io/sstable/LegacySSTableTest.java b/test/unit/org/apache/cassandra/io/sstable/LegacySSTableTest.java
index 510d12f448..201e4481e4 100644
--- a/test/unit/org/apache/cassandra/io/sstable/LegacySSTableTest.java
+++ b/test/unit/org/apache/cassandra/io/sstable/LegacySSTableTest.java
@@ -89,7 +89,7 @@ public class LegacySSTableTest
      * See {@link #testGenerateSstables()} to generate sstables.
      * Take care on commit as you need to add the sstable files using {@code git add -f}
      */
-    public static final String[] legacyVersions = {"mc", "mb", "ma", "la", "ka", "jb"};
+    public static final String[] legacyVersions = {"me", "md", "mc", "mb", "ma", "la", "ka", "jb"};
 
     // 1200 chars
     static final String longString = "0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789" +
diff --git a/test/unit/org/apache/cassandra/io/sstable/metadata/MetadataSerializerTest.java b/test/unit/org/apache/cassandra/io/sstable/metadata/MetadataSerializerTest.java
index 3c9a13bb09..6cab237aad 100644
--- a/test/unit/org/apache/cassandra/io/sstable/metadata/MetadataSerializerTest.java
+++ b/test/unit/org/apache/cassandra/io/sstable/metadata/MetadataSerializerTest.java
@@ -22,6 +22,7 @@ import java.io.File;
 import java.io.FileNotFoundException;
 import java.io.FileOutputStream;
 import java.io.IOException;
+import java.util.Arrays;
 import java.util.Collections;
 import java.util.EnumSet;
 import java.util.Map;
@@ -43,6 +44,7 @@ import org.apache.cassandra.io.sstable.format.big.BigFormat;
 import org.apache.cassandra.io.util.BufferedDataOutputStreamPlus;
 import org.apache.cassandra.io.util.DataOutputStreamPlus;
 import org.apache.cassandra.io.util.RandomAccessReader;
+import org.apache.cassandra.utils.Throwables;
 
 import static org.junit.Assert.assertEquals;
 import static org.junit.Assert.assertFalse;
@@ -124,28 +126,51 @@ public class MetadataSerializerTest
         return originalMetadata;
     }
 
+    private void testVersions(String... versions) throws Throwable
+    {
+        Throwable t = null;
+        for (int oldIdx = 0; oldIdx < versions.length; oldIdx++)
+        {
+            for (int newIdx = oldIdx; newIdx < versions.length; newIdx++)
+            {
+                try
+                {
+                    testOldReadsNew(versions[oldIdx], versions[newIdx]);
+                }
+                catch (Exception | AssertionError e)
+                {
+                    t = Throwables.merge(t, new AssertionError("Failed to test " + versions[oldIdx] + " -> " + versions[newIdx], e));
+                }
+            }
+        }
+        if (t != null)
+        {
+            throw t;
+        }
+    }
+
     @Test
-    public void testLaReadLb() throws IOException
+    public void testJVersions() throws Throwable
     {
-        testOldReadsNew("la", "lb");
+        testVersions("jb");
     }
 
     @Test
-    public void testMaReadMb() throws IOException
+    public void testKVersions() throws Throwable
     {
-        testOldReadsNew("ma", "mb");
+        testVersions("ka");
     }
 
     @Test
-    public void testMaReadMc() throws IOException
+    public void testLVersions() throws Throwable
     {
-        testOldReadsNew("ma", "mc");
+        testVersions("la", "lb");
     }
 
     @Test
-    public void testMbReadMc() throws IOException
+    public void testMVersions() throws Throwable
     {
-        testOldReadsNew("mb", "mc");
+        testVersions("ma", "mb", "mc", "md", "me");
     }
 
     public void testOldReadsNew(String oldV, String newV) throws IOException
@@ -175,4 +200,11 @@ public class MetadataSerializerTest
             }
         }
     }
+
+    @Test
+    public void originatingHostCompatibility()
+    {
+        Arrays.asList("ma", "mb", "mc", "md").forEach(v -> assertFalse(BigFormat.instance.getVersion(v).hasOriginatingHostId()));
+        Arrays.asList("me").forEach(v -> assertTrue(BigFormat.instance.getVersion(v).hasOriginatingHostId()));
+    }
 }
