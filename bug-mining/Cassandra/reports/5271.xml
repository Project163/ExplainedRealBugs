<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:14:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13917] COMPACT STORAGE queries on dense static tables accept hidden column1 and value columns</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13917</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Test for the issue:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testCompactStorage() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Throwable
    {
        createTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE %s (a &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; PRIMARY KEY, b &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, c &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) WITH COMPACT STORAGE&quot;&lt;/span&gt;);
        assertInvalid(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s (a, b, c, column1) VALUES (?, ?, ?, ?)&quot;&lt;/span&gt;, 1, 1, 1, ByteBufferUtil.bytes(&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;));
        &lt;span class=&quot;code-comment&quot;&gt;// This one fails with Some clustering keys are missing: column1, which is still wrong
&lt;/span&gt;        assertInvalid(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s (a, b, c, value) VALUES (?, ?, ?, ?)&quot;&lt;/span&gt;, 1, 1, 1, ByteBufferUtil.bytes(&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;));       
        assertInvalid(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s (a, b, c, column1, value) VALUES (?, ?, ?, ?, ?)&quot;&lt;/span&gt;, 1, 1, 1, ByteBufferUtil.bytes(&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;), ByteBufferUtil.bytes(&lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;));
        assertEmpty(execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM %s&quot;&lt;/span&gt;));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Gladly, these writes are no-op, even though they succeed.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;value&lt;/tt&gt; and &lt;tt&gt;column1&lt;/tt&gt; should be completely hidden. Fixing this one should be as easy as just adding validations.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13105742">CASSANDRA-13917</key>
            <summary>COMPACT STORAGE queries on dense static tables accept hidden column1 and value columns</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Gerrrr">Alex Sorokoumov</assignee>
                                    <reporter username="ifesdjeen">Alex Petrov</reporter>
                        <labels>
                            <label>lhf</label>
                    </labels>
                <created>Thu, 28 Sep 2017 12:40:53 +0000</created>
                <updated>Fri, 2 Oct 2020 12:42:31 +0000</updated>
                            <resolved>Mon, 6 Apr 2020 09:50:24 +0000</resolved>
                                        <fixVersion>3.0.21</fixVersion>
                    <fixVersion>3.11.7</fixVersion>
                                    <component>Legacy/Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16203776" author="gerrrr" created="Fri, 13 Oct 2017 16:14:18 +0000"  >&lt;p&gt;If the table is created with COMPACT STORAGE and a single primary key, e.g.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh:k&amp;gt; CREATE TABLE t1 (a int PRIMARY KEY, b int, c int) WITH COMPACT STORAGE;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We get the behavior from the tests:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh:k&amp;gt; INSERT INTO t1 (a,b,c,column1) VALUES (1,1,1,&apos;a&apos;);
cqlsh:k&amp;gt; select * from t1;

 a | b | c
---+---+---

(0 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Corresponding CFMMetaData and the column definition kinds during the &lt;tt&gt;INSERT&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cfm:
isCompactTable() =&amp;gt; true
isStaticCompactTable() =&amp;gt; true

Column definitions:
a.kind=PARTITION_KEY
b.kind=STATIC
c.kind=STATIC
column1.kind=CLUSTERING
value.kind=REGULAR
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also, if the table contains a column with a name &lt;tt&gt;column1&lt;/tt&gt;, the hidden column will be called &lt;tt&gt;column2&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh:k&amp;gt; CREATE TABLE t2 (a int PRIMARY KEY, b int, c int, column1 text) WITH COMPACT STORAGE;
cqlsh:k&amp;gt; INSERT INTO t2 (a,b,c,column1, column2, value) VALUES (1,1,1,&apos;a&apos;,&apos;a&apos;,0xbb);
cqlsh:k&amp;gt; select * from t2;

 a | b | c | column1
---+---+---+---------

(0 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If the table is created with COMPACT STORAGE and a compound primary key, it works as expected:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh:k&amp;gt; CREATE TABLE t3 (a int, b int, c int, PRIMARY KEY (a, b)) WITH COMPACT STORAGE;
cqlsh:k&amp;gt; INSERT INTO t3 (a,b,c,column1) VALUES (1,1,1,&apos;a&apos;);
InvalidRequest: Error from server: code=2200 [Invalid query] message=&quot;Undefined column name column1&quot;
cqlsh:k&amp;gt; INSERT INTO t3 (a,b,c,column1,value) VALUES (1,1,1,&apos;a&apos;,0xff);
InvalidRequest: Error from server: code=2200 [Invalid query] message=&quot;Undefined column name column1&quot;
cqlsh:k&amp;gt; INSERT INTO t3 (a,b,c,value) VALUES (1,1,1,0xff);
InvalidRequest: Error from server: code=2200 [Invalid query] message=&quot;Undefined column name value&quot;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Corresponding CFMMetaData during the &lt;tt&gt;INSERT&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cfm.isCompactTable() =&amp;gt; true
cfm.isStaticCompactTable() =&amp;gt; false
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;h4&gt;&lt;a name=&quot;Solution&quot;&gt;&lt;/a&gt;Solution&lt;/h4&gt;

&lt;p&gt;In &lt;tt&gt;UpdateStatement.prepareInternal&lt;/tt&gt; when the CFM is &lt;tt&gt;StaticCompactTable&lt;/tt&gt; check that the columns to be updated are not &lt;tt&gt;CLUSTERING&lt;/tt&gt; or &lt;tt&gt;REGULAR&lt;/tt&gt;. if this is the case - &quot;hide&quot; the columns by returning the error &quot;Undefined column name&quot;.&lt;/p&gt;

&lt;p&gt;Branches:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/Gerrrr/cassandra/tree/13917-3.0.15&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0.15&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/Gerrrr/cassandra/tree/13917-3.11.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11.1&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16273425" author="jjirsa" created="Thu, 30 Nov 2017 21:07:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt; are you able to review this as the reporter?&lt;/p&gt;</comment>
                            <comment id="16683466" author="ifesdjeen" created="Mon, 12 Nov 2018 09:40:36 +0000"  >&lt;p&gt;The patch looks good, modulo indentation in tests. Also, I would list all unmatching columns in the error message instead of just a single in case someone would try to repair query by repairing one column after another.&lt;/p&gt;

&lt;p&gt;Another thing, to my best memory, we have actual definitions listed &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.11/src/java/org/apache/cassandra/config/CFMetaData.java#L138&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, which we probably should use. I realise that this does not change much semantically but still might be less error-prone.&lt;/p&gt;

&lt;p&gt;Lastly, it&apos;d be great to rebase both patches.&lt;/p&gt;</comment>
                            <comment id="16696118" author="gerrrr" created="Thu, 22 Nov 2018 16:55:03 +0000"  >&lt;p&gt;Thanks for feedback! I fixed indentation in tests, changed the check to report all unmatching columns at once and rebased both branches.&lt;/p&gt;

&lt;p&gt;I did not use &lt;tt&gt;superCfKeyColumn&lt;/tt&gt; and &lt;tt&gt;superCfValueColumn&lt;/tt&gt; because they are null in the test case.&lt;/p&gt;

&lt;p&gt;Created new branches:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/Gerrrr/cassandra/tree/13917-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Gerrrr/cassandra/tree/13917-3.0&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/Gerrrr/cassandra/tree/13917-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Gerrrr/cassandra/tree/13917-3.11&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;CI results:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12949215/13917-3.0.png&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;13917-3.0 &lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12949214/13917-3.11.png&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;13917-3.11 &lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16696675" author="ifesdjeen" created="Fri, 23 Nov 2018 11:23:58 +0000"  >&lt;p&gt;After looking a bit more, it might be that the issue is not fully fixed: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
# Still &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;Range deletions are not supported &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; specific columns&apos;&lt;/span&gt;
DELETE value FROM %s WHERE a = 1

# Still &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;Invalid identifier column1 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; deletion (should not be a PRIMARY KEY part)&apos;&lt;/span&gt;
DELETE column1 FROM %s WHERE a = 1

# Still works:
DELETE FROM %s WHERE a = 1 and column1 = &lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;

# Still works:
SELECT value, column1 FROM %s
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You&apos;re right it&apos;s not supercolumn cf, so we have only &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.11/src/java/org/apache/cassandra/config/CFMetaData.java#L124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;compact value&lt;/a&gt; that we can use.&lt;/p&gt;

&lt;p&gt;After thinking a bit more, I&apos;d try and explore more places where &lt;tt&gt;getColumnDefinition&lt;/tt&gt; is used in order to understand better the surface of the problem and maybe even try looking &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.11/test/unit/org/apache/cassandra/cql3/validation/operations/DropCompactStorageThriftTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; to learn more about compact storage. &lt;/p&gt;

&lt;p&gt;If you have any questions about compact storage, I&apos;m happy to help either on IRC or here.&lt;/p&gt;</comment>
                            <comment id="16700243" author="gerrrr" created="Tue, 27 Nov 2018 11:04:07 +0000"  >&lt;p&gt;Thanks for the review and suggestions! I updated the patches.&lt;/p&gt;

&lt;p&gt;CI results:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12949663/13917-3.0-testall-2.png&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;13917-3.0&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12949662/13917-3.11-testall-2.png&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;13917-3.11&lt;/a&gt;&lt;br/&gt;
&#160;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16978286" author="gerrrr" created="Wed, 20 Nov 2019 10:14:38 +0000"  >&lt;p&gt;I rebased the branches and re-ran tests. 13917-3.0 has 1  timed out test - &lt;tt&gt;org.apache.cassandra.db/ScrubTest/testScrubCorruptedCounterRow&lt;/tt&gt; that seems unrelated, 13917-3.11 passed.&lt;/p&gt;

&lt;p&gt;Branches:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...Gerrrr:13917-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13917-3.0&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...Gerrrr:13917-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13917-3.11&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;CI results:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://jira.apache.org/jira/secure/attachment/12986317/13917-3.0-testall-20.11.2019.png&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13917-3.0&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://jira.apache.org/jira/secure/attachment/12986318/13917-3.11-testall-20.11.2019.png&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13917-3.11&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16984366" author="ifesdjeen" created="Thu, 28 Nov 2019 12:03:17 +0000"  >&lt;p&gt;Thank you for the patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Gerrrr&quot; class=&quot;user-hover&quot; rel=&quot;Gerrrr&quot;&gt;Gerrrr&lt;/a&gt;. I think the patch is overall good, but I was a bit skeptical about &lt;tt&gt;hiddenColumns&lt;/tt&gt; set and its creation depending on &lt;tt&gt;isStaticCompactTable&lt;/tt&gt;, which has lead me to consider other cases, such as:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        createTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE %s (a &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, b &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, PRIMARY KEY(a, b)) WITH COMPACT STORAGE&quot;&lt;/span&gt;);
        execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s (a, b, value) VALUES (?, ?, ?)&quot;&lt;/span&gt;, 1, 1, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;); &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; should not work&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I did check some thrift-created tables, but in the most other things work the same way with and without compact storage. You can get some more information and (hopefully) an exhaustive set of compact storage table examples in &lt;tt&gt;DropCompactStorageThriftTest&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;In short, we should make sure that non-static compact tables also work as expected while not breaking dense tables that actually have the value column specified. This means that we should probably take a slightly different approach for validation and check for hidden columns depending on the table configuration.&lt;/p&gt;

&lt;p&gt;Supercolumn families seem to work fine; but I also think we probably can skip adding tests for those.&lt;/p&gt;</comment>
                            <comment id="16995527" author="gerrrr" created="Fri, 13 Dec 2019 10:20:44 +0000"  >&lt;p&gt;Thank you for your review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;As you suggested, I have slightly changed the approach. Now dense and sparse tables are considered separately. In case of dense tables we only need to add a compact value column if it has an empty type &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;. In case of sparse tables we also need to make sure that the table is not super in order not break thrift integration tests.&lt;/p&gt;

&lt;p&gt;Branches:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...Gerrrr:13917-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13917-3.0&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...Gerrrr:13917-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13917-3.11&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;CI results:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://jira.apache.org/jira/secure/attachment/12986317/13917-3.0-testall-13.12.2019.png&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13917-3.0&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://jira.apache.org/jira/secure/attachment/12986318/13917-3.11-testall-13.12.2019.png&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13917-3.11&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;tt&gt;org.apache.cassandra.cql3.validation.operations.TTLTest.testCapWarnExpirationOverflowPolicy&lt;/tt&gt; failure at the patch for 3.11 looked suspicious, but it did not reproduce locally on the same branch, so I believe that it is a CI glitch and not related to the patch.&lt;/p&gt;

&lt;p&gt;1. Besides debugging on my own, I found this article on &lt;a href=&quot;https://docs.datastax.com/en/dse/5.1/cql/cql/cql_using/dropCompactStorage.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Migrating from compact storage&lt;/a&gt; that confirmed my assumptions about cases when &lt;tt&gt;column1&lt;/tt&gt; and &lt;tt&gt;value&lt;/tt&gt; columns are added, and when &lt;tt&gt;value&lt;/tt&gt; type is empty.&lt;/p&gt;


</comment>
                            <comment id="16997113" author="ifesdjeen" created="Mon, 16 Dec 2019 09:28:15 +0000"  >&lt;p&gt;Thank you for the patch. This looks good for the most part. The only thing where I&apos;m still thinking is if it&apos;s worth to move a check on &lt;tt&gt;isHiddenColumn&lt;/tt&gt; to &lt;tt&gt;getColumnDefinition&lt;/tt&gt;? This way we don&apos;t have to special-case modification statement check for hidden columns and all other places where column definition is null. &lt;/p&gt;</comment>
                            <comment id="17009668" author="gerrrr" created="Tue, 7 Jan 2020 12:21:52 +0000"  >&lt;p&gt;Good idea! I moved &lt;tt&gt;isHiddenColumn&lt;/tt&gt; check to &lt;tt&gt;getColumnDefinition&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17010798" author="ifesdjeen" created="Wed, 8 Jan 2020 16:12:44 +0000"  >&lt;p&gt;Thank you for the patch! Committed to 3.0 with &lt;a href=&quot;https://github.com/apache/cassandra/commit/0c54cc98595b4879c9a634737674fd36fd1c46d0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;0c54cc98595b4879c9a634737674fd36fd1c46d0&lt;/a&gt;, and merged up to &lt;a href=&quot;https://github.com/apache/cassandra/commit/9635e55f73598c0f7aece56d5e603198ca464fcc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt; and trunk (with &lt;tt&gt;-s ours&lt;/tt&gt;)&lt;/p&gt;</comment>
                            <comment id="17013087" author="slebresne" created="Fri, 10 Jan 2020 17:37:49 +0000"  >&lt;p&gt;Re-opening because this patch breaks things badly. Did you run the tests after the move of &lt;tt&gt;isHiddenColumn&lt;/tt&gt; to &lt;tt&gt;getColumnDefinition&lt;/tt&gt;? Because if so, our tests aren&apos;t very good.&lt;/p&gt;

&lt;p&gt;The committed version, that move &lt;tt&gt;isHiddenColumn&lt;/tt&gt; to &lt;tt&gt;getColumnDefinition&lt;/tt&gt;, means the compact column is invisible internally, which is wrong, it must be accessible internally.&lt;/p&gt;

&lt;p&gt;Concretely, a simple test that creates a 2ndary index, wait for it to be built, and then restart the node will fail on restart with&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.RuntimeException: Unknown column value during deserialization
	at org.apache.cassandra.db.SerializationHeader$Component.toHeader(SerializationHeader.java:353) ~[main/:na]
	at org.apache.cassandra.io.sstable.format.SSTableReader.open(SSTableReader.java:496) ~[main/:na]
	at org.apache.cassandra.io.sstable.format.SSTableReader.open(SSTableReader.java:365) ~[main/:na]
	at org.apache.cassandra.io.sstable.format.SSTableReader$2.run(SSTableReader.java:544) ~[main/:na]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_152]
	at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_152]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) ~[na:1.8.0_152]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [na:1.8.0_152]
	at org.apache.cassandra.concurrent.NamedThreadFactory.lambda$threadLocalDeallocator$0(NamedThreadFactory.java:83) [main/:na]
	at java.lang.Thread.run(Thread.java:748) ~[na:1.8.0_152]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;because the &lt;tt&gt;SystemKeyspace.BUILT_INDEXES&lt;/tt&gt; table is compact, so when it tries to open the header of the sstables for this table, the &lt;tt&gt;getColumnDefinition&lt;/tt&gt; returns &lt;tt&gt;null&lt;/tt&gt; for the &lt;tt&gt;value&lt;/tt&gt; column, even though it obviously exists and should be returned.&lt;/p&gt;</comment>
                            <comment id="17016761" author="gerrrr" created="Thu, 16 Jan 2020 09:44:07 +0000"  >&lt;p&gt;I did run unit tests after all changes; should have run upgrade tests as well.&lt;/p&gt;

&lt;p&gt;Here are the fixup patches that use the hidden column logic only for statements:&lt;/p&gt;

&lt;p&gt;Branches:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...Gerrrr:13917-fixup-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13917-fixup-3.0&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...Gerrrr:13917-fixup-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13917-fixup-3.11&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;CI results:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12991097/13917-3.0-testall-16.01.2020&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;13917-fixup-3.0-testall&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12991098/13917-3.0-upgrade-16.01.2020&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;13917-fixup-3.0-upgrade&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12991099/13917-3.11-testall-16.01.2020.png&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;13917-fixup-3.11-testall&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12991100/13917-3.11-upgrade-16.01.2020.png&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;13917-fixup-3.11-upgrade&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17017897" author="ifesdjeen" created="Fri, 17 Jan 2020 10:39:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; you are right. In fact, I&apos;ve found several more places where this could cause a problem. What we should&apos;ve done initially is just add a separate method for CQL layer, and let the rest of the calls (e.g., all internal stuff) to use the old one. Committed version of the patch also caused problems in mixed version environments which was caught by one of the upgrade in-jvm dtests. Also, things like thrift and compact storage compatibility layer was impacted in a way, too. &lt;/p&gt;

&lt;p&gt;I&apos;m still thinking if &lt;tt&gt;RowUpdateBuilder&lt;/tt&gt; should be using CQL columns or all columns. I&apos;d argue that CQL only (e.g., no hidden), since this is also how we query them for the most part. We don&apos;t really those hidden column even on internal paths.&lt;/p&gt;

&lt;p&gt;I&apos;ve made a patch and have added a couple more tests that validates the situations that weren&apos;t covered previously. Thanks to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15506&quot; title=&quot;Run in-jvm upgrade dtests in circleci&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15506&quot;&gt;&lt;del&gt;CASSANDRA-15506&lt;/del&gt;&lt;/a&gt;, we can also make sure that upgrade tests are going to be running. &lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:CASSANDRA-13917-followup&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/ifesdjeen/cassandra/tree/CASSANDRA-13917-followup&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CI&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:CASSANDRA-13917-followup-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/ifesdjeen/cassandra/tree/CASSANDRA-13917-followup-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CI&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17021457" author="gerrrr" created="Wed, 22 Jan 2020 20:05:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt; I reviewed your patch. It covers some cases that I missed and has better abstraction via &lt;tt&gt;getColumnDefinitionForCQL&lt;/tt&gt;. +1 to merge your version!&lt;/p&gt;</comment>
                            <comment id="17021531" author="ifesdjeen" created="Wed, 22 Jan 2020 21:36:06 +0000"  >&lt;p&gt;Committed a follow-up patch to 3.0 with &lt;a href=&quot;https://github.com/apache/cassandra/commit/b907dc9689dd04ebae1f765570401d1f20a88ebd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;b907dc9689dd04ebae1f765570401d1f20a88ebd&lt;/a&gt;, and merged up to &lt;a href=&quot;https://github.com/apache/cassandra/commit/7cd0e92dcac8e3423f2eae08069bd5ebf6a3e236&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;, and trunk (with &lt;tt&gt;-s ours&lt;/tt&gt;).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12988774" name="13917-3.0-testall-13.12.2019" size="16613" author="Gerrrr" created="Fri, 13 Dec 2019 10:14:57 +0000"/>
                            <attachment id="12991097" name="13917-3.0-testall-16.01.2020" size="36513" author="Gerrrr" created="Thu, 16 Jan 2020 09:37:20 +0000"/>
                            <attachment id="12949663" name="13917-3.0-testall-2.png" size="38243" author="Gerrrr" created="Tue, 27 Nov 2018 11:03:03 +0000"/>
                            <attachment id="12986317" name="13917-3.0-testall-20.11.2019.png" size="28621" author="Gerrrr" created="Wed, 20 Nov 2019 10:12:18 +0000"/>
                            <attachment id="12991098" name="13917-3.0-upgrade-16.01.2020" size="38877" author="Gerrrr" created="Thu, 16 Jan 2020 09:37:20 +0000"/>
                            <attachment id="12949215" name="13917-3.0.png" size="38121" author="Gerrrr" created="Thu, 22 Nov 2018 16:51:36 +0000"/>
                            <attachment id="12988773" name="13917-3.11-testall-13.12.2019" size="24410" author="Gerrrr" created="Fri, 13 Dec 2019 10:14:57 +0000"/>
                            <attachment id="12991099" name="13917-3.11-testall-16.01.2020.png" size="27853" author="Gerrrr" created="Thu, 16 Jan 2020 09:37:20 +0000"/>
                            <attachment id="12949662" name="13917-3.11-testall-2.png" size="20778" author="Gerrrr" created="Tue, 27 Nov 2018 11:03:02 +0000"/>
                            <attachment id="12986318" name="13917-3.11-testall-20.11.2019.png" size="28380" author="Gerrrr" created="Wed, 20 Nov 2019 10:12:32 +0000"/>
                            <attachment id="12991100" name="13917-3.11-upgrade-16.01.2020.png" size="38048" author="Gerrrr" created="Thu, 16 Jan 2020 09:37:20 +0000"/>
                            <attachment id="12949214" name="13917-3.11.png" size="19889" author="Gerrrr" created="Thu, 22 Nov 2018 16:51:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>12.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[Gerrrr]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12988" cascade-level="1"><![CDATA[API / Semantic Implementation]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12966"><![CDATA[Challenging]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12975"><![CDATA[Code Inspection]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 42 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3knvj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>ifesdjeen</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12344930">3.0.19</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/0c54cc98595b4879c9a634737674fd36fd1c46d0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/0c54cc98595b4879c9a634737674fd36fd1c46d0&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Unit tests&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>