<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:38:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5529] thrift_max_message_length_in_mb makes long-lived connections error out</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5529</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When running mapreduce jobs that read directly from cassandra, the job will sometimes fail with an exception like this:&lt;/p&gt;

&lt;p&gt;java.lang.RuntimeException: com.rockmelt.org.apache.thrift.TException: Message length exceeded: 40&lt;br/&gt;
	at org.apache.cassandra.hadoop.ColumnFamilyRecordReader$StaticRowIterator.maybeInit(ColumnFamilyRecordReader.java:400)&lt;br/&gt;
	at org.apache.cassandra.hadoop.ColumnFamilyRecordReader$StaticRowIterator.computeNext(ColumnFamilyRecordReader.java:406)&lt;br/&gt;
	at org.apache.cassandra.hadoop.ColumnFamilyRecordReader$StaticRowIterator.computeNext(ColumnFamilyRecordReader.java:329)&lt;br/&gt;
	at com.google.common.collect.AbstractIterator.tryToComputeNext(AbstractIterator.java:143)&lt;br/&gt;
	at com.google.common.collect.AbstractIterator.hasNext(AbstractIterator.java:138)&lt;br/&gt;
	at org.apache.cassandra.hadoop.ColumnFamilyRecordReader.getProgress(ColumnFamilyRecordReader.java:109)&lt;br/&gt;
	at org.apache.hadoop.mapred.MapTask$NewTrackingRecordReader.getProgress(MapTask.java:522)&lt;br/&gt;
	at org.apache.hadoop.mapred.MapTask$NewTrackingRecordReader.nextKeyValue(MapTask.java:547)&lt;br/&gt;
	at org.apache.hadoop.mapreduce.MapContext.nextKeyValue(MapContext.java:67)&lt;br/&gt;
	at org.apache.hadoop.mapreduce.Mapper.run(Mapper.java:143)&lt;br/&gt;
	at org.apache.hadoop.mapred.MapTask.runNewMapper(MapTask.java:771)&lt;br/&gt;
	at org.apache.hadoop.mapred.MapTask.run(MapTask.java:375)&lt;br/&gt;
	at org.apache.hadoop.mapred.Child$4.run(Child.java:255)&lt;br/&gt;
	at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
	at javax.security.auth.Subject.doAs(Subject.java:396)&lt;br/&gt;
	at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1132)&lt;br/&gt;
	at org.apache.hadoop.mapred.Child.main(Child.java:249)&lt;br/&gt;
Caused by: com.rockmelt.org.apache.thrift.TException: Message length exceeded: 40&lt;br/&gt;
	at com.rockmelt.org.apache.thrift.protocol.TBinaryProtocol.checkReadLength(TBinaryProtocol.java:393)&lt;br/&gt;
	at com.rockmelt.org.apache.thrift.protocol.TBinaryProtocol.readBinary(TBinaryProtocol.java:363)&lt;br/&gt;
	at org.apache.cassandra.thrift.Column.read(Column.java:528)&lt;br/&gt;
	at org.apache.cassandra.thrift.ColumnOrSuperColumn.read(ColumnOrSuperColumn.java:507)&lt;br/&gt;
	at org.apache.cassandra.thrift.KeySlice.read(KeySlice.java:408)&lt;br/&gt;
	at org.apache.cassandra.thrift.Cassandra$get_range_slices_result.read(Cassandra.java:12422)&lt;br/&gt;
	at com.rockmelt.org.apache.thrift.TServiceClient.receiveBase(TServiceClient.java:78)&lt;br/&gt;
	at org.apache.cassandra.thrift.Cassandra$Client.recv_get_range_slices(Cassandra.java:696)&lt;br/&gt;
	at org.apache.cassandra.thrift.Cassandra$Client.get_range_slices(Cassandra.java:680)&lt;br/&gt;
	at org.apache.cassandra.hadoop.ColumnFamilyRecordReader$StaticRowIterator.maybeInit(ColumnFamilyRecordReader.java:362)&lt;br/&gt;
	... 16 more&lt;/p&gt;


&lt;p&gt;In ColumnFamilyRecordReader#initialize, a TBinaryProtocol is created as follows:&lt;/p&gt;

&lt;p&gt;TTransport transport = ConfigHelper.getInputTransportFactory(conf).openTransport(socket, conf);&lt;br/&gt;
TBinaryProtocol binaryProtocol = new TBinaryProtocol(transport, ConfigHelper.getThriftMaxMessageLength(conf));&lt;br/&gt;
client = new Cassandra.Client(binaryProtocol);&lt;/p&gt;

&lt;p&gt;But each time a call to cassandra is made, checkReadLength(int length) is called in TBinaryProtocol, which includes this:&lt;/p&gt;

&lt;p&gt;readLength_ -= length;&lt;br/&gt;
if (readLength_ &amp;lt; 0) {&lt;br/&gt;
   throw new TException(&quot;Message length exceeded: &quot; + length);&lt;br/&gt;
}&lt;/p&gt;

&lt;p&gt;The result is that readLength_ is decreased each time, until it goes negative and exception is thrown.  This will only happen if you&apos;re reading a lot of data and your split size is large (which is maybe why people haven&apos;t noticed it earlier).  This happens regardless of whether you use wide row support.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure what the right fix is.  It seems like you could either reset the length of TBinaryProtocol after each call or just use a new TBinaryProtocol each time.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12645568">CASSANDRA-5529</key>
            <summary>thrift_max_message_length_in_mb makes long-lived connections error out</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="rtimpe">Rob Timpe</reporter>
                        <labels>
                    </labels>
                <created>Wed, 1 May 2013 00:54:14 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:13 +0000</updated>
                            <resolved>Tue, 21 May 2013 18:55:39 +0000</resolved>
                                        <fixVersion>1.1.12</fixVersion>
                    <fixVersion>1.2.6</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13646374" author="jbellis" created="Wed, 1 May 2013 04:39:36 +0000"  >&lt;p&gt;Rob, your analysis looks spot on.&lt;/p&gt;

&lt;p&gt;WTF.  Creating a new TBinaryProtocol for each message would be pretty ludicrous.&lt;/p&gt;

&lt;p&gt;The genesis of this readLength_ business is hidden in the murky archives of the Thrift incubator svn repro.  It looks to me like it&apos;s kind of a really ugly hack for pre-Framed transports that could call setReadLength in between messages based on some kind of per-application knowledge.  Because I can&apos;t think of any use for &quot;expiring&quot; a connection after X bytes otherwise.&lt;/p&gt;

&lt;p&gt;I don&apos;t think we should be using it at all.  Attached is a patch that rips it out, on the Cassandra server side as well.  I feel sorry for any poor bastard who ever pulled his hair out over Cassandra erroring out his connection apparently randomly...&lt;/p&gt;</comment>
                            <comment id="13646378" author="jbellis" created="Wed, 1 May 2013 04:58:16 +0000"  >&lt;p&gt;Thought I was on the 1.1 branch when I wrote that patch but it was really 1.2.  Here it is against 1.1 as well.&lt;/p&gt;</comment>
                            <comment id="13646379" author="jbellis" created="Wed, 1 May 2013 05:04:30 +0000"  >&lt;p&gt;Note to self: remove our hacked TBinaryProtocol entirely in trunk.&lt;/p&gt;</comment>
                            <comment id="13646434" author="rtimpe" created="Wed, 1 May 2013 07:06:30 +0000"  >&lt;p&gt;Thanks for the patch and the quick turnaround.  Verified on the 1.1 branch that it fixes my problem.&lt;/p&gt;

&lt;p&gt;I&apos;m not really familiar with this api, hence my notes about TBinaryProtocol.  You solution makes way more sense &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13662643" author="jbellis" created="Tue, 21 May 2013 03:50:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt; Can you review above?&lt;/p&gt;</comment>
                            <comment id="13663104" author="tjake" created="Tue, 21 May 2013 16:43:52 +0000"  >&lt;p&gt;Looks fine.  I filed &lt;a href=&quot;https://issues.apache.org/jira/browse/THRIFT-1975&quot; title=&quot;TBinaryProtocol CheckLength can&amp;#39;t be used for a client&quot; class=&quot;issue-link&quot; data-issue-key=&quot;THRIFT-1975&quot;&gt;&lt;del&gt;THRIFT-1975&lt;/del&gt;&lt;/a&gt; to get this issue fixed in general&lt;/p&gt;</comment>
                            <comment id="13663254" author="jbellis" created="Tue, 21 May 2013 18:55:39 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12581335" name="5529-1.1.txt" size="9807" author="jbellis" created="Wed, 1 May 2013 04:58:16 +0000"/>
                            <attachment id="12581334" name="5529.txt" size="9538" author="jbellis" created="Wed, 1 May 2013 04:39:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>325929</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 27 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1k8a7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>326274</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>tjake</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[tjake]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>