<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:25:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2466] bloom filters should avoid huge array allocations to avoid fragmentation concerns</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2466</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The fact that bloom filters are backed by single large arrays of longs is expected to interact badly with promotion of objects into old gen with CMS, due to fragmentation concerns (as discussed in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2463&quot; title=&quot;Flush and Compaction Unnecessarily Allocate 256MB Contiguous Buffers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2463&quot;&gt;&lt;del&gt;CASSANDRA-2463&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;It should be less of an issue than &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2463&quot; title=&quot;Flush and Compaction Unnecessarily Allocate 256MB Contiguous Buffers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2463&quot;&gt;&lt;del&gt;CASSANDRA-2463&lt;/del&gt;&lt;/a&gt; in the sense that you need to have a lot of rows before the array sizes become truly huge. For comparison, the ~ 143 million row key limit implied by the use of &apos;int&apos; in BitSet prior to the switch to OpenBitSet translates roughly to 238 MB (assuming the limitation factor there was the addressability of the bits with a 32 bit int, which is my understanding).&lt;/p&gt;

&lt;p&gt;Having a preliminary look at OpenBitSet with an eye towards replacing the single long[] with multiple arrays, it seems that if we&apos;re willing to drop some of the functionality that is not used for bloom filter purposes, the bits&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt; indexing should be pretty easy to augment with modulo to address an appropriate smaller array. Locality is not an issue since the bloom filter case is the worst possible case for locality anyway, and it doesn&apos;t matter whether it&apos;s one huge array or a number of ~ 64k arrays.&lt;/p&gt;

&lt;p&gt;Callers may be affected like BloomFilterSerializer which cares about the underlying bit array.&lt;/p&gt;

&lt;p&gt;If the full functionality of OpenBitSet is to be maintained (e.g., xorCount) some additional acrobatics would be necessary and presumably at a noticable performance cost if such operations were to be used in performance critical places.&lt;/p&gt;

&lt;p&gt;An argument against touching OpenBitSet is that it seems to be pretty carefully written and tested and has some non-trivial details and people have seemingly benchmarked it quite carefully. On the other hand, the improvement would then apply to other things as well, such as the bitsets used to keep track of in-core pages (off the cuff for scale, a 64 gig sstable should imply a 2 mb bit set, with one bit per 4k page).&lt;/p&gt;

</description>
                <environment></environment>
        <key id="12504130">CASSANDRA-2466</key>
            <summary>bloom filters should avoid huge array allocations to avoid fragmentation concerns</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="m0nstermind">Oleg Anastasyev</assignee>
                                    <reporter username="scode">Peter Schuller</reporter>
                        <labels>
                    </labels>
                <created>Wed, 13 Apr 2011 03:45:34 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:02 +0000</updated>
                            <resolved>Wed, 26 Oct 2011 19:34:20 +0000</resolved>
                                        <fixVersion>1.0.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13019222" author="cscotta" created="Wed, 13 Apr 2011 06:14:39 +0000"  >&lt;p&gt;Peter, it&apos;s interesting that you mention this. During the first run of the memory profiling I ran while investigating &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2463&quot; title=&quot;Flush and Compaction Unnecessarily Allocate 256MB Contiguous Buffers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2463&quot;&gt;&lt;del&gt;CASSANDRA-2463&lt;/del&gt;&lt;/a&gt; on vanilla 0.7.4, I saw a tremendous amount of allocation of long[]/longs (comprising ~70% of heap allocations at that specific moment), but was not sure of the source. I doubt I&apos;ll have time to look into this at the office this week, but if I&apos;m able to outside of work I may check into the allocation a bit.&lt;/p&gt;

&lt;p&gt;If you&apos;re on it, by all means go for it. Thanks for mentioning this!&lt;/p&gt;</comment>
                            <comment id="13019457" author="kingryan" created="Wed, 13 Apr 2011 17:48:33 +0000"  >&lt;p&gt;Moving to smaller arrays would make the allocation easier, but wouldn&apos;t reduce the raw amount of memory needed for a large bloom filter.&lt;/p&gt;

&lt;p&gt;Would it be worth moving these off-heap completely?&lt;/p&gt;</comment>
                            <comment id="13019491" author="scode" created="Wed, 13 Apr 2011 18:55:13 +0000"  >&lt;p&gt;Yes, it&apos;s not decreasing the total amount. The idea is that with small values, at least you&apos;re now left with a tweakable situation where a suitable heap size and a suitable initial occupancy trigger should be sufficient to avoid concurrent mode failures, as long as you&apos;re avoiding the fragmentation induced promotion failures (pragmatically, even if theoretically unclean, one can also help CMS along by inserting some minor application level pauses during allocations of many chunks as part of a larger allocation). But the memory pressure remains.&lt;/p&gt;

&lt;p&gt;Regarding off-heap: I didn&apos;t suggest it because I&apos;d personally like to avoid JNI/JNA if possible for &quot;safety&quot; reasons, and I would also like to avoid adding further dependencies on CMS sweeps for external resources (files, off-heap mem, etc) for the usual reasons. But maybe I&apos;m more paranoid about that than most.&lt;/p&gt;

&lt;p&gt;It would be really nice to just have an explicitly managed pool of fixed-size off-heap buffers of a reasonable size (say, a meg a piece, mmap():ed). I&apos;m thinking maybe the bloom filters can be explicitly managed more easily than the mmaps/brafs for data reading; for example by accepting that for the few requests that race with the removal of an sstable, the bloom filter would just pretend all bits are set.&lt;/p&gt;

&lt;p&gt;Hmmm...&lt;/p&gt;
</comment>
                            <comment id="13022649" author="scode" created="Thu, 21 Apr 2011 07:02:59 +0000"  >&lt;p&gt;If/once the bullet is bitten in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2521&quot; title=&quot;Move away from Phantom References for Compaction/Memtable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2521&quot;&gt;&lt;del&gt;CASSANDRA-2521&lt;/del&gt;&lt;/a&gt; this should be much simpler to accomplish without the GC tradeoffs.&lt;/p&gt;</comment>
                            <comment id="13127065" author="jbellis" created="Thu, 13 Oct 2011 22:41:36 +0000"  >&lt;p&gt;The main problem with moving BF off-heap is that single-item gets from direct buffers are about 1/2 the speed of accessing an on-heap byte[].  That&apos;s a pretty big hit to take.&lt;/p&gt;</comment>
                            <comment id="13127292" author="scode" created="Fri, 14 Oct 2011 06:19:20 +0000"  >&lt;p&gt;Good point. What&apos;s your feeling on the approach of modifying the bitset to use a number of small byte arrays? (Probably at some fixed size to help fragmentation.)&lt;/p&gt;

&lt;p&gt;It does mean an additional level of indirection in an array of arrays, and it&apos;s not clear (to me at least) that it is expected to usually reside in CPU cache.&lt;/p&gt;</comment>
                            <comment id="13127313" author="m0nstermind" created="Fri, 14 Oct 2011 06:52:28 +0000"  >&lt;p&gt;I made it already for our cassandra deployment (because we have huge bloom filters). Attaching it as is (will rebase it to head if you&apos;ll find it useful).&lt;/p&gt;</comment>
                            <comment id="13127481" author="jbellis" created="Fri, 14 Oct 2011 12:47:51 +0000"  >&lt;p&gt;What effect did you observe when deploying this, Oleg?&lt;/p&gt;</comment>
                            <comment id="13127586" author="m0nstermind" created="Fri, 14 Oct 2011 14:44:50 +0000"  >&lt;p&gt;Promotion failures caused by bloom filters gone away completely.&lt;/p&gt;

&lt;p&gt;I did not measured performance overhead specifically on bloom filters, so all I can tell that it was not introduced measureable performance degradation on production cluster operation from client perspective. &lt;/p&gt;

&lt;p&gt;(currently we have ~3300 thrift single column read reqs/sec per node with ~1ms avg call duration measured from client; 98% reads are bounced by bloom filters; size of single bloom filter is up to 250Mb)&lt;/p&gt;</comment>
                            <comment id="13127720" author="jbellis" created="Fri, 14 Oct 2011 17:32:56 +0000"  >&lt;p&gt;Is serialization the same, or at least backwards-compatible w/ existing OBS BFs?&lt;/p&gt;</comment>
                            <comment id="13127728" author="m0nstermind" created="Fri, 14 Oct 2011 17:44:23 +0000"  >&lt;p&gt;You mean on-disk format ? Yes. Specifics are handled by BloomFilterSerializer. Attached serializer as implemented for 0.6.&lt;br/&gt;
(as far as i see no changes are required in BloomFilter itself)&lt;/p&gt;</comment>
                            <comment id="13127735" author="jbellis" created="Fri, 14 Oct 2011 17:58:04 +0000"  >&lt;p&gt;Are there any other moving parts to this? Could we ask you to submit a patch against trunk?&lt;/p&gt;</comment>
                            <comment id="13127749" author="m0nstermind" created="Fri, 14 Oct 2011 18:14:26 +0000"  >&lt;p&gt;Of course. I&apos;ll try to prepare it till monday.&lt;/p&gt;</comment>
                            <comment id="13127871" author="jbellis" created="Fri, 14 Oct 2011 21:27:57 +0000"  >&lt;p&gt;Great!&lt;/p&gt;</comment>
                            <comment id="13128435" author="m0nstermind" created="Sun, 16 Oct 2011 16:03:08 +0000"  >&lt;p&gt;Rebased to trunk. ant test passed.&lt;/p&gt;</comment>
                            <comment id="13128846" author="jbellis" created="Mon, 17 Oct 2011 13:11:45 +0000"  >&lt;p&gt;Some comments:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; pageSize &amp;amp;&amp;amp; bitLength-- &amp;gt; 0; i++)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Isn&apos;t one of those bounds checks redundant?  It looks like wlen/bitLength is the right one to use.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;lots of commented-out methods in OBS. Let&apos;s remove them entirely if we&apos;re not going to implement.&lt;/li&gt;
	&lt;li&gt;OBS.setPage is unnecessary&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13129114" author="m0nstermind" created="Mon, 17 Oct 2011 19:41:20 +0000"  >&lt;p&gt;Attached v2:&lt;br/&gt;
Removed there commented out code as well as OBS.setPage.&lt;/p&gt;

&lt;p&gt;regarding  &quot;i &amp;lt; pageSize &amp;amp;&amp;amp; bitLength-- &amp;gt; 0&quot;:&lt;br/&gt;
both bound checks are neccessary:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&quot;i&amp;lt;pageSize&quot; ensures there are no out of bounds for every single page, while&lt;/li&gt;
	&lt;li&gt;&quot;bitLength-- &amp;gt; 0&quot; ensures there are no more than neccessary bytes are written from the last page (otherwise extra zeroes will appear in file, which will break backwards compatibility).&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13135329" author="jbellis" created="Tue, 25 Oct 2011 18:52:24 +0000"  >&lt;p&gt;Patch looks good to me, just waiting for performance testing now.&lt;/p&gt;</comment>
                            <comment id="13136261" author="jbellis" created="Wed, 26 Oct 2011 19:34:20 +0000"  >&lt;p&gt;Tested (by Brandon) and committed. Thanks, Oleg!&lt;/p&gt;</comment>
                            <comment id="13136279" author="scode" created="Wed, 26 Oct 2011 19:49:28 +0000"  >&lt;p&gt;Awesome!&lt;/p&gt;</comment>
                            <comment id="13136297" author="m0nstermind" created="Wed, 26 Oct 2011 20:06:23 +0000"  >&lt;p&gt;Youre welcome &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12504814">CASSANDRA-2521</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12499202" name="2466v1.patch" size="25733" author="m0nstermind" created="Sun, 16 Oct 2011 16:03:07 +0000"/>
                            <attachment id="12499421" name="2466v2.patch" size="27386" author="m0nstermind" created="Mon, 17 Oct 2011 19:34:39 +0000"/>
                            <attachment id="12499069" name="BloomFilterSerializer.java" size="2371" author="m0nstermind" created="Fri, 14 Oct 2011 17:44:23 +0000"/>
                            <attachment id="12498988" name="OpenBitSet.java" size="27749" author="m0nstermind" created="Fri, 14 Oct 2011 06:52:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[m0nstermind]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20640</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 4 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gbjj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93300</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>