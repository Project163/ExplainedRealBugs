<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:42:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6619] Race condition issue during upgrading 1.1 to 1.2</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6619</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;There is a race condition during upgrading a C* 1.1x cluster to C* 1.2.&lt;br/&gt;
One issue is that OutboundTCPConnection can&apos;t establish from a 1.2 node to some 1.1x nodes.  Because of this, a live cluster during the upgrading will suffer in high read latency and be unable to fulfill some write requests.  It won&apos;t be a problem if there is a small cluster but it is a problem in a large cluster (100+ nodes) because the upgrading process takes 10+ hours to 1+ day(s) to complete.&lt;/p&gt;


&lt;p&gt;Acknowledging about &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5692&quot; title=&quot;Race condition in detecting version on a mixed 1.1/1.2 cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5692&quot;&gt;&lt;del&gt;CASSANDRA-5692&lt;/del&gt;&lt;/a&gt;, however, it does not fully fix the issue.  We already have a patch for this and will attach shortly for feedback.&lt;/p&gt;

</description>
                <environment></environment>
        <key id="12691198">CASSANDRA-6619</key>
            <summary>Race condition issue during upgrading 1.1 to 1.2</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="timiblossom">Minh Do</assignee>
                                    <reporter username="timiblossom">Minh Do</reporter>
                        <labels>
                    </labels>
                <created>Sat, 25 Jan 2014 11:20:01 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:55 +0000</updated>
                            <resolved>Wed, 29 Jan 2014 15:53:25 +0000</resolved>
                                        <fixVersion>1.2.14</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13883419" author="timiblossom" created="Mon, 27 Jan 2014 22:10:05 +0000"  >&lt;p&gt;As posted in other tickets, 1.1 and 1.2 have different message protocols.  Hence, it is important to set the right target version when making outbound connections rather than depending on the inbound connections to set a version value.  Thus, race condition in setting the version values is solved.&lt;/p&gt;

&lt;p&gt;Attachment is the patch to make sure the code does that when an outbound connection is open and an exchange for versioning information in the hankshake fails.&lt;/p&gt;

&lt;p&gt;As discussed with Jason Brown here at Netflix, we came up with a solution that during the upgrade, the upgraded nodes have in the environment the variable cassandra.prev_version = 5 (for 1.1.7 or 4 for 1.1) to help out the handshakes in a mixed version cluster.&lt;/p&gt;

&lt;p&gt;Once a cluster is fully upgraded to 1.2, cassadra.prev_version is removed from all nodes&apos; environment and a C* rolling restart across nodes is required.  This step ensures that the new patch won&apos;t penalize the 1.2 cluster where all outbound connections are from 1.2 to 1.2.&lt;/p&gt;


</comment>
                            <comment id="13884166" author="jbellis" created="Tue, 28 Jan 2014 14:14:08 +0000"  >&lt;p&gt;Before we add a workaround, do we understand why the &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5692&quot; title=&quot;Race condition in detecting version on a mixed 1.1/1.2 cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5692&quot;&gt;&lt;del&gt;CASSANDRA-5692&lt;/del&gt;&lt;/a&gt; approach &quot;reconnect and use the version that the other side sent us in the meantime&quot; doesn&apos;t work?  1.1 and 1.2 are compatible enough to see each others&apos; version, by design.  Specifically, in both versions the first two ints sent are MAGIC (a sanity check) and &quot;header&quot; (compression + version flags).&lt;/p&gt;</comment>
                            <comment id="13884312" author="timiblossom" created="Tue, 28 Jan 2014 16:39:48 +0000"  >&lt;p&gt;Jonathan,  you are right that both 1.2 and 1.1 are designed to read out the versions from the headers of the other.  However, 1.2, as a sender in opening the outbound socket, expects to receive back immediately the version int as soon as it sends out its own.  1.1, as a receiver, can read 1.2 header but does not send the version int back.&lt;/p&gt;

&lt;p&gt;Here is the piece of code in 1.2 in IncomingTcpConnection.java that sends back the version int:&lt;/p&gt;

&lt;p&gt;private void handleModernVersion(int version, int header) throws IOException&lt;br/&gt;
{&lt;br/&gt;
        DataOutputStream out = new DataOutputStream(socket.getOutputStream());&lt;br/&gt;
        out.writeInt(MessagingService.current_version);&lt;br/&gt;
        out.flush();&lt;br/&gt;
        ......&lt;br/&gt;
}&lt;/p&gt;


&lt;p&gt;Because 1.1 does not send this back immediately, 1.2 OutboundTcpConnection will be timed out on the read and the socket gets disconnected.  The whole cycle will get repeated again and again until some code sets the target version right.  In the lucky case, IncomingTcpConnection sets the right target version.  However,&lt;br/&gt;
it takes a while for the other 1.1 nodes to know that there is a new 1.2 node, especially if the new 1.2 node can&apos;t connection to any 1.1 nodes first.&lt;/p&gt;

&lt;p&gt;The version convergence will eventually settle down.  However, in a large cluster, this would take some time causing some side effects during this time such as high read latencies, and more hints being stored.&lt;/p&gt;
</comment>
                            <comment id="13885449" author="jbellis" created="Wed, 29 Jan 2014 15:53:25 +0000"  >&lt;p&gt;Changed the property name to cassandra.default_messaging_version and commited.&lt;/p&gt;</comment>
                            <comment id="13891079" author="rcoli" created="Tue, 4 Feb 2014 19:39:13 +0000"  >&lt;p&gt;As a note to those coming here from the changelog and trying to estimate potential impact on their 1.1 -&amp;gt; 1.2 upgrade, this particular upgrade edge case has so far only been reproduced with the EC2MultiRegionSnitch, and is likely to only affect deploys using a reconnecting snitch like this one.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12625455" name="patch.txt" size="2915" author="timiblossom" created="Mon, 27 Jan 2014 22:18:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[timiblossom]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>369941</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 42 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1rre7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>370243</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>