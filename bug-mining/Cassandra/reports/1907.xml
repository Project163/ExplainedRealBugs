<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:36:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4384] HintedHandoff can begin before SS knows the hostID</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4384</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Since HH fires from the FD, SS won&apos;t quite have the hostId yet:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; INFO 18:58:04,196 Started hinted handoff for host: null with IP: /10.179.65.102
 INFO 18:58:04,197 Node /10.179.65.102 state jump to normal
ERROR 18:58:04,197 Exception in thread Thread[HintedHandoff:1,1,main]
java.lang.NullPointerException
        at org.apache.cassandra.utils.UUIDGen.decompose(UUIDGen.java:120)
        at org.apache.cassandra.db.HintedHandOffManager.deliverHintsToEndpointInternal(HintedHandOffManager.java:304)
        at org.apache.cassandra.db.HintedHandOffManager.deliverHintsToEndpoint(HintedHandOffManager.java:250)
        at org.apache.cassandra.db.HintedHandOffManager.access$400(HintedHandOffManager.java:87)
        at org.apache.cassandra.db.HintedHandOffManager$4.runMayThrow(HintedHandOffManager.java:433)
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:26)
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
        at java.lang.Thread.run(Thread.java:662)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Simple solution seems to be getting the hostId from gossip instead.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12596137">CASSANDRA-4384</key>
            <summary>HintedHandoff can begin before SS knows the hostID</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brandon.williams">Brandon Williams</assignee>
                                    <reporter username="brandon.williams">Brandon Williams</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Jun 2012 19:00:58 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:31 +0000</updated>
                            <resolved>Thu, 15 Nov 2012 17:58:48 +0000</resolved>
                                        <fixVersion>1.2.0 beta 3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13402628" author="urandom" created="Wed, 27 Jun 2012 22:32:31 +0000"  >&lt;p&gt;This is a corner-case that only happens to a node that is restarted (and lost its hostId map as a result).  It is the result of a hint delivery being triggered (by the &lt;em&gt;reception&lt;/em&gt; of a gossip message) before the hostId could be processed from the message.&lt;/p&gt;

&lt;p&gt;I see two ways to fix:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Skip hint delivery when we don&apos;t (yet) have a hostId.&lt;/li&gt;
	&lt;li&gt;Persist hostIds the way we do tokens.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;(1) has the benefit of being a one-liner.  Presumably this code exists to schedule hint delivery for a remote host that was dead and is now alive.  Since in this case it is &lt;em&gt;us&lt;/em&gt; that was down, I don&apos;t think skipping would be Evil.&lt;/p&gt;

&lt;p&gt;(2) adds complexity, but guards against any future cases of an &lt;tt&gt;IEndpointStateChangeSubscriber.onAlive()&lt;/tt&gt; relying on &lt;tt&gt;TokenMetadata.isMember()&lt;/tt&gt; before looking up a hostId.&lt;/p&gt;
</comment>
                            <comment id="13403132" author="soverton" created="Thu, 28 Jun 2012 14:28:17 +0000"  >&lt;p&gt;When a node first starts up without a hostId map, it may be asked to store a hint for a node which is down and it won&apos;t know the hostId of that node since it never saw it alive.&lt;/p&gt;

&lt;p&gt;We should persist the hostIds to prevent both of these cases where we are missing required information when we first start up.&lt;/p&gt;
</comment>
                            <comment id="13403309" author="brandon.williams" created="Thu, 28 Jun 2012 18:03:38 +0000"  >&lt;p&gt;I&apos;m inclined to agree with Sam, since this is how the problem is solved with tokens.&lt;/p&gt;</comment>
                            <comment id="13403315" author="slebresne" created="Thu, 28 Jun 2012 18:09:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4351&quot; title=&quot;Consider storing more informations on peers in system tables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4351&quot;&gt;&lt;del&gt;CASSANDRA-4351&lt;/del&gt;&lt;/a&gt; is relevant (or in other words, I agree too since we wanted to persist them anyway for that issue).&lt;/p&gt;</comment>
                            <comment id="13403966" author="brandon.williams" created="Fri, 29 Jun 2012 15:23:00 +0000"  >&lt;p&gt;I&apos;ll note that while &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4351&quot; title=&quot;Consider storing more informations on peers in system tables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4351&quot;&gt;&lt;del&gt;CASSANDRA-4351&lt;/del&gt;&lt;/a&gt; is similar in spirit, that is information we do NOT want to use, so I would prefer this be in LocationInfo with the tokens, and have everything else in a different CF, so the old method of blowing away LI when something goes bad is still valid.&lt;/p&gt;</comment>
                            <comment id="13403994" author="urandom" created="Fri, 29 Jun 2012 16:13:02 +0000"  >&lt;blockquote&gt;&lt;p&gt;...so I would prefer this be in LocationInfo with the tokens...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Tokens are now in the &lt;tt&gt;peers&lt;/tt&gt; columnfamily, keyed by the token with one column for the peer (inet address).  With vnodes, that will become many-to-one (the endpoints will not be unique).  Host IDs are one-to-one.  The most straightforward approach seemed to be to create another columnfamily (peer_ids?), similar to &lt;tt&gt;peers&lt;/tt&gt;, but keyed by host ID.&lt;/p&gt;</comment>
                            <comment id="13404003" author="jbellis" created="Fri, 29 Jun 2012 16:25:16 +0000"  >&lt;p&gt;or we could replace the existing &lt;tt&gt;peers&lt;/tt&gt; entirely (I&apos;d prefer to retain the table name) and add an index on the token column for that lookup.&lt;/p&gt;</comment>
                            <comment id="13404006" author="slebresne" created="Fri, 29 Jun 2012 16:30:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;or we could replace the existing peers entirely&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I would agree with that, but going a bit further I would imagine that a natural schema for that peers table could be something like:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE TABLE peers (
  host_id UUID PRIMARY KEY,
  peer inet,
  tokens set&amp;lt;blob&amp;gt;,
)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;with maybe even more info for each host but that&apos;s for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4351&quot; title=&quot;Consider storing more informations on peers in system tables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4351&quot;&gt;&lt;del&gt;CASSANDRA-4351&lt;/del&gt;&lt;/a&gt;. Of course that specific schema means waiting for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3647&quot; title=&quot;Support collection (list, set, and map) value types in CQL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3647&quot;&gt;&lt;del&gt;CASSANDRA-3647&lt;/del&gt;&lt;/a&gt;, but I don&apos;t see that as a big problem. This wouldn&apos;t let use query by token but I don&apos;t think that really matter because we&apos;ll read the whole table content at startup anyway.&lt;/p&gt;</comment>
                            <comment id="13411623" author="soverton" created="Wed, 11 Jul 2012 15:19:59 +0000"  >&lt;p&gt;I have a branch at &lt;a href=&quot;https://github.com/acunu/cassandra/tree/CASSANDRA-4384&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/acunu/cassandra/tree/CASSANDRA-4384&lt;/a&gt; which&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;gossips host ID on startup&lt;/li&gt;
	&lt;li&gt;persists host IDs to the peers CF and loads them on startup&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I ended up changing the peers schema to be keyed off IP address instead of UUID:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE TABLE peers (
  peer inet PRIMARY KEY,
  token_bytes blob,
  ring_id uuid,
)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I agree with Sylvain that it seems more natural to use UUID as the key rather than by IP, but that didn&apos;t seem as straightforward to update when tokens or hostIds change.&lt;/p&gt;

&lt;p&gt;There is some overlap with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4122&quot; title=&quot;Bootstrap and decommission with multiple ranges for vnodes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4122&quot;&gt;&lt;del&gt;CASSANDRA-4122&lt;/del&gt;&lt;/a&gt; so it would be best to wait for that to go in before changing the SystemTable again for this.&lt;/p&gt;
</comment>
                            <comment id="13411655" author="brandon.williams" created="Wed, 11 Jul 2012 15:57:21 +0000"  >&lt;p&gt;I like making HOST_ID a full app state, that seems much cleaner.  Unsure on the ip vs uuid change at the moment.&lt;/p&gt;</comment>
                            <comment id="13447930" author="brandon.williams" created="Tue, 4 Sep 2012 18:48:22 +0000"  >&lt;p&gt;HOST_ID is a full app state after &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4383&quot; title=&quot;Binary encoding of vnode tokens&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4383&quot;&gt;&lt;del&gt;CASSANDRA-4383&lt;/del&gt;&lt;/a&gt; now so we can revisit this.&lt;/p&gt;</comment>
                            <comment id="13458594" author="brandon.williams" created="Wed, 19 Sep 2012 11:41:55 +0000"  >&lt;p&gt;Not sure where we stand on the schema changes, but we can trivially prevent this exception by checking the gossiper instead of SS now.&lt;/p&gt;</comment>
                            <comment id="13476952" author="slebresne" created="Tue, 16 Oct 2012 12:15:35 +0000"  >&lt;p&gt;We do persist the ring_id for all nodes now, so maybe we should use that.&lt;/p&gt;</comment>
                            <comment id="13498168" author="jbellis" created="Thu, 15 Nov 2012 17:53:18 +0000"  >&lt;p&gt;+1 on Brandon&apos;s fix for 1.2.0.&lt;/p&gt;</comment>
                            <comment id="13498174" author="brandon.williams" created="Thu, 15 Nov 2012 17:58:48 +0000"  >&lt;p&gt;Committed.  Let&apos;s leave future changes to a new ticket if needed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12545711" name="4384.txt" size="914" author="brandon.williams" created="Wed, 19 Sep 2012 11:41:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>239484</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 1 week, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i00hsf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>814</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>