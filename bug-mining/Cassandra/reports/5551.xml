<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:18:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16071] max_compaction_flush_memory_in_mb is interpreted as bytes</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16071</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12662&quot; title=&quot;OOM when using SASI index&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12662&quot;&gt;CASSANDRA-12662&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=scottcarey&quot; class=&quot;user-hover&quot; rel=&quot;scottcarey&quot;&gt;scottcarey&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12662?focusedCommentId=17070055&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17070055&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;reported&lt;/a&gt; that the &lt;tt&gt;max_compaction_flush_memory_in_mb&lt;/tt&gt; setting gets incorrectly interpreted in bytes rather than megabytes as its name implies.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;1.  the setting &apos;max_compaction_flush_memory_in_mb&apos; is a misnomer, it is actually memory in BYTES.  If you take it at face value, and set it to say, &apos;512&apos; thinking that means 512MB,  you will produce a million temp files rather quickly in a large compaction, which will exhaust even large values of max_map_count rapidly, and get the OOM: Map Error issue above and possibly have a very difficult situation to get a cluster back into a place where nodes aren&apos;t crashing while initilaizing or soon after.  This issue is minor if you know about it in advance and set the value IN BYTES.&lt;/p&gt;&lt;/blockquote&gt;
</description>
                <environment></environment>
        <key id="13324230">CASSANDRA-16071</key>
            <summary>max_compaction_flush_memory_in_mb is interpreted as bytes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mck">Michael Semb Wever</assignee>
                                    <reporter username="mck">Michael Semb Wever</reporter>
                        <labels>
                    </labels>
                <created>Mon, 24 Aug 2020 09:39:32 +0000</created>
                <updated>Sat, 5 Dec 2020 17:52:08 +0000</updated>
                            <resolved>Tue, 25 Aug 2020 18:24:56 +0000</resolved>
                                        <fixVersion>3.11.8</fixVersion>
                    <fixVersion>3.11.10</fixVersion>
                    <fixVersion>4.0-beta2</fixVersion>
                    <fixVersion>4.0-beta4</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Feature/SASI</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17183111" author="michaelsembwever" created="Mon, 24 Aug 2020 09:47:16 +0000"  >&lt;p&gt;Patches&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...thelastpickle:mck/cassandra-3.11_max_compaction_flush_memory_in_mb_fix&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt; with CI &lt;a href=&quot;https://ci-cassandra.apache.org/blue/organizations/jenkins/Cassandra-devbranch/detail/Cassandra-devbranch/264/pipeline&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;run&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...thelastpickle:mck/trunk_max_compaction_flush_memory_in_mb_fix&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt; with CI &lt;a href=&quot;https://ci-cassandra.apache.org/blue/organizations/jenkins/Cassandra-devbranch/detail/Cassandra-devbranch/265/pipeline&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;run&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;(will update with tests &#8230;)&lt;/p&gt;</comment>
                            <comment id="17183177" author="jasonstack" created="Mon, 24 Aug 2020 11:49:16 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; maxMemMb = indexOptions.get(INDEX_MAX_FLUSH_MEMORY_OPTION) == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
  ? (&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;) (1048576 * INDEX_MAX_FLUSH_DEFAULT_MULTIPLIER) &lt;span class=&quot;code-comment&quot;&gt;// 1G &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; memtable
&lt;/span&gt;  : &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.parseLong(indexOptions.get(INDEX_MAX_FLUSH_MEMORY_OPTION));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mck&quot; class=&quot;user-hover&quot; rel=&quot;mck&quot;&gt;mck&lt;/a&gt; I think the default &lt;tt&gt;&quot;1048576 * 0.15 mb&quot; (153GB)&lt;/tt&gt; may still cause OOM.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;How about we rename &lt;tt&gt;&quot;maxMemMb&quot;&lt;/tt&gt; to &lt;tt&gt;&quot;maxMemBytes&quot;&lt;/tt&gt; and rename &lt;br/&gt;
 &lt;tt&gt;&quot;IndexMode#maxCompactionFlushMemoryInMb&quot;&lt;/tt&gt; to &lt;tt&gt;&quot;maxCompactionFlushMemoryInBytes&quot;&lt;/tt&gt;. So it should be :&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; maxMemBytes = indexOptions.get(INDEX_MAX_FLUSH_MEMORY_OPTION) == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
  ? (&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;) (1073741824 * INDEX_MAX_FLUSH_DEFAULT_MULTIPLIER) &lt;span class=&quot;code-comment&quot;&gt;// 1G &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; memtable
&lt;/span&gt;  : 1048576L * &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.parseLong(indexOptions.get(INDEX_MAX_FLUSH_MEMORY_OPTION));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17183253" author="michaelsembwever" created="Mon, 24 Aug 2020 13:02:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;How about we rename &quot;maxMemMb&quot; to &quot;maxMemBytes&quot; and rename&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&quot;IndexMode#maxCompactionFlushMemoryInMb&quot; to &quot;maxCompactionFlushMemoryInBytes&quot;.&lt;/p&gt;

&lt;p&gt;Done. And CI runs added. Working on a (super simple) unit test&#8230;&lt;/p&gt;</comment>
                            <comment id="17184038" author="michaelsembwever" created="Tue, 25 Aug 2020 13:27:17 +0000"  >&lt;p&gt;Unit test added.&lt;/p&gt;</comment>
                            <comment id="17184111" author="jasonstack" created="Tue, 25 Aug 2020 14:59:09 +0000"  >&lt;p&gt;Thanks for the patch. LGTM.&lt;/p&gt;</comment>
                            <comment id="17184661" author="michaelsembwever" created="Tue, 25 Aug 2020 18:24:56 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/116e9c1678a1e96748236962e71319f337e07f8d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;116e9c1678a1e96748236962e71319f337e07f8d&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17197916" author="scottcarey" created="Thu, 17 Sep 2020 19:09:46 +0000"  >&lt;p&gt;Heads-up for anyone currently working around this bug by setting the value in bytes.&lt;/p&gt;

&lt;p&gt;With this bug fix, it appears we will need to change our config file or risk going OOM.&#160; For me, it will go from a setting of 10MB to 10TB when the version is bumped if I don&apos;t change the config when updating.&lt;/p&gt;</comment>
                            <comment id="17232194" author="scott_carey" created="Sun, 15 Nov 2020 03:13:31 +0000"  >&lt;p&gt;Its worse than I remembered.&#160;&#160; Updating to the latest cassandra with this fix in will take down nodes.&#160; The configuration option is on the index itself, and there is no &apos;alter index&apos; option to reset the max_compaction_flush_memory_in_mb value.&#160;&#160;&#160; The whole cluster must be updated to the new version, then compaction has to be either stopped or delicately monitored, then &lt;em&gt;new&lt;/em&gt; indexes need to be built with the updated values for max_compaction_flush_memory_in_mb, and then the old indexes can be removed.&#160;&#160;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The new values will destroy old versions with death-by-a-million-open-files, and the old values will destroy new nodes with OOM during compaction.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I wish I had seen this fix before it was committed.&#160; It should have detected &apos;unusually large&apos; values and interpreted them as bytes.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;For example, &apos;20480000&apos; is 20MB if interpreted as bytes.&#160; If interpreted as MB its way over any reasonable size &#8211; 20TB.&#160;&#160; A safe bet would be to interpret anything over 100000 (100GB in MB, but only 100K if bytes) as bytes, and anything below that as MB.&#160; Then this wouldn&apos;t be a migration nightmare.&lt;/p&gt;</comment>
                            <comment id="17232257" author="michaelsembwever" created="Sun, 15 Nov 2020 12:47:32 +0000"  >&lt;p&gt;I should have put this in NEWS.txt &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;A safe bet would be to interpret anything over 100000 (100GB in MB, but only 100K if bytes) as bytes&#8230;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is smart. Though I&apos;m uneasy with continuing to interpret the value in bytes. &lt;br/&gt;
Here are patches for &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...thelastpickle:mck/cassandra-3.11_16701_2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...thelastpickle:mck/trunk_16071_2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt; that, if the value is over 100GB, log an error and revert value back to default of 1GB. This won&apos;t be ideal in all situations, but I believe it means users will correct the configuration and will be therefore safer in the longer run. wdyt &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=scott_carey&quot; class=&quot;user-hover&quot; rel=&quot;scott_carey&quot;&gt;scott_carey&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt;?&lt;/p&gt;


&lt;p&gt;Rehashing the pain&#8230;&lt;/p&gt;

&lt;p&gt;Clusters that had previously configured &lt;tt&gt;max_compaction_flush_memory_in_mb&lt;/tt&gt; as bytes,  must take one of the upgrade actions,&lt;/p&gt;

&lt;p&gt;Upgrading to 3.11.8 or 3.11.9, with the index unavailable:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;drop index&lt;/li&gt;
	&lt;li&gt;rolling upgrade all nodes (disabling compactions upon restart)&lt;/li&gt;
	&lt;li&gt;recreate index with correct &lt;tt&gt;max_compaction_flush_memory_in_mb&lt;/tt&gt; mb value&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Upgrading to 3.11.8 or 3.11.9, maintaining use of index:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;disable compactions on all nodes&lt;/li&gt;
	&lt;li&gt;rolling upgrade all nodes (disabling compactions upon restart)&lt;/li&gt;
	&lt;li&gt;create new index with correct &lt;tt&gt;max_compaction_flush_memory_in_mb&lt;/tt&gt; mb value&lt;/li&gt;
	&lt;li&gt;drop old index&lt;/li&gt;
	&lt;li&gt;enable compactions on all nodes&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;With the patches proposed, upgrading to 3.11.10+:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;rolling upgrade all nodes&lt;/li&gt;
	&lt;li&gt;drop and recreate index with correct &lt;tt&gt;max_compaction_flush_memory_in_mb&lt;/tt&gt; mb value&lt;/li&gt;
&lt;/ul&gt;


</comment>
                            <comment id="17232306" author="jasonstack" created="Sun, 15 Nov 2020 14:54:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;if the value is over 100GB, log an error and revert value back to default of 1GB. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;lgtm.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;if (maxMemBytes &amp;gt; 100 * 1073741824)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;right hand side will overflow..&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;logger.error(&quot;{} configured as {} is above 100GB, reverting to default 1GB&quot;, INDEX_MAX_FLUSH_MEMORY_OPTION, maxMemBytes);&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;nits: how about using &lt;tt&gt;FBUtilities#prettyPrintMemory&lt;/tt&gt; for &lt;tt&gt;maxMemBytes&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="17232311" author="michaelsembwever" created="Sun, 15 Nov 2020 15:03:10 +0000"  >
&lt;blockquote&gt;&lt;p&gt;right hand side will overflow..&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;fixed, and moved to a constant.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;nits: how about using FBUtilities#prettyPrintMemory for maxMemBytes&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I first did that, but figured the raw value here is more intuitive, as it helps explain the mismatch between bytes and megabytes, and the calculation happening&#8230;&lt;/p&gt;</comment>
                            <comment id="17232672" author="michaelsembwever" created="Mon, 16 Nov 2020 10:32:10 +0000"  >&lt;p&gt;CI runs for &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/206/#showFailuresLink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt; and &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/207/#showFailuresLink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=scottcarey&quot; class=&quot;user-hover&quot; rel=&quot;scottcarey&quot;&gt;scottcarey&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=scott_carey&quot; class=&quot;user-hover&quot; rel=&quot;scott_carey&quot;&gt;scott_carey&lt;/a&gt;, I am still waiting for your input before committing these patches.&lt;/p&gt;</comment>
                            <comment id="17234568" author="michaelsembwever" created="Wed, 18 Nov 2020 12:31:05 +0000"  >&lt;p&gt;Committed upgrade protection as &lt;a href=&quot;https://github.com/apache/cassandra/commit/ad9b7156bd3df143c1d090a3d77f9479d906e0ec&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ad9b7156bd3df143c1d090a3d77f9479d906e0ec&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17235004" author="scott_carey" created="Wed, 18 Nov 2020 21:06:29 +0000"  >&lt;p&gt;I still have to do a rolling re-index which is not very nice.&#160;&#160; If it just interpreted the large values as if it were bytes it would be ok.&#160; Sure, log a loud warning or something.&#160;&#160; I don&apos;t comprehend why interpreting it as bytes for such values is problematic.&#160;&#160; Maybe set a floor of some sort if 100k is too small.&#160; But 1GB is useless for anyone who already set this lower than the default 1GB on purpose.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The default 1GB isn&apos;t safe either, due to the bugs I listed in the other ticket. &#160; Large compactions with multiple output files are 1GB&#160;&lt;em&gt;per file&lt;/em&gt; &lt;em&gt;output&lt;/em&gt; per index in the worst case. &#160; So a compaction that outputs 40 files from LCS id DOA on my environment at 1GB&#160; &#8211; no different than setting it to 1TB.&#160;&#160; Anyone who set the value smaller than the default did so most likely to avoid going OOM.&lt;/p&gt;

&lt;p&gt;I suppose the patch here will help some people, but is not helpful for me.&#160; It does highlight the issue in the logs which is a big improvement.&lt;/p&gt;

&lt;p&gt;To compound issues, the cassandra yum repo does not store older versions, so rolling back to 3.11.7 is non-trivial.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;RE: the upgrade process&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In no way is it acceptable in most environments using SASI to drop the old index and only then build the new one.&#160;&#160; Most likely, there are queries that will not function without the index.&#160;&#160; I have to build a new index with the new settings (but a different name), then drop the old one.&#160;&#160;&lt;/p&gt;

&lt;p&gt;I also have to carefully build them in the correct order since the query planner is dependent on the order of creation of the index.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If this interpreted the value as bytes when it is huge, I wouldn&apos;t have to create a new index.&#160;&#160; If addressing the error log message was as simple as dividing the value by 2^20 and nothing else, it would probably even be reasonable to halt the start-up and correct it.&#160; But as long as it is an index rebuild that can take a LONG time on a large table, I think this fix should be more sensitive to the operational cost incurred &#8211; after all this is a minor patch release and it seems unusual to require data rebuilds in such a patch.&lt;/p&gt;</comment>
                            <comment id="17235006" author="scott_carey" created="Wed, 18 Nov 2020 21:09:34 +0000"  >&lt;p&gt;On the other hand, maybe I&apos;m the only one crazy enough to use this feature on an LCS table with 500GB of data per node.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Yet, it absolutely obliterates the ordinary secondary indexing on a low to moderate cardinality index and opens up use cases that are impossible without it.&#160; I&apos;m looking forward to the new secondary indexing feature that is being designed that likewise uses a local index alongside an SSTable.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Sorry for the delay replying, I&apos;m not getting email notifications at the moment.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks for listening!&#160;&#160; I thought&#160; about submitting a patch but I don&apos;t have a cassandra dev environment set up.&lt;/p&gt;</comment>
                            <comment id="17235421" author="michaelsembwever" created="Thu, 19 Nov 2020 12:42:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=scott_carey&quot; class=&quot;user-hover&quot; rel=&quot;scott_carey&quot;&gt;scott_carey&lt;/a&gt;, apologies for moving ahead with the upgrade protection patch before getting the feedback from you.&lt;/p&gt;

&lt;p&gt;We definitely hear your concerns and pain around how to upgrade in this situation while maintaining the SASI available.&lt;/p&gt;

&lt;p&gt;The approach of reverting to the default was chosen to minimise tech debt in the C* code, as having it continue to parse bytes is something likely to trap other C* developers and might just hurt other users down the road. The impact is also thought to be limited, i.e. not many will be in this situation of accurately incorrectly tuned max_compaction_flush_memory_in_mb in setups where the default value does not work at all and SASI availability is critical.&lt;/p&gt;

&lt;p&gt;That being said, I will write up here soon a manual migration approach you can use to avoid having to recreate the SASI and keeping it available over the upgrade.&lt;/p&gt;</comment>
                            <comment id="17236687" author="michaelsembwever" created="Sat, 21 Nov 2020 15:16:47 +0000"  >&lt;p&gt;Here is a manual migration you can use to avoid having to recreate the SASI, also while keeping it available during the upgrade.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;disable compactions on all nodes&lt;/li&gt;
	&lt;li&gt;rolling upgrade all nodes (disabling again compactions upon restart)&lt;/li&gt;
	&lt;li&gt;verify that the system.log files reported
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; ERROR [main] &#8230; IndexMode.java:196 - max_compaction_flush_memory_in_mb configured as &#8230; is above 100GB, reverting to default 1GB&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;verify the index still has the old setting
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh -e &lt;span class=&quot;code-quote&quot;&gt;&quot;select * from system_schema.indexes where keyspace_name = &lt;span class=&quot;code-quote&quot;&gt;&apos;&amp;lt;keyspace&amp;gt;&apos;&lt;/span&gt; and table_name = &lt;span class=&quot;code-quote&quot;&gt;&apos;&amp;lt;table&amp;gt;&apos;&lt;/span&gt;;&quot;&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;edit the indexes table to the correct max_compaction_flush_memory_in_mb value. It is important to get all the values here correct, including all those in &lt;tt&gt;OPTIONS&lt;/tt&gt;. Failure to do this correctly can corrupt the original table and leave the node unable to start.
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh
&amp;gt; update system_schema.indexes set options = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class_name&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.cassandra.index.sasi.SASIIndex&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;max_compaction_flush_memory_in_mb&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;&amp;lt;correct_value&amp;gt;&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;target&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;&amp;lt;column_name&amp;gt;&apos;&lt;/span&gt;, &#8230;&amp;lt;other options&amp;gt;}  where keyspace_name = &lt;span class=&quot;code-quote&quot;&gt;&apos;&amp;lt;keyspace&amp;gt;&apos;&lt;/span&gt; and table_name = &lt;span class=&quot;code-quote&quot;&gt;&apos;&amp;lt;table&amp;gt;&apos;&lt;/span&gt; and index_name = &lt;span class=&quot;code-quote&quot;&gt;&apos;&amp;lt;index_name&amp;gt;&apos;&lt;/span&gt; ;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;restart the node&lt;/li&gt;
	&lt;li&gt;validate the ERROR message no longer appears during startup&lt;/li&gt;
	&lt;li&gt;enable compactions on all nodes&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17244553" author="scottcarey" created="Sat, 5 Dec 2020 17:50:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mck&quot; class=&quot;user-hover&quot; rel=&quot;mck&quot;&gt;mck&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thank you for the update script that simulates &quot;alter index&quot;.&#160; This is also useful if one wants to modify this value without rebuilding the index for other purposes as well.&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13005773">CASSANDRA-12662</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[mck]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12988" cascade-level="1"><![CDATA[API / Semantic Implementation]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 49 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0i15s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasonstack]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12334622">3.4</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/116e9c1678a1e96748236962e71319f337e07f8d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/116e9c1678a1e96748236962e71319f337e07f8d&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;CI run. Unit test added.&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>