<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:17:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15164] Overflowed Partition Cell Histograms Can Prevent Compactions from Executing</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15164</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Hi, we are running 6 node Cassandra cluster in production with 3 seed node but from last night one of our seed nodes is continuously throwing an error like this;-&lt;/p&gt;

&lt;p&gt;cassandra.protocol.ServerError: &amp;lt;Error from server: code=0000 &lt;span class=&quot;error&quot;&gt;&amp;#91;Server error&amp;#93;&lt;/span&gt; message=&quot;java.lang.IllegalStateException: Unable to compute ceiling for max when histogram overflowed&quot;&amp;gt;&lt;/p&gt;

&lt;p&gt;For a cluster to be up and running I Drained this node.&lt;/p&gt;

&lt;p&gt;Can somebody help me out with this?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Any help or lead would be appreciated&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Note : We are using Cassandra version 3.7&lt;/p&gt;</description>
                <environment></environment>
        <key id="13239882">CASSANDRA-15164</key>
            <summary>Overflowed Partition Cell Histograms Can Prevent Compactions from Executing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="maedhroz">Caleb Rackliffe</assignee>
                                    <reporter username="ajha">Ankur Jha</reporter>
                        <labels>
                            <label>compaction</label>
                            <label>partition</label>
                    </labels>
                <created>Mon, 17 Jun 2019 08:47:45 +0000</created>
                <updated>Wed, 16 Mar 2022 14:17:24 +0000</updated>
                            <resolved>Thu, 24 Sep 2020 18:08:33 +0000</resolved>
                                        <fixVersion>3.0.23</fixVersion>
                    <fixVersion>3.11.9</fixVersion>
                    <fixVersion>4.0-beta3</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>CQL/Interpreter</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="9000">2.5h</timespent>
                                <comments>
                            <comment id="17193934" author="maedhroz" created="Fri, 11 Sep 2020 00:46:55 +0000"  >&lt;p&gt;Let&apos;s revisit the stack trace from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15326&quot; title=&quot;Unable to compute ceiling for max when histogram overflowed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15326&quot;&gt;&lt;del&gt;CASSANDRA-15326&lt;/del&gt;&lt;/a&gt;, which is almost certainly the same here:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Exception in thread Thread[CompactionExecutor:113041,1,main] 
java.lang.IllegalStateException: Unable to compute ceiling for max when histogram overflowed
at org.apache.cassandra.utils.EstimatedHistogram.rawMean(EstimatedHistogram.java:231) ~[apache-cassandra-3.11.4.jar:3.11.4]
at org.apache.cassandra.utils.EstimatedHistogram.mean(EstimatedHistogram.java:220) ~[apache-cassandra-3.11.4.jar:3.11.4]
at org.apache.cassandra.io.sstable.metadata.StatsMetadata.getEstimatedDroppableTombstoneRatio(StatsMetadata.java:115) ~[apache-cassandra-3.11.4.jar:3.11.4]
at org.apache.cassandra.io.sstable.format.SSTableReader.getEstimatedDroppableTombstoneRatio(SSTableReader.java:1926) ~[apache-cassandra-3.11.4.jar:3.11.4]
at org.apache.cassandra.db.compaction.AbstractCompactionStrategy.worthDroppingTombstones(AbstractCompactionStrategy.java:424) ~[apache-cassandra-3.11.4.jar:3.11.4]
at org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy.getNextBackgroundSSTables(SizeTieredCompactionStrategy.java:99) ~[apache-cassandra-3.11.4.jar:3.11.4]
at org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy.getNextBackgroundTask(SizeTieredCompactionStrategy.java:183) ~[apache-cassandra-3.11.4.jar:3.11.4]
at org.apache.cassandra.db.compaction.CompactionStrategyManager.getNextBackgroundTask(CompactionStrategyManager.java:153) ~[apache-cassandra-3.11.4.jar:3.11.4]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;All our compaction strategies, at some point, want to know what the ratio of droppable tombstones to cells is on average for the partitions in an SSTable. However, if we ever have more than about 1.9 billion cells in a partition, the &lt;tt&gt;EstimatedHistogram&lt;/tt&gt; that tracks this will overflow. Then, when compaction attempts to get the mean number of cells per partition &lt;tt&gt;EstimatedHistogram&lt;/tt&gt; throws an &lt;tt&gt;IllegalStateException&lt;/tt&gt; that aborts the attempt at compaction. This can continue indefinitely.&lt;/p&gt;

&lt;p&gt;In C* 4.0, full checksum validation for metadata components exists, but it&apos;s also possible that, in previous versions, the serialization/deserialization cycle for &lt;tt&gt;EstimatedHistogram&lt;/tt&gt; could introduce corruption that breaks the mean calculation.&lt;/p&gt;</comment>
                            <comment id="17194529" author="maedhroz" created="Fri, 11 Sep 2020 21:20:38 +0000"  >&lt;p&gt;I&apos;ve taken a stab at both providing better visibility around overflowed histograms and taking reasonable action to prevent compaction failures when they are present. There are reasonable inline comments and a simple new test.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/750&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra/112/workflows/ab37a692-bb8c-40f7-a4f6-d406ddf9f6d5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8 tests&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra/112/workflows/69c9a0ca-f627-4238-b94b-da182f86641b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11 tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17195561" author="maedhroz" created="Mon, 14 Sep 2020 16:15:11 +0000"  >&lt;p&gt;This also should apply pretty cleanly to 3.0 and 3.11.&lt;/p&gt;</comment>
                            <comment id="17200343" author="maedhroz" created="Tue, 22 Sep 2020 19:54:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=clohfink&quot; class=&quot;user-hover&quot; rel=&quot;clohfink&quot;&gt;clohfink&lt;/a&gt; I&apos;ve reworked the patch a bit to handle both of the stats histograms and take into account the feedback &lt;a href=&quot;https://github.com/apache/cassandra/pull/750#pullrequestreview-493580468&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. Short of dynamically growing the number of buckets, this seems like the most reasonable quick fix to make the things that might depend on an overflowed histogram safe. (The worst case is that our estimates won&apos;t be as helpful as they would if we had more buckets, etc.)&lt;/p&gt;

&lt;p&gt;Tests in progress &lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra?branch=CASSANDRA-15164&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;...&lt;/p&gt;</comment>
                            <comment id="17200364" author="maedhroz" created="Tue, 22 Sep 2020 20:33:22 +0000"  >&lt;p&gt;The tests look pretty clean, outside hitting &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15313&quot; title=&quot;Fix flaky - ChecksummingTransformerTest - org.apache.cassandra.transport.frame.checksum.ChecksummingTransformerTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15313&quot;&gt;&lt;del&gt;CASSANDRA-15313&lt;/del&gt;&lt;/a&gt; again.&lt;/p&gt;</comment>
                            <comment id="17200940" author="blerer" created="Wed, 23 Sep 2020 16:35:05 +0000"  >&lt;p&gt;After thinking about that problem overnight, I realized that a corruption might not necessary be the problem. I had a quick chat with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; who believe that it should be possible to create a partitions with more than 2 billions cells.&lt;/p&gt;

&lt;p&gt;By consequence, I think that we should change the code to ensure that we do not overflow if a partition has more than 2 billion cells. For that we can either increase the default number of buckets (using &lt;tt&gt;118&lt;/tt&gt; instead of &lt;tt&gt;114&lt;/tt&gt; will allow for more than 4 billions cells) or dynamically increasing the number of buckets if needed.&lt;/p&gt;

&lt;p&gt;Otherwise, the approach to clear the overflow seems reasonable to me as it will solve the problem of the already corrupted &lt;tt&gt;Statistics&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;wdyt?&lt;/p&gt;






</comment>
                            <comment id="17200960" author="maedhroz" created="Wed, 23 Sep 2020 16:59:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; As long as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=clohfink&quot; class=&quot;user-hover&quot; rel=&quot;clohfink&quot;&gt;clohfink&lt;/a&gt; doesn&apos;t have any objections, I think raising the number of buckets to 118 should be a pretty innocuous change, and we already encode the length, so it won&apos;t break anything (...and I&apos;ll keep the rest of the latest version of the patch in place to catch existing corruption).&lt;/p&gt;</comment>
                            <comment id="17200986" author="jmeredithco" created="Wed, 23 Sep 2020 17:09:13 +0000"  >&lt;p&gt;I&apos;d support increasing the number of buckets and keeping the changes to continue to operate if there is an overflow.  Looks like the histogram #buckets is written by the serializer so no compatibility concerns with the file formats.&lt;/p&gt;</comment>
                            <comment id="17200995" author="maedhroz" created="Wed, 23 Sep 2020 17:34:43 +0000"  >&lt;p&gt;Updated version of the patch: &lt;a href=&quot;https://github.com/apache/cassandra/pull/750&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra/120/workflows/da3718e8-6cb0-4727-b89d-2c17e14e347f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8 tests&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra/120/workflows/03a81457-1d8a-47a2-a169-779a346053dc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11 tests&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;UPDATE: The only test failures I see are &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15958&quot; title=&quot;org.apache.cassandra.net.ConnectionTest testMessagePurging&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15958&quot;&gt;&lt;del&gt;CASSANDRA-15958&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15892&quot; title=&quot;JAVA 8/11: test_resumable_rebuild - rebuild_test.TestRebuild&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15892&quot;&gt;&lt;del&gt;CASSANDRA-15892&lt;/del&gt;&lt;/a&gt;, and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15997&quot; title=&quot;TestBootstrap::test_cleanup failing on unexpected number of SSTables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15997&quot;&gt;&lt;del&gt;CASSANDRA-15997&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17201112" author="clohfink" created="Wed, 23 Sep 2020 21:39:34 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                            <comment id="17201359" author="blerer" created="Thu, 24 Sep 2020 08:19:24 +0000"  >&lt;p&gt;We should also commit that patch into 3.0 and 3.11.&lt;/p&gt;</comment>
                            <comment id="17201702" author="clohfink" created="Thu, 24 Sep 2020 17:58:56 +0000"  >&lt;p&gt;Its been merged back into 3.0 and 3.11 now&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13256242">CASSANDRA-15325</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[maedhroz]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12986" cascade-level="1"><![CDATA[Recoverable Corruption / Loss]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12966"><![CDATA[Challenging]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 7 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z03t5s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
        <customfieldvalue><![CDATA[clohfink]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333891">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/4782fd399d97be551032576c4d77f079e862fdba&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/4782fd399d97be551032576c4d77f079e862fdba&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;new tests to verify EstimatedHistogram overflow clearing and overflowed histograms instats deserialization&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>