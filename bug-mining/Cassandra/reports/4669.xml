<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:06:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13130] Strange result of several list updates in a single request</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13130</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Let&apos;s assume that we have a row with the &apos;listColumn&apos; column and value {1,2,3,4}.&lt;br/&gt;
For me it looks logical to expect that the following two pieces of code will ends up with the same result but it isn&apos;t so.&lt;br/&gt;
Code1:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;UPDATE t SET listColumn[2] = 7, listColumn[2] = 8  WHERE id = 1;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Expected result: listColumn={1,2,8,4} &lt;br/&gt;
Actual result: listColumn={1,2,7,8,4}&lt;/p&gt;

&lt;p&gt;Code2:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;UPDATE t SET listColumn[2] = 7  WHERE id = 1;
UPDATE t SET listColumn[2] = 8  WHERE id = 1;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Expected result: listColumn={1,2,8,4} &lt;br/&gt;
Actual result: listColumn={1,2,8,4}&lt;/p&gt;

&lt;p&gt;So the question is why Code1 and Code2 give different results?&lt;br/&gt;
Looks like Code1 should give the same result as Code2.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13035608">CASSANDRA-13130</key>
            <summary>Strange result of several list updates in a single request</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blerer">Benjamin Lerer</assignee>
                                    <reporter username="mkrupits_jb">Mikhail Krupitskiy</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 Jan 2017 17:41:00 +0000</created>
                <updated>Fri, 15 May 2020 08:02:24 +0000</updated>
                            <resolved>Fri, 10 Mar 2017 20:45:07 +0000</resolved>
                                        <fixVersion>2.2.10</fixVersion>
                    <fixVersion>3.0.13</fixVersion>
                    <fixVersion>3.11.0</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15870279" author="blerer" created="Thu, 16 Feb 2017 16:59:27 +0000"  >&lt;p&gt;There is clearly a bug. The &lt;tt&gt;7&lt;/tt&gt; should not appear.&lt;br/&gt;
At the same time you should be carefull with those type of queries. When you issue a single query with two updates, the two updates are  actually having the same timestamp which means that the update with the higher value will win. As if you had send 2 &lt;tt&gt;UPDATE&lt;/tt&gt; queries with exactly the same timestamp.&lt;/p&gt;

&lt;p&gt;So, &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;UPDATE t SET listColumn[2] = 8, listColumn[2] = 7  WHERE id = 1;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; should also return &lt;tt&gt;listColumn=(1,2,8,4)&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15870591" author="mkrupits_jb" created="Thu, 16 Feb 2017 19:45:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;When you issue a single query with two updates, the two updates are actually having the same timestamp which means that the update with the higher value will win.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Could you please clarify what does &quot;the higher value will win&quot; mean?&lt;br/&gt;
Does it mean that it&apos;s not defined which of two updates will be actually applied?&lt;/p&gt;</comment>
                            <comment id="15871754" author="blerer" created="Fri, 17 Feb 2017 12:08:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;Could you please clarify what does &quot;the higher value will win&quot; mean?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sorry, I meant the &lt;tt&gt;greater&lt;/tt&gt; value win.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Does it mean that it&apos;s not defined which of two updates will be actually applied?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It is clearly defined which value will win. It might not just be the one that you expect.&lt;/p&gt;

&lt;p&gt;If you look at the following query: &lt;tt&gt;UPDATE t SET listColumn[2] = 8, listColumn[2] = 7  WHERE id = 1;&lt;/tt&gt;&lt;br/&gt;
You might expect that the second value will win because it comes last.&lt;/p&gt;

&lt;p&gt;In reality C* will consider that it has received 2 updates with exactly the same &lt;tt&gt;timestamp&lt;/tt&gt;: &lt;tt&gt;UPDATE t SET listColumn[2] = 8  WHERE id = 1;&lt;/tt&gt; and &lt;tt&gt;UPDATE t SET listColumn[2] = 7  WHERE id = 1;&lt;/tt&gt; and will reconcile the data.&lt;/p&gt;

&lt;p&gt;The data will be reconciled as follow:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;if one of the modifications is a deletion (tomstone), it wins and the data is marked as deleted&lt;/li&gt;
	&lt;li&gt;if none of the modifications is a deletion, the update with the greater value win. If &lt;tt&gt;A &amp;gt; B&lt;/tt&gt; then A win. If &lt;tt&gt;B &amp;gt; A&lt;/tt&gt; then B win.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;You will face the same issue with batches:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;BEGIN BATCH
UPDATE t SET listColumn[2] = 8  WHERE id = 1;
UPDATE t SET listColumn[2] = 7  WHERE id = 1;
APPLY BATCH;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;will also result in &lt;tt&gt;listColumn={1,2,8,4&lt;/tt&gt;}.&lt;/p&gt;

&lt;p&gt;I you want the second update to always be the winner then you should send to separate updates.&lt;/p&gt;</comment>
                            <comment id="15871978" author="mkrupits_jb" created="Fri, 17 Feb 2017 15:27:53 +0000"  >&lt;p&gt;Thank you for the clarification!&lt;br/&gt;
Such behaviour looks like not intuitive - will be very useful to have the description somewhere in Cassandra&apos;s docs. &lt;/p&gt;

&lt;p&gt;1) Are there any plans to make the behaviour more intuitive like &quot;the second value will win because it comes last&quot;?&lt;br/&gt;
2) How the following query will work (does an order matter?)?&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;UPDATE t SET listColumn[2] = 8, listColumn = 7 + listColumn WHERE id = 1;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;3) Is there a general recommendation not to combine several updates to one column in the single query?&lt;/p&gt;</comment>
                            <comment id="15874258" author="blerer" created="Mon, 20 Feb 2017 09:38:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;1) Are there any plans to make the behaviour more intuitive like &quot;the second value will win because it comes last&quot;?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not for the moment. Feel free to open an improvement ticket if you want to (but make sure that you have looked at my answer to question 3))&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;How the following query will work (does an order matter?)?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I had to fix the behavior for this type of queries as part of this ticket patch.&lt;br/&gt;
As long as the 2 operations do not affect the same column, the results should be the same as if they were done in 2 separate statements.&lt;br/&gt;
If they affect the same column then the data will be reconciled using the rules that I previously mentioned .&lt;/p&gt;

&lt;p&gt;For examples you can look &lt;a href=&quot;https://github.com/blerer/cassandra/blob/13130-3.0/test/unit/org/apache/cassandra/cql3/validation/entities/CollectionsTest.java#L911&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;3) Is there a general recommendation not to combine several updates to one column in the single query?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Our recommendation is: &lt;b&gt;Do not do it&lt;/b&gt;.&lt;br/&gt;
The output is difficult to predict and it is inefficient from the performance point of view.&lt;br/&gt;
Even if the output was predictable, the update would require unecessary transfert of data between the client and the server and unecessary computing. Due to that our advise would still be: &lt;b&gt;Do not do it&lt;/b&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  &lt;/p&gt;


</comment>
                            <comment id="15874277" author="blerer" created="Mon, 20 Feb 2017 09:50:18 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:13130-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-13130-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-13130-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:13130-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-13130-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-13130-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:13130-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-13130-3.11-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-13130-3.11-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-13130-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-13130-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;The patches fix 2 problems:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;For lists, the previous operations were not taken into account as the code was only looking at the prefetched list.&lt;/li&gt;
	&lt;li&gt;In 3.0 and after, the reconciliation of the Cells was not performed correctly for complex columns&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="15903247" author="slebresne" created="Thu, 9 Mar 2017 15:51:52 +0000"  >&lt;p&gt;Sorry, it appears I missed that one and so it may require rebase, but +1 on the patches otherwise.&lt;/p&gt;</comment>
                            <comment id="15905675" author="blerer" created="Fri, 10 Mar 2017 20:45:07 +0000"  >&lt;p&gt;Committed into 2.2 at 5ef8a8b408d4c492f7f2ffbbbe6fce237140c7cb and merged into 3.0, 3.11 and trunk&lt;/p&gt;</comment>
                            <comment id="15907903" author="mkrupits_jb" created="Mon, 13 Mar 2017 17:27:09 +0000"  >&lt;p&gt;Benjamin, thank you for the clarifications.&lt;br/&gt;
Will try to follow your recommendations.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 36 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i38tuv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12334947">3.5</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>