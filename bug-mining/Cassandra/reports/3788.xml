<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:57:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10206] Incorrect handling of end-of stream leading to infinite loop in streaming session</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10206</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;StreamMessage.deserialize (StreamMessage.java:63) function return null when receive end of stream for ReadableByteChannel.read () function. IncomingMessageHandler.run (ConnectionHandler.java:257) interpreting null - as unsupported message and ignore it. It resulting infinite loop when IncomingMessageHandler try to read message from closed steram, and deserialize always return null - to indicate close stream.&lt;/p&gt;

&lt;p&gt;It not happen on normal socket, because when normal socket closed it throw IOException. But happen from time to time when iner-node ssl encryption enabled.&lt;/p&gt;

&lt;p&gt;I&apos;m attach two tread dump from one node with two infinity lopped thread with id 614 and 583&lt;/p&gt;</description>
                <environment>&lt;p&gt;cassndra 2.1.8 12 nodes cluster in two DC, with enabled ssl encryption.&lt;/p&gt;</environment>
        <key id="12859574">CASSANDRA-10206</key>
            <summary>Incorrect handling of end-of stream leading to infinite loop in streaming session</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="-1">Unassigned</assignee>
                                    <reporter username="a.burylov">Alexey Burylov</reporter>
                        <labels>
                    </labels>
                <created>Thu, 27 Aug 2015 11:17:51 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:58 +0000</updated>
                            <resolved>Tue, 1 Sep 2015 22:02:03 +0000</resolved>
                                        <fixVersion>2.1.10</fixVersion>
                    <fixVersion>2.2.2</fixVersion>
                    <fixVersion>3.0 beta 2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14716680" author="yukim" created="Thu, 27 Aug 2015 13:45:24 +0000"  >&lt;p&gt;Thanks for the patch.&lt;br/&gt;
Throwing exception there will cause streaming session to fail when end of stream reached no matter what.&lt;/p&gt;

&lt;p&gt;Are you observing streaming hang when this happens?&lt;br/&gt;
What does other end of stream (thread dump) looks like?&lt;/p&gt;</comment>
                            <comment id="14716810" author="a.burylov" created="Thu, 27 Aug 2015 15:03:39 +0000"  >&lt;p&gt;I&apos;m upload more dump, from different server.&lt;/p&gt;

&lt;p&gt;Also i&apos;m write litle JMX unity what monitor thread and capture stack-traces, when found new one. May be, it output more useful? &lt;/p&gt;

&lt;p&gt;Output for thread 17633 from threaddump-1440686737505.tdump&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;	at java.nio.channels.Channels$ReadableByteChannelImpl.read(Channels.java:385)
	at org.apache.cassandra.streaming.messages.StreamMessage.deserialize(StreamMessage.java:51)
	at org.apache.cassandra.streaming.ConnectionHandler$IncomingMessageHandler.run(ConnectionHandler.java:250)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

	at java.nio.channels.Channels$ReadableByteChannelImpl.read(Channels.java:384)
	at org.apache.cassandra.streaming.messages.StreamMessage.deserialize(StreamMessage.java:51)
	at org.apache.cassandra.streaming.ConnectionHandler$IncomingMessageHandler.run(ConnectionHandler.java:250)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

	at java.lang.&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;$2.blockedOn(&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.java:1195)
	at java.nio.channels.spi.AbstractInterruptibleChannel.blockedOn(AbstractInterruptibleChannel.java:211)
	at java.nio.channels.spi.AbstractInterruptibleChannel.end(AbstractInterruptibleChannel.java:198)
	at java.nio.channels.Channels$ReadableByteChannelImpl.read(Channels.java:387)
	at org.apache.cassandra.streaming.messages.StreamMessage.deserialize(StreamMessage.java:51)
	at org.apache.cassandra.streaming.ConnectionHandler$IncomingMessageHandler.run(ConnectionHandler.java:250)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

	at java.nio.ByteBuffer.allocate(ByteBuffer.java:331)
	at org.apache.cassandra.streaming.messages.StreamMessage.deserialize(StreamMessage.java:50)
	at org.apache.cassandra.streaming.ConnectionHandler$IncomingMessageHandler.run(ConnectionHandler.java:250)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

	at org.apache.cassandra.streaming.messages.StreamMessage.deserialize(StreamMessage.java:51)
	at org.apache.cassandra.streaming.ConnectionHandler$IncomingMessageHandler.run(ConnectionHandler.java:250)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

	at java.nio.HeapByteBuffer.&amp;lt;init&amp;gt;(HeapByteBuffer.java:57)
	at java.nio.ByteBuffer.allocate(ByteBuffer.java:331)
	at org.apache.cassandra.streaming.messages.StreamMessage.deserialize(StreamMessage.java:50)
	at org.apache.cassandra.streaming.ConnectionHandler$IncomingMessageHandler.run(ConnectionHandler.java:250)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

	at org.apache.cassandra.streaming.ConnectionHandler$IncomingMessageHandler.run(ConnectionHandler.java:258)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)

	at java.nio.channels.Channels$ReadableByteChannelImpl.read(Channels.java:375)
	at org.apache.cassandra.streaming.messages.StreamMessage.deserialize(StreamMessage.java:51)
	at org.apache.cassandra.streaming.ConnectionHandler$IncomingMessageHandler.run(ConnectionHandler.java:250)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Unity code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;		&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (JMXConnector connector = JMXConnectorFactory.connect(
				&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; JMXServiceURL(url),
				ENVIRONMENT)) {
			MBeanServerConnection mbsc = connector.getMBeanServerConnection();
			ObjectName threading = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ObjectName(&lt;span class=&quot;code-quote&quot;&gt;&quot;java.lang:type=Threading&quot;&lt;/span&gt;);
			ThreadMXBean treading = ManagementFactory.newPlatformMXBeanProxy(mbsc, &lt;span class=&quot;code-quote&quot;&gt;&quot;java.lang:type=Threading&quot;&lt;/span&gt;, ThreadMXBean.class);


			Set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; set = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashSet&amp;lt;&amp;gt;();
			&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 1000000; i++) {
				ThreadInfo info = treading.getThreadInfo(17633, &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE);
				StackTraceElement[] stackTrace = info.getStackTrace();
				&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; st = stackTrace[0].toString();
				&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!set.contains(st)) {
					set.add(st);
					&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println();
					&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (StackTraceElement stackTraceElement : stackTrace) {
						&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;\tat &quot;&lt;/span&gt; + stackTraceElement);
					}
				}
			}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14716812" author="a.burylov" created="Thu, 27 Aug 2015 15:05:03 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Throwing exception there will cause streaming session to fail when end of stream reached no matter what.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;You are right! Sorry. I&apos;m try to fix that. New pachset: cassandra-2.1-10206.txt&lt;/p&gt;</comment>
                            <comment id="14716895" author="yukim" created="Thu, 27 Aug 2015 15:47:06 +0000"  >&lt;p&gt;Thanks, I slightly modified your patch to handle when 0 byte is read, which is normal case, and pushed it to here: &lt;a href=&quot;https://github.com/yukim/cassandra/tree/10206&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/yukim/cassandra/tree/10206&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;CI (&lt;a href=&quot;http://cassci.datastax.com&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com&lt;/a&gt;) will eventually test my branch so let&apos;s see.&lt;/p&gt;</comment>
                            <comment id="14716958" author="a.burylov" created="Thu, 27 Aug 2015 16:12:15 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Are you observing streaming hang when this happens?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Streaming session visible in JMX monitoring and node-tool unity:&lt;br/&gt;
For thread 17365 and 17633 of threaddump-1440686737505.tdump&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;nodetool **** netstats | grep -B1 &lt;span class=&quot;code-quote&quot;&gt;&quot;10.8.6.84&quot;&lt;/span&gt;
Repair 834af7d0-4cb8-11e5-813b-273d25d97b13
    /10.8.6.84
        Receiving 3 files, 141990 bytes total. Already received 3 files, 141990 bytes total
            ***-tmp-ka-77703-Data.db 66507/66507 bytes(100%) received from idx:0/10.8.6.84
            ***-tmp-ka-77702-Data.db 55758/55758 bytes(100%) received from idx:0/10.8.6.84
            ***-tmp-ka-77701-Data.db 19725/19725 bytes(100%) received from idx:0/10.8.6.84
        Sending 3 files, 151858 bytes total. Already sent 3 files, 151858 bytes total
            ***-ka-59374-Data.db 20716/20716 bytes(100%) sent to idx:0/10.8.6.84
            ***-ka-75986-Data.db 75224/75224 bytes(100%) sent to idx:0/10.8.6.84
            ***-ka-53876-Data.db 55918/55918 bytes(100%) sent to idx:0/10.8.6.84
--
Repair 7b088ec1-4cb8-11e5-813b-273d25d97b13
    /10.8.6.84
        Receiving 3 files, 124841 bytes total. Already received 3 files, 124841 bytes total
            ***-tmp-ka-495105-Data.db 49758/49758 bytes(100%) received from idx:0/10.8.6.84
            ***-tmp-ka-495104-Data.db 24711/24711 bytes(100%) received from idx:0/10.8.6.84
            ***-tmp-ka-495106-Data.db 50372/50372 bytes(100%) received from idx:0/10.8.6.84
        Sending 4 files, 175697 bytes total. Already sent 4 files, 175697 bytes total
            ***-ka-489513-Data.db 49255/49255 bytes(100%) sent to idx:0/10.8.6.84
            ***-ka-483689-Data.db 74596/74596 bytes(100%) sent to idx:0/10.8.6.84
            ***-ka-494198-Data.db 25941/25941 bytes(100%) sent to idx:0/10.8.6.84
            ***-ka-493844-Data.db 25905/25905 bytes(100%) sent to idx:0/10.8.6.84
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;blockquote&gt;
&lt;p&gt;Are you observing streaming hang when this happens?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes it hang on 100%&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;What does other end of stream (thread dump) looks like?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I try to capture form live node. At  now, i can say what stream session continue even after other site node rebooted.&lt;/p&gt;</comment>
                            <comment id="14718241" author="a.burylov" created="Fri, 28 Aug 2015 09:05:17 +0000"  >&lt;blockquote&gt;
&lt;p&gt; I slightly modified your patch to handle when 0 byte is read, which is normal case&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;As i can see in java-doc is not&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;if a channel is in blocking mode and there is at least one byte remaining in the buffer then this method will block until at least one byte is read.&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;So read() can  return only -1 or 1.&lt;/p&gt;</comment>
                            <comment id="14723441" author="a.burylov" created="Mon, 31 Aug 2015 14:09:11 +0000"  >&lt;p&gt;I&apos;m connect to hang node with debbugger - all confirmed.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12753290/12753290_screenshot-1.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="14723451" author="yukim" created="Mon, 31 Aug 2015 14:17:57 +0000"  >&lt;p&gt;Thanks for confirm.&lt;/p&gt;

&lt;p&gt;And yes, in blocking mode, it is either -1 or greater than 0, and we use socket in blocking mode.&lt;br/&gt;
But I think handling 0 here is harmless and should not mix with negative.&lt;br/&gt;
If you are ok with this, I will commit the patch.&lt;/p&gt;</comment>
                            <comment id="14725392" author="a.burylov" created="Tue, 1 Sep 2015 13:31:26 +0000"  >&lt;p&gt;It ok to me.&lt;/p&gt;</comment>
                            <comment id="14726284" author="yukim" created="Tue, 1 Sep 2015 22:02:03 +0000"  >&lt;p&gt;Committed, thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12752771" name="cassandra-2.1-10206.txt" size="1340" author="a.burylov" created="Thu, 27 Aug 2015 15:03:39 +0000"/>
                            <attachment id="12753290" name="screenshot-1.png" size="185597" author="a.burylov" created="Mon, 31 Aug 2015 14:08:34 +0000"/>
                            <attachment id="12752713" name="threaddump-1440601628223.tdump" size="299451" author="a.burylov" created="Thu, 27 Aug 2015 11:17:51 +0000"/>
                            <attachment id="12752772" name="threaddump-1440602926719.tdump" size="313582" author="a.burylov" created="Thu, 27 Aug 2015 15:03:39 +0000"/>
                            <attachment id="12752714" name="threaddump-1440672821181.tdump" size="267169" author="a.burylov" created="Thu, 27 Aug 2015 11:17:51 +0000"/>
                            <attachment id="12752773" name="threaddump-1440686737505.tdump" size="284629" author="a.burylov" created="Thu, 27 Aug 2015 15:03:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 12 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2jfzj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332829">2.1.8</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>yukim</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>