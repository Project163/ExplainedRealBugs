<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:42:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6470] ArrayIndexOutOfBoundsException on range query from client</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6470</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;schema: &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE TABLE inboxkeyspace.inboxes(user_id bigint, message_id bigint, thread_id bigint, network_id bigint, read boolean, PRIMARY KEY(user_id, message_id)) WITH CLUSTERING ORDER BY (message_id DESC);
CREATE INDEX ON inboxkeyspace.inboxes(read);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;query: &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;SELECT thread_id, message_id, network_id FROM inboxkeyspace.inboxes WHERE user_id = ? AND message_id &amp;lt; ? AND read = ? LIMIT ? 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The query works if run via cqlsh. However, when run through the datastax client, on the client side we get a timeout exception and on the server side, the Cassandra log shows this exception: &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [ReadStage:4190] 2013-12-10 13:18:03,579 CassandraDaemon.java (line 187) Exception in thread Thread[ReadStage:4190,5,main]
java.lang.RuntimeException: java.lang.ArrayIndexOutOfBoundsException: 0
        at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:1940)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
        at java.lang.Thread.run(Thread.java:722)
Caused by: java.lang.ArrayIndexOutOfBoundsException: 0
        at org.apache.cassandra.db.filter.SliceQueryFilter.start(SliceQueryFilter.java:261)
        at org.apache.cassandra.db.index.composites.CompositesSearcher.makePrefix(CompositesSearcher.java:66)
        at org.apache.cassandra.db.index.composites.CompositesSearcher.getIndexedIterator(CompositesSearcher.java:101)
        at org.apache.cassandra.db.index.composites.CompositesSearcher.search(CompositesSearcher.java:53)
        at org.apache.cassandra.db.index.SecondaryIndexManager.search(SecondaryIndexManager.java:537)
        at org.apache.cassandra.db.ColumnFamilyStore.search(ColumnFamilyStore.java:1669)
        at org.apache.cassandra.db.PagedRangeCommand.executeLocally(PagedRangeCommand.java:109)
        at org.apache.cassandra.service.StorageProxy$LocalRangeSliceRunnable.runMayThrow(StorageProxy.java:1423)
        at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:1936)
        ... 3 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12683839">CASSANDRA-6470</key>
            <summary>ArrayIndexOutOfBoundsException on range query from client</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="enrico.scalavino">Enrico Scalavino</reporter>
                        <labels>
                    </labels>
                <created>Tue, 10 Dec 2013 13:39:18 +0000</created>
                <updated>Tue, 14 Oct 2025 12:13:55 +0000</updated>
                            <resolved>Wed, 29 Jan 2014 18:25:44 +0000</resolved>
                                        <fixVersion>2.0.5</fixVersion>
                                        <due></due>
                            <votes>2</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="13846645" author="jbellis" created="Thu, 12 Dec 2013 19:32:31 +0000"  >&lt;p&gt;Can you reproduce, Ryan?&lt;/p&gt;</comment>
                            <comment id="13846693" author="enigmacurry" created="Thu, 12 Dec 2013 20:19:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enrico.scalavino&quot; class=&quot;user-hover&quot; rel=&quot;enrico.scalavino&quot;&gt;enrico.scalavino&lt;/a&gt; What version of Cassandra and datastax driver are you using? I&apos;ll try and recreate this, but if you have a test already written that is easily decoupled from your project can you post that too?&lt;/p&gt;</comment>
                            <comment id="13846841" author="JIRAUSER308715" created="Thu, 12 Dec 2013 22:38:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enrico.scalavino&quot; class=&quot;user-hover&quot; rel=&quot;enrico.scalavino&quot;&gt;enrico.scalavino&lt;/a&gt; are you using version 2.0.X of C* and the driver?  The limit being a bind parameter isn&apos;t supported unless you are. It may be confusing the driver if you are using the 1.0.X version of the driver (not sure what error gets thrown if you do that).&lt;/p&gt;</comment>
                            <comment id="13847099" author="marcostrama" created="Fri, 13 Dec 2013 03:09:14 +0000"  >&lt;p&gt;I get the same error. I dont know when it has been started. I&apos;m using Cassandra 2.0.2 and Datastax Java Driver 2.0.0-beta2. Query works in cqlsh but fail when running in the client. I tried to re-create (DROP/CREATE) the column family, but the error stills.&lt;/p&gt;

&lt;p&gt;=============&lt;br/&gt;
Table layout:&lt;/p&gt;

&lt;p&gt;cqlsh:pollkan&amp;gt; desc table observed;&lt;/p&gt;

&lt;p&gt;CREATE TABLE observed (&lt;br/&gt;
  observed timeuuid,&lt;br/&gt;
  observer timeuuid,&lt;br/&gt;
  blocked boolean,&lt;br/&gt;
  PRIMARY KEY (observed, observer)&lt;br/&gt;
) WITH&lt;br/&gt;
  bloom_filter_fp_chance=0.010000 AND&lt;br/&gt;
  caching=&apos;KEYS_ONLY&apos; AND&lt;br/&gt;
  comment=&apos;&apos; AND&lt;br/&gt;
  dclocal_read_repair_chance=0.000000 AND&lt;br/&gt;
  gc_grace_seconds=864000 AND&lt;br/&gt;
  index_interval=128 AND&lt;br/&gt;
  read_repair_chance=0.100000 AND&lt;br/&gt;
  replicate_on_write=&apos;true&apos; AND&lt;br/&gt;
  populate_io_cache_on_flush=&apos;false&apos; AND&lt;br/&gt;
  default_time_to_live=0 AND&lt;br/&gt;
  speculative_retry=&apos;99.0PERCENTILE&apos; AND&lt;br/&gt;
  memtable_flush_period_in_ms=0 AND&lt;br/&gt;
  compaction=&lt;/p&gt;
{&apos;class&apos;: &apos;SizeTieredCompactionStrategy&apos;}
&lt;p&gt; AND&lt;br/&gt;
  compression=&lt;/p&gt;
{&apos;sstable_compression&apos;: &apos;LZ4Compressor&apos;}
&lt;p&gt;;&lt;/p&gt;

&lt;p&gt;CREATE INDEX observedBlocked ON observed (blocked);&lt;/p&gt;

&lt;p&gt;=============&lt;br/&gt;
Query in the cqlsh:&lt;/p&gt;

&lt;p&gt;cqlsh:pollkan&amp;gt; SELECT observer FROM observed WHERE observed = fa93c210-4bff-11e3-b48f-5714d8c6f3b2 AND observer &amp;gt; 00000000-0000-1000-0000-000000000000 and blocked = false LIMIT 10000;&lt;/p&gt;

&lt;p&gt; observer&lt;br/&gt;
--------------------------------------&lt;br/&gt;
 43814f60-5bb1-11e3-97c8-ad396a9e8180&lt;/p&gt;

&lt;p&gt;(1 rows)&lt;/p&gt;

&lt;p&gt;=============&lt;br/&gt;
Query in the client log:&lt;/p&gt;

&lt;p&gt;2013-12-13/00:53:03.039/BRST &lt;span class=&quot;error&quot;&gt;&amp;#91;timeline_1&amp;#93;&lt;/span&gt; DEBUG br.com.pollkan.batch.CqlCommands Execute query &lt;span class=&quot;error&quot;&gt;&amp;#91;SELECT observer FROM observed WHERE observed = ? AND observer &amp;gt; ? and blocked = ? LIMIT 10000;&amp;#93;&lt;/span&gt; arguments [&lt;span class=&quot;error&quot;&gt;&amp;#91;fa93c210-4bff-11e3-b48f-5714d8c6f3b2&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;00000000-0000-1000-0000-000000000000&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;false&amp;#93;&lt;/span&gt;]&lt;/p&gt;

&lt;p&gt;=============&lt;br/&gt;
Error in cassandra:&lt;/p&gt;

&lt;p&gt;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;ReadStage:52&amp;#93;&lt;/span&gt; 2013-12-13 01:04:56,799 CassandraDaemon.java (line 187) Exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;ReadStage:52,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.RuntimeException: java.lang.ArrayIndexOutOfBoundsException: 0&lt;br/&gt;
        at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:1931)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:724)&lt;br/&gt;
Caused by: java.lang.ArrayIndexOutOfBoundsException: 0&lt;br/&gt;
        at org.apache.cassandra.db.filter.SliceQueryFilter.start(SliceQueryFilter.java:261)&lt;br/&gt;
        at org.apache.cassandra.db.index.composites.CompositesSearcher.makePrefix(CompositesSearcher.java:66)&lt;br/&gt;
        at org.apache.cassandra.db.index.composites.CompositesSearcher.getIndexedIterator(CompositesSearcher.java:101)&lt;br/&gt;
        at org.apache.cassandra.db.index.composites.CompositesSearcher.search(CompositesSearcher.java:53)&lt;br/&gt;
        at org.apache.cassandra.db.index.SecondaryIndexManager.search(SecondaryIndexManager.java:537)&lt;br/&gt;
        at org.apache.cassandra.db.ColumnFamilyStore.search(ColumnFamilyStore.java:1649)&lt;br/&gt;
        at org.apache.cassandra.db.PagedRangeCommand.executeLocally(PagedRangeCommand.java:109)&lt;br/&gt;
        at org.apache.cassandra.service.StorageProxy$LocalRangeSliceRunnable.runMayThrow(StorageProxy.java:1414)&lt;br/&gt;
        at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:1927)&lt;br/&gt;
        ... 3 more&lt;/p&gt;

&lt;p&gt;=============&lt;br/&gt;
Error from driver log:&lt;/p&gt;

&lt;p&gt;2013-12-13/01:05:06.798/BRST &lt;span class=&quot;error&quot;&gt;&amp;#91;timeline_1&amp;#93;&lt;/span&gt; ERROR br.com.pollkan.batch.CqlCommands Exception! &lt;span class=&quot;error&quot;&gt;&amp;#91;Cassandra timeout during read query at consistency ONE (1 responses were required but only 0 replica responded)&amp;#93;&lt;/span&gt;&lt;br/&gt;
com.datastax.driver.core.exceptions.ReadTimeoutException: Cassandra timeout during read query at consistency ONE (1 responses were required but only 0 replica responded)&lt;br/&gt;
        at com.datastax.driver.core.exceptions.ReadTimeoutException.copy(ReadTimeoutException.java:69)&lt;br/&gt;
        at com.datastax.driver.core.ResultSetFuture.extractCauseFromExecutionException(ResultSetFuture.java:271)&lt;br/&gt;
        at com.datastax.driver.core.ResultSetFuture.getUninterruptibly(ResultSetFuture.java:187)&lt;br/&gt;
        at com.datastax.driver.core.Session.execute(Session.java:126)&lt;br/&gt;
        at br.com.pollkan.batch.CqlCommands.executeQuery(CqlCommands.java:149)&lt;br/&gt;
        at br.com.pollkan.batch.BaseBatch.processChild(BaseBatch.java:364)&lt;br/&gt;
        at br.com.pollkan.batch.BaseBatch.run(BaseBatch.java:640)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:722)&lt;/p&gt;

&lt;p&gt;If need more information, please let me know. Tks&lt;/p&gt;</comment>
                            <comment id="13847418" author="enrico.scalavino" created="Fri, 13 Dec 2013 11:22:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjordan&quot; class=&quot;user-hover&quot; rel=&quot;jjordan&quot;&gt;jjordan&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enigmacurry&quot; class=&quot;user-hover&quot; rel=&quot;enigmacurry&quot;&gt;enigmacurry&lt;/a&gt; I am using datastax 2.0.0-rc1 and Cassandra 2.0.3. The query works if I remove the where clause on either the read attribute or on the message_id attribute. &lt;br/&gt;
Unfortunately the code calling the query is buried deep in the project, and the tests only test high level apis. &lt;/p&gt;</comment>
                            <comment id="13847458" author="dmnorc" created="Fri, 13 Dec 2013 13:02:03 +0000"  >&lt;p&gt;I get the same error too. I&apos;m using Cassandra 2.0.2 and Datastax Java Driver 2.0.0-beta2&lt;/p&gt;</comment>
                            <comment id="13852345" author="marcostrama" created="Wed, 18 Dec 2013 23:56:21 +0000"  >&lt;p&gt;I removed the &quot;blocked&quot; column from the query (indexed column) and now it works. This helps?&lt;/p&gt;</comment>
                            <comment id="13852799" author="enrico.scalavino" created="Thu, 19 Dec 2013 10:47:33 +0000"  >&lt;p&gt;No, also my query works if I remove one of the conditions. That still does not explain why that happens, and why there is an unmanaged exception on the server. &lt;/p&gt;</comment>
                            <comment id="13884889" author="enigmacurry" created="Tue, 28 Jan 2014 23:16:55 +0000"  >&lt;p&gt;I uploaded an Eclipse project (6470-reproduced.tar.gz) that reproduces this issue.&lt;/p&gt;

&lt;p&gt;Start up a ccm cluster: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ccm create -v git:cassandra-2.0.2
ccm create -v git:cassandra-2.0.2 test
ccm populate -n 3:3
ccm start
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then run Bug6470Client.&lt;/p&gt;

&lt;p&gt;This code actually works with driver version 1.0.3, so I wonder if that&apos;s not the cause instead of C*...&lt;/p&gt;

&lt;p&gt;I can also confirm that the same queries issued in cqlsh do not repro this issue.&lt;/p&gt;</comment>
                            <comment id="13884903" author="enigmacurry" created="Tue, 28 Jan 2014 23:24:14 +0000"  >&lt;p&gt;I also tried from the latest python driver, no problem there.&lt;/p&gt;</comment>
                            <comment id="13885157" author="slebresne" created="Wed, 29 Jan 2014 09:07:17 +0000"  >&lt;p&gt;This is likely a problem with the paging over 2ndary indexes (which is why only the 2.0 version of the driver is running into it). I&apos;ll have a closer look.&lt;/p&gt;</comment>
                            <comment id="13885395" author="slebresne" created="Wed, 29 Jan 2014 14:50:23 +0000"  >&lt;p&gt;We were not handling empty bounds in DataRange.sliceForKey() (that is indeed used by paging calls) which was returning an empty slice array (which was incorrect but hence the error).&lt;/p&gt;

&lt;p&gt;Attached simple fix.&lt;/p&gt;</comment>
                            <comment id="13885581" author="lyubent" created="Wed, 29 Jan 2014 17:50:42 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13885622" author="slebresne" created="Wed, 29 Jan 2014 18:25:44 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12625763" name="6470-reproduced.tar.gz" size="5409" author="enigmacurry" created="Tue, 28 Jan 2014 23:16:55 +0000"/>
                            <attachment id="12625871" name="6470.txt" size="1595" author="slebresne" created="Wed, 29 Jan 2014 14:50:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>362911</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 42 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1qk2v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>363217</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>lyubent</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[lyubent]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>