<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:48:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8020] nodetool repair on Cassandra 2.1.0 indexed tables returns java exception about creating snapshots</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8020</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Running a nodetool repair on Cassandra 2.1.0 indexed tables returns java exception about creating snapshots:&lt;/p&gt;

&lt;p&gt;Command line:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[2014-09-29 11:25:24,945] Repair session 73c0d390-47e4-11e4-ba0f-c7788dc924ec for range (-7298689860784559350,-7297558156602685286] failed with error java.io.IOException: Failed during snapshot creation.
[2014-09-29 11:25:24,945] Repair command #5 finished
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Cassandra log:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [Thread-49681] 2014-09-29 11:25:24,945 StorageService.java:2689 - Repair session 73c0d390-47e4-11e4-ba0f-c7788dc924ec for range (-7298689860784559350,-7297558156602685286] failed with error java.io.IOException: Failed during snapshot creation.
java.util.concurrent.ExecutionException: java.lang.RuntimeException: java.io.IOException: Failed during snapshot creation.
        at java.util.concurrent.FutureTask.report(FutureTask.java:122) [na:1.7.0_67]
        at java.util.concurrent.FutureTask.get(FutureTask.java:188) [na:1.7.0_67]
        at org.apache.cassandra.service.StorageService$4.runMayThrow(StorageService.java:2680) ~[apache-cassandra-2.1.0.jar:2.1.0]
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) [apache-cassandra-2.1.0.jar:2.1.0]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) [na:1.7.0_67]
        at java.util.concurrent.FutureTask.run(FutureTask.java:262) [na:1.7.0_67]
        at java.lang.Thread.run(Thread.java:745) [na:1.7.0_67]
Caused by: java.lang.RuntimeException: java.io.IOException: Failed during snapshot creation.
        at com.google.common.base.Throwables.propagate(Throwables.java:160) ~[guava-16.0.jar:na]
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:32) [apache-cassandra-2.1.0.jar:2.1.0]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) [na:1.7.0_67]
        at java.util.concurrent.FutureTask.run(FutureTask.java:262) [na:1.7.0_67]
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) ~[na:1.7.0_67]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) ~[na:1.7.0_67]
        ... 1 common frames omitted
Caused by: java.io.IOException: Failed during snapshot creation.
        at org.apache.cassandra.repair.RepairSession.failedSnapshot(RepairSession.java:344) ~[apache-cassandra-2.1.0.jar:2.1.0]
        at org.apache.cassandra.repair.RepairJob$2.onFailure(RepairJob.java:128) ~[apache-cassandra-2.1.0.jar:2.1.0]
        at com.google.common.util.concurrent.Futures$4.run(Futures.java:1172) ~[guava-16.0.jar:na]
        ... 3 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If the index is dropped, the repair returns no error:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh:test&amp;gt; drop INDEX user_pass_idx ;

root@test:~# nodetool repair test user
[2014-09-29 11:27:29,668] Starting repair command #6, repairing 743 ranges for keyspace test (seq=true, full=true)
.
.
[2014-09-29 11:28:38,030] Repair session e6d40e10-47e4-11e4-ba0f-c7788dc924ec for range (-7298689860784559350,-7297558156602685286] finished
[2014-09-29 11:28:38,030] Repair command #6 finished
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The test table:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE TABLE test.user (
    login text PRIMARY KEY,
    password text
)
create INDEX user_pass_idx on test.user (password) ;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Cassandra 2.1.0, Slackware 64bits 14.1, Linux Kernel 3.14.19, JDK build 1.7.0_67-b01, cluster with six nodes, Xeon E3-1230, 32GB RAM&lt;/p&gt;</environment>
        <key id="12744762">CASSANDRA-8020</key>
            <summary>nodetool repair on Cassandra 2.1.0 indexed tables returns java exception about creating snapshots</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yukim">Yuki Morishita</assignee>
                                    <reporter username="jero">Jeronimo A Barros</reporter>
                        <labels>
                            <label>newbie</label>
                    </labels>
                <created>Mon, 29 Sep 2014 19:30:06 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:33 +0000</updated>
                            <resolved>Thu, 2 Oct 2014 17:19:02 +0000</resolved>
                                        <fixVersion>2.1.1</fixVersion>
                                    <component>Tool/nodetool</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>11</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="86400">24h</timeoriginalestimate>
                            <timeestimate seconds="86400">24h</timeestimate>
                                        <comments>
                            <comment id="14152320" author="carlyeks" created="Mon, 29 Sep 2014 21:22:57 +0000"  >&lt;p&gt;It looks like there was an error while trying to create the snapshot. Can you look through the logs for &quot;Error occurred during snapshot phase&quot;? This will help pin down the original cause of the failed repair.&lt;/p&gt;</comment>
                            <comment id="14152357" author="jero" created="Mon, 29 Sep 2014 21:53:43 +0000"  >&lt;p&gt;Carl, no &quot;Error occurred during snapshot phase&quot;. But I took another look (yes, I should have done this before) and the beginning of the &quot;nodetool repair&quot; points to the AntiEntropyStage class:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;NFO  [Thread-49681] 2014-09-29 11:25:22,787 StorageService.java:2595 - Starting repair command #5, repairing 743 ranges for keyspace test (seq=true, full=true)
INFO  [AntiEntropySessions:17] 2014-09-29 11:25:24,264 RepairSession.java:260 - [repair #736daa80-47e4-11e4-ba0f-c7788dc924ec] new session: will sync c1.test.net/192.168.33.248, /192.168.33.250, /192.168.33.252 on range (-7990332010750800111,-7986163865225197304] for test.[user]
ERROR [AntiEntropyStage:1487] 2014-09-29 11:25:24,265 CassandraDaemon.java:166 - Exception in thread Thread[AntiEntropyStage:1487,5,main]
java.lang.ClassCastException: null
ERROR [RepairJobTask:3] 2014-09-29 11:25:24,266 RepairJob.java:127 - Error occurred during snapshot phase
java.lang.RuntimeException: Could not create snapshot at /192.168.33.248
	at org.apache.cassandra.repair.SnapshotTask$SnapshotCallback.onFailure(SnapshotTask.java:77) ~[apache-cassandra-2.1.0.jar:2.1.0]
	at org.apache.cassandra.net.ResponseVerbHandler.doVerb(ResponseVerbHandler.java:48) ~[apache-cassandra-2.1.0.jar:2.1.0]
	at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:62) ~[apache-cassandra-2.1.0.jar:2.1.0]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) [na:1.7.0_67]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) [na:1.7.0_67]
	at java.lang.Thread.run(Thread.java:745) [na:1.7.0_67]
ERROR [AntiEntropySessions:17] 2014-09-29 11:25:24,266 RepairSession.java:303 - [repair #736daa80-47e4-11e4-ba0f-c7788dc924ec] session completed with the following error
java.io.IOException: Failed during snapshot creation.
	at org.apache.cassandra.repair.RepairSession.failedSnapshot(RepairSession.java:344) ~[apache-cassandra-2.1.0.jar:2.1.0]
	at org.apache.cassandra.repair.RepairJob$2.onFailure(RepairJob.java:128) ~[apache-cassandra-2.1.0.jar:2.1.0]
	at com.google.common.util.concurrent.Futures$4.run(Futures.java:1172) ~[guava-16.0.jar:na]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) [na:1.7.0_67]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) [na:1.7.0_67]
	at java.lang.Thread.run(Thread.java:745) [na:1.7.0_67]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;m attaching the full log of the error.&lt;/p&gt;</comment>
                            <comment id="14152363" author="jero" created="Mon, 29 Sep 2014 21:56:34 +0000"  >&lt;p&gt;nodetool repair system.log&lt;/p&gt;</comment>
                            <comment id="14152442" author="yukim" created="Mon, 29 Sep 2014 22:38:01 +0000"  >&lt;p&gt;Confirmed.&lt;/p&gt;

&lt;p&gt;When snapshotting, replica node is throwing the following on indexed table:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [AntiEntropyStage:768] 2014-09-29 17:34:25,654 CassandraDaemon.java:166 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[AntiEntropyStage:768,5,main]
java.lang.ClassCastException: java.lang.&lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt; cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to java.nio.ByteBuffer
        at org.apache.cassandra.db.marshal.BytesType.compare(BytesType.java:29) ~[main/:na]
        at org.apache.cassandra.dht.LocalToken.compareTo(LocalToken.java:44) ~[main/:na]
        at org.apache.cassandra.dht.LocalToken.compareTo(LocalToken.java:24) ~[main/:na]
        at org.apache.cassandra.dht.Range.contains(Range.java:71) ~[main/:na]
        at org.apache.cassandra.dht.Range.contains(Range.java:111) ~[main/:na]
        at org.apache.cassandra.dht.Range.intersects(Range.java:142) ~[main/:na]
        at org.apache.cassandra.dht.Range.intersects(Range.java:129) ~[main/:na]
        at org.apache.cassandra.dht.AbstractBounds.intersects(AbstractBounds.java:83) ~[main/:na]
        at org.apache.cassandra.repair.RepairMessageVerbHandler$1.apply(RepairMessageVerbHandler.java:83) ~[main/:na]
        at org.apache.cassandra.repair.RepairMessageVerbHandler$1.apply(RepairMessageVerbHandler.java:80) ~[main/:na]
        at org.apache.cassandra.db.ColumnFamilyStore.snapshotWithoutFlush(ColumnFamilyStore.java:2152) ~[main/:na]
        at org.apache.cassandra.db.ColumnFamilyStore.snapshot(ColumnFamilyStore.java:2215) ~[main/:na]
        at org.apache.cassandra.repair.RepairMessageVerbHandler.doVerb(RepairMessageVerbHandler.java:79) ~[main/:na]
        at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:62) ~[main/:na]
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) ~[na:1.7.0_51]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) ~[na:1.7.0_51]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:744) ~[na:1.7.0_51]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14152444" author="yukim" created="Mon, 29 Sep 2014 22:39:57 +0000"  >&lt;p&gt;This is introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7024&quot; title=&quot;Create snapshot selectively during sequential repair&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7024&quot;&gt;&lt;del&gt;CASSANDRA-7024&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14154678" author="tuukkamustonen" created="Wed, 1 Oct 2014 11:34:42 +0000"  >&lt;p&gt;Just bumped into this. Similar log lines found. Any workarounds until 2.1.1 is out?&lt;/p&gt;</comment>
                            <comment id="14154849" author="pyritschard" created="Wed, 1 Oct 2014 14:16:45 +0000"  >&lt;p&gt;We&apos;re seeing this as well&lt;/p&gt;</comment>
                            <comment id="14154919" author="pyritschard" created="Wed, 1 Oct 2014 15:16:33 +0000"  >&lt;p&gt;The crux of the problem seems to be that in &lt;tt&gt;org.apache.cassandra.repair.RepairMessageVerbHandler&lt;/tt&gt;, the line 83&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;return sstable != null &amp;amp;&amp;amp; new Bounds&amp;lt;&amp;gt;(sstable.first.getToken(),     
      sstable.last.getToken()).intersects(Collections.singleton(repairingRange));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;might generate a comparison between a &lt;tt&gt;LocalToken&lt;/tt&gt; and a &lt;tt&gt;LongToken&lt;/tt&gt; which fails since the former wraps a ByteBuffer and the latter a Long&lt;/p&gt;
</comment>
                            <comment id="14154936" author="yukim" created="Wed, 1 Oct 2014 15:23:54 +0000"  >&lt;p&gt;Attached patch to exclude SSTables from 2i from snapshotting.&lt;/p&gt;</comment>
                            <comment id="14154949" author="jbellis" created="Wed, 1 Oct 2014 15:37:11 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;(is this bug new in 2.1?)&lt;/p&gt;</comment>
                            <comment id="14154969" author="yukim" created="Wed, 1 Oct 2014 15:46:29 +0000"  >&lt;blockquote&gt;&lt;p&gt;is this bug new in 2.1?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, it&apos;s from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7024&quot; title=&quot;Create snapshot selectively during sequential repair&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7024&quot;&gt;&lt;del&gt;CASSANDRA-7024&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14156792" author="yukim" created="Thu, 2 Oct 2014 17:19:02 +0000"  >&lt;p&gt;Committed, thanks!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12707786">CASSANDRA-7024</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12672339" name="8020-2.1.txt" size="1450" author="yukim" created="Wed, 1 Oct 2014 15:23:54 +0000"/>
                            <attachment id="12671877" name="system.log.2014-09-29_1127" size="4014256" author="jero" created="Mon, 29 Sep 2014 21:56:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 7 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i20lp3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327256">2.1.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327256">2.1.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>