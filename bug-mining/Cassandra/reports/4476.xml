<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:04:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12509] Shutdown process triggered twice during if the node is drained</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12509</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;If the node is drained, the &lt;tt&gt;StorageService#drain&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/StorageService.java#L4212&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;method&lt;/a&gt; is called, which triggers shutdown of mutation stage, messaging service, compaction, batchlog etc. In the end of this process, the node is moved to &lt;tt&gt;DRAINED&lt;/tt&gt; status with the process still running. &lt;/p&gt;

&lt;p&gt;When JVM is shutdown, the JVM shutdown hooks are ran, which are subscribed during the server initialisation: &lt;tt&gt;Runtime.getRuntime().addShutdownHook(drainOnShutdown);&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/StorageService.java#L575-L636&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;I noticed this behaviour while reviewing &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12461&quot; title=&quot;Add hooks to StorageService shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12461&quot;&gt;&lt;del&gt;CASSANDRA-12461&lt;/del&gt;&lt;/a&gt;, as if we&apos;d like add custom pre and post-shutdown hooks, most likely it makes sense to run them once (or user might expect such behaviour). &lt;/p&gt;

&lt;p&gt;Is this behaviour correct? Should we run whole shutdown process twice or just once in &quot;drain&quot; and no-op during JVM shutdown?  &lt;/p&gt;</description>
                <environment></environment>
        <key id="12998568">CASSANDRA-12509</key>
            <summary>Shutdown process triggered twice during if the node is drained</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ifesdjeen">Alex Petrov</assignee>
                                    <reporter username="ifesdjeen">Alex Petrov</reporter>
                        <labels>
                    </labels>
                <created>Fri, 19 Aug 2016 18:58:18 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:21 +0000</updated>
                            <resolved>Tue, 4 Oct 2016 02:02:44 +0000</resolved>
                                        <fixVersion>3.0.10</fixVersion>
                    <fixVersion>3.10</fixVersion>
                                    <component>Local/Startup and Shutdown</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15532749" author="ifesdjeen" created="Thu, 29 Sep 2016 13:18:32 +0000"  >&lt;p&gt;Moving the bugfix here from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12461&quot; title=&quot;Add hooks to StorageService shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12461&quot;&gt;&lt;del&gt;CASSANDRA-12461&lt;/del&gt;&lt;/a&gt;, re-triggering CI:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/12509-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12509-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/ifesdjeen-12509-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/ifesdjeen-12509-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/12509-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12509-3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/ifesdjeen-12509-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/ifesdjeen-12509-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15534961" author="stefania" created="Fri, 30 Sep 2016 04:13:30 +0000"  >&lt;p&gt;Unfortunately the 3.0 patch has broken &lt;a href=&quot;http://cassci.datastax.com/job/ifesdjeen-12509-3.0-dtest/lastCompletedBuild/testReport/snapshot_test/TestArchiveCommitlog/test_archive_commitlog_with_active_commitlog_2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;test_archive_commitlog_with_active_commitlog&lt;/a&gt; in 3.0. It&apos;s a known failure, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11811&quot; title=&quot;dtest failure in snapshot_test.TestArchiveCommitlog.test_archive_commitlog&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11811&quot;&gt;&lt;del&gt;CASSANDRA-11811&lt;/del&gt;&lt;/a&gt;, but whilst it currently fails rarely, this patch makes it fail every single time, even locally.&lt;/p&gt;

&lt;p&gt;The problem is that an archived commitlog segment from a destroyed cluster is replayed, which adds the bootstrap tokens of the old cluster, but subsequently new bootstrap tokens are generated and the node fails to start because it thinks it has twice as many tokens.&lt;/p&gt;

&lt;p&gt;I&apos;ve proposed this &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/1354&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;pull request&lt;/a&gt; to fix the problem, which prevents the new cluster from generating new tokens, let&apos;s see if it gets accepted.&lt;/p&gt;</comment>
                            <comment id="15541655" author="stefania" created="Mon, 3 Oct 2016 06:22:55 +0000"  >&lt;p&gt;The fix for the failing dtest should be available in this new &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/1349&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;pull request&lt;/a&gt;, we should be able to commit this once the pull request is merged.&lt;/p&gt;</comment>
                            <comment id="15544068" author="stefania" created="Tue, 4 Oct 2016 02:02:44 +0000"  >&lt;p&gt;It seems that the dtest pull request is waiting for this patch in order to stabilize the test, so I&apos;ve committed this patch to 3.0 as 5115c106db198e684b47c614b237925c45c71da8 and merged into 3.X and trunk.&lt;/p&gt;

&lt;p&gt;Until the dtest P.R. is also merged, &lt;tt&gt;TestArchiveCommitlog.test_archive_commitlog_with_active_commitlog&lt;/tt&gt; will fail but it is already covered by a known failure and the P.R. is almost ready to be merged.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                                                <inwardlinks description="is blocked by">
                                        <issuelink>
            <issuekey id="12970141">CASSANDRA-11811</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310060">
                    <name>Container</name>
                                                                <inwardlinks description="Is contained by">
                                        <issuelink>
            <issuekey id="12997321">CASSANDRA-12461</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 7 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i32jd3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>stefania</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>