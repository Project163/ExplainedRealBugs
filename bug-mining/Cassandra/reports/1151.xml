<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:23:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3224] LeveledCompactionStrategy is too complacent</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3224</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;As the title says, it barely does anything.  I inserted 50G worth of data with 1G heap and 99% overwrite ratio, and it only compacted twice:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; INFO [CompactionExecutor:1] 2011-09-16 22:29:54,572 CompactionTask.java (line 118) Compacting [SSTableReader(path=&apos;/var/lib/cassandra/data/Keyspace1/Standard1-h-1-Data.db&apos;)]
 INFO [CompactionExecutor:1] 2011-09-16 22:29:58,606 CompactionTask.java (line 220) Compacted to [/var/lib/cassandra/data/Keyspace1/Standard1-h-2-Data.db,/var/lib/cassandra/data/Keyspace1/Standard1-h-4-Data.db,/var/lib/cassandra/data/Keyspace1/Standard1-h-5-Data.db,].  12,595,811 to 12,595,811 (~100% of original) bytes for 40,501 keys at 3.058122MBPS.  Time: 3,928ms.
 INFO [CompactionExecutor:1] 2011-09-16 22:29:58,607 CompactionTask.java (line 222) CF Total Bytes Compacted: 12,595,811
 INFO [CompactionExecutor:3] 2011-09-16 22:29:58,889 CompactionTask.java (line 118) Compacting [SSTableReader(path=&apos;/var/lib/cassandra/data/Keyspace1/Standard1-h-4-Data.db&apos;), SSTableReader(path=&apos;/var/lib/cassandra/data/Keyspace1/Standard1-h-2-Data.db&apos;), SSTableReader(path=&apos;/var/lib/cassandra/data/Keyspace1/Standard1-h-5-Data.db&apos;), SSTableReader(path=&apos;/var/lib/cassandra/data/Keyspace1/Standard1-h-3-Data.db&apos;)]
 INFO [CompactionExecutor:3] 2011-09-16 22:30:06,900 CompactionTask.java (line 220) Compacted to [/var/lib/cassandra/data/Keyspace1/Standard1-h-7-Data.db,/var/lib/cassandra/data/Keyspace1/Standard1-h-9-Data.db,/var/lib/cassandra/data/Keyspace1/Standard1-h-11-Data.db,/var/lib/cassandra/data/Keyspace1/Standard1-h-12-Data.db,/var/lib/cassandra/data/Keyspace1/Standard1-h-14-Data.db,/var/lib/cassandra/data/Keyspace1/Standard1-h-15-Data.db,].  28,374,396 to 28,374,396 (~100% of original) bytes for 91,236 keys at 3.380379MBPS.  Time: 8,005ms.
 INFO [CompactionExecutor:3] 2011-09-16 22:30:06,901 CompactionTask.java (line 222) CF Total Bytes Compacted: 40,970,207
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Resulting in the following levels:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;L0: 4965
L1: 6
L2: 0
L3: 0
L4: 0
L5: 0
L6: 0
L7: 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is obviously going to result in extremely poor read performance.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12523442">CASSANDRA-3224</key>
            <summary>LeveledCompactionStrategy is too complacent</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="brandon.williams">Brandon Williams</reporter>
                        <labels>
                            <label>compaction</label>
                    </labels>
                <created>Sat, 17 Sep 2011 18:10:17 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:50 +0000</updated>
                            <resolved>Tue, 20 Sep 2011 13:13:11 +0000</resolved>
                                        <fixVersion>1.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13107324" author="jbellis" created="Sun, 18 Sep 2011 03:08:20 +0000"  >&lt;p&gt;This is a regression caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3181&quot; title=&quot;Compaction fails to occur&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3181&quot;&gt;&lt;del&gt;CASSANDRA-3181&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The problem is that when CompactionTask calls submitBackground, the original Task is not yet technically done, so LeveledCompactionStrategy returns &quot;nothing to do&quot; to prevent multiple tasks running in parallel, which is not supported for LCS.  So after the first compaction runs five minutes in, that&apos;s all she wrote.&lt;/p&gt;

&lt;p&gt;Fixing the Task/Executor mess is out of scope for 1.0 (created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3225&quot; title=&quot;Clean up CompactionManager / CompactionTask / CompactionInfo / CompactionInfo.Holder mess&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3225&quot;&gt;&lt;del&gt;CASSANDRA-3225&lt;/del&gt;&lt;/a&gt; to address in 1.1) s&lt;/p&gt;</comment>
                            <comment id="13108018" author="brandon.williams" created="Mon, 19 Sep 2011 17:43:09 +0000"  >&lt;p&gt;Better, but it looks like LCS starts miscounting at some point, and this causes compactions to stop:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
DEBUG [CompactionExecutor:4] 2011-09-19 17:40:31,359 LeveledManifest.java (line 218) Level 0 contains 85 SSTables
DEBUG [CompactionExecutor:4] 2011-09-19 17:40:31,360 LeveledManifest.java (line 218) Level 1 contains 0 SSTables
DEBUG [CompactionExecutor:4] 2011-09-19 17:40:31,360 LeveledManifest.java (line 218) Level 2 contains 14 SSTables
DEBUG [CompactionExecutor:4] 2011-09-19 17:40:31,361 LeveledManifest.java (line 218) Level 3 contains 0 SSTables
DEBUG [CompactionExecutor:4] 2011-09-19 17:40:31,361 LeveledManifest.java (line 218) Level 4 contains 0 SSTables
DEBUG [CompactionExecutor:4] 2011-09-19 17:40:31,361 LeveledManifest.java (line 218) Level 5 contains 0 SSTables
DEBUG [CompactionExecutor:4] 2011-09-19 17:40:31,361 LeveledManifest.java (line 218) Level 6 contains 0 SSTables
DEBUG [CompactionExecutor:4] 2011-09-19 17:40:31,361 LeveledManifest.java (line 218) Level 7 contains 0 SSTables
DEBUG [CompactionExecutor:4] 2011-09-19 17:40:31,361 LeveledManifest.java (line 197) Compaction score for level 0 is 0.0
DEBUG [CompactionExecutor:4] 2011-09-19 17:40:31,362 LeveledManifest.java (line 197) Compaction score for level 2 is 0.0
DEBUG [CompactionExecutor:4] 2011-09-19 17:40:31,362 LeveledCompactionStrategy.java (line 112) CompactionManager candidates are 
DEBUG [CompactionExecutor:1] 2011-09-19 17:40:31,362 LeveledManifest.java (line 218) Level 0 contains 0 SSTables
DEBUG [CompactionExecutor:1] 2011-09-19 17:40:31,362 LeveledManifest.java (line 218) Level 1 contains 0 SSTables
DEBUG [CompactionExecutor:1] 2011-09-19 17:40:31,362 LeveledManifest.java (line 218) Level 2 contains 0 SSTables
DEBUG [CompactionExecutor:1] 2011-09-19 17:40:31,362 LeveledManifest.java (line 218) Level 3 contains 0 SSTables
DEBUG [CompactionExecutor:1] 2011-09-19 17:40:31,363 LeveledManifest.java (line 218) Level 4 contains 0 SSTables
DEBUG [CompactionExecutor:1] 2011-09-19 17:40:31,363 LeveledManifest.java (line 218) Level 5 contains 0 SSTables
DEBUG [CompactionExecutor:1] 2011-09-19 17:40:31,363 LeveledManifest.java (line 218) Level 6 contains 0 SSTables
DEBUG [CompactionExecutor:1] 2011-09-19 17:40:31,363 LeveledManifest.java (line 218) Level 7 contains 0 SSTables
DEBUG [CompactionExecutor:1] 2011-09-19 17:40:31,363 LeveledCompactionStrategy.java (line 112) CompactionManager candidates are 
DEBUG [CompactionExecutor:1] 2011-09-19 17:40:31,363 LeveledManifest.java (line 218) Level 0 contains 0 SSTables
DEBUG [CompactionExecutor:1] 2011-09-19 17:40:31,363 LeveledManifest.java (line 218) Level 1 contains 0 SSTables
DEBUG [CompactionExecutor:1] 2011-09-19 17:40:31,363 LeveledManifest.java (line 218) Level 2 contains 0 SSTables
DEBUG [CompactionExecutor:1] 2011-09-19 17:40:31,364 LeveledManifest.java (line 218) Level 3 contains 0 SSTables
DEBUG [CompactionExecutor:1] 2011-09-19 17:40:31,364 LeveledManifest.java (line 218) Level 4 contains 0 SSTables
DEBUG [CompactionExecutor:1] 2011-09-19 17:40:31,364 LeveledManifest.java (line 218) Level 5 contains 0 SSTables
DEBUG [CompactionExecutor:1] 2011-09-19 17:40:31,364 LeveledManifest.java (line 218) Level 6 contains 0 SSTables
DEBUG [CompactionExecutor:1] 2011-09-19 17:40:31,364 LeveledManifest.java (line 218) Level 7 contains 0 SSTables
DEBUG [CompactionExecutor:1] 2011-09-19 17:40:31,364 LeveledCompactionStrategy.java (line 112) CompactionManager candidates are 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Actual levels are (according to json manifest):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;L0: 85
L1: 0
L2: 14
L3: 0
L4: 0
L5: 0
L6: 0
L7: 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Attempting to force a compaction via nodetool:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
 INFO 17:42:28,933 Compacting [SSTableReader(path=&apos;/var/lib/cassandra/data/system/LocationInfo-h-2-Data.db&apos;), SSTableReader(path=&apos;/var/lib
/cassandra/data/system/LocationInfo-h-1-Data.db&apos;)]
DEBUG 17:42:28,933 Expected bloom filter size : 512
 INFO 17:42:28,956 Compacted to [/var/lib/cassandra/data/system/LocationInfo-h-3-Data.db,].  498 to 447 (~89% of original) bytes for 3 key
s at 0.019377MBPS.  Time: 22ms.
 INFO 17:42:28,956 CF Total Bytes Compacted: 225,632,757
 INFO 17:42:28,956 Nothing to compact in Migrations.Use forceUserDefinedCompaction if you wish to force compaction of single sstables (e.g. for tombstone collection)
 INFO 17:42:28,957 Nothing to compact in Schema.Use forceUserDefinedCompaction if you wish to force compaction of single sstables (e.g. for tombstone collection)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13108030" author="jbellis" created="Mon, 19 Sep 2011 18:02:28 +0000"  >&lt;p&gt;v2 attached w/ one-line fix to score computation&lt;/p&gt;</comment>
                            <comment id="13108078" author="brandon.williams" created="Mon, 19 Sep 2011 19:23:19 +0000"  >&lt;p&gt;Somehow, I ended up in the following situation, even though my workload is 100% unique and some compactions did succeed:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;L0: 974
L1: 0
L2: 0
L3: 0
L4: 0
L5: 0
L6: 0
L7: 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The box then died from OOM while trying to write the BF.  System log with db.compaction at DEBUG attached.&lt;/p&gt;</comment>
                            <comment id="13108087" author="jbellis" created="Mon, 19 Sep 2011 19:34:28 +0000"  >&lt;p&gt;v3 improves some logging and adds an assert&lt;/p&gt;</comment>
                            <comment id="13108114" author="jbellis" created="Mon, 19 Sep 2011 20:25:08 +0000"  >&lt;p&gt;v4 adds more debug logging, which makes clear that the empty manifests being logged were from other CFS.&lt;/p&gt;

&lt;p&gt;caps L0 compaction candidates at 32 to avoid OOMing from pessimisting BF sizing.&lt;/p&gt;

&lt;p&gt;picks L0 initial victim based on age of data rather than randomly.&lt;/p&gt;</comment>
                            <comment id="13108211" author="jbellis" created="Mon, 19 Sep 2011 23:07:57 +0000"  >&lt;p&gt;v5 attached.  changes max-from-L0 to 10, and fixes manifest loading on restart.&lt;/p&gt;</comment>
                            <comment id="13108338" author="jbellis" created="Tue, 20 Sep 2011 02:43:52 +0000"  >&lt;p&gt;v6 changes scoring of levels to prioritize higher levels, reducing the duplicate work that gets done when lower levels are done in turn.&lt;/p&gt;

&lt;p&gt;also logs what level each compacted sstable comes from.&lt;/p&gt;</comment>
                            <comment id="13108637" author="brandon.williams" created="Tue, 20 Sep 2011 12:43:40 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13108661" author="jbellis" created="Tue, 20 Sep 2011 13:13:11 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12495117" name="3224-v2.txt" size="2099" author="jbellis" created="Mon, 19 Sep 2011 18:02:28 +0000"/>
                            <attachment id="12495131" name="3224-v3.txt" size="3838" author="jbellis" created="Mon, 19 Sep 2011 19:34:28 +0000"/>
                            <attachment id="12495137" name="3224-v4.txt" size="9955" author="jbellis" created="Mon, 19 Sep 2011 20:25:08 +0000"/>
                            <attachment id="12495159" name="3224-v5.txt" size="15622" author="jbellis" created="Mon, 19 Sep 2011 23:07:57 +0000"/>
                            <attachment id="12495186" name="3224-v6.txt" size="18546" author="jbellis" created="Tue, 20 Sep 2011 02:43:52 +0000"/>
                            <attachment id="12494955" name="3224.txt" size="1224" author="jbellis" created="Sun, 18 Sep 2011 03:08:20 +0000"/>
                            <attachment id="12495127" name="system.log.bz2" size="143238" author="brandon.williams" created="Mon, 19 Sep 2011 19:23:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4009</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 10 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ghbj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94236</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>brandon.williams</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>