<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:45:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6875] CQL3: select multiple CQL rows in a single partition using IN</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6875</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In the spirit of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4851&quot; title=&quot;CQL3: improve support for paginating over composites&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4851&quot;&gt;&lt;del&gt;CASSANDRA-4851&lt;/del&gt;&lt;/a&gt; and to bring CQL to parity with Thrift, it is important to support reading several distinct CQL rows from a given partition using a distinct set of &quot;coordinates&quot; for these rows within the partition.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4851&quot; title=&quot;CQL3: improve support for paginating over composites&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4851&quot;&gt;&lt;del&gt;CASSANDRA-4851&lt;/del&gt;&lt;/a&gt; introduced a range scan over the multi-dimensional space of clustering keys. We also need to support a &quot;multi-get&quot; of CQL rows, potentially using the &quot;IN&quot; keyword to define a set of clustering keys to fetch at once.&lt;/p&gt;

&lt;p&gt;(reusing the same example:)&lt;/p&gt;

&lt;p&gt;Consider the following table:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE TABLE test (
  k &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
  c1 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
  c2 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
  PRIMARY KEY (k, c1, c2)
);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;with the following data:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; k | c1 | c2
---+----+----
 0 |  0 |  0
 0 |  0 |  1
 0 |  1 |  0
 0 |  1 |  1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We can fetch a single row or a range of rows, but not a set of them:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&amp;gt; SELECT * FROM test WHERE k = 0 AND (c1, c2) IN ((0, 0), (1,1)) ;
Bad Request: line 1:54 missing EOF at &lt;span class=&quot;code-quote&quot;&gt;&apos;,&apos;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Supporting this syntax would return:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; k | c1 | c2
---+----+----
 0 |  0 |  0
 0 |  1 |  1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Being able to fetch these two CQL rows in a single read is important to maintain partition-level isolation.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12701934">CASSANDRA-6875</key>
            <summary>CQL3: select multiple CQL rows in a single partition using IN</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thobbs">Tom Hobbs</assignee>
                                    <reporter username="nff">Nicolas Favre-Felix</reporter>
                        <labels>
                    </labels>
                <created>Mon, 17 Mar 2014 17:25:16 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:51 +0000</updated>
                            <resolved>Thu, 29 May 2014 18:29:44 +0000</resolved>
                                        <fixVersion>2.0.9</fixVersion>
                    <fixVersion>2.1 rc1</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="13938104" author="slebresne" created="Mon, 17 Mar 2014 17:52:50 +0000"  >&lt;p&gt;That&apos;s a relatively nature extension of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4851&quot; title=&quot;CQL3: improve support for paginating over composites&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4851&quot;&gt;&lt;del&gt;CASSANDRA-4851&lt;/del&gt;&lt;/a&gt; and we can definitively support that.&lt;/p&gt;</comment>
                            <comment id="13955776" author="brandon.williams" created="Mon, 31 Mar 2014 21:59:34 +0000"  >&lt;p&gt;Since &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4851&quot; title=&quot;CQL3: improve support for paginating over composites&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4851&quot;&gt;&lt;del&gt;CASSANDRA-4851&lt;/del&gt;&lt;/a&gt; was in 2.0, let&apos;s do this one in 2.0 as well.&lt;/p&gt;</comment>
                            <comment id="13973391" author="thobbs" created="Thu, 17 Apr 2014 20:50:26 +0000"  >&lt;p&gt;Regarding prepared statements, I assume we want to support all of the following:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;... WHERE (c1, c2) IN ?&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;... WHERE (c1, c2) IN (?, ?, ...)&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;... WHERE (c1, c2) IN ((?, ?), (?, ?), ...)&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13980438" author="thobbs" created="Thu, 24 Apr 2014 22:57:26 +0000"  >&lt;p&gt;A first version of the patch is available as a branch here: &lt;a href=&quot;https://github.com/thobbs/cassandra/tree/CASSANDRA-6875-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/thobbs/cassandra/tree/CASSANDRA-6875-2.0&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Note that the first commit just splits up &lt;tt&gt;SelectStatement.RawStatement.prepare()&lt;/tt&gt; into smaller functions, so you&apos;ll get a more useful diff this way: &lt;a href=&quot;https://github.com/thobbs/cassandra/compare/3808c2b35993fed50554f13a73b2444afb598715...CASSANDRA-6875-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/thobbs/cassandra/compare/3808c2b35993fed50554f13a73b2444afb598715...CASSANDRA-6875-2.0&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;After review, I&apos;ll make a 2.1 version of the changes.&lt;/p&gt;</comment>
                            <comment id="13983930" author="brandon.williams" created="Tue, 29 Apr 2014 03:04:36 +0000"  >&lt;p&gt;Moving this back to &apos;bug&apos;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mfiguiere&quot; class=&quot;user-hover&quot; rel=&quot;mfiguiere&quot;&gt;mfiguiere&lt;/a&gt;, because anything that thrift can do that CQL can&apos;t is a bug.&lt;/p&gt;</comment>
                            <comment id="13984098" author="mfiguiere" created="Tue, 29 Apr 2014 07:40:53 +0000"  >&lt;p&gt;All right. Makes sense.&lt;/p&gt;</comment>
                            <comment id="13985587" author="slebresne" created="Wed, 30 Apr 2014 14:52:39 +0000"  >&lt;p&gt;The overall principle looks good, but I feel this could use some more comments and/or made a little more clear. Mainly, the &lt;tt&gt;isMultiColumn&lt;/tt&gt; path in &lt;tt&gt;SelectStatement.buildBound&lt;/tt&gt; looks weird at face value: we&apos;re inside a loop that populates a &lt;tt&gt;ColumnNameBuilder&lt;/tt&gt;, but the &lt;tt&gt;isMultiColumn&lt;/tt&gt; path completely ignores both the iterated object and the builder. This work because it relies on the fact that when there is a multi-column restriction then it&apos;s the only one restriction (which is duplicated in the &lt;tt&gt;SelectStatement.columnRestrictions&lt;/tt&gt; array), and that the value from such restriction is not a single column value but rather a fully built composite serialized value (which is not self evident from the method naming in particular).  But it&apos;s hard to piece it all that together when you look at &lt;tt&gt;buildBound&lt;/tt&gt; currently.  Some comments would help, but I&apos;d prefer going even further and move the &lt;tt&gt;isMultiColumn&lt;/tt&gt; path outside of the loop (by looking up first if the first restriction in &lt;tt&gt;columnRestrictions&lt;/tt&gt; is a multi-column one or not) since it has no reason to be in the loop. In fact, I&apos;d go a tad further by making SelectStatement abstract and have 2 subClass, one for single-column restrictions with a &lt;tt&gt;SingleColumnRelation[] columnRestrictions&lt;/tt&gt; array field as we have now, and one for multi-column that has just one non-array &lt;tt&gt;MultiColumnRestriction columnsRestriction&lt;/tt&gt; field. After all, both cases exclude one another in the current implementation.&lt;/p&gt;

&lt;p&gt;Somewhat related, I&apos;m slightly afraid that the parts about multi-column restrictions returning fully serialized composites (through Tuples.Value.get()) will not play nice with the 2.1 code, where we don&apos;t manipulate composites as opaque ByteBuffers anymore (concretely, Tuples will serialize the composite, but SelectStatement will have to deserialize it back right away to get a Composite, which will be both ugly and inefficient).  So to avoid having to change everything on merge, I think it would be cleaner to make Tuples.Value return a list of (individual column) values instead of just one, and let SelectStatement build back the full composite name using a ColumnNameBuilder.  Especially if you make the per-column and multi-column paths a tad more separated as suggested above, I suspect it might clarify things a bit.  &lt;/p&gt;

&lt;p&gt;Other than that, a bunch of more minor comments and nits:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The &lt;tt&gt;SelectStatement.RawStatement.prepare()&lt;/tt&gt; re-org patch breaks proper indentation at places (for instance, the indentation of parameters to &apos;new ColumnSpecification&apos; in the first branch of udpateSingleColumnRestriction, though there is a few other places). Would be nice to fix those.&lt;/li&gt;
	&lt;li&gt;Can&apos;t we use &lt;tt&gt;QueryProcessor.instance.getPrepared&lt;/tt&gt; instead of creating a only-for-test &lt;tt&gt;QueryProcessor.staticGetPrepared&lt;/tt&gt;? Or at the very least leave such shortcuts in the tests where it belongs.&lt;/li&gt;
	&lt;li&gt;In Tuples.Literal.prepare, I&apos;d prefer good ol&apos;fashion indexed loop to iterate over 2 lists (feels clearer, and saves the allocator creation as a bonus).&lt;/li&gt;
	&lt;li&gt;In Tuples.Raw.makeInReceiver should probably be called makeReceiver (it&apos;s not related to &quot;IN&quot;). I&apos;d also drop the spaces in the string generated (if only for consistency with the string generated in INRaw). As a side node, Raw.makeReceiver uses indexed iteration while INRaw.makeInReceiver don&apos;t, can&apos;t we make both consistent style wise for OCD sakes?&lt;/li&gt;
	&lt;li&gt;Why make methods of CQLStatement abstract (it&apos;s an interface)?  Also, I&apos;d rather add the QueryOptions parameter to the existing executeInternal and default to QueryOptions.DEFAULT when calling it, rather than having 2 methods. Though tbh, my preference would be to move the tests to dtest and leave those somewhat unrelated changes to another ticket, see below.&lt;/li&gt;
	&lt;li&gt;SingleColumnRelation.previousInTuple is now unused but not removed.&lt;/li&gt;
	&lt;li&gt;We could save one list allocation (instead of both toCreate and toUpdate) in SelectStatement.updateRestrictionsForRelation (for EQ and IN, we know it can only be a create, and for slices we can lookup with getExisting).&lt;/li&gt;
	&lt;li&gt;In Restriction, the &lt;tt&gt;values&lt;/tt&gt; method is already at top-level, no reason to re-declare it for EQ.&lt;/li&gt;
	&lt;li&gt;It bothers me to start adding unit tests for CQL queries when all of our CQL tests are currently in dtest. I&apos;d &lt;b&gt;much&lt;/b&gt; rather keep it all in the dtests to avoid the confusion on where is what tested.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13986178" author="thobbs" created="Wed, 30 Apr 2014 22:40:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;It bothers me to start adding unit tests for CQL queries when all of our CQL tests are currently in dtest. I&apos;d much rather keep it all in the dtests to avoid the confusion on where is what tested.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I went with unit tests for a couple of reasons.  The main one is that we can&apos;t use prepared statements with the dtests right now (as far as I can tell).  The other is that it&apos;s a lot faster to work with unit tests than dtests here, and a distributed setup isn&apos;t really required for any of these tests.  We should definitely have a discussion about where and how to test in general (maybe in a dev ML thread), but my feeling is that dtests are good for:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Testing end-to-end&lt;/li&gt;
	&lt;li&gt;Tests that require more than one node&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Otherwise, if it&apos;s reasonable to do in a unit test, I don&apos;t see why we wouldn&apos;t do it there.  FWIW, if we could use prepared statements in the dtests, I would also add some of the prepared statement test cases from the unit tests there.&lt;/p&gt;

&lt;p&gt;All of your other suggestions sound good, thanks!&lt;/p&gt;</comment>
                            <comment id="13986466" author="slebresne" created="Thu, 1 May 2014 09:35:45 +0000"  >&lt;blockquote&gt;&lt;p&gt;we can&apos;t use prepared statements with the dtests right now (as far as I can tell)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We can, see cql_prepared_test.py (arguably our number of tests for prepared statement is deeply lacking, but it&apos;s possible to have some).&lt;/p&gt;

&lt;p&gt;On the more general question of where tests should go, we could have a debate I suppose (but definitively not here), but frankly, I don&apos;t think there is very many downside to having the tests in the dtests and since we have tons of them there already, I&apos;d much rather not waste precious time at changing for the sake of change. But quickly, the reasons why I think dtests are really not that bad here:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;it doesn&apos;t get a whole lot more end-to-end than the CQL tests imo.&lt;/li&gt;
	&lt;li&gt;dtests feels to me a lot more readable and easier to work with. Mainly because for that kind of tests python is just more comfortable/quick to get things done.&lt;/li&gt;
	&lt;li&gt;there &lt;b&gt;is&lt;/b&gt; a few of the CQL dtests where we do want a distributed setup, like CAS tests. Of course we could left those in dtests and move the rest in the unit test suite, but keeping all CQL tests at the same place just feels simpler (you don&apos;t duplicate all those small utility functions that you invariably need to make tests easier).&lt;/li&gt;
	&lt;li&gt;I work with unit tests and dtests daily, and it honestly is not at all my experience that working with unit tests is a &quot;lot faster&quot;. Quite the contrary in fact. I&apos;m willing to admit that one may be more comfortable with one suite or the other, but I&apos;ll fight to the death the concept that &quot;unit test are a &lt;b&gt;lot&lt;/b&gt; faster to work with&quot; as an absolute truth.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I&apos;ll note the CQL dtests are not perfect. They could use being reorganized a bit, and we can speed them up dramatically by not spinning up a cluster on every test. That said, fixing those issue is likely simpler than migrating all the existing tests back to the unit tests.&lt;/p&gt;

&lt;p&gt;All this said, to focus back on this issue, I&apos;d rather keep CQL tests to dtests for now (even if we do start a debate on changing that fact on dev list), but I won&apos;t block the issue if that&apos;s not the case. That remark was in the category &quot;minor comments&quot;.&lt;/p&gt;</comment>
                            <comment id="13986584" author="enigmacurry" created="Thu, 1 May 2014 13:48:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;We can, see cql_prepared_test.py (arguably our number of tests for prepared statement is deeply lacking, but it&apos;s possible to have some).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; Is that test possibly uncommitted? I actually don&apos;t have that test in my repo.&lt;/p&gt;</comment>
                            <comment id="13986597" author="slebresne" created="Thu, 1 May 2014 13:57:40 +0000"  >&lt;p&gt;Ahah, it is uncommitted. Well I just did commit it for info. It&apos;s just one uninteresting test though, not sure why I never committed it.&lt;/p&gt;</comment>
                            <comment id="13986770" author="thobbs" created="Thu, 1 May 2014 17:04:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;We can, see cql_prepared_test.py (arguably our number of tests for prepared statement is deeply lacking, but it&apos;s possible to have some).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ah, thanks, good to know.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;ll fight to the death the concept that &quot;unit test are a lot faster to work with&quot; as an absolute truth.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Don&apos;t worry, I&apos;m not going to challenge you to a duel &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.  It&apos;s not an absolute truth, but it&apos;s easy to do things like run a unit test with the debugger on, which makes a big difference in some cases.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;fixing those issue is likely simpler than migrating all the existing tests back to the unit tests.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m definitely not suggesting moving any existing dtests to unit tests.  I&apos;m just proposing that we allow some mix of unit tests and dtests for newly written tests.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;we could have a debate I suppose (but definitively not here)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Do you mind if I start a dev ML thread?  It would be good to get input from other devs and QA.&lt;/p&gt;
</comment>
                            <comment id="13986810" author="slebresne" created="Thu, 1 May 2014 17:48:25 +0000"  >&lt;blockquote&gt;&lt;p&gt;Do you mind if I start a dev ML thread?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Absolutely not.&lt;/p&gt;</comment>
                            <comment id="13986889" author="thobbs" created="Thu, 1 May 2014 19:15:57 +0000"  >&lt;p&gt;After thinking more closely about splitting up SelectStatement into two subclasses for single-column and multi-column restrictions, I&apos;m not 100% convinced that&apos;s the best path.&lt;/p&gt;

&lt;p&gt;For example, suppose you have a query like &lt;tt&gt;SELECT * FROM foo WHERE key=0 AND c1 &amp;gt; 0 AND (c1, c2) &amp;lt; (2, 3)&lt;/tt&gt;.  We could a) require it to be written like &lt;tt&gt;(c1) &amp;gt; (0) AND (c1, c2) &amp;lt; (2, 3)&lt;/tt&gt;, or b) accept that syntax and correctly reduce the expressions to a single multi-column slice restriction.  I&apos;m not sure that option (b) would be clearer than keeping the restrictions separate.&lt;/p&gt;

&lt;p&gt;I can also imagine us supporting something like &lt;tt&gt;SELECT ... WHERE key=0 AND c1=0 AND (c2, c3) &amp;gt; (1, 2)&lt;/tt&gt; in the future.  Of course, we could also require this to be written differently (&lt;tt&gt;(c1, c2, c3) &amp;gt; (0, 1, 2) AND (c1) &amp;lt;= (0)&lt;/tt&gt; or reduce it to a single multi-column slice restriction.  I&apos;m just pointing out that this may become less clear than simply improving the bounds-building code (which I agree is needed).&lt;/p&gt;
</comment>
                            <comment id="13987526" author="slebresne" created="Fri, 2 May 2014 09:17:55 +0000"  >&lt;p&gt;I don&apos;t disagree, the split I&apos;m suggesting is not absolutely future proof, and we&apos;ll need to find something better in the long run. But that don&apos;t change the fact that storing multi-column restriction in an array when we only use one is misleading and error prone as of this patch imo. I mainly meant the splitting as a way to support what we do support today more cleanly, but I do absolutely think SelectStatement will require much serious refactoring sooner than later. There&apos;s &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4762&quot; title=&quot;Support IN clause for any clustering column&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4762&quot;&gt;&lt;del&gt;CASSANDRA-4762&lt;/del&gt;&lt;/a&gt; too that we will want to get at some point (which, it&apos;s worth mentioning, is made slightly less urgent by this ticket because it covers some of the same cases, though it&apos;s not fully equivalent) that will complicate matters here.&lt;/p&gt;

&lt;p&gt;So anyway, I&apos;m all for a third option that is both clean and future proof, but I&apos;m coming short here right now. Or rather, I see ways to get there, but they require more refactoring than is reasonable for a 2.0 target. So I went with the suggestion that felt cleaner, if not too future proof &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. But if you prefer not do the class splitting, I can live with that as long as we maybe split buildBound and add some comments.&lt;/p&gt;</comment>
                            <comment id="13992153" author="thobbs" created="Wed, 7 May 2014 19:46:46 +0000"  >&lt;p&gt;It turns out that the tuple notation allows for non-contiguous slices when &lt;tt&gt;CLUSTERING ORDER&lt;/tt&gt; specifies some reversed comparators.  For example, with current 2.0:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh:ks&amp;gt; create table foo (a int, b int, c int, PRIMARY KEY (a, b, c)) WITH CLUSTERING ORDER BY (b DESC, c ASC);
cqlsh:ks&amp;gt; INSERT INTO foo (a, b, c) VALUES (0, 2, 0);
cqlsh:ks&amp;gt; INSERT INTO foo (a, b, c) VALUES (0, 1, 0);
cqlsh:ks&amp;gt; INSERT INTO foo (a, b, c) VALUES (0, 1, 1);
cqlsh:ks&amp;gt; INSERT INTO foo (a, b, c) VALUES (0, 0, 0);
cqlsh:ks&amp;gt; SELECT * FROM foo WHERE a=0;

 a | b | c
---+---+---
 0 | 2 | 0
 0 | 1 | 0
 0 | 1 | 1
 0 | 0 | 0

(4 rows)

cqlsh:ks&amp;gt; SELECT * FROM foo WHERE a=0 AND (b, c) &amp;gt; (1, 0);

 a | b | c
---+---+---
 0 | 2 | 0

(1 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The correct query response would be two rows: &lt;tt&gt;(0, 2, 0) and (0, 1, 1)&lt;/tt&gt;, which requires two slices.  We could of course build bounds for two slices, but I think this exposes a deeper problem: how does a user get everything in the partition after &lt;tt&gt;(0, 1, 0)&lt;/tt&gt;?  It is not possible to express this with tuple notation alone.  You need to be able to do &lt;tt&gt;WHERE a=0 AND ((b=1 AND c &amp;gt; 0) OR b &amp;lt; 1)&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The scope of this ticket doesn&apos;t really include fixing that, so I can maintain the current behavior here.  We will eventually need to add support for disjunctions, though.&lt;/p&gt;</comment>
                            <comment id="13993078" author="thobbs" created="Thu, 8 May 2014 20:35:13 +0000"  >&lt;p&gt;Okay, most of your concerns should be addressed on the &lt;a href=&quot;https://github.com/thobbs/cassandra/compare/3808c2b35993fed50554f13a73b2444afb598715...CASSANDRA-6875-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;same branch&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;As I mentioned, I&apos;ve kept the same behavior for slices over mixed-asc/desc comparators; I&apos;ll wait for your response to decide what to do about that.&lt;/p&gt;

&lt;p&gt;Tuples.Value no longer returns serialized values, so &lt;tt&gt;buildBounds&lt;/tt&gt; takes care of that work.  It seemed cleanest to just split out different functions for building the different types of multi-column bounds instead of fitting it all into one loop.&lt;/p&gt;

&lt;p&gt;I did try moving MultiColumnRestrictions into a separate attribute in SelectStatement, but that didn&apos;t seem to make things much clearer.  The column names that the restriction applies to would need to be separately tracked.  When processing restrictions, you would have to refer back to that list and check it or update it.  I think the current behavior is reasonably clear if you think of it like this: SelectStatement.columnRestrictions tracks restrictions on each column; in the case of multi-column restrictions, some columns may share a single restriction object.&lt;/p&gt;

&lt;p&gt;Once ASF mail is working again, I&apos;ll start that thread about tests on the dev ML.&lt;/p&gt;</comment>
                            <comment id="13996581" author="slebresne" created="Tue, 13 May 2014 16:36:52 +0000"  >&lt;p&gt;I haven&apos;t looked at that last version yet (but will try to shortly), but something occured to me. The patch currently use CompositeType for tuple markers (and thus tuple values must be serialized following CompositeType). We shouldn&apos;t do that. CompositeType is a type that is never used by the native protocol so 1) it will appear like a &quot;custom type&quot; to drivers and 2) the composite encoding is inconsistent with the rest of the encodings and in particular the end-of-component that said encoding contains is completely useless. This is basically the same problem than &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7209&quot; title=&quot;Consider changing UDT serialization format before 2.1 release.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7209&quot;&gt;&lt;del&gt;CASSANDRA-7209&lt;/del&gt;&lt;/a&gt;, we shouldn&apos;t commit to such inadequate encoding.&lt;/p&gt;

&lt;p&gt;Another way to put it is that this patch introduces the concept of tuple values in the native protocol, but we don&apos;t have such type. So maybe the right way to go would be to introduce such tuple type first (which would really just be some form of anymous user type) and use that. Of course, adding such type is even more out of scope for 2.0 than this ticket already is. So i think we may want to introduce such tuple type in 2.1 but I suppose we could still commit this to 2.0 but with the right encoding (there is no reason not to reuse the one for user type from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7209&quot; title=&quot;Consider changing UDT serialization format before 2.1 release.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7209&quot;&gt;&lt;del&gt;CASSANDRA-7209&lt;/del&gt;&lt;/a&gt;) and just some simple TupleType (that won&apos;t have more support in 2.0 that what this issue does; it will be exposed to drivers as a custom type for 2.0 but I don&apos;t think there is anything we can do about that one).&lt;/p&gt;</comment>
                            <comment id="13999757" author="slebresne" created="Fri, 16 May 2014 11:52:20 +0000"  >&lt;p&gt;I&apos;ve created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7248&quot; title=&quot;Tuple type&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7248&quot;&gt;&lt;del&gt;CASSANDRA-7248&lt;/del&gt;&lt;/a&gt; for the more general support of tuple types discussed above. I&apos;ll note that imo the correct course of action would be to postpone this to 2.1 and base it on top of that &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7248&quot; title=&quot;Tuple type&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7248&quot;&gt;&lt;del&gt;CASSANDRA-7248&lt;/del&gt;&lt;/a&gt;. This would make it much easier on the client drivers anyway since they&apos;ll have support for the TupleType in the v3 protocol, while if we commit this to 2.0 they won&apos;t and will have to special case for it. Also, the changes here are far from trivial so it would also make sense in term of &quot;not introducing risky new features&quot; in a minor release.&lt;/p&gt;

&lt;p&gt;Though if we absolutely insist on getting this in 2.0, we can just extract the TupleTyple AbstractType from the &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7248&quot; title=&quot;Tuple type&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7248&quot;&gt;&lt;del&gt;CASSANDRA-7248&lt;/del&gt;&lt;/a&gt; patch and use that here.&lt;/p&gt;</comment>
                            <comment id="14004088" author="thobbs" created="Tue, 20 May 2014 22:49:58 +0000"  >&lt;p&gt;I&apos;ve backported TupleType from 7248 and pushed my changes to the same branch.  (I merged in cassandra-2.0, so let me know if you&apos;d like a rebase or anything.)&lt;/p&gt;</comment>
                            <comment id="14004951" author="slebresne" created="Wed, 21 May 2014 17:25:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;As I mentioned, I&apos;ve kept the same behavior for slices over mixed-asc/desc comparators; I&apos;ll wait for your response to decide what to do about that.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s definitively a problem and we should fix it. I&apos;ve created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7281&quot; title=&quot;SELECT on tuple relations are broken for mixed ASC/DESC clustering order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7281&quot;&gt;&lt;del&gt;CASSANDRA-7281&lt;/del&gt;&lt;/a&gt; for that.  As far as this patch goes, as long as it preserve correct behavior for all-ASC or all-DESC (which I believe it does), we can leave the rest to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7281&quot; title=&quot;SELECT on tuple relations are broken for mixed ASC/DESC clustering order&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7281&quot;&gt;&lt;del&gt;CASSANDRA-7281&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The patch lgtm with 2 minor nits (and you will have to rebase it before commit btw):&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;In buildBound, I believe we can as well check restriction[ 0], saving the iterator creation.&lt;/li&gt;
	&lt;li&gt;There&apos;s an unecessary import in QueryProcessor (of VisibleForTesting)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;That said, I&apos;m still a bit uncomfortable pushing this in 2.0 given where we are of the 2.0 cycle. But if I&apos;m the only one feeling this way, I suppose I can shut up (and so +1 minus that caveat).&lt;/p&gt;</comment>
                            <comment id="14006356" author="thobbs" created="Thu, 22 May 2014 19:22:10 +0000"  >&lt;p&gt;Thanks! Committed with the nits fixed.&lt;/p&gt;</comment>
                            <comment id="14006950" author="slebresne" created="Fri, 23 May 2014 07:36:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; Can you bump the CQL version in QueryProcessor and update the CQL doc accordingly too?&lt;/p&gt;</comment>
                            <comment id="14007313" author="thobbs" created="Fri, 23 May 2014 16:22:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; done.  Thanks for catching that.&lt;/p&gt;</comment>
                            <comment id="14009075" author="wtmitchell3" created="Mon, 26 May 2014 20:38:27 +0000"  >&lt;p&gt;To try this out, I cobbled up a test case by accessing the TupleType directly on the client side, as this feature is not yet supported in the Java driver.  My approach was to serialize my two ordering column values, then use TupleType.buildValue() to concatenate them into a single ByteBuffer, build a List of all these, then use serialize on a ListType&amp;lt;ByteBuffer&amp;gt; instance to get a single ByteBuffer representing the entire list, and bind that using setBytesUnsafe().  I&apos;m not totally sure of all this, but it seems reasonable.  &lt;/p&gt;

&lt;p&gt;My SELECT statement syntax followed the first of the three Tyler suggested: ... WHERE (c1, c2) IN ?, as this allows the statement to be prepared only once, irrespective of the number of compound keys provided.  &lt;/p&gt;

&lt;p&gt;What I saw was the following traceback on the server:&lt;br/&gt;
14/05/26 14:33:09 ERROR messages.ErrorMessage: Unexpected exception during request&lt;br/&gt;
java.util.NoSuchElementException&lt;br/&gt;
	at java.util.LinkedHashMap$LinkedHashIterator.nextEntry(LinkedHashMap.java:396)&lt;br/&gt;
	at java.util.LinkedHashMap$ValueIterator.next(LinkedHashMap.java:409)&lt;br/&gt;
	at org.apache.cassandra.cql3.statements.SelectStatement.buildMultiColumnInBound(SelectStatement.java:941)&lt;br/&gt;
	at org.apache.cassandra.cql3.statements.SelectStatement.buildBound(SelectStatement.java:814)&lt;br/&gt;
	at org.apache.cassandra.cql3.statements.SelectStatement.getRequestedBound(SelectStatement.java:977)&lt;br/&gt;
	at org.apache.cassandra.cql3.statements.SelectStatement.makeFilter(SelectStatement.java:444)&lt;br/&gt;
	at org.apache.cassandra.cql3.statements.SelectStatement.getSliceCommands(SelectStatement.java:340)&lt;br/&gt;
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:210)&lt;br/&gt;
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:61)&lt;br/&gt;
	at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:158)&lt;br/&gt;
	at org.apache.cassandra.cql3.QueryProcessor.processPrepared(QueryProcessor.java:309)&lt;br/&gt;
	at org.apache.cassandra.transport.messages.ExecuteMessage.execute(ExecuteMessage.java:132)&lt;br/&gt;
	at org.apache.cassandra.transport.Message$Dispatcher.messageReceived(Message.java:304)&lt;/p&gt;

&lt;p&gt;Stepping through the code, it appears to have analyzed my statement correctly.  In BuildMultiColumnInBound, splitInValues contains 1426 tuples, which is the number I intended to pass.  The names parameter identifies two columns, createdate and emailcrypt.  The loop executes twice, but on the third iteration there are no more elements in names, thus the exception. &lt;/p&gt;

&lt;p&gt;Moving the construction of the iterator within the loop fixed my Exception.  The code still looks suspect, though, as it calculates a bound b based on whether the first column is reversed, then uses bound, not b, in the following statement.  I&apos;ve not researched which would be correct, as this appears closely related to the fix Sylvain just developed for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7105&quot; title=&quot;SELECT with IN on final column of composite and compound primary key fails&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7105&quot;&gt;&lt;del&gt;CASSANDRA-7105&lt;/del&gt;&lt;/a&gt;.  In my test case, where the columns were declared as DESC, the code as fixed below did return all the expected rows. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        TreeSet&amp;lt;ByteBuffer&amp;gt; inValues = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TreeSet&amp;lt;&amp;gt;(isReversed ? cfDef.cfm.comparator.reverseComparator : cfDef.cfm.comparator);
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (List&amp;lt;ByteBuffer&amp;gt; components : splitInValues)
        {
            ColumnNameBuilder nameBuilder = builder.copy();
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (ByteBuffer component : components)
                nameBuilder.add(component);

            Iterator&amp;lt;CFDefinition.Name&amp;gt; iter = names.iterator();
            Bound b = isReversed == isReversedType(iter.next()) ? bound : Bound.reverse(bound);
            inValues.add((bound == Bound.END &amp;amp;&amp;amp; nameBuilder.remainingCount() &amp;gt; 0) ? nameBuilder.buildAsEndOfRange() : nameBuilder.build());
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;(inValues);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;  

&lt;p&gt;P.S. I changed my test configuration to declare the ordering columns as ASC instead of DESC and reran the tests.  There was no failure with the code as changed.  So apparently the comparison of bound == and not b == works fine, which should mean that both iter and b can be dropped.  &lt;/p&gt;</comment>
                            <comment id="14009846" author="thobbs" created="Tue, 27 May 2014 16:13:30 +0000"  >&lt;p&gt;Good analysis, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=wtmitchell3&quot; class=&quot;user-hover&quot; rel=&quot;wtmitchell3&quot;&gt;wtmitchell3&lt;/a&gt;.  We shouldn&apos;t need to adjust the bound for the comparator at all for IN queries (and the iterator was obviously being used incorrectly anyway).  6875-part2.txt fixes that and adds some unit test coverage for IN queries on reversed comparators and IN queries with more items than the number of components in the comparator..&lt;/p&gt;</comment>
                            <comment id="14012270" author="slebresne" created="Thu, 29 May 2014 10:45:11 +0000"  >&lt;p&gt;Mostly looks good, but for the same reasons than in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7105&quot; title=&quot;SELECT with IN on final column of composite and compound primary key fails&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7105&quot;&gt;&lt;del&gt;CASSANDRA-7105&lt;/del&gt;&lt;/a&gt;, we shouldn&apos;t test &lt;tt&gt;bound == END&lt;/tt&gt; but rather &lt;tt&gt;eocBound == END&lt;/tt&gt;. Attaching a part2-v2 that simply change that and adds one test that exercise the problem. +1 from me with that.&lt;/p&gt;</comment>
                            <comment id="14012665" author="thobbs" created="Thu, 29 May 2014 18:29:44 +0000"  >&lt;p&gt;Thanks, committed the v2 patch.&lt;/p&gt;</comment>
                            <comment id="16358561" author="datta" created="Fri, 9 Feb 2018 15:33:35 +0000"  >&lt;p&gt;Is there any other possible way to compare multi column in IN clause (other than clustering key)?&#160;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12738176">CASSANDRA-7854</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12647345" name="6875-part2-v2.txt" size="7293" author="slebresne" created="Thu, 29 May 2014 10:45:11 +0000"/>
                            <attachment id="12646927" name="6875-part2.txt" size="6132" author="thobbs" created="Tue, 27 May 2014 16:13:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>380274</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 40 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1tirz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>380557</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>