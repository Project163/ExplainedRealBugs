<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:07:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13346] Failed unregistering mbean during drop keyspace</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13346</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;All node throw exceptions about materialized views during drop keyspace:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
WARN  [MigrationStage:1] 2017-03-16 16:54:25,016 ColumnFamilyStore.java:535 - Failed unregistering mbean: org.apache.cassandra.db:type=Tables,keyspace=test20160810,table=unit_by_account
java.lang.NullPointerException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
        at java.util.concurrent.ConcurrentHashMap.replaceNode(ConcurrentHashMap.java:1106) ~[na:1.8.0_121]
        at java.util.concurrent.ConcurrentHashMap.remove(ConcurrentHashMap.java:1097) ~[na:1.8.0_121]
        at java.util.concurrent.ConcurrentHashMap$KeySetView.remove(ConcurrentHashMap.java:4569) ~[na:1.8.0_121]
        at org.apache.cassandra.metrics.TableMetrics.release(TableMetrics.java:712) ~[apache-cassandra-3.9.0.jar:3.9.0]
        at org.apache.cassandra.db.ColumnFamilyStore.unregisterMBean(ColumnFamilyStore.java:570) [apache-cassandra-3.9.0.jar:3.9.0]
        at org.apache.cassandra.db.ColumnFamilyStore.invalidate(ColumnFamilyStore.java:527) [apache-cassandra-3.9.0.jar:3.9.0]
        at org.apache.cassandra.db.ColumnFamilyStore.invalidate(ColumnFamilyStore.java:517) [apache-cassandra-3.9.0.jar:3.9.0]
        at org.apache.cassandra.db.Keyspace.unloadCf(Keyspace.java:365) [apache-cassandra-3.9.0.jar:3.9.0]
        at org.apache.cassandra.db.Keyspace.dropCf(Keyspace.java:358) [apache-cassandra-3.9.0.jar:3.9.0]
        at org.apache.cassandra.config.Schema.dropView(Schema.java:744) [apache-cassandra-3.9.0.jar:3.9.0]
        at org.apache.cassandra.schema.SchemaKeyspace.lambda$mergeSchema$373(SchemaKeyspace.java:1287) [apache-cassandra-3.9.0.jar:3.9.0]
        at java.lang.Iterable.forEach(Iterable.java:75) ~[na:1.8.0_121]
        at org.apache.cassandra.schema.SchemaKeyspace.mergeSchema(SchemaKeyspace.java:1287) [apache-cassandra-3.9.0.jar:3.9.0]
        at org.apache.cassandra.schema.SchemaKeyspace.mergeSchemaAndAnnounceVersion(SchemaKeyspace.java:1256) [apache-cassandra-3.9.0.jar:3.9.0]
        at org.apache.cassandra.db.DefinitionsUpdateVerbHandler$1.runMayThrow(DefinitionsUpdateVerbHandler.java:51) ~[apache-cassandra-3.9.0.jar:3.9.0]
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[apache-cassandra-3.9.0.jar:3.9.0]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_121]
        at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_121]
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[na:1.8.0_121]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) ~[na:1.8.0_121]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) ~[na:1.8.0_121]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Cassandra 3.9&lt;/p&gt;</environment>
        <key id="13056967">CASSANDRA-13346</key>
            <summary>Failed unregistering mbean during drop keyspace</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Lerh Low">Lerh Chuan Low</assignee>
                                    <reporter username="gabor.auth">G&#225;bor Auth</reporter>
                        <labels>
                            <label>lhf</label>
                    </labels>
                <created>Fri, 17 Mar 2017 11:15:07 +0000</created>
                <updated>Fri, 15 May 2020 07:59:48 +0000</updated>
                            <resolved>Tue, 6 Jun 2017 18:59:03 +0000</resolved>
                                        <fixVersion>3.0.14</fixVersion>
                    <fixVersion>3.11.0</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Feature/Materialized Views</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="15942114" author="jeromatron" created="Sun, 26 Mar 2017 03:21:06 +0000"  >&lt;p&gt;Is there any context around this?  Were you doing any other schema modification at the time?  Also was there any other effect other than this error in the logs?&lt;/p&gt;</comment>
                            <comment id="15954427" author="andrew efimov" created="Tue, 4 Apr 2017 00:59:57 +0000"  >&lt;p&gt;Hi Jeremy, G&#225;bor&lt;br/&gt;
I have the same issue in 3.10, in my case, this occurs only for materialized views at the end of the test phase.&lt;br/&gt;
Also I am using org.cassandraunit for testing in embedded mode.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.NullPointerException: null
	at java.util.concurrent.ConcurrentHashMap.replaceNode(ConcurrentHashMap.java:1106) ~[na:1.8.0_121]
	at java.util.concurrent.ConcurrentHashMap.remove(ConcurrentHashMap.java:1097) ~[na:1.8.0_121]
	at java.util.concurrent.ConcurrentHashMap$KeySetView.remove(ConcurrentHashMap.java:4569) ~[na:1.8.0_121]
	at org.apache.cassandra.metrics.TableMetrics.release(TableMetrics.java:713) ~[cassandra-all-3.10.jar:3.10]
	at org.apache.cassandra.db.ColumnFamilyStore.unregisterMBean(ColumnFamilyStore.java:577) [cassandra-all-3.10.jar:3.10]
	at org.apache.cassandra.db.ColumnFamilyStore.invalidate(ColumnFamilyStore.java:534) [cassandra-all-3.10.jar:3.10]
	at org.apache.cassandra.db.ColumnFamilyStore.invalidate(ColumnFamilyStore.java:524) [cassandra-all-3.10.jar:3.10]
	at org.apache.cassandra.db.Keyspace.unloadCf(Keyspace.java:370) [cassandra-all-3.10.jar:3.10]
	at org.apache.cassandra.db.Keyspace.dropCf(Keyspace.java:363) [cassandra-all-3.10.jar:3.10]
	at org.apache.cassandra.config.Schema.dropView(Schema.java:704) [cassandra-all-3.10.jar:3.10]
	at org.apache.cassandra.schema.SchemaKeyspace.lambda$mergeSchema$17(SchemaKeyspace.java:1313) [cassandra-all-3.10.jar:3.10]
	at java.lang.Iterable.forEach(Iterable.java:75) ~[na:1.8.0_121]
	at org.apache.cassandra.schema.SchemaKeyspace.mergeSchema(SchemaKeyspace.java:1313) [cassandra-all-3.10.jar:3.10]
	at org.apache.cassandra.schema.SchemaKeyspace.mergeSchemaAndAnnounceVersion(SchemaKeyspace.java:1282) [cassandra-all-3.10.jar:3.10]
	at org.apache.cassandra.service.MigrationManager$1.runMayThrow(MigrationManager.java:535) ~[cassandra-all-3.10.jar:3.10]
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[cassandra-all-3.10.jar:3.10]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_121]
	at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_121]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[na:1.8.0_121]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) ~[na:1.8.0_121]
	at org.apache.cassandra.concurrent.NamedThreadFactory.lambda$threadLocalDeallocator$0(NamedThreadFactory.java:79) ~[cassandra-all-3.10.jar:3.10]
	at java.lang.Thread.run(Thread.java:745) ~[na:1.8.0_121]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15954535" author="jjirsa" created="Tue, 4 Apr 2017 04:02:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gabor.auth&quot; class=&quot;user-hover&quot; rel=&quot;gabor.auth&quot;&gt;gabor.auth&lt;/a&gt; - is &lt;tt&gt;test20160810.unit_by_account&lt;/tt&gt; a materialized view as well? &lt;/p&gt;
</comment>
                            <comment id="15954566" author="gabor.auth" created="Tue, 4 Apr 2017 05:17:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt;: yes, as I mentioned in the description: &quot;All node throw exceptions about materialized views during drop keyspace&quot;. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;All nodes throws this exception about all materialized view of the keyspace during drop keyspace command.&lt;/p&gt;</comment>
                            <comment id="15954568" author="gabor.auth" created="Tue, 4 Apr 2017 05:20:07 +0000"  >&lt;p&gt;&quot;Is there any context around this?&quot;&lt;/p&gt;

&lt;p&gt;Hm... I saw only this exception.&lt;/p&gt;

&lt;p&gt;&quot;Were you doing any other schema modification at the time?&quot;&lt;/p&gt;

&lt;p&gt;No, only `DROP KEYSPACE test20160810`.&lt;/p&gt;

&lt;p&gt;&quot;Also was there any other effect other than this error in the logs?&quot;&lt;/p&gt;

&lt;p&gt;As I see, everything is okay but this exception.&lt;/p&gt;</comment>
                            <comment id="15954980" author="andrew efimov" created="Tue, 4 Apr 2017 10:49:38 +0000"  >&lt;p&gt;I guess that the problem may be in the difference of metrics types for Materialized view and Table:&lt;br/&gt;
&lt;tt&gt;at org.apache.cassandra.metrics.TableMetrics.release(TableMetrics.java:713)&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;TableMetrics&lt;/tt&gt; does not find the metrics for view, can only be used for Table.&lt;/p&gt;</comment>
                            <comment id="15955004" author="andrew efimov" created="Tue, 4 Apr 2017 11:11:14 +0000"  >&lt;p&gt;&lt;tt&gt;TableMetrics.release&lt;/tt&gt; does not release metric with name &lt;tt&gt;ViewReadTime&lt;/tt&gt;&lt;br/&gt;
because it is not created, but release method tries to remove this metric with NPE:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;C* 3.10
org.apache.cassandra.metrics.TableMetrics: 669

        // We do not want to capture view mutation specific metrics for a view
        // They only makes sense to capture on the base table
        if (cfs.metadata.isView())
        {
            viewLockAcquireTime = null;
            viewReadTime = null;
        }
        else
        {
            viewLockAcquireTime = createTableTimer(&quot;ViewLockAcquireTime&quot;, cfs.keyspace.metric.viewLockAcquireTime);
            viewReadTime = createTableTimer(&quot;ViewReadTime&quot;, cfs.keyspace.metric.viewReadTime);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15985783" author="lerh low" created="Thu, 27 Apr 2017 00:11:11 +0000"  >&lt;p&gt;This is quite easily reproduced, we just have to create a materialized view and try to drop keyspace. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE KEYSPACE mvtest WITH REPLICATION = { &lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: 1 };
CREATE TABLE mvtest.tobedropped (
    foo &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
    bar text,
    baz text,
    PRIMARY KEY (foo, bar)
);

CREATE MATERIALIZED VIEW mvtest.explosion AS
    SELECT foo, bar, baz FROM mvtest.tobedropped WHERE
    foo IS NOT NULL AND bar IS NOT NULL AND baz IS NOT NULL
PRIMARY KEY (foo, bar, baz);

INSERT INTO mvtest.tobedropped (foo, bar, baz) VALUES (1, &lt;span class=&quot;code-quote&quot;&gt;&apos;baz&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;bokusapp&apos;&lt;/span&gt;);
INSERT INTO mvtest.tobedropped (foo, bar, baz) VALUES (2, &lt;span class=&quot;code-quote&quot;&gt;&apos;baz&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;vitamin&apos;&lt;/span&gt;);
INSERT INTO mvtest.tobedropped (foo, bar, baz) VALUES (2, &lt;span class=&quot;code-quote&quot;&gt;&apos;backgammon&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;gin&apos;&lt;/span&gt;);

DROP KEYSPACE mvtest;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Andrew+Efimov&quot; class=&quot;user-hover&quot; rel=&quot;Andrew Efimov&quot;&gt;Andrew Efimov&lt;/a&gt; mentioned, this seems to be because &lt;tt&gt;ViewLockReadTime&lt;/tt&gt; and &lt;tt&gt;ViewLockAcquireTime&lt;/tt&gt; are both set to null for materialized views (they don&apos;t make sense for materialized views and was decided to be that way based on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10323&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;CASSANDRA-10323&lt;/a&gt;). So the call to &lt;tt&gt;Metrics.getMetrics().get(name.getMetricName())&lt;/tt&gt; returns null, which throws the Exception as the &lt;tt&gt;remove&lt;/tt&gt; method does not allow &lt;tt&gt;null&lt;/tt&gt; values (For the implementation of the set in &lt;tt&gt;allTableMetrics&lt;/tt&gt;. I&apos;ve attached a patch for both 3.0.X and 3.X since it&apos;s a relatively small change - it looks like it&apos;s just a case of trying to unregister a metric from the registry that doesn&apos;t exist so we should just ignore it when it&apos;s &lt;tt&gt;null&lt;/tt&gt; (which is only when it&apos;s releasing view metrics). I&apos;ve retested it on my local and it works...Any feedbacks are welcome! (&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=carlyeks&quot; class=&quot;user-hover&quot; rel=&quot;carlyeks&quot;&gt;carlyeks&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnlwsu&quot; class=&quot;user-hover&quot; rel=&quot;cnlwsu&quot;&gt;cnlwsu&lt;/a&gt;]...?), or guidance on writing tests if necessary (It doesn&apos;t seem like there are any metrics tests though there are metrics dtests, I&apos;ll try taking a look at dtests). &lt;/p&gt;</comment>
                            <comment id="15985916" author="cnlwsu" created="Thu, 27 Apr 2017 03:15:14 +0000"  >&lt;p&gt;+1 for patch. Big +1 for some dtests, the registering and removing of metrics around keyspace and table drops+creations has come up a few times (notice all hard coded entries in &lt;tt&gt;release&lt;/tt&gt; that has drifted in and out of date).&lt;/p&gt;</comment>
                            <comment id="15985942" author="cnlwsu" created="Thu, 27 Apr 2017 03:38:02 +0000"  >&lt;p&gt;so actually taking a second look there may be something more to this. The patch will still work though.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;release&lt;/tt&gt; call is iterating over &lt;tt&gt;all&lt;/tt&gt; registered mbeans, not just the ones for that table so whenever there are metrics that exist in some tables and not others, and gets dropped, it will throw the NPE. It really seems we should not be using a big static map to store these, but just a local one to store the ones we create for that table. The tricky thing is the &quot;all&quot; metrics which span multiple tables but that can probably be handled by getting a list of the columnfamilystore&apos;s and iterating over them instead of trying to keep a separate registry in sync.&lt;/p&gt;

&lt;p&gt;Patch does fix it though and is a much simpler fix.&lt;/p&gt;</comment>
                            <comment id="15985985" author="lerh low" created="Thu, 27 Apr 2017 04:26:26 +0000"  >&lt;p&gt;Hey Chris,&lt;/p&gt;

&lt;p&gt;Thanks for answering. I&apos;ll try to fit dtests into my schedule and take a look at how it works/how to write one. &lt;/p&gt;

&lt;p&gt;With regards to your more recent comment, my impression is &lt;tt&gt;all&lt;/tt&gt; is a hashmap of metric names to their aliases.&lt;br/&gt;
 &lt;tt&gt;allTableMetrics&lt;/tt&gt; is a map of each metric to their set of metrics for each Table (&lt;tt&gt;String, Set&amp;lt;String&amp;gt;&lt;/tt&gt;, which is used in the aggregation metrics over all Tables (e.g Readlatency key will have all the tables&apos; read latency in its Set of values). If we had it use a local one to store the ones we create for the table, then it would be harder to aggregate over all known Tables. &lt;/p&gt;

&lt;p&gt;Open to any suggestions though, as usual &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;</comment>
                            <comment id="15988859" author="cnlwsu" created="Fri, 28 Apr 2017 14:08:01 +0000"  >&lt;p&gt;the &quot;all&quot; map is actually for metrics that have a global representation thats aggregated. For example, theres a global sstables per read metric that aggregates all the individual table and keyspace metrics so you can see the entire nodes sstables per read to see if any are high instead of walking through entire table set to find out.&lt;/p&gt;</comment>
                            <comment id="15990616" author="lerh low" created="Mon, 1 May 2017 06:20:04 +0000"  >&lt;p&gt;Hi Chris,&lt;/p&gt;

&lt;p&gt;While debugging, &lt;tt&gt;all&lt;/tt&gt; is just a map of names to values. I think what you&apos;re referring to is &lt;tt&gt;allTableMetrics&lt;/tt&gt;, which in that case then yep - as you mentioned, the downside is now we would need some way of aggregating over all metrics for the global ones, but if you&apos;d rather it that way I can look into it. &lt;/p&gt;

&lt;p&gt;I&apos;ve also gotten ready a dtest here: &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/1467&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/riptano/cassandra-dtest/pull/1467&lt;/a&gt; Any feedbacks/code style/whatever are more than welcome. &lt;/p&gt;</comment>
                            <comment id="16003693" author="lerh low" created="Tue, 9 May 2017 22:44:32 +0000"  >&lt;p&gt;Thought I should also add, this causes metrics not to be dropped properly, so there will still be metrics in the registry for tables that should have already been dropped as a result of this Exception..&lt;/p&gt;</comment>
                            <comment id="16003766" author="cnlwsu" created="Tue, 9 May 2017 23:42:49 +0000"  >&lt;p&gt;which can potentially be bad since recreating same named table may cause mbean naming conflicts and failures&lt;/p&gt;</comment>
                            <comment id="16015087" author="lerh low" created="Thu, 18 May 2017 02:11:15 +0000"  >&lt;p&gt;Hi Chris,&lt;/p&gt;

&lt;p&gt;Looking into it a little bit more, this is another way to do it - just retain enough information in &lt;tt&gt;allTableMetrics&lt;/tt&gt; so we know what metrics are held by which CF. Or, at least, we can iterate through it to find the metrics that are held for a particular CF, and release all of them. In this case, the changes will look something like this: &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...juiceblender:cassandra-13346&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/trunk...juiceblender:cassandra-13346&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Then &lt;tt&gt;allTableMetrics&lt;/tt&gt; becomes something we keep in sync with the &lt;tt&gt;MetricsRegistry&lt;/tt&gt;. In fact it&apos;s more or less identical or isomorphic to &lt;tt&gt;MetricsRegistry&lt;/tt&gt;. Just with the way we currently register metrics, we use this method: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; getMetricName()
        {
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; MetricRegistry.name(group, type, name, scope);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which adds a &lt;tt&gt;.&lt;/tt&gt; in between each value. &lt;br/&gt;
So that eventually, an entry in my branch&apos;s &lt;tt&gt;allTableMetrics&lt;/tt&gt; looks like so: &lt;br/&gt;
&lt;tt&gt;org.apache.cassandra.metrics:type=Table,keyspace=system_distributed,scope=repair_history,name=TotalDiskSpaceUsed -&amp;gt; The actual metric&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;While &lt;tt&gt;Metrics.getMetrics()&lt;/tt&gt; looks like so: &lt;br/&gt;
&lt;tt&gt;org.apache.cassandra.metrics.Table.BloomFilterFalsePositives.system.built_views -&amp;gt; The actual metric&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;From here, there are a few options forward:&lt;br/&gt;
i) We stick with the original patch&lt;br/&gt;
ii) We go ahead with what&apos;s in the branch, the dtest still works for it.&lt;br/&gt;
iii) We totally get rid of &lt;tt&gt;allTableMetrics&lt;/tt&gt; and just use the existing &lt;tt&gt;MetricsRegistry&lt;/tt&gt;. To make it really safe for the aggregating metrics, I feel we would need some way to construct (or parse) a &lt;tt&gt;MetricName&lt;/tt&gt; object from the String returned from &lt;tt&gt;Metrics.getMetrics()&lt;/tt&gt; (It&apos;s a Map&amp;lt;String, Metric&amp;gt; unfortunately). In this case we will have to iterate over every metric that we ever registered compared to just the table metrics in &lt;tt&gt;allTableMetrics&lt;/tt&gt;, but it should be relatively fine because we don&apos;t release metrics often&lt;br/&gt;
iv) We try and have each CFStore keep a local copy of its TableMetric. When constructing TableMetric for a CFStore, we will have to get a list of CFStores (I would need some guidance on this, from a viewManager somewhere?) and get all their respective gauges and aggregate them that way. Something like iii). &lt;/p&gt;

&lt;p&gt;I&apos;m for either i) or iii), any thoughts? &lt;/p&gt;</comment>
                            <comment id="16015096" author="cnlwsu" created="Thu, 18 May 2017 02:20:29 +0000"  >&lt;p&gt;I like idea of &lt;tt&gt;i&lt;/tt&gt; immediately and &lt;tt&gt;iii&lt;/tt&gt; being done in follow up. It could use some refactoring/cleaning up.&lt;/p&gt;</comment>
                            <comment id="16015193" author="lerh low" created="Thu, 18 May 2017 04:41:33 +0000"  >&lt;p&gt;Let&apos;s go with &lt;tt&gt;i&lt;/tt&gt; then. Would you be able to review and commit please if it&apos;s ok or if anything else needs to be done? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; The dtest is here: &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/1467&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/riptano/cassandra-dtest/pull/1467&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16015197" author="lerh low" created="Thu, 18 May 2017 04:48:29 +0000"  >&lt;p&gt;Sorry, forgot about trunk. Updating. &lt;/p&gt;</comment>
                            <comment id="16015203" author="lerh low" created="Thu, 18 May 2017 04:55:57 +0000"  >&lt;p&gt;Attached, trunk is the same as 3.10.&lt;/p&gt;</comment>
                            <comment id="16015789" author="cnlwsu" created="Thu, 18 May 2017 14:07:08 +0000"  >&lt;p&gt;I cant commit but +1 from me&lt;/p&gt;</comment>
                            <comment id="16016460" author="lerh low" created="Thu, 18 May 2017 20:59:51 +0000"  >&lt;p&gt;Ahhh I see, thanks for going through all that with me though &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16037817" author="jjirsa" created="Mon, 5 Jun 2017 23:06:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnlwsu&quot; class=&quot;user-hover&quot; rel=&quot;cnlwsu&quot;&gt;cnlwsu&lt;/a&gt; / &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Lerh+Low&quot; class=&quot;user-hover&quot; rel=&quot;Lerh Low&quot;&gt;Lerh Low&lt;/a&gt; - just to be clear, which patches here are ready to commit? The ones attached to the JIRA, or the github URL &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...juiceblender:cassandra-13346&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/trunk...juiceblender:cassandra-13346&lt;/a&gt; ? &lt;/p&gt;

</comment>
                            <comment id="16037831" author="lerh low" created="Mon, 5 Jun 2017 23:24:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt; The ones attached to the JIRA &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;</comment>
                            <comment id="16039465" author="jjirsa" created="Tue, 6 Jun 2017 18:59:04 +0000"  >&lt;p&gt;Committed as &lt;tt&gt;40ad3cf4dd384bede595edce4617534ca904f1ed&lt;/tt&gt;, thanks all!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12865234" name="13346-3.0.X.txt" size="1443" author="Lerh Low" created="Thu, 27 Apr 2017 00:01:49 +0000"/>
                            <attachment id="12865235" name="13346-3.X.txt" size="1153" author="Lerh Low" created="Thu, 27 Apr 2017 00:01:49 +0000"/>
                            <attachment id="12868679" name="13346-trunk.txt" size="1153" author="Lerh Low" created="Thu, 18 May 2017 04:55:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[Lerh Low]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 24 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3cf4f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12339942">3.0.13</customfieldvalue>
    <customfieldvalue id="12337348">3.10</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>cnlwsu</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[cnlwsu]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>