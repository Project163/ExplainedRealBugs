<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:47:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7740] Parsing of UDF body is broken</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7740</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The parsing of function body introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7395&quot; title=&quot;Support for pure user-defined functions (UDF)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7395&quot;&gt;&lt;del&gt;CASSANDRA-7395&lt;/del&gt;&lt;/a&gt; is somewhat broken. It blindly parse everything up to &lt;tt&gt;END_BODY&lt;/tt&gt;, which as 2 problems:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;it parse function body as if it was part of the CQL syntax, so anything that don&apos;t happen to be a valid CQL token won&apos;t even parse.&lt;/li&gt;
	&lt;li&gt;something like
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE FUNCTION foo() RETURNS text LANGUAGE JAVA BODY return &quot;END_BODY&quot;; END_BODY;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;will not parse correctly.&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I don&apos;t think we can accept random syntax like that. A better solution (which is the one Postgresql uses) is to pass the function body as a normal string. And in fact I&apos;d be in favor of reusing Postgresql syntax (because why not), that is to have:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE FUNCTION foo() RETURNS text LANGUAGE JAVA AS &apos;return &quot;END_BODY&quot;&apos;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;One minor annoyance might be, for certain languages, the necessity to double every quote inside the string. But in a separate ticket we could introduce Postregsql solution of adding an &lt;a href=&quot;http://www.postgresql.org/docs/9.1/static/sql-syntax-lexical.html#SQL-SYNTAX-DOLLAR-QUOTING&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;alternate syntax for string constants&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12733219">CASSANDRA-7740</key>
            <summary>Parsing of UDF body is broken</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="snazy">Robert Stupp</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                    </labels>
                <created>Mon, 11 Aug 2014 12:02:47 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:37 +0000</updated>
                            <resolved>Thu, 21 Aug 2014 12:25:05 +0000</resolved>
                                        <fixVersion>2.2.0 beta 1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14092730" author="snazy" created="Mon, 11 Aug 2014 12:39:15 +0000"  >&lt;p&gt;note: in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7562&quot; title=&quot;Java source code for UDFs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7562&quot;&gt;&lt;del&gt;CASSANDRA-7562&lt;/del&gt;&lt;/a&gt; I&apos;ve changed parsing a bit and the end marker is &lt;tt&gt;K_END K_BODY&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;But the main point (anything looking like &lt;tt&gt;END BODY&lt;/tt&gt; is recognized as the end of function body) stays. IMO it was the &quot;lesser of two evils&quot; (compared to single-quote-escaping).&lt;/p&gt;

&lt;p&gt;I thought about escaping - e.g. &lt;tt&gt;&apos;&lt;/tt&gt; to &lt;tt&gt;&apos;&apos;&lt;/tt&gt; - but didn&apos;t like it. It might work for Java - but, as you said, other script languages would look really strange.&lt;/p&gt;

&lt;p&gt;Something like&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE FUNCTION ...
BODY
$function$
    return &quot;END BODY&quot;;
$function$
END BODY;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;could work - would assume, that &lt;tt&gt;$function$&lt;/tt&gt; is not used within the body.&lt;/p&gt;

&lt;p&gt;Additionally we could also support that &lt;tt&gt;&apos;&lt;/tt&gt; escaping anyway.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE FUNCTION ...
BODY 
    &apos;return &quot;END BODY&quot;;&apos;
END BODY;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;d personally prefer to implement both (&lt;tt&gt;$function$...$function$&lt;/tt&gt; and string).&lt;/p&gt;

&lt;p&gt;Having that, we could also remove the &lt;tt&gt;K_END K_BODY&lt;/tt&gt; completly and replace &lt;tt&gt;K_BODY&lt;/tt&gt; with &lt;tt&gt;K_AS&lt;/tt&gt; - have no preference for that.&lt;/p&gt;

&lt;p&gt;So this would incorportate three tasks:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;change parsing in cqlsh for &lt;tt&gt;$function$&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;-&lt;del&gt;change parsing in cqlsh to support multi-line strings&lt;/del&gt;- (already supported)&lt;/li&gt;
	&lt;li&gt;change parsing in C*&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14092741" author="slebresne" created="Mon, 11 Aug 2014 13:03:09 +0000"  >&lt;p&gt;Honestly, I&apos;m not sure I understand your arguments. Since we want to accept &quot;free-form&quot; function body, we need to clearly delimit those body and whatever we use, we need clear escape rules. We already have such thing and that&apos;s called string constants. Why would we not reuse that? That&apos;s going to be &lt;b&gt;a lot&lt;/b&gt; easier for all tools.&lt;/p&gt;

&lt;p&gt;So let&apos;s first switch to having body as strings. Then, as as second step, we can add an alternative syntax for strings that do no require to escape single quotes. But there is no reason to limit that syntax to functions, it can just be an alternative string constant syntax. Like Postregsql does. And so this is a separate ticket.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;we could also remove the K_END K_BODY completly and replace K_BODY with K_AS - have no preference for that&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I do strongly prefer &lt;tt&gt;AS&lt;/tt&gt;.&lt;/p&gt;

</comment>
                            <comment id="14092746" author="jkrupan" created="Mon, 11 Aug 2014 13:17:01 +0000"  >&lt;p&gt;PostgreSQL-style dollar-quoted string constants would be nice. See:&lt;br/&gt;
&lt;a href=&quot;http://www.postgresql.org/docs/8.2/static/sql-syntax-lexical.html#SQL-SYNTAX-DOLLAR-QUOTING&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.postgresql.org/docs/8.2/static/sql-syntax-lexical.html#SQL-SYNTAX-DOLLAR-QUOTING&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;But as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; suggested, that should be a global feature of string constants, not limited to this feature.&lt;/p&gt;</comment>
                            <comment id="14092898" author="jbellis" created="Mon, 11 Aug 2014 15:37:43 +0000"  >&lt;p&gt;+1 pg-style string constants&lt;/p&gt;</comment>
                            <comment id="14095934" author="snazy" created="Wed, 13 Aug 2014 18:57:05 +0000"  >&lt;p&gt;FML - this ticket is really essential for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7562&quot; title=&quot;Java source code for UDFs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7562&quot;&gt;&lt;del&gt;CASSANDRA-7562&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7526&quot; title=&quot;Defining UDFs using scripting language directly from CQL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7526&quot;&gt;&lt;del&gt;CASSANDRA-7526&lt;/del&gt;&lt;/a&gt; to work properly. Just coded a unit test - and the CQL parser breaks just because of the sequence near &lt;tt&gt;1d)&lt;/tt&gt; in the snippet below...&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE OR REPLACE FUNCTION jft(val double) RETURNS double LANGUAGE JAVA
BODY
  return Double.valueOf(1d);
END BODY;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;even this one fails...&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;return Double.valueOf(&quot;1&quot;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14097571" author="snazy" created="Thu, 14 Aug 2014 20:20:24 +0000"  >&lt;p&gt;Patch for first string-style variant.&lt;br/&gt;
Will open a separate ticket for pg-style variant.&lt;/p&gt;</comment>
                            <comment id="14098942" author="thobbs" created="Fri, 15 Aug 2014 18:58:57 +0000"  >&lt;p&gt;Can you rebase the patch against current trunk?&lt;/p&gt;</comment>
                            <comment id="14099562" author="snazy" created="Sat, 16 Aug 2014 08:25:40 +0000"  >&lt;p&gt;Rebased against trunk&lt;/p&gt;</comment>
                            <comment id="14100613" author="slebresne" created="Mon, 18 Aug 2014 13:18:21 +0000"  >&lt;p&gt;The attached patch definitively include parts that are not related to this ticket. Please try to keep patches focused on the issue at end. &lt;/p&gt;</comment>
                            <comment id="14100682" author="snazy" created="Mon, 18 Aug 2014 14:26:30 +0000"  >&lt;p&gt;Yes, it contains code from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7562&quot; title=&quot;Java source code for UDFs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7562&quot;&gt;&lt;del&gt;CASSANDRA-7562&lt;/del&gt;&lt;/a&gt; - intention was that 7562 is a &quot;requirement&quot; for this one. Can either remove the 7562 stuff or we wait until 7562 is committed (which makes this ticket&apos;s patch &quot;cleaner&quot;).&lt;/p&gt;</comment>
                            <comment id="14100710" author="slebresne" created="Mon, 18 Aug 2014 14:58:28 +0000"  >&lt;p&gt;Even if the intent is that this should be committed after &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7562&quot; title=&quot;Java source code for UDFs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7562&quot;&gt;&lt;del&gt;CASSANDRA-7562&lt;/del&gt;&lt;/a&gt; (I&apos;d prefer not creating such artificial dependencies for such simple issue, but why not) there still shouldn&apos;t be any code for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7562&quot; title=&quot;Java source code for UDFs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7562&quot;&gt;&lt;del&gt;CASSANDRA-7562&lt;/del&gt;&lt;/a&gt; in there.&lt;/p&gt;</comment>
                            <comment id="14102414" author="thobbs" created="Tue, 19 Aug 2014 16:26:26 +0000"  >&lt;p&gt;I believe this should be committed before &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7562&quot; title=&quot;Java source code for UDFs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7562&quot;&gt;&lt;del&gt;CASSANDRA-7562&lt;/del&gt;&lt;/a&gt; (instead of after) so that we can properly test 7562.&lt;/p&gt;</comment>
                            <comment id="14102737" author="snazy" created="Tue, 19 Aug 2014 19:59:17 +0000"  >&lt;p&gt;New patch with just the &lt;tt&gt;Cql.g&lt;/tt&gt; and &lt;tt&gt;cql3handling.py&lt;/tt&gt; changes.&lt;br/&gt;
No C* code changes necessary.&lt;/p&gt;

&lt;p&gt;EDIT: Will update &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7562&quot; title=&quot;Java source code for UDFs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7562&quot;&gt;&lt;del&gt;CASSANDRA-7562&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7526&quot; title=&quot;Defining UDFs using scripting language directly from CQL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7526&quot;&gt;&lt;del&gt;CASSANDRA-7526&lt;/del&gt;&lt;/a&gt; patches today.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7562&quot; title=&quot;Java source code for UDFs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7562&quot;&gt;&lt;del&gt;CASSANDRA-7562&lt;/del&gt;&lt;/a&gt; first and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7526&quot; title=&quot;Defining UDFs using scripting language directly from CQL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7526&quot;&gt;&lt;del&gt;CASSANDRA-7526&lt;/del&gt;&lt;/a&gt; on top of 7562&lt;/p&gt;</comment>
                            <comment id="14105335" author="slebresne" created="Thu, 21 Aug 2014 12:25:05 +0000"  >&lt;p&gt;lgtm, committed.&lt;/p&gt;

&lt;p&gt;There was a minor error in cql3handling.py in that a &apos;.&apos; was used between the namespace and function name rather than &apos;::&apos; but I fixed that during commit. That said, I&apos;m not sure how much cqlsh likes it: it suggests it for completion but don&apos;t seem too happy after it&apos;s been provided. Not a huge deal but &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt;, could you have a quick look when you have a minute (and ninja-fix if something could be improved)?&lt;/p&gt;</comment>
                            <comment id="14105575" author="thobbs" created="Thu, 21 Aug 2014 16:48:07 +0000"  >&lt;p&gt;I committed some minor corrections as &lt;a href=&quot;https://github.com/apache/cassandra/commit/f6ef8ef4d91e36c0e0b6ea6f74d0de48a695320d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;f6ef8ef4d9&lt;/a&gt;.  It seemed to be working reasonably well for function calls for me.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12726275">CASSANDRA-7526</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12727889">CASSANDRA-7562</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12734245">CASSANDRA-7769</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12662828" name="7740.txt" size="4325" author="snazy" created="Tue, 19 Aug 2014 19:59:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[snazy]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>411247</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 13 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1yr2v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>411239</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>