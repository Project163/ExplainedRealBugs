<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:51:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8613] Regression in mixed single and multi-column relation support</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8613</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In 2.0.6 through 2.0.8, a query like the following was supported:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;SELECT * FROM mytable WHERE clustering_0 = ? AND (clustering_1, clustering_2) &amp;gt; (?, ?)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, after &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6875&quot; title=&quot;CQL3: select multiple CQL rows in a single partition using IN&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6875&quot;&gt;&lt;del&gt;CASSANDRA-6875&lt;/del&gt;&lt;/a&gt;, you&apos;ll get the following error:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Clustering columns may not be skipped in multi-column relations. They should appear in the PRIMARY KEY order. Got (c, d) &amp;gt; (0, 0)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12767186">CASSANDRA-8613</key>
            <summary>Regression in mixed single and multi-column relation support</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blerer">Benjamin Lerer</assignee>
                                    <reporter username="thobbs">Tom Hobbs</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Jan 2015 16:49:45 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:23 +0000</updated>
                            <resolved>Thu, 5 Mar 2015 18:37:09 +0000</resolved>
                                        <fixVersion>2.0.15</fixVersion>
                    <fixVersion>2.1.5</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="14287983" author="shawn.kumar" created="Thu, 22 Jan 2015 18:58:24 +0000"  >&lt;p&gt;Managed to reproduce pretty easily on both branches. Seems that this is particular scenario isn&apos;t covered in dtests, will add to cql_tests to address this.&lt;/p&gt;</comment>
                            <comment id="14288158" author="blerer" created="Thu, 22 Jan 2015 20:20:06 +0000"  >&lt;p&gt;The reason, I think, why it is not cover is that we never intended to support this type of query. It is a side effect of how multi-column relations were originally developed. In the following versions we implemented some checks to prevent the mix of single column and multi-column relations on the clustering keys. The refactoring of &lt;tt&gt;SelectStatement&lt;/tt&gt; in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7981&quot; title=&quot;Refactor SelectStatement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7981&quot;&gt;&lt;del&gt;CASSANDRA-7981&lt;/del&gt;&lt;/a&gt; has enforced even more that constraint in the code.&lt;br/&gt;
Overall, I agree with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; that this query make sense and that we should support it. It is just not an easy thing to do on the current code.&lt;/p&gt;</comment>
                            <comment id="14291884" author="jgray" created="Mon, 26 Jan 2015 14:34:52 +0000"  >&lt;p&gt;I originally worked with Hobbs to open this issue. I&apos;ve linked to a design document below, describing our internal use of multi-column relations in Cassandra. Though all of these queries worked in version 2.0.6, many have broken since Cassandra 2.0.9. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.ibm.com/developerworks/community/wikis/home?lang=en#!/wiki/Wf96854c0c8fc_4762_9b83_c6247feca5fc/page/Paging%20and%20Filtering%20with%20Apache%20Cassandra&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Paging and Filtering with Apache Cassandra&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14292043" author="blerer" created="Mon, 26 Jan 2015 16:38:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jgray&quot; class=&quot;user-hover&quot; rel=&quot;jgray&quot;&gt;jgray&lt;/a&gt; Thanks for the link.&lt;/p&gt;

&lt;p&gt;I understand your problem. It is a perfectly valid issue and I will fix the regression.&lt;/p&gt;

&lt;p&gt;In my previous comment, I was just trying to explain why we did not have some tests for this type of query and the problems behind this issue.&lt;/p&gt;</comment>
                            <comment id="14298394" author="blerer" created="Fri, 30 Jan 2015 09:06:52 +0000"  >&lt;p&gt;According to Jared document and to the code it looks like we were also supporting queries like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SELECT * FROM mytable WHERE (clustering_0, clustering_1, clustering_2) = (?, ?, ?) AND (clustering_3, clustering_4) &amp;gt; (?, ?)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;so my guess is that queries like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SELECT * FROM mytable WHERE (clustering_0, clustering_1, clustering_2) = (?, ?, ?) AND clustering_3 &amp;gt; ?;
SELECT * FROM mytable WHERE (clustering_0, clustering_1, clustering_2) = (?, ?, ?) AND clustering_3 IN (?, ?);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;were also valid.&lt;/p&gt;

&lt;p&gt;This means that after &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6875&quot; title=&quot;CQL3: select multiple CQL rows in a single partition using IN&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6875&quot;&gt;&lt;del&gt;CASSANDRA-6875&lt;/del&gt;&lt;/a&gt; in 2.0 and 2.1 we should add support queries for the following queries: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SELECT * FROM mytable WHERE clustering_0 = ? AND (clustering_1, clustering_2) IN ((?, ?), (?, ?));
SELECT * FROM mytable WHERE clustering_0 = ? AND clustering_1 = ? AND  (clustering_2, clustering_3) IN ((?, ?), (?, ?));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In 3.0 we will need to add support for the IN queries like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SELECT * FROM mytable WHERE (clustering_0, clustering_1, clustering_2) IN ((?, ?, ?), (?, ?, ?)) AND clustering_3 &amp;gt; ?;
SELECT * FROM mytable WHERE (clustering_0, clustering_1, clustering_2) IN ((?, ?, ?), (?, ?, ?)) AND clustering_3 IN (?, ?);
SELECT * FROM mytable WHERE clustering_0 = ? AND clustering_1 = ? AND  (clustering_2, clustering_3) IN ((?, ?), (?, ?)) AND (clustering_4, clustering_5)  &amp;gt; (?, ?);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the end it can be summarize by: we need to support any type of mix between single and multi column relations as long as it respect the constraints on posisiton of the IN and slice operator.&lt;/p&gt;</comment>
                            <comment id="14320663" author="blerer" created="Fri, 13 Feb 2015 19:55:37 +0000"  >&lt;p&gt;The patches for 2.0 and 2.1 fix the problem in &lt;tt&gt;SelectStatement.buildBound&lt;/tt&gt; and add some unit tests for the &lt;tt&gt;buildBound&lt;/tt&gt; method in &lt;tt&gt;SelectStatementTest&lt;/tt&gt; as well as in &lt;tt&gt;MultiColumnRelationTest&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The patch for trunk modify the Restriction hierachy and converts &lt;tt&gt;SingleColumnPrimaryKeyRestrictions&lt;/tt&gt; into &lt;tt&gt;PrimaryKeyRestrictionSet&lt;/tt&gt; which support mix of &lt;tt&gt;SingleColumnRestriction&lt;/tt&gt; and &lt;tt&gt;MultiColumnRestriction&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14327926" author="thobbs" created="Thu, 19 Feb 2015 18:37:39 +0000"  >&lt;p&gt;Overall, this looks excellent.  Nice job on keeping it simple, and thanks for the large test suites.&lt;/p&gt;

&lt;p&gt;Some review comments, mostly around code clarity:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;In the 2.0 patch, the comment in &lt;tt&gt;SelectStatement.buildBound()&lt;/tt&gt; about preserving pre-6875 behavior appears to be stale and is a little confusing&lt;/li&gt;
	&lt;li&gt;In &lt;tt&gt;SelectStatement.updateRestrictionsForRelation()&lt;/tt&gt; (2.0 and 2.1), the logic for checking for overlapping multi-column relations could use an explanatory comment (or perhaps be changed for clarity):
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;if ((i == 0 &amp;amp;&amp;amp; name.position != 0 &amp;amp;&amp;amp; stmt.columnRestrictions[name.position - 1] == existing)
    || (i != 0 &amp;amp;&amp;amp; previous != existing)).
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The error message helps, but it still took me a couple of minutes to figure out how the checks worked.&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;In &lt;tt&gt;SelectStatement.processColumnRestrictions()&lt;/tt&gt; the check &lt;tt&gt;!(previousRestriction != null &amp;amp;&amp;amp; restriction == previousRestriction)&lt;/tt&gt; can be simplified to &lt;tt&gt;restriction != previousRestriction&lt;/tt&gt;.  If they&apos;re equal, it&apos;s a multi-column relation.  The comment above it could be broken up to clarify where we&apos;re testing for each case.&lt;/li&gt;
	&lt;li&gt;In the same method, there&apos;s a typo in the error message: &quot;tulpe&quot;.  Additionally, it seems like we could give clearer error messages.  How about one error message for the &quot;unrestricted previous column&quot; case, and another for non-eq restrictions where we just use the operator in the error message?&lt;/li&gt;
	&lt;li&gt;The javadoc for &lt;tt&gt;testBuildBoundWithEqAndInRelation&lt;/tt&gt; says the test is for a single clustering column, but there are two&lt;/li&gt;
	&lt;li&gt;In the 2.1 patch in &lt;tt&gt;SelectStatement&lt;/tt&gt;, try to avoid using nested ternaries.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Comments specific to the trunk patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;RestrictionSet.getRestriction()&lt;/tt&gt; is unused&lt;/li&gt;
	&lt;li&gt;In &lt;tt&gt;RestrictionSet.addRestriction()&lt;/tt&gt;, why is the TreeMap of existing restrictions cloned instead of updated?  (Maybe explain this in a comment.)&lt;/li&gt;
	&lt;li&gt;In &lt;tt&gt;RestrictionSet.mergeRestriction()&lt;/tt&gt;, I&apos;m not sure what the comment is trying to point out.  Is it just that &lt;tt&gt;mergeRestriction()&lt;/tt&gt; may throw an IRE?&lt;/li&gt;
	&lt;li&gt;In the &lt;tt&gt;PrimaryKeyRestrictionSet&lt;/tt&gt; constructor, it might be clearer to rename &lt;tt&gt;lastColumn&lt;/tt&gt; and &lt;tt&gt;newColumn&lt;/tt&gt; to something like &lt;tt&gt;lastRestrictionStart&lt;/tt&gt; and &lt;tt&gt;newRestrictionStart&lt;/tt&gt;, respectively&lt;/li&gt;
	&lt;li&gt;In &lt;tt&gt;CompositesBuilder.addEachElementToAll()&lt;/tt&gt;, if an empty values list is passed in, everything will be removed from &lt;tt&gt;elementsList&lt;/tt&gt;.  It looks like this is okay right now because &lt;tt&gt;hasMissingElements&lt;/tt&gt; gets set to &lt;tt&gt;true&lt;/tt&gt;, but it seems like it may be a bug, especially because &lt;tt&gt;addAllElementsToAll()&lt;/tt&gt; doesn&apos;t have the same behavior with empty lists.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If you can make any changes on a git branch and link them, I would appreciate it.  It gets difficult to follow changes with large patches.&lt;/p&gt;</comment>
                            <comment id="14347488" author="blerer" created="Wed, 4 Mar 2015 20:09:16 +0000"  >&lt;p&gt;The branches with the latest patches are there: &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:CASSANDRA-8613-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;cassandra-2.0&lt;/a&gt;, &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:CASSANDRA-8613-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;cassandra-2.1&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:CASSANDRA-8613-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14349223" author="thobbs" created="Thu, 5 Mar 2015 18:37:09 +0000"  >&lt;p&gt;+1, committed as 90a012a1.  I&apos;ve attached the final diffs as the v2 patches.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="14354185" author="iamaleksey" created="Tue, 10 Mar 2015 03:00:26 +0000"  >&lt;p&gt;Relabeling as 2.0.14, since it&apos;s not in the currently being tested cassandra-2.0.13 branch (we can cherry-pick it into cassandra-2.0.13 if we decide it&apos;s major enough, just updating JIRA to reflect the current state).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12702867" name="8613-2.0-v2.txt" size="90692" author="thobbs" created="Thu, 5 Mar 2015 18:36:58 +0000"/>
                            <attachment id="12702868" name="8613-2.1-v2.txt" size="97534" author="thobbs" created="Thu, 5 Mar 2015 18:36:58 +0000"/>
                            <attachment id="12702869" name="8613-trunk-v2.txt" size="176639" author="thobbs" created="Thu, 5 Mar 2015 18:36:58 +0000"/>
                            <attachment id="12698805" name="CASSANDRA-8613-2.0.txt" size="91034" author="blerer" created="Fri, 13 Feb 2015 19:55:37 +0000"/>
                            <attachment id="12698806" name="CASSANDRA-8613-2.1.txt" size="94621" author="blerer" created="Fri, 13 Feb 2015 19:55:37 +0000"/>
                            <attachment id="12698807" name="CASSANDRA-8613-trunk.txt" size="177101" author="blerer" created="Fri, 13 Feb 2015 19:55:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 37 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i24bgn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thobbs</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326830">2.0.9</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12311124" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Tester</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>shawn.kumar</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>