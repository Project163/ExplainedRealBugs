<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:08:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12884] Batch logic can lead to unbalanced use of system.batches</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12884</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;It looks as though there are some odd edge cases in how we distribute the copies in system.batches.&lt;/p&gt;

&lt;p&gt;The main issue is in the filter method for org.apache.cassandra.batchlog.BatchlogManager&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (validated.size() - validated.get(localRack).size() &amp;gt;= 2)
 {
        &lt;span class=&quot;code-comment&quot;&gt;// we have enough endpoints in other racks
&lt;/span&gt;        validated.removeAll(localRack);
  }

 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (validated.keySet().size() == 1)
 {
       &lt;span class=&quot;code-comment&quot;&gt;// we have only 1 `other` rack
&lt;/span&gt;       Collection otherRack = Iterables.getOnlyElement(validated.asMap().values());
       
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Lists.newArrayList(Iterables.limit(otherRack, 2));
 }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So with one or two racks we just return the first 2 entries in the list.  There&apos;s no shuffle or randomisation here.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13018841">CASSANDRA-12884</key>
            <summary>Batch logic can lead to unbalanced use of system.batches</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="daniel.cranford">Daniel Cranford</assignee>
                                    <reporter username="ahattrell">Adam Hattrell</reporter>
                        <labels>
                    </labels>
                <created>Mon, 7 Nov 2016 14:11:24 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:15 +0000</updated>
                            <resolved>Mon, 14 Aug 2017 14:33:36 +0000</resolved>
                                        <fixVersion>3.0.15</fixVersion>
                    <fixVersion>3.11.1</fixVersion>
                                    <component>Legacy/Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16119975" author="daniel.cranford" created="Wed, 9 Aug 2017 14:23:28 +0000"  >&lt;p&gt;Fix + improved unit tests.&lt;/p&gt;</comment>
                            <comment id="16119980" author="daniel.cranford" created="Wed, 9 Aug 2017 14:25:47 +0000"  >&lt;p&gt;Same bug as &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8735&quot; title=&quot;Batch log replication is not randomized when there are only 2 racks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8735&quot;&gt;&lt;del&gt;CASSANDRA-8735&lt;/del&gt;&lt;/a&gt;. Regression.&lt;/p&gt;</comment>
                            <comment id="16122224" author="jjirsa" created="Thu, 10 Aug 2017 20:02:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; will have a more comprehensive review, I&apos;m sure, but a few notes from a very cursory glance:&lt;/p&gt;

&lt;p&gt;&lt;del&gt;1) I don&apos;t see the purpose of stubbing out &lt;tt&gt;BatchlogManager::shuffle&lt;/tt&gt; as a helper function here.&lt;/del&gt; (You&apos;re overriding it for deterministic testing)&lt;/p&gt;

&lt;p&gt;2) In the case where &lt;tt&gt;validated.keySet().size() == 1&lt;/tt&gt; , shuffling all of the IPs in a given rack may not be all that efficient - may be quicker to just pick 2 random ints, and grab the IPs at those offsets (like we do for the case where we have more than 2 racks, &lt;tt&gt;result.add(rackMembers.get(getRandomInt(rackMembers.size())));&lt;/tt&gt; )&lt;/p&gt;
</comment>
                            <comment id="16122288" author="daniel.cranford" created="Thu, 10 Aug 2017 20:41:44 +0000"  >&lt;p&gt;1) BatchlogManager::shuffle is stubbed out so the unit test can provide a deterministic override. The unit test has been expanded to provide a test which catches this regression. (the existing code used the same pattern for getRandomInt which is overridden to be non-random in the unit test)&lt;/p&gt;

&lt;p&gt;2) getRandomInt could return the same value twice (sampling with replacement) resulting in the same replica being chosen. The existing code uses the shuffle+take head pattern, eg in BatchlogManager.java line 545 &lt;tt&gt;shuffle((List&amp;lt;String&amp;gt;) racks);&lt;/tt&gt; and line 550 &lt;tt&gt;for (String rack : Iterables.limit(racks, 2))&lt;/tt&gt; to perform sampling without replacement.&lt;/p&gt;</comment>
                            <comment id="16122335" author="daniel.cranford" created="Thu, 10 Aug 2017 21:13:02 +0000"  >&lt;p&gt;Technically, if efficiency is key, we could implement something like a Durstenfeld/Knuth shuffle, eg &lt;a href=&quot;https://stackoverflow.com/a/35278327&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://stackoverflow.com/a/35278327&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16125688" author="iamaleksey" created="Mon, 14 Aug 2017 13:36:37 +0000"  >&lt;p&gt;The code is correct, but you could avoid creating an extra &lt;tt&gt;ArrayList&lt;/tt&gt; there by clearing extra elements of the collection in-place. While we are here, can also simplify that slightly weird use of &lt;tt&gt;Iterables.getOnlyElement(validated.asMap().values())&lt;/tt&gt; - in our case it&apos;s essentially equivalent to &lt;tt&gt;validated.values()&lt;/tt&gt;. And a formatting nit: we put braces on new lines, always.&lt;/p&gt;

&lt;p&gt;Pushed a tiny commit on top with these suggestions addressed &lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/12884-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Does it look alright to you?&lt;/p&gt;</comment>
                            <comment id="16125710" author="daniel.cranford" created="Mon, 14 Aug 2017 14:02:53 +0000"  >&lt;p&gt;I had originally considered using sublist to avoid creating a second ArrayList, but decided against it because the sublist version throws an exception in the degenerate case where there is only 1 element in otherRack.&lt;/p&gt;

&lt;p&gt;But now that I trace through the code, I think that otherRack is guaranteed to have at least 2 elements. If otherRack is the local rack and only has 1 element, &lt;tt&gt;if(validated.size() &amp;lt;= 2)&lt;/tt&gt; would have been true, and the filter() function would have already returned. If otherRack was the single non-local rack, and had size 1, then &lt;tt&gt;if(validated.size() - validated.get(localRack).size() &amp;gt;= 2)&lt;/tt&gt; would be false and the whole single-other-rack block wouldn&apos;t run. It&apos;s probably worth a comment stating that otherRack is guaranteed to have at least 2 elements.&lt;/p&gt;

&lt;p&gt;Looks good!&lt;/p&gt;</comment>
                            <comment id="16125719" author="daniel.cranford" created="Mon, 14 Aug 2017 14:11:02 +0000"  >&lt;p&gt;Oh, and not to nitpick, but any reason to prefer&lt;br/&gt;
&lt;tt&gt;otherRack.sublist(2, otherRack.size()).clear(); return otherRack();&lt;/tt&gt; to &lt;tt&gt;return otherRack.sublist(0,2);&lt;/tt&gt; ?&lt;/p&gt;</comment>
                            <comment id="16125750" author="iamaleksey" created="Mon, 14 Aug 2017 14:33:12 +0000"  >&lt;blockquote&gt;&lt;p&gt;Oh, and not to nitpick, but any reason to prefer &lt;tt&gt;otherRack.sublist(2, otherRack.size()).clear(); return otherRack();&lt;/tt&gt; to &lt;tt&gt;return otherRack.sublist(0,2);&lt;/tt&gt;?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s very slightly cheaper as it won&apos;t in practice create an extra object. But here it doesn&apos;t really matter, and the latter, I agree, reads better. Swapped.&lt;/p&gt;

&lt;p&gt;Committed to 3.0 as &lt;a href=&quot;https://github.com/apache/cassandra/commit/c2b635ac240ae8d9375fd96791a5aba903a94498&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;c2b635ac240ae8d9375fd96791a5aba903a94498&lt;/a&gt; and merged into 3.11 and trunk.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12772207">CASSANDRA-8735</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12881026" name="0001-CASSANDRA-12884.patch" size="4862" author="daniel.cranford" created="Wed, 9 Aug 2017 14:22:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[daniel.cranford]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 14 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3607b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12337349">3.0.9</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>