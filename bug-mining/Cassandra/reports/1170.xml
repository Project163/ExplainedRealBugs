<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:23:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3262] SimpleSnitch.compareEndpoints doesn&apos;t respect the intent of the snitch</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3262</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;SimpleSnitch is supposed to not sort the input addresses, thus respecting the order of the partitioner. However, it&apos;s compareEndpoints instead uses IP addresses comparison. Note that this matter when the dynamicSnitch fall back to the wrapped snitch since it uses the compareEndpoint method then.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12524827">CASSANDRA-3262</key>
            <summary>SimpleSnitch.compareEndpoints doesn&apos;t respect the intent of the snitch</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                    </labels>
                <created>Tue, 27 Sep 2011 09:48:46 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:50 +0000</updated>
                            <resolved>Wed, 28 Sep 2011 04:17:08 +0000</resolved>
                                        <fixVersion>0.8.7</fixVersion>
                    <fixVersion>1.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13115376" author="slebresne" created="Tue, 27 Sep 2011 10:10:48 +0000"  >&lt;p&gt;Note that I refactor a bit the code because it felt weird to have compareEndpoint being concrete in AbstractEndpointSnitch but sortByProximity being abstract. It seems more natural to have compareEndpoint being the abstract method and sortByProximity being defined from it in AES.&lt;/p&gt;</comment>
                            <comment id="13115458" author="jbellis" created="Tue, 27 Sep 2011 12:55:47 +0000"  >&lt;p&gt;The reason for this behavior (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1314&quot; title=&quot;snitch that prefers a single replica for all reads to a given key&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1314&quot;&gt;&lt;del&gt;CASSANDRA-1314&lt;/del&gt;&lt;/a&gt;) is because for best performance, normal reads want exactly the opposite behavior of counters: we want to direct reads to the same replica so that the cache stays hot.  Put another way, if each replica is serving a distinct range then you get (replica count) times as much cache memory [with CL.ONE and RR off) than if each is getting the full range of requests from different coordinators.&lt;/p&gt;</comment>
                            <comment id="13115511" author="slebresne" created="Tue, 27 Sep 2011 13:56:43 +0000"  >&lt;p&gt;I think there is a misunderstanding. I agree with the pinning of replicas. The problem is that the current implementation of AbstractEndpointSnitch.compareEndpoints is:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;public int compareEndpoints(InetAddress target, InetAddress a1, InetAddress a2)
{
    return a1.getHostAddress().compareTo(a2.getHostAddress());
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;If you sort a list of hosts using that, you will always return the host that have the &quot;smallest&quot; IP. In other words, in a 3 nodes cluster with RF=3, all and every read will hit the exact same node.&lt;/p&gt;

&lt;p&gt;What makes it kind of work today is that this compareEndpoints() method is barely used. It&apos;s used only in the case where the dynamic snitch have no scores for the endpoints. Otherwise, it&apos;s sortByProximity that is used (which doesn&apos;t rely on compareEndpoints &amp;#8211; this is confusing and my patch corrects it). And sortByProximity does &lt;b&gt;the right thing&lt;/b&gt;, i.e, it doesn&apos;t sort the input list since it is supposed to be in token order (which effectively pin one range to every replica).&lt;/p&gt;

&lt;p&gt;So the patch here proposes two things:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;If fixes the compareEndpoints method: comparing IP addresses is not a good idea.&lt;/li&gt;
	&lt;li&gt;It refactors the code to make sortByProximity use compareEndpoint, to having getting in that situation again.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13116124" author="jbellis" created="Wed, 28 Sep 2011 04:17:08 +0000"  >&lt;p&gt;lgtm.  made some minor updates to comments and committed.&lt;/p&gt;</comment>
                            <comment id="13116163" author="hudson" created="Wed, 28 Sep 2011 05:15:25 +0000"  >&lt;p&gt;Integrated in Cassandra-0.8 #346 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.8/346/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.8/346/&lt;/a&gt;)&lt;br/&gt;
    Keep SimpleSnitch proximity ordering unchanged from what the Strategy generates, as intended&lt;br/&gt;
patch by slebresne; reviewed by jbellis for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3262&quot; title=&quot;SimpleSnitch.compareEndpoints doesn&amp;#39;t respect the intent of the snitch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3262&quot;&gt;&lt;del&gt;CASSANDRA-3262&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;jbellis : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1176712&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1176712&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/locator/AbstractEndpointSnitch.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/locator/AbstractNetworkTopologySnitch.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/locator/DynamicEndpointSnitch.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/locator/SimpleSnitch.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12496657" name="3262.patch" size="7084" author="slebresne" created="Tue, 27 Sep 2011 10:10:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>17916</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 8 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ghrz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94310</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>