<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:45:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6788] Race condition silently kills thrift server</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6788</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;There&apos;s a race condition in CustomTThreadPoolServer that can cause the thrift server to silently stop listening for connections. &lt;/p&gt;

&lt;p&gt;It happens when the executor service throws a RejectedExecutionException, which is not caught.&lt;/p&gt;

&lt;p&gt;Silent in the sense that OpsCenter doesn&apos;t notice any problem since JMX is still running fine.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12698120">CASSANDRA-6788</key>
            <summary>Race condition silently kills thrift server</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ccrolf">Christian Rolf</assignee>
                                    <reporter username="ccrolf">Christian Rolf</reporter>
                        <labels>
                    </labels>
                <created>Sat, 1 Mar 2014 15:02:16 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:52 +0000</updated>
                            <resolved>Sat, 7 Jun 2014 13:22:03 +0000</resolved>
                                        <fixVersion>1.2.17</fixVersion>
                    <fixVersion>2.0.7</fixVersion>
                    <fixVersion>2.1 beta2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="13917144" author="jbellis" created="Sat, 1 Mar 2014 18:22:46 +0000"  >&lt;p&gt;I don&apos;t understand how (a) a REE will &quot;cause the thrift server to silently stop listening for connections,&quot; nor (b) how closing transports fixes it.  Note that the executor is always a ThreadPoolExecutor so a dead worker thread will be replaced automatically.&lt;/p&gt;</comment>
                            <comment id="13917174" author="ccrolf" created="Sat, 1 Mar 2014 19:53:44 +0000"  >&lt;p&gt;Sorry, I should&apos;ve been a more specific; this happens when the number of RPC threads is limited. We&apos;ve been running a ring of 12 nodes with 2048 as max RPC threads for over a year without problems, but the past week we&apos;ve been getting zombie nodes almost every day.&lt;/p&gt;

&lt;p&gt;Basically, the active thread counter is decremented at line 216 (pre-patch) of CustomTThreadPoolServer.java, this can end the waiting loop at line 98. If a new connection is made before the run-method of old thread has completed, the execute() command at line 108 can cause a RejectedExecutionException.&lt;/p&gt;</comment>
                            <comment id="13917194" author="jbellis" created="Sat, 1 Mar 2014 21:06:35 +0000"  >&lt;p&gt;I see.  But that doesn&apos;t eliminate the window for a race, just reduces it.  (TPE.runWorker still needs to call afterExecute and do its own bookkeeping.)  v2 adds an explicit catch for REE.  This is better than dying, but it will accept connections and then drop them on the floor if necessary which is obviously sub optimal.  Moral is not to push right up to the edge of max connections. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13918370" author="ccrolf" created="Mon, 3 Mar 2014 18:27:17 +0000"  >&lt;p&gt;True, given that the ThreadPoolExecutor.afterExecute is a noop, the exception should be rare. &lt;/p&gt;

&lt;p&gt;Here&apos;s an alternative solution...in the hope that you prefer overrides to factories and extra exception handling as much as I do &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13933635" author="jbellis" created="Thu, 13 Mar 2014 17:58:04 +0000"  >&lt;p&gt;Hmm, doesn&apos;t this mean we&apos;re back to dying ignominiously if we still happen to get a REE?  I would prefer v2 for that reason.&lt;/p&gt;</comment>
                            <comment id="13933641" author="jbellis" created="Thu, 13 Mar 2014 17:59:07 +0000"  >&lt;p&gt;(attaching my rebase of v3 for posterity)&lt;/p&gt;</comment>
                            <comment id="13937776" author="ccrolf" created="Mon, 17 Mar 2014 13:14:28 +0000"  >&lt;p&gt;Having read through the (somewhat horrendous) code of java.util.concurrent.ThreadPoolExecutor, I agree whole-heartedly with your version. It&apos;s the only way to be completely safe from the race; the contract for afterExecute simply isn&apos;t clear enough to rely on.&lt;br/&gt;
I see I put myself as the assignee, what do I need to do to subtmit the patch?&lt;/p&gt;</comment>
                            <comment id="13937937" author="jbellis" created="Mon, 17 Mar 2014 15:52:06 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="14011652" author="brandon.williams" created="Wed, 28 May 2014 21:46:45 +0000"  >&lt;p&gt;This can happen on 1.2 as well, so we should backport this fix there.&lt;/p&gt;</comment>
                            <comment id="14011656" author="kohlisankalp" created="Wed, 28 May 2014 21:49:13 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14012287" author="ccrolf" created="Thu, 29 May 2014 11:22:19 +0000"  >&lt;p&gt;Thanks for reporting this. Looks like the patch (v2) is exactly the same for 1.2. &lt;/p&gt;</comment>
                            <comment id="14018401" author="vmallet" created="Thu, 5 Jun 2014 01:33:23 +0000"  >&lt;p&gt;+1 on the port to 1.2, we&apos;re hoping to grab your patch as soon as you feel comfortable with it and commit it for 1.2.17.&lt;/p&gt;</comment>
                            <comment id="14018912" author="brandon.williams" created="Thu, 5 Jun 2014 16:20:16 +0000"  >&lt;p&gt;v2 Just Applies to 1.2, so if you&apos;re cool with that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbellis&quot; class=&quot;user-hover&quot; rel=&quot;jbellis&quot;&gt;jbellis&lt;/a&gt; let&apos;s just commit it there.&lt;/p&gt;</comment>
                            <comment id="14020798" author="jbellis" created="Sat, 7 Jun 2014 13:22:03 +0000"  >&lt;p&gt;committed to 1.2&lt;/p&gt;</comment>
                            <comment id="15204079" author="dpinol" created="Mon, 21 Mar 2016 11:58:59 +0000"  >&lt;p&gt;With both Cassandra 1.2.19 and 2.2.5 (which should contain the patch) I can experience a similar problem, with both OSX and linux. I use thrift with scale7-pelops 1.3-1.1.x. This is my pseudocode. I use dynamic columns.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;for(column=1..1000) 
{
  for(value=1..25) 
  {
    write(&quot;CF1&quot;, &quot;key1&quot;, column, writtenValue);
    readValue = read(&quot;CF1&quot;, &quot;key1&quot;, column);
    some times here readValue!=writtenValue. Once this happens, sleeping and reading again does not help  
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The only alternative ways to avoid the problem are:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;inserting a sleep (any duration) right after the put.&lt;/li&gt;
	&lt;li&gt;replacing thrift with CQL&lt;/li&gt;
	&lt;li&gt;This sounds crazy, but each value contains the previous one as prefix (1, 12, 123, 1234...) it never fails.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12631970" name="6788-v2.txt" size="2450" author="jbellis" created="Sat, 1 Mar 2014 21:06:35 +0000"/>
                            <attachment id="12632322" name="6788-v3.txt" size="3335" author="ccrolf" created="Mon, 3 Mar 2014 18:27:17 +0000"/>
                            <attachment id="12634495" name="6793-v3-rebased.txt" size="3583" author="jbellis" created="Thu, 13 Mar 2014 17:59:07 +0000"/>
                            <attachment id="12631951" name="race_patch.diff" size="1205" author="ccrolf" created="Sat, 1 Mar 2014 15:02:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ccrolf]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>376589</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 35 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1sw5z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>376884</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326174">1.2.16</customfieldvalue>
    <customfieldvalue id="12325644">2.0.4</customfieldvalue>
    <customfieldvalue id="12325761">2.0.5</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>