<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:09:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13899] Fix buffer length comparison when decompressing in netty-based streaming</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13899</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Streaming a single partition with ~100K rows fails with the following exception:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [Stream-Deserializer-/127.0.0.1:35149-a92e5e12] 2017-09-21 04:03:41,237 StreamSession.java:617 - [Stream #c2e5b640-9eab-11e7-99c0-e9864ca8da8e] Streaming error occurred on session with peer 127.0.0.1
org.apache.cassandra.streaming.StreamReceiveException: java.lang.RuntimeException: Last written key DecoratedKey(-1000328290821038380) &amp;gt;= current key DecoratedKey(-1055007227842125139)  writing into /home/paulo/.ccm/test/node2/data0/stresscql/typestest-482ac7b09e8d11e787cf85d073c
8e037/na-1-big-Data.db
        at org.apache.cassandra.streaming.messages.IncomingFileMessage$1.deserialize(IncomingFileMessage.java:63) ~[main/:na]
        at org.apache.cassandra.streaming.messages.IncomingFileMessage$1.deserialize(IncomingFileMessage.java:41) ~[main/:na]
        at org.apache.cassandra.streaming.messages.StreamMessage.deserialize(StreamMessage.java:55) ~[main/:na]
        at org.apache.cassandra.streaming.async.StreamingInboundHandler$StreamDeserializingTask.run(StreamingInboundHandler.java:178) ~[main/:na]
        at java.lang.Thread.run(Thread.java:745) [na:1.8.0_121]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Reproduction steps:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Create CCM cluster with 2 nodes&lt;/li&gt;
	&lt;li&gt;Start only first node, disable hinted handoff&lt;/li&gt;
	&lt;li&gt;Run stress with the attached yaml: &lt;tt&gt;tools/bin/cassandra-stress &quot;user profile=largepartition.yaml n=10K ops(insert=1) no-warmup -node whitelist 127.0.0.1 -mode native cql3 compression=lz4 -rate threads=4 -insert visits=FIXED(100K) revisit=FIXED(100K)&quot;&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Start second node, run repair on &lt;tt&gt;stresscql&lt;/tt&gt; table - the exception above will be thrown.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I investigated briefly and haven&apos;t found anything suspicious. This seems to be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12229&quot; title=&quot;Move streaming to non-blocking IO and netty (streaming 2.1)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12229&quot;&gt;&lt;del&gt;CASSANDRA-12229&lt;/del&gt;&lt;/a&gt; as I tested the steps above in a branch without that and the repair completed successfully. I haven&apos;t tested with a smaller number of rows per partition to see at which point it starts to be a problem.&lt;/p&gt;

&lt;p&gt;We should probably add a regression dtest to stream large partitions to catch similar problems in the future.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13104716">CASSANDRA-13899</key>
            <summary>Fix buffer length comparison when decompressing in netty-based streaming</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jasobrown">Jason Brown</assignee>
                                    <reporter username="pauloricardomg">Paulo Motta</reporter>
                        <labels>
                    </labels>
                <created>Mon, 25 Sep 2017 10:16:04 +0000</created>
                <updated>Fri, 15 May 2020 08:00:26 +0000</updated>
                            <resolved>Wed, 4 Oct 2017 07:05:40 +0000</resolved>
                                        <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16178814" author="pauloricardomg" created="Mon, 25 Sep 2017 10:18:33 +0000"  >&lt;p&gt;(cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="16180041" author="jasobrown" created="Tue, 26 Sep 2017 01:06:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt; Thanks for the scripts and instructions - I was able to reproduce. Will have a patch hopefully in a day or two&lt;/p&gt;</comment>
                            <comment id="16181621" author="jasobrown" created="Tue, 26 Sep 2017 21:32:10 +0000"  >&lt;p&gt;This turned out to be a simple, stupid bug - i used the wrong length to compare against when translating from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10520&quot; title=&quot;Compressed writer and reader should support non-compressed data.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10520&quot;&gt;&lt;del&gt;CASSANDRA-10520&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Patch here:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;13899&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jasobrown/cassandra/tree/13899&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/337/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/jasobrown/cassandra/tree/13899&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt; Do you mind reviewing?&lt;/p&gt;</comment>
                            <comment id="16181837" author="jasobrown" created="Wed, 27 Sep 2017 01:21:24 +0000"  >&lt;p&gt;tbh, I don&apos;t think it&apos;s large partitions that necessarily triggered this bug; streaming just transfers the bytes of sstable Data file naively. I think it was something in the dataset and the way it compresses that exposed the bug. Thus, I&apos;m not sure how to proceed with a dtest, especially one based on &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt;&apos;s submitted patch (as highly useful as it is!).&lt;/p&gt;</comment>
                            <comment id="16183601" author="pauloricardomg" created="Thu, 28 Sep 2017 03:07:56 +0000"  >&lt;blockquote&gt;&lt;p&gt;tbh, I don&apos;t think it&apos;s large partitions that necessarily triggered this bug; streaming just transfers the bytes of sstable Data file naively. I think it was something in the dataset and the way it compresses that exposed the bug. Thus, I&apos;m not sure how to proceed with a dtest, especially one based on Paulo Motta&apos;s submitted patch (as highly useful as it is!).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good point, I managed to reproduce this with 1k entries with the same YAML by setting &lt;tt&gt;chunk_length_in_kb=1&lt;/tt&gt;. Maybe it&apos;s possible to reproduce with even fewer entries and the default generator with a large payload size and a very low &lt;tt&gt;chunk_length_in_kb&lt;/tt&gt;. Would you mind trying that?&lt;/p&gt;

&lt;p&gt;The patch looks good, but would be nice to have a regression dtest for this, since it&apos;s pretty subtle to catch.&lt;/p&gt;</comment>
                            <comment id="16184194" author="jasobrown" created="Thu, 28 Sep 2017 13:44:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt; Good call on dropping the &lt;tt&gt;chunk_length_in_kb&lt;/tt&gt; down to 1 for the dtest. I can trigger the error on trunk with it and a much lower insert count in under 80 seconds total. I&apos;ve turned it into a &lt;a href=&quot;https://github.com/jasobrown/cassandra-dtest/tree/13899&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;. Please review and let me know what you think.&lt;/p&gt;</comment>
                            <comment id="16190187" author="jasobrown" created="Tue, 3 Oct 2017 19:26:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt; do you think you can finish up the review on this soonish?&lt;/p&gt;</comment>
                            <comment id="16190719" author="pauloricardomg" created="Wed, 4 Oct 2017 02:57:36 +0000"  >&lt;p&gt;I am away this week but this is simple enough so I managed to have a quick look during vacation. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I can trigger the error on trunk with it and a much lower insert count in under 80 seconds total. I&apos;ve turned it into a dtest.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Awesome, dtest looks good to me - verified that it fails without the patch and passes with it - thanks! Marking as ready to commit.&lt;/p&gt;</comment>
                            <comment id="16190892" author="jasobrown" created="Wed, 4 Oct 2017 07:05:40 +0000"  >&lt;p&gt;Holy crap - I didn&apos;t know you were vacationing. Sorry about that, but thanks soo much for the review!!&lt;/p&gt;

&lt;p&gt;committed as sha &lt;tt&gt;d080a73723d9aa402507c1ae04eef92ff6d44948&lt;/tt&gt; to the cassandra repo, and as sha &lt;tt&gt;6ea3964d18b54b4e23b6e7ebf63ca42080e8404b&lt;/tt&gt; to the dtests repo.&lt;/p&gt;</comment>
                            <comment id="16190894" author="jasobrown" created="Wed, 4 Oct 2017 07:06:46 +0000"  >&lt;p&gt;updated the ticket title to more accurately describe the problem&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12904794">CASSANDRA-10520</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12888815" name="largepartition.yaml" size="3912" author="pauloricardomg" created="Mon, 25 Sep 2017 10:17:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasobrown]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 6 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3khl3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12336842">4.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>pauloricardomg</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[pauloricardomg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>