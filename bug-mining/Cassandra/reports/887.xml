<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:20:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2552] ReadResponseResolver Race</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2552</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When receiving a response, ReadResponseResolver uses a 3 step process to decide whether to trigger the condition that enough responses have arrived:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Add new response&lt;/li&gt;
	&lt;li&gt;Check response set size&lt;/li&gt;
	&lt;li&gt;Check that data is present&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I think that these steps must have been reordered by the compiler in some cases, because I was able to reproduce a case for a QUORUM read where the condition is not properly triggered:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO [RequestResponseStage:15] 2011-04-25 00:26:53,514 ReadResponseResolver.java (line 87) post append for 1087367065: hasData=false in 2 messages
INFO [RequestResponseStage:8] 2011-04-25 00:26:53,514 ReadResponseResolver.java (line 87) post append for 1087367065: hasData=true in 1 messages
INFO [pool-1-thread-54] 2011-04-25 00:27:03,516 StorageProxy.java (line 623) Read timeout: java.util.concurrent.TimeoutException: ReadResponseResolver@1087367065(/10.34.131.109=false,/10.34.132.122=true,)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The last line shows that both results were present, and that one of them was holding data.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12505091">CASSANDRA-2552</key>
            <summary>ReadResponseResolver Race</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="stuhood">Stu Hood</reporter>
                        <labels>
                    </labels>
                <created>Mon, 25 Apr 2011 01:21:21 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:01 +0000</updated>
                            <resolved>Thu, 28 Apr 2011 13:26:58 +0000</resolved>
                                        <fixVersion>0.7.6</fixVersion>
                    <fixVersion>0.8.0 beta 2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13024705" author="stuhood" created="Mon, 25 Apr 2011 02:06:48 +0000"  >&lt;p&gt;I have a patch ready that I believe fixes this: testing it out before posting.&lt;/p&gt;</comment>
                            <comment id="13024787" author="jbellis" created="Mon, 25 Apr 2011 13:25:24 +0000"  >&lt;p&gt;Hard to tell exactly what&apos;s going on here w/o knowing where your logging was added.&lt;/p&gt;

&lt;p&gt;In particular it&apos;s important to note that we don&apos;t prevent responses from being processed after we&apos;ve already given up and decided to call a timeout (but before we&apos;ve torn down the request callback).&lt;/p&gt;</comment>
                            <comment id="13025086" author="stuhood" created="Tue, 26 Apr 2011 06:08:09 +0000"  >&lt;p&gt;Here is a cut down testcase that reproduces the race: it looks like two threads can race on step 2 such that neither accounts for the item added by the other, and both think the set of responses is too small.&lt;/p&gt;

&lt;p&gt;I have a patch that makes append + size an atomic operation: I&apos;ll post it as soon as I clean it up a bit.&lt;/p&gt;</comment>
                            <comment id="13025102" author="stuhood" created="Tue, 26 Apr 2011 07:10:54 +0000"  >&lt;p&gt;Chris pointed out that the example passes if you replace NBHM with CHM, but I don&apos;t think NBHM is necessarily to blame here: each thread views a locally consistent copy, likely due to Cliff&apos;s use of sun.misc.Unsafe references.&lt;/p&gt;

&lt;p&gt;It&apos;s possible that a similar race applies to RangeSliceResponseResolver, but I think changes to LBQ (like CHM) will be broadcast to all threads.&lt;/p&gt;</comment>
                            <comment id="13025112" author="stuhood" created="Tue, 26 Apr 2011 07:36:35 +0000"  >&lt;p&gt;Attaching a patch that replaces NBHM with an AtomicReferenceArray that is appended to and counted atomically. This patch eliminated the timeouts we were seeing.&lt;/p&gt;

&lt;p&gt;CHM may also be a legitimate solution, but it feels a bit like an abuse of a map.&lt;/p&gt;</comment>
                            <comment id="13025337" author="jbellis" created="Tue, 26 Apr 2011 17:21:01 +0000"  >&lt;p&gt;That sure sounds like a NBHM bug to me. The javadoc says,&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Retrievals reflect the results of the most recently completed update operations holding upon their onset... Similarly, Iterators and Enumerations return elements reflecting the state of the hash table at some point at or since the creation of the iterator/enumeration.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I.e., for at least one thread, &lt;b&gt;both&lt;/b&gt; update operations will have completed when the iterator is created, so it should see all the entries.&lt;/p&gt;

&lt;p&gt;(Will review the actual patch shortly, I&apos;m just saying I think we should report a bug too.)&lt;/p&gt;</comment>
                            <comment id="13025490" author="stuhood" created="Tue, 26 Apr 2011 22:39:09 +0000"  >&lt;p&gt;&amp;gt; I.e., for at least one thread, both update operations will have completed when the iterator is created&lt;br/&gt;
Note that the race I observed via the debug output for that test was actually on the size() operation, which doesn&apos;t put any such guarantees in its javadocs.&lt;/p&gt;</comment>
                            <comment id="13025518" author="jbellis" created="Tue, 26 Apr 2011 23:46:18 +0000"  >&lt;p&gt;You&apos;re right: size() is implemented as a org.cliffc.high_scale_lib.Counter object, which says&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  &lt;span class=&quot;code-comment&quot;&gt;// Add the given value to current counter value.  Concurrent updates will
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// not be lost, but addAndGet or getAndAdd are not implemented because but
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// the total counter value is not atomically updated.
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void add( &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; x );
&lt;/span&gt;
...

  &lt;span class=&quot;code-comment&quot;&gt;// Current value of the counter.  Since other threads are updating furiously
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// the value is only approximate, but it includes all counts made by the
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;// current thread.  Requires a pass over all the striped counters.
&lt;/span&gt;  &lt;span class=&quot;code-comment&quot;&gt;//&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; get();&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13025692" author="slebresne" created="Wed, 27 Apr 2011 09:38:05 +0000"  >&lt;p&gt;I am no expert of the Java Memory Model, but I can&apos;t find anything that preclude this behavior in the CHM docs either (there really is not much on the size function). So I would have liked the CHM solution if we could be sure it always fix that problem (I would have liked it because it was a one line change and I think maps are here to be &quot;abused&quot;), but as far as I can tell, it may well only make the bug much less frequent or fix it only on some architecture (the code of CHM seems to indicate it is safe but it&apos;s complicated enough that I wouldn&apos;t bet my life on it).&lt;/p&gt;

&lt;p&gt;Note that if that&apos;s true, LBQ too could well allow for a race here without breaking it&apos;s specification (it seems to use a AtomicInteger for the size internally so it is trivially ok, but if the spec doesn&apos;t force anything, I suppose that could change).&lt;/p&gt;

&lt;p&gt;So I suppose if we want to do right by the spec, we should probably update both AbstractRowResolver and RangeSliceResponseResolver (note that using an AtomicInteger to count the number of responses could be slightly simpler, but I&apos;m fine with an AtomicReferenceArray). &lt;/p&gt;</comment>
                            <comment id="13025847" author="jbellis" created="Wed, 27 Apr 2011 15:38:29 +0000"  >&lt;p&gt;is there a reason RSRR can&apos;t inherit ARR or does it just predate that refactoring?&lt;/p&gt;</comment>
                            <comment id="13025867" author="jbellis" created="Wed, 27 Apr 2011 16:07:12 +0000"  >&lt;blockquote&gt;&lt;p&gt;is there a reason RSRR can&apos;t inherit ARR or does it just predate that refactoring?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;To answer my own ARR assumes we&apos;re returning Rows, which would be easy to fix, and that Messages turn into ReadResponse objects, which would be harder since we&apos;d need to have a &amp;lt;T extends ISerializable&amp;gt; interface where ISerializeable gave us a Serializer class declaring &quot;void serialize(T, outputstream) and T deserialize(inputstream)&quot;, i.e., we start to get into fixing ICompactSerializer and all the mess that would be.&lt;/p&gt;</comment>
                            <comment id="13025878" author="jbellis" created="Wed, 27 Apr 2011 16:29:21 +0000"  >&lt;p&gt;I&apos;m not sure I&apos;m a fan of the ARR solution.  Wouldn&apos;t it be similar complexity (one O(N) operation per message received) to keep NBHM and implement getMessageCount as an iterate-entries operation?  (the O(N) op in ARR is of course the search-for-free-slot in append.)&lt;/p&gt;

&lt;p&gt;I&apos;m -0 on changing RSRR away from LBQ when LBQ is known to work fine in practice.&lt;/p&gt;</comment>
                            <comment id="13025882" author="jbellis" created="Wed, 27 Apr 2011 16:37:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;Wouldn&apos;t it be similar complexity (one O(N) operation per message received) to keep NBHM and implement getMessageCount as an iterate-entries operation?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We can actually do size-by-iteration for basically free (with a little refactoring), since we&apos;re already iterating for isDataPresent. We can just push the iteration into the callers who care about size-and-data-present and do it with one loop.&lt;/p&gt;

&lt;p&gt;But if I am honest that is premature optimization.  We are already using the AtomicInteger approach in DatacenterReadCallback.  I&apos;ll submit a patch to standardize on that.&lt;/p&gt;</comment>
                            <comment id="13025904" author="jbellis" created="Wed, 27 Apr 2011 17:23:16 +0000"  >&lt;p&gt;v2 w/ AtomicInteger approach&lt;/p&gt;</comment>
                            <comment id="13025983" author="jbellis" created="Wed, 27 Apr 2011 20:18:34 +0000"  >&lt;p&gt;updated v2 fixes AsyncRepairCallback and RepairCallback as well&lt;/p&gt;</comment>
                            <comment id="13025985" author="jbellis" created="Wed, 27 Apr 2011 20:24:36 +0000"  >&lt;p&gt;and a v2 for 0.7&lt;/p&gt;</comment>
                            <comment id="13025995" author="stuhood" created="Wed, 27 Apr 2011 20:45:08 +0000"  >&lt;p&gt;Although I didn&apos;t reproduce a race between size() and isDataPresent(), isn&apos;t that one still possible? IMO, two operations that are atomic independently shouldn&apos;t be trusted to compose. The point of the ARR wasn&apos;t to improve runtime, it was simply to make all three steps atomic.&lt;/p&gt;</comment>
                            <comment id="13026000" author="jbellis" created="Wed, 27 Apr 2011 20:53:44 +0000"  >&lt;p&gt;the correctness criterion is that once the messages are received, at least one thread running response will see that both blockfor and data are satisfied; this meets that need.&lt;/p&gt;

&lt;p&gt;note that received(-messages-that-count-towards-blockfor) is NOT the same as size (see: DRC) so you need a separate variable anyway even with ARR.&lt;/p&gt;</comment>
                            <comment id="13026210" author="stuhood" created="Thu, 28 Apr 2011 08:45:54 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;I still think a Map is overkill here, but I can&apos;t reproduce a race with the v2 algorithm.&lt;/p&gt;</comment>
                            <comment id="13026300" author="jbellis" created="Thu, 28 Apr 2011 13:26:59 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="13026306" author="hudson" created="Thu, 28 Apr 2011 13:44:17 +0000"  >&lt;p&gt;Integrated in Cassandra-0.7 #459 (See &lt;a href=&quot;https://builds.apache.org/hudson/job/Cassandra-0.7/459/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/hudson/job/Cassandra-0.7/459/&lt;/a&gt;)&lt;br/&gt;
    fix incorrect use ofNBHM.size in ReadCallback&lt;br/&gt;
patch by jbellis; reviewed by stuhood for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2552&quot; title=&quot;ReadResponseResolver Race&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2552&quot;&gt;&lt;del&gt;CASSANDRA-2552&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12477369" name="0001-Move-Resolvers-to-atomic-append-count.txt" size="24615" author="stuhood" created="Tue, 26 Apr 2011 07:36:35 +0000"/>
                            <attachment id="12477577" name="2552-v2-07.txt" size="9619" author="jbellis" created="Wed, 27 Apr 2011 20:24:36 +0000"/>
                            <attachment id="12477576" name="2552-v2.txt" size="8798" author="jbellis" created="Wed, 27 Apr 2011 20:18:34 +0000"/>
                            <attachment id="12477366" name="ResolveRaceTest.java" size="4006" author="stuhood" created="Tue, 26 Apr 2011 06:08:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20693</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 30 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gc1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93381</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>stuhood</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stuhood]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>