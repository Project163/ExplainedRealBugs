<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:26:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3303] Short reads protection results in returning more columns than asked for</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3303</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When we detect a short read (in SP.fetchRows), we retry a new command created by:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;logger.debug(&quot;detected short read: expected {} columns, but only resolved {} columns&quot;, sliceCommand.count, liveColumnsInRow);
int retryCount = sliceCommand.count + sliceCommand.count - liveColumnsInRow;
SliceFromReadCommand retryCommand = new SliceFromReadCommand(command.table,
                                                             command.key,
                                                             command.queryPath,
                                                             sliceCommand.start,
                                                             sliceCommand.finish,
                                                             sliceCommand.reversed,
                                                             retryCount);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;That is, in that new command, the count is greater than what asked in the initial command. But we never cut back the result of that new retried query.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12525636">CASSANDRA-3303</key>
            <summary>Short reads protection results in returning more columns than asked for</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="byronclark">Byron Clark</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                    </labels>
                <created>Tue, 4 Oct 2011 09:04:53 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:49 +0000</updated>
                            <resolved>Fri, 4 Nov 2011 08:37:54 +0000</resolved>
                                        <fixVersion>1.0.2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13121386" author="jbellis" created="Wed, 5 Oct 2011 19:28:08 +0000"  >&lt;p&gt;Tagging this 1.0.1 since short reads being broken is nothing new (I would say returning too much data, is better than returning not enough)&lt;/p&gt;</comment>
                            <comment id="13130325" author="byronclark" created="Wed, 19 Oct 2011 02:46:24 +0000"  >&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;^long_read.sh&amp;#93;&lt;/span&gt; is the script I&apos;m using with ccm to reproduce the issue. It&apos;s the same script used for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2643&quot; title=&quot;read repair/reconciliation breaks slice based iteration at QUORUM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2643&quot;&gt;&lt;del&gt;CASSANDRA-2643&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13130345" author="byronclark" created="Wed, 19 Oct 2011 04:20:40 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12499632/12499632_cassandra-3303-1.patch&quot; title=&quot;cassandra-3303-1.patch attached to CASSANDRA-3303&quot;&gt;cassandra-3303-1.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; is a first attempt at fixing this.  I&apos;m not sure it handles the situation correctly for a slice requested in reverse order.&lt;/p&gt;</comment>
                            <comment id="13130349" author="byronclark" created="Wed, 19 Oct 2011 04:24:54 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12499634/12499634_cassandra-3303-2.patch&quot; title=&quot;cassandra-3303-2.patch attached to CASSANDRA-3303&quot;&gt;cassandra-3303-2.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; doesn&apos;t reuse a counter variable on an inner loop.&lt;/p&gt;</comment>
                            <comment id="13131659" author="slebresne" created="Thu, 20 Oct 2011 14:37:04 +0000"  >&lt;p&gt;This doesn&apos;t always work, because we cannot be sure that on the retry phase, we will have a digest mismatch again (some read repair could have kicked in). I.e, we should also trim also in the initial for loop, not only in the &apos;deal with repair response&apos; one.&lt;/p&gt;

&lt;p&gt;Also (and I&apos;m nitpicking a bit) it would be nice to push the trim code into RetriedSliceFromReadCommand (and to make it handle reversed queries). For instance we could add a filter(ColumFamily) method or something like that. Same thing for the original count, rather than using instanceof, I&apos;d rather add a originalCount() method to SliceFromReadCommand (that would return count) that the Retried variant would override.&lt;/p&gt;</comment>
                            <comment id="13139520" author="byronclark" created="Sun, 30 Oct 2011 02:07:26 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12501488/12501488_cassandra-3303-3.patch&quot; title=&quot;cassandra-3303-3.patch attached to CASSANDRA-3303&quot;&gt;cassandra-3303-3.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; should address all the concerns mentioned. &lt;/p&gt;

&lt;p&gt;I&apos;m going to go ahead and pull some more of the logic out of StorageProxy and get rid of all the instanceof checks.&lt;/p&gt;</comment>
                            <comment id="13140607" author="jbellis" created="Mon, 31 Oct 2011 21:59:34 +0000"  >&lt;p&gt;So, we should wait before reviewing?&lt;/p&gt;</comment>
                            <comment id="13141217" author="byronclark" created="Tue, 1 Nov 2011 14:58:36 +0000"  >&lt;p&gt;Yes, please. I&apos;ll be attaching the improved patch later today.&lt;/p&gt;</comment>
                            <comment id="13141350" author="jbellis" created="Tue, 1 Nov 2011 17:20:38 +0000"  >&lt;p&gt;Belatedly and probably redundantly, I note that any time we hit RowRepairResolver we can have this count problem, not just w/ short read resolution.  (E.g., &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3395&quot; title=&quot;Quorum returns incorrect results during hinted handoff&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3395&quot;&gt;&lt;del&gt;CASSANDRA-3395&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="13141500" author="byronclark" created="Tue, 1 Nov 2011 19:48:08 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12501816/12501816_cassandra-3303-4.patch&quot; title=&quot;cassandra-3303-4.patch attached to CASSANDRA-3303&quot;&gt;cassandra-3303-4.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; removes all of the ugly logic to handle this case (and the short read case) into the ReadCommands.&lt;/p&gt;

&lt;p&gt;Jonathan - Does this already address &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3395&quot; title=&quot;Quorum returns incorrect results during hinted handoff&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3395&quot;&gt;&lt;del&gt;CASSANDRA-3395&lt;/del&gt;&lt;/a&gt; or is more work needed for that one?&lt;/p&gt;</comment>
                            <comment id="13142194" author="slebresne" created="Wed, 2 Nov 2011 14:51:07 +0000"  >&lt;p&gt;On the patch, a few minor remarks:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;There is a weird UnImplNode on top of ReadCommand.java (that prevents compilation)&lt;/li&gt;
	&lt;li&gt;I think we could replace isLongRead and trimLongRead by a maybeTrim() method that would be a noop by default. Basically trimLongRead requires that isLongRead() has been called (otherwise it throws an unsupported exception), so in those case I think it&apos;s easier to use if it&apos;s just one method. Same for the pair (isShortRead, generateShortRetry) actually.&lt;/li&gt;
	&lt;li&gt;nit: There is some imports rewrite (java.io.* -&amp;gt; multiple imports) in SFRC. It&apos;s a big deal but that kind of thing makes diffs bigger than necessary so it&apos;s nice to take the habit to no do that.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Now I don&apos;t think this patch addresses &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3395&quot; title=&quot;Quorum returns incorrect results during hinted handoff&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3395&quot;&gt;&lt;del&gt;CASSANDRA-3395&lt;/del&gt;&lt;/a&gt; as is. For that, we would basically need to move the trimLongRead to SliceFromReadCommand directly (the bug of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3395&quot; title=&quot;Quorum returns incorrect results during hinted handoff&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3395&quot;&gt;&lt;del&gt;CASSANDRA-3395&lt;/del&gt;&lt;/a&gt; is that normal SliceFromReadCommand can have more that requested columns because of reconciliation of the result of different nodes). The easiest way here is probably to move the trim code to a SliceFromReadCommand.maybeTrim() and to have that method uses some getRequestedCount() method. For SFRC, the latter method would return count, for RSFRC, it would return originalCount.&lt;/p&gt;</comment>
                            <comment id="13143504" author="byronclark" created="Thu, 3 Nov 2011 20:18:42 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12502214/12502214_cassandra-3303-5.patch&quot; title=&quot;cassandra-3303-5.patch attached to CASSANDRA-3303&quot;&gt;cassandra-3303-5.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; addresses all the comments in the most recent review. Additionally, it checks for a long read on SliceFromReadCommand instead of just RetriedSliceFromReadCommand.&lt;/p&gt;</comment>
                            <comment id="13143828" author="slebresne" created="Fri, 4 Nov 2011 08:37:54 +0000"  >&lt;p&gt;+1, committed&lt;br/&gt;
Thanks Byron.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12499627" name="ASF.LICENSE.NOT.GRANTED--long_read.sh" size="1738" author="byronclark" created="Wed, 19 Oct 2011 02:46:24 +0000"/>
                            <attachment id="12499632" name="cassandra-3303-1.patch" size="6452" author="byronclark" created="Wed, 19 Oct 2011 04:20:40 +0000"/>
                            <attachment id="12499634" name="cassandra-3303-2.patch" size="6456" author="byronclark" created="Wed, 19 Oct 2011 04:24:54 +0000"/>
                            <attachment id="12501488" name="cassandra-3303-3.patch" size="8935" author="byronclark" created="Sun, 30 Oct 2011 02:07:26 +0000"/>
                            <attachment id="12501816" name="cassandra-3303-4.patch" size="11332" author="byronclark" created="Tue, 1 Nov 2011 19:48:07 +0000"/>
                            <attachment id="12502214" name="cassandra-3303-5.patch" size="10969" author="byronclark" created="Thu, 3 Nov 2011 20:18:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[byronclark]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>44229</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 3 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gi9r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94390</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>