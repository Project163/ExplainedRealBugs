<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:03:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11907] 2i behaviour is different in different versions</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11907</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt; I think I have found more cases where 2i behave different in different Cassandra versions, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11510&quot; title=&quot;Clustering key and secondary index&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11510&quot;&gt;&lt;del&gt;CASSANDRA-11510&lt;/del&gt;&lt;/a&gt; solved one such case but I think there are a few more.&lt;/p&gt;

&lt;p&gt;I get one behaviour with 2.1.14 and Trunk and I think this is the correct one. With 2.2.7 and 3.0.6 the behaviour is different.&lt;/p&gt;

&lt;p&gt;To test this I used ccm to setup one node clusters with the different versions, I prepared each cluster with these commands:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;CREATE&lt;/span&gt; KEYSPACE test &lt;span class=&quot;code-keyword&quot;&gt;WITH&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;replication&lt;/span&gt; = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;NetworkTopologyStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;datacenter1&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt; };
&lt;span class=&quot;code-keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;TABLE&lt;/span&gt; test.table1 (&lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;text&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt;,inter &lt;span class=&quot;code-keyword&quot;&gt;text&lt;/span&gt;,foo &lt;span class=&quot;code-keyword&quot;&gt;text&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;power&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;PRIMARY&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;KEY&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt;, class, inter, foo)) &lt;span class=&quot;code-keyword&quot;&gt;WITH&lt;/span&gt; CLUSTERING &lt;span class=&quot;code-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;BY&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;DESC&lt;/span&gt;, inter &lt;span class=&quot;code-keyword&quot;&gt;ASC&lt;/span&gt;);
&lt;span class=&quot;code-keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;INDEX&lt;/span&gt; table1_power &lt;span class=&quot;code-keyword&quot;&gt;ON&lt;/span&gt; test.table1 (&lt;span class=&quot;code-keyword&quot;&gt;power&lt;/span&gt;) ;
&lt;span class=&quot;code-keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;TABLE&lt;/span&gt; test.table2 (&lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;text&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt;,inter &lt;span class=&quot;code-keyword&quot;&gt;text&lt;/span&gt;,foo &lt;span class=&quot;code-keyword&quot;&gt;text&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;power&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;PRIMARY&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;KEY&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt;, class, inter, foo)) &lt;span class=&quot;code-keyword&quot;&gt;WITH&lt;/span&gt; CLUSTERING &lt;span class=&quot;code-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;BY&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;DESC&lt;/span&gt;, inter &lt;span class=&quot;code-keyword&quot;&gt;ASC&lt;/span&gt;);
&lt;span class=&quot;code-keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;INDEX&lt;/span&gt; table2_inter &lt;span class=&quot;code-keyword&quot;&gt;ON&lt;/span&gt; test.table2 (inter) ;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I executed two select quieries on each cluster:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; * &lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; test.table1 &lt;span class=&quot;code-keyword&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&apos;R1&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class&amp;&lt;/span&gt;gt;0 &lt;span class=&quot;code-keyword&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class&amp;&lt;/span&gt;lt;4 &lt;span class=&quot;code-keyword&quot;&gt;AND&lt;/span&gt; inter=&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;int1&lt;/span&gt;&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;power&lt;/span&gt;=18 ALLOW FILTERING;
&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; * &lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; test.table2 &lt;span class=&quot;code-keyword&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&apos;R1&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class&amp;&lt;/span&gt;gt;0 &lt;span class=&quot;code-keyword&quot;&gt;AND&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class&amp;&lt;/span&gt;lt;4 &lt;span class=&quot;code-keyword&quot;&gt;AND&lt;/span&gt; inter=&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;int1&lt;/span&gt;&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;AND&lt;/span&gt; foo=&lt;span class=&quot;code-quote&quot;&gt;&apos;aa&apos;&lt;/span&gt; ALLOW FILTERING;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On 2.1.14 and Trunk they where successful. But on 2.2.7 and 3.0.6 they failed, the first one with &lt;tt&gt;InvalidRequest: code=2200 &lt;span class=&quot;error&quot;&gt;&amp;#91;Invalid query&amp;#93;&lt;/span&gt; message=&quot;Clustering column &quot;inter&quot; cannot be restricted (preceding column &quot;class&quot; is restricted by a non-EQ relation)&quot;&lt;/tt&gt; and the second one with &lt;tt&gt;InvalidRequest: code=2200 &lt;span class=&quot;error&quot;&gt;&amp;#91;Invalid query&amp;#93;&lt;/span&gt; message=&quot;Clustering column &quot;foo&quot; cannot be restricted (preceding column &quot;inter&quot; is restricted by a non-EQ relation)&quot;&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I could get the queries to execute successfully on 2.2.7 and 3.0.6 by creating two more 2i:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;INDEX&lt;/span&gt; table1_inter &lt;span class=&quot;code-keyword&quot;&gt;ON&lt;/span&gt; test.table1 (inter) ;
&lt;span class=&quot;code-keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;INDEX&lt;/span&gt; table2_foo &lt;span class=&quot;code-keyword&quot;&gt;ON&lt;/span&gt; test.table2 (foo) ;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12973426">CASSANDRA-11907</key>
            <summary>2i behaviour is different in different versions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ifesdjeen">Alex Petrov</assignee>
                                    <reporter username="tommy_s">Tommy Stendahl</reporter>
                        <labels>
                    </labels>
                <created>Fri, 27 May 2016 14:23:30 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:31 +0000</updated>
                            <resolved>Mon, 4 Jul 2016 12:50:05 +0000</resolved>
                                                            <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15343880" author="ifesdjeen" created="Wed, 22 Jun 2016 08:08:42 +0000"  >&lt;p&gt;Even though this type of query is allowed in &lt;tt&gt;2.1.14&lt;/tt&gt;, unfortunately it doesn&apos;t work there properly as one of the filters is not added:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE KEYSPACE test WITH replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;NetworkTopologyStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;datacenter1&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt; };
use test;
CREATE TABLE table1 (pk &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,c1 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,c2 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,c3 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,v &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,PRIMARY KEY (pk, c1,c2,c3));

INSERT INTO table1 (pk,c1,c2,c3,v) VALUES (1,1,1,1,1);
INSERT INTO table1 (pk,c1,c2,c3,v) VALUES (1,1,1,1,1);
INSERT INTO table1 (pk,c1,c2,c3,v) VALUES (1,1,1,1,1);
INSERT INTO table1 (pk,c1,c2,c3,v) VALUES (1,1,1,1,1);

INSERT INTO table1 (pk,c1,c2,c3,v) VALUES (1,1,1,1,2);
INSERT INTO table1 (pk,c1,c2,c3,v) VALUES (1,1,1,2,2);
INSERT INTO table1 (pk,c1,c2,c3,v) VALUES (1,1,2,2,2);
INSERT INTO table1 (pk,c1,c2,c3,v) VALUES (1,2,2,2,2);

INSERT INTO table1 (pk,c1,c2,c3,v) VALUES (1,1,1,1,3);
INSERT INTO table1 (pk,c1,c2,c3,v) VALUES (1,1,1,3,3);
INSERT INTO table1 (pk,c1,c2,c3,v) VALUES (1,1,3,3,3);
INSERT INTO table1 (pk,c1,c2,c3,v) VALUES (1,3,3,3,3);

INSERT INTO table1 (pk,c1,c2,c3,v) VALUES (1,1,1,1,4);
INSERT INTO table1 (pk,c1,c2,c3,v) VALUES (1,1,1,4,4);
INSERT INTO table1 (pk,c1,c2,c3,v) VALUES (1,1,4,4,4);
INSERT INTO table1 (pk,c1,c2,c3,v) VALUES (1,4,4,4,4);

INSERT INTO table1 (pk,c1,c2,c3,v) VALUES (1,1,1,1,5);
INSERT INTO table1 (pk,c1,c2,c3,v) VALUES (1,1,1,5,3);
INSERT INTO table1 (pk,c1,c2,c3,v) VALUES (1,1,5,5,3);
INSERT INTO table1 (pk,c1,c2,c3,v) VALUES (1,5,5,5,3);

create index table1_v ON table1(v);

cqlsh:test&amp;gt; select * from table1 WHERE pk = 1 AND  c1 &amp;gt; 0 AND c1 &amp;lt; 5 AND c2 = 1 AND v = 3 ALLOW FILTERING;

 pk | c1 | c2 | c3 | v
----+----+----+----+---
  1 |  1 |  1 |  3 | 3
  1 |  1 |  1 |  5 | 3
  1 |  1 |  3 |  3 | 3
  1 |  1 |  5 |  5 | 3
  1 |  3 |  3 |  3 | 3
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In order to fix the issue for &lt;tt&gt;2.2&lt;/tt&gt; and &lt;tt&gt;3.0&lt;/tt&gt;, I&apos;ve moved the validation from &lt;tt&gt;PrimaryKeyRestrictionSet&lt;/tt&gt; to the special method. Since restrictions are already given in sorted order, there&apos;s no distinction between the previously existing two error messages (where slice is supplied in preceding column, and same situation but columns are given out of order), like: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh:test&amp;gt; select * from table1 WHERE pk = 1 AND  c1 &amp;gt; 0 AND c1 &amp;lt; 5 AND c2 = 1;
InvalidRequest: code=2200 [Invalid query] message=&lt;span class=&quot;code-quote&quot;&gt;&quot;Clustering column &quot;&lt;/span&gt;c2&lt;span class=&quot;code-quote&quot;&gt;&quot; cannot be restricted (preceding column &quot;&lt;/span&gt;c1&lt;span class=&quot;code-quote&quot;&gt;&quot; is restricted by a non-EQ relation)&quot;&lt;/span&gt;
cqlsh:test&amp;gt; select * from table1 WHERE pk = 1 AND  c2 = 1 AND c1 &amp;gt; 0 AND c1 &amp;lt; 5;
InvalidRequest: code=2200 [Invalid query] message=&lt;span class=&quot;code-quote&quot;&gt;&quot;PRIMARY KEY column &quot;&lt;/span&gt;c2&lt;span class=&quot;code-quote&quot;&gt;&quot; cannot be restricted (preceding column &quot;&lt;/span&gt;c1&lt;span class=&quot;code-quote&quot;&gt;&quot; is restricted by a non-EQ relation)&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Problem is that during creation of &lt;tt&gt;PrimaryKeyRestrictionSet&lt;/tt&gt; we do not know if query touches 2i, since 2i restriction might be supplied later (for example, on &quot;regular&quot; column). So we have to push the validation logic further. Another problem was that row filter (index expression in 2.x) was not adding all clustering columns that would require filtering. Trunk branch contains tests only (with minor removal). Patches for 2.2 and 3.0 are almost identical, but unfortunately do not merge cleanly. &lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/11907-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11907-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11907-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/11907-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 &lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11907-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11907-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/11907-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk &lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11907-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15347178" author="ifesdjeen" created="Thu, 23 Jun 2016 21:03:59 +0000"  >&lt;p&gt;2.1 patch is quite different from the other ones, as it was pre-&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7981&quot; title=&quot;Refactor SelectStatement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7981&quot;&gt;&lt;del&gt;CASSANDRA-7981&lt;/del&gt;&lt;/a&gt;. I&apos;ve tried to keep the logic similar to current one: if there&apos;s a slice restriction (single or multiple), the next restriction has to use filtering. Previously, one of the columns (&lt;tt&gt;c2&lt;/tt&gt; in previous comment) was removed from &lt;tt&gt;restrictedColumns&lt;/tt&gt;, but slice bounds were not really taking it into account, so we were getting extra results.&lt;/p&gt;

&lt;p&gt;Comments on &lt;tt&gt;2.2&lt;/tt&gt; and &lt;tt&gt;3.0&lt;/tt&gt; are same.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/11907-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11907-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11907-2.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/11907-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11907-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11907-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/11907-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 &lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11907-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11907-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/11907-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk &lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11907-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15350964" author="blerer" created="Mon, 27 Jun 2016 13:13:56 +0000"  >&lt;p&gt;I have the following remarks:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;It seems that the patches for &lt;tt&gt;2.2&lt;/tt&gt; and &lt;tt&gt;3.0&lt;/tt&gt; is breaking the behaviour for partition key restrictions.&lt;br/&gt;
The problem can be reproduced with the following test
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testIndexQueryWithCompositePartitionKey() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Throwable
    {
        createTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE %s (p1 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, p2 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, v &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, PRIMARY KEY ((p1, p2)))&quot;&lt;/span&gt;);
        createIndex(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE INDEX ON %s(v)&quot;&lt;/span&gt;);

        execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s(p1, p2, v) values (?, ?, ?)&quot;&lt;/span&gt;, 1, 1, 3);
        execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s(p1, p2, v) values (?, ?, ?)&quot;&lt;/span&gt;, 1, 2, 3);
        execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s(p1, p2, v) values (?, ?, ?)&quot;&lt;/span&gt;, 2, 1, 3);

        assertRows(execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM %s WHERE p1 = 1 AND v = 3 ALLOW FILTERING&quot;&lt;/span&gt;),
                   row(1, 2, 3),
                   row(1, 1, 3));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;In  the patches for &lt;tt&gt;2.2&lt;/tt&gt; and &lt;tt&gt;3.0&lt;/tt&gt;, in &lt;tt&gt;addIndexExpressionTo&lt;/tt&gt;, I do not really understand the last part of the statement:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (slice != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !slice.getFirstColumn().equals(restriction.getFirstColumn()))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I might be mistaken but I do not think that we can have a case where 2 restrictions overlap.&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;Same comment for the &lt;tt&gt;2.1&lt;/tt&gt; patch for:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lastSliceRestriction != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !restriction.equals(lastSliceRestriction))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;In &lt;tt&gt;addIndexExpressionTo&lt;/tt&gt; it seems to me that the 2 first &lt;tt&gt;if&lt;/tt&gt; statements should be merged into one.&lt;/li&gt;
	&lt;li&gt;I would be in favor of moving the code from &lt;tt&gt;validate&lt;/tt&gt; into &lt;tt&gt;StatementRestrictions&lt;/tt&gt; by making &lt;tt&gt;PrimaryKeyRestrictionSet&lt;/tt&gt; implements &lt;tt&gt;Iterable&amp;lt;Restriction&amp;gt;&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;In &lt;tt&gt;testFilteringWithSecondaryIndex&lt;/tt&gt;,
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 5; i++)
        {
            &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; j = i + 1;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;can be simplified to:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 1; i &amp;lt;= 5; i++)
        {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;While looking at &lt;tt&gt;MultiColumnRestrictions.Slice::addIndexExpressionTo&lt;/tt&gt; I realized that the error message could be confusing if such a restriction was used within an index query. I checked the tests and it does not seems that we have any test that test secondary index query with two multicolumn slice restrictions. Could you add one?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15353539" author="ifesdjeen" created="Tue, 28 Jun 2016 19:03:18 +0000"  >&lt;p&gt;Thank you for the review!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;It seems that the patches for 2.2 and 3.0 is breaking the behaviour for partition key restrictions.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You&apos;re right. I was too concentrated on making slice restrictions compatible that missed the existing condition. It is now re-added and corresponding test is in all branches now.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;In the patches for 2.2 and 3.0, in &lt;tt&gt;addIndexExpressionTo&lt;/tt&gt;, I do not really understand the last part of the statement:&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;ve simplified this for &lt;tt&gt;2.2&lt;/tt&gt;, &lt;tt&gt;3.0&lt;/tt&gt; and &lt;tt&gt;trunk&lt;/tt&gt;. This turned out to be redundant for all branches, as using &lt;tt&gt;!isSlice&lt;/tt&gt; to assign the next position is sufficient to resolve that correctly. I&apos;ve made similar change to simplify {{needsFiltering}.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Same comment for the 2.1 patch ...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;(discussed offline, summary here) since we&apos;re adding a column multiple times for the same restriction, we have to check for whether the column is still same for slice or no.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I would be in favor of moving the code from validate into StatementRestrictions by making PrimaryKeyRestrictionSet implements Iterable&amp;lt;Restriction&amp;gt;.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree, moved.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;In testFilteringWithSecondaryIndex,&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Test condition adjusted. It was historically looking different, I should&apos;ve optimised it myself.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;While looking at MultiColumnRestrictions.Slice::addIndexExpressionTo I realized that the error message could be confusing if such a restriction was used within an index query.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed, wording changed to &lt;tt&gt;Multi-column restrictions can only be applied to a single set of clustering columns.&lt;/tt&gt; and corresponding tests added&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/11907-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11907-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11907-2.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/11907-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11907-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11907-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/11907-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 &lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11907-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11907-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/11907-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk &lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11907-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11907-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15361231" author="blerer" created="Mon, 4 Jul 2016 12:16:57 +0000"  >&lt;p&gt;Thanks for the patch. +1&lt;/p&gt;</comment>
                            <comment id="15361260" author="blerer" created="Mon, 4 Jul 2016 12:50:05 +0000"  >&lt;p&gt;Committed into 2.1 at c857919b40b9fb27139424944e9fb6cc58befc48 and merged into 2.2, 3.0, 3.9 and trunk&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12956454">CASSANDRA-11510</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 20 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ylov:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12334783">2.1.14</customfieldvalue>
    <customfieldvalue id="12335581">2.2.7</customfieldvalue>
    <customfieldvalue id="12335502">3.0.6</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blerer</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12334272">2.2.5</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>