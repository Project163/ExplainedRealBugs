<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:29:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-19120] local consistencies may get timeout if blocking read repair is sending the read repair mutation to other DC </title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-19120</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;For a two DCs cluster setup. When a new node is being added to DC1, for blocking read repair triggered by local_quorum in DC1, it will require to send read repair mutation to an extra node(1)(2). The selector for read repair may select &lt;b&gt;ANY&lt;/b&gt;&#160;node that has not been contacted before(3) instead of selecting the DC1 nodes. If a node from DC2 is selected, this will cause 100% timeout because of the bug described below:&lt;/p&gt;

&lt;p&gt;When we initialized the latch(4) for blocking read repair, the shouldBlockOn function will only return true for local nodes(5), the blockFor value will be reduced if a local node doesn&apos;t require repair(6). The blockFor is same as the number of read repair mutation sent out. But when the coordinator node receives the response from the target nodes, the latch only count down for nodes in same DC(7). The latch will wait till timeout and the read request will timeout.&lt;/p&gt;

&lt;p&gt;This can be reproduced if you have a constant load on a 3 + 3 cluster when adding a node. If you have someway to trigger blocking read repair(maybe by adding load using stress tool). If you use local_quorum consistency with a constant read after write load in the same DC that you are adding node. You will see read timeout issue from time to time because of the bug described above&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think for read repair when selecting the extra node to do repair, we should prefer local nodes than the nodes from other region. Also, we need to fix the latch part so even if we send mutation to the nodes in other DC, we don&apos;t get a timeout.&lt;/p&gt;

&lt;p&gt;(1)&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.0.11/src/java/org/apache/cassandra/locator/ReplicaPlans.java#L455&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-4.0.11/src/java/org/apache/cassandra/locator/ReplicaPlans.java#L455&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(2)&lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/ConsistencyLevel.java#L183&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/ConsistencyLevel.java#L183&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(3)&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.0.11/src/java/org/apache/cassandra/locator/ReplicaPlans.java#L458&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-4.0.11/src/java/org/apache/cassandra/locator/ReplicaPlans.java#L458&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(4)&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.0.11/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L96&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-4.0.11/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L96&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(5)&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.0.11/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L71&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-4.0.11/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L71&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(6)&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.0.11/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L88&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-4.0.11/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L88&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(7)&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.0.11/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L113&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-4.0.11/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L113&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13559980">CASSANDRA-19120</key>
            <summary>local consistencies may get timeout if blocking read repair is sending the read repair mutation to other DC </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="curlylrt">Runtian Liu</assignee>
                                    <reporter username="curlylrt">Runtian Liu</reporter>
                        <labels>
                    </labels>
                <created>Wed, 29 Nov 2023 22:59:31 +0000</created>
                <updated>Tue, 26 Mar 2024 10:38:28 +0000</updated>
                            <resolved>Thu, 22 Feb 2024 23:14:07 +0000</resolved>
                                        <fixVersion>4.0.13</fixVersion>
                    <fixVersion>4.1.5</fixVersion>
                    <fixVersion>5.0-rc1</fixVersion>
                    <fixVersion>5.0</fixVersion>
                    <fixVersion>5.1</fixVersion>
                                    <component>Consistency/Repair</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17791366" author="smiklosovic" created="Wed, 29 Nov 2023 23:18:38 +0000"  >&lt;p&gt;Interesting issue, let me see it in more depth ...&#160;&lt;/p&gt;</comment>
                            <comment id="17791368" author="JIRAUSER291682" created="Wed, 29 Nov 2023 23:24:11 +0000"  >&lt;p&gt;We ran into this issue when upgrading from 3.0 to 4.0. Application get more timeouts caused by blocking read repair when doing node replacement by adding one new node followed by decommission the old node. After applying a hot fix like this, the issue is gone. But I think we still need to fix the latch part.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13064826/13064826_image-2023-11-29-15-26-08-056.png&quot; height=&quot;341&quot; width=&quot;511&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17791377" author="JIRAUSER283332" created="Thu, 30 Nov 2023 00:07:00 +0000"  >&lt;p&gt;Have you considered to get rid of read repairs completely? It has questionable benefits. Also, do you use dclocal read repair?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://thelastpickle.com/blog/2021/01/12/get_rid_of_repair_repair_chance.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://thelastpickle.com/blog/2021/01/12/get&amp;amp;#95;rid&amp;amp;#95;of&amp;amp;#95;repair&amp;amp;#95;repair&amp;amp;#95;chance.html&lt;/a&gt;[https_thelastpickle.com_blog_2021_01_12_get_rid_of_repair_repair_chance.html]&lt;/p&gt;


&lt;p&gt;Sent from ProtonMail mobile&lt;/p&gt;



&lt;p&gt;\&lt;/p&gt;</comment>
                            <comment id="17791411" author="JIRAUSER291682" created="Thu, 30 Nov 2023 02:21:34 +0000"  >&lt;p&gt;I think dclocal read repair is removed in 4.0.&lt;/p&gt;</comment>
                            <comment id="17791490" author="smiklosovic" created="Thu, 30 Nov 2023 07:06:06 +0000"  >&lt;p&gt;Disable all read repair altogether everywhere in 3.0.&lt;/p&gt;

&lt;p&gt;There is not (dclocal)_read_repair_chance in table parameters anymore in 4.0.&#160; There is only &quot;read_repair&quot; which is either BLOCKING or NONE.&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/reads/repair/BlockingReadRepair.java#L45-L49&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/reads/repair/BlockingReadRepair.java#L45-L49&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/reads/repair/ReadOnlyReadRepair.java#L33-L36&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/reads/repair/ReadOnlyReadRepair.java#L33-L36&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/reads/repair/ReadRepairStrategy.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/reads/repair/ReadRepairStrategy.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;3.0 and 3.11 have &quot;read_repair_chance&quot; and &quot;dclocal_read_repair_chance&quot;. 4.0+ has only &quot;read_repair&quot; which is either NONE or BLOCKING.&lt;/p&gt;

&lt;p&gt;You said that you hit this issue when upgrading from 3.0 to 4.0 so my idea is to set both dc and read_repair_chance to 0.0 to effectively turn it off and then this will not happen no?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/config/CFMetaData.java#L720-L730&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/config/CFMetaData.java#L720-L730&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;What I want to say is that I dont know what it has in common when you are doing upgrades from 3.0 to 4.0.&lt;/p&gt;</comment>
                            <comment id="17791500" author="smiklosovic" created="Thu, 30 Nov 2023 08:18:31 +0000"  >&lt;p&gt;Anyway ... I think your issue is fixed in trunk (to be 5.1), if you look closely here (1) (this is trunk) and&#160; you compare it with 5.0 (2), in trunk, there is &quot;adjustedBlockFor&quot; and then it is set to &quot;blockFor&quot; which is used in int blockFor() method in that class. In 5.0, this is not there, so int blockFor() will use &quot;writePlan.writeQuorum();&quot; and I think this is the source of that timeout because we are waiting for replicas from other DC in a blocking manner but trunk does not block on replicas from remote DCs.&lt;/p&gt;

&lt;p&gt;(1) &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L83-L91&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L83-L91&lt;/a&gt;&lt;br/&gt;
(2)&#160;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-5.0/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L83-L92&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-5.0/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L83-L92&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17791680" author="brandon.williams" created="Thu, 30 Nov 2023 15:24:20 +0000"  >&lt;p&gt;We should backport that to 4.0 and 4.1.&lt;/p&gt;</comment>
                            <comment id="17791722" author="chovatia.jaydeep@gmail.com" created="Thu, 30 Nov 2023 17:43:35 +0000"  >&lt;p&gt;I don&apos;t think so; this is completely resolved in the &lt;em&gt;trunk&lt;/em&gt; yet. We are still not adjusting the &lt;em&gt;latch&lt;/em&gt; if the &lt;em&gt;pendingRepairs&lt;/em&gt; include a node from the remote region.&lt;/p&gt;

&lt;p&gt;Let me explain with the following scenario:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;em&gt;pendingRepairs&lt;/em&gt; at line number 81 &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; has 1 node from the local region and another node from a remote region&lt;/li&gt;
	&lt;li&gt;At line number 100 &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;em&gt;blockFor&lt;/em&gt; will be 2, i.e., the latch will be 2&lt;/li&gt;
	&lt;li&gt;When the local node responds, then at line no 122 &lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;, it includes the response, i.e., the latch will be decremented as &lt;b&gt;&lt;font color=&quot;#00875a&quot;&gt;expected&lt;/font&gt;&lt;/b&gt;&lt;/li&gt;
	&lt;li&gt;When the remote node responds, then at line no 122 &lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;, it &lt;font color=&quot;#de350b&quot;&gt;excludes&lt;/font&gt; the response, i.e., the latch will not be &lt;font color=&quot;#de350b&quot;&gt;decremented&lt;/font&gt;, and this is the &lt;b&gt;&lt;font color=&quot;#ff0000&quot;&gt;problem&lt;/font&gt;&lt;/b&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Could you please double-check the above scenario?&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L81&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L81&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L100&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L122&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L122&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17791731" author="JIRAUSER291682" created="Thu, 30 Nov 2023 18:32:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt; I think trunk(5.1) and 5.0 is basically same. Although 5.0 the int blockFor() function is returning &quot;writePlan.writeQuorum();&quot;, looks like the function is never called. The latch is still initialized with the local variable blockFor in the constructor. This is same as the trunk version of adjustedBlockFor. The problem here for blocking read repair is that the cross DC node has not been contacted before(No read from the cross DC node). It&apos;s the &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/locator/ReplicaPlans.java#L411&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;selector&lt;/a&gt; which is requiring 1 extra node to response when applying read repair mutation &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/locator/ReplicaPlans.java#L572&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;[1]&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;This means for replication factor 3 in each DC, sending read request with local_quorum assuming no speculative retry is triggered. When we get digest mismatch, blocking read repair will start. For normal scenario, blocking read repair will only try to repair the replicas that have been contacted(read) before, also we want to satisfy the consistency blockFor. If blockFor is larger than the number of replicas contacted before, we will add more nodes to apply the read-repair-mutation. For normal cases, blockFor should be same as the number of nodes contacted before. However, if we are adding a node in the same DC, the blockFor will be blockFor + pending which requires one more node to be repaired. And this &quot;one more node&quot; can be any node that has not been contacted before. As mentioned, the while the latch is initialized with number of nodes that the read-repair-mutations have been sent to but only count down when getting response from same DC. The coordinator node will get timeout 100% if a cross DC node is selected to perform the read-repair-mutation.&lt;/p&gt;</comment>
                            <comment id="17791744" author="smiklosovic" created="Thu, 30 Nov 2023 19:05:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chovatia.jaydeep%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;chovatia.jaydeep@gmail.com&quot;&gt;chovatia.jaydeep@gmail.com&lt;/a&gt; in your point 2), how did you come to the conclusion that blockFor (hence latch) will be set to 2? Could you elaborate point 2) in more detail?&lt;/p&gt;</comment>
                            <comment id="17791756" author="chovatia.jaydeep@gmail.com" created="Thu, 30 Nov 2023 19:52:24 +0000"  >&lt;p&gt;Sure.&lt;/p&gt;

&lt;p&gt;Say we are reading with LOCAL_QUORUM with a replication factor of 3. Now, let&apos;s understand the input parameters for the following:&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; BlockingPartitionRepair(DecoratedKey key, Map&amp;lt;Replica, Mutation&amp;gt; repairs, ReplicaPlan.ForWrite repairPlan, Predicate&amp;lt;InetAddressAndPort&amp;gt; shouldBlockOn) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;ins&gt;&lt;em&gt;repairPlan&lt;/em&gt;&lt;/ins&gt;: This could have two local nodes &lt;em&gt;L1, L2&lt;/em&gt; and one remote node &lt;em&gt;R1&lt;/em&gt; as the &lt;em&gt;Selector&lt;/em&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; could select the remote node as&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=curlylrt&quot; class=&quot;user-hover&quot; rel=&quot;curlylrt&quot;&gt;curlylrt&lt;/a&gt; mentioned above. So &lt;em&gt;repairPlan&lt;/em&gt; parameter has {&lt;em&gt;L1, L2, R1&lt;/em&gt;}&lt;/li&gt;
	&lt;li&gt;&lt;ins&gt;&lt;em&gt;repairs&lt;/em&gt;&lt;/ins&gt;: This also has &lt;em&gt;L1&lt;/em&gt; and &lt;em&gt;R1&lt;/em&gt; because these two might be stale and require an update. L2 is not included as it has the latest data.&lt;/li&gt;
	&lt;li&gt;Now, at the following line, &lt;em&gt;pendingRepairs&lt;/em&gt; will have two nodes {&lt;em&gt;L1, R1&lt;/em&gt;}.&#160;&#160;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.pendingRepairs = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConcurrentHashMap&amp;lt;&amp;gt;(repairs); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;&#160;so &lt;em&gt;adjustedBlockFor&lt;/em&gt; will be set to 3 at the following line:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; adjustedBlockFor = repairPlan.writeQuorum(); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Let&apos;s analyse L1, L2, and R1 for the following condition:&#160;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!repairs.containsKey(participant) &amp;amp;&amp;amp; shouldBlockOn.test(participant.endpoint())) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;
	&lt;ul&gt;
		&lt;li&gt;L1: &lt;em&gt;false&lt;/em&gt; as it is a participant&lt;/li&gt;
		&lt;li&gt;L2: &lt;em&gt;true&lt;/em&gt; as it is not a participant and local as well //&lt;em&gt;adjustedBlockFor&lt;/em&gt; 3--&amp;gt;2&lt;/li&gt;
		&lt;li&gt;R1: &lt;em&gt;false&lt;/em&gt; as it is a participant&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;The following lines sets &lt;em&gt;blockFor&lt;/em&gt; and &lt;em&gt;latch&lt;/em&gt; to the value 2&#160;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.blockFor = adjustedBlockFor; 
...
latch = newCountDownLatch(&lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.max(blockFor, 0));&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;But when we receive a response from &lt;em&gt;R1&lt;/em&gt;, then line 122 &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;&#160;&lt;font color=&quot;#de350b&quot;&gt;excludes&lt;/font&gt; the response, as a result, the latch does not decrement&#160;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    void ack(InetAddressAndPort from)
&#160; &#160; {
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldBlockOn.test(from))
&#160; &#160; &#160; &#160; {
&#160; &#160; &#160; &#160; &#160; &#160; pendingRepairs.remove(repairPlan.lookup(from));
&#160; &#160; &#160; &#160; &#160; &#160; latch.decrement();
&#160; &#160; &#160; &#160; }
&#160; &#160; } &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/locator/ReplicaPlans.java#L411&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/locator/ReplicaPlans.java#L411&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L122C9-L122C9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L122C9-L122C9&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17791801" author="smiklosovic" created="Thu, 30 Nov 2023 21:37:26 +0000"  >&lt;p&gt;If we have a keyspace with RF 3 and we do a read with CL LOCAL_QUORUM, then this (looking into trunk version of that)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; adjustedBlockFor = repairPlan.writeQuorum();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;will be set here (1). writeQuorum is computed in the constructor above, and that is computed in (2). It will firstly compute blockFor from the consistency level for LOCAL_QUORUM when RF is 3 which will be 2 (line 176) and since we have LOCAL_QUORUM it will go to the case where it does&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
blockFor += pending.count(InOurDc.replicas());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and since we are assuming that pending is not in local DC, it will add 0 to 2 which is 2 so yeah, adjustedBlockFor will be 2. We are on the same page here.&lt;/p&gt;

&lt;p&gt;Now this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; adjustedBlockFor = repairPlan.writeQuorum();
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Replica participant : repairPlan.contacts())
        {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!repairs.containsKey(participant) &amp;amp;&amp;amp; shouldBlockOn.test(participant.endpoint()))
                adjustedBlockFor--;
        }
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.blockFor = adjustedBlockFor;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is a little bit confusing to go through but in order to decrement adjustedBlockFor (which is 2 at the beginning of this loop), any participant of the repairPlan (contacts) has to be in the local dc (in order to have shouldBlockOn returning true when it is InOurDc.endpoints()).&lt;/p&gt;

&lt;p&gt;repairPlan.contacts() in that loop will ultimately take these contacts from (3). In that selector, (4)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; add = consistencyLevel.blockForWrite(liveAndDown.replicationStrategy(), liveAndDown.pending()) - contacts.size();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;blockForWrite will be called with strategy with RF = 3, LOCAL_QUORUM is 2, pending might be one, so it will do again &quot;blockFor += pending.count(InOurDc.replicas());&quot; which will be 2 += 0 = 2. In order to have add at least 1, when blockForWrite returns 2, contacts.size() has to be 1 (2 - 1 = 1). Then it goes through live replicas and it will choose some which was not contacted &lt;b&gt;and here it might pick remote replica&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt;so if we return to that &quot;if&quot;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!repairs.containsKey(participant) &amp;amp;&amp;amp; shouldBlockOn.test(participant.endpoint()))
                adjustedBlockFor--;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;participant can be remote, so &quot;repairs.containsKey(participant)&quot; is &quot;false&quot; (when repairs are all local), so &quot;!repairs.containsKey(participant)&quot; is true. Then the second clause, shouldBlock, will evaluate to false, because participant is not local and shouldBlockOn is InOurDc.endpoints. So true &amp;amp;&amp;amp; false = false. So &quot;adjustedBlockFor&quot; will not be decremented. But I think that it should be, because we are not going to block for remote participants. If it is not decremented, then blockFor will be set to 2 but it should be set only to 1. If it is set to 2, then this&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    void ack(InetAddressAndPort from)
    {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldBlockOn.test(from))
        {
            pendingRepairs.remove(repairPlan.lookup(from));
            latch.decrement();
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;will decrement it just once, from 2 to 1 and it will never reach 0.&lt;/p&gt;

&lt;p&gt;So it seems to me that we should do this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!repairs.containsKey(participant) &amp;amp;&amp;amp; !shouldBlockOn.test(participant.endpoint()))
                adjustedBlockFor--;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Notice the negation for shouldBlockOn. We should not block on remotes. shouldBlockOn will return true when participant is local. In order to not block on remote participants, (!shouldNotBlockOn) should be true, that is only when shouldNotBlockOn is false. That is only when participant is remote one.&lt;/p&gt;

&lt;p&gt;Or maybe I am completely wrong? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Would you guys be so nice to go through this and proof read it?&lt;/p&gt;

&lt;p&gt;(1) &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/locator/ReplicaPlan.java#L326-L329&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/locator/ReplicaPlan.java#L326-L329&lt;/a&gt;&lt;br/&gt;
(2) &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/ConsistencyLevel.java#L181-L184&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/ConsistencyLevel.java#L181-L184&lt;/a&gt;&lt;br/&gt;
(3) &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/locator/ReplicaPlans.java#L577&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/locator/ReplicaPlans.java#L577&lt;/a&gt;&lt;br/&gt;
(4) &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/locator/ReplicaPlans.java#L572&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/locator/ReplicaPlans.java#L572&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17791805" author="JIRAUSER291682" created="Thu, 30 Nov 2023 22:03:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;and since we are assuming that pending is not in local DC, it will add 0 to 2 which is 2 so yeah, adjustedBlockFor will be 2. We are on the same page here.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The pending is in local DC. Because we are adding a node in local DC. So the adjustedBlockFor is 3 not 2.&lt;/p&gt;</comment>
                            <comment id="17791806" author="smiklosovic" created="Thu, 30 Nov 2023 22:06:04 +0000"  >&lt;p&gt;Then I dont understand how &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chovatia.jaydeep%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;chovatia.jaydeep@gmail.com&quot;&gt;chovatia.jaydeep@gmail.com&lt;/a&gt;&#160; concluded that initial&#160;adjustedBlockFor is 2. This&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
blockFor += pending.count(InOurDc.replicas());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;will be then 3.&lt;/p&gt;</comment>
                            <comment id="17791807" author="smiklosovic" created="Thu, 30 Nov 2023 22:09:44 +0000"  >&lt;p&gt;Anyway, that does not matter. Whole post can be read with pending being local. It is same thing.&lt;/p&gt;

&lt;p&gt;It is the combination of this adding remote replicas&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Replica replica : filter(live.all(), r -&amp;gt; !contacts.contains(r)))
                        {
                            contacts.add(replica);
                            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (--add == 0)
                                &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
                        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and this&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!repairs.containsKey(participant) &amp;amp;&amp;amp; shouldBlockOn.test(participant.endpoint()))
                adjustedBlockFor--;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;not decrementing when participant is remote.&lt;/p&gt;</comment>
                            <comment id="17791808" author="chovatia.jaydeep@gmail.com" created="Thu, 30 Nov 2023 22:14:43 +0000"  >&lt;p&gt;Yeah, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=curlylrt&quot; class=&quot;user-hover&quot; rel=&quot;curlylrt&quot;&gt;curlylrt&lt;/a&gt;, &lt;em&gt;adjustedBlockFor&lt;/em&gt; would be 3 instead of 2.&lt;/p&gt;</comment>
                            <comment id="17791810" author="JIRAUSER291682" created="Thu, 30 Nov 2023 22:20:48 +0000"  >&lt;p&gt;Anyway, that does not matter. Whole post can be read with pending being local. It is same thing.&lt;/p&gt;

&lt;p&gt;It is the combination of this adding remote replicas&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Replica replica : filter(live.all(), r -&amp;gt; !contacts.contains(r)))
                        {
                            contacts.add(replica);
                            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (--add == 0)
                                &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
                        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and this&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!repairs.containsKey(participant) &amp;amp;&amp;amp; shouldBlockOn.test(participant.endpoint()))
                adjustedBlockFor--;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;not decrementing when participant is remote.&lt;/p&gt;

&lt;p&gt;If we have participant which is remote, we will have problem when ack:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
void ack(InetAddressAndPort from)
&#160; &#160; {
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldBlockOn.test(from))
&#160; &#160; &#160; &#160; {
&#160; &#160; &#160; &#160; &#160; &#160; pendingRepairs.remove(repairPlan.lookup(from));
&#160; &#160; &#160; &#160; &#160; &#160; latch.decrement();
&#160; &#160; &#160; &#160; }
&#160; &#160; } &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Remote node won&apos;t get latch count down.&lt;/p&gt;</comment>
                            <comment id="17791811" author="chovatia.jaydeep@gmail.com" created="Thu, 30 Nov 2023 22:31:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;&amp;gt; So it seems to me that we should do this:&lt;/p&gt;

&lt;p&gt;The fix you recommended won&apos;t work because if the remote node is a participant, the condition will always be &lt;em&gt;false&lt;/em&gt; because of the &lt;em&gt;`&amp;amp;&amp;amp;`&lt;/em&gt; operator in the &lt;em&gt;if&lt;/em&gt; loop. It should be an &lt;em&gt;`||&lt;/em&gt;` operator. A slight modification will work:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!repairs.containsKey(participant) || !shouldBlockOn.test(participant.endpoint()))
    adjustedBlockFor--;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17791812" author="smiklosovic" created="Thu, 30 Nov 2023 22:34:12 +0000"  >&lt;p&gt;Whole logic will &quot;end&quot; when latch is 0. Correct? if &quot;from&quot;  in ack() is remote, then it will not enter that &quot;if&quot; so it will not be decremented. But that is all fine, as long as (adjusted)BlockFor contains only blocks for local replicas. Basically we need to set blockFor low enough to get to 0 in ack(). That will be done when we negate shouldBlockFor method in that &quot;if&quot; to exclude remote replicas because remote replicas are not meant to be waited for.&lt;/p&gt;</comment>
                            <comment id="17791813" author="smiklosovic" created="Thu, 30 Nov 2023 22:38:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chovatia.jaydeep%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;chovatia.jaydeep@gmail.com&quot;&gt;chovatia.jaydeep@gmail.com&lt;/a&gt; cool I will run some tests here. Maybe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=curlylrt&quot; class=&quot;user-hover&quot; rel=&quot;curlylrt&quot;&gt;curlylrt&lt;/a&gt; could test this on his end in the meanwhile to verify our logic?&lt;/p&gt;</comment>
                            <comment id="17791814" author="chovatia.jaydeep@gmail.com" created="Thu, 30 Nov 2023 22:46:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=curlylrt&quot; class=&quot;user-hover&quot; rel=&quot;curlylrt&quot;&gt;curlylrt&lt;/a&gt; and I are also suggesting enhancing the &lt;em&gt;Selector&lt;/em&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; code and not selecting&#160;the remote replicas in the first place if the user-specified consistency level is &lt;em&gt;LOCAL&lt;/em&gt;*. So, in short, two fixes we are recommending:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;em&gt;adjustedBlockFor&lt;/em&gt; should count only the local replicas &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; - &lt;font color=&quot;#de350b&quot;&gt;&lt;b&gt;must&lt;/b&gt;&lt;/font&gt;&lt;/li&gt;
	&lt;li&gt;Improve the selector not to select the remote replicas in the first place &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; - &lt;b&gt;&lt;font color=&quot;#ff8b00&quot;&gt;nice to have&lt;/font&gt;&lt;/b&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L88&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L88&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/locator/ReplicaPlans.java#L577&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/locator/ReplicaPlans.java#L577&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;wdyt?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17791816" author="smiklosovic" created="Thu, 30 Nov 2023 22:50:47 +0000"  >&lt;p&gt;Whole research we did was with LOCAL_QUORUM in mind. If we are not on EACH_QUORUM (1), then the selector logic will be also invoked when we are on QUORUM, right? Then, selecting replicas in remote DCs to participate in read repair is perfectly fine, no? We just should not block for them in BlockingPartitionRepair. &lt;/p&gt;

&lt;p&gt;(1) &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/locator/ReplicaPlans.java#L570&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/locator/ReplicaPlans.java#L570&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17791818" author="chovatia.jaydeep@gmail.com" created="Thu, 30 Nov 2023 22:57:45 +0000"  >&lt;p&gt;For &lt;em&gt;QUORUM&lt;/em&gt;, it is okay to have remote nodes, but for &lt;em&gt;LOCAL_QUORUM&lt;/em&gt;, it is better to prioritize local nodes over remote nodes. We can extend the selector code &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; and add a special case for LOCAL_QUORUM to prioritize local node selection first because in a multi-region setup, LOCAL_QUORUM is the most commonly used replication factor.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/locator/ReplicaPlans.java#L572&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/locator/ReplicaPlans.java#L572&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17791820" author="smiklosovic" created="Thu, 30 Nov 2023 23:07:48 +0000"  >&lt;p&gt;I see ... well, I dont know ... something like this?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2953/commits/06069fac4f73882115c325722c2cc7bb9b779080&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2953/commits/06069fac4f73882115c325722c2cc7bb9b779080&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I dont see anything wrong with that special case but we are changing the behavior here and we should be careful. Let&apos;s test this idea first and then we can invite another committer to evaluate it as well.&lt;/p&gt;
</comment>
                            <comment id="17791821" author="smiklosovic" created="Thu, 30 Nov 2023 23:11:47 +0000"  >&lt;p&gt;Well that is not so simple. Yeah as you said, we might prioritize but we should not &lt;em&gt;exclude them&lt;/em&gt;. E.g. if all live nodes are remote and we are on LOCAL_QUORUM then by what I just sent we would never add them.&lt;/p&gt;

&lt;p&gt;I ll play with this and let you know &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17791827" author="chovatia.jaydeep@gmail.com" created="Thu, 30 Nov 2023 23:32:27 +0000"  >&lt;p&gt;yeah, we should not completely filter the remote nodes with LOCAL_QUORUM as it would lead to other issues. We should simply &lt;b&gt;prioritize&lt;/b&gt; the local nodes over remote nodes. Something like this can be done....&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (consistencyLevel != EACH_QUORUM)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;{
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; add = consistencyLevel.blockForWrite(liveAndDown.replicationStrategy(), liveAndDown.pending()) - contacts.size();
+
+ &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (consistencyLevel == LOCAL_QUORUM)
+ &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;{
+ &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;span class=&quot;code-comment&quot;&gt;// prioritize local replicas first
&lt;/span&gt;+ &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Replica replica : filter(live.all(), r -&amp;gt; !contacts.contains(r) &amp;amp;&amp;amp; InOurDcTester.replicas().test(r)))
+ &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;{
+ &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;contacts.add(replica);
+ &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (--add == 0)
+ &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
+ &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;}
+ &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;}
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (add &amp;gt; 0)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;{
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Replica replica : filter(live.all(), r -&amp;gt; !contacts.contains(r)))
.....
..... &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17791831" author="smiklosovic" created="Thu, 30 Nov 2023 23:35:15 +0000"  >&lt;p&gt;my idea is more like this&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2953/files#diff-5f7abad30251655d9a9ba867a9d98d63e915941bf1b5acfe3b1def30a4137cc2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2953/files#diff-5f7abad30251655d9a9ba867a9d98d63e915941bf1b5acfe3b1def30a4137cc2&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17791832" author="chovatia.jaydeep@gmail.com" created="Thu, 30 Nov 2023 23:41:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt; , that works for us!&lt;/p&gt;</comment>
                            <comment id="17791834" author="smiklosovic" created="Thu, 30 Nov 2023 23:52:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chovatia.jaydeep%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;chovatia.jaydeep@gmail.com&quot;&gt;chovatia.jaydeep@gmail.com&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I think we should wrap it in &quot;if&quot; checking if we are on LOCAL_QUORUM because if we do that as I suggested, then it will be preferring local replicas when we are on QUORUM too and I do not think that is desirable. Preferring local replicas when we are on LOCAL_QUORUM is probably just fine. &lt;/p&gt;</comment>
                            <comment id="17791837" author="chovatia.jaydeep@gmail.com" created="Thu, 30 Nov 2023 23:54:05 +0000"  >&lt;p&gt;Sounds good &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17791840" author="smiklosovic" created="Fri, 1 Dec 2023 00:01:01 +0000"  >&lt;p&gt;Draft updated.&lt;/p&gt;</comment>
                            <comment id="17791846" author="chovatia.jaydeep@gmail.com" created="Fri, 1 Dec 2023 00:10:21 +0000"  >&lt;p&gt;The draft looks good to me. Will let &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=curlylrt&quot; class=&quot;user-hover&quot; rel=&quot;curlylrt&quot;&gt;curlylrt&lt;/a&gt; also take a look at it Besides, we should add a JVM dtest or unit test for this fix. If you want &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=curlylrt&quot; class=&quot;user-hover&quot; rel=&quot;curlylrt&quot;&gt;curlylrt&lt;/a&gt; to take care of it, then let us know, and we can write one.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17791853" author="smiklosovic" created="Fri, 1 Dec 2023 00:35:35 +0000"  >&lt;p&gt;I am running a build here (1). Let&apos;s see what tests will fail on this to have an idea what we are against. &lt;/p&gt;

&lt;p&gt;(1) &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3603/workflows/3f5ec3b4-62c3-40e9-8734-88cf55d86327&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3603/workflows/3f5ec3b4-62c3-40e9-8734-88cf55d86327&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17791854" author="JIRAUSER291682" created="Fri, 1 Dec 2023 00:36:14 +0000"  >&lt;p&gt;The Draft looks good, I can create a dtest for this case.&lt;/p&gt;</comment>
                            <comment id="17792052" author="smiklosovic" created="Fri, 1 Dec 2023 13:21:38 +0000"  >&lt;p&gt;Sure write a test for it. I ll review. I am still looking at it, I am suspicious of what we did though. We will probably discuss more when tests are written ... &lt;/p&gt;</comment>
                            <comment id="17792279" author="JIRAUSER291682" created="Sat, 2 Dec 2023 00:51:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt; , please check the added dtest: &lt;a href=&quot;https://github.com/apache/cassandra-dtest/pull/248&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra-dtest/pull/248&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Tested this new test with 4.0, 4.1, 5.0 and trunk, all of them failed.&lt;/p&gt;

&lt;p&gt;3.0 and 3.11 are good with this test.&lt;/p&gt;</comment>
                            <comment id="17792795" author="smiklosovic" created="Mon, 4 Dec 2023 11:56:28 +0000"  >&lt;p&gt;We need to fix it everywhere, at least in 4.0+. 5.1/trunk is a must I would say. I am not sure about the complexity of this in older branches.&lt;/p&gt;

&lt;p&gt;I think that Java tests would be better for this. I updated the draft branch where I tried to write a test for that. If you notice there is BlockingReadRepairTest which tests various scenarios we are covering here quite in depth but there is our test missing. I tried to put it together but that whole test class is little bit cumbersome to work with and it gets complicated pretty fast.&lt;/p&gt;

&lt;p&gt;The logic around this is quite complicated and I am not sure I got it right. I think you should focus on tests like these. If it turns out it is too complicated to refactor that class, you might just create completely new but it would be great if we test this in Java rather than doing it in Python which seems to be flaky.&lt;/p&gt;

&lt;p&gt;BTW I am still not persuaded that we covered all scenarios. This comment (1) is quite concerning to me. Is our solution covering that too?&lt;/p&gt;

&lt;p&gt;(1) &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L95-L99&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L95-L99&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17793443" author="JIRAUSER291682" created="Tue, 5 Dec 2023 22:06:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;I checked the failed test in BlockingReadRepairTest in the linked CI job: &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3603/workflows/3f5ec3b4-62c3-40e9-8734-88cf55d86327&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3603/workflows/3f5ec3b4-62c3-40e9-8734-88cf55d86327.&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The test&#160;&lt;em&gt;remoteDCTest&lt;/em&gt;&#160;is not right.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The replication strategy is simple strategy(1)&lt;/li&gt;
	&lt;li&gt;The consistency level passed in is not used, no matter what consistency level is passed in, it will finally use Consistency.TWO and the test is passing for a coincident not the validating the right logic&#160; (2)(3)(4)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;(1)&lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/test/unit/org/apache/cassandra/service/reads/repair/AbstractReadRepairTest.java#L225&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/test/unit/org/apache/cassandra/service/reads/repair/AbstractReadRepairTest.java#L225&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(2)&lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/test/unit/org/apache/cassandra/service/reads/repair/BlockingReadRepairTest.java#L272&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/test/unit/org/apache/cassandra/service/reads/repair/BlockingReadRepairTest.java#L272&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(3)&lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/test/unit/org/apache/cassandra/service/reads/repair/AbstractReadRepairTest.java#L286&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/test/unit/org/apache/cassandra/service/reads/repair/AbstractReadRepairTest.java#L286&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(4)&lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/test/unit/org/apache/cassandra/service/reads/repair/AbstractReadRepairTest.java#L303&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/test/unit/org/apache/cassandra/service/reads/repair/AbstractReadRepairTest.java#L303&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The comment you mentioned should not be a problem.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17793586" author="smiklosovic" created="Wed, 6 Dec 2023 09:21:56 +0000"  >&lt;p&gt;Have you gone through my branch with the improved test? What do you think about that?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/instaclustr/cassandra/tree/CASSANDRA-19120-5.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/instaclustr/cassandra/tree/CASSANDRA-19120-5.0&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I think the test which is right now in place is just wrong ... it does not truly test scenario with multiple datacenters because it will always evaluate every replica in same DC based on the snitch. The original test is a fake one, there is no real distinction between local and remote nodes which my patch somehow tries to address.&lt;/p&gt;</comment>
                            <comment id="17793846" author="JIRAUSER291682" created="Wed, 6 Dec 2023 17:10:58 +0000"  >&lt;p&gt;The test you added is not right or at least not testing the bug we are discussing.&lt;/p&gt;

&lt;p&gt;The pending node should be joining the first DC instead of second DC (1) which is causing one more remote node to be added to the repairs map (This part is good in your test(2))&lt;/p&gt;

&lt;p&gt;If the pending node is joining the first DC, the blockFor will be 3 instead of 2. (3)&lt;/p&gt;

&lt;p&gt;Since no node is repairs satisfied the if condition (4), the latch will be initialized with 3.&lt;/p&gt;

&lt;p&gt;So the handler.waitingOn should be 3 instead of 2. (5)&lt;/p&gt;

&lt;p&gt;Without any change to the latch part, we will run into the timeout error because ack node4 won&apos;t do latch count down.&lt;/p&gt;

&lt;p&gt;(1) &lt;a href=&quot;https://github.com/instaclustr/cassandra/commit/853ced996d3637109bf1e183092f0bd9cbb180ca#diff-1ddca3571de225b02568519eada4b76eb136b84c4cc25f061d5c1f806f0fe145R332&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/instaclustr/cassandra/commit/853ced996d3637109bf1e183092f0bd9cbb180ca#diff-1ddca3571de225b02568519eada4b76eb136b84c4cc25f061d5c1f806f0fe145R332&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(2) &lt;a href=&quot;https://github.com/instaclustr/cassandra/commit/853ced996d3637109bf1e183092f0bd9cbb180ca#diff-1ddca3571de225b02568519eada4b76eb136b84c4cc25f061d5c1f806f0fe145R309-R312&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/instaclustr/cassandra/commit/853ced996d3637109bf1e183092f0bd9cbb180ca#diff-1ddca3571de225b02568519eada4b76eb136b84c4cc25f061d5c1f806f0fe145R309-R312&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(3) &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-5.0/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L83&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-5.0/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L83&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(4) &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-5.0/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L90&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-5.0/src/java/org/apache/cassandra/service/reads/repair/BlockingPartitionRepair.java#L90&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(5) &lt;a href=&quot;https://github.com/instaclustr/cassandra/commit/853ced996d3637109bf1e183092f0bd9cbb180ca#diff-1ddca3571de225b02568519eada4b76eb136b84c4cc25f061d5c1f806f0fe145R343&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/instaclustr/cassandra/commit/853ced996d3637109bf1e183092f0bd9cbb180ca#diff-1ddca3571de225b02568519eada4b76eb136b84c4cc25f061d5c1f806f0fe145R343&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17793903" author="smiklosovic" created="Wed, 6 Dec 2023 19:15:50 +0000"  >&lt;p&gt;Feel free to fix that test I started, no problem with that. I had strong suspicion that I did not do it right anyway ... &lt;/p&gt;</comment>
                            <comment id="17795029" author="JIRAUSER291682" created="Sun, 10 Dec 2023 07:13:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt; please review this diff for this ticket: &lt;a href=&quot;https://github.com/apache/cassandra/pull/2981&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2981&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I think we need to keep the original latch part to handle speculative retry introduced remote DC contacts. Let me know what you think. Thanks.&lt;/p&gt;</comment>
                            <comment id="17795513" author="chovatia.jaydeep@gmail.com" created="Mon, 11 Dec 2023 21:49:25 +0000"  >&lt;p&gt;LGTM &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=curlylrt&quot; class=&quot;user-hover&quot; rel=&quot;curlylrt&quot;&gt;curlylrt&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt;, Could you please help review the pull request from Runtian?&lt;/p&gt;</comment>
                            <comment id="17795552" author="smiklosovic" created="Tue, 12 Dec 2023 00:48:29 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=curlylrt&quot; class=&quot;user-hover&quot; rel=&quot;curlylrt&quot;&gt;curlylrt&lt;/a&gt;, I am currently a little bit busy (on Cassandra Summit) and my availability is limited. I know about this ticket and I plan to return to that next week. (the week from 18th December).&lt;/p&gt;</comment>
                            <comment id="17795555" author="smiklosovic" created="Tue, 12 Dec 2023 00:56:43 +0000"  >&lt;p&gt;Running a CircleCI build for 4.0 j11 here to see how we do:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3646/workflows/11a3f988-f6cf-4447-a11e-daa3224dbf1e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3646/workflows/11a3f988-f6cf-4447-a11e-daa3224dbf1e&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17799186" author="JIRAUSER291682" created="Wed, 20 Dec 2023 22:02:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt; , not sure what went wrong with the vnode dtests bootstrap test? Not sure if it is related to this blocking read repair change.&lt;/p&gt;</comment>
                            <comment id="17801779" author="smiklosovic" created="Tue, 2 Jan 2024 13:02:53 +0000"  >&lt;p&gt;This is still on my radar, I should return to this sometimes this or next week.&#160;&lt;/p&gt;</comment>
                            <comment id="17801785" author="smiklosovic" created="Tue, 2 Jan 2024 13:27:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=curlylrt&quot; class=&quot;user-hover&quot; rel=&quot;curlylrt&quot;&gt;curlylrt&lt;/a&gt; would you mind to prepare all other branches? 4.1, 5.0, trunk ... I think there are some minor differences between them.&lt;/p&gt;</comment>
                            <comment id="17801958" author="JIRAUSER291682" created="Tue, 2 Jan 2024 23:23:36 +0000"  >&lt;p&gt;4.1: &lt;a href=&quot;https://github.com/apache/cassandra/pull/3019&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3019&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;5.0: &lt;a href=&quot;https://github.com/apache/cassandra/pull/3020&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3020&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;trunk: &lt;a href=&quot;https://github.com/apache/cassandra/pull/3021&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3021&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17804204" author="smiklosovic" created="Mon, 8 Jan 2024 09:31:27 +0000"  >&lt;p&gt;I am OK with that, we just need to find another committer (these are the rules we play with here).&#160;&lt;/p&gt;

&lt;p&gt;Looking into git blame, I see &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=samt&quot; class=&quot;user-hover&quot; rel=&quot;samt&quot;&gt;samt&lt;/a&gt; &#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt; as the last people who touched that code. Any chance they will review this, at least conceptually?&lt;/p&gt;</comment>
                            <comment id="17811384" author="bdeggleston" created="Fri, 26 Jan 2024 19:41:07 +0000"  >&lt;p&gt;Thanks for your time on this Runtian and Stefan. Feedback is below,&#160;&lt;/p&gt;

&lt;p&gt;So after the removal of read_repair_chance/dclocal_read_repair_chance in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13910&quot; title=&quot;Remove read_repair_chance/dclocal_read_repair_chance&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13910&quot;&gt;&lt;del&gt;CASSANDRA-13910&lt;/del&gt;&lt;/a&gt;, there should never be a case where a DC local read or read repairs are talking to remote DCs.&lt;/p&gt;

&lt;p&gt;First, replicas from remote dcs should not be making it into the contact list. If we weren&#8217;t correctly disregarding their acks in BlockingReadRepair, we&#8217;d have a violation of monotonic read guarantees. So I&#8217;d suggest that we filter remote DC replicas out when constructing the initial replica plan for the read repair&lt;/p&gt;

&lt;p&gt;Second, if we don&#8217;t have to worry about remote DCs making it into BlockingPartitionRepair, we can remove the shouldBlockOn logic from that class, though we should add something to the effect of `Preconditions.checkState(!consistencyLevel.isDatacenterLocal() ||&#160; InOurDcTester.&lt;em&gt;endpoints&lt;/em&gt;().contains(participant))` in the ctor as a sanity check. This would also mean the removal of the blockFor decrementing code you added.&lt;/p&gt;

&lt;p&gt;Third, in some situations (ie: when there is a pending node), the pendingRepairMap will always have fewer items than blockFor, which will mean the repair will always speculate. To avoid this, I&#8217;d proactively add repairs to the pendingRepair map when this is the case, though it will mean a little reworking of maybeSendAdditionalWrites.&lt;/p&gt;

&lt;p&gt;Let me know what you think. Also, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=samt&quot; class=&quot;user-hover&quot; rel=&quot;samt&quot;&gt;samt&lt;/a&gt; does all that seem reasonable to you?&lt;/p&gt;</comment>
                            <comment id="17811413" author="JIRAUSER291682" created="Fri, 26 Jan 2024 23:00:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;First, replicas from remote dcs should not be making it into the contact list. If we weren&#8217;t correctly disregarding their acks in BlockingReadRepair, we&#8217;d have a violation of monotonic read guarantees. So I&#8217;d suggest that we filter remote DC replicas out when constructing the initial replica plan for the read repair&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I agree, this means instead of sorting the nodes to prefer local nodes for local consistency blocking read repair, we should just filter out all remote dc nodes when preparing the write plan. However, is it possible for remote node to participant in speculative retry? Or should we also block this as well?&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Second, if we don&#8217;t have to worry about remote DCs making it into BlockingPartitionRepair, we can remove the shouldBlockOn logic from that class, though we should add something to the effect of `Preconditions.checkState(!consistencyLevel.isDatacenterLocal() ||&#160; InOurDcTester.&lt;em&gt;endpoints&lt;/em&gt;().contains(participant))` in the ctor as a sanity check. This would also mean the removal of the blockFor decrementing code you added.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, we should remove the shouldBlockOn logic if remote DCs won&apos;t get into BlockingPartitionRepair. But I think the code block in the pull request to use check maxAckCanGet is kind of sanity check. It is making sure we won&apos;t cause any timeout because of the number of target nodes we sent mutations to is smaller than the ack we are expecting. This code is not necessary if there is no bug in the code so we always send out enough requests that we need for the blockFor.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Third, in some situations (ie: when there is a pending node), the pendingRepairMap will always have fewer items than blockFor, which will mean the repair will always speculate.&#160;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This is not the case for this bug. This bug is that when there is a pending node, the writePlan for blocking read repair &lt;b&gt;may&lt;/b&gt;&#160;include a remote DC node as contact node for write only. While we are expecting one more node to ack, but the ack is filtered out by the shouldBlockOn logic. Then it caused timeout because all requests have responded.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;To avoid this, I&#8217;d proactively add repairs to the pendingRepair map when this is the case, though it will mean a little reworking of maybeSendAdditionalWrites.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think the pendingRepair map is used at two places:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;send initial repairs.&lt;/li&gt;
	&lt;li&gt;If addition writes are needed, the pendingRepair map is used to build the mutations.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I see some code that trying to remove items from this pendingRepair map and I think they are not necessary. This means it won&apos;t be useful to add more items into this map. Yeah, I agree, when somehow the pendingRepair map has less number of nodes compare to blockFlor, we should trigger maybeSendAdditionalWrites immediately after the BlockingPartitionRepair is initialized (or maybe add this logic in the sendInitialRepairs function so the addition writes will be sent after the initial writes).&lt;/p&gt;</comment>
                            <comment id="17812996" author="JIRAUSER291682" created="Thu, 1 Feb 2024 01:14:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt;&#160; I made some change to the PR, please take a look. Thanks. &lt;a href=&quot;https://github.com/apache/cassandra/pull/2981/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2981/files&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17815816" author="bdeggleston" created="Thu, 8 Feb 2024 19:57:24 +0000"  >&lt;blockquote&gt;&lt;p&gt;This is not the case for this bug. This bug is that when there is a pending node, the writePlan for blocking read repair &lt;b&gt;may&lt;/b&gt;&#160;include a remote DC node as contact node for write only. While we are expecting one more node to ack, but the ack is filtered out by the shouldBlockOn logic. Then it caused timeout because all requests have responded.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, you&#8217;re right. Reviewing this had raised some suspicion that we could temporarily break read monotonicity when running a read repair with a pending node, but I don&#8217;t think it&#8217;s actually a concern.&lt;/p&gt;

&lt;p&gt;Anyway, I left some minor feedback on the PR, I&#8217;m +1 on committing after it&#8217;s addressed.&lt;/p&gt;</comment>
                            <comment id="17815830" author="smiklosovic" created="Thu, 8 Feb 2024 20:40:49 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt; for checking this ticket again, I run a CI to see if something failed and so far it looks good (with the latest set of changes from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=curlylrt&quot; class=&quot;user-hover&quot; rel=&quot;curlylrt&quot;&gt;curlylrt&lt;/a&gt; ).&lt;/p&gt;</comment>
                            <comment id="17815892" author="JIRAUSER291682" created="Fri, 9 Feb 2024 02:06:18 +0000"  >&lt;p&gt;Updated the PR.&lt;/p&gt;</comment>
                            <comment id="17816502" author="smiklosovic" created="Mon, 12 Feb 2024 07:29:48 +0000"  >&lt;p&gt;So, at this stage, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=curlylrt&quot; class=&quot;user-hover&quot; rel=&quot;curlylrt&quot;&gt;curlylrt&lt;/a&gt; I think we need to apply the review of Blake to all other branches as well.&lt;/p&gt;</comment>
                            <comment id="17816801" author="JIRAUSER291682" created="Mon, 12 Feb 2024 22:02:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt; sure, I can make similar change for other branches. Just want to make sure the current change for 4.0 is good. Did you get a chance to run the test suites? I don&apos;t have the CI setup for all the tests. If the test looks good on 4.0. I can start port similar change to other branches.&lt;/p&gt;</comment>
                            <comment id="17816889" author="smiklosovic" created="Tue, 13 Feb 2024 08:05:25 +0000"  >&lt;p&gt;I run CI before your current latest changes in 4.0 and looked fine. I do not think that the latest minor changes introduced any error. Feel free to update the branches, I will do the final builds after that.&lt;/p&gt;</comment>
                            <comment id="17817582" author="JIRAUSER291682" created="Thu, 15 Feb 2024 04:31:53 +0000"  >&lt;p&gt;Updated the four PRs:&lt;/p&gt;

&lt;p&gt;4.0: &lt;a href=&quot;https://github.com/apache/cassandra/pull/2981&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2981&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;4.1:&#160;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3019&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3019&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;5.0:&#160;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3020&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3020&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;trunk:&#160;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3021&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3021&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17818479" author="smiklosovic" created="Mon, 19 Feb 2024 13:16:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/instaclustr/cassandra/tree/CASSANDRA-19120-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-19120-4.0&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java11_pre-commit_tests                         
java11_separate_tests                            
java8_pre-commit_tests                          
  &#10003; j8_build                                         5m 37s
  &#10003; j8_cqlsh-dtests-py2-no-vnodes                     8m 7s
  &#10003; j8_cqlsh-dtests-py2-with-vnodes                  6m 56s
  &#10003; j8_cqlsh_dtests_py3                              8m 59s
  &#10003; j8_cqlsh_dtests_py311                            7m 35s
  &#10003; j8_cqlsh_dtests_py311_vnode                      7m 11s
  &#10003; j8_cqlsh_dtests_py38                             6m 32s
  &#10003; j8_cqlsh_dtests_py38_vnode                       6m 48s
  &#10003; j8_cqlsh_dtests_py3_vnode                        7m 29s
  &#10003; j8_cqlshlib_tests                                8m 15s
  &#10003; j8_dtests                                       32m 15s
  &#10003; j8_dtests_vnode                                 33m 48s
  &#10003; j8_jvm_dtests                                   13m 25s
  &#10003; j11_dtests_vnode                                 35m 2s
  &#10003; j11_dtests                                      32m 17s
  &#10003; j11_cqlsh_dtests_py3_vnode                       5m 18s
  &#10003; j11_cqlsh_dtests_py38_vnode                      5m 24s
  &#10003; j11_cqlsh_dtests_py38                            5m 50s
  &#10003; j11_cqlsh_dtests_py311_vnode                     5m 27s
  &#10003; j11_cqlsh_dtests_py311                           5m 50s
  &#10003; j11_cqlsh_dtests_py3                             5m 25s
  &#10003; j11_cqlsh-dtests-py2-with-vnodes                 5m 25s
  &#10003; j11_cqlsh-dtests-py2-no-vnodes                   6m 43s
  &#10005; j8_unit_tests                                    7m 46s
      org.apache.cassandra.cql3.MemtableSizeTest testTruncationReleasesLogSpace
  &#10005; j8_utests_system_keyspace_directory              9m 38s
      org.apache.cassandra.cql3.MemtableSizeTest testTruncationReleasesLogSpace
  &#10005; j11_unit_tests                                   7m 56s
      org.apache.cassandra.index.sasi.SASICQLTest testPagingWithClustering
      org.apache.cassandra.cql3.MemtableSizeTest testTruncationReleasesLogSpace
java8_separate_tests                             
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3892/workflows/26904ec4-ba86-4c8e-ba07-5da871b6c5a1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java11_pre-commit_tests&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3892/workflows/c35e2b54-b6f1-4283-a9f4-6e776517a721&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java11_separate_tests&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3892/workflows/d7e43174-bc76-42da-93a9-e43eb65218ae&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java8_pre-commit_tests&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3892/workflows/1168aafe-d453-4b54-b688-5bf3d9d5624a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java8_separate_tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17818546" author="smiklosovic" created="Mon, 19 Feb 2024 17:33:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/instaclustr/cassandra/tree/CASSANDRA-19120-4.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-19120-4.1&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java11_pre-commit_tests                         
java11_separate_tests                            
java8_pre-commit_tests                          
  &#10003; j8_build                                         7m 12s
  &#10003; j8_cqlsh_dtests_py3                              5m 50s
  &#10003; j8_cqlsh_dtests_py311                            6m 44s
  &#10003; j8_cqlsh_dtests_py311_vnode                       9m 2s
  &#10003; j8_cqlsh_dtests_py38                             5m 40s
  &#10003; j8_cqlsh_dtests_py38_vnode                       7m 26s
  &#10003; j8_cqlsh_dtests_py3_vnode                        6m 55s
  &#10003; j8_cqlshlib_cython_tests                        11m 36s
  &#10003; j8_cqlshlib_tests                                8m 27s
  &#10003; j8_dtests                                       32m 50s
  &#10003; j8_dtests_vnode                                 35m 28s
  &#10003; j8_jvm_dtests                                   17m 48s
  &#10003; j8_jvm_dtests_vnode                             12m 55s
  &#10003; j8_simulator_dtests                              4m 33s
  &#10003; j11_jvm_dtests_vnode                            12m 53s
  &#10003; j11_jvm_dtests                                  15m 51s
  &#10003; j11_dtests_vnode                                36m 11s
  &#10003; j11_dtests                                      33m 43s
  &#10003; j11_cqlshlib_tests                               6m 13s
  &#10003; j11_cqlshlib_cython_tests                        8m 41s
  &#10003; j11_cqlsh_dtests_py3_vnode                       5m 48s
  &#10003; j11_cqlsh_dtests_py38_vnode                      5m 51s
  &#10003; j11_cqlsh_dtests_py38                            5m 50s
  &#10003; j11_cqlsh_dtests_py311_vnode                     5m 55s
  &#10003; j11_cqlsh_dtests_py311                           5m 52s
  &#10003; j11_cqlsh_dtests_py3                             5m 24s
  &#10005; j8_unit_tests                                    8m 46s
      org.apache.cassandra.cql3.MemtableSizeTest testSize[skiplist]
  &#10005; j8_utests_system_keyspace_directory             10m 29s
      org.apache.cassandra.cql3.MemtableSizeTest testSize[skiplist]
  &#10005; j11_unit_tests                                   9m 39s
      org.apache.cassandra.cql3.MemtableSizeTest testSize[skiplist]
java8_separate_tests                             
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3893/workflows/0c11383e-c153-4611-a92d-d7316e54db79&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java11_pre-commit_tests&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3893/workflows/6c63a512-f926-42a7-b814-91b273a77fdc&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java11_separate_tests&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3893/workflows/017f3324-f2e6-477f-ac54-6c7ea4c4224e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java8_pre-commit_tests&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3893/workflows/7222a794-c46a-4fd3-916b-e5ec9def9045&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java8_separate_tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17818553" author="JIRAUSER291682" created="Mon, 19 Feb 2024 18:47:51 +0000"  >&lt;p&gt;I think the failed test is not related to this PR, it is related to this commit: &lt;a href=&quot;https://github.com/apache/cassandra/commit/aa561f2373e90f78d4af92d490a6236c40acccd7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/aa561f2373e90f78d4af92d490a6236c40acccd7&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think the linked CI job in this ticket has this test failed but we still committed this change.&lt;/p&gt;</comment>
                            <comment id="17818758" author="smiklosovic" created="Tue, 20 Feb 2024 11:01:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/instaclustr/cassandra/tree/CASSANDRA-19120-5.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-19120-5.0&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java17_pre-commit_tests                         
java17_separate_tests                            
java11_pre-commit_tests                         
  &#10003; j11_build                                        3m 42s
  &#10003; j11_cqlsh_dtests_py311                           6m 27s
  &#10003; j11_cqlsh_dtests_py311_vnode                     10m 0s
  &#10003; j11_cqlsh_dtests_py38                             8m 3s
  &#10003; j11_cqlsh_dtests_py38_vnode                      9m 21s
  &#10003; j11_cqlshlib_cython_tests                       12m 53s
  &#10003; j11_cqlshlib_tests                               6m 35s
  &#10003; j11_dtests                                      32m 48s
  &#10003; j11_dtests_vnode                                39m 21s
  &#10003; j11_jvm_dtests                                  20m 23s
  &#10003; j11_jvm_dtests_vnode                            16m 10s
  &#10003; j11_simulator_dtests                             2m 47s
  &#10003; j17_cqlsh_dtests_py311                           5m 52s
  &#10003; j17_cqlsh_dtests_py311_vnode                     6m 14s
  &#10003; j17_cqlsh_dtests_py38                            6m 16s
  &#10003; j17_cqlsh_dtests_py38_vnode                      6m 16s
  &#10003; j17_cqlshlib_cython_tests                        9m 32s
  &#10003; j17_cqlshlib_tests                               6m 29s
  &#10003; j17_dtests                                      33m 15s
  &#10003; j17_dtests_vnode                                 33m 1s
  &#10003; j17_jvm_dtests                                  19m 57s
  &#10003; j17_jvm_dtests_vnode                            14m 52s
  &#10005; j11_unit_tests                                  21m 10s
      org.apache.cassandra.index.sai.cql.VectorUpdateDeleteTest updateTest
  &#10005; j11_utests_oa                                   17m 44s
      org.apache.cassandra.index.sai.cql.VectorUpdateDeleteTest updateTest
  &#10005; j11_utests_system_keyspace_directory            16m 51s
      org.apache.cassandra.index.sai.cql.VectorUpdateDeleteTest updateTest
  &#10005; j17_unit_tests                                  14m 55s
      org.apache.cassandra.index.sai.cql.VectorUpdateDeleteTest updateTest
  &#10005; j17_utests_oa                                   17m 25s
      org.apache.cassandra.index.sai.cql.VectorUpdateDeleteTest updateTest
java11_separate_tests                            
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3894/workflows/3d8af41d-1225-4a8e-b590-46c06051b324&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java17_pre-commit_tests&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3894/workflows/3d1996bf-acb6-403a-a8aa-d89521bb6b42&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java17_separate_tests&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3894/workflows/abe178de-5d3f-468f-9886-c93e10cddbcf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java11_pre-commit_tests&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3894/workflows/66bb8816-92b9-4237-8dc9-d3d811782575&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java11_separate_tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17818894" author="smiklosovic" created="Tue, 20 Feb 2024 16:32:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/instaclustr/cassandra/tree/CASSANDRA-19120-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-19120-trunk&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java17_pre-commit_tests                         
java17_separate_tests                            
java11_pre-commit_tests                         
  &#10003; j11_build                                        7m 58s
  &#10003; j11_cqlsh_dtests_py311                           9m 58s
  &#10003; j11_cqlsh_dtests_py311_vnode                    10m 23s
  &#10003; j11_cqlsh_dtests_py38                            7m 52s
  &#10003; j11_cqlsh_dtests_py38_vnode                     10m 31s
  &#10003; j11_cqlshlib_cython_tests                       11m 38s
  &#10003; j11_cqlshlib_tests                               12m 1s
  &#10003; j11_dtests                                      37m 13s
  &#10003; j11_dtests_vnode                                 41m 2s
  &#10003; j11_jvm_dtests_vnode                             20m 5s
  &#10003; j11_simulator_dtests                              9m 0s
  &#10003; j17_cqlsh_dtests_py311                           6m 53s
  &#10003; j17_cqlsh_dtests_py311_vnode                     7m 12s
  &#10003; j17_cqlsh_dtests_py38                            6m 51s
  &#10003; j17_cqlsh_dtests_py38_vnode                      7m 13s
  &#10003; j17_cqlshlib_cython_tests                        8m 19s
  &#10003; j17_cqlshlib_tests                                7m 4s
  &#10003; j17_dtests                                      35m 30s
  &#10003; j17_dtests_vnode                                35m 34s
  &#10005; j11_jvm_dtests                                   26m 8s
      org.apache.cassandra.fuzz.ring.ConsistentBootstrapTest coordinatorIsBehindTest
  &#10005; j11_unit_tests                                  15m 46s
      org.apache.cassandra.index.sai.cql.VectorUpdateDeleteTest updateTest
  &#10005; j11_utests_oa                                   15m 46s
      org.apache.cassandra.index.sai.cql.VectorUpdateDeleteTest updateTest
  &#10005; j11_utests_system_keyspace_directory            16m 17s
      org.apache.cassandra.index.sai.cql.VectorUpdateDeleteTest updateTest
  &#10005; j17_jvm_dtests                                  25m 12s
      org.apache.cassandra.distributed.test.NativeTransportEncryptionOptionsTest testEndpointVerificationEnabledIpNotInSAN TIMEOUTED
  &#10005; j17_jvm_dtests_vnode                            23m 24s
      junit.framework.TestSuite org.apache.cassandra.fuzz.harry.integration.model.InJVMTokenAwareExecutorTest TIMEOUTED
      org.apache.cassandra.distributed.test.NativeTransportEncryptionOptionsTest testEndpointVerificationEnabledIpNotInSAN TIMEOUTED
  &#10005; j17_unit_tests                                  14m 54s
      org.apache.cassandra.index.sai.cql.VectorUpdateDeleteTest updateTest
  &#10005; j17_utests_oa                                   13m 18s
      org.apache.cassandra.index.sai.cql.VectorUpdateDeleteTest updateTest
java11_separate_tests                            
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3896/workflows/b64e0655-b604-4fad-a917-cbe6429819c6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java17_pre-commit_tests&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3896/workflows/afeaf2b1-3d7b-4231-b669-9be4d6e9d7a7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java17_separate_tests&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3896/workflows/2d7b6b75-8bdd-4c81-959d-9e3db922565e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java11_pre-commit_tests&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3896/workflows/74474984-97f7-4a1f-8541-b66291e93ef9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java11_separate_tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17818897" author="smiklosovic" created="Tue, 20 Feb 2024 16:33:37 +0000"  >&lt;p&gt;This all looks good to me, if &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt; agrees we might ship it.&lt;/p&gt;</comment>
                            <comment id="17818902" author="bdeggleston" created="Tue, 20 Feb 2024 16:41:42 +0000"  >&lt;p&gt;+1 if we know the failing tests were failing/flaky previously&lt;/p&gt;</comment>
                            <comment id="17819582" author="smiklosovic" created="Thu, 22 Feb 2024 10:29:37 +0000"  >&lt;p&gt;I ll get to the merge soonish.&lt;/p&gt;</comment>
                            <comment id="17819839" author="smiklosovic" created="Thu, 22 Feb 2024 22:44:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19120&quot; title=&quot;local consistencies may get timeout if blocking read repair is sending the read repair mutation to other DC &quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19120&quot;&gt;&lt;del&gt;CASSANDRA-19120&lt;/del&gt;&lt;/a&gt;-4.0&lt;/p&gt;

&lt;p&gt;MemtableSizeTest - &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17298&quot; title=&quot;Improve accuracy of memtable heap usage tracking&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17298&quot;&gt;&lt;del&gt;CASSANDRA-17298&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
SASICQLTest - &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18432&quot; title=&quot;Test failure: org.apache.cassandra.index.sasi.SASICQLTest#testPagingWithClustering&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18432&quot;&gt;CASSANDRA-18432&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19120&quot; title=&quot;local consistencies may get timeout if blocking read repair is sending the read repair mutation to other DC &quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19120&quot;&gt;&lt;del&gt;CASSANDRA-19120&lt;/del&gt;&lt;/a&gt;-4.1&lt;/p&gt;

&lt;p&gt;MemtableSizeTest - &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17298&quot; title=&quot;Improve accuracy of memtable heap usage tracking&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17298&quot;&gt;&lt;del&gt;CASSANDRA-17298&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19120&quot; title=&quot;local consistencies may get timeout if blocking read repair is sending the read repair mutation to other DC &quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19120&quot;&gt;&lt;del&gt;CASSANDRA-19120&lt;/del&gt;&lt;/a&gt;-5.0&lt;/p&gt;

&lt;p&gt;VectorUpdateDeleteTest - &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19168&quot; title=&quot;Test Failure: VectorUpdateDeleteTest fails with heap_buffers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19168&quot;&gt;&lt;del&gt;CASSANDRA-19168&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19120&quot; title=&quot;local consistencies may get timeout if blocking read repair is sending the read repair mutation to other DC &quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19120&quot;&gt;&lt;del&gt;CASSANDRA-19120&lt;/del&gt;&lt;/a&gt;-trunk&lt;/p&gt;

&lt;p&gt;ConsistentBootstrapTest - &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19343&quot; title=&quot;Test Failure: org.apache.cassandra.fuzz.ring.ConsistentBootstrapTest.coordinatorIsBehindTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19343&quot;&gt;&lt;del&gt;CASSANDRA-19343&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
VectorUpdateDeleteTest - &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19168&quot; title=&quot;Test Failure: VectorUpdateDeleteTest fails with heap_buffers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19168&quot;&gt;&lt;del&gt;CASSANDRA-19168&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
NativeTransportEncryptionOptionsTest - &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19281&quot; title=&quot;NativeTransportEncryptionOptionsTest fails often in CI&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19281&quot;&gt;&lt;del&gt;CASSANDRA-19281&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;InJVMTokenAwareExecutorTest - just a timeout&lt;/p&gt;</comment>
                            <comment id="17819844" author="smiklosovic" created="Thu, 22 Feb 2024 23:14:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=curlylrt&quot; class=&quot;user-hover&quot; rel=&quot;curlylrt&quot;&gt;curlylrt&lt;/a&gt; thank you for your patience and you, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt; for the review&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13064826" name="image-2023-11-29-15-26-08-056.png" size="187647" author="curlylrt" created="Wed, 29 Nov 2023 23:26:09 +0000"/>
                            <attachment id="13064827" name="signature.asc" size="509" author="miklosovic@pm.me" created="Thu, 30 Nov 2023 00:07:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[curlylrt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12989" cascade-level="1"><![CDATA[Consistency]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 37 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1lxyo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bdeggleston]]></customfieldvalue>
        <customfieldvalue><![CDATA[smiklosovic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12336842">4.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/c2041ba45b036e1d5963f8166f517c6d95d4eab1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/c2041ba45b036e1d5963f8166f517c6d95d4eab1&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;ci&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>