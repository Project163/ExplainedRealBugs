<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:42:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6623] Null in a cell caused by expired TTL does not work with IF clause (in CQL3)</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6623</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;IF onecell=null clause does not work if the onecell has got its null value from an expired TTL. If onecell is updated with null value (UPDATE) then IF onecell=null works fine.&lt;br/&gt;
This bug is not present when you create a table with COMPACT STORAGE directive.&lt;/p&gt;</description>
                <environment>&lt;p&gt;One cluster with two nodes on a Linux and a Windows system. cqlsh 4.1.0 | Cassandra 2.0.4 | CQL spec 3.1.1 | Thrift protocol 19.39.0. CQL3 Column Family&lt;/p&gt;</environment>
        <key id="12691349">CASSANDRA-6623</key>
            <summary>Null in a cell caused by expired TTL does not work with IF clause (in CQL3)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="scs95">Csaba Seres</reporter>
                        <labels>
                    </labels>
                <created>Mon, 27 Jan 2014 10:47:57 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:55 +0000</updated>
                            <resolved>Thu, 6 Feb 2014 07:50:57 +0000</resolved>
                                        <fixVersion>2.0.6</fixVersion>
                                    <component>Legacy/Testing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13882783" author="slebresne" created="Mon, 27 Jan 2014 12:32:29 +0000"  >&lt;p&gt;Can you provide a simple reproduction test case? (I&apos;m not contesting there is a problem, just want to make sure what you are running into exactly first)&lt;/p&gt;</comment>
                            <comment id="13882828" author="scs95" created="Mon, 27 Jan 2014 14:14:40 +0000"  >&lt;p&gt;Dear Sylvain Lebresne,&lt;/p&gt;

&lt;p&gt;I created a table without COMPACT STORAGE directive:&lt;br/&gt;
cqlsh&amp;gt; CREATE TABLE astyanaxks.cf2 (name varchar PRIMARY KEY, lock varchar, something varchar);&lt;br/&gt;
Then inserted a row:&lt;br/&gt;
cqlsh&amp;gt; INSERT INTO astyanaxks.cf2 (name, lock , something ) VALUES ( &apos;name1&apos;, &apos;lock1&apos;, &apos;som1&apos;);&lt;br/&gt;
Updated the lock column with a new TTL value:&lt;br/&gt;
cqlsh&amp;gt; UPDATE astyanaxks.cf2 USING TTL 10 SET lock=&apos;lock2&apos; WHERE name=&apos;name1&apos;;&lt;br/&gt;
cqlsh&amp;gt; SELECT * FROM astyanaxks.cf2;&lt;/p&gt;

&lt;p&gt; name  | lock  | something&lt;br/&gt;
------&lt;del&gt;&lt;ins&gt;&lt;/del&gt;-----&lt;del&gt;&lt;/ins&gt;&lt;/del&gt;----------&lt;br/&gt;
 name1 | lock2 |      som1&lt;/p&gt;

&lt;p&gt;(1 rows)&lt;/p&gt;

&lt;p&gt;After 10 seconds:&lt;/p&gt;

&lt;p&gt;cqlsh&amp;gt; SELECT * FROM astyanaxks.cf2;&lt;/p&gt;

&lt;p&gt; name  | lock | something&lt;br/&gt;
------&lt;del&gt;&lt;ins&gt;&lt;/del&gt;----&lt;del&gt;&lt;/ins&gt;&lt;/del&gt;----------&lt;br/&gt;
 name1 | null |      som1&lt;/p&gt;

&lt;p&gt;(1 rows)&lt;/p&gt;

&lt;p&gt;Then I wanted to update the row if lock is null:&lt;br/&gt;
cqlsh&amp;gt; UPDATE astyanaxks.cf2 USING TTL 10 SET lock=&apos;lock2&apos; WHERE name=&apos;name1&apos; IF lock=null;&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;applied&amp;#93;&lt;/span&gt;&lt;br/&gt;
-----------&lt;br/&gt;
     False&lt;/p&gt;

&lt;p&gt;It was unsuccessful.&lt;/p&gt;

&lt;p&gt;cqlsh&amp;gt; SELECT * FROM astyanaxks.cf2;&lt;/p&gt;

&lt;p&gt; name  | lock | something&lt;br/&gt;
------&lt;del&gt;&lt;ins&gt;&lt;/del&gt;----&lt;del&gt;&lt;/ins&gt;&lt;/del&gt;----------&lt;br/&gt;
 name1 | null |      som1&lt;/p&gt;

&lt;p&gt;(1 rows)&lt;/p&gt;

&lt;p&gt;cqlsh&amp;gt; &lt;/p&gt;

&lt;p&gt;On the other hand, if the null value is set by an update, then IF clause works. On the same Column Family:&lt;br/&gt;
cqlsh&amp;gt; UPDATE astyanaxks.cf2 SET lock=null WHERE name=&apos;name1&apos;;&lt;br/&gt;
cqlsh&amp;gt; UPDATE astyanaxks.cf2 USING TTL 10 SET lock=&apos;lock2&apos; WHERE name=&apos;name1&apos; IF lock=null;&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;applied&amp;#93;&lt;/span&gt;&lt;br/&gt;
-----------&lt;br/&gt;
      True&lt;/p&gt;

&lt;p&gt;cqlsh&amp;gt; SELECT * FROM astyanaxks.cf2;&lt;/p&gt;

&lt;p&gt; name  | lock  | something&lt;br/&gt;
------&lt;del&gt;&lt;ins&gt;&lt;/del&gt;-----&lt;del&gt;&lt;/ins&gt;&lt;/del&gt;----------&lt;br/&gt;
 name1 | lock2 |      som1&lt;/p&gt;

&lt;p&gt;Now lock column is set.&lt;/p&gt;

&lt;p&gt;Best Regards,&lt;/p&gt;

&lt;p&gt;Csaba Seres&lt;/p&gt;


</comment>
                            <comment id="13882875" author="slebresne" created="Mon, 27 Jan 2014 15:17:51 +0000"  >&lt;p&gt;Thanks Csaba.&lt;/p&gt;

&lt;p&gt;So this is kind of due to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5619&quot; title=&quot;CAS UPDATE for a lost race: save round trip by returning column values&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5619&quot;&gt;&lt;del&gt;CASSANDRA-5619&lt;/del&gt;&lt;/a&gt; patch, with a soup&#231;on of the problem from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5762&quot; title=&quot;Lost row marker after TTL expires&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5762&quot;&gt;&lt;del&gt;CASSANDRA-5762&lt;/del&gt;&lt;/a&gt; thrown in.&lt;/p&gt;

&lt;p&gt;When we generate conditions on a row internally, we currently include the row marker in the &apos;expected&apos; CF. The reason is that for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5619&quot; title=&quot;CAS UPDATE for a lost race: save round trip by returning column values&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5619&quot;&gt;&lt;del&gt;CASSANDRA-5619&lt;/del&gt;&lt;/a&gt;, we wanted to distinguish the cases of CAS failure because the row doesn&apos;t exist, from CAS failure because all columns on which we have conditions are null (but the row exists). So including the row marker in &apos;expected&apos;, makes us query the row marker, which in turns allows to say if the row does exists or not on CAS failure.&lt;/p&gt;

&lt;p&gt;But this also means that &apos;UPDATE IF&apos; checks for the row existence. Which doesn&apos;t really matter, unless you have only &apos;null&apos; conditions. Namely, doing&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE TABLE test (k int PRIMARY KEY, v int)
UPDATE test SET v = 1 WHERE k = 0 IF v = null
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;the last update won&apos;t work, because the row doesn&apos;t exist prior to the update.  And I think this is actually the first question to ask here: do we want that update not to work? I could see arguments for either side tbh. On the one side, since &apos;null&apos; means the column doesn&apos;t exist, if the row don&apos;t exist then the column doesn&apos;t either and in that sense the update should work. On the other side, making it not work is somewhat more expressive since it allow to check for &apos;row exists but has null value&apos; separately of &apos;row doesn&apos;t exists&apos; (which you can already check with an &apos;INSERT IF NOT EXISTS&apos;). Also, this reinforce the notion that with conditions, UPDATE work really more like a SQL UPDATE.&lt;/p&gt;

&lt;p&gt;So anyway, the problem Csaba is having here is a bit different. Namely, it&apos;s due to the fact that TTL ends up removing the row marker, even if the TTL was only applied to one of the columns and is not a proper marker of row existence.  The result is that the row marker expires in Casba example, but since the CAS expects it to be there, it fails (and this, even though the row actually does still exist).&lt;/p&gt;

&lt;p&gt;I think the solution here is basically the same than in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5762&quot; title=&quot;Lost row marker after TTL expires&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5762&quot;&gt;&lt;del&gt;CASSANDRA-5762&lt;/del&gt;&lt;/a&gt;, we should query the full CQL row as soon as we have a condition on it to be able to reliably say if the row exists or not. But while we&apos;re at it, it&apos;s worth deciding if we want to preserve the current &apos;UPDATE IF always checks for row existence&apos; behavior or not.&lt;/p&gt;</comment>
                            <comment id="13885136" author="scs95" created="Wed, 29 Jan 2014 08:32:06 +0000"  >&lt;p&gt;Dear Sylvain Lebresne,&lt;/p&gt;

&lt;p&gt;Sorry for the late reply but we had much work to finish. Thank you for your respond. We wanted to use lightweight transaction as a semaphore (to lock a row or a Column Family). We would have used the TTL to guarantee a time limit for processes. As the null problem is only in CQL3 table, we use Compact Storage table for timed semaphores.&lt;/p&gt;

&lt;p&gt;Best Regards,&lt;/p&gt;

&lt;p&gt;Csaba Seres&lt;/p&gt;

</comment>
                            <comment id="13885589" author="slebresne" created="Wed, 29 Jan 2014 17:58:07 +0000"  >&lt;p&gt;Attaching patch that fetch the full CQL row for CAS as we do for normal selects. The patch did abstract a bit the conditions in SP.cas() so that we can deal with the details of thrift and CQL separatly, which I think is a lot cleaner anyway and is actually needed to lift a few of the current limitation of the current patch on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6561&quot; title=&quot;Static columns in CQL3&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6561&quot;&gt;&lt;del&gt;CASSANDRA-6561&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I&apos;ll note that the patch preserves the current behavior that a &apos;UPDATE IF&apos; implicitely check for the row existence, even if the conditions are all testing for &lt;tt&gt;null&lt;/tt&gt;. As said above, I don&apos;t know if that is the actual semantic we want to preserve or if we want to change it.&lt;/p&gt;</comment>
                            <comment id="13892577" author="iamaleksey" created="Wed, 5 Feb 2014 21:17:51 +0000"  >&lt;p&gt;LGTM&lt;/p&gt;

&lt;p&gt;Nits:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;I&apos;d rather see 
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!(c != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; c.isLive(now) &amp;amp;&amp;amp; c.value().equals(e.value())))&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; rewritten as &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (c == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || c.isMarkedForDelete(now) || !c.value().equals(e.value()))&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; in ThriftCASConditions (as it is more or less in ColumnsConditions, apparently)&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;hasLiveColumns() in ColumnsCondition is dead code&lt;/li&gt;
	&lt;li&gt;ByteBufferUtil in ModificationStatement; ColumnNameBuilder, NamesQueryFilter, and SliceQueryFilter in SP are now unused imports&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13893142" author="slebresne" created="Thu, 6 Feb 2014 07:50:57 +0000"  >&lt;p&gt;Committed (with nits fixed), thanks&lt;/p&gt;</comment>
                            <comment id="13922046" author="pkendall" created="Thu, 6 Mar 2014 05:47:11 +0000"  >&lt;p&gt;This problem is not fixed. I am trying to exactly as the steps as in comment #2 above and get exactly the same problems using the trunk version from git.&lt;/p&gt;

&lt;p&gt;The expiry time of a column is in seconds&lt;br/&gt;
The call time passed to isLive is in milliseconds&lt;br/&gt;
The queryTimestamp is in microseconds (not seconds like the comment in the patch says)&lt;br/&gt;
There are 3 calls to the CQL3CasConditions constructor passing the queryTimestamp and the one in ModificationStatement.executeWithCondition is the only one that changes the scale of the time value.&lt;/p&gt;

&lt;p&gt;From my testing the best solution is to remove the scaling done here and apply a divide by 1000 in the constructor of CQL3CasConditions.&lt;/p&gt;

&lt;p&gt;Attached patch &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12633056/12633056_0001-Fix-for-expiring-columns-used-in-cas-conditions.patch&quot; title=&quot;0001-Fix-for-expiring-columns-used-in-cas-conditions.patch attached to CASSANDRA-6623&quot;&gt;0001-Fix-for-expiring-columns-used-in-cas-conditions.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="13922211" author="slebresne" created="Thu, 6 Mar 2014 09:38:21 +0000"  >&lt;p&gt;That&apos;s correct, pushed that fix, thanks (the worst part is that there is a dtest but it was currently skipped, so activated it too).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12698908">CASSANDRA-6801</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12633056" name="0001-Fix-for-expiring-columns-used-in-cas-conditions.patch" size="2241" author="pkendall" created="Thu, 6 Mar 2014 06:26:34 +0000"/>
                            <attachment id="12625907" name="6623.txt" size="21055" author="slebresne" created="Wed, 29 Jan 2014 17:58:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>370094</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 37 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1rsbz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>370396</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>