<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:28:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-18361] Test Failure: secondary_indexes_test.py::TestSecondaryIndexes::test_failing_manual_rebuild_index</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-18361</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The Python dtest&#160;&lt;tt&gt;secondary_indexes_test.py::TestSecondaryIndexes::test_failing_manual_rebuild_index&lt;/tt&gt; is flaky, at least for trunk:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://butler.cassandra.apache.org/#/ci/upstream/workflow/Cassandra-trunk/failure/secondary_indexes_test/TestSecondaryIndexes/test_failing_manual_rebuild_index&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://butler.cassandra.apache.org/#/ci/upstream/workflow/Cassandra-trunk/failure/secondary_indexes_test/TestSecondaryIndexes/test_failing_manual_rebuild_index&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/1501/testReport/dtest.secondary_indexes_test/TestSecondaryIndexes/test_failing_manual_rebuild_index/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/job/Cassandra-trunk/1501/testReport/dtest.secondary_indexes_test/TestSecondaryIndexes/test_failing_manual_rebuild_index/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Error Message
failed on teardown with &lt;span class=&quot;code-quote&quot;&gt;&quot;Unexpected error found in node logs (see stdout &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; full details). Errors: [[node1] &lt;span class=&quot;code-quote&quot;&gt;&apos;ERROR [Reference-Reaper] 2023-03-23 00:23:43,597 Ref.java:237 - LEAK DETECTED: a reference (&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.io.util.FileHandle$Cleanup@967019010:/home/cassandra/cassandra/cassandra-dtest/tmp/dtest-hgjoy8rq/test/node1/data0/k/t-b7dae870c91011eda58f05bc40bfcaa1/nc-1-big-Index.db) to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.io.util.FileHandle$Cleanup@967019010:/home/cassandra/cassandra/cassandra-dtest/tmp/dtest-hgjoy8rq/test/node1/data0/k/t-b7dae870c91011eda58f05bc40bfcaa1/nc-1-big-Index.db was not released before the reference was garbage collected&apos;&lt;/span&gt;]&quot;&lt;/span&gt;
Stacktrace
Unexpected error found in node logs (see stdout &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; full details). Errors: [[node1] &lt;span class=&quot;code-quote&quot;&gt;&apos;ERROR [Reference-Reaper] 2023-03-23 00:23:43,597 Ref.java:237 - LEAK DETECTED: a reference (&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.io.util.FileHandle$Cleanup@967019010:/home/cassandra/cassandra/cassandra-dtest/tmp/dtest-hgjoy8rq/test/node1/data0/k/t-b7dae870c91011eda58f05bc40bfcaa1/nc-1-big-Index.db) to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.io.util.FileHandle$Cleanup@967019010:/home/cassandra/cassandra/cassandra-dtest/tmp/dtest-hgjoy8rq/test/node1/data0/k/t-b7dae870c91011eda58f05bc40bfcaa1/nc-1-big-Index.db was not released before the reference was garbage collected&apos;&lt;/span&gt;]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The failure can be reproduced in CircleCI:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/2732/workflows/829434ab-2d1a-4e1c-8c7f-42449fcfda22&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/adelapena/cassandra/2732/workflows/829434ab-2d1a-4e1c-8c7f-42449fcfda22&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The CircleCI config I used to reproduce the test failure can be generated with:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
.circleci/generate.sh -p \
  -e REPEATED_DTESTS_COUNT=200 \
  -e REPEATED_DTESTS=secondary_indexes_test.py::TestSecondaryIndexes::test_failing_manual_rebuild_index
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13529977">CASSANDRA-18361</key>
            <summary>Test Failure: secondary_indexes_test.py::TestSecondaryIndexes::test_failing_manual_rebuild_index</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jlewandowski">Jacek Lewandowski</assignee>
                                    <reporter username="adelapena">Andres de la Pe&#241;a</reporter>
                        <labels>
                    </labels>
                <created>Fri, 24 Mar 2023 12:49:23 +0000</created>
                <updated>Fri, 10 Oct 2025 08:47:46 +0000</updated>
                            <resolved>Thu, 5 Oct 2023 13:39:37 +0000</resolved>
                                        <fixVersion>4.0.12</fixVersion>
                    <fixVersion>4.1.4</fixVersion>
                                    <component>Test/dtest/python</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="17718454" author="smiklosovic" created="Tue, 2 May 2023 06:40:26 +0000"  >&lt;p&gt;I am hitting this one quite often. &lt;/p&gt;</comment>
                            <comment id="17730960" author="edimitrova" created="Fri, 9 Jun 2023 13:42:54 +0000"  >&lt;p&gt;Seen also here - &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1050/workflows/72962ea6-8d12-4f59-b9f3-f3058a9af827/jobs/28651/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/driftx/cassandra/1050/workflows/72962ea6-8d12-4f59-b9f3-f3058a9af827/jobs/28651/tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17749196" author="adelapena" created="Mon, 31 Jul 2023 12:51:04 +0000"  >&lt;p&gt;This test failure has likely been introduced in 5.0, since it doesn&apos;t seem to reproduce in 4.1: &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3077/workflows/fb303d89-2196-490d-8e3b-8f6eb4fdc736&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/adelapena/cassandra/3077/workflows/fb303d89-2196-490d-8e3b-8f6eb4fdc736&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17763942" author="edimitrova" created="Mon, 11 Sep 2023 21:21:10 +0000"  >&lt;p&gt;I am bisecting this one - it started failing somewhere between b7eaa2d (not failing) and fb95112 (failing) commits. I will confirm exact commit later when my runs complete.&#160;&lt;/p&gt;</comment>
                            <comment id="17763957" author="edimitrova" created="Mon, 11 Sep 2023 22:23:40 +0000"  >&lt;p&gt;UPDATE: Clearly, this started failing with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18311&quot; title=&quot;BufferPool incorrectly counts memoryInUse when putUnusedPortion is used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18311&quot;&gt;&lt;del&gt;CASSANDRA-18311&lt;/del&gt;&lt;/a&gt; - &lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/2505/workflows/765ed0e9-95e9-4b90-9a11-93f4c464f456/jobs/40029/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/2505/workflows/765ed0e9-95e9-4b90-9a11-93f4c464f456/jobs/40029/tests&lt;/a&gt;&lt;br/&gt;
It was not failing with the previous commit from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16984&quot; title=&quot;Deprecate org.apache.cassandra.hadoop code&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16984&quot;&gt;&lt;del&gt;CASSANDRA-16984&lt;/del&gt;&lt;/a&gt; as it is visible in this run - &lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/2498/workflows/856b7f04-6899-470e-a867-292bc84d077c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/2498/workflows/856b7f04-6899-470e-a867-292bc84d077c&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The patch from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18311&quot; title=&quot;BufferPool incorrectly counts memoryInUse when putUnusedPortion is used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18311&quot;&gt;&lt;del&gt;CASSANDRA-18311&lt;/del&gt;&lt;/a&gt; was committed to 4.0, 4.1, and trunk, but as per &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt;&apos;s run, the test does not fail on 4.1.&lt;br/&gt;
Probably there was some difference in 5.0&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jlewandowski&quot; class=&quot;user-hover&quot; rel=&quot;jlewandowski&quot;&gt;jlewandowski&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jtgrabowski&quot; class=&quot;user-hover&quot; rel=&quot;jtgrabowski&quot;&gt;jtgrabowski&lt;/a&gt;, do you mind looking at this flaky test? The leak appears also in other tests, but most of the time with this one. Easy to reproduce and bisect to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18311&quot; title=&quot;BufferPool incorrectly counts memoryInUse when putUnusedPortion is used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18311&quot;&gt;&lt;del&gt;CASSANDRA-18311&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;
</comment>
                            <comment id="17769091" author="jlewandowski" created="Tue, 26 Sep 2023 10:01:47 +0000"  >&lt;p&gt;I can see no relation between &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18311&quot; title=&quot;BufferPool incorrectly counts memoryInUse when putUnusedPortion is used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18311&quot;&gt;&lt;del&gt;CASSANDRA-18311&lt;/del&gt;&lt;/a&gt; and this flaky test.&lt;br/&gt;
EDIT: the only way I think they can be related is that &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18311&quot; title=&quot;BufferPool incorrectly counts memoryInUse when putUnusedPortion is used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18311&quot;&gt;&lt;del&gt;CASSANDRA-18311&lt;/del&gt;&lt;/a&gt; modified a moment when gc is usually called, which made this problem more apparent.&lt;/p&gt;

&lt;p&gt;What I can see is that the test does something weird. It aims to fail the index build and it uses byteman to do that with the following rule:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;RULE fail during index building
CLASS org.apache.cassandra.db.compaction.CompactionManager
METHOD submitIndexBuild
AT ENTRY
# set flag to only run this rule once.
IF NOT flagged(&quot;done&quot;)
DO
   flag(&quot;done&quot;);
   throw new java.lang.RuntimeException(&quot;Index building failure&quot;)
ENDRULE
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The rule executes on entry of this method:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    Future&amp;lt;?&amp;gt; submitIndexBuild(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; SecondaryIndexBuilder builder, ActiveCompactionsTracker activeCompactions)
    {
        &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt; runnable = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt;()
        {
           ...
        };

        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; secondaryIndexExecutor.submitIfRunning(runnable, &lt;span class=&quot;code-quote&quot;&gt;&quot;index build&quot;&lt;/span&gt;);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As I can see, it is very unlikely that any exception could even happen in this place - maybe when the executor is already shutdown. I suppose the original intention was to make the runnable fail its execution, in which case, instead of throwing an exception at entry, we should return a fixed failed future.&lt;/p&gt;

&lt;p&gt;I&apos;ve managed to reproduce it locally and with enabled ref debugging, this is the stack trace of the offending reference creation:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  Thread[RMI TCP Connection(2)-127.0.0.1,5,RMI Runtime]
        at java.base/java.lang.Thread.getStackTrace(Thread.java:1602)
        at org.apache.cassandra.utils.concurrent.Ref$Debug.&amp;lt;init&amp;gt;(Ref.java:273)
        at org.apache.cassandra.utils.concurrent.Ref$State.&amp;lt;init&amp;gt;(Ref.java:194)
        at org.apache.cassandra.utils.concurrent.Ref.&amp;lt;init&amp;gt;(Ref.java:122)
        at org.apache.cassandra.utils.concurrent.Ref.tryRef(Ref.java:159)
        at org.apache.cassandra.utils.concurrent.Ref.ref(Ref.java:164)
        at org.apache.cassandra.utils.concurrent.SharedCloseableImpl.&amp;lt;init&amp;gt;(SharedCloseableImpl.java:35)
        at org.apache.cassandra.io.util.FileHandle.&amp;lt;init&amp;gt;(FileHandle.java:79)
        at org.apache.cassandra.io.util.FileHandle.sharedCopy(FileHandle.java:123)
        at org.apache.cassandra.io.sstable.format.big.BigTableKeyReader.create(BigTableKeyReader.java:77)
        at org.apache.cassandra.io.sstable.format.big.BigTableReader.keyReader(BigTableReader.java:157)
        at org.apache.cassandra.io.sstable.format.SSTableReader.keyIterator(SSTableReader.java:829)
        at org.apache.cassandra.io.sstable.ReducingKeyIterator.&amp;lt;init&amp;gt;(ReducingKeyIterator.java:48)
        at org.apache.cassandra.index.Index$CollatedViewIndexBuildingSupport.getIndexBuildTask(Index.java:195)
        at org.apache.cassandra.index.SecondaryIndexManager.lambda$buildIndexesBlocking$7(SecondaryIndexManager.java:632)
        at java.base/java.util.HashMap.forEach(HashMap.java:1337)
        at org.apache.cassandra.index.SecondaryIndexManager.buildIndexesBlocking(SecondaryIndexManager.java:630)
        at org.apache.cassandra.index.SecondaryIndexManager.rebuildIndexesBlocking(SecondaryIndexManager.java:423)
        at org.apache.cassandra.db.ColumnFamilyStore.rebuildSecondaryIndex(ColumnFamilyStore.java:904)
        at org.apache.cassandra.service.StorageService.rebuildSecondaryIndex(StorageService.java:6456)
        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
        at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.base/java.lang.reflect.Method.invoke(Method.java:566)
        at sun.reflect.misc.Trampoline.invoke(MethodUtil.java:71)
        at jdk.internal.reflect.GeneratedMethodAccessor1.invoke(Unknown Source)
        at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.base/java.lang.reflect.Method.invoke(Method.java:566)
        at java.base/sun.reflect.misc.MethodUtil.invoke(MethodUtil.java:260)
        at java.management/com.sun.jmx.mbeanserver.StandardMBeanIntrospector.invokeM2(StandardMBeanIntrospector.java:112)
        at java.management/com.sun.jmx.mbeanserver.StandardMBeanIntrospector.invokeM2(StandardMBeanIntrospector.java:46)
        at java.management/com.sun.jmx.mbeanserver.MBeanIntrospector.invokeM(MBeanIntrospector.java:237)
        at java.management/com.sun.jmx.mbeanserver.PerInterface.invoke(PerInterface.java:138)
        at java.management/com.sun.jmx.mbeanserver.MBeanSupport.invoke(MBeanSupport.java:252)
        at java.management/com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.invoke(DefaultMBeanServerInterceptor.java:809)
        at java.management/com.sun.jmx.mbeanserver.JmxMBeanServer.invoke(JmxMBeanServer.java:801)
        at java.management.rmi/javax.management.remote.rmi.RMIConnectionImpl.doOperation(RMIConnectionImpl.java:1466)
        at java.management.rmi/javax.management.remote.rmi.RMIConnectionImpl$PrivilegedOperation.run(RMIConnectionImpl.java:1307)
        at java.management.rmi/javax.management.remote.rmi.RMIConnectionImpl.doPrivilegedOperation(RMIConnectionImpl.java:1399)
        at java.management.rmi/javax.management.remote.rmi.RMIConnectionImpl.invoke(RMIConnectionImpl.java:827)
        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
        at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.base/java.lang.reflect.Method.invoke(Method.java:566)
        at java.rmi/sun.rmi.server.UnicastServerRef.dispatch(UnicastServerRef.java:359)
        at java.rmi/sun.rmi.transport.Transport$1.run(Transport.java:200)
        at java.rmi/sun.rmi.transport.Transport$1.run(Transport.java:197)
        at java.base/java.security.AccessController.doPrivileged(Native Method)
        at java.rmi/sun.rmi.transport.Transport.serviceCall(Transport.java:196)
        at java.rmi/sun.rmi.transport.tcp.TCPTransport.handleMessages(TCPTransport.java:562)
        at java.rmi/sun.rmi.transport.tcp.TCPTransport$ConnectionHandler.run0(TCPTransport.java:796)
        at java.rmi/sun.rmi.transport.tcp.TCPTransport$ConnectionHandler.lambda$run$0(TCPTransport.java:677)
        at java.base/java.security.AccessController.doPrivileged(Native Method)
        at java.rmi/sun.rmi.transport.tcp.TCPTransport$ConnectionHandler.run(TCPTransport.java:676)
        at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
        at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
        at java.base/java.lang.Thread.run(Thread.java:829)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;ll keep working on it...&lt;/p&gt;</comment>
                            <comment id="17769107" author="jlewandowski" created="Tue, 26 Sep 2023 10:54:41 +0000"  >&lt;p&gt;It looks like there is a bug in the production code as well - &lt;tt&gt;SecondaryIndexBuilder&lt;/tt&gt; is not expected to be closed. After creating it, if there are resources opened solely for it, those will be closed when &lt;tt&gt;build&lt;/tt&gt; method is invoked. However, in this case, we do not even call &lt;tt&gt;build&lt;/tt&gt;, so the resources are never closed.&lt;/p&gt;</comment>
                            <comment id="17769114" author="jlewandowski" created="Tue, 26 Sep 2023 11:07:30 +0000"  >&lt;p&gt;In order to reproduce it quite reliably on a local machine, it is enough to add a couple of &lt;tt&gt;System.gc()&lt;/tt&gt; calls to the beginning of the &lt;tt&gt;finally&lt;/tt&gt; block in &lt;tt&gt;org.apache.cassandra.index.SecondaryIndexManager#buildIndexesBlocking&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17769207" author="jlewandowski" created="Tue, 26 Sep 2023 14:18:56 +0000"  >&lt;p&gt;I&apos;ve prepared a test fix for this:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/cassandra-dtest/pull/235&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra-dtest/pull/235&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In essence, the fix moves the exception throwing to the thread. This is more appropriate imho because there is almost no way the exception could be thrown before the thread is started.  In only possibility for the production code to fail with a leak is that the executor is shutdown and we cannot submit the job. In this case, the opened iterator will not be ever closed. However, I suppose this could happen only on the server tear down. &lt;/p&gt;

&lt;p&gt;I&apos;m not very happy with the solution. I think we should modify the code so that the iterator is opened only in the place where it can be closed - instead of passing the ad-hoc initialized key iterator to the builder and assuming that &lt;tt&gt;build&lt;/tt&gt; method will be called, we should rather initialize the iterator inside the &lt;tt&gt;build&lt;/tt&gt; method, where the iterator is closed in the &lt;tt&gt;finally&lt;/tt&gt; block. &lt;/p&gt;</comment>
                            <comment id="17769260" author="jlewandowski" created="Tue, 26 Sep 2023 15:31:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt; - wdyt?&lt;/p&gt;</comment>
                            <comment id="17769493" author="jlewandowski" created="Wed, 27 Sep 2023 09:01:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/jacek-lewandowski/cassandra/943/workflows/3877e250-7bc6-48cf-9c52-c6d9bf828eb7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/jacek-lewandowski/cassandra/943/workflows/3877e250-7bc6-48cf-9c52-c6d9bf828eb7&lt;/a&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17769978" author="adelapena" created="Thu, 28 Sep 2023 10:14:53 +0000"  >&lt;p&gt;The fix looks good to me. We will also need 500-iteration runs for all branches since 4.0, with and without vnodes.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I&apos;m not very happy with the solution. I think we should modify the code so that the iterator is opened only in the place where it can be closed - instead of passing the ad-hoc initialized key iterator to the builder and assuming that&#160;&lt;tt&gt;build&lt;/tt&gt;&#160;method will be called, we should rather initialize the iterator inside the&#160;&lt;tt&gt;build&lt;/tt&gt;&#160;method, where the iterator is closed in the&#160;&lt;tt&gt;finally&lt;/tt&gt;&#160;block.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Is it the plan to do it here or on a separate ticket?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17769995" author="jlewandowski" created="Thu, 28 Sep 2023 10:55:14 +0000"  >&lt;p&gt;what vnodes have to do with it?&lt;/p&gt;</comment>
                            <comment id="17769997" author="adelapena" created="Thu, 28 Sep 2023 11:05:14 +0000"  >&lt;p&gt;Probably nothing, but there can always be surprises. That&apos;s why we run them with both configs on CI. The 500 runs can be divided with 250 in vnodes and 250 in no-vnodes.&lt;/p&gt;</comment>
                            <comment id="17770026" author="jlewandowski" created="Thu, 28 Sep 2023 12:04:09 +0000"  >&lt;p&gt;I&apos;m not going to fix the original issue in this ticket; I can create one to try to fix it for 5.0 and on, but I think we should not touch pre 5.0. I&apos;ll verify if the issue exists in the previous versions&lt;/p&gt;</comment>
                            <comment id="17770035" author="jlewandowski" created="Thu, 28 Sep 2023 12:28:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/jacek-lewandowski/cassandra/952/workflows/e61b7ff9-9003-4020-bc74-ad4349acf2ad&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/jacek-lewandowski/cassandra/952/workflows/e61b7ff9-9003-4020-bc74-ad4349acf2ad&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/jacek-lewandowski/cassandra/950/workflows/7d2d3b23-04b0-4fb7-befd-20ef288f9d10&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/jacek-lewandowski/cassandra/950/workflows/7d2d3b23-04b0-4fb7-befd-20ef288f9d10&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/jacek-lewandowski/cassandra/951/workflows/84600429-680b-4676-8bb5-12d9ac550a1f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/jacek-lewandowski/cassandra/951/workflows/84600429-680b-4676-8bb5-12d9ac550a1f&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;del&gt;The issue does not affect 4.0 and 4.1&lt;/del&gt; &lt;br/&gt;
UPDATE: In 4.1 there is a bug in the code which the test helped to reveal&lt;/p&gt;</comment>
                            <comment id="17770060" author="jlewandowski" created="Thu, 28 Sep 2023 13:32:44 +0000"  >&lt;p&gt;In 4.1 &lt;tt&gt;ReducedKeyIterator&lt;/tt&gt; is initialized lazily, that&apos;s why I&apos;ve initially claimed that the flaky test does not affect 4.1. Though there is a problem with it:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    Future&amp;lt;?&amp;gt; submitIndexBuild(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; SecondaryIndexBuilder builder, ActiveCompactionsTracker activeCompactions)
    {
        &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt; runnable = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt;()
        {
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run()
            {
                activeCompactions.beginCompaction(builder);
                &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
                {
                    builder.build();
                }
                &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt;
                {
                    activeCompactions.finishCompaction(builder);
                }
            }
        };

        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; executor.submitIfRunning(runnable, &lt;span class=&quot;code-quote&quot;&gt;&quot;index build&quot;&lt;/span&gt;);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;now - the &lt;tt&gt;builder.build()&lt;/tt&gt; method is supposed to close the key iterator in finally block. Since the key iterator internally initialized lazily, it will not close if it was not initialized yet; then, &lt;tt&gt;activeCompactions.finishCompaction()&lt;/tt&gt; accesses the key iterator and initializes it, and there is no place for it to be closed. In fact, if no exception is thrown, &lt;tt&gt;finishCompaction&lt;/tt&gt; accesses a closed iterator, which imo bad anyway.&lt;/p&gt;</comment>
                            <comment id="17770073" author="jlewandowski" created="Thu, 28 Sep 2023 14:12:00 +0000"  >&lt;p&gt;new run for 4.1: &lt;a href=&quot;https://app.circleci.com/pipelines/github/jacek-lewandowski/cassandra/953/workflows/281f3a9c-69b3-47f4-a905-c9266252bd7a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/jacek-lewandowski/cassandra/953/workflows/281f3a9c-69b3-47f4-a905-c9266252bd7a&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2749&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2749&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17770074" author="jlewandowski" created="Thu, 28 Sep 2023 14:17:43 +0000"  >&lt;p&gt;4.0 probably suffers from the same problem&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/jacek-lewandowski/cassandra/954/workflows/e1412dad-20e6-4fbc-a517-f18d984aa461&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/jacek-lewandowski/cassandra/954/workflows/e1412dad-20e6-4fbc-a517-f18d984aa461&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2751&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2751&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17771474" author="adelapena" created="Tue, 3 Oct 2023 13:10:18 +0000"  >&lt;p&gt;The patches look good to me. It seems that 4.0 has hit a couple of timeouts on index-related tests that probably aren&apos;t related. Nevertheless, I&apos;ve started some repeated runs for them (&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3231/workflows/d64c5f22-93ca-4d12-9589-12aa6d37717e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt; and &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3230/workflows/219c52b8-6334-44c5-8cee-aecfde4a2af0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.1&lt;/a&gt;) in case we have to open separate tickets for them.&lt;/p&gt;</comment>
                            <comment id="17771735" author="jlewandowski" created="Wed, 4 Oct 2023 07:14:32 +0000"  >&lt;p&gt;That was my mistake &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I&apos;ve confused if-branch levels... Nevertheless, the fix is pushed and tests are running for 4.0 - &lt;a href=&quot;https://app.circleci.com/pipelines/github/jacek-lewandowski/cassandra/964/workflows/2c5bfe26-2393-49ab-9a39-8ebf455d24b9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/jacek-lewandowski/cassandra/964/workflows/2c5bfe26-2393-49ab-9a39-8ebf455d24b9&lt;/a&gt; - if they are ok, I&apos;ll apply patch for 4.1 as well.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17771968" author="jlewandowski" created="Wed, 4 Oct 2023 18:25:15 +0000"  >&lt;p&gt;Ok, summary:&lt;/p&gt;

&lt;p&gt;Fix in dtests:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra-dtest/pull/235&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra-dtest/pull/235&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;No fix for trunk, repeated run of the modified test link attached to the PR&lt;/p&gt;

&lt;p&gt;No fix for 5.0, repeated run of the modified test link attached to the PR&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Fix for 4.1: &lt;a href=&quot;https://github.com/apache/cassandra/pull/2749&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2749&lt;/a&gt; with test links attached to the PR&lt;/p&gt;

&lt;p&gt;Fix for 4.0: &lt;a href=&quot;https://github.com/apache/cassandra/pull/2751&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2751&lt;/a&gt; with test links attached to the PR&lt;/p&gt;</comment>
                            <comment id="17772148" author="adelapena" created="Thu, 5 Oct 2023 09:33:21 +0000"  >&lt;p&gt;Looks good to me, +1&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13535770">CASSANDRA-18522</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jlewandowski]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12990" cascade-level="1"><![CDATA[Test Failure]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13861"><![CDATA[DTest]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 5 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1gu1s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[adelapena]]></customfieldvalue>
        <customfieldvalue><![CDATA[pkolaczk]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12349261">4.0.x</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/016d91a7d7d6c7998d1f3cb35726baf8dd9bac03&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/016d91a7d7d6c7998d1f3cb35726baf8dd9bac03&lt;/a&gt;, &lt;a href=&quot;https://github.com/apache/cassandra-dtest/commit/3af85373d70fb5d549447f6520da1d11a228d71a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra-dtest/commit/3af85373d70fb5d549447f6520da1d11a228d71a&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;run repeated tests&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>