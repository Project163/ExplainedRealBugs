<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:08:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13696] Digest mismatch Exception if hints file has UnknownColumnFamily</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13696</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;WARN  [HintsDispatcher:2] 2017-07-16 22:00:32,579 HintsReader.java:235 - Failed to read a hint for /127.0.0.2: a2b7daf1-a6a4-4dfc-89de-32d12d2d48b0 - table with id 3882bbb0-6a71-11e7-9bca-2759083e3964 is unknown in file a2b7daf1-a6a4-4dfc-89de-32d12d2d48b0-1500242103097-1.hints
ERROR [HintsDispatcher:2] 2017-07-16 22:00:32,580 HintsDispatchExecutor.java:234 - Failed to dispatch hints file a2b7daf1-a6a4-4dfc-89de-32d12d2d48b0-1500242103097-1.hints: file is corrupted ({})
org.apache.cassandra.io.FSReadError: java.io.IOException: Digest mismatch exception
    at org.apache.cassandra.hints.HintsReader$HintsIterator.computeNext(HintsReader.java:199) ~[main/:na]
    at org.apache.cassandra.hints.HintsReader$HintsIterator.computeNext(HintsReader.java:164) ~[main/:na]
    at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[main/:na]
    at org.apache.cassandra.hints.HintsDispatcher.sendHints(HintsDispatcher.java:157) ~[main/:na]
    at org.apache.cassandra.hints.HintsDispatcher.sendHintsAndAwait(HintsDispatcher.java:139) ~[main/:na]
    at org.apache.cassandra.hints.HintsDispatcher.dispatch(HintsDispatcher.java:123) ~[main/:na]
    at org.apache.cassandra.hints.HintsDispatcher.dispatch(HintsDispatcher.java:95) ~[main/:na]
    at org.apache.cassandra.hints.HintsDispatchExecutor$DispatchHintsTask.deliver(HintsDispatchExecutor.java:268) [main/:na]
    at org.apache.cassandra.hints.HintsDispatchExecutor$DispatchHintsTask.dispatch(HintsDispatchExecutor.java:251) [main/:na]
    at org.apache.cassandra.hints.HintsDispatchExecutor$DispatchHintsTask.dispatch(HintsDispatchExecutor.java:229) [main/:na]
    at org.apache.cassandra.hints.HintsDispatchExecutor$DispatchHintsTask.run(HintsDispatchExecutor.java:208) [main/:na]
    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) [na:1.8.0_111]
    at java.util.concurrent.FutureTask.run(FutureTask.java:266) [na:1.8.0_111]
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [na:1.8.0_111]
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [na:1.8.0_111]
    at org.apache.cassandra.concurrent.NamedThreadFactory.lambda$threadLocalDeallocator$0(NamedThreadFactory.java:79) [main/:na]
    at java.lang.Thread.run(Thread.java:745) ~[na:1.8.0_111]
Caused by: java.io.IOException: Digest mismatch exception
    at org.apache.cassandra.hints.HintsReader$HintsIterator.computeNextInternal(HintsReader.java:216) ~[main/:na]
    at org.apache.cassandra.hints.HintsReader$HintsIterator.computeNext(HintsReader.java:190) ~[main/:na]
    ... 16 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It causes multiple cassandra nodes stop &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/conf/cassandra.yaml#L188&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;by default&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Here is the reproduce steps on a 3 nodes cluster, RF=3:&lt;br/&gt;
1. stop node1&lt;br/&gt;
2. send some data with quorum (or one), it will generate hints file on node2/node3&lt;br/&gt;
3. drop the table&lt;br/&gt;
4. start node1&lt;/p&gt;

&lt;p&gt;node2/node3 will report &quot;corrupted hints file&quot; and stop. The impact is very bad for a large cluster, when it happens, almost all the nodes are down at the same time and we have to remove all the hints files (which contain the dropped table) to bring the node back.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13087482">CASSANDRA-13696</key>
            <summary>Digest mismatch Exception if hints file has UnknownColumnFamily</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jay.zhuang">Jay Zhuang</assignee>
                                    <reporter username="jay.zhuang">Jay Zhuang</reporter>
                        <labels>
                    </labels>
                <created>Mon, 17 Jul 2017 06:18:11 +0000</created>
                <updated>Fri, 15 May 2020 08:04:57 +0000</updated>
                            <resolved>Thu, 27 Jul 2017 00:00:23 +0000</resolved>
                                        <fixVersion>3.0.15</fixVersion>
                    <fixVersion>3.11.1</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="16089393" author="jay.zhuang" created="Mon, 17 Jul 2017 06:53:50 +0000"  >&lt;p&gt;The problem is because &lt;tt&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/io/util/RebufferingInputStream.java#L119&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;skipBytes()&lt;/a&gt;&lt;/tt&gt; will leave some value in the buffer. Before returning, it should call &lt;tt&gt;input.checkCrc()&lt;/tt&gt; to update the CRC.&lt;br/&gt;
The fix is to set &lt;tt&gt;hint=null&lt;/tt&gt; and use the reminding code to do &lt;tt&gt;checkCRC()&lt;/tt&gt;. Adding an uTest to reproduce the problem:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Branch &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; uTest &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/cooldoger/cassandra/tree/13696-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13696-3.0&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/cooldoger/cassandra/21&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circleci#21&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/cooldoger/cassandra/tree/13696-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13696-3.11&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/cooldoger/cassandra/24&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circleci#24&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/cooldoger/cassandra/tree/13696-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13696-trunk&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/cooldoger/cassandra/23&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circleci#23&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt; would you please review the patch?&lt;/p&gt;</comment>
                            <comment id="16090530" author="jjirsa" created="Mon, 17 Jul 2017 20:48:02 +0000"  >&lt;p&gt;Looks pretty serious, I&apos;ll try to get to it soon. Short term, your trunk patch doesn&apos;t actually compile ( &lt;tt&gt;CFMetaData&lt;/tt&gt; is gone in trunk), can you fix that and  push that branch? &lt;/p&gt;</comment>
                            <comment id="16091154" author="jay.zhuang" created="Tue, 18 Jul 2017 06:00:09 +0000"  >&lt;p&gt;Sure, updated the test for trunk:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Branch &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; uTest &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/cooldoger/cassandra/tree/13696-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13696-3.0&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/cooldoger/cassandra/21&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circleci#21&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/cooldoger/cassandra/tree/13696-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13696-3.11&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/cooldoger/cassandra/24&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circleci#24&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/cooldoger/cassandra/tree/13696-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13696-trunk&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/cooldoger/cassandra/25&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circleci#25&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Yes, I think it&apos;s a serious problem that all nodes go down at the same time. And to recover, the user has to delete all hints file (Not sure if there&apos;s an easy way to identify the &quot;corrupted&quot; hints files, system.log only shows the first one. So for us, we just delete all the hints files.)&lt;/p&gt;</comment>
                            <comment id="16092595" author="jjirsa" created="Wed, 19 Jul 2017 05:23:39 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jay.zhuang&quot; class=&quot;user-hover&quot; rel=&quot;jay.zhuang&quot;&gt;jay.zhuang&lt;/a&gt; - took a look and I don&apos;t see any issues. The new tests look good. trunk circleCI run failed due to circleci, but run #26 looks green.&lt;/p&gt;

&lt;p&gt;I&apos;d like to glance at it again tomorrow when I&apos;m more awake, but as of right now, it seems very reasonable and correct to me.&lt;/p&gt;
</comment>
                            <comment id="16092658" author="jay.zhuang" created="Wed, 19 Jul 2017 06:31:51 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt;.&lt;br/&gt;
I did more investigation today. Seems it&apos;s more serious than I thought. Even there&apos;s no down node, &quot;drop table&quot; + write traffic, will trigger the problem.&lt;br/&gt;
Here is reproduce steps:&lt;br/&gt;
1. Create a 3 nodes cluster:&lt;br/&gt;
  &lt;tt&gt;$ ccm create test13696 -v 3.0.14 &amp;amp;&amp;amp; ccm populate -n 3 &amp;amp;&amp;amp; ccm start&lt;/tt&gt;&lt;br/&gt;
2. Send some traffics with cassandra-stress (blogpost.yaml is only in trunk, if you use another yaml file, change the RF=3)&lt;br/&gt;
  &lt;tt&gt;$ tools/bin/cassandra-stress user profile=test/resources/blogpost.yaml cl=QUORUM truncate=never ops&amp;#40;insert=1&amp;#41; duration=30m -rate threads=2 -mode native cql3 -node 127.0.0.1&lt;/tt&gt;&lt;br/&gt;
3. While the traffic is running, drop table&lt;br/&gt;
  &lt;tt&gt;$ cqlsh -e &quot;drop table  stresscql.blogposts&quot;&lt;/tt&gt;&lt;br/&gt;
&lt;b&gt;All 3 nodes go down because of &quot;Digest mismatch Exception&quot;.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The CRC calculation problem has been there for a long time, but only got exposed after &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13004&quot; title=&quot;Corruption while adding/removing a column to/from the table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13004&quot;&gt;&lt;del&gt;CASSANDRA-13004&lt;/del&gt;&lt;/a&gt; because of the MessagingService version bump. In the normal case when the versions are the same, HintsDispatcher uses &lt;tt&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/hints/HintsDispatcher.java#L138&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;page.buffersIterator()&lt;/a&gt;&lt;/tt&gt; instead of &lt;tt&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/hints/HintsDispatcher.java#L139&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;page.hintsIterator()&lt;/a&gt;&lt;/tt&gt;. &lt;tt&gt;buffersIterator()&lt;/tt&gt; doesn&apos;t need to decode hints, so it won&apos;t have the problem.&lt;/p&gt;

&lt;p&gt;I think the messagingVersion for the hints file should be updated: &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...cooldoger:13696.2-3.0?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/cassandra-3.0...cooldoger:13696.2-3.0?expand=1&lt;/a&gt; so it could dispatch hints in an optimized way. Not sure if we need to check/bump other {{MessagingService.VERSION_30}}s in the 3.0 branch.&lt;br/&gt;
cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16092704" author="jjirsa" created="Wed, 19 Jul 2017 07:19:01 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; as well.&lt;/p&gt;</comment>
                            <comment id="16092952" author="ifesdjeen" created="Wed, 19 Jul 2017 11:29:04 +0000"  >&lt;p&gt;Might be we want to use either 30 or 3014 depending on which one is active?&lt;/p&gt;

&lt;p&gt;Question: does this happen in mixed version cluster or all the nodes actually have the same protocol version?&lt;/p&gt;</comment>
                            <comment id="16093491" author="jay.zhuang" created="Wed, 19 Jul 2017 17:48:54 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Question: does this happen in mixed version cluster or all the nodes actually have the same protocol version?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;All the nodes are on the same messagingVersion &lt;tt&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/net/MessagingService.java#L95&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;VERSION_3014&lt;/a&gt;&lt;/tt&gt;&lt;br/&gt;
It can be reproduced with a new 3.0.14 cluster.&lt;/p&gt;</comment>
                            <comment id="16094602" author="ifesdjeen" created="Thu, 20 Jul 2017 12:20:41 +0000"  >&lt;p&gt;I agree we should also return a correct version from the hints service (as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jay.zhuang&quot; class=&quot;user-hover&quot; rel=&quot;jay.zhuang&quot;&gt;jay.zhuang&lt;/a&gt; already mentioned), like &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...cooldoger:13696.2-3.0?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; same as we do in commit log descriptor.&lt;/p&gt;

&lt;p&gt;This also would make the issue for same-version go away, and since it would make the service to pick a different code path I&apos;d say it&apos;s also necessary to include it. &lt;/p&gt;

&lt;p&gt;WRT to the patch itself, might be it&apos;s better to just call &lt;tt&gt;resetCrc&lt;/tt&gt; explicitly and still return null like I did &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:13696-3.0#diff-cf15f9cac67d8b2f3e581129d617df16R242&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;? &lt;tt&gt;hint&lt;/tt&gt; is a local variable, and setting it and carrying on makes the logic a bit harder to understand. For example, for me it was non-obvious that this boolean method would also do some buffer rewinding / state resetting under the hood. &lt;/p&gt;</comment>
                            <comment id="16094839" author="jjirsa" created="Thu, 20 Jul 2017 15:38:21 +0000"  >&lt;p&gt;Wanted to chat with Aleksey offline about the version implications, so withholding comment on that for a bit, but:&lt;/p&gt;


&lt;blockquote&gt;
&lt;p&gt;might be it&apos;s better to just call resetCrc explicitly and still return null like I did here? hint is a local variable, and setting it and carrying on makes the logic a bit harder to understand. For example, for me it was non-obvious that this boolean method would also do some buffer rewinding / state resetting under the hood.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think the current behavior is actually the right thing to do. Simply resetting the CRC state isn&apos;t enough, we need to check to see if the CRC matches, because we want to invoke the disk failure policy if we&apos;re reading corrupt data, and frankly, a corruption source (bad disk / RAM / etc) that flips bits could cause us to see an invalid CFID, and skipping the corruption test at that point would be the wrong thing to do. A few more comment lines are probably worthwhile, though, since it seems like an easy &apos;fix&apos; to revert in the future because it&apos;s nonobvious. &lt;/p&gt;
</comment>
                            <comment id="16094903" author="ifesdjeen" created="Thu, 20 Jul 2017 16:14:12 +0000"  >&lt;blockquote&gt;&lt;p&gt;Simply resetting the CRC state isn&apos;t enough,&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;True. Re-read the issue description/first comment, now it&apos;s quite obvious. Thanks for explanation. &lt;/p&gt;

&lt;p&gt;Adding a comment would be great though!&lt;/p&gt;</comment>
                            <comment id="16095169" author="jay.zhuang" created="Thu, 20 Jul 2017 18:35:11 +0000"  >&lt;p&gt;Updated based on the reviews:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Branch &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; uTest &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/cooldoger/cassandra/tree/13696-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13696-3.0&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/cooldoger/cassandra/31&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circleci#31&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/cooldoger/cassandra/tree/13696-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13696-3.11&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/cooldoger/cassandra/32&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circleci#32&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/cooldoger/cassandra/tree/13696-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13696-trunk&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/cooldoger/cassandra/30&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circleci#30&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Also, &lt;tt&gt;resetCrc()&lt;/tt&gt; could also cause CRC mismatch for the next hint read in the same file.&lt;/p&gt;

&lt;p&gt;Another question is why dropTable + write traffic will cause hints file, do you think it&apos;s an issue? I create a separate ticket to track that: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13712&quot; title=&quot;DropTable could cause hints&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13712&quot;&gt;&lt;del&gt;CASSANDRA-13712&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16098282" author="iamaleksey" created="Mon, 24 Jul 2017 12:24:43 +0000"  >&lt;p&gt;+1 from me as well.&lt;/p&gt;</comment>
                            <comment id="16098294" author="iamaleksey" created="Mon, 24 Jul 2017 12:33:10 +0000"  >&lt;blockquote&gt;
&lt;p&gt;The CRC calculation problem has been there for a long time, but only got exposed after &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13004&quot; title=&quot;Corruption while adding/removing a column to/from the table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13004&quot;&gt;&lt;del&gt;CASSANDRA-13004&lt;/del&gt;&lt;/a&gt; because of the MessagingService version bump. In the normal case when the versions are the same, HintsDispatcher uses page.buffersIterator() instead of page.hintsIterator(). buffersIterator() doesn&apos;t need to decode hints, so it won&apos;t have the problem.&lt;br/&gt;
I think the messagingVersion for the hints file should be updated: &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...cooldoger:13696.2-3.0?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/cassandra-3.0...cooldoger:13696.2-3.0?expand=1&lt;/a&gt; so it could dispatch hints in an optimized way. Not sure if we need to check/bump other &lt;tt&gt;MessagingService.VERSION_30&lt;/tt&gt; s in the 3.0 branch.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;And your analysis is correct, too. Thanks for catching and fixing it.&lt;/p&gt;</comment>
                            <comment id="16098443" author="jjirsa" created="Mon, 24 Jul 2017 13:52:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jay.zhuang&quot; class=&quot;user-hover&quot; rel=&quot;jay.zhuang&quot;&gt;jay.zhuang&lt;/a&gt; - could you rebuild 3.11 on circleci? test failed (exceeded memory limit), I&apos;m fairly confident it&apos;s benign, but we should have a green test before committing (I&apos;m confident it&apos;s benign because the test actually passed on 3.11 before the messaging fix, but we should prove there&apos;s not a regression there).&lt;/p&gt;</comment>
                            <comment id="16098894" author="jay.zhuang" created="Mon, 24 Jul 2017 17:47:31 +0000"  >&lt;p&gt;Sure, rebuilt the CI, and it&apos;s passed: &lt;a href=&quot;https://circleci.com/gh/cooldoger/cassandra/43&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/gh/cooldoger/cassandra/43&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16098908" author="jjirsa" created="Mon, 24 Jul 2017 18:03:05 +0000"  >&lt;p&gt;lgtm will commit when I have time.&lt;/p&gt;</comment>
                            <comment id="16102492" author="jjirsa" created="Thu, 27 Jul 2017 00:00:23 +0000"  >&lt;p&gt;Committed to 3.0 as &lt;tt&gt;f919cf4a478cdbcb7864e8b47814a40bfcb343a7&lt;/tt&gt; and merged to 3.11 and trunk. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jay.zhuang&quot; class=&quot;user-hover&quot; rel=&quot;jay.zhuang&quot;&gt;jay.zhuang&lt;/a&gt;, good find!&lt;/p&gt;</comment>
                            <comment id="16430989" author="vinegh" created="Mon, 9 Apr 2018 18:05:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jay.zhuang&quot; class=&quot;user-hover&quot; rel=&quot;jay.zhuang&quot;&gt;jay.zhuang&lt;/a&gt;: I am not sure if this the same issue. I appiled commit you have here on 3.11.1 and we still see the following issue on a 14 node cluster&lt;/p&gt;

&lt;p&gt;Any ideas on what might be wrong?&lt;/p&gt;

&lt;p&gt;ERROR&#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;HintsDispatcher:1&amp;#93;&lt;/span&gt;&#160;2018-04-06 16:26:44,423 CassandraDaemon.java:228 - Exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;HintsDispatcher:1,1,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
org.apache.cassandra.io.FSReadError: java.io.IOException: Digest mismatch exception&lt;br/&gt;
at org.apache.cassandra.hints.HintsReader$BuffersIterator.computeNext(HintsReader.java:298) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.1.jar:3.11.1-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
at org.apache.cassandra.hints.HintsReader$BuffersIterator.computeNext(HintsReader.java:263) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.1.jar:3.11.1-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.1.jar:3.11.1-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
at org.apache.cassandra.hints.HintsDispatcher.sendHints(HintsDispatcher.java:169) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.1.jar:3.11.1-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
at org.apache.cassandra.hints.HintsDispatcher.sendHintsAndAwait(HintsDispatcher.java:128) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.1.jar:3.11.1-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
at org.apache.cassandra.hints.HintsDispatcher.dispatch(HintsDispatcher.java:113) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.1.jar:3.11.1-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
at org.apache.cassandra.hints.HintsDispatcher.dispatch(HintsDispatcher.java:94) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.1.jar:3.11.1-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
at org.apache.cassandra.hints.HintsDispatchExecutor$DispatchHintsTask.deliver(HintsDispatchExecutor.java:278) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.1.jar:3.11.1-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
at org.apache.cassandra.hints.HintsDispatchExecutor$DispatchHintsTask.dispatch(HintsDispatchExecutor.java:260) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.1.jar:3.11.1-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
at org.apache.cassandra.hints.HintsDispatchExecutor$DispatchHintsTask.dispatch(HintsDispatchExecutor.java:238) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.1.jar:3.11.1-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
at org.apache.cassandra.hints.HintsDispatchExecutor$DispatchHintsTask.run(HintsDispatchExecutor.java:217) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.1.jar:3.11.1-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_141&amp;#93;&lt;/span&gt;&lt;br/&gt;
at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_141&amp;#93;&lt;/span&gt;&lt;br/&gt;
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_141&amp;#93;&lt;/span&gt;&lt;br/&gt;
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)&#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_141&amp;#93;&lt;/span&gt;&lt;br/&gt;
at org.apache.cassandra.concurrent.NamedThreadFactory.lambda$threadLocalDeallocator$0(NamedThreadFactory.java:81)&#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.1.jar:3.11.1-SNAPSHOT&amp;#93;&lt;/span&gt;&lt;br/&gt;
at java.lang.Thread.run(Thread.java:748) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_141&amp;#93;&lt;/span&gt;&lt;br/&gt;
Caused by: java.io.IOException: Digest mismatch exception&lt;/p&gt;

&lt;p&gt;To overcome this we do a truncatehints and everything works after that. Issue happens once a while we have seen it twice so far on 14 node cluster and 7 node cluster&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16431515" author="jay.zhuang" created="Mon, 9 Apr 2018 23:54:36 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vinegh&quot; class=&quot;user-hover&quot; rel=&quot;vinegh&quot;&gt;vinegh&lt;/a&gt;, this should be a different issue, as &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.11/src/java/org/apache/cassandra/hints/HintsDispatcher.java#L128&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;HintsDispatcher.java:128&lt;/tt&gt;&lt;/a&gt; sends hints with {{buffer}}s, this patch is only to fix the digest mismatch for &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.11/src/java/org/apache/cassandra/hints/HintsDispatcher.java#L129&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;HintsDispatcher.java:129&lt;/tt&gt;&lt;/a&gt;, which sends hints one by one.&lt;/p&gt;

&lt;p&gt;Do you see the digest mismatch issue on one node or multiple nodes? Do you have schema change during that? Maybe you should file a separate ticket for that.&lt;/p&gt;</comment>
                            <comment id="16431791" author="vinegh" created="Tue, 10 Apr 2018 06:35:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jay.zhuang&quot; class=&quot;user-hover&quot; rel=&quot;jay.zhuang&quot;&gt;jay.zhuang&lt;/a&gt;: Yes we see it on multiple hosts. Yes, schema is being&#160;propagated to other nodes. We create schema on one node and bring up rest of nodes so it should take a while to propagate. I will file a separate ticket too.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jay.zhuang]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12983" cascade-level=""><![CDATA[Availability]]></customfieldvalue>
                                <customfieldvalue key="12993" cascade-level="1"><![CDATA[Cluster Crash]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 32 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3hkxb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12340362">3.0.14</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jjirsa</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jjirsa]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>