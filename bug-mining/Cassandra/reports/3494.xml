<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:52:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8336] Add shutdown gossip state to prevent timeouts during rolling restarts</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8336</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3936&quot; title=&quot;Gossip should have a &amp;#39;goodbye&amp;#39; command to indicate shutdown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3936&quot;&gt;&lt;del&gt;CASSANDRA-3936&lt;/del&gt;&lt;/a&gt; we added a gossip shutdown announcement.  The problem here is that this isn&apos;t sufficient; you can still get TOEs and have to wait on the FD to figure things out.  This happens due to gossip propagation time and variance; if node X shuts down and sends the message to Y, but Z has a greater gossip version than Y for X and has not yet received the message, it can initiate gossip with Y and thus mark X alive again.  I propose quarantining to solve this, however I feel it should be a -D parameter you have to specify, so as not to destroy current dev and test practices, since this will mean a node that shuts down will not be able to restart until the quarantine expires.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12756196">CASSANDRA-8336</key>
            <summary>Add shutdown gossip state to prevent timeouts during rolling restarts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brandon.williams">Brandon Williams</assignee>
                                    <reporter username="brandon.williams">Brandon Williams</reporter>
                        <labels>
                    </labels>
                <created>Tue, 18 Nov 2014 20:02:48 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:28 +0000</updated>
                            <resolved>Wed, 15 Apr 2015 14:36:41 +0000</resolved>
                                        <fixVersion>2.0.15</fixVersion>
                    <fixVersion>2.1.5</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14244857" author="brandon.williams" created="Fri, 12 Dec 2014 22:00:33 +0000"  >&lt;p&gt;So the real wrinkle here is that when we send the shutdown message, our latest heartbeat hasn&apos;t propagated fully, so even if the nodes quarantine, a newer heartbeat will eventually be seen, marking the killed node as back up.  I&apos;m not sure what we can do about that, short of changing the format for the shutdown message to include the heartbeat and then filtering based on that.  Unfortunately that puts us in 3.1 territory, where we&apos;ll have to make 3.0 a prerequisite.&lt;/p&gt;</comment>
                            <comment id="14244880" author="brandon.williams" created="Fri, 12 Dec 2014 22:12:12 +0000"  >&lt;p&gt;Perhaps one thing we could do is put the node into hibernation before the shutdown message.  This way, it will never get marked alive regardless of the heartbeat, even if it propagates later.  We might want a new dead state for that though, since I don&apos;t want to overload the hibernation state with too many functions since that will complicate knowing what state a node is really in.&lt;/p&gt;</comment>
                            <comment id="14284444" author="brandon.williams" created="Tue, 20 Jan 2015 21:26:58 +0000"  >&lt;p&gt;Patch to take the hibernate approach, but use a new STATUS VV called SHUTDOWN.  One reason we need this (not just for operator clarity) is that we have to special case it for Gossiper.convict, since if it receives our shutdown state passively over gossip before it receives it actively over RPC it will be in a dead state and left untouched. We can also race the other way (rpc before passive) but the isAlive check prevents us from doubly marking it down.&lt;/p&gt;

&lt;p&gt;In a mixed cluster, this still preserves the old behavior, since they won&apos;t know what &apos;shutdown&apos; means and just rely on the active rpc method to mark the node down.&lt;/p&gt;</comment>
                            <comment id="14288251" author="brandon.williams" created="Thu, 22 Jan 2015 21:28:02 +0000"  >&lt;p&gt;This patch helps, but the problem with this is approach is the node can still flap, given a disjoint enough (gossip state-wise) cluster.  There are a few ways we can solve this:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;quarantine after shutdown.  This has the consequence of not being able to restart a node until the quarantine expires.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Sleep for ring_delay or some interval after setting the shutdown state before sending the rpc shutdown.  I&apos;m not 100% sure this would prevent the flapping, and sleeping that long on shutdown sucks as equally as not being able to reboot until the quarantine expires.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;I suggest a third way, which I&apos;ll discuss below.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The method suggests when node X receives a shutdown event from Y, it will update its local state for Y to version Integer.MAX_VALUE, and thus no updates for the same generation will be accepted since they will always have a lower version.  When Y restarts it will have a new generation and everything will work normally.  &lt;/p&gt;

&lt;p&gt;There is one consequence to this method, and that is that gossipdisable/enable has to now generate a new generation, which triggers the &quot;has restarted, now UP&quot; message on other nodes, but this seems like a fairly minor thing.&lt;/p&gt;

&lt;p&gt;On the surface, it may seem easier to have Y just send with a version of MAX_VALUE, but that will only apply to nodes that receive it via gossip, not the ones that receive it via rpc which is likely the bulk of them, and it wouldn&apos;t be an optimization anyway since we only sleep for one gossip round, and the node(s) we gossip to will set the version anyway before propagating it to the rest of the cluster.&lt;/p&gt;

&lt;p&gt;v2 does this.&lt;/p&gt;</comment>
                            <comment id="14302098" author="brandon.williams" created="Mon, 2 Feb 2015 22:52:37 +0000"  >&lt;p&gt;v2 has a few problems:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;If a node joins while another is shutdown, it won&apos;t see the down node&apos;s tokens because it&apos;s a dead state.  This is somewhat tricky to fix since now we need a third class of states aside from live/dead.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;when we decom and the user kills the node, it goes into shutdown state instead of LEFT&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;we should probably do both active and passive announcement, then sleep before killing the gossiper&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14304167" author="brandon.williams" created="Tue, 3 Feb 2015 22:38:33 +0000"  >&lt;p&gt;v3 addresses the previous issues.  It turns out for the first problem, the simplest thing to do is not make shutdown a dead state, and instead special case detection of it in handleMajorStateChange at the very end.  SS treats shutdown nodes as normal in the onJoin event, and then immediately afterward receives the event that it is shutdown.&lt;/p&gt;</comment>
                            <comment id="14325170" author="rlow" created="Wed, 18 Feb 2015 00:07:57 +0000"  >&lt;p&gt;v3 works well and I was able to do a full cluster bounce with zero timeouts.&lt;/p&gt;

&lt;p&gt;Here&#8217;s a few minor points:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;The shutting down node might as well set the version of the shutdown state to Integer.MAX_VALUE since receiving nodes will blindly use that.&lt;/li&gt;
	&lt;li&gt;Why does it increment the generation number? We call Gossiper.instance.start with a new generation number set to the current time so it would make sense to use that.&lt;/li&gt;
	&lt;li&gt;If hit &apos;Unable to gossip with any seeds&#8217; on replace, it shuts down the gossiper. This throws an AssertionError in addLocalApplicationState since the local epState is null.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14329286" author="brandon.williams" created="Fri, 20 Feb 2015 18:10:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;The shutting down node might as well set the version of the shutdown state to Integer.MAX_VALUE since receiving nodes will blindly use that.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Well, as I explained in an earlier comment, this isn&apos;t really much of an optimization, and if the nodes receive the RPC first, we have to modify it on the receiver anyway, so it seems cleaner to reuse markAsShutdown for both.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Why does it increment the generation number? We call Gossiper.instance.start with a new generation number set to the current time so it would make sense to use that.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Because start calls maybeInitializeLocalState which won&apos;t actually add the current time heartbeat, since as the method says, it will only add the new state if the gossiper has never been started before (meaning we don&apos;t know our own state.)&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If hit &apos;Unable to gossip with any seeds&#8217; on replace, it shuts down the gossiper. This throws an AssertionError in addLocalApplicationState since the local epState is null.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hmm, probably the best thing to do there is change it from stop to stopForLeaving (though that method needs a better name now) since there&apos;s no point in sending shutdown notifications for a node that isn&apos;t a member.&lt;/p&gt;</comment>
                            <comment id="14339022" author="brandon.williams" created="Thu, 26 Feb 2015 19:44:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;If hit &apos;Unable to gossip with any seeds&#8217; on replace, it shuts down the gossiper.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Do you have the stacktrace where this is happening?  I have a feeling we&apos;re going to end up in checked exception hell trying to fix this since we throw RuntimeException there (to avoid such a hell, in fact.)&lt;/p&gt;</comment>
                            <comment id="14341222" author="rlow" created="Sat, 28 Feb 2015 02:17:06 +0000"  >&lt;p&gt;Here it is:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [main] 2015-02-27 18:11:57,584 CassandraDaemon.java (line 513) Exception encountered during startup
java.lang.RuntimeException: Unable to gossip with any seeds
        at org.apache.cassandra.gms.Gossiper.doShadowRound(Gossiper.java:1270)
        at org.apache.cassandra.service.StorageService.checkForEndpointCollision(StorageService.java:459)
        at org.apache.cassandra.service.StorageService.prepareToJoin(StorageService.java:673)
        at org.apache.cassandra.service.StorageService.initServer(StorageService.java:625)
        at org.apache.cassandra.service.StorageService.initServer(StorageService.java:517)
        at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:378)
        at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:496)
        at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:585)
 INFO [StorageServiceShutdownHook] 2015-02-27 18:11:57,605 Gossiper.java (line 1370) Announcing shutdown
ERROR [StorageServiceShutdownHook] 2015-02-27 18:11:57,607 CassandraDaemon.java (line 199) Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[StorageServiceShutdownHook,5,main]
java.lang.AssertionError
        at org.apache.cassandra.gms.Gossiper.addLocalApplicationState(Gossiper.java:1339)
        at org.apache.cassandra.gms.Gossiper.stop(Gossiper.java:1371)
        at org.apache.cassandra.service.StorageService$1.runMayThrow(StorageService.java:586)
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14389207" author="brandon.williams" created="Tue, 31 Mar 2015 19:02:37 +0000"  >&lt;p&gt;After wrestling with exceptions for a bit, I came up with a simpler solution.  Gossiper&apos;s stop() can examine the local state itself, and skip shutdown announcement if it doesn&apos;t exist.  We still need stopSilently (which I renamed in this patch from stopForLeaving) for cases like decom, where we aren&apos;t coming back and don&apos;t want to mutate our state on shutdown.&lt;/p&gt;</comment>
                            <comment id="14481559" author="brandon.williams" created="Mon, 6 Apr 2015 18:23:24 +0000"  >&lt;p&gt;There is one last wrinkle with this: if a bootstrap is started but then aborted by the operator, the shutdown message makes it part of the ring in that it will be persisted to system.peers, which then confuses clients.  I believe the same will happen with an aborted replace_address as well, or any non-normal state which gets aborted and then sends the shutdown state.  One solution might be to have Gossiper&apos;s stop() examine its own state and compare against dead states and the joining state to decide whether to send the shutdown state or not.&lt;/p&gt;</comment>
                            <comment id="14492782" author="brandon.williams" created="Mon, 13 Apr 2015 18:21:02 +0000"  >&lt;p&gt;v5 creates a SILENT_SHUTDOWN_STATES list that stop() now checks, which is DEAD_STATES plus bootstrap and left.  Since LEFT is in there, we don&apos;t need stopSilently anymore, which I rather like.  Unfortunately the issue I previously mentioned about failed bootstraps is not the fault of this patch but a bug in 2.0 itself I happened to discover, which we can address in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9180&quot; title=&quot;Failed bootstrap/replace attempts persist entries in system.peers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9180&quot;&gt;&lt;del&gt;CASSANDRA-9180&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14493345" author="rlow" created="Tue, 14 Apr 2015 00:18:40 +0000"  >&lt;p&gt;+1, thanks Brandon!&lt;/p&gt;</comment>
                            <comment id="14496255" author="brandon.williams" created="Wed, 15 Apr 2015 14:36:41 +0000"  >&lt;p&gt;Committed, with minor nit: LEFT is a dead state, so adding it to SILENT_SHUTDOWN_STATES was redundant.&lt;/p&gt;</comment>
                            <comment id="14538155" author="aweisberg" created="Mon, 11 May 2015 16:46:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; don&apos;t shoot the messenger, but you had a behavior of Gossip you didn&apos;t like. You made changes to try and get a different behavior. But I don&apos;t see a test added checking that?&lt;/p&gt;

&lt;p&gt;I know Gossip testing is problematic as you commented on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9100&quot; title=&quot;Gossip is inadequately tested&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9100&quot;&gt;CASSANDRA-9100&lt;/a&gt;. If you as a developer can&apos;t test the changes you are making in a reasonable way then that is definitely retrospective fodder for went poorly. It also maybe shows us what it is costing to not tackle the singleton issue.&lt;/p&gt;</comment>
                            <comment id="14538177" author="brandon.williams" created="Mon, 11 May 2015 17:04:01 +0000"  >&lt;p&gt;We actually do test rolling restarts in the dtests, the problem is you need a fairly large cluster to see this problem.&lt;/p&gt;</comment>
                            <comment id="14538198" author="rlow" created="Mon, 11 May 2015 17:16:13 +0000"  >&lt;p&gt;How big is your largest QA cluster? I did extensive manual tests to verify this fixes the issue in a large cluster.&lt;/p&gt;</comment>
                            <comment id="14538212" author="aweisberg" created="Mon, 11 May 2015 17:21:58 +0000"  >&lt;p&gt;I was thinking of a unit test for the behaviors not a regression test for the bug. &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9100&quot; title=&quot;Gossip is inadequately tested&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9100&quot;&gt;CASSANDRA-9100&lt;/a&gt; is going to have to evolve into whatever it takes to make Gossip reliable every time we release.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12839532">CASSANDRA-9630</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12693999" name="8336-v2.txt" size="8035" author="brandon.williams" created="Thu, 22 Jan 2015 21:33:11 +0000"/>
                            <attachment id="12696306" name="8336-v3.txt" size="9858" author="brandon.williams" created="Tue, 3 Feb 2015 22:38:33 +0000"/>
                            <attachment id="12708500" name="8336-v4.txt" size="10889" author="brandon.williams" created="Tue, 31 Mar 2015 19:02:37 +0000"/>
                            <attachment id="12693391" name="8336.txt" size="3587" author="brandon.williams" created="Tue, 20 Jan 2015 21:26:58 +0000"/>
                            <attachment id="12724993" name="8366-v5.txt" size="12002" author="brandon.williams" created="Mon, 13 Apr 2015 18:21:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 28 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i22it3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>richardlow</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[richardlow]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311124" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Tester</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>philipthompson</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>