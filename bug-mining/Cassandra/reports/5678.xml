<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:19:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16526] BinLogTest is flaky</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16526</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Probably due to increasing the runners:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.RuntimeException: java.lang.IllegalStateException: Expected file to exist for cycle: 1616021848, file: /home/jenkins/jenkins-slave/workspace/Cassandra-devbranch-test-compression/jdk/jdk_11_latest/label/cassandra/tmp/foo17bar/20210317-225728T.cq4.
minCycle: 1616021850, maxCycle: 1616021852
Available files: [20210317-225730T.cq4, 20210317-225732T.cq4]
	at org.apache.cassandra.utils.binlog.BinLogTest.readBinLogRecords(BinLogTest.java:492)
	at org.apache.cassandra.utils.binlog.BinLogTest.lambda$testTrucationReleasesLogSpace$8(BinLogTest.java:444)
	at org.apache.cassandra.Util.spinAssertEquals(Util.java:605)
	at org.apache.cassandra.Util.spinAssertEquals(Util.java:595)
	at org.apache.cassandra.utils.binlog.BinLogTest.testTrucationReleasesLogSpace(BinLogTest.java:444)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
Caused by: java.lang.IllegalStateException: Expected file to exist for cycle: 1616021848, file: /home/jenkins/jenkins-slave/workspace/Cassandra-devbranch-test-compression/jdk/jdk_11_latest/label/cassandra/tmp/foo17bar/20210317-225728T.cq4.
minCycle: 1616021850, maxCycle: 1616021852
Available files: [20210317-225730T.cq4, 20210317-225732T.cq4]
	at net.openhft.chronicle.queue.impl.single.SingleChronicleQueue$StoreSupplier.nextCycle(SingleChronicleQueue.java:1157)
	at net.openhft.chronicle.queue.impl.WireStorePool.nextCycle(WireStorePool.java:66)
	at net.openhft.chronicle.queue.impl.single.SingleChronicleQueue.nextCycle(SingleChronicleQueue.java:507)
	at net.openhft.chronicle.queue.impl.single.StoreTailer.nextIndexWithNextAvailableCycle(StoreTailer.java:507)
	at net.openhft.chronicle.queue.impl.single.StoreTailer.endOfCycle(StoreTailer.java:323)
	at net.openhft.chronicle.queue.impl.single.StoreTailer.next0(StoreTailer.java:295)
	at net.openhft.chronicle.queue.impl.single.StoreTailer.readingDocument(StoreTailer.java:202)
	at net.openhft.chronicle.queue.impl.single.StoreTailer.readDocument(StoreTailer.java:108)
	at org.apache.cassandra.utils.binlog.BinLogTest.readBinLogRecords(BinLogTest.java:481)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13366101">CASSANDRA-16526</key>
            <summary>BinLogTest is flaky</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brandon.williams">Brandon Williams</assignee>
                                    <reporter username="brandon.williams">Brandon Williams</reporter>
                        <labels>
                    </labels>
                <created>Thu, 18 Mar 2021 14:38:58 +0000</created>
                <updated>Sun, 25 Apr 2021 11:23:33 +0000</updated>
                            <resolved>Tue, 30 Mar 2021 00:00:55 +0000</resolved>
                                        <fixVersion>4.0-rc1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Test/unit</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17306486" author="brandon.williams" created="Mon, 22 Mar 2021 18:29:34 +0000"  >&lt;p&gt;Though CI only has the &lt;a href=&quot;https://ci-cassandra.apache.org/blue/organizations/jenkins/Cassandra-devbranch/detail/Cassandra-devbranch/497/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;one failure&lt;/a&gt; it doesn&apos;t really have enough history to see what&apos;s happened here.  Hoping I could bisect, I tried to find a good revision, but even the fix for the last time it was flaky in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15797&quot; title=&quot;Fix flaky BinLogTest - org.apache.cassandra.utils.binlog.BinLogTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15797&quot;&gt;&lt;del&gt;CASSANDRA-15797&lt;/del&gt;&lt;/a&gt; does not pass 100 iterations on either j11 or j8 on multiple machines with just a single test runner.  It doesn&apos;t seem like this could have been failing sporadically for this long and been lost in the noise each time, but I don&apos;t have any other explanation at this point.&lt;/p&gt;</comment>
                            <comment id="17308076" author="brandon.williams" created="Wed, 24 Mar 2021 18:02:50 +0000"  >&lt;p&gt;Checking nightlies, there is one other failure from November 9th of last year:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;      &amp;lt;testcase classname=&quot;org.apache.cassandra.utils.binlog.BinLogTest&quot; name=&quot;testTrucationReleasesLogSpace-cdc&quot; time=&quot;5.043&quot;&amp;gt;
          &amp;lt;failure message=&quot;missing currentCycle, file=/home/jenkins/jenkins-slave/workspace/Cassandra-trunk-test-cdc/jdk/jdk_1.8_latest/label/cassandra/tmp/foo17bar/20201109-222009.cq4&quot; type=&quot;junit.framework.A
ssertionFailedError&quot;&amp;gt;junit.framework.AssertionFailedError: missing currentCycle, file=/home/jenkins/jenkins-slave/workspace/Cassandra-trunk-test-cdc/jdk/jdk_1.8_latest/label/cassandra/tmp/foo17bar/20201109-2220
09.cq4
        at net.openhft.chronicle.queue.impl.single.SingleChronicleQueue$StoreSupplier.nextCycle(SingleChronicleQueue.java:931)
        at net.openhft.chronicle.queue.impl.WireStorePool.nextCycle(WireStorePool.java:106)
        at net.openhft.chronicle.queue.impl.single.SingleChronicleQueue.nextCycle(SingleChronicleQueue.java:412)
        at net.openhft.chronicle.queue.impl.single.SingleChronicleQueueExcerpts$StoreTailer.nextIndexWithNextAvailableCycle0(SingleChronicleQueueExcerpts.java:1509)
        at net.openhft.chronicle.queue.impl.single.SingleChronicleQueueExcerpts$StoreTailer.nextIndexWithNextAvailableCycle(SingleChronicleQueueExcerpts.java:1465)
        at net.openhft.chronicle.queue.impl.single.SingleChronicleQueueExcerpts$StoreTailer.endOfCycle(SingleChronicleQueueExcerpts.java:1255)
        at net.openhft.chronicle.queue.impl.single.SingleChronicleQueueExcerpts$StoreTailer.next0(SingleChronicleQueueExcerpts.java:1230)
        at net.openhft.chronicle.queue.impl.single.SingleChronicleQueueExcerpts$StoreTailer.readingDocument(SingleChronicleQueueExcerpts.java:1175)
        at net.openhft.chronicle.queue.impl.single.SingleChronicleQueueExcerpts$StoreTailer.readDocument(SingleChronicleQueueExcerpts.java:1096)
        at org.apache.cassandra.utils.binlog.BinLogTest.readBinLogRecords(BinLogTest.java:481)
        at org.apache.cassandra.utils.binlog.BinLogTest.lambda$testTrucationReleasesLogSpace$8(BinLogTest.java:444)
        at org.apache.cassandra.Util.spinAssertEquals(Util.java:599)
        at org.apache.cassandra.Util.spinAssertEquals(Util.java:589)
        at org.apache.cassandra.utils.binlog.BinLogTest.testTrucationReleasesLogSpace(BinLogTest.java:444)
&amp;lt;/failure&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17310994" author="brandon.williams" created="Mon, 29 Mar 2021 21:18:53 +0000"  >&lt;p&gt;What I&apos;ve determined is that any of these tests can run together in the suite with no problem, as long as testPut and/or testOffer are not mixed with the truncation test, and even then most of time nothing fails.&lt;/p&gt;

&lt;p&gt;But every once in a while, through no fault of their own, these tests seem to confuse Chronicle when it goes to read logs in testTrucationReleasesLogSpace, where it sometimes expects to see a file &lt;em&gt;that it deleted itself&lt;/em&gt;.  Since these work fine in isolation and the failure is quite rare, I&apos;ve taken the route of running it twice under the flakyTest handler so that a failure one time is tolerated.  The patch also modernizes the temporary directory creation and fixes the &apos;trucation&apos; typo in the test name.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/blue/organizations/jenkins/Cassandra-devbranch/detail/Cassandra-devbranch/530/pipeline&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/530/badge/icon&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17311021" author="yifanc" created="Mon, 29 Mar 2021 22:43:04 +0000"  >&lt;p&gt;The approach is sensible.&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;It is very hard to reproduce. I have loop&apos;d the test for over 100 times but still failed to reproduce.&lt;/p&gt;

&lt;p&gt;There is a shared &lt;tt&gt;QueueFileShrinkManager&lt;/tt&gt; in the chronicle queue internal. Whenever the file rolls to the next cycle, it schedules an async shrinking task that often runs after the test is finished. Maybe it has something to do with the failed test. (I have not looked deep into it.) It is probably worthy to make the shrink task synchronized to run it as part of the test. However, with the change proposed, I need to increase the sleep time in the &lt;tt&gt;testTrucationReleasesLogSpace&lt;/tt&gt; from 2 seconds to 4 seconds.&lt;/p&gt;</comment>
                            <comment id="17311040" author="brandon.williams" created="Tue, 30 Mar 2021 00:00:07 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12984" cascade-level=""><![CDATA[Degradation]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 33 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0oxrs:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ycai]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348835">NA</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/d421e82ee0ffd66d3f382bfbe0b69b7b275edce3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/d421e82ee0ffd66d3f382bfbe0b69b7b275edce3&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;run the test a lot&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>