<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:21:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2419] Risk of counter over-count when recovering commit log</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2419</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When a memtable was flush, there is a small delay before the commit log replay position gets updated. If the node fails during this delay, all the updates of this memtable will be replay during commit log recovery and will end-up being over-counts.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12503450">CASSANDRA-2419</key>
            <summary>Risk of counter over-count when recovering commit log</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                            <label>counters</label>
                    </labels>
                <created>Tue, 5 Apr 2011 20:49:22 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:02 +0000</updated>
                            <resolved>Sun, 8 May 2011 01:42:50 +0000</resolved>
                                        <fixVersion>0.8.0</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="28800">8h</timeoriginalestimate>
                            <timeestimate seconds="28800">8h</timeestimate>
                                        <comments>
                            <comment id="13016118" author="slebresne" created="Tue, 5 Apr 2011 21:02:55 +0000"  >&lt;p&gt;One solution I see to this problem would be to record along with the replay position the time when we last updated this replay position. The during recover, we would first look at all the sstables (for the CF) and if a sstable is freshly flushed (which implies that we have a marker to know that a sstable was never compacted) and have a modification time higher that the last time we updated the replay position, then we&apos;ll just remove the sstable since we know it will be fully replayed.&lt;/p&gt;

&lt;p&gt;Note that to work correctly we also need a way to mark a freshly flushed sstable as &apos;non compactable&apos; during the time it takes to mark the commit log.&lt;/p&gt;

&lt;p&gt;We would probably only do this for counter CF just to be on the safe side.&lt;/p&gt;

&lt;p&gt;Opinions ?&lt;/p&gt;</comment>
                            <comment id="13016130" author="jbellis" created="Tue, 5 Apr 2011 21:25:59 +0000"  >&lt;p&gt;What if instead of the CL &quot;header&quot; we record the CL context as part of an sstable footer?  (footer is less likely to cause bugs w/ sstable math that assumes 0 = start of first row.)  then there is no race.&lt;/p&gt;</comment>
                            <comment id="13016133" author="jbellis" created="Tue, 5 Apr 2011 21:34:41 +0000"  >&lt;p&gt;Hmm, I think we need both the CL header and this information, since this flush footer would only give us when we flushed which is not the same as &quot;do I need to replay.&quot;&lt;/p&gt;

&lt;p&gt;For instance: if there is no flush marker for a commitlog segment in any existing sstable, that does not necessarily mean no data is in the commitlog for that CF.&lt;/p&gt;

&lt;p&gt;So replay position would be max(dirty at from CL header, flushed at from sstable footers).&lt;/p&gt;

&lt;p&gt;(You would need to allow multiple flush contexts in a single sstable footer, to preserve them during compaction.)&lt;/p&gt;</comment>
                            <comment id="13016134" author="slebresne" created="Tue, 5 Apr 2011 21:39:28 +0000"  >&lt;p&gt;What about a new component .metadata for each sstable instead of a footer. I actually think we will have a use for other sstable metadata at some point anyway. For instance we could keep the file format version. That way we wouldn&apos;t rely so much on the data file name.&lt;/p&gt;</comment>
                            <comment id="13016137" author="jbellis" created="Tue, 5 Apr 2011 21:44:50 +0000"  >&lt;p&gt;A separate component is a better idea.&lt;/p&gt;</comment>
                            <comment id="13016142" author="slebresne" created="Tue, 5 Apr 2011 21:52:53 +0000"  >&lt;p&gt;Actually I don&apos;t think this really solves the race condition. We really shouldn&apos;t compact the newly flushed sstable until we marked the commit log, because if we compact it, even if we&apos;re able to detect that &apos;some parts&apos; of a sstable will be replay during recover, there is nothing we can do about it.&lt;/p&gt;</comment>
                            <comment id="13016147" author="jbellis" created="Tue, 5 Apr 2011 22:01:02 +0000"  >&lt;p&gt;I don&apos;t understand the problem.  Say we have this situation:&lt;/p&gt;

&lt;p&gt;CommitLog-1302036825548.log: &lt;span class=&quot;error&quot;&gt;&amp;#91;full of writes to CF Foo counters, up to position 100.  header reads dirty-at 50, our last flush position&amp;#93;&lt;/span&gt;&lt;br/&gt;
Foo-g-45-Metadata.db: &lt;span class=&quot;error&quot;&gt;&amp;#91;flushed at position (1302036825548, 50)&amp;#93;&lt;/span&gt;&lt;br/&gt;
Foo-g-46-Metadata.db: &lt;span class=&quot;error&quot;&gt;&amp;#91;flushed at position (1302036825548, 100)&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;We compact and get&lt;br/&gt;
Foo-g-47-Metadata.db: &lt;span class=&quot;error&quot;&gt;&amp;#91;flushed at position (1302036825548, 100)&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;If we die and restart here we will correctly start reply of Foo at position 100 in this segment.&lt;/p&gt;

&lt;p&gt;(we can combine to a single flushed-at entry in this case since they were from the same CL segment.  if they were from different segments we would keep both.)&lt;/p&gt;</comment>
                            <comment id="13016152" author="slebresne" created="Tue, 5 Apr 2011 22:10:46 +0000"  >&lt;p&gt;Right, that was just me not getting you idea at first. Make sense, sorry.&lt;/p&gt;</comment>
                            <comment id="13016631" author="slebresne" created="Thu, 7 Apr 2011 00:38:40 +0000"  >&lt;p&gt;Attaching patch implementing Jonathan&apos;s idea to record the CL replay position along with the sstable.&lt;/p&gt;</comment>
                            <comment id="13016633" author="slebresne" created="Thu, 7 Apr 2011 00:40:59 +0000"  >&lt;p&gt;I&apos;m wondering, couldn&apos;t we just drop the commit log header if we do that.&lt;/p&gt;</comment>
                            <comment id="13016649" author="jbellis" created="Thu, 7 Apr 2011 01:56:56 +0000"  >&lt;p&gt;Yes, I think we can.&lt;/p&gt;</comment>
                            <comment id="13020048" author="jbellis" created="Thu, 14 Apr 2011 21:39:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m wondering, couldn&apos;t we just drop the commit log header if we do that.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Were you planning to update w/ that change?&lt;/p&gt;</comment>
                            <comment id="13026980" author="slebresne" created="Fri, 29 Apr 2011 13:57:21 +0000"  >&lt;p&gt;v2 removes commit log header completely in favor of sstable metadata about where to replay (patch against 0.8).&lt;/p&gt;

&lt;p&gt;This differs from v1 in that instead of keeping every (segment, replay_position) pair, we keep for a given sstable, only the position for the most recent segment (that is, we leverage the fact that we use increasing timestamps for commit logs).&lt;/p&gt;

&lt;p&gt;The reason for this is twofold:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;this more compact (and simple)&lt;/li&gt;
	&lt;li&gt;if we remove the commit log header, we need to be able to say if a given segment is dirty or not for a given column family. That is, we don&apos;t want to know if some replay position existed on this segment, but if a relevant one still exist. So for a given column family we really only care about the newest (segment, replay_position) pair.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Now there is the question of the update path. With this patch, the (existing) commit log headers will be ignored. This means that ideally before updating to a version having this patch people would use drain. If they do not, then the commit logs will be fully replayed. Pre-0.8, it&apos;s not a big deal. With counters, this could mean over-counts (that&apos;s exactly what this ticket is about). So I would be in favor of putting this for 0.8.0, since it is a bug fix and it will avoids the problem of upgrading from a version already having counters. But I would admit this is not trivial patch, so ...&lt;/p&gt;</comment>
                            <comment id="13027797" author="jbellis" created="Mon, 2 May 2011 19:53:12 +0000"  >&lt;p&gt;v3 attached with some changes:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;SSTableMetadata removed; replayposition becomes a field in SSTable that is serialized w/ statistics&lt;/li&gt;
	&lt;li&gt;RP is final and part of the SSTable constructor&lt;/li&gt;
	&lt;li&gt;RP implements Comparable instead of a one-off resolve API; RP.getReplayPosition encapsulates the find-replay-point logic&lt;/li&gt;
	&lt;li&gt;RP moved to a top-level class and replaces CLContext&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;d like to make the metadata a json blob so we can extend it more easily, so I probably need to re-introduce SSTM. Consider v3 a work in progress.&lt;/p&gt;</comment>
                            <comment id="13027987" author="jbellis" created="Tue, 3 May 2011 01:57:40 +0000"  >&lt;p&gt;I tried two ways of storing metadata as yaml &amp;#8211; first with the metadata as java beans that were stored directly as yaml, and second half-manually serializing to a yaml Map&amp;lt;String, Object&amp;gt; &amp;#8211; and both feel clunkier than just using the version field to deal with adding things. (Especially when you need to do version checks anyway when modifying things rather than just adding new fields.)&lt;/p&gt;

&lt;p&gt;So, v4 is substantially the same as v3 but Descriptor version is bumped to g and we use that instead of EOF to when reading RP. (Also, writeStatistics is renamed to writeMetadata.)&lt;/p&gt;</comment>
                            <comment id="13028185" author="slebresne" created="Tue, 3 May 2011 12:32:19 +0000"  >&lt;p&gt;v4 looks good, I like those changes (note: I committed r1099037 to fix CFSTest, it had a test with hardcoded sstable filenames using version &apos;f&apos; and thus was failing)&lt;/p&gt;</comment>
                            <comment id="13028260" author="jbellis" created="Tue, 3 May 2011 15:00:41 +0000"  >&lt;p&gt;v5 updates CL replay to use RP.getReplayPosition as well&lt;/p&gt;</comment>
                            <comment id="13028267" author="jbellis" created="Tue, 3 May 2011 15:37:34 +0000"  >&lt;p&gt;v6 fixes a test failure in v5&lt;/p&gt;</comment>
                            <comment id="13028315" author="slebresne" created="Tue, 3 May 2011 17:05:17 +0000"  >&lt;p&gt;Minor nitpick: in CommitLog.java:recover(), was there a reason to create a new List&amp;lt;ReplayPosition&amp;gt; positions instead of using cfPositions.values() ?&lt;/p&gt;

&lt;p&gt;but other than that, +1 on v6.&lt;/p&gt;</comment>
                            <comment id="13028334" author="jbellis" created="Tue, 3 May 2011 17:35:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;in CommitLog.java:recover(), was there a reason to create a new List&amp;lt;ReplayPosition&amp;gt; positions instead of using cfPositions.values()&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Nope. I&apos;ll fix that before commit.&lt;/p&gt;

&lt;p&gt;Asked Paul Cannon to also review first though, since obviously we want to be extra sure not to cause regressions here.&lt;/p&gt;</comment>
                            <comment id="13030441" author="jbellis" created="Sun, 8 May 2011 01:42:50 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="13030862" author="stuhood" created="Mon, 9 May 2011 19:12:32 +0000"  >&lt;p&gt;Thanks a ton for this work! Transactionality here we come.&lt;/p&gt;</comment>
                            <comment id="13031427" author="hudson" created="Tue, 10 May 2011 22:30:29 +0000"  >&lt;p&gt;Integrated in Cassandra-0.8 #93 (See &lt;a href=&quot;https://builds.apache.org/hudson/job/Cassandra-0.8/93/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/hudson/job/Cassandra-0.8/93/&lt;/a&gt;)&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12477754" name="0001-Record-CL-replay-infos-alongside-sstables-v2.patch" size="64732" author="slebresne" created="Fri, 29 Apr 2011 13:57:21 +0000"/>
                            <attachment id="12475649" name="0001-Record-and-use-sstable-replay-position.patch" size="33039" author="slebresne" created="Thu, 7 Apr 2011 00:38:40 +0000"/>
                            <attachment id="12477981" name="2419-v3.txt" size="62358" author="jbellis" created="Mon, 2 May 2011 19:53:11 +0000"/>
                            <attachment id="12478017" name="2419-v4.txt" size="63056" author="jbellis" created="Tue, 3 May 2011 01:57:40 +0000"/>
                            <attachment id="12478061" name="2419-v6.txt" size="63460" author="jbellis" created="Tue, 3 May 2011 15:37:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20613</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 28 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gb9j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93255</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>