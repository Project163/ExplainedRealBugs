<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:17:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15158] Wait for schema agreement rather than in flight schema requests when bootstrapping</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15158</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Currently when a node is bootstrapping we use a set of latches (org.apache.cassandra.service.MigrationTask#inflightTasks) to keep track of in-flight schema pull requests, and we don&apos;t proceed with bootstrapping/stream until all the latches are released (or we timeout waiting for each one). One issue with this is that if we have a large schema, or the retrieval of the schema from the other nodes was unexpectedly slow then we have no explicit check in place to ensure we have actually received a schema before we proceed.&lt;/p&gt;

&lt;p&gt;While it&apos;s possible to increase &quot;migration_task_wait_in_seconds&quot; to force the node to wait on each latche longer, there are cases where this doesn&apos;t help because the callbacks for the schema pull requests have expired off the messaging service&apos;s callback map (org.apache.cassandra.net.MessagingService#callbacks) after request_timeout_in_ms (default 10 seconds) before the other nodes were able to respond to the new node.&lt;/p&gt;

&lt;p&gt;This patch checks for schema agreement between the bootstrapping node and the rest of the live nodes before proceeding with bootstrapping. It also adds a check to prevent the new node from flooding existing nodes with simultaneous schema pull requests as can happen in large clusters.&lt;/p&gt;

&lt;p&gt;Removing the latch system should also prevent new nodes in large clusters getting stuck for extended amounts of time as they wait `migration_task_wait_in_seconds` on each of the latches left orphaned by the timed out callbacks.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.11&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...vincewhite:check_for_schema&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PoC&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra-dtest/compare/master...vincewhite:wait_for_schema_agreement&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13239212">CASSANDRA-15158</key>
            <summary>Wait for schema agreement rather than in flight schema requests when bootstrapping</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bdeggleston">Blake Eggleston</assignee>
                                    <reporter username="VincentWhite">Vincent White</reporter>
                        <labels>
                    </labels>
                <created>Thu, 13 Jun 2019 09:18:30 +0000</created>
                <updated>Fri, 21 Oct 2022 14:03:08 +0000</updated>
                            <resolved>Mon, 9 Nov 2020 20:26:43 +0000</resolved>
                                        <fixVersion>3.0.24</fixVersion>
                    <fixVersion>3.11.10</fixVersion>
                    <fixVersion>4.0-beta4</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Cluster/Gossip</component>
                    <component>Cluster/Schema</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>16</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17090918" author="bdeggleston" created="Thu, 23 Apr 2020 20:27:04 +0000"  >&lt;p&gt;So just skimming this, it looks like it&apos;s the right approach. We should add some tests though, think through what we want to do if we can&apos;t get the schema to converge, as well as leave an &quot;escape hatch&quot; if we need to start up and are willing to skip waiting on schema agreement.&lt;/p&gt;</comment>
                            <comment id="17090923" author="bdeggleston" created="Thu, 23 Apr 2020 20:30:13 +0000"  >&lt;p&gt;I also wanted to point out that the underlying issues causing this problem can lead to correctness issues or data loss in some scenarios. Since we don&apos;t currently confirm that any of the in flight migration tasks have been completed and applied,&#160;it&apos;s possible for us to not receive &lt;em&gt;any&lt;/em&gt; schema responses, and begin bootstrapping without a schema. In this case, bootstrap would complete immediately, because the node believes there is nothing to stream. When the node later receives the schema, it will begin serving reads and writes with no data.&#160;&lt;/p&gt;</comment>
                            <comment id="17095596" author="stefan.miklosovic" created="Wed, 29 Apr 2020 16:29:41 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;please review this one&#160;&lt;a href=&quot;https://github.com/smiklosovic/cassandra/tree/CASSANDRA-15158&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/smiklosovic/cassandra/tree/CASSANDRA-15158&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Sorry for the fuss but this seems to be more problematic than I was thinking initially.&#160;&lt;/p&gt;

&lt;p&gt;I do not think that we have to &lt;em&gt;check&lt;/em&gt; that respective migration request is successful or not, we should just check it all schemas match ...&lt;/p&gt;

&lt;p&gt;The logic is based on repeated checking if schemas agree or not and only in case all schemas are equal we proceed, otherwise an exception is thrown (this might be reworked in such sense that we just log this). There is a global timeout for this check, it will be obvious from reading the code.&lt;/p&gt;

&lt;p&gt;There is a test added too, because of the nature of the test, I had to &quot;inject&quot; these callbacks into respective methods so I could modify their default behaviour and test their state.&#160;&lt;/p&gt;

&lt;p&gt;This is against 3.11, we need to backport this to 3.0 for our customer.&lt;/p&gt;</comment>
                            <comment id="17095605" author="bdeggleston" created="Wed, 29 Apr 2020 16:38:46 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefan.miklosovic&quot; class=&quot;user-hover&quot; rel=&quot;stefan.miklosovic&quot;&gt;stefan.miklosovic&lt;/a&gt;, I&apos;m &lt;em&gt;should&lt;/em&gt; have some time to review next week.&lt;/p&gt;</comment>
                            <comment id="17098952" author="stefan.miklosovic" created="Mon, 4 May 2020 13:54:02 +0000"  >&lt;p&gt;code for 3.0&#160;&lt;a href=&quot;https://github.com/smiklosovic/cassandra/tree/CASSANDRA-15158-cassandra-3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/smiklosovic/cassandra/tree/CASSANDRA-15158-cassandra-3&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17101407" author="stefan.miklosovic" created="Thu, 7 May 2020 06:28:05 +0000"  >&lt;p&gt;for 3.11&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/smiklosovic/cassandra/tree/CASSANDRA-15158&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/smiklosovic/cassandra/tree/CASSANDRA-15158&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;for 3.0&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/smiklosovic/cassandra/tree/CASSANDRA-15158-cassandra-3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/smiklosovic/cassandra/tree/CASSANDRA-15158-cassandra-3&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17102037" author="bdeggleston" created="Thu, 7 May 2020 21:17:31 +0000"  >&lt;p&gt;It&apos;s likely we&apos;ll want to fix this in 3.0 and up, so I&apos;ll review the 3.0 version to start with and we can go from there.&lt;/p&gt;

&lt;p&gt;I haven&apos;t completed my review yet, but there are some structural and design issues we should address up front.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Structural issues&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;First, the &lt;tt&gt;waitForSchema*&lt;/tt&gt; methods should live in the MigrationManager. This will prevent you from setting an updated status if you&apos;re sending out additional schema pulls, but we can revisit that later if we think it&apos;s neccesary.&lt;/p&gt;

&lt;p&gt;Second, instantiating MigrationTaskCallbacks in StorageService/MigrationManager and passing it into MigrationTask is a little awkward. I&apos;d prefer if the callback remained an anonymous class. We can communicate endpoint to send schema pulls to with an inetaddress argument, and we need to rethink what `isRunningForcibly` is doing and why. First, we shouldn&apos;t be adding it to &lt;tt&gt;IAsyncCallback&lt;/tt&gt; for this narrow use case. Next, it&apos;s use seems to be changing how schema pulls actually work, but only in a test environment, which is something we should avoid.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Design issues&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;This doesn&apos;t deal with multiple schema versions. If a node joins, and there are 2 or more schema versions floating around, it will only wait until it has &lt;em&gt;some&lt;/em&gt; schema to begin bootstrapping, not all. Related to this, we also need a plan for unreachable schema versions. For instance, if a single node is reporting a schema version that no one else has, but the node is unreachable, what do we do?&lt;/p&gt;

&lt;p&gt;Next, I like how this limits the number of messages sent to a given endpoint, but we should also limit the number of messages we send out for a given schema version. If we have a large cluster, and all nodes are reporting the same version, we don&apos;t need to ask every node for it&apos;s schema.&lt;/p&gt;</comment>
                            <comment id="17102374" author="stefan.miklosovic" created="Fri, 8 May 2020 08:32:47 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;commenting on design issues, I am not completely sure if these issues you are talking about are related to this patch or they are already existing? We could indeed focus on the points you raised but it seems to me that the current (comitted) code is worse without this patch than with as I guess these problems are already there?&lt;/p&gt;

&lt;p&gt;Isn&apos;t the goal here to have all nodes on same versions? Isn&apos;t the very fact that there are multiple versions pretty strange to begin with so we should not even try to join a node if they mismatch hence there is nothing to deal with in the first place?&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;It will only wait until it has&#160;&lt;em&gt;some&lt;/em&gt;&#160;schema to begin bootstrapping, not all&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This is the most likely not true unless I am not getting something. The node to be bootstrapped will never advance in doing so unless all nodes have same versions.&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&#160;For instance, if a single node is reporting a schema version that no one else has, but the node is unreachable, what do we do?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;We should fail whole bootstrapping and one should go and fix it.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;For instance, if a single node is reporting a schema version that no one else has, but the node is unreachable, what do we do?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;How can a node report its schema while being unreachable?&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Next, I like how this limits the number of messages sent to a given endpoint, but we should also limit the number of messages we send out for a given schema version. If we have a large cluster, and all nodes are reporting the same version, we don&apos;t need to ask every node for it&apos;s schema.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Got you, this might be tracked.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;When it comes to testing, I admit that adding isRunningForcibly method feels like a hack but I had very hard time to test this stuff out. It was basically the only reasonable way possible at the time I was coding it, if you know of more better version, please tell me otherwise I am not sure what might be better here and we could stick with this for a time being? The whole testing methodology was based on these callbacks and checking their inner state which results into having a methods which are accepting them so we can elaborate on their state. Without &quot;injecting&quot; them from outside, I would not be able to do that.&lt;/p&gt;</comment>
                            <comment id="17102543" author="stefan.miklosovic" created="Fri, 8 May 2020 12:48:19 +0000"  >&lt;p&gt;It seems to me that one aspect of the PR was overlooked so I just iterate on that one. The mechanim how to not flood nodes with schema pull messages is incorporated in the loop over callbacks. If you notice it, there are sleeps of various lenghts based on a request being already sent or not. This sleep will actually &quot;delay&quot; the next schema pull from the other node because during this time of a sleep, some schema could come from the node we just sent a message to so on the next iteration when another node is compared on schema equality, it may happen that there is not any need to pull it anymore because they are on par. Hence we are not blindly sending messages to all nodes.&lt;br/&gt;
 If there are some discrepancies, there is the global timeout set after which whole bootstrapping process will be evaluated as errorneous and (in the current code) we throw a ConfigurationException. This behaviour might be relaxed but I consider it more appropriate to just throw it there.&lt;/p&gt;</comment>
                            <comment id="17102741" author="bdeggleston" created="Fri, 8 May 2020 17:03:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;commenting on design issues, I am not completely sure if these issues you are talking about are related to this patch or they are already existing? We could indeed focus on the points you raised but it seems to me that the current (comitted) code is worse without this patch than with as I guess these problems are already there?&lt;br/&gt;
Isn&apos;t the goal here to have all nodes on same versions? Isn&apos;t the very fact that there are multiple versions pretty strange to begin with so we should not even try to join a node if they mismatch hence there is nothing to deal with in the first place?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;When there are schema changes, it&apos;s not strange at all for there to be multiple schema versions in the cluster before they converge. We also don&apos;t forbid making schema changes while changing cluster topology, so this would be something we should expect to encounter, although I would expect it to happen infrequently. Since bootstrap doesn&apos;t stream keyspaces it doesn&apos;t know about, this could create a window of data loss. Since the goal of this ticket is to wait for schema to converge before starting bootstrap, we should deal with edge cases like this. Also, I believe there have been bugs that caused a lot of schema change activity when nodes bootstrap, so depending on what exactly you&apos;re doing&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;How can a node report its schema while being unreachable?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Schema versions are gossiped. So a node might gossip a new schema version then become unreachable. The bootstrapping node would learn about this new version via gossip, but be unable to contact it.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; admit that adding isRunningForcibly method feels like a hack but I had very hard time to test this stuff out.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I&apos;ll look into how testing can be improved.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;gt; This is the most likely not true unless I am not getting something. The node to be bootstrapped will never advance in doing so unless all nodes have same versions.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Ah, yes you&apos;re right. Althought waiting for all nodes to arrive at the same schema version isn&apos;t neccesary, we just need to receive and merge at least one schema pull from every schema version in the cluster.&lt;/p&gt;</comment>
                            <comment id="17133717" author="stefan.miklosovic" created="Thu, 11 Jun 2020 21:44:34 +0000"  >&lt;p&gt;Hi Blake,&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;because of your very helpful explanation I was able to put together yet another version of the solution to this problem. You will find it here&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/628&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/628&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks for the review in advance&lt;/p&gt;</comment>
                            <comment id="17163023" author="bdeggleston" created="Wed, 22 Jul 2020 19:07:33 +0000"  >&lt;p&gt;I&apos;ve reworked this a bit more &lt;a href=&quot;https://github.com/bdeggleston/cassandra/tree/15158-coordinator&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. It&apos;s now pretty self contained, has some fairly granular unit tests, and fixes a few functional things. Can you take a look &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefan.miklosovic&quot; class=&quot;user-hover&quot; rel=&quot;stefan.miklosovic&quot;&gt;stefan.miklosovic&lt;/a&gt; and let me know what you think? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aleksey&quot; class=&quot;user-hover&quot; rel=&quot;aleksey&quot;&gt;aleksey&lt;/a&gt;, can you also take a look / review? The basic idea is that we now track which schema versions exist in gossip, and which endpoints are reporting them, then block bootstrap until we&apos;ve received a schema for each version. It also tracks how many outstanding migration requests we have per version so we don&apos;t send out thousands.&lt;/p&gt;

&lt;p&gt;Also, what are your opinions of this going into 3.x? I think I&apos;d lean towards putting it in, since it eliminates a scenario where data loss could occur and will shave a few hours off of adding/replacing nodes in large clusters. On the other hand, since it reduces the amount of migration requests sent out on bootstrap, any bugs determining if we&apos;ve received sufficient schema data could make data loss &lt;em&gt;more&lt;/em&gt; likely.&lt;/p&gt;</comment>
                            <comment id="17165619" author="stefan.miklosovic" created="Mon, 27 Jul 2020 11:00:43 +0000"  >&lt;p&gt;In general looks good to me in spite of getting lost a bit on the actual schema migration response:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Future&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt; response(Collection&amp;lt;Mutation&amp;gt; mutations)
{
    &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; (info)
    {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (shouldApplySchemaFrom(endpoint, info))
            mergeSchemaFrom(endpoint, mutations);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; pullComplete(endpoint, info, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);  &lt;span class=&quot;code-comment&quot;&gt;/// why?
&lt;/span&gt;    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I am not completely sure why are we pulling again here. I would rewrite the whole solution in a such way that this Callable just does one thing on a successful response (merging of a schema) and the actual &quot;retry&quot; would be handled from outside. The reader has to make quite a mental exercise to visualise that this callback might actually call another callback in it until some &quot;version&quot; is completed etc ... At least for me, it was quite tedious to track.&lt;/p&gt;

&lt;p&gt;I understand the motivation behind that but callback should just do one task and thats it, it shouldnt be responsible for potentially scheduling another callback recursively until some conditions on some signals or what have you are met ... just my 2 cents.&lt;/p&gt;

&lt;p&gt;There is also this:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; Future&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Void&lt;/span&gt;&amp;gt; reportEndpointVersion(InetAddress endpoint, UUID version)
{
    UUID current = endpointVersions.get(endpoint);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (current != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; current.equals(version))
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; FINISHED_FUTURE;

    VersionInfo info = versionInfo.computeIfAbsent(version, VersionInfo::&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isLocalVersion(version))
        info.markReceived();
    info.endpoints.add(endpoint);
    info.requestQueue.add(endpoint);
    endpointVersions.put(endpoint, version);

    removeEndpointFromVersion(endpoint, current); &lt;span class=&quot;code-comment&quot;&gt;///// why?
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; maybePullSchema(info);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;TBH that is quite counterintuitive too, maybe renaming of that method would help.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The test has failed for me (repeatedly):&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.AssertionError:&#160;java.lang.AssertionError:&#160;
Expected :2
Actual&#160; &#160;:0
&amp;lt;Click to see difference&amp;gt; at org.junit.Assert.fail(Assert.java:92) at org.junit.Assert.failNotEquals(Assert.java:689) at org.junit.Assert.assertEquals(Assert.java:127) at org.junit.Assert.assertEquals(Assert.java:514) at org.junit.Assert.assertEquals(Assert.java:498) at org.apache.cassandra.service.MigrationCoordinatorTest.testWeKeepSendingRequests(MigrationCoordinatorTest.java:278) at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) at java.lang.reflect.Method.invoke(Method.java:498) at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:44) at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:15) at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:41) at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:20) at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:28) at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:31) at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:70) at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:44) at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:180) at org.junit.runners.ParentRunner.access$000(ParentRunner.java:41) at org.junit.runners.ParentRunner$1.evaluate(ParentRunner.java:173) at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:28) at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:31) at org.junit.runners.ParentRunner.run(ParentRunner.java:220) at org.junit.runner.JUnitCore.run(JUnitCore.java:159) at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:68) at com.intellij.rt.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:33) at com.intellij.rt.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:230) at com.intellij.rt.junit.JUnitStarter.main(JUnitStarter.java:58)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17169101" author="stefan.miklosovic" created="Fri, 31 Jul 2020 19:28:58 +0000"  >&lt;p&gt;hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt;, have you had a chance to reflect the above issues?&lt;/p&gt;</comment>
                            <comment id="17171139" author="bdeggleston" created="Tue, 4 Aug 2020 21:29:31 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I am not completely sure why are we pulling again here. I would rewrite the whole solution in a such way that this Callable just does one thing on a successful response (merging of a schema) and the actual &quot;retry&quot; would be handled from outside. The reader has to make quite a mental exercise to visualise that this callback might actually call another callback in it until some &quot;version&quot; is completed etc ... At least for me, it was quite tedious to track.&lt;/p&gt;

&lt;/blockquote&gt;
&lt;p&gt;In the case of a successful pull, we won&apos;t pull again. Response and fail both call pullComplete, but an additional pull is only called if it&apos;s called from fail.&lt;/p&gt;

&lt;p&gt;I get that this can be a bit difficult to follow, but I&apos;m not sure there&apos;s a better approach, given the schema pulls are completely event driven during normal runtime. If we miss a schema change during normal runtime (not bootstrap), there&apos;s nothing waiting on schema convergence that would enable us to retry from the outside.&lt;/p&gt;

&lt;p&gt;There is a periodic task that pulls schema for outstanding versions that don&apos;t have any in flight requests^&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;^, but it only runs once a minute, and we need to be more proactive about learning about schema updates since we&apos;ll be unable to serve some reads and writes until we&apos;re up to date.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;TBH that is quite counterintuitive too&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Could you expand on what&apos;s counterintuitive about it? If the endpoint&apos;s schema version has changed, we need to disassociate it with it&apos;s previously reported version. I have added a comment saying as much.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;The test has failed for me (repeatedly):&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Thanks, it should be passing now.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; This handles the case where all nodes reporting a given version are on a different version so we can&apos;t pull schema from them, and acts as a hedge against any bugs in this implementation that might cause us to not schedule schema pulls as intended&lt;/p&gt;</comment>
                            <comment id="17172281" author="stefan.miklosovic" created="Thu, 6 Aug 2020 11:32:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt; Thanks for the explanation. Maybe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aleksey&quot; class=&quot;user-hover&quot; rel=&quot;aleksey&quot;&gt;aleksey&lt;/a&gt;&#160;might take a look before moving this forward?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17188581" author="iamaleksey" created="Tue, 1 Sep 2020 15:48:53 +0000"  >&lt;p&gt;Pushed some minor tweaks &lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/15158-review&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. Made some bits more idiomatic, and changed the way in-flight requests are being kept track of.&lt;/p&gt;

&lt;p&gt;In general, this does the job and solves the problem in the description. It doesn&apos;t, however, fully deal with storms in large clusters caused by a sequence of updates in quick succession, but, it&apos;s not intended to, either.&lt;/p&gt;

&lt;p&gt;EDIT: the amount of synchronisation here bothers me a tiny bit, as all of it will likely have to be eventually gotten rid of, when and if TPC happens, but I can live with it.&lt;/p&gt;</comment>
                            <comment id="17189362" author="bdeggleston" created="Wed, 2 Sep 2020 16:32:17 +0000"  >&lt;p&gt;Thanks Aleksey.&lt;/p&gt;

&lt;p&gt;Removing requestQueue is going to cause some problems, We need to have some way of cycling requests through the entire set of endpoints reporting a given version. Without one, if the first few endpoints to come out of the iterator are down, we&apos;ll get stuck in a loop as we schedule pulls which will immediately fail causing new pulls to be scheduled for the same node.&lt;/p&gt;

&lt;p&gt;I&apos;ve updated my branch with your changes and added the request queue back. Since the storage service doesn&apos;t really need to fire off migration requests, I also added a commit making the MigrationCoordinator an endpoint change subscriber. So StorageService is responsible for a little less.&lt;/p&gt;</comment>
                            <comment id="17189611" author="iamaleksey" created="Wed, 2 Sep 2020 18:09:55 +0000"  >&lt;p&gt;Oh, I brainfarted that node liveness check was a part of &lt;tt&gt;shouldPullFromEndpoint()&lt;/tt&gt;. Could just extend that condition then to add the liveness check in addition to &lt;tt&gt;shouldPullFromEndpoint()&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="17189642" author="bdeggleston" created="Wed, 2 Sep 2020 19:16:30 +0000"  >&lt;p&gt;Possibly, you still need to check in the submission task in case the node has died in the meantime. There would still be an intersection of node flapping rate and unfortunate scheduling where the lockup could occur though.&lt;/p&gt;

&lt;p&gt;The queue, while a little awkward, also makes us a bit more resilient against other unanticipated states and/or bugs.&lt;/p&gt;</comment>
                            <comment id="17191705" author="stefan.miklosovic" created="Mon, 7 Sep 2020 13:16:30 +0000"  >&lt;p&gt;I am getting this exception on totally clean node, I am bootstrapping a cluster of 3 nodes:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
cassandra_node_1    | INFO  [ScheduledTasks:1] 2020-09-07 15:10:13,037 TokenMetadata.java:517 - Updating topology &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; all endpoints that have changed
cassandra_node_1    | INFO  [HANDSHAKE-spark-master-1/172.19.0.5] 2020-09-07 15:10:13,311 OutboundTcpConnection.java:561 - Handshaking version with spark-master-1/172.19.0.5
cassandra_node_1    | INFO  [GossipStage:1] 2020-09-07 15:10:13,870 Gossiper.java:1141 - Node /172.19.0.5 is now part of the cluster
cassandra_node_1    | INFO  [GossipStage:1] 2020-09-07 15:10:13,904 TokenMetadata.java:497 - Updating topology &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.19.0.5
cassandra_node_1    | INFO  [GossipStage:1] 2020-09-07 15:10:13,907 TokenMetadata.java:497 - Updating topology &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /172.19.0.5
cassandra_node_1    | INFO  [GossipStage:1] 2020-09-07 15:10:14,052 Gossiper.java:1103 - InetAddress /172.19.0.5 is now UP
cassandra_node_1    | WARN  [MessagingService-Incoming-/172.19.0.5] 2020-09-07 15:10:14,119 IncomingTcpConnection.java:103 - UnknownColumnFamilyException reading from socket; closing
cassandra_node_1    | org.apache.cassandra.db.UnknownColumnFamilyException: Couldn&apos;t find table &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; cfId 5bc52802-de25-35ed-aeab-188eecebb090. If a table was just created, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is likely due to the schema not being fully propagated.  Please wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; schema agreement on table creation.
cassandra_node_1    | 	at org.apache.cassandra.config.CFMetaData$Serializer.deserialize(CFMetaData.java:1578) ~[apache-cassandra-3.11.9-SNAPSHOT.jar:3.11.9-SNAPSHOT]
cassandra_node_1    | 	at org.apache.cassandra.db.partitions.PartitionUpdate$PartitionUpdateSerializer.deserialize30(PartitionUpdate.java:899) ~[apache-cassandra-3.11.9-SNAPSHOT.jar:3.11.9-SNAPSHOT]
cassandra_node_1    | 	at org.apache.cassandra.db.partitions.PartitionUpdate$PartitionUpdateSerializer.deserialize(PartitionUpdate.java:874) ~[apache-cassandra-3.11.9-SNAPSHOT.jar:3.11.9-SNAPSHOT]
cassandra_node_1    | 	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:415) ~[apache-cassandra-3.11.9-SNAPSHOT.jar:3.11.9-SNAPSHOT]
cassandra_node_1    | 	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:434) ~[apache-cassandra-3.11.9-SNAPSHOT.jar:3.11.9-SNAPSHOT]
cassandra_node_1    | 	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:371) ~[apache-cassandra-3.11.9-SNAPSHOT.jar:3.11.9-SNAPSHOT]
cassandra_node_1    | 	at org.apache.cassandra.net.MessageIn.read(MessageIn.java:123) ~[apache-cassandra-3.11.9-SNAPSHOT.jar:3.11.9-SNAPSHOT]
cassandra_node_1    | 	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessage(IncomingTcpConnection.java:195) ~[apache-cassandra-3.11.9-SNAPSHOT.jar:3.11.9-SNAPSHOT]
cassandra_node_1    | 	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessages(IncomingTcpConnection.java:183) ~[apache-cassandra-3.11.9-SNAPSHOT.jar:3.11.9-SNAPSHOT]

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That cfId stands for system_auth/roles. It seems like we are applying changes before schema agreement has occured so that table is not there yet to apply mutations against.&lt;/p&gt;

&lt;p&gt;This is the log from the second node. The first one booted fine, the second one throws this, the third one boots fine. It seems like eventually everything is just fine however that exception is ... concerning.&lt;/p&gt;</comment>
                            <comment id="17191711" author="stefan.miklosovic" created="Mon, 7 Sep 2020 13:36:56 +0000"  >&lt;p&gt;There is also a runtime error as that concurrent hash map from that package is not on the class path. I removed it here, I just squashed all changes in Blakes branch + this one fix:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/instaclustr/cassandra/commit/e23677deeb7c836b4b7c80f98009353668351620&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/instaclustr/cassandra/commit/e23677deeb7c836b4b7c80f98009353668351620&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17191793" author="stefan.miklosovic" created="Mon, 7 Sep 2020 16:58:53 +0000"  >&lt;p&gt;These tests are failing&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/4/#showFailuresLink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/4/#showFailuresLink&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17193009" author="stefan.miklosovic" created="Wed, 9 Sep 2020 16:18:15 +0000"  >&lt;p&gt;I have improved the original work of mine and I wrote a test for that. Jenkins build does not fail anymore so I believe I have totally on par solution when it comes to dtests as I do not have time to fix dtests which the other solution breaks. While I admit that the improved version is technicaly more superior, the necessity to have clean build and same behaviour when it comes to dtests is more important to me at this moment. It would be awesome if dtests and issues I spotted are resolved though.&lt;/p&gt;

&lt;p&gt;The test is here (1), the main logic is that a cluster of two nodes is started, the third node is started afterwards and I am dropping all migration messages to the other two, simulating some communication error between them. After some time, migration messages starts to flow again. So by doing this, I ll test the internals of the logic I wrote and it seems to do its job.&lt;/p&gt;

&lt;p&gt;One issue I am little bit concerned of is that StorageService is issuing schema migration requests on &quot;onAlive, onJoin ...&quot; in StorageService and these requests are not part of the waitForSchema() logic. It is understandable that it is like that as we need to track migration requests after a node fully bootstraps but we should skip this from happening when a node is under bootstrapping. I wrapped the bodies of these methods into &quot;if (hasJoined())&quot; but it was invoked anyway. However, it does not matter too much if this is outside of the logic I did because if schema migration was sucessful, the rewritten logic in waitForSchema does not have anything to deal with so we are done anyway. For skipping this in test, I used ByteBuddy to intercept MigrationManager#scheduleSchemaPull to do nothing hence I effectively skip migration schemas to be sent outside of the change I did.&lt;/p&gt;

&lt;p&gt;onChange method in onJoin merges schemas again too, in case state is SCHEMA so I am not completely sure why we are merging schemas on a join anyway?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onJoin(InetAddress endpoint, EndpointState epState)
    {
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Map.Entry&amp;lt;ApplicationState, VersionedValue&amp;gt; entry : epState.states())
        {
            onChange(endpoint, entry.getKey(), entry.getValue());
        }

        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is weird
&lt;/span&gt;        MigrationManager.instance.scheduleSchemaPull(endpoint, epState);
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onAlive(InetAddress endpoint, EndpointState state)
    {
        &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is weird as well
&lt;/span&gt;        MigrationManager.instance.scheduleSchemaPull(endpoint, state);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (tokenMetadata.isMember(endpoint))
            notifyUp(endpoint);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;(1) &lt;a href=&quot;https://github.com/instaclustr/cassandra/blob/15158-original-fix/test/distributed/org/apache/cassandra/distributed/test/BootstrappingSchemaAgreementTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/instaclustr/cassandra/blob/15158-original-fix/test/distributed/org/apache/cassandra/distributed/test/BootstrappingSchemaAgreementTest.java&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="17211409" author="bdeggleston" created="Fri, 9 Oct 2020 21:11:31 +0000"  >&lt;p&gt;Ok, I&apos;ve fixed all the dtest issues and ported the 3.11 fix to 3.0 and trunk.&lt;/p&gt;

&lt;p&gt;The 3.11 branch with misc fixes is here: &lt;a href=&quot;https://github.com/bdeggleston/cassandra/tree/15158-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/bdeggleston/cassandra/tree/15158-3.11&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Most of the fixes are self explanatory, the less obvious ones are:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;wait for gossip to settle before waiting on schemas. The original patch accidentally removed the wait on the schema version to be non-empty, so this both a fix and a change. Waiting for gossip makes it more likely that we&apos;ve seen all current schema versions before we begin waiting instead of just waiting for the first schema to be received, which was the effect of waiting on Schema.instance.isEmpty&lt;/li&gt;
	&lt;li&gt;don&apos;t check liveness in shouldPullFromEndpoint. There were cases where the node wasn&apos;t considered alive until after `reportEndpointVersion` had been called (because it happens as part of the current gossip update).&lt;/li&gt;
	&lt;li&gt;move migration start inside StorageService.joinRing because in-jvm dtests don&apos;t use CassandraDaemon&lt;/li&gt;
	&lt;li&gt;don&apos;t fail maybePullSchema if version info has no endpoints. We automatically call that after completing a pull, so a version will eventually have no endpoints left on it&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The squashed ports are here:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/bdeggleston/cassandra/tree/15158-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/bdeggleston/cassandra?branch=15158-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/bdeggleston/cassandra/tree/15158-3.11-squashed&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/bdeggleston/cassandra?branch=15158-3.11-squashed&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/bdeggleston/cassandra/tree/15158-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/bdeggleston/cassandra?branch=15158-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17211469" author="stefan.miklosovic" created="Fri, 9 Oct 2020 23:30:10 +0000"  >&lt;p&gt;Thanks for this a lot! I ll review right at the beginning of the next week.&lt;/p&gt;</comment>
                            <comment id="17211620" author="stefan.miklosovic" created="Sat, 10 Oct 2020 08:51:24 +0000"  >&lt;p&gt;I have left my comments in 3.0 branch - probably applicable to 3.11 and trunk too.&lt;/p&gt;</comment>
                            <comment id="17216816" author="iamaleksey" created="Mon, 19 Oct 2020 15:27:17 +0000"  >&lt;p&gt;Left a small comment on the 3.0 branch. Also, the following nits for &lt;tt&gt;MigrationCoordinator&lt;/tt&gt;:&lt;br/&gt;
1. A bunch of unused imports&lt;br/&gt;
2. &lt;tt&gt;shouldApplySchemaFrom()&lt;/tt&gt; has an unused argument&lt;br/&gt;
3. &lt;tt&gt;requestQueue&lt;/tt&gt; could be an &lt;tt&gt;ArrayDequeue&lt;/tt&gt; instead of a &lt;tt&gt;LinkedList&lt;/tt&gt; - should set a good example for anyone randomly reading this code, even if it&apos;s not critical to do the right thing in this context &lt;/p&gt;

&lt;p&gt;EDIT: LGTM, +1, ship it&lt;/p&gt;</comment>
                            <comment id="17223244" author="bdeggleston" created="Thu, 29 Oct 2020 22:09:31 +0000"  >&lt;p&gt;Addressed all review comments and rebased onto the latest branches&lt;/p&gt;</comment>
                            <comment id="17225010" author="stefan.miklosovic" created="Mon, 2 Nov 2020 23:21:22 +0000"  >&lt;p&gt;I am +1 too (it if counts &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;)&lt;/p&gt;</comment>
                            <comment id="17228799" author="bdeggleston" created="Mon, 9 Nov 2020 20:26:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefan.miklosovic&quot; class=&quot;user-hover&quot; rel=&quot;stefan.miklosovic&quot;&gt;stefan.miklosovic&lt;/a&gt;&#160;it does, thanks to you and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aleksey&quot; class=&quot;user-hover&quot; rel=&quot;aleksey&quot;&gt;aleksey&lt;/a&gt;&#160;for the reviews. Committed to 3.0 and merged up to trunk.&lt;/p&gt;</comment>
                            <comment id="17231757" author="dcapwell" created="Fri, 13 Nov 2020 18:52:24 +0000"  >&lt;p&gt;Found a small set of typos which cause us to wait for schemas for 8h20m rather than 30s, going to submit a patch here and fix in all 3 branches...&lt;/p&gt;</comment>
                            <comment id="17231777" author="dcapwell" created="Fri, 13 Nov 2020 19:14:05 +0000"  >&lt;p&gt;Patches:&lt;/p&gt;

&lt;p&gt;3.0: &lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/patchfix/CASSANDRA-15158-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dcapwell/cassandra/tree/patchfix/CASSANDRA-15158-3.0&lt;/a&gt;&lt;br/&gt;
3.11: &lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/patchfix/CASSANDRA-15158-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dcapwell/cassandra/tree/patchfix/CASSANDRA-15158-3.11&lt;/a&gt;&lt;br/&gt;
trunk: &lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/patchfix/CASSANDRA-15158-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dcapwell/cassandra/tree/patchfix/CASSANDRA-15158-trunk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;A test was added in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16213&quot; title=&quot;Cannot replace_address /X because it doesn&amp;#39;t exist in gossip&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16213&quot;&gt;&lt;del&gt;CASSANDRA-16213&lt;/del&gt;&lt;/a&gt; which showed this issue, its only stable once this patch is applied (and disable failing)&lt;/p&gt;</comment>
                            <comment id="17231782" author="dcapwell" created="Fri, 13 Nov 2020 19:25:50 +0000"  >&lt;p&gt;Starting commit&lt;/p&gt;

&lt;p&gt;CI Results: Yellow.  3.1 org.apache.cassandra.service.MigrationCoordinatorTest but passes locally, &lt;del&gt;trunk org.apache.cassandra.distributed.test.ring.BootstrapTest fails frequently due to schemas not present added commit which increases timeout from 30s to 90s&lt;/del&gt;, and other expected issues.&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Source&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Circle CI&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Jenkins&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;cassandra-3.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/commit_remote_branch/CASSANDRA-15158-cassandra-3.0-7E401495-E38F-4857-80C1-2C27028F572E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=commit_remote_branch%2FCASSANDRA-15158-cassandra-3.0-7E401495-E38F-4857-80C1-2C27028F572E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/200/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;cassandra-3.11&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/commit_remote_branch/CASSANDRA-15158-cassandra-3.11-7E401495-E38F-4857-80C1-2C27028F572E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=commit_remote_branch%2FCASSANDRA-15158-cassandra-3.11-7E401495-E38F-4857-80C1-2C27028F572E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/201/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/commit_remote_branch/CASSANDRA-15158-trunk-7E401495-E38F-4857-80C1-2C27028F572E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=commit_remote_branch%2FCASSANDRA-15158-trunk-7E401495-E38F-4857-80C1-2C27028F572E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/202/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17231810" author="bdeggleston" created="Fri, 13 Nov 2020 20:26:44 +0000"  >&lt;p&gt;Thanks David, +1&lt;/p&gt;</comment>
                            <comment id="17231814" author="dcapwell" created="Fri, 13 Nov 2020 20:39:30 +0000"  >&lt;p&gt;Committed&#160;&lt;a href=&quot;https://github.com/apache/cassandra/commit/7d6f9b94dd0d00bfd29374d7a645e650f451023d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/7d6f9b94dd0d00bfd29374d7a645e650f451023d&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13486968">CASSANDRA-17972</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13383346">CASSANDRA-16732</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12967282">CASSANDRA-11748</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bdeggleston]]></customfieldvalue>
        <customfieldvalue><![CDATA[stefan.miklosovic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12989" cascade-level="1"><![CDATA[Consistency]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12966"><![CDATA[Challenging]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z03p14:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
        <customfieldvalue><![CDATA[bdeggleston]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333891">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/08450080614250a8bfaba23dbca741a4d9315e3c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/08450080614250a8bfaba23dbca741a4d9315e3c&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;There are unit tests as part of PR testing this feature.&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>