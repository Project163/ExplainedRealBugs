<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:49:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8285] Move all hints related tasks to hints private executor</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8285</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We ran drivers 3-days endurance tests against Cassandra 2.0.11 and C* crashed with an OOME.  This happened both with ruby-driver 1.0-beta and java-driver 2.0.8-snapshot.&lt;/p&gt;

&lt;p&gt;Attached are :&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; OOME_node_system.log &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; The system.log of one Cassandra node that crashed &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; gc.log.gz &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; The GC log on the same node &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; heap-usage-after-gc.png &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; The heap occupancy evolution after every GC cycle &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; heap-usage-after-gc-zoom.png &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; A focus on when things start to go wrong &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Workload :&lt;br/&gt;
Our test executes 5 CQL statements (select, insert, select, delete, select) for a given unique id, during 3 days, using multiple threads.  There is not change in the workload during the test.&lt;/p&gt;

&lt;p&gt;Symptoms :&lt;br/&gt;
In the attached log, it seems something starts in Cassandra between 2014-11-06 10:29:22 and 2014-11-06 10:45:32.  This causes an allocation that fills the heap.  We eventually get stuck in a Full GC storm and get an OOME in the logs.&lt;/p&gt;

&lt;p&gt;I have run the java-driver tests against Cassandra 1.2.19 and 2.1.1.  The error does not occur.  It seems specific to 2.0.11.&lt;/p&gt;
</description>
                <environment>&lt;p&gt;Cassandra 2.0.11 + java-driver 2.0.8-SNAPSHOT&lt;br/&gt;
Cassandra 2.0.11 + ruby-driver 1.0-beta&lt;/p&gt;</environment>
        <key id="12754161">CASSANDRA-8285</key>
            <summary>Move all hints related tasks to hints private executor</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aleksey">Aleksey Yeschenko</assignee>
                                    <reporter username="pingtimeout">Pierre Laporte</reporter>
                        <labels>
                    </labels>
                <created>Mon, 10 Nov 2014 15:12:48 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:28 +0000</updated>
                            <resolved>Fri, 19 Dec 2014 18:29:44 +0000</resolved>
                                        <fixVersion>2.0.12</fixVersion>
                    <fixVersion>2.1.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>15</watches>
                                                                                                                <comments>
                            <comment id="14205594" author="jbellis" created="Mon, 10 Nov 2014 23:55:46 +0000"  >&lt;p&gt;Ryan, who can do a first cut heap analysis?&lt;/p&gt;</comment>
                            <comment id="14205600" author="jbellis" created="Mon, 10 Nov 2014 23:56:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pingtimeout&quot; class=&quot;user-hover&quot; rel=&quot;pingtimeout&quot;&gt;pingtimeout&lt;/a&gt; please upload a heap dump and we&apos;ll have a look.  may be we&apos;re not flushing aggressively enough.&lt;/p&gt;</comment>
                            <comment id="14208169" author="pingtimeout" created="Wed, 12 Nov 2014 16:00:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbellis&quot; class=&quot;user-hover&quot; rel=&quot;jbellis&quot;&gt;jbellis&lt;/a&gt; Please find a new gc log, system log and heap dump &lt;a href=&quot;https://drive.google.com/a/datastax.com/folderview?id=0BxvGkaXP3ayeNV83Nm1nSUNEcDQ&amp;amp;usp=sharing&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;Those 3 files come from the same instance that crashed after a couple of hours.  The heap dump was triggered by &lt;tt&gt;-XX:+HeapDumpOnOutOfMemoryError&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Hope that helps&lt;/p&gt;</comment>
                            <comment id="14208642" author="rhatch" created="Wed, 12 Nov 2014 20:40:26 +0000"  >&lt;p&gt;I used MAT to have a look at the heap contents and try to figure out what&apos;s going on. The heap appears to be dominated by a single MemTable consuming about 97% of heap. The max memtable size is definitely being exceeded. So something quirky with flushing seems like a good suspect.&lt;/p&gt;

&lt;p&gt;Here&apos;s the startup message acknowledging the max size (presumably defaulted to 1/4 heap by not being set):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; INFO [main] 2014-11-10 17:09:29,348 DatabaseDescriptor.java (line 268) Global memtable threshold is enabled at 253MB
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Due to dropped messages and full gc&apos;s StatusLogger was dumping some (maybe) useful information to the logs that shows some blocked FlushWriter threads &amp;#8211; I&apos;m not sure whether this is routine or not, might be worth reviewing. Here we see the FlushWriter &apos;All Time Blocked&apos; threads value spike suddenly, followed by a large increase in pending compactions (if I&apos;m interpreting the logs correctly):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;                                                                                                          Active    Pending    Completed      Blocked     All Time Blocked
 INFO [ScheduledTasks:1] 2014-11-11 08:21:07,549 StatusLogger.java (line 70) FlushWriter                       0         0           4993         0                 1
 INFO [ScheduledTasks:1] 2014-11-11 08:21:07,636 StatusLogger.java (line 70) CompactionExecutor                1         6           4639         0                 0
 INFO [ScheduledTasks:1] 2014-11-11 08:21:07,636 StatusLogger.java (line 79) CompactionManager                 1         8
 INFO [ScheduledTasks:1] 2014-11-12 09:57:10,590 StatusLogger.java (line 70) FlushWriter                       0         0            111         0                28
 INFO [ScheduledTasks:1] 2014-11-12 09:57:10,719 StatusLogger.java (line 70) CompactionExecutor                1        19             26         0                 0
 INFO [ScheduledTasks:1] 2014-11-12 09:57:10,720 StatusLogger.java (line 79) CompactionManager                 1        21
 INFO [ScheduledTasks:1] 2014-11-12 09:57:24,648 StatusLogger.java (line 70) FlushWriter                       0         0            111         0                28
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So it seems basically an unflushed memtable is consuming excessive heap and causing the constant full GC&apos;s and the eventual OOM. Now the question is why is the memtable not being flushed?&lt;/p&gt;</comment>
                            <comment id="14216783" author="kishkaru" created="Tue, 18 Nov 2014 20:56:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; I ran the duration tests for twice the normal length (6days/144h) and here are the results:&lt;/p&gt;

&lt;p&gt;The duration tests run against 2.0.9 and 2.0.10 completed successfully without errors.&lt;/p&gt;

&lt;p&gt;The endurance test run against 2.0.10 OOME&apos;d. The endurance test is identical to the duration test, except that we randomly kill/restart C* nodes on a rolling basis. Although the C* nodes had a few a few heap dumps, it wasn&apos;t after the last one that the nodes weren&apos;t able to restart. This is when I noticed that there was an issue. I&apos;ve attached the first heap dump and the last heap dump. Because of the way I was logging the gc, I only have the log for the immediately prior to the last heap dump.&lt;/p&gt;

&lt;p&gt;The gc log, the heap dumps, the system logs, and a few graphs generated from the gc log via jClarity can be found &lt;a href=&quot;https://drive.google.com/folderview?id=0B7jl9PHt-BGQRDA2RHJ0cmVwVlU&amp;amp;usp=sharing&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14216831" author="iamaleksey" created="Tue, 18 Nov 2014 21:38:45 +0000"  >&lt;p&gt;I have a strong feeling that this is a dupe of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8164&quot; title=&quot;OOM due to slow memory meter&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8164&quot;&gt;&lt;del&gt;CASSANDRA-8164&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14221226" author="kishkaru" created="Fri, 21 Nov 2014 18:41:03 +0000"  >&lt;p&gt;Currently running Ruby duration tests against C* 2.0 head (2.0.12) in both duration and endurance fashion. This is another 6-day trial, and is about 40% complete (57.6h). So far no errors.&lt;/p&gt;</comment>
                            <comment id="14223083" author="pingtimeout" created="Mon, 24 Nov 2014 16:01:50 +0000"  >&lt;p&gt;I have the issue after ~1.5 day on the endurance test of java-driver 2.1.3 against 2.0.12.&lt;/p&gt;

&lt;p&gt;Please find the associated heap dump &lt;a href=&quot;https://drive.google.com/open?id=0BxvGkaXP3ayeOElqY1ZNQTlBNTg&amp;amp;authuser=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="14223321" author="pingtimeout" created="Mon, 24 Nov 2014 19:09:11 +0000"  >&lt;p&gt;I just reproduced the issue on my machine against Cassandra 2.1.2.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Howto&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Create 3-nodes C* cluster&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ccm create -n 3 -v 2.1.2 -b -s -i 127.0.0. cassandra-2.1&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Insert/delete a lot of rows inside a single table.  I was actually trying to reproduce the TombstoneOverwhelmingException but got an OOME instead.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;CassandraTest &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; AutoCloseable {
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; KEYSPACE = &lt;span class=&quot;code-quote&quot;&gt;&quot;TombstonesOverwhelming&quot;&lt;/span&gt;;

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Cluster cluster;
    &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; Session session;

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; CassandraTest() {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RoundRobinPolicy());
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; CassandraTest(LoadBalancingPolicy loadBalancingPolicy) {
        &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Creating builder...&quot;&lt;/span&gt;);
        cluster = Cluster.builder().addContactPoint(&lt;span class=&quot;code-quote&quot;&gt;&quot;127.0.0.1&quot;&lt;/span&gt;).withLoadBalancingPolicy(loadBalancingPolicy).build();
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Host host : cluster.getMetadata().getAllHosts()) {
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Found host &quot;&lt;/span&gt; + host.getAddress() + &lt;span class=&quot;code-quote&quot;&gt;&quot; in DC &quot;&lt;/span&gt; + host.getDatacenter());
        }
        session = cluster.connect();
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void executeQuietly(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; query) {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            execute(query);
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
            e.printStackTrace();
        }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; ResultSet execute(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; query) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; session.execute(query);
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; ResultSet execute(Statement statement) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; session.execute(statement);
    }

    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException {
        cluster.close();
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;... args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (CassandraTest test = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CassandraTest()) {
            test.executeQuietly(&lt;span class=&quot;code-quote&quot;&gt;&quot;DROP KEYSPACE IF EXISTS &quot;&lt;/span&gt; + KEYSPACE);
            test.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE KEYSPACE &quot;&lt;/span&gt; + KEYSPACE + &lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt; +
                &lt;span class=&quot;code-quote&quot;&gt;&quot;WITH REPLICATION = { &lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt; : 3 }&quot;&lt;/span&gt;);
            test.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;USE &quot;&lt;/span&gt; + KEYSPACE);
            test.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE useful (run &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, iteration &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, copy &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, PRIMARY KEY (run, iteration, copy))&quot;&lt;/span&gt;);

            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Press ENTER to start the test&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.in.read();

            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; run = 0; run &amp;lt; 1_000_000; run++) {
                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.printf(&lt;span class=&quot;code-quote&quot;&gt;&quot;Starting run % 7d... &quot;&lt;/span&gt;, run);
                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.print(&lt;span class=&quot;code-quote&quot;&gt;&quot;Inserting...&quot;&lt;/span&gt;);
                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; iteration = 0; iteration &amp;lt; 1_000_000; iteration++) {
                    Batch batch = QueryBuilder.batch();
                    batch.setConsistencyLevel(ConsistencyLevel.QUORUM);
                    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; copy = 0; copy &amp;lt; 100; copy++) {
                        batch.add(QueryBuilder.insertInto(&lt;span class=&quot;code-quote&quot;&gt;&quot;useful&quot;&lt;/span&gt;)
                            .value(&lt;span class=&quot;code-quote&quot;&gt;&quot;run&quot;&lt;/span&gt;, run).value(&lt;span class=&quot;code-quote&quot;&gt;&quot;iteration&quot;&lt;/span&gt;, iteration).value(&lt;span class=&quot;code-quote&quot;&gt;&quot;copy&quot;&lt;/span&gt;, copy));
                    }
                    test.execute(batch);
                }
                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;Deleting...&quot;&lt;/span&gt;);
                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; iteration = 0; iteration &amp;lt; 1_000_000; iteration++) {
                    Batch batch = QueryBuilder.batch();
                    batch.setConsistencyLevel(ConsistencyLevel.QUORUM);
                    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; copy = 0; copy &amp;lt; 100; copy++) {
                        batch.add(QueryBuilder.delete().from(&lt;span class=&quot;code-quote&quot;&gt;&quot;useful&quot;&lt;/span&gt;)
                            .where(eq(&lt;span class=&quot;code-quote&quot;&gt;&quot;run&quot;&lt;/span&gt;, run)).and(eq(&lt;span class=&quot;code-quote&quot;&gt;&quot;iteration&quot;&lt;/span&gt;, iteration)).and(eq(&lt;span class=&quot;code-quote&quot;&gt;&quot;copy&quot;&lt;/span&gt;, copy)));
                    }
                    test.execute(batch);
                }
            }
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
            e.printStackTrace();
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I took ~50 minutes before two instances OOME&apos;d.  Please find attached the gc log (gc-1416849312.log.gz) and the system log (system.log.gz).  If needed, I can upload a heap dump too.&lt;/p&gt;

&lt;p&gt;Hope that helps&lt;/p&gt;</comment>
                            <comment id="14223346" author="rhatch" created="Mon, 24 Nov 2014 19:19:57 +0000"  >&lt;p&gt;The heap dump Pierre included directly above looks similar to the earlier one. One difference here is there appears to be 2 active memtables (the earlier heap dump had just one) consuming most of the heap.&lt;/p&gt;

&lt;p&gt;In this newer heap dump the MemTable objects appear to be contained/referenced by DataTracker objects, whereas in the earlier heap the voracious MemTable looked kinda like a &quot;top level&quot; object. But I could be misreading/misunderstanding the MAT report.&lt;/p&gt;</comment>
                            <comment id="14223845" author="kishkaru" created="Tue, 25 Nov 2014 00:39:19 +0000"  >&lt;p&gt;Both the duration and endurance tests on the Ruby side finished successfully without any C* errors. These were run with larger instances, thus I launched another 6-day trial against C* 2.0 head with regular instance sizes.&lt;/p&gt;</comment>
                            <comment id="14225253" author="kishkaru" created="Tue, 25 Nov 2014 21:42:15 +0000"  >&lt;p&gt;I was able to reproduce the OOME on C* 2.0 head within 14 hours on the endurance test. As with Pierre&apos;s case, it first manifests as a TombstoneOverwhelmingException, and then soon after an OutOfMemoryError. Heap dump &lt;a href=&quot;https://drive.google.com/file/d/0B7jl9PHt-BGQaHpJTUpSRHhVYTg/view?usp=sharing&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14226462" author="jbellis" created="Wed, 26 Nov 2014 17:05:40 +0000"  >&lt;p&gt;Can you bisect?  (Perhaps with a tiny heap to reproduce OOM faster.)&lt;/p&gt;</comment>
                            <comment id="14229171" author="iamaleksey" created="Sun, 30 Nov 2014 17:28:10 +0000"  >&lt;p&gt;We are dealing with two (or maybe three) separate issues here, so I&apos;ll be splitting the ticket later.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kishkaru&quot; class=&quot;user-hover&quot; rel=&quot;kishkaru&quot;&gt;kishkaru&lt;/a&gt; your first 2 2.0.10 dumps are dominated by system.hints SSTables. 10k SSTables read for HHOM#getRangeSlice() call, each with a 65kb byte[] array for its CRAR. The stack trace is more or less the same as for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8269&quot; title=&quot;Large number of system hints &amp;amp; other CF&amp;#39;s cause heap to fill and run OOM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8269&quot;&gt;&lt;del&gt;CASSANDRA-8269&lt;/del&gt;&lt;/a&gt;. Not much we can do there - &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8269?focusedCommentId=14200316&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14200316&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-8269?focusedCommentId=14200316&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14200316&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Still trying to load the third dump (takes a while).&lt;/p&gt;

&lt;p&gt;And Pierre&apos;s problem is completely unrelated. I&apos;ll comment in more detail tomorrow.&lt;/p&gt;</comment>
                            <comment id="14229186" author="iamaleksey" created="Sun, 30 Nov 2014 18:16:39 +0000"  >&lt;p&gt;The third dump is dominated by two memtables - hints (shocking) and duration_test0.ints. Hints memtable in place of sstables b/c of the change in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6998&quot; title=&quot;HintedHandoff - expired hints may block future hints deliveries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6998&quot;&gt;&lt;del&gt;CASSANDRA-6998&lt;/del&gt;&lt;/a&gt;, which should probably explicitly flush before replaying - in addition to explcit compaction. I&apos;ll open a separate ticket for that.&lt;/p&gt;

</comment>
                            <comment id="14230732" author="iamaleksey" created="Tue, 2 Dec 2014 00:04:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6998&quot; title=&quot;HintedHandoff - expired hints may block future hints deliveries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6998&quot;&gt;&lt;del&gt;CASSANDRA-6998&lt;/del&gt;&lt;/a&gt; broke it by forcing a synchronous major compaction in HHOM#scheduleAllHints(). But scheduleAllHints() is running on StorageService.optionalTasks, same single threaded executor that we use for memtable flushing.&lt;/p&gt;

&lt;p&gt;So with a huge hint buildup (which is what these duration tests are doing), it can block flushing other memtables, b/c metered flusher is scheduled there too.&lt;/p&gt;

&lt;p&gt;This solves it for 2.0.11. Pierre&apos;s issue is unrelated.&lt;/p&gt;</comment>
                            <comment id="14232205" author="jbellis" created="Tue, 2 Dec 2014 22:03:05 +0000"  >&lt;p&gt;Was &quot;this&quot; referring to a patch you meant to attach?&lt;/p&gt;</comment>
                            <comment id="14232455" author="iamaleksey" created="Wed, 3 Dec 2014 01:55:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;Was &quot;this&quot; referring to a patch you meant to attach?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No idea what I meant by &quot;this&quot;. Most likely &quot;&apos;changing the current behavior&quot;. Either way, the patch is attached now.&lt;/p&gt;</comment>
                            <comment id="14234620" author="kishkaru" created="Thu, 4 Dec 2014 21:03:57 +0000"  >&lt;p&gt;I tried 2.0 head with Aleksey&apos;s patch, and I get the following error upon startup:&lt;br/&gt;
&lt;a href=&quot;http://aep.appspot.com/display/PX-eSYFV0e47OujZ8BzaC-5yNsM/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://aep.appspot.com/display/PX-eSYFV0e47OujZ8BzaC-5yNsM/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14237180" author="iamaleksey" created="Sun, 7 Dec 2014 15:35:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kishkaru&quot; class=&quot;user-hover&quot; rel=&quot;kishkaru&quot;&gt;kishkaru&lt;/a&gt; that was a problem with MBean naming. Attached a v2. Can you run it and see if it works before I mark the issue as patch-available?&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="14237952" author="kishkaru" created="Mon, 8 Dec 2014 15:13:21 +0000"  >&lt;p&gt;Yes, it compiles and starts up. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pingtimeout&quot; class=&quot;user-hover&quot; rel=&quot;pingtimeout&quot;&gt;pingtimeout&lt;/a&gt;, could you spin up a duration test?&lt;/p&gt;</comment>
                            <comment id="14238059" author="pingtimeout" created="Mon, 8 Dec 2014 16:52:41 +0000"  >&lt;p&gt;Sure. Is the patch already applied to branch cassandra-2.0 or should I apply it manually ?&lt;/p&gt;</comment>
                            <comment id="14238256" author="iamaleksey" created="Mon, 8 Dec 2014 18:54:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;Sure. Is the patch already applied to branch cassandra-2.0 or should I apply it manually ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The latter.&lt;/p&gt;</comment>
                            <comment id="14246984" author="pingtimeout" created="Mon, 15 Dec 2014 18:38:30 +0000"  >&lt;p&gt;The ruby duration tests have passed, the issue has not been seen on C* 2.0.12 (HEAD + 8285-v2.txt).&lt;/p&gt;

&lt;p&gt;Note that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kishkaru&quot; class=&quot;user-hover&quot; rel=&quot;kishkaru&quot;&gt;kishkaru&lt;/a&gt;&apos;s previous tests was using two tester machines, while this one only used one, so that reduces the load C* had to handle.  Still, the issue has not been seen during the 3-days test.&lt;/p&gt;</comment>
                            <comment id="14247046" author="iamaleksey" created="Mon, 15 Dec 2014 19:00:58 +0000"  >&lt;p&gt;Thanks, Pierre.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt; to review. With &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8485&quot; title=&quot;Move 2.0 metered flusher to its own thread&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8485&quot;&gt;&lt;del&gt;CASSANDRA-8485&lt;/del&gt;&lt;/a&gt; opened as a follow-up issue.&lt;/p&gt;</comment>
                            <comment id="14253666" author="beobal" created="Fri, 19 Dec 2014 17:15:09 +0000"  >&lt;p&gt;lgtm, but doesn&apos;t apply to 2.1 any more. Some of the changes to ThreadPoolMetrics in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8328&quot; title=&quot;Expose Thread Pool maximum pool size in metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8328&quot;&gt;&lt;del&gt;CASSANDRA-8328&lt;/del&gt;&lt;/a&gt; complicate things, but it seems that we can do those things in a slightly different way. Attaching a v3 rebased onto 2.1 and with the problematic stuff from 8328 re-jigged.&lt;/p&gt;</comment>
                            <comment id="14253738" author="iamaleksey" created="Fri, 19 Dec 2014 18:29:13 +0000"  >&lt;p&gt;Committed, thanks.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12749808">CASSANDRA-8164</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12707157">CASSANDRA-6998</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12685610" name="8285-v2.txt" size="10160" author="aleksey" created="Sun, 7 Dec 2014 15:34:20 +0000"/>
                            <attachment id="12688359" name="8285-v3.txt" size="13793" author="samt" created="Fri, 19 Dec 2014 17:16:11 +0000"/>
                            <attachment id="12684772" name="8285.txt" size="8866" author="aleksey" created="Wed, 3 Dec 2014 01:49:53 +0000"/>
                            <attachment id="12680587" name="OOME_node_system.log" size="6297407" author="pingtimeout" created="Mon, 10 Nov 2014 15:12:48 +0000"/>
                            <attachment id="12683389" name="gc-1416849312.log.gz" size="2342150" author="pingtimeout" created="Mon, 24 Nov 2014 19:09:11 +0000"/>
                            <attachment id="12680584" name="gc.log.gz" size="5395091" author="pingtimeout" created="Mon, 10 Nov 2014 15:12:48 +0000"/>
                            <attachment id="12680585" name="heap-usage-after-gc-zoom.png" size="121999" author="pingtimeout" created="Mon, 10 Nov 2014 15:12:48 +0000"/>
                            <attachment id="12680586" name="heap-usage-after-gc.png" size="393626" author="pingtimeout" created="Mon, 10 Nov 2014 15:12:48 +0000"/>
                            <attachment id="12683390" name="system.log.gz" size="153993" author="pingtimeout" created="Mon, 24 Nov 2014 19:09:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 48 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i226nz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>samt</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>