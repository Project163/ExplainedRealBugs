<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:14:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15035] C* 3.0 sstables w/ UDTs are corrupted in 3.11 + 4.0</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15035</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;OSS C* 3.0 writes incorrect type information for UDTs into the serialization-header of each sstable.&lt;/p&gt;

&lt;p&gt;In C* 3.0, both UDTs and tuple are always frozen. A frozen type must be enclosed in a &lt;tt&gt;frozen&amp;lt;...&amp;gt;&lt;/tt&gt; via the &lt;tt&gt;CQL3Type&lt;/tt&gt; hierarchy (resp &lt;tt&gt;org.apache.cassandra.db.marshal.FrozenType(...)&lt;/tt&gt; via the &lt;tt&gt;AbstractType&lt;/tt&gt; hierarchy) &#8220;bracket&#8221; in the schema and serialization-header.&lt;/p&gt;

&lt;p&gt;Since &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7423&quot; title=&quot;Allow updating individual subfields of UDT&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7423&quot;&gt;&lt;del&gt;CASSANDRA-7423&lt;/del&gt;&lt;/a&gt; (committed to C* 3.6) UDTs can also be non-frozen (= multi-cell).&lt;/p&gt;

&lt;p&gt;Unfortunately, C* 3.0 does not write the &lt;tt&gt;org.apache.cassandra.db.marshal.FrozenType(...)&lt;/tt&gt; &#8220;bracket&#8221; for UDTs into the &lt;tt&gt;SerializationHeader.Component&lt;/tt&gt; in the &lt;tt&gt;-Stats.db&lt;/tt&gt; sstable component.&lt;/p&gt;

&lt;p&gt;The order in which columns of a row are serialized depends on the concrete &lt;tt&gt;AbstractType&lt;/tt&gt;. Columns with variable length types (frozen types belong to this category) are serialized before columns with multi-cell types (non-frozen types belong to that category).&lt;/p&gt;

&lt;p&gt;If C* 3.6 (or any newer version) reads an sstable written by C* 3.0 (up to 3.5), it will read the type information &#8220;non-frozen UDT&#8221; from the serialization header, which is technically correct.&lt;/p&gt;

&lt;p&gt;This means, that upgrades from C* 3.0 to C* 3.11 and 4.0, using a schema that uses UDTs, result in inaccessible data in those sstables. Reads against 3.0 sstables as well as attempts to scrub these sstables result in a wide variety of errors/exceptions (&lt;tt&gt;CorruptSSTableException&lt;/tt&gt;, &lt;tt&gt;EOFExcepiton&lt;/tt&gt;, &lt;tt&gt;OutOfMemoryError&lt;/tt&gt;, etc etc), as usual in such cases.&lt;/p&gt;

&lt;p&gt;Mitigation strategy in the proposed patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Fix the broken serialization-headers automatically when an upgrade from C* 3.0 is detected.&lt;/li&gt;
	&lt;li&gt;Enhance &lt;tt&gt;sstablescrub&lt;/tt&gt; to verify the serialization-header against the schema and allow &lt;tt&gt;sstablescrub&lt;/tt&gt; to fix the UDT types according to the information in the schema. This does not apply to &quot;online scrub&quot; (e.g. nodetool scrub). The behavior of &lt;tt&gt;sstablescrub&lt;/tt&gt; has been changed to first inspect the serialization-header and verify the type information against the schema.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Differences between the schema and the sstable serialization-headers cause &lt;tt&gt;sstablescrub&lt;/tt&gt; to error out and stop - i.e. safety first (there&#8217;s a way to opt-out though).&lt;/p&gt;

&lt;p&gt;A new class &lt;tt&gt;SSTableHeaderFix&lt;/tt&gt; can inspect the serialization-header (&lt;tt&gt;SerializationHeader.Component&lt;/tt&gt;) in the the &lt;tt&gt;-Statistics.db&lt;/tt&gt; component and fix the type information in those sstables for UDTs according to the schema information.&lt;/p&gt;

&lt;p&gt;This new class could be used during verify and before sstables are imported. But changes to &#8220;verify&#8221; and &#8220;import&#8221; are out of the scope of this ticket, as the patch is already bigger than I originally expected.&lt;/p&gt;

&lt;p&gt;Another issue not tackled by this ticket is that the wrong &#8216;kind&#8217; is written to the type information in &lt;tt&gt;system_schema.dropped_columns&lt;/tt&gt; when a non-frozen UDT column is dropped. When a UDT column is dropped, the type of the dropped column is converted from the UDT definition to its &#8220;corresponding&#8221; tuple type definition. But all versions currently write &lt;tt&gt;frozen&amp;lt;tuple&amp;lt;...&amp;gt;&amp;gt;&lt;/tt&gt;, but for non-frozen UDTs it should actually just be &lt;tt&gt;tuple&amp;lt;...&amp;gt;&lt;/tt&gt;. Unfortunately, there is nothing that could be done in this ticket to fix (or even consider) the type information of a dropped column. But for correctness, the tuple type should be a multi-cell one (only accessible for dropped UDTs though - not as something that a user can create as a type).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13218085">CASSANDRA-15035</key>
            <summary>C* 3.0 sstables w/ UDTs are corrupted in 3.11 + 4.0</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="snazy">Robert Stupp</assignee>
                                    <reporter username="snazy">Robert Stupp</reporter>
                        <labels>
                    </labels>
                <created>Tue, 26 Feb 2019 13:03:04 +0000</created>
                <updated>Tue, 4 Mar 2025 21:07:53 +0000</updated>
                            <resolved>Fri, 31 Jan 2020 09:15:40 +0000</resolved>
                                        <fixVersion>3.11.6</fixVersion>
                    <fixVersion>4.0-alpha4</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Feature/UDT</component>
                    <component>Local/SSTable</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="16777894" author="snazy" created="Tue, 26 Feb 2019 13:10:05 +0000"  >&lt;p&gt;PRs on GitHub:&lt;br/&gt;
trunk: &lt;a href=&quot;https://github.com/apache/cassandra/pull/303&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/303&lt;/a&gt;&lt;br/&gt;
3.11: &lt;a href=&quot;https://github.com/apache/cassandra/pull/304&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/304&lt;/a&gt;&lt;br/&gt;
dtest: &lt;a href=&quot;https://github.com/apache/cassandra-dtest/pull/46&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra-dtest/pull/46&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17017459" author="brandon.williams" created="Thu, 16 Jan 2020 20:27:21 +0000"  >&lt;p&gt;Needs some very minor rebasing now, but +1.&lt;/p&gt;</comment>
                            <comment id="17027303" author="snazy" created="Fri, 31 Jan 2020 09:15:40 +0000"  >&lt;p&gt;Thanks for the review!&lt;/p&gt;

&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/ffab2b8dde0c7c40080c1c0b36831edd6965a042&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ffab2b8dde0c7c40080c1c0b36831edd6965a042&lt;/a&gt; to &lt;a href=&quot;https://github.com/apache/cassandra/tree/cassandra-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;cassandra-3.11&lt;/a&gt;, &lt;a href=&quot;https://github.com/apache/cassandra/commit/7a7eece9578312a2f9d77de6e0755a3c3c542e99&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;merged&lt;/a&gt; to &lt;a href=&quot;https://github.com/apache/cassandra/tree/trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Committed manually as ffab2b8dde0c7c40080c1c0b36831edd6965a042&lt;br/&gt;
 Merged manually as 7a7eece9578312a2f9d77de6e0755a3c3c542e99&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/ffab2b8dde0c7c40080c1c0b36831edd6965a042&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest committed&lt;/a&gt; as well&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13181833">CASSANDRA-14673</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13610567">CASSANDRA-20394</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[snazy]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="13161" cascade-level="1"><![CDATA[Unrecoverable Corruption / Loss]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 41 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z003fc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12343577">3.11.4</customfieldvalue>
    <customfieldvalue id="12336842">4.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>dimitarndimitrov</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
        <customfieldvalue><![CDATA[snazy]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12335055">3.6</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/ffab2b8dde0c7c40080c1c0b36831edd6965a042&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/ffab2b8dde0c7c40080c1c0b36831edd6965a042&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>