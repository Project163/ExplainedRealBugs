<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:30:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-17298] Improve accuracy of memtable heap usage tracking</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-17298</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-4.0/313/testReport/org.apache.cassandra.cql3/MemtableSizeTest/testTruncationReleasesLogSpace_2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/job/Cassandra-4.0/313/testReport/org.apache.cassandra.cql3/MemtableSizeTest/testTruncationReleasesLogSpace_2/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;Failed 4 times in the last 30 runs. Flakiness: 27%, Stability: 86%&lt;br/&gt;
Error Message&lt;br/&gt;
Expected heap usage close to 49.930MiB, got 41.542MiB.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Stacktrace
junit.framework.AssertionFailedError: Expected heap usage close to 49.930MiB, got 41.542MiB.

	at org.apache.cassandra.cql3.MemtableSizeTest.testSize(MemtableSizeTest.java:130)
	at org.apache.cassandra.Util.runCatchingAssertionError(Util.java:644)
	at org.apache.cassandra.Util.flakyTest(Util.java:669)
	at org.apache.cassandra.cql3.MemtableSizeTest.testTruncationReleasesLogSpace(MemtableSizeTest.java:61)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
&#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;UPDATE:&lt;/b&gt; It was discovered that unit tests were running with memtable_allocation_type: offheap_objects when we ship C* with heap_buffers.&lt;br/&gt;
So we changed that in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19326&quot; title=&quot;Switch memtable_allocation_type from offheap_objects to heap_buffers in test/conf/cassandra.yaml&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19326&quot;&gt;&lt;del&gt;CASSANDRA-19326&lt;/del&gt;&lt;/a&gt;, now we test with memtable_allocation_type: heap_buffers. As a result, this test now fails all the time on 4.0 and 4.1. &lt;/p&gt;</description>
                <environment></environment>
        <key id="13424987">CASSANDRA-17298</key>
            <summary>Improve accuracy of memtable heap usage tracking</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dnk">Dmitry Konstantinov</assignee>
                                    <reporter username="jmckenzie">Josh McKenzie</reporter>
                        <labels>
                    </labels>
                <created>Wed, 26 Jan 2022 17:42:06 +0000</created>
                <updated>Fri, 10 Oct 2025 08:47:54 +0000</updated>
                            <resolved>Tue, 10 Sep 2024 09:23:49 +0000</resolved>
                                        <fixVersion>4.0.14</fixVersion>
                    <fixVersion>4.1.7</fixVersion>
                    <fixVersion>5.0.1</fixVersion>
                    <fixVersion>5.1</fixVersion>
                                    <component>Test/unit</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4800">1h 20m</timespent>
                                <comments>
                            <comment id="17815684" author="paulo" created="Thu, 8 Feb 2024 13:48:49 +0000"  >&lt;p&gt;Looks like this is failing consistently in both 4.0/4.1:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://butler.cassandra.apache.org/#/ci/upstream/compare/Cassandra-4.0/cassandra-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://butler.cassandra.apache.org/#/ci/upstream/compare/Cassandra-4.0/cassandra-4.0&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://butler.cassandra.apache.org/#/ci/upstream/compare/Cassandra-4.0/cassandra-4.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://butler.cassandra.apache.org/#/ci/upstream/compare/Cassandra-4.0/cassandra-4.1&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=e.dimitrova&quot; class=&quot;user-hover&quot; rel=&quot;e.dimitrova&quot;&gt;e.dimitrova&lt;/a&gt; I wonder if this should&apos;ve been addressed by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16684&quot; title=&quot;Flaky MemtableSizeTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16684&quot;&gt;&lt;del&gt;CASSANDRA-16684&lt;/del&gt;&lt;/a&gt; or if it&apos;s a new issue. I am able to reproduce the failure locally on cassandra-4.1, even after increasing rerunsOnFailure from 2 to 4.&lt;/p&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.AssertionError: Expected heap usage close to 75.335MiB, got 71.163MiB.
    at org.junit.Assert.fail(Assert.java:88)
&#160; &#160; at org.junit.Assert.assertTrue(Assert.java:41)
&#160; &#160; at org.apache.cassandra.cql3.MemtableSizeTest.testSizeFlaky(MemtableSizeTest.java:149)
&#160; &#160; at org.apache.cassandra.Util.runCatchingAssertionError(Util.java:696)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17815741" author="edimitrova" created="Thu, 8 Feb 2024 16:01:47 +0000"  >&lt;p&gt;Hey, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paulo&quot; class=&quot;user-hover&quot; rel=&quot;paulo&quot;&gt;paulo&lt;/a&gt; - the short answer is this is new - the constant failures since last week. &lt;br/&gt;
Now, the details &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;br/&gt;
It was discovered that unit tests were running with memtable_allocation_type: offheap_objects  when we ship C* with heap_buffers.&lt;br/&gt;
So we changed that in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19326&quot; title=&quot;Switch memtable_allocation_type from offheap_objects to heap_buffers in test/conf/cassandra.yaml&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19326&quot;&gt;&lt;del&gt;CASSANDRA-19326&lt;/del&gt;&lt;/a&gt;, now we test with memtable_allocation_type: heap_buffers. As a result, this test now fails all the time. I will now mark tickets 4.0 and 4.1 and this additional information for awareness. I discovered the new failures yesterday but did not find this ticket. We were considering opening a new one with Jacek.&lt;/p&gt;</comment>
                            <comment id="17842726" author="dcapwell" created="Wed, 1 May 2024 17:36:33 +0000"  >&lt;p&gt;This fails for me as well, but when I run locally on JDK 11 I get the following error&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: FSReadError in /Users/dcapwell/src/github/apache/cassandra/4.0/build/test/cassandra/data/system/local-7ad54392bcdd35a684174e047860b377
	at org.apache.cassandra.db.lifecycle.LogReplica.create(LogReplica.java:59)
...
Caused by: java.io.IOException: Invalid folder descriptor trying to create log replica /Users/dcapwell/src/github/apache/cassandra/4.0/build/test/cassandra/data/system/local-7ad54392bcdd35a684174e047860b377
	... 26 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But in CI it fails differently&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 java.lang.reflect.InaccessibleObjectException: Unable to make field &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; jdk.internal.platform.CgroupV1Metrics jdk.internal.platform.CgroupV1MetricsImpl.metrics accessible: module java.base does not &lt;span class=&quot;code-quote&quot;&gt;&quot;opens jdk.internal.platform&quot;&lt;/span&gt; to unnamed module @f79e
	at java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:340)
	at java.base/java.lang.reflect.AccessibleObject.checkCanSetAccessible(AccessibleObject.java:280)
	at java.base/java.lang.reflect.Field.checkCanSetAccessible(Field.java:176)
	at java.base/java.lang.reflect.Field.setAccessible(Field.java:170)
	at org.github.jamm.MemoryMeter.addFieldChildren(MemoryMeter.java:330)
	at org.github.jamm.MemoryMeter.measureDeep(MemoryMeter.java:269)
	at org.apache.cassandra.utils.ObjectSizes.measureDeep(ObjectSizes.java:216)
	at org.apache.cassandra.cql3.MemtableSizeTest.testSize(MemtableSizeTest.java:121)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Trying to merge &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19182&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-19182&lt;/a&gt; but its not clean so trying to make sure everything is known...&lt;/p&gt;</comment>
                            <comment id="17842731" author="edimitrova" created="Wed, 1 May 2024 18:07:18 +0000"  >&lt;p&gt;I don&apos;t know about the local error you get, but this is about the one you see in CI:&lt;/p&gt;

&lt;p&gt;4.0 and 4.1 use the old version of jamm where there were issues with the crawling, so I am not surprised measureDeep hit closed module. This cannot be related to your patch. It is jamm issue.&lt;/p&gt;</comment>
                            <comment id="17842927" author="jmckenzie" created="Thu, 2 May 2024 10:40:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;when I run locally&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Locally in intellij or locally from console? I ask because on my JDK21 work, I have a failure in `MemtableQuickTest` that&apos;s passing in IDE and failing from console. Since it looks like they source their runtime env params from different locations I&apos;m starting to suspect drift there.&lt;/p&gt;

&lt;p&gt;Also seen some other jamm related issues but they&apos;re known issues on other JIRA tickets as well, so I wouldn&apos;t be surprised if you were wrestling with or seeing something there as well - matches w/what you&apos;re seeing in CI.&lt;/p&gt;</comment>
                            <comment id="17877179" author="dcapwell" created="Tue, 27 Aug 2024 20:51:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;Locally in intellij or locally from console?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t remember so going to say IntelliJ =)&lt;/p&gt;</comment>
                            <comment id="17877181" author="dnk" created="Tue, 27 Aug 2024 20:55:30 +0000"  >&lt;p&gt;Hi, I have faced the issue (a big discrepancy between actual and expected heap size) with the test several times when committed other changes, so I decided to volunteer &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; and have spent some time to analyze it in more details. &lt;br/&gt;
Please find below the results of the analysis.&lt;/p&gt;

&lt;p&gt;There are several aspects which contribute to the issue:&lt;br/&gt;
1) The memtable actual size is measured using ObjectSizes.measureDeep(memtable). A memtable object has several references which go beyond Memtable scope:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
(org.apache.cassandra.db.Memtable) memtable
  (org.apache.cassandra.db.ColumnFamilyStore) cfs
    (org.apache.cassandra.db.Keyspace) keyspace &amp;lt;-------- has references to all tables in the same keyspace
  (org.apache.cassandra.utils.memory.SlabAllocator) allocator
    (org.apache.cassandra.utils.memory.MemtableAllocator$SubAllocator) onHeap
    ---- the boundary between memtable specific allocator objects and global memory pool objects ----
      (org.apache.cassandra.utils.memory.MemtablePool$SubPool) parent
        (org.apache.cassandra.utils.memory.SlabPool) &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;$0
          (org.apache.cassandra.utils.memory.MemtableCleanerThread) cleaner
            (java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;) thread
              (java.lang.&lt;span class=&quot;code-object&quot;&gt;ThreadGroup&lt;/span&gt;) group
                (java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[]) threads &lt;span class=&quot;code-comment&quot;&gt;// references to almost all Cassandra threads, then to thread-locals, etc
&lt;/span&gt;                (java.lang.&lt;span class=&quot;code-object&quot;&gt;ThreadGroup&lt;/span&gt;) parent
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;so, when we measure heap size of memtable object through Memtable.cfs and SubAllocator.parent references we also count non-related and dynamically changed amount of memory. When we run a test several times to fight with flakiness without cleanup the impact is even increasing - we implicitly observe memory allocations related to the previous runs.&lt;br/&gt;
To avoid this issue we can ask jamm Meter to ignore the correspondent objects using @Unmetered annotation on the related fields.&lt;br/&gt;
Also, it makes sense to drop the table after the test to cleanup memory.&lt;/p&gt;

&lt;p&gt;2) heap_buffers memtable allocation type uses 1Mb shared byte array slabs to store partition key, clustering keys and cell values.&lt;br/&gt;
The free part of such slab is not counted as owned by MemtableAllocator logic but it is measured by ObjectSizes.measureDeep(memtable) due to an existence of reference path from Memtable via allocator the the .&lt;br/&gt;
There are two possible ways to deal with it: &lt;br/&gt;
a) doesn&apos;t measure Memtable.allocator object at all&lt;br/&gt;
b) add a slab size to the allowed difference assertion between MemtableAllocator reported value and ObjectSizes.measureDeep(memtable) value&lt;br/&gt;
My own preference is a) because:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;MemtableAllocator does not consider the slab free space as used and we actually test correctness of MemtableAllocator tracking by this test&lt;/li&gt;
	&lt;li&gt;adding such 1Mb difference decreases the accuracy of assertion and may hide other issues&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;NOTE:&lt;br/&gt;
4.0.x ObjectSizes uses jamm-0.3.2 with omitSharedBufferOverhead option --&amp;gt; the shared byte[] slab is NOT counted by Meter in ObjectSizes.&lt;br/&gt;
4.1.x ObjectSizes uses jamm-0.3.2 withOUT omitSharedBufferOverhead option --&amp;gt; the shared byte[] slab is counted by Meter in ObjectSizes.&lt;/p&gt;

&lt;p&gt;The related change in 4.1 branch for ObjectSizes (&lt;a href=&quot;https://github.com/apache/cassandra/commits/cassandra-4.1/src/java/org/apache/cassandra/utils/ObjectSizes.java):&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commits/cassandra-4.1/src/java/org/apache/cassandra/utils/ObjectSizes.java):&lt;/a&gt; &lt;a href=&quot;https://github.com/apache/cassandra/commit/0d8126dd143898588f4efcdc40b8e2bb10597185#diff-1122d7d3efe9721af7244d373e66378f7e90cb05fd65859a52e8a3ea58a7c8f9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/0d8126dd143898588f4efcdc40b8e2bb10597185#diff-1122d7d3efe9721af7244d373e66378f7e90cb05fd65859a52e8a3ea58a7c8f9&lt;/a&gt;&lt;br/&gt;
omitSharedBufferOverhead() is removed&lt;/p&gt;

&lt;p&gt;So, to not measure the whole slab array in case of&#160; 4.1.x branch a separate Meter needs to be configured for MemtableSizeTest&lt;/p&gt;

&lt;p&gt;3) The most interesting part - the precision of memtable heap tracking. I have applied the following approach to find the missed parts.&lt;br/&gt;
To see the actual memory structure I have dumped few partitions for each write type (insert/delete partition/delete row) as a tree using MemoryMeter with enabled debug:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
MemoryMeter meter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MemoryMeter().omitSharedBufferOverhead()
                                     .withGuessing(MemoryMeter.Guess.FALLBACK_UNSAFE)
                                     .ignoreKnownSingletons()
                                     .enableDebug();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;While it does not print aggregated memory usage accurately (it does not reflect in the printing a memory used from the shared buffers) it allows to see the object graph and size of objects themselves:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
root [org.apache.cassandra.db.partitions.AtomicBTreePartition] 632 bytes (32 bytes)
  |
  +--ref [org.apache.cassandra.db.partitions.AbstractBTreePartition$Holder] 504 bytes (32 bytes)
  |  |
  |  +--columns [org.apache.cassandra.db.RegularAndStaticColumns] 48 bytes (24 bytes)
  |  |  |
  |  |  +--statics [org.apache.cassandra.db.Columns] 24 bytes (24 bytes)
  |  |
  |  +--deletionInfo [org.apache.cassandra.db.MutableDeletionInfo] 24 bytes (24 bytes)
  |  |
  |  +--tree [java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]] 200 bytes (24 bytes)
  |  |  |
  |  |  +--0 [org.apache.cassandra.db.rows.BTreeRow] 176 bytes (32 bytes)
  |  |    |
  |  |    +--clustering [org.apache.cassandra.db.BufferClustering] 96 bytes (24 bytes)
  |  |    |  |
  |  |    |  +--values [java.nio.ByteBuffer[]] 72 bytes (24 bytes)
  |  |    |    |
  |  |    |    +--0 [java.nio.HeapByteBuffer] 48 bytes (48 bytes)
  |  |    |
  |  |    +--deletion [org.apache.cassandra.db.rows.Row$Deletion] 48 bytes (24 bytes)
  |  |      |
  |  |      +--time [org.apache.cassandra.db.DeletionTime] 24 bytes (24 bytes)
  |  |
  |  +--staticRow [org.apache.cassandra.db.rows.BTreeRow] 168 bytes (32 bytes)
  |  |  |
  |  |  +--clustering [org.apache.cassandra.db.Clustering$1] 40 bytes (24 bytes)
  |  |  |  |
  |  |  |  +--values [java.nio.ByteBuffer[]] 16 bytes (16 bytes)
  |  |  |
  |  |  +--primaryKeyLivenessInfo [org.apache.cassandra.db.LivenessInfo] 24 bytes (24 bytes)
  |  |  |
  |  |  +--deletion [org.apache.cassandra.db.rows.Row$Deletion] 48 bytes (24 bytes)
  |  |  |  |
  |  |  |  +--time [org.apache.cassandra.db.DeletionTime] 24 bytes (24 bytes)
  |  |  |
  |  |  +--btree [java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]] 24 bytes (24 bytes)
  |  |
  |  +--stats [org.apache.cassandra.db.rows.EncodingStats] 32 bytes (32 bytes)
  |
  +--partitionKey [org.apache.cassandra.db.BufferDecoratedKey] 96 bytes (24 bytes)
    |
    +--key [java.nio.HeapByteBuffer] 48 bytes (48 bytes)
    |
    +--token [org.apache.cassandra.dht.Murmur3Partitioner$LongToken] 24 bytes (24 bytes)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Based on this input and source code analysis we can get a visual representation of the partitions and count manually the amount of used memory.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13071125/13071125_structure_example.svg&quot; title=&quot;structure_example.svg attached to CASSANDRA-17298&quot;&gt;structure_example.svg&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;As the second step I added temporary a tracing of records to the allocator tracking logic to see which values and where are counted by MemtableAllocator during a put operation, like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.utils.memory.MemtableAllocator.SubAllocator {

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ThreadLocal&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;&amp;gt; tracing = ThreadLocal.withInitial(() -&amp;gt; &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.FALSE);
....

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void allocated(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; size)
{
    parent.allocated(size);
    reportChange(size); &amp;lt;==== added
    ownsUpdater.addAndGet(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, size);

    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (state == LifeCycle.DISCARDING)
    {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (logger.isTraceEnabled())
            logger.trace(&lt;span class=&quot;code-quote&quot;&gt;&quot;Allocated {} bytes whilst discarding&quot;&lt;/span&gt;, size);
        updateReclaiming();
    }
}

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void reportChange(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; delta) {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (tracing.get())
            {
                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;ALLOCATOR: &quot;&lt;/span&gt; + delta);
                &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Exception().printStackTrace(&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out);
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&quot;tracing&quot; thread-local is used to print such information only for an analyzed memtable&lt;br/&gt;
Similar tracing was added temporary to org.apache.cassandra.db.partitions.AtomicBTreePartition.RowUpdater as well.&lt;br/&gt;
The output looks like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ALLOCATOR: 8
java.lang.Exception
   at org.apache.cassandra.utils.memory.MemtableAllocator$SubAllocator.reportChange(MemtableAllocator.java:226)
   at org.apache.cassandra.utils.memory.MemtableAllocator$SubAllocator.acquired(MemtableAllocator.java:238)
   at org.apache.cassandra.utils.memory.MemtableAllocator$SubAllocator.allocate(MemtableAllocator.java:179)
   at org.apache.cassandra.utils.memory.SlabAllocator.allocate(SlabAllocator.java:89)
   at org.apache.cassandra.utils.memory.MemtableBufferAllocator$1.allocate(MemtableBufferAllocator.java:40)
   at org.apache.cassandra.utils.memory.ByteBufferCloner.clone(ByteBufferCloner.java:77)
   at org.apache.cassandra.utils.memory.ByteBufferCloner.clone(ByteBufferCloner.java:63)
   at org.apache.cassandra.db.Clustering.clone(Clustering.java:53)
   at org.apache.cassandra.utils.memory.ByteBufferCloner.clone(ByteBufferCloner.java:52)
   at org.apache.cassandra.db.rows.BTreeRow.clone(BTreeRow.java:505)
   at org.apache.cassandra.db.partitions.AtomicBTreePartition$RowUpdater.insert(AtomicBTreePartition.java:376)
   at org.apache.cassandra.db.partitions.AtomicBTreePartition$RowUpdater.insert(AtomicBTreePartition.java:352)
   at org.apache.cassandra.utils.btree.BTree.transformLeaf(BTree.java:1308)
   at org.apache.cassandra.utils.btree.BTree.transform(BTree.java:1255)
   at org.apache.cassandra.utils.btree.BTree.update(BTree.java:353)
   at org.apache.cassandra.db.partitions.AtomicBTreePartition.addAllWithSizeDeltaInternal(AtomicBTreePartition.java:147)
   at org.apache.cassandra.db.partitions.AtomicBTreePartition.addAllWithSizeDelta(AtomicBTreePartition.java:191)
   at org.apache.cassandra.db.Memtable.put(Memtable.java:327)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;As a result for a single put operation we can observe how does memory tracking works, with stack traces to the points where it is happening.&lt;br/&gt;
I have used this information and put marks on the object graph picture created on the previous step.&lt;br/&gt;
It allows to see the discrepancies - what objects are not counted correctly.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13071126/13071126_analyzed_objects.svg&quot; title=&quot;analyzed_objects.svg attached to CASSANDRA-17298&quot;&gt;analyzed_objects.svg&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_green.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; So, there are the following discrepancies found:&lt;br/&gt;
1) we do not count ByteBuffer BufferDecoratedKey.key, it is supposed to be counted by Memtable.estimateRowOverhead method logic but estimateRowOverhead puts ByteBufferUtil.EMPTY_BYTE_BUFFER with size = 0 to the field. Cloning of BufferDecoratedKey does not help, we still have the same object returned by org.apache.cassandra.utils.memory.ByteBufferCloner#clone(V, org.apache.cassandra.db.marshal.ValueAccessor&amp;lt;V&amp;gt;).&lt;br/&gt;
So, when we measure ConcurrentSkipListMap deep size in estimateRowOverhead we have the same ByteBufferUtil.EMPTY_BYTE_BUFFER object used and it is counted only once. To avoid this issue we should allocate a buffer of non-zero size in Memtable.estimateRowOverhead.&lt;/p&gt;

&lt;p&gt;2) Columns (under RegularAndStaticColumns) stores ColumnMetadata in btree structure (Object[]) but the cost of this structure is not counted.&lt;br/&gt;
To fix the issue BTree.sizeOfStructureOnHeap(columns) should be added to org.apache.cassandra.db.Columns#unsharedHeapSize&lt;/p&gt;

&lt;p&gt;3) Container for cells = BTreeRow.btree is EMPTY_LEAF when we delete a row, EMPTY_LEAF is a shared singleton but org.apache.cassandra.utils.btree.BTree#sizeOfStructureOnHeap used in org.apache.cassandra.db.rows.BTreeRow#unsharedHeapSizeExcludingData&lt;br/&gt;
to measure size of this structure does not check usage of EMPTY_LEAF and incorrectly reports a non-zero size for this Object[] array value.&lt;br/&gt;
To fix this issue a check for EMPTY_LEAF value should be added to BTree#sizeOfStructureOnHeap&lt;/p&gt;

&lt;p&gt;By combining of these changes together I have got about 1 byte of difference per partition between measured and allocator reported values.&lt;br/&gt;
When I found the exact places in the code I have compared them with 5.0 code and found the following commit by () - &lt;a href=&quot;https://github.com/apache/cassandra/commit/49e0c61107005b1a83799f7f1e6c0a855d159c29&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/49e0c61107005b1a83799f7f1e6c0a855d159c29&lt;/a&gt; done as a part of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17240&quot; title=&quot;CEP-19: Trie memtable implementation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17240&quot;&gt;&lt;del&gt;CASSANDRA-17240&lt;/del&gt;&lt;/a&gt; story. So, it looks like I independently have come to the same conclusions as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt;&#160; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;

&lt;p&gt;I have aggregated the changes to MRs for 4.0 and 4.1:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3503&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3503&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3504&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3504&lt;/a&gt;&#160;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/help_16.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; An open question: there are two very similar methods: BTree.sizeOnHeapOf vs BTree.sizeOfStructureOnHeap used in the code.&lt;br/&gt;
The difference is only in measuring of sizeOfArray(sizeMap(tree)). I wonder why do we need sizeOfStructureOnHeap.., especially taking in account what we use sizeOnHeapOf to measure Holder.btree memory usage (in Object[] tree = BTree.update(current.tree, update.holder().tree, update.metadata().comparator, updater)). So, in one case we use sizeOfStructureOnHeap and in another - sizeOnHeapOf for the same kind of logic..&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; sizeOfStructureOnHeap(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] tree)
    {
        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; size = ObjectSizes.sizeOfArray(tree);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isLeaf(tree))
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; size;
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = getChildStart(tree); i &amp;lt; getChildEnd(tree); i++)
            size += sizeOfStructureOnHeap((&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) tree[i]);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; size;
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; sizeOnHeapOf(&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[] tree)
    {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isEmpty(tree))
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; 0;
        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; size = ObjectSizes.sizeOfArray(tree);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isLeaf(tree))
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; size;
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = childOffset(tree); i &amp;lt; childEndOffset(tree); i++)
            size += sizeOnHeapOf((&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]) tree[i]);
        size += ObjectSizes.sizeOfArray(sizeMap(tree)); &lt;span class=&quot;code-comment&quot;&gt;// may overcount, since we share size maps
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; size;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17877183" author="dnk" created="Tue, 27 Aug 2024 20:58:52 +0000"  >&lt;p&gt;Sample test output with the changes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;4.0
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INFO  [main] 2024-08-27 00:04:08,955 MemtableSizeTest.java:135 - Expected heap usage close to 75.169MiB, got 75.231MiB. Delta per partition: 1.00 bytes
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;4.1
	&lt;ul&gt;
		&lt;li&gt;skiplist
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INFO &#160;[main] 2024-08-27 18:33:14,115 MemtableSizeTest.java:154 - Expected heap usage close to 75.168MiB, got 75.231MiB. Delta per partition: 1.01 bytes. &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
		&lt;li&gt;skiplist_sharded
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INFO  [main] 2024-08-27 18:33:26,606 MemtableSizeTest.java:154 - Expected heap usage close to 75.170MiB, got 75.231MiB. Delta per partition: 0.98 bytes.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17877296" author="blambov" created="Wed, 28 Aug 2024 09:03:32 +0000"  >&lt;p&gt;Thank you for the very detailed investigation.&lt;/p&gt;

&lt;p&gt;This has been a source of annoyance, with many attempts to fix since the test was first introduced, but it&apos;s necessary because before the test we had reached about 2x difference between the memtable&apos;s understanding of its on-heap size and what it actually used. One consideration we&apos;ve previously had around this is that adjusting the memory usage reporting may cause memtables to flush earlier and change the behavior of existing clusters too much for a patch release. In this case it looks like the difference is on the order of 10%, which I personally would not see as a problem.&lt;/p&gt;

&lt;p&gt;I wonder if it we shouldn&apos;t backport most of that 5.0 patch so that we start testing all allocation strategies in 4.x as well. Also, am I understanding correctly that there is also something (EMPTY_LEAF?) that we are not tracking correctly in 5.0?&lt;/p&gt;

&lt;p&gt;On the open question, there may be a reason to use both  &lt;tt&gt;BTree.sizeOnHeapOf&lt;/tt&gt; and &lt;tt&gt;BTree.sizeOfStructureOnHeap&lt;/tt&gt; (e.g. some BTree-building methods always share the size map, others never, and if the caller knows which one it is it could choose between the two). From a quick glance it looks like we use the latter version for &lt;tt&gt;Columns&lt;/tt&gt;, and these are built from sorted using shared size maps, thus this appears to be the right thing to do. However, the names of the two methods should reflect this difference and they it should also be explained in javaDoc.&lt;/p&gt;</comment>
                            <comment id="17877305" author="dnk" created="Wed, 28 Aug 2024 09:35:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;it&apos;s necessary because before the test we had reached about 2x difference between the memtable&apos;s understanding of its on-heap size and what it actually used.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, no doubts here - I looked though the history: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16318&quot; title=&quot;Memtable heap size is severely underestimated&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16318&quot;&gt;&lt;del&gt;CASSANDRA-16318&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18125&quot; title=&quot;Improve memtable allocator accounting when updating AtomicBTreePartition&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18125&quot;&gt;&lt;del&gt;CASSANDRA-18125&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I wonder if it we shouldn&apos;t backport most of that 5.0 patch so that we start testing all allocation strategies in 4.x as well.&#160;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes, I thought about it as well, just worried to not make the change too big. I will backport testing of other allocation strategies to the MRs.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;ll. Also, am I understanding correctly that there is also something (EMPTY_LEAF?) that we are not tracking correctly in 5.0?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No, as of now I have not found anything to fix in 5.0.&lt;/p&gt;

&lt;p&gt;EMPTY_LEAF fix is here: &lt;a href=&quot;https://github.com/apache/cassandra/commit/49e0c61107005b1a83799f7f1e6c0a855d159c29#diff-f937f7e20079a198fac440e91b60acac76125e75f55ea01da912f66581d5846e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/49e0c61107005b1a83799f7f1e6c0a855d159c29#diff-f937f7e20079a198fac440e91b60acac76125e75f55ea01da912f66581d5846e&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In future I have a plan to add (as a separate improvement ticket) more tests to 5.0 about changing of existing rows (the current tests are focused on measuring of inserted elements and does not cover the adjustment cases when an existing partition object is updated like row update or a row insert and then removal - it is tricker to test due to slabs usage but this area may still have some hidden issues).&#160;&lt;/p&gt;</comment>
                            <comment id="17877703" author="dnk" created="Thu, 29 Aug 2024 13:07:19 +0000"  >&lt;p&gt;I have updated the MRs:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3503&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3503&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3504&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3504&lt;/a&gt;&#160;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Changes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Memtable size tests are backported from 5.0
	&lt;ul&gt;
		&lt;li&gt;all allocation types are tested now&lt;/li&gt;
		&lt;li&gt;skiplist memtable type is tested for 4.0&lt;/li&gt;
		&lt;li&gt;skiplist + sharded skiplist are tested for 4.1&lt;/li&gt;
		&lt;li&gt;printing of avg difference per partition is added compared to the original 5.0 tests - it is easier to interpret&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;sizeOfStructureOnHeap is used now in Columns (compared to my original commit)&lt;/li&gt;
	&lt;li&gt;using the backported test I have found one more issue in Memtable.estimateRowOverhead logic for MemtableAllocationType.unslabbed_heap_buffers: it did not include heap usage for byte array object header&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Can somebody help with review?&lt;/p&gt;</comment>
                            <comment id="17878003" author="blambov" created="Fri, 30 Aug 2024 07:51:05 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;Both patches look good to me.&lt;/p&gt;</comment>
                            <comment id="17879918" author="smiklosovic" created="Fri, 6 Sep 2024 16:30:21 +0000"  >&lt;p&gt;I am on it.&lt;/p&gt;</comment>
                            <comment id="17880020" author="smiklosovic" created="Sat, 7 Sep 2024 08:25:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dnk&quot; class=&quot;user-hover&quot; rel=&quot;dnk&quot;&gt;dnk&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I am not completely sure how this works but looking at it on face value, the logic in Memtable / SkipListMemtable is dealing with &quot;new LongToken(0)&quot; and similar. LongToken is logically related to Murmur3Partitioner. There are diffrent implementations of abstract Token based on what partitioner is used so I wonder how is this logic behaving when we use different partitioner from Murmur3? That stuff wont be valid anymore, would it?&lt;/p&gt;</comment>
                            <comment id="17880021" author="dnk" created="Sat, 7 Sep 2024 08:49:11 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt; ,&#160;&lt;/p&gt;

&lt;p&gt;The measured memtable overhead (calculated by estimateRowOverhead) does not include Token heap size. We measure the deep size of ConcurrentSkipListMap object including BufferDecoratedKey with LongToken but later we subtract the heap size for used Token object, so the result overhead does not include it.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0 ; i &amp;lt; count ; i++)
    partitions.put(cloner.clone(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BufferDecoratedKey(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LongToken(i), ByteBuffer.allocate(testBufferSize))), val); &lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;-- here it is counted
&lt;/span&gt;
rowOverhead -= &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LongToken(0).getHeapSize();  &lt;span class=&quot;code-comment&quot;&gt;// here we remove it from the result overhead&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The actual Token object heap size (for the real implementation) is added later when we put actual data into a memtable (org.apache.cassandra.db.memtable.SkipListMemtable#put):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; overhead = (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) (cloneKey.getToken().getHeapSize() + ROW_OVERHEAD_HEAP_SIZE); &lt;span class=&quot;code-comment&quot;&gt;// here we use the actual token heap size &lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Technically, we can allocate Tokens in the overhead measuring logic using DatabaseDescriptor.getPartitioner().getToken() but the result should be the same due to the described reason.&lt;/p&gt;</comment>
                            <comment id="17880024" author="smiklosovic" created="Sat, 7 Sep 2024 09:38:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dnk&quot; class=&quot;user-hover&quot; rel=&quot;dnk&quot;&gt;dnk&lt;/a&gt; &lt;a href=&quot;https://github.com/netudima/cassandra/pull/1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netudima/cassandra/pull/1&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;I tested manually that it works with other partitioners as well (OrderPreservingPartitioner, ByteOrderedPartitioner ...).&lt;/p&gt;</comment>
                            <comment id="17880025" author="smiklosovic" created="Sat, 7 Sep 2024 09:46:37 +0000"  >&lt;p&gt;I get that it probably does not matter in this particular case but we should just get rid of the specific LongToken. It should be coded in a generic-enough way so whatever partitioner we use the code will reflect that otherwise other people will start to look at this in the future trying to figure out &lt;em&gt;why LongToken exactly&lt;/em&gt;? You feel me ... &lt;/p&gt;</comment>
                            <comment id="17880033" author="dnk" created="Sat, 7 Sep 2024 11:26:33 +0000"  >&lt;p&gt;yes, no concerns here, it makes sense, I will apply the same changes in MR for 4.1&lt;/p&gt;</comment>
                            <comment id="17880034" author="dnk" created="Sat, 7 Sep 2024 11:43:25 +0000"  >&lt;p&gt;MRs are updated.&lt;/p&gt;</comment>
                            <comment id="17880037" author="smiklosovic" created="Sat, 7 Sep 2024 12:25:45 +0000"  >&lt;p&gt;I run this branch (1) in the multiplexer (2). It is basically your stuff + mine you just merged and all squashed into 1  commit. Multiplexer works in such a way that it will run all tests which we modified or added 500 times (by default) to rule out any flakes.&lt;/p&gt;

&lt;p&gt;You see that some jobs passed and some not. I have 25 containers and 500 tests, that means that each container runs all tests 20 times. These failed (3). &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
junit.framework.AssertionFailedError: Expected heap usage close to 85.836MiB, got 78.878MiB, 6.957MiB difference. Delta per partition: 112.24 bytes
	at org.apache.cassandra.db.memtable.MemtableSizeTestBase.testSize(MemtableSizeTestBase.java:178)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It is always org.apache.cassandra.db.memtable.MemtableSizeOffheapBuffersTest.&lt;/p&gt;

&lt;p&gt;(1) &lt;a href=&quot;https://github.com/instaclustr/cassandra/commits/CASSANDRA-17298-4.0/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/instaclustr/cassandra/commits/CASSANDRA-17298-4.0/&lt;/a&gt;&lt;br/&gt;
(2) &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/4675/workflows/a548e71f-605c-4acf-bb78-f42d59a6e48d/jobs/269136/steps&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/instaclustr/cassandra/4675/workflows/a548e71f-605c-4acf-bb78-f42d59a6e48d/jobs/269136/steps&lt;/a&gt;&lt;br/&gt;
(3) &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/4675/workflows/a548e71f-605c-4acf-bb78-f42d59a6e48d/jobs/269136/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/instaclustr/cassandra/4675/workflows/a548e71f-605c-4acf-bb78-f42d59a6e48d/jobs/269136/tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17880039" author="dnk" created="Sat, 7 Sep 2024 12:41:55 +0000"  >&lt;p&gt;Thank you for running the tests! I am checking the logs..&lt;/p&gt;</comment>
                            <comment id="17880116" author="dnk" created="Sun, 8 Sep 2024 11:52:41 +0000"  >&lt;p&gt;As of now I cannot reproduce it locally (MacOS), I have executed a similar logic (without a container) 200 times using AdoptOpenJDK 1.8.0_265 and 200 times using AdoptOpenJDK-11.0.11 but all of the runs were successful:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
count=200
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; i in $(seq -w 1 $count)
&lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt;
  echo &lt;span class=&quot;code-quote&quot;&gt;&quot;Running test org.apache.cassandra.db.memtable.MemtableSizeOffheapBuffersTest, iteration $i of $count&quot;&lt;/span&gt;
  ant testsome -Dtest.name=org.apache.cassandra.db.memtable.MemtableSizeOffheapBuffersTest -Dno-build-test=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  mkdir build/repeated_tests/$i
  mv build/test/output/TEST-org.apache.cassandra.db.memtable.MemtableSizeOffheapBuffersTest.xml build/repeated_tests/$i
done
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Observations based on the provided logs: there is a fluctuation in the memory measured within the test using MemoryMeter.measureDeep(memtable). In successful scenarios on CI (as well as locally in my case) it is ~79MiB. In case of a failure it is has a higher value like ~86MiB:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[junit-timeout] INFO  [main] 2024-09-07 12:03:39,024 MemtableSizeTestBase.java:176 - Expected heap usage close to 78.755MiB, got 78.754MiB, 0.797KiB difference. Delta per partition: 0.01 bytes
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[junit-timeout] INFO  [main] 2024-09-07 12:03:58,623 MemtableSizeTestBase.java:176 - Expected heap usage close to 85.836MiB, got 78.878MiB, 6.957MiB difference. Delta per partition: 112.24 bytes
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The value reported by Allocator logic (it is what we actually test) is consistent across all runs.&lt;/p&gt;

&lt;p&gt;Taking in account that the issue happens only for offheap_buffers mode I suspect that the possible cause can be unexpected shared objects which MemoryMeter traversing from DirectByteBuffer objects through &quot;att&quot; and &quot;cleaner&quot; references.&lt;/p&gt;

&lt;p&gt;An experiment which shows that it is possible:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void test() {

    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 10; i++) {
        ByteBuffer byteBuffer = ByteBuffer.allocateDirect(1);
    }

    ByteBuffer byteBuffer = ByteBuffer.allocateDirect(10);

    MemoryMeter meter = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MemoryMeter().withGuessing(MemoryMeter.Guess.FALLBACK_UNSAFE)
                                         .enableDebug(100)
                                         &lt;span class=&quot;code-comment&quot;&gt;//.omitSharedBufferOverhead()
&lt;/span&gt;                                         .ignoreNonStrongReferences()
                                         .ignoreKnownSingletons();

    &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(meter.measureDeep(byteBuffer));

} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
root [java.nio.DirectByteBuffer] 1.51 KB (64 bytes)
&#160; |
&#160; +--cleaner [sun.misc.Cleaner] 1.45 KB (40 bytes)
&#160; &#160; |
&#160; &#160; +--next [sun.misc.Cleaner] 1.33 KB (40 bytes)
&#160; &#160; | &#160;|
&#160; &#160; | &#160;+--next [sun.misc.Cleaner] 1.20 KB (40 bytes)
&#160; &#160; | &#160;| &#160;|
&#160; &#160; | &#160;| &#160;+--next [sun.misc.Cleaner] 1.06 KB (40 bytes)
&#160; &#160; | &#160;| &#160;| &#160;|
&#160; &#160; | &#160;| &#160;| &#160;+--next [sun.misc.Cleaner] 952 bytes (40 bytes)
&#160; &#160; | &#160;| &#160;| &#160;| &#160;|
&#160; &#160; | &#160;| &#160;| &#160;| &#160;+--next [sun.misc.Cleaner] 816 bytes (40 bytes)
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;|
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;+--next [sun.misc.Cleaner] 680 bytes (40 bytes)
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;|
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;+--next [sun.misc.Cleaner] 544 bytes (40 bytes)
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;|
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;+--next [sun.misc.Cleaner] 408 bytes (40 bytes)
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;|
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;+--next [sun.misc.Cleaner] 272 bytes (40 bytes)
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;|
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;+--next [sun.misc.Cleaner] 136 bytes (40 bytes)
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;|
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;+--thunk [java.nio.DirectByteBuffer$Deallocator] 32 bytes (32 bytes)
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;|
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;+--referent [java.nio.DirectByteBuffer] 64 bytes (64 bytes)
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;|
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;+--thunk [java.nio.DirectByteBuffer$Deallocator] 32 bytes (32 bytes)
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;|
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;+--referent [java.nio.DirectByteBuffer] 64 bytes (64 bytes)
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;|
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;+--thunk [java.nio.DirectByteBuffer$Deallocator] 32 bytes (32 bytes)
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;|
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;+--referent [java.nio.DirectByteBuffer] 64 bytes (64 bytes)
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;|
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;+--thunk [java.nio.DirectByteBuffer$Deallocator] 32 bytes (32 bytes)
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;|
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;| &#160;+--referent [java.nio.DirectByteBuffer] 64 bytes (64 bytes)
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;|
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;+--thunk [java.nio.DirectByteBuffer$Deallocator] 32 bytes (32 bytes)
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;|
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;| &#160;+--referent [java.nio.DirectByteBuffer] 64 bytes (64 bytes)
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;|
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;+--thunk [java.nio.DirectByteBuffer$Deallocator] 32 bytes (32 bytes)
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;|
&#160; &#160; | &#160;| &#160;| &#160;| &#160;| &#160;+--referent [java.nio.DirectByteBuffer] 64 bytes (64 bytes)
&#160; &#160; | &#160;| &#160;| &#160;| &#160;|
&#160; &#160; | &#160;| &#160;| &#160;| &#160;+--thunk [java.nio.DirectByteBuffer$Deallocator] 32 bytes (32 bytes)
&#160; &#160; | &#160;| &#160;| &#160;| &#160;|
&#160; &#160; | &#160;| &#160;| &#160;| &#160;+--referent [java.nio.DirectByteBuffer] 64 bytes (64 bytes)
&#160; &#160; | &#160;| &#160;| &#160;|
&#160; &#160; | &#160;| &#160;| &#160;+--thunk [java.nio.DirectByteBuffer$Deallocator] 32 bytes (32 bytes)
&#160; &#160; | &#160;| &#160;| &#160;|
&#160; &#160; | &#160;| &#160;| &#160;+--referent [java.nio.DirectByteBuffer] 64 bytes (64 bytes)
&#160; &#160; | &#160;| &#160;|
&#160; &#160; | &#160;| &#160;+--thunk [java.nio.DirectByteBuffer$Deallocator] 32 bytes (32 bytes)
&#160; &#160; | &#160;| &#160;|
&#160; &#160; | &#160;| &#160;+--referent [java.nio.DirectByteBuffer] 64 bytes (64 bytes)
&#160; &#160; | &#160;|
&#160; &#160; | &#160;+--thunk [java.nio.DirectByteBuffer$Deallocator] 32 bytes (32 bytes)
&#160; &#160; | &#160;|
&#160; &#160; | &#160;+--referent [java.nio.DirectByteBuffer] 64 bytes (64 bytes)
&#160; &#160; |
&#160; &#160; +--thunk [java.nio.DirectByteBuffer$Deallocator] 32 bytes (32 bytes)
&#160; &#160; |
&#160; &#160; +--queue [java.lang.ref.ReferenceQueue] 48 bytes (32 bytes)
&#160; &#160; &#160; |
&#160; &#160; &#160; +--lock [java.lang.ref.ReferenceQueue$Lock] 16 bytes (16 bytes)1544 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Ideally, it would be beneficial to switch to jamm 0.4.0 (used in 5.0) - it covers such cases (&lt;a href=&quot;https://github.com/jbellis/jamm/blob/aa95057962b18a436ff12ddd9f5d0e9a3da74ae2/src/org/github/jamm/Filters.java#L70C37-L70C58&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jbellis/jamm/blob/aa95057962b18a436ff12ddd9f5d0e9a3da74ae2/src/org/github/jamm/Filters.java#L70C37-L70C58&lt;/a&gt;) but I suppose it is not allowed to do such 3rd party upgrades within 4.0/4.1 branches.&lt;br/&gt;
In case of the current MemoryMeter:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;if omitSharedBufferOverhead is disabled it starts to traverse and include heap usage for unpredictable global Cleaner/ReferenceQueue graphs&lt;/li&gt;
	&lt;li&gt;if omitSharedBufferOverhead is enabled it includes direct buffer capacity into the memory usage&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So, I have not find a better way than using of omitSharedBufferOverhead mode (which does not traverse via &quot;att&quot; and &quot;cleaner&quot; references of DirectByteBuffer objects but includes the buffer capacity into the measured result) and then to correct the heap usage measured in the test by subtracting the total size of data within DirectBuffer (off-heap allocation).&lt;/p&gt;

&lt;p&gt;I have submitted the change in the test logic to &lt;a href=&quot;https://github.com/apache/cassandra/pull/3503/commits&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3503/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt; would it be possible to run the repeated tests again for org.apache.cassandra.db.memtable.MemtableSizeOffheapBuffersTest for the updated 4.0 MR?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17880201" author="smiklosovic" created="Mon, 9 Sep 2024 06:20:30 +0000"  >&lt;p&gt;That helped. Would you mind to apply same stuff to 4.1?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/instaclustr/cassandra/tree/CASSANDRA-17298-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-17298-4.0&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java11_pre-commit_tests                         
  &#10003; j11_build                                        1m 58s
  &#10003; j11_cqlsh-dtests-py2-no-vnodes                   5m 26s
  &#10003; j11_cqlsh-dtests-py2-with-vnodes                 5m 32s
  &#10003; j11_cqlsh_dtests_py3                             5m 19s
  &#10003; j11_cqlsh_dtests_py311                           5m 44s
  &#10003; j11_cqlsh_dtests_py311_vnode                     5m 49s
  &#10003; j11_cqlsh_dtests_py38                            5m 39s
  &#10003; j11_cqlsh_dtests_py38_vnode                      5m 41s
  &#10003; j11_cqlsh_dtests_py3_vnode                       5m 47s
  &#10003; j11_cqlshlib_tests                                8m 6s
  &#10003; j11_dtests                                      32m 32s
  &#10003; j11_dtests_vnode                                34m 50s
  &#10003; j11_jvm_dtests                                   9m 41s
  &#10003; j11_unit_tests                                   6m 47s
  &#10003; j11_unit_tests_repeat                           24m 46s
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/4677/workflows/d24a8452-d3a1-4878-a5b5-b22d56e73a1f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java11_pre-commit_tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17880231" author="dnk" created="Mon, 9 Sep 2024 09:00:30 +0000"  >&lt;p&gt;Done, &lt;a href=&quot;https://github.com/apache/cassandra/pull/3504&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3504&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17880241" author="smiklosovic" created="Mon, 9 Sep 2024 09:26:33 +0000"  >&lt;p&gt;I run it 1000x just to be sure and it passes too &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/4678/workflows/340bb293-b384-483c-aea4-159f40425087/jobs/269459&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/instaclustr/cassandra/4678/workflows/340bb293-b384-483c-aea4-159f40425087/jobs/269459&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17880251" author="smiklosovic" created="Mon, 9 Sep 2024 10:12:15 +0000"  >&lt;p&gt;I will run 4.1 build and then I will merge.&lt;/p&gt;</comment>
                            <comment id="17880252" author="smiklosovic" created="Mon, 9 Sep 2024 10:13:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dnk&quot; class=&quot;user-hover&quot; rel=&quot;dnk&quot;&gt;dnk&lt;/a&gt; is there something similar to apply to 5.0 / trunk? I see that in 5.0 / trunk we are still on LongToken and I guess that if I run multiplexer against 5.0 we would see same issues.&lt;/p&gt;</comment>
                            <comment id="17880255" author="dnk" created="Mon, 9 Sep 2024 10:29:59 +0000"  >&lt;p&gt;Yes, I think for 5.0/trunk we should apply the changes about LongToken to keep the code consistent - I will prepare MRs. The last change related to offheap buffers measurement in the tests is not needed because 5.0/trunk uses a newer version of jamm library, which does not have the mentioned issue with DirectByteBuffer (&lt;a href=&quot;https://github.com/jbellis/jamm/blob/aa95057962b18a436ff12ddd9f5d0e9a3da74ae2/src/org/github/jamm/Filters.java#L70C37-L70C58&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jbellis/jamm/blob/aa95057962b18a436ff12ddd9f5d0e9a3da74ae2/src/org/github/jamm/Filters.java#L70C37-L70C58&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;At the same time if you can run the repeated test for the current 5.0 version - it would be good, to double check.&lt;/p&gt;</comment>
                            <comment id="17880306" author="dnk" created="Mon, 9 Sep 2024 12:20:31 +0000"  >&lt;p&gt;Changes for 5.0 and trunk:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3528&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3528&lt;/a&gt;&#160;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3529&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3529&lt;/a&gt;&lt;br/&gt;
NOTE: there is a 1 difference compared to 5.0 - trunk version did not have&#160;&lt;br/&gt;
CQLTester.prepareServer() within org.apache.cassandra.db.memtable.MemtableSizeTestBase#setup and relied on CQLTester.setUpClass()&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17880531" author="smiklosovic" created="Tue, 10 Sep 2024 07:42:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/instaclustr/cassandra/tree/CASSANDRA-17298-4.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-17298-4.1&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java8_pre-commit_tests                          
  &#10003; j8_build                                          4m 8s
  &#10003; j8_cqlsh_dtests_py3                              7m 50s
  &#10003; j8_cqlsh_dtests_py311                            7m 11s
  &#10003; j8_cqlsh_dtests_py311_vnode                      5m 51s
  &#10003; j8_cqlsh_dtests_py38                             6m 22s
  &#10003; j8_cqlsh_dtests_py38_vnode                       8m 32s
  &#10003; j8_cqlsh_dtests_py3_vnode                        7m 50s
  &#10003; j8_cqlshlib_cython_tests                         14m 3s
  &#10003; j8_cqlshlib_tests                               14m 30s
  &#10003; j8_jvm_dtests                                   23m 12s
  &#10003; j8_jvm_dtests_vnode                             21m 10s
  &#10003; j8_simulator_dtests                              5m 58s
  &#10003; j8_unit_tests                                    9m 17s
  &#10003; j8_unit_tests_repeat                            30m 27s
  &#10003; j8_utests_system_keyspace_directory              10m 6s
  &#10003; j8_utests_system_keyspace_directory_repeat      34m 15s
  &#10003; j11_unit_tests_repeat                           35m 27s
  &#10003; j11_unit_tests                                   8m 48s
  &#10003; j11_jvm_dtests_vnode                            12m 58s
  &#10003; j11_jvm_dtests                                  16m 58s
  &#10003; j11_cqlshlib_tests                               6m 46s
  &#10003; j11_cqlshlib_cython_tests                        6m 52s
  &#10003; j11_cqlsh_dtests_py3_vnode                        6m 9s
  &#10003; j11_cqlsh_dtests_py38_vnode                      5m 45s
  &#10003; j11_cqlsh_dtests_py38                            6m 10s
  &#10003; j11_cqlsh_dtests_py311_vnode                     5m 47s
  &#10003; j11_cqlsh_dtests_py311                           5m 29s
  &#10003; j11_cqlsh_dtests_py3                             5m 42s
  &#10005; j8_dtests                                       34m 48s
      largecolumn_test.TestLargeColumn test_cleanup
  &#10005; j8_dtests_vnode                                 35m 46s
      largecolumn_test.TestLargeColumn test_cleanup
  &#10005; j11_dtests_vnode                                37m 22s
      largecolumn_test.TestLargeColumn test_cleanup
  &#10005; j11_dtests                                      35m 18s
      largecolumn_test.TestLargeColumn test_cleanup
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/4679/workflows/e9788768-7d69-4ab4-b1e3-95f41f9ed432&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java8_pre-commit_tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17880532" author="smiklosovic" created="Tue, 10 Sep 2024 07:43:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/instaclustr/cassandra/tree/CASSANDRA-17298-5.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-17298-5.0&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java17_pre-commit_tests                         
  &#10003; j17_build                                        4m 27s
  &#10003; j17_cqlsh_dtests_py311                           6m 12s
  &#10003; j17_cqlsh_dtests_py311_vnode                     6m 18s
  &#10003; j17_cqlsh_dtests_py38                            6m 32s
  &#10003; j17_cqlsh_dtests_py38_vnode                       6m 7s
  &#10003; j17_cqlshlib_cython_tests                        7m 33s
  &#10003; j17_cqlshlib_tests                               6m 39s
  &#10003; j17_dtests                                      32m 21s
  &#10003; j17_dtests_latest                               34m 30s
  &#10003; j17_jvm_dtests                                  23m 11s
  &#10003; j17_jvm_dtests_latest_vnode                     14m 16s
  &#10003; j17_unit_tests                                  14m 32s
  &#10003; j17_unit_tests_repeat                           52m 22s
  &#10003; j17_utests_latest                               16m 26s
  &#10003; j17_utests_latest_repeat                        50m 45s
  &#10003; j17_utests_oa                                   14m 29s
  &#10003; j17_utests_oa_repeat                            51m 56s
  &#10005; j17_dtests_vnode                                33m 56s
      bootstrap_test.TestBootstrap test_shutdown_wiped_node_cannot_join
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/4681/workflows/c4ec1832-2e14-4ec9-baa4-17219ca2f2bd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java17_pre-commit_tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17880534" author="smiklosovic" created="Tue, 10 Sep 2024 07:45:52 +0000"  >&lt;p&gt;Trunk looks rather messy but I don&apos;t think that anything we did is related to that.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/instaclustr/cassandra/tree/CASSANDRA-17298-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-17298-trunk&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java17_pre-commit_tests                         
  &#10003; j17_build                                        4m 22s
  &#10003; j17_cqlsh_dtests_py311                           7m 12s
  &#10003; j17_cqlsh_dtests_py311_vnode                     7m 22s
  &#10003; j17_cqlsh_dtests_py38                            7m 21s
  &#10003; j17_cqlshlib_cython_tests                        7m 59s
  &#10003; j17_cqlshlib_tests                                7m 7s
  &#10003; j17_dtests_vnode                                35m 47s
  &#10003; j17_unit_tests                                   15m 4s
  &#10003; j17_unit_tests_repeat                           47m 31s
  &#10003; j17_utests_latest                               14m 31s
  &#10003; j17_utests_latest_repeat                        45m 14s
  &#10003; j17_utests_oa                                   15m 11s
  &#10003; j17_utests_oa_repeat                            47m 10s
  &#10005; j17_cqlsh_dtests_py38_vnode                     10m 33s
      cqlsh_tests.test_cqlsh.TestCqlshSmoke test_drop_table
  &#10005; j17_dtests                                      32m 21s
      pushed_notifications_test.TestPushedNotifications test_move_single_node_localhost
  &#10005; j17_dtests_latest                               36m 41s
      replica_side_filtering_test.TestSecondaryIndexes test_complementary_deletion_with_limit_on_clustering_key_column
      replica_side_filtering_test.TestSecondaryIndexes test_complementary_deletion_with_limit_on_partition_key_column_with_not_empty_partitions
      bootstrap_test.TestBootstrap test_consistent_range_movement_false_with_rf1_should_succeed
  &#10005; j17_jvm_dtests                                  24m 50s
      org.apache.cassandra.fuzz.ring.ConsistentBootstrapTest coordinatorIsBehindTest
      org.apache.cassandra.distributed.test.NativeTransportEncryptionOptionsTest testOptionalMtlsModeDoNotAllowNonSSLConnections
      org.apache.cassandra.distributed.test.NativeTransportEncryptionOptionsTest testEndpointVerificationEnabledIpNotInSAN
  &#10005; j17_jvm_dtests_latest_vnode                     24m 58s
      org.apache.cassandra.distributed.test.tcm.CMSPlacementAfterMoveTest testMoveToCMS
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/4682/workflows/3d48192a-07f6-4528-bc15-dfa5da3a28d7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java17_pre-commit_tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17880571" author="dnk" created="Tue, 10 Sep 2024 09:36:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt; , &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; thank you for the review, testing and committing the changes!&lt;/p&gt;</comment>
                            <comment id="17880575" author="smiklosovic" created="Tue, 10 Sep 2024 09:44:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dnk&quot; class=&quot;user-hover&quot; rel=&quot;dnk&quot;&gt;dnk&lt;/a&gt; would you mind to take a look at &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19702&quot; title=&quot;Test failure: largecolumn_test.TestLargeColumn&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19702&quot;&gt;&lt;del&gt;CASSANDRA-19702&lt;/del&gt;&lt;/a&gt; ? That&apos;s the one which constantly fails in 4.1 (it is visible in the builds I provided too). That is the last one to have 4.1 builds clean.&lt;/p&gt;</comment>
                            <comment id="17880592" author="dnk" created="Tue, 10 Sep 2024 10:52:32 +0000"  >&lt;p&gt;Funny, I noticed the test as well and I&apos;ve started to look it yesterday evening already &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Yes, I have taken it&lt;/p&gt;</comment>
                            <comment id="17881061" author="dnk" created="Wed, 11 Sep 2024 17:09:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It looks like during a merge the old test was not removed (was re-added back) in 4.1: &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.1/test/unit/org/apache/cassandra/cql3/MemtableSizeTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-4.1/test/unit/org/apache/cassandra/cql3/MemtableSizeTest.java&lt;/a&gt;&#160; (the commit has the removal - &lt;a href=&quot;https://github.com/apache/cassandra/commit/c56ba3b317e67f4530db1737169f5558969bd531#diff-e7b2385cd817d698d35bdeffea2d4cb765653e2e3eb13fa22abfb070fed05a8f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/c56ba3b317e67f4530db1737169f5558969bd531#diff-e7b2385cd817d698d35bdeffea2d4cb765653e2e3eb13fa22abfb070fed05a8f&lt;/a&gt; )&lt;/p&gt;</comment>
                            <comment id="17881069" author="smiklosovic" created="Wed, 11 Sep 2024 17:17:17 +0000"  >&lt;p&gt;ah right ... oops. Seems like it is an issue just in 4.1. Could you please create a ticket to remove that test from 4.1?&#160;&lt;/p&gt;</comment>
                            <comment id="17881077" author="dnk" created="Wed, 11 Sep 2024 17:25:43 +0000"  >&lt;p&gt;created: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19911&quot; title=&quot;Removed MemtableSizeTest test re-appeared after a merge&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19911&quot;&gt;&lt;del&gt;CASSANDRA-19911&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13379722">CASSANDRA-16684</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13591842">CASSANDRA-19911</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13071126" name="analyzed_objects.svg" size="194237" author="dnk" created="Tue, 27 Aug 2024 20:54:52 +0000"/>
                            <attachment id="13071125" name="structure_example.svg" size="49005" author="dnk" created="Tue, 27 Aug 2024 20:54:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dnk]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12990" cascade-level="1"><![CDATA[Test Failure]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 8 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0yzds:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blambov]]></customfieldvalue>
        <customfieldvalue><![CDATA[smiklosovic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12350367">4.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/c56ba3b317e67f4530db1737169f5558969bd531&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/c56ba3b317e67f4530db1737169f5558969bd531&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;existing tests are adjusted&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>