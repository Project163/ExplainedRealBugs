<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:20:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16653] Multinode counters don&apos;t get updated</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16653</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;A multi node setup with counters doesn&apos;t update counters value. Works as expected on a single node though. Comes from &lt;a href=&quot;https://github.com/apache/cassandra-dtest/blob/trunk/upgrade_tests/cql_tests.py#L460&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt; test. Repro:&lt;/p&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ccm create counters40
ccm populate -n 2
ccm start
ccm node1 cqlsh
  CREATE KEYSPACE foo WITH REPLICATION = { &apos;class&apos; : &apos;NetworkTopologyStrategy&apos;, &apos;datacenter1&apos; : 1 } ;
  use foo;
  CREATE TABLE clicks ( userid int, url text, total counter, PRIMARY KEY (userid, url) ) WITH COMPACT STORAGE;
  ALTER TABLE clicks DROP COMPACT STORAGE;
  TRUNCATE clicks;
  UPDATE clicks SET total = total + 1 WHERE userid = 1 AND url = &apos;http://foo.com&apos;;
  SELECT total FROM clicks WHERE userid = 1 AND url = &apos;http://foo.com&apos;;

     total
    -------
         1
  UPDATE clicks SET total = total - 4 WHERE userid = 1 AND url = &apos;http://foo.com&apos;;
  SELECT total FROM clicks WHERE userid = 1 AND url = &apos;http://foo.com&apos;;

     total
    -------
         1 *********** Should be &apos;-3&apos;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13376725">CASSANDRA-16653</key>
            <summary>Multinode counters don&apos;t get updated</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="adelapena">Andres de la Pe&#241;a</assignee>
                                    <reporter username="bereng">Berenguer Blasi</reporter>
                        <labels>
                    </labels>
                <created>Wed, 5 May 2021 06:21:54 +0000</created>
                <updated>Fri, 10 Oct 2025 08:47:53 +0000</updated>
                            <resolved>Wed, 12 May 2021 19:51:56 +0000</resolved>
                                        <fixVersion>4.0-rc2</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Feature/Counters</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3000">50m</timespent>
                                <comments>
                            <comment id="17340315" author="adelapena" created="Thu, 6 May 2021 17:04:02 +0000"  >&lt;p&gt;It seems that the problem is that &lt;tt&gt;AlterTableStatement&lt;/tt&gt; replaces all the flags in the&#160;&lt;tt&gt;TableMetadata&lt;/tt&gt;&#160;by a single &lt;tt&gt;COMPOUND&lt;/tt&gt; flag (&lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/cql3/statements/schema/AlterTableStatement.java#L437&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;). This removes the &lt;tt&gt;DENSE&lt;/tt&gt; flag, as it&apos;s desired. The problem is that the &lt;tt&gt;COUNTER&lt;/tt&gt; flag is also removed, so the table is not considered as a counters table anymore. This leads to sending wrong mutations to the table, producing the problem that we can see in the provided reproduction steps.&lt;/p&gt;

&lt;p&gt;The proposed patch simply makes sure that the &lt;tt&gt;COUNTER&lt;/tt&gt; flag is preserved.&lt;/p&gt;

&lt;p&gt;CI is running:&lt;br/&gt;
 4.0:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/406/workflows/7bafc2a3-4c98-4d1b-9869-24407099147b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CircleCI J8&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/406/workflows/86f980d7-5566-4d65-a2b7-e573dc70d737&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CircleCI J11&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;trunk:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/405/workflows/ae9977c7-02d6-4050-89fd-3683fe8fc581&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CircleCI J8&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/405/workflows/d5f61277-870e-45b7-9d14-99d93da24b82&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CircleCI J11&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17340420" author="edimitrova" created="Thu, 6 May 2021 20:27:29 +0000"  >&lt;p&gt;+1 on green CI. &lt;/p&gt;</comment>
                            <comment id="17340665" author="blerer" created="Fri, 7 May 2021 08:28:08 +0000"  >&lt;p&gt;+1. The failing tests do not look related. &lt;/p&gt;</comment>
                            <comment id="17340940" author="adelapena" created="Fri, 7 May 2021 17:03:24 +0000"  >&lt;p&gt;Thanks for the reviews.&lt;/p&gt;

&lt;p&gt;Committed to &lt;tt&gt;cassandra-4.0&lt;/tt&gt; as &lt;a href=&quot;https://github.com/apache/cassandra/commit/fb76baa60898db82831df44796bd224d30e3236d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;fb76baa60898db82831df44796bd224d30e3236d&lt;/a&gt; and merged up to &lt;a href=&quot;https://github.com/apache/cassandra/commit/2c3c3e639aec8b7515db0e59b606adbea411626a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;trunk&lt;/tt&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17341775" author="bereng" created="Mon, 10 May 2021 08:33:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt; &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-4.0/31/#showFailuresLink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt; run still fails &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-4.0/31/testReport/junit/dtest-upgrade.upgrade_tests.cql_tests/TestCQLNodes2RF1_Upgrade_current_4_0_x_To_indev_4_0_x/test_counters/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;counters&lt;/a&gt; and I can see it&apos;s on &lt;tt&gt;62e1d74701bcb59437aeb1c778ba7a81aac84741&lt;/tt&gt; which should include your fix already?&lt;/p&gt;</comment>
                            <comment id="17341949" author="adelapena" created="Mon, 10 May 2021 15:00:47 +0000"  >&lt;p&gt;It seems that the test needs some fixing. The failing case is an upgrade from 4.0-rc1 to indev 4.0. The &lt;tt&gt;DROP COMPACT STORAGE&lt;/tt&gt; is run in the original version, 4.0-rc1. That version doesn&apos;t contain this bug fix, so the table wrongly stops being a counter table ever before doing the upgrade. I&apos;m working on a patch fixing the dtest.&lt;/p&gt;</comment>
                            <comment id="17342743" author="adelapena" created="Tue, 11 May 2021 17:09:03 +0000"  >&lt;p&gt;The proposed &lt;a href=&quot;https://github.com/apache/cassandra-dtest/pull/136&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR&lt;/a&gt;&#160;changes the dtest to not use compact storage when the origin version is &amp;gt;= 4.0, although previous version will still do it.&lt;/p&gt;

&lt;p&gt;Maybe it would have been preferable to skip the compact storage part only in origin versions between &lt;tt&gt;4.0-beta4&lt;/tt&gt;&#160;and &lt;tt&gt;4.0-rc1&lt;/tt&gt;, which is where the bug is, but AFAIK there isn&apos;t an easy way to get that from the cluster version. Nevertheless, I don&apos;t think that compact storage is an important part of the 4.0-4.0/4.x counters upgrade path, and we already have our new JVM dtest for dropping compact storage in 4.0/4.x counter tables.&lt;/p&gt;

&lt;p&gt;CI is running:&lt;/p&gt;

&lt;p&gt;Jenkins:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/blue/organizations/jenkins/Cassandra-devbranch/detail/Cassandra-devbranch/764/pipeline&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/blue/organizations/jenkins/Cassandra-devbranch/detail/Cassandra-devbranch/765/pipeline&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/blue/organizations/jenkins/Cassandra-devbranch/detail/Cassandra-devbranch/762/pipeline&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/blue/organizations/jenkins/Cassandra-devbranch/detail/Cassandra-devbranch/766/pipeline&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;CircleCI:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/450/workflows/65855969-e4e5-4dd8-b9cb-226f641f99cd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/448/workflows/19b48d88-64ad-4981-8f30-ea2d6f3a0cc5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/449/workflows/af262f01-bf4c-47b6-bf5d-7b4c6ce837ae&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/452/workflows/b6c1e360-3456-4d58-8e76-f7818e415c49&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17343341" author="edimitrova" created="Wed, 12 May 2021 16:20:45 +0000"  >&lt;p&gt;+1, especially now when we have the mentioned in-jvm test.&lt;/p&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17343534" author="adelapena" created="Wed, 12 May 2021 19:51:39 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=e.dimitrova&quot; class=&quot;user-hover&quot; rel=&quot;e.dimitrova&quot;&gt;e.dimitrova&lt;/a&gt;, dtest fix committed as &lt;a href=&quot;https://github.com/apache/cassandra-dtest/commit/7542dfe3921089dae35c2ab70616a7fb1f526fe8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;7542dfe3921089dae35c2ab70616a7fb1f526fe8&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310760">
                    <name>Testing</name>
                                                                <inwardlinks description="Discovered while testing">
                                        <issuelink>
            <issuekey id="13376283">CASSANDRA-16648</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[adelapena]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 26 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0qqkg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
        <customfieldvalue><![CDATA[e.dimitrova]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12349335">4.0-beta4</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/fb76baa60898db82831df44796bd224d30e3236d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/fb76baa60898db82831df44796bd224d30e3236d&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;The patch includes a JVM dtest with the reproduction steps included in the description.&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>