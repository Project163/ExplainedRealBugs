<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:42:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5631] NPE when creating column family shortly after multinode startup</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5631</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I&apos;m testing a 2-node cluster and creating a column family right after the nodes startup.  I am using the Astyanax client.  Sometimes column family creation fails and I see NPEs on the cassandra server:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2013-06-12 14:55:31,773 ERROR CassandraDaemon [MigrationStage:1] - Exception in thread Thread[MigrationStage:1,5,main]
java.lang.NullPointerException
	at org.apache.cassandra.db.DefsTable.addColumnFamily(DefsTable.java:510)
	at org.apache.cassandra.db.DefsTable.mergeColumnFamilies(DefsTable.java:444)
	at org.apache.cassandra.db.DefsTable.mergeSchema(DefsTable.java:354)
	at org.apache.cassandra.db.DefinitionsUpdateVerbHandler$1.runMayThrow(DefinitionsUpdateVerbHandler.java:55)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)
	at java.util.concurrent.FutureTask.run(FutureTask.java:166)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.Thread.run(Thread.java:722)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2013-06-12 14:55:31,880 ERROR CassandraDaemon [MigrationStage:1] - Exception in thread Thread[MigrationStage:1,5,main]
java.lang.NullPointerException
	at org.apache.cassandra.db.DefsTable.mergeColumnFamilies(DefsTable.java:475)
	at org.apache.cassandra.db.DefsTable.mergeSchema(DefsTable.java:354)
	at org.apache.cassandra.db.DefinitionsUpdateVerbHandler$1.runMayThrow(DefinitionsUpdateVerbHandler.java:55)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)
	at java.util.concurrent.FutureTask.run(FutureTask.java:166)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.Thread.run(Thread.java:722)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12652464">CASSANDRA-5631</key>
            <summary>NPE when creating column family shortly after multinode startup</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aleksey">Aleksey Yeschenko</assignee>
                                    <reporter username="mserrano">Martin Serrano</reporter>
                        <labels>
                    </labels>
                <created>Wed, 12 Jun 2013 19:27:30 +0000</created>
                <updated>Tue, 14 Oct 2025 12:13:56 +0000</updated>
                            <resolved>Wed, 19 Feb 2014 19:28:18 +0000</resolved>
                                        <fixVersion>1.2.16</fixVersion>
                    <fixVersion>2.0.6</fixVersion>
                    <fixVersion>2.1 beta1</fixVersion>
                                        <due></due>
                            <votes>2</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="13681543" author="jbellis" created="Wed, 12 Jun 2013 19:29:58 +0000"  >&lt;p&gt;Please test 1.2.5&lt;/p&gt;</comment>
                            <comment id="13681652" author="mserrano" created="Wed, 12 Jun 2013 21:21:59 +0000"  >&lt;p&gt;Unfortunately we are using the Astyanax client which only supports up to 1.2.2.  Is there anything I can do to detect this case and retry?  or work around it?&lt;/p&gt;</comment>
                            <comment id="13682624" author="mserrano" created="Thu, 13 Jun 2013 19:46:03 +0000"  >&lt;p&gt;I was incorrect regarding Astyanax support.  I just had a classpath issue.  Anyway, I have tested in 1.2.5 and can no longer reproduce.  Thanks!&lt;/p&gt;</comment>
                            <comment id="13682627" author="jbellis" created="Thu, 13 Jun 2013 19:49:21 +0000"  >&lt;p&gt;Great; thanks for the followup!&lt;/p&gt;</comment>
                            <comment id="13880982" author="rlow" created="Fri, 24 Jan 2014 14:10:59 +0000"  >&lt;p&gt;I&apos;ve seen this on Cassandra 1.2.11.  It happens if you create a keyspace, following quickly by creating a column family within that keyspace.  The NPE is thrown because Schema.instance.getTableDefinition returns null for the keyspace but it isn&apos;t checked.&lt;/p&gt;

&lt;p&gt;In the case I saw, the node that threw the NPE had problems so it wasn&apos;t receiving many messages - it didn&apos;t get the create keyspace message but did get the create CF message.  Even if a node doesn&apos;t have any problems, the ordering of these messages is not guaranteed.  The node will get the create keyspace message some time later (probably about 60 seconds later when another node has noticed the schema version is wrong) but it won&apos;t attempt to recreate the CF unless there is a further CF change (create, update or delete) within that keyspace.  Only then is the current cached schema compared with the on disk schema (in DefsTable.mergeColumnFamilies).  It then notices the CF doesn&apos;t exist so creates it.  This could never happen, so the node won&apos;t ever create the CF (unless it is restarted).&lt;/p&gt;

&lt;p&gt;I think a fix would be to catch the NPEs above, and then, on learning about a new keyspace, check to see if any CFs should have been created for that keyspace.&lt;/p&gt;

&lt;p&gt;I haven&apos;t tried to repro this on 2.0 but the code looks almost identical so I would expect it to still be present.&lt;/p&gt;

&lt;p&gt;Could someone reopen the ticket please?&lt;/p&gt;</comment>
                            <comment id="13886886" author="proggie" created="Thu, 30 Jan 2014 18:37:41 +0000"  >&lt;p&gt;I&apos;m just seeing the exact same thing on my 2 node cluster (cassandra 2.0.4).&lt;/p&gt;</comment>
                            <comment id="13892925" author="iamaleksey" created="Thu, 6 Feb 2014 02:18:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think a fix would be to catch the NPEs above, and then, on learning about a new keyspace, check to see if any CFs should have been created for that keyspace.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This sounds reasonable to me. Another way would be to send the keyspace mutation serialized along with any column families created/altered messages, so that there will never be an NPE there in the first place. This had actually come up before. Will have a look.&lt;/p&gt;</comment>
                            <comment id="13904545" author="JIRAUSER308715" created="Tue, 18 Feb 2014 20:26:49 +0000"  >&lt;p&gt;If the issue is about the node not having gotten the create KS yet.  Can you not just wait for schema agreement in your client before going on to the next create?  That is how I do things to avoid these kinds of issues.&lt;/p&gt;</comment>
                            <comment id="13905072" author="iamaleksey" created="Wed, 19 Feb 2014 08:50:18 +0000"  >&lt;p&gt;The attached patch sends the serialized keyspace itself with any CF update/create/drop migration, making the NPE in question impossible - the keyspace will always be there now.&lt;/p&gt;</comment>
                            <comment id="13905402" author="slebresne" created="Wed, 19 Feb 2014 13:18:17 +0000"  >&lt;p&gt;Lgtm (nit: I&apos;d rename serializeKeyspace to say addSerializedKeyspace).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Can you not just wait for schema agreement in your client before going on to the next create?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;For the record, Jeremiah is right that clients are supposed to wait for schema agreement if they want to guarantee the table creation won&apos;t fail just after the keyspace one (or alternatively make sure both creation goes through the same coordinator node). Of course, we shouldn&apos;t NPE internally if a user don&apos;t respect that and that&apos;s just what this ticket is about.&lt;/p&gt;</comment>
                            <comment id="13905930" author="iamaleksey" created="Wed, 19 Feb 2014 19:28:18 +0000"  >&lt;p&gt;Committed with a nit, thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12629732" name="5631.txt" size="2042" author="aleksey" created="Wed, 19 Feb 2014 08:47:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>332788</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 39 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1leqf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>333117</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>