<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:49:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8243] DTCS can leave time-overlaps, limiting ability to expire entire SSTables</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8243</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6602&quot; title=&quot;Compaction improvements to optimize time series data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6602&quot;&gt;&lt;del&gt;CASSANDRA-6602&lt;/del&gt;&lt;/a&gt; (DTCS) and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5228&quot; title=&quot;Track maximum ttl and use to expire entire sstables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5228&quot;&gt;&lt;del&gt;CASSANDRA-5228&lt;/del&gt;&lt;/a&gt; are supposed to be a perfect match for tables where every value is written with a TTL. DTCS makes sure to keep old data separate from new data. So shortly after the TTL has passed, Cassandra should be able to throw away the whole SSTable containing a given data point.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5228&quot; title=&quot;Track maximum ttl and use to expire entire sstables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5228&quot;&gt;&lt;del&gt;CASSANDRA-5228&lt;/del&gt;&lt;/a&gt; deletes the very oldest SSTables, and only if they don&apos;t overlap (in terms of timestamps) with another SSTable which cannot be deleted.&lt;/p&gt;

&lt;p&gt;DTCS however, can&apos;t guarantee that SSTables won&apos;t overlap (again, in terms of timestamps). In a test that I ran, every single SSTable overlapped with its nearest neighbors by a very tiny amount. My reasoning for why this could happen is that the dumped memtables were already overlapping from the start. DTCS will never create an overlap where there is none. I surmised that this happened in my case because I sent parallel writes which must have come out of order. This was just locally, and out of order writes should be much more common non-locally.&lt;/p&gt;

&lt;p&gt;That means that the SSTable removal optimization may never get a chance to kick in!&lt;/p&gt;

&lt;p&gt;I can see two solutions:&lt;br/&gt;
1. Make DTCS split SSTables on time window borders. This will essentially only be done on a newly dumped memtable once every base_time_seconds.&lt;br/&gt;
2. Make TTL SSTable expiry more aggressive. Relax the conditions on which an SSTable can be dropped completely, of course without affecting any semantics.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12752345">CASSANDRA-8243</key>
            <summary>DTCS can leave time-overlaps, limiting ability to expire entire SSTables</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Bj0rn">Bj&#246;rn Hegerfors</assignee>
                                    <reporter username="Bj0rn">Bj&#246;rn Hegerfors</reporter>
                        <labels>
                            <label>compaction</label>
                            <label>dtcs</label>
                            <label>performance</label>
                    </labels>
                <created>Mon, 3 Nov 2014 00:01:29 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:29 +0000</updated>
                            <resolved>Fri, 14 Nov 2014 10:14:02 +0000</resolved>
                                        <fixVersion>2.0.15</fixVersion>
                    <fixVersion>2.1.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="14194126" author="bj0rn" created="Mon, 3 Nov 2014 00:20:30 +0000"  >&lt;p&gt;I&apos;ve made a simple change in the getFullyExpiredSSTables method (removing one line did the trick) which drops an SSTable as long as it is fully expired and has getMaxTimestamp less than the getMinTimestamp of any (overlapping) SSTable which contains any column that&apos;s still alive. The difference between this condition and the previous is subtle, but to my understanding, the old condition was being unnecessarily cautious. This one should be safe and it will certainly solve this issue.&lt;/p&gt;

&lt;p&gt;But of course, if this is wrong, then that could be a serious bug. So this has to be carefully reviewed.&lt;/p&gt;</comment>
                            <comment id="14209684" author="krummas" created="Thu, 13 Nov 2014 12:26:43 +0000"  >&lt;p&gt;Problem with this is that we might drop tombstones that actually cover data in other sstables, even though that data is also expired. &lt;/p&gt;

&lt;p&gt;I don&apos;t see any reason that this would make a difference to users, but I&apos;m gonna throw up the &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;-flag here as he said back in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5228&quot; title=&quot;Track maximum ttl and use to expire entire sstables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5228&quot;&gt;&lt;del&gt;CASSANDRA-5228&lt;/del&gt;&lt;/a&gt; that we must account for the timestamp of candidates that cover data in other sstables (in the code in the comment from Mar 21st)&lt;/p&gt;</comment>
                            <comment id="14209735" author="slebresne" created="Thu, 13 Nov 2014 13:17:40 +0000"  >&lt;p&gt;I suspect my comment was so we avoid dropping a tombstone that shadows datat in another non-dropped sstable, but you&apos;re right that in that case we&apos;re guaranteed that the data shadowed is actually expired (and even purgeable) data so I agree with you, I don&apos;t think it matters and this look safe to do (though I&apos;d rather avoid committing this to 2.0, just in case).&lt;/p&gt;</comment>
                            <comment id="14210057" author="bj0rn" created="Thu, 13 Nov 2014 17:30:50 +0000"  >&lt;p&gt;An expired column is equivalent to a tombstone with the same timestamp in Cassandra&apos;s eyes, right? Compactions even turn them into tombstones, if they can&apos;t be immediately purged. So to simplify, we&apos;re dealing with all-tombstone SSTables. Both the old and new implementation agree that removing an SSTable can only happen if the oldest SSTable (the one with lowest minTimestamp) is all-tombstones (= has fully expired). Both implementations also agree that this oldest SSTable may not overlap (in time span) with an SSTable containing any non-tombtone data. If there is no such overlap, everything in any SSTable (with an overlapping row range, anyway) written with a timestamp less than or equal to this oldest table&apos;s maxTimestamp is guaranteed to be a tombstone.&lt;/p&gt;

&lt;p&gt;Also, since any SSTable that either of the implementations remove is an all-tombstone SSTable, the only thing that can happen is that something is resurrected. Combined with the reasoning in my previous paragraph, the only thing that could be resurrected when a tombstone for column x with timestamp t is removed is another tombstone for column x, with a lower timestamp t&apos;! When could that matter? Only if some other SSTable makes a constructive write to column x in the interval (t&apos;, t]. But that&apos;s impossible, because that would then be an SSTable containing some non-tombstone data with a minTimestamp less than or equal to the oldest SSTable&apos;s maxTimestamp, which goes against the assumption that no such SSTable exists!&lt;/p&gt;

&lt;p&gt;There you have a proof by contradiction that the oldest SSTable can be safely removed if it is all-tombstones and doesn&apos;t overlap with any SSTable containing any non-tombstone data. If we then consider the oldest SSTable free to remove, the same rules apply to the oldest remaining SSTable and so on. This is the rule that my implementation uses. From the comments it looks like we already agree intuitively on this, but I though a more formal proof like this might help this get committed. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; any reason to still not submit this patch to 2.0?&lt;/p&gt;

&lt;p&gt;Oh, and I noticed that I didn&apos;t update the Javadoc, so here comes a new patch.&lt;/p&gt;</comment>
                            <comment id="14211998" author="slebresne" created="Fri, 14 Nov 2014 08:19:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;any reason to still not submit this patch to 2.0?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, this is really an improvement and we&apos;re not committing improvements to 2.0 at this point. I don&apos;t contest the reasoning, but we&apos;ve all seen simple and well reasoned patch backfire in unexpected ways from times to times and that&apos;s why we implement rules like this. I&apos;m not absolutely dead set against committing to 2.0 if everyone else wants to, but I&apos;m not in favor of it on principle.&lt;/p&gt;</comment>
                            <comment id="14212090" author="krummas" created="Fri, 14 Nov 2014 10:14:02 +0000"  >&lt;p&gt;Agree that this is for 2.1, and the patch is quite simple so if anyone on 2.0 hits this (probably very rare) case, they can backport it.&lt;/p&gt;

&lt;p&gt;Committed to 2.1&lt;/p&gt;</comment>
                            <comment id="14521327" author="krummas" created="Thu, 30 Apr 2015 11:01:48 +0000"  >&lt;p&gt;backported to 2.0 in 13af5978225e1ac511fc00a763a8919a2d638dfa - several users were hit by this&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12681367" name="cassandra-trunk-CASSANDRA-8243-aggressiveTTLExpiry.txt" size="5939" author="Bj0rn" created="Thu, 13 Nov 2014 17:31:12 +0000"/>
                            <attachment id="12678839" name="cassandra-trunk-CASSANDRA-8243-aggressiveTTLExpiry.txt" size="4781" author="Bj0rn" created="Mon, 3 Nov 2014 00:20:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[Bj0rn]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 29 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i21vq7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327942">2.0.11</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>