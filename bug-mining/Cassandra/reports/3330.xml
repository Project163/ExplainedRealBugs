<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:50:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8550] Internal pagination in CQL3 index queries creating substantial overhead</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8550</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;While benchmarking CQL3 secondary indexes in 2.1.2, we&apos;ve noticed substantial performance degradation as the volume of indexed data increases.  In trying to figure out what&apos;s going on, we found that a major factor contributing to this degradation appears to be logic in &lt;tt&gt;o.a.c.db.index.composites.CompositesSearcher&lt;/tt&gt; used to paginate scans of index tables.  In particular, in the use cases we&apos;ve explored, this short algorithm used to select a page size appears to be the culprit:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; meanColumns = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.max(index.getIndexCfs().getMeanColumns(), 1);
            &lt;span class=&quot;code-comment&quot;&gt;// We shouldn&lt;span class=&quot;code-quote&quot;&gt;&apos;t fetch only 1 row as &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; provides buggy paging in &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; the first row doesn&apos;&lt;/span&gt;t satisfy all clauses
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; rowsPerQuery = &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.max(&lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.min(filter.maxRows(), filter.maxColumns() / meanColumns), 2);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In indexes where the cardinality doesn&apos;t scale linearly with the volume of data indexed, it seems likely that the value of &lt;tt&gt;meanColumns&lt;/tt&gt; will steadily rise in write-heavy workloads.  In the cases we&apos;ve explored, &lt;tt&gt;filter.maxColumns()&lt;/tt&gt; returns a small enough number (related to the lesser of the native-protocol page size or the user-specified limit for the query) that, after &lt;tt&gt;meanColumns&lt;/tt&gt; reaches a few thousand, &lt;tt&gt;rowsPerQuery&lt;/tt&gt; (the page size) is consistently set to 2.&lt;/p&gt;

&lt;p&gt;The resulting overhead is severe.  In our environment, if we fix &lt;tt&gt;rowsPerQuery&lt;/tt&gt; to some reasonably large constant (e.g., 5,000), queries that with the existing logic would require over two minutes to complete can run in under ten seconds.&lt;/p&gt;

&lt;p&gt;Using a constant clearly seems like the wrong answer.  But the overhead the existing algorithm seems to introduce suggests that it isn&apos;t the right answer either.  An intuitive solution might be to use the minimum of &lt;tt&gt;filter.maxRows()&lt;/tt&gt; and &lt;tt&gt;filter.maxColumns()&lt;/tt&gt; (or 2 if both of those are 1), but it&apos;s not immediately clear that there aren&apos;t safety considerations the algorithm is attempting to account for that this strategy does not.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12764404">CASSANDRA-8550</key>
            <summary>Internal pagination in CQL3 index queries creating substantial overhead</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thobbs">Tom Hobbs</assignee>
                                    <reporter username="sklock">Samuel Klock</reporter>
                        <labels>
                    </labels>
                <created>Wed, 31 Dec 2014 17:23:34 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:24 +0000</updated>
                            <resolved>Wed, 14 Jan 2015 17:36:26 +0000</resolved>
                                        <fixVersion>2.0.12</fixVersion>
                    <fixVersion>2.1.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14270059" author="thobbs" created="Thu, 8 Jan 2015 21:15:22 +0000"  >&lt;p&gt;It looks like this has been a problem since &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3680&quot; title=&quot;Add Support for Composite Secondary Indexes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3680&quot;&gt;&lt;del&gt;CASSANDRA-3680&lt;/del&gt;&lt;/a&gt;.  The logic there appears to have been copied from KeysSearcher (where it actually makes sense).&lt;/p&gt;

&lt;p&gt;The attached patch just uses the query limit to calculate the index table slice limit.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; can you review?&lt;/p&gt;</comment>
                            <comment id="14277121" author="blerer" created="Wed, 14 Jan 2015 16:05:35 +0000"  >&lt;p&gt;LGTM&lt;/p&gt;</comment>
                            <comment id="14277275" author="thobbs" created="Wed, 14 Jan 2015 17:36:26 +0000"  >&lt;p&gt;Thanks, committed as 90780b5.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12690942" name="8550-2.0.txt" size="2657" author="thobbs" created="Thu, 8 Jan 2015 21:15:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 44 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i23vtr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12328841">2.1.2</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blerer</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12319262">1.2.0 beta 1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>