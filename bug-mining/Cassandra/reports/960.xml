<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:21:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2766] ConcurrentModificationException during node recovery</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2766</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Testing some node recovery operations.&lt;/p&gt;

&lt;p&gt;In this case:&lt;br/&gt;
1. Data is being added/updated as it would in production&lt;br/&gt;
2. repair is running on other nodes in the cluster&lt;br/&gt;
3. we wiped data on this node and started up again, but before repair was actually started on this node (but it had gotten data through the regular data feed) we got this error.&lt;/p&gt;

&lt;p&gt;I see no indication in the logs that outgoing streams has been started, but the node have finished one incoming stream before this (I guess from some other node doing repair).&lt;/p&gt;

&lt;p&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:11&amp;#93;&lt;/span&gt; 2011-06-14 14:15:09,078 SSTableReader.java (line 155) Opening /data/cassandra/node1/data/JP/test-g-8&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:13&amp;#93;&lt;/span&gt; 2011-06-14 14:15:09,079 SSTableReader.java (line 155) Opening /data/cassandra/node1/data/JP/test-g-10&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;HintedHandoff:1&amp;#93;&lt;/span&gt; 2011-06-14 14:15:26,623 HintedHandOffManager.java (line 302) Started hinted handoff for endpoint /1.10.42.216&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;HintedHandoff:1&amp;#93;&lt;/span&gt; 2011-06-14 14:15:26,623 HintedHandOffManager.java (line 358) Finished hinted handoff of 0 rows to endpoint /1.10.42.216&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:9&amp;#93;&lt;/span&gt; 2011-06-14 14:15:29,417 SSTableReader.java (line 155) Opening /data/cassandra/node1/data/JP/Datetest-g-2&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-84&amp;#93;&lt;/span&gt; 2011-06-14 14:15:36,755 AbstractCassandraDaemon.java (line 113) Fatal exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-84,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.util.ConcurrentModificationException&lt;br/&gt;
        at java.util.AbstractList$Itr.checkForComodification(AbstractList.java:372)&lt;br/&gt;
        at java.util.AbstractList$Itr.next(AbstractList.java:343)&lt;br/&gt;
        at org.apache.cassandra.streaming.StreamInSession.closeIfFinished(StreamInSession.java:132)&lt;br/&gt;
        at org.apache.cassandra.streaming.IncomingStreamReader.read(IncomingStreamReader.java:63)&lt;br/&gt;
        at org.apache.cassandra.net.IncomingTcpConnection.stream(IncomingTcpConnection.java:155)&lt;br/&gt;
        at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:93)&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-79&amp;#93;&lt;/span&gt; 2011-06-14 14:15:36,755 AbstractCassandraDaemon.java (line 113) Fatal exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-79,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.util.ConcurrentModificationException&lt;br/&gt;
        at java.util.AbstractList$Itr.checkForComodification(AbstractList.java:372)&lt;br/&gt;
        at java.util.AbstractList$Itr.next(AbstractList.java:343)&lt;br/&gt;
        at org.apache.cassandra.streaming.StreamInSession.closeIfFinished(StreamInSession.java:132)&lt;br/&gt;
        at org.apache.cassandra.streaming.IncomingStreamReader.read(IncomingStreamReader.java:63)&lt;br/&gt;
        at org.apache.cassandra.net.IncomingTcpConnection.stream(IncomingTcpConnection.java:155)&lt;br/&gt;
        at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:93)&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-83&amp;#93;&lt;/span&gt; 2011-06-14 14:15:36,755 AbstractCassandraDaemon.java (line 113) Fatal exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-83,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.util.ConcurrentModificationException&lt;br/&gt;
        at java.util.AbstractList$Itr.checkForComodification(AbstractList.java:372)&lt;br/&gt;
        at java.util.AbstractList$Itr.next(AbstractList.java:343)&lt;br/&gt;
        at org.apache.cassandra.streaming.StreamInSession.closeIfFinished(StreamInSession.java:132)&lt;br/&gt;
        at org.apache.cassandra.streaming.IncomingStreamReader.read(IncomingStreamReader.java:63)&lt;br/&gt;
        at org.apache.cassandra.net.IncomingTcpConnection.stream(IncomingTcpConnection.java:155)&lt;br/&gt;
        at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:93)&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-85&amp;#93;&lt;/span&gt; 2011-06-14 14:15:36,755 AbstractCassandraDaemon.java (line 113) Fatal exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-85,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.util.ConcurrentModificationException&lt;br/&gt;
        at java.util.AbstractList$Itr.checkForComodification(AbstractList.java:372)&lt;br/&gt;
        at java.util.AbstractList$Itr.next(AbstractList.java:343)&lt;br/&gt;
        at org.apache.cassandra.streaming.StreamInSession.closeIfFinished(StreamInSession.java:132)&lt;br/&gt;
        at org.apache.cassandra.streaming.IncomingStreamReader.read(IncomingStreamReader.java:63)&lt;br/&gt;
        at org.apache.cassandra.net.IncomingTcpConnection.stream(IncomingTcpConnection.java:155)&lt;br/&gt;
        at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:93)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12510276">CASSANDRA-2766</key>
            <summary>ConcurrentModificationException during node recovery</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="terjem">Terje Marthinussen</reporter>
                        <labels>
                    </labels>
                <created>Tue, 14 Jun 2011 07:14:07 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:57 +0000</updated>
                            <resolved>Thu, 16 Jun 2011 17:40:35 +0000</resolved>
                                        <fixVersion>0.8.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13049079" author="jbellis" created="Tue, 14 Jun 2011 09:37:48 +0000"  >&lt;p&gt;looks like a straightforward case of &quot;not using threadsafe collections means there is no happens-before guarantee where a naive reading of the code would expect one&quot; (i.e., since buildFutures.add is always called before files.remove, after files.isEmpty is true there should be no more changes to buildFutures.add).&lt;/p&gt;

&lt;p&gt;patch attached that changes both of these from Arraylist to CSLS.&lt;/p&gt;</comment>
                            <comment id="13049170" author="muga_nishizawa" created="Tue, 14 Jun 2011 13:08:11 +0000"  >&lt;p&gt;Thanks for your quick response.  But we&apos;ve encountered the following exception.    &lt;/p&gt;

&lt;p&gt;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-18&amp;#93;&lt;/span&gt; 2011-06-14 21:54:04,065 AbstractCassandraDaemon.java (line 113) Fatal exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-18,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.ClassCastException: org.apache.cassandra.streaming.PendingFile cannot be cast to java.lang.Comparable&lt;br/&gt;
        at java.util.concurrent.ConcurrentSkipListMap.comparable(ConcurrentSkipListMap.java:621)&lt;br/&gt;
        at java.util.concurrent.ConcurrentSkipListMap.doPut(ConcurrentSkipListMap.java:862)&lt;br/&gt;
        at java.util.concurrent.ConcurrentSkipListMap.putIfAbsent(ConcurrentSkipListMap.java:1893)&lt;br/&gt;
        at java.util.concurrent.ConcurrentSkipListSet.add(ConcurrentSkipListSet.java:202)&lt;br/&gt;
        at org.apache.cassandra.streaming.StreamInSession.addFiles(StreamInSession.java:100)&lt;br/&gt;
        at org.apache.cassandra.streaming.IncomingStreamReader.&amp;lt;init&amp;gt;(IncomingStreamReader.java:49)&lt;br/&gt;
        at org.apache.cassandra.net.IncomingTcpConnection.stream(IncomingTcpConnection.java:155)&lt;br/&gt;
        at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:93)&lt;/p&gt;</comment>
                            <comment id="13049174" author="jbellis" created="Tue, 14 Jun 2011 13:24:05 +0000"  >&lt;p&gt;oops. v2 w/ collections that don&apos;t require a comparable.&lt;/p&gt;</comment>
                            <comment id="13049191" author="slebresne" created="Tue, 14 Jun 2011 14:06:36 +0000"  >&lt;p&gt;lgtm +1 on v2&lt;/p&gt;</comment>
                            <comment id="13049273" author="hudson" created="Tue, 14 Jun 2011 17:02:36 +0000"  >&lt;p&gt;Integrated in Cassandra-0.8 #170 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.8/170/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.8/170/&lt;/a&gt;)&lt;br/&gt;
    use threadsafe collections for StreamInSession&lt;br/&gt;
patch by jbellis; reviewed by slebresne for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2766&quot; title=&quot;ConcurrentModificationException during node recovery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2766&quot;&gt;&lt;del&gt;CASSANDRA-2766&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;jbellis : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1135611&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1135611&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/streaming/StreamInSession.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13050588" author="jbellis" created="Thu, 16 Jun 2011 17:40:35 +0000"  >&lt;p&gt;(committed)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12482553" name="2766-v2.txt" size="1759" author="jbellis" created="Tue, 14 Jun 2011 13:24:05 +0000"/>
                            <attachment id="12482534" name="2766.txt" size="1349" author="jbellis" created="Tue, 14 Jun 2011 09:37:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20816</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 23 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gdbr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93589</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>