<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:39:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5704] add cassandra.unsafesystem property (Truncate flushes to disk again in 1.2, even with durable_writes=false)</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5704</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I just upgraded my dev-environment to C* 1.2. Unfortunetaly 1.2 makes my JUnit tests slow again, due to a blocking-flush in saveTruncationRecord().&lt;/p&gt;

&lt;p&gt;With Cassandra 1.1 truncate was very fast due to: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4153&quot; title=&quot;Optimize truncate when snapshots are disabled or keyspace not durable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4153&quot;&gt;&lt;del&gt;CASSANDRA-4153&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;My proposal is to make saveTruncationRecord() only flush when durableWrites are enabled.&lt;/p&gt;

&lt;p&gt;My assumption is that if somebody turn off durable writes then he does not mind if truncate is not guaranteed to be durable either.&lt;/p&gt;


&lt;p&gt;I successfully tested the following patch with my testsuite. Its as fast as it was with 1.1 (maybe even faster!):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@@ -186,5 +186,8 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SystemTable
         &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; req = &lt;span class=&quot;code-quote&quot;&gt;&quot;UPDATE system.%s SET truncated_at = truncated_at + %s WHERE key = &lt;span class=&quot;code-quote&quot;&gt;&apos;%s&apos;&lt;/span&gt;&quot;&lt;/span&gt;;
         processInternal(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(req, LOCAL_CF, truncationAsMapEntry(cfs, truncatedAt, position), LOCAL_KEY));
-        forceBlockingFlush(LOCAL_CF);
+        
+        KSMetaData ksm = Schema.instance.getKSMetaData(cfs.table.name);
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ksm.durableWrites) &lt;span class=&quot;code-comment&quot;&gt;// flush only when durable_writes are enabled
&lt;/span&gt;+            forceBlockingFlush(LOCAL_CF);
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12654927">CASSANDRA-5704</key>
            <summary>add cassandra.unsafesystem property (Truncate flushes to disk again in 1.2, even with durable_writes=false)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="christianmovi">Christian Spriegel</reporter>
                        <labels>
                    </labels>
                <created>Wed, 26 Jun 2013 13:39:31 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:10 +0000</updated>
                            <resolved>Wed, 17 Jul 2013 19:05:27 +0000</resolved>
                                        <fixVersion>1.2.7</fixVersion>
                    <fixVersion>2.0 beta 2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13693964" author="christianmovi" created="Wed, 26 Jun 2013 13:46:04 +0000"  >&lt;p&gt;I attached patchfiles for 1.2 and trunk&lt;/p&gt;</comment>
                            <comment id="13693995" author="jbellis" created="Wed, 26 Jun 2013 14:29:02 +0000"  >&lt;p&gt;Hmm.  I&apos;m not sure I&apos;m convinced that we should not save the truncation record when durable writes are disabled.  Durable writes means &quot;I&apos;m okay if you lose the data I&apos;m about to write in case of power failure,&quot; but not flushing the truncate means &quot;Data that was supposed to be gone, could reappear&quot; which feels semantically different to me.&lt;/p&gt;

&lt;p&gt;WDYT &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt;?&lt;/p&gt;

&lt;p&gt;(I note that for production use, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4906&quot; title=&quot;Avoid flushing other columnfamilies on truncate&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4906&quot;&gt;&lt;del&gt;CASSANDRA-4906&lt;/del&gt;&lt;/a&gt; made the biggest difference since now we only need to flush the table being truncated instead of everyone.)&lt;/p&gt;</comment>
                            <comment id="13693997" author="brandon.williams" created="Wed, 26 Jun 2013 14:36:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;&quot;Data that was supposed to be gone, could reappear&quot; which feels semantically different to me.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I tend to agree.  Certainly if the biggest problem here is tests are slow, it&apos;s not worth the risk just to speed them up.  We could do something like add a flag if we need this.&lt;/p&gt;</comment>
                            <comment id="13694013" author="tjake" created="Wed, 26 Jun 2013 14:55:16 +0000"  >&lt;p&gt;I agree, perhaps add sone test.mode property that skips it for unit tests?&lt;/p&gt;</comment>
                            <comment id="13694036" author="christianmovi" created="Wed, 26 Jun 2013 15:44:56 +0000"  >&lt;blockquote&gt;&lt;p&gt;&quot;Data that was supposed to be gone, could reappear&quot; which feels semantically different to me.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I can understand that. My thought was that durable_writes already applies to deletes. So I thought why not also apply that pattern to truncate?&lt;/p&gt;


&lt;p&gt;I could live with a new &quot;test.mode&quot; property though (in cassandra.yaml, right?). I would even go as far to say that this one should also deactivate all fsyncs in Cassandra &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Nevertheless, for practical reasons I like the idea of using the durable_writes flag, because it allows me to use have different behaviour on my dev-laptop for...&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;... one keyspace for my junits. These require constant truncation.&lt;/li&gt;
	&lt;li&gt;... my local installation of our application. Here I like a bit more data safety, because I not want to set up my testdata all the time.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13694037" author="christianmovi" created="Wed, 26 Jun 2013 15:47:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m not sure I&apos;m convinced that we should not save the truncation record when durable writes are disabled.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;My understanding was that my patch only stops it from flushing. The record is still being written to a memtable, right?&lt;/p&gt;</comment>
                            <comment id="13711351" author="jbellis" created="Wed, 17 Jul 2013 17:49:50 +0000"  >&lt;p&gt;Yes, it&apos;s a memtable write ... to the system.local table, with information about the truncated table.&lt;/p&gt;

&lt;p&gt;No doubt you would reply, &quot;then let&apos;s skip the flush when durable writes are disabled on the system keyspace,&quot; but you&apos;ll note that we&apos;ve already special cased this flush even though the memtable writes is commitlogged &amp;#8211; we want it to persist immediately even with periodic commitlog mode.  Truncated data reappearing is very high on the list of Behaviors That Surprise People.&lt;/p&gt;

&lt;p&gt;Therefore I propose the attached patch along the lines of what Jake and Brandon suggest, that adds a &lt;tt&gt;cassandra.unsafetruncate&lt;/tt&gt; property.  (Normally I am not a fan of using a &apos;negative&apos; property name like &apos;unsafe&apos; but I don&apos;t want to encourage people to use it, who shouldn&apos;t, which I think we risk if we use &lt;tt&gt;quicktruncate&lt;/tt&gt; or similar.)&lt;/p&gt;</comment>
                            <comment id="13711383" author="brandon.williams" created="Wed, 17 Jul 2013 18:08:33 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13711482" author="jbellis" created="Wed, 17 Jul 2013 19:05:27 +0000"  >&lt;p&gt;Committed&lt;/p&gt;</comment>
                            <comment id="13711787" author="christianmovi" created="Wed, 17 Jul 2013 23:18:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbellis&quot; class=&quot;user-hover&quot; rel=&quot;jbellis&quot;&gt;jbellis&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt;: I&apos;m fine with a property. Thanks!&lt;/p&gt;

&lt;p&gt;Is there any chance we can make it a &quot;cassandra.unsafesystem&quot;-property and apply the same behaviour to all system table operations? This would then also speed up schema changes, which are are also a pain for tests.&lt;/p&gt;

&lt;p&gt;FWIW: I attached a patch which works nicely for me.&lt;/p&gt;

&lt;p&gt;Update: Perhaps as a separate 2.0 ticket?&lt;/p&gt;</comment>
                            <comment id="13712471" author="jbellis" created="Thu, 18 Jul 2013 16:45:45 +0000"  >&lt;p&gt;WFM.  Committed w/ light modifications.&lt;/p&gt;</comment>
                            <comment id="13712662" author="christianmovi" created="Thu, 18 Jul 2013 19:00:09 +0000"  >&lt;p&gt;Awesome, thanks!&lt;/p&gt;

&lt;p&gt;For documentation purposes: The property is: -Dcassandra.unsafesystem=true&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12550963">CASSANDRA-4153</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12725955">CASSANDRA-7511</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12592809" name="5704-v2.txt" size="684" author="jbellis" created="Wed, 17 Jul 2013 17:50:31 +0000"/>
                            <attachment id="12592887" name="5704_unsafeSystem.txt" size="1715" author="christianmovi" created="Wed, 17 Jul 2013 23:19:16 +0000"/>
                            <attachment id="12589747" name="CASSANDRA_5704_V1_1_2.patch" size="784" author="christianmovi" created="Wed, 26 Jun 2013 13:45:02 +0000"/>
                            <attachment id="12589748" name="CASSANDRA_5704_V1_trunk.patch" size="789" author="christianmovi" created="Wed, 26 Jun 2013 13:45:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>335204</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 18 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ltkn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>335528</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>brandon.williams</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>