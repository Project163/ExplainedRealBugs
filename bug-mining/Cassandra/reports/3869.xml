<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:58:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10503] NPE in MVs on update</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10503</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I&apos;ve stumbled upon an NPE in MVs on update. This script will reproduce 100% on trunk from &lt;tt&gt;Date:   Sat Oct 10 09:23:15 2015 +0100&lt;/tt&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [SharedPool-Worker-3] 2015-10-10 21:35:01,867 Keyspace.java:487 - Unknown exception caught &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; attempting to update MaterializedView! test.test_with_cluster
java.lang.NullPointerException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
        at org.apache.cassandra.db.view.TemporalRow.clusteringValue(TemporalRow.java:381) ~[main/:na]
        at org.apache.cassandra.db.view.View.createUpdatesForInserts(View.java:355) ~[main/:na]
        at org.apache.cassandra.db.view.View.createMutations(View.java:664) ~[main/:na]
        at org.apache.cassandra.db.view.ViewManager.pushViewReplicaUpdates(ViewManager.java:130) ~[main/:na]
        at org.apache.cassandra.db.Keyspace.apply(Keyspace.java:482) [main/:na]
        at org.apache.cassandra.db.Keyspace.apply(Keyspace.java:387) [main/:na]
        at org.apache.cassandra.db.Mutation.apply(Mutation.java:205) [main/:na]
        at org.apache.cassandra.service.StorageProxy$$Lambda$149/1333013217.run(Unknown Source) [main/:na]
        at org.apache.cassandra.service.StorageProxy$7.runMayThrow(StorageProxy.java:1247) [main/:na]
        at org.apache.cassandra.service.StorageProxy$LocalMutationRunnable.run(StorageProxy.java:2399) [main/:na]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) [na:1.8.0_45]
        at org.apache.cassandra.concurrent.AbstractTracingAwareExecutorService$FutureTask.run(AbstractTracingAwareExecutorService.java:164) [main/:na]
        at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) [main/:na]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [na:1.8.0_45]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And the script to trigger:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ccm remove test; 
ccm create test --install-dir=/Users/jeff/Desktop/Dev/cassandra/ -s -n 1 ; 
echo &lt;span class=&quot;code-quote&quot;&gt;&quot;create keyspace test WITH replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: 1}; use test; create table test ( id text primary key, last text, first text, high &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, low &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;); insert into test(id,last,first,high,low) values (&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, 1, 1); insert into test(id,last,first,high,low) values (&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;, 2, 2); insert into test(id,last,first,high,low) values (&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;c&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;c&apos;&lt;/span&gt;, 3, 3); insert into test(id,last,first,high,low) values (&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;e&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;e&apos;&lt;/span&gt;, 5, 5); insert into test(id,last,first,high,low) values (&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;d&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;d&apos;&lt;/span&gt;, 4, 4); select * from test where id=&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;;&quot;&lt;/span&gt; | ccm node1 cqlsh

echo &lt;span class=&quot;code-quote&quot;&gt;&quot;Creating MV test_by_high on test&quot;&lt;/span&gt;
echo &lt;span class=&quot;code-quote&quot;&gt;&quot;use test; create materialized view test_by_high as select id, high from test where high is not &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; primary key(high, id);&quot;&lt;/span&gt; | ccm node1 cqlsh

echo &lt;span class=&quot;code-quote&quot;&gt;&quot;Insert high score 6, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; will succeed&quot;&lt;/span&gt;
echo &lt;span class=&quot;code-quote&quot;&gt;&quot;use test; insert into test(id,last,first,high,low) values (&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;f&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;f&apos;&lt;/span&gt;, 6, 6); &quot;&lt;/span&gt; | ccm node1 cqlsh 

sleep 1

echo &lt;span class=&quot;code-quote&quot;&gt;&quot;Select from MV where score = 6, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; will succeed&quot;&lt;/span&gt;
echo &lt;span class=&quot;code-quote&quot;&gt;&quot;use test; select * from test_by_high where high=6; &quot;&lt;/span&gt; | ccm node1 cqlsh

echo &lt;span class=&quot;code-quote&quot;&gt;&quot;Create a larger table with clustering key&quot;&lt;/span&gt;
echo &lt;span class=&quot;code-quote&quot;&gt;&quot;use test; create table test_with_cluster(part text, clus text, last text, first text, high &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, low &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, primary key (part, clus));&quot;&lt;/span&gt; | ccm node1 cqlsh

echo &lt;span class=&quot;code-quote&quot;&gt;&quot;use test; create materialized view high_view as select part, clus, high from test_with_cluster where part is not &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; and clus is not &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; and high is not &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; primary key(high, part, clus);&quot;&lt;/span&gt; | ccm node1 cqlsh

echo &lt;span class=&quot;code-quote&quot;&gt;&quot;Populate test_with_cluster, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; will &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;&quot;&lt;/span&gt;
echo &lt;span class=&quot;code-quote&quot;&gt;&quot;use test; insert into test_with_cluster(part, clus,last,first,high,low) values (&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;, 1, 1); &quot;&lt;/span&gt; | ccm node1 cqlsh
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Logs from my previous tests (which I&apos;ve deleted, unfortunately) suggest that the NPE is due to using the wrong &lt;tt&gt;ColumnIdentifier&lt;/tt&gt; - it&apos;s using &lt;tt&gt;id&lt;/tt&gt; (from test.test?) which causes the NPE in &lt;tt&gt;clusteringValue()&lt;/tt&gt;, since it&apos;s in the wrong base table. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12904015">CASSANDRA-10503</key>
            <summary>NPE in MVs on update</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jjirsa">Jeff Jirsa</assignee>
                                    <reporter username="jjirsa">Jeff Jirsa</reporter>
                        <labels>
                    </labels>
                <created>Sun, 11 Oct 2015 04:41:57 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:53 +0000</updated>
                            <resolved>Tue, 13 Oct 2015 09:04:51 +0000</resolved>
                                        <fixVersion>3.0.0 rc2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14952174" author="jjirsa" created="Sun, 11 Oct 2015 06:29:17 +0000"  >&lt;p&gt;&lt;tt&gt;View.updateAffectsView&lt;/tt&gt; doesn&apos;t actually verify that the partition being updated actually matches the base table of the view. &lt;/p&gt;

&lt;p&gt;I&apos;ve pushed a patch here that I believe fixes this: &lt;a href=&quot;https://github.com/jeffjirsa/cassandra/commits/cassandra-10503&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jeffjirsa/cassandra/commits/cassandra-10503&lt;/a&gt; - Includes a test, but I&apos;m unable to get (any) unit tests to run tonight. Hoping cassci runs cleanly.&lt;/p&gt;

</comment>
                            <comment id="14952302" author="tjake" created="Sun, 11 Oct 2015 14:40:50 +0000"  >&lt;p&gt;we should never be getting the wrong ColumnIdentifier from a different base table. this sounds like a bug in the metadata lookup&lt;/p&gt;</comment>
                            <comment id="14952428" author="jjirsa" created="Sun, 11 Oct 2015 20:35:24 +0000"  >&lt;p&gt;Was able to get tests to run, and confirmed that this happens iff there are more than one table in a KS AND more than one tables with a corresponding MV. Force pushed an updated test to the cassandra-10503 github link above. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=carlyeks&quot; class=&quot;user-hover&quot; rel=&quot;carlyeks&quot;&gt;carlyeks&lt;/a&gt; , you may want to catch this higher up in the call stack? &lt;/p&gt;</comment>
                            <comment id="14953473" author="carlyeks" created="Mon, 12 Oct 2015 17:50:09 +0000"  >&lt;p&gt;This looks like the right approach; we had the check in &lt;tt&gt;ViewManager.updatesAffectView&lt;/tt&gt;, but we should have had it in the &lt;tt&gt;View&lt;/tt&gt; instead for the case where you have multiple tables and views on different tables.&lt;/p&gt;

&lt;p&gt;I pushed an &lt;a href=&quot;https://github.com/carlyeks/cassandra/tree/review/10503/3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;updated branch&lt;/a&gt; to remove the now redundant &lt;tt&gt;ViewManager&lt;/tt&gt; check, as well as a change around &lt;tt&gt;TemporalRow.Set&lt;/tt&gt; to make sure we aren&apos;t requerying when the update doesn&apos;t affect the view.&lt;/p&gt;</comment>
                            <comment id="14953669" author="jjirsa" created="Mon, 12 Oct 2015 20:15:35 +0000"  >&lt;p&gt;My tests pass. I&apos;m +1 (for the little it&apos;s worth). &lt;/p&gt;</comment>
                            <comment id="14954674" author="slebresne" created="Tue, 13 Oct 2015 09:04:51 +0000"  >&lt;p&gt;Committed, thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jjirsa]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 6 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2muy7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>carlyeks</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[carlyeks]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>