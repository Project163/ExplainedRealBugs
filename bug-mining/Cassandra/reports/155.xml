<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:11:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-455] DebuggableScheduledThreadPoolExecutor only schedules a task once</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-455</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;DebuggableScheduledThreadPoolExecutor only schedules a task exactly once, instead of periodically. This affects scheduled flushers and periodic hints delivery.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12436431">CASSANDRA-455</key>
            <summary>DebuggableScheduledThreadPoolExecutor only schedules a task once</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="junrao">Jun Rao</reporter>
                        <labels>
                    </labels>
                <created>Wed, 23 Sep 2009 16:58:53 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:33 +0000</updated>
                            <resolved>Mon, 28 Sep 2009 18:44:35 +0000</resolved>
                                        <fixVersion>0.4</fixVersion>
                    <fixVersion>0.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12758776" author="junrao" created="Wed, 23 Sep 2009 17:00:02 +0000"  >&lt;p&gt;The problem seems to be in DebuggableScheduledThreadPoolExecutor.afterExecute(). If I remove the line&lt;br/&gt;
 DebuggableThreadPoolExecutor.logFutureExceptions(r);&lt;br/&gt;
then all tasks are scheduled periodically as expected. Not sure if this is the right fix though.&lt;/p&gt;</comment>
                            <comment id="12759139" author="junrao" created="Thu, 24 Sep 2009 14:54:37 +0000"  >&lt;p&gt;It seems that one needs to call DebuggableThreadPoolExecutor.logFutureExceptions(r) to catch any exception while running the scheduled task. However, once get() is called on the FutureTask, the task is no longer scheduled any more. Anyone knows how do address this?&lt;/p&gt;</comment>
                            <comment id="12759143" author="jbellis" created="Thu, 24 Sep 2009 15:10:56 +0000"  >&lt;p&gt;scheduleAtFixedRate &quot;Creates and executes a periodic action that becomes enabled first after the given initial delay, and subsequently with the given period; that is executions will commence after initialDelay then initialDelay+period, then initialDelay + 2 * period, and so on. If any execution of the task encounters an exception, subsequent executions are suppressed...&quot;&lt;/p&gt;

&lt;p&gt;so get() shouldn&apos;t be causing a cancel, but if an exception is found then we need to re-schedule it manually.  (If you cast the Runnable in afterExecute to ScheduledFutureTask you can get access to the scheduling info.)&lt;/p&gt;

&lt;p&gt;if get is causing the cancel even w/o any exceptions being involved then I guess you&apos;ll need to source dive in ScheduledThreadPoolExecutor to see what is going on.&lt;/p&gt;</comment>
                            <comment id="12759146" author="junrao" created="Thu, 24 Sep 2009 15:20:56 +0000"  >&lt;p&gt;&quot;if get is causing the cancel even w/o any exceptions being involved then I guess you&apos;ll need to source dive in ScheduledThreadPoolExecutor to see what is going on.&quot;&lt;/p&gt;

&lt;p&gt;That seems to be the case. Here is what happens. &lt;/p&gt;

&lt;p&gt;Without exception:&lt;br/&gt;
When DebuggableThreadPoolExecutor.logFutureExceptions(r) is called in afterExecute(), tasks are no longer executed afterwards. When DebuggableThreadPoolExecutor.logFutureExceptions(r) is removed, tasks are scheduled as expected.&lt;/p&gt;

&lt;p&gt;With exception:&lt;br/&gt;
If DebuggableThreadPoolExecutor.logFutureExceptions(r) is removed, exception is not logged.&lt;/p&gt;</comment>
                            <comment id="12759150" author="jbellis" created="Thu, 24 Sep 2009 15:28:28 +0000"  >&lt;p&gt;then i guess we should always reschedule after checking for exceptions.&lt;/p&gt;

&lt;p&gt;but i&apos;d be more comfortable if i saw the code that is un-scheduling it, so i could be sure there are no conditions under which we could end up w/ 2 copies of the same task scheduled.&lt;/p&gt;</comment>
                            <comment id="12759728" author="jbellis" created="Fri, 25 Sep 2009 20:25:58 +0000"  >&lt;p&gt;Okay, here&apos;s what&apos;s going on.&lt;/p&gt;

&lt;p&gt;ScheduledFutureTask overrides FT.run as follows:&lt;/p&gt;

&lt;p&gt;        public void run() &lt;/p&gt;
{
            if (isPeriodic())
                runPeriodic();
            else
                ScheduledFutureTask.super.run();
        }

&lt;p&gt;we are scheduling periodic tasks, so the normal run() method, which just wrapps sync.innerRun(), is not called.  Instead we call runPeriodic, of which the important part here is&lt;/p&gt;

&lt;p&gt;            boolean ok = ScheduledFutureTask.super.runAndReset();&lt;/p&gt;

&lt;p&gt;not run()!  runAndReset()!  which says&lt;/p&gt;

&lt;p&gt;    /**&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Executes the computation without setting its result, and then&lt;/li&gt;
	&lt;li&gt;resets this Future to initial state, failing to do so if the&lt;/li&gt;
	&lt;li&gt;computation encounters an exception or is cancelled.  This is&lt;/li&gt;
	&lt;li&gt;designed for use with tasks that intrinsically execute more&lt;/li&gt;
	&lt;li&gt;than once.&lt;/li&gt;
	&lt;li&gt;@return true if successfully run and reset&lt;br/&gt;
     */&lt;br/&gt;
    protected boolean runAndReset() 
{
        return sync.innerRunAndReset();
    }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;key point is &quot;... without setting its result.&quot;  sure enough, sync.innerRAR sets the state back to 0 when it is done &amp;#8211; but get() will block until state is RAN or CANCELLED, i.e. until there is a result.  So the reason get() makes the task stop executing is it deadlocks the executor thread that it&apos;s running on.&lt;/p&gt;

&lt;p&gt;as far as i can see there is no public way to get an exception out of a FutureTask.sync w/o calling get.  I guess we can get it out using reflection tho.&lt;/p&gt;

&lt;p&gt;For 0.4 I will just revert the commit that added logFutureExceptions to DebuggableScheduledThreadPoolExecutor.&lt;/p&gt;</comment>
                            <comment id="12759734" author="jbellis" created="Fri, 25 Sep 2009 20:37:27 +0000"  >&lt;p&gt;ScheduledFutureTask is private.  @Q#%$&lt;/p&gt;</comment>
                            <comment id="12759738" author="jbellis" created="Fri, 25 Sep 2009 20:52:39 +0000"  >&lt;p&gt;performed the revert on the 0.4 branch.&lt;/p&gt;</comment>
                            <comment id="12759754" author="jbellis" created="Fri, 25 Sep 2009 21:25:52 +0000"  >&lt;p&gt;I took a stab at using STPE.decorateTask to make a new ScheduledFuture that doesn&apos;t eat exceptions but it&apos;s going to be messy and fragile.&lt;/p&gt;

&lt;p&gt;Ripping that crap out and using old-school Timers looks like a better option.&lt;/p&gt;</comment>
                            <comment id="12760269" author="jbellis" created="Mon, 28 Sep 2009 15:12:58 +0000"  >&lt;p&gt;    Replace DebuggableScheduledThreadPoolExecutor with non-Scheduled Executors and Timers.  This allows logging&lt;br/&gt;
    exceptions from repeated tasks, which is basically impossible with STPE.&lt;/p&gt;</comment>
                            <comment id="12760307" author="junrao" created="Mon, 28 Sep 2009 17:48:53 +0000"  >&lt;p&gt;Looks good to me. Perhaps we should add some logging for the starting of each scheduled task.&lt;/p&gt;</comment>
                            <comment id="12760333" author="jbellis" created="Mon, 28 Sep 2009 18:42:15 +0000"  >&lt;p&gt;both flushing and HHO log as soon as they start so I think adding logging at the timer level clutters things up more than clarifies.  (maybe if we decide we have too many Timer threads around and consolidate into a global service, though.)&lt;/p&gt;</comment>
                            <comment id="12760336" author="jbellis" created="Mon, 28 Sep 2009 18:44:34 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12420702" name="455.patch" size="16321" author="jbellis" created="Mon, 28 Sep 2009 15:12:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19696</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 9 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0fz1j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>91275</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>