<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:16:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15878] Ec2Snitch fails on upgrade in legacy mode</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15878</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7839&quot; title=&quot;Support standard EC2 naming conventions in Ec2Snitch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7839&quot;&gt;&lt;del&gt;CASSANDRA-7839&lt;/del&gt;&lt;/a&gt; changed the way the EC2 DC/Rack naming was handled in the Ec2Snitch to match AWS conventions.&lt;/p&gt;

&lt;p&gt;The &quot;legacy&quot; mode was introduced to allow upgrades from Cassandra 3.0/3.x and keep the same naming as before (while the &quot;standard&quot; mode uses the new naming convention).&lt;/p&gt;

&lt;p&gt;When performing an upgrade in the us-west-2 region, the second node failed to start with the following exception:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR [main] 2020-06-16 09:14:42,218 Ec2Snitch.java:210 - This ec2-enabled snitch appears to be using the legacy naming scheme &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; regions, but existing nodes in cluster are using the opposite: region(s) = [us-west-2], availability zone(s) = [2a]. Please check the ec2_naming_scheme property in the cassandra-rackdc.properties configuration file &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; more details.
ERROR [main] 2020-06-16 09:14:42,219 CassandraDaemon.java:789 - Exception encountered during startup
java.lang.IllegalStateException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at org.apache.cassandra.service.StorageService.validateEndpointSnitch(StorageService.java:573)
	at org.apache.cassandra.service.StorageService.checkForEndpointCollision(StorageService.java:530)
	at org.apache.cassandra.service.StorageService.prepareToJoin(StorageService.java:800)
	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:659)
	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:610)
	at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:373)
	at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:650)
	at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:767)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The exception leads back to &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.0-alpha4/src/java/org/apache/cassandra/locator/Ec2Snitch.java#L183-L185&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this piece of code&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;After adding some logging, it turned out the DC name of the first upgraded node was considered invalid as a legacy one:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INFO  [main] 2020-06-16 09:14:42,216 Ec2Snitch.java:183 - Detected DC us-west-2
INFO  [main] 2020-06-16 09:14:42,217 Ec2Snitch.java:185 - dcUsesLegacyFormat=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; / usingLegacyNaming=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
ERROR [main] 2020-06-16 09:14:42,217 Ec2Snitch.java:188 - Invalid DC name us-west-2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The problem is that the regex that&apos;s used to identify legacy dc names will match both old and new names :&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; dcUsesLegacyFormat = !dc.matches(&lt;span class=&quot;code-quote&quot;&gt;&quot;[a-z]+-[a-z].+-[\\d].*&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Knowing that some dc names didn&apos;t change between the two modes (us-west-2 for example), I don&apos;t see how we can use the dc names to detect if the legacy mode is being used by other nodes in the cluster.&lt;br/&gt;
 &#160;&lt;br/&gt;
 The rack names on the other hand are totally different in the legacy and standard modes and can be used to detect mismatching settings.&lt;br/&gt;
 &#160;&lt;br/&gt;
 My go to fix would be to drop the check on datacenters by removing the following lines:&#160;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.0-alpha4/src/java/org/apache/cassandra/locator/Ec2Snitch.java#L172-L186&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-4.0-alpha4/src/java/org/apache/cassandra/locator/Ec2Snitch.java#L172-L186&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13311749">CASSANDRA-15878</key>
            <summary>Ec2Snitch fails on upgrade in legacy mode</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="adejanovski">Alexander Dejanovski</assignee>
                                    <reporter username="adejanovski">Alexander Dejanovski</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 Jun 2020 15:12:49 +0000</created>
                <updated>Mon, 29 Jun 2020 16:26:56 +0000</updated>
                            <resolved>Mon, 29 Jun 2020 16:26:56 +0000</resolved>
                                        <fixVersion>4.0-beta1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/Distributed Metadata</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17146442" author="adejanovski" created="Fri, 26 Jun 2020 16:09:45 +0000"  >&lt;p&gt;I&apos;ve pushed a commit with a potential fix and updated unit tests:&#160;&lt;a href=&quot;https://github.com/apache/cassandra/pull/653/commits/7a53846a217102143ae56416ebcf534c59de93e6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/653/commits/7a53846a217102143ae56416ebcf534c59de93e6&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolynch&quot; class=&quot;user-hover&quot; rel=&quot;jolynch&quot;&gt;jolynch&lt;/a&gt;, I&apos;d love to have your input on this since you reviewed the original ticket that brought this change.&lt;/p&gt;

&lt;p&gt;Are there cases I&apos;m not seeing where the dc name would be useful to check?&lt;/p&gt;</comment>
                            <comment id="17147114" author="jolynch" created="Sat, 27 Jun 2020 21:14:41 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adejanovski&quot; class=&quot;user-hover&quot; rel=&quot;adejanovski&quot;&gt;adejanovski&lt;/a&gt; thanks for the mention! I will try to page back in context on this change and review this weekend, feel free to put me as a reviewer (although I see mck already got to it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; ).&lt;/p&gt;</comment>
                            <comment id="17147297" author="michaelsembwever" created="Sun, 28 Jun 2020 10:17:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;feel free to put me as a reviewer (although I see mck already got to it  ).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Best with your input on this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolynch&quot; class=&quot;user-hover&quot; rel=&quot;jolynch&quot;&gt;jolynch&lt;/a&gt;, as you&apos;ve got a better idea on the original work.&lt;br/&gt;
my two cents, is it would help if the unit tests could cover all scenarios, including those where we&apos;re dependent on racks to identify legacy, e.g. &quot;us-west-2&quot;. &lt;/p&gt;</comment>
                            <comment id="17147473" author="jolynch" created="Sun, 28 Jun 2020 23:58:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adejanovski&quot; class=&quot;user-hover&quot; rel=&quot;adejanovski&quot;&gt;adejanovski&lt;/a&gt; I agree with you that the rack check is sufficient to determine that we have an accidental mixed mode cluster, but I think we can salvage the datacenter check as well which imo provides a nice second layer of defense against a very easy to make mistake. Specifically, if we see a datacenter with no number (e.g. just &quot;us-east&quot; or just &quot;eu-west&quot;, and usingLegacyNaming is set to False then we could reject it as invalid and raise an exception. Yes, if users had custom suffixes that included numbers we would miss it, but then the rack verification would catch it.&lt;/p&gt;

&lt;p&gt;I&apos;m fine with the proposed patch as I agree the rack checks are sufficient, but I&apos;d also be fine with fixing the datacenter check to be:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;boolean dcUsesLegacyFormat = dc.matches(&quot;[a-z]+-[a-z]+$&quot;);
if (dcUsesLegacyFormat != usingLegacyNaming)
    valid = false;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So for example if someone started up with usingLegacyNaming=false, and the node sees another node with datacenter &quot;us-east&quot; or &quot;eu-west&quot;, then we fail with the error to prevent a split brained cluster. If someone had a custom datacenter suffix of -1, we would be foiled, and the rack check would have to catch the operator error.&lt;/p&gt;</comment>
                            <comment id="17147566" author="adejanovski" created="Mon, 29 Jun 2020 06:00:57 +0000"  >&lt;p&gt;Thanks for the feedback &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolynch&quot; class=&quot;user-hover&quot; rel=&quot;jolynch&quot;&gt;jolynch&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I&apos;ve added back the DC name check and adjusted it as suggested. I provided accurate informations on which case we&apos;re actually covering now with this check.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mck&quot; class=&quot;user-hover&quot; rel=&quot;mck&quot;&gt;mck&lt;/a&gt;, I&apos;ve reintroduced the unit tests that I had deleted and changed the assertions where needed.&lt;/p&gt;

&lt;p&gt;You can check the changes here:&#160;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...thelastpickle:CASSANDRA-15878&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/trunk...thelastpickle:CASSANDRA-15878&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Let me know what you think.&lt;/p&gt;</comment>
                            <comment id="17147902" author="michaelsembwever" created="Mon, 29 Jun 2020 15:46:40 +0000"  >&lt;p&gt;Patch looks good to me. Move the ticket into &apos;patch submitted&apos; if you&apos;re ready for me to commit it.&lt;/p&gt;</comment>
                            <comment id="17147924" author="michaelsembwever" created="Mon, 29 Jun 2020 16:26:56 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/6fc8920889e8537a1f56f45e6c966b3d18325fbb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;6fc8920889e8537a1f56f45e6c966b3d18325fbb &lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12737138">CASSANDRA-7839</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[adejanovski]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12983" cascade-level=""><![CDATA[Availability]]></customfieldvalue>
                                <customfieldvalue key="12992" cascade-level="1"><![CDATA[Process Crash]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 20 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0fwio:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[mck]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348281">4.0-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/6fc8920889e8537a1f56f45e6c966b3d18325fbb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/6fc8920889e8537a1f56f45e6c966b3d18325fbb&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;unit tests added&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>