<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:36:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5171] Save EC2Snitch topology information in system table</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5171</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;EC2Snitch currently waits for the Gossip information to understand the cluster information every time we restart. It will be nice to use already available system table info similar to GPFS.&lt;/p&gt;</description>
                <environment>&lt;p&gt;EC2&lt;/p&gt;</environment>
        <key id="12628167">CASSANDRA-5171</key>
            <summary>Save EC2Snitch topology information in system table</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vijay2win@yahoo.com">Vijay</assignee>
                                    <reporter username="vijay2win@yahoo.com">Vijay</reporter>
                        <labels>
                    </labels>
                <created>Fri, 18 Jan 2013 07:43:47 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:19 +0000</updated>
                            <resolved>Wed, 10 Jul 2013 02:11:31 +0000</resolved>
                                        <fixVersion>2.0 beta 2</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13557260" author="brandon.williams" created="Fri, 18 Jan 2013 15:09:42 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13557480" author="vijay2win@yahoo.com" created="Fri, 18 Jan 2013 19:00:06 +0000"  >&lt;p&gt;Committed to 1.2 and trunk. Thanks!&lt;/p&gt;</comment>
                            <comment id="13664210" author="jbellis" created="Wed, 22 May 2013 15:53:18 +0000"  >&lt;p&gt;This was reverted in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5432&quot; title=&quot;Repair Freeze/Gossip Invisibility Issues 1.2.4&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5432&quot;&gt;&lt;del&gt;CASSANDRA-5432&lt;/del&gt;&lt;/a&gt;, but I think the problem it solves is actually pretty severe, so I&apos;m reopening it.&lt;/p&gt;

&lt;p&gt;The problem is that pretty much everything from TokenMetadata to NetworkTopologyStrategy assumes that once we see a node, the snitch can tell us where it lives, and in particular that once the snitch tells us where a node lives it won&apos;t change its answer.&lt;/p&gt;

&lt;p&gt;So this is problematic:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; getDatacenter(InetAddress endpoint)
    {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (endpoint.equals(FBUtilities.getBroadcastAddress()))
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ec2region;
        EndpointState state = Gossiper.instance.getEndpointStateForEndpoint(endpoint);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (state == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || state.getApplicationState(ApplicationState.DC) == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; DEFAULT_DC;
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; state.getApplicationState(ApplicationState.DC).value;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That is, if we don&apos;t know where a node belongs (e.g., we just restarted and haven&apos;t been gosipped to yet), assume it&apos;s in &lt;tt&gt;DEFAULT_DC&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;This can lead to data loss.  Consider node X in DC1, where keyspace KS is replicated.  Suddenly X is yanked out of DC1 and placed in DC2, where KS is not replicated.  Nobody will bother querying X for the data in KS that was formerly replicated to it.  Even repair will not see it.&lt;/p&gt;</comment>
                            <comment id="13701528" author="vijay2win@yahoo.com" created="Sun, 7 Jul 2013 08:06:13 +0000"  >&lt;p&gt;Attached patch brings the reverted patch back to life, in addition it saves the reseted_ip in system table so when a connection is reopened to the host we will use the reseted_ip instead of endpoint address.&lt;/p&gt;</comment>
                            <comment id="13701612" author="vijay2win@yahoo.com" created="Sun, 7 Jul 2013 17:16:53 +0000"  >&lt;p&gt;Looks like &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5669&quot; title=&quot;Connection thrashing in multi-region ec2 during upgrade, due to messaging version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5669&quot;&gt;&lt;del&gt;CASSANDRA-5669&lt;/del&gt;&lt;/a&gt; forces the user to open public and private IP&apos;s for communication (and hence &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5432&quot; title=&quot;Repair Freeze/Gossip Invisibility Issues 1.2.4&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5432&quot;&gt;&lt;del&gt;CASSANDRA-5432&lt;/del&gt;&lt;/a&gt; no longer a problem) within a AZ and hence v2 is not needed and we can commit v1.&lt;/p&gt;</comment>
                            <comment id="13703203" author="jasobrown" created="Tue, 9 Jul 2013 12:20:05 +0000"  >&lt;p&gt;While this patch (v1 actually) was reverted in CASANDRA-5432, it wasn&apos;t satisfactorily answered why the patch failed to work as expected. I&apos;m adding details here so we can get this ticket done right &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;

&lt;p&gt;First it&apos;s helpful to explore how a node can start gossip in EC2MRS with inter-DC (inter-region) enabled (and a Priam-type setup).&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;ec2 instance is started, Priam comes up first and adds publicIP/sslPort to the security group&apos;s ingress privileges (so this node can accept connections on it&apos;s publicIP/sslPort from anywhere).&lt;/li&gt;
	&lt;li&gt;c* starts, and gets seed node public hostnames from Priam&lt;/li&gt;
	&lt;li&gt;gossip to one of the seeds - the public hostname will resolve to the node&apos;s public IP addr.&lt;/li&gt;
	&lt;li&gt;When OTC goes to write the first message on the seed, it gets a socket from OTCP.newSocket(). newSocket() calls isEncryptedChannel() to determine if we need to encrypt the data on the wire. As we don&apos;t know anything yet about the seed node (remember we havn&apos;t started gossip yet with anyone), isEncryptedChannel() will always return true when the following are true:
	&lt;ol&gt;
		&lt;li&gt;internode_encryption != none&lt;/li&gt;
		&lt;li&gt;we don&apos;t know the DC or RACK info for the remote node (which is the case when using the EC2MRS). This step is a little funky as OTCP calls the snitch for the seed&apos;s DC/RACK, to which EC2MRS will return UNKNOWN-DC/UNKNOWN-RACK, which will just happen to not match a value like &quot;us-east-1&quot; (the current&apos;s node&apos;s DC).&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;create the socket using remote node&apos;s publicIP addr on the SSL port.&lt;/li&gt;
	&lt;li&gt;create the connection from and send messages successfully, assuming you&apos;ve opened the SSL port for public addresses on the security group (which Priam handles).&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Thus, if we are connecting to a node in the same EC2 region, we connect on the publicIP (as expected) but use the SSL port.&lt;/p&gt;

&lt;p&gt;After we learn, via gossip, about a remote node&apos;s DC/RACK/localIP, we can choose to reconnect to nodes in the same region on the localIP/nonSSLPort.&lt;/p&gt;

&lt;p&gt;The reason why Vijay&apos;s patch had problems here was because on restart, we would already know the DC/RACK from the previous execution of c* on this node, and the check in OTCP.isEncryptedChannel() returns false (do not use encryption), so a we choose to use the non-SSL port when creating a connection to the publicIP. Thus the connection creation unltimately fails because the non-SSL port is not opened for traffic on the security group for the public IP (nor should it be). EDIT: The other part of the problem is that we start the connection on the publicIP rather than localIP (INTERNAL_IP) even if we already have the localIP.&lt;/p&gt;

&lt;p&gt;To make this patch work then, I think getting the localIP address in the OTCP&apos;s ctor would work the best. Code would look something like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    OutboundTcpConnectionPool(InetAddress remoteEp)
    {
        EndpointState epState =  Gossiper.instance.getEndpointStateForEndpoint(remoteEp);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;(epState != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; epState.getApplicationState(ApplicationState.INTERNAL_IP) != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
            &amp;amp;&amp;amp; epState.getApplicationState(ApplicationState.DC).equals(snitch.getDatacenter(FBUtilities.getBroadcastAddress()))
        {
            id = epState.getApplicationState(ApplicationState.INTERNAL_IP);             
        }
        &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
        {
            id = remoteEp;
        }
        
        cmdCon = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; OutboundTcpConnection(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
        cmdCon.start();
        ackCon = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; OutboundTcpConnection(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
        ackCon.start();

        metrics = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConnectionMetrics(id, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then you would connect on the localIP addr with the correct port (SSL or non-SSL).&lt;/p&gt;</comment>
                            <comment id="13703372" author="jasobrown" created="Tue, 9 Jul 2013 15:20:38 +0000"  >&lt;p&gt;Ahh, didn&apos;t look at Vijay&apos;s second patch, but it more or less does what I suggested - however, I thought we were already keeping the resettedAddr in the system table, but the second patch adds that in.&lt;/p&gt;</comment>
                            <comment id="13703477" author="jasobrown" created="Tue, 9 Jul 2013 16:44:00 +0000"  >&lt;p&gt;I&apos;m +1 on the v2 patch. As a minor nit, you might rename the &quot;communication_ip&quot; to something like &quot;preferred_ip&quot;.&lt;/p&gt;

&lt;p&gt;As an aside, I&apos;ve never been thrilled with the default &quot;UNKNOWN-DC&quot; that can get returned when we don&apos;t know the DC. It&apos;s guaranteed to be wrong in almost all cases. However, I&apos;m not sure what we&apos;d do instead - returning null or empty string seems only slightly worse than the current default.&lt;/p&gt;</comment>
                            <comment id="13703553" author="vijay2win@yahoo.com" created="Tue, 9 Jul 2013 17:47:41 +0000"  >&lt;blockquote&gt;
&lt;p&gt;I&apos;ve never been thrilled with the default &quot;UNKNOWN-DC&quot; &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I am not a fan either, if we throw an exception node will never start the gossiping.... &lt;br/&gt;
Back in the days, it made sense with the old way of versioning etc. We should probably open another ticket to discuses this if needed.&lt;/p&gt;

&lt;p&gt;I will commit with the nit in few min. Thanks!&lt;/p&gt;</comment>
                            <comment id="13704261" author="vijay2win@yahoo.com" created="Wed, 10 Jul 2013 06:41:44 +0000"  >&lt;p&gt;PS: i only committed to 2.0 to be safe, let me know if you think otherwise. Thanks!&lt;/p&gt;</comment>
                            <comment id="13704538" author="jasobrown" created="Wed, 10 Jul 2013 13:19:29 +0000"  >&lt;p&gt;I thought the patch was reasonable enough for 1.2. If you give me a few days, I can test it out in our env, and let you know if it borks everything or not.&lt;/p&gt;

&lt;p&gt;EDIT: Yeah, will definitely want to test to make sure it&apos;s cool with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5669&quot; title=&quot;Connection thrashing in multi-region ec2 during upgrade, due to messaging version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5669&quot;&gt;&lt;del&gt;CASSANDRA-5669&lt;/del&gt;&lt;/a&gt; (i.e. they don&apos;t collide to not connect at all).&lt;/p&gt;</comment>
                            <comment id="13704784" author="vijay2win@yahoo.com" created="Wed, 10 Jul 2013 17:26:36 +0000"  >&lt;p&gt;Thanks Jason!&lt;/p&gt;</comment>
                            <comment id="13705018" author="jasobrown" created="Wed, 10 Jul 2013 20:22:09 +0000"  >&lt;p&gt;damn jira hotkeys - sorry this got reassigned (to me, and back), Vijay &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12591115" name="0001-CASSANDRA-5171-v2.patch" size="9242" author="vijay2win@yahoo.com" created="Sun, 7 Jul 2013 08:06:13 +0000"/>
                            <attachment id="12565443" name="0001-CASSANDRA-5171.patch" size="2841" author="vijay2win@yahoo.com" created="Fri, 18 Jan 2013 07:45:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[vijay2win@yahoo.com]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>305041</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 19 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i186lr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>255872</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>brandon.williams</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>