<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:23:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3269] possible early deletion of commit logs</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3269</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I ran my cluster for about 2 days. the cluster has 2 nodes. I restarted one box several times, and the other one was always running. the one always running ended up accumulating 100GB of commit logs.&lt;/p&gt;


&lt;p&gt;this is 1.0.0 code from about Sept 15 in github. I kept the original setting for &lt;br/&gt;
#commitlog_total_space_in_mb: 4096&lt;br/&gt;
i.e. commented out&lt;/p&gt;


&lt;p&gt;here is some sample of the output:&lt;/p&gt;

&lt;p&gt;&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 134217857 2011-09-28 03:51 CommitLog-1317181834810.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 134217869 2011-09-28 03:50 CommitLog-1317181764105.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 134217783 2011-09-28 03:49 CommitLog-1317181694633.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 134217750 2011-09-28 02:39 CommitLog-1317176955102.log&lt;br/&gt;
yyang@ip-10-71-21-46:/mnt/cass/log/cassandra$ ls -lt /mnt/cass/lib//cassandra/commitlog/|wc -l&lt;br/&gt;
727&lt;br/&gt;
yyang@ip-10-71-21-46:/mnt/cass/log/cassandra$ du -s /mnt/cass/lib/cassandra/commitlog/ &lt;br/&gt;
95095316        /mnt/cass/lib/cassandra/commitlog/&lt;/p&gt;</description>
                <environment></environment>
        <key id="12525098">CASSANDRA-3269</key>
            <summary>possible early deletion of commit logs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="yangyangyyy">Yang Yang</reporter>
                        <labels>
                    </labels>
                <created>Wed, 28 Sep 2011 20:27:38 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:50 +0000</updated>
                            <resolved>Tue, 4 Oct 2011 16:59:21 +0000</resolved>
                                        <fixVersion>1.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13116783" author="jbellis" created="Wed, 28 Sep 2011 20:46:19 +0000"  >&lt;p&gt;Hmm.  Would be useful to have a debug log &amp;#8211; it would say this&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;                logger.debug(&quot;Not safe to delete commit log &quot; + segment + &quot;; dirty is &quot; + segment.dirtyString() + &quot;; hasNext: &quot; + iter.hasNext());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;whenever a CF was flushed but it can&apos;t remove a segment.&lt;/p&gt;

&lt;p&gt;For bonus points, you could add a log message in CommitLog before it creates the forceFlush runnable in createNewSegment when the size cap is exceeded.&lt;/p&gt;</comment>
                            <comment id="13116848" author="yangyangyyy" created="Wed, 28 Sep 2011 22:07:10 +0000"  >&lt;p&gt;Thanks Jonathan. &lt;br/&gt;
unfortunately I removed the logs. I&apos;ll keep the load testing, if this appears again, I&apos;ll update this bug&lt;/p&gt;</comment>
                            <comment id="13117437" author="yangyangyyy" created="Thu, 29 Sep 2011 17:01:12 +0000"  >&lt;p&gt;I ran the code for a while, it created a lot of commit logs (not yet over the 4G limit ), I shut it down, ran with the code with extra debugging. &lt;/p&gt;

&lt;p&gt;then it showed the following messages, saying that not safe to remove. but in the end, the old commit logs were indeed removed, and I have only a new one left. (see the ls output at the end)&lt;/p&gt;



&lt;p&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FlushWriter:2&amp;#93;&lt;/span&gt; 2011-09-29 16:50:28,410 Memtable.java (line 236) Writing Memtable-multi_click_filter@1810361645(106184307/1327303837 serialized/live bytes, 1538903 ops)&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-09-29 16:50:28,410 CommitLog.java (line 501) Not safe to delete commit log CommitLogSegment(/mnt/cass/lib/cassandra/commitlog/CommitLog-1317314880183.log); dirty is ; hasNext: false&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FlushWriter:2&amp;#93;&lt;/span&gt; 2011-09-29 16:50:31,610 Memtable.java (line 272) Completed flushing /mnt/cass/lib/cassandra/data/testBudget_items/multi_click_filter-h-33-Data.db (118127883 bytes)&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-09-29 16:50:31,611 CommitLog.java (line 461) discard completed log segments for ReplayPosition(segmentId=1317314880183, position=0), column family 1010.&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FlushWriter:2&amp;#93;&lt;/span&gt; 2011-09-29 16:50:31,611 Memtable.java (line 236) Writing Memtable-IpFilter@1199856819(109065609/1328000737 serialized/live bytes, 1580661 ops)&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-09-29 16:50:31,612 CommitLog.java (line 501) Not safe to delete commit log CommitLogSegment(/mnt/cass/lib/cassandra/commitlog/CommitLog-1317314880183.log); dirty is ; hasNext: false&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FlushWriter:2&amp;#93;&lt;/span&gt; 2011-09-29 16:50:34,038 Memtable.java (line 272) Completed flushing /mnt/cass/lib/cassandra/data/testBudget_items/IpFilter-h-33-Data.db (107340235 bytes)&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-09-29 16:50:34,040 CommitLog.java (line 461) discard completed log segments for ReplayPosition(segmentId=1317314880183, position=0), column family 1013.&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FlushWriter:2&amp;#93;&lt;/span&gt; 2011-09-29 16:50:34,040 Memtable.java (line 236) Writing Memtable-opsMetrics@1355039451(1297090/77250 serialized/live bytes, 15090 ops)&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-09-29 16:50:34,040 CommitLog.java (line 501) Not safe to delete commit log CommitLogSegment(/mnt/cass/lib/cassandra/commitlog/CommitLog-1317314880183.log); dirty is ; hasNext: false&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FlushWriter:2&amp;#93;&lt;/span&gt; 2011-09-29 16:50:34,129 Memtable.java (line 272) Completed flushing /mnt/cass/lib/cassandra/data/testBudget_counters/opsMetrics-h-19-Data.db (6282 bytes)&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-09-29 16:50:34,130 CommitLog.java (line 461) discard completed log segments for ReplayPosition(segmentId=1317314880183, position=0), column family 1001.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-09-29 16:50:34,130 CommitLog.java (line 501) Not safe to delete commit log CommitLogSegment(/mnt/cass/lib/cassandra/commitlog/CommitLog-1317314880183.log); dirty is ; hasNext: false&lt;/p&gt;






&lt;p&gt;yyang@ip-10-71-21-46:/mnt/cass/log/cassandra$ ls -lt /mnt/cass/lib/cassandra/commitlog/&lt;br/&gt;
total 2474280&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang         0 2011-09-29 16:48 CommitLog-1317314880183.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang         0 2011-09-29 16:43 CommitLog-1317314635458.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang         0 2011-09-29 16:40 CommitLog-1317314406536.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang         0 2011-09-29 16:36 CommitLog-1317314186503.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang         0 2011-09-29 16:21 CommitLog-1317313281629.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 115115322 2011-09-29 16:02 CommitLog-1317312032419.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 134217870 2011-09-29 16:00 CommitLog-1317311854994.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 134217761 2011-09-29 15:57 CommitLog-1317311685452.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 134217843 2011-09-29 15:54 CommitLog-1317311520485.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 134217795 2011-09-29 15:52 CommitLog-1317311347744.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 134217777 2011-09-29 15:49 CommitLog-1317311185371.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 134217819 2011-09-29 15:46 CommitLog-1317311021414.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 134217766 2011-09-29 15:43 CommitLog-1317310849097.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 134217800 2011-09-29 15:40 CommitLog-1317310682639.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 134217867 2011-09-29 15:38 CommitLog-1317310520489.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 134217882 2011-09-29 15:35 CommitLog-1317310339007.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 134217857 2011-09-29 15:32 CommitLog-1317310162460.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 134217876 2011-09-29 15:29 CommitLog-1317310000804.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 134217883 2011-09-29 15:26 CommitLog-1317309831513.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 134217886 2011-09-29 15:23 CommitLog-1317309658187.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 134217846 2011-09-29 15:20 CommitLog-1317309490763.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 134217741 2011-09-29 15:18 CommitLog-1317309323730.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 134217828 2011-09-29 15:15 CommitLog-1317309154140.log&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 134217738 2011-09-29 15:12 CommitLog-1317308989678.log&lt;br/&gt;
yyang@ip-10-71-21-46:/mnt/cass/log/cassandra$ ls -lt /mnt/cass/lib/cassandra/commitlog/&lt;br/&gt;
total 4&lt;br/&gt;
&lt;del&gt;rw-r&lt;/del&gt;&lt;del&gt;r&lt;/del&gt;- 1 yyang yyang 270 2011-09-29 16:50 CommitLog-1317314880183.log&lt;/p&gt;</comment>
                            <comment id="13117475" author="jbellis" created="Thu, 29 Sep 2011 17:58:07 +0000"  >&lt;p&gt;Are you simply writing faster than it can flush?&lt;/p&gt;</comment>
                            <comment id="13117493" author="yangyangyyy" created="Thu, 29 Sep 2011 18:13:45 +0000"  >&lt;p&gt;I don&apos;t think so, I have set the memtable_total_space to be very high&lt;br/&gt;
due to my larger memory available, and rely on the&lt;br/&gt;
commit_log_total_size to trigger flushing  (also I changed the&lt;br/&gt;
getLiveSize() ... as I said in the other JIRA I commented , since my&lt;br/&gt;
traffic contains a large portion of counter adds). so essentially the&lt;br/&gt;
only trigger for flushing should come from commit_log_total_size&lt;br/&gt;
threshold,  but I don&apos;t see these flushing requests coming out, it&apos;s&lt;br/&gt;
not that the flushing started and can&apos;t finish.&lt;/p&gt;


&lt;p&gt;I&apos;m still running it, let me set it to a smaller threshold and&lt;br/&gt;
hopefully get to the point soon.&lt;/p&gt;

&lt;p&gt;On Thu, Sep 29, 2011 at 10:59 AM, Jonathan Ellis (Commented) (JIRA)&lt;br/&gt;
&amp;lt;jira@apache.org&amp;gt; wrote:&lt;/p&gt;</comment>
                            <comment id="13119106" author="yangyangyyy" created="Sun, 2 Oct 2011 23:40:56 +0000"  >&lt;p&gt;the following shows that createNewSegment() sees that for  the oldest segment file xxxxx63739.log , it&apos;s forcing out a flush of LocationInfo CF. it does this multiple times (at least 1000 times ... ), but the actualy CFS.forceFlush() always says that the CF is clean. so no flushing happens.&lt;/p&gt;



&lt;p&gt;DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 12:29:22,217 CommitLog.java (line 572) create new segment&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 12:29:22,217 CommitLog.java (line 523)  commit log total size now:23488116331&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 12:29:22,217 CommitLog.java (line 578) forcing a flush on segments : CommitLog-1317524063739.log out of 176&lt;br/&gt;
 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 12:29:22,217 ColumnFamilyStore.java (line 718) forceFlush requested but everything is clean&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 12:29:22,218 CommitLog.java (line 584) forcing out CF:LocationInfo&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 12:30:15,357 CommitLog.java (line 572) create new segment&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 12:30:15,357 CommitLog.java (line 523)  commit log total size now:23622334131&lt;/p&gt;


&lt;p&gt;but when flushing (triggered by other cf) happens, the discardSegment() says that the oldest one is still dirty on LocationInfo.&lt;/p&gt;



&lt;p&gt;DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 05:11:14,182 CommitLog.java (line 502) Not safe to delete commit log CommitLogSegment(/mnt/cass/lib/cassandra/commitlog/CommitLog-1317524063739.log); dirty is opsMetrics (1001), LocationInfo (0), Budget (1000), ; hasNext: true&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 06:21:26,481 CommitLog.java (line 502) Not safe to delete commit log CommitLogSegment(/mnt/cass/lib/cassandra/commitlog/CommitLog-1317524063739.log); dirty is LocationInfo (0), Budget (1000), ; hasNext: true&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 06:21:26,868 CommitLog.java (line 502) Not safe to delete commit log CommitLogSegment(/mnt/cass/lib/cassandra/commitlog/CommitLog-1317524063739.log); dirty is LocationInfo (0), ; hasNext: true&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 06:32:15,341 CommitLog.java (line 502) Not safe to delete commit log CommitLogSegment(/mnt/cass/lib/cassandra/commitlog/CommitLog-1317524063739.log); dirty is LocationInfo (0), ; hasNext: true&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 06:32:20,905 CommitLog.java (line 502) Not safe to delete commit log CommitLogSegment(/mnt/cass/lib/cassandra/commitlog/CommitLog-1317524063739.log); dirty is LocationInfo (0), ; hasNext: true&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 06:32:39,725 CommitLog.java (line 502) Not safe to delete commit log CommitLogSegment(/mnt/cass/lib/cassandra/commitlog/CommitLog-1317524063739.log); dirty is LocationInfo (0), ; hasNext: true&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 06:32:54,023 CommitLog.java (line 502) Not safe to delete commit log CommitLogSegment(/mnt/cass/lib/cassandra/commitlog/CommitLog-1317524063739.log); dirty is LocationInfo (0), ; hasNext: true&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 06:33:01,934 CommitLog.java (line 502) Not safe to delete commit log CommitLogSegment(/mnt/cass/lib/cassandra/commitlog/CommitLog-1317524063739.log); dirty is LocationInfo (0), ; hasNext: true&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 06:33:11,167 CommitLog.java (line 502) Not safe to delete commit log CommitLogSegment(/mnt/cass/lib/cassandra/commitlog/CommitLog-1317524063739.log); dirty is LocationInfo (0), ; hasNext: true&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 08:16:28,250 CommitLog.java (line 502) Not safe to delete commit log CommitLogSegment(/mnt/cass/lib/cassandra/commitlog/CommitLog-1317524063739.log); dirty is LocationInfo (0), ; hasNext: true&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 08:16:36,208 CommitLog.java (line 502) Not safe to delete commit log CommitLogSegment(/mnt/cass/lib/cassandra/commitlog/CommitLog-1317524063739.log); dirty is LocationInfo (0), ; hasNext: true&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 08:16:56,037 CommitLog.java (line 502) Not safe to delete commit log CommitLogSegment(/mnt/cass/lib/cassandra/commitlog/CommitLog-1317524063739.log); dirty is LocationInfo (0), ; hasNext: true&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 08:17:18,003 CommitLog.java (line 502) Not safe to delete commit log CommitLogSegment(/mnt/cass/lib/cassandra/commitlog/CommitLog-1317524063739.log); dirty is LocationInfo (0), ; hasNext: true&lt;/p&gt;



&lt;p&gt;since the isClean() of CFS is determined by columnFamilies.size() and isClean() of segment is determined by lastCFWrite(), it seems that these 2 data structures somehow got out of sync.&lt;/p&gt;


&lt;p&gt;also an easy suspect is that the lastCFWrite is not concurrent, but I can&apos;t show an exact scenario of how this would lead to the symptom I see&lt;/p&gt;


</comment>
                            <comment id="13119163" author="yangyangyyy" created="Mon, 3 Oct 2011 06:51:51 +0000"  >&lt;p&gt;this piece of logging is particularly interesting.  the LocationInfo CF is flushed, right after that, it&apos;s trying to discard oldest segment, but the discard fails saying that locationInfo bit is dirty. but supposedly the bit should have been turned off&lt;/p&gt;




&lt;p&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; 2011-10-02 04:22:55,033 CommitLog.java (line 174) Log replay complete, 15600762 replayed mutations&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; 2011-10-02 04:22:58,560 ColumnFamilyStore.java (line 651) flush position is ReplayPosition(segmentId=1317524063739,&lt;br/&gt;
 position=0)&lt;/p&gt;

&lt;p&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; 2011-10-02 04:22:59,244 ColumnFamilyStore.java (line 665) Enqueuing flush of Memtable-LocationInfo@2115195389(29/36&lt;br/&gt;
 serialized/live bytes, 1 ops)&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FlushWriter:2&amp;#93;&lt;/span&gt; 2011-10-02 04:22:59,244 Memtable.java (line 283) flushing memtable LocationInfo&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FlushWriter:2&amp;#93;&lt;/span&gt; 2011-10-02 04:22:59,244 Memtable.java (line 287) entered lock flushing memtable LocationInfo&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FlushWriter:2&amp;#93;&lt;/span&gt; 2011-10-02 04:22:59,244 Memtable.java (line 290) really start flushing memtable LocationInfo&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FlushWriter:2&amp;#93;&lt;/span&gt; 2011-10-02 04:22:59,245 Memtable.java (line 236) Writing Memtable-LocationInfo@2115195389(29/36 serialized&lt;br/&gt;
/live bytes, 1 ops)&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FlushWriter:2&amp;#93;&lt;/span&gt; 2011-10-02 04:22:59,396 Memtable.java (line 272) Completed flushing /mnt/cass/lib/cassandra/data/system/Lo&lt;br/&gt;
cationInfo-h-4-Data.db (80 bytes)&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 04:22:59,397 CommitLog.java (line 461) discard completed log segments for ReplayPosition(segmentId=1317524063739, position=0), column family 0.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 04:22:59,397 CommitLog.java (line 473) trying to discard segment CommitLog-1317524063739.log&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 04:22:59,398 CommitLog.java (line 502) Not safe to delete commit log CommitLogSegment(/mnt/cass/lib/cassandra/commitlog/CommitLog-1317524063739.log); dirty is LocationInfo (0), ; hasNext: false&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; 2011-10-02 04:22:59,447 ColumnFamilyStore.java (line 651) flush position is ReplayPosition(segmentId=1317524063739, position=174)&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; 2011-10-02 04:22:59,447 ColumnFamilyStore.java (line 665) Enqueuing flush of Memtable-LocationInfo@2010157886(53/66 serialized/live bytes, 2 ops)&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FlushWriter:2&amp;#93;&lt;/span&gt; 2011-10-02 04:22:59,448 Memtable.java (line 283) flushing memtable LocationInfo&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FlushWriter:2&amp;#93;&lt;/span&gt; 2011-10-02 04:22:59,448 Memtable.java (line 287) entered lock flushing memtable LocationInfo&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FlushWriter:2&amp;#93;&lt;/span&gt; 2011-10-02 04:22:59,448 Memtable.java (line 290) really start flushing memtable LocationInfo&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FlushWriter:2&amp;#93;&lt;/span&gt; 2011-10-02 04:22:59,448 Memtable.java (line 236) Writing Memtable-LocationInfo@2010157886(53/66 serialized/live bytes, 2 ops)&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FlushWriter:2&amp;#93;&lt;/span&gt; 2011-10-02 04:22:59,572 Memtable.java (line 272) Completed flushing /mnt/cass/lib/cassandra/data/system/LocationInfo-h-6-Data.db (163 bytes)&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 04:22:59,573 CommitLog.java (line 461) discard completed log segments for ReplayPosition(segmentId=1317524063739, position=174), column family 0.&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 04:22:59,573 CommitLog.java (line 473) trying to discard segment CommitLog-1317524063739.log&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-02 04:22:59,573 CommitLog.java (line 502) Not safe to delete commit log CommitLogSegment(/mnt/cass/lib/cassandra/commitlog/CommitLog-1317524063739.log); dirty is LocationInfo (0), ; hasNext: false&lt;br/&gt;
 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;MutationStage:23&amp;#93;&lt;/span&gt; 2011-10-02 04:23:21,015 Memtable.java (line 136) MemoryMeter uninitialized (jamm not specified as java :&lt;/p&gt;</comment>
                            <comment id="13119171" author="yangyangyyy" created="Mon, 3 Oct 2011 07:19:03 +0000"  >&lt;p&gt;I think I found why:&lt;/p&gt;



&lt;p&gt;CommitLogSegment.turnOffIfNotWritten() :&lt;br/&gt;
    void turnOffIfNotWritten(Integer cfId, Integer flushPosition)&lt;/p&gt;
    {
        Integer lastWritten = cfLastWrite.get(cfId);
        if (lastWritten == null || lastWritten &amp;lt; flushPosition)
            cfLastWrite.remove(cfId);
    }

&lt;p&gt;the comparison &quot;&amp;lt;&quot; probably should be &quot;&amp;lt;=&quot;&lt;/p&gt;

&lt;p&gt;let&apos;s say we flush a Memtable, and we have only 1 commitlogsegment in system now. after the flush, no write has come in, now the post-flush job tries to discard segments, &lt;br/&gt;
the context passed in points to the current pointer, which is the same as cfLastWrite, &lt;br/&gt;
then the comparison fails here, and the bit in this logsegment is not removed.&lt;/p&gt;

&lt;p&gt;later, either the cf is never flushed, or when it is being forcefully flushed, we find that there is no new writes to the CF, so the CF isclean(), so the flush is never submitted, and the post-flush can never be run, so the dirty bit can never be cleared.....&lt;/p&gt;

&lt;p&gt;sounds right?&lt;/p&gt;</comment>
                            <comment id="13119219" author="slebresne" created="Mon, 3 Oct 2011 09:31:34 +0000"  >&lt;p&gt;Actually no. The cfLastWrite position is the last position we started writing at for the given column family, not the last position we finished writing to. More precisely, we populate cfLastWrite in CLS.turnOn() which itself is called in CLS.write(RowMutation) just before the actual write with the position prior to the write. In other words, if lastWritten == flushPosition, it can only mean that the flush grabbed the commit log position &lt;b&gt;before&lt;/b&gt; the last write (and thus we don&apos;t want to turn the segment off).&lt;/p&gt;</comment>
                            <comment id="13119248" author="slebresne" created="Mon, 3 Oct 2011 11:33:04 +0000"  >&lt;p&gt;But there is something very wrong in the commit log code. The commit r1171248 broke it (we ended up always setting the position of the LastWrite at -1). That commit is from September 15th, so that could match with what you&apos;re seeing, even though it should have resulted in commit log segment being deleted sooner than is safe rather than later. Attaching patch to fix anyway.&lt;/p&gt;</comment>
                            <comment id="13119352" author="jbellis" created="Mon, 3 Oct 2011 15:14:34 +0000"  >&lt;p&gt;not to bikeshed this too much, but v2 moves context and currentPosition out of the try/catch to make it clear that cP will always be valid in the catch section.  also merging declaration and assignment of cP prevents bogus refactors like the original regression.&lt;/p&gt;</comment>
                            <comment id="13119354" author="jbellis" created="Mon, 3 Oct 2011 15:23:28 +0000"  >&lt;p&gt;v3 inlines cP entirely.&lt;/p&gt;</comment>
                            <comment id="13119359" author="slebresne" created="Mon, 3 Oct 2011 15:25:23 +0000"  >&lt;p&gt;+1 on v3&lt;/p&gt;</comment>
                            <comment id="13119361" author="jbellis" created="Mon, 3 Oct 2011 15:29:51 +0000"  >&lt;p&gt;committed v3&lt;/p&gt;</comment>
                            <comment id="13119382" author="slebresne" created="Mon, 3 Oct 2011 16:22:25 +0000"  >&lt;p&gt;To be clear, the committed patch is probably not the source of the problem Yang is seeing, so let&apos;s keep that open for now.&lt;/p&gt;

&lt;p&gt;Yang, I don&apos;t see anything yet from the logs you&apos;ve pasted that seem wrong per se. Can you try to lower the commit_log_total_size&lt;br/&gt;
to something small (like 300MB) and see if you can reproduce easily ? (you should hopefully never have more than 3 commit logs (2 even) since when the third one is created, we should be over the limit and the older one should be deleted).&lt;/p&gt;</comment>
                            <comment id="13119388" author="yangyangyyy" created="Mon, 3 Oct 2011 16:31:36 +0000"  >&lt;p&gt;Sylvain:&lt;/p&gt;


&lt;p&gt;I did try to move down the threshold to 300MB, but in that case, it does not seem to occur easily (I haven&apos;t seen the issue appear after running under a 300MB threshold for 10 hours).&lt;/p&gt;


&lt;p&gt;but if you look at  comment &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3269?focusedCommentId=13119163&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13119163&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-3269?focusedCommentId=13119163&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13119163&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;you see that LocationInfo being flushed already, twice, once at position 0, once at 174, then right after that, it tries to discard the segment, but complains that it&apos;s dirty, and the only dirty bit is locationInfo itself. that is the part that doesn&apos;t sound right.&lt;/p&gt;
</comment>
                            <comment id="13119402" author="yangyangyyy" created="Mon, 3 Oct 2011 17:05:33 +0000"  >&lt;p&gt;I&apos;m a bit unclear about the logic in cfLastWrites vs position, it seems that cflastWrites take value from the logwriter position, which always increases, so cfLastWrite can be only smaller or equal than the position, which is the value obtained through maybeSwitchMemtable()----&amp;gt;getContext() .&lt;/p&gt;


&lt;p&gt;but in log I see&lt;/p&gt;


&lt;p&gt; WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-03 15:48:38,038 CommitLogSegment.java (line 205) turnOffIfNotWritten:ad_ip_agent 50020888/3959&lt;br/&gt;
3935&lt;/p&gt;


&lt;p&gt;the above logging is produced in &lt;/p&gt;



&lt;p&gt;    void turnOffIfNotWritten(Integer cfId, Integer flushPosition)&lt;/p&gt;
    {   
        Integer lastWritten = cfLastWrite.get(cfId);
                String keypace = Schema.instance.getCF(cfId).left;

                final ColumnFamilyStore cfs = Table.open(keypace).getColumnFamilyStore(cfId);
                logger.warn(&quot;turnOffIfNotWritten:&quot; + cfs.columnFamily + &quot; &quot; + lastWritten + &quot;/&quot; + flushPosition);

        if (lastWritten == null || lastWritten &amp;lt; flushPosition)
            cfLastWrite.remove(cfId);
    }</comment>
                            <comment id="13119423" author="yangyangyyy" created="Mon, 3 Oct 2011 17:34:44 +0000"  >&lt;p&gt;I changed the commitlog rotation size to 5MB and total to 200MB, see if the symptoms come out more easily&lt;/p&gt;</comment>
                            <comment id="13119643" author="yangyangyyy" created="Mon, 3 Oct 2011 21:37:54 +0000"  >&lt;p&gt;I added a warn() to CLS.turnOffIfNotWritten() :&lt;/p&gt;

&lt;p&gt;    void turnOffIfNotWritten(Integer cfId, Integer flushPosition)&lt;/p&gt;
    {  
        Integer lastWritten = cfLastWrite.get(cfId);
                String keypace = Schema.instance.getCF(cfId).left;

                final ColumnFamilyStore cfs = Table.open(keypace).getColumnFamilyStore(cfId);
                logger.warn(&quot;turnOffIfNotWritten:&quot; + cfs.columnFamily + &quot; &quot; + lastWritten + &quot;/&quot; + flushPosition);

        if (lastWritten == null || lastWritten &amp;lt; flushPosition)
            cfLastWrite.remove(cfId);
    }



&lt;p&gt;I saw many cases where lastWritten is &amp;gt; than the flushPosition, this does not make sense. &lt;br/&gt;
I think this is definitely going to lead to the un-purged commit logs symptoms, IF no more writes are added onto the dirty CFs in the oldest segment. so the analysis I gave before still holds, but we just need to find out why  lastWritten &amp;gt; flushPosition.&lt;/p&gt;

&lt;p&gt; WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-03 19:43:19,552 CommitLogSegment.java (line 205) turnOffIfNotWritten:ad_impression_session 96030/46355&lt;br/&gt;
 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-03 19:43:22,688 CommitLogSegment.java (line 205) turnOffIfNotWritten:ad_ip_agent 3070922/46355&lt;br/&gt;
 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-03 19:43:24,397 CommitLogSegment.java (line 205) turnOffIfNotWritten:multi_click_filter 4996295/46522&lt;br/&gt;
 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-03 19:43:25,576 CommitLogSegment.java (line 205) turnOffIfNotWritten:session_limit_filter 5242578/59906&lt;br/&gt;
 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-03 19:43:27,013 CommitLogSegment.java (line 205) turnOffIfNotWritten:measuredSession 5241697/80685&lt;br/&gt;
 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-03 19:43:28,740 CommitLogSegment.java (line 205) turnOffIfNotWritten:IpFilter 5242052/96877&lt;br/&gt;
 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-03 19:43:28,919 CommitLogSegment.java (line 205) turnOffIfNotWritten:session_limit_filter 5242475/870755&lt;br/&gt;
 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-03 19:43:29,187 CommitLogSegment.java (line 205) turnOffIfNotWritten:measuredSession 5242807/890241&lt;br/&gt;
 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-03 19:43:29,471 CommitLogSegment.java (line 205) turnOffIfNotWritten:IpFilter 5242120/890241&lt;br/&gt;
 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-03 19:43:29,690 CommitLogSegment.java (line 205) turnOffIfNotWritten:IpFilter 3422607/768691&lt;br/&gt;
 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-03 19:45:36,674 CommitLogSegment.java (line 205) turnOffIfNotWritten:ad_impression_session 3552787/165636&lt;br/&gt;
 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-03 19:45:39,484 CommitLogSegment.java (line 205) turnOffIfNotWritten:ad_ip_agent 5242441/165636&lt;br/&gt;
 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-03 19:45:40,832 CommitLogSegment.java (line 205) turnOffIfNotWritten:multi_click_filter 5241748/165636&lt;br/&gt;
 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-03 19:45:41,670 CommitLogSegment.java (line 205) turnOffIfNotWritten:ad_ip_agent 5242691/1387810&lt;br/&gt;
 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2011-10-03 19:45:41,863 CommitLogSegment.java (line 205) turnOffIfNotWritten:multi_click_filter 5242353/1409533&lt;/p&gt;

</comment>
                            <comment id="13119659" author="yangyangyyy" created="Mon, 3 Oct 2011 21:52:55 +0000"  >&lt;p&gt;ok, this looks to be what could lead to the symptoms:&lt;/p&gt;


&lt;p&gt;let&apos;s say the commitlog position is 0 now.&lt;/p&gt;

&lt;p&gt;Table.apply() :&lt;/p&gt;

&lt;p&gt;  switchlock.readlock.lock();&lt;br/&gt;
          commitlog.instance.add(mutation) ====&amp;gt; executor.add(new LogRecordAdder())&lt;br/&gt;
                             // but the Adder is not really executed yet, just submitted.&lt;/p&gt;

&lt;p&gt;         /// add to memtable&lt;br/&gt;
  switchlock.readlock.unlock();&lt;/p&gt;



&lt;p&gt;then we have a flush.&lt;br/&gt;
  CFS.maybeSwitchMemtable()&lt;/p&gt;

&lt;p&gt;  switchlock.writelock.lock();&lt;br/&gt;
    ctx = Commitlog.instance.getContext();   // returns 0 &lt;/p&gt;



&lt;p&gt;/// now the logRecordAdder is executed , and advances the position to 199;&lt;/p&gt;

&lt;p&gt;/// blahblah&lt;br/&gt;
   postflusher.executes(&lt;br/&gt;
      discardCompletedSegments&lt;/p&gt;

&lt;p&gt;             turnOffIfNotWritten() ====&amp;gt; check fails, so the CF written by the last Adder&lt;br/&gt;
                                         is not cleaned&lt;br/&gt;
  )&lt;br/&gt;
  unlock&lt;/p&gt;


&lt;p&gt;as  a result, IF the CF is never written again, it will forever remain dirty in the segment.&lt;/p&gt;



&lt;p&gt;then we need to maintain the order between the adder and the getContext() call in maybeSwitchMemtable()&lt;/p&gt;

</comment>
                            <comment id="13119702" author="yangyangyyy" created="Mon, 3 Oct 2011 22:38:44 +0000"  >&lt;p&gt;per  &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3269?focusedCommentId=13119382&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13119382&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-3269?focusedCommentId=13119382&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13119382&lt;/a&gt;&lt;/p&gt;

</comment>
                            <comment id="13119937" author="slebresne" created="Tue, 4 Oct 2011 07:37:36 +0000"  >&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;switchlock.writelock.lock();
ctx = Commitlog.instance.getContext(); // returns 0

/// now the logRecordAdder is executed , and advances the position to 199;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That could (should) not happen. The commit log is mono-threaded by mean of its executor. And every action on the commit log happens in a task on that executor. In particular Commitlog.instance.getContext() push a task on the commit log executor. This means that a logRecordAdder that has been pushed before the switchlock is grabbed for the flush cannot return a position that is after the position return by getContext() at the beginning of the flush (i.e, it either return a greater position in the same segment or a position in a newer segment). So thanks to the switchlock (that stops writes momentarily), we know that that the ctx position for the flush is after every write that has been done in the memtable we are flushing.&lt;br/&gt;
Now we call discardCompletedSegments later, so what can happen is that there has been writes to the commit log between the time we had grabbed that flush position and the time discardCompletedSegments is called. That is the goal of CL.lastWrite. If when we discard segments, there has been no write on this segment after the flush position we are considering, then the segment can be turnOff, otherwise there is still &quot;active&quot; write for the column family so we don&apos;t turn it off. But if that happens (i.e, if lastWrite &amp;gt;= flushPosition), it means that the writes have been done in a newer memtable than the one we just flushed. So the segment will be turnOff when the flush for that newer memtable happens.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;you see that LocationInfo being flushed already, twice, once at position 0, once at 174, then right after that, it tries to discard the segment, but complains that it&apos;s dirty, and the only dirty bit is locationInfo itself. that is the part that doesn&apos;t sound right.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That log is not fully conclusive, because it is entirely possible that there has been some write to that commit log after the second flush position. In which case it&apos;s ok to not unmark LocationInfo.&lt;/p&gt;

&lt;p&gt;In particular, the last line of the log:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;DEBUG [COMMIT-LOG-WRITER] 2011-10-02 04:22:59,573 CommitLog.java (line 502) Not safe to delete commit log CommitLogSegment(/mnt/cass/lib/cassandra/commitlog/CommitLog-1317524063739.log); dirty is LocationInfo (0), ; hasNext: false
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;shows that the segment is the active one (hasNext == false), so it&apos;s perfectly reasonable to think there has been some write since position 174. The log is missing the value of lastWrite in the message to be able to say if it&apos;s the case.&lt;/p&gt;</comment>
                            <comment id="13120244" author="yangyangyyy" created="Tue, 4 Oct 2011 16:12:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;That could (should) not happen. The commit log is mono-threaded by mean of its executor.&lt;/p&gt;&lt;/blockquote&gt;



&lt;p&gt;this is no longer the case since it was changed (particularly getContext() ) in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3253&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-3253&lt;/a&gt; due to possibility of deadlock&lt;/p&gt;</comment>
                            <comment id="13120248" author="slebresne" created="Tue, 4 Oct 2011 16:18:48 +0000"  >&lt;p&gt;Hum, #3253 moved a flush to an unrelated executor, so that a task on the commit log executor don&apos;t wait for another task on the commit log executor &lt;b&gt;because&lt;/b&gt; that commit log executor is mono-threaded and so this would deadlock. But the commit log executor is still mono-thread (all hell would break loose if it wasn&apos;t) and CL.getContext() does push a task on that executor.&lt;/p&gt;</comment>
                            <comment id="13120266" author="slebresne" created="Tue, 4 Oct 2011 16:42:26 +0000"  >&lt;blockquote&gt;
&lt;p&gt;there is hard evidence in that link that cfWrite has appeared to be &amp;gt; flushPosition.&lt;br/&gt;
this would indeed lead to the turnOffIfNotWritten() not turning off the dirty bit, this point is right, no???&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, it can and will happen that cfWrite &amp;gt; flushPosition. And then the dirty bit will not be turning off. That is right. However, if that happen, it means that there is a write for the column family in a memtable that is not flushed yet. And thus the flush of this memtable would clean the dirty bit off. The invariant that the code enforces  (unless there is a bug of course) is that &apos;for the flush of a given memtable, every write in that memtable will have been written to the commit log at a position that is &amp;lt; the flushPosition for &lt;b&gt;that&lt;/b&gt; flush&apos;. If follows that if cfWrite &amp;gt; flushPosition, there a write in a unflushed memtable.&lt;/p&gt;</comment>
                            <comment id="13120280" author="yangyangyyy" created="Tue, 4 Oct 2011 16:58:45 +0000"  >&lt;p&gt;thanks Sylvain.&lt;/p&gt;

&lt;p&gt;now I see that cfWrite&amp;gt; flushPosition is  fine .&lt;br/&gt;
after I updated to the git HEAD  , the run in the last day has not produced excessive commitlogs. let me keep running and see if it&apos;s gone now&lt;/p&gt;


&lt;p&gt;Yang&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12497474" name="3269-v2.txt" size="1112" author="jbellis" created="Mon, 3 Oct 2011 15:14:34 +0000"/>
                            <attachment id="12497475" name="3269-v3.txt" size="1352" author="jbellis" created="Mon, 3 Oct 2011 15:23:28 +0000"/>
                            <attachment id="12497443" name="3269.patch" size="1608" author="slebresne" created="Mon, 3 Oct 2011 11:33:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>37551</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 8 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ghv3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94324</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>