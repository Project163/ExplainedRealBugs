<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:39:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5855] Scrub does not understand compound primary key created in CQL 3 beta</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5855</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We have a customer who was using the beta version of CQL 3 in DSE 3.0 which includes Cassandra 1.1.9 plus patches backported from later versions.  They&apos;ve now upgraded to DSE 3.1, which includes Cassandra 1.2.6 plus patches.&lt;/p&gt;

&lt;p&gt;When restarting for the first time after running upgradesstables, they noticed the following error in the log:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Thread[SSTableBatchOpen:2,5,main]
java.lang.AssertionError
        at org.apache.cassandra.utils.ByteBufferUtil.readBytes(ByteBufferUtil.java:401)
        at org.apache.cassandra.io.sstable.IndexSummary$IndexSummarySerializer.deserialize(IndexSummary.java:124)
        at org.apache.cassandra.io.sstable.SSTableReader.loadSummary(SSTableReader.java:426)
        at org.apache.cassandra.io.sstable.SSTableReader.load(SSTableReader.java:360)
        at org.apache.cassandra.io.sstable.SSTableReader.open(SSTableReader.java:201)
        at org.apache.cassandra.io.sstable.SSTableReader.open(SSTableReader.java:154)
        at org.apache.cassandra.io.sstable.SSTableReader$1.run(SSTableReader.java:241)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:439)
        at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)
        at java.util.concurrent.FutureTask.run(FutureTask.java:138)
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
        at java.lang.Thread.run(Thread.java:662)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This error was also reported on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5703&quot; title=&quot;IndexSummary and empty keys&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5703&quot;&gt;&lt;del&gt;CASSANDRA-5703&lt;/del&gt;&lt;/a&gt;.  The comments suggested it was caused by an empty row key, so I had them run scrub on it.  When they did, scrub reported the following warning almost 4 million times:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; WARN [CompactionExecutor:27] 2013-08-02 10:13:13,041 OutputHandler.java (line 52) Row at 530332255 is unreadable; skipping to next
 WARN [CompactionExecutor:27] 2013-08-02 10:13:13,041 OutputHandler.java (line 57) Non-fatal error reading row (stacktrace follows)
java.lang.RuntimeException: Error validating row DecoratedKey(139154446688383793922009760478335751546, 735fc9da503b11e2844b123140ff209f)
 at org.apache.cassandra.io.sstable.SSTableIdentityIterator.getColumnFamilyWithColumns(SSTableIdentityIterator.java:243)
 at org.apache.cassandra.db.compaction.PrecompactedRow.merge(PrecompactedRow.java:114)
 at org.apache.cassandra.db.compaction.PrecompactedRow.&amp;lt;init&amp;gt;(PrecompactedRow.java:98)
 at org.apache.cassandra.db.compaction.CompactionController.getCompactedRow(CompactionController.java:160)
 at org.apache.cassandra.db.compaction.CompactionController.getCompactedRow(CompactionController.java:166)
 at org.apache.cassandra.db.compaction.Scrubber.scrub(Scrubber.java:173)
 at org.apache.cassandra.db.compaction.CompactionManager.scrubOne(CompactionManager.java:529)
 at org.apache.cassandra.db.compaction.CompactionManager.doScrub(CompactionManager.java:518)
 at org.apache.cassandra.db.compaction.CompactionManager.access$400(CompactionManager.java:73)
 at org.apache.cassandra.db.compaction.CompactionManager$3.perform(CompactionManager.java:283)
 at org.apache.cassandra.db.compaction.CompactionManager$2.call(CompactionManager.java:253)
 at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)
 at java.util.concurrent.FutureTask.run(FutureTask.java:138)
 at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
 at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
 at java.lang.Thread.run(Thread.java:662)
Caused by: org.apache.cassandra.db.marshal.MarshalException: String didn&apos;t validate.
 at org.apache.cassandra.db.marshal.UTF8Type.validate(UTF8Type.java:66)
 at org.apache.cassandra.db.Column.validateFields(Column.java:292)
 at org.apache.cassandra.db.ColumnFamily.validateColumnFields(ColumnFamily.java:382)
 at org.apache.cassandra.io.sstable.SSTableIdentityIterator.getColumnFamilyWithColumns(SSTableIdentityIterator.java:239)
 ... 15 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The customer did some testing and they&apos;ve determined that the issue only exists when taking a Cassandra 1.1 sstable with compound primary keys and running scrub on it in either Cassandra 1.1 or 1.2.&lt;/p&gt;

&lt;p&gt;It appears that the scrub does not understand the 1.1 compound primary key so is invalidating the row.&lt;/p&gt;

&lt;p&gt;The customer provided a cassandra data directory that&apos;s from DSE 3.0. Running &quot;nodetool scrub&quot; in either DSE 3.0 or 3.1 generates all sorts of exceptions.&lt;/p&gt;

&lt;p&gt;If you fire up cassandra before running the scrub, running this query:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;select count(*) from b_projectsubscription_project;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;will return 88.&lt;/p&gt;

&lt;p&gt;After the scrub, it returns 0.&lt;/p&gt;

&lt;p&gt;When I discussed this with Alexey Yeschenko, he said that if he recalls correctly, the beta didn&apos;t have row markers, and did not use a composite comparator for simple primary keys. Whereas CQL3 final used CompositeType(UTF8Type), the beta would just use UTF8Type. I asked him if this could cause these errors, and he said he didn&apos;t think so because after upgrading your schema created under the beta would still have UTF8Type, so Cassandra would know how to handle it correctly. &lt;/p&gt;

&lt;p&gt;Based on the customer&apos;s investigation, it sounds like this may be true of the normal read/write path but not for scrub. However, given the error that occurred at startup, this may be causing some issues aside from just scrub.  My theory is that scrub is looking at what&apos;s just a UTF8 string and trying to interpret the first few bytes as the sentinels for a composite type.  When it then tries to interpret the remaining bytes, if only part of a multi-byte UTF8 character was in the remaining byte array, it might cause the UTF8 validation errors above.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12662401">CASSANDRA-5855</key>
            <summary>Scrub does not understand compound primary key created in CQL 3 beta</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thobbs">Tom Hobbs</assignee>
                                    <reporter username="jblangston@datastax.com">J.B. Langston</reporter>
                        <labels>
                    </labels>
                <created>Wed, 7 Aug 2013 15:02:43 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:08 +0000</updated>
                            <resolved>Thu, 8 Aug 2013 22:10:54 +0000</resolved>
                                        <fixVersion>1.2.9</fixVersion>
                    <fixVersion>2.0.0</fixVersion>
                                    <component>Legacy/Tools</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13732168" author="jbellis" created="Wed, 7 Aug 2013 17:02:19 +0000"  >&lt;p&gt;Can you get us instructions to reproduce along these lines?&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Start C* 1.1&lt;/li&gt;
	&lt;li&gt;CREATE TABLE ...&lt;/li&gt;
	&lt;li&gt;INSERT ...&lt;/li&gt;
	&lt;li&gt;Start C* 1.2&lt;/li&gt;
	&lt;li&gt;Scrub and watch the error&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="13732768" author="jblangston@datastax.com" created="Wed, 7 Aug 2013 21:30:25 +0000"  >&lt;p&gt;The error will occur whether scrub is run under 1.1 or 1.2.&lt;/p&gt;

&lt;p&gt;1) Start Cassandra 1.1.9&lt;/p&gt;

&lt;p&gt;2) Run the following in cqlsh -3&lt;/p&gt;

&lt;p&gt;CREATE TABLE b_projectsubscription_project (&lt;br/&gt;
  project uuid,&lt;br/&gt;
  uuid uuid,&lt;br/&gt;
  created_on bigint,&lt;br/&gt;
  deleted boolean,&lt;br/&gt;
  hsn_deleted boolean,&lt;br/&gt;
  send_notifications boolean,&lt;br/&gt;
  user uuid,&lt;br/&gt;
  PRIMARY KEY (project, uuid)&lt;br/&gt;
);&lt;/p&gt;

&lt;p&gt;insert into b_projectsubscription_project (project,uuid,created_on,deleted,hsn_deleted,send_notifications,user) values (d7ea9931-3e70-4ec3-b7a8-a7a7535473f2,00388f1e-5b59-41d8-92c7-16b6cedf25a5,1375831887947529,&apos;False&apos;,&apos;False&apos;,&apos;True&apos;,d3151d4d-873c-4c8e-9445-dabd7f0660ef);&lt;/p&gt;

&lt;p&gt;4) run nodetool flush&lt;br/&gt;
5) optional: upgrade to Cassandra 1.2.6&lt;br/&gt;
6) run nodetool scrub&lt;br/&gt;
7) check system.log for &quot;RuntimeException: Error validating row&quot;&lt;br/&gt;
8) in cqlsh -3 run &apos;select * from b_projectsubscription_project;&apos; and notice the row is gone.&lt;/p&gt;</comment>
                            <comment id="13732799" author="jblangston@datastax.com" created="Wed, 7 Aug 2013 21:52:47 +0000"  >&lt;p&gt;One more observation: the bug may only happen if the pk fields are uuid. I tried to reproduce it before with pk fields that are text and wasn&apos;t able to.&lt;/p&gt;</comment>
                            <comment id="13732897" author="thobbs" created="Wed, 7 Aug 2013 23:07:24 +0000"  >&lt;p&gt;At least with a 1.1.9 scrub, it&apos;s trying to look up the column value validator with the full composite column name, but CfMetadata is expecting to only see the last component (e.g. &quot;created_on&quot;).  So, it ends up using the default validator, which is UTF8Type, to try to validate all of the column values.&lt;/p&gt;</comment>
                            <comment id="13732929" author="xcbsmith" created="Wed, 7 Aug 2013 23:34:59 +0000"  >&lt;p&gt;Tyler, that makes sense... does that mean if you kept the composite key fields all the same type, it would work properly?&lt;/p&gt;

&lt;p&gt;It&apos;s kind of weird that you&apos;d still see the problem with the table after it had been upgraded to 1.2. Really, after an upgrade, I would expect scrubs of a table to behave &lt;b&gt;exactly the same&lt;/b&gt; as if the table had been originally created in 1.2. Is the upgrade process perhaps less complete than I imagined?&lt;/p&gt;</comment>
                            <comment id="13733081" author="jbellis" created="Thu, 8 Aug 2013 02:43:10 +0000"  >&lt;p&gt;Usually upgrades only fix bugs that we knew we had. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13733211" author="xcbsmith" created="Thu, 8 Aug 2013 06:53:49 +0000"  >&lt;p&gt;Hehe.&lt;/p&gt;

&lt;p&gt;I figured the idea would be to make it the &lt;em&gt;same&lt;/em&gt; as the same column family created with the new tool. So for example, if the problem was the missing markers, while a bug might exist with the 1.1.9 scrub tool with 1.1.9 column family, it&apos;d be a different story after upgrade. Since the bug shows up you upgrade the column family, but not if you always created it in 1.2, that would imply the markers still weren&apos;t there after the upgrade, which you&apos;d think would be noticed by someone just checking to make sure upgrade actually upgraded, even if nobody realized this tickled an actual bug in scrub.&lt;/p&gt;</comment>
                            <comment id="13733450" author="jbellis" created="Thu, 8 Aug 2013 12:36:12 +0000"  >&lt;p&gt;The problem is that it can&apos;t read the existing data file.  If it could, it would indeed write out a 1.2-format file.&lt;/p&gt;</comment>
                            <comment id="13733643" author="thobbs" created="Thu, 8 Aug 2013 16:20:45 +0000"  >&lt;blockquote&gt;&lt;p&gt;Tyler, that makes sense... does that mean if you kept the composite key fields all the same type, it would work properly?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If all of the column values were UTF8Type, it would work properly, but that&apos;s definitely not a feasible workaround.  I&apos;m looking into a proper fix, which would allow scrub to lookup the correct column validators.&lt;/p&gt;</comment>
                            <comment id="13733886" author="thobbs" created="Thu, 8 Aug 2013 19:39:28 +0000"  >&lt;p&gt;Patch 0001 should apply to 1.1 or 1.2.  It&apos;s not the most general technique, so I welcome any suggestions, but it does fix this particular issue.  If a sparse composite schema is being used, only the last composite component is used to try to look up the column validator.&lt;/p&gt;

&lt;p&gt;I&apos;ll also note that this code path is currently only used by scrub, so it should be safe to test.&lt;/p&gt;</comment>
                            <comment id="13733928" author="jbellis" created="Thu, 8 Aug 2013 20:20:00 +0000"  >&lt;p&gt;It looks to me like we actually need to handle 3 cases:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;classic one-cell-per-column, no composites; the existing code&lt;/li&gt;
	&lt;li&gt;CQL-style one-cell-per-column; the code you added&lt;/li&gt;
	&lt;li&gt;COMPACT style, multiple columns in one cell; need to split them up and check each value&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Nit: prefer assigning variables only once, e.g. we could write the validationName code &lt;span class=&quot;error&quot;&gt;&amp;#91;without addressing case 3 above&amp;#93;&lt;/span&gt; as&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        ByteBuffer validationName;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (cfdef.isComposite &amp;amp;&amp;amp; !cfdef.isCompact)
        {
            AbstractCompositeType comparator = (AbstractCompositeType) metadata.comparator;
            List&amp;lt;AbstractCompositeType.CompositeComponent&amp;gt; components = comparator.deconstruct(name);
            validationName = components.get(components.size() - 1).value;
        }
        &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
        {
            validationName = name;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13733932" author="jbellis" created="Thu, 8 Aug 2013 20:21:03 +0000"  >&lt;p&gt;Actually, COMPACT case is handled by validateName so we&apos;re good.  I&apos;ll fix the nit and commit.&lt;/p&gt;</comment>
                            <comment id="13733997" author="jbellis" created="Thu, 8 Aug 2013 21:16:15 +0000"  >&lt;p&gt;Attached followup patch to make it collection-aware.&lt;/p&gt;</comment>
                            <comment id="13734025" author="thobbs" created="Thu, 8 Aug 2013 21:31:38 +0000"  >&lt;p&gt;+1 on 5585-followup.txt&lt;/p&gt;</comment>
                            <comment id="13734080" author="jbellis" created="Thu, 8 Aug 2013 22:10:55 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12596918" name="0001-Correctly-validate-sparse-composite-columns.patch" size="1768" author="thobbs" created="Thu, 8 Aug 2013 19:39:28 +0000"/>
                            <attachment id="12596943" name="5855-followup.txt" size="2519" author="jbellis" created="Thu, 8 Aug 2013 21:16:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>342405</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 15 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1n1uf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>342710</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>