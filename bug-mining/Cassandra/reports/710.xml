<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:19:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2069] Read repair causes tremendous GC pressure</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2069</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;To reproduce: start a three node cluster, insert 1M rows with stress.java and rf=2.  Take one down, delete its data, then bring it back up and issue 1M reads against it.  After the run is done you will see at least 1 STW long enough to mark the node as dead, often 4 or 5.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12496983">CASSANDRA-2069</key>
            <summary>Read repair causes tremendous GC pressure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="brandon.williams">Brandon Williams</reporter>
                        <labels>
                    </labels>
                <created>Thu, 27 Jan 2011 21:14:02 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:08 +0000</updated>
                            <resolved>Tue, 15 Feb 2011 17:15:55 +0000</resolved>
                                        <fixVersion>0.7.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="57600">16h</timeoriginalestimate>
                            <timeestimate seconds="57600">16h</timeestimate>
                                        <comments>
                            <comment id="12987790" author="jbellis" created="Thu, 27 Jan 2011 22:08:11 +0000"  >&lt;p&gt;is this also true for 0.6?&lt;/p&gt;</comment>
                            <comment id="12987801" author="brandon.williams" created="Thu, 27 Jan 2011 22:31:38 +0000"  >&lt;p&gt;No, only 0.7&lt;/p&gt;</comment>
                            <comment id="12988130" author="jbellis" created="Fri, 28 Jan 2011 16:16:11 +0000"  >&lt;p&gt;In the log snippets I saw the heap was legitimately nearly-full during the repair process.  What does MAT show is using all the memory?&lt;/p&gt;</comment>
                            <comment id="12990343" author="brandon.williams" created="Thu, 3 Feb 2011 22:35:59 +0000"  >&lt;p&gt;MAT indicates there are millions of pending futuretasks in StorageProxy.repairExecutor.&lt;/p&gt;</comment>
                            <comment id="12990392" author="brandon.williams" created="Fri, 4 Feb 2011 00:05:39 +0000"  >&lt;p&gt;Bisecting this indicates two problems.  First, the tremendous GC pressure doesn&apos;t exhibit until we increase the newgen size.  If that is ignored and we only observe whether stress.java moves forward (it has the &apos;keep trying&apos; rather than &apos;keep going&apos; behavior) then the culprit is r1053245.&lt;/p&gt;

&lt;p&gt;Both cases show that RR requests can grow unbounded, which is probably ok, but if it&apos;s the same request over and over we still queue it as many times as it&apos;s requested.&lt;/p&gt;</comment>
                            <comment id="12990416" author="mdennis" created="Fri, 4 Feb 2011 00:44:36 +0000"  >&lt;p&gt;I&apos;ve observed similar issues with large a large newgen, largish memtables and writing at RF&amp;gt;1 at CL.Q/CL.ALL though it&apos;s not as immediate as it is with RR.&lt;/p&gt;

&lt;p&gt;We should look into a way at bounding the number of outstanding requests (RR or &quot;send to replica&quot;), or more aggressively timing out the older requests once we hit some configurable threshold of outstanding requests.&lt;/p&gt;</comment>
                            <comment id="12990427" author="jbellis" created="Fri, 4 Feb 2011 02:14:24 +0000"  >&lt;p&gt;Attached patch does two things:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;allows the repair executor to use threads = # of cores&lt;/li&gt;
	&lt;li&gt;stops sending repair requests when the executor queue gets too large.  (&quot;dropped&quot; requests will be logged by MessagingService along with the other overload-scenario dropping.)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12990433" author="jbellis" created="Fri, 4 Feb 2011 02:36:12 +0000"  >&lt;p&gt;Working on another approach that should let us throw away repair handlers in the expected case that everyone responds quickly.  This will be kinder to new gen gc since we won&apos;t have nearly as many survivors.&lt;/p&gt;</comment>
                            <comment id="12990461" author="jbellis" created="Fri, 4 Feb 2011 06:04:06 +0000"  >&lt;p&gt;v2 adds a READ_REPAIR stage and	does resolve of digests that were not checked for the client result on that stage as soon as response() collects all the replies.	If there is a mismatch and we do a re-read of full	resultset, we also check those results on the RR stage based on response() (in AsyncRepairRunner, now in ReadCallback.)&lt;/p&gt;

&lt;p&gt;I preserved the	feature	from v1	of not doing repairs if	the RR stage is	full.&lt;/p&gt;

&lt;p&gt;Most of the code changes are about getting the right information into ReadCallback (e.g. endpoints) and some ceremony to make static typing happy (IReadCallback).&lt;/p&gt;

&lt;p&gt;A side benefit is that StorageProxy.fetchRows is significantly cleaner (no more commandEndpoints or  repairs collections).&lt;/p&gt;</comment>
                            <comment id="12990585" author="jbellis" created="Fri, 4 Feb 2011 15:38:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;I preserved the feature from v1 of not doing repairs if the RR stage is full.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Removed this for v3. It&apos;s complexity we don&apos;t need to solve a non-problem, when we&apos;re not hanging on to each callback until RPC_TIMEOUT (as demonstrated by 0.6).&lt;/p&gt;</comment>
                            <comment id="12990692" author="jbellis" created="Fri, 4 Feb 2011 19:37:41 +0000"  >&lt;p&gt;v4 fixes build&lt;/p&gt;</comment>
                            <comment id="12990751" author="jbellis" created="Fri, 4 Feb 2011 21:22:40 +0000"  >&lt;p&gt;v5 fixes a confusion of endpoints and handler.endpoints&lt;/p&gt;</comment>
                            <comment id="12990824" author="brandon.williams" created="Fri, 4 Feb 2011 23:20:31 +0000"  >&lt;p&gt;No GC pressure now, however RR does not appear to actually occur.&lt;/p&gt;</comment>
                            <comment id="12990862" author="jbellis" created="Sat, 5 Feb 2011 01:20:28 +0000"  >&lt;p&gt;what does debug log show?&lt;/p&gt;</comment>
                            <comment id="12990865" author="brandon.williams" created="Sat, 5 Feb 2011 01:27:21 +0000"  >&lt;p&gt;Nothing interesting, afaict.  Just a lot of this:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;DEBUG 23:19:42,094 get_slice
DEBUG 23:19:42,094 get_slice
DEBUG 23:19:42,240 ReadCallback blocking for 1 responses
DEBUG 23:19:42,240 ReadCallback blocking for 1 responses
DEBUG 23:19:42,093 ReadCallback blocking for 1 responses
DEBUG 23:19:42,092 reading data for SliceFromReadCommand(table=&apos;Keyspace1&apos;, key=&apos;30343939323034&apos;, column_parent=&apos;QueryPath(columnFamilyName=&apos;Standard1&apos;, superColumnName=&apos;null&apos;, columnName=&apos;null&apos;)&apos;, start=&apos;&apos;, finish=&apos;&apos;, reversed=false, count=5) locally
DEBUG 23:19:42,091 Read: 21 ms.
DEBUG 23:19:42,091 LocalReadRunnable reading SliceFromReadCommand(table=&apos;Keyspace1&apos;, key=&apos;30353032333935&apos;, column_parent=&apos;QueryPath(columnFamilyName=&apos;Standard1&apos;, superColumnName=&apos;null&apos;, columnName=&apos;null&apos;)&apos;, start=&apos;&apos;, finish=&apos;&apos;, reversed=false, count=5)
DEBUG 23:19:42,091 Read: 17 ms.
DEBUG 23:19:42,241 Read: 159 ms.
DEBUG 23:19:42,091 Read: 12 ms.
DEBUG 23:19:42,091 reading data for SliceFromReadCommand(table=&apos;Keyspace1&apos;, key=&apos;30333636313035&apos;, column_parent=&apos;QueryPath(columnFamilyName=&apos;Standard1&apos;, superColumnName=&apos;null&apos;, columnName=&apos;null&apos;)&apos;, start=&apos;&apos;, finish=&apos;&apos;, reversed=false, count=5) locally
DEBUG 23:19:42,091 LocalReadRunnable reading SliceFromReadCommand(table=&apos;Keyspace1&apos;, key=&apos;30343831383238&apos;, column_parent=&apos;QueryPath(columnFamilyName=&apos;Standard1&apos;, superColumnName=&apos;null&apos;, columnName=&apos;null&apos;)&apos;, start=&apos;&apos;, finish=&apos;&apos;, reversed=false, count=5)
DEBUG 23:19:42,091 get_slice
DEBUG 23:19:42,242 Read: 161 ms.
DEBUG 23:19:42,242 ReadCallback blocking for 1 responses
DEBUG 23:19:42,091 get_slice
DEBUG 23:19:42,090 Read: 17 ms.
DEBUG 23:19:42,243 ReadCallback blocking for 1 responses
DEBUG 23:19:42,090 Read: 19 ms.
DEBUG 23:19:42,090 reading data for SliceFromReadCommand(table=&apos;Keyspace1&apos;, key=&apos;30353131363631&apos;, column_parent=&apos;QueryPath(columnFamilyName=&apos;Standard1&apos;, superColumnName=&apos;null&apos;, columnName=&apos;null&apos;)&apos;, start=&apos;&apos;, finish=&apos;&apos;, reversed=false, count=5) locally
DEBUG 23:19:42,089 ReadCallback blocking for 1 responses
DEBUG 23:19:42,243 reading data for SliceFromReadCommand(table=&apos;Keyspace1&apos;, key=&apos;30353532343833&apos;, column_parent=&apos;QueryPath(columnFamilyName=&apos;Standard1&apos;, superColumnName=&apos;null&apos;, columnName=&apos;null&apos;)&apos;, start=&apos;&apos;, finish=&apos;&apos;, reversed=false, count=5) locally
DEBUG 23:19:42,244 LocalReadRunnable reading SliceFromReadCommand(table=&apos;Keyspace1&apos;, key=&apos;30353532343833&apos;, column_parent=&apos;QueryPath(columnFamilyName=&apos;Standard1&apos;, superColumnName=&apos;null&apos;, columnName=&apos;null&apos;)&apos;, start=&apos;&apos;, finish=&apos;&apos;, reversed=false, count=5)
DEBUG 23:19:42,244 Read: 1 ms.
DEBUG 23:19:42,243 reading data for SliceFromReadCommand(table=&apos;Keyspace1&apos;, key=&apos;30363137363033&apos;, column_parent=&apos;QueryPath(columnFamilyName=&apos;Standard1&apos;, superColumnName=&apos;null&apos;, columnName=&apos;null&apos;)&apos;, start=&apos;&apos;, finish=&apos;&apos;, reversed=false, count=5) locally
DEBUG 23:19:42,242 reading data for SliceFromReadCommand(table=&apos;Keyspace1&apos;, key=&apos;30363234303332&apos;, column_parent=&apos;QueryPath(columnFamilyName=&apos;Standard1&apos;, superColumnName=&apos;null&apos;, columnName=&apos;null&apos;)&apos;, start=&apos;&apos;, finish=&apos;&apos;, reversed=false, count=5) locally
DEBUG 23:19:42,242 LocalReadRunnable reading SliceFromReadCommand(table=&apos;Keyspace1&apos;, key=&apos;30333636313035&apos;, column_parent=&apos;QueryPath(columnFamilyName=&apos;Standard1&apos;, superColumnName=&apos;null&apos;, columnName=&apos;null&apos;)&apos;, start=&apos;&apos;, finish=&apos;&apos;, reversed=false, count=5)
DEBUG 23:19:42,241 LocalReadRunnable reading SliceFromReadCommand(table=&apos;Keyspace1&apos;, key=&apos;30343939323034&apos;, column_parent=&apos;QueryPath(columnFamilyName=&apos;Standard1&apos;, superColumnName=&apos;null&apos;, columnName=&apos;null&apos;)&apos;, start=&apos;&apos;, finish=&apos;&apos;, reversed=false, count=5)
DEBUG 23:19:42,245 Read: 3 ms.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12991473" author="jbellis" created="Mon, 7 Feb 2011 17:09:32 +0000"  >&lt;p&gt;v6 adds the new repair callbacks to DES latency tracking.&lt;/p&gt;</comment>
                            <comment id="12991717" author="jbellis" created="Mon, 7 Feb 2011 23:48:12 +0000"  >&lt;p&gt;v7 rebases post-1530.&lt;/p&gt;</comment>
                            <comment id="12991793" author="jbellis" created="Tue, 8 Feb 2011 05:02:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;RR does not appear to actually occur&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No digest reads are being sent but I don&apos;t know why.  v8 adds better debug logging around ReadCallback.endpoints creation which governs that.&lt;/p&gt;</comment>
                            <comment id="12992116" author="jbellis" created="Tue, 8 Feb 2011 19:11:26 +0000"  >&lt;p&gt;v9 fixes ReadCallback construction and adds more asserts around AsyncRepairRunner.&lt;/p&gt;</comment>
                            <comment id="12993212" author="jbellis" created="Thu, 10 Feb 2011 20:35:30 +0000"  >&lt;p&gt;v10 fixes a race where a quick repair would remove the data needed for the response to client.  it also splits repair and digest-processing resolvers into different classes.&lt;/p&gt;</comment>
                            <comment id="12994540" author="jbellis" created="Mon, 14 Feb 2011 22:44:06 +0000"  >&lt;p&gt;rebased v10&lt;/p&gt;</comment>
                            <comment id="12994569" author="brandon.williams" created="Mon, 14 Feb 2011 23:45:03 +0000"  >&lt;p&gt;+1, RR works, GC pressure is gone.&lt;/p&gt;</comment>
                            <comment id="12994884" author="jbellis" created="Tue, 15 Feb 2011 17:15:55 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="12995020" author="hudson" created="Tue, 15 Feb 2011 21:43:50 +0000"  >&lt;p&gt;Integrated in Cassandra-0.7 #280 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/Cassandra-0.7/280/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hudson.apache.org/hudson/job/Cassandra-0.7/280/&lt;/a&gt;)&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12471030" name="2069-v10.txt" size="69172" author="jbellis" created="Mon, 14 Feb 2011 22:44:06 +0000"/>
                            <attachment id="12470216" name="2069-v2.txt" size="32102" author="jbellis" created="Fri, 4 Feb 2011 06:04:06 +0000"/>
                            <attachment id="12470239" name="2069-v3.txt" size="30504" author="jbellis" created="Fri, 4 Feb 2011 15:38:42 +0000"/>
                            <attachment id="12470271" name="2069-v4.txt" size="30362" author="jbellis" created="Fri, 4 Feb 2011 19:37:41 +0000"/>
                            <attachment id="12470280" name="2069-v5.txt" size="30420" author="jbellis" created="Fri, 4 Feb 2011 21:22:40 +0000"/>
                            <attachment id="12470472" name="2069-v6.txt" size="36034" author="jbellis" created="Mon, 7 Feb 2011 17:09:32 +0000"/>
                            <attachment id="12470525" name="2069-v7.txt" size="36050" author="jbellis" created="Mon, 7 Feb 2011 23:48:12 +0000"/>
                            <attachment id="12470544" name="2069-v8.txt" size="38059" author="jbellis" created="Tue, 8 Feb 2011 05:02:42 +0000"/>
                            <attachment id="12470615" name="2069-v9.txt" size="38174" author="jbellis" created="Tue, 8 Feb 2011 19:11:26 +0000"/>
                            <attachment id="12470212" name="2069.txt" size="3360" author="jbellis" created="Fri, 4 Feb 2011 02:14:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>10.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20425</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 41 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0g94v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>92910</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>brandon.williams</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>