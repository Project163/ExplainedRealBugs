<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:34:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4427] Restarting a failed bootstrap instajoins the ring</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4427</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I think when we made auto_bootstrap = true the default, we broke the check for the bootstrap flag, creating a dangerous situation.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12597963">CASSANDRA-4427</key>
            <summary>Restarting a failed bootstrap instajoins the ring</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="brandon.williams">Brandon Williams</reporter>
                        <labels>
                    </labels>
                <created>Sun, 8 Jul 2012 23:06:30 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:31 +0000</updated>
                            <resolved>Tue, 31 Jul 2012 20:57:53 +0000</resolved>
                                        <fixVersion>1.1.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13413101" author="brandon.williams" created="Thu, 12 Jul 2012 19:20:53 +0000"  >&lt;p&gt;Patch to remove the check for non-system tables.  As far as I can tell, it makes no sense to have this condition, since you can partially stream some data during bootstrap, then die.  If you try again without clearing the machine, instajoin.&lt;/p&gt;

&lt;p&gt;It looks like this condition was added as part of a fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3219&quot; title=&quot;Nodes started at the same time end up with the same token&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3219&quot;&gt;&lt;del&gt;CASSANDRA-3219&lt;/del&gt;&lt;/a&gt; in commit de829f17, but the check was inverted and later fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3285&quot; title=&quot;Bootstrap is broken in 1.0.0-rc1&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3285&quot;&gt;&lt;del&gt;CASSANDRA-3285&lt;/del&gt;&lt;/a&gt;.  However, the reasoning behind having such a check at all is never explained and I can&apos;t see why it should be there.&lt;/p&gt;</comment>
                            <comment id="13413124" author="brandon.williams" created="Thu, 12 Jul 2012 19:48:33 +0000"  >&lt;p&gt;Updated to also remove strange seed check (if seed, then bootstrap?) which is impossible anyway due to previous check.&lt;/p&gt;</comment>
                            <comment id="13413145" author="jbellis" created="Thu, 12 Jul 2012 20:10:36 +0000"  >&lt;p&gt;Here&apos;s what we were trying to address there:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Now there is a actual new problem with 1.0.0. That problem is that when you start an initial cluster, i.e, when in 0.8 you would start node with auto-boostrap=false, you do often end up starting nodes simultaneously. That is why older version were using random token when auto-bootstrap was false. This problem does need to be fix for 1.0.0 because that is a serious regression. However, my argument is that even though we now default to auto-boostrap=true, that doesn&apos;t mean that there is no difference between setting up the initial nodes of a cluster and the latter bootstrapping of nodes to add capacity to an existing cluster. Indeed, in 1.0.0 we decided to draw this line based on whether a schema had been created or not (we call the bootstrap() method based on that). Imho, this means that we have no boostrap option and the &quot;I have no schema&quot; is the old auto-boostrap=false. So we should use random token in that case and balanced one otherwise the same way we are doing it in 0.8.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="13413244" author="brandon.williams" created="Thu, 12 Jul 2012 21:30:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;Indeed, in 1.0.0 we decided to draw this line based on whether a schema had been created or not&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This seems more dangerous than it was worth, since you can easily receive even partial schema within a couple of seconds, realize you made some sort of mistake (forgot to mount the data dir, etc) and restart it, possibly wrecking your production app.&lt;/p&gt;

&lt;p&gt;(The seed check still seems strange regardless)&lt;/p&gt;</comment>
                            <comment id="13413927" author="brandon.williams" created="Fri, 13 Jul 2012 18:14:34 +0000"  >&lt;p&gt;v2 takes a different approach that Sylvain kindly suggested, and changes the bootstrap flag from a boolean to a 3-way value so that we can detect previous attempts that failed, and try again.&lt;/p&gt;</comment>
                            <comment id="13413931" author="jbellis" created="Fri, 13 Jul 2012 18:19:30 +0000"  >&lt;p&gt;I think you&apos;re misreading the original seed logic...  !(isBootstrapped || isSeed) expands to !isBootstrapped &amp;amp;&amp;amp; !isSeed.  Still need that so that single-node clusters don&apos;t try to bootstrap.&lt;/p&gt;</comment>
                            <comment id="13413940" author="brandon.williams" created="Fri, 13 Jul 2012 18:27:48 +0000"  >&lt;p&gt;Oh, I see now.  v3 restores the seed check.&lt;/p&gt;</comment>
                            <comment id="13415631" author="jbellis" created="Mon, 16 Jul 2012 21:06:48 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;nit: worth adding a comment to explain wtf all the clauses of that if statement are, so we don&apos;t have to dig through ticket history next time&lt;/p&gt;</comment>
                            <comment id="13415647" author="brandon.williams" created="Mon, 16 Jul 2012 21:19:45 +0000"  >&lt;p&gt;Committed with comments added.&lt;/p&gt;</comment>
                            <comment id="13415714" author="jbellis" created="Mon, 16 Jul 2012 22:18:46 +0000"  >&lt;p&gt;Started trying to improve the comments and got stuck on the schema check: it&apos;s basically a no-op (except for the purposes of screwing up a partial bootstrap like this), since we perform the check before waiting for gossip to fill in the schema.&lt;/p&gt;

&lt;p&gt;Simpler fix at &lt;a href=&quot;https://github.com/jbellis/cassandra/tree/4427-4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jbellis/cassandra/tree/4427-4&lt;/a&gt; to move the schema check into getBootstrapToken.&lt;/p&gt;</comment>
                            <comment id="13416041" author="slebresne" created="Tue, 17 Jul 2012 09:39:33 +0000"  >&lt;p&gt;I believe this simpler fix doesn&apos;t handle the case of boostrapping multiple nodes into an existing cluster. Namely, in that case, that will have a schema and so the node will have a system table by the time it checks for it and we&apos;ll end up picking the same token for multiple nodes.&lt;/p&gt;

&lt;p&gt;Also, I think checking system tables existence is fairly fragile and I would prefer moving away from it. It is way too easy to screw that up by having something (anything) written to those system tables. Typically, I don&apos;t know if that fix works for multiple nodes started in a brand new cluster (with not all being seeds), because without careful checking I don&apos;t know if we can end up writing some info in the system tables before checking for getBootstrapToken.&lt;/p&gt;

&lt;p&gt;Overall I do like the idea of registering that the bootstrap is in process, because on top of (I think) fixing the problem in a non-fragile way, it also allows us better reporting. Even outside of the problem of generating tokens, I think it is reassuring for a user that restart a node that failed to boostrap to have the software acknowledge that it understand and handle correctly the situation.&lt;/p&gt;</comment>
                            <comment id="13416921" author="jbellis" created="Wed, 18 Jul 2012 07:35:30 +0000"  >&lt;blockquote&gt;&lt;p&gt;I believe this simpler fix doesn&apos;t handle the case of boostrapping multiple nodes into an existing cluster.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We&apos;ve never tried to prevent this in the existing cluster case, except by saying &quot;thou shalt space bootstraps apart two minutes,&quot; because the only way to stop it is to drop the &quot;balanced&quot; token picking altogether.  Adding &quot;bootstrap in progress&quot; concept does nothing for this one way or the other.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Namely, in that case, that will have a schema and so the node will have a system table by the time it checks for it and we&apos;ll end up picking the same token for multiple nodes.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is exactly how it&apos;s supposed to work: if there&apos;s a schema, we use &quot;existing cluster mode&quot; and pick a token to divide the range of the heaviest node (and cross our fingers that the user is spacing things out enough between node additions).  If there&apos;s no schema, we use &quot;new cluster mode&quot; and pick a random token.&lt;/p&gt;

&lt;p&gt;Let the record show that back in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3219&quot; title=&quot;Nodes started at the same time end up with the same token&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3219&quot;&gt;&lt;del&gt;CASSANDRA-3219&lt;/del&gt;&lt;/a&gt; I said this was confusing behavior and we should add explicit initial_token modes instead of trying to make it magical. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13416945" author="slebresne" created="Wed, 18 Jul 2012 08:44:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;Adding &quot;bootstrap in progress&quot; concept does nothing for this one way or the other.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You&apos;re right, brain fart, sorry.&lt;/p&gt;

&lt;p&gt;Anyway, there is still one behavior that the patch changes, that is it will always boobstrap non seeds node, while previously the system table check was making sure we never bootstrapped a node in a new cluster, independently of whether it was a seed or not.&lt;/p&gt;

&lt;p&gt;It is clearly not a bad idea when you start a new cluster to set all those nodes as seeds, but I just want to point out that the behavior is changed and I&apos;m not sure everyone always set all of its initial node as seeds today. I&apos;ll also note that boostrapping some of the node in an initial cluster don&apos;t break anything, it just makes the node start much less quickly that they would otherwise.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure how I feel about changing that behavior, especially in a minor release. The fact is that recording that bootstrap is in progress (along with the system table check) would allow to fix the instajoin while keeping the current behavior unchanged otherwise, and I do feel that recording the info is not a bad idea in itself, so that would have my preference. But that is not an extremely strong preference either.&lt;/p&gt;</comment>
                            <comment id="13417016" author="brandon.williams" created="Wed, 18 Jul 2012 11:51:36 +0000"  >&lt;blockquote&gt;&lt;p&gt;The fact is that recording that bootstrap is in progress (along with the system table check) would allow to fix the instajoin while keeping the current behavior unchanged otherwise, and I do feel that recording the info is not a bad idea in itself, so that would have my preference.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I tend to agree that having an explicit, persisted flag feels a lot less fragile than the current logic, and being able to indicate a failure to the user seems like a good improvement.&lt;/p&gt;</comment>
                            <comment id="13420736" author="jbellis" created="Mon, 23 Jul 2012 16:06:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;there is still one behavior that the patch changes, that is it will always boobstrap non seeds node&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You&apos;re right.  Okay, take five: &lt;a href=&quot;https://github.com/jbellis/cassandra/tree/4427-5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jbellis/cassandra/tree/4427-5&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;4 patches here on top of Brandon&apos;s work.  The main ones are the 1st and 4th.  In the first, I remove the seed special case since it&apos;s a subset of the empty schema case.  (Unless you&apos;re Doing It Wrong and adding seed nodes directly to an active cluster, which always surprises people when it burns them.  So I say good riddance.)&lt;/p&gt;

&lt;p&gt;The first also adds a 2-gossip-round sleep so that (always assuming seeds are set correctly) we eliminate the risk of thinking schema is empty incorrectly due to a race w/ gossip.  The fourth patch follows this up by making the schema check based on other peers&apos; schema uuids instead of local data.  Which is unlikely to be a problem today, but is is still a race-y approach and the correct alternative was straightforward.&lt;/p&gt;</comment>
                            <comment id="13423777" author="slebresne" created="Fri, 27 Jul 2012 10:06:49 +0000"  >&lt;p&gt;In the check for bootstrap:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;if (DatabaseDescriptor.isAutoBootstrap()
    &amp;amp;&amp;amp; (SystemTable.bootstrapInProgress() || (!SystemTable.bootstrapComplete() &amp;amp;&amp;amp; !schemaPresent)))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I believe the schemaPresent condition shouldn&apos;t be negated. We want to skip boostrap is there is no schema, but bootstrap if there is one.&lt;/p&gt;

&lt;p&gt;Even with that fixed, this breaks some of the unit tests (BoostrapperTest, EmbeddedCassandraServiceTest, StreamingTransferTest and AntiEntropyServiceStandardTest). Namely:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;junit] java.lang.RuntimeException: No other nodes seen!  Unable to bootstrap.If you intended to start a single-node cluster, you should make sure your broadcast_address (or listen_address) is listed as a seed.  Otherwise, you need to determine why the seed being contacted has no knowledge of the rest of the cluster.  Usually, this can be solved by giving all nodes the same seed list.
junit] 	at org.apache.cassandra.dht.BootStrapper.getBootstrapSource(BootStrapper.java:127)
junit] 	at org.apache.cassandra.dht.BootStrapper.getBalancedToken(BootStrapper.java:109)
junit] 	at org.apache.cassandra.dht.BootStrapper.getBootstrapToken(BootStrapper.java:104)
junit] 	at org.apache.cassandra.service.StorageService.joinTokenRing(StorageService.java:629)
junit] 	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:526)
junit] 	at org.apache.cassandra.dht.BootStrapperTest.testTokenRoundtrip(BootStrapperTest.java:50)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On committing to 1.0, I&apos;m not sure what was the intention, but this feels a bit bigger than what I&apos;m plainly confortable pushing in 1.0 at this point, and it feels we can tell people on 1.0 to wipe the data dir on a failed boostrap before retrying. That&apos;s not a strong opposition though, more an opinion.&lt;/p&gt;

&lt;p&gt;Nits:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Instead of calculateEmptySchema(), I would have put the initialization fo Schema.emptyVersion in a static block to make it explicit that it&apos;s a one time initialization. Though if you made that on purpose because you don&apos;t like static blocks, that&apos;s good enough for me.&lt;/li&gt;
	&lt;li&gt;We log when we detect a boostrap failure, but it could be nice to also log whether we&apos;re going to boostrap or not and why in the other case.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13423909" author="slebresne" created="Fri, 27 Jul 2012 14:48:27 +0000"  >&lt;p&gt;I suspect the test failures are due to the removal of the seeds special case and because our tests are not fully realistic. Namely, in the tests, while localhost is a seed, it gets a schema loaded before joinTokenRing is called, and so it ends up with schemaPresent = true and tries to bootstrap (even though it&apos;s the only node). That shouldn&apos;t happen in real life but at least on the short term fixing the tests themselves is more work than is worth it, so maybe we can:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Either we back the isSeed test&lt;/li&gt;
	&lt;li&gt;Or exclude ourselves when we check for schemaPresent&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Some Preference?&lt;/p&gt;</comment>
                            <comment id="13424177" author="jbellis" created="Fri, 27 Jul 2012 22:02:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;I believe the schemaPresent condition shouldn&apos;t be negated&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right, fix pushed to same github branch.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I would have put the initialization fo Schema.emptyVersion in a static block to make it explicit that it&apos;s a one time initialization&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I thought you couldn&apos;t declare emptyVersion final that way...  I was wrong, the compiler is smart enough to recognize the static block.  Also fixed.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;it could be nice to also log whether we&apos;re going to boostrap or not and why in the other case.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Added a debug line.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;exclude ourselves when we check for schemaPresent&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Done.  (Since we can&apos;t have one ourselves unless another does too &amp;#8211; or unless we already joined the ring successfully &amp;#8211; there is no loss of correctness.)&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;this feels a bit bigger than what I&apos;m plainly confortable pushing in 1.0 at this point&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1, let&apos;s leave it as a known issue in 1.0.&lt;/p&gt;</comment>
                            <comment id="13424311" author="slebresne" created="Sat, 28 Jul 2012 09:54:41 +0000"  >&lt;p&gt;lgtm, +1&lt;/p&gt;</comment>
                            <comment id="13424563" author="brandon.williams" created="Sun, 29 Jul 2012 14:59:34 +0000"  >&lt;p&gt;This doesn&apos;t quite work, because we&apos;re looking for the SCHEMA app state, which at startup won&apos;t always exist:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [main] 2012-07-29 01:08:28,476 CassandraDaemon.java (line 335) Exception encountered during startup
java.lang.NullPointerException
        at org.apache.cassandra.service.StorageService.joinTokenRing(StorageService.java:527)
        at org.apache.cassandra.service.StorageService.initServer(StorageService.java:475)
        at org.apache.cassandra.service.StorageService.initServer(StorageService.java:366)
        at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:228)
        at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:318)
        at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:361)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13424580" author="brandon.williams" created="Sun, 29 Jul 2012 16:24:10 +0000"  >&lt;p&gt;Note: that was with autobootstrap disabled.  But, I&apos;m also not convinced that waiting two gossiper rounds is sufficient either (alert the ring_delay police!)&lt;/p&gt;

&lt;p&gt;It&apos;s possible that you could have 3 seeds and all but one could be down, thus 2 gossip rounds doesn&apos;t guarantee you&apos;ll have any appstates.&lt;/p&gt;</comment>
                            <comment id="13424590" author="jbellis" created="Sun, 29 Jul 2012 17:27:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;This doesn&apos;t quite work, because we&apos;re looking for the SCHEMA app state, which at startup won&apos;t always exist&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Added a quick fix for this case.  If the cluster is so new that there is no SCHEMA state, then there&apos;s no actual schema info either.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;It&apos;s possible that you could have 3 seeds and all but one could be down, thus 2 gossip rounds doesn&apos;t guarantee you&apos;ll have any appstates&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Granted, but surely two rounds is a better measure than the zero we had before.  (Which apparently worked most of the time...)  Remember, our goal is to avoid the full RING_DELAY sleep when we don&apos;t need to bootstrap.&lt;/p&gt;</comment>
                            <comment id="13424595" author="brandon.williams" created="Sun, 29 Jul 2012 17:39:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;Added a quick fix for this case. If the cluster is so new that there is no SCHEMA state, then there&apos;s no actual schema info either.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;LGTM.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Granted, but surely two rounds is a better measure than the zero we had before. (Which apparently worked most of the time...) Remember, our goal is to avoid the full RING_DELAY sleep when we don&apos;t need to bootstrap.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I know.  It&apos;s a situation with no perfect solution unfortunately (but I agree 2 &amp;gt; 0 &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13425881" author="brandon.williams" created="Tue, 31 Jul 2012 16:13:03 +0000"  >&lt;p&gt;Well, bad news, something here is still broken:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;DEBUG [main] 2012-07-31 10:52:40,564 MigrationManager.java (line 240) Gossiping my schema version 59adb24e-f3cd-3e02-97f0-5b395827453f
...
DEBUG [main] 2012-07-31 10:52:42,584 StorageService.java (line 591) Bootstrap variables: true false false false
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and it joins the ring, where it should have bootstrapped.  I&apos;m not sure why the schema check is failing, but it&apos;s causing problems for the dtests and happens in a very reproducible manner.&lt;/p&gt;</comment>
                            <comment id="13425905" author="jbellis" created="Tue, 31 Jul 2012 16:35:37 +0000"  >&lt;p&gt;59adb24e-f3cd-3e02-97f0-5b395827453f is emptyVersion, so from that snippet it looks like it&apos;s working as designed.&lt;/p&gt;</comment>
                            <comment id="13425920" author="brandon.williams" created="Tue, 31 Jul 2012 16:56:05 +0000"  >&lt;p&gt;Here&apos;s the real problem:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
 INFO 16:49:57,531 Starting up server gossip
 INFO 16:49:57,547 Enqueuing flush of Memtable-LocationInfo@1547338589(126/157 serialized/live bytes, 3 ops)
 INFO 16:49:57,548 Writing Memtable-LocationInfo@1547338589(126/157 serialized/live bytes, 3 ops)
 INFO 16:49:57,586 Completed flushing /var/lib/cassandra/data/system/LocationInfo/system-LocationInfo-he-1-Data.db (234 bytes) for commitlog position ReplayPosition(segmentId=10938112371080118, position=595)
 INFO 16:49:57,616 Starting Messaging Service on port 7000
 INFO 16:49:59,634 Saved token not found. Using 113427455640312821154458202477256070484 from configuration
 INFO 16:49:59,636 Enqueuing flush of Memtable-LocationInfo@1088940267(53/66 serialized/live bytes, 2 ops)
 INFO 16:49:59,636 Writing Memtable-LocationInfo@1088940267(53/66 serialized/live bytes, 2 ops)
 INFO 16:49:59,652 Completed flushing /var/lib/cassandra/data/system/LocationInfo/system-LocationInfo-he-2-Data.db (163 bytes) for commitlog position ReplayPosition(segmentId=10938112371080118, position=776)
 INFO 16:49:59,655 Node cassandra-3/10.179.111.137 state jump to normal
 INFO 16:49:59,656 Bootstrap/Replace/Move completed! Now serving reads.
 INFO 16:49:59,690 Binding thrift service to cassandra-3/10.179.111.137:9160
 INFO 16:49:59,694 Using TFastFramedTransport with a max frame size of 15728640 bytes.
 INFO 16:49:59,698 Using synchronous/threadpool thrift server on cassandra-3/10.179.111.137 : 9160
 INFO 16:49:59,699 Listening for thrift clients...
 INFO 16:49:59,873 Node /10.179.64.227 is now part of the cluster
 INFO 16:49:59,874 InetAddress /10.179.64.227 is now UP
 INFO 16:49:59,876 Enqueuing flush of Memtable-LocationInfo@1301257077(35/43 serialized/live bytes, 1 ops)
 INFO 16:49:59,877 Writing Memtable-LocationInfo@1301257077(35/43 serialized/live bytes, 1 ops)
 INFO 16:49:59,892 Completed flushing /var/lib/cassandra/data/system/LocationInfo/system-LocationInfo-he-3-Data.db (89 bytes) for commitlog position ReplayPosition(segmentId=10938112371080118, position=874)
 INFO 16:49:59,894 Node /10.179.65.102 is now part of the cluster
 INFO 16:49:59,894 InetAddress /10.179.65.102 is now UP
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Gossip hasn&apos;t quite discovered any other nodes yet when the schema check fires.&lt;/p&gt;</comment>
                            <comment id="13425958" author="jbellis" created="Tue, 31 Jul 2012 17:48:39 +0000"  >&lt;p&gt;Patch attached to add back seed logic and move the schema check into getBootstrapToken.&lt;/p&gt;</comment>
                            <comment id="13425991" author="brandon.williams" created="Tue, 31 Jul 2012 18:25:41 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13426007" author="brandon.williams" created="Tue, 31 Jul 2012 18:42:38 +0000"  >&lt;p&gt;We can save an appreciable amount of time by checking for schema during the delay, and then short circuiting to the isReadyForBootstrap check.&lt;/p&gt;</comment>
                            <comment id="13426074" author="jbellis" created="Tue, 31 Jul 2012 20:01:14 +0000"  >&lt;p&gt;Don&apos;t you still want the full ring delay to make sure you know about everyone in the cluster (so if you are picking a &quot;balanced&quot; token it does the Right Thing)?&lt;/p&gt;</comment>
                            <comment id="13426075" author="brandon.williams" created="Tue, 31 Jul 2012 20:04:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;Don&apos;t you still want the full ring delay to make sure you know about everyone in the cluster (so if you are picking a &quot;balanced&quot; token it does the Right Thing)?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Well, if we got any non-empty schema, a full gossip round has occurred so we should be good to go at that point, since it will have also populated our knowledge of the ring.&lt;/p&gt;</comment>
                            <comment id="13426085" author="jbellis" created="Tue, 31 Jul 2012 20:22:48 +0000"  >&lt;p&gt;+1 then.&lt;/p&gt;

&lt;p&gt;nit: i&apos;d also change sleep(delay) in the MigrationManager loop to sleep(1000), or even sleep(100)&lt;/p&gt;</comment>
                            <comment id="13426118" author="brandon.williams" created="Tue, 31 Jul 2012 20:57:53 +0000"  >&lt;p&gt;Committed w/nit fixed to sleep(1000), since if it&apos;s not complete logging every 100ms would be a bit annoying.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12538579" name="4427-4.txt" size="6434" author="jbellis" created="Tue, 31 Jul 2012 17:48:39 +0000"/>
                            <attachment id="12538597" name="4427-5.txt" size="7772" author="brandon.williams" created="Tue, 31 Jul 2012 18:51:05 +0000"/>
                            <attachment id="12536426" name="4427-v2.txt" size="5852" author="brandon.williams" created="Fri, 13 Jul 2012 18:14:34 +0000"/>
                            <attachment id="12536429" name="4427-v3.txt" size="5929" author="brandon.williams" created="Fri, 13 Jul 2012 18:27:48 +0000"/>
                            <attachment id="12536264" name="4427.txt" size="1437" author="brandon.williams" created="Thu, 12 Jul 2012 19:48:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>256148</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 17 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gvr3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>96574</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>