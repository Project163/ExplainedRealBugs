<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:58:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7953] RangeTombstones not merging during compaction</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7953</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When performing a compaction on two sstables that contain the same RangeTombstone with different timestamps, the tombstones are not merged in the new sstable.&lt;/p&gt;

&lt;p&gt;This has been tested using cassandra 2.1 with the following table:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE TABLE test(
  key text,
  column text,
  data text,
  PRIMARY KEY(key, column)
);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And then doing the following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;INSERT INTO test (key, column, data) VALUES (&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;); &lt;span class=&quot;code-comment&quot;&gt;// If the sstable only contains tombstones during compaction it seems that the sstable either gets removed or isn&apos;t created (but that could probably be a separate JIRA issue).
&lt;/span&gt;INSERT INTO test (key, column, data) VALUES (&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;); &lt;span class=&quot;code-comment&quot;&gt;// The inserts are not actually needed, since the deletes create tombstones either way.
&lt;/span&gt;DELETE FROM test WHERE key=&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt; AND column=&lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;;

nodetool flush

INSERT INTO test (key, column, data) VALUES (&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;);
DELETE FROM test WHERE key=&lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt; AND column=&lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;;

nodetool flush
nodetool compact
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When checking with the SSTableExport tool two tombstones exists in the compacted sstable. This can be repeated, resulting in more and more tombstones.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Cassandra 2.1&lt;/p&gt;</environment>
        <key id="12742136">CASSANDRA-7953</key>
            <summary>RangeTombstones not merging during compaction</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blambov">Branimir Lambov</assignee>
                                    <reporter username="molsson">Marcus Olsson</reporter>
                        <labels>
                            <label>compaction</label>
                            <label>deletes</label>
                            <label>tombstone</label>
                    </labels>
                <created>Wed, 17 Sep 2014 13:30:04 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:34 +0000</updated>
                            <resolved>Tue, 1 Dec 2015 15:17:20 +0000</resolved>
                                        <fixVersion>2.1.12</fixVersion>
                    <fixVersion>2.2.4</fixVersion>
                                        <due></due>
                            <votes>7</votes>
                                    <watches>24</watches>
                                                                                                                <comments>
                            <comment id="14137222" author="molsson" created="Wed, 17 Sep 2014 13:42:30 +0000"  >&lt;p&gt;When merging cells the tombstones where compared with their markedForDeleteAt if their range was equal. I assume that if the ranges are equal(or if the latest tombstone includes the former) they should be merged instead.&lt;/p&gt;</comment>
                            <comment id="14138654" author="krummas" created="Thu, 18 Sep 2014 07:45:02 +0000"  >&lt;blockquote&gt;&lt;p&gt;If the sstable only contains tombstones during compaction it seems that the sstable either gets removed or isn&apos;t created&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7969&quot; title=&quot;Properly track min/max timestamps and maxLocalDeletionTimes for range and row tombstones&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7969&quot;&gt;&lt;del&gt;CASSANDRA-7969&lt;/del&gt;&lt;/a&gt; for this&lt;/p&gt;

&lt;p&gt;will have a look at your patch now&lt;/p&gt;</comment>
                            <comment id="14138713" author="molsson" created="Thu, 18 Sep 2014 09:15:29 +0000"  >&lt;p&gt;Added case for when tombstone timestamps are equal, but not the range.&lt;/p&gt;</comment>
                            <comment id="14140398" author="krummas" created="Fri, 19 Sep 2014 11:55:50 +0000"  >&lt;p&gt;in general, LGTM&lt;/p&gt;

&lt;p&gt;Attaching slightly updated patch, please have a look to verify that I didn&apos;t break anything&lt;/p&gt;</comment>
                            <comment id="14140469" author="molsson" created="Fri, 19 Sep 2014 13:31:31 +0000"  >&lt;p&gt;Seems right&lt;/p&gt;</comment>
                            <comment id="14151434" author="krummas" created="Mon, 29 Sep 2014 07:04:49 +0000"  >&lt;p&gt;It might not be safe to change the comparator for this, a proper fix should probably be in RangeTombstone.Tracker and remove all unnecessary RTs (not only the ones that have the same start point). It might not be trivial in our new (since &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4180&quot; title=&quot;Single-pass compaction for LCR&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4180&quot;&gt;&lt;del&gt;CASSANDRA-4180&lt;/del&gt;&lt;/a&gt;) single-pass compaction though&lt;/p&gt;</comment>
                            <comment id="14151608" author="molsson" created="Mon, 29 Sep 2014 11:49:47 +0000"  >&lt;p&gt;Could an alternative be to change the onDiskAtomComparator to only check for equal ranges, instead of inclusive ranges?&lt;/p&gt;</comment>
                            <comment id="14947065" author="blambov" created="Wed, 7 Oct 2015 15:47:37 +0000"  >&lt;p&gt;Patch to remove redundant tombstones uploaded &lt;a href=&quot;https://github.com/blambov/cassandra/tree/7953-rt-merge-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here for 2.1&lt;/a&gt; (&lt;a href=&quot;http://cassci.datastax.com/job/blambov-7953-rt-merge-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt; &lt;a href=&quot;http://cassci.datastax.com/job/blambov-7953-rt-merge-2.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;) and &lt;a href=&quot;https://github.com/blambov/cassandra/tree/7953-rt-merge-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here for 2.2&lt;/a&gt; (&lt;a href=&quot;http://cassci.datastax.com/job/blambov-7953-rt-merge-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt; &lt;a href=&quot;http://cassci.datastax.com/job/blambov-7953-rt-merge-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;, still running).&lt;/p&gt;

&lt;p&gt;Delays writing tombstones until the next cell arrives, allowing redundant ones to be recognized and skipped. Removes superseded equal as well as completely covered tombstones. Does not change comparator.&lt;/p&gt;

&lt;p&gt;3.0 is not affected as &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8099&quot; title=&quot;Refactor and modernize the storage engine&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8099&quot;&gt;&lt;del&gt;CASSANDRA-8099&lt;/del&gt;&lt;/a&gt; includes a much better treatment of tombstones that covers this issue.&lt;/p&gt;</comment>
                            <comment id="14954591" author="krummas" created="Tue, 13 Oct 2015 08:11:19 +0000"  >&lt;p&gt;Very nice, just one worry - if we have a very wide partition with only non-duplicate RTs (say with increasing &lt;tt&gt;.min&lt;/tt&gt; and &lt;tt&gt;.max&lt;/tt&gt;), we will keep them all in memory until we call .build(). Could we write all unwritten tombstones that have &lt;tt&gt;unwritten.max &amp;lt; toAdd.name()&lt;/tt&gt; in &lt;tt&gt;Tracker.update(..)&lt;/tt&gt;? That should make sure we will not be able to remove the unwritten one due to duplication, right?&lt;/p&gt;</comment>
                            <comment id="14954862" author="blambov" created="Tue, 13 Oct 2015 12:43:04 +0000"  >&lt;p&gt;This is correct, we will hold all RTs in the &lt;tt&gt;unwrittenTombstones&lt;/tt&gt; list until the &lt;tt&gt;build()&lt;/tt&gt; call in this case. The reason I did not address this is to avoid the necessary additional comparison, with the belief that there is actually no way to generate such a sequence of RTs, or generally overlapping but not completely contained tombstones (except possibly for 3.0+ using &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6237&quot; title=&quot;Allow range deletions in CQL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6237&quot;&gt;&lt;del&gt;CASSANDRA-6237&lt;/del&gt;&lt;/a&gt;). Am I missing something there, could one actually do that?&lt;/p&gt;</comment>
                            <comment id="14954904" author="krummas" created="Tue, 13 Oct 2015 13:11:41 +0000"  >&lt;p&gt;There is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5435&quot; title=&quot;Support range tombstones from thrift&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5435&quot;&gt;&lt;del&gt;CASSANDRA-5435&lt;/del&gt;&lt;/a&gt; - but I dunno if we should worry about that, wdyt &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="14954942" author="slebresne" created="Tue, 13 Oct 2015 13:41:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;There is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5435&quot; title=&quot;Support range tombstones from thrift&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5435&quot;&gt;&lt;del&gt;CASSANDRA-5435&lt;/del&gt;&lt;/a&gt; - but I dunno if we should worry about that&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;d say we don&apos;t (worry about it). Range tombstones through thrift is a very late addition and it&apos;s almost surely barely used (I&apos;m not sure most of the thrift clients even support it). And we&apos;re not talking of breaking that feature here, just to trade-off higher memory consumption in a very unlikely scenario against saving comparisons in most cases. I think that&apos;s the right choice.&lt;/p&gt;</comment>
                            <comment id="14955005" author="krummas" created="Tue, 13 Oct 2015 14:17:08 +0000"  >&lt;p&gt;OK, +1 on the patch then&lt;/p&gt;</comment>
                            <comment id="14958849" author="fhsgoncalves" created="Thu, 15 Oct 2015 12:57:26 +0000"  >&lt;p&gt;We have experienced the same behaviour described on ticket &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10505&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-10505&lt;/a&gt;: &quot;Once this happens in multiple sstables, compacting them causes the duplication to grow. The more this occurs, the worse the problem gets.&quot;&lt;/p&gt;

&lt;p&gt;Basically, when we run the repair in the node, the compaction process starts and never ends, many pending tasks, and the number of sstables of one table grows exponentially (reaching 34k sstables). We use one column of the type map&amp;lt;text, text&amp;gt;, LeveledStrategyCompaction, and many updates to this column. The memory consumption grows a lot too. We decide to stop the repair process and kill the node, because the latency grown a lot too and impact the whole cluster. But we need to run repair again, because we kill one node and put a new node on the cluster, and another node was impacted from this bug again, and we need to repeated the process: kill the repair process, kill the node, start a new node.&lt;/p&gt;

&lt;p&gt;So we just created another table without using the collection map, but using blob type instead, and migrate all the data for it - we are fine now: the repair process and compaction finished successfully without big impact on performance.&lt;/p&gt;

&lt;p&gt;Please, give attention for this ticket, I think that its a major issue!&lt;/p&gt;</comment>
                            <comment id="14958871" author="eitikimura" created="Thu, 15 Oct 2015 13:12:28 +0000"  >&lt;p&gt;Hello guys whe are you planning to release this patch? &lt;br/&gt;
we are facing the same problem as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fhsgoncalves&quot; class=&quot;user-hover&quot; rel=&quot;fhsgoncalves&quot;&gt;fhsgoncalves&lt;/a&gt; described above &lt;/p&gt;</comment>
                            <comment id="14958919" author="krummas" created="Thu, 15 Oct 2015 13:39:37 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="14961444" author="ostefano" created="Fri, 16 Oct 2015 22:18:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; Does this mean that range deletes via standard CQL driver are not affected by all these concerns?&lt;/p&gt;</comment>
                            <comment id="14962992" author="slebresne" created="Mon, 19 Oct 2015 08:47:35 +0000"  >&lt;p&gt;Depends what you mean by &quot;all these concerns&quot;. The ticket itself does affect CQL, but the concern about the patch to fix accumulating too much RTs in memory shouldn&apos;t indeed be a problem for deletions done through CQL.&lt;/p&gt;</comment>
                            <comment id="14963023" author="ostefano" created="Mon, 19 Oct 2015 09:12:48 +0000"  >&lt;p&gt;I am thinking of a scenario where queries such as &quot;DELETE WHERE primary_key = X and cluster_key &amp;lt; Y&quot; are heavily used (only possible with C* 3). If such queries generate 1 RT, accumulating in memory should not be an issue. Can you confirm me this is the case?&lt;/p&gt;</comment>
                            <comment id="14963031" author="slebresne" created="Mon, 19 Oct 2015 09:15:07 +0000"  >&lt;p&gt;That ticket doesn&apos;t affect C* 3.0 at all, so I can confirm that you&apos;re fine.&lt;/p&gt;</comment>
                            <comment id="15033346" author="blambov" created="Tue, 1 Dec 2015 08:42:31 +0000"  >&lt;p&gt;Reopening ticket as patch can cause a problem receiving streamed tables where range tombstones can be written after END_OF_ROW markers.&lt;/p&gt;</comment>
                            <comment id="15033363" author="slebresne" created="Tue, 1 Dec 2015 08:54:20 +0000"  >&lt;p&gt;Can you open a new ticket (referencing this one) instead? We avoid re-opening ticket for which some code has been committed to a released version as that makes tracking what is in which version harder. Thanks.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12904209">CASSANDRA-10505</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12917190">CASSANDRA-10791</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12669981" name="0001-7953-v2.patch" size="5300" author="marcuse" created="Fri, 19 Sep 2014 11:55:50 +0000"/>
                            <attachment id="12669681" name="CASSANDRA-7953-1.patch" size="5344" author="molsson" created="Thu, 18 Sep 2014 09:14:14 +0000"/>
                            <attachment id="12669401" name="CASSANDRA-7953.patch" size="4745" author="molsson" created="Wed, 17 Sep 2014 13:43:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blambov]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 51 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i205o7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332360">2.2.x</customfieldvalue>
    <customfieldvalue id="12327256">2.1.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>