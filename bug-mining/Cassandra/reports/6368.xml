<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:28:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-18935] Fix nodetool enable/disablebinary to correctly set rpc</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-18935</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 &#160;&#160;&#160;&#160;&#160;&#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((nativeFlag != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.parseBoolean(nativeFlag)) || (nativeFlag == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; DatabaseDescriptor.startNativeTransport()))
&#160;&#160;&#160;&#160;&#160;&#160;&#160; {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; startNativeTransport();
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; StorageService.instance.setRpcReady(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
&#160;&#160;&#160;&#160;&#160;&#160;&#160; } &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The startup code here only sets RpcReady if native transport is enabled. If you call&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
nodetool enablebinary&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;then this flag doesn&apos;t get set.&lt;/p&gt;

&lt;p&gt;But with the change from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13043&quot; title=&quot;UnavailabeException caused by counter writes forwarded to leaders without complete cluster view&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13043&quot;&gt;&lt;del&gt;CASSANDRA-13043&lt;/del&gt;&lt;/a&gt; it requires RpcReady set to true in order to get a leader for the counter update.&lt;/p&gt;

&lt;p&gt;Not sure what the correct fix is here, seems to only really use this flag for counters. So thinking perhaps the fix is to just move this outside the if condition.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13554475">CASSANDRA-18935</key>
            <summary>Fix nodetool enable/disablebinary to correctly set rpc</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="smiklosovic">Stefan Miklosovic</assignee>
                                    <reporter username="cam1982">Cameron Zemek</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 Oct 2023 22:50:39 +0000</created>
                <updated>Tue, 5 Dec 2023 12:51:33 +0000</updated>
                            <resolved>Wed, 29 Nov 2023 11:34:52 +0000</resolved>
                                        <fixVersion>3.0.30</fixVersion>
                    <fixVersion>3.11.17</fixVersion>
                    <fixVersion>4.0.12</fixVersion>
                    <fixVersion>4.1.4</fixVersion>
                    <fixVersion>5.0-beta1</fixVersion>
                    <fixVersion>5.0</fixVersion>
                    <fixVersion>5.1</fixVersion>
                                    <component>Legacy/Core</component>
                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="9600">2h 40m</timespent>
                                <comments>
                            <comment id="17776464" author="maxwellguo" created="Wed, 18 Oct 2023 02:57:30 +0000"  >&lt;p&gt;So, why not set the flag when doing nodetool enablebinary if we found the flag is not true? If I understand your description correctly.&lt;/p&gt;</comment>
                            <comment id="17776558" author="smiklosovic" created="Wed, 18 Oct 2023 08:35:06 +0000"  >&lt;p&gt;I think there is also another issue&lt;/p&gt;

&lt;p&gt;if you start it all just fine and then you do nodetool disablebinary it will not set rpc to false.&lt;/p&gt;

&lt;p&gt;so then this &lt;a href=&quot;https://github.com/apache/cassandra/commit/36bdc253193318ceaf5beb9bc5e869f6af590cb1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/36bdc253193318ceaf5beb9bc5e869f6af590cb1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;it will still think rpc is true / that native transport is running there&lt;/p&gt;</comment>
                            <comment id="17776559" author="brandon.williams" created="Wed, 18 Oct 2023 08:36:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;why not set the flag when doing nodetool enablebinary if we found the flag is not true&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, that&apos;s the correct fix, having enablebinary also call setRpcReady(true).  Given that the call appears idempotent, we could move it into the start/stop native transport calls directly.  It&apos;s probably a vestige of having thrift and the native protocol.&lt;/p&gt;</comment>
                            <comment id="17776564" author="smiklosovic" created="Wed, 18 Oct 2023 08:50:10 +0000"  >&lt;p&gt;pinging &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; if this patch makes sense to him &lt;a href=&quot;https://github.com/apache/cassandra/pull/2817&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2817&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17776565" author="brandon.williams" created="Wed, 18 Oct 2023 08:54:58 +0000"  >&lt;p&gt;LGTM&lt;/p&gt;</comment>
                            <comment id="17776569" author="maxwellguo" created="Wed, 18 Oct 2023 09:05:59 +0000"  >&lt;p&gt;So it seems that we need to create a bug fix for nodetool enablebinary and disablebinary&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17776582" author="smiklosovic" created="Wed, 18 Oct 2023 09:50:44 +0000"  >&lt;p&gt;I just renamed the ticket.&lt;/p&gt;</comment>
                            <comment id="17776634" author="smiklosovic" created="Wed, 18 Oct 2023 12:19:53 +0000"  >&lt;p&gt;Patches are available. I will build it all in next days.&lt;/p&gt;</comment>
                            <comment id="17777220" author="smiklosovic" created="Thu, 19 Oct 2023 11:47:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3369/workflows/b1dceb9a-e45d-4b1a-b4db-394f361f2689&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk j17&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3368/workflows/8309cbb1-cd5b-4945-b590-329617e44c92&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0 j17&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3367/workflows/8d968041-fd54-4cba-87e2-0d939b7376ca&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.1 j11&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3366/workflows/e4d5c713-cb48-46e5-979b-fc139a6c0733&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0 j11&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3350/workflows/8416bbd5-a736-49ee-aa50-0a98f5c9eee2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11 j8&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3365/workflows/689b2ed4-a32b-4ee7-9b1e-f5bfd53d1d9c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 j8&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17777308" author="brandon.williams" created="Thu, 19 Oct 2023 15:04:32 +0000"  >&lt;p&gt;Missing some JDK runs?&lt;/p&gt;</comment>
                            <comment id="17777316" author="smiklosovic" created="Thu, 19 Oct 2023 15:08:43 +0000"  >&lt;p&gt;since it is the very same patch just applied to various branches, I would say that we tested it all from Java 8 to 17 &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17777329" author="brandon.williams" created="Thu, 19 Oct 2023 15:25:18 +0000"  >&lt;p&gt;Fair enough, it&apos;s a simple patch.  The failure in 5.0 is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18360&quot; title=&quot;Test Failure: o.a.c.cql3.validation.operations.AlterTest#testDropListAndAddListWithSameName&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18360&quot;&gt;CASSANDRA-18360&lt;/a&gt; and it didn&apos;t repro on trunk so nothing to be concerned about there. +1&lt;/p&gt;</comment>
                            <comment id="17778662" author="brandon.williams" created="Mon, 23 Oct 2023 13:21:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1346/workflows/b3fec612-e901-4166-a18a-8e1c88128f42&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Upgrade tests&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17778746" author="smiklosovic" created="Mon, 23 Oct 2023 16:46:25 +0000"  >&lt;p&gt;passed &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1346/workflows/b3fec612-e901-4166-a18a-8e1c88128f42/jobs/59243&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/driftx/cassandra/1346/workflows/b3fec612-e901-4166-a18a-8e1c88128f42/jobs/59243&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17786894" author="JIRAUSER291682" created="Thu, 16 Nov 2023 18:52:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt; Does this mean after this change, if a cluster has multiple nodes binary disabled for some reason, for certain partitions, the counter update will always get UnavailableException because all the replica nodes are not &quot;RPC_READY&quot;? Why counter update needs to bind with native transport enabled?&lt;/p&gt;

&lt;p&gt;Also, it is mentioned in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13043&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-13043&lt;/a&gt;, &quot;if a cluster have a setup with dedicated coordinator nodes, in which storage nodes don&apos;t even bother listening to clients, and have that disabled&quot; counter update will always fail.&lt;/p&gt;

&lt;p&gt;Quote: &quot;&#160;it sounds like the problem we have is that we move endpoints from &apos;pending&apos; to &apos;natural&apos; endpoints too quickly after bootstrap, before the node is actually fully ready, and that this is what we should be fixing&quot;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;With all above being said, I think it&apos;s better to&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;set the RPC_READY to true when enable native transport. (This is already done in the merge PR)&lt;/li&gt;
	&lt;li&gt;Do not set RPC_READY to false if we are using nodetool to shutdown native transport. We just set the value to false when the node is decommissioned and drained. (This is added in this PR) I think we should remove this line: &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13064466/13064466_image-2023-11-16-10-56-16-693.png&quot; height=&quot;127&quot; width=&quot;414&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Thoughts?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17786922" author="brandon.williams" created="Thu, 16 Nov 2023 19:37:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;Does this mean after this change, if a cluster has multiple nodes binary disabled for some reason, for certain partitions, the counter update will always get UnavailableException because all the replica nodes are not &quot;RPC_READY&quot;?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I believe it does mean we will throw UE because the 13043 code is still active &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/StorageProxy.java#L1764&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.  It is rather unfortunate that counters have misused this, forcing us to claim rpc is ready regardless of the actual state, but I think that&apos;s what we have to do, never set it to false once it has been set to true unless decom/drain, as you said.&lt;/p&gt;</comment>
                            <comment id="17786968" author="smiklosovic" created="Thu, 16 Nov 2023 23:23:23 +0000"  >&lt;p&gt;interesting catch about dedicated coordinators! I think we need to cover that scenario too. &lt;/p&gt;</comment>
                            <comment id="17786976" author="smiklosovic" created="Thu, 16 Nov 2023 23:40:03 +0000"  >&lt;p&gt;This is a tricky ticket! I just keep thinking about the consequences here from various angles. When you say we should never set it to false, does that hold for coordinator nodes as well? I think it should be reworded like this: &lt;/p&gt;

&lt;p&gt;never set it to false, &lt;em&gt;WHEN IT IS NOT A COORDINATOR&lt;/em&gt;, once it has been set to true unless decom/drain. Why wouldnt you set rpc status to false in coordinator nodes?&lt;/p&gt;</comment>
                            <comment id="17787013" author="JIRAUSER291682" created="Fri, 17 Nov 2023 03:45:39 +0000"  >&lt;p&gt;Not sure why we added this RPC_READY flag in the first place. But I think the issue &#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13043&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-13043&lt;/a&gt; trying to solve is that when doing counter mutation, we do not want the node stilling bootstrapping to be the leader of the counter mutation. The trick we did is to use this flag to make sure the bootstrap is finished. I think we should not use RPC_READY flag to filter the nodes. Maybe we need to add a new flag to indicate if a node is fully bootstrapped?&lt;/p&gt;</comment>
                            <comment id="17787143" author="brandon.williams" created="Fri, 17 Nov 2023 11:22:10 +0000"  >&lt;p&gt;We already have a flag to indicate this, STATUS.  It seems there could have been some kind of race around this when &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13043&quot; title=&quot;UnavailabeException caused by counter writes forwarded to leaders without complete cluster view&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13043&quot;&gt;&lt;del&gt;CASSANDRA-13043&lt;/del&gt;&lt;/a&gt; was being worked on that made RPC_READY seem like a better option, but nonetheless it is the de facto way to know whether a node is ready to receive requests, and what the rest of the system uses: counters are special and reinventing that wheel here.&lt;/p&gt;</comment>
                            <comment id="17787289" author="smiklosovic" created="Fri, 17 Nov 2023 16:22:35 +0000"  >&lt;p&gt;Coordinator nodes, these which will never join a ring, will be in STARTING state for ever. So if we filter only nodes with NORMAL status here (1) instead waiting for RPC, then replicas for hints will ever be just &quot;normal&quot; nodes carrying data. &lt;/p&gt;

&lt;p&gt;So this will not collide with rpc enable/disable as it is now? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(1) &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/StorageProxy.java#L1764&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/StorageProxy.java#L1764&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17787292" author="brandon.williams" created="Fri, 17 Nov 2023 16:24:37 +0000"  >&lt;p&gt;The problem is not coordinator-only nodes, but storage nodes that have rpc disabled.&lt;/p&gt;</comment>
                            <comment id="17787304" author="smiklosovic" created="Fri, 17 Nov 2023 16:45:55 +0000"  >&lt;p&gt;Before this fix, RPC was set to true on startup, then if somebody turned it off, RPC flag was not set to false so that logic around counters always saw RPC of that node up, even if it was not. &lt;/p&gt;

&lt;p&gt;So what is the difference if we set that RPC to false when it is really not enabled? I think what happens here is that if RPC is set to true even it is really not, then in StorageProxy.mutateCounter it will send message with counter mutation with a response handler which has &quot;null&quot; in &quot;hintsOnFailure&quot; parameter so it means that if that message fails (because RPC is false?) it will not even create hints for such mutation.&lt;/p&gt;

&lt;p&gt;But the outcome is same?&lt;/p&gt;

&lt;p&gt;(1) &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/StorageProxy.java#L1736&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/StorageProxy.java#L1736&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17787305" author="brandon.williams" created="Fri, 17 Nov 2023 16:50:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;So what is the difference if we set that RPC to false when it is really not enabled?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Counter writes will fail.  Whether or not RPC is actually enabled has no effect, counters just want the flag.&lt;/p&gt;</comment>
                            <comment id="17787314" author="smiklosovic" created="Fri, 17 Nov 2023 16:55:30 +0000"  >&lt;p&gt;OK so if they just want that flag, and it is irrelevant whether it is in fact enabled or not, then why could not we replace that with filter on STATUS being NORMAL. &lt;/p&gt;</comment>
                            <comment id="17787322" author="brandon.williams" created="Fri, 17 Nov 2023 16:57:15 +0000"  >&lt;p&gt;We can, but all existing installations are still going to want RPC_READY, so it&apos;s not so simple to unring this bell.&lt;/p&gt;</comment>
                            <comment id="17787332" author="smiklosovic" created="Fri, 17 Nov 2023 17:44:36 +0000"  >&lt;p&gt;I will remove that one line &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=curlylrt&quot; class=&quot;user-hover&quot; rel=&quot;curlylrt&quot;&gt;curlylrt&lt;/a&gt; showed. Too bad there is no simple fix. This will leak e.g. to nodetool gossipinfo where RPC status is visible so it may be misleading. &lt;/p&gt;</comment>
                            <comment id="17787336" author="brandon.williams" created="Fri, 17 Nov 2023 17:53:23 +0000"  >&lt;p&gt;We can also switch to checking STATUS here, and then someday we can restore RPC_READY to accuracy.&lt;/p&gt;</comment>
                            <comment id="17787338" author="brandon.williams" created="Fri, 17 Nov 2023 17:57:48 +0000"  >&lt;p&gt;I think we should probably also add a test for counters in this situation so nobody accidentally &quot;fixes&quot; it again.&lt;/p&gt;</comment>
                            <comment id="17787400" author="JIRAUSER291682" created="Fri, 17 Nov 2023 21:21:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; , I think the problem of &quot;STATUS&quot; is that when a node started, it will broadcast the NORMAL status to peers. For this just started node, the gossip may have some delay so it may only have the partial view of the cluster. This means the node will consider part of the cluster is down. What we really want in counter mutation is to make sure the leader recent started node(or a new node) is fully connected to the cluster so it has full view of the cluster.&lt;/p&gt;

&lt;p&gt;The reason we chose RPC_READY might be that this flag was set to true only when everything is done.&#160; But this flag is indicating if binary port is enabled, I don&apos;t think we should use this flag.&lt;/p&gt;

&lt;p&gt;I see 4.0 has added a checker before enabling binary port: &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/CassandraDaemon.java#L644&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/CassandraDaemon.java#L644&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think it&apos;s better to create a new flag like &quot;FULLY_CONNECTED&quot; so that we know the node has a full view of the cluster. Then we can use this flag in counter mutation and keep &quot;RPC_READY&quot; like what we have today: 1. set to true when binary port enabled. 2. set to false when binary port disabled.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17787404" author="brandon.williams" created="Fri, 17 Nov 2023 21:24:45 +0000"  >&lt;blockquote&gt;&lt;p&gt;the gossip may have some delay so it may only have the partial view of the cluster.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Gossip has mechanisms to avoid this scenario.  If it was a problem then rolling restarts would break all kinds of queries all the time, nothing specific to counters.&lt;/p&gt;</comment>
                            <comment id="17787408" author="JIRAUSER291682" created="Fri, 17 Nov 2023 21:34:34 +0000"  >&lt;p&gt;If that&apos;s the case, does it mean if a node&apos;s status is NORMAL, it means the node should have the full view of the cluster? Then we should change to use status to filter. Also, we have added &lt;a href=&quot;https://github.com/ostefano/cassandra-dtest/commit/a1e505977a6e8f04f85d053ce1f8bb83e7b04d21&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;test&lt;/a&gt; earlier, let me check if changing the filter to use status will work with that test.&lt;/p&gt;</comment>
                            <comment id="17787412" author="brandon.williams" created="Fri, 17 Nov 2023 21:52:06 +0000"  >&lt;p&gt;We should probably make a new ticket to change the behavior and just revert the one line here to avoid a regression.  I&apos;m not sure why that test didn&apos;t fail here though.&lt;/p&gt;</comment>
                            <comment id="17787423" author="smiklosovic" created="Fri, 17 Nov 2023 22:35:55 +0000"  >&lt;p&gt;btw when I read the code correctly, NORMAL value of STATUS application state will be propagated by Gossip before transports are started and RPC_READY value is set to true. So it may happen that for brief period of time, until RPC_READY is true, it will choose replicas which are NORMAL but their transports are not started yet. &lt;/p&gt;

&lt;p&gt;If NORMAL status would be set after RPC_READY was set and counters wait for NORMAL, there is a guarantee that if it is RPC_READY so queries would not fail. &lt;/p&gt;</comment>
                            <comment id="17787425" author="brandon.williams" created="Fri, 17 Nov 2023 22:53:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;it will choose replicas which are NORMAL but their transports are not started yet. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Which is inconsequential since nothing needs to use them.&lt;/p&gt;</comment>
                            <comment id="17787427" author="JIRAUSER291682" created="Fri, 17 Nov 2023 22:58:58 +0000"  >&lt;p&gt;The test won&apos;t pass if we change to check if the status of the node is normal.&lt;/p&gt;

&lt;p&gt;I think we cannot use status NORMAL to filter the leader node for counter mutation. I think the extra requirement for counter mutation leader here is to make sure the leader has full view of the cluster. But the binary port of the leader doesn&apos;t have to be enabled.&lt;/p&gt;</comment>
                            <comment id="17787457" author="JIRAUSER283332" created="Sat, 18 Nov 2023 07:03:00 +0000"  >&lt;p&gt;I dont get this &quot;full view of cluster&quot; thing. if RPC&amp;#95;READY is true or false is in fact irrelevant. It is used just for leader selection. If we choose NORMAL node and its RPC is not ready yet, that doesnt matter. It would be same situation as now.&lt;/p&gt;

&lt;p&gt;The logic around replica leader selection just has to have enough nodes to choose from, whatever that means.&lt;/p&gt;

&lt;p&gt;The only discrepancy is that if there is, e.g., 5 nodes cluster and we go to upgrade it in a rolling fashion, after restart of a node and turning off its RPC, that node would not be part of the leader selection process on old nodes, because its rpc would be turned off.&lt;/p&gt;

&lt;p&gt;Then if 4 nodes are upgraded with rpc disabled, the last node would have no replicas to choose from but itself.&lt;/p&gt;

&lt;p&gt;As soon as the last node is upgraded, it would start to filter on STATUS (as any other node is doing at this moment)&lt;/p&gt;

&lt;p&gt;I think that filer on NORMAL would be problematic only when rpc is disabled while cluster is being upgraded.&lt;/p&gt;

&lt;p&gt;Sent from ProtonMail mobile&lt;/p&gt;



&lt;p&gt;\&lt;/p&gt;</comment>
                            <comment id="17787463" author="JIRAUSER291682" created="Sat, 18 Nov 2023 08:27:04 +0000"  >&lt;p&gt;It will be easier to understand If you check the added &lt;a href=&quot;https://github.com/ostefano/cassandra-dtest/commit/a1e505977a6e8f04f85d053ce1f8bb83e7b04d21&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;test.&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Let me explain the &quot;full view of the cluster&quot;: We have a 3 node cluster, with a keyspace as replication factor 3. Now we restart node A. After node A restart, it will first set its own status to NORMAL then gossip this info to the rest of the cluster, Node B received the message. Before other nodes send any gossip info to node A, the endpointStateMap of node A is empty. Let&apos;s say some how the gossip info sending to node A got delayed. Now, node B received a request to do counter mutation. Node B selects node A as a leader of the counter mutation because Node A is normal, so Node B send the mutation to A. From A&apos;s point of view, the other two nodes are down nodes. The only live node is Node A itself. If consistency level is local_quorum, node A will just throw the UAE. To solve the issue, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13043&quot; title=&quot;UnavailabeException caused by counter writes forwarded to leaders without complete cluster view&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13043&quot;&gt;&lt;del&gt;CASSANDRA-13043&lt;/del&gt;&lt;/a&gt; made the change to wait for the last flag &quot;RPC_READY&quot; to be true. When RPC_READY is true, A has the &quot;full view of the cluster&quot; (Node B and C is UP and normal).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;Below are logs related to gossip when a node getting started:&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {&amp;quot;@timestamp&amp;quot;}&lt;/span&gt; &lt;/div&gt;
&lt;p&gt; {&quot;@timestamp&quot;:&quot;2023-11-18T08:03:21.454+00:00&quot;,&quot;@version&quot;:1,&quot;message&quot;:&quot;Updating topology for /node1.ip.address:9042&quot;,&quot;logger_name&quot;:&quot;o.a.c.locator.TokenMetadata&quot;,&quot;thread_name&quot;:&quot;main&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;level_value&quot;:20000} {&quot;@timestamp&quot;:&quot;2023-11-18T08:03:21.455+00:00&quot;,&quot;@version&quot;:1,&quot;message&quot;:&quot;Updating topology for /node1.ip.address:9042&quot;,&quot;logger_name&quot;:&quot;o.a.c.locator.TokenMetadata&quot;,&quot;thread_name&quot;:&quot;main&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;level_value&quot;:20000} {&quot;@timestamp&quot;:&quot;2023-11-18T08:03:21.660+00:00&quot;,&quot;@version&quot;:1,&quot;message&quot;:&quot;Node /node2.ip.address:9042 is now part of the cluster&quot;,&quot;logger_name&quot;:&quot;o.a.cassandra.gms.Gossiper&quot;,&quot;thread_name&quot;:&quot;GossipStage:1&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;level_value&quot;:20000} {&quot;@timestamp&quot;:&quot;2023-11-18T08:03:21.668+00:00&quot;,&quot;@version&quot;:1,&quot;message&quot;:&quot;Using saved tokens &lt;span class=&quot;error&quot;&gt;&amp;#91;-2221857722054656123, -3885079421067140903, -5343119608664883471, -6713057863481554638, -704218406783704283, -8255104289521151109, 1443620187740186167, 2237424365810614485, 3011306438350676741, 3823627889871018402, 4717722679840880909, 491446797270294465, 5682153714635827559, 6562206662586337529, 7479206264222202974, 8684646769397141191&amp;#93;&lt;/span&gt;&quot;,&quot;logger_name&quot;:&quot;o.a.c.service.StorageService&quot;,&quot;thread_name&quot;:&quot;main&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;level_value&quot;:20000} {&quot;@timestamp&quot;:&quot;2023-11-18T08:03:21.688+00:00&quot;,&quot;@version&quot;:1,&quot;message&quot;:&quot;JOINING: Finish joining ring&quot;,&quot;logger_name&quot;:&quot;o.a.c.service.StorageService&quot;,&quot;thread_name&quot;:&quot;main&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;level_value&quot;:20000} {&quot;@timestamp&quot;:&quot;2023-11-18T08:03:21.700+00:00&quot;,&quot;@version&quot;:1,&quot;message&quot;:&quot;Updating topology for /node2.ip.address:9042&quot;,&quot;logger_name&quot;:&quot;o.a.c.locator.TokenMetadata&quot;,&quot;thread_name&quot;:&quot;GossipStage:1&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;level_value&quot;:20000} {&quot;@timestamp&quot;:&quot;2023-11-18T08:03:21.701+00:00&quot;,&quot;@version&quot;:1,&quot;message&quot;:&quot;Updating topology for /node2.ip.address:9042&quot;,&quot;logger_name&quot;:&quot;o.a.c.locator.TokenMetadata&quot;,&quot;thread_name&quot;:&quot;GossipStage:1&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;level_value&quot;:20000} {&quot;@timestamp&quot;:&quot;2023-11-18T08:03:21.707+00:00&quot;,&quot;@version&quot;:1,&quot;message&quot;:&quot;Node /node1.ip.address:9042 state jump to NORMAL&quot;,&quot;logger_name&quot;:&quot;o.a.c.service.StorageService&quot;,&quot;thread_name&quot;:&quot;main&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;level_value&quot;:20000} {&quot;@timestamp&quot;:&quot;2023-11-18T08:03:21.726+00:00&quot;,&quot;@version&quot;:1,&quot;message&quot;:&quot;Node /node1.ip.address:9042 state jump to NORMAL&quot;,&quot;logger_name&quot;:&quot;o.a.c.service.StorageService&quot;,&quot;thread_name&quot;:&quot;main&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;level_value&quot;:20000} {&quot;@timestamp&quot;:&quot;2023-11-18T08:03:21.730+00:00&quot;,&quot;@version&quot;:1,&quot;message&quot;:&quot;Node /node3.ip.address:9042 has restarted, now UP&quot;,&quot;logger_name&quot;:&quot;o.a.cassandra.gms.Gossiper&quot;,&quot;thread_name&quot;:&quot;GossipStage:1&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;level_value&quot;:20000} {&quot;@timestamp&quot;:&quot;2023-11-18T08:03:21.731+00:00&quot;,&quot;@version&quot;:1,&quot;message&quot;:&quot;Node /node3.ip.address:9042 state jump to NORMAL&quot;,&quot;logger_name&quot;:&quot;o.a.c.service.StorageService&quot;,&quot;thread_name&quot;:&quot;GossipStage:1&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;level_value&quot;:20000} {&quot;@timestamp&quot;:&quot;2023-11-18T08:03:21.826+00:00&quot;,&quot;@version&quot;:1,&quot;message&quot;:&quot;Updating topology for /node3.ip.address:9042&quot;,&quot;logger_name&quot;:&quot;o.a.c.locator.TokenMetadata&quot;,&quot;thread_name&quot;:&quot;GossipStage:1&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;level_value&quot;:20000} {&quot;@timestamp&quot;:&quot;2023-11-18T08:03:21.827+00:00&quot;,&quot;@version&quot;:1,&quot;message&quot;:&quot;Updating topology for /node3.ip.address:9042&quot;,&quot;logger_name&quot;:&quot;o.a.c.locator.TokenMetadata&quot;,&quot;thread_name&quot;:&quot;GossipStage:1&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;level_value&quot;:20000} {&quot;@timestamp&quot;:&quot;2023-11-18T08:03:21.832+00:00&quot;,&quot;@version&quot;:1,&quot;message&quot;:&quot;InetAddress /node2.ip.address:9042 is now UP&quot;,&quot;logger_name&quot;:&quot;o.a.cassandra.gms.Gossiper&quot;,&quot;thread_name&quot;:&quot;GossipStage:1&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;level_value&quot;:20000} {&quot;@timestamp&quot;:&quot;2023-11-18T08:03:21.841+00:00&quot;,&quot;@version&quot;:1,&quot;message&quot;:&quot;InetAddress /node3.ip.address:9042 is now UP&quot;,&quot;logger_name&quot;:&quot;o.a.cassandra.gms.Gossiper&quot;,&quot;thread_name&quot;:&quot;GossipStage:1&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;level_value&quot;:20000} {&quot;@timestamp&quot;:&quot;2023-11-18T08:03:21.880+00:00&quot;,&quot;@version&quot;:1,&quot;message&quot;:&quot;&lt;font color=&quot;#FF0000&quot;&gt;Waiting for gossip to settle...&lt;/font&gt;&quot;,&quot;logger_name&quot;:&quot;o.a.cassandra.gms.Gossiper&quot;,&quot;thread_name&quot;:&quot;main&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;level_value&quot;:20000} {&quot;@timestamp&quot;:&quot;2023-11-18T08:03:29.881+00:00&quot;,&quot;@version&quot;:1,&quot;message&quot;:&quot;&lt;font color=&quot;#FF0000&quot;&gt;No gossip backlog; proceeding&lt;/font&gt;&quot;,&quot;logger_name&quot;:&quot;o.a.cassandra.gms.Gossiper&quot;,&quot;thread_name&quot;:&quot;main&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;level_value&quot;:20000} {&quot;@timestamp&quot;:&quot;2023-11-18T08:03:29.891+00:00&quot;,&quot;@version&quot;:1,&quot;message&quot;:&quot;Blocking coordination until only a single peer is DOWN in the local datacenter, timeout=10s&quot;,&quot;logger_name&quot;:&quot;o.a.c.n.StartupClusterConnectivityChecker&quot;,&quot;thread_name&quot;:&quot;main&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;level_value&quot;:20000} {&quot;@timestamp&quot;:&quot;2023-11-18T08:03:30.037+00:00&quot;,&quot;@version&quot;:1,&quot;message&quot;:&quot;Ensured sufficient healthy connections with &lt;span class=&quot;error&quot;&gt;&amp;#91;dc1&amp;#93;&lt;/span&gt; after 144 milliseconds&quot;,&quot;logger_name&quot;:&quot;o.a.c.n.StartupClusterConnectivityChecker&quot;,&quot;thread_name&quot;:&quot;main&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;level_value&quot;:20000} {&quot;@timestamp&quot;:&quot;2023-11-18T08:03:30.114+00:00&quot;,&quot;@version&quot;:1,&quot;message&quot;:&quot;Starting listening for CQL clients on /0.0.0.0:27906 (unencrypted)...&quot;,&quot;logger_name&quot;:&quot;o.a.c.t.PipelineConfigurator&quot;,&quot;thread_name&quot;:&quot;main&quot;,&quot;level&quot;:&quot;INFO&quot;,&quot;level_value&quot;:20000}&lt;/p&gt;

&lt;p&gt;&lt;font color=&quot;#FF0000&quot;&gt;RPC_READY set to true here&lt;/font&gt;&lt;/p&gt;

&lt;div class=&quot;error&quot;&gt;&lt;span class=&quot;error&quot;&gt;Unknown macro: {&amp;quot;@timestamp&amp;quot;}&lt;/span&gt; &lt;/div&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think the &lt;b&gt;key&lt;/b&gt; part is the wait gossip to settle. If a node take too long to settle the gossip and that node is selected as a leader, we will have problem when doing counter update. I think we need a flag to indicate gossip settled so we don&apos;t need to use RPC_READY flag.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17787497" author="smiklosovic" created="Sat, 18 Nov 2023 15:17:50 +0000"  >&lt;p&gt;I think we should just remove that one line and that&apos;s it, for the sake of not having this regression in 5.0.0. We will wait until CEP-21 (TCM) is in place, should be pretty soon. If you check TCM logic in that method, it was rewritten (1) so it does not make sense to introduce new gossip message etc, this stuff is apparently going to be handled differently quite soon.&lt;/p&gt;

&lt;p&gt;After TCM changes are in, I think we can finally decouple this rpc readiness from counter&apos;s logic and then we can fix enable/disable binary behaviour when it comes to RPC status.&lt;/p&gt;

&lt;p&gt;(1) &lt;a href=&quot;https://github.com/apache/cassandra/blob/cep-21-tcm/src/java/org/apache/cassandra/locator/ReplicaPlans.java#L212-L221&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cep-21-tcm/src/java/org/apache/cassandra/locator/ReplicaPlans.java#L212-L221&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17787520" author="JIRAUSER291682" created="Sat, 18 Nov 2023 18:56:56 +0000"  >&lt;p&gt;I concur that with CEP 21, the issue should no longer persist. Yet, what approach should we take for versions 3.0.x to 4.1.x?&lt;/p&gt;

&lt;p&gt;My inquiry pertains to the precise meaning of RPC_READY. Does RPC_READY equate to binary being enabled? Or does it simply indicate that the node is prepared to enable the binary port for serving client traffic? If RPC_READY merely signifies readiness without guaranteeing the binary port&apos;s activation, it might be better to switch this flag to true only after gossip has stabilized, regardless of the binary port&apos;s status.&lt;/p&gt;

&lt;p&gt;Initially, we encountered a problem when attempting to initiate every node with &quot;start_native_transport&quot;: false in cassandra.yaml, intending to activate the binary port via JMX short after the node is status NORMAL and stable. This led to a significant outage, with all counter mutations failing because the RPC_READY flag was absent on all nodes. This flag is only set to true when &quot;start_native_transport&quot; is true. The solution proposed in this ticket appears to resolve this issue, as enabling the binary port will trigger the RPC_READY flag to true. However, we also observed that disabling the binary port sets this flag to false. This could pose a problem for us, as we occasionally need to disable nodes for various reasons, which could obstruct counter updates.&lt;/p&gt;

&lt;p&gt;Should we consider separating the RPC_READY status from the actual state of the binary port? For example, for the setup of dedicated coordinator nodes, the storage nodes are started with &quot;start_native_transport&quot;: false and never get binary enabled, the &quot;RPC_READY&quot; flag will never be true. Then, counter update for certain partitions will always fail because of the UAE.&lt;/p&gt;</comment>
                            <comment id="17788148" author="smiklosovic" created="Mon, 20 Nov 2023 20:09:06 +0000"  >&lt;p&gt;RPC_READY is set locally &lt;em&gt;after&lt;/em&gt; native transport is started (ports are open, it is fully initialized and it listens to connections) and then it is propagated by Gossip and it will eventually reach other nodes. So by the time another node sees RPC_READY is &quot;true&quot; for such and such node, it is basically guaranteed that it listens to connections. (if the node which started transport service does not stop it by the time RPC_READY = true propagates in Gossip).&lt;/p&gt;

&lt;p&gt;I am not sure what is the correct solution but the current one feels like a hack. If RPC_READY is defacto irrelevant what it is set to, then we can change it to something else, questionable to what. However, this is problematic only for corner cases like storage node where RPC is turned off. It is quite a bummer that the current code does not consider that scenario.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=curlylrt&quot; class=&quot;user-hover&quot; rel=&quot;curlylrt&quot;&gt;curlylrt&lt;/a&gt; Why is it so problematic for you to have RPC started even on data nodes? You can still firewall / blacklist them etc if you do not wish the clients to connect to it, no?&lt;/p&gt;

&lt;p&gt;This is patch for 3.0 I want to get in (1), I will continue on all branches soon and I ll provide the builds.&lt;/p&gt;

&lt;p&gt;(1) &lt;a href=&quot;https://github.com/apache/cassandra/pull/2923/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2923/files&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17788499" author="JIRAUSER291682" created="Tue, 21 Nov 2023 18:24:06 +0000"  >&lt;p&gt;I think the fix looks good. It will work for us. Thanks.&lt;/p&gt;</comment>
                            <comment id="17789177" author="smiklosovic" created="Thu, 23 Nov 2023 15:32:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3542/workflows/f44d30c4-146d-4183-87ad-2fc9ced5fe9d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3543/workflows/6ede27da-a6ef-4f80-846d-fd4de7292329&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3544/workflows/c649e450-6334-4131-bfa3-a229c6dd6447&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3545/workflows/0d27e44f-771e-4990-b3d3-3c922ca29521&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.1&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3546/workflows/fa7e792a-ca7a-4ab7-a5d0-d1f824b76504&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0&lt;/a&gt;&lt;br/&gt;
restarted j17 dtest for 5.0 &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3552/workflows/f5b5824e-95b5-40da-a43e-21017cf40928/jobs/156678&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3547/workflows/7b99303f-08b9-45f1-a5b9-70107bbaa1c3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17789181" author="smiklosovic" created="Thu, 23 Nov 2023 15:33:57 +0000"  >&lt;p&gt;patch for 3.0 &lt;a href=&quot;https://github.com/apache/cassandra/pull/2923/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2923/files&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;patches for all other branches are literally identical&lt;/p&gt;</comment>
                            <comment id="17789182" author="smiklosovic" created="Thu, 23 Nov 2023 15:35:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mck&quot; class=&quot;user-hover&quot; rel=&quot;mck&quot;&gt;mck&lt;/a&gt; we are trying to fix the regression here after original 18935 was committed. Mentioning that in case you will want to move this out from 5.0.0 scope.&lt;/p&gt;</comment>
                            <comment id="17790115" author="brandon.williams" created="Mon, 27 Nov 2023 15:01:59 +0000"  >&lt;p&gt;I am +1 on this.&lt;/p&gt;

&lt;p&gt;I think we should figure out why counter_leader_with_partial_view_test didn&apos;t fail (and still does not currently) when we set rpc_ready to false, otherwise it&apos;s not very useful.&lt;/p&gt;</comment>
                            <comment id="17790161" author="smiklosovic" created="Mon, 27 Nov 2023 16:18:32 +0000"  >&lt;p&gt;I created this for trunk &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19103&quot; title=&quot;Filter replicas for counter mutation leader to be JOINED replicas to decouple from RPC_READY state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19103&quot;&gt;CASSANDRA-19103&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;TCM has landed in the meanwhile and stuff has changed around this logic. I will try to get some response from TCM guys.&lt;/p&gt;</comment>
                            <comment id="17790174" author="JIRAUSER291682" created="Mon, 27 Nov 2023 16:45:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; the reason why test_counter_leader_with_partial_view didn&apos;t fail before and still does not fail currently is because &quot;nodetool disablebinary&quot; is not called in the test. The test is only restarting a node and delay update status of other nodes&apos; views for that node. I would say the test is currently useful but it won&apos;t cover the case when modifying binary port with nodetool commands.&lt;/p&gt;</comment>
                            <comment id="17790177" author="brandon.williams" created="Mon, 27 Nov 2023 16:54:20 +0000"  >&lt;p&gt;I see, thanks.  NativeProtocolTest will cover it in Stefan&apos;s patch, so I think we&apos;re good to go here.&lt;/p&gt;</comment>
                            <comment id="17790416" author="smiklosovic" created="Tue, 28 Nov 2023 07:56:17 +0000"  >&lt;p&gt;Well, I see in trunk that test_counter_leader_with_partial_view now fails. I am trying to figure out why and fix it.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3562/workflows/3aeab43a-1b13-4b93-a6a9-c6c3cca0e9ca/jobs/157646/tests#failed-test-1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3562/workflows/3aeab43a-1b13-4b93-a6a9-c6c3cca0e9ca/jobs/157646/tests#failed-test-1&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17790581" author="smiklosovic" created="Tue, 28 Nov 2023 13:49:57 +0000"  >&lt;p&gt;It seems that the byteman script we inject into node 1 and 3 in test_counter_leader_with_partial does not work. If you look closely, the rule is trying to intercept a method called &quot;findSuitableEndpoint&quot; (1) but there is not such method in 4.0 included. So how does this work then, huh ...&#160;&lt;/p&gt;

&lt;p&gt;findSuitableEndpoint is present only in 3.0 and 3.11. For these versions, there is this byteman injected (2).&lt;/p&gt;

&lt;p&gt;So, it seems like it does its job for 3.0 and 3.11 only. For 4.0 included it does not inject anything.&#160;&lt;/p&gt;

&lt;p&gt;The question is, if it is not injected, how is it possible that the test still passes anyway? Well, if it is not injected, then it goes by the logic currently present in 4.0+, which is - replica which is going to be a leader will be only a node for which RPC is true and it is not marked as dead by FailureDetector. So it seems like when we stop the second node in (3), two remaining nodes will detect this and they will never send any mutation to that node because it is filtered out and byteman script which forces to select it if it is not filtered out does not work anyway. So the node with partial view of the cluster is never selected.&lt;/p&gt;

&lt;p&gt;I think we need to do this to fix the tests everywhere &lt;a href=&quot;https://github.com/apache/cassandra-dtest/pull/246&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra-dtest/pull/246&lt;/a&gt; (this will go together with 19103)&lt;/p&gt;

&lt;p&gt;The byteman injection after we stopped the node is not necessary in trunk because there is TCM machinery in place.&lt;/p&gt;

&lt;p&gt;(1) &lt;a href=&quot;https://github.com/apache/cassandra-dtest/blob/trunk/byteman/4.0/election_counter_leader_favor_node2.btm#L8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra-dtest/blob/trunk/byteman/4.0/election_counter_leader_favor_node2.btm#L8&lt;/a&gt;&lt;br/&gt;
(2) &lt;a href=&quot;https://github.com/apache/cassandra-dtest/blob/trunk/byteman/pre4.0/election_counter_leader_favor_node2.btm#L8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra-dtest/blob/trunk/byteman/pre4.0/election_counter_leader_favor_node2.btm#L8&lt;/a&gt;&lt;br/&gt;
(3) &lt;a href=&quot;https://github.com/apache/cassandra-dtest/blob/trunk/counter_test.py#L117-L119&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra-dtest/blob/trunk/counter_test.py#L117-L119&lt;/a&gt;&lt;br/&gt;
(3) &lt;a href=&quot;https://github.com/apache/cassandra-dtest/blob/trunk/counter_test.py#L110-L132&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra-dtest/blob/trunk/counter_test.py#L110-L132&lt;/a&gt;&lt;br/&gt;
(4) &lt;a href=&quot;https://github.com/apache/cassandra-dtest/blob/trunk/byteman/4.0/election_counter_leader_favor_node2.btm#L10&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra-dtest/blob/trunk/byteman/4.0/election_counter_leader_favor_node2.btm#L10&lt;/a&gt;&lt;br/&gt;
(5) &lt;a href=&quot;https://github.com/apache/cassandra-dtest/blob/trunk/counter_test.py#L117&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra-dtest/blob/trunk/counter_test.py#L117&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17790722" author="smiklosovic" created="Tue, 28 Nov 2023 18:47:00 +0000"  >&lt;p&gt;Well ... it is flaky every now and then &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3569/workflows/363967bb-7390-4aef-9dd1-b2850e3790d9/jobs/158433&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3569/workflows/363967bb-7390-4aef-9dd1-b2850e3790d9/jobs/158433&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I just dont have time for this for now, I will commit just the revert and we will deal with 19103 separately in trunk afterwards.&lt;/p&gt;</comment>
                            <comment id="17790730" author="brandon.williams" created="Tue, 28 Nov 2023 19:22:18 +0000"  >&lt;p&gt;That&apos;s fine, I&apos;m +1 on that plan.&lt;/p&gt;</comment>
                            <comment id="17790733" author="smiklosovic" created="Tue, 28 Nov 2023 19:44:24 +0000"  >&lt;p&gt;Good news is that I have a non-flaky test in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19103&quot; title=&quot;Filter replicas for counter mutation leader to be JOINED replicas to decouple from RPC_READY state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19103&quot;&gt;CASSANDRA-19103&lt;/a&gt; implemented for coordinator + storage nodes scenario. Maybe we could rewrite what is in dtest to in-jvm dtest when it comes to test_counter_leader_with_partial_view . I started the multiplexer on current 5.0 to see if it is flaky already or I made it like that.&lt;/p&gt;</comment>
                            <comment id="17791001" author="smiklosovic" created="Wed, 29 Nov 2023 09:57:31 +0000"  >&lt;p&gt;I built the patch for trunk as TCM has happened there (1). Even the build contains a lot of failures, this is all known and tracked and I do not see anything wrong with the patch itself.&lt;/p&gt;

&lt;p&gt;Also, for the reference, test_counter_leader_with_partial_view test is NOT flaky. I run the multiplexer and it all just passes fine. So I had to introduce the instability in my attempt to bring in the changes in located in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19103&quot; title=&quot;Filter replicas for counter mutation leader to be JOINED replicas to decouple from RPC_READY state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19103&quot;&gt;CASSANDRA-19103&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Anyway, as already communicated, we go without that.&lt;/p&gt;

&lt;p&gt;I am starting the merging process.&lt;/p&gt;

&lt;p&gt;(1) &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3572/workflows/70ea8bc0-08c3-472c-a292-a1c050bc65dd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/instaclustr/cassandra/3572/workflows/70ea8bc0-08c3-472c-a292-a1c050bc65dd&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17791028" author="smiklosovic" created="Wed, 29 Nov 2023 11:34:52 +0000"  >&lt;p&gt;followup committed from &lt;a href=&quot;https://github.com/apache/cassandra/commit/c1b12058e71b2a06a20b284c2498979efcd63633&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/c1b12058e71b2a06a20b284c2498979efcd63633&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13063619" name="18935-3.11.patch" size="1022" author="cam1982" created="Tue, 17 Oct 2023 22:56:54 +0000"/>
                            <attachment id="13064466" name="image-2023-11-16-10-56-16-693.png" size="73458" author="curlylrt" created="Thu, 16 Nov 2023 18:56:17 +0000"/>
                            <attachment id="13064501" name="signature.asc" size="509" author="miklosovic@pm.me" created="Sat, 18 Nov 2023 07:03:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[smiklosovic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12977"><![CDATA[Adhoc Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 49 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1l0c8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333891">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/b51ee83a29c3691c1f769e253b869acdeb7747db&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/b51ee83a29c3691c1f769e253b869acdeb7747db&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;CI&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>