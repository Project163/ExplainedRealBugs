<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:52:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8978] CQLSSTableWriter causes ArrayIndexOutOfBoundsException</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8978</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;On long-running jobs with CQLSSTableWriter preparing sstables for later bulk load via sstableloader, occassionally I get the sporadic error shown below.&lt;/p&gt;

&lt;p&gt;I can run the exact same job again - and it will succeed or fail with the same error at another location in the input stream. The error is appears to occur &quot;randomly&quot; - with the same input it may occur never, early or late in the run with no apparent logic or system.&lt;/p&gt;

&lt;p&gt;I use five instances of CQLSSTableWriter in the application (to write redundantly to five different tables). But these instances do not exist at the same time; and thus never used concurrently.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;09:26:33.582 [main] INFO  d.dma.ais.store.FileSSTableConverter - Finished processing directory, 369582175 packets was converted from /nas1/
Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.lang.reflect.InvocationTargetException
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:483)
        at dk.dma.commons.app.CliCommandList$1.execute(CliCommandList.java:50)
        at dk.dma.commons.app.CliCommandList.invoke(CliCommandList.java:80)
        at dk.dma.ais.store.Main.main(Main.java:34)
Caused by: java.lang.ArrayIndexOutOfBoundsException: 297868
        at org.apache.cassandra.db.ArrayBackedSortedColumns.append(ArrayBackedSortedColumns.java:196)
        at org.apache.cassandra.db.ArrayBackedSortedColumns.appendOrReconcile(ArrayBackedSortedColumns.java:191)
        at org.apache.cassandra.db.ArrayBackedSortedColumns.sortCells(ArrayBackedSortedColumns.java:176)
        at org.apache.cassandra.db.ArrayBackedSortedColumns.maybeSortCells(ArrayBackedSortedColumns.java:125)
        at org.apache.cassandra.db.ArrayBackedSortedColumns.access$1100(ArrayBackedSortedColumns.java:44)
        at org.apache.cassandra.db.ArrayBackedSortedColumns$CellCollection.iterator(ArrayBackedSortedColumns.java:622)
        at org.apache.cassandra.db.ColumnFamily.iterator(ColumnFamily.java:476)
        at org.apache.cassandra.db.ColumnIndex$Builder.build(ColumnIndex.java:129)
        at org.apache.cassandra.io.sstable.SSTableWriter.rawAppend(SSTableWriter.java:233)
        at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:218)
        at org.apache.cassandra.io.sstable.SSTableSimpleUnsortedWriter$DiskWriter.run(SSTableSimpleUnsortedWriter.java:215)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So far I overcome this problem by simply retrying with another run of the application in attempt to generate the sstables. But this is a rather time consuming and shaky approach - and I feel a bit uneasy relying on the produced sstables, though their contents appear to be correct when I sample them with cqlsh &apos;select&apos; after load into Cassandra.&lt;/p&gt;
</description>
                <environment>&lt;p&gt;3.8.0-42-generic #62~precise1-Ubuntu SMP Wed Jun 4 22:04:18 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux&lt;/p&gt;

&lt;p&gt;java version &quot;1.8.0_20&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.8.0_20-b26)&lt;br/&gt;
Java HotSpot(TM) 64-Bit Server VM (build 25.20-b23, mixed mode)&lt;/p&gt;</environment>
        <key id="12782570">CASSANDRA-8978</key>
            <summary>CQLSSTableWriter causes ArrayIndexOutOfBoundsException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="carlyeks">Carl Yeksigian</assignee>
                                    <reporter username="tbsalling">Thomas Borg Salling</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 Mar 2015 14:15:49 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:18 +0000</updated>
                            <resolved>Wed, 15 Apr 2015 15:24:33 +0000</resolved>
                                        <fixVersion>2.1.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14381004" author="carlyeks" created="Wed, 25 Mar 2015 23:15:32 +0000"  >&lt;p&gt;This is caused because of a race condition in the CQLSSTableWriter. If we are writing to a single partition, we create a new column family to write into and send the previous one to the writer thread, but continue to use the old column family until we are done with the current partition.&lt;/p&gt;

&lt;p&gt;This adds a call to check whether the row needs to be added, and if needed will sync at that point which is after an insert has completed is finished.&lt;/p&gt;</comment>
                            <comment id="14386848" author="blerer" created="Mon, 30 Mar 2015 15:17:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=carlyeks&quot; class=&quot;user-hover&quot; rel=&quot;carlyeks&quot;&gt;carlyeks&lt;/a&gt; I do not fully understand the problem that you describe. Could you explain a bit more where is the race condition and how it trigger the ArrayIndexOutOfBoundException?&lt;/p&gt;</comment>
                            <comment id="14394680" author="carlyeks" created="Fri, 3 Apr 2015 16:54:59 +0000"  >&lt;p&gt;The test that I added had been failing for me when I posted this patch, but I can&apos;t get it to anymore. I&apos;m attaching a new test instead (test-8978.txt), which does fail on 2.1.&lt;/p&gt;

&lt;p&gt;The issue is that &lt;tt&gt;UpdateStatement&lt;/tt&gt; has a &lt;tt&gt;ColumnFamily&lt;/tt&gt; which it applies the modification to. When we hit the size that we are targeting in &lt;tt&gt;ABSC.addColumn&lt;/tt&gt;, we replace the current column family with a new one and send the previous one to the writer thread. Since update statement doesn&apos;t have the new column family, it continues to write columns to the old one which should no longer be modified.&lt;/p&gt;

&lt;p&gt;The change that I made moves replacing the column family to a point where update statement is complete.&lt;/p&gt;</comment>
                            <comment id="14494407" author="blerer" created="Tue, 14 Apr 2015 17:09:11 +0000"  >&lt;p&gt;The patch look good to me but are you sure we do not need also a patch for 2.0?&lt;/p&gt;</comment>
                            <comment id="14494446" author="carlyeks" created="Tue, 14 Apr 2015 17:31:59 +0000"  >&lt;p&gt;Yeah, it will happen on 2.0 as well; attaching a patch for it.&lt;/p&gt;</comment>
                            <comment id="14495789" author="blerer" created="Wed, 15 Apr 2015 07:19:45 +0000"  >&lt;p&gt;+1&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; can you commit?&lt;/p&gt;</comment>
                            <comment id="14496337" author="slebresne" created="Wed, 15 Apr 2015 15:24:33 +0000"  >&lt;p&gt;Committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12725290" name="8978-2.0-v2.txt" size="10495" author="carlyeks" created="Tue, 14 Apr 2015 17:31:59 +0000"/>
                            <attachment id="12709262" name="8978-2.1-v2.txt" size="10583" author="carlyeks" created="Fri, 3 Apr 2015 16:54:59 +0000"/>
                            <attachment id="12707357" name="8978-2.1.txt" size="10359" author="carlyeks" created="Wed, 25 Mar 2015 23:15:32 +0000"/>
                            <attachment id="12709261" name="test-8978.txt" size="4142" author="carlyeks" created="Fri, 3 Apr 2015 16:54:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[carlyeks]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 31 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i26v9b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blerer</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12328841">2.1.2</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>