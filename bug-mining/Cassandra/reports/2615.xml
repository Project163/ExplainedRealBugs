<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:42:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6707] AIOOBE when doing select count(*) from on a mixed cluster.</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6707</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;After upgrading one node from 1.2 to 2.0, the following query fails with timeout:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Connected to test at localhost:9160.
[cqlsh 4.1.0 | Cassandra 2.0.5.1-SNAPSHOT | CQL spec 3.1.1 | Thrift protocol 19.39.0]
Use HELP for help.
cqlsh&amp;gt; select count(*) from cfs.sblocks;
Request did not complete within rpc_timeout.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Table definition:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh&amp;gt; describe columnfamily cfs.sblocks;

CREATE TABLE sblocks (
  key blob,
  column1 blob,
  value blob,
  PRIMARY KEY (key, column1)
) WITH COMPACT STORAGE AND
  bloom_filter_fp_chance=0.000068 AND
  caching=&apos;KEYS_ONLY&apos; AND
  comment=&apos;Stores blocks of information associated with a inode&apos; AND
  dclocal_read_repair_chance=0.000000 AND
  gc_grace_seconds=864000 AND
  index_interval=128 AND
  read_repair_chance=0.100000 AND
  replicate_on_write=&apos;true&apos; AND
  populate_io_cache_on_flush=&apos;true&apos; AND
  default_time_to_live=0 AND
  speculative_retry=&apos;99.0PERCENTILE&apos; AND
  memtable_flush_period_in_ms=0 AND
  compaction={&apos;class&apos;: &apos;com.datastax.bdp.hadoop.cfs.compaction.CFSCompactionStrategy&apos;} AND
  compression={};
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The 1.2 node reports the following error:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR 08:38:02,006 Exception in thread Thread[Thread-32,5,main]
java.lang.ArrayIndexOutOfBoundsException: 36
	at org.apache.cassandra.net.MessageIn.read(MessageIn.java:59)
	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessage(IncomingTcpConnection.java:208)
	at org.apache.cassandra.net.IncomingTcpConnection.handleModernVersion(IncomingTcpConnection.java:140)
	at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:83)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There were no errors during the upgrade.&lt;/p&gt;</description>
                <environment>&lt;p&gt;old nodes: Cassandra 1.2.16 from DSE 3.2.5  (unreleased)&lt;br/&gt;
new node: Cassandra  2.0.5 from DSE 4.0.0 (unreleased)&lt;/p&gt;</environment>
        <key id="12695167">CASSANDRA-6707</key>
            <summary>AIOOBE when doing select count(*) from on a mixed cluster.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thobbs">Tom Hobbs</assignee>
                                    <reporter username="pkolaczk">Piotr Kolaczkowski</reporter>
                        <labels>
                    </labels>
                <created>Fri, 14 Feb 2014 08:56:38 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:53 +0000</updated>
                            <resolved>Mon, 17 Feb 2014 13:54:55 +0000</resolved>
                                        <fixVersion>2.0.6</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13901247" author="pkolaczk" created="Fri, 14 Feb 2014 09:00:33 +0000"  >&lt;p&gt;The following works fine:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;select * from cfs.sblocks limit 1;  
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13901444" author="jbellis" created="Fri, 14 Feb 2014 13:32:57 +0000"  >&lt;p&gt;Via Sylvain,&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think I know what the problem is: count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; on 2.0 blindly use the new pagers and when it&apos;s a range query, this uses PagedRangeCommand which 1.2 nodes don&apos;t have. Not sure what&apos;s the right fix is. Probably just stick to non-paged calls if there is 1.2 nodes in the cluster, but that&apos;s slightly painful.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="13902030" author="thobbs" created="Fri, 14 Feb 2014 22:20:57 +0000"  >&lt;p&gt;6707.patch (and &lt;a href=&quot;https://github.com/thobbs/cassandra/tree/6707&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;) takes the approach suggested by Sylvain.  I tested this against a two-node cluster like so:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Start two 1.2 nodes&lt;/li&gt;
	&lt;li&gt;Insert 1m rows, verify &lt;tt&gt;select count&amp;#40;*&amp;#41;&lt;/tt&gt; returns 1m&lt;/li&gt;
	&lt;li&gt;Upgrade one node to cassandra-2.0 plus the patch, verify that &lt;tt&gt;select count&amp;#40;*&amp;#41;&lt;/tt&gt; with the 2.0 node as the coordinator doesn&apos;t send a paging query to the 1.2 node&lt;/li&gt;
	&lt;li&gt;Upgrade the second node to cassandra-2.0, verify that the paging query is now used&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;However, I will note that after upgrading the first node to 2.0, the results of &lt;tt&gt;select count&amp;#40;*&amp;#41;&lt;/tt&gt; were consistent but incorrect (I got 957815 as the result).  After upgrading the second node to 2.0 I got another consistent but incorrect result (912873).  I couldn&apos;t reproduce this when I started a new two node cluster with just 2.0 plus the patch, so I might have made a mistake when upgrading and testing the patch, or there might be a separate issue with counting.  Unfortunately I don&apos;t have time to investigate this at the moment.&lt;/p&gt;</comment>
                            <comment id="13902411" author="pkolaczk" created="Sat, 15 Feb 2014 14:36:44 +0000"  >&lt;p&gt;I tested it and something went wrong.&lt;br/&gt;
I&apos;m unable to run the query from hive:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.io.IOException: java.io.IOException: java.lang.RuntimeException: java.lang.IndexOutOfBoundsException: Index: 0, Size: 0
	at org.apache.hadoop.hive.io.HiveIOExceptionHandlerChain.handleRecordReaderCreationException(HiveIOExceptionHandlerChain.java:97)
	at org.apache.hadoop.hive.io.HiveIOExceptionHandlerUtil.handleRecordReaderCreationException(HiveIOExceptionHandlerUtil.java:57)
	at org.apache.hadoop.hive.ql.io.HiveInputFormat.getRecordReader(HiveInputFormat.java:244)
	at org.apache.hadoop.hive.ql.io.CombineHiveInputFormat.getRecordReader(CombineHiveInputFormat.java:538)
	at org.apache.hadoop.mapred.MapTask$TrackedRecordReader.&amp;lt;init&amp;gt;(MapTask.java:197)
	at org.apache.hadoop.mapred.MapTask.runOldMapper(MapTask.java:418)
	at org.apache.hadoop.mapred.MapTask.run(MapTask.java:372)
	at org.apache.hadoop.mapred.Child$4.run(Child.java:266)
	at java.security.AccessController.doPrivileged(Native Method)
	at javax.security.auth.Subject.doAs(Subject.java:415)
	at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1121)
	at org.apache.hadoop.mapred.Child.main(Child.java:260)
Caused by: java.io.IOException: java.lang.RuntimeException: java.lang.IndexOutOfBoundsException: Index: 0, Size: 0
	at org.apache.hadoop.hive.cassandra.cql3.input.HiveCqlInputFormat.getRecordReader(HiveCqlInputFormat.java:102)
	at org.apache.hadoop.hive.ql.io.HiveInputFormat.getRecordReader(HiveInputFormat.java:241)
	... 9 more
Caused by: java.lang.RuntimeException: java.lang.IndexOutOfBoundsException: Index: 0, Size: 0
	at org.apache.cassandra.hadoop.cql3.CqlPagingRecordReader.initialize(CqlPagingRecordReader.java:161)
	at org.apache.hadoop.hive.cassandra.cql3.input.CqlHiveRecordReader.initialize(CqlHiveRecordReader.java:91)
	at org.apache.hadoop.hive.cassandra.cql3.input.HiveCqlInputFormat.getRecordReader(HiveCqlInputFormat.java:96)
	... 10 more
Caused by: java.lang.IndexOutOfBoundsException: Index: 0, Size: 0
	at java.util.ArrayList.rangeCheck(ArrayList.java:604)
	at java.util.ArrayList.get(ArrayList.java:382)
	at org.apache.cassandra.hadoop.cql3.CqlPagingRecordReader.retrieveKeys(CqlPagingRecordReader.java:710)
	at org.apache.cassandra.hadoop.cql3.CqlPagingRecordReader.initialize(CqlPagingRecordReader.java:155)
	... 12 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Additionally, after I upgraded the whole cluster to 2.0, it lost all data and select is returning 0 rows. Not sure what happened. Unfortunately I forgot to record the count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; number returned before I started the upgrade. I have to retry and see if it is reproducible.&lt;/p&gt;</comment>
                            <comment id="13902523" author="pkolaczk" created="Sat, 15 Feb 2014 21:15:50 +0000"  >&lt;p&gt;I repeated the experiment.&lt;/p&gt;

&lt;p&gt;Before upgrade:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
cqlsh&amp;gt; select count(*) from &quot;PortfolioDemo&quot;.&quot;Stocks&quot;;

 count
-------
  2776

cqlsh&amp;gt; exit;

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After upgrading one of three nodes:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;automaton@ubuntu:~$ cqlsh
Connected to test at localhost:9160.
[cqlsh 4.1.0 | Cassandra 2.0.5-CASSANDRA-6707-SNAPSHOT | CQL spec 3.1.1 | Thrift protocol 19.39.0]
Use HELP for help.
cqlsh&amp;gt; select count(*) from &quot;PortfolioDemo&quot;.&quot;Stocks&quot;;

 count
-------
  1829

(1 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After upgrading another one (2/3):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;automaton@ubuntu:~$ cqlsh
Connected to test at localhost:9160.
[cqlsh 4.1.0 | Cassandra 2.0.5-CASSANDRA-6707-SNAPSHOT | CQL spec 3.1.1 | Thrift protocol 19.39.0]
Use HELP for help.
cqlsh&amp;gt; select count(*) from &quot;PortfolioDemo&quot;.&quot;Stocks&quot;;

 count
-------
   910

(1 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After upgrading all:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh&amp;gt; select count(*) from &quot;PortfolioDemo&quot;.&quot;Stocks&quot;;

 count
-------
     0

(1 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

</comment>
                            <comment id="13902528" author="pkolaczk" created="Sat, 15 Feb 2014 21:31:59 +0000"  >&lt;p&gt;Restarting the cluster does not bring the data back. I&apos;m afraid it lost them for good.&lt;/p&gt;</comment>
                            <comment id="13902531" author="iamaleksey" created="Sat, 15 Feb 2014 21:37:17 +0000"  >&lt;p&gt;Looks like an issue with counting to me. You can&apos;t really lose any data by running a SELECT query.&lt;/p&gt;</comment>
                            <comment id="13902537" author="pkolaczk" created="Sat, 15 Feb 2014 21:49:13 +0000"  >&lt;p&gt;Are you sure?&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[cqlsh 4.1.0 | Cassandra 2.0.5-CASSANDRA-6707-SNAPSHOT | CQL spec 3.1.1 | Thrift protocol 19.39.0]
Use HELP for help.
cqlsh&amp;gt; select * from &quot;PortfolioDemo&quot;.&quot;Stocks&quot;;

(0 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Previously it &lt;b&gt;did&lt;/b&gt; return results.&lt;/p&gt;</comment>
                            <comment id="13902538" author="iamaleksey" created="Sat, 15 Feb 2014 21:52:03 +0000"  >&lt;p&gt;Try looking it up by key.&lt;/p&gt;</comment>
                            <comment id="13902556" author="pkolaczk" created="Sat, 15 Feb 2014 22:38:39 +0000"  >&lt;p&gt;No luck. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
cqlsh&amp;gt; select * from &quot;PortfolioDemo&quot;.&quot;StockHist&quot; where key=&apos;JZL&apos;;

(0 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Previously I did:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh&amp;gt; select * from &quot;PortfolioDemo&quot;.&quot;StockHist&quot;;

 key  | column1    | value
------+------------+----------
  JZL | 2013-11-08 |   5.4057
  JZL | 2013-11-09 |   164.12
  JZL | 2013-11-10 |   479.89
  JZL | 2013-11-11 |   822.42
  JZL | 2013-11-12 |   225.37
  JZL | 2013-11-13 |   613.18
  JZL | 2013-11-14 |   387.83
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13902675" author="pkolaczk" created="Sun, 16 Feb 2014 11:01:54 +0000"  >&lt;p&gt;I repeated the experiment with one minor change. This time I did nodetool flush before upgrading the first node and I didn&apos;t do it before upgrading the second node. Here are the results:&lt;/p&gt;

&lt;p&gt;Before upgrade:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Connected to test at localhost:9160.
[cqlsh 3.1.8 | Cassandra 1.2.15.1-SNAPSHOT | CQL spec 3.0.0 | Thrift protocol 19.36.2]
Use HELP for help.
cqlsh&amp;gt; select * from &quot;PortfolioDemo&quot;.&quot;StockHist&quot; where key=&apos;JZL&apos;;

 key | column1    | value
-----+------------+--------
 JZL | 2013-11-09 | 517.41
 JZL | 2013-11-10 | 621.67
 JZL | 2013-11-11 | 647.35
 JZL | 2013-11-12 | 189.38
 JZL | 2013-11-13 | 29.725
 JZL | 2013-11-14 | 385.86
 JZL | 2013-11-15 | 900.27
 JZL | 2013-11-16 |  210.4
 JZL | 2013-11-17 | 844.64
 JZL | 2013-11-18 | 619.82
 JZL | 2013-11-19 | 956.49
 JZL | 2013-11-20 | 928.05
 JZL | 2013-11-21 | 542.06
 JZL | 2013-11-22 | 437.06
 JZL | 2013-11-23 | 806.88
 JZL | 2013-11-24 | 179.27
 JZL | 2013-11-25 | 207.45
 JZL | 2013-11-26 |  848.3
 JZL | 2013-11-27 | 715.32
 JZL | 2013-11-28 | 445.85
 JZL | 2013-11-29 | 821.07
 JZL | 2013-11-30 |  873.4
 JZL | 2013-12-01 | 625.07
 JZL | 2013-12-02 | 21.017
 JZL | 2013-12-03 | 881.37
 JZL | 2013-12-04 | 443.81
 JZL | 2013-12-05 |  432.7
 JZL | 2013-12-06 | 850.86
 JZL | 2013-12-07 | 38.699
 JZL | 2013-12-08 | 612.97
 JZL | 2013-12-09 | 158.81
 JZL | 2013-12-10 | 378.39
 JZL | 2013-12-11 | 245.21
 JZL | 2013-12-12 | 428.54
 JZL | 2013-12-13 | 664.41
 JZL | 2013-12-14 | 784.94
 JZL | 2013-12-15 | 820.02
 JZL | 2013-12-16 | 859.82
 JZL | 2013-12-17 |  258.5
 JZL | 2013-12-18 | 731.21
 JZL | 2013-12-19 | 384.75
 JZL | 2013-12-20 | 696.25
 JZL | 2013-12-21 |  936.1
 JZL | 2013-12-22 | 781.04
 JZL | 2013-12-23 | 113.63
 JZL | 2013-12-24 | 254.12
 JZL | 2013-12-25 | 120.91
 JZL | 2013-12-26 | 65.565
 JZL | 2013-12-27 |  378.6
 JZL | 2013-12-28 | 712.02
 JZL | 2013-12-29 | 953.41
 JZL | 2013-12-30 | 788.21
 JZL | 2013-12-31 | 236.73
 JZL | 2014-01-01 | 727.81
 JZL | 2014-01-02 | 128.59
 JZL | 2014-01-03 | 290.18
 JZL | 2014-01-04 | 930.29
 JZL | 2014-01-05 | 160.98
 JZL | 2014-01-06 | 992.55
 JZL | 2014-01-07 | 92.251
 JZL | 2014-01-08 | 456.14
 JZL | 2014-01-09 | 969.27
 JZL | 2014-01-10 | 769.52
 JZL | 2014-01-11 | 864.01
 JZL | 2014-01-12 | 516.35
 JZL | 2014-01-13 | 547.88
 JZL | 2014-01-14 | 128.87
 JZL | 2014-01-15 | 847.73
 JZL | 2014-01-16 | 232.34
 JZL | 2014-01-17 | 491.26
 JZL | 2014-01-18 | 196.56
 JZL | 2014-01-19 |  57.35
 JZL | 2014-01-20 | 978.43
 JZL | 2014-01-21 | 588.59
 JZL | 2014-01-22 | 377.69
 JZL | 2014-01-23 | 772.32
 JZL | 2014-01-24 | 377.71
 JZL | 2014-01-25 | 121.46
 JZL | 2014-01-26 | 202.91
 JZL | 2014-01-27 | 679.37
 JZL | 2014-01-28 | 558.55
 JZL | 2014-01-29 | 493.89
 JZL | 2014-01-30 | 759.51
 JZL | 2014-01-31 | 331.46
 JZL | 2014-02-01 | 291.12
 JZL | 2014-02-02 | 533.44
 JZL | 2014-02-03 | 950.21
 JZL | 2014-02-04 | 920.72
 JZL | 2014-02-05 | 843.61
 JZL | 2014-02-06 | 447.53
 JZL | 2014-02-07 | 797.89
 JZL | 2014-02-08 | 419.86
 JZL | 2014-02-09 | 640.36
 JZL | 2014-02-10 | 123.98
 JZL | 2014-02-11 | 339.73
 JZL | 2014-02-12 | 833.88
 JZL | 2014-02-13 | 699.87
 JZL | 2014-02-14 |  705.4
 JZL | 2014-02-15 | 655.25
 JZL | 2014-02-16 | 950.93

cqlsh&amp;gt; select * from &quot;PortfolioDemo&quot;.&quot;StockHist&quot; where key=&apos;JZL&apos; and column1=&apos;2013-11-09&apos;;

 key | column1    | value
-----+------------+--------
 JZL | 2013-11-09 | 517.41

cqlsh&amp;gt; exit;
automaton@ubuntu:~$ cqlsh
Connected to test at localhost:9160.
[cqlsh 3.1.8 | Cassandra 1.2.15.1-SNAPSHOT | CQL spec 3.0.0 | Thrift protocol 19.36.2]
Use HELP for help.
cqlsh&amp;gt; select count(*) from &quot;PortfolioDemo&quot;.&quot;Stocks&quot;;

 count
-------
  2767

cqlsh&amp;gt; exit;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After nodetool flush on the first node and upgrade of the first node:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Connected to test at localhost:9160.
[cqlsh 4.1.0 | Cassandra 2.0.5-CASSANDRA-6707-SNAPSHOT | CQL spec 3.1.1 | Thrift protocol 19.39.0]
Use HELP for help.
cqlsh&amp;gt; select count(*) from &quot;PortfolioDemo&quot;.&quot;Stocks&quot;;

 count
-------
  2767

(1 rows)

cqlsh&amp;gt; select * from &quot;PortfolioDemo&quot;.&quot;StockHist&quot; where key=&apos;JZL&apos; and column1=&apos;2013-11-09&apos;;

 key | column1    | value
-----+------------+--------
 JZL | 2013-11-09 | 517.41

(1 rows)

cqlsh&amp;gt; exit;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After upgrading the second node (&lt;b&gt;no nodetool flush&lt;/b&gt; - deliberately):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;automaton@ubuntu:~$ cqlsh
Connected to test at localhost:9160.
[cqlsh 4.1.0 | Cassandra 2.0.5-CASSANDRA-6707-SNAPSHOT | CQL spec 3.1.1 | Thrift protocol 19.39.0]
Use HELP for help.
cqlsh&amp;gt; select count(*) from &quot;PortfolioDemo&quot;.&quot;Stocks&quot;;

 count
-------
  1853

(1 rows)

cqlsh&amp;gt; select * from &quot;PortfolioDemo&quot;.&quot;StockHist&quot; where key=&apos;JZL&apos; and column1=&apos;2013-11-09&apos;;

(0 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There were &lt;b&gt;no errors nor warnings&lt;/b&gt; reported in the system.log when the new nodes were starting up.&lt;br/&gt;
It looks like we&apos;ve got a serious problem with commit-log. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; loaded more data than me, so probably it managed to flush most data. That explains pretty well his results (count being slightly below the correct value).&lt;/p&gt;</comment>
                            <comment id="13902676" author="pkolaczk" created="Sun, 16 Feb 2014 11:04:18 +0000"  >&lt;p&gt;BTW: I double checked - commit log location did not change.&lt;/p&gt;</comment>
                            <comment id="13902677" author="pkolaczk" created="Sun, 16 Feb 2014 11:06:16 +0000"  >&lt;p&gt;Flushing the second node &lt;b&gt;after the upgrade&lt;/b&gt; does not bring the data back. So I guess those data were not loaded into memtable from CL.&lt;/p&gt;</comment>
                            <comment id="13902778" author="iamaleksey" created="Sun, 16 Feb 2014 18:43:50 +0000"  >&lt;p&gt;You are supposed to &apos;nodetool drain&apos; before upgrading (or, at least I always assumed so).&lt;/p&gt;</comment>
                            <comment id="13902797" author="pkolaczk" created="Sun, 16 Feb 2014 19:45:30 +0000"  >&lt;p&gt;Ok, I retry with nodetool drain.&lt;/p&gt;</comment>
                            <comment id="13902803" author="benedict" created="Sun, 16 Feb 2014 20:04:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;You are supposed to &apos;nodetool drain&apos; before upgrading (or, at least I always assumed so).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Even so, I don&apos;t think there&apos;s a good reason for this to fail - nothing has changed in log replay. Seems like we should be resilient to this if possible.&lt;/p&gt;

&lt;p&gt;I would guess it&apos;s because any schema upgrading hasn&apos;t happened before we replay the CL, so we don&apos;t find the CFs the records are associated with, as I can&apos;t see any other reason for this to go wrong.&lt;/p&gt;</comment>
                            <comment id="13902807" author="iamaleksey" created="Sun, 16 Feb 2014 20:09:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;I would guess it&apos;s because any schema upgrading hasn&apos;t happened before we replay the CL&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Nope, most definitely not it (no breaking schema changes that could affect this between 1.2 and 2.0).&lt;/p&gt;

&lt;p&gt;The RowMutation serialization, however, has changed between VERSION_12 and VERSION_20 (keyspace name present/absent). The commitlog is, and has always been, implicitly versioned, even if the replay code itself hasn&apos;t changed.&lt;/p&gt;</comment>
                            <comment id="13902809" author="benedict" created="Sun, 16 Feb 2014 20:15:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;The RowMutation serialization, however, has changed between VERSION_12 and VERSION_20 (keyspace name present/absent). The commitlog is, and has always been, implicitly versioned, even if the replay code itself hasn&apos;t changed.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, but it is supposed to be able to replay these older versions. Both the replay and the RM are aware of the version change, so if this is the problem it is a bug.&lt;/p&gt;</comment>
                            <comment id="13902810" author="iamaleksey" created="Sun, 16 Feb 2014 20:15:36 +0000"  >&lt;p&gt;See the comment (and code) at/after &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-2.0/src/java/org/apache/cassandra/db/commitlog/CommitLogReplayer.java#L269&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-2.0/src/java/org/apache/cassandra/db/commitlog/CommitLogReplayer.java#L269&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Not saying that this is the right/proper way to do it, just pointing to how it currently works.&lt;/p&gt;</comment>
                            <comment id="13902812" author="benedict" created="Sun, 16 Feb 2014 20:19:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-2.0/src/java/org/apache/cassandra/db/commitlog/CommitLogReplayer.java#L237&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-2.0/src/java/org/apache/cassandra/db/commitlog/CommitLogReplayer.java#L237&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-2.0/src/java/org/apache/cassandra/db/RowMutation.java#L274&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-2.0/src/java/org/apache/cassandra/db/RowMutation.java#L274&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Not sure why we go to such lengths to make sure we can do it elsewhere then? It seems like all the related code thinks it can replay these version changes...&lt;/p&gt;</comment>
                            <comment id="13902817" author="benedict" created="Sun, 16 Feb 2014 20:27:19 +0000"  >&lt;p&gt;Note that comment is from 1.1; it&apos;s not clear it&apos;s up-to-date with the latest intent. Especially since it doesn&apos;t assume the current version - it passes in the actual version of the CLS, whereas in 1.1 it really did assume.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-1.1/src/java/org/apache/cassandra/db/commitlog/CommitLogReplayer.java#L202&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-1.1/src/java/org/apache/cassandra/db/commitlog/CommitLogReplayer.java#L202&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Also, if there were an error deserializing, it should throw an exception that would be logged as an error.&lt;/p&gt;</comment>
                            <comment id="13903159" author="pkolaczk" created="Mon, 17 Feb 2014 11:49:49 +0000"  >&lt;p&gt;If it can deserialize, it should do it. If it cannot (unsupported version), it should bail out, shout at the user &quot;don&apos;t do this! do nodetool drain first!&quot; and terminate without touching any data. This way it is now, I&apos;m pretty sure some of the customers will run into this, and telling them it was their fault wouldn&apos;t make them less unhappy. We&apos;re not mongo to penalize them with silent data loss.&lt;/p&gt;</comment>
                            <comment id="13903163" author="pkolaczk" created="Mon, 17 Feb 2014 11:59:37 +0000"  >&lt;p&gt;I tested again doing nodetool drain before upgrading every single node and counts were correct. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; patch works fine and lgtm.&lt;br/&gt;
+1&lt;/p&gt;

&lt;p&gt;Shouldn&apos;t we move the commitlog replay problem to another ticket?&lt;/p&gt;</comment>
                            <comment id="13903238" author="iamaleksey" created="Mon, 17 Feb 2014 13:41:45 +0000"  >&lt;p&gt;Committed to 2.0, waiting for 2.0-&amp;gt;trunk merge of another issue before committing to trunk.&lt;/p&gt;</comment>
                            <comment id="13903247" author="iamaleksey" created="Mon, 17 Feb 2014 13:54:55 +0000"  >&lt;p&gt;Committed, thanks everybody.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12629131" name="6707.patch" size="3433" author="thobbs" created="Fri, 14 Feb 2014 22:20:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>373675</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 40 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1se8n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>373975</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>pkolaczk</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[pkolaczk]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>