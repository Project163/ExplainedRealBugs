<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:10:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13006] Disable automatic heap dumps on OOM error</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13006</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;With&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9861&quot; title=&quot;When forcibly exiting due to OOM, we should produce a heap dump&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9861&quot;&gt;&lt;del&gt;CASSANDRA-9861&lt;/del&gt;&lt;/a&gt;, a change was added to enable collecting heap dumps by default if the process encountered an OOM error. These heap dumps are stored in the Apache Cassandra home directory unless configured otherwise (see&#160;&lt;a href=&quot;https://support.datastax.com/hc/en-us/articles/204225959-Generating-and-Analyzing-Heap-Dumps&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Cassandra Support Document&lt;/a&gt; for this feature).&lt;br/&gt;
&#160;&lt;br/&gt;
The creation and storage of heap dumps aides debugging and investigative workflows, but is not be desirable for a production environment where these heap dumps may occupy a large amount of disk space and require manual intervention for cleanups.&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
Managing heap dumps on out of memory errors and configuring the paths for these heap dumps are available as JVM options in JVM. The current behavior conflicts with the Boolean JVM flag HeapDumpOnOutOfMemoryError.&#160;&lt;br/&gt;
&#160;&lt;br/&gt;
A patch can be proposed here that would make the heap dump on OOM error honor the&#160;HeapDumpOnOutOfMemoryError&#160;flag. Users who would want to still generate heap dumps on OOM errors can set the&#160;-XX:+HeapDumpOnOutOfMemoryError&#160;JVM option.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13025986">CASSANDRA-13006</key>
            <summary>Disable automatic heap dumps on OOM error</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blerer">Benjamin Lerer</assignee>
                                    <reporter username="anmolsharma.141">anmols</reporter>
                        <labels>
                    </labels>
                <created>Tue, 6 Dec 2016 15:19:51 +0000</created>
                <updated>Wed, 15 Oct 2025 09:49:07 +0000</updated>
                            <resolved>Tue, 12 Dec 2017 09:57:19 +0000</resolved>
                                        <fixVersion>2.2.12</fixVersion>
                    <fixVersion>3.0.16</fixVersion>
                    <fixVersion>3.11.2</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Local/Config</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>17</watches>
                                                                                                                <comments>
                            <comment id="15725927" author="cnlwsu" created="Tue, 6 Dec 2016 16:13:16 +0000"  >&lt;p&gt;I am &lt;tt&gt;-1&lt;/tt&gt; on this. With current compaction strategies production nodes should have 50-30% free disk space and a heap dump of 8gb is difference between being able to debug bad issues and not. Its like removing log files to save disk space. If anything making it a &quot;rotating&quot; heap dumpa to only have at most 5 or something sounds like a better idea (like log files).&lt;/p&gt;</comment>
                            <comment id="15726095" author="blerer" created="Tue, 6 Dec 2016 17:14:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anmolsharma.141&quot; class=&quot;user-hover&quot; rel=&quot;anmolsharma.141&quot;&gt;anmolsharma.141&lt;/a&gt; Out of curiosity, how often do your nodes dies of an OOM error? &lt;/p&gt;</comment>
                            <comment id="15727672" author="JIRAUSER308715" created="Wed, 7 Dec 2016 04:38:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnlwsu&quot; class=&quot;user-hover&quot; rel=&quot;cnlwsu&quot;&gt;cnlwsu&lt;/a&gt; This isn&apos;t proposing we remove heap dumps, just that we honor the JVM flags for making and storing them. I think that is probably a good idea.&lt;/p&gt;

&lt;p&gt;We should still default our flags to make them in env files, but users should have control over if they are to be written out, besides hacks like setting the output to a read only location.&lt;/p&gt;</comment>
                            <comment id="15728130" author="blerer" created="Wed, 7 Dec 2016 08:37:02 +0000"  >&lt;p&gt;I also believe that the issue is legitimate as the code is already relying on the JVM argument for the location where the dumps must be generated. After I am not convinced that turning it off is a wise thing to do.&lt;/p&gt;</comment>
                            <comment id="15730355" author="anmolsharma.141" created="Wed, 7 Dec 2016 23:52:49 +0000"  >&lt;p&gt;Patch for Disabling Heap Dumps if JVM option HeapDumpOnOutOfMemoryError is not set.&lt;/p&gt;</comment>
                            <comment id="15730360" author="anmolsharma.141" created="Wed, 7 Dec 2016 23:53:57 +0000"  >&lt;p&gt;Disable heap dumps if JVM option HeapDumpOnOutOfMemoryError is not set.&lt;/p&gt;</comment>
                            <comment id="15730400" author="anmolsharma.141" created="Thu, 8 Dec 2016 00:12:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; We encountered a condition in one of our clusters that resulted in repeated OOMs across many of the nodes. The reason for the OOMs is an issue (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12796&quot; title=&quot;Heap exhaustion when rebuilding secondary index over a table with wide partitions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12796&quot;&gt;&lt;del&gt;CASSANDRA-12796&lt;/del&gt;&lt;/a&gt;) that was causing heap exhaustion when rebuilding secondary indexes over wide partitions.&lt;/p&gt;
</comment>
                            <comment id="15741620" author="blerer" created="Mon, 12 Dec 2016 10:56:34 +0000"  >&lt;p&gt;One thing that I did not consider why working on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9861&quot; title=&quot;When forcibly exiting due to OOM, we should produce a heap dump&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9861&quot;&gt;&lt;del&gt;CASSANDRA-9861&lt;/del&gt;&lt;/a&gt; was that not everybody use the Oracle JVM. It is clear that some people use &lt;tt&gt;Zing&lt;/tt&gt; and I guess that some people might also be using the IBM JVM. All of those JVM seems to provide &lt;tt&gt;jmap&lt;/tt&gt; but they do not seems to use the same configuration arguments for handling &lt;tt&gt;OOM&lt;/tt&gt; errors. I could not find the &lt;tt&gt;Zing&lt;/tt&gt; options (&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nitsanw&quot; class=&quot;user-hover&quot; rel=&quot;nitsanw&quot;&gt;nitsanw&lt;/a&gt; do you have any idea of where I could get them?) but the IBM JVM does not use the same options as the Oracle one.&lt;br/&gt;
Moreover, the Oracle JVM support also options like &lt;tt&gt;-XX:OnOutOfMemoryError&lt;/tt&gt; which we currently ignore.&lt;/p&gt;

&lt;p&gt;To be honest, I am not fully sure how we should handle all that. We could:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;try to determine which JVM is being used and check for the relevants options (knowing that it will never be fully bulletproof)&lt;/li&gt;
	&lt;li&gt;ignore the JVM options and create our own configuration for it (knowing that it might be confusing for the administrators)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Any opinions or suggestions?    &lt;/p&gt;</comment>
                            <comment id="15750847" author="nitsanw" created="Thu, 15 Dec 2016 09:08:31 +0000"  >&lt;p&gt;OnOutOfMemoryError and HeapDumpOnOutOfMemoryError are both available on Zing.&lt;br/&gt;
The default for HeapDumpOnOutOfMemoryError is false.&lt;br/&gt;
Let me know if you need more details.&lt;/p&gt;</comment>
                            <comment id="15880056" author="anmolsharma.141" created="Thu, 23 Feb 2017 07:39:34 +0000"  >&lt;p&gt;I have suggested a patch for this issue, can you please let me know if this is acceptable for this issue?&lt;/p&gt;</comment>
                            <comment id="15880141" author="blerer" created="Thu, 23 Feb 2017 08:59:17 +0000"  >&lt;p&gt;Sorry, for the misunderstanding.&lt;br/&gt;
Your patch fix only one part of the problem and I would rather fix all the problems at once than solving them in multiple tickets.&lt;/p&gt;

&lt;p&gt;Basically, the fix need to take into account the JVM being used and handle the processing of &lt;tt&gt;OOM&lt;/tt&gt; errors accordingly. It also need to support options like &lt;tt&gt;-XX:OnOutOfMemoryError&lt;/tt&gt;.&lt;br/&gt;
Apparently, &lt;tt&gt;Oracle&lt;/tt&gt; and &lt;tt&gt;Zing&lt;/tt&gt; JVMs use the same options names. The &lt;tt&gt;IBM&lt;/tt&gt; one seems to use different options.&lt;br/&gt;
The patch should also log a clear error message if the JVM is not supported.&lt;/p&gt;

&lt;p&gt;If you are still interested in working on this issue, feel free to reasign it to yourself. &lt;/p&gt;</comment>
                            <comment id="15975153" author="nibin.gv" created="Wed, 19 Apr 2017 17:44:03 +0000"  >&lt;p&gt;Oracle Java&apos;s JRE 8 and Server JRE 8 for linux environments are not shipping jmap anymore. That means, we have to use Oracle Java&apos;s JDK for the heap dumps to be generated from cassandra. And some of the security compliance won&apos;t permit the use of JDK in production.&lt;/p&gt;

&lt;p&gt;It would be great if an option is provided to disable heap dump from the application code&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;. So that JVM can generate the heap dump. Or use jcmd utility (available in server-jre 8 and jdk 8) instead of jmap.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://github.com/apache/cassandra/blob/81f6c784ce967fadb6ed7f58de1328e713eaf53c/src/java/org/apache/cassandra/utils/JVMStabilityInspector.java#L56&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/81f6c784ce967fadb6ed7f58de1328e713eaf53c/src/java/org/apache/cassandra/utils/JVMStabilityInspector.java#L56&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="15975192" author="JIRAUSER308715" created="Wed, 19 Apr 2017 18:04:31 +0000"  >&lt;p&gt;We could fall back to trying to use the &quot;com.sun.management:type=HotSpotDiagnostic&quot; bean directly if we can&apos;t find jmap.&lt;/p&gt;

&lt;p&gt;Some links for doing this:&lt;br/&gt;
&lt;a href=&quot;https://blogs.oracle.com/sundararajan/entry/programmatically_dumping_heap_from_java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://blogs.oracle.com/sundararajan/entry/programmatically_dumping_heap_from_java&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://stackoverflow.com/a/12297339/138693&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/a/12297339/138693&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15975265" author="nibin.gv" created="Wed, 19 Apr 2017 18:40:54 +0000"  >&lt;p&gt;Why can&apos;t we delegate the heap dump generation to JVM if jmap is not available in class path ? JRE can generate heap dump even if jmap is not there in the path.&lt;/p&gt;</comment>
                            <comment id="16118421" author="urandom" created="Tue, 8 Aug 2017 14:56:30 +0000"  >&lt;p&gt;I think this behavior (invoking &lt;tt&gt;jmap&lt;/tt&gt; on OOM) is a pretty serious violation to the Element of Least-surprise.  We already provide mechanisms for passing arguments to the JVM, and TTBMK, all of them provide some means for dropping a heap dump on out-of-memory.&lt;/p&gt;

&lt;p&gt;It definitely caught me be surprise.  We carried over &lt;tt&gt;-XX:+HeapDumpOnOutOfMemoryError&lt;/tt&gt; from our 2.2.x environment, only to have Cassandra and the JVM racing to create a dump of the same name.&lt;/p&gt;

&lt;p&gt;Additionally, something about all of this is buggy, because on more than one occasion we&apos;ve had Cassandra fork-bombing &lt;tt&gt;jmap&lt;/tt&gt; processes&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&#9679; cassandra-b.service - distributed storage system for structured data
   Loaded: loaded (/lib/systemd/system/cassandra-b.service; static)
   Active: active (running) since Sat 2017-08-05 22:32:07 UTC; 23h ago
 Main PID: 25025 (java)
   CGroup: /system.slice/cassandra-b.service
           &#9500;&#9472; 9213 jmap -histo 25025
           &#9500;&#9472; 9214 jmap -histo 25025
           &#9500;&#9472; 9284 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472; 9285 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472; 9388 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472; 9453 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472; 9519 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472; 9520 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472; 9733 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472; 9735 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472; 9736 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472;14835 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472;14836 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472;14837 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472;14839 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472;14841 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472;14844 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472;18932 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472;18933 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472;18934 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472;18935 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472;18936 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472;18937 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472;18938 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472;18939 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472;18940 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472;18942 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472;18943 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472;18944 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           &#9500;&#9472;18945 jmap -dump:format=b,file=/srv/cassandra-b/cassandra-1501972327-pid24937.hprof 25025
           [ ... ]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;IMO, the sanest strategy here would be to leave the creation of heap dumps to the JVM.&lt;/p&gt;
</comment>
                            <comment id="16135080" author="blerer" created="Mon, 21 Aug 2017 12:02:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=urandom&quot; class=&quot;user-hover&quot; rel=&quot;urandom&quot;&gt;urandom&lt;/a&gt; Sorry, this ticket felt out of my radar.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;IMO, the sanest strategy here would be to leave the creation of heap dumps to the JVM.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I fully agree with you. &lt;br/&gt;
Initially, we started to catch &lt;tt&gt;OOM&lt;/tt&gt; errors to prevent C* to run in an unknown state that could cause data corruption (see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7507&quot; title=&quot;OOM creates unreliable state - die instantly better&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7507&quot;&gt;&lt;del&gt;CASSANDRA-7507&lt;/del&gt;&lt;/a&gt;). The problem with that approach  was that Heap dumps were not created anymore on &lt;tt&gt;OOM&lt;/tt&gt; errors. I tried to fix that in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9861&quot; title=&quot;When forcibly exiting due to OOM, we should produce a heap dump&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9861&quot;&gt;&lt;del&gt;CASSANDRA-9861&lt;/del&gt;&lt;/a&gt; but that approach seems to have some serious issues and limitations.&lt;/p&gt;

&lt;p&gt;In April 2016, roughly at the same time that I was fixing &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9861&quot; title=&quot;When forcibly exiting due to OOM, we should produce a heap dump&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9861&quot;&gt;&lt;del&gt;CASSANDRA-9861&lt;/del&gt;&lt;/a&gt;, Oracle released the &lt;a href=&quot;http://www.oracle.com/technetwork/java/javase/8u92-relnotes-2949471.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JDK 8u92&lt;/a&gt; which added 2 new JVM Options: &lt;tt&gt;ExitOnOutOfMemoryError&lt;/tt&gt; and &lt;tt&gt;CrashOnOutOfMemoryError&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;With that in mind, my idea would be to:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;stop handling the &lt;tt&gt;OOM&lt;/tt&gt; errors on the C* side (and producing Heap dump)&lt;/li&gt;
	&lt;li&gt;add  &lt;tt&gt;ExitOnOutOfMemoryError&lt;/tt&gt;  to the default JVM options in the startup scripts&lt;/li&gt;
	&lt;li&gt;in the &lt;tt&gt;News.txt&lt;/tt&gt; upgrade procedure: request people to use a java version &amp;gt;= &lt;tt&gt;8u92&lt;/tt&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=JoshuaMcKenzie&quot; class=&quot;user-hover&quot; rel=&quot;JoshuaMcKenzie&quot;&gt;JoshuaMcKenzie&lt;/a&gt; you worked on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7507&quot; title=&quot;OOM creates unreliable state - die instantly better&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7507&quot;&gt;&lt;del&gt;CASSANDRA-7507&lt;/del&gt;&lt;/a&gt;. Do you have any concern with the approach I am suggesting?&lt;/p&gt;

&lt;p&gt;My only concern right now is that I know that some C* users are using Zing and I do not if it support the &lt;tt&gt;ExitOnOutOfMemoryError&lt;/tt&gt; option.&lt;br/&gt;
I asked the Zing support and will update the ticket as soon as I know more.&lt;/p&gt;

</comment>
                            <comment id="16137242" author="jmckenzie" created="Tue, 22 Aug 2017 19:24:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;Joshua McKenzie you worked on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7507&quot; title=&quot;OOM creates unreliable state - die instantly better&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7507&quot;&gt;&lt;del&gt;CASSANDRA-7507&lt;/del&gt;&lt;/a&gt;. Do you have any concern with the approach I am suggesting?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No major concerns; maybe we should have a commented out option in the config to add &lt;tt&gt;CrashOnOutOfMemoryError&lt;/tt&gt; for operators that would prefer to use that?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;in the News.txt upgrade procedure: request people to use a java version &amp;gt;= 8u92&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;We can also enforce that or warn when we version check in the startup scripts.&lt;/p&gt;</comment>
                            <comment id="16167937" author="ajorgensen" created="Fri, 15 Sep 2017 14:27:48 +0000"  >&lt;p&gt;Just to ask a clarifying question for my own understanding. This change would change the default from always producing a heap dump to having to explicitly turn it on which I think is good. One place this might trip some people up is cassandra has a command line &lt;a href=&quot;https://github.com/apache/cassandra/blob/fe3cfe3d7df296f022c50c9c0d22f91a0fc0a217/bin/cassandra#L245-L247&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;argument&lt;/a&gt; that allows setting the specific location of the heap dump. One place that I know this is used is in the &lt;a href=&quot;https://github.com/apache/cassandra/blob/fe3cfe3d7df296f022c50c9c0d22f91a0fc0a217/debian/init#L86-L87&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;debian init&lt;/a&gt; script. Presumably if that flag is set the user wants to get heap dumps, is it worth also checking to see if -XX:HeapDumpPath or -XX:+HeapDumpOnOutOfMemoryError are present when creating a heap dump to make sure the behavior stays consistent?&lt;/p&gt;

&lt;p&gt;I also have another change &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13843&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;CASSANDRA-13843&lt;/a&gt; that I am proposing to fix the debian init script since it shadows the HeapDumpPath environment variable and renders it unchangeable from the default in its current form. &lt;/p&gt;</comment>
                            <comment id="16195149" author="blerer" created="Fri, 6 Oct 2017 19:46:12 +0000"  >
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=urandom&quot; class=&quot;user-hover&quot; rel=&quot;urandom&quot;&gt;urandom&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Sorry, for the delay.&lt;/p&gt;

&lt;p&gt;I pushed some patches for &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...blerer:13006-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt;, &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...blerer:13006-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;,  &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...blerer:13006-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:13006-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The branches differs only at the level of the configuration files (&lt;tt&gt;cassandra-env.sh&lt;/tt&gt; and &lt;tt&gt;cassandra-env.ps1&lt;/tt&gt;). &lt;/p&gt;

&lt;p&gt;The patches let the JVM handle the &lt;tt&gt;OutOfMemoryErrors&lt;/tt&gt; throught the JVM &lt;tt&gt;OnOutOfMemoryError&lt;/tt&gt;, &lt;tt&gt;ExitOnOutOfMemoryError&lt;/tt&gt; or &lt;tt&gt;CrashOnOutOfMemoryError&lt;/tt&gt; options.&lt;br/&gt;
As the &lt;tt&gt;ExitOnOutOfMemoryError&lt;/tt&gt; and &lt;tt&gt;CrashOnOutOfMemoryError&lt;/tt&gt; options are only supported since Oracle JDK 7 update 101 and since JDK 8 update 92, Cassandra uses by default the &lt;tt&gt;OnOutOfMemoryError&lt;/tt&gt; option.&lt;/p&gt;

&lt;p&gt;A startup check will emit a warning if none of the options is used. This check is there to ensure that &lt;tt&gt;OOM&lt;/tt&gt; errors are properly handled and that C* cannot continue to run in an unstable state that could cause data corruption.&lt;br/&gt;
The patch add no check for the &lt;tt&gt;HeapDumpOnOutOfMemoryError&lt;/tt&gt; option as in some cases administrators prefer to disable them.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;cassandra-env.sh&lt;/tt&gt; has a new variable &lt;tt&gt;JVM_ON_OUT_OF_MEMORY_ERROR_OPT&lt;/tt&gt; which should be use to specify the &lt;tt&gt;OnOutOfMemoryError&lt;/tt&gt; option. As bash commands split words on white spaces without taking quotes into account, specifying the &lt;tt&gt;OnOutOfMemoryError&lt;/tt&gt; as part of the &lt;tt&gt;JVM_OPTS&lt;/tt&gt; variable cannot work for an option value such as: &lt;tt&gt;kill -9 %p&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Before generating an heap dump, C* use to log an Heap histogram using &lt;tt&gt;jmap&lt;/tt&gt;. If the heap size was large, reading the heap dump could take a few hours and the heap histogram can help to debug the problem much faster. The patches keep the posibility to print an heap histogram on OOM error but disables it by default. To enable it the &lt;tt&gt;cassandra.printHeapHistogramOnOutOfMemoryError&lt;/tt&gt; system property must be set to &lt;tt&gt;true&lt;/tt&gt;.&lt;br/&gt;
As generating the histogram for only the live objects (using &lt;tt&gt;jmap histo:live&lt;/tt&gt;) would trigger a garbage collection before generating the histogram, I prefered to stick with &lt;tt&gt;jmap histo&lt;/tt&gt; to minimize the risks.  &lt;/p&gt;

&lt;p&gt;The previous implementation was suffering of 2 problems:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;If several OOM errors were thrown in a short time span, each of them would trigger an heap histogram and an heap dump (see this &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13006?focusedCommentId=16118421&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16118421&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;comment&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;If an exception was thrown while C* was trying to generate the heap dump, C* would not be shutdown and would continue running in an unstable state (see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13886&quot; title=&quot;OOM put node in limbo&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13886&quot;&gt;&lt;del&gt;CASSANDRA-13886&lt;/del&gt;&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The patches fix those problems for the case were an heap histogram need to be logged. In the case were the histogram is not requested those problems do not exist anymore.&lt;/p&gt;

&lt;p&gt;CI looks good for the unit tests. &lt;br/&gt;
The changes to the &lt;tt&gt;cassandra&lt;/tt&gt; startup script break the DTests but before changing the &lt;tt&gt;DTests&lt;/tt&gt; framework I would prefer having a first review of the patches.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=JoshuaMcKenzie&quot; class=&quot;user-hover&quot; rel=&quot;JoshuaMcKenzie&quot;&gt;JoshuaMcKenzie&lt;/a&gt; could you review the patches? &lt;/p&gt;</comment>
                            <comment id="16195167" author="blerer" created="Fri, 6 Oct 2017 19:55:10 +0000"  >&lt;p&gt;Just realized that I forgot to switch from &lt;tt&gt;jmap&lt;/tt&gt; to &lt;tt&gt;jcmd&lt;/tt&gt;, for generating heap histograms, as suggested by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nibin.gv&quot; class=&quot;user-hover&quot; rel=&quot;nibin.gv&quot;&gt;nibin.gv&lt;/a&gt;. I will update my patches in the coming days.&lt;/p&gt;</comment>
                            <comment id="16247177" author="blerer" created="Fri, 10 Nov 2017 08:15:07 +0000"  >&lt;p&gt;I updated the patches for &lt;tt&gt;3.0&lt;/tt&gt;, &lt;tt&gt;3.11&lt;/tt&gt; and &lt;tt&gt;trunk&lt;/tt&gt;. I replaced the use of &lt;tt&gt;jmap&lt;/tt&gt; by &lt;tt&gt;jcmd&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;CI results look good for the unit tests.&lt;/p&gt;</comment>
                            <comment id="16260876" author="jmckenzie" created="Tue, 21 Nov 2017 15:09:17 +0000"  >&lt;p&gt;Sorry for the delay - didn&apos;t realize I was reviewer on this.&lt;/p&gt;

&lt;p&gt;Feedback follows:&lt;/p&gt;


&lt;p&gt;general feedback:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;In our launch scripts, why have a separate JVM_ON_OUT_OF_MEMORY_ERROR_OPT instead of nesting it inside JVM_OPTS? The latter seems more consistent w/other configuration approaches. This would also clean up launching branch logic a touch.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;nits:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Not sure why StartupChecks.checkOutOfMemoryHandling() is scoped to protected. Should be able to be private.&lt;/li&gt;
	&lt;li&gt;remove added whitespace at top of bin/cassandra.sh&lt;/li&gt;
	&lt;li&gt;misspelling: 
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; # uncomment the prefered option &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; should be &lt;tt&gt;preferred&lt;/tt&gt;&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;Same holds for conf/cassandra-env.sh&lt;/li&gt;
	&lt;li&gt;Having parseJavaVersion and parseUpdate both take no arguments and System.getProperty(&quot;java.version&quot;) would be a cleaner interface. This isn&apos;t critical path in any way so the duplicate calls to getProperty would be no real issue.&lt;/li&gt;
	&lt;li&gt;&quot;jmcd&quot; should read &quot;jcmd&quot; in comments in HeapUtils.java, line 55&lt;/li&gt;
	&lt;li&gt;Since HeapUtils is the only call-site for &lt;tt&gt;logProcessOutput&lt;/tt&gt;, that can be inlined if you&apos;re in the mood for it.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Basically a bag of trivial things - looks good on the whole. +1 with the above nits dealt with as you see fit.&lt;/p&gt;</comment>
                            <comment id="16260929" author="blerer" created="Tue, 21 Nov 2017 15:44:49 +0000"  >&lt;p&gt;Thanks for the review.&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
	&lt;li&gt;In our launch scripts, why have a separate JVM_ON_OUT_OF_MEMORY_ERROR_OPT instead of nesting it inside JVM_OPTS? The latter seems more consistent w/other configuration approaches. This would also clean up launching branch logic a touch.&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;As bash commands split words on white spaces without taking quotes into account, specifying the &lt;tt&gt;OnOutOfMemoryError&lt;/tt&gt; as part of the &lt;tt&gt;JVM_OPTS&lt;/tt&gt; variable cannot work for an option value such as: &lt;tt&gt;kill -9 %p&lt;/tt&gt;. I wasted a couple of days on that and could not come up with a better solution that the proposed one.&lt;/p&gt;

&lt;p&gt;I will take care of the nits.&lt;/p&gt;</comment>
                            <comment id="16286970" author="jjirsa" created="Tue, 12 Dec 2017 02:02:57 +0000"  >&lt;p&gt;Friendly ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; that this is sitting in &quot;Ready to Commit&quot;.&lt;/p&gt;</comment>
                            <comment id="16287277" author="blerer" created="Tue, 12 Dec 2017 08:46:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt; Thanks for the reminder. &lt;br/&gt;
I fixed the review comments and rerun CI on our internal instances. Tests looks good including the DTests ones (no new failing tests).&lt;/p&gt;</comment>
                            <comment id="16287364" author="blerer" created="Tue, 12 Dec 2017 09:57:19 +0000"  >&lt;p&gt;Committed into cassandra-2.2 at 02aba7343ce300397ab672bbb1788aa8182d8a48 and merged into 3.0, 3.11 and trunk&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13103541">CASSANDRA-13886</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13400331">CASSANDRA-16939</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12842247" name="13006-3.0.9.txt" size="2197" author="anmolsharma.141" created="Wed, 7 Dec 2016 23:52:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 49 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i378b3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12336056">3.0.8</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>joshuamckenzie</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[joshuamckenzie]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>