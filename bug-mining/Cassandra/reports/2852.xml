<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:45:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7279] MultiSliceTest.test_with_overlap* unit tests failing in trunk</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7279</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Example:&lt;br/&gt;
&lt;a href=&quot;https://cassci.datastax.com/job/trunk_utest/623/testReport/org.apache.cassandra.thrift/MultiSliceTest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cassci.datastax.com/job/trunk_utest/623/testReport/org.apache.cassandra.thrift/MultiSliceTest/&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12715776">CASSANDRA-7279</key>
            <summary>MultiSliceTest.test_with_overlap* unit tests failing in trunk</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="mshuler">Michael Shuler</reporter>
                        <labels>
                            <label>qa-resolved</label>
                    </labels>
                <created>Wed, 21 May 2014 15:37:47 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:44 +0000</updated>
                            <resolved>Wed, 28 May 2014 17:59:42 +0000</resolved>
                                        <fixVersion>2.1 rc1</fixVersion>
                    <fixVersion>2.2.0 beta 1</fixVersion>
                                    <component>Legacy/Testing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14004960" author="mshuler" created="Wed, 21 May 2014 17:29:59 +0000"  >&lt;p&gt;MultiSliceTest was added in commit 60fb923 where it passes.&lt;br/&gt;
&lt;tt&gt;git bisect start trunk 60fb923018a6fd2dabf04a1d4500f7b29a23a6f1&lt;/tt&gt; gets me f31f689 as the first bad commit, which is the merge commit for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6689&quot; title=&quot;Partially Off Heap Memtables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6689&quot;&gt;&lt;del&gt;CASSANDRA-6689&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14005088" author="tjake" created="Wed, 21 May 2014 18:53:22 +0000"  >&lt;p&gt;So this is only failing in trunk not 2.1 branch?&lt;/p&gt;</comment>
                            <comment id="14005106" author="mshuler" created="Wed, 21 May 2014 19:02:33 +0000"  >&lt;p&gt;the test only exists in trunk&lt;/p&gt;</comment>
                            <comment id="14005134" author="benedict" created="Wed, 21 May 2014 19:37:10 +0000"  >&lt;p&gt;This is probably my mess in that case, so I&apos;ll take a look&lt;/p&gt;</comment>
                            <comment id="14005162" author="tjake" created="Wed, 21 May 2014 20:07:57 +0000"  >&lt;p&gt;I&apos;m already debugging... pretty sure this is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5086&quot; title=&quot;MultiSlice bug in SimpleBlockFetcher&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5086&quot;&gt;&lt;del&gt;CASSANDRA-5086&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14005164" author="benedict" created="Wed, 21 May 2014 20:09:27 +0000"  >&lt;p&gt;OK, knock yourself out &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14005266" author="tjake" created="Wed, 21 May 2014 21:34:06 +0000"  >&lt;p&gt;So the issue is the ABSC is blindly adding the overlapping slices so it ends up with dups.  &lt;/p&gt;

&lt;p&gt;We can  fix this by:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;cropping the slices so none of them intersect.&lt;/li&gt;
	&lt;li&gt;changing ABSC.maybeAppendColumn to use addColumn vs addInternal (so it checks the previous value)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I prefer the first but there would be a number of places to change if we did it at the iterator level.  Since this is only exposed in thrift the simplest place would be there.&lt;/p&gt;</comment>
                            <comment id="14005275" author="tjake" created="Wed, 21 May 2014 21:40:45 +0000"  >&lt;p&gt;Actually it can be done in SliceQueryFilter constructor&lt;/p&gt;</comment>
                            <comment id="14005276" author="benedict" created="Wed, 21 May 2014 21:40:51 +0000"  >&lt;p&gt;Do you mean ABTC? Pretty sure ABSC treats it correctly; probably when slicing we should use the max of (previous slice end) and (new slice start) for the bound of the new iterator. I&apos;d kind of like to fix this in a similar way to how we deal with it in ABSC though, although it would be more work (so probably best left until later); in trunk we could use the new SearchIterator (with some small tweaks) to solve the problem by always using the current position as a lower bound for the search for the next lower bound.&lt;/p&gt;</comment>
                            <comment id="14005294" author="tjake" created="Wed, 21 May 2014 21:58:44 +0000"  >&lt;p&gt;Digging into the history of this more.  Origionally Multiple slice ranges didn&apos;t allow overlapping ranges &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3855&quot; title=&quot;RemoveDeleted dominates compaction time for large sstable counts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3855&quot;&gt;&lt;del&gt;CASSANDRA-3855&lt;/del&gt;&lt;/a&gt; but that restriction was removed in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5573&quot; title=&quot;Querying with an empty (impossible) range returns incorrect results&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5573&quot;&gt;&lt;del&gt;CASSANDRA-5573&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

</comment>
                            <comment id="14005304" author="tjake" created="Wed, 21 May 2014 22:09:36 +0000"  >&lt;p&gt;No It&apos;s in ABSC, I think it was broken in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7107&quot; title=&quot;General minor tidying of CollationController path&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7107&quot;&gt;&lt;del&gt;CASSANDRA-7107&lt;/del&gt;&lt;/a&gt; since that stopped using addCell and instead just appends the cell to the array.  I think fixing it in slices so they don&apos;t overlap is the right approach.&lt;/p&gt;</comment>
                            <comment id="14005314" author="benedict" created="Wed, 21 May 2014 22:14:20 +0000"  >&lt;p&gt;Well, there&apos;s lots of places you could consider the bug to be; I meant that ABTC listens to overlapping slices and returns the overlap, whereas ABSC doesn&apos;t, and iirc the on-disk indexed slice iterator also doesn&apos;t, so if ABTC didn&apos;t also we&apos;d be safe again. But fixing it in the Slice def is as good a solution and more permanent in the face of more slice iterator sources. We could even simplify ABSC&apos;s slice iterators in that case as well.&lt;/p&gt;</comment>
                            <comment id="14006346" author="tjake" created="Thu, 22 May 2014 19:11:11 +0000"  >&lt;p&gt;Attached patch to sort and crop overlapping slices.  I also had to change AtomicBtreeColumns to deal with excluding a point when the start of the finish of the previous slice == the start of the next slice &lt;/p&gt;</comment>
                            <comment id="14006397" author="mshuler" created="Thu, 22 May 2014 20:12:45 +0000"  >&lt;p&gt;Applied the patch to trunk and tested out the modified tests (haven&apos;t run a full &apos;ant test&apos;) - MultiSliceTest, QueryPagerTest, RangeTombstoneTest pass, but ColumnFamilyStoreTest failed with:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;test:
     [echo] running unit tests
    [junit] WARNING: multiple versions of ant detected in path for junit 
    [junit]          jar:file:/usr/share/ant/lib/ant.jar!/org/apache/tools/ant/Project.class
    [junit]      and jar:file:/home/mshuler/git/cassandra/build/lib/jars/ant-1.6.5.jar!/org/apache/tools/ant/Project.class
    [junit] Testsuite: org.apache.cassandra.db.ColumnFamilyStoreTest
    [junit] Tests run: 35, Failures: 8, Errors: 0, Skipped: 0, Time elapsed: 17.085 sec
    [junit] 
    [junit] ------------- Standard Output ---------------
    [junit] ERROR 20:07:21 Unable to delete build/test/cassandra/data/Keyspace1/Indexed2-a7e63420e1ec11e3a5c09b2001e5c823/Keyspace1-Indexed2.birthdate_index-ka-1-Data.db (it will be removed on server restart; we&apos;ll also retry after GC)
    [junit] ERROR 20:07:21 Unable to delete build/test/cassandra/data/Keyspace1/Indexed2-a7e63420e1ec11e3a5c09b2001e5c823/Keyspace1-Indexed2.birthdate_index-ka-1-Data.db (it will be removed on server restart; we&apos;ll also retry after GC)
    [junit] ERROR 20:07:23 Missing component: build/test/cassandra/data/Keyspace1/Standard3-a7e60d12e1ec11e3a5c09b2001e5c823/Keyspace1-Standard3-ka-1-Summary.db
    [junit] ERROR 20:07:23 Missing component: build/test/cassandra/data/Keyspace1/Standard3-a7e60d12e1ec11e3a5c09b2001e5c823/Keyspace1-Standard3-ka-1-Summary.db
    [junit] ERROR 20:07:23 Missing component: build/test/cassandra/data/Keyspace1/Standard4-a7e60d13e1ec11e3a5c09b2001e5c823/Keyspace1-Standard4-ka-3-Summary.db
    [junit] ERROR 20:07:23 Missing component: build/test/cassandra/data/Keyspace1/Standard4-a7e60d13e1ec11e3a5c09b2001e5c823/Keyspace1-Standard4-ka-3-Summary.db
    [junit] ------------- ---------------- ---------------
    [junit] Testcase: testMultiRangeSomeEmptyNoIndex(org.apache.cassandra.db.ColumnFamilyStoreTest):    FAILED
    [junit] Columns did not match. Expected: [colI, colD, colC, colA] but got:[]
    [junit] junit.framework.AssertionFailedError: Columns did not match. Expected: [colI, colD, colC, colA] but got:[]
    [junit]     at org.apache.cassandra.db.ColumnFamilyStoreTest.findRowGetSlicesAndAssertColsFound(ColumnFamilyStoreTest.java:2101)
    [junit]     at org.apache.cassandra.db.ColumnFamilyStoreTest.testMultiRangeSomeEmptyNoIndex(ColumnFamilyStoreTest.java:1419)
    [junit] 
    [junit] 
    [junit] Testcase: testMultiRangeSomeEmptyIndexed(org.apache.cassandra.db.ColumnFamilyStoreTest):    FAILED
    [junit] Columns did not match. Expected: [colI, colD, colC, colA] but got:[colD, colC]
    [junit] junit.framework.AssertionFailedError: Columns did not match. Expected: [colI, colD, colC, colA] but got:[colD, colC]
    [junit]     at org.apache.cassandra.db.ColumnFamilyStoreTest.findRowGetSlicesAndAssertColsFound(ColumnFamilyStoreTest.java:2101)
    [junit]     at org.apache.cassandra.db.ColumnFamilyStoreTest.testMultiRangeSomeEmptyIndexed(ColumnFamilyStoreTest.java:1468)
    [junit] 
    [junit] 
    [junit] Testcase: testMultiRangeContiguousNoIndex(org.apache.cassandra.db.ColumnFamilyStoreTest):   FAILED
    [junit] Columns did not match. Expected: [colI, colG, colF, colE, colD, colC, colA] but got:[]
    [junit] junit.framework.AssertionFailedError: Columns did not match. Expected: [colI, colG, colF, colE, colD, colC, colA] but got:[]
    [junit]     at org.apache.cassandra.db.ColumnFamilyStoreTest.findRowGetSlicesAndAssertColsFound(ColumnFamilyStoreTest.java:2101)
    [junit]     at org.apache.cassandra.db.ColumnFamilyStoreTest.testMultiRangeContiguousNoIndex(ColumnFamilyStoreTest.java:1517)
    [junit] 
    [junit] 
    [junit] Testcase: testMultiRangeContiguousIndexed(org.apache.cassandra.db.ColumnFamilyStoreTest):   FAILED
    [junit] Columns did not match. Expected: [colI, colG, colF, colE, colD, colC, colA] but got:[colG, colF, colE, colD, colC]
    [junit] junit.framework.AssertionFailedError: Columns did not match. Expected: [colI, colG, colF, colE, colD, colC, colA] but got:[colG, colF, colE, colD, colC]
    [junit]     at org.apache.cassandra.db.ColumnFamilyStoreTest.findRowGetSlicesAndAssertColsFound(ColumnFamilyStoreTest.java:2101)
    [junit]     at org.apache.cassandra.db.ColumnFamilyStoreTest.testMultiRangeContiguousIndexed(ColumnFamilyStoreTest.java:1567)
    [junit] 
    [junit] 
    [junit] Testcase: testMultiRangeIndexed(org.apache.cassandra.db.ColumnFamilyStoreTest):     FAILED
    [junit] Columns did not match. Expected: [colI, colG, colE, colD, colC, colA] but got:[colG, colE, colD, colC]
    [junit] junit.framework.AssertionFailedError: Columns did not match. Expected: [colI, colG, colE, colD, colC, colA] but got:[colG, colE, colD, colC]
    [junit]     at org.apache.cassandra.db.ColumnFamilyStoreTest.findRowGetSlicesAndAssertColsFound(ColumnFamilyStoreTest.java:2101)
    [junit]     at org.apache.cassandra.db.ColumnFamilyStoreTest.testMultiRangeIndexed(ColumnFamilyStoreTest.java:1628)
    [junit] 
    [junit] 
    [junit] Testcase: testMultipleRangesSlicesNoIndexedColumns(org.apache.cassandra.db.ColumnFamilyStoreTest):  FAILED
    [junit] Columns did not match. Expected: [cola] but got:[]
    [junit] junit.framework.AssertionFailedError: Columns did not match. Expected: [cola] but got:[]
    [junit]     at org.apache.cassandra.db.ColumnFamilyStoreTest.findRowGetSlicesAndAssertColsFound(ColumnFamilyStoreTest.java:2101)
    [junit]     at org.apache.cassandra.db.ColumnFamilyStoreTest.testMultiRangeSlicesBehavior(ColumnFamilyStoreTest.java:1965)
    [junit]     at org.apache.cassandra.db.ColumnFamilyStoreTest.testMultipleRangesSlicesNoIndexedColumns(ColumnFamilyStoreTest.java:1637)
    [junit] 
    [junit] 
    [junit] Testcase: testMultipleRangesSlicesWithIndexedColumns(org.apache.cassandra.db.ColumnFamilyStoreTest):        FAILED
    [junit] Columns did not match. Expected: [cola] but got:[]
    [junit] junit.framework.AssertionFailedError: Columns did not match. Expected: [cola] but got:[]
    [junit]     at org.apache.cassandra.db.ColumnFamilyStoreTest.findRowGetSlicesAndAssertColsFound(ColumnFamilyStoreTest.java:2101)
    [junit]     at org.apache.cassandra.db.ColumnFamilyStoreTest.testMultiRangeSlicesBehavior(ColumnFamilyStoreTest.java:1965)
    [junit]     at org.apache.cassandra.db.ColumnFamilyStoreTest.testMultipleRangesSlicesWithIndexedColumns(ColumnFamilyStoreTest.java:1644)
    [junit] 
    [junit] 
    [junit] Testcase: testMultipleRangesSlicesInMemory(org.apache.cassandra.db.ColumnFamilyStoreTest):  FAILED
    [junit] Columns did not match. Expected: [cola] but got:[]
    [junit] junit.framework.AssertionFailedError: Columns did not match. Expected: [cola] but got:[]
    [junit]     at org.apache.cassandra.db.ColumnFamilyStoreTest.findRowGetSlicesAndAssertColsFound(ColumnFamilyStoreTest.java:2101)
    [junit]     at org.apache.cassandra.db.ColumnFamilyStoreTest.testMultiRangeSlicesBehavior(ColumnFamilyStoreTest.java:1965)
    [junit]     at org.apache.cassandra.db.ColumnFamilyStoreTest.testMultipleRangesSlicesInMemory(ColumnFamilyStoreTest.java:1651)
    [junit] 
    [junit] 
    [junit] Test org.apache.cassandra.db.ColumnFamilyStoreTest FAILED
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I backed the patch out, so HEAD is now at e5ab470, and ColumnFamilyStoreTest passes ok&lt;/p&gt;</comment>
                            <comment id="14006657" author="appodictic" created="Fri, 23 May 2014 00:42:27 +0000"  >&lt;p&gt;Were you just testing this? All the Slices are in one direction but the order should not matter. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;-        req.setColumn_slices(Arrays.asList(columnSliceFrom(&lt;span class=&quot;code-quote&quot;&gt;&quot;e&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;), columnSliceFrom(&lt;span class=&quot;code-quote&quot;&gt;&quot;g&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;d&quot;&lt;/span&gt;)));
+        req.setColumn_slices(Arrays.asList( columnSliceFrom(&lt;span class=&quot;code-quote&quot;&gt;&quot;g&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;d&quot;&lt;/span&gt;), columnSliceFrom(&lt;span class=&quot;code-quote&quot;&gt;&quot;e&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;)));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Good call. This assert was backwards&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void assertColumnNameMatches(List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; expected , List&amp;lt;ColumnOrSuperColumn&amp;gt; actual)
     {
-        Assert.assertEquals(actual+&lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt;+expected +&lt;span class=&quot;code-quote&quot;&gt;&quot; did not have same number of elements&quot;&lt;/span&gt;, actual.size(), expected.size());
+        Assert.assertEquals(actual+&lt;span class=&quot;code-quote&quot;&gt;&quot; &quot;&lt;/span&gt;+expected +&lt;span class=&quot;code-quote&quot;&gt;&quot; did not have same number of elements&quot;&lt;/span&gt;, expected.size(), actual.size());
         &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0 ; i&amp;lt; expected.size() ; i++)
         {
-            Assert.assertEquals(actual.get(i) +&lt;span class=&quot;code-quote&quot;&gt;&quot; did not equal &quot;&lt;/span&gt;+ expected.get(i), 
-                    &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;(actual.get(i).getColumn().getName()), expected.get(i));
+            Assert.assertEquals(actual.get(i) +&lt;span class=&quot;code-quote&quot;&gt;&quot; did not equal &quot;&lt;/span&gt;+ expected.get(i), expected.get(i),
+                    &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;(actual.get(i).getColumn().getName()));
         }
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14006668" author="appodictic" created="Fri, 23 May 2014 00:59:53 +0000"  >&lt;p&gt;I linked two issues I opened up months ago which are also this issue. &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;changing ABSC.maybeAppendColumn to use addColumn vs addInternal (so it checks the previous value)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Not to be critical, but I think ABSC is hard to groc. As an nube without context it is very hard to me understand what it&apos;s purpose is and how it is supposed to behave without more Java doc and direct testing. For a speciality data structure the intent is lost without more documentation. Suggestion: maybe we can beef up the javadoc in the patch?&lt;/p&gt;</comment>
                            <comment id="14006737" author="tjake" created="Fri, 23 May 2014 02:46:16 +0000"  >&lt;p&gt;v2 fixes the ColumnFamilyStoreTests&lt;/p&gt;</comment>
                            <comment id="14006762" author="mshuler" created="Fri, 23 May 2014 03:49:23 +0000"  >&lt;p&gt;v2 looks good to me for the unit tests&lt;/p&gt;</comment>
                            <comment id="14006885" author="appodictic" created="Fri, 23 May 2014 06:25:14 +0000"  >&lt;p&gt;Two questions:&lt;/p&gt;

&lt;p&gt;In removeOverlappingSlices, what is the rational for not doing anything when we have no comparator? Is there ever a time when we do not have a comparator? I would assume no comparator BytesType. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (comparator == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || slices.length &amp;lt;= 1)
+            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; slices;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is a test with bad input:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testBadStuff() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; CharacterCodingException
    {
      ColumnSlice aToE = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ColumnSlice(cellname(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;), cellname(&lt;span class=&quot;code-quote&quot;&gt;&quot;e&quot;&lt;/span&gt;));
      ColumnSlice dToG = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ColumnSlice(cellname(&lt;span class=&quot;code-quote&quot;&gt;&quot;g&quot;&lt;/span&gt;), cellname(&lt;span class=&quot;code-quote&quot;&gt;&quot;d&quot;&lt;/span&gt;));
      CellNameType c = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SimpleDenseCellNameType(UTF8Type.instance);
      ColumnSlice [] result =   SliceQueryFilter.removeOverlappingSlices(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ColumnSlice[]{ dToG, aToE }, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, c );
      Assert.assertEquals(1, result.length);
      Assert.assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;g&quot;&lt;/span&gt;, ByteBufferUtil.string(result[0].start.get(0)));
      Assert.assertEquals(&lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;, ByteBufferUtil.string(result[0].finish.get(0)));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;junit.framework.ComparisonFailure: null expected:&amp;lt;&lt;span class=&quot;error&quot;&gt;&amp;#91;a&amp;#93;&lt;/span&gt;&amp;gt; but was:&amp;lt;&lt;span class=&quot;error&quot;&gt;&amp;#91;d&amp;#93;&lt;/span&gt;&amp;gt;&lt;/p&gt;

&lt;p&gt;Maybe it is redundant checking, but should we explode more violently in these cases? Like the case above is it better to fail hard then return something undefined?&lt;/p&gt;</comment>
                            <comment id="14006906" author="appodictic" created="Fri, 23 May 2014 06:29:59 +0000"  >&lt;p&gt;Patch that adds some direct testing, and a test that returns bad output but maybe should explode?&lt;/p&gt;</comment>
                            <comment id="14006913" author="appodictic" created="Fri, 23 May 2014 06:36:39 +0000"  >&lt;p&gt;I think I found an edge case. Shouldn&apos;t the all slice from &quot;&quot; to &quot;&quot; absorb &quot;d&quot; to &quot;g&quot; ?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;  @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testWithEmpty() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; CharacterCodingException
    {
      ColumnSlice aToE = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ColumnSlice(cellname(&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;), cellname(&quot;&lt;/span&gt;&quot;));
      ColumnSlice dToG = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ColumnSlice(cellname(&lt;span class=&quot;code-quote&quot;&gt;&quot;d&quot;&lt;/span&gt;), cellname(&lt;span class=&quot;code-quote&quot;&gt;&quot;g&quot;&lt;/span&gt;));
      CellNameType c = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SimpleDenseCellNameType(UTF8Type.instance);
      
      ColumnSlice [] result =   SliceQueryFilter.removeOverlappingSlices(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ColumnSlice[]{ aToE, dToG }, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, c );
      Assert.assertEquals(1, result.length);
      Assert.assertEquals(&quot;&quot;, ByteBufferUtil.string(result[0].start.get(0)));
      Assert.assertEquals(&quot;&quot;, ByteBufferUtil.string(result[0].finish.get(0)));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;junit.framework.AssertionFailedError: expected:&amp;lt;1&amp;gt; but was:&amp;lt;2&amp;gt;&lt;/p&gt;
</comment>
                            <comment id="14007140" author="tjake" created="Fri, 23 May 2014 13:12:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;what is the rational for not doing anything when we have no comparator?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is for the case when a replica deserializes the slice over the wire internally (from the coordinators request), It&apos;s redundant to check in this case since the coordinator has already done this check.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Maybe it is redundant checking, but should we explode more violently in these cases?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If you run with -ea you get an assertion error.   &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think I found an edge case. Shouldn&apos;t the all slice from &quot;&quot; to &quot;&quot; absorb &quot;d&quot; to &quot;g&quot; ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;cellname(&quot;&quot;) get&apos;s you another AssertionError.  You should be using Composites.EMPTY with that it does the right thing.  These things are checked on input&lt;/p&gt;</comment>
                            <comment id="14007175" author="appodictic" created="Fri, 23 May 2014 13:57:07 +0000"  >&lt;p&gt;Composite.empty who knew? It does work as expected. Tx.&lt;/p&gt;</comment>
                            <comment id="14007212" author="appodictic" created="Fri, 23 May 2014 15:00:52 +0000"  >&lt;p&gt;Added some light documentation that explains some of the nuances of how the overlapping thing works.&lt;/p&gt;</comment>
                            <comment id="14007236" author="slebresne" created="Fri, 23 May 2014 15:22:53 +0000"  >&lt;p&gt;We&apos;ve always assumed it was the job of whomever built the slices (so mainly the thrift code and the CQL3 code) to de-overlap (and make sure things were in the right order). Wouldn&apos;t it be cleaner to keep it that way, i.e. to push the deoverlapping in places of code that might generate overlapping slices (which part of the code is doing that btw?), rather that pass the comparator every time but having it null half of the time?&lt;/p&gt;</comment>
                            <comment id="14007245" author="tjake" created="Fri, 23 May 2014 15:29:47 +0000"  >&lt;p&gt;Given the fact that it used to be validated but was subsequently removed in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5573&quot; title=&quot;Querying with an empty (impossible) range returns incorrect results&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5573&quot;&gt;&lt;del&gt;CASSANDRA-5573&lt;/del&gt;&lt;/a&gt; I think it needs to be centralized here to keep things simple.  We can move the pre-processing to a different location vs the constructor but I don&apos;t see an issue with keeping it as is.&lt;/p&gt;</comment>
                            <comment id="14007249" author="slebresne" created="Fri, 23 May 2014 15:33:30 +0000"  >&lt;blockquote&gt;&lt;p&gt;Given the fact that it used to be validated but was subsequently removed in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5573&quot; title=&quot;Querying with an empty (impossible) range returns incorrect results&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5573&quot;&gt;&lt;del&gt;CASSANDRA-5573&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Could you expand on what exactly in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5573&quot; title=&quot;Querying with an empty (impossible) range returns incorrect results&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5573&quot;&gt;&lt;del&gt;CASSANDRA-5573&lt;/del&gt;&lt;/a&gt; removed a previous validation of this? I&apos;m not totally sure I follow.&lt;/p&gt;</comment>
                            <comment id="14007258" author="tjake" created="Fri, 23 May 2014 15:42:08 +0000"  >
&lt;p&gt;from that commit:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;you can kill both ColumnSlice.validate() overloads (only used by QP.validateSLiceFilter) altogether if you ditch QueryProcessor.validateSliceFilter() (unused).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We used to not allow overlapping ranges but, 5573 removed that restriction.  Ed&apos;s tests exposed that it wasn&apos;t properly handled.  &lt;/p&gt;</comment>
                            <comment id="14007282" author="slebresne" created="Fri, 23 May 2014 15:56:29 +0000"  >&lt;p&gt;But wait. What I&apos;m saying is that the CQL3 code never generate overlapping ranges. If it does, it&apos;s a bug that needs to be fixed but that I&apos;m not aware of.&lt;/p&gt;

&lt;p&gt;So that this call to removeOverlappingSlices is doing work that, at least for CQL3, is wasting good cpu cycles. If we&apos;re freaked out that the CQL3 might create overlapping slices by mistake in the future, I guess I&apos;m not opposed to re-adding validation of the slices (preferably in an assert), but validating the slices is much simpler than what removeOverlappingSlices does (it doesn&apos;t have to allocate a Comparator object or sort an array that is already sorted).&lt;/p&gt;

&lt;p&gt;And if thrift is the only place that accepts overlapping slices and does de-ovelapping silently, then it&apos;s only there that we should deoverlap.&lt;/p&gt;</comment>
                            <comment id="14007296" author="appodictic" created="Fri, 23 May 2014 16:09:40 +0000"  >&lt;blockquote&gt;
&lt;p&gt;But wait. What I&apos;m saying is that the CQL3 code never generate overlapping ranges. If it does, it&apos;s a bug that needs to be fixed but that I&apos;m not aware of.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Does any CQL code generate multiple ranges at all? It could be a bug not yet hit by CQL because it is unable to leverage this feature at the current moment but in the near future might?&lt;/p&gt;</comment>
                            <comment id="14007305" author="tjake" created="Fri, 23 May 2014 16:16:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4762&quot; title=&quot;Support IN clause for any clustering column&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4762&quot;&gt;&lt;del&gt;CASSANDRA-4762&lt;/del&gt;&lt;/a&gt; would add this to cql. Is the CPU cost really that high here? It&apos;s only run once per query&lt;/p&gt;</comment>
                            <comment id="14007317" author="appodictic" created="Fri, 23 May 2014 16:27:37 +0000"  >&lt;p&gt;Solve the problem in one place. For CQL the code path is skipped in all cases currently. When 4762 is added we talking about sorting a list of a few slices when the feature is active.  &lt;/p&gt;

&lt;p&gt;I like where Jake has it. Put the logic closer to the storage engine, do not count multiple components thrift/cql to have to do this separately. As this ticket shows it is easy to miss the bug under the assumption that something understands some implicit contract.&lt;/p&gt;</comment>
                            <comment id="14007326" author="slebresne" created="Fri, 23 May 2014 16:33:10 +0000"  >&lt;blockquote&gt;&lt;p&gt;Does any CQL code generate multiple ranges at all?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes it does.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4762&quot; title=&quot;Support IN clause for any clustering column&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4762&quot;&gt;&lt;del&gt;CASSANDRA-4762&lt;/del&gt;&lt;/a&gt; would add this to cql&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m pretty sure &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4762&quot; title=&quot;Support IN clause for any clustering column&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4762&quot;&gt;&lt;del&gt;CASSANDRA-4762&lt;/del&gt;&lt;/a&gt; can be done so that slices are generated non-overlapping by construction. And if it turns out that it&apos;s really much more convenient to generate overlapping slices and de-overlap after the fact, then fine, we can call the deoverlapping code then. But that&apos;s still not a reason to call it everytime when there is many cases where we know it&apos;s useless.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Is the CPU cost really that high here? It&apos;s only run once per query&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;But if it&apos;s useless, it&apos;s kind of too costly, isn&apos;t it ? What is the downsides of doing the de-overlapping only when we need to and just adding a check in an assertion otherwise? I doubt it&apos;ll be much more code if any. I&apos;m fine providing a patch doing that if it&apos;s just a matter of &quot;you&apos;d rather not spend more time on this&quot; (which I respect).&lt;/p&gt;</comment>
                            <comment id="14007349" author="appodictic" created="Fri, 23 May 2014 16:48:57 +0000"  >&lt;p&gt;I do not want to bikeshed over performance of implementation. I only care that it works, produces the same result across versions, and coverage is in place so that it continues working. &lt;/p&gt;</comment>
                            <comment id="14007672" author="tjake" created="Fri, 23 May 2014 20:38:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;What is the downsides of doing the de-overlapping only when we need to and just adding a check in an assertion otherwise?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;How do you know &quot;when you need to&quot;?  You  only need to check this when there are more than one slice is passed in.  This de-overlapping only happens if &amp;gt; 1 slice is passed in.  If you have something clever in mind then feel free to code it up.  In the end I thing the amount of cpu time will be the same.&lt;/p&gt;</comment>
                            <comment id="14007865" author="appodictic" created="Fri, 23 May 2014 23:24:31 +0000"  >&lt;p&gt;Also take into account that the normal case is a user would likely send 2-3 slices, in order, without overlaps. Not sure of the sorting algo but in that case it might not be many passes through the list.&lt;/p&gt;</comment>
                            <comment id="14007881" author="appodictic" created="Fri, 23 May 2014 23:34:46 +0000"  >&lt;p&gt;One other thing. cassandra.server has a similiar notion of a ColumnSlice so we should be able to transport this logic to thrift nd let cql handle this differently. &lt;/p&gt;

&lt;p&gt;Though it feels lile in the future cql could benefit from storage layer de duping like selecting parts of collections that may have overlaps or something.&lt;/p&gt;
</comment>
                            <comment id="14008398" author="appodictic" created="Sun, 25 May 2014 18:32:25 +0000"  >&lt;p&gt;The problem as I see it, is the bulk of the testing was in ColumnFamilyStoreTest, so the other collaborating components are not clear with pre/post conditions. Since none of the collaborators are defined as who handles the de duplication it is a very open ended discussion. Review this table:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Component&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Accepts overlaping ranges?&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Action&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Cassandra.Server multiSliceRequest&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Yes&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Blindly pass Along&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;SliceQueryFilter (with Jake&apos;s Patch)&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Yes&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Deduplicate and de-overlap&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;ColumnFamilyStore&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Yes&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Never receives an overlapped slice &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Suggestion. Construct a similar table for the new current and/or new CQL paths. Use that determine where the overlapping check should be. Go back and define in each piece of the API what they do and do not accept.&lt;/p&gt;



</comment>
                            <comment id="14008739" author="slebresne" created="Mon, 26 May 2014 10:50:59 +0000"  >&lt;p&gt;Attaching a patch for how I would do this. It only deoverlap/sort slices for thrift, but does validate (in an assertion) the slices for CQL &quot;to avoid whatever future bug everyone seems to assume we&apos;ll introduce&quot;. I&apos;ll note that said validation is more thorough than what the de-overlapping method would protect against since it validates that each slices in the proper order (while the de-overlapping method would have silently do the wrong thing in that case, potentially hiding a bug deeper rather than protecting against one).&lt;/p&gt;

&lt;p&gt;The patch also fix 2 bugs in the handling of the empty finish bounds by the de-overlapping function: 1) in the initial sorting, it is the finish bound that should be special cased, the start bound is automatically handled by the comparator, and 2) later the finish bound also needs special casing when testing for inclusion. Both are covered by additional unit tests. &lt;/p&gt;</comment>
                            <comment id="14008842" author="benedict" created="Mon, 26 May 2014 13:44:42 +0000"  >&lt;p&gt;I&apos;d be comfortable with just asserting (always, regardless of if assertions are enabled) on the thrift path to keep the patch simple. Multi slices are a new thing to thrift world, so constraining them sensibly (to inputs we don&apos;t have to massage to make sense) seems reasonable to me. The only possible point of contention would be two ranges with equal end/starts, which we would reject but which are easy to understand what should be meant. I don&apos;t think they&apos;re a severe casualty though.&lt;/p&gt;

&lt;p&gt;It&apos;d be nice to take the opportunity to simultaneously clean up the ABSC code to no longer enforce this assumption while we&apos;re imposing it elsewhere.&lt;/p&gt;

&lt;p&gt;Also, there&apos;s at least one spot where the constructor can be called that isn&apos;t covered by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;&apos;s patch, so I&apos;d suggest either moving the assert into the constructor, or creating a static method for construction that requires stipulating if the assert is always enforced (thrift), or only if assertions are enabled. I&apos;m a little concerned that we can easily introduce new code paths that use them incorrectly but that won&apos;t be covered by any assertions as it stands.&lt;/p&gt;</comment>
                            <comment id="14008853" author="slebresne" created="Mon, 26 May 2014 13:55:09 +0000"  >&lt;blockquote&gt;&lt;p&gt;there&apos;s at least one spot where the constructor can be called that isn&apos;t covered by Sylvain Lebresne&apos;s patch&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There is more than one, but the spots I didn&apos;t add the assertion to where the ones where it was easy to verify that things were ok by construction. But I&apos;m fine putting the assertion everywhere is we&apos;re really all that freaked out by bug there though (it just happen I don&apos;t share that fear). &lt;/p&gt;</comment>
                            <comment id="14008918" author="appodictic" created="Mon, 26 May 2014 15:23:00 +0000"  >&lt;p&gt;Looks good.&lt;/p&gt;

&lt;p&gt;The actual result is still different from the original result, but this a result of merging the slices pre-count.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;setCount(6)
....
       req.setColumn_slices(Arrays.asList(columnSliceFrom(&lt;span class=&quot;code-quote&quot;&gt;&quot;e&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;), columnSliceFrom(&lt;span class=&quot;code-quote&quot;&gt;&quot;g&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;d&quot;&lt;/span&gt;)));
-        assertColumnNameMatches(Arrays.asList(&lt;span class=&quot;code-quote&quot;&gt;&quot;g&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;e&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;d&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;c&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;), server.get_multi_slice(req)); 
+        assertColumnNameMatches(Arrays.asList(&lt;span class=&quot;code-quote&quot;&gt;&quot;g&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;f&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;e&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;d&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;c&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;b&quot;&lt;/span&gt;), server.get_multi_slice(req));
     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Even though in some cases we just changed the test to match the results. The code written does make more sense in the long run.&lt;/p&gt;</comment>
                            <comment id="14008927" author="benedict" created="Mon, 26 May 2014 15:53:15 +0000"  >&lt;p&gt;I&apos;m neutral on the asserts, but if we&apos;re adding them I think we should be consistent, especially as they should be computationally cheap even with them enabled (and free when disabled). The CQL3CasConditions didn&apos;t look (at-a-glance-)trivial to me that it would definitely produce safe slices. &lt;/p&gt;</comment>
                            <comment id="14009704" author="tjake" created="Tue, 27 May 2014 14:21:36 +0000"  >&lt;p&gt;Ok +1 I&apos;ll backport this to 2.1 then commit. Thanks.&lt;/p&gt;</comment>
                            <comment id="14009802" author="slebresne" created="Tue, 27 May 2014 15:33:23 +0000"  >&lt;blockquote&gt;&lt;p&gt;The CQL3CasConditions didn&apos;t look (at-a-glance-)trivial to me that it would definitely produce safe slices.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s creating the slices by using the &lt;tt&gt;slice()&lt;/tt&gt; method on composites coming from a map sorted by the comparator. But I&apos;m happy with adding the assertion there (I suppose Jake can just chime that in his backport).&lt;/p&gt;</comment>
                            <comment id="14009814" author="tjake" created="Tue, 27 May 2014 15:40:37 +0000"  >&lt;p&gt;Looks like some tests in org.apache.cassandra.cql3.MultiColumnRelationTest started failing due to assertion check&lt;/p&gt;</comment>
                            <comment id="14011205" author="slebresne" created="Wed, 28 May 2014 15:32:36 +0000"  >&lt;p&gt;The problem (with MultiColumnRelationTest) is that the check in ColumnSlice is assuming that an empty value will still sort as a lower bound even for a reverse comparator as this is what has always been done by &lt;tt&gt;AbstractType.reverseComparator&lt;/tt&gt;. However, somehow, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5417&quot; title=&quot;Push composites support in the storage engine&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5417&quot;&gt;&lt;del&gt;CASSANDRA-5417&lt;/del&gt;&lt;/a&gt; didn&apos;t seem to have carried that over to &lt;tt&gt;AbstractCType.reverseComparator()&lt;/tt&gt;. So anyway, attaching a v2 that simply add &quot;proper&quot; handling of empty to &lt;tt&gt;AbstractCType.reverseComparator()&lt;/tt&gt;. As far as I can tell that breaks no other tests. Note that this part won&apos;t be needed in 2.0 backport since &lt;tt&gt;AbstracType&lt;/tt&gt; does the right thing there.&lt;/p&gt;

&lt;p&gt;v2 also adds the assert in CQL3CasConditions while at it.&lt;/p&gt;</comment>
                            <comment id="14011394" author="tjake" created="Wed, 28 May 2014 18:00:58 +0000"  >&lt;p&gt;Committed thanks&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12708092">CASSANDRA-7027</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12712572">CASSANDRA-7174</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12646370" name="7279-trunk.txt" size="31058" author="tjake" created="Thu, 22 May 2014 19:42:41 +0000"/>
                            <attachment id="12646437" name="7279-trunkv2.txt" size="31251" author="tjake" created="Fri, 23 May 2014 02:46:16 +0000"/>
                            <attachment id="12646462" name="7279-trunkv3.txt" size="35424" author="appodictic" created="Fri, 23 May 2014 06:29:59 +0000"/>
                            <attachment id="12646521" name="7279-trunkv4.txt" size="31862" author="appodictic" created="Fri, 23 May 2014 15:00:52 +0000"/>
                            <attachment id="12647146" name="7279_alternative-v2.txt" size="17090" author="slebresne" created="Wed, 28 May 2014 15:32:36 +0000"/>
                            <attachment id="12646772" name="7279_alternative.txt" size="15461" author="slebresne" created="Mon, 26 May 2014 10:50:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>394061</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 25 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1vumn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>394200</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>tjake</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[tjake]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311124" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Tester</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>mshuler</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>