<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:13:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-1179] split commitlog into header + mutations files</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-1179</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;As mentioned in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1119&quot; title=&quot;detect incomplete commitlogheader&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1119&quot;&gt;&lt;del&gt;CASSANDRA-1119&lt;/del&gt;&lt;/a&gt;, it seems possible that a commitlog header could be corrupted by a power loss during update of the header, post-flush.  We could try to make it more robust (by writing the size of the commitlogheader first, and skipping to the end if we encounter corruption) but it seems to me that the most foolproof method would be to split the log into two files: the header, which we&apos;ll overwrite, and the data, which is truly append only.  If If the header is corrupt on reply, we just reply the data from the beginning; the header allows us to avoid replaying data redundantly, but it&apos;s strictly an optimization and not required for correctness.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12466697">CASSANDRA-1179</key>
            <summary>split commitlog into header + mutations files</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mdennis">Matthew F. Dennis</assignee>
                                    <reporter username="jbellis">Jonathan Ellis</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Jun 2010 23:02:11 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:22 +0000</updated>
                            <resolved>Sat, 19 Jun 2010 16:09:57 +0000</resolved>
                                        <fixVersion>0.7 beta 1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12879117" author="jbellis" created="Tue, 15 Jun 2010 21:06:14 +0000"  >&lt;p&gt;made some minor changes, primarily using BRAF in writeCommitLogHeader (you don&apos;t get buffering w/ raw FileOutputStream, and BRAF is simpler than doing the FOS/BufferedOutputStream/FileChannel dance).  also added RecoveryManager3Test to test the .header missing entirely.&lt;/p&gt;

&lt;p&gt;todo: still needs to delete the .headers after a successful replay as well as the .log.&lt;/p&gt;

&lt;p&gt;more severe: after running &quot;bin/cassandra -f&quot; and C-c-ing several times in a row, I get&lt;/p&gt;

&lt;p&gt;ERROR 16:02:14,537 Exception encountered during startup.&lt;br/&gt;
java.lang.ArrayIndexOutOfBoundsException&lt;br/&gt;
	at java.lang.System.arraycopy(Native Method)&lt;br/&gt;
	at org.apache.cassandra.io.util.BufferedRandomAccessFile.read(BufferedRandomAccessFile.java:332)&lt;br/&gt;
	at java.io.RandomAccessFile.readFully(RandomAccessFile.java:381)&lt;br/&gt;
	at java.io.RandomAccessFile.readFully(RandomAccessFile.java:361)&lt;br/&gt;
	at org.apache.cassandra.db.commitlog.CommitLog.recover(CommitLog.java:213)&lt;br/&gt;
	at org.apache.cassandra.db.commitlog.CommitLog.recover(CommitLog.java:172)&lt;br/&gt;
	at org.apache.cassandra.thrift.CassandraDaemon.setup(CassandraDaemon.java:120)&lt;br/&gt;
	at org.apache.cassandra.service.AbstractCassandraDaemon.activate(AbstractCassandraDaemon.java:90)&lt;br/&gt;
	at org.apache.cassandra.thrift.CassandraDaemon.main(CassandraDaemon.java:221)&lt;/p&gt;

&lt;p&gt;(This looks like BRAF is throwing AIOOBE when it should really be EOFException)&lt;/p&gt;</comment>
                            <comment id="12879122" author="jbellis" created="Tue, 15 Jun 2010 21:15:51 +0000"  >&lt;p&gt;(fixed trying to be to clever w/ metadata fsync &amp;#8211; we actually do need to include that the first time we write the file)&lt;/p&gt;</comment>
                            <comment id="12879162" author="mdennis" created="Tue, 15 Jun 2010 22:55:14 +0000"  >&lt;p&gt;trunk-1179-v3.txt deletes header files after successful replay, handle short entries and garbage size writes&lt;/p&gt;</comment>
                            <comment id="12879196" author="mdennis" created="Wed, 16 Jun 2010 00:04:21 +0000"  >&lt;p&gt;need to add a test for the corrupted / partially flushed segment&lt;/p&gt;</comment>
                            <comment id="12879227" author="jbellis" created="Wed, 16 Jun 2010 01:54:01 +0000"  >&lt;p&gt;I&apos;d rather fix BRAF to generate correct EOFExceptions in case other code runs into this.  (And by removing the EOFException check, we introduce a new bug that if the size int is incomplete, we die again.)&lt;/p&gt;</comment>
                            <comment id="12879229" author="jbellis" created="Wed, 16 Jun 2010 02:01:53 +0000"  >&lt;p&gt;(actually BRAF.read should be returning -1, so that RAF.readFully throws EOFException)&lt;/p&gt;</comment>
                            <comment id="12879467" author="mdennis" created="Wed, 16 Jun 2010 19:19:03 +0000"  >&lt;blockquote&gt;
&lt;p&gt;made some minor changes, primarily using BRAF in writeCommitLogHeader (you don&apos;t get buffering w/ raw FileOutputStream, and BRAF is simpler than doing the FOS/BufferedOutputStream/FileChannel dance).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;FOS doesn&apos;t sync on flush/close and as headers are &quot;optional&quot; now there is no reason to waste the IO.  Just to be sure I was remembering this correctly, I just now tested it.  It provides 80+% improvement over BRAF, even more on a heavily loaded system.  This was clearly a failure on my part to document it at as such.  The header is so small (56 bytes I think) the OS will cache it just fine and not using buffered output will avoid both the memcopies and GC from the buffers.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;todo: still needs to delete the .headers after a successful replay as well as the .log.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;thank you, I hadn&apos;t realized there were two places the logs were getting removed.  Done.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;I&apos;d rather fix BRAF to generate correct EOFExceptions in case other code runs into this. (And by removing the EOFException check, we introduce a new bug that if the size int is incomplete, we die again.)&lt;/p&gt;

&lt;p&gt;(actually BRAF.read should be returning -1, so that RAF.readFully throws EOFException) &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It was not at EOF, the buffer the data was supposed to be written into was zero length.  There was data in the file, but no where to write it in the buffer (because the size read was 0, new byte&lt;span class=&quot;error&quot;&gt;&amp;#91;size&amp;#93;&lt;/span&gt; resulted in a zero length array was was then supposed to be filled by BRAF.readFully).&lt;/p&gt;

&lt;p&gt;I&apos;ve added tests to catch this problem (as well as other related ones) and also changed BRAF to throw a more reasonable exception (but not EOF).  I believe BRAF.readFully will already throw EOF if it is at the end of the file.&lt;/p&gt;

&lt;p&gt;The size of the log entry is now CRCed on it&apos;s own.  Whlie testing with random garbage at the end of a commit log, I had written a really large int to the size field which resulted in recover() trying to allocate a massive byte[] and getting OOM.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;by removing the EOFException check, we introduce a new bug that if the size int is incomplete, we die again.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;good catch.  I have no idea WTF I was thinking, there was even a comment that warned about it that got removed when the try/catch was removed.  I was probably trying to test something and removed it so it&apos;d spew but forgot to put it back.&lt;/p&gt;</comment>
                            <comment id="12880506" author="jbellis" created="Sat, 19 Jun 2010 16:09:57 +0000"  >&lt;p&gt;committed, minus the BRAF change&lt;/p&gt;</comment>
                            <comment id="12880625" author="hudson" created="Sun, 20 Jun 2010 12:47:27 +0000"  >&lt;p&gt;Integrated in Cassandra #471 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Cassandra/471/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hudson.zones.apache.org/hudson/job/Cassandra/471/&lt;/a&gt;)&lt;br/&gt;
    split commitlog header into separate file and add size checksum to mutations.  patch by mdennis and jbellis for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1179&quot; title=&quot;split commitlog into header + mutations files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1179&quot;&gt;&lt;del&gt;CASSANDRA-1179&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12447172" name="1179-v2.txt" size="22569" author="jbellis" created="Tue, 15 Jun 2010 21:15:04 +0000"/>
                            <attachment id="12447181" name="trunk-1179-v3.txt" size="23464" author="mdennis" created="Tue, 15 Jun 2010 22:55:14 +0000"/>
                            <attachment id="12447266" name="trunk-1179-v4.txt" size="30015" author="mdennis" created="Wed, 16 Jun 2010 19:19:03 +0000"/>
                            <attachment id="12447163" name="trunk-1179.txt" size="15824" author="mdennis" created="Tue, 15 Jun 2010 19:17:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[mdennis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20023</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 23 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0g3hb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>91994</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>