<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:11:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-445] commitlog may consider writes flushed, that are not yet</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-445</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Jun Rao explains:&lt;/p&gt;

&lt;p&gt;Suppose there are 3 updates u1, u2, and u3. They are written to commit log in that order. If u1 and u3 are applied to memtable first and at that point, a flush is triggered. After the flush completes, it will move the commit log restarting position based on the log for u3. However, u2 hasn&apos;t been persisted on disk yet. This means that if the node dies now, the recovery logic won&apos;t replay u2 from the log.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12435716">CASSANDRA-445</key>
            <summary>commitlog may consider writes flushed, that are not yet</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="junrao">Jun Rao</assignee>
                                    <reporter username="jbellis">Jonathan Ellis</reporter>
                        <labels>
                    </labels>
                <created>Tue, 15 Sep 2009 14:39:42 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:33 +0000</updated>
                            <resolved>Fri, 18 Sep 2009 03:21:55 +0000</resolved>
                                        <fixVersion>0.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12755511" author="jbellis" created="Tue, 15 Sep 2009 14:43:51 +0000"  >&lt;p&gt;One solution would be to have a map&amp;lt;thread, int&amp;gt; of most-recent commitlog writes per columnfamily.  Then we could use the lowest most-recent-write on flush.  Weak referenced keys would keep threads that don&apos;t exist anymore from causing trouble.&lt;/p&gt;

&lt;p&gt;Dare I ask what does hbase does?&lt;/p&gt;</comment>
                            <comment id="12755781" author="junrao" created="Tue, 15 Sep 2009 23:03:00 +0000"  >&lt;p&gt;hbase actually behaves correctly. Here is the logic. Every update first grabs a read lock, then gets a log sequence num (increasing) and appends to log, and finally updates memtable and releases the read lock. The flusher first grabs a write lock, then gets the next LSN (used as the starting position for log reply), starts the flush and releases the write lock. So, the flusher waits until all outstanding writes to memtable complete and prevents new writes while initiating a flush. Updates to memtable are not necessarily in LSN order though.&lt;/p&gt;</comment>
                            <comment id="12755848" author="jbellis" created="Wed, 16 Sep 2009 02:31:08 +0000"  >&lt;p&gt;Thanks for looking into that.  Using a rwlock is definitely the easiest way to enforce a &quot;wait for everyone to finish writing before flushing&quot; policy.&lt;/p&gt;</comment>
                            <comment id="12756098" author="junrao" created="Wed, 16 Sep 2009 16:25:32 +0000"  >&lt;p&gt;Submit a quick patch. Use the approach in hbase to drain updaters before flushing. If this looks good, we can polish the code a bit more. For example, CFS.apply() no longer needs commitLogContext.&lt;/p&gt;</comment>
                            <comment id="12756303" author="junrao" created="Thu, 17 Sep 2009 00:54:11 +0000"  >&lt;p&gt;Did a quick performance test : inserting 1milllion single-column keys to a 1-node cassandra (key + value &amp;lt; 20 bytes), with 8 client threads, on an 8-core machine.&lt;/p&gt;

&lt;p&gt;with patch&lt;br/&gt;
run1: 2m28s&lt;br/&gt;
run2: 2m36s&lt;/p&gt;

&lt;p&gt;w/o patch&lt;br/&gt;
run1: 2m29s&lt;br/&gt;
run2: 2m32s&lt;/p&gt;

&lt;p&gt;There is hardly any performance difference.&lt;/p&gt;</comment>
                            <comment id="12756620" author="jbellis" created="Thu, 17 Sep 2009 16:46:40 +0000"  >&lt;p&gt;I think this approach will work, so +1.&lt;/p&gt;

&lt;p&gt;Two comments:&lt;/p&gt;

&lt;p&gt;1)&lt;br/&gt;
            memtable_.put(key, columnFamily);&lt;/p&gt;

&lt;p&gt;should change to&lt;/p&gt;

&lt;p&gt;            initialMemtable.put(key, columnFamily);&lt;/p&gt;

&lt;p&gt;to emphasize that apply always puts it into the memtable that was live at the start of the call, and the switch is now done by Table.&lt;/p&gt;

&lt;p&gt;2)&lt;br/&gt;
there seems to be a high degree of overlap between memtableLock_ and flusherLock_ &amp;#8211; both are serializing access to a flush-related activity (that is, post-&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-444&quot; title=&quot;improve throughput for normal inserts on many-core systems&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-444&quot;&gt;&lt;del&gt;CASSANDRA-444&lt;/del&gt;&lt;/a&gt;).  I think memtableLock could be removed now with a little work.&lt;/p&gt;</comment>
                            <comment id="12756751" author="junrao" created="Thu, 17 Sep 2009 20:16:15 +0000"  >&lt;p&gt;Attach v2.&lt;br/&gt;
1. make flusherlock static to guard updates on all tables.&lt;br/&gt;
2. fix periodic flushers&lt;br/&gt;
3. force a sync on header updates to log files (called on flush)&lt;/p&gt;

&lt;p&gt;Performance didn&apos;t change in the same test above.&lt;/p&gt;</comment>
                            <comment id="12756895" author="jbellis" created="Fri, 18 Sep 2009 01:23:32 +0000"  >&lt;p&gt;+1, but i think we&apos;ll still need some cleanup of memtableLock post-444&lt;/p&gt;</comment>
                            <comment id="12756939" author="junrao" created="Fri, 18 Sep 2009 03:21:41 +0000"  >&lt;p&gt;committed to trunk.&lt;/p&gt;</comment>
                            <comment id="12757146" author="hudson" created="Fri, 18 Sep 2009 13:03:42 +0000"  >&lt;p&gt;Integrated in Cassandra #201 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Cassandra/201/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hudson.zones.apache.org/hudson/job/Cassandra/201/&lt;/a&gt;)&lt;br/&gt;
    commitlog may consider writes flushed, that are not yet; patched by junrao; reviewed by jbellis for &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12419789" name="issue445.patchv1" size="4241" author="junrao" created="Wed, 16 Sep 2009 16:25:32 +0000"/>
                            <attachment id="12419925" name="issue445.patchv2" size="7205" author="junrao" created="Thu, 17 Sep 2009 20:16:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[junrao]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19691</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 10 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0fyz3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>91264</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>