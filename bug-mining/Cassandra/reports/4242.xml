<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:02:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11502] Fix denseness and column metadata updates coming from Thrift</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11502</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;It was &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7744?focusedCommentId=14095472&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14095472&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;decided&lt;/a&gt; that we&apos;d be recalculating &lt;tt&gt;is_dense&lt;/tt&gt; for table updates coming from Thrift on every change. However, due to some oversight, &lt;tt&gt;is_dense&lt;/tt&gt; can only go from &lt;tt&gt;false&lt;/tt&gt; to &lt;tt&gt;true&lt;/tt&gt;. Once dense, even adding a &lt;tt&gt;REGULAR&lt;/tt&gt; column will not reset &lt;tt&gt;is_dense&lt;/tt&gt; back to &lt;tt&gt;false&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The recalculation fails because no matter what happens, we never remove the auto-generated &lt;tt&gt;CLUSTERING&lt;/tt&gt; and &lt;tt&gt;COMPACT_VALUE&lt;/tt&gt; columns of a dense table.&lt;/p&gt;

&lt;p&gt;Which ultimately leads to the issue on 2.2 to 3.0 upgrade (see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11315&quot; title=&quot;Fix upgrading sparse tables that are incorrectly marked as dense&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11315&quot;&gt;&lt;del&gt;CASSANDRA-11315&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;What we should do is remove the special-case for Thrift in &lt;tt&gt;LegacySchemaTables::makeUpdateTableMutation&lt;/tt&gt; and correct the logic in &lt;tt&gt;ThriftConversion::internalFromThrift&lt;/tt&gt; to remove those columns when going from dense to sparse.&lt;/p&gt;

&lt;p&gt;This is not enough to fix &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11315&quot; title=&quot;Fix upgrading sparse tables that are incorrectly marked as dense&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11315&quot;&gt;&lt;del&gt;CASSANDRA-11315&lt;/del&gt;&lt;/a&gt;, however, as we need to handle pre-patch upgrades, and upgrades from 2.1. Fixing it in 2.2 means a) getting proper schema from &lt;tt&gt;DESCRIBE&lt;/tt&gt; now and b) using the more efficient &lt;tt&gt;SparseCellNameType&lt;/tt&gt; when you add columns.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12956207">CASSANDRA-11502</key>
            <summary>Fix denseness and column metadata updates coming from Thrift</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aleksey">Aleksey Yeschenko</assignee>
                                    <reporter username="aleksey">Aleksey Yeschenko</reporter>
                        <labels>
                    </labels>
                <created>Tue, 5 Apr 2016 16:45:27 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:37 +0000</updated>
                            <resolved>Wed, 27 Apr 2016 17:01:35 +0000</resolved>
                                        <fixVersion>2.2.7</fixVersion>
                    <fixVersion>3.0.6</fixVersion>
                    <fixVersion>3.6</fixVersion>
                                    <component>Legacy/Distributed Metadata</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15230525" author="iamaleksey" created="Thu, 7 Apr 2016 16:36:45 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;testall&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/iamaleksey/cassandra/tree/11502-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;11502-2.2&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/iamaleksey/job/iamaleksey-11502-2.2-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/iamaleksey/job/iamaleksey-11502-2.2-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/iamaleksey/cassandra/tree/11502-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;11502-3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/iamaleksey/job/iamaleksey-11502-3.0-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/iamaleksey/job/iamaleksey-11502-3.0-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;2.2 version makes sure we recalculate and remove redundant column. 3.0 versions preserves denseness, but cleans up unnecessary Thrift special casing from &lt;tt&gt;SchemaKeyspace::makeUpdateTableMutation&lt;/tt&gt;. It&apos;s unnecessary because despite Thrift not knowing about non regular/static columns, &lt;tt&gt;ThriftConversion::internalFromThrift&lt;/tt&gt; will include them from the current CFM, so we are not going to lose anything.&lt;/p&gt;</comment>
                            <comment id="15258085" author="slebresne" created="Tue, 26 Apr 2016 13:28:24 +0000"  >&lt;p&gt;Mostly looks good with the following remarks:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Regarding the cleanup of &lt;tt&gt;SchemaKeyspace::makeUpdateTableMutation&lt;/tt&gt; (in both 2.2 and 3.0), I follow the reasoning and I&apos;m relatively sure you&apos;re right, but was that breaking anything? I mention this because those schema upgrade and thrift stuffs are easily subtle and are unfortunately not very well covered by tests, so while this does look an ok removal, I&apos;d hate to introduce some subtle upgrade bug just to remove a few lines of code that will go away in 4.0. Anyway, I&apos;m not opposing the removal per-se, but just mentioning that if it was completely up to me, I&apos;d probably leave them in out of (probably unreasonably extreme) caution.&lt;/li&gt;
	&lt;li&gt;I believe the removal of &lt;tt&gt;CLUSTERING_COLUMN&lt;/tt&gt; when sparse table could screw up some CQL tables. Now, I agree that if someone modifies a CQL table from thrift he is obviously looking for trouble, but it shouldn&apos;t be too hard to avoid the problem by only excluding the column based on its &lt;tt&gt;position()&lt;/tt&gt; (only if it correspond to the last componenent of the comparator, if that comparator is composite). Besides, the patch modify the code to preserve &lt;tt&gt;STATIC&lt;/tt&gt; column, which should only ever matters for CQL table so it sounds like you do care about that case &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15258318" author="iamaleksey" created="Tue, 26 Apr 2016 15:52:11 +0000"  >&lt;p&gt;Re 1: If you leave it alone, then &lt;tt&gt;is_dense&lt;/tt&gt; will forever be stuck at true and never recomputed. This is breaking upgrading to 3.0 (now, we&apos;ll still need to address this in 3.0, for users upgrading from C* that don&apos;t have this patch in, but that&apos;s what &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11315&quot; title=&quot;Fix upgrading sparse tables that are incorrectly marked as dense&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11315&quot;&gt;&lt;del&gt;CASSANDRA-11315&lt;/del&gt;&lt;/a&gt; is for). Now, I 100% get the caution, but I, instead, feel more paranoid about leaving it in - having the logic duplicated in two places has already led to this one bug. And, a lot less critically, in preparation for Thrift removal I want to push any Thrift code as close to the edges as possible.&lt;/p&gt;

&lt;p&gt;Re 2: I &lt;b&gt;think&lt;/b&gt; we should be safe here b/c of the &lt;tt&gt;isThriftCompatible()&lt;/tt&gt; guard in &lt;tt&gt;CassandraServer::system_update_column_family()&lt;/tt&gt;. If we aren&apos;t, then we have a bug in &lt;tt&gt;update_column_family()&lt;/tt&gt;. I&apos;ll double check.&lt;/p&gt;
</comment>
                            <comment id="15260110" author="slebresne" created="Wed, 27 Apr 2016 13:12:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;but I, instead, feel more paranoid about leaving it in&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Fair enough, I&apos;m good getting rid of it.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think we should be safe here b/c of the &lt;tt&gt;isThriftCompatible()&lt;/tt&gt; guard in &lt;tt&gt;CassandraServer::system_update_column_family()&lt;/tt&gt;.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You&apos;re right. I got confused because I help someone a few days ago with an upgrade problem and was able to do an update on a CQL table, but that was on some 2.0 version so must have been on some version from before we introduced that. Would still be great to double check but +1 on the patch in any case.&lt;/p&gt;</comment>
                            <comment id="15260146" author="iamaleksey" created="Wed, 27 Apr 2016 13:33:54 +0000"  >&lt;blockquote&gt;&lt;p&gt;I help someone a few days ago with an upgrade problem and was able to do an update on a CQL table, but that was on some 2.0 version so must have been on some version from before we introduced that.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Do you have that table schema handy? I might as well check if the check for that fails in 2.1+ and open a new ticket if so.&lt;/p&gt;</comment>
                            <comment id="15260482" author="iamaleksey" created="Wed, 27 Apr 2016 17:01:07 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/e5c40278001bf3a9582085a58941e5f4765f118c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;e5c40278001bf3a9582085a58941e5f4765f118c&lt;/a&gt; to 2.2 and merged with 3.0 and trunk, thanks. Did some manual testing w/ cqlsh/nodetool to make sure sparse CFs w/ clustering columns don&apos;t pass &lt;tt&gt;isThriftCompatibleTest()&lt;/tt&gt;, and it seems like we are all good.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12947982">CASSANDRA-11315</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 29 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2vo73:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12334273">2.1.13</customfieldvalue>
    <customfieldvalue id="12334272">2.2.5</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327164">2.0.10</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>